<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3173503">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3173558">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3173612">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3173663">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3173733">package</span>&nbsp;<span class="ident" id="3173741">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3173746">import</span>&nbsp;<span class="op" id="3173753">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3173756">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3173762">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3173768">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3173779">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3173794">&#34;syscall&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3173805">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3173812">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3173815">//&nbsp;Network&nbsp;file&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="keyword" id="3173843">type</span>&nbsp;<span class="ident" id="3173848">netFD</span>&nbsp;<span class="keyword" id="3173854">struct</span>&nbsp;<span class="op" id="3173861">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3173864">//&nbsp;locking/lifetime&nbsp;of&nbsp;sysfd&nbsp;+&nbsp;serialize&nbsp;access&nbsp;to&nbsp;Read&nbsp;and&nbsp;Write&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3173939">fdmu</span>&nbsp;<span class="ident" id="3173944">fdMutex</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3173954">//&nbsp;immutable&nbsp;until&nbsp;Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3173980">sysfd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3173992">int</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3173997">family</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3174009">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3174014">sotype</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3174026">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3174031">isConnected</span>&nbsp;<span class="builtintype" id="3174043">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3174049">net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3174061">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3174069">laddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3174081">Addr</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3174087">raddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3174099">Addr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3174106">//&nbsp;wait&nbsp;server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3174122">pd</span>&nbsp;<span class="ident" id="3174125">pollDesc</span><br>
<span class="lineno"></span><span class="op" id="3174134">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="3174137">func</span>&nbsp;<span class="ident" id="3174142">sysInit</span><span class="op" id="3174149">(</span><span class="op" id="3174150">)</span>&nbsp;<span class="op" id="3174152">{</span><br>
<span class="lineno"></span><span class="op" id="3174154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3174157">func</span>&nbsp;<span class="ident" id="3174162">dial</span><span class="op" id="3174166">(</span><span class="ident" id="3174167">network</span>&nbsp;<span class="builtintype" id="3174175">string</span><span class="op" id="3174181">,</span>&nbsp;<span class="ident" id="3174183">ra</span>&nbsp;<span class="ident" id="3174186">Addr</span><span class="op" id="3174190">,</span>&nbsp;<span class="ident" id="3174192">dialer</span>&nbsp;<span class="keyword" id="3174199">func</span><span class="op" id="3174203">(</span><span class="ident" id="3174204">time</span><span class="op" id="3174208">.</span><span class="ident" id="3174209">Time</span><span class="op" id="3174213">)</span>&nbsp;<span class="op" id="3174215">(</span><span class="ident" id="3174216">Conn</span><span class="op" id="3174220">,</span>&nbsp;<span class="builtintype" id="3174222">error</span><span class="op" id="3174227">)</span><span class="op" id="3174228">,</span>&nbsp;<span class="ident" id="3174230">deadline</span>&nbsp;<span class="ident" id="3174239">time</span><span class="op" id="3174243">.</span><span class="ident" id="3174244">Time</span><span class="op" id="3174248">)</span>&nbsp;<span class="op" id="3174250">(</span><span class="ident" id="3174251">Conn</span><span class="op" id="3174255">,</span>&nbsp;<span class="builtintype" id="3174257">error</span><span class="op" id="3174262">)</span>&nbsp;<span class="op" id="3174264">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3174267">return</span>&nbsp;<span class="ident" id="3174274">dialer</span><span class="op" id="3174280">(</span><span class="ident" id="3174281">deadline</span><span class="op" id="3174289">)</span><br>
<span class="lineno"></span><span class="op" id="3174291">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3174294">func</span>&nbsp;<span class="ident" id="3174299">newFD</span><span class="op" id="3174304">(</span><span class="ident" id="3174305">sysfd</span><span class="op" id="3174310">,</span>&nbsp;<span class="ident" id="3174312">family</span><span class="op" id="3174318">,</span>&nbsp;<span class="ident" id="3174320">sotype</span>&nbsp;<span class="builtintype" id="3174327">int</span><span class="op" id="3174330">,</span>&nbsp;<span class="ident" id="3174332">net</span>&nbsp;<span class="builtintype" id="3174336">string</span><span class="op" id="3174342">)</span>&nbsp;<span class="op" id="3174344">(</span><span class="op" id="3174345">*</span><span class="ident" id="3174346">netFD</span><span class="op" id="3174351">,</span>&nbsp;<span class="builtintype" id="3174353">error</span><span class="op" id="3174358">)</span>&nbsp;<span class="op" id="3174360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3174363">return</span>&nbsp;<span class="op" id="3174370">&amp;</span><span class="ident" id="3174371">netFD</span><span class="op" id="3174376">{</span><span class="ident" id="3174377">sysfd</span><span class="op" id="3174382">:</span>&nbsp;<span class="ident" id="3174384">sysfd</span><span class="op" id="3174389">,</span>&nbsp;<span class="ident" id="3174391">family</span><span class="op" id="3174397">:</span>&nbsp;<span class="ident" id="3174399">family</span><span class="op" id="3174405">,</span>&nbsp;<span class="ident" id="3174407">sotype</span><span class="op" id="3174413">:</span>&nbsp;<span class="ident" id="3174415">sotype</span><span class="op" id="3174421">,</span>&nbsp;<span class="ident" id="3174423">net</span><span class="op" id="3174426">:</span>&nbsp;<span class="ident" id="3174428">net</span><span class="op" id="3174431">}</span><span class="op" id="3174432">,</span>&nbsp;<span class="ident" id="3174434">nil</span><br>
<span class="lineno">45</span><span class="op" id="3174438">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3174441">func</span>&nbsp;<span class="op" id="3174446">(</span><span class="ident" id="3174447">fd</span>&nbsp;<span class="op" id="3174450">*</span><span class="ident" id="3174451">netFD</span><span class="op" id="3174456">)</span>&nbsp;<span class="ident" id="3174458">init</span><span class="op" id="3174462">(</span><span class="op" id="3174463">)</span>&nbsp;<span class="builtintype" id="3174465">error</span>&nbsp;<span class="op" id="3174471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3174474">if</span>&nbsp;<span class="ident" id="3174477">err</span>&nbsp;<span class="op" id="3174481">:=</span>&nbsp;<span class="ident" id="3174484">fd</span><span class="op" id="3174486">.</span><span class="ident" id="3174487">pd</span><span class="op" id="3174489">.</span><span class="ident" id="3174490">Init</span><span class="op" id="3174494">(</span><span class="ident" id="3174495">fd</span><span class="op" id="3174497">)</span><span class="op" id="3174498">;</span>&nbsp;<span class="ident" id="3174500">err</span>&nbsp;<span class="op" id="3174504">!=</span>&nbsp;<span class="ident" id="3174507">nil</span>&nbsp;<span class="op" id="3174511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3174515">return</span>&nbsp;<span class="ident" id="3174522">err</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3174527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3174530">return</span>&nbsp;<span class="ident" id="3174537">nil</span><br>
<span class="lineno"></span><span class="op" id="3174541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3174544">func</span>&nbsp;<span class="op" id="3174549">(</span><span class="ident" id="3174550">fd</span>&nbsp;<span class="op" id="3174553">*</span><span class="ident" id="3174554">netFD</span><span class="op" id="3174559">)</span>&nbsp;<span class="ident" id="3174561">setAddr</span><span class="op" id="3174568">(</span><span class="ident" id="3174569">laddr</span><span class="op" id="3174574">,</span>&nbsp;<span class="ident" id="3174576">raddr</span>&nbsp;<span class="ident" id="3174582">Addr</span><span class="op" id="3174586">)</span>&nbsp;<span class="op" id="3174588">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3174591">fd</span><span class="op" id="3174593">.</span><span class="ident" id="3174594">laddr</span>&nbsp;<span class="op" id="3174600">=</span>&nbsp;<span class="ident" id="3174602">laddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3174609">fd</span><span class="op" id="3174611">.</span><span class="ident" id="3174612">raddr</span>&nbsp;<span class="op" id="3174618">=</span>&nbsp;<span class="ident" id="3174620">raddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3174627">runtime</span><span class="op" id="3174634">.</span><span class="ident" id="3174635">SetFinalizer</span><span class="op" id="3174647">(</span><span class="ident" id="3174648">fd</span><span class="op" id="3174650">,</span>&nbsp;<span class="op" id="3174652">(</span><span class="op" id="3174653">*</span><span class="ident" id="3174654">netFD</span><span class="op" id="3174659">)</span><span class="op" id="3174660">.</span><span class="ident" id="3174661">Close</span><span class="op" id="3174666">)</span><br>
<span class="lineno"></span><span class="op" id="3174668">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="3174671">func</span>&nbsp;<span class="op" id="3174676">(</span><span class="ident" id="3174677">fd</span>&nbsp;<span class="op" id="3174680">*</span><span class="ident" id="3174681">netFD</span><span class="op" id="3174686">)</span>&nbsp;<span class="ident" id="3174688">name</span><span class="op" id="3174692">(</span><span class="op" id="3174693">)</span>&nbsp;<span class="builtintype" id="3174695">string</span>&nbsp;<span class="op" id="3174702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3174705">var</span>&nbsp;<span class="ident" id="3174709">ls</span><span class="op" id="3174711">,</span>&nbsp;<span class="ident" id="3174713">rs</span>&nbsp;<span class="builtintype" id="3174716">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3174724">if</span>&nbsp;<span class="ident" id="3174727">fd</span><span class="op" id="3174729">.</span><span class="ident" id="3174730">laddr</span>&nbsp;<span class="op" id="3174736">!=</span>&nbsp;<span class="ident" id="3174739">nil</span>&nbsp;<span class="op" id="3174743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3174747">ls</span>&nbsp;<span class="op" id="3174750">=</span>&nbsp;<span class="ident" id="3174752">fd</span><span class="op" id="3174754">.</span><span class="ident" id="3174755">laddr</span><span class="op" id="3174760">.</span><span class="ident" id="3174761">String</span><span class="op" id="3174767">(</span><span class="op" id="3174768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3174771">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3174774">if</span>&nbsp;<span class="ident" id="3174777">fd</span><span class="op" id="3174779">.</span><span class="ident" id="3174780">raddr</span>&nbsp;<span class="op" id="3174786">!=</span>&nbsp;<span class="ident" id="3174789">nil</span>&nbsp;<span class="op" id="3174793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3174797">rs</span>&nbsp;<span class="op" id="3174800">=</span>&nbsp;<span class="ident" id="3174802">fd</span><span class="op" id="3174804">.</span><span class="ident" id="3174805">raddr</span><span class="op" id="3174810">.</span><span class="ident" id="3174811">String</span><span class="op" id="3174817">(</span><span class="op" id="3174818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3174821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3174824">return</span>&nbsp;<span class="ident" id="3174831">fd</span><span class="op" id="3174833">.</span><span class="ident" id="3174834">net</span>&nbsp;<span class="op" id="3174838">+</span>&nbsp;<span class="string" id="3174840">&#34;:&#34;</span>&nbsp;<span class="op" id="3174844">+</span>&nbsp;<span class="ident" id="3174846">ls</span>&nbsp;<span class="op" id="3174849">+</span>&nbsp;<span class="string" id="3174851">&#34;-&gt;&#34;</span>&nbsp;<span class="op" id="3174856">+</span>&nbsp;<span class="ident" id="3174858">rs</span><br>
<span class="lineno"></span><span class="op" id="3174861">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="3174864">func</span>&nbsp;<span class="op" id="3174869">(</span><span class="ident" id="3174870">fd</span>&nbsp;<span class="op" id="3174873">*</span><span class="ident" id="3174874">netFD</span><span class="op" id="3174879">)</span>&nbsp;<span class="ident" id="3174881">connect</span><span class="op" id="3174888">(</span><span class="ident" id="3174889">la</span><span class="op" id="3174891">,</span>&nbsp;<span class="ident" id="3174893">ra</span>&nbsp;<span class="ident" id="3174896">syscall</span><span class="op" id="3174903">.</span><span class="ident" id="3174904">Sockaddr</span><span class="op" id="3174912">,</span>&nbsp;<span class="ident" id="3174914">deadline</span>&nbsp;<span class="ident" id="3174923">time</span><span class="op" id="3174927">.</span><span class="ident" id="3174928">Time</span><span class="op" id="3174932">)</span>&nbsp;<span class="builtintype" id="3174934">error</span>&nbsp;<span class="op" id="3174940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3174943">//&nbsp;Do&nbsp;not&nbsp;need&nbsp;to&nbsp;call&nbsp;fd.writeLock&nbsp;here,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3174986">//&nbsp;because&nbsp;fd&nbsp;is&nbsp;not&nbsp;yet&nbsp;accessible&nbsp;to&nbsp;user,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3175032">//&nbsp;so&nbsp;no&nbsp;concurrent&nbsp;operations&nbsp;are&nbsp;possible.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3175078">switch</span>&nbsp;<span class="ident" id="3175085">err</span>&nbsp;<span class="op" id="3175089">:=</span>&nbsp;<span class="ident" id="3175092">syscall</span><span class="op" id="3175099">.</span><span class="ident" id="3175100">Connect</span><span class="op" id="3175107">(</span><span class="ident" id="3175108">fd</span><span class="op" id="3175110">.</span><span class="ident" id="3175111">sysfd</span><span class="op" id="3175116">,</span>&nbsp;<span class="ident" id="3175118">ra</span><span class="op" id="3175120">)</span><span class="op" id="3175121">;</span>&nbsp;<span class="ident" id="3175123">err</span>&nbsp;<span class="op" id="3175127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3175130">case</span>&nbsp;<span class="ident" id="3175135">syscall</span><span class="op" id="3175142">.</span><span class="ident" id="3175143">EINPROGRESS</span><span class="op" id="3175154">,</span>&nbsp;<span class="ident" id="3175156">syscall</span><span class="op" id="3175163">.</span><span class="ident" id="3175164">EALREADY</span><span class="op" id="3175172">,</span>&nbsp;<span class="ident" id="3175174">syscall</span><span class="op" id="3175181">.</span><span class="ident" id="3175182">EINTR</span><span class="op" id="3175187">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3175190">case</span>&nbsp;<span class="ident" id="3175195">nil</span><span class="op" id="3175198">,</span>&nbsp;<span class="ident" id="3175200">syscall</span><span class="op" id="3175207">.</span><span class="ident" id="3175208">EISCONN</span><span class="op" id="3175215">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3175219">if</span>&nbsp;<span class="op" id="3175222">!</span><span class="ident" id="3175223">deadline</span><span class="op" id="3175231">.</span><span class="ident" id="3175232">IsZero</span><span class="op" id="3175238">(</span><span class="op" id="3175239">)</span>&nbsp;<span class="op" id="3175241">&amp;&amp;</span>&nbsp;<span class="ident" id="3175244">deadline</span><span class="op" id="3175252">.</span><span class="ident" id="3175253">Before</span><span class="op" id="3175259">(</span><span class="ident" id="3175260">time</span><span class="op" id="3175264">.</span><span class="ident" id="3175265">Now</span><span class="op" id="3175268">(</span><span class="op" id="3175269">)</span><span class="op" id="3175270">)</span>&nbsp;<span class="op" id="3175272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3175277">return</span>&nbsp;<span class="ident" id="3175284">errTimeout</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3175297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3175301">if</span>&nbsp;<span class="ident" id="3175304">err</span>&nbsp;<span class="op" id="3175308">:=</span>&nbsp;<span class="ident" id="3175311">fd</span><span class="op" id="3175313">.</span><span class="ident" id="3175314">init</span><span class="op" id="3175318">(</span><span class="op" id="3175319">)</span><span class="op" id="3175320">;</span>&nbsp;<span class="ident" id="3175322">err</span>&nbsp;<span class="op" id="3175326">!=</span>&nbsp;<span class="ident" id="3175329">nil</span>&nbsp;<span class="op" id="3175333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3175338">return</span>&nbsp;<span class="ident" id="3175345">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3175351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3175355">return</span>&nbsp;<span class="ident" id="3175362">nil</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3175367">case</span>&nbsp;<span class="ident" id="3175372">syscall</span><span class="op" id="3175379">.</span><span class="ident" id="3175380">EINVAL</span><span class="op" id="3175386">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3175390">//&nbsp;On&nbsp;Solaris&nbsp;we&nbsp;can&nbsp;see&nbsp;EINVAL&nbsp;if&nbsp;the&nbsp;socket&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3175442">//&nbsp;already&nbsp;been&nbsp;accepted&nbsp;and&nbsp;closed&nbsp;by&nbsp;the&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3175495">//&nbsp;Treat&nbsp;this&nbsp;as&nbsp;a&nbsp;successful&nbsp;connection--writes&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3175549">//&nbsp;the&nbsp;socket&nbsp;will&nbsp;see&nbsp;EOF.&nbsp;&nbsp;For&nbsp;details&nbsp;and&nbsp;a&nbsp;test</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3175603">//&nbsp;case&nbsp;in&nbsp;C&nbsp;see&nbsp;http://golang.org/issue/6828.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3175652">if</span>&nbsp;<span class="ident" id="3175655">runtime</span><span class="op" id="3175662">.</span><span class="ident" id="3175663">GOOS</span>&nbsp;<span class="op" id="3175668">==</span>&nbsp;<span class="string" id="3175671">&#34;solaris&#34;</span>&nbsp;<span class="op" id="3175681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3175686">return</span>&nbsp;<span class="ident" id="3175693">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3175699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3175703">fallthrough</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3175716">default</span><span class="op" id="3175723">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3175727">return</span>&nbsp;<span class="ident" id="3175734">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3175739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3175742">if</span>&nbsp;<span class="ident" id="3175745">err</span>&nbsp;<span class="op" id="3175749">:=</span>&nbsp;<span class="ident" id="3175752">fd</span><span class="op" id="3175754">.</span><span class="ident" id="3175755">init</span><span class="op" id="3175759">(</span><span class="op" id="3175760">)</span><span class="op" id="3175761">;</span>&nbsp;<span class="ident" id="3175763">err</span>&nbsp;<span class="op" id="3175767">!=</span>&nbsp;<span class="ident" id="3175770">nil</span>&nbsp;<span class="op" id="3175774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3175778">return</span>&nbsp;<span class="ident" id="3175785">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3175790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3175793">if</span>&nbsp;<span class="op" id="3175796">!</span><span class="ident" id="3175797">deadline</span><span class="op" id="3175805">.</span><span class="ident" id="3175806">IsZero</span><span class="op" id="3175812">(</span><span class="op" id="3175813">)</span>&nbsp;<span class="op" id="3175815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3175819">fd</span><span class="op" id="3175821">.</span><span class="ident" id="3175822">setWriteDeadline</span><span class="op" id="3175838">(</span><span class="ident" id="3175839">deadline</span><span class="op" id="3175847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3175851">defer</span>&nbsp;<span class="ident" id="3175857">fd</span><span class="op" id="3175859">.</span><span class="ident" id="3175860">setWriteDeadline</span><span class="op" id="3175876">(</span><span class="ident" id="3175877">noDeadline</span><span class="op" id="3175887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3175890">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3175893">for</span>&nbsp;<span class="op" id="3175897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3175901">//&nbsp;Performing&nbsp;multiple&nbsp;connect&nbsp;system&nbsp;calls&nbsp;on&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3175952">//&nbsp;non-blocking&nbsp;socket&nbsp;under&nbsp;Unix&nbsp;variants&nbsp;does&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3176006">//&nbsp;necessarily&nbsp;result&nbsp;in&nbsp;earlier&nbsp;errors&nbsp;being</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3176054">//&nbsp;returned.&nbsp;Instead,&nbsp;once&nbsp;runtime-integrated&nbsp;network</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3176110">//&nbsp;poller&nbsp;tells&nbsp;us&nbsp;that&nbsp;the&nbsp;socket&nbsp;is&nbsp;ready,&nbsp;get&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3176165">//&nbsp;SO_ERROR&nbsp;socket&nbsp;option&nbsp;to&nbsp;see&nbsp;if&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3176218">//&nbsp;succeeded&nbsp;or&nbsp;failed.&nbsp;See&nbsp;issue&nbsp;7474&nbsp;for&nbsp;further</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3176271">//&nbsp;details.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3176285">if</span>&nbsp;<span class="ident" id="3176288">err</span>&nbsp;<span class="op" id="3176292">:=</span>&nbsp;<span class="ident" id="3176295">fd</span><span class="op" id="3176297">.</span><span class="ident" id="3176298">pd</span><span class="op" id="3176300">.</span><span class="ident" id="3176301">WaitWrite</span><span class="op" id="3176310">(</span><span class="op" id="3176311">)</span><span class="op" id="3176312">;</span>&nbsp;<span class="ident" id="3176314">err</span>&nbsp;<span class="op" id="3176318">!=</span>&nbsp;<span class="ident" id="3176321">nil</span>&nbsp;<span class="op" id="3176325">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3176330">return</span>&nbsp;<span class="ident" id="3176337">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3176343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3176347">nerr</span><span class="op" id="3176351">,</span>&nbsp;<span class="ident" id="3176353">err</span>&nbsp;<span class="op" id="3176357">:=</span>&nbsp;<span class="ident" id="3176360">syscall</span><span class="op" id="3176367">.</span><span class="ident" id="3176368">GetsockoptInt</span><span class="op" id="3176381">(</span><span class="ident" id="3176382">fd</span><span class="op" id="3176384">.</span><span class="ident" id="3176385">sysfd</span><span class="op" id="3176390">,</span>&nbsp;<span class="ident" id="3176392">syscall</span><span class="op" id="3176399">.</span><span class="ident" id="3176400">SOL_SOCKET</span><span class="op" id="3176410">,</span>&nbsp;<span class="ident" id="3176412">syscall</span><span class="op" id="3176419">.</span><span class="ident" id="3176420">SO_ERROR</span><span class="op" id="3176428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3176432">if</span>&nbsp;<span class="ident" id="3176435">err</span>&nbsp;<span class="op" id="3176439">!=</span>&nbsp;<span class="ident" id="3176442">nil</span>&nbsp;<span class="op" id="3176446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3176451">return</span>&nbsp;<span class="ident" id="3176458">err</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3176464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3176468">switch</span>&nbsp;<span class="ident" id="3176475">err</span>&nbsp;<span class="op" id="3176479">:=</span>&nbsp;<span class="ident" id="3176482">syscall</span><span class="op" id="3176489">.</span><span class="ident" id="3176490">Errno</span><span class="op" id="3176495">(</span><span class="ident" id="3176496">nerr</span><span class="op" id="3176500">)</span><span class="op" id="3176501">;</span>&nbsp;<span class="ident" id="3176503">err</span>&nbsp;<span class="op" id="3176507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3176511">case</span>&nbsp;<span class="ident" id="3176516">syscall</span><span class="op" id="3176523">.</span><span class="ident" id="3176524">EINPROGRESS</span><span class="op" id="3176535">,</span>&nbsp;<span class="ident" id="3176537">syscall</span><span class="op" id="3176544">.</span><span class="ident" id="3176545">EALREADY</span><span class="op" id="3176553">,</span>&nbsp;<span class="ident" id="3176555">syscall</span><span class="op" id="3176562">.</span><span class="ident" id="3176563">EINTR</span><span class="op" id="3176568">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3176572">case</span>&nbsp;<span class="ident" id="3176577">syscall</span><span class="op" id="3176584">.</span><span class="ident" id="3176585">Errno</span><span class="op" id="3176590">(</span><span class="num" id="3176591">0</span><span class="op" id="3176592">)</span><span class="op" id="3176593">,</span>&nbsp;<span class="ident" id="3176595">syscall</span><span class="op" id="3176602">.</span><span class="ident" id="3176603">EISCONN</span><span class="op" id="3176610">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3176615">return</span>&nbsp;<span class="ident" id="3176622">nil</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3176628">default</span><span class="op" id="3176635">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3176640">return</span>&nbsp;<span class="ident" id="3176647">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3176653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3176656">}</span><br>
<span class="lineno"></span><span class="op" id="3176658">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="keyword" id="3176661">func</span>&nbsp;<span class="op" id="3176666">(</span><span class="ident" id="3176667">fd</span>&nbsp;<span class="op" id="3176670">*</span><span class="ident" id="3176671">netFD</span><span class="op" id="3176676">)</span>&nbsp;<span class="ident" id="3176678">destroy</span><span class="op" id="3176685">(</span><span class="op" id="3176686">)</span>&nbsp;<span class="op" id="3176688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3176691">//&nbsp;Poller&nbsp;may&nbsp;want&nbsp;to&nbsp;unregister&nbsp;fd&nbsp;in&nbsp;readiness&nbsp;notification&nbsp;mechanism,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3176765">//&nbsp;so&nbsp;this&nbsp;must&nbsp;be&nbsp;executed&nbsp;before&nbsp;closesocket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3176814">fd</span><span class="op" id="3176816">.</span><span class="ident" id="3176817">pd</span><span class="op" id="3176819">.</span><span class="ident" id="3176820">Close</span><span class="op" id="3176825">(</span><span class="op" id="3176826">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3176829">closesocket</span><span class="op" id="3176840">(</span><span class="ident" id="3176841">fd</span><span class="op" id="3176843">.</span><span class="ident" id="3176844">sysfd</span><span class="op" id="3176849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3176852">fd</span><span class="op" id="3176854">.</span><span class="ident" id="3176855">sysfd</span>&nbsp;<span class="op" id="3176861">=</span>&nbsp;<span class="op" id="3176863">-</span><span class="num" id="3176864">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3176867">runtime</span><span class="op" id="3176874">.</span><span class="ident" id="3176875">SetFinalizer</span><span class="op" id="3176887">(</span><span class="ident" id="3176888">fd</span><span class="op" id="3176890">,</span>&nbsp;<span class="ident" id="3176892">nil</span><span class="op" id="3176895">)</span><br>
<span class="lineno"></span><span class="op" id="3176897">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="3176900">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd.</span><br>
<span class="lineno"></span><span class="comment" id="3176931">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3176977">func</span>&nbsp;<span class="op" id="3176982">(</span><span class="ident" id="3176983">fd</span>&nbsp;<span class="op" id="3176986">*</span><span class="ident" id="3176987">netFD</span><span class="op" id="3176992">)</span>&nbsp;<span class="ident" id="3176994">incref</span><span class="op" id="3177000">(</span><span class="op" id="3177001">)</span>&nbsp;<span class="builtintype" id="3177003">error</span>&nbsp;<span class="op" id="3177009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3177012">if</span>&nbsp;<span class="op" id="3177015">!</span><span class="ident" id="3177016">fd</span><span class="op" id="3177018">.</span><span class="ident" id="3177019">fdmu</span><span class="op" id="3177023">.</span><span class="ident" id="3177024">Incref</span><span class="op" id="3177030">(</span><span class="op" id="3177031">)</span>&nbsp;<span class="op" id="3177033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3177037">return</span>&nbsp;<span class="ident" id="3177044">errClosing</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3177056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3177059">return</span>&nbsp;<span class="ident" id="3177066">nil</span><br>
<span class="lineno"></span><span class="op" id="3177070">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3177073">//&nbsp;Remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD&nbsp;and&nbsp;close&nbsp;if&nbsp;we&#39;ve&nbsp;been&nbsp;asked&nbsp;to&nbsp;do&nbsp;so</span><br>
<span class="lineno">150</span><span class="comment" id="3177145">//&nbsp;(and&nbsp;there&nbsp;are&nbsp;no&nbsp;references&nbsp;left).</span><br>
<span class="lineno"></span><span class="keyword" id="3177184">func</span>&nbsp;<span class="op" id="3177189">(</span><span class="ident" id="3177190">fd</span>&nbsp;<span class="op" id="3177193">*</span><span class="ident" id="3177194">netFD</span><span class="op" id="3177199">)</span>&nbsp;<span class="ident" id="3177201">decref</span><span class="op" id="3177207">(</span><span class="op" id="3177208">)</span>&nbsp;<span class="op" id="3177210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3177213">if</span>&nbsp;<span class="ident" id="3177216">fd</span><span class="op" id="3177218">.</span><span class="ident" id="3177219">fdmu</span><span class="op" id="3177223">.</span><span class="ident" id="3177224">Decref</span><span class="op" id="3177230">(</span><span class="op" id="3177231">)</span>&nbsp;<span class="op" id="3177233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3177237">fd</span><span class="op" id="3177239">.</span><span class="ident" id="3177240">destroy</span><span class="op" id="3177247">(</span><span class="op" id="3177248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3177251">}</span><br>
<span class="lineno">155</span><span class="op" id="3177253">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3177256">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd&nbsp;and&nbsp;lock&nbsp;for&nbsp;reading.</span><br>
<span class="lineno"></span><span class="comment" id="3177308">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3177354">func</span>&nbsp;<span class="op" id="3177359">(</span><span class="ident" id="3177360">fd</span>&nbsp;<span class="op" id="3177363">*</span><span class="ident" id="3177364">netFD</span><span class="op" id="3177369">)</span>&nbsp;<span class="ident" id="3177371">readLock</span><span class="op" id="3177379">(</span><span class="op" id="3177380">)</span>&nbsp;<span class="builtintype" id="3177382">error</span>&nbsp;<span class="op" id="3177388">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3177391">if</span>&nbsp;<span class="op" id="3177394">!</span><span class="ident" id="3177395">fd</span><span class="op" id="3177397">.</span><span class="ident" id="3177398">fdmu</span><span class="op" id="3177402">.</span><span class="ident" id="3177403">RWLock</span><span class="op" id="3177409">(</span><span class="builtintype" id="3177410">true</span><span class="op" id="3177414">)</span>&nbsp;<span class="op" id="3177416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3177420">return</span>&nbsp;<span class="ident" id="3177427">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3177439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3177442">return</span>&nbsp;<span class="ident" id="3177449">nil</span><br>
<span class="lineno"></span><span class="op" id="3177453">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="3177456">//&nbsp;Unlock&nbsp;for&nbsp;reading&nbsp;and&nbsp;remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD.</span><br>
<span class="lineno"></span><span class="keyword" id="3177513">func</span>&nbsp;<span class="op" id="3177518">(</span><span class="ident" id="3177519">fd</span>&nbsp;<span class="op" id="3177522">*</span><span class="ident" id="3177523">netFD</span><span class="op" id="3177528">)</span>&nbsp;<span class="ident" id="3177530">readUnlock</span><span class="op" id="3177540">(</span><span class="op" id="3177541">)</span>&nbsp;<span class="op" id="3177543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3177546">if</span>&nbsp;<span class="ident" id="3177549">fd</span><span class="op" id="3177551">.</span><span class="ident" id="3177552">fdmu</span><span class="op" id="3177556">.</span><span class="ident" id="3177557">RWUnlock</span><span class="op" id="3177565">(</span><span class="builtintype" id="3177566">true</span><span class="op" id="3177570">)</span>&nbsp;<span class="op" id="3177572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3177576">fd</span><span class="op" id="3177578">.</span><span class="ident" id="3177579">destroy</span><span class="op" id="3177586">(</span><span class="op" id="3177587">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3177590">}</span><br>
<span class="lineno"></span><span class="op" id="3177592">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3177595">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd&nbsp;and&nbsp;lock&nbsp;for&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="3177647">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno">175</span><span class="keyword" id="3177693">func</span>&nbsp;<span class="op" id="3177698">(</span><span class="ident" id="3177699">fd</span>&nbsp;<span class="op" id="3177702">*</span><span class="ident" id="3177703">netFD</span><span class="op" id="3177708">)</span>&nbsp;<span class="ident" id="3177710">writeLock</span><span class="op" id="3177719">(</span><span class="op" id="3177720">)</span>&nbsp;<span class="builtintype" id="3177722">error</span>&nbsp;<span class="op" id="3177728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3177731">if</span>&nbsp;<span class="op" id="3177734">!</span><span class="ident" id="3177735">fd</span><span class="op" id="3177737">.</span><span class="ident" id="3177738">fdmu</span><span class="op" id="3177742">.</span><span class="ident" id="3177743">RWLock</span><span class="op" id="3177749">(</span><span class="builtintype" id="3177750">false</span><span class="op" id="3177755">)</span>&nbsp;<span class="op" id="3177757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3177761">return</span>&nbsp;<span class="ident" id="3177768">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3177780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3177783">return</span>&nbsp;<span class="ident" id="3177790">nil</span><br>
<span class="lineno">180</span><span class="op" id="3177794">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3177797">//&nbsp;Unlock&nbsp;for&nbsp;writing&nbsp;and&nbsp;remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD.</span><br>
<span class="lineno"></span><span class="keyword" id="3177854">func</span>&nbsp;<span class="op" id="3177859">(</span><span class="ident" id="3177860">fd</span>&nbsp;<span class="op" id="3177863">*</span><span class="ident" id="3177864">netFD</span><span class="op" id="3177869">)</span>&nbsp;<span class="ident" id="3177871">writeUnlock</span><span class="op" id="3177882">(</span><span class="op" id="3177883">)</span>&nbsp;<span class="op" id="3177885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3177888">if</span>&nbsp;<span class="ident" id="3177891">fd</span><span class="op" id="3177893">.</span><span class="ident" id="3177894">fdmu</span><span class="op" id="3177898">.</span><span class="ident" id="3177899">RWUnlock</span><span class="op" id="3177907">(</span><span class="builtintype" id="3177908">false</span><span class="op" id="3177913">)</span>&nbsp;<span class="op" id="3177915">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3177919">fd</span><span class="op" id="3177921">.</span><span class="ident" id="3177922">destroy</span><span class="op" id="3177929">(</span><span class="op" id="3177930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3177933">}</span><br>
<span class="lineno"></span><span class="op" id="3177935">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3177938">func</span>&nbsp;<span class="op" id="3177943">(</span><span class="ident" id="3177944">fd</span>&nbsp;<span class="op" id="3177947">*</span><span class="ident" id="3177948">netFD</span><span class="op" id="3177953">)</span>&nbsp;<span class="ident" id="3177955">Close</span><span class="op" id="3177960">(</span><span class="op" id="3177961">)</span>&nbsp;<span class="builtintype" id="3177963">error</span>&nbsp;<span class="op" id="3177969">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3177972">fd</span><span class="op" id="3177974">.</span><span class="ident" id="3177975">pd</span><span class="op" id="3177977">.</span><span class="ident" id="3177978">Lock</span><span class="op" id="3177982">(</span><span class="op" id="3177983">)</span>&nbsp;<span class="comment" id="3177985">//&nbsp;needed&nbsp;for&nbsp;both&nbsp;fd.incref(true)&nbsp;and&nbsp;pollDesc.Evict</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178040">if</span>&nbsp;<span class="op" id="3178043">!</span><span class="ident" id="3178044">fd</span><span class="op" id="3178046">.</span><span class="ident" id="3178047">fdmu</span><span class="op" id="3178051">.</span><span class="ident" id="3178052">IncrefAndClose</span><span class="op" id="3178066">(</span><span class="op" id="3178067">)</span>&nbsp;<span class="op" id="3178069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3178073">fd</span><span class="op" id="3178075">.</span><span class="ident" id="3178076">pd</span><span class="op" id="3178078">.</span><span class="ident" id="3178079">Unlock</span><span class="op" id="3178085">(</span><span class="op" id="3178086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178090">return</span>&nbsp;<span class="ident" id="3178097">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3178109">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3178112">//&nbsp;Unblock&nbsp;any&nbsp;I/O.&nbsp;&nbsp;Once&nbsp;it&nbsp;all&nbsp;unblocks&nbsp;and&nbsp;returns,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3178168">//&nbsp;so&nbsp;that&nbsp;it&nbsp;cannot&nbsp;be&nbsp;referring&nbsp;to&nbsp;fd.sysfd&nbsp;anymore,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3178224">//&nbsp;the&nbsp;final&nbsp;decref&nbsp;will&nbsp;close&nbsp;fd.sysfd.&nbsp;&nbsp;This&nbsp;should&nbsp;happen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3178286">//&nbsp;fairly&nbsp;quickly,&nbsp;since&nbsp;all&nbsp;the&nbsp;I/O&nbsp;is&nbsp;non-blocking,&nbsp;and&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3178349">//&nbsp;attempts&nbsp;to&nbsp;block&nbsp;in&nbsp;the&nbsp;pollDesc&nbsp;will&nbsp;return&nbsp;errClosing.</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3178411">doWakeup</span>&nbsp;<span class="op" id="3178420">:=</span>&nbsp;<span class="ident" id="3178423">fd</span><span class="op" id="3178425">.</span><span class="ident" id="3178426">pd</span><span class="op" id="3178428">.</span><span class="ident" id="3178429">Evict</span><span class="op" id="3178434">(</span><span class="op" id="3178435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3178438">fd</span><span class="op" id="3178440">.</span><span class="ident" id="3178441">pd</span><span class="op" id="3178443">.</span><span class="ident" id="3178444">Unlock</span><span class="op" id="3178450">(</span><span class="op" id="3178451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3178454">fd</span><span class="op" id="3178456">.</span><span class="ident" id="3178457">decref</span><span class="op" id="3178463">(</span><span class="op" id="3178464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178467">if</span>&nbsp;<span class="ident" id="3178470">doWakeup</span>&nbsp;<span class="op" id="3178479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3178483">fd</span><span class="op" id="3178485">.</span><span class="ident" id="3178486">pd</span><span class="op" id="3178488">.</span><span class="ident" id="3178489">Wakeup</span><span class="op" id="3178495">(</span><span class="op" id="3178496">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3178499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178502">return</span>&nbsp;<span class="ident" id="3178509">nil</span><br>
<span class="lineno"></span><span class="op" id="3178513">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3178516">func</span>&nbsp;<span class="op" id="3178521">(</span><span class="ident" id="3178522">fd</span>&nbsp;<span class="op" id="3178525">*</span><span class="ident" id="3178526">netFD</span><span class="op" id="3178531">)</span>&nbsp;<span class="ident" id="3178533">shutdown</span><span class="op" id="3178541">(</span><span class="ident" id="3178542">how</span>&nbsp;<span class="builtintype" id="3178546">int</span><span class="op" id="3178549">)</span>&nbsp;<span class="builtintype" id="3178551">error</span>&nbsp;<span class="op" id="3178557">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178560">if</span>&nbsp;<span class="ident" id="3178563">err</span>&nbsp;<span class="op" id="3178567">:=</span>&nbsp;<span class="ident" id="3178570">fd</span><span class="op" id="3178572">.</span><span class="ident" id="3178573">incref</span><span class="op" id="3178579">(</span><span class="op" id="3178580">)</span><span class="op" id="3178581">;</span>&nbsp;<span class="ident" id="3178583">err</span>&nbsp;<span class="op" id="3178587">!=</span>&nbsp;<span class="ident" id="3178590">nil</span>&nbsp;<span class="op" id="3178594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178598">return</span>&nbsp;<span class="ident" id="3178605">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3178610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178613">defer</span>&nbsp;<span class="ident" id="3178619">fd</span><span class="op" id="3178621">.</span><span class="ident" id="3178622">decref</span><span class="op" id="3178628">(</span><span class="op" id="3178629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3178632">err</span>&nbsp;<span class="op" id="3178636">:=</span>&nbsp;<span class="ident" id="3178639">syscall</span><span class="op" id="3178646">.</span><span class="ident" id="3178647">Shutdown</span><span class="op" id="3178655">(</span><span class="ident" id="3178656">fd</span><span class="op" id="3178658">.</span><span class="ident" id="3178659">sysfd</span><span class="op" id="3178664">,</span>&nbsp;<span class="ident" id="3178666">how</span><span class="op" id="3178669">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178672">if</span>&nbsp;<span class="ident" id="3178675">err</span>&nbsp;<span class="op" id="3178679">!=</span>&nbsp;<span class="ident" id="3178682">nil</span>&nbsp;<span class="op" id="3178686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178690">return</span>&nbsp;<span class="op" id="3178697">&amp;</span><span class="ident" id="3178698">OpError</span><span class="op" id="3178705">{</span><span class="string" id="3178706">&#34;shutdown&#34;</span><span class="op" id="3178716">,</span>&nbsp;<span class="ident" id="3178718">fd</span><span class="op" id="3178720">.</span><span class="ident" id="3178721">net</span><span class="op" id="3178724">,</span>&nbsp;<span class="ident" id="3178726">fd</span><span class="op" id="3178728">.</span><span class="ident" id="3178729">laddr</span><span class="op" id="3178734">,</span>&nbsp;<span class="ident" id="3178736">err</span><span class="op" id="3178739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3178742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178745">return</span>&nbsp;<span class="ident" id="3178752">nil</span><br>
<span class="lineno"></span><span class="op" id="3178756">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="keyword" id="3178759">func</span>&nbsp;<span class="op" id="3178764">(</span><span class="ident" id="3178765">fd</span>&nbsp;<span class="op" id="3178768">*</span><span class="ident" id="3178769">netFD</span><span class="op" id="3178774">)</span>&nbsp;<span class="ident" id="3178776">closeRead</span><span class="op" id="3178785">(</span><span class="op" id="3178786">)</span>&nbsp;<span class="builtintype" id="3178788">error</span>&nbsp;<span class="op" id="3178794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178797">return</span>&nbsp;<span class="ident" id="3178804">fd</span><span class="op" id="3178806">.</span><span class="ident" id="3178807">shutdown</span><span class="op" id="3178815">(</span><span class="ident" id="3178816">syscall</span><span class="op" id="3178823">.</span><span class="ident" id="3178824">SHUT_RD</span><span class="op" id="3178831">)</span><br>
<span class="lineno"></span><span class="op" id="3178833">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="3178836">func</span>&nbsp;<span class="op" id="3178841">(</span><span class="ident" id="3178842">fd</span>&nbsp;<span class="op" id="3178845">*</span><span class="ident" id="3178846">netFD</span><span class="op" id="3178851">)</span>&nbsp;<span class="ident" id="3178853">closeWrite</span><span class="op" id="3178863">(</span><span class="op" id="3178864">)</span>&nbsp;<span class="builtintype" id="3178866">error</span>&nbsp;<span class="op" id="3178872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178875">return</span>&nbsp;<span class="ident" id="3178882">fd</span><span class="op" id="3178884">.</span><span class="ident" id="3178885">shutdown</span><span class="op" id="3178893">(</span><span class="ident" id="3178894">syscall</span><span class="op" id="3178901">.</span><span class="ident" id="3178902">SHUT_WR</span><span class="op" id="3178909">)</span><br>
<span class="lineno"></span><span class="op" id="3178911">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3178914">func</span>&nbsp;<span class="op" id="3178919">(</span><span class="ident" id="3178920">fd</span>&nbsp;<span class="op" id="3178923">*</span><span class="ident" id="3178924">netFD</span><span class="op" id="3178929">)</span>&nbsp;<span class="ident" id="3178931">Read</span><span class="op" id="3178935">(</span><span class="ident" id="3178936">p</span>&nbsp;<span class="op" id="3178938">[</span><span class="op" id="3178939">]</span><span class="builtintype" id="3178940">byte</span><span class="op" id="3178944">)</span>&nbsp;<span class="op" id="3178946">(</span><span class="ident" id="3178947">n</span>&nbsp;<span class="builtintype" id="3178949">int</span><span class="op" id="3178952">,</span>&nbsp;<span class="ident" id="3178954">err</span>&nbsp;<span class="builtintype" id="3178958">error</span><span class="op" id="3178963">)</span>&nbsp;<span class="op" id="3178965">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178968">if</span>&nbsp;<span class="ident" id="3178971">err</span>&nbsp;<span class="op" id="3178975">:=</span>&nbsp;<span class="ident" id="3178978">fd</span><span class="op" id="3178980">.</span><span class="ident" id="3178981">readLock</span><span class="op" id="3178989">(</span><span class="op" id="3178990">)</span><span class="op" id="3178991">;</span>&nbsp;<span class="ident" id="3178993">err</span>&nbsp;<span class="op" id="3178997">!=</span>&nbsp;<span class="ident" id="3179000">nil</span>&nbsp;<span class="op" id="3179004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3179008">return</span>&nbsp;<span class="num" id="3179015">0</span><span class="op" id="3179016">,</span>&nbsp;<span class="ident" id="3179018">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3179023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3179026">defer</span>&nbsp;<span class="ident" id="3179032">fd</span><span class="op" id="3179034">.</span><span class="ident" id="3179035">readUnlock</span><span class="op" id="3179045">(</span><span class="op" id="3179046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3179049">if</span>&nbsp;<span class="ident" id="3179052">err</span>&nbsp;<span class="op" id="3179056">:=</span>&nbsp;<span class="ident" id="3179059">fd</span><span class="op" id="3179061">.</span><span class="ident" id="3179062">pd</span><span class="op" id="3179064">.</span><span class="ident" id="3179065">PrepareRead</span><span class="op" id="3179076">(</span><span class="op" id="3179077">)</span><span class="op" id="3179078">;</span>&nbsp;<span class="ident" id="3179080">err</span>&nbsp;<span class="op" id="3179084">!=</span>&nbsp;<span class="ident" id="3179087">nil</span>&nbsp;<span class="op" id="3179091">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3179095">return</span>&nbsp;<span class="num" id="3179102">0</span><span class="op" id="3179103">,</span>&nbsp;<span class="op" id="3179105">&amp;</span><span class="ident" id="3179106">OpError</span><span class="op" id="3179113">{</span><span class="string" id="3179114">&#34;read&#34;</span><span class="op" id="3179120">,</span>&nbsp;<span class="ident" id="3179122">fd</span><span class="op" id="3179124">.</span><span class="ident" id="3179125">net</span><span class="op" id="3179128">,</span>&nbsp;<span class="ident" id="3179130">fd</span><span class="op" id="3179132">.</span><span class="ident" id="3179133">raddr</span><span class="op" id="3179138">,</span>&nbsp;<span class="ident" id="3179140">err</span><span class="op" id="3179143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3179146">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3179149">for</span>&nbsp;<span class="op" id="3179153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3179157">n</span><span class="op" id="3179158">,</span>&nbsp;<span class="ident" id="3179160">err</span>&nbsp;<span class="op" id="3179164">=</span>&nbsp;<span class="ident" id="3179166">syscall</span><span class="op" id="3179173">.</span><span class="ident" id="3179174">Read</span><span class="op" id="3179178">(</span><span class="builtintype" id="3179179">int</span><span class="op" id="3179182">(</span><span class="ident" id="3179183">fd</span><span class="op" id="3179185">.</span><span class="ident" id="3179186">sysfd</span><span class="op" id="3179191">)</span><span class="op" id="3179192">,</span>&nbsp;<span class="ident" id="3179194">p</span><span class="op" id="3179195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3179199">if</span>&nbsp;<span class="ident" id="3179202">err</span>&nbsp;<span class="op" id="3179206">!=</span>&nbsp;<span class="ident" id="3179209">nil</span>&nbsp;<span class="op" id="3179213">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3179218">n</span>&nbsp;<span class="op" id="3179220">=</span>&nbsp;<span class="num" id="3179222">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3179227">if</span>&nbsp;<span class="ident" id="3179230">err</span>&nbsp;<span class="op" id="3179234">==</span>&nbsp;<span class="ident" id="3179237">syscall</span><span class="op" id="3179244">.</span><span class="ident" id="3179245">EAGAIN</span>&nbsp;<span class="op" id="3179252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3179258">if</span>&nbsp;<span class="ident" id="3179261">err</span>&nbsp;<span class="op" id="3179265">=</span>&nbsp;<span class="ident" id="3179267">fd</span><span class="op" id="3179269">.</span><span class="ident" id="3179270">pd</span><span class="op" id="3179272">.</span><span class="ident" id="3179273">WaitRead</span><span class="op" id="3179281">(</span><span class="op" id="3179282">)</span><span class="op" id="3179283">;</span>&nbsp;<span class="ident" id="3179285">err</span>&nbsp;<span class="op" id="3179289">==</span>&nbsp;<span class="ident" id="3179292">nil</span>&nbsp;<span class="op" id="3179296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3179303">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3179316">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3179321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3179325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3179329">err</span>&nbsp;<span class="op" id="3179333">=</span>&nbsp;<span class="ident" id="3179335">chkReadErr</span><span class="op" id="3179345">(</span><span class="ident" id="3179346">n</span><span class="op" id="3179347">,</span>&nbsp;<span class="ident" id="3179349">err</span><span class="op" id="3179352">,</span>&nbsp;<span class="ident" id="3179354">fd</span><span class="op" id="3179356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3179360">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3179367">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3179370">if</span>&nbsp;<span class="ident" id="3179373">err</span>&nbsp;<span class="op" id="3179377">!=</span>&nbsp;<span class="ident" id="3179380">nil</span>&nbsp;<span class="op" id="3179384">&amp;&amp;</span>&nbsp;<span class="ident" id="3179387">err</span>&nbsp;<span class="op" id="3179391">!=</span>&nbsp;<span class="ident" id="3179394">io</span><span class="op" id="3179396">.</span><span class="ident" id="3179397">EOF</span>&nbsp;<span class="op" id="3179401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3179405">err</span>&nbsp;<span class="op" id="3179409">=</span>&nbsp;<span class="op" id="3179411">&amp;</span><span class="ident" id="3179412">OpError</span><span class="op" id="3179419">{</span><span class="string" id="3179420">&#34;read&#34;</span><span class="op" id="3179426">,</span>&nbsp;<span class="ident" id="3179428">fd</span><span class="op" id="3179430">.</span><span class="ident" id="3179431">net</span><span class="op" id="3179434">,</span>&nbsp;<span class="ident" id="3179436">fd</span><span class="op" id="3179438">.</span><span class="ident" id="3179439">raddr</span><span class="op" id="3179444">,</span>&nbsp;<span class="ident" id="3179446">err</span><span class="op" id="3179449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3179452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3179455">return</span><br>
<span class="lineno"></span><span class="op" id="3179462">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="3179465">func</span>&nbsp;<span class="op" id="3179470">(</span><span class="ident" id="3179471">fd</span>&nbsp;<span class="op" id="3179474">*</span><span class="ident" id="3179475">netFD</span><span class="op" id="3179480">)</span>&nbsp;<span class="ident" id="3179482">readFrom</span><span class="op" id="3179490">(</span><span class="ident" id="3179491">p</span>&nbsp;<span class="op" id="3179493">[</span><span class="op" id="3179494">]</span><span class="builtintype" id="3179495">byte</span><span class="op" id="3179499">)</span>&nbsp;<span class="op" id="3179501">(</span><span class="ident" id="3179502">n</span>&nbsp;<span class="builtintype" id="3179504">int</span><span class="op" id="3179507">,</span>&nbsp;<span class="ident" id="3179509">sa</span>&nbsp;<span class="ident" id="3179512">syscall</span><span class="op" id="3179519">.</span><span class="ident" id="3179520">Sockaddr</span><span class="op" id="3179528">,</span>&nbsp;<span class="ident" id="3179530">err</span>&nbsp;<span class="builtintype" id="3179534">error</span><span class="op" id="3179539">)</span>&nbsp;<span class="op" id="3179541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3179544">if</span>&nbsp;<span class="ident" id="3179547">err</span>&nbsp;<span class="op" id="3179551">:=</span>&nbsp;<span class="ident" id="3179554">fd</span><span class="op" id="3179556">.</span><span class="ident" id="3179557">readLock</span><span class="op" id="3179565">(</span><span class="op" id="3179566">)</span><span class="op" id="3179567">;</span>&nbsp;<span class="ident" id="3179569">err</span>&nbsp;<span class="op" id="3179573">!=</span>&nbsp;<span class="ident" id="3179576">nil</span>&nbsp;<span class="op" id="3179580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3179584">return</span>&nbsp;<span class="num" id="3179591">0</span><span class="op" id="3179592">,</span>&nbsp;<span class="ident" id="3179594">nil</span><span class="op" id="3179597">,</span>&nbsp;<span class="ident" id="3179599">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3179604">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3179607">defer</span>&nbsp;<span class="ident" id="3179613">fd</span><span class="op" id="3179615">.</span><span class="ident" id="3179616">readUnlock</span><span class="op" id="3179626">(</span><span class="op" id="3179627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3179630">if</span>&nbsp;<span class="ident" id="3179633">err</span>&nbsp;<span class="op" id="3179637">:=</span>&nbsp;<span class="ident" id="3179640">fd</span><span class="op" id="3179642">.</span><span class="ident" id="3179643">pd</span><span class="op" id="3179645">.</span><span class="ident" id="3179646">PrepareRead</span><span class="op" id="3179657">(</span><span class="op" id="3179658">)</span><span class="op" id="3179659">;</span>&nbsp;<span class="ident" id="3179661">err</span>&nbsp;<span class="op" id="3179665">!=</span>&nbsp;<span class="ident" id="3179668">nil</span>&nbsp;<span class="op" id="3179672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3179676">return</span>&nbsp;<span class="num" id="3179683">0</span><span class="op" id="3179684">,</span>&nbsp;<span class="ident" id="3179686">nil</span><span class="op" id="3179689">,</span>&nbsp;<span class="op" id="3179691">&amp;</span><span class="ident" id="3179692">OpError</span><span class="op" id="3179699">{</span><span class="string" id="3179700">&#34;read&#34;</span><span class="op" id="3179706">,</span>&nbsp;<span class="ident" id="3179708">fd</span><span class="op" id="3179710">.</span><span class="ident" id="3179711">net</span><span class="op" id="3179714">,</span>&nbsp;<span class="ident" id="3179716">fd</span><span class="op" id="3179718">.</span><span class="ident" id="3179719">laddr</span><span class="op" id="3179724">,</span>&nbsp;<span class="ident" id="3179726">err</span><span class="op" id="3179729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3179732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3179735">for</span>&nbsp;<span class="op" id="3179739">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3179743">n</span><span class="op" id="3179744">,</span>&nbsp;<span class="ident" id="3179746">sa</span><span class="op" id="3179748">,</span>&nbsp;<span class="ident" id="3179750">err</span>&nbsp;<span class="op" id="3179754">=</span>&nbsp;<span class="ident" id="3179756">syscall</span><span class="op" id="3179763">.</span><span class="ident" id="3179764">Recvfrom</span><span class="op" id="3179772">(</span><span class="ident" id="3179773">fd</span><span class="op" id="3179775">.</span><span class="ident" id="3179776">sysfd</span><span class="op" id="3179781">,</span>&nbsp;<span class="ident" id="3179783">p</span><span class="op" id="3179784">,</span>&nbsp;<span class="num" id="3179786">0</span><span class="op" id="3179787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3179791">if</span>&nbsp;<span class="ident" id="3179794">err</span>&nbsp;<span class="op" id="3179798">!=</span>&nbsp;<span class="ident" id="3179801">nil</span>&nbsp;<span class="op" id="3179805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3179810">n</span>&nbsp;<span class="op" id="3179812">=</span>&nbsp;<span class="num" id="3179814">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3179819">if</span>&nbsp;<span class="ident" id="3179822">err</span>&nbsp;<span class="op" id="3179826">==</span>&nbsp;<span class="ident" id="3179829">syscall</span><span class="op" id="3179836">.</span><span class="ident" id="3179837">EAGAIN</span>&nbsp;<span class="op" id="3179844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3179850">if</span>&nbsp;<span class="ident" id="3179853">err</span>&nbsp;<span class="op" id="3179857">=</span>&nbsp;<span class="ident" id="3179859">fd</span><span class="op" id="3179861">.</span><span class="ident" id="3179862">pd</span><span class="op" id="3179864">.</span><span class="ident" id="3179865">WaitRead</span><span class="op" id="3179873">(</span><span class="op" id="3179874">)</span><span class="op" id="3179875">;</span>&nbsp;<span class="ident" id="3179877">err</span>&nbsp;<span class="op" id="3179881">==</span>&nbsp;<span class="ident" id="3179884">nil</span>&nbsp;<span class="op" id="3179888">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3179895">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3179908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3179913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3179917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3179921">err</span>&nbsp;<span class="op" id="3179925">=</span>&nbsp;<span class="ident" id="3179927">chkReadErr</span><span class="op" id="3179937">(</span><span class="ident" id="3179938">n</span><span class="op" id="3179939">,</span>&nbsp;<span class="ident" id="3179941">err</span><span class="op" id="3179944">,</span>&nbsp;<span class="ident" id="3179946">fd</span><span class="op" id="3179948">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3179952">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3179959">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3179962">if</span>&nbsp;<span class="ident" id="3179965">err</span>&nbsp;<span class="op" id="3179969">!=</span>&nbsp;<span class="ident" id="3179972">nil</span>&nbsp;<span class="op" id="3179976">&amp;&amp;</span>&nbsp;<span class="ident" id="3179979">err</span>&nbsp;<span class="op" id="3179983">!=</span>&nbsp;<span class="ident" id="3179986">io</span><span class="op" id="3179988">.</span><span class="ident" id="3179989">EOF</span>&nbsp;<span class="op" id="3179993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3179997">err</span>&nbsp;<span class="op" id="3180001">=</span>&nbsp;<span class="op" id="3180003">&amp;</span><span class="ident" id="3180004">OpError</span><span class="op" id="3180011">{</span><span class="string" id="3180012">&#34;read&#34;</span><span class="op" id="3180018">,</span>&nbsp;<span class="ident" id="3180020">fd</span><span class="op" id="3180022">.</span><span class="ident" id="3180023">net</span><span class="op" id="3180026">,</span>&nbsp;<span class="ident" id="3180028">fd</span><span class="op" id="3180030">.</span><span class="ident" id="3180031">laddr</span><span class="op" id="3180036">,</span>&nbsp;<span class="ident" id="3180038">err</span><span class="op" id="3180041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3180044">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3180047">return</span><br>
<span class="lineno"></span><span class="op" id="3180054">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3180057">func</span>&nbsp;<span class="op" id="3180062">(</span><span class="ident" id="3180063">fd</span>&nbsp;<span class="op" id="3180066">*</span><span class="ident" id="3180067">netFD</span><span class="op" id="3180072">)</span>&nbsp;<span class="ident" id="3180074">readMsg</span><span class="op" id="3180081">(</span><span class="ident" id="3180082">p</span>&nbsp;<span class="op" id="3180084">[</span><span class="op" id="3180085">]</span><span class="builtintype" id="3180086">byte</span><span class="op" id="3180090">,</span>&nbsp;<span class="ident" id="3180092">oob</span>&nbsp;<span class="op" id="3180096">[</span><span class="op" id="3180097">]</span><span class="builtintype" id="3180098">byte</span><span class="op" id="3180102">)</span>&nbsp;<span class="op" id="3180104">(</span><span class="ident" id="3180105">n</span><span class="op" id="3180106">,</span>&nbsp;<span class="ident" id="3180108">oobn</span><span class="op" id="3180112">,</span>&nbsp;<span class="ident" id="3180114">flags</span>&nbsp;<span class="builtintype" id="3180120">int</span><span class="op" id="3180123">,</span>&nbsp;<span class="ident" id="3180125">sa</span>&nbsp;<span class="ident" id="3180128">syscall</span><span class="op" id="3180135">.</span><span class="ident" id="3180136">Sockaddr</span><span class="op" id="3180144">,</span>&nbsp;<span class="ident" id="3180146">err</span>&nbsp;<span class="builtintype" id="3180150">error</span><span class="op" id="3180155">)</span>&nbsp;<span class="op" id="3180157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3180160">if</span>&nbsp;<span class="ident" id="3180163">err</span>&nbsp;<span class="op" id="3180167">:=</span>&nbsp;<span class="ident" id="3180170">fd</span><span class="op" id="3180172">.</span><span class="ident" id="3180173">readLock</span><span class="op" id="3180181">(</span><span class="op" id="3180182">)</span><span class="op" id="3180183">;</span>&nbsp;<span class="ident" id="3180185">err</span>&nbsp;<span class="op" id="3180189">!=</span>&nbsp;<span class="ident" id="3180192">nil</span>&nbsp;<span class="op" id="3180196">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3180200">return</span>&nbsp;<span class="num" id="3180207">0</span><span class="op" id="3180208">,</span>&nbsp;<span class="num" id="3180210">0</span><span class="op" id="3180211">,</span>&nbsp;<span class="num" id="3180213">0</span><span class="op" id="3180214">,</span>&nbsp;<span class="ident" id="3180216">nil</span><span class="op" id="3180219">,</span>&nbsp;<span class="ident" id="3180221">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3180226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3180229">defer</span>&nbsp;<span class="ident" id="3180235">fd</span><span class="op" id="3180237">.</span><span class="ident" id="3180238">readUnlock</span><span class="op" id="3180248">(</span><span class="op" id="3180249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3180252">if</span>&nbsp;<span class="ident" id="3180255">err</span>&nbsp;<span class="op" id="3180259">:=</span>&nbsp;<span class="ident" id="3180262">fd</span><span class="op" id="3180264">.</span><span class="ident" id="3180265">pd</span><span class="op" id="3180267">.</span><span class="ident" id="3180268">PrepareRead</span><span class="op" id="3180279">(</span><span class="op" id="3180280">)</span><span class="op" id="3180281">;</span>&nbsp;<span class="ident" id="3180283">err</span>&nbsp;<span class="op" id="3180287">!=</span>&nbsp;<span class="ident" id="3180290">nil</span>&nbsp;<span class="op" id="3180294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3180298">return</span>&nbsp;<span class="num" id="3180305">0</span><span class="op" id="3180306">,</span>&nbsp;<span class="num" id="3180308">0</span><span class="op" id="3180309">,</span>&nbsp;<span class="num" id="3180311">0</span><span class="op" id="3180312">,</span>&nbsp;<span class="ident" id="3180314">nil</span><span class="op" id="3180317">,</span>&nbsp;<span class="op" id="3180319">&amp;</span><span class="ident" id="3180320">OpError</span><span class="op" id="3180327">{</span><span class="string" id="3180328">&#34;read&#34;</span><span class="op" id="3180334">,</span>&nbsp;<span class="ident" id="3180336">fd</span><span class="op" id="3180338">.</span><span class="ident" id="3180339">net</span><span class="op" id="3180342">,</span>&nbsp;<span class="ident" id="3180344">fd</span><span class="op" id="3180346">.</span><span class="ident" id="3180347">laddr</span><span class="op" id="3180352">,</span>&nbsp;<span class="ident" id="3180354">err</span><span class="op" id="3180357">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3180360">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3180363">for</span>&nbsp;<span class="op" id="3180367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3180371">n</span><span class="op" id="3180372">,</span>&nbsp;<span class="ident" id="3180374">oobn</span><span class="op" id="3180378">,</span>&nbsp;<span class="ident" id="3180380">flags</span><span class="op" id="3180385">,</span>&nbsp;<span class="ident" id="3180387">sa</span><span class="op" id="3180389">,</span>&nbsp;<span class="ident" id="3180391">err</span>&nbsp;<span class="op" id="3180395">=</span>&nbsp;<span class="ident" id="3180397">syscall</span><span class="op" id="3180404">.</span><span class="ident" id="3180405">Recvmsg</span><span class="op" id="3180412">(</span><span class="ident" id="3180413">fd</span><span class="op" id="3180415">.</span><span class="ident" id="3180416">sysfd</span><span class="op" id="3180421">,</span>&nbsp;<span class="ident" id="3180423">p</span><span class="op" id="3180424">,</span>&nbsp;<span class="ident" id="3180426">oob</span><span class="op" id="3180429">,</span>&nbsp;<span class="num" id="3180431">0</span><span class="op" id="3180432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3180436">if</span>&nbsp;<span class="ident" id="3180439">err</span>&nbsp;<span class="op" id="3180443">!=</span>&nbsp;<span class="ident" id="3180446">nil</span>&nbsp;<span class="op" id="3180450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3180455">//&nbsp;TODO(dfc)&nbsp;should&nbsp;n&nbsp;and&nbsp;oobn&nbsp;be&nbsp;set&nbsp;to&nbsp;0</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3180501">if</span>&nbsp;<span class="ident" id="3180504">err</span>&nbsp;<span class="op" id="3180508">==</span>&nbsp;<span class="ident" id="3180511">syscall</span><span class="op" id="3180518">.</span><span class="ident" id="3180519">EAGAIN</span>&nbsp;<span class="op" id="3180526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3180532">if</span>&nbsp;<span class="ident" id="3180535">err</span>&nbsp;<span class="op" id="3180539">=</span>&nbsp;<span class="ident" id="3180541">fd</span><span class="op" id="3180543">.</span><span class="ident" id="3180544">pd</span><span class="op" id="3180546">.</span><span class="ident" id="3180547">WaitRead</span><span class="op" id="3180555">(</span><span class="op" id="3180556">)</span><span class="op" id="3180557">;</span>&nbsp;<span class="ident" id="3180559">err</span>&nbsp;<span class="op" id="3180563">==</span>&nbsp;<span class="ident" id="3180566">nil</span>&nbsp;<span class="op" id="3180570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3180577">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3180590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3180595">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3180599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3180603">err</span>&nbsp;<span class="op" id="3180607">=</span>&nbsp;<span class="ident" id="3180609">chkReadErr</span><span class="op" id="3180619">(</span><span class="ident" id="3180620">n</span><span class="op" id="3180621">,</span>&nbsp;<span class="ident" id="3180623">err</span><span class="op" id="3180626">,</span>&nbsp;<span class="ident" id="3180628">fd</span><span class="op" id="3180630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3180634">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3180641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3180644">if</span>&nbsp;<span class="ident" id="3180647">err</span>&nbsp;<span class="op" id="3180651">!=</span>&nbsp;<span class="ident" id="3180654">nil</span>&nbsp;<span class="op" id="3180658">&amp;&amp;</span>&nbsp;<span class="ident" id="3180661">err</span>&nbsp;<span class="op" id="3180665">!=</span>&nbsp;<span class="ident" id="3180668">io</span><span class="op" id="3180670">.</span><span class="ident" id="3180671">EOF</span>&nbsp;<span class="op" id="3180675">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3180679">err</span>&nbsp;<span class="op" id="3180683">=</span>&nbsp;<span class="op" id="3180685">&amp;</span><span class="ident" id="3180686">OpError</span><span class="op" id="3180693">{</span><span class="string" id="3180694">&#34;read&#34;</span><span class="op" id="3180700">,</span>&nbsp;<span class="ident" id="3180702">fd</span><span class="op" id="3180704">.</span><span class="ident" id="3180705">net</span><span class="op" id="3180708">,</span>&nbsp;<span class="ident" id="3180710">fd</span><span class="op" id="3180712">.</span><span class="ident" id="3180713">laddr</span><span class="op" id="3180718">,</span>&nbsp;<span class="ident" id="3180720">err</span><span class="op" id="3180723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3180726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3180729">return</span><br>
<span class="lineno"></span><span class="op" id="3180736">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">310</span><span class="keyword" id="3180739">func</span>&nbsp;<span class="ident" id="3180744">chkReadErr</span><span class="op" id="3180754">(</span><span class="ident" id="3180755">n</span>&nbsp;<span class="builtintype" id="3180757">int</span><span class="op" id="3180760">,</span>&nbsp;<span class="ident" id="3180762">err</span>&nbsp;<span class="builtintype" id="3180766">error</span><span class="op" id="3180771">,</span>&nbsp;<span class="ident" id="3180773">fd</span>&nbsp;<span class="op" id="3180776">*</span><span class="ident" id="3180777">netFD</span><span class="op" id="3180782">)</span>&nbsp;<span class="builtintype" id="3180784">error</span>&nbsp;<span class="op" id="3180790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3180793">if</span>&nbsp;<span class="ident" id="3180796">n</span>&nbsp;<span class="op" id="3180798">==</span>&nbsp;<span class="num" id="3180801">0</span>&nbsp;<span class="op" id="3180803">&amp;&amp;</span>&nbsp;<span class="ident" id="3180806">err</span>&nbsp;<span class="op" id="3180810">==</span>&nbsp;<span class="ident" id="3180813">nil</span>&nbsp;<span class="op" id="3180817">&amp;&amp;</span>&nbsp;<span class="ident" id="3180820">fd</span><span class="op" id="3180822">.</span><span class="ident" id="3180823">sotype</span>&nbsp;<span class="op" id="3180830">!=</span>&nbsp;<span class="ident" id="3180833">syscall</span><span class="op" id="3180840">.</span><span class="ident" id="3180841">SOCK_DGRAM</span>&nbsp;<span class="op" id="3180852">&amp;&amp;</span>&nbsp;<span class="ident" id="3180855">fd</span><span class="op" id="3180857">.</span><span class="ident" id="3180858">sotype</span>&nbsp;<span class="op" id="3180865">!=</span>&nbsp;<span class="ident" id="3180868">syscall</span><span class="op" id="3180875">.</span><span class="ident" id="3180876">SOCK_RAW</span>&nbsp;<span class="op" id="3180885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3180889">return</span>&nbsp;<span class="ident" id="3180896">io</span><span class="op" id="3180898">.</span><span class="ident" id="3180899">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3180904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3180907">return</span>&nbsp;<span class="ident" id="3180914">err</span><br>
<span class="lineno">315</span><span class="op" id="3180918">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3180921">func</span>&nbsp;<span class="op" id="3180926">(</span><span class="ident" id="3180927">fd</span>&nbsp;<span class="op" id="3180930">*</span><span class="ident" id="3180931">netFD</span><span class="op" id="3180936">)</span>&nbsp;<span class="ident" id="3180938">Write</span><span class="op" id="3180943">(</span><span class="ident" id="3180944">p</span>&nbsp;<span class="op" id="3180946">[</span><span class="op" id="3180947">]</span><span class="builtintype" id="3180948">byte</span><span class="op" id="3180952">)</span>&nbsp;<span class="op" id="3180954">(</span><span class="ident" id="3180955">nn</span>&nbsp;<span class="builtintype" id="3180958">int</span><span class="op" id="3180961">,</span>&nbsp;<span class="ident" id="3180963">err</span>&nbsp;<span class="builtintype" id="3180967">error</span><span class="op" id="3180972">)</span>&nbsp;<span class="op" id="3180974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3180977">if</span>&nbsp;<span class="ident" id="3180980">err</span>&nbsp;<span class="op" id="3180984">:=</span>&nbsp;<span class="ident" id="3180987">fd</span><span class="op" id="3180989">.</span><span class="ident" id="3180990">writeLock</span><span class="op" id="3180999">(</span><span class="op" id="3181000">)</span><span class="op" id="3181001">;</span>&nbsp;<span class="ident" id="3181003">err</span>&nbsp;<span class="op" id="3181007">!=</span>&nbsp;<span class="ident" id="3181010">nil</span>&nbsp;<span class="op" id="3181014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3181018">return</span>&nbsp;<span class="num" id="3181025">0</span><span class="op" id="3181026">,</span>&nbsp;<span class="ident" id="3181028">err</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3181033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3181036">defer</span>&nbsp;<span class="ident" id="3181042">fd</span><span class="op" id="3181044">.</span><span class="ident" id="3181045">writeUnlock</span><span class="op" id="3181056">(</span><span class="op" id="3181057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3181060">if</span>&nbsp;<span class="ident" id="3181063">err</span>&nbsp;<span class="op" id="3181067">:=</span>&nbsp;<span class="ident" id="3181070">fd</span><span class="op" id="3181072">.</span><span class="ident" id="3181073">pd</span><span class="op" id="3181075">.</span><span class="ident" id="3181076">PrepareWrite</span><span class="op" id="3181088">(</span><span class="op" id="3181089">)</span><span class="op" id="3181090">;</span>&nbsp;<span class="ident" id="3181092">err</span>&nbsp;<span class="op" id="3181096">!=</span>&nbsp;<span class="ident" id="3181099">nil</span>&nbsp;<span class="op" id="3181103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3181107">return</span>&nbsp;<span class="num" id="3181114">0</span><span class="op" id="3181115">,</span>&nbsp;<span class="op" id="3181117">&amp;</span><span class="ident" id="3181118">OpError</span><span class="op" id="3181125">{</span><span class="string" id="3181126">&#34;write&#34;</span><span class="op" id="3181133">,</span>&nbsp;<span class="ident" id="3181135">fd</span><span class="op" id="3181137">.</span><span class="ident" id="3181138">net</span><span class="op" id="3181141">,</span>&nbsp;<span class="ident" id="3181143">fd</span><span class="op" id="3181145">.</span><span class="ident" id="3181146">raddr</span><span class="op" id="3181151">,</span>&nbsp;<span class="ident" id="3181153">err</span><span class="op" id="3181156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3181159">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3181162">for</span>&nbsp;<span class="op" id="3181166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3181170">var</span>&nbsp;<span class="ident" id="3181174">n</span>&nbsp;<span class="builtintype" id="3181176">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3181182">n</span><span class="op" id="3181183">,</span>&nbsp;<span class="ident" id="3181185">err</span>&nbsp;<span class="op" id="3181189">=</span>&nbsp;<span class="ident" id="3181191">syscall</span><span class="op" id="3181198">.</span><span class="ident" id="3181199">Write</span><span class="op" id="3181204">(</span><span class="builtintype" id="3181205">int</span><span class="op" id="3181208">(</span><span class="ident" id="3181209">fd</span><span class="op" id="3181211">.</span><span class="ident" id="3181212">sysfd</span><span class="op" id="3181217">)</span><span class="op" id="3181218">,</span>&nbsp;<span class="ident" id="3181220">p</span><span class="op" id="3181221">[</span><span class="ident" id="3181222">nn</span><span class="op" id="3181224">:</span><span class="op" id="3181225">]</span><span class="op" id="3181226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3181230">if</span>&nbsp;<span class="ident" id="3181233">n</span>&nbsp;<span class="op" id="3181235">&gt;</span>&nbsp;<span class="num" id="3181237">0</span>&nbsp;<span class="op" id="3181239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3181244">nn</span>&nbsp;<span class="op" id="3181247">+=</span>&nbsp;<span class="ident" id="3181250">n</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3181254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3181258">if</span>&nbsp;<span class="ident" id="3181261">nn</span>&nbsp;<span class="op" id="3181264">==</span>&nbsp;<span class="builtinfunc" id="3181267">len</span><span class="op" id="3181270">(</span><span class="ident" id="3181271">p</span><span class="op" id="3181272">)</span>&nbsp;<span class="op" id="3181274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3181279">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3181287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3181291">if</span>&nbsp;<span class="ident" id="3181294">err</span>&nbsp;<span class="op" id="3181298">==</span>&nbsp;<span class="ident" id="3181301">syscall</span><span class="op" id="3181308">.</span><span class="ident" id="3181309">EAGAIN</span>&nbsp;<span class="op" id="3181316">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3181321">if</span>&nbsp;<span class="ident" id="3181324">err</span>&nbsp;<span class="op" id="3181328">=</span>&nbsp;<span class="ident" id="3181330">fd</span><span class="op" id="3181332">.</span><span class="ident" id="3181333">pd</span><span class="op" id="3181335">.</span><span class="ident" id="3181336">WaitWrite</span><span class="op" id="3181345">(</span><span class="op" id="3181346">)</span><span class="op" id="3181347">;</span>&nbsp;<span class="ident" id="3181349">err</span>&nbsp;<span class="op" id="3181353">==</span>&nbsp;<span class="ident" id="3181356">nil</span>&nbsp;<span class="op" id="3181360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3181366">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3181378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3181382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3181386">if</span>&nbsp;<span class="ident" id="3181389">err</span>&nbsp;<span class="op" id="3181393">!=</span>&nbsp;<span class="ident" id="3181396">nil</span>&nbsp;<span class="op" id="3181400">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3181405">n</span>&nbsp;<span class="op" id="3181407">=</span>&nbsp;<span class="num" id="3181409">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3181414">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3181422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3181426">if</span>&nbsp;<span class="ident" id="3181429">n</span>&nbsp;<span class="op" id="3181431">==</span>&nbsp;<span class="num" id="3181434">0</span>&nbsp;<span class="op" id="3181436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3181441">err</span>&nbsp;<span class="op" id="3181445">=</span>&nbsp;<span class="ident" id="3181447">io</span><span class="op" id="3181449">.</span><span class="ident" id="3181450">ErrUnexpectedEOF</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3181470">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3181478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3181481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3181484">if</span>&nbsp;<span class="ident" id="3181487">err</span>&nbsp;<span class="op" id="3181491">!=</span>&nbsp;<span class="ident" id="3181494">nil</span>&nbsp;<span class="op" id="3181498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3181502">err</span>&nbsp;<span class="op" id="3181506">=</span>&nbsp;<span class="op" id="3181508">&amp;</span><span class="ident" id="3181509">OpError</span><span class="op" id="3181516">{</span><span class="string" id="3181517">&#34;write&#34;</span><span class="op" id="3181524">,</span>&nbsp;<span class="ident" id="3181526">fd</span><span class="op" id="3181528">.</span><span class="ident" id="3181529">net</span><span class="op" id="3181532">,</span>&nbsp;<span class="ident" id="3181534">fd</span><span class="op" id="3181536">.</span><span class="ident" id="3181537">raddr</span><span class="op" id="3181542">,</span>&nbsp;<span class="ident" id="3181544">err</span><span class="op" id="3181547">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3181550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3181553">return</span>&nbsp;<span class="ident" id="3181560">nn</span><span class="op" id="3181562">,</span>&nbsp;<span class="ident" id="3181564">err</span><br>
<span class="lineno"></span><span class="op" id="3181568">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3181571">func</span>&nbsp;<span class="op" id="3181576">(</span><span class="ident" id="3181577">fd</span>&nbsp;<span class="op" id="3181580">*</span><span class="ident" id="3181581">netFD</span><span class="op" id="3181586">)</span>&nbsp;<span class="ident" id="3181588">writeTo</span><span class="op" id="3181595">(</span><span class="ident" id="3181596">p</span>&nbsp;<span class="op" id="3181598">[</span><span class="op" id="3181599">]</span><span class="builtintype" id="3181600">byte</span><span class="op" id="3181604">,</span>&nbsp;<span class="ident" id="3181606">sa</span>&nbsp;<span class="ident" id="3181609">syscall</span><span class="op" id="3181616">.</span><span class="ident" id="3181617">Sockaddr</span><span class="op" id="3181625">)</span>&nbsp;<span class="op" id="3181627">(</span><span class="ident" id="3181628">n</span>&nbsp;<span class="builtintype" id="3181630">int</span><span class="op" id="3181633">,</span>&nbsp;<span class="ident" id="3181635">err</span>&nbsp;<span class="builtintype" id="3181639">error</span><span class="op" id="3181644">)</span>&nbsp;<span class="op" id="3181646">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3181649">if</span>&nbsp;<span class="ident" id="3181652">err</span>&nbsp;<span class="op" id="3181656">:=</span>&nbsp;<span class="ident" id="3181659">fd</span><span class="op" id="3181661">.</span><span class="ident" id="3181662">writeLock</span><span class="op" id="3181671">(</span><span class="op" id="3181672">)</span><span class="op" id="3181673">;</span>&nbsp;<span class="ident" id="3181675">err</span>&nbsp;<span class="op" id="3181679">!=</span>&nbsp;<span class="ident" id="3181682">nil</span>&nbsp;<span class="op" id="3181686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3181690">return</span>&nbsp;<span class="num" id="3181697">0</span><span class="op" id="3181698">,</span>&nbsp;<span class="ident" id="3181700">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3181705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3181708">defer</span>&nbsp;<span class="ident" id="3181714">fd</span><span class="op" id="3181716">.</span><span class="ident" id="3181717">writeUnlock</span><span class="op" id="3181728">(</span><span class="op" id="3181729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3181732">if</span>&nbsp;<span class="ident" id="3181735">err</span>&nbsp;<span class="op" id="3181739">:=</span>&nbsp;<span class="ident" id="3181742">fd</span><span class="op" id="3181744">.</span><span class="ident" id="3181745">pd</span><span class="op" id="3181747">.</span><span class="ident" id="3181748">PrepareWrite</span><span class="op" id="3181760">(</span><span class="op" id="3181761">)</span><span class="op" id="3181762">;</span>&nbsp;<span class="ident" id="3181764">err</span>&nbsp;<span class="op" id="3181768">!=</span>&nbsp;<span class="ident" id="3181771">nil</span>&nbsp;<span class="op" id="3181775">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3181779">return</span>&nbsp;<span class="num" id="3181786">0</span><span class="op" id="3181787">,</span>&nbsp;<span class="op" id="3181789">&amp;</span><span class="ident" id="3181790">OpError</span><span class="op" id="3181797">{</span><span class="string" id="3181798">&#34;write&#34;</span><span class="op" id="3181805">,</span>&nbsp;<span class="ident" id="3181807">fd</span><span class="op" id="3181809">.</span><span class="ident" id="3181810">net</span><span class="op" id="3181813">,</span>&nbsp;<span class="ident" id="3181815">fd</span><span class="op" id="3181817">.</span><span class="ident" id="3181818">raddr</span><span class="op" id="3181823">,</span>&nbsp;<span class="ident" id="3181825">err</span><span class="op" id="3181828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3181831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3181834">for</span>&nbsp;<span class="op" id="3181838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3181842">err</span>&nbsp;<span class="op" id="3181846">=</span>&nbsp;<span class="ident" id="3181848">syscall</span><span class="op" id="3181855">.</span><span class="ident" id="3181856">Sendto</span><span class="op" id="3181862">(</span><span class="ident" id="3181863">fd</span><span class="op" id="3181865">.</span><span class="ident" id="3181866">sysfd</span><span class="op" id="3181871">,</span>&nbsp;<span class="ident" id="3181873">p</span><span class="op" id="3181874">,</span>&nbsp;<span class="num" id="3181876">0</span><span class="op" id="3181877">,</span>&nbsp;<span class="ident" id="3181879">sa</span><span class="op" id="3181881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3181885">if</span>&nbsp;<span class="ident" id="3181888">err</span>&nbsp;<span class="op" id="3181892">==</span>&nbsp;<span class="ident" id="3181895">syscall</span><span class="op" id="3181902">.</span><span class="ident" id="3181903">EAGAIN</span>&nbsp;<span class="op" id="3181910">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3181915">if</span>&nbsp;<span class="ident" id="3181918">err</span>&nbsp;<span class="op" id="3181922">=</span>&nbsp;<span class="ident" id="3181924">fd</span><span class="op" id="3181926">.</span><span class="ident" id="3181927">pd</span><span class="op" id="3181929">.</span><span class="ident" id="3181930">WaitWrite</span><span class="op" id="3181939">(</span><span class="op" id="3181940">)</span><span class="op" id="3181941">;</span>&nbsp;<span class="ident" id="3181943">err</span>&nbsp;<span class="op" id="3181947">==</span>&nbsp;<span class="ident" id="3181950">nil</span>&nbsp;<span class="op" id="3181954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3181960">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3181972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3181976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3181980">break</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3181987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3181990">if</span>&nbsp;<span class="ident" id="3181993">err</span>&nbsp;<span class="op" id="3181997">==</span>&nbsp;<span class="ident" id="3182000">nil</span>&nbsp;<span class="op" id="3182004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3182008">n</span>&nbsp;<span class="op" id="3182010">=</span>&nbsp;<span class="builtinfunc" id="3182012">len</span><span class="op" id="3182015">(</span><span class="ident" id="3182016">p</span><span class="op" id="3182017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3182020">}</span>&nbsp;<span class="keyword" id="3182022">else</span>&nbsp;<span class="op" id="3182027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3182031">err</span>&nbsp;<span class="op" id="3182035">=</span>&nbsp;<span class="op" id="3182037">&amp;</span><span class="ident" id="3182038">OpError</span><span class="op" id="3182045">{</span><span class="string" id="3182046">&#34;write&#34;</span><span class="op" id="3182053">,</span>&nbsp;<span class="ident" id="3182055">fd</span><span class="op" id="3182057">.</span><span class="ident" id="3182058">net</span><span class="op" id="3182061">,</span>&nbsp;<span class="ident" id="3182063">fd</span><span class="op" id="3182065">.</span><span class="ident" id="3182066">raddr</span><span class="op" id="3182071">,</span>&nbsp;<span class="ident" id="3182073">err</span><span class="op" id="3182076">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3182079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3182082">return</span><br>
<span class="lineno"></span><span class="op" id="3182089">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3182092">func</span>&nbsp;<span class="op" id="3182097">(</span><span class="ident" id="3182098">fd</span>&nbsp;<span class="op" id="3182101">*</span><span class="ident" id="3182102">netFD</span><span class="op" id="3182107">)</span>&nbsp;<span class="ident" id="3182109">writeMsg</span><span class="op" id="3182117">(</span><span class="ident" id="3182118">p</span>&nbsp;<span class="op" id="3182120">[</span><span class="op" id="3182121">]</span><span class="builtintype" id="3182122">byte</span><span class="op" id="3182126">,</span>&nbsp;<span class="ident" id="3182128">oob</span>&nbsp;<span class="op" id="3182132">[</span><span class="op" id="3182133">]</span><span class="builtintype" id="3182134">byte</span><span class="op" id="3182138">,</span>&nbsp;<span class="ident" id="3182140">sa</span>&nbsp;<span class="ident" id="3182143">syscall</span><span class="op" id="3182150">.</span><span class="ident" id="3182151">Sockaddr</span><span class="op" id="3182159">)</span>&nbsp;<span class="op" id="3182161">(</span><span class="ident" id="3182162">n</span>&nbsp;<span class="builtintype" id="3182164">int</span><span class="op" id="3182167">,</span>&nbsp;<span class="ident" id="3182169">oobn</span>&nbsp;<span class="builtintype" id="3182174">int</span><span class="op" id="3182177">,</span>&nbsp;<span class="ident" id="3182179">err</span>&nbsp;<span class="builtintype" id="3182183">error</span><span class="op" id="3182188">)</span>&nbsp;<span class="op" id="3182190">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3182193">if</span>&nbsp;<span class="ident" id="3182196">err</span>&nbsp;<span class="op" id="3182200">:=</span>&nbsp;<span class="ident" id="3182203">fd</span><span class="op" id="3182205">.</span><span class="ident" id="3182206">writeLock</span><span class="op" id="3182215">(</span><span class="op" id="3182216">)</span><span class="op" id="3182217">;</span>&nbsp;<span class="ident" id="3182219">err</span>&nbsp;<span class="op" id="3182223">!=</span>&nbsp;<span class="ident" id="3182226">nil</span>&nbsp;<span class="op" id="3182230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3182234">return</span>&nbsp;<span class="num" id="3182241">0</span><span class="op" id="3182242">,</span>&nbsp;<span class="num" id="3182244">0</span><span class="op" id="3182245">,</span>&nbsp;<span class="ident" id="3182247">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3182252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3182255">defer</span>&nbsp;<span class="ident" id="3182261">fd</span><span class="op" id="3182263">.</span><span class="ident" id="3182264">writeUnlock</span><span class="op" id="3182275">(</span><span class="op" id="3182276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3182279">if</span>&nbsp;<span class="ident" id="3182282">err</span>&nbsp;<span class="op" id="3182286">:=</span>&nbsp;<span class="ident" id="3182289">fd</span><span class="op" id="3182291">.</span><span class="ident" id="3182292">pd</span><span class="op" id="3182294">.</span><span class="ident" id="3182295">PrepareWrite</span><span class="op" id="3182307">(</span><span class="op" id="3182308">)</span><span class="op" id="3182309">;</span>&nbsp;<span class="ident" id="3182311">err</span>&nbsp;<span class="op" id="3182315">!=</span>&nbsp;<span class="ident" id="3182318">nil</span>&nbsp;<span class="op" id="3182322">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3182326">return</span>&nbsp;<span class="num" id="3182333">0</span><span class="op" id="3182334">,</span>&nbsp;<span class="num" id="3182336">0</span><span class="op" id="3182337">,</span>&nbsp;<span class="op" id="3182339">&amp;</span><span class="ident" id="3182340">OpError</span><span class="op" id="3182347">{</span><span class="string" id="3182348">&#34;write&#34;</span><span class="op" id="3182355">,</span>&nbsp;<span class="ident" id="3182357">fd</span><span class="op" id="3182359">.</span><span class="ident" id="3182360">net</span><span class="op" id="3182363">,</span>&nbsp;<span class="ident" id="3182365">fd</span><span class="op" id="3182367">.</span><span class="ident" id="3182368">raddr</span><span class="op" id="3182373">,</span>&nbsp;<span class="ident" id="3182375">err</span><span class="op" id="3182378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3182381">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3182384">for</span>&nbsp;<span class="op" id="3182388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3182392">n</span><span class="op" id="3182393">,</span>&nbsp;<span class="ident" id="3182395">err</span>&nbsp;<span class="op" id="3182399">=</span>&nbsp;<span class="ident" id="3182401">syscall</span><span class="op" id="3182408">.</span><span class="ident" id="3182409">SendmsgN</span><span class="op" id="3182417">(</span><span class="ident" id="3182418">fd</span><span class="op" id="3182420">.</span><span class="ident" id="3182421">sysfd</span><span class="op" id="3182426">,</span>&nbsp;<span class="ident" id="3182428">p</span><span class="op" id="3182429">,</span>&nbsp;<span class="ident" id="3182431">oob</span><span class="op" id="3182434">,</span>&nbsp;<span class="ident" id="3182436">sa</span><span class="op" id="3182438">,</span>&nbsp;<span class="num" id="3182440">0</span><span class="op" id="3182441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3182445">if</span>&nbsp;<span class="ident" id="3182448">err</span>&nbsp;<span class="op" id="3182452">==</span>&nbsp;<span class="ident" id="3182455">syscall</span><span class="op" id="3182462">.</span><span class="ident" id="3182463">EAGAIN</span>&nbsp;<span class="op" id="3182470">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3182475">if</span>&nbsp;<span class="ident" id="3182478">err</span>&nbsp;<span class="op" id="3182482">=</span>&nbsp;<span class="ident" id="3182484">fd</span><span class="op" id="3182486">.</span><span class="ident" id="3182487">pd</span><span class="op" id="3182489">.</span><span class="ident" id="3182490">WaitWrite</span><span class="op" id="3182499">(</span><span class="op" id="3182500">)</span><span class="op" id="3182501">;</span>&nbsp;<span class="ident" id="3182503">err</span>&nbsp;<span class="op" id="3182507">==</span>&nbsp;<span class="ident" id="3182510">nil</span>&nbsp;<span class="op" id="3182514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3182520">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3182532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3182536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3182540">break</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3182547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3182550">if</span>&nbsp;<span class="ident" id="3182553">err</span>&nbsp;<span class="op" id="3182557">==</span>&nbsp;<span class="ident" id="3182560">nil</span>&nbsp;<span class="op" id="3182564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3182568">oobn</span>&nbsp;<span class="op" id="3182573">=</span>&nbsp;<span class="builtinfunc" id="3182575">len</span><span class="op" id="3182578">(</span><span class="ident" id="3182579">oob</span><span class="op" id="3182582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3182585">}</span>&nbsp;<span class="keyword" id="3182587">else</span>&nbsp;<span class="op" id="3182592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3182596">err</span>&nbsp;<span class="op" id="3182600">=</span>&nbsp;<span class="op" id="3182602">&amp;</span><span class="ident" id="3182603">OpError</span><span class="op" id="3182610">{</span><span class="string" id="3182611">&#34;write&#34;</span><span class="op" id="3182618">,</span>&nbsp;<span class="ident" id="3182620">fd</span><span class="op" id="3182622">.</span><span class="ident" id="3182623">net</span><span class="op" id="3182626">,</span>&nbsp;<span class="ident" id="3182628">fd</span><span class="op" id="3182630">.</span><span class="ident" id="3182631">raddr</span><span class="op" id="3182636">,</span>&nbsp;<span class="ident" id="3182638">err</span><span class="op" id="3182641">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3182644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3182647">return</span><br>
<span class="lineno"></span><span class="op" id="3182654">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3182657">func</span>&nbsp;<span class="op" id="3182662">(</span><span class="ident" id="3182663">fd</span>&nbsp;<span class="op" id="3182666">*</span><span class="ident" id="3182667">netFD</span><span class="op" id="3182672">)</span>&nbsp;<span class="ident" id="3182674">accept</span><span class="op" id="3182680">(</span><span class="op" id="3182681">)</span>&nbsp;<span class="op" id="3182683">(</span><span class="ident" id="3182684">netfd</span>&nbsp;<span class="op" id="3182690">*</span><span class="ident" id="3182691">netFD</span><span class="op" id="3182696">,</span>&nbsp;<span class="ident" id="3182698">err</span>&nbsp;<span class="builtintype" id="3182702">error</span><span class="op" id="3182707">)</span>&nbsp;<span class="op" id="3182709">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3182712">if</span>&nbsp;<span class="ident" id="3182715">err</span>&nbsp;<span class="op" id="3182719">:=</span>&nbsp;<span class="ident" id="3182722">fd</span><span class="op" id="3182724">.</span><span class="ident" id="3182725">readLock</span><span class="op" id="3182733">(</span><span class="op" id="3182734">)</span><span class="op" id="3182735">;</span>&nbsp;<span class="ident" id="3182737">err</span>&nbsp;<span class="op" id="3182741">!=</span>&nbsp;<span class="ident" id="3182744">nil</span>&nbsp;<span class="op" id="3182748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3182752">return</span>&nbsp;<span class="ident" id="3182759">nil</span><span class="op" id="3182762">,</span>&nbsp;<span class="ident" id="3182764">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3182769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3182772">defer</span>&nbsp;<span class="ident" id="3182778">fd</span><span class="op" id="3182780">.</span><span class="ident" id="3182781">readUnlock</span><span class="op" id="3182791">(</span><span class="op" id="3182792">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3182796">var</span>&nbsp;<span class="ident" id="3182800">s</span>&nbsp;<span class="builtintype" id="3182802">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3182807">var</span>&nbsp;<span class="ident" id="3182811">rsa</span>&nbsp;<span class="ident" id="3182815">syscall</span><span class="op" id="3182822">.</span><span class="ident" id="3182823">Sockaddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3182833">if</span>&nbsp;<span class="ident" id="3182836">err</span>&nbsp;<span class="op" id="3182840">=</span>&nbsp;<span class="ident" id="3182842">fd</span><span class="op" id="3182844">.</span><span class="ident" id="3182845">pd</span><span class="op" id="3182847">.</span><span class="ident" id="3182848">PrepareRead</span><span class="op" id="3182859">(</span><span class="op" id="3182860">)</span><span class="op" id="3182861">;</span>&nbsp;<span class="ident" id="3182863">err</span>&nbsp;<span class="op" id="3182867">!=</span>&nbsp;<span class="ident" id="3182870">nil</span>&nbsp;<span class="op" id="3182874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3182878">return</span>&nbsp;<span class="ident" id="3182885">nil</span><span class="op" id="3182888">,</span>&nbsp;<span class="op" id="3182890">&amp;</span><span class="ident" id="3182891">OpError</span><span class="op" id="3182898">{</span><span class="string" id="3182899">&#34;accept&#34;</span><span class="op" id="3182907">,</span>&nbsp;<span class="ident" id="3182909">fd</span><span class="op" id="3182911">.</span><span class="ident" id="3182912">net</span><span class="op" id="3182915">,</span>&nbsp;<span class="ident" id="3182917">fd</span><span class="op" id="3182919">.</span><span class="ident" id="3182920">laddr</span><span class="op" id="3182925">,</span>&nbsp;<span class="ident" id="3182927">err</span><span class="op" id="3182930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3182933">}</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3182936">for</span>&nbsp;<span class="op" id="3182940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3182944">s</span><span class="op" id="3182945">,</span>&nbsp;<span class="ident" id="3182947">rsa</span><span class="op" id="3182950">,</span>&nbsp;<span class="ident" id="3182952">err</span>&nbsp;<span class="op" id="3182956">=</span>&nbsp;<span class="ident" id="3182958">accept</span><span class="op" id="3182964">(</span><span class="ident" id="3182965">fd</span><span class="op" id="3182967">.</span><span class="ident" id="3182968">sysfd</span><span class="op" id="3182973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3182977">if</span>&nbsp;<span class="ident" id="3182980">err</span>&nbsp;<span class="op" id="3182984">!=</span>&nbsp;<span class="ident" id="3182987">nil</span>&nbsp;<span class="op" id="3182991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3182996">if</span>&nbsp;<span class="ident" id="3182999">err</span>&nbsp;<span class="op" id="3183003">==</span>&nbsp;<span class="ident" id="3183006">syscall</span><span class="op" id="3183013">.</span><span class="ident" id="3183014">EAGAIN</span>&nbsp;<span class="op" id="3183021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3183027">if</span>&nbsp;<span class="ident" id="3183030">err</span>&nbsp;<span class="op" id="3183034">=</span>&nbsp;<span class="ident" id="3183036">fd</span><span class="op" id="3183038">.</span><span class="ident" id="3183039">pd</span><span class="op" id="3183041">.</span><span class="ident" id="3183042">WaitRead</span><span class="op" id="3183050">(</span><span class="op" id="3183051">)</span><span class="op" id="3183052">;</span>&nbsp;<span class="ident" id="3183054">err</span>&nbsp;<span class="op" id="3183058">==</span>&nbsp;<span class="ident" id="3183061">nil</span>&nbsp;<span class="op" id="3183065">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3183072">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3183085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3183090">}</span>&nbsp;<span class="keyword" id="3183092">else</span>&nbsp;<span class="keyword" id="3183097">if</span>&nbsp;<span class="ident" id="3183100">err</span>&nbsp;<span class="op" id="3183104">==</span>&nbsp;<span class="ident" id="3183107">syscall</span><span class="op" id="3183114">.</span><span class="ident" id="3183115">ECONNABORTED</span>&nbsp;<span class="op" id="3183128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3183134">//&nbsp;This&nbsp;means&nbsp;that&nbsp;a&nbsp;socket&nbsp;on&nbsp;the&nbsp;listen&nbsp;queue&nbsp;was&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3183197">//&nbsp;before&nbsp;we&nbsp;Accept()ed&nbsp;it;&nbsp;it&#39;s&nbsp;a&nbsp;silly&nbsp;error,&nbsp;so&nbsp;try&nbsp;again.</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3183263">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3183275">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3183280">return</span>&nbsp;<span class="ident" id="3183287">nil</span><span class="op" id="3183290">,</span>&nbsp;<span class="op" id="3183292">&amp;</span><span class="ident" id="3183293">OpError</span><span class="op" id="3183300">{</span><span class="string" id="3183301">&#34;accept&#34;</span><span class="op" id="3183309">,</span>&nbsp;<span class="ident" id="3183311">fd</span><span class="op" id="3183313">.</span><span class="ident" id="3183314">net</span><span class="op" id="3183317">,</span>&nbsp;<span class="ident" id="3183319">fd</span><span class="op" id="3183321">.</span><span class="ident" id="3183322">laddr</span><span class="op" id="3183327">,</span>&nbsp;<span class="ident" id="3183329">err</span><span class="op" id="3183332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3183336">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3183340">break</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3183347">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3183351">if</span>&nbsp;<span class="ident" id="3183354">netfd</span><span class="op" id="3183359">,</span>&nbsp;<span class="ident" id="3183361">err</span>&nbsp;<span class="op" id="3183365">=</span>&nbsp;<span class="ident" id="3183367">newFD</span><span class="op" id="3183372">(</span><span class="ident" id="3183373">s</span><span class="op" id="3183374">,</span>&nbsp;<span class="ident" id="3183376">fd</span><span class="op" id="3183378">.</span><span class="ident" id="3183379">family</span><span class="op" id="3183385">,</span>&nbsp;<span class="ident" id="3183387">fd</span><span class="op" id="3183389">.</span><span class="ident" id="3183390">sotype</span><span class="op" id="3183396">,</span>&nbsp;<span class="ident" id="3183398">fd</span><span class="op" id="3183400">.</span><span class="ident" id="3183401">net</span><span class="op" id="3183404">)</span><span class="op" id="3183405">;</span>&nbsp;<span class="ident" id="3183407">err</span>&nbsp;<span class="op" id="3183411">!=</span>&nbsp;<span class="ident" id="3183414">nil</span>&nbsp;<span class="op" id="3183418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3183422">closesocket</span><span class="op" id="3183433">(</span><span class="ident" id="3183434">s</span><span class="op" id="3183435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3183439">return</span>&nbsp;<span class="ident" id="3183446">nil</span><span class="op" id="3183449">,</span>&nbsp;<span class="ident" id="3183451">err</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3183456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3183459">if</span>&nbsp;<span class="ident" id="3183462">err</span>&nbsp;<span class="op" id="3183466">=</span>&nbsp;<span class="ident" id="3183468">netfd</span><span class="op" id="3183473">.</span><span class="ident" id="3183474">init</span><span class="op" id="3183478">(</span><span class="op" id="3183479">)</span><span class="op" id="3183480">;</span>&nbsp;<span class="ident" id="3183482">err</span>&nbsp;<span class="op" id="3183486">!=</span>&nbsp;<span class="ident" id="3183489">nil</span>&nbsp;<span class="op" id="3183493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3183497">fd</span><span class="op" id="3183499">.</span><span class="ident" id="3183500">Close</span><span class="op" id="3183505">(</span><span class="op" id="3183506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3183510">return</span>&nbsp;<span class="ident" id="3183517">nil</span><span class="op" id="3183520">,</span>&nbsp;<span class="ident" id="3183522">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3183527">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3183530">lsa</span><span class="op" id="3183533">,</span>&nbsp;<span class="ident" id="3183535">_</span>&nbsp;<span class="op" id="3183537">:=</span>&nbsp;<span class="ident" id="3183540">syscall</span><span class="op" id="3183547">.</span><span class="ident" id="3183548">Getsockname</span><span class="op" id="3183559">(</span><span class="ident" id="3183560">netfd</span><span class="op" id="3183565">.</span><span class="ident" id="3183566">sysfd</span><span class="op" id="3183571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3183574">netfd</span><span class="op" id="3183579">.</span><span class="ident" id="3183580">setAddr</span><span class="op" id="3183587">(</span><span class="ident" id="3183588">netfd</span><span class="op" id="3183593">.</span><span class="ident" id="3183594">addrFunc</span><span class="op" id="3183602">(</span><span class="op" id="3183603">)</span><span class="op" id="3183604">(</span><span class="ident" id="3183605">lsa</span><span class="op" id="3183608">)</span><span class="op" id="3183609">,</span>&nbsp;<span class="ident" id="3183611">netfd</span><span class="op" id="3183616">.</span><span class="ident" id="3183617">addrFunc</span><span class="op" id="3183625">(</span><span class="op" id="3183626">)</span><span class="op" id="3183627">(</span><span class="ident" id="3183628">rsa</span><span class="op" id="3183631">)</span><span class="op" id="3183632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3183635">return</span>&nbsp;<span class="ident" id="3183642">netfd</span><span class="op" id="3183647">,</span>&nbsp;<span class="ident" id="3183649">nil</span><br>
<span class="lineno"></span><span class="op" id="3183653">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span><span class="comment" id="3183656">//&nbsp;tryDupCloexec&nbsp;indicates&nbsp;whether&nbsp;F_DUPFD_CLOEXEC&nbsp;should&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="comment" id="3183723">//&nbsp;If&nbsp;the&nbsp;kernel&nbsp;doesn&#39;t&nbsp;support&nbsp;it,&nbsp;this&nbsp;is&nbsp;set&nbsp;to&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="3183778">var</span>&nbsp;<span class="ident" id="3183782">tryDupCloexec</span>&nbsp;<span class="op" id="3183796">=</span>&nbsp;<span class="builtintype" id="3183798">int32</span><span class="op" id="3183803">(</span><span class="num" id="3183804">1</span><span class="op" id="3183805">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3183808">func</span>&nbsp;<span class="ident" id="3183813">dupCloseOnExec</span><span class="op" id="3183827">(</span><span class="ident" id="3183828">fd</span>&nbsp;<span class="builtintype" id="3183831">int</span><span class="op" id="3183834">)</span>&nbsp;<span class="op" id="3183836">(</span><span class="ident" id="3183837">newfd</span>&nbsp;<span class="builtintype" id="3183843">int</span><span class="op" id="3183846">,</span>&nbsp;<span class="ident" id="3183848">err</span>&nbsp;<span class="builtintype" id="3183852">error</span><span class="op" id="3183857">)</span>&nbsp;<span class="op" id="3183859">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3183862">if</span>&nbsp;<span class="ident" id="3183865">atomic</span><span class="op" id="3183871">.</span><span class="ident" id="3183872">LoadInt32</span><span class="op" id="3183881">(</span><span class="op" id="3183882">&amp;</span><span class="ident" id="3183883">tryDupCloexec</span><span class="op" id="3183896">)</span>&nbsp;<span class="op" id="3183898">==</span>&nbsp;<span class="num" id="3183901">1</span>&nbsp;<span class="op" id="3183903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3183907">r0</span><span class="op" id="3183909">,</span>&nbsp;<span class="ident" id="3183911">_</span><span class="op" id="3183912">,</span>&nbsp;<span class="ident" id="3183914">e1</span>&nbsp;<span class="op" id="3183917">:=</span>&nbsp;<span class="ident" id="3183920">syscall</span><span class="op" id="3183927">.</span><span class="ident" id="3183928">Syscall</span><span class="op" id="3183935">(</span><span class="ident" id="3183936">syscall</span><span class="op" id="3183943">.</span><span class="ident" id="3183944">SYS_FCNTL</span><span class="op" id="3183953">,</span>&nbsp;<span class="builtintype" id="3183955">uintptr</span><span class="op" id="3183962">(</span><span class="ident" id="3183963">fd</span><span class="op" id="3183965">)</span><span class="op" id="3183966">,</span>&nbsp;<span class="ident" id="3183968">syscall</span><span class="op" id="3183975">.</span><span class="ident" id="3183976">F_DUPFD_CLOEXEC</span><span class="op" id="3183991">,</span>&nbsp;<span class="num" id="3183993">0</span><span class="op" id="3183994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3183998">if</span>&nbsp;<span class="ident" id="3184001">runtime</span><span class="op" id="3184008">.</span><span class="ident" id="3184009">GOOS</span>&nbsp;<span class="op" id="3184014">==</span>&nbsp;<span class="string" id="3184017">&#34;darwin&#34;</span>&nbsp;<span class="op" id="3184026">&amp;&amp;</span>&nbsp;<span class="ident" id="3184029">e1</span>&nbsp;<span class="op" id="3184032">==</span>&nbsp;<span class="ident" id="3184035">syscall</span><span class="op" id="3184042">.</span><span class="ident" id="3184043">EBADF</span>&nbsp;<span class="op" id="3184049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3184054">//&nbsp;On&nbsp;OS&nbsp;X&nbsp;10.6&nbsp;and&nbsp;below&nbsp;(but&nbsp;we&nbsp;only&nbsp;support</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3184104">//&nbsp;&gt;=&nbsp;10.6),&nbsp;F_DUPFD_CLOEXEC&nbsp;is&nbsp;unsupported</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3184151">//&nbsp;and&nbsp;fcntl&nbsp;there&nbsp;falls&nbsp;back&nbsp;(undocumented)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3184199">//&nbsp;to&nbsp;doing&nbsp;an&nbsp;ioctl&nbsp;instead,&nbsp;returning&nbsp;EBADF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3184248">//&nbsp;in&nbsp;this&nbsp;case&nbsp;because&nbsp;fd&nbsp;is&nbsp;not&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3184292">//&nbsp;expected&nbsp;device&nbsp;fd&nbsp;type.&nbsp;&nbsp;Treat&nbsp;it&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3184336">//&nbsp;EINVAL&nbsp;instead,&nbsp;so&nbsp;we&nbsp;fall&nbsp;back&nbsp;to&nbsp;the</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3184381">//&nbsp;normal&nbsp;dup&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3184404">//&nbsp;TODO:&nbsp;only&nbsp;do&nbsp;this&nbsp;on&nbsp;10.6&nbsp;if&nbsp;we&nbsp;can&nbsp;detect&nbsp;10.6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3184459">//&nbsp;cheaply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3184474">e1</span>&nbsp;<span class="op" id="3184477">=</span>&nbsp;<span class="ident" id="3184479">syscall</span><span class="op" id="3184486">.</span><span class="ident" id="3184487">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3184496">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3184500">switch</span>&nbsp;<span class="ident" id="3184507">e1</span>&nbsp;<span class="op" id="3184510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3184514">case</span>&nbsp;<span class="num" id="3184519">0</span><span class="op" id="3184520">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3184525">return</span>&nbsp;<span class="builtintype" id="3184532">int</span><span class="op" id="3184535">(</span><span class="ident" id="3184536">r0</span><span class="op" id="3184538">)</span><span class="op" id="3184539">,</span>&nbsp;<span class="ident" id="3184541">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3184547">case</span>&nbsp;<span class="ident" id="3184552">syscall</span><span class="op" id="3184559">.</span><span class="ident" id="3184560">EINVAL</span><span class="op" id="3184566">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3184571">//&nbsp;Old&nbsp;kernel.&nbsp;Fall&nbsp;back&nbsp;to&nbsp;the&nbsp;portable&nbsp;way</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3184619">//&nbsp;from&nbsp;now&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3184638">atomic</span><span class="op" id="3184644">.</span><span class="ident" id="3184645">StoreInt32</span><span class="op" id="3184655">(</span><span class="op" id="3184656">&amp;</span><span class="ident" id="3184657">tryDupCloexec</span><span class="op" id="3184670">,</span>&nbsp;<span class="num" id="3184672">0</span><span class="op" id="3184673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3184677">default</span><span class="op" id="3184684">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3184689">return</span>&nbsp;<span class="op" id="3184696">-</span><span class="num" id="3184697">1</span><span class="op" id="3184698">,</span>&nbsp;<span class="ident" id="3184700">e1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3184705">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3184708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3184711">return</span>&nbsp;<span class="ident" id="3184718">dupCloseOnExecOld</span><span class="op" id="3184735">(</span><span class="ident" id="3184736">fd</span><span class="op" id="3184738">)</span><br>
<span class="lineno"></span><span class="op" id="3184740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3184743">//&nbsp;dupCloseOnExecUnixOld&nbsp;is&nbsp;the&nbsp;traditional&nbsp;way&nbsp;to&nbsp;dup&nbsp;an&nbsp;fd&nbsp;and</span><br>
<span class="lineno">480</span><span class="comment" id="3184808">//&nbsp;set&nbsp;its&nbsp;O_CLOEXEC&nbsp;bit,&nbsp;using&nbsp;two&nbsp;system&nbsp;calls.</span><br>
<span class="lineno"></span><span class="keyword" id="3184858">func</span>&nbsp;<span class="ident" id="3184863">dupCloseOnExecOld</span><span class="op" id="3184880">(</span><span class="ident" id="3184881">fd</span>&nbsp;<span class="builtintype" id="3184884">int</span><span class="op" id="3184887">)</span>&nbsp;<span class="op" id="3184889">(</span><span class="ident" id="3184890">newfd</span>&nbsp;<span class="builtintype" id="3184896">int</span><span class="op" id="3184899">,</span>&nbsp;<span class="ident" id="3184901">err</span>&nbsp;<span class="builtintype" id="3184905">error</span><span class="op" id="3184910">)</span>&nbsp;<span class="op" id="3184912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3184915">syscall</span><span class="op" id="3184922">.</span><span class="ident" id="3184923">ForkLock</span><span class="op" id="3184931">.</span><span class="ident" id="3184932">RLock</span><span class="op" id="3184937">(</span><span class="op" id="3184938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3184941">defer</span>&nbsp;<span class="ident" id="3184947">syscall</span><span class="op" id="3184954">.</span><span class="ident" id="3184955">ForkLock</span><span class="op" id="3184963">.</span><span class="ident" id="3184964">RUnlock</span><span class="op" id="3184971">(</span><span class="op" id="3184972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3184975">newfd</span><span class="op" id="3184980">,</span>&nbsp;<span class="ident" id="3184982">err</span>&nbsp;<span class="op" id="3184986">=</span>&nbsp;<span class="ident" id="3184988">syscall</span><span class="op" id="3184995">.</span><span class="ident" id="3184996">Dup</span><span class="op" id="3184999">(</span><span class="ident" id="3185000">fd</span><span class="op" id="3185002">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3185005">if</span>&nbsp;<span class="ident" id="3185008">err</span>&nbsp;<span class="op" id="3185012">!=</span>&nbsp;<span class="ident" id="3185015">nil</span>&nbsp;<span class="op" id="3185019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3185023">return</span>&nbsp;<span class="op" id="3185030">-</span><span class="num" id="3185031">1</span><span class="op" id="3185032">,</span>&nbsp;<span class="ident" id="3185034">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3185039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3185042">syscall</span><span class="op" id="3185049">.</span><span class="ident" id="3185050">CloseOnExec</span><span class="op" id="3185061">(</span><span class="ident" id="3185062">newfd</span><span class="op" id="3185067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3185070">return</span><br>
<span class="lineno">490</span><span class="op" id="3185077">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3185080">func</span>&nbsp;<span class="op" id="3185085">(</span><span class="ident" id="3185086">fd</span>&nbsp;<span class="op" id="3185089">*</span><span class="ident" id="3185090">netFD</span><span class="op" id="3185095">)</span>&nbsp;<span class="ident" id="3185097">dup</span><span class="op" id="3185100">(</span><span class="op" id="3185101">)</span>&nbsp;<span class="op" id="3185103">(</span><span class="ident" id="3185104">f</span>&nbsp;<span class="op" id="3185106">*</span><span class="ident" id="3185107">os</span><span class="op" id="3185109">.</span><span class="ident" id="3185110">File</span><span class="op" id="3185114">,</span>&nbsp;<span class="ident" id="3185116">err</span>&nbsp;<span class="builtintype" id="3185120">error</span><span class="op" id="3185125">)</span>&nbsp;<span class="op" id="3185127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3185130">ns</span><span class="op" id="3185132">,</span>&nbsp;<span class="ident" id="3185134">err</span>&nbsp;<span class="op" id="3185138">:=</span>&nbsp;<span class="ident" id="3185141">dupCloseOnExec</span><span class="op" id="3185155">(</span><span class="ident" id="3185156">fd</span><span class="op" id="3185158">.</span><span class="ident" id="3185159">sysfd</span><span class="op" id="3185164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3185167">if</span>&nbsp;<span class="ident" id="3185170">err</span>&nbsp;<span class="op" id="3185174">!=</span>&nbsp;<span class="ident" id="3185177">nil</span>&nbsp;<span class="op" id="3185181">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3185185">return</span>&nbsp;<span class="ident" id="3185192">nil</span><span class="op" id="3185195">,</span>&nbsp;<span class="op" id="3185197">&amp;</span><span class="ident" id="3185198">OpError</span><span class="op" id="3185205">{</span><span class="string" id="3185206">&#34;dup&#34;</span><span class="op" id="3185211">,</span>&nbsp;<span class="ident" id="3185213">fd</span><span class="op" id="3185215">.</span><span class="ident" id="3185216">net</span><span class="op" id="3185219">,</span>&nbsp;<span class="ident" id="3185221">fd</span><span class="op" id="3185223">.</span><span class="ident" id="3185224">laddr</span><span class="op" id="3185229">,</span>&nbsp;<span class="ident" id="3185231">err</span><span class="op" id="3185234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3185237">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3185241">//&nbsp;We&nbsp;want&nbsp;blocking&nbsp;mode&nbsp;for&nbsp;the&nbsp;new&nbsp;fd,&nbsp;hence&nbsp;the&nbsp;double&nbsp;negative.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3185310">//&nbsp;This&nbsp;also&nbsp;puts&nbsp;the&nbsp;old&nbsp;fd&nbsp;into&nbsp;blocking&nbsp;mode,&nbsp;meaning&nbsp;that</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3185373">//&nbsp;I/O&nbsp;will&nbsp;block&nbsp;the&nbsp;thread&nbsp;instead&nbsp;of&nbsp;letting&nbsp;us&nbsp;use&nbsp;the&nbsp;epoll&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3185447">//&nbsp;Everything&nbsp;will&nbsp;still&nbsp;work,&nbsp;just&nbsp;with&nbsp;more&nbsp;threads.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3185503">if</span>&nbsp;<span class="ident" id="3185506">err</span>&nbsp;<span class="op" id="3185510">=</span>&nbsp;<span class="ident" id="3185512">syscall</span><span class="op" id="3185519">.</span><span class="ident" id="3185520">SetNonblock</span><span class="op" id="3185531">(</span><span class="ident" id="3185532">ns</span><span class="op" id="3185534">,</span>&nbsp;<span class="builtintype" id="3185536">false</span><span class="op" id="3185541">)</span><span class="op" id="3185542">;</span>&nbsp;<span class="ident" id="3185544">err</span>&nbsp;<span class="op" id="3185548">!=</span>&nbsp;<span class="ident" id="3185551">nil</span>&nbsp;<span class="op" id="3185555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3185559">return</span>&nbsp;<span class="ident" id="3185566">nil</span><span class="op" id="3185569">,</span>&nbsp;<span class="op" id="3185571">&amp;</span><span class="ident" id="3185572">OpError</span><span class="op" id="3185579">{</span><span class="string" id="3185580">&#34;setnonblock&#34;</span><span class="op" id="3185593">,</span>&nbsp;<span class="ident" id="3185595">fd</span><span class="op" id="3185597">.</span><span class="ident" id="3185598">net</span><span class="op" id="3185601">,</span>&nbsp;<span class="ident" id="3185603">fd</span><span class="op" id="3185605">.</span><span class="ident" id="3185606">laddr</span><span class="op" id="3185611">,</span>&nbsp;<span class="ident" id="3185613">err</span><span class="op" id="3185616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3185619">}</span><br>
<span class="lineno">505</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3185623">return</span>&nbsp;<span class="ident" id="3185630">os</span><span class="op" id="3185632">.</span><span class="ident" id="3185633">NewFile</span><span class="op" id="3185640">(</span><span class="builtintype" id="3185641">uintptr</span><span class="op" id="3185648">(</span><span class="ident" id="3185649">ns</span><span class="op" id="3185651">)</span><span class="op" id="3185652">,</span>&nbsp;<span class="ident" id="3185654">fd</span><span class="op" id="3185656">.</span><span class="ident" id="3185657">name</span><span class="op" id="3185661">(</span><span class="op" id="3185662">)</span><span class="op" id="3185663">)</span><span class="op" id="3185664">,</span>&nbsp;<span class="ident" id="3185666">nil</span><br>
<span class="lineno"></span><span class="op" id="3185670">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3185673">func</span>&nbsp;<span class="ident" id="3185678">closesocket</span><span class="op" id="3185689">(</span><span class="ident" id="3185690">s</span>&nbsp;<span class="builtintype" id="3185692">int</span><span class="op" id="3185695">)</span>&nbsp;<span class="builtintype" id="3185697">error</span>&nbsp;<span class="op" id="3185703">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3185706">return</span>&nbsp;<span class="ident" id="3185713">syscall</span><span class="op" id="3185720">.</span><span class="ident" id="3185721">Close</span><span class="op" id="3185726">(</span><span class="ident" id="3185727">s</span><span class="op" id="3185728">)</span><br>
<span class="lineno"></span><span class="op" id="3185730">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3185733">func</span>&nbsp;<span class="ident" id="3185738">skipRawSocketTests</span><span class="op" id="3185756">(</span><span class="op" id="3185757">)</span>&nbsp;<span class="op" id="3185759">(</span><span class="ident" id="3185760">skip</span>&nbsp;<span class="builtintype" id="3185765">bool</span><span class="op" id="3185769">,</span>&nbsp;<span class="ident" id="3185771">skipmsg</span>&nbsp;<span class="builtintype" id="3185779">string</span><span class="op" id="3185785">,</span>&nbsp;<span class="ident" id="3185787">err</span>&nbsp;<span class="builtintype" id="3185791">error</span><span class="op" id="3185796">)</span>&nbsp;<span class="op" id="3185798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3185801">if</span>&nbsp;<span class="ident" id="3185804">os</span><span class="op" id="3185806">.</span><span class="ident" id="3185807">Getuid</span><span class="op" id="3185813">(</span><span class="op" id="3185814">)</span>&nbsp;<span class="op" id="3185816">!=</span>&nbsp;<span class="num" id="3185819">0</span>&nbsp;<span class="op" id="3185821">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3185825">return</span>&nbsp;<span class="builtintype" id="3185832">true</span><span class="op" id="3185836">,</span>&nbsp;<span class="string" id="3185838">&#34;skipping&nbsp;test;&nbsp;must&nbsp;be&nbsp;root&#34;</span><span class="op" id="3185867">,</span>&nbsp;<span class="ident" id="3185869">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3185874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3185877">return</span>&nbsp;<span class="builtintype" id="3185884">false</span><span class="op" id="3185889">,</span>&nbsp;<span class="string" id="3185891">&#34;&#34;</span><span class="op" id="3185893">,</span>&nbsp;<span class="ident" id="3185895">nil</span><br>
<span class="lineno"></span><span class="op" id="3185899">}</span>
</div>
</body>
</html>
