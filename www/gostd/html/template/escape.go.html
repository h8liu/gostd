<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>html/template</h2>
<ul>
<li><a href="/gostd/html/template/attr.go.html">attr.go</a></li>
<li><a href="/gostd/html/template/clone_test.go.html">clone_test.go</a></li>
<li><a href="/gostd/html/template/content.go.html">content.go</a></li>
<li><a href="/gostd/html/template/content_test.go.html">content_test.go</a></li>
<li><a href="/gostd/html/template/context.go.html">context.go</a></li>
<li><a href="/gostd/html/template/css.go.html">css.go</a></li>
<li><a href="/gostd/html/template/css_test.go.html">css_test.go</a></li>
<li><a href="/gostd/html/template/doc.go.html">doc.go</a></li>
<li><a href="/gostd/html/template/error.go.html">error.go</a></li>
<li><a href="/gostd/html/template/escape.go.html">escape.go</a></li>
<li><a href="/gostd/html/template/escape_test.go.html">escape_test.go</a></li>
<li><a href="/gostd/html/template/html.go.html">html.go</a></li>
<li><a href="/gostd/html/template/html_test.go.html">html_test.go</a></li>
<li><a href="/gostd/html/template/js.go.html">js.go</a></li>
<li><a href="/gostd/html/template/js_test.go.html">js_test.go</a></li>
<li><a href="/gostd/html/template/template.go.html">template.go</a></li>
<li><a href="/gostd/html/template/transition.go.html">transition.go</a></li>
<li><a href="/gostd/html/template/url.go.html">url.go</a></li>
<li><a href="/gostd/html/template/url_test.go.html">url_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5201091">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5201146">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5201200">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5201251">package</span>&nbsp;<span class="ident" id="5201259">template</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5201269">import</span>&nbsp;<span class="op" id="5201276">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5201279">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5201288">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5201295">&#34;html&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5201303">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5201309">&#34;text/template&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5201326">&#34;text/template/parse&#34;</span><br>
<span class="lineno"></span><span class="op" id="5201348">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="5201351">//&nbsp;escapeTemplate&nbsp;rewrites&nbsp;the&nbsp;named&nbsp;template,&nbsp;which&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5201412">//&nbsp;associated&nbsp;with&nbsp;t,&nbsp;to&nbsp;guarantee&nbsp;that&nbsp;the&nbsp;output&nbsp;of&nbsp;any&nbsp;of&nbsp;the&nbsp;named</span><br>
<span class="lineno"></span><span class="comment" id="5201483">//&nbsp;templates&nbsp;is&nbsp;properly&nbsp;escaped.&nbsp;&nbsp;If&nbsp;no&nbsp;error&nbsp;is&nbsp;returned,&nbsp;then&nbsp;the&nbsp;named&nbsp;templates&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="5201573">//&nbsp;been&nbsp;modified.&nbsp;&nbsp;Otherwise&nbsp;the&nbsp;named&nbsp;templates&nbsp;have&nbsp;been&nbsp;rendered</span><br>
<span class="lineno">20</span><span class="comment" id="5201641">//&nbsp;unusable.</span><br>
<span class="lineno"></span><span class="keyword" id="5201654">func</span>&nbsp;<span class="ident" id="5201659">escapeTemplate</span><span class="op" id="5201673">(</span><span class="ident" id="5201674">tmpl</span>&nbsp;<span class="op" id="5201679">*</span><span class="ident" id="5201680">Template</span><span class="op" id="5201688">,</span>&nbsp;<span class="ident" id="5201690">node</span>&nbsp;<span class="ident" id="5201695">parse</span><span class="op" id="5201700">.</span><span class="ident" id="5201701">Node</span><span class="op" id="5201705">,</span>&nbsp;<span class="ident" id="5201707">name</span>&nbsp;<span class="builtintype" id="5201712">string</span><span class="op" id="5201718">)</span>&nbsp;<span class="builtintype" id="5201720">error</span>&nbsp;<span class="op" id="5201726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5201729">e</span>&nbsp;<span class="op" id="5201731">:=</span>&nbsp;<span class="ident" id="5201734">newEscaper</span><span class="op" id="5201744">(</span><span class="ident" id="5201745">tmpl</span><span class="op" id="5201749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5201752">c</span><span class="op" id="5201753">,</span>&nbsp;<span class="ident" id="5201755">_</span>&nbsp;<span class="op" id="5201757">:=</span>&nbsp;<span class="ident" id="5201760">e</span><span class="op" id="5201761">.</span><span class="ident" id="5201762">escapeTree</span><span class="op" id="5201772">(</span><span class="ident" id="5201773">context</span><span class="op" id="5201780">{</span><span class="op" id="5201781">}</span><span class="op" id="5201782">,</span>&nbsp;<span class="ident" id="5201784">node</span><span class="op" id="5201788">,</span>&nbsp;<span class="ident" id="5201790">name</span><span class="op" id="5201794">,</span>&nbsp;<span class="num" id="5201796">0</span><span class="op" id="5201797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5201800">var</span>&nbsp;<span class="ident" id="5201804">err</span>&nbsp;<span class="builtintype" id="5201808">error</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5201815">if</span>&nbsp;<span class="ident" id="5201818">c</span><span class="op" id="5201819">.</span><span class="ident" id="5201820">err</span>&nbsp;<span class="op" id="5201824">!=</span>&nbsp;<span class="ident" id="5201827">nil</span>&nbsp;<span class="op" id="5201831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5201835">err</span><span class="op" id="5201838">,</span>&nbsp;<span class="ident" id="5201840">c</span><span class="op" id="5201841">.</span><span class="ident" id="5201842">err</span><span class="op" id="5201845">.</span><span class="ident" id="5201846">Name</span>&nbsp;<span class="op" id="5201851">=</span>&nbsp;<span class="ident" id="5201853">c</span><span class="op" id="5201854">.</span><span class="ident" id="5201855">err</span><span class="op" id="5201858">,</span>&nbsp;<span class="ident" id="5201860">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5201866">}</span>&nbsp;<span class="keyword" id="5201868">else</span>&nbsp;<span class="keyword" id="5201873">if</span>&nbsp;<span class="ident" id="5201876">c</span><span class="op" id="5201877">.</span><span class="ident" id="5201878">state</span>&nbsp;<span class="op" id="5201884">!=</span>&nbsp;<span class="ident" id="5201887">stateText</span>&nbsp;<span class="op" id="5201897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5201901">err</span>&nbsp;<span class="op" id="5201905">=</span>&nbsp;<span class="op" id="5201907">&amp;</span><span class="ident" id="5201908">Error</span><span class="op" id="5201913">{</span><span class="ident" id="5201914">ErrEndContext</span><span class="op" id="5201927">,</span>&nbsp;<span class="ident" id="5201929">nil</span><span class="op" id="5201932">,</span>&nbsp;<span class="ident" id="5201934">name</span><span class="op" id="5201938">,</span>&nbsp;<span class="num" id="5201940">0</span><span class="op" id="5201941">,</span>&nbsp;<span class="ident" id="5201943">fmt</span><span class="op" id="5201946">.</span><span class="ident" id="5201947">Sprintf</span><span class="op" id="5201954">(</span><span class="string" id="5201955">&#34;ends&nbsp;in&nbsp;a&nbsp;non-text&nbsp;context:&nbsp;%v&#34;</span><span class="op" id="5201987">,</span>&nbsp;<span class="ident" id="5201989">c</span><span class="op" id="5201990">)</span><span class="op" id="5201991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5201994">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5201997">if</span>&nbsp;<span class="ident" id="5202000">err</span>&nbsp;<span class="op" id="5202004">!=</span>&nbsp;<span class="ident" id="5202007">nil</span>&nbsp;<span class="op" id="5202011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5202015">//&nbsp;Prevent&nbsp;execution&nbsp;of&nbsp;unsafe&nbsp;templates.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5202059">if</span>&nbsp;<span class="ident" id="5202062">t</span>&nbsp;<span class="op" id="5202064">:=</span>&nbsp;<span class="ident" id="5202067">tmpl</span><span class="op" id="5202071">.</span><span class="ident" id="5202072">set</span><span class="op" id="5202075">[</span><span class="ident" id="5202076">name</span><span class="op" id="5202080">]</span><span class="op" id="5202081">;</span>&nbsp;<span class="ident" id="5202083">t</span>&nbsp;<span class="op" id="5202085">!=</span>&nbsp;<span class="ident" id="5202088">nil</span>&nbsp;<span class="op" id="5202092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5202097">t</span><span class="op" id="5202098">.</span><span class="ident" id="5202099">escapeErr</span>&nbsp;<span class="op" id="5202109">=</span>&nbsp;<span class="ident" id="5202111">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5202118">t</span><span class="op" id="5202119">.</span><span class="ident" id="5202120">text</span><span class="op" id="5202124">.</span><span class="ident" id="5202125">Tree</span>&nbsp;<span class="op" id="5202130">=</span>&nbsp;<span class="ident" id="5202132">nil</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5202139">t</span><span class="op" id="5202140">.</span><span class="ident" id="5202141">Tree</span>&nbsp;<span class="op" id="5202146">=</span>&nbsp;<span class="ident" id="5202148">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5202154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5202158">return</span>&nbsp;<span class="ident" id="5202165">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5202170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5202173">e</span><span class="op" id="5202174">.</span><span class="ident" id="5202175">commit</span><span class="op" id="5202181">(</span><span class="op" id="5202182">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5202185">if</span>&nbsp;<span class="ident" id="5202188">t</span>&nbsp;<span class="op" id="5202190">:=</span>&nbsp;<span class="ident" id="5202193">tmpl</span><span class="op" id="5202197">.</span><span class="ident" id="5202198">set</span><span class="op" id="5202201">[</span><span class="ident" id="5202202">name</span><span class="op" id="5202206">]</span><span class="op" id="5202207">;</span>&nbsp;<span class="ident" id="5202209">t</span>&nbsp;<span class="op" id="5202211">!=</span>&nbsp;<span class="ident" id="5202214">nil</span>&nbsp;<span class="op" id="5202218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5202222">t</span><span class="op" id="5202223">.</span><span class="ident" id="5202224">escapeErr</span>&nbsp;<span class="op" id="5202234">=</span>&nbsp;<span class="ident" id="5202236">escapeOK</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5202247">t</span><span class="op" id="5202248">.</span><span class="ident" id="5202249">Tree</span>&nbsp;<span class="op" id="5202254">=</span>&nbsp;<span class="ident" id="5202256">t</span><span class="op" id="5202257">.</span><span class="ident" id="5202258">text</span><span class="op" id="5202262">.</span><span class="ident" id="5202263">Tree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5202269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5202272">return</span>&nbsp;<span class="ident" id="5202279">nil</span><br>
<span class="lineno">45</span><span class="op" id="5202283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5202286">//&nbsp;funcMap&nbsp;maps&nbsp;command&nbsp;names&nbsp;to&nbsp;functions&nbsp;that&nbsp;render&nbsp;their&nbsp;inputs&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="5202360">var</span>&nbsp;<span class="ident" id="5202364">funcMap</span>&nbsp;<span class="op" id="5202372">=</span>&nbsp;<span class="ident" id="5202374">template</span><span class="op" id="5202382">.</span><span class="ident" id="5202383">FuncMap</span><span class="op" id="5202390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5202393">&#34;html_template_attrescaper&#34;</span><span class="op" id="5202420">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5202426">attrEscaper</span><span class="op" id="5202437">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5202440">&#34;html_template_commentescaper&#34;</span><span class="op" id="5202470">:</span>&nbsp;&nbsp;<span class="ident" id="5202473">commentEscaper</span><span class="op" id="5202487">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5202490">&#34;html_template_cssescaper&#34;</span><span class="op" id="5202516">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5202523">cssEscaper</span><span class="op" id="5202533">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5202536">&#34;html_template_cssvaluefilter&#34;</span><span class="op" id="5202566">:</span>&nbsp;&nbsp;<span class="ident" id="5202569">cssValueFilter</span><span class="op" id="5202583">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5202586">&#34;html_template_htmlnamefilter&#34;</span><span class="op" id="5202616">:</span>&nbsp;&nbsp;<span class="ident" id="5202619">htmlNameFilter</span><span class="op" id="5202633">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5202636">&#34;html_template_htmlescaper&#34;</span><span class="op" id="5202663">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5202669">htmlEscaper</span><span class="op" id="5202680">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5202683">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="5202714">:</span>&nbsp;<span class="ident" id="5202716">jsRegexpEscaper</span><span class="op" id="5202731">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5202734">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="5202762">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5202767">jsStrEscaper</span><span class="op" id="5202779">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5202782">&#34;html_template_jsvalescaper&#34;</span><span class="op" id="5202810">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5202815">jsValEscaper</span><span class="op" id="5202827">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5202830">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="5202860">:</span>&nbsp;&nbsp;<span class="ident" id="5202863">htmlNospaceEscaper</span><span class="op" id="5202881">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5202884">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="5202913">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5202917">rcdataEscaper</span><span class="op" id="5202930">,</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5202933">&#34;html_template_urlescaper&#34;</span><span class="op" id="5202959">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5202966">urlEscaper</span><span class="op" id="5202976">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5202979">&#34;html_template_urlfilter&#34;</span><span class="op" id="5203004">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5203012">urlFilter</span><span class="op" id="5203021">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5203024">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="5203053">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5203057">urlNormalizer</span><span class="op" id="5203070">,</span><br>
<span class="lineno"></span><span class="op" id="5203072">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="5203075">//&nbsp;equivEscapers&nbsp;matches&nbsp;contextual&nbsp;escapers&nbsp;to&nbsp;equivalent&nbsp;template&nbsp;builtins.</span><br>
<span class="lineno"></span><span class="keyword" id="5203153">var</span>&nbsp;<span class="ident" id="5203157">equivEscapers</span>&nbsp;<span class="op" id="5203171">=</span>&nbsp;<span class="keyword" id="5203173">map</span><span class="op" id="5203176">[</span><span class="builtintype" id="5203177">string</span><span class="op" id="5203183">]</span><span class="builtintype" id="5203184">string</span><span class="op" id="5203190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5203193">&#34;html_template_attrescaper&#34;</span><span class="op" id="5203220">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5203225">&#34;html&#34;</span><span class="op" id="5203231">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5203234">&#34;html_template_htmlescaper&#34;</span><span class="op" id="5203261">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5203266">&#34;html&#34;</span><span class="op" id="5203272">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5203275">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="5203305">:</span>&nbsp;<span class="string" id="5203307">&#34;html&#34;</span><span class="op" id="5203313">,</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5203316">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="5203345">:</span>&nbsp;&nbsp;<span class="string" id="5203348">&#34;html&#34;</span><span class="op" id="5203354">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5203357">&#34;html_template_urlescaper&#34;</span><span class="op" id="5203383">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5203389">&#34;urlquery&#34;</span><span class="op" id="5203399">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5203402">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="5203431">:</span>&nbsp;&nbsp;<span class="string" id="5203434">&#34;urlquery&#34;</span><span class="op" id="5203444">,</span><br>
<span class="lineno"></span><span class="op" id="5203446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="5203449">//&nbsp;escaper&nbsp;collects&nbsp;type&nbsp;inferences&nbsp;about&nbsp;templates&nbsp;and&nbsp;changes&nbsp;needed&nbsp;to&nbsp;make</span><br>
<span class="lineno"></span><span class="comment" id="5203528">//&nbsp;templates&nbsp;injection&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="5203557">type</span>&nbsp;<span class="ident" id="5203562">escaper</span>&nbsp;<span class="keyword" id="5203570">struct</span>&nbsp;<span class="op" id="5203577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5203580">tmpl</span>&nbsp;<span class="op" id="5203585">*</span><span class="ident" id="5203586">Template</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5203596">//&nbsp;output[templateName]&nbsp;is&nbsp;the&nbsp;output&nbsp;context&nbsp;for&nbsp;a&nbsp;templateName&nbsp;that</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5203667">//&nbsp;has&nbsp;been&nbsp;mangled&nbsp;to&nbsp;include&nbsp;its&nbsp;input&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5203718">output</span>&nbsp;<span class="keyword" id="5203725">map</span><span class="op" id="5203728">[</span><span class="builtintype" id="5203729">string</span><span class="op" id="5203735">]</span><span class="ident" id="5203736">context</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5203745">//&nbsp;derived[c.mangle(name)]&nbsp;maps&nbsp;to&nbsp;a&nbsp;template&nbsp;derived&nbsp;from&nbsp;the&nbsp;template</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5203818">//&nbsp;named&nbsp;name&nbsp;templateName&nbsp;for&nbsp;the&nbsp;start&nbsp;context&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5203871">derived</span>&nbsp;<span class="keyword" id="5203879">map</span><span class="op" id="5203882">[</span><span class="builtintype" id="5203883">string</span><span class="op" id="5203889">]</span><span class="op" id="5203890">*</span><span class="ident" id="5203891">template</span><span class="op" id="5203899">.</span><span class="ident" id="5203900">Template</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5203910">//&nbsp;called[templateName]&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;called&nbsp;mangled&nbsp;template&nbsp;names.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5203978">called</span>&nbsp;<span class="keyword" id="5203985">map</span><span class="op" id="5203988">[</span><span class="builtintype" id="5203989">string</span><span class="op" id="5203995">]</span><span class="builtintype" id="5203996">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5204002">//&nbsp;xxxNodeEdits&nbsp;are&nbsp;the&nbsp;accumulated&nbsp;edits&nbsp;to&nbsp;apply&nbsp;during&nbsp;commit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5204069">//&nbsp;Such&nbsp;edits&nbsp;are&nbsp;not&nbsp;applied&nbsp;immediately&nbsp;in&nbsp;case&nbsp;a&nbsp;template&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5204135">//&nbsp;executes&nbsp;a&nbsp;given&nbsp;template&nbsp;in&nbsp;different&nbsp;escaping&nbsp;contexts.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5204197">actionNodeEdits</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="5204215">map</span><span class="op" id="5204218">[</span><span class="op" id="5204219">*</span><span class="ident" id="5204220">parse</span><span class="op" id="5204225">.</span><span class="ident" id="5204226">ActionNode</span><span class="op" id="5204236">]</span><span class="op" id="5204237">[</span><span class="op" id="5204238">]</span><span class="builtintype" id="5204239">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5204247">templateNodeEdits</span>&nbsp;<span class="keyword" id="5204265">map</span><span class="op" id="5204268">[</span><span class="op" id="5204269">*</span><span class="ident" id="5204270">parse</span><span class="op" id="5204275">.</span><span class="ident" id="5204276">TemplateNode</span><span class="op" id="5204288">]</span><span class="builtintype" id="5204289">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5204297">textNodeEdits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5204315">map</span><span class="op" id="5204318">[</span><span class="op" id="5204319">*</span><span class="ident" id="5204320">parse</span><span class="op" id="5204325">.</span><span class="ident" id="5204326">TextNode</span><span class="op" id="5204334">]</span><span class="op" id="5204335">[</span><span class="op" id="5204336">]</span><span class="builtintype" id="5204337">byte</span><br>
<span class="lineno"></span><span class="op" id="5204342">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="5204345">//&nbsp;newEscaper&nbsp;creates&nbsp;a&nbsp;blank&nbsp;escaper&nbsp;for&nbsp;the&nbsp;given&nbsp;set.</span><br>
<span class="lineno"></span><span class="keyword" id="5204402">func</span>&nbsp;<span class="ident" id="5204407">newEscaper</span><span class="op" id="5204417">(</span><span class="ident" id="5204418">t</span>&nbsp;<span class="op" id="5204420">*</span><span class="ident" id="5204421">Template</span><span class="op" id="5204429">)</span>&nbsp;<span class="op" id="5204431">*</span><span class="ident" id="5204432">escaper</span>&nbsp;<span class="op" id="5204440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5204443">return</span>&nbsp;<span class="op" id="5204450">&amp;</span><span class="ident" id="5204451">escaper</span><span class="op" id="5204458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5204462">t</span><span class="op" id="5204463">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5204467">map</span><span class="op" id="5204470">[</span><span class="builtintype" id="5204471">string</span><span class="op" id="5204477">]</span><span class="ident" id="5204478">context</span><span class="op" id="5204485">{</span><span class="op" id="5204486">}</span><span class="op" id="5204487">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5204491">map</span><span class="op" id="5204494">[</span><span class="builtintype" id="5204495">string</span><span class="op" id="5204501">]</span><span class="op" id="5204502">*</span><span class="ident" id="5204503">template</span><span class="op" id="5204511">.</span><span class="ident" id="5204512">Template</span><span class="op" id="5204520">{</span><span class="op" id="5204521">}</span><span class="op" id="5204522">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5204526">map</span><span class="op" id="5204529">[</span><span class="builtintype" id="5204530">string</span><span class="op" id="5204536">]</span><span class="builtintype" id="5204537">bool</span><span class="op" id="5204541">{</span><span class="op" id="5204542">}</span><span class="op" id="5204543">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5204547">map</span><span class="op" id="5204550">[</span><span class="op" id="5204551">*</span><span class="ident" id="5204552">parse</span><span class="op" id="5204557">.</span><span class="ident" id="5204558">ActionNode</span><span class="op" id="5204568">]</span><span class="op" id="5204569">[</span><span class="op" id="5204570">]</span><span class="builtintype" id="5204571">string</span><span class="op" id="5204577">{</span><span class="op" id="5204578">}</span><span class="op" id="5204579">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5204583">map</span><span class="op" id="5204586">[</span><span class="op" id="5204587">*</span><span class="ident" id="5204588">parse</span><span class="op" id="5204593">.</span><span class="ident" id="5204594">TemplateNode</span><span class="op" id="5204606">]</span><span class="builtintype" id="5204607">string</span><span class="op" id="5204613">{</span><span class="op" id="5204614">}</span><span class="op" id="5204615">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5204619">map</span><span class="op" id="5204622">[</span><span class="op" id="5204623">*</span><span class="ident" id="5204624">parse</span><span class="op" id="5204629">.</span><span class="ident" id="5204630">TextNode</span><span class="op" id="5204638">]</span><span class="op" id="5204639">[</span><span class="op" id="5204640">]</span><span class="builtintype" id="5204641">byte</span><span class="op" id="5204645">{</span><span class="op" id="5204646">}</span><span class="op" id="5204647">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5204650">}</span><br>
<span class="lineno"></span><span class="op" id="5204652">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5204655">//&nbsp;filterFailsafe&nbsp;is&nbsp;an&nbsp;innocuous&nbsp;word&nbsp;that&nbsp;is&nbsp;emitted&nbsp;in&nbsp;place&nbsp;of&nbsp;unsafe&nbsp;values</span><br>
<span class="lineno"></span><span class="comment" id="5204736">//&nbsp;by&nbsp;sanitizer&nbsp;functions.&nbsp;It&nbsp;is&nbsp;not&nbsp;a&nbsp;keyword&nbsp;in&nbsp;any&nbsp;programming&nbsp;language,</span><br>
<span class="lineno">110</span><span class="comment" id="5204812">//&nbsp;contains&nbsp;no&nbsp;special&nbsp;characters,&nbsp;is&nbsp;not&nbsp;empty,&nbsp;and&nbsp;when&nbsp;it&nbsp;appears&nbsp;in&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="5204891">//&nbsp;it&nbsp;is&nbsp;distinct&nbsp;enough&nbsp;that&nbsp;a&nbsp;developer&nbsp;can&nbsp;find&nbsp;the&nbsp;source&nbsp;of&nbsp;the&nbsp;problem</span><br>
<span class="lineno"></span><span class="comment" id="5204968">//&nbsp;via&nbsp;a&nbsp;search&nbsp;engine.</span><br>
<span class="lineno"></span><span class="keyword" id="5204992">const</span>&nbsp;<span class="ident" id="5204998">filterFailsafe</span>&nbsp;<span class="op" id="5205013">=</span>&nbsp;<span class="string" id="5205015">&#34;ZgotmplZ&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="comment" id="5205027">//&nbsp;escape&nbsp;escapes&nbsp;a&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="5205062">func</span>&nbsp;<span class="op" id="5205067">(</span><span class="ident" id="5205068">e</span>&nbsp;<span class="op" id="5205070">*</span><span class="ident" id="5205071">escaper</span><span class="op" id="5205078">)</span>&nbsp;<span class="ident" id="5205080">escape</span><span class="op" id="5205086">(</span><span class="ident" id="5205087">c</span>&nbsp;<span class="ident" id="5205089">context</span><span class="op" id="5205096">,</span>&nbsp;<span class="ident" id="5205098">n</span>&nbsp;<span class="ident" id="5205100">parse</span><span class="op" id="5205105">.</span><span class="ident" id="5205106">Node</span><span class="op" id="5205110">)</span>&nbsp;<span class="ident" id="5205112">context</span>&nbsp;<span class="op" id="5205120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5205123">switch</span>&nbsp;<span class="ident" id="5205130">n</span>&nbsp;<span class="op" id="5205132">:=</span>&nbsp;<span class="ident" id="5205135">n</span><span class="op" id="5205136">.</span><span class="op" id="5205137">(</span><span class="keyword" id="5205138">type</span><span class="op" id="5205142">)</span>&nbsp;<span class="op" id="5205144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5205147">case</span>&nbsp;<span class="op" id="5205152">*</span><span class="ident" id="5205153">parse</span><span class="op" id="5205158">.</span><span class="ident" id="5205159">ActionNode</span><span class="op" id="5205169">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5205173">return</span>&nbsp;<span class="ident" id="5205180">e</span><span class="op" id="5205181">.</span><span class="ident" id="5205182">escapeAction</span><span class="op" id="5205194">(</span><span class="ident" id="5205195">c</span><span class="op" id="5205196">,</span>&nbsp;<span class="ident" id="5205198">n</span><span class="op" id="5205199">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5205202">case</span>&nbsp;<span class="op" id="5205207">*</span><span class="ident" id="5205208">parse</span><span class="op" id="5205213">.</span><span class="ident" id="5205214">IfNode</span><span class="op" id="5205220">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5205224">return</span>&nbsp;<span class="ident" id="5205231">e</span><span class="op" id="5205232">.</span><span class="ident" id="5205233">escapeBranch</span><span class="op" id="5205245">(</span><span class="ident" id="5205246">c</span><span class="op" id="5205247">,</span>&nbsp;<span class="op" id="5205249">&amp;</span><span class="ident" id="5205250">n</span><span class="op" id="5205251">.</span><span class="ident" id="5205252">BranchNode</span><span class="op" id="5205262">,</span>&nbsp;<span class="string" id="5205264">&#34;if&#34;</span><span class="op" id="5205268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5205271">case</span>&nbsp;<span class="op" id="5205276">*</span><span class="ident" id="5205277">parse</span><span class="op" id="5205282">.</span><span class="ident" id="5205283">ListNode</span><span class="op" id="5205291">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5205295">return</span>&nbsp;<span class="ident" id="5205302">e</span><span class="op" id="5205303">.</span><span class="ident" id="5205304">escapeList</span><span class="op" id="5205314">(</span><span class="ident" id="5205315">c</span><span class="op" id="5205316">,</span>&nbsp;<span class="ident" id="5205318">n</span><span class="op" id="5205319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5205322">case</span>&nbsp;<span class="op" id="5205327">*</span><span class="ident" id="5205328">parse</span><span class="op" id="5205333">.</span><span class="ident" id="5205334">RangeNode</span><span class="op" id="5205343">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5205347">return</span>&nbsp;<span class="ident" id="5205354">e</span><span class="op" id="5205355">.</span><span class="ident" id="5205356">escapeBranch</span><span class="op" id="5205368">(</span><span class="ident" id="5205369">c</span><span class="op" id="5205370">,</span>&nbsp;<span class="op" id="5205372">&amp;</span><span class="ident" id="5205373">n</span><span class="op" id="5205374">.</span><span class="ident" id="5205375">BranchNode</span><span class="op" id="5205385">,</span>&nbsp;<span class="string" id="5205387">&#34;range&#34;</span><span class="op" id="5205394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5205397">case</span>&nbsp;<span class="op" id="5205402">*</span><span class="ident" id="5205403">parse</span><span class="op" id="5205408">.</span><span class="ident" id="5205409">TemplateNode</span><span class="op" id="5205421">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5205425">return</span>&nbsp;<span class="ident" id="5205432">e</span><span class="op" id="5205433">.</span><span class="ident" id="5205434">escapeTemplate</span><span class="op" id="5205448">(</span><span class="ident" id="5205449">c</span><span class="op" id="5205450">,</span>&nbsp;<span class="ident" id="5205452">n</span><span class="op" id="5205453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5205456">case</span>&nbsp;<span class="op" id="5205461">*</span><span class="ident" id="5205462">parse</span><span class="op" id="5205467">.</span><span class="ident" id="5205468">TextNode</span><span class="op" id="5205476">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5205480">return</span>&nbsp;<span class="ident" id="5205487">e</span><span class="op" id="5205488">.</span><span class="ident" id="5205489">escapeText</span><span class="op" id="5205499">(</span><span class="ident" id="5205500">c</span><span class="op" id="5205501">,</span>&nbsp;<span class="ident" id="5205503">n</span><span class="op" id="5205504">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5205507">case</span>&nbsp;<span class="op" id="5205512">*</span><span class="ident" id="5205513">parse</span><span class="op" id="5205518">.</span><span class="ident" id="5205519">WithNode</span><span class="op" id="5205527">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5205531">return</span>&nbsp;<span class="ident" id="5205538">e</span><span class="op" id="5205539">.</span><span class="ident" id="5205540">escapeBranch</span><span class="op" id="5205552">(</span><span class="ident" id="5205553">c</span><span class="op" id="5205554">,</span>&nbsp;<span class="op" id="5205556">&amp;</span><span class="ident" id="5205557">n</span><span class="op" id="5205558">.</span><span class="ident" id="5205559">BranchNode</span><span class="op" id="5205569">,</span>&nbsp;<span class="string" id="5205571">&#34;with&#34;</span><span class="op" id="5205577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5205580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5205583">panic</span><span class="op" id="5205588">(</span><span class="string" id="5205589">&#34;escaping&nbsp;&#34;</span>&nbsp;<span class="op" id="5205601">+</span>&nbsp;<span class="ident" id="5205603">n</span><span class="op" id="5205604">.</span><span class="ident" id="5205605">String</span><span class="op" id="5205611">(</span><span class="op" id="5205612">)</span>&nbsp;<span class="op" id="5205614">+</span>&nbsp;<span class="string" id="5205616">&#34;&nbsp;is&nbsp;unimplemented&#34;</span><span class="op" id="5205635">)</span><br>
<span class="lineno"></span><span class="op" id="5205637">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="comment" id="5205640">//&nbsp;escapeAction&nbsp;escapes&nbsp;an&nbsp;action&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="5205689">func</span>&nbsp;<span class="op" id="5205694">(</span><span class="ident" id="5205695">e</span>&nbsp;<span class="op" id="5205697">*</span><span class="ident" id="5205698">escaper</span><span class="op" id="5205705">)</span>&nbsp;<span class="ident" id="5205707">escapeAction</span><span class="op" id="5205719">(</span><span class="ident" id="5205720">c</span>&nbsp;<span class="ident" id="5205722">context</span><span class="op" id="5205729">,</span>&nbsp;<span class="ident" id="5205731">n</span>&nbsp;<span class="op" id="5205733">*</span><span class="ident" id="5205734">parse</span><span class="op" id="5205739">.</span><span class="ident" id="5205740">ActionNode</span><span class="op" id="5205750">)</span>&nbsp;<span class="ident" id="5205752">context</span>&nbsp;<span class="op" id="5205760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5205763">if</span>&nbsp;<span class="builtinfunc" id="5205766">len</span><span class="op" id="5205769">(</span><span class="ident" id="5205770">n</span><span class="op" id="5205771">.</span><span class="ident" id="5205772">Pipe</span><span class="op" id="5205776">.</span><span class="ident" id="5205777">Decl</span><span class="op" id="5205781">)</span>&nbsp;<span class="op" id="5205783">!=</span>&nbsp;<span class="num" id="5205786">0</span>&nbsp;<span class="op" id="5205788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5205792">//&nbsp;A&nbsp;local&nbsp;variable&nbsp;assignment,&nbsp;not&nbsp;an&nbsp;interpolation.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5205848">return</span>&nbsp;<span class="ident" id="5205855">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5205858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5205861">c</span>&nbsp;<span class="op" id="5205863">=</span>&nbsp;<span class="ident" id="5205865">nudge</span><span class="op" id="5205870">(</span><span class="ident" id="5205871">c</span><span class="op" id="5205872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5205875">s</span>&nbsp;<span class="op" id="5205877">:=</span>&nbsp;<span class="builtinfunc" id="5205880">make</span><span class="op" id="5205884">(</span><span class="op" id="5205885">[</span><span class="op" id="5205886">]</span><span class="builtintype" id="5205887">string</span><span class="op" id="5205893">,</span>&nbsp;<span class="num" id="5205895">0</span><span class="op" id="5205896">,</span>&nbsp;<span class="num" id="5205898">3</span><span class="op" id="5205899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5205902">switch</span>&nbsp;<span class="ident" id="5205909">c</span><span class="op" id="5205910">.</span><span class="ident" id="5205911">state</span>&nbsp;<span class="op" id="5205917">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5205920">case</span>&nbsp;<span class="ident" id="5205925">stateError</span><span class="op" id="5205935">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5205939">return</span>&nbsp;<span class="ident" id="5205946">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5205949">case</span>&nbsp;<span class="ident" id="5205954">stateURL</span><span class="op" id="5205962">,</span>&nbsp;<span class="ident" id="5205964">stateCSSDqStr</span><span class="op" id="5205977">,</span>&nbsp;<span class="ident" id="5205979">stateCSSSqStr</span><span class="op" id="5205992">,</span>&nbsp;<span class="ident" id="5205994">stateCSSDqURL</span><span class="op" id="5206007">,</span>&nbsp;<span class="ident" id="5206009">stateCSSSqURL</span><span class="op" id="5206022">,</span>&nbsp;<span class="ident" id="5206024">stateCSSURL</span><span class="op" id="5206035">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5206039">switch</span>&nbsp;<span class="ident" id="5206046">c</span><span class="op" id="5206047">.</span><span class="ident" id="5206048">urlPart</span>&nbsp;<span class="op" id="5206056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5206060">case</span>&nbsp;<span class="ident" id="5206065">urlPartNone</span><span class="op" id="5206076">:</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5206081">s</span>&nbsp;<span class="op" id="5206083">=</span>&nbsp;<span class="builtinfunc" id="5206085">append</span><span class="op" id="5206091">(</span><span class="ident" id="5206092">s</span><span class="op" id="5206093">,</span>&nbsp;<span class="string" id="5206095">&#34;html_template_urlfilter&#34;</span><span class="op" id="5206120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5206125">fallthrough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5206139">case</span>&nbsp;<span class="ident" id="5206144">urlPartPreQuery</span><span class="op" id="5206159">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5206164">switch</span>&nbsp;<span class="ident" id="5206171">c</span><span class="op" id="5206172">.</span><span class="ident" id="5206173">state</span>&nbsp;<span class="op" id="5206179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5206184">case</span>&nbsp;<span class="ident" id="5206189">stateCSSDqStr</span><span class="op" id="5206202">,</span>&nbsp;<span class="ident" id="5206204">stateCSSSqStr</span><span class="op" id="5206217">:</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5206223">s</span>&nbsp;<span class="op" id="5206225">=</span>&nbsp;<span class="builtinfunc" id="5206227">append</span><span class="op" id="5206233">(</span><span class="ident" id="5206234">s</span><span class="op" id="5206235">,</span>&nbsp;<span class="string" id="5206237">&#34;html_template_cssescaper&#34;</span><span class="op" id="5206263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5206268">default</span><span class="op" id="5206275">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5206281">s</span>&nbsp;<span class="op" id="5206283">=</span>&nbsp;<span class="builtinfunc" id="5206285">append</span><span class="op" id="5206291">(</span><span class="ident" id="5206292">s</span><span class="op" id="5206293">,</span>&nbsp;<span class="string" id="5206295">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="5206324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5206329">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5206333">case</span>&nbsp;<span class="ident" id="5206338">urlPartQueryOrFrag</span><span class="op" id="5206356">:</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5206361">s</span>&nbsp;<span class="op" id="5206363">=</span>&nbsp;<span class="builtinfunc" id="5206365">append</span><span class="op" id="5206371">(</span><span class="ident" id="5206372">s</span><span class="op" id="5206373">,</span>&nbsp;<span class="string" id="5206375">&#34;html_template_urlescaper&#34;</span><span class="op" id="5206401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5206405">case</span>&nbsp;<span class="ident" id="5206410">urlPartUnknown</span><span class="op" id="5206424">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5206429">return</span>&nbsp;<span class="ident" id="5206436">context</span><span class="op" id="5206443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5206449">state</span><span class="op" id="5206454">:</span>&nbsp;<span class="ident" id="5206456">stateError</span><span class="op" id="5206466">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5206472">err</span><span class="op" id="5206475">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5206479">errorf</span><span class="op" id="5206485">(</span><span class="ident" id="5206486">ErrAmbigContext</span><span class="op" id="5206501">,</span>&nbsp;<span class="ident" id="5206503">n</span><span class="op" id="5206504">,</span>&nbsp;<span class="ident" id="5206506">n</span><span class="op" id="5206507">.</span><span class="ident" id="5206508">Line</span><span class="op" id="5206512">,</span>&nbsp;<span class="string" id="5206514">&#34;%s&nbsp;appears&nbsp;in&nbsp;an&nbsp;ambiguous&nbsp;URL&nbsp;context&#34;</span><span class="op" id="5206554">,</span>&nbsp;<span class="ident" id="5206556">n</span><span class="op" id="5206557">)</span><span class="op" id="5206558">,</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5206563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5206567">default</span><span class="op" id="5206574">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5206579">panic</span><span class="op" id="5206584">(</span><span class="ident" id="5206585">c</span><span class="op" id="5206586">.</span><span class="ident" id="5206587">urlPart</span><span class="op" id="5206594">.</span><span class="ident" id="5206595">String</span><span class="op" id="5206601">(</span><span class="op" id="5206602">)</span><span class="op" id="5206603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5206607">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5206610">case</span>&nbsp;<span class="ident" id="5206615">stateJS</span><span class="op" id="5206622">:</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5206626">s</span>&nbsp;<span class="op" id="5206628">=</span>&nbsp;<span class="builtinfunc" id="5206630">append</span><span class="op" id="5206636">(</span><span class="ident" id="5206637">s</span><span class="op" id="5206638">,</span>&nbsp;<span class="string" id="5206640">&#34;html_template_jsvalescaper&#34;</span><span class="op" id="5206668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5206672">//&nbsp;A&nbsp;slash&nbsp;after&nbsp;a&nbsp;value&nbsp;starts&nbsp;a&nbsp;div&nbsp;operator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5206722">c</span><span class="op" id="5206723">.</span><span class="ident" id="5206724">jsCtx</span>&nbsp;<span class="op" id="5206730">=</span>&nbsp;<span class="ident" id="5206732">jsCtxDivOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5206744">case</span>&nbsp;<span class="ident" id="5206749">stateJSDqStr</span><span class="op" id="5206761">,</span>&nbsp;<span class="ident" id="5206763">stateJSSqStr</span><span class="op" id="5206775">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5206779">s</span>&nbsp;<span class="op" id="5206781">=</span>&nbsp;<span class="builtinfunc" id="5206783">append</span><span class="op" id="5206789">(</span><span class="ident" id="5206790">s</span><span class="op" id="5206791">,</span>&nbsp;<span class="string" id="5206793">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="5206821">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5206824">case</span>&nbsp;<span class="ident" id="5206829">stateJSRegexp</span><span class="op" id="5206842">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5206846">s</span>&nbsp;<span class="op" id="5206848">=</span>&nbsp;<span class="builtinfunc" id="5206850">append</span><span class="op" id="5206856">(</span><span class="ident" id="5206857">s</span><span class="op" id="5206858">,</span>&nbsp;<span class="string" id="5206860">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="5206891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5206894">case</span>&nbsp;<span class="ident" id="5206899">stateCSS</span><span class="op" id="5206907">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5206911">s</span>&nbsp;<span class="op" id="5206913">=</span>&nbsp;<span class="builtinfunc" id="5206915">append</span><span class="op" id="5206921">(</span><span class="ident" id="5206922">s</span><span class="op" id="5206923">,</span>&nbsp;<span class="string" id="5206925">&#34;html_template_cssvaluefilter&#34;</span><span class="op" id="5206955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5206958">case</span>&nbsp;<span class="ident" id="5206963">stateText</span><span class="op" id="5206972">:</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5206976">s</span>&nbsp;<span class="op" id="5206978">=</span>&nbsp;<span class="builtinfunc" id="5206980">append</span><span class="op" id="5206986">(</span><span class="ident" id="5206987">s</span><span class="op" id="5206988">,</span>&nbsp;<span class="string" id="5206990">&#34;html_template_htmlescaper&#34;</span><span class="op" id="5207017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5207020">case</span>&nbsp;<span class="ident" id="5207025">stateRCDATA</span><span class="op" id="5207036">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5207040">s</span>&nbsp;<span class="op" id="5207042">=</span>&nbsp;<span class="builtinfunc" id="5207044">append</span><span class="op" id="5207050">(</span><span class="ident" id="5207051">s</span><span class="op" id="5207052">,</span>&nbsp;<span class="string" id="5207054">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="5207083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5207086">case</span>&nbsp;<span class="ident" id="5207091">stateAttr</span><span class="op" id="5207100">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5207104">//&nbsp;Handled&nbsp;below&nbsp;in&nbsp;delim&nbsp;check.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5207138">case</span>&nbsp;<span class="ident" id="5207143">stateAttrName</span><span class="op" id="5207156">,</span>&nbsp;<span class="ident" id="5207158">stateTag</span><span class="op" id="5207166">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5207170">c</span><span class="op" id="5207171">.</span><span class="ident" id="5207172">state</span>&nbsp;<span class="op" id="5207178">=</span>&nbsp;<span class="ident" id="5207180">stateAttrName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5207196">s</span>&nbsp;<span class="op" id="5207198">=</span>&nbsp;<span class="builtinfunc" id="5207200">append</span><span class="op" id="5207206">(</span><span class="ident" id="5207207">s</span><span class="op" id="5207208">,</span>&nbsp;<span class="string" id="5207210">&#34;html_template_htmlnamefilter&#34;</span><span class="op" id="5207240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5207243">default</span><span class="op" id="5207250">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5207254">if</span>&nbsp;<span class="ident" id="5207257">isComment</span><span class="op" id="5207266">(</span><span class="ident" id="5207267">c</span><span class="op" id="5207268">.</span><span class="ident" id="5207269">state</span><span class="op" id="5207274">)</span>&nbsp;<span class="op" id="5207276">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5207281">s</span>&nbsp;<span class="op" id="5207283">=</span>&nbsp;<span class="builtinfunc" id="5207285">append</span><span class="op" id="5207291">(</span><span class="ident" id="5207292">s</span><span class="op" id="5207293">,</span>&nbsp;<span class="string" id="5207295">&#34;html_template_commentescaper&#34;</span><span class="op" id="5207325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5207329">}</span>&nbsp;<span class="keyword" id="5207331">else</span>&nbsp;<span class="op" id="5207336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5207341">panic</span><span class="op" id="5207346">(</span><span class="string" id="5207347">&#34;unexpected&nbsp;state&nbsp;&#34;</span>&nbsp;<span class="op" id="5207367">+</span>&nbsp;<span class="ident" id="5207369">c</span><span class="op" id="5207370">.</span><span class="ident" id="5207371">state</span><span class="op" id="5207376">.</span><span class="ident" id="5207377">String</span><span class="op" id="5207383">(</span><span class="op" id="5207384">)</span><span class="op" id="5207385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5207389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5207392">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5207395">switch</span>&nbsp;<span class="ident" id="5207402">c</span><span class="op" id="5207403">.</span><span class="ident" id="5207404">delim</span>&nbsp;<span class="op" id="5207410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5207413">case</span>&nbsp;<span class="ident" id="5207418">delimNone</span><span class="op" id="5207427">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5207431">//&nbsp;No&nbsp;extra-escaping&nbsp;needed&nbsp;for&nbsp;raw&nbsp;text&nbsp;content.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5207482">case</span>&nbsp;<span class="ident" id="5207487">delimSpaceOrTagEnd</span><span class="op" id="5207505">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5207509">s</span>&nbsp;<span class="op" id="5207511">=</span>&nbsp;<span class="builtinfunc" id="5207513">append</span><span class="op" id="5207519">(</span><span class="ident" id="5207520">s</span><span class="op" id="5207521">,</span>&nbsp;<span class="string" id="5207523">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="5207553">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5207556">default</span><span class="op" id="5207563">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5207567">s</span>&nbsp;<span class="op" id="5207569">=</span>&nbsp;<span class="builtinfunc" id="5207571">append</span><span class="op" id="5207577">(</span><span class="ident" id="5207578">s</span><span class="op" id="5207579">,</span>&nbsp;<span class="string" id="5207581">&#34;html_template_attrescaper&#34;</span><span class="op" id="5207608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5207611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5207614">e</span><span class="op" id="5207615">.</span><span class="ident" id="5207616">editActionNode</span><span class="op" id="5207630">(</span><span class="ident" id="5207631">n</span><span class="op" id="5207632">,</span>&nbsp;<span class="ident" id="5207634">s</span><span class="op" id="5207635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5207638">return</span>&nbsp;<span class="ident" id="5207645">c</span><br>
<span class="lineno">205</span><span class="op" id="5207647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5207650">//&nbsp;allIdents&nbsp;returns&nbsp;the&nbsp;names&nbsp;of&nbsp;the&nbsp;identifiers&nbsp;under&nbsp;the&nbsp;Ident&nbsp;field&nbsp;of&nbsp;the&nbsp;node,</span><br>
<span class="lineno"></span><span class="comment" id="5207735">//&nbsp;which&nbsp;might&nbsp;be&nbsp;a&nbsp;singleton&nbsp;(Identifier)&nbsp;or&nbsp;a&nbsp;slice&nbsp;(Field).</span><br>
<span class="lineno"></span><span class="keyword" id="5207798">func</span>&nbsp;<span class="ident" id="5207803">allIdents</span><span class="op" id="5207812">(</span><span class="ident" id="5207813">node</span>&nbsp;<span class="ident" id="5207818">parse</span><span class="op" id="5207823">.</span><span class="ident" id="5207824">Node</span><span class="op" id="5207828">)</span>&nbsp;<span class="op" id="5207830">[</span><span class="op" id="5207831">]</span><span class="builtintype" id="5207832">string</span>&nbsp;<span class="op" id="5207839">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5207842">switch</span>&nbsp;<span class="ident" id="5207849">node</span>&nbsp;<span class="op" id="5207854">:=</span>&nbsp;<span class="ident" id="5207857">node</span><span class="op" id="5207861">.</span><span class="op" id="5207862">(</span><span class="keyword" id="5207863">type</span><span class="op" id="5207867">)</span>&nbsp;<span class="op" id="5207869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5207872">case</span>&nbsp;<span class="op" id="5207877">*</span><span class="ident" id="5207878">parse</span><span class="op" id="5207883">.</span><span class="ident" id="5207884">IdentifierNode</span><span class="op" id="5207898">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5207902">return</span>&nbsp;<span class="op" id="5207909">[</span><span class="op" id="5207910">]</span><span class="builtintype" id="5207911">string</span><span class="op" id="5207917">{</span><span class="ident" id="5207918">node</span><span class="op" id="5207922">.</span><span class="ident" id="5207923">Ident</span><span class="op" id="5207928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5207931">case</span>&nbsp;<span class="op" id="5207936">*</span><span class="ident" id="5207937">parse</span><span class="op" id="5207942">.</span><span class="ident" id="5207943">FieldNode</span><span class="op" id="5207952">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5207956">return</span>&nbsp;<span class="ident" id="5207963">node</span><span class="op" id="5207967">.</span><span class="ident" id="5207968">Ident</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5207975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5207978">panic</span><span class="op" id="5207983">(</span><span class="string" id="5207984">&#34;unidentified&nbsp;node&nbsp;type&nbsp;in&nbsp;allIdents&#34;</span><span class="op" id="5208021">)</span><br>
<span class="lineno"></span><span class="op" id="5208023">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5208026">//&nbsp;ensurePipelineContains&nbsp;ensures&nbsp;that&nbsp;the&nbsp;pipeline&nbsp;has&nbsp;commands&nbsp;with</span><br>
<span class="lineno">220</span><span class="comment" id="5208096">//&nbsp;the&nbsp;identifiers&nbsp;in&nbsp;s&nbsp;in&nbsp;order.</span><br>
<span class="lineno"></span><span class="comment" id="5208130">//&nbsp;If&nbsp;the&nbsp;pipeline&nbsp;already&nbsp;has&nbsp;some&nbsp;of&nbsp;the&nbsp;sanitizers,&nbsp;do&nbsp;not&nbsp;interfere.</span><br>
<span class="lineno"></span><span class="comment" id="5208203">//&nbsp;For&nbsp;example,&nbsp;if&nbsp;p&nbsp;is&nbsp;(.X&nbsp;|&nbsp;html)&nbsp;and&nbsp;s&nbsp;is&nbsp;[&#34;escapeJSVal&#34;,&nbsp;&#34;html&#34;]&nbsp;then&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="5208280">//&nbsp;has&nbsp;one&nbsp;matching,&nbsp;&#34;html&#34;,&nbsp;and&nbsp;one&nbsp;to&nbsp;insert,&nbsp;&#34;escapeJSVal&#34;,&nbsp;to&nbsp;produce</span><br>
<span class="lineno"></span><span class="comment" id="5208354">//&nbsp;(.X&nbsp;|&nbsp;escapeJSVal&nbsp;|&nbsp;html).</span><br>
<span class="lineno">225</span><span class="keyword" id="5208384">func</span>&nbsp;<span class="ident" id="5208389">ensurePipelineContains</span><span class="op" id="5208411">(</span><span class="ident" id="5208412">p</span>&nbsp;<span class="op" id="5208414">*</span><span class="ident" id="5208415">parse</span><span class="op" id="5208420">.</span><span class="ident" id="5208421">PipeNode</span><span class="op" id="5208429">,</span>&nbsp;<span class="ident" id="5208431">s</span>&nbsp;<span class="op" id="5208433">[</span><span class="op" id="5208434">]</span><span class="builtintype" id="5208435">string</span><span class="op" id="5208441">)</span>&nbsp;<span class="op" id="5208443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5208446">if</span>&nbsp;<span class="builtinfunc" id="5208449">len</span><span class="op" id="5208452">(</span><span class="ident" id="5208453">s</span><span class="op" id="5208454">)</span>&nbsp;<span class="op" id="5208456">==</span>&nbsp;<span class="num" id="5208459">0</span>&nbsp;<span class="op" id="5208461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5208465">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5208473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5208476">n</span>&nbsp;<span class="op" id="5208478">:=</span>&nbsp;<span class="builtinfunc" id="5208481">len</span><span class="op" id="5208484">(</span><span class="ident" id="5208485">p</span><span class="op" id="5208486">.</span><span class="ident" id="5208487">Cmds</span><span class="op" id="5208491">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5208494">//&nbsp;Find&nbsp;the&nbsp;identifiers&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;command&nbsp;chain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5208552">idents</span>&nbsp;<span class="op" id="5208559">:=</span>&nbsp;<span class="ident" id="5208562">p</span><span class="op" id="5208563">.</span><span class="ident" id="5208564">Cmds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5208570">for</span>&nbsp;<span class="ident" id="5208574">i</span>&nbsp;<span class="op" id="5208576">:=</span>&nbsp;<span class="ident" id="5208579">n</span>&nbsp;<span class="op" id="5208581">-</span>&nbsp;<span class="num" id="5208583">1</span><span class="op" id="5208584">;</span>&nbsp;<span class="ident" id="5208586">i</span>&nbsp;<span class="op" id="5208588">&gt;=</span>&nbsp;<span class="num" id="5208591">0</span><span class="op" id="5208592">;</span>&nbsp;<span class="ident" id="5208594">i</span><span class="op" id="5208595">--</span>&nbsp;<span class="op" id="5208598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5208602">if</span>&nbsp;<span class="ident" id="5208605">cmd</span>&nbsp;<span class="op" id="5208609">:=</span>&nbsp;<span class="ident" id="5208612">p</span><span class="op" id="5208613">.</span><span class="ident" id="5208614">Cmds</span><span class="op" id="5208618">[</span><span class="ident" id="5208619">i</span><span class="op" id="5208620">]</span><span class="op" id="5208621">;</span>&nbsp;<span class="builtinfunc" id="5208623">len</span><span class="op" id="5208626">(</span><span class="ident" id="5208627">cmd</span><span class="op" id="5208630">.</span><span class="ident" id="5208631">Args</span><span class="op" id="5208635">)</span>&nbsp;<span class="op" id="5208637">!=</span>&nbsp;<span class="num" id="5208640">0</span>&nbsp;<span class="op" id="5208642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5208647">if</span>&nbsp;<span class="ident" id="5208650">_</span><span class="op" id="5208651">,</span>&nbsp;<span class="ident" id="5208653">ok</span>&nbsp;<span class="op" id="5208656">:=</span>&nbsp;<span class="ident" id="5208659">cmd</span><span class="op" id="5208662">.</span><span class="ident" id="5208663">Args</span><span class="op" id="5208667">[</span><span class="num" id="5208668">0</span><span class="op" id="5208669">]</span><span class="op" id="5208670">.</span><span class="op" id="5208671">(</span><span class="op" id="5208672">*</span><span class="ident" id="5208673">parse</span><span class="op" id="5208678">.</span><span class="ident" id="5208679">IdentifierNode</span><span class="op" id="5208693">)</span><span class="op" id="5208694">;</span>&nbsp;<span class="ident" id="5208696">ok</span>&nbsp;<span class="op" id="5208699">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5208705">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5208717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5208721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5208725">idents</span>&nbsp;<span class="op" id="5208732">=</span>&nbsp;<span class="ident" id="5208734">p</span><span class="op" id="5208735">.</span><span class="ident" id="5208736">Cmds</span><span class="op" id="5208740">[</span><span class="ident" id="5208741">i</span><span class="op" id="5208742">+</span><span class="num" id="5208743">1</span><span class="op" id="5208744">:</span><span class="op" id="5208745">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5208748">}</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5208751">dups</span>&nbsp;<span class="op" id="5208756">:=</span>&nbsp;<span class="num" id="5208759">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5208762">for</span>&nbsp;<span class="ident" id="5208766">_</span><span class="op" id="5208767">,</span>&nbsp;<span class="ident" id="5208769">idNode</span>&nbsp;<span class="op" id="5208776">:=</span>&nbsp;<span class="keyword" id="5208779">range</span>&nbsp;<span class="ident" id="5208785">idents</span>&nbsp;<span class="op" id="5208792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5208796">for</span>&nbsp;<span class="ident" id="5208800">_</span><span class="op" id="5208801">,</span>&nbsp;<span class="ident" id="5208803">ident</span>&nbsp;<span class="op" id="5208809">:=</span>&nbsp;<span class="keyword" id="5208812">range</span>&nbsp;<span class="ident" id="5208818">allIdents</span><span class="op" id="5208827">(</span><span class="ident" id="5208828">idNode</span><span class="op" id="5208834">.</span><span class="ident" id="5208835">Args</span><span class="op" id="5208839">[</span><span class="num" id="5208840">0</span><span class="op" id="5208841">]</span><span class="op" id="5208842">)</span>&nbsp;<span class="op" id="5208844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5208849">if</span>&nbsp;<span class="ident" id="5208852">escFnsEq</span><span class="op" id="5208860">(</span><span class="ident" id="5208861">s</span><span class="op" id="5208862">[</span><span class="ident" id="5208863">dups</span><span class="op" id="5208867">]</span><span class="op" id="5208868">,</span>&nbsp;<span class="ident" id="5208870">ident</span><span class="op" id="5208875">)</span>&nbsp;<span class="op" id="5208877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5208883">dups</span><span class="op" id="5208887">++</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5208894">if</span>&nbsp;<span class="ident" id="5208897">dups</span>&nbsp;<span class="op" id="5208902">==</span>&nbsp;<span class="builtinfunc" id="5208905">len</span><span class="op" id="5208908">(</span><span class="ident" id="5208909">s</span><span class="op" id="5208910">)</span>&nbsp;<span class="op" id="5208912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5208919">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5208930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5208935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5208939">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5208942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5208945">newCmds</span>&nbsp;<span class="op" id="5208953">:=</span>&nbsp;<span class="builtinfunc" id="5208956">make</span><span class="op" id="5208960">(</span><span class="op" id="5208961">[</span><span class="op" id="5208962">]</span><span class="op" id="5208963">*</span><span class="ident" id="5208964">parse</span><span class="op" id="5208969">.</span><span class="ident" id="5208970">CommandNode</span><span class="op" id="5208981">,</span>&nbsp;<span class="ident" id="5208983">n</span><span class="op" id="5208984">-</span><span class="builtinfunc" id="5208985">len</span><span class="op" id="5208988">(</span><span class="ident" id="5208989">idents</span><span class="op" id="5208995">)</span><span class="op" id="5208996">,</span>&nbsp;<span class="ident" id="5208998">n</span><span class="op" id="5208999">+</span><span class="builtinfunc" id="5209000">len</span><span class="op" id="5209003">(</span><span class="ident" id="5209004">s</span><span class="op" id="5209005">)</span><span class="op" id="5209006">-</span><span class="ident" id="5209007">dups</span><span class="op" id="5209011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5209014">copy</span><span class="op" id="5209018">(</span><span class="ident" id="5209019">newCmds</span><span class="op" id="5209026">,</span>&nbsp;<span class="ident" id="5209028">p</span><span class="op" id="5209029">.</span><span class="ident" id="5209030">Cmds</span><span class="op" id="5209034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5209037">//&nbsp;Merge&nbsp;existing&nbsp;identifier&nbsp;commands&nbsp;with&nbsp;the&nbsp;sanitizers&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5209104">for</span>&nbsp;<span class="ident" id="5209108">_</span><span class="op" id="5209109">,</span>&nbsp;<span class="ident" id="5209111">idNode</span>&nbsp;<span class="op" id="5209118">:=</span>&nbsp;<span class="keyword" id="5209121">range</span>&nbsp;<span class="ident" id="5209127">idents</span>&nbsp;<span class="op" id="5209134">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5209138">pos</span>&nbsp;<span class="op" id="5209142">:=</span>&nbsp;<span class="ident" id="5209145">idNode</span><span class="op" id="5209151">.</span><span class="ident" id="5209152">Args</span><span class="op" id="5209156">[</span><span class="num" id="5209157">0</span><span class="op" id="5209158">]</span><span class="op" id="5209159">.</span><span class="ident" id="5209160">Position</span><span class="op" id="5209168">(</span><span class="op" id="5209169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5209173">for</span>&nbsp;<span class="ident" id="5209177">_</span><span class="op" id="5209178">,</span>&nbsp;<span class="ident" id="5209180">ident</span>&nbsp;<span class="op" id="5209186">:=</span>&nbsp;<span class="keyword" id="5209189">range</span>&nbsp;<span class="ident" id="5209195">allIdents</span><span class="op" id="5209204">(</span><span class="ident" id="5209205">idNode</span><span class="op" id="5209211">.</span><span class="ident" id="5209212">Args</span><span class="op" id="5209216">[</span><span class="num" id="5209217">0</span><span class="op" id="5209218">]</span><span class="op" id="5209219">)</span>&nbsp;<span class="op" id="5209221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5209226">i</span>&nbsp;<span class="op" id="5209228">:=</span>&nbsp;<span class="ident" id="5209231">indexOfStr</span><span class="op" id="5209241">(</span><span class="ident" id="5209242">ident</span><span class="op" id="5209247">,</span>&nbsp;<span class="ident" id="5209249">s</span><span class="op" id="5209250">,</span>&nbsp;<span class="ident" id="5209252">escFnsEq</span><span class="op" id="5209260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5209265">if</span>&nbsp;<span class="ident" id="5209268">i</span>&nbsp;<span class="op" id="5209270">!=</span>&nbsp;<span class="op" id="5209273">-</span><span class="num" id="5209274">1</span>&nbsp;<span class="op" id="5209276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5209282">for</span>&nbsp;<span class="ident" id="5209286">_</span><span class="op" id="5209287">,</span>&nbsp;<span class="ident" id="5209289">name</span>&nbsp;<span class="op" id="5209294">:=</span>&nbsp;<span class="keyword" id="5209297">range</span>&nbsp;<span class="ident" id="5209303">s</span><span class="op" id="5209304">[</span><span class="op" id="5209305">:</span><span class="ident" id="5209306">i</span><span class="op" id="5209307">]</span>&nbsp;<span class="op" id="5209309">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5209316">newCmds</span>&nbsp;<span class="op" id="5209324">=</span>&nbsp;<span class="ident" id="5209326">appendCmd</span><span class="op" id="5209335">(</span><span class="ident" id="5209336">newCmds</span><span class="op" id="5209343">,</span>&nbsp;<span class="ident" id="5209345">newIdentCmd</span><span class="op" id="5209356">(</span><span class="ident" id="5209357">name</span><span class="op" id="5209361">,</span>&nbsp;<span class="ident" id="5209363">pos</span><span class="op" id="5209366">)</span><span class="op" id="5209367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5209373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5209379">s</span>&nbsp;<span class="op" id="5209381">=</span>&nbsp;<span class="ident" id="5209383">s</span><span class="op" id="5209384">[</span><span class="ident" id="5209385">i</span><span class="op" id="5209386">+</span><span class="num" id="5209387">1</span><span class="op" id="5209388">:</span><span class="op" id="5209389">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5209394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5209398">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5209402">newCmds</span>&nbsp;<span class="op" id="5209410">=</span>&nbsp;<span class="ident" id="5209412">appendCmd</span><span class="op" id="5209421">(</span><span class="ident" id="5209422">newCmds</span><span class="op" id="5209429">,</span>&nbsp;<span class="ident" id="5209431">idNode</span><span class="op" id="5209437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5209440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5209443">//&nbsp;Create&nbsp;any&nbsp;remaining&nbsp;sanitizers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5209480">for</span>&nbsp;<span class="ident" id="5209484">_</span><span class="op" id="5209485">,</span>&nbsp;<span class="ident" id="5209487">name</span>&nbsp;<span class="op" id="5209492">:=</span>&nbsp;<span class="keyword" id="5209495">range</span>&nbsp;<span class="ident" id="5209501">s</span>&nbsp;<span class="op" id="5209503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5209507">newCmds</span>&nbsp;<span class="op" id="5209515">=</span>&nbsp;<span class="ident" id="5209517">appendCmd</span><span class="op" id="5209526">(</span><span class="ident" id="5209527">newCmds</span><span class="op" id="5209534">,</span>&nbsp;<span class="ident" id="5209536">newIdentCmd</span><span class="op" id="5209547">(</span><span class="ident" id="5209548">name</span><span class="op" id="5209552">,</span>&nbsp;<span class="ident" id="5209554">p</span><span class="op" id="5209555">.</span><span class="ident" id="5209556">Position</span><span class="op" id="5209564">(</span><span class="op" id="5209565">)</span><span class="op" id="5209566">)</span><span class="op" id="5209567">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5209570">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5209573">p</span><span class="op" id="5209574">.</span><span class="ident" id="5209575">Cmds</span>&nbsp;<span class="op" id="5209580">=</span>&nbsp;<span class="ident" id="5209582">newCmds</span><br>
<span class="lineno"></span><span class="op" id="5209590">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5209593">//&nbsp;redundantFuncs[a][b]&nbsp;implies&nbsp;that&nbsp;funcMap[b](funcMap[a](x))&nbsp;==&nbsp;funcMap[a](x)</span><br>
<span class="lineno">275</span><span class="comment" id="5209673">//&nbsp;for&nbsp;all&nbsp;x.</span><br>
<span class="lineno"></span><span class="keyword" id="5209687">var</span>&nbsp;<span class="ident" id="5209691">redundantFuncs</span>&nbsp;<span class="op" id="5209706">=</span>&nbsp;<span class="keyword" id="5209708">map</span><span class="op" id="5209711">[</span><span class="builtintype" id="5209712">string</span><span class="op" id="5209718">]</span><span class="keyword" id="5209719">map</span><span class="op" id="5209722">[</span><span class="builtintype" id="5209723">string</span><span class="op" id="5209729">]</span><span class="builtintype" id="5209730">bool</span><span class="op" id="5209734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5209737">&#34;html_template_commentescaper&#34;</span><span class="op" id="5209767">:</span>&nbsp;<span class="op" id="5209769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5209773">&#34;html_template_attrescaper&#34;</span><span class="op" id="5209800">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5209805">true</span><span class="op" id="5209809">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5209813">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="5209843">:</span>&nbsp;<span class="builtintype" id="5209845">true</span><span class="op" id="5209849">,</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5209853">&#34;html_template_htmlescaper&#34;</span><span class="op" id="5209880">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5209885">true</span><span class="op" id="5209889">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5209892">}</span><span class="op" id="5209893">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5209896">&#34;html_template_cssescaper&#34;</span><span class="op" id="5209922">:</span>&nbsp;<span class="op" id="5209924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5209928">&#34;html_template_attrescaper&#34;</span><span class="op" id="5209955">:</span>&nbsp;<span class="builtintype" id="5209957">true</span><span class="op" id="5209961">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5209964">}</span><span class="op" id="5209965">,</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5209968">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="5209999">:</span>&nbsp;<span class="op" id="5210001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5210005">&#34;html_template_attrescaper&#34;</span><span class="op" id="5210032">:</span>&nbsp;<span class="builtintype" id="5210034">true</span><span class="op" id="5210038">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5210041">}</span><span class="op" id="5210042">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5210045">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="5210073">:</span>&nbsp;<span class="op" id="5210075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5210079">&#34;html_template_attrescaper&#34;</span><span class="op" id="5210106">:</span>&nbsp;<span class="builtintype" id="5210108">true</span><span class="op" id="5210112">,</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5210115">}</span><span class="op" id="5210116">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5210119">&#34;html_template_urlescaper&#34;</span><span class="op" id="5210145">:</span>&nbsp;<span class="op" id="5210147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5210151">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="5210180">:</span>&nbsp;<span class="builtintype" id="5210182">true</span><span class="op" id="5210186">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5210189">}</span><span class="op" id="5210190">,</span><br>
<span class="lineno"></span><span class="op" id="5210192">}</span><br>
<span class="lineno">295</span><br>
<span class="lineno"></span><span class="comment" id="5210195">//&nbsp;appendCmd&nbsp;appends&nbsp;the&nbsp;given&nbsp;command&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;command&nbsp;pipeline</span><br>
<span class="lineno"></span><span class="comment" id="5210269">//&nbsp;unless&nbsp;it&nbsp;is&nbsp;redundant&nbsp;with&nbsp;the&nbsp;last&nbsp;command.</span><br>
<span class="lineno"></span><span class="keyword" id="5210318">func</span>&nbsp;<span class="ident" id="5210323">appendCmd</span><span class="op" id="5210332">(</span><span class="ident" id="5210333">cmds</span>&nbsp;<span class="op" id="5210338">[</span><span class="op" id="5210339">]</span><span class="op" id="5210340">*</span><span class="ident" id="5210341">parse</span><span class="op" id="5210346">.</span><span class="ident" id="5210347">CommandNode</span><span class="op" id="5210358">,</span>&nbsp;<span class="ident" id="5210360">cmd</span>&nbsp;<span class="op" id="5210364">*</span><span class="ident" id="5210365">parse</span><span class="op" id="5210370">.</span><span class="ident" id="5210371">CommandNode</span><span class="op" id="5210382">)</span>&nbsp;<span class="op" id="5210384">[</span><span class="op" id="5210385">]</span><span class="op" id="5210386">*</span><span class="ident" id="5210387">parse</span><span class="op" id="5210392">.</span><span class="ident" id="5210393">CommandNode</span>&nbsp;<span class="op" id="5210405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5210408">if</span>&nbsp;<span class="ident" id="5210411">n</span>&nbsp;<span class="op" id="5210413">:=</span>&nbsp;<span class="builtinfunc" id="5210416">len</span><span class="op" id="5210419">(</span><span class="ident" id="5210420">cmds</span><span class="op" id="5210424">)</span><span class="op" id="5210425">;</span>&nbsp;<span class="ident" id="5210427">n</span>&nbsp;<span class="op" id="5210429">!=</span>&nbsp;<span class="num" id="5210432">0</span>&nbsp;<span class="op" id="5210434">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5210438">last</span><span class="op" id="5210442">,</span>&nbsp;<span class="ident" id="5210444">ok</span>&nbsp;<span class="op" id="5210447">:=</span>&nbsp;<span class="ident" id="5210450">cmds</span><span class="op" id="5210454">[</span><span class="ident" id="5210455">n</span><span class="op" id="5210456">-</span><span class="num" id="5210457">1</span><span class="op" id="5210458">]</span><span class="op" id="5210459">.</span><span class="ident" id="5210460">Args</span><span class="op" id="5210464">[</span><span class="num" id="5210465">0</span><span class="op" id="5210466">]</span><span class="op" id="5210467">.</span><span class="op" id="5210468">(</span><span class="op" id="5210469">*</span><span class="ident" id="5210470">parse</span><span class="op" id="5210475">.</span><span class="ident" id="5210476">IdentifierNode</span><span class="op" id="5210490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5210494">next</span><span class="op" id="5210498">,</span>&nbsp;<span class="ident" id="5210500">_</span>&nbsp;<span class="op" id="5210502">:=</span>&nbsp;<span class="ident" id="5210505">cmd</span><span class="op" id="5210508">.</span><span class="ident" id="5210509">Args</span><span class="op" id="5210513">[</span><span class="num" id="5210514">0</span><span class="op" id="5210515">]</span><span class="op" id="5210516">.</span><span class="op" id="5210517">(</span><span class="op" id="5210518">*</span><span class="ident" id="5210519">parse</span><span class="op" id="5210524">.</span><span class="ident" id="5210525">IdentifierNode</span><span class="op" id="5210539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5210543">if</span>&nbsp;<span class="ident" id="5210546">ok</span>&nbsp;<span class="op" id="5210549">&amp;&amp;</span>&nbsp;<span class="ident" id="5210552">redundantFuncs</span><span class="op" id="5210566">[</span><span class="ident" id="5210567">last</span><span class="op" id="5210571">.</span><span class="ident" id="5210572">Ident</span><span class="op" id="5210577">]</span><span class="op" id="5210578">[</span><span class="ident" id="5210579">next</span><span class="op" id="5210583">.</span><span class="ident" id="5210584">Ident</span><span class="op" id="5210589">]</span>&nbsp;<span class="op" id="5210591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5210596">return</span>&nbsp;<span class="ident" id="5210603">cmds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5210610">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5210613">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5210616">return</span>&nbsp;<span class="builtinfunc" id="5210623">append</span><span class="op" id="5210629">(</span><span class="ident" id="5210630">cmds</span><span class="op" id="5210634">,</span>&nbsp;<span class="ident" id="5210636">cmd</span><span class="op" id="5210639">)</span><br>
<span class="lineno"></span><span class="op" id="5210641">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5210644">//&nbsp;indexOfStr&nbsp;is&nbsp;the&nbsp;first&nbsp;i&nbsp;such&nbsp;that&nbsp;eq(s,&nbsp;strs[i])&nbsp;or&nbsp;-1&nbsp;if&nbsp;s&nbsp;was&nbsp;not&nbsp;found.</span><br>
<span class="lineno">310</span><span class="keyword" id="5210724">func</span>&nbsp;<span class="ident" id="5210729">indexOfStr</span><span class="op" id="5210739">(</span><span class="ident" id="5210740">s</span>&nbsp;<span class="builtintype" id="5210742">string</span><span class="op" id="5210748">,</span>&nbsp;<span class="ident" id="5210750">strs</span>&nbsp;<span class="op" id="5210755">[</span><span class="op" id="5210756">]</span><span class="builtintype" id="5210757">string</span><span class="op" id="5210763">,</span>&nbsp;<span class="ident" id="5210765">eq</span>&nbsp;<span class="keyword" id="5210768">func</span><span class="op" id="5210772">(</span><span class="ident" id="5210773">a</span><span class="op" id="5210774">,</span>&nbsp;<span class="ident" id="5210776">b</span>&nbsp;<span class="builtintype" id="5210778">string</span><span class="op" id="5210784">)</span>&nbsp;<span class="builtintype" id="5210786">bool</span><span class="op" id="5210790">)</span>&nbsp;<span class="builtintype" id="5210792">int</span>&nbsp;<span class="op" id="5210796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5210799">for</span>&nbsp;<span class="ident" id="5210803">i</span><span class="op" id="5210804">,</span>&nbsp;<span class="ident" id="5210806">t</span>&nbsp;<span class="op" id="5210808">:=</span>&nbsp;<span class="keyword" id="5210811">range</span>&nbsp;<span class="ident" id="5210817">strs</span>&nbsp;<span class="op" id="5210822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5210826">if</span>&nbsp;<span class="ident" id="5210829">eq</span><span class="op" id="5210831">(</span><span class="ident" id="5210832">s</span><span class="op" id="5210833">,</span>&nbsp;<span class="ident" id="5210835">t</span><span class="op" id="5210836">)</span>&nbsp;<span class="op" id="5210838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5210843">return</span>&nbsp;<span class="ident" id="5210850">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5210854">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5210857">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5210860">return</span>&nbsp;<span class="op" id="5210867">-</span><span class="num" id="5210868">1</span><br>
<span class="lineno"></span><span class="op" id="5210870">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5210873">//&nbsp;escFnsEq&nbsp;reports&nbsp;whether&nbsp;the&nbsp;two&nbsp;escaping&nbsp;functions&nbsp;are&nbsp;equivalent.</span><br>
<span class="lineno">320</span><span class="keyword" id="5210944">func</span>&nbsp;<span class="ident" id="5210949">escFnsEq</span><span class="op" id="5210957">(</span><span class="ident" id="5210958">a</span><span class="op" id="5210959">,</span>&nbsp;<span class="ident" id="5210961">b</span>&nbsp;<span class="builtintype" id="5210963">string</span><span class="op" id="5210969">)</span>&nbsp;<span class="builtintype" id="5210971">bool</span>&nbsp;<span class="op" id="5210976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5210979">if</span>&nbsp;<span class="ident" id="5210982">e</span>&nbsp;<span class="op" id="5210984">:=</span>&nbsp;<span class="ident" id="5210987">equivEscapers</span><span class="op" id="5211000">[</span><span class="ident" id="5211001">a</span><span class="op" id="5211002">]</span><span class="op" id="5211003">;</span>&nbsp;<span class="ident" id="5211005">e</span>&nbsp;<span class="op" id="5211007">!=</span>&nbsp;<span class="string" id="5211010">&#34;&#34;</span>&nbsp;<span class="op" id="5211013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5211017">a</span>&nbsp;<span class="op" id="5211019">=</span>&nbsp;<span class="ident" id="5211021">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5211024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5211027">if</span>&nbsp;<span class="ident" id="5211030">e</span>&nbsp;<span class="op" id="5211032">:=</span>&nbsp;<span class="ident" id="5211035">equivEscapers</span><span class="op" id="5211048">[</span><span class="ident" id="5211049">b</span><span class="op" id="5211050">]</span><span class="op" id="5211051">;</span>&nbsp;<span class="ident" id="5211053">e</span>&nbsp;<span class="op" id="5211055">!=</span>&nbsp;<span class="string" id="5211058">&#34;&#34;</span>&nbsp;<span class="op" id="5211061">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5211065">b</span>&nbsp;<span class="op" id="5211067">=</span>&nbsp;<span class="ident" id="5211069">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5211072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5211075">return</span>&nbsp;<span class="ident" id="5211082">a</span>&nbsp;<span class="op" id="5211084">==</span>&nbsp;<span class="ident" id="5211087">b</span><br>
<span class="lineno"></span><span class="op" id="5211089">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span><span class="comment" id="5211092">//&nbsp;newIdentCmd&nbsp;produces&nbsp;a&nbsp;command&nbsp;containing&nbsp;a&nbsp;single&nbsp;identifier&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="5211163">func</span>&nbsp;<span class="ident" id="5211168">newIdentCmd</span><span class="op" id="5211179">(</span><span class="ident" id="5211180">identifier</span>&nbsp;<span class="builtintype" id="5211191">string</span><span class="op" id="5211197">,</span>&nbsp;<span class="ident" id="5211199">pos</span>&nbsp;<span class="ident" id="5211203">parse</span><span class="op" id="5211208">.</span><span class="ident" id="5211209">Pos</span><span class="op" id="5211212">)</span>&nbsp;<span class="op" id="5211214">*</span><span class="ident" id="5211215">parse</span><span class="op" id="5211220">.</span><span class="ident" id="5211221">CommandNode</span>&nbsp;<span class="op" id="5211233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5211236">return</span>&nbsp;<span class="op" id="5211243">&amp;</span><span class="ident" id="5211244">parse</span><span class="op" id="5211249">.</span><span class="ident" id="5211250">CommandNode</span><span class="op" id="5211261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5211265">NodeType</span><span class="op" id="5211273">:</span>&nbsp;<span class="ident" id="5211275">parse</span><span class="op" id="5211280">.</span><span class="ident" id="5211281">NodeCommand</span><span class="op" id="5211292">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5211296">Args</span><span class="op" id="5211300">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5211306">[</span><span class="op" id="5211307">]</span><span class="ident" id="5211308">parse</span><span class="op" id="5211313">.</span><span class="ident" id="5211314">Node</span><span class="op" id="5211318">{</span><span class="ident" id="5211319">parse</span><span class="op" id="5211324">.</span><span class="ident" id="5211325">NewIdentifier</span><span class="op" id="5211338">(</span><span class="ident" id="5211339">identifier</span><span class="op" id="5211349">)</span><span class="op" id="5211350">.</span><span class="ident" id="5211351">SetTree</span><span class="op" id="5211358">(</span><span class="ident" id="5211359">nil</span><span class="op" id="5211362">)</span><span class="op" id="5211363">.</span><span class="ident" id="5211364">SetPos</span><span class="op" id="5211370">(</span><span class="ident" id="5211371">pos</span><span class="op" id="5211374">)</span><span class="op" id="5211375">}</span><span class="op" id="5211376">,</span>&nbsp;<span class="comment" id="5211378">//&nbsp;TODO:&nbsp;SetTree.</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5211397">}</span><br>
<span class="lineno"></span><span class="op" id="5211399">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5211402">//&nbsp;nudge&nbsp;returns&nbsp;the&nbsp;context&nbsp;that&nbsp;would&nbsp;result&nbsp;from&nbsp;following&nbsp;empty&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="5211477">//&nbsp;transitions&nbsp;from&nbsp;the&nbsp;input&nbsp;context.</span><br>
<span class="lineno">340</span><span class="comment" id="5211516">//&nbsp;For&nbsp;example,&nbsp;parsing:</span><br>
<span class="lineno"></span><span class="comment" id="5211541">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`&lt;a&nbsp;href=`</span><br>
<span class="lineno"></span><span class="comment" id="5211559">//&nbsp;will&nbsp;end&nbsp;in&nbsp;context{stateBeforeValue,&nbsp;attrURL},&nbsp;but&nbsp;parsing&nbsp;one&nbsp;extra&nbsp;rune:</span><br>
<span class="lineno"></span><span class="comment" id="5211638">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`&lt;a&nbsp;href=x`</span><br>
<span class="lineno"></span><span class="comment" id="5211657">//&nbsp;will&nbsp;end&nbsp;in&nbsp;context{stateURL,&nbsp;delimSpaceOrTagEnd,&nbsp;...}.</span><br>
<span class="lineno">345</span><span class="comment" id="5211716">//&nbsp;There&nbsp;are&nbsp;two&nbsp;transitions&nbsp;that&nbsp;happen&nbsp;when&nbsp;the&nbsp;&#39;x&#39;&nbsp;is&nbsp;seen:</span><br>
<span class="lineno"></span><span class="comment" id="5211779">//&nbsp;(1)&nbsp;Transition&nbsp;from&nbsp;a&nbsp;before-value&nbsp;state&nbsp;to&nbsp;a&nbsp;start-of-value&nbsp;state&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="5211857">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;consuming&nbsp;any&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="5211889">//&nbsp;(2)&nbsp;Consume&nbsp;&#39;x&#39;&nbsp;and&nbsp;transition&nbsp;past&nbsp;the&nbsp;first&nbsp;value&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="5211955">//&nbsp;In&nbsp;this&nbsp;case,&nbsp;nudging&nbsp;produces&nbsp;the&nbsp;context&nbsp;after&nbsp;(1)&nbsp;happens.</span><br>
<span class="lineno">350</span><span class="keyword" id="5212020">func</span>&nbsp;<span class="ident" id="5212025">nudge</span><span class="op" id="5212030">(</span><span class="ident" id="5212031">c</span>&nbsp;<span class="ident" id="5212033">context</span><span class="op" id="5212040">)</span>&nbsp;<span class="ident" id="5212042">context</span>&nbsp;<span class="op" id="5212050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5212053">switch</span>&nbsp;<span class="ident" id="5212060">c</span><span class="op" id="5212061">.</span><span class="ident" id="5212062">state</span>&nbsp;<span class="op" id="5212068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5212071">case</span>&nbsp;<span class="ident" id="5212076">stateTag</span><span class="op" id="5212084">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5212088">//&nbsp;In&nbsp;`&lt;foo&nbsp;{{.}}`,&nbsp;the&nbsp;action&nbsp;should&nbsp;emit&nbsp;an&nbsp;attribute.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212147">c</span><span class="op" id="5212148">.</span><span class="ident" id="5212149">state</span>&nbsp;<span class="op" id="5212155">=</span>&nbsp;<span class="ident" id="5212157">stateAttrName</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5212172">case</span>&nbsp;<span class="ident" id="5212177">stateBeforeValue</span><span class="op" id="5212193">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5212197">//&nbsp;In&nbsp;`&lt;foo&nbsp;bar={{.}}`,&nbsp;the&nbsp;action&nbsp;is&nbsp;an&nbsp;undelimited&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212259">c</span><span class="op" id="5212260">.</span><span class="ident" id="5212261">state</span><span class="op" id="5212266">,</span>&nbsp;<span class="ident" id="5212268">c</span><span class="op" id="5212269">.</span><span class="ident" id="5212270">delim</span><span class="op" id="5212275">,</span>&nbsp;<span class="ident" id="5212277">c</span><span class="op" id="5212278">.</span><span class="ident" id="5212279">attr</span>&nbsp;<span class="op" id="5212284">=</span>&nbsp;<span class="ident" id="5212286">attrStartStates</span><span class="op" id="5212301">[</span><span class="ident" id="5212302">c</span><span class="op" id="5212303">.</span><span class="ident" id="5212304">attr</span><span class="op" id="5212308">]</span><span class="op" id="5212309">,</span>&nbsp;<span class="ident" id="5212311">delimSpaceOrTagEnd</span><span class="op" id="5212329">,</span>&nbsp;<span class="ident" id="5212331">attrNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5212341">case</span>&nbsp;<span class="ident" id="5212346">stateAfterName</span><span class="op" id="5212360">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5212364">//&nbsp;In&nbsp;`&lt;foo&nbsp;bar&nbsp;{{.}}`,&nbsp;the&nbsp;action&nbsp;is&nbsp;an&nbsp;attribute&nbsp;name.</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212423">c</span><span class="op" id="5212424">.</span><span class="ident" id="5212425">state</span><span class="op" id="5212430">,</span>&nbsp;<span class="ident" id="5212432">c</span><span class="op" id="5212433">.</span><span class="ident" id="5212434">attr</span>&nbsp;<span class="op" id="5212439">=</span>&nbsp;<span class="ident" id="5212441">stateAttrName</span><span class="op" id="5212454">,</span>&nbsp;<span class="ident" id="5212456">attrNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5212466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5212469">return</span>&nbsp;<span class="ident" id="5212476">c</span><br>
<span class="lineno"></span><span class="op" id="5212478">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="comment" id="5212481">//&nbsp;join&nbsp;joins&nbsp;the&nbsp;two&nbsp;contexts&nbsp;of&nbsp;a&nbsp;branch&nbsp;template&nbsp;node.&nbsp;The&nbsp;result&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="5212556">//&nbsp;error&nbsp;context&nbsp;if&nbsp;either&nbsp;of&nbsp;the&nbsp;input&nbsp;contexts&nbsp;are&nbsp;error&nbsp;contexts,&nbsp;or&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5212635">//&nbsp;the&nbsp;input&nbsp;contexts&nbsp;differ.</span><br>
<span class="lineno"></span><span class="keyword" id="5212665">func</span>&nbsp;<span class="ident" id="5212670">join</span><span class="op" id="5212674">(</span><span class="ident" id="5212675">a</span><span class="op" id="5212676">,</span>&nbsp;<span class="ident" id="5212678">b</span>&nbsp;<span class="ident" id="5212680">context</span><span class="op" id="5212687">,</span>&nbsp;<span class="ident" id="5212689">node</span>&nbsp;<span class="ident" id="5212694">parse</span><span class="op" id="5212699">.</span><span class="ident" id="5212700">Node</span><span class="op" id="5212704">,</span>&nbsp;<span class="ident" id="5212706">nodeName</span>&nbsp;<span class="builtintype" id="5212715">string</span><span class="op" id="5212721">)</span>&nbsp;<span class="ident" id="5212723">context</span>&nbsp;<span class="op" id="5212731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5212734">if</span>&nbsp;<span class="ident" id="5212737">a</span><span class="op" id="5212738">.</span><span class="ident" id="5212739">state</span>&nbsp;<span class="op" id="5212745">==</span>&nbsp;<span class="ident" id="5212748">stateError</span>&nbsp;<span class="op" id="5212759">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5212763">return</span>&nbsp;<span class="ident" id="5212770">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5212773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5212776">if</span>&nbsp;<span class="ident" id="5212779">b</span><span class="op" id="5212780">.</span><span class="ident" id="5212781">state</span>&nbsp;<span class="op" id="5212787">==</span>&nbsp;<span class="ident" id="5212790">stateError</span>&nbsp;<span class="op" id="5212801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5212805">return</span>&nbsp;<span class="ident" id="5212812">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5212815">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5212818">if</span>&nbsp;<span class="ident" id="5212821">a</span><span class="op" id="5212822">.</span><span class="ident" id="5212823">eq</span><span class="op" id="5212825">(</span><span class="ident" id="5212826">b</span><span class="op" id="5212827">)</span>&nbsp;<span class="op" id="5212829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5212833">return</span>&nbsp;<span class="ident" id="5212840">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5212843">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212847">c</span>&nbsp;<span class="op" id="5212849">:=</span>&nbsp;<span class="ident" id="5212852">a</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212855">c</span><span class="op" id="5212856">.</span><span class="ident" id="5212857">urlPart</span>&nbsp;<span class="op" id="5212865">=</span>&nbsp;<span class="ident" id="5212867">b</span><span class="op" id="5212868">.</span><span class="ident" id="5212869">urlPart</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5212878">if</span>&nbsp;<span class="ident" id="5212881">c</span><span class="op" id="5212882">.</span><span class="ident" id="5212883">eq</span><span class="op" id="5212885">(</span><span class="ident" id="5212886">b</span><span class="op" id="5212887">)</span>&nbsp;<span class="op" id="5212889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5212893">//&nbsp;The&nbsp;contexts&nbsp;differ&nbsp;only&nbsp;by&nbsp;urlPart.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212935">c</span><span class="op" id="5212936">.</span><span class="ident" id="5212937">urlPart</span>&nbsp;<span class="op" id="5212945">=</span>&nbsp;<span class="ident" id="5212947">urlPartUnknown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5212964">return</span>&nbsp;<span class="ident" id="5212971">c</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5212974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212978">c</span>&nbsp;<span class="op" id="5212980">=</span>&nbsp;<span class="ident" id="5212982">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212985">c</span><span class="op" id="5212986">.</span><span class="ident" id="5212987">jsCtx</span>&nbsp;<span class="op" id="5212993">=</span>&nbsp;<span class="ident" id="5212995">b</span><span class="op" id="5212996">.</span><span class="ident" id="5212997">jsCtx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5213004">if</span>&nbsp;<span class="ident" id="5213007">c</span><span class="op" id="5213008">.</span><span class="ident" id="5213009">eq</span><span class="op" id="5213011">(</span><span class="ident" id="5213012">b</span><span class="op" id="5213013">)</span>&nbsp;<span class="op" id="5213015">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5213019">//&nbsp;The&nbsp;contexts&nbsp;differ&nbsp;only&nbsp;by&nbsp;jsCtx.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5213059">c</span><span class="op" id="5213060">.</span><span class="ident" id="5213061">jsCtx</span>&nbsp;<span class="op" id="5213067">=</span>&nbsp;<span class="ident" id="5213069">jsCtxUnknown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5213084">return</span>&nbsp;<span class="ident" id="5213091">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5213094">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5213098">//&nbsp;Allow&nbsp;a&nbsp;nudged&nbsp;context&nbsp;to&nbsp;join&nbsp;with&nbsp;an&nbsp;unnudged&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5213155">//&nbsp;This&nbsp;means&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5213175">//&nbsp;&nbsp;&nbsp;&lt;p&nbsp;title={{if&nbsp;.C}}{{.}}{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5213212">//&nbsp;ends&nbsp;in&nbsp;an&nbsp;unquoted&nbsp;value&nbsp;state&nbsp;even&nbsp;though&nbsp;the&nbsp;else&nbsp;branch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5213276">//&nbsp;ends&nbsp;in&nbsp;stateBeforeValue.</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5213306">if</span>&nbsp;<span class="ident" id="5213309">c</span><span class="op" id="5213310">,</span>&nbsp;<span class="ident" id="5213312">d</span>&nbsp;<span class="op" id="5213314">:=</span>&nbsp;<span class="ident" id="5213317">nudge</span><span class="op" id="5213322">(</span><span class="ident" id="5213323">a</span><span class="op" id="5213324">)</span><span class="op" id="5213325">,</span>&nbsp;<span class="ident" id="5213327">nudge</span><span class="op" id="5213332">(</span><span class="ident" id="5213333">b</span><span class="op" id="5213334">)</span><span class="op" id="5213335">;</span>&nbsp;<span class="op" id="5213337">!</span><span class="op" id="5213338">(</span><span class="ident" id="5213339">c</span><span class="op" id="5213340">.</span><span class="ident" id="5213341">eq</span><span class="op" id="5213343">(</span><span class="ident" id="5213344">a</span><span class="op" id="5213345">)</span>&nbsp;<span class="op" id="5213347">&amp;&amp;</span>&nbsp;<span class="ident" id="5213350">d</span><span class="op" id="5213351">.</span><span class="ident" id="5213352">eq</span><span class="op" id="5213354">(</span><span class="ident" id="5213355">b</span><span class="op" id="5213356">)</span><span class="op" id="5213357">)</span>&nbsp;<span class="op" id="5213359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5213363">if</span>&nbsp;<span class="ident" id="5213366">e</span>&nbsp;<span class="op" id="5213368">:=</span>&nbsp;<span class="ident" id="5213371">join</span><span class="op" id="5213375">(</span><span class="ident" id="5213376">c</span><span class="op" id="5213377">,</span>&nbsp;<span class="ident" id="5213379">d</span><span class="op" id="5213380">,</span>&nbsp;<span class="ident" id="5213382">node</span><span class="op" id="5213386">,</span>&nbsp;<span class="ident" id="5213388">nodeName</span><span class="op" id="5213396">)</span><span class="op" id="5213397">;</span>&nbsp;<span class="ident" id="5213399">e</span><span class="op" id="5213400">.</span><span class="ident" id="5213401">state</span>&nbsp;<span class="op" id="5213407">!=</span>&nbsp;<span class="ident" id="5213410">stateError</span>&nbsp;<span class="op" id="5213421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5213426">return</span>&nbsp;<span class="ident" id="5213433">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5213437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5213440">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5213444">return</span>&nbsp;<span class="ident" id="5213451">context</span><span class="op" id="5213458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5213462">state</span><span class="op" id="5213467">:</span>&nbsp;<span class="ident" id="5213469">stateError</span><span class="op" id="5213479">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5213483">err</span><span class="op" id="5213486">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5213490">errorf</span><span class="op" id="5213496">(</span><span class="ident" id="5213497">ErrBranchEnd</span><span class="op" id="5213509">,</span>&nbsp;<span class="ident" id="5213511">node</span><span class="op" id="5213515">,</span>&nbsp;<span class="num" id="5213517">0</span><span class="op" id="5213518">,</span>&nbsp;<span class="string" id="5213520">&#34;{{%s}}&nbsp;branches&nbsp;end&nbsp;in&nbsp;different&nbsp;contexts:&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="5213571">,</span>&nbsp;<span class="ident" id="5213573">nodeName</span><span class="op" id="5213581">,</span>&nbsp;<span class="ident" id="5213583">a</span><span class="op" id="5213584">,</span>&nbsp;<span class="ident" id="5213586">b</span><span class="op" id="5213587">)</span><span class="op" id="5213588">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5213591">}</span><br>
<span class="lineno">410</span><span class="op" id="5213593">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5213596">//&nbsp;escapeBranch&nbsp;escapes&nbsp;a&nbsp;branch&nbsp;template&nbsp;node:&nbsp;&#34;if&#34;,&nbsp;&#34;range&#34;&nbsp;and&nbsp;&#34;with&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="5213670">func</span>&nbsp;<span class="op" id="5213675">(</span><span class="ident" id="5213676">e</span>&nbsp;<span class="op" id="5213678">*</span><span class="ident" id="5213679">escaper</span><span class="op" id="5213686">)</span>&nbsp;<span class="ident" id="5213688">escapeBranch</span><span class="op" id="5213700">(</span><span class="ident" id="5213701">c</span>&nbsp;<span class="ident" id="5213703">context</span><span class="op" id="5213710">,</span>&nbsp;<span class="ident" id="5213712">n</span>&nbsp;<span class="op" id="5213714">*</span><span class="ident" id="5213715">parse</span><span class="op" id="5213720">.</span><span class="ident" id="5213721">BranchNode</span><span class="op" id="5213731">,</span>&nbsp;<span class="ident" id="5213733">nodeName</span>&nbsp;<span class="builtintype" id="5213742">string</span><span class="op" id="5213748">)</span>&nbsp;<span class="ident" id="5213750">context</span>&nbsp;<span class="op" id="5213758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5213761">c0</span>&nbsp;<span class="op" id="5213764">:=</span>&nbsp;<span class="ident" id="5213767">e</span><span class="op" id="5213768">.</span><span class="ident" id="5213769">escapeList</span><span class="op" id="5213779">(</span><span class="ident" id="5213780">c</span><span class="op" id="5213781">,</span>&nbsp;<span class="ident" id="5213783">n</span><span class="op" id="5213784">.</span><span class="ident" id="5213785">List</span><span class="op" id="5213789">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5213792">if</span>&nbsp;<span class="ident" id="5213795">nodeName</span>&nbsp;<span class="op" id="5213804">==</span>&nbsp;<span class="string" id="5213807">&#34;range&#34;</span>&nbsp;<span class="op" id="5213815">&amp;&amp;</span>&nbsp;<span class="ident" id="5213818">c0</span><span class="op" id="5213820">.</span><span class="ident" id="5213821">state</span>&nbsp;<span class="op" id="5213827">!=</span>&nbsp;<span class="ident" id="5213830">stateError</span>&nbsp;<span class="op" id="5213841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5213845">//&nbsp;The&nbsp;&#34;true&#34;&nbsp;branch&nbsp;of&nbsp;a&nbsp;&#34;range&#34;&nbsp;node&nbsp;can&nbsp;execute&nbsp;multiple&nbsp;times.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5213914">//&nbsp;We&nbsp;check&nbsp;that&nbsp;executing&nbsp;n.List&nbsp;once&nbsp;results&nbsp;in&nbsp;the&nbsp;same&nbsp;context</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5213983">//&nbsp;as&nbsp;executing&nbsp;n.List&nbsp;twice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5214015">c1</span><span class="op" id="5214017">,</span>&nbsp;<span class="ident" id="5214019">_</span>&nbsp;<span class="op" id="5214021">:=</span>&nbsp;<span class="ident" id="5214024">e</span><span class="op" id="5214025">.</span><span class="ident" id="5214026">escapeListConditionally</span><span class="op" id="5214049">(</span><span class="ident" id="5214050">c0</span><span class="op" id="5214052">,</span>&nbsp;<span class="ident" id="5214054">n</span><span class="op" id="5214055">.</span><span class="ident" id="5214056">List</span><span class="op" id="5214060">,</span>&nbsp;<span class="ident" id="5214062">nil</span><span class="op" id="5214065">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5214069">c0</span>&nbsp;<span class="op" id="5214072">=</span>&nbsp;<span class="ident" id="5214074">join</span><span class="op" id="5214078">(</span><span class="ident" id="5214079">c0</span><span class="op" id="5214081">,</span>&nbsp;<span class="ident" id="5214083">c1</span><span class="op" id="5214085">,</span>&nbsp;<span class="ident" id="5214087">n</span><span class="op" id="5214088">,</span>&nbsp;<span class="ident" id="5214090">nodeName</span><span class="op" id="5214098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5214102">if</span>&nbsp;<span class="ident" id="5214105">c0</span><span class="op" id="5214107">.</span><span class="ident" id="5214108">state</span>&nbsp;<span class="op" id="5214114">==</span>&nbsp;<span class="ident" id="5214117">stateError</span>&nbsp;<span class="op" id="5214128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5214133">//&nbsp;Make&nbsp;clear&nbsp;that&nbsp;this&nbsp;is&nbsp;a&nbsp;problem&nbsp;on&nbsp;loop&nbsp;re-entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5214190">//&nbsp;since&nbsp;developers&nbsp;tend&nbsp;to&nbsp;overlook&nbsp;that&nbsp;branch&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5214247">//&nbsp;debugging&nbsp;templates.</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5214274">c0</span><span class="op" id="5214276">.</span><span class="ident" id="5214277">err</span><span class="op" id="5214280">.</span><span class="ident" id="5214281">Line</span>&nbsp;<span class="op" id="5214286">=</span>&nbsp;<span class="ident" id="5214288">n</span><span class="op" id="5214289">.</span><span class="ident" id="5214290">Line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5214298">c0</span><span class="op" id="5214300">.</span><span class="ident" id="5214301">err</span><span class="op" id="5214304">.</span><span class="ident" id="5214305">Description</span>&nbsp;<span class="op" id="5214317">=</span>&nbsp;<span class="string" id="5214319">&#34;on&nbsp;range&nbsp;loop&nbsp;re-entry:&nbsp;&#34;</span>&nbsp;<span class="op" id="5214346">+</span>&nbsp;<span class="ident" id="5214348">c0</span><span class="op" id="5214350">.</span><span class="ident" id="5214351">err</span><span class="op" id="5214354">.</span><span class="ident" id="5214355">Description</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5214370">return</span>&nbsp;<span class="ident" id="5214377">c0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5214382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5214385">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5214388">c1</span>&nbsp;<span class="op" id="5214391">:=</span>&nbsp;<span class="ident" id="5214394">e</span><span class="op" id="5214395">.</span><span class="ident" id="5214396">escapeList</span><span class="op" id="5214406">(</span><span class="ident" id="5214407">c</span><span class="op" id="5214408">,</span>&nbsp;<span class="ident" id="5214410">n</span><span class="op" id="5214411">.</span><span class="ident" id="5214412">ElseList</span><span class="op" id="5214420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5214423">return</span>&nbsp;<span class="ident" id="5214430">join</span><span class="op" id="5214434">(</span><span class="ident" id="5214435">c0</span><span class="op" id="5214437">,</span>&nbsp;<span class="ident" id="5214439">c1</span><span class="op" id="5214441">,</span>&nbsp;<span class="ident" id="5214443">n</span><span class="op" id="5214444">,</span>&nbsp;<span class="ident" id="5214446">nodeName</span><span class="op" id="5214454">)</span><br>
<span class="lineno"></span><span class="op" id="5214456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5214459">//&nbsp;escapeList&nbsp;escapes&nbsp;a&nbsp;list&nbsp;template&nbsp;node.</span><br>
<span class="lineno">435</span><span class="keyword" id="5214503">func</span>&nbsp;<span class="op" id="5214508">(</span><span class="ident" id="5214509">e</span>&nbsp;<span class="op" id="5214511">*</span><span class="ident" id="5214512">escaper</span><span class="op" id="5214519">)</span>&nbsp;<span class="ident" id="5214521">escapeList</span><span class="op" id="5214531">(</span><span class="ident" id="5214532">c</span>&nbsp;<span class="ident" id="5214534">context</span><span class="op" id="5214541">,</span>&nbsp;<span class="ident" id="5214543">n</span>&nbsp;<span class="op" id="5214545">*</span><span class="ident" id="5214546">parse</span><span class="op" id="5214551">.</span><span class="ident" id="5214552">ListNode</span><span class="op" id="5214560">)</span>&nbsp;<span class="ident" id="5214562">context</span>&nbsp;<span class="op" id="5214570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5214573">if</span>&nbsp;<span class="ident" id="5214576">n</span>&nbsp;<span class="op" id="5214578">==</span>&nbsp;<span class="ident" id="5214581">nil</span>&nbsp;<span class="op" id="5214585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5214589">return</span>&nbsp;<span class="ident" id="5214596">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5214599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5214602">for</span>&nbsp;<span class="ident" id="5214606">_</span><span class="op" id="5214607">,</span>&nbsp;<span class="ident" id="5214609">m</span>&nbsp;<span class="op" id="5214611">:=</span>&nbsp;<span class="keyword" id="5214614">range</span>&nbsp;<span class="ident" id="5214620">n</span><span class="op" id="5214621">.</span><span class="ident" id="5214622">Nodes</span>&nbsp;<span class="op" id="5214628">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5214632">c</span>&nbsp;<span class="op" id="5214634">=</span>&nbsp;<span class="ident" id="5214636">e</span><span class="op" id="5214637">.</span><span class="ident" id="5214638">escape</span><span class="op" id="5214644">(</span><span class="ident" id="5214645">c</span><span class="op" id="5214646">,</span>&nbsp;<span class="ident" id="5214648">m</span><span class="op" id="5214649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5214652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5214655">return</span>&nbsp;<span class="ident" id="5214662">c</span><br>
<span class="lineno"></span><span class="op" id="5214664">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span><span class="comment" id="5214667">//&nbsp;escapeListConditionally&nbsp;escapes&nbsp;a&nbsp;list&nbsp;node&nbsp;but&nbsp;only&nbsp;preserves&nbsp;edits&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5214743">//&nbsp;inferences&nbsp;in&nbsp;e&nbsp;if&nbsp;the&nbsp;inferences&nbsp;and&nbsp;output&nbsp;context&nbsp;satisfy&nbsp;filter.</span><br>
<span class="lineno"></span><span class="comment" id="5214815">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;best&nbsp;guess&nbsp;at&nbsp;an&nbsp;output&nbsp;context,&nbsp;and&nbsp;the&nbsp;result&nbsp;of&nbsp;the&nbsp;filter</span><br>
<span class="lineno"></span><span class="comment" id="5214895">//&nbsp;which&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;whether&nbsp;e&nbsp;was&nbsp;updated.</span><br>
<span class="lineno"></span><span class="keyword" id="5214942">func</span>&nbsp;<span class="op" id="5214947">(</span><span class="ident" id="5214948">e</span>&nbsp;<span class="op" id="5214950">*</span><span class="ident" id="5214951">escaper</span><span class="op" id="5214958">)</span>&nbsp;<span class="ident" id="5214960">escapeListConditionally</span><span class="op" id="5214983">(</span><span class="ident" id="5214984">c</span>&nbsp;<span class="ident" id="5214986">context</span><span class="op" id="5214993">,</span>&nbsp;<span class="ident" id="5214995">n</span>&nbsp;<span class="op" id="5214997">*</span><span class="ident" id="5214998">parse</span><span class="op" id="5215003">.</span><span class="ident" id="5215004">ListNode</span><span class="op" id="5215012">,</span>&nbsp;<span class="ident" id="5215014">filter</span>&nbsp;<span class="keyword" id="5215021">func</span><span class="op" id="5215025">(</span><span class="op" id="5215026">*</span><span class="ident" id="5215027">escaper</span><span class="op" id="5215034">,</span>&nbsp;<span class="ident" id="5215036">context</span><span class="op" id="5215043">)</span>&nbsp;<span class="builtintype" id="5215045">bool</span><span class="op" id="5215049">)</span>&nbsp;<span class="op" id="5215051">(</span><span class="ident" id="5215052">context</span><span class="op" id="5215059">,</span>&nbsp;<span class="builtintype" id="5215061">bool</span><span class="op" id="5215065">)</span>&nbsp;<span class="op" id="5215067">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5215070">e1</span>&nbsp;<span class="op" id="5215073">:=</span>&nbsp;<span class="ident" id="5215076">newEscaper</span><span class="op" id="5215086">(</span><span class="ident" id="5215087">e</span><span class="op" id="5215088">.</span><span class="ident" id="5215089">tmpl</span><span class="op" id="5215093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5215096">//&nbsp;Make&nbsp;type&nbsp;inferences&nbsp;available&nbsp;to&nbsp;f.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5215137">for</span>&nbsp;<span class="ident" id="5215141">k</span><span class="op" id="5215142">,</span>&nbsp;<span class="ident" id="5215144">v</span>&nbsp;<span class="op" id="5215146">:=</span>&nbsp;<span class="keyword" id="5215149">range</span>&nbsp;<span class="ident" id="5215155">e</span><span class="op" id="5215156">.</span><span class="ident" id="5215157">output</span>&nbsp;<span class="op" id="5215164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5215168">e1</span><span class="op" id="5215170">.</span><span class="ident" id="5215171">output</span><span class="op" id="5215177">[</span><span class="ident" id="5215178">k</span><span class="op" id="5215179">]</span>&nbsp;<span class="op" id="5215181">=</span>&nbsp;<span class="ident" id="5215183">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5215186">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5215189">c</span>&nbsp;<span class="op" id="5215191">=</span>&nbsp;<span class="ident" id="5215193">e1</span><span class="op" id="5215195">.</span><span class="ident" id="5215196">escapeList</span><span class="op" id="5215206">(</span><span class="ident" id="5215207">c</span><span class="op" id="5215208">,</span>&nbsp;<span class="ident" id="5215210">n</span><span class="op" id="5215211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5215214">ok</span>&nbsp;<span class="op" id="5215217">:=</span>&nbsp;<span class="ident" id="5215220">filter</span>&nbsp;<span class="op" id="5215227">!=</span>&nbsp;<span class="ident" id="5215230">nil</span>&nbsp;<span class="op" id="5215234">&amp;&amp;</span>&nbsp;<span class="ident" id="5215237">filter</span><span class="op" id="5215243">(</span><span class="ident" id="5215244">e1</span><span class="op" id="5215246">,</span>&nbsp;<span class="ident" id="5215248">c</span><span class="op" id="5215249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5215252">if</span>&nbsp;<span class="ident" id="5215255">ok</span>&nbsp;<span class="op" id="5215258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5215262">//&nbsp;Copy&nbsp;inferences&nbsp;and&nbsp;edits&nbsp;from&nbsp;e1&nbsp;back&nbsp;into&nbsp;e.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5215314">for</span>&nbsp;<span class="ident" id="5215318">k</span><span class="op" id="5215319">,</span>&nbsp;<span class="ident" id="5215321">v</span>&nbsp;<span class="op" id="5215323">:=</span>&nbsp;<span class="keyword" id="5215326">range</span>&nbsp;<span class="ident" id="5215332">e1</span><span class="op" id="5215334">.</span><span class="ident" id="5215335">output</span>&nbsp;<span class="op" id="5215342">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5215347">e</span><span class="op" id="5215348">.</span><span class="ident" id="5215349">output</span><span class="op" id="5215355">[</span><span class="ident" id="5215356">k</span><span class="op" id="5215357">]</span>&nbsp;<span class="op" id="5215359">=</span>&nbsp;<span class="ident" id="5215361">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5215365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5215369">for</span>&nbsp;<span class="ident" id="5215373">k</span><span class="op" id="5215374">,</span>&nbsp;<span class="ident" id="5215376">v</span>&nbsp;<span class="op" id="5215378">:=</span>&nbsp;<span class="keyword" id="5215381">range</span>&nbsp;<span class="ident" id="5215387">e1</span><span class="op" id="5215389">.</span><span class="ident" id="5215390">derived</span>&nbsp;<span class="op" id="5215398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5215403">e</span><span class="op" id="5215404">.</span><span class="ident" id="5215405">derived</span><span class="op" id="5215412">[</span><span class="ident" id="5215413">k</span><span class="op" id="5215414">]</span>&nbsp;<span class="op" id="5215416">=</span>&nbsp;<span class="ident" id="5215418">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5215422">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5215426">for</span>&nbsp;<span class="ident" id="5215430">k</span><span class="op" id="5215431">,</span>&nbsp;<span class="ident" id="5215433">v</span>&nbsp;<span class="op" id="5215435">:=</span>&nbsp;<span class="keyword" id="5215438">range</span>&nbsp;<span class="ident" id="5215444">e1</span><span class="op" id="5215446">.</span><span class="ident" id="5215447">called</span>&nbsp;<span class="op" id="5215454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5215459">e</span><span class="op" id="5215460">.</span><span class="ident" id="5215461">called</span><span class="op" id="5215467">[</span><span class="ident" id="5215468">k</span><span class="op" id="5215469">]</span>&nbsp;<span class="op" id="5215471">=</span>&nbsp;<span class="ident" id="5215473">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5215477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5215481">for</span>&nbsp;<span class="ident" id="5215485">k</span><span class="op" id="5215486">,</span>&nbsp;<span class="ident" id="5215488">v</span>&nbsp;<span class="op" id="5215490">:=</span>&nbsp;<span class="keyword" id="5215493">range</span>&nbsp;<span class="ident" id="5215499">e1</span><span class="op" id="5215501">.</span><span class="ident" id="5215502">actionNodeEdits</span>&nbsp;<span class="op" id="5215518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5215523">e</span><span class="op" id="5215524">.</span><span class="ident" id="5215525">editActionNode</span><span class="op" id="5215539">(</span><span class="ident" id="5215540">k</span><span class="op" id="5215541">,</span>&nbsp;<span class="ident" id="5215543">v</span><span class="op" id="5215544">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5215548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5215552">for</span>&nbsp;<span class="ident" id="5215556">k</span><span class="op" id="5215557">,</span>&nbsp;<span class="ident" id="5215559">v</span>&nbsp;<span class="op" id="5215561">:=</span>&nbsp;<span class="keyword" id="5215564">range</span>&nbsp;<span class="ident" id="5215570">e1</span><span class="op" id="5215572">.</span><span class="ident" id="5215573">templateNodeEdits</span>&nbsp;<span class="op" id="5215591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5215596">e</span><span class="op" id="5215597">.</span><span class="ident" id="5215598">editTemplateNode</span><span class="op" id="5215614">(</span><span class="ident" id="5215615">k</span><span class="op" id="5215616">,</span>&nbsp;<span class="ident" id="5215618">v</span><span class="op" id="5215619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5215623">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5215627">for</span>&nbsp;<span class="ident" id="5215631">k</span><span class="op" id="5215632">,</span>&nbsp;<span class="ident" id="5215634">v</span>&nbsp;<span class="op" id="5215636">:=</span>&nbsp;<span class="keyword" id="5215639">range</span>&nbsp;<span class="ident" id="5215645">e1</span><span class="op" id="5215647">.</span><span class="ident" id="5215648">textNodeEdits</span>&nbsp;<span class="op" id="5215662">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5215667">e</span><span class="op" id="5215668">.</span><span class="ident" id="5215669">editTextNode</span><span class="op" id="5215681">(</span><span class="ident" id="5215682">k</span><span class="op" id="5215683">,</span>&nbsp;<span class="ident" id="5215685">v</span><span class="op" id="5215686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5215690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5215693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5215696">return</span>&nbsp;<span class="ident" id="5215703">c</span><span class="op" id="5215704">,</span>&nbsp;<span class="ident" id="5215706">ok</span><br>
<span class="lineno"></span><span class="op" id="5215709">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="5215712">//&nbsp;escapeTemplate&nbsp;escapes&nbsp;a&nbsp;{{template}}&nbsp;call&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="5215764">func</span>&nbsp;<span class="op" id="5215769">(</span><span class="ident" id="5215770">e</span>&nbsp;<span class="op" id="5215772">*</span><span class="ident" id="5215773">escaper</span><span class="op" id="5215780">)</span>&nbsp;<span class="ident" id="5215782">escapeTemplate</span><span class="op" id="5215796">(</span><span class="ident" id="5215797">c</span>&nbsp;<span class="ident" id="5215799">context</span><span class="op" id="5215806">,</span>&nbsp;<span class="ident" id="5215808">n</span>&nbsp;<span class="op" id="5215810">*</span><span class="ident" id="5215811">parse</span><span class="op" id="5215816">.</span><span class="ident" id="5215817">TemplateNode</span><span class="op" id="5215829">)</span>&nbsp;<span class="ident" id="5215831">context</span>&nbsp;<span class="op" id="5215839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5215842">c</span><span class="op" id="5215843">,</span>&nbsp;<span class="ident" id="5215845">name</span>&nbsp;<span class="op" id="5215850">:=</span>&nbsp;<span class="ident" id="5215853">e</span><span class="op" id="5215854">.</span><span class="ident" id="5215855">escapeTree</span><span class="op" id="5215865">(</span><span class="ident" id="5215866">c</span><span class="op" id="5215867">,</span>&nbsp;<span class="ident" id="5215869">n</span><span class="op" id="5215870">,</span>&nbsp;<span class="ident" id="5215872">n</span><span class="op" id="5215873">.</span><span class="ident" id="5215874">Name</span><span class="op" id="5215878">,</span>&nbsp;<span class="ident" id="5215880">n</span><span class="op" id="5215881">.</span><span class="ident" id="5215882">Line</span><span class="op" id="5215886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5215889">if</span>&nbsp;<span class="ident" id="5215892">name</span>&nbsp;<span class="op" id="5215897">!=</span>&nbsp;<span class="ident" id="5215900">n</span><span class="op" id="5215901">.</span><span class="ident" id="5215902">Name</span>&nbsp;<span class="op" id="5215907">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5215911">e</span><span class="op" id="5215912">.</span><span class="ident" id="5215913">editTemplateNode</span><span class="op" id="5215929">(</span><span class="ident" id="5215930">n</span><span class="op" id="5215931">,</span>&nbsp;<span class="ident" id="5215933">name</span><span class="op" id="5215937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5215940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5215943">return</span>&nbsp;<span class="ident" id="5215950">c</span><br>
<span class="lineno"></span><span class="op" id="5215952">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span><span class="comment" id="5215955">//&nbsp;escapeTree&nbsp;escapes&nbsp;the&nbsp;named&nbsp;template&nbsp;starting&nbsp;in&nbsp;the&nbsp;given&nbsp;context&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="5216029">//&nbsp;necessary&nbsp;and&nbsp;returns&nbsp;its&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span><span class="keyword" id="5216074">func</span>&nbsp;<span class="op" id="5216079">(</span><span class="ident" id="5216080">e</span>&nbsp;<span class="op" id="5216082">*</span><span class="ident" id="5216083">escaper</span><span class="op" id="5216090">)</span>&nbsp;<span class="ident" id="5216092">escapeTree</span><span class="op" id="5216102">(</span><span class="ident" id="5216103">c</span>&nbsp;<span class="ident" id="5216105">context</span><span class="op" id="5216112">,</span>&nbsp;<span class="ident" id="5216114">node</span>&nbsp;<span class="ident" id="5216119">parse</span><span class="op" id="5216124">.</span><span class="ident" id="5216125">Node</span><span class="op" id="5216129">,</span>&nbsp;<span class="ident" id="5216131">name</span>&nbsp;<span class="builtintype" id="5216136">string</span><span class="op" id="5216142">,</span>&nbsp;<span class="ident" id="5216144">line</span>&nbsp;<span class="builtintype" id="5216149">int</span><span class="op" id="5216152">)</span>&nbsp;<span class="op" id="5216154">(</span><span class="ident" id="5216155">context</span><span class="op" id="5216162">,</span>&nbsp;<span class="builtintype" id="5216164">string</span><span class="op" id="5216170">)</span>&nbsp;<span class="op" id="5216172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5216175">//&nbsp;Mangle&nbsp;the&nbsp;template&nbsp;name&nbsp;with&nbsp;the&nbsp;input&nbsp;context&nbsp;to&nbsp;produce&nbsp;a&nbsp;reliable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5216249">//&nbsp;identifier.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5216265">dname</span>&nbsp;<span class="op" id="5216271">:=</span>&nbsp;<span class="ident" id="5216274">c</span><span class="op" id="5216275">.</span><span class="ident" id="5216276">mangle</span><span class="op" id="5216282">(</span><span class="ident" id="5216283">name</span><span class="op" id="5216287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5216290">e</span><span class="op" id="5216291">.</span><span class="ident" id="5216292">called</span><span class="op" id="5216298">[</span><span class="ident" id="5216299">dname</span><span class="op" id="5216304">]</span>&nbsp;<span class="op" id="5216306">=</span>&nbsp;<span class="builtintype" id="5216308">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5216314">if</span>&nbsp;<span class="ident" id="5216317">out</span><span class="op" id="5216320">,</span>&nbsp;<span class="ident" id="5216322">ok</span>&nbsp;<span class="op" id="5216325">:=</span>&nbsp;<span class="ident" id="5216328">e</span><span class="op" id="5216329">.</span><span class="ident" id="5216330">output</span><span class="op" id="5216336">[</span><span class="ident" id="5216337">dname</span><span class="op" id="5216342">]</span><span class="op" id="5216343">;</span>&nbsp;<span class="ident" id="5216345">ok</span>&nbsp;<span class="op" id="5216348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5216352">//&nbsp;Already&nbsp;escaped.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5216374">return</span>&nbsp;<span class="ident" id="5216381">out</span><span class="op" id="5216384">,</span>&nbsp;<span class="ident" id="5216386">dname</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5216393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5216396">t</span>&nbsp;<span class="op" id="5216398">:=</span>&nbsp;<span class="ident" id="5216401">e</span><span class="op" id="5216402">.</span><span class="ident" id="5216403">template</span><span class="op" id="5216411">(</span><span class="ident" id="5216412">name</span><span class="op" id="5216416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5216419">if</span>&nbsp;<span class="ident" id="5216422">t</span>&nbsp;<span class="op" id="5216424">==</span>&nbsp;<span class="ident" id="5216427">nil</span>&nbsp;<span class="op" id="5216431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5216435">//&nbsp;Two&nbsp;cases:&nbsp;The&nbsp;template&nbsp;exists&nbsp;but&nbsp;is&nbsp;empty,&nbsp;or&nbsp;has&nbsp;never&nbsp;been&nbsp;mentioned&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5216516">//&nbsp;all.&nbsp;Distinguish&nbsp;the&nbsp;cases&nbsp;in&nbsp;the&nbsp;error&nbsp;messages.</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5216571">if</span>&nbsp;<span class="ident" id="5216574">e</span><span class="op" id="5216575">.</span><span class="ident" id="5216576">tmpl</span><span class="op" id="5216580">.</span><span class="ident" id="5216581">set</span><span class="op" id="5216584">[</span><span class="ident" id="5216585">name</span><span class="op" id="5216589">]</span>&nbsp;<span class="op" id="5216591">!=</span>&nbsp;<span class="ident" id="5216594">nil</span>&nbsp;<span class="op" id="5216598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5216603">return</span>&nbsp;<span class="ident" id="5216610">context</span><span class="op" id="5216617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5216623">state</span><span class="op" id="5216628">:</span>&nbsp;<span class="ident" id="5216630">stateError</span><span class="op" id="5216640">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5216646">err</span><span class="op" id="5216649">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5216653">errorf</span><span class="op" id="5216659">(</span><span class="ident" id="5216660">ErrNoSuchTemplate</span><span class="op" id="5216677">,</span>&nbsp;<span class="ident" id="5216679">node</span><span class="op" id="5216683">,</span>&nbsp;<span class="ident" id="5216685">line</span><span class="op" id="5216689">,</span>&nbsp;<span class="string" id="5216691">&#34;%q&nbsp;is&nbsp;an&nbsp;incomplete&nbsp;or&nbsp;empty&nbsp;template&#34;</span><span class="op" id="5216730">,</span>&nbsp;<span class="ident" id="5216732">name</span><span class="op" id="5216736">)</span><span class="op" id="5216737">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5216742">}</span><span class="op" id="5216743">,</span>&nbsp;<span class="ident" id="5216745">dname</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5216753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5216757">return</span>&nbsp;<span class="ident" id="5216764">context</span><span class="op" id="5216771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5216776">state</span><span class="op" id="5216781">:</span>&nbsp;<span class="ident" id="5216783">stateError</span><span class="op" id="5216793">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5216798">err</span><span class="op" id="5216801">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5216805">errorf</span><span class="op" id="5216811">(</span><span class="ident" id="5216812">ErrNoSuchTemplate</span><span class="op" id="5216829">,</span>&nbsp;<span class="ident" id="5216831">node</span><span class="op" id="5216835">,</span>&nbsp;<span class="ident" id="5216837">line</span><span class="op" id="5216841">,</span>&nbsp;<span class="string" id="5216843">&#34;no&nbsp;such&nbsp;template&nbsp;%q&#34;</span><span class="op" id="5216864">,</span>&nbsp;<span class="ident" id="5216866">name</span><span class="op" id="5216870">)</span><span class="op" id="5216871">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5216875">}</span><span class="op" id="5216876">,</span>&nbsp;<span class="ident" id="5216878">dname</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5216885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5216888">if</span>&nbsp;<span class="ident" id="5216891">dname</span>&nbsp;<span class="op" id="5216897">!=</span>&nbsp;<span class="ident" id="5216900">name</span>&nbsp;<span class="op" id="5216905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5216909">//&nbsp;Use&nbsp;any&nbsp;template&nbsp;derived&nbsp;during&nbsp;an&nbsp;earlier&nbsp;call&nbsp;to&nbsp;escapeTemplate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5216980">//&nbsp;with&nbsp;different&nbsp;top&nbsp;level&nbsp;templates,&nbsp;or&nbsp;clone&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217044">dt</span>&nbsp;<span class="op" id="5217047">:=</span>&nbsp;<span class="ident" id="5217050">e</span><span class="op" id="5217051">.</span><span class="ident" id="5217052">template</span><span class="op" id="5217060">(</span><span class="ident" id="5217061">dname</span><span class="op" id="5217066">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5217070">if</span>&nbsp;<span class="ident" id="5217073">dt</span>&nbsp;<span class="op" id="5217076">==</span>&nbsp;<span class="ident" id="5217079">nil</span>&nbsp;<span class="op" id="5217083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217088">dt</span>&nbsp;<span class="op" id="5217091">=</span>&nbsp;<span class="ident" id="5217093">template</span><span class="op" id="5217101">.</span><span class="ident" id="5217102">New</span><span class="op" id="5217105">(</span><span class="ident" id="5217106">dname</span><span class="op" id="5217111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217116">dt</span><span class="op" id="5217118">.</span><span class="ident" id="5217119">Tree</span>&nbsp;<span class="op" id="5217124">=</span>&nbsp;<span class="op" id="5217126">&amp;</span><span class="ident" id="5217127">parse</span><span class="op" id="5217132">.</span><span class="ident" id="5217133">Tree</span><span class="op" id="5217137">{</span><span class="ident" id="5217138">Name</span><span class="op" id="5217142">:</span>&nbsp;<span class="ident" id="5217144">dname</span><span class="op" id="5217149">,</span>&nbsp;<span class="ident" id="5217151">Root</span><span class="op" id="5217155">:</span>&nbsp;<span class="ident" id="5217157">t</span><span class="op" id="5217158">.</span><span class="ident" id="5217159">Root</span><span class="op" id="5217163">.</span><span class="ident" id="5217164">CopyList</span><span class="op" id="5217172">(</span><span class="op" id="5217173">)</span><span class="op" id="5217174">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217179">e</span><span class="op" id="5217180">.</span><span class="ident" id="5217181">derived</span><span class="op" id="5217188">[</span><span class="ident" id="5217189">dname</span><span class="op" id="5217194">]</span>&nbsp;<span class="op" id="5217196">=</span>&nbsp;<span class="ident" id="5217198">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5217203">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217207">t</span>&nbsp;<span class="op" id="5217209">=</span>&nbsp;<span class="ident" id="5217211">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5217215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5217218">return</span>&nbsp;<span class="ident" id="5217225">e</span><span class="op" id="5217226">.</span><span class="ident" id="5217227">computeOutCtx</span><span class="op" id="5217240">(</span><span class="ident" id="5217241">c</span><span class="op" id="5217242">,</span>&nbsp;<span class="ident" id="5217244">t</span><span class="op" id="5217245">)</span><span class="op" id="5217246">,</span>&nbsp;<span class="ident" id="5217248">dname</span><br>
<span class="lineno"></span><span class="op" id="5217254">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">530</span><span class="comment" id="5217257">//&nbsp;computeOutCtx&nbsp;takes&nbsp;a&nbsp;template&nbsp;and&nbsp;its&nbsp;start&nbsp;context&nbsp;and&nbsp;computes&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="5217337">//&nbsp;context&nbsp;while&nbsp;storing&nbsp;any&nbsp;inferences&nbsp;in&nbsp;e.</span><br>
<span class="lineno"></span><span class="keyword" id="5217383">func</span>&nbsp;<span class="op" id="5217388">(</span><span class="ident" id="5217389">e</span>&nbsp;<span class="op" id="5217391">*</span><span class="ident" id="5217392">escaper</span><span class="op" id="5217399">)</span>&nbsp;<span class="ident" id="5217401">computeOutCtx</span><span class="op" id="5217414">(</span><span class="ident" id="5217415">c</span>&nbsp;<span class="ident" id="5217417">context</span><span class="op" id="5217424">,</span>&nbsp;<span class="ident" id="5217426">t</span>&nbsp;<span class="op" id="5217428">*</span><span class="ident" id="5217429">template</span><span class="op" id="5217437">.</span><span class="ident" id="5217438">Template</span><span class="op" id="5217446">)</span>&nbsp;<span class="ident" id="5217448">context</span>&nbsp;<span class="op" id="5217456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5217459">//&nbsp;Propagate&nbsp;context&nbsp;over&nbsp;the&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217496">c1</span><span class="op" id="5217498">,</span>&nbsp;<span class="ident" id="5217500">ok</span>&nbsp;<span class="op" id="5217503">:=</span>&nbsp;<span class="ident" id="5217506">e</span><span class="op" id="5217507">.</span><span class="ident" id="5217508">escapeTemplateBody</span><span class="op" id="5217526">(</span><span class="ident" id="5217527">c</span><span class="op" id="5217528">,</span>&nbsp;<span class="ident" id="5217530">t</span><span class="op" id="5217531">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5217534">if</span>&nbsp;<span class="op" id="5217537">!</span><span class="ident" id="5217538">ok</span>&nbsp;<span class="op" id="5217541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5217545">//&nbsp;Look&nbsp;for&nbsp;a&nbsp;fixed&nbsp;point&nbsp;by&nbsp;assuming&nbsp;c1&nbsp;as&nbsp;the&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5217611">if</span>&nbsp;<span class="ident" id="5217614">c2</span><span class="op" id="5217616">,</span>&nbsp;<span class="ident" id="5217618">ok2</span>&nbsp;<span class="op" id="5217622">:=</span>&nbsp;<span class="ident" id="5217625">e</span><span class="op" id="5217626">.</span><span class="ident" id="5217627">escapeTemplateBody</span><span class="op" id="5217645">(</span><span class="ident" id="5217646">c1</span><span class="op" id="5217648">,</span>&nbsp;<span class="ident" id="5217650">t</span><span class="op" id="5217651">)</span><span class="op" id="5217652">;</span>&nbsp;<span class="ident" id="5217654">ok2</span>&nbsp;<span class="op" id="5217658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217663">c1</span><span class="op" id="5217665">,</span>&nbsp;<span class="ident" id="5217667">ok</span>&nbsp;<span class="op" id="5217670">=</span>&nbsp;<span class="ident" id="5217672">c2</span><span class="op" id="5217674">,</span>&nbsp;<span class="builtintype" id="5217676">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5217683">}</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5217687">//&nbsp;Use&nbsp;c1&nbsp;as&nbsp;the&nbsp;error&nbsp;context&nbsp;if&nbsp;neither&nbsp;assumption&nbsp;worked.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5217749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5217752">if</span>&nbsp;<span class="op" id="5217755">!</span><span class="ident" id="5217756">ok</span>&nbsp;<span class="op" id="5217759">&amp;&amp;</span>&nbsp;<span class="ident" id="5217762">c1</span><span class="op" id="5217764">.</span><span class="ident" id="5217765">state</span>&nbsp;<span class="op" id="5217771">!=</span>&nbsp;<span class="ident" id="5217774">stateError</span>&nbsp;<span class="op" id="5217785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5217789">return</span>&nbsp;<span class="ident" id="5217796">context</span><span class="op" id="5217803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217808">state</span><span class="op" id="5217813">:</span>&nbsp;<span class="ident" id="5217815">stateError</span><span class="op" id="5217825">,</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217830">err</span><span class="op" id="5217833">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5217837">errorf</span><span class="op" id="5217843">(</span><span class="ident" id="5217844">ErrOutputContext</span><span class="op" id="5217860">,</span>&nbsp;<span class="ident" id="5217862">t</span><span class="op" id="5217863">.</span><span class="ident" id="5217864">Tree</span><span class="op" id="5217868">.</span><span class="ident" id="5217869">Root</span><span class="op" id="5217873">,</span>&nbsp;<span class="num" id="5217875">0</span><span class="op" id="5217876">,</span>&nbsp;<span class="string" id="5217878">&#34;cannot&nbsp;compute&nbsp;output&nbsp;context&nbsp;for&nbsp;template&nbsp;%s&#34;</span><span class="op" id="5217925">,</span>&nbsp;<span class="ident" id="5217927">t</span><span class="op" id="5217928">.</span><span class="ident" id="5217929">Name</span><span class="op" id="5217933">(</span><span class="op" id="5217934">)</span><span class="op" id="5217935">)</span><span class="op" id="5217936">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5217940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5217943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5217946">return</span>&nbsp;<span class="ident" id="5217953">c1</span><br>
<span class="lineno"></span><span class="op" id="5217956">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="comment" id="5217959">//&nbsp;escapeTemplateBody&nbsp;escapes&nbsp;the&nbsp;given&nbsp;template&nbsp;assuming&nbsp;the&nbsp;given&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="5218034">//&nbsp;context,&nbsp;and&nbsp;returns&nbsp;the&nbsp;best&nbsp;guess&nbsp;at&nbsp;the&nbsp;output&nbsp;context&nbsp;and&nbsp;whether&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5218111">//&nbsp;assumption&nbsp;was&nbsp;correct.</span><br>
<span class="lineno"></span><span class="keyword" id="5218138">func</span>&nbsp;<span class="op" id="5218143">(</span><span class="ident" id="5218144">e</span>&nbsp;<span class="op" id="5218146">*</span><span class="ident" id="5218147">escaper</span><span class="op" id="5218154">)</span>&nbsp;<span class="ident" id="5218156">escapeTemplateBody</span><span class="op" id="5218174">(</span><span class="ident" id="5218175">c</span>&nbsp;<span class="ident" id="5218177">context</span><span class="op" id="5218184">,</span>&nbsp;<span class="ident" id="5218186">t</span>&nbsp;<span class="op" id="5218188">*</span><span class="ident" id="5218189">template</span><span class="op" id="5218197">.</span><span class="ident" id="5218198">Template</span><span class="op" id="5218206">)</span>&nbsp;<span class="op" id="5218208">(</span><span class="ident" id="5218209">context</span><span class="op" id="5218216">,</span>&nbsp;<span class="builtintype" id="5218218">bool</span><span class="op" id="5218222">)</span>&nbsp;<span class="op" id="5218224">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5218227">filter</span>&nbsp;<span class="op" id="5218234">:=</span>&nbsp;<span class="keyword" id="5218237">func</span><span class="op" id="5218241">(</span><span class="ident" id="5218242">e1</span>&nbsp;<span class="op" id="5218245">*</span><span class="ident" id="5218246">escaper</span><span class="op" id="5218253">,</span>&nbsp;<span class="ident" id="5218255">c1</span>&nbsp;<span class="ident" id="5218258">context</span><span class="op" id="5218265">)</span>&nbsp;<span class="builtintype" id="5218267">bool</span>&nbsp;<span class="op" id="5218272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218276">if</span>&nbsp;<span class="ident" id="5218279">c1</span><span class="op" id="5218281">.</span><span class="ident" id="5218282">state</span>&nbsp;<span class="op" id="5218288">==</span>&nbsp;<span class="ident" id="5218291">stateError</span>&nbsp;<span class="op" id="5218302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5218307">//&nbsp;Do&nbsp;not&nbsp;update&nbsp;the&nbsp;input&nbsp;escaper,&nbsp;e.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218349">return</span>&nbsp;<span class="builtintype" id="5218356">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5218364">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218368">if</span>&nbsp;<span class="op" id="5218371">!</span><span class="ident" id="5218372">e1</span><span class="op" id="5218374">.</span><span class="ident" id="5218375">called</span><span class="op" id="5218381">[</span><span class="ident" id="5218382">t</span><span class="op" id="5218383">.</span><span class="ident" id="5218384">Name</span><span class="op" id="5218388">(</span><span class="op" id="5218389">)</span><span class="op" id="5218390">]</span>&nbsp;<span class="op" id="5218392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5218397">//&nbsp;If&nbsp;t&nbsp;is&nbsp;not&nbsp;recursively&nbsp;called,&nbsp;then&nbsp;c1&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5218449">//&nbsp;accurate&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218480">return</span>&nbsp;<span class="builtintype" id="5218487">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5218494">}</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5218498">//&nbsp;c1&nbsp;is&nbsp;accurate&nbsp;if&nbsp;it&nbsp;matches&nbsp;our&nbsp;assumed&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218560">return</span>&nbsp;<span class="ident" id="5218567">c</span><span class="op" id="5218568">.</span><span class="ident" id="5218569">eq</span><span class="op" id="5218571">(</span><span class="ident" id="5218572">c1</span><span class="op" id="5218574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5218577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5218580">//&nbsp;We&nbsp;need&nbsp;to&nbsp;assume&nbsp;an&nbsp;output&nbsp;context&nbsp;so&nbsp;that&nbsp;recursive&nbsp;template&nbsp;calls</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5218653">//&nbsp;take&nbsp;the&nbsp;fast&nbsp;path&nbsp;out&nbsp;of&nbsp;escapeTree&nbsp;instead&nbsp;of&nbsp;infinitely&nbsp;recursing.</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5218727">//&nbsp;Naively&nbsp;assuming&nbsp;that&nbsp;the&nbsp;input&nbsp;context&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5218797">//&nbsp;works&nbsp;&gt;90%&nbsp;of&nbsp;the&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5218825">e</span><span class="op" id="5218826">.</span><span class="ident" id="5218827">output</span><span class="op" id="5218833">[</span><span class="ident" id="5218834">t</span><span class="op" id="5218835">.</span><span class="ident" id="5218836">Name</span><span class="op" id="5218840">(</span><span class="op" id="5218841">)</span><span class="op" id="5218842">]</span>&nbsp;<span class="op" id="5218844">=</span>&nbsp;<span class="ident" id="5218846">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218849">return</span>&nbsp;<span class="ident" id="5218856">e</span><span class="op" id="5218857">.</span><span class="ident" id="5218858">escapeListConditionally</span><span class="op" id="5218881">(</span><span class="ident" id="5218882">c</span><span class="op" id="5218883">,</span>&nbsp;<span class="ident" id="5218885">t</span><span class="op" id="5218886">.</span><span class="ident" id="5218887">Tree</span><span class="op" id="5218891">.</span><span class="ident" id="5218892">Root</span><span class="op" id="5218896">,</span>&nbsp;<span class="ident" id="5218898">filter</span><span class="op" id="5218904">)</span><br>
<span class="lineno"></span><span class="op" id="5218906">}</span><br>
<span class="lineno">575</span><br>
<span class="lineno"></span><span class="comment" id="5218909">//&nbsp;delimEnds&nbsp;maps&nbsp;each&nbsp;delim&nbsp;to&nbsp;a&nbsp;string&nbsp;of&nbsp;characters&nbsp;that&nbsp;terminate&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="5218983">var</span>&nbsp;<span class="ident" id="5218987">delimEnds</span>&nbsp;<span class="op" id="5218997">=</span>&nbsp;<span class="op" id="5218999">[</span><span class="op" id="5219000">...</span><span class="op" id="5219003">]</span><span class="builtintype" id="5219004">string</span><span class="op" id="5219010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5219013">delimDoubleQuote</span><span class="op" id="5219029">:</span>&nbsp;<span class="string" id="5219031">`&#34;`</span><span class="op" id="5219034">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5219037">delimSingleQuote</span><span class="op" id="5219053">:</span>&nbsp;<span class="string" id="5219055">&#34;&#39;&#34;</span><span class="op" id="5219058">,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5219061">//&nbsp;Determined&nbsp;empirically&nbsp;by&nbsp;running&nbsp;the&nbsp;below&nbsp;in&nbsp;various&nbsp;browsers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5219130">//&nbsp;var&nbsp;div&nbsp;=&nbsp;document.createElement(&#34;DIV&#34;);</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5219175">//&nbsp;for&nbsp;(var&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;0x10000;&nbsp;++i)&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5219215">//&nbsp;&nbsp;&nbsp;div.innerHTML&nbsp;=&nbsp;&#34;&lt;span&nbsp;title=x&#34;&nbsp;+&nbsp;String.fromCharCode(i)&nbsp;+&nbsp;&#34;-bar&gt;&#34;;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5219289">//&nbsp;&nbsp;&nbsp;if&nbsp;(div.getElementsByTagName(&#34;SPAN&#34;)[0].title.indexOf(&#34;bar&#34;)&nbsp;&lt;&nbsp;0)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5219361">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;document.write(&#34;&lt;p&gt;U+&#34;&nbsp;+&nbsp;i.toString(16));</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5219411">//&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5219417">delimSpaceOrTagEnd</span><span class="op" id="5219435">:</span>&nbsp;<span class="string" id="5219437">&#34;&nbsp;\t\n\f\r&gt;&#34;</span><span class="op" id="5219449">,</span><br>
<span class="lineno"></span><span class="op" id="5219451">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span><span class="keyword" id="5219454">var</span>&nbsp;<span class="ident" id="5219458">doctypeBytes</span>&nbsp;<span class="op" id="5219471">=</span>&nbsp;<span class="op" id="5219473">[</span><span class="op" id="5219474">]</span><span class="builtintype" id="5219475">byte</span><span class="op" id="5219479">(</span><span class="string" id="5219480">&#34;&lt;!DOCTYPE&#34;</span><span class="op" id="5219491">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5219494">//&nbsp;escapeText&nbsp;escapes&nbsp;a&nbsp;text&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="5219538">func</span>&nbsp;<span class="op" id="5219543">(</span><span class="ident" id="5219544">e</span>&nbsp;<span class="op" id="5219546">*</span><span class="ident" id="5219547">escaper</span><span class="op" id="5219554">)</span>&nbsp;<span class="ident" id="5219556">escapeText</span><span class="op" id="5219566">(</span><span class="ident" id="5219567">c</span>&nbsp;<span class="ident" id="5219569">context</span><span class="op" id="5219576">,</span>&nbsp;<span class="ident" id="5219578">n</span>&nbsp;<span class="op" id="5219580">*</span><span class="ident" id="5219581">parse</span><span class="op" id="5219586">.</span><span class="ident" id="5219587">TextNode</span><span class="op" id="5219595">)</span>&nbsp;<span class="ident" id="5219597">context</span>&nbsp;<span class="op" id="5219605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5219608">s</span><span class="op" id="5219609">,</span>&nbsp;<span class="ident" id="5219611">written</span><span class="op" id="5219618">,</span>&nbsp;<span class="ident" id="5219620">i</span><span class="op" id="5219621">,</span>&nbsp;<span class="ident" id="5219623">b</span>&nbsp;<span class="op" id="5219625">:=</span>&nbsp;<span class="ident" id="5219628">n</span><span class="op" id="5219629">.</span><span class="ident" id="5219630">Text</span><span class="op" id="5219634">,</span>&nbsp;<span class="num" id="5219636">0</span><span class="op" id="5219637">,</span>&nbsp;<span class="num" id="5219639">0</span><span class="op" id="5219640">,</span>&nbsp;<span class="builtinfunc" id="5219642">new</span><span class="op" id="5219645">(</span><span class="ident" id="5219646">bytes</span><span class="op" id="5219651">.</span><span class="ident" id="5219652">Buffer</span><span class="op" id="5219658">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5219661">for</span>&nbsp;<span class="ident" id="5219665">i</span>&nbsp;<span class="op" id="5219667">!=</span>&nbsp;<span class="builtinfunc" id="5219670">len</span><span class="op" id="5219673">(</span><span class="ident" id="5219674">s</span><span class="op" id="5219675">)</span>&nbsp;<span class="op" id="5219677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5219681">c1</span><span class="op" id="5219683">,</span>&nbsp;<span class="ident" id="5219685">nread</span>&nbsp;<span class="op" id="5219691">:=</span>&nbsp;<span class="ident" id="5219694">contextAfterText</span><span class="op" id="5219710">(</span><span class="ident" id="5219711">c</span><span class="op" id="5219712">,</span>&nbsp;<span class="ident" id="5219714">s</span><span class="op" id="5219715">[</span><span class="ident" id="5219716">i</span><span class="op" id="5219717">:</span><span class="op" id="5219718">]</span><span class="op" id="5219719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5219723">i1</span>&nbsp;<span class="op" id="5219726">:=</span>&nbsp;<span class="ident" id="5219729">i</span>&nbsp;<span class="op" id="5219731">+</span>&nbsp;<span class="ident" id="5219733">nread</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5219741">if</span>&nbsp;<span class="ident" id="5219744">c</span><span class="op" id="5219745">.</span><span class="ident" id="5219746">state</span>&nbsp;<span class="op" id="5219752">==</span>&nbsp;<span class="ident" id="5219755">stateText</span>&nbsp;<span class="op" id="5219765">||</span>&nbsp;<span class="ident" id="5219768">c</span><span class="op" id="5219769">.</span><span class="ident" id="5219770">state</span>&nbsp;<span class="op" id="5219776">==</span>&nbsp;<span class="ident" id="5219779">stateRCDATA</span>&nbsp;<span class="op" id="5219791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5219796">end</span>&nbsp;<span class="op" id="5219800">:=</span>&nbsp;<span class="ident" id="5219803">i1</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5219809">if</span>&nbsp;<span class="ident" id="5219812">c1</span><span class="op" id="5219814">.</span><span class="ident" id="5219815">state</span>&nbsp;<span class="op" id="5219821">!=</span>&nbsp;<span class="ident" id="5219824">c</span><span class="op" id="5219825">.</span><span class="ident" id="5219826">state</span>&nbsp;<span class="op" id="5219832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5219838">for</span>&nbsp;<span class="ident" id="5219842">j</span>&nbsp;<span class="op" id="5219844">:=</span>&nbsp;<span class="ident" id="5219847">end</span>&nbsp;<span class="op" id="5219851">-</span>&nbsp;<span class="num" id="5219853">1</span><span class="op" id="5219854">;</span>&nbsp;<span class="ident" id="5219856">j</span>&nbsp;<span class="op" id="5219858">&gt;=</span>&nbsp;<span class="ident" id="5219861">i</span><span class="op" id="5219862">;</span>&nbsp;<span class="ident" id="5219864">j</span><span class="op" id="5219865">--</span>&nbsp;<span class="op" id="5219868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5219875">if</span>&nbsp;<span class="ident" id="5219878">s</span><span class="op" id="5219879">[</span><span class="ident" id="5219880">j</span><span class="op" id="5219881">]</span>&nbsp;<span class="op" id="5219883">==</span>&nbsp;<span class="string" id="5219886">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="5219890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5219898">end</span>&nbsp;<span class="op" id="5219902">=</span>&nbsp;<span class="ident" id="5219904">j</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5219912">break</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5219923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5219929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5219934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5219939">for</span>&nbsp;<span class="ident" id="5219943">j</span>&nbsp;<span class="op" id="5219945">:=</span>&nbsp;<span class="ident" id="5219948">i</span><span class="op" id="5219949">;</span>&nbsp;<span class="ident" id="5219951">j</span>&nbsp;<span class="op" id="5219953">&lt;</span>&nbsp;<span class="ident" id="5219955">end</span><span class="op" id="5219958">;</span>&nbsp;<span class="ident" id="5219960">j</span><span class="op" id="5219961">++</span>&nbsp;<span class="op" id="5219964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5219970">if</span>&nbsp;<span class="ident" id="5219973">s</span><span class="op" id="5219974">[</span><span class="ident" id="5219975">j</span><span class="op" id="5219976">]</span>&nbsp;<span class="op" id="5219978">==</span>&nbsp;<span class="string" id="5219981">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="5219985">&amp;&amp;</span>&nbsp;<span class="op" id="5219988">!</span><span class="ident" id="5219989">bytes</span><span class="op" id="5219994">.</span><span class="ident" id="5219995">HasPrefix</span><span class="op" id="5220004">(</span><span class="ident" id="5220005">bytes</span><span class="op" id="5220010">.</span><span class="ident" id="5220011">ToUpper</span><span class="op" id="5220018">(</span><span class="ident" id="5220019">s</span><span class="op" id="5220020">[</span><span class="ident" id="5220021">j</span><span class="op" id="5220022">:</span><span class="op" id="5220023">]</span><span class="op" id="5220024">)</span><span class="op" id="5220025">,</span>&nbsp;<span class="ident" id="5220027">doctypeBytes</span><span class="op" id="5220039">)</span>&nbsp;<span class="op" id="5220041">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5220048">b</span><span class="op" id="5220049">.</span><span class="ident" id="5220050">Write</span><span class="op" id="5220055">(</span><span class="ident" id="5220056">s</span><span class="op" id="5220057">[</span><span class="ident" id="5220058">written</span><span class="op" id="5220065">:</span><span class="ident" id="5220066">j</span><span class="op" id="5220067">]</span><span class="op" id="5220068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5220075">b</span><span class="op" id="5220076">.</span><span class="ident" id="5220077">WriteString</span><span class="op" id="5220088">(</span><span class="string" id="5220089">&#34;&amp;lt;&#34;</span><span class="op" id="5220095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5220102">written</span>&nbsp;<span class="op" id="5220110">=</span>&nbsp;<span class="ident" id="5220112">j</span>&nbsp;<span class="op" id="5220114">+</span>&nbsp;<span class="num" id="5220116">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5220122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5220127">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5220131">}</span>&nbsp;<span class="keyword" id="5220133">else</span>&nbsp;<span class="keyword" id="5220138">if</span>&nbsp;<span class="ident" id="5220141">isComment</span><span class="op" id="5220150">(</span><span class="ident" id="5220151">c</span><span class="op" id="5220152">.</span><span class="ident" id="5220153">state</span><span class="op" id="5220158">)</span>&nbsp;<span class="op" id="5220160">&amp;&amp;</span>&nbsp;<span class="ident" id="5220163">c</span><span class="op" id="5220164">.</span><span class="ident" id="5220165">delim</span>&nbsp;<span class="op" id="5220171">==</span>&nbsp;<span class="ident" id="5220174">delimNone</span>&nbsp;<span class="op" id="5220184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5220189">switch</span>&nbsp;<span class="ident" id="5220196">c</span><span class="op" id="5220197">.</span><span class="ident" id="5220198">state</span>&nbsp;<span class="op" id="5220204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5220209">case</span>&nbsp;<span class="ident" id="5220214">stateJSBlockCmt</span><span class="op" id="5220229">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5220235">//&nbsp;http://es5.github.com/#x7.4:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5220271">//&nbsp;&#34;Comments&nbsp;behave&nbsp;like&nbsp;white&nbsp;space&nbsp;and&nbsp;are</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5220320">//&nbsp;discarded&nbsp;except&nbsp;that,&nbsp;if&nbsp;a&nbsp;MultiLineComment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5220372">//&nbsp;contains&nbsp;a&nbsp;line&nbsp;terminator&nbsp;character,&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5220422">//&nbsp;the&nbsp;entire&nbsp;comment&nbsp;is&nbsp;considered&nbsp;to&nbsp;be&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5220470">//&nbsp;LineTerminator&nbsp;for&nbsp;purposes&nbsp;of&nbsp;parsing&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5220519">//&nbsp;the&nbsp;syntactic&nbsp;grammar.&#34;</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5220550">if</span>&nbsp;<span class="ident" id="5220553">bytes</span><span class="op" id="5220558">.</span><span class="ident" id="5220559">IndexAny</span><span class="op" id="5220567">(</span><span class="ident" id="5220568">s</span><span class="op" id="5220569">[</span><span class="ident" id="5220570">written</span><span class="op" id="5220577">:</span><span class="ident" id="5220578">i1</span><span class="op" id="5220580">]</span><span class="op" id="5220581">,</span>&nbsp;<span class="string" id="5220583">&#34;\n\r\u2028\u2029&#34;</span><span class="op" id="5220601">)</span>&nbsp;<span class="op" id="5220603">!=</span>&nbsp;<span class="op" id="5220606">-</span><span class="num" id="5220607">1</span>&nbsp;<span class="op" id="5220609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5220616">b</span><span class="op" id="5220617">.</span><span class="ident" id="5220618">WriteByte</span><span class="op" id="5220627">(</span><span class="string" id="5220628">&#39;\n&#39;</span><span class="op" id="5220632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5220638">}</span>&nbsp;<span class="keyword" id="5220640">else</span>&nbsp;<span class="op" id="5220645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5220652">b</span><span class="op" id="5220653">.</span><span class="ident" id="5220654">WriteByte</span><span class="op" id="5220663">(</span><span class="string" id="5220664">&#39;&nbsp;&#39;</span><span class="op" id="5220667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5220673">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5220678">case</span>&nbsp;<span class="ident" id="5220683">stateCSSBlockCmt</span><span class="op" id="5220699">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5220705">b</span><span class="op" id="5220706">.</span><span class="ident" id="5220707">WriteByte</span><span class="op" id="5220716">(</span><span class="string" id="5220717">&#39;&nbsp;&#39;</span><span class="op" id="5220720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5220725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5220730">written</span>&nbsp;<span class="op" id="5220738">=</span>&nbsp;<span class="ident" id="5220740">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5220745">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5220749">if</span>&nbsp;<span class="ident" id="5220752">c</span><span class="op" id="5220753">.</span><span class="ident" id="5220754">state</span>&nbsp;<span class="op" id="5220760">!=</span>&nbsp;<span class="ident" id="5220763">c1</span><span class="op" id="5220765">.</span><span class="ident" id="5220766">state</span>&nbsp;<span class="op" id="5220772">&amp;&amp;</span>&nbsp;<span class="ident" id="5220775">isComment</span><span class="op" id="5220784">(</span><span class="ident" id="5220785">c1</span><span class="op" id="5220787">.</span><span class="ident" id="5220788">state</span><span class="op" id="5220793">)</span>&nbsp;<span class="op" id="5220795">&amp;&amp;</span>&nbsp;<span class="ident" id="5220798">c1</span><span class="op" id="5220800">.</span><span class="ident" id="5220801">delim</span>&nbsp;<span class="op" id="5220807">==</span>&nbsp;<span class="ident" id="5220810">delimNone</span>&nbsp;<span class="op" id="5220820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5220825">//&nbsp;Preserve&nbsp;the&nbsp;portion&nbsp;between&nbsp;written&nbsp;and&nbsp;the&nbsp;comment&nbsp;start.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5220891">cs</span>&nbsp;<span class="op" id="5220894">:=</span>&nbsp;<span class="ident" id="5220897">i1</span>&nbsp;<span class="op" id="5220900">-</span>&nbsp;<span class="num" id="5220902">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5220907">if</span>&nbsp;<span class="ident" id="5220910">c1</span><span class="op" id="5220912">.</span><span class="ident" id="5220913">state</span>&nbsp;<span class="op" id="5220919">==</span>&nbsp;<span class="ident" id="5220922">stateHTMLCmt</span>&nbsp;<span class="op" id="5220935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5220941">//&nbsp;&#34;&lt;!--&#34;&nbsp;instead&nbsp;of&nbsp;&#34;/*&#34;&nbsp;or&nbsp;&#34;//&#34;</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5220979">cs</span>&nbsp;<span class="op" id="5220982">-=</span>&nbsp;<span class="num" id="5220985">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5220990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5220995">b</span><span class="op" id="5220996">.</span><span class="ident" id="5220997">Write</span><span class="op" id="5221002">(</span><span class="ident" id="5221003">s</span><span class="op" id="5221004">[</span><span class="ident" id="5221005">written</span><span class="op" id="5221012">:</span><span class="ident" id="5221013">cs</span><span class="op" id="5221015">]</span><span class="op" id="5221016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5221021">written</span>&nbsp;<span class="op" id="5221029">=</span>&nbsp;<span class="ident" id="5221031">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5221036">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5221040">if</span>&nbsp;<span class="ident" id="5221043">i</span>&nbsp;<span class="op" id="5221045">==</span>&nbsp;<span class="ident" id="5221048">i1</span>&nbsp;<span class="op" id="5221051">&amp;&amp;</span>&nbsp;<span class="ident" id="5221054">c</span><span class="op" id="5221055">.</span><span class="ident" id="5221056">state</span>&nbsp;<span class="op" id="5221062">==</span>&nbsp;<span class="ident" id="5221065">c1</span><span class="op" id="5221067">.</span><span class="ident" id="5221068">state</span>&nbsp;<span class="op" id="5221074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5221079">panic</span><span class="op" id="5221084">(</span><span class="ident" id="5221085">fmt</span><span class="op" id="5221088">.</span><span class="ident" id="5221089">Sprintf</span><span class="op" id="5221096">(</span><span class="string" id="5221097">&#34;infinite&nbsp;loop&nbsp;from&nbsp;%v&nbsp;to&nbsp;%v&nbsp;on&nbsp;%q..%q&#34;</span><span class="op" id="5221136">,</span>&nbsp;<span class="ident" id="5221138">c</span><span class="op" id="5221139">,</span>&nbsp;<span class="ident" id="5221141">c1</span><span class="op" id="5221143">,</span>&nbsp;<span class="ident" id="5221145">s</span><span class="op" id="5221146">[</span><span class="op" id="5221147">:</span><span class="ident" id="5221148">i</span><span class="op" id="5221149">]</span><span class="op" id="5221150">,</span>&nbsp;<span class="ident" id="5221152">s</span><span class="op" id="5221153">[</span><span class="ident" id="5221154">i</span><span class="op" id="5221155">:</span><span class="op" id="5221156">]</span><span class="op" id="5221157">)</span><span class="op" id="5221158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5221162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5221166">c</span><span class="op" id="5221167">,</span>&nbsp;<span class="ident" id="5221169">i</span>&nbsp;<span class="op" id="5221171">=</span>&nbsp;<span class="ident" id="5221173">c1</span><span class="op" id="5221175">,</span>&nbsp;<span class="ident" id="5221177">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5221181">}</span><br>
<span class="lineno">650</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5221185">if</span>&nbsp;<span class="ident" id="5221188">written</span>&nbsp;<span class="op" id="5221196">!=</span>&nbsp;<span class="num" id="5221199">0</span>&nbsp;<span class="op" id="5221201">&amp;&amp;</span>&nbsp;<span class="ident" id="5221204">c</span><span class="op" id="5221205">.</span><span class="ident" id="5221206">state</span>&nbsp;<span class="op" id="5221212">!=</span>&nbsp;<span class="ident" id="5221215">stateError</span>&nbsp;<span class="op" id="5221226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5221230">if</span>&nbsp;<span class="op" id="5221233">!</span><span class="ident" id="5221234">isComment</span><span class="op" id="5221243">(</span><span class="ident" id="5221244">c</span><span class="op" id="5221245">.</span><span class="ident" id="5221246">state</span><span class="op" id="5221251">)</span>&nbsp;<span class="op" id="5221253">||</span>&nbsp;<span class="ident" id="5221256">c</span><span class="op" id="5221257">.</span><span class="ident" id="5221258">delim</span>&nbsp;<span class="op" id="5221264">!=</span>&nbsp;<span class="ident" id="5221267">delimNone</span>&nbsp;<span class="op" id="5221277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5221282">b</span><span class="op" id="5221283">.</span><span class="ident" id="5221284">Write</span><span class="op" id="5221289">(</span><span class="ident" id="5221290">n</span><span class="op" id="5221291">.</span><span class="ident" id="5221292">Text</span><span class="op" id="5221296">[</span><span class="ident" id="5221297">written</span><span class="op" id="5221304">:</span><span class="op" id="5221305">]</span><span class="op" id="5221306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5221310">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5221314">e</span><span class="op" id="5221315">.</span><span class="ident" id="5221316">editTextNode</span><span class="op" id="5221328">(</span><span class="ident" id="5221329">n</span><span class="op" id="5221330">,</span>&nbsp;<span class="ident" id="5221332">b</span><span class="op" id="5221333">.</span><span class="ident" id="5221334">Bytes</span><span class="op" id="5221339">(</span><span class="op" id="5221340">)</span><span class="op" id="5221341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5221344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5221347">return</span>&nbsp;<span class="ident" id="5221354">c</span><br>
<span class="lineno"></span><span class="op" id="5221356">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span><span class="comment" id="5221359">//&nbsp;contextAfterText&nbsp;starts&nbsp;in&nbsp;context&nbsp;c,&nbsp;consumes&nbsp;some&nbsp;tokens&nbsp;from&nbsp;the&nbsp;front&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5221439">//&nbsp;s,&nbsp;then&nbsp;returns&nbsp;the&nbsp;context&nbsp;after&nbsp;those&nbsp;tokens&nbsp;and&nbsp;the&nbsp;unprocessed&nbsp;suffix.</span><br>
<span class="lineno"></span><span class="keyword" id="5221517">func</span>&nbsp;<span class="ident" id="5221522">contextAfterText</span><span class="op" id="5221538">(</span><span class="ident" id="5221539">c</span>&nbsp;<span class="ident" id="5221541">context</span><span class="op" id="5221548">,</span>&nbsp;<span class="ident" id="5221550">s</span>&nbsp;<span class="op" id="5221552">[</span><span class="op" id="5221553">]</span><span class="builtintype" id="5221554">byte</span><span class="op" id="5221558">)</span>&nbsp;<span class="op" id="5221560">(</span><span class="ident" id="5221561">context</span><span class="op" id="5221568">,</span>&nbsp;<span class="builtintype" id="5221570">int</span><span class="op" id="5221573">)</span>&nbsp;<span class="op" id="5221575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5221578">if</span>&nbsp;<span class="ident" id="5221581">c</span><span class="op" id="5221582">.</span><span class="ident" id="5221583">delim</span>&nbsp;<span class="op" id="5221589">==</span>&nbsp;<span class="ident" id="5221592">delimNone</span>&nbsp;<span class="op" id="5221602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5221606">c1</span><span class="op" id="5221608">,</span>&nbsp;<span class="ident" id="5221610">i</span>&nbsp;<span class="op" id="5221612">:=</span>&nbsp;<span class="ident" id="5221615">tSpecialTagEnd</span><span class="op" id="5221629">(</span><span class="ident" id="5221630">c</span><span class="op" id="5221631">,</span>&nbsp;<span class="ident" id="5221633">s</span><span class="op" id="5221634">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5221638">if</span>&nbsp;<span class="ident" id="5221641">i</span>&nbsp;<span class="op" id="5221643">==</span>&nbsp;<span class="num" id="5221646">0</span>&nbsp;<span class="op" id="5221648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5221653">//&nbsp;A&nbsp;special&nbsp;end&nbsp;tag&nbsp;(`&lt;/script&gt;`)&nbsp;has&nbsp;been&nbsp;seen&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5221709">//&nbsp;all&nbsp;content&nbsp;preceding&nbsp;it&nbsp;has&nbsp;been&nbsp;consumed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5221759">return</span>&nbsp;<span class="ident" id="5221766">c1</span><span class="op" id="5221768">,</span>&nbsp;<span class="num" id="5221770">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5221774">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5221778">//&nbsp;Consider&nbsp;all&nbsp;content&nbsp;up&nbsp;to&nbsp;any&nbsp;end&nbsp;tag.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5221823">return</span>&nbsp;<span class="ident" id="5221830">transitionFunc</span><span class="op" id="5221844">[</span><span class="ident" id="5221845">c</span><span class="op" id="5221846">.</span><span class="ident" id="5221847">state</span><span class="op" id="5221852">]</span><span class="op" id="5221853">(</span><span class="ident" id="5221854">c</span><span class="op" id="5221855">,</span>&nbsp;<span class="ident" id="5221857">s</span><span class="op" id="5221858">[</span><span class="op" id="5221859">:</span><span class="ident" id="5221860">i</span><span class="op" id="5221861">]</span><span class="op" id="5221862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5221865">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5221869">i</span>&nbsp;<span class="op" id="5221871">:=</span>&nbsp;<span class="ident" id="5221874">bytes</span><span class="op" id="5221879">.</span><span class="ident" id="5221880">IndexAny</span><span class="op" id="5221888">(</span><span class="ident" id="5221889">s</span><span class="op" id="5221890">,</span>&nbsp;<span class="ident" id="5221892">delimEnds</span><span class="op" id="5221901">[</span><span class="ident" id="5221902">c</span><span class="op" id="5221903">.</span><span class="ident" id="5221904">delim</span><span class="op" id="5221909">]</span><span class="op" id="5221910">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5221913">if</span>&nbsp;<span class="ident" id="5221916">i</span>&nbsp;<span class="op" id="5221918">==</span>&nbsp;<span class="op" id="5221921">-</span><span class="num" id="5221922">1</span>&nbsp;<span class="op" id="5221924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5221928">i</span>&nbsp;<span class="op" id="5221930">=</span>&nbsp;<span class="builtinfunc" id="5221932">len</span><span class="op" id="5221935">(</span><span class="ident" id="5221936">s</span><span class="op" id="5221937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5221940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5221943">if</span>&nbsp;<span class="ident" id="5221946">c</span><span class="op" id="5221947">.</span><span class="ident" id="5221948">delim</span>&nbsp;<span class="op" id="5221954">==</span>&nbsp;<span class="ident" id="5221957">delimSpaceOrTagEnd</span>&nbsp;<span class="op" id="5221976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5221980">//&nbsp;http://www.w3.org/TR/html5/syntax.html#attribute-value-(unquoted)-state</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5222057">//&nbsp;lists&nbsp;the&nbsp;runes&nbsp;below&nbsp;as&nbsp;error&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5222105">//&nbsp;Error&nbsp;out&nbsp;because&nbsp;HTML&nbsp;parsers&nbsp;may&nbsp;differ&nbsp;on&nbsp;whether</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5222163">//&nbsp;&#34;&lt;a&nbsp;id=&nbsp;onclick=f(&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ends&nbsp;inside&nbsp;id&#39;s&nbsp;or&nbsp;onclick&#39;s&nbsp;value,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5222229">//&nbsp;&#34;&lt;a&nbsp;class=`foo&nbsp;&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ends&nbsp;inside&nbsp;a&nbsp;value,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5222279">//&nbsp;&#34;&lt;a&nbsp;style=font:&#39;Arial&#39;&#34;&nbsp;needs&nbsp;open-quote&nbsp;fixup.</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5222332">//&nbsp;IE&nbsp;treats&nbsp;&#39;`&#39;&nbsp;as&nbsp;a&nbsp;quotation&nbsp;character.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5222377">if</span>&nbsp;<span class="ident" id="5222380">j</span>&nbsp;<span class="op" id="5222382">:=</span>&nbsp;<span class="ident" id="5222385">bytes</span><span class="op" id="5222390">.</span><span class="ident" id="5222391">IndexAny</span><span class="op" id="5222399">(</span><span class="ident" id="5222400">s</span><span class="op" id="5222401">[</span><span class="op" id="5222402">:</span><span class="ident" id="5222403">i</span><span class="op" id="5222404">]</span><span class="op" id="5222405">,</span>&nbsp;<span class="string" id="5222407">&#34;\&#34;&#39;&lt;=`&#34;</span><span class="op" id="5222415">)</span><span class="op" id="5222416">;</span>&nbsp;<span class="ident" id="5222418">j</span>&nbsp;<span class="op" id="5222420">&gt;=</span>&nbsp;<span class="num" id="5222423">0</span>&nbsp;<span class="op" id="5222425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5222430">return</span>&nbsp;<span class="ident" id="5222437">context</span><span class="op" id="5222444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5222450">state</span><span class="op" id="5222455">:</span>&nbsp;<span class="ident" id="5222457">stateError</span><span class="op" id="5222467">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5222473">err</span><span class="op" id="5222476">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5222480">errorf</span><span class="op" id="5222486">(</span><span class="ident" id="5222487">ErrBadHTML</span><span class="op" id="5222497">,</span>&nbsp;<span class="ident" id="5222499">nil</span><span class="op" id="5222502">,</span>&nbsp;<span class="num" id="5222504">0</span><span class="op" id="5222505">,</span>&nbsp;<span class="string" id="5222507">&#34;%q&nbsp;in&nbsp;unquoted&nbsp;attr:&nbsp;%q&#34;</span><span class="op" id="5222532">,</span>&nbsp;<span class="ident" id="5222534">s</span><span class="op" id="5222535">[</span><span class="ident" id="5222536">j</span><span class="op" id="5222537">:</span><span class="ident" id="5222538">j</span><span class="op" id="5222539">+</span><span class="num" id="5222540">1</span><span class="op" id="5222541">]</span><span class="op" id="5222542">,</span>&nbsp;<span class="ident" id="5222544">s</span><span class="op" id="5222545">[</span><span class="op" id="5222546">:</span><span class="ident" id="5222547">i</span><span class="op" id="5222548">]</span><span class="op" id="5222549">)</span><span class="op" id="5222550">,</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5222555">}</span><span class="op" id="5222556">,</span>&nbsp;<span class="builtinfunc" id="5222558">len</span><span class="op" id="5222561">(</span><span class="ident" id="5222562">s</span><span class="op" id="5222563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5222567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5222570">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5222573">if</span>&nbsp;<span class="ident" id="5222576">i</span>&nbsp;<span class="op" id="5222578">==</span>&nbsp;<span class="builtinfunc" id="5222581">len</span><span class="op" id="5222584">(</span><span class="ident" id="5222585">s</span><span class="op" id="5222586">)</span>&nbsp;<span class="op" id="5222588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5222592">//&nbsp;Remain&nbsp;inside&nbsp;the&nbsp;attribute.</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5222626">//&nbsp;Decode&nbsp;the&nbsp;value&nbsp;so&nbsp;non-HTML&nbsp;rules&nbsp;can&nbsp;easily&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5222684">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;button&nbsp;onclick=&#34;alert(&amp;quot;Hi!&amp;quot;)&#34;&gt;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5222735">//&nbsp;without&nbsp;having&nbsp;to&nbsp;entity&nbsp;decode&nbsp;token&nbsp;boundaries.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5222790">for</span>&nbsp;<span class="ident" id="5222794">u</span>&nbsp;<span class="op" id="5222796">:=</span>&nbsp;<span class="op" id="5222799">[</span><span class="op" id="5222800">]</span><span class="builtintype" id="5222801">byte</span><span class="op" id="5222805">(</span><span class="ident" id="5222806">html</span><span class="op" id="5222810">.</span><span class="ident" id="5222811">UnescapeString</span><span class="op" id="5222825">(</span><span class="builtintype" id="5222826">string</span><span class="op" id="5222832">(</span><span class="ident" id="5222833">s</span><span class="op" id="5222834">)</span><span class="op" id="5222835">)</span><span class="op" id="5222836">)</span><span class="op" id="5222837">;</span>&nbsp;<span class="builtinfunc" id="5222839">len</span><span class="op" id="5222842">(</span><span class="ident" id="5222843">u</span><span class="op" id="5222844">)</span>&nbsp;<span class="op" id="5222846">!=</span>&nbsp;<span class="num" id="5222849">0</span><span class="op" id="5222850">;</span>&nbsp;<span class="op" id="5222852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5222857">c1</span><span class="op" id="5222859">,</span>&nbsp;<span class="ident" id="5222861">i1</span>&nbsp;<span class="op" id="5222864">:=</span>&nbsp;<span class="ident" id="5222867">transitionFunc</span><span class="op" id="5222881">[</span><span class="ident" id="5222882">c</span><span class="op" id="5222883">.</span><span class="ident" id="5222884">state</span><span class="op" id="5222889">]</span><span class="op" id="5222890">(</span><span class="ident" id="5222891">c</span><span class="op" id="5222892">,</span>&nbsp;<span class="ident" id="5222894">u</span><span class="op" id="5222895">)</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5222900">c</span><span class="op" id="5222901">,</span>&nbsp;<span class="ident" id="5222903">u</span>&nbsp;<span class="op" id="5222905">=</span>&nbsp;<span class="ident" id="5222907">c1</span><span class="op" id="5222909">,</span>&nbsp;<span class="ident" id="5222911">u</span><span class="op" id="5222912">[</span><span class="ident" id="5222913">i1</span><span class="op" id="5222915">:</span><span class="op" id="5222916">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5222920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5222924">return</span>&nbsp;<span class="ident" id="5222931">c</span><span class="op" id="5222932">,</span>&nbsp;<span class="builtinfunc" id="5222934">len</span><span class="op" id="5222937">(</span><span class="ident" id="5222938">s</span><span class="op" id="5222939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5222942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5222945">if</span>&nbsp;<span class="ident" id="5222948">c</span><span class="op" id="5222949">.</span><span class="ident" id="5222950">delim</span>&nbsp;<span class="op" id="5222956">!=</span>&nbsp;<span class="ident" id="5222959">delimSpaceOrTagEnd</span>&nbsp;<span class="op" id="5222978">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5222982">//&nbsp;Consume&nbsp;any&nbsp;quote.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5223006">i</span><span class="op" id="5223007">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5223011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5223014">//&nbsp;On&nbsp;exiting&nbsp;an&nbsp;attribute,&nbsp;we&nbsp;discard&nbsp;all&nbsp;state&nbsp;information</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5223076">//&nbsp;except&nbsp;the&nbsp;state&nbsp;and&nbsp;element.</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5223110">return</span>&nbsp;<span class="ident" id="5223117">context</span><span class="op" id="5223124">{</span><span class="ident" id="5223125">state</span><span class="op" id="5223130">:</span>&nbsp;<span class="ident" id="5223132">stateTag</span><span class="op" id="5223140">,</span>&nbsp;<span class="ident" id="5223142">element</span><span class="op" id="5223149">:</span>&nbsp;<span class="ident" id="5223151">c</span><span class="op" id="5223152">.</span><span class="ident" id="5223153">element</span><span class="op" id="5223160">}</span><span class="op" id="5223161">,</span>&nbsp;<span class="ident" id="5223163">i</span><br>
<span class="lineno"></span><span class="op" id="5223165">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5223168">//&nbsp;editActionNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;an&nbsp;action&nbsp;pipeline&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno"></span><span class="keyword" id="5223243">func</span>&nbsp;<span class="op" id="5223248">(</span><span class="ident" id="5223249">e</span>&nbsp;<span class="op" id="5223251">*</span><span class="ident" id="5223252">escaper</span><span class="op" id="5223259">)</span>&nbsp;<span class="ident" id="5223261">editActionNode</span><span class="op" id="5223275">(</span><span class="ident" id="5223276">n</span>&nbsp;<span class="op" id="5223278">*</span><span class="ident" id="5223279">parse</span><span class="op" id="5223284">.</span><span class="ident" id="5223285">ActionNode</span><span class="op" id="5223295">,</span>&nbsp;<span class="ident" id="5223297">cmds</span>&nbsp;<span class="op" id="5223302">[</span><span class="op" id="5223303">]</span><span class="builtintype" id="5223304">string</span><span class="op" id="5223310">)</span>&nbsp;<span class="op" id="5223312">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5223315">if</span>&nbsp;<span class="ident" id="5223318">_</span><span class="op" id="5223319">,</span>&nbsp;<span class="ident" id="5223321">ok</span>&nbsp;<span class="op" id="5223324">:=</span>&nbsp;<span class="ident" id="5223327">e</span><span class="op" id="5223328">.</span><span class="ident" id="5223329">actionNodeEdits</span><span class="op" id="5223344">[</span><span class="ident" id="5223345">n</span><span class="op" id="5223346">]</span><span class="op" id="5223347">;</span>&nbsp;<span class="ident" id="5223349">ok</span>&nbsp;<span class="op" id="5223352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5223356">panic</span><span class="op" id="5223361">(</span><span class="ident" id="5223362">fmt</span><span class="op" id="5223365">.</span><span class="ident" id="5223366">Sprintf</span><span class="op" id="5223373">(</span><span class="string" id="5223374">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="5223408">,</span>&nbsp;<span class="ident" id="5223410">n</span><span class="op" id="5223411">)</span><span class="op" id="5223412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5223415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5223418">e</span><span class="op" id="5223419">.</span><span class="ident" id="5223420">actionNodeEdits</span><span class="op" id="5223435">[</span><span class="ident" id="5223436">n</span><span class="op" id="5223437">]</span>&nbsp;<span class="op" id="5223439">=</span>&nbsp;<span class="ident" id="5223441">cmds</span><br>
<span class="lineno"></span><span class="op" id="5223446">}</span><br>
<span class="lineno">720</span><br>
<span class="lineno"></span><span class="comment" id="5223449">//&nbsp;editTemplateNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;a&nbsp;{{template}}&nbsp;callee&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno"></span><span class="keyword" id="5223529">func</span>&nbsp;<span class="op" id="5223534">(</span><span class="ident" id="5223535">e</span>&nbsp;<span class="op" id="5223537">*</span><span class="ident" id="5223538">escaper</span><span class="op" id="5223545">)</span>&nbsp;<span class="ident" id="5223547">editTemplateNode</span><span class="op" id="5223563">(</span><span class="ident" id="5223564">n</span>&nbsp;<span class="op" id="5223566">*</span><span class="ident" id="5223567">parse</span><span class="op" id="5223572">.</span><span class="ident" id="5223573">TemplateNode</span><span class="op" id="5223585">,</span>&nbsp;<span class="ident" id="5223587">callee</span>&nbsp;<span class="builtintype" id="5223594">string</span><span class="op" id="5223600">)</span>&nbsp;<span class="op" id="5223602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5223605">if</span>&nbsp;<span class="ident" id="5223608">_</span><span class="op" id="5223609">,</span>&nbsp;<span class="ident" id="5223611">ok</span>&nbsp;<span class="op" id="5223614">:=</span>&nbsp;<span class="ident" id="5223617">e</span><span class="op" id="5223618">.</span><span class="ident" id="5223619">templateNodeEdits</span><span class="op" id="5223636">[</span><span class="ident" id="5223637">n</span><span class="op" id="5223638">]</span><span class="op" id="5223639">;</span>&nbsp;<span class="ident" id="5223641">ok</span>&nbsp;<span class="op" id="5223644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5223648">panic</span><span class="op" id="5223653">(</span><span class="ident" id="5223654">fmt</span><span class="op" id="5223657">.</span><span class="ident" id="5223658">Sprintf</span><span class="op" id="5223665">(</span><span class="string" id="5223666">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="5223700">,</span>&nbsp;<span class="ident" id="5223702">n</span><span class="op" id="5223703">)</span><span class="op" id="5223704">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5223707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5223710">e</span><span class="op" id="5223711">.</span><span class="ident" id="5223712">templateNodeEdits</span><span class="op" id="5223729">[</span><span class="ident" id="5223730">n</span><span class="op" id="5223731">]</span>&nbsp;<span class="op" id="5223733">=</span>&nbsp;<span class="ident" id="5223735">callee</span><br>
<span class="lineno"></span><span class="op" id="5223742">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5223745">//&nbsp;editTextNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;a&nbsp;text&nbsp;node&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno">730</span><span class="keyword" id="5223811">func</span>&nbsp;<span class="op" id="5223816">(</span><span class="ident" id="5223817">e</span>&nbsp;<span class="op" id="5223819">*</span><span class="ident" id="5223820">escaper</span><span class="op" id="5223827">)</span>&nbsp;<span class="ident" id="5223829">editTextNode</span><span class="op" id="5223841">(</span><span class="ident" id="5223842">n</span>&nbsp;<span class="op" id="5223844">*</span><span class="ident" id="5223845">parse</span><span class="op" id="5223850">.</span><span class="ident" id="5223851">TextNode</span><span class="op" id="5223859">,</span>&nbsp;<span class="ident" id="5223861">text</span>&nbsp;<span class="op" id="5223866">[</span><span class="op" id="5223867">]</span><span class="builtintype" id="5223868">byte</span><span class="op" id="5223872">)</span>&nbsp;<span class="op" id="5223874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5223877">if</span>&nbsp;<span class="ident" id="5223880">_</span><span class="op" id="5223881">,</span>&nbsp;<span class="ident" id="5223883">ok</span>&nbsp;<span class="op" id="5223886">:=</span>&nbsp;<span class="ident" id="5223889">e</span><span class="op" id="5223890">.</span><span class="ident" id="5223891">textNodeEdits</span><span class="op" id="5223904">[</span><span class="ident" id="5223905">n</span><span class="op" id="5223906">]</span><span class="op" id="5223907">;</span>&nbsp;<span class="ident" id="5223909">ok</span>&nbsp;<span class="op" id="5223912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5223916">panic</span><span class="op" id="5223921">(</span><span class="ident" id="5223922">fmt</span><span class="op" id="5223925">.</span><span class="ident" id="5223926">Sprintf</span><span class="op" id="5223933">(</span><span class="string" id="5223934">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="5223968">,</span>&nbsp;<span class="ident" id="5223970">n</span><span class="op" id="5223971">)</span><span class="op" id="5223972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5223975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5223978">e</span><span class="op" id="5223979">.</span><span class="ident" id="5223980">textNodeEdits</span><span class="op" id="5223993">[</span><span class="ident" id="5223994">n</span><span class="op" id="5223995">]</span>&nbsp;<span class="op" id="5223997">=</span>&nbsp;<span class="ident" id="5223999">text</span><br>
<span class="lineno">735</span><span class="op" id="5224004">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5224007">//&nbsp;commit&nbsp;applies&nbsp;changes&nbsp;to&nbsp;actions&nbsp;and&nbsp;template&nbsp;calls&nbsp;needed&nbsp;to&nbsp;contextually</span><br>
<span class="lineno"></span><span class="comment" id="5224086">//&nbsp;autoescape&nbsp;content&nbsp;and&nbsp;adds&nbsp;any&nbsp;derived&nbsp;templates&nbsp;to&nbsp;the&nbsp;set.</span><br>
<span class="lineno"></span><span class="keyword" id="5224151">func</span>&nbsp;<span class="op" id="5224156">(</span><span class="ident" id="5224157">e</span>&nbsp;<span class="op" id="5224159">*</span><span class="ident" id="5224160">escaper</span><span class="op" id="5224167">)</span>&nbsp;<span class="ident" id="5224169">commit</span><span class="op" id="5224175">(</span><span class="op" id="5224176">)</span>&nbsp;<span class="op" id="5224178">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5224181">for</span>&nbsp;<span class="ident" id="5224185">name</span>&nbsp;<span class="op" id="5224190">:=</span>&nbsp;<span class="keyword" id="5224193">range</span>&nbsp;<span class="ident" id="5224199">e</span><span class="op" id="5224200">.</span><span class="ident" id="5224201">output</span>&nbsp;<span class="op" id="5224208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5224212">e</span><span class="op" id="5224213">.</span><span class="ident" id="5224214">template</span><span class="op" id="5224222">(</span><span class="ident" id="5224223">name</span><span class="op" id="5224227">)</span><span class="op" id="5224228">.</span><span class="ident" id="5224229">Funcs</span><span class="op" id="5224234">(</span><span class="ident" id="5224235">funcMap</span><span class="op" id="5224242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5224245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5224248">for</span>&nbsp;<span class="ident" id="5224252">_</span><span class="op" id="5224253">,</span>&nbsp;<span class="ident" id="5224255">t</span>&nbsp;<span class="op" id="5224257">:=</span>&nbsp;<span class="keyword" id="5224260">range</span>&nbsp;<span class="ident" id="5224266">e</span><span class="op" id="5224267">.</span><span class="ident" id="5224268">derived</span>&nbsp;<span class="op" id="5224276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5224280">if</span>&nbsp;<span class="ident" id="5224283">_</span><span class="op" id="5224284">,</span>&nbsp;<span class="ident" id="5224286">err</span>&nbsp;<span class="op" id="5224290">:=</span>&nbsp;<span class="ident" id="5224293">e</span><span class="op" id="5224294">.</span><span class="ident" id="5224295">tmpl</span><span class="op" id="5224299">.</span><span class="ident" id="5224300">text</span><span class="op" id="5224304">.</span><span class="ident" id="5224305">AddParseTree</span><span class="op" id="5224317">(</span><span class="ident" id="5224318">t</span><span class="op" id="5224319">.</span><span class="ident" id="5224320">Name</span><span class="op" id="5224324">(</span><span class="op" id="5224325">)</span><span class="op" id="5224326">,</span>&nbsp;<span class="ident" id="5224328">t</span><span class="op" id="5224329">.</span><span class="ident" id="5224330">Tree</span><span class="op" id="5224334">)</span><span class="op" id="5224335">;</span>&nbsp;<span class="ident" id="5224337">err</span>&nbsp;<span class="op" id="5224341">!=</span>&nbsp;<span class="ident" id="5224344">nil</span>&nbsp;<span class="op" id="5224348">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5224353">panic</span><span class="op" id="5224358">(</span><span class="string" id="5224359">&#34;error&nbsp;adding&nbsp;derived&nbsp;template&#34;</span><span class="op" id="5224390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5224394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5224397">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5224400">for</span>&nbsp;<span class="ident" id="5224404">n</span><span class="op" id="5224405">,</span>&nbsp;<span class="ident" id="5224407">s</span>&nbsp;<span class="op" id="5224409">:=</span>&nbsp;<span class="keyword" id="5224412">range</span>&nbsp;<span class="ident" id="5224418">e</span><span class="op" id="5224419">.</span><span class="ident" id="5224420">actionNodeEdits</span>&nbsp;<span class="op" id="5224436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5224440">ensurePipelineContains</span><span class="op" id="5224462">(</span><span class="ident" id="5224463">n</span><span class="op" id="5224464">.</span><span class="ident" id="5224465">Pipe</span><span class="op" id="5224469">,</span>&nbsp;<span class="ident" id="5224471">s</span><span class="op" id="5224472">)</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5224475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5224478">for</span>&nbsp;<span class="ident" id="5224482">n</span><span class="op" id="5224483">,</span>&nbsp;<span class="ident" id="5224485">name</span>&nbsp;<span class="op" id="5224490">:=</span>&nbsp;<span class="keyword" id="5224493">range</span>&nbsp;<span class="ident" id="5224499">e</span><span class="op" id="5224500">.</span><span class="ident" id="5224501">templateNodeEdits</span>&nbsp;<span class="op" id="5224519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5224523">n</span><span class="op" id="5224524">.</span><span class="ident" id="5224525">Name</span>&nbsp;<span class="op" id="5224530">=</span>&nbsp;<span class="ident" id="5224532">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5224538">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5224541">for</span>&nbsp;<span class="ident" id="5224545">n</span><span class="op" id="5224546">,</span>&nbsp;<span class="ident" id="5224548">s</span>&nbsp;<span class="op" id="5224550">:=</span>&nbsp;<span class="keyword" id="5224553">range</span>&nbsp;<span class="ident" id="5224559">e</span><span class="op" id="5224560">.</span><span class="ident" id="5224561">textNodeEdits</span>&nbsp;<span class="op" id="5224575">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5224579">n</span><span class="op" id="5224580">.</span><span class="ident" id="5224581">Text</span>&nbsp;<span class="op" id="5224586">=</span>&nbsp;<span class="ident" id="5224588">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5224591">}</span><br>
<span class="lineno"></span><span class="op" id="5224593">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5224596">//&nbsp;template&nbsp;returns&nbsp;the&nbsp;named&nbsp;template&nbsp;given&nbsp;a&nbsp;mangled&nbsp;template&nbsp;name.</span><br>
<span class="lineno">760</span><span class="keyword" id="5224666">func</span>&nbsp;<span class="op" id="5224671">(</span><span class="ident" id="5224672">e</span>&nbsp;<span class="op" id="5224674">*</span><span class="ident" id="5224675">escaper</span><span class="op" id="5224682">)</span>&nbsp;<span class="ident" id="5224684">template</span><span class="op" id="5224692">(</span><span class="ident" id="5224693">name</span>&nbsp;<span class="builtintype" id="5224698">string</span><span class="op" id="5224704">)</span>&nbsp;<span class="op" id="5224706">*</span><span class="ident" id="5224707">template</span><span class="op" id="5224715">.</span><span class="ident" id="5224716">Template</span>&nbsp;<span class="op" id="5224725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5224728">t</span>&nbsp;<span class="op" id="5224730">:=</span>&nbsp;<span class="ident" id="5224733">e</span><span class="op" id="5224734">.</span><span class="ident" id="5224735">tmpl</span><span class="op" id="5224739">.</span><span class="ident" id="5224740">text</span><span class="op" id="5224744">.</span><span class="ident" id="5224745">Lookup</span><span class="op" id="5224751">(</span><span class="ident" id="5224752">name</span><span class="op" id="5224756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5224759">if</span>&nbsp;<span class="ident" id="5224762">t</span>&nbsp;<span class="op" id="5224764">==</span>&nbsp;<span class="ident" id="5224767">nil</span>&nbsp;<span class="op" id="5224771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5224775">t</span>&nbsp;<span class="op" id="5224777">=</span>&nbsp;<span class="ident" id="5224779">e</span><span class="op" id="5224780">.</span><span class="ident" id="5224781">derived</span><span class="op" id="5224788">[</span><span class="ident" id="5224789">name</span><span class="op" id="5224793">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5224796">}</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5224799">return</span>&nbsp;<span class="ident" id="5224806">t</span><br>
<span class="lineno"></span><span class="op" id="5224808">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5224811">//&nbsp;Forwarding&nbsp;functions&nbsp;so&nbsp;that&nbsp;clients&nbsp;need&nbsp;only&nbsp;import&nbsp;this&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="5224881">//&nbsp;to&nbsp;reach&nbsp;the&nbsp;general&nbsp;escaping&nbsp;functions&nbsp;of&nbsp;text/template.</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span><span class="comment" id="5224943">//&nbsp;HTMLEscape&nbsp;writes&nbsp;to&nbsp;w&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="5225023">func</span>&nbsp;<span class="ident" id="5225028">HTMLEscape</span><span class="op" id="5225038">(</span><span class="ident" id="5225039">w</span>&nbsp;<span class="ident" id="5225041">io</span><span class="op" id="5225043">.</span><span class="ident" id="5225044">Writer</span><span class="op" id="5225050">,</span>&nbsp;<span class="ident" id="5225052">b</span>&nbsp;<span class="op" id="5225054">[</span><span class="op" id="5225055">]</span><span class="builtintype" id="5225056">byte</span><span class="op" id="5225060">)</span>&nbsp;<span class="op" id="5225062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5225065">template</span><span class="op" id="5225073">.</span><span class="ident" id="5225074">HTMLEscape</span><span class="op" id="5225084">(</span><span class="ident" id="5225085">w</span><span class="op" id="5225086">,</span>&nbsp;<span class="ident" id="5225088">b</span><span class="op" id="5225089">)</span><br>
<span class="lineno"></span><span class="op" id="5225091">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span><span class="comment" id="5225094">//&nbsp;HTMLEscapeString&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="5225176">func</span>&nbsp;<span class="ident" id="5225181">HTMLEscapeString</span><span class="op" id="5225197">(</span><span class="ident" id="5225198">s</span>&nbsp;<span class="builtintype" id="5225200">string</span><span class="op" id="5225206">)</span>&nbsp;<span class="builtintype" id="5225208">string</span>&nbsp;<span class="op" id="5225215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5225218">return</span>&nbsp;<span class="ident" id="5225225">template</span><span class="op" id="5225233">.</span><span class="ident" id="5225234">HTMLEscapeString</span><span class="op" id="5225250">(</span><span class="ident" id="5225251">s</span><span class="op" id="5225252">)</span><br>
<span class="lineno"></span><span class="op" id="5225254">}</span><br>
<span class="lineno">780</span><br>
<span class="lineno"></span><span class="comment" id="5225257">//&nbsp;HTMLEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;textual</span><br>
<span class="lineno"></span><span class="comment" id="5225323">//&nbsp;representation&nbsp;of&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="keyword" id="5225359">func</span>&nbsp;<span class="ident" id="5225364">HTMLEscaper</span><span class="op" id="5225375">(</span><span class="ident" id="5225376">args</span>&nbsp;<span class="op" id="5225381">...</span><span class="keyword" id="5225384">interface</span><span class="op" id="5225393">{</span><span class="op" id="5225394">}</span><span class="op" id="5225395">)</span>&nbsp;<span class="builtintype" id="5225397">string</span>&nbsp;<span class="op" id="5225404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5225407">return</span>&nbsp;<span class="ident" id="5225414">template</span><span class="op" id="5225422">.</span><span class="ident" id="5225423">HTMLEscaper</span><span class="op" id="5225434">(</span><span class="ident" id="5225435">args</span><span class="op" id="5225439">...</span><span class="op" id="5225442">)</span><br>
<span class="lineno">785</span><span class="op" id="5225444">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5225447">//&nbsp;JSEscape&nbsp;writes&nbsp;to&nbsp;w&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="5225531">func</span>&nbsp;<span class="ident" id="5225536">JSEscape</span><span class="op" id="5225544">(</span><span class="ident" id="5225545">w</span>&nbsp;<span class="ident" id="5225547">io</span><span class="op" id="5225549">.</span><span class="ident" id="5225550">Writer</span><span class="op" id="5225556">,</span>&nbsp;<span class="ident" id="5225558">b</span>&nbsp;<span class="op" id="5225560">[</span><span class="op" id="5225561">]</span><span class="builtintype" id="5225562">byte</span><span class="op" id="5225566">)</span>&nbsp;<span class="op" id="5225568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5225571">template</span><span class="op" id="5225579">.</span><span class="ident" id="5225580">JSEscape</span><span class="op" id="5225588">(</span><span class="ident" id="5225589">w</span><span class="op" id="5225590">,</span>&nbsp;<span class="ident" id="5225592">b</span><span class="op" id="5225593">)</span><br>
<span class="lineno">790</span><span class="op" id="5225595">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5225598">//&nbsp;JSEscapeString&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="5225684">func</span>&nbsp;<span class="ident" id="5225689">JSEscapeString</span><span class="op" id="5225703">(</span><span class="ident" id="5225704">s</span>&nbsp;<span class="builtintype" id="5225706">string</span><span class="op" id="5225712">)</span>&nbsp;<span class="builtintype" id="5225714">string</span>&nbsp;<span class="op" id="5225721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5225724">return</span>&nbsp;<span class="ident" id="5225731">template</span><span class="op" id="5225739">.</span><span class="ident" id="5225740">JSEscapeString</span><span class="op" id="5225754">(</span><span class="ident" id="5225755">s</span><span class="op" id="5225756">)</span><br>
<span class="lineno">795</span><span class="op" id="5225758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5225761">//&nbsp;JSEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;textual</span><br>
<span class="lineno"></span><span class="comment" id="5225831">//&nbsp;representation&nbsp;of&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="keyword" id="5225867">func</span>&nbsp;<span class="ident" id="5225872">JSEscaper</span><span class="op" id="5225881">(</span><span class="ident" id="5225882">args</span>&nbsp;<span class="op" id="5225887">...</span><span class="keyword" id="5225890">interface</span><span class="op" id="5225899">{</span><span class="op" id="5225900">}</span><span class="op" id="5225901">)</span>&nbsp;<span class="builtintype" id="5225903">string</span>&nbsp;<span class="op" id="5225910">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5225913">return</span>&nbsp;<span class="ident" id="5225920">template</span><span class="op" id="5225928">.</span><span class="ident" id="5225929">JSEscaper</span><span class="op" id="5225938">(</span><span class="ident" id="5225939">args</span><span class="op" id="5225943">...</span><span class="op" id="5225946">)</span><br>
<span class="lineno"></span><span class="op" id="5225948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5225951">//&nbsp;URLQueryEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;value&nbsp;of&nbsp;the&nbsp;textual&nbsp;representation&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5226029">//&nbsp;its&nbsp;arguments&nbsp;in&nbsp;a&nbsp;form&nbsp;suitable&nbsp;for&nbsp;embedding&nbsp;in&nbsp;a&nbsp;URL&nbsp;query.</span><br>
<span class="lineno">805</span><span class="keyword" id="5226095">func</span>&nbsp;<span class="ident" id="5226100">URLQueryEscaper</span><span class="op" id="5226115">(</span><span class="ident" id="5226116">args</span>&nbsp;<span class="op" id="5226121">...</span><span class="keyword" id="5226124">interface</span><span class="op" id="5226133">{</span><span class="op" id="5226134">}</span><span class="op" id="5226135">)</span>&nbsp;<span class="builtintype" id="5226137">string</span>&nbsp;<span class="op" id="5226144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5226147">return</span>&nbsp;<span class="ident" id="5226154">template</span><span class="op" id="5226162">.</span><span class="ident" id="5226163">URLQueryEscaper</span><span class="op" id="5226178">(</span><span class="ident" id="5226179">args</span><span class="op" id="5226183">...</span><span class="op" id="5226186">)</span><br>
<span class="lineno"></span><span class="op" id="5226188">}</span>
</div>
</body>
</html>
