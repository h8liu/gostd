<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1625554">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1625609">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1625663">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1625714">package</span>&nbsp;<span class="ident" id="1625722">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1625728">import</span>&nbsp;<span class="op" id="1625735">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1625738">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1625753">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><span class="op" id="1625762">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1625765">//&nbsp;An&nbsp;RWMutex&nbsp;is&nbsp;a&nbsp;reader/writer&nbsp;mutual&nbsp;exclusion&nbsp;lock.</span><br>
<span class="lineno"></span><span class="comment" id="1625821">//&nbsp;The&nbsp;lock&nbsp;can&nbsp;be&nbsp;held&nbsp;by&nbsp;an&nbsp;arbitrary&nbsp;number&nbsp;of&nbsp;readers</span><br>
<span class="lineno"></span><span class="comment" id="1625879">//&nbsp;or&nbsp;a&nbsp;single&nbsp;writer.</span><br>
<span class="lineno">15</span><span class="comment" id="1625902">//&nbsp;RWMutexes&nbsp;can&nbsp;be&nbsp;created&nbsp;as&nbsp;part&nbsp;of&nbsp;other</span><br>
<span class="lineno"></span><span class="comment" id="1625947">//&nbsp;structures;&nbsp;the&nbsp;zero&nbsp;value&nbsp;for&nbsp;a&nbsp;RWMutex&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1625994">//&nbsp;an&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="1626016">type</span>&nbsp;<span class="ident" id="1626021">RWMutex</span>&nbsp;<span class="keyword" id="1626029">struct</span>&nbsp;<span class="op" id="1626036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626039">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1626051">Mutex</span>&nbsp;&nbsp;<span class="comment" id="1626058">//&nbsp;held&nbsp;if&nbsp;there&nbsp;are&nbsp;pending&nbsp;writers</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626096">writerSem</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1626108">uint32</span>&nbsp;<span class="comment" id="1626115">//&nbsp;semaphore&nbsp;for&nbsp;writers&nbsp;to&nbsp;wait&nbsp;for&nbsp;completing&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626172">readerSem</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1626184">uint32</span>&nbsp;<span class="comment" id="1626191">//&nbsp;semaphore&nbsp;for&nbsp;readers&nbsp;to&nbsp;wait&nbsp;for&nbsp;completing&nbsp;writers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626248">readerCount</span>&nbsp;<span class="builtintype" id="1626260">int32</span>&nbsp;&nbsp;<span class="comment" id="1626267">//&nbsp;number&nbsp;of&nbsp;pending&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626297">readerWait</span>&nbsp;&nbsp;<span class="builtintype" id="1626309">int32</span>&nbsp;&nbsp;<span class="comment" id="1626316">//&nbsp;number&nbsp;of&nbsp;departing&nbsp;readers</span><br>
<span class="lineno"></span><span class="op" id="1626347">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="1626350">const</span>&nbsp;<span class="ident" id="1626356">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1626374">=</span>&nbsp;<span class="num" id="1626376">1</span>&nbsp;<span class="op" id="1626378">&lt;&lt;</span>&nbsp;<span class="num" id="1626381">30</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1626385">//&nbsp;RLock&nbsp;locks&nbsp;rw&nbsp;for&nbsp;reading.</span><br>
<span class="lineno"></span><span class="keyword" id="1626416">func</span>&nbsp;<span class="op" id="1626421">(</span><span class="ident" id="1626422">rw</span>&nbsp;<span class="op" id="1626425">*</span><span class="ident" id="1626426">RWMutex</span><span class="op" id="1626433">)</span>&nbsp;<span class="ident" id="1626435">RLock</span><span class="op" id="1626440">(</span><span class="op" id="1626441">)</span>&nbsp;<span class="op" id="1626443">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1626446">if</span>&nbsp;<span class="ident" id="1626449">raceenabled</span>&nbsp;<span class="op" id="1626461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626465">_</span>&nbsp;<span class="op" id="1626467">=</span>&nbsp;<span class="ident" id="1626469">rw</span><span class="op" id="1626471">.</span><span class="ident" id="1626472">w</span><span class="op" id="1626473">.</span><span class="ident" id="1626474">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626482">raceDisable</span><span class="op" id="1626493">(</span><span class="op" id="1626494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1626497">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1626500">if</span>&nbsp;<span class="ident" id="1626503">atomic</span><span class="op" id="1626509">.</span><span class="ident" id="1626510">AddInt32</span><span class="op" id="1626518">(</span><span class="op" id="1626519">&amp;</span><span class="ident" id="1626520">rw</span><span class="op" id="1626522">.</span><span class="ident" id="1626523">readerCount</span><span class="op" id="1626534">,</span>&nbsp;<span class="num" id="1626536">1</span><span class="op" id="1626537">)</span>&nbsp;<span class="op" id="1626539">&lt;</span>&nbsp;<span class="num" id="1626541">0</span>&nbsp;<span class="op" id="1626543">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1626547">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;pending,&nbsp;wait&nbsp;for&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626586">runtime_Semacquire</span><span class="op" id="1626604">(</span><span class="op" id="1626605">&amp;</span><span class="ident" id="1626606">rw</span><span class="op" id="1626608">.</span><span class="ident" id="1626609">readerSem</span><span class="op" id="1626618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1626621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1626624">if</span>&nbsp;<span class="ident" id="1626627">raceenabled</span>&nbsp;<span class="op" id="1626639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626643">raceEnable</span><span class="op" id="1626653">(</span><span class="op" id="1626654">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626658">raceAcquire</span><span class="op" id="1626669">(</span><span class="ident" id="1626670">unsafe</span><span class="op" id="1626676">.</span><span class="ident" id="1626677">Pointer</span><span class="op" id="1626684">(</span><span class="op" id="1626685">&amp;</span><span class="ident" id="1626686">rw</span><span class="op" id="1626688">.</span><span class="ident" id="1626689">readerSem</span><span class="op" id="1626698">)</span><span class="op" id="1626699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1626702">}</span><br>
<span class="lineno"></span><span class="op" id="1626704">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1626707">//&nbsp;RUnlock&nbsp;undoes&nbsp;a&nbsp;single&nbsp;RLock&nbsp;call;</span><br>
<span class="lineno">45</span><span class="comment" id="1626746">//&nbsp;it&nbsp;does&nbsp;not&nbsp;affect&nbsp;other&nbsp;simultaneous&nbsp;readers.</span><br>
<span class="lineno"></span><span class="comment" id="1626796">//&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;rw&nbsp;is&nbsp;not&nbsp;locked&nbsp;for&nbsp;reading</span><br>
<span class="lineno"></span><span class="comment" id="1626854">//&nbsp;on&nbsp;entry&nbsp;to&nbsp;RUnlock.</span><br>
<span class="lineno"></span><span class="keyword" id="1626878">func</span>&nbsp;<span class="op" id="1626883">(</span><span class="ident" id="1626884">rw</span>&nbsp;<span class="op" id="1626887">*</span><span class="ident" id="1626888">RWMutex</span><span class="op" id="1626895">)</span>&nbsp;<span class="ident" id="1626897">RUnlock</span><span class="op" id="1626904">(</span><span class="op" id="1626905">)</span>&nbsp;<span class="op" id="1626907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1626910">if</span>&nbsp;<span class="ident" id="1626913">raceenabled</span>&nbsp;<span class="op" id="1626925">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626929">_</span>&nbsp;<span class="op" id="1626931">=</span>&nbsp;<span class="ident" id="1626933">rw</span><span class="op" id="1626935">.</span><span class="ident" id="1626936">w</span><span class="op" id="1626937">.</span><span class="ident" id="1626938">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626946">raceReleaseMerge</span><span class="op" id="1626962">(</span><span class="ident" id="1626963">unsafe</span><span class="op" id="1626969">.</span><span class="ident" id="1626970">Pointer</span><span class="op" id="1626977">(</span><span class="op" id="1626978">&amp;</span><span class="ident" id="1626979">rw</span><span class="op" id="1626981">.</span><span class="ident" id="1626982">writerSem</span><span class="op" id="1626991">)</span><span class="op" id="1626992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626996">raceDisable</span><span class="op" id="1627007">(</span><span class="op" id="1627008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1627011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1627014">if</span>&nbsp;<span class="ident" id="1627017">r</span>&nbsp;<span class="op" id="1627019">:=</span>&nbsp;<span class="ident" id="1627022">atomic</span><span class="op" id="1627028">.</span><span class="ident" id="1627029">AddInt32</span><span class="op" id="1627037">(</span><span class="op" id="1627038">&amp;</span><span class="ident" id="1627039">rw</span><span class="op" id="1627041">.</span><span class="ident" id="1627042">readerCount</span><span class="op" id="1627053">,</span>&nbsp;<span class="op" id="1627055">-</span><span class="num" id="1627056">1</span><span class="op" id="1627057">)</span><span class="op" id="1627058">;</span>&nbsp;<span class="ident" id="1627060">r</span>&nbsp;<span class="op" id="1627062">&lt;</span>&nbsp;<span class="num" id="1627064">0</span>&nbsp;<span class="op" id="1627066">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1627070">if</span>&nbsp;<span class="ident" id="1627073">r</span><span class="op" id="1627074">+</span><span class="num" id="1627075">1</span>&nbsp;<span class="op" id="1627077">==</span>&nbsp;<span class="num" id="1627080">0</span>&nbsp;<span class="op" id="1627082">||</span>&nbsp;<span class="ident" id="1627085">r</span><span class="op" id="1627086">+</span><span class="num" id="1627087">1</span>&nbsp;<span class="op" id="1627089">==</span>&nbsp;<span class="op" id="1627092">-</span><span class="ident" id="1627093">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1627111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627116">raceEnable</span><span class="op" id="1627126">(</span><span class="op" id="1627127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1627132">panic</span><span class="op" id="1627137">(</span><span class="string" id="1627138">&#34;sync:&nbsp;RUnlock&nbsp;of&nbsp;unlocked&nbsp;RWMutex&#34;</span><span class="op" id="1627173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1627177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1627181">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;pending.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1627207">if</span>&nbsp;<span class="ident" id="1627210">atomic</span><span class="op" id="1627216">.</span><span class="ident" id="1627217">AddInt32</span><span class="op" id="1627225">(</span><span class="op" id="1627226">&amp;</span><span class="ident" id="1627227">rw</span><span class="op" id="1627229">.</span><span class="ident" id="1627230">readerWait</span><span class="op" id="1627240">,</span>&nbsp;<span class="op" id="1627242">-</span><span class="num" id="1627243">1</span><span class="op" id="1627244">)</span>&nbsp;<span class="op" id="1627246">==</span>&nbsp;<span class="num" id="1627249">0</span>&nbsp;<span class="op" id="1627251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1627256">//&nbsp;The&nbsp;last&nbsp;reader&nbsp;unblocks&nbsp;the&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627299">runtime_Semrelease</span><span class="op" id="1627317">(</span><span class="op" id="1627318">&amp;</span><span class="ident" id="1627319">rw</span><span class="op" id="1627321">.</span><span class="ident" id="1627322">writerSem</span><span class="op" id="1627331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1627335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1627338">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1627341">if</span>&nbsp;<span class="ident" id="1627344">raceenabled</span>&nbsp;<span class="op" id="1627356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627360">raceEnable</span><span class="op" id="1627370">(</span><span class="op" id="1627371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1627374">}</span><br>
<span class="lineno"></span><span class="op" id="1627376">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="comment" id="1627379">//&nbsp;Lock&nbsp;locks&nbsp;rw&nbsp;for&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="1627409">//&nbsp;If&nbsp;the&nbsp;lock&nbsp;is&nbsp;already&nbsp;locked&nbsp;for&nbsp;reading&nbsp;or&nbsp;writing,</span><br>
<span class="lineno"></span><span class="comment" id="1627466">//&nbsp;Lock&nbsp;blocks&nbsp;until&nbsp;the&nbsp;lock&nbsp;is&nbsp;available.</span><br>
<span class="lineno"></span><span class="comment" id="1627510">//&nbsp;To&nbsp;ensure&nbsp;that&nbsp;the&nbsp;lock&nbsp;eventually&nbsp;becomes&nbsp;available,</span><br>
<span class="lineno"></span><span class="comment" id="1627567">//&nbsp;a&nbsp;blocked&nbsp;Lock&nbsp;call&nbsp;excludes&nbsp;new&nbsp;readers&nbsp;from&nbsp;acquiring</span><br>
<span class="lineno">75</span><span class="comment" id="1627626">//&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="keyword" id="1627639">func</span>&nbsp;<span class="op" id="1627644">(</span><span class="ident" id="1627645">rw</span>&nbsp;<span class="op" id="1627648">*</span><span class="ident" id="1627649">RWMutex</span><span class="op" id="1627656">)</span>&nbsp;<span class="ident" id="1627658">Lock</span><span class="op" id="1627662">(</span><span class="op" id="1627663">)</span>&nbsp;<span class="op" id="1627665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1627668">if</span>&nbsp;<span class="ident" id="1627671">raceenabled</span>&nbsp;<span class="op" id="1627683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627687">_</span>&nbsp;<span class="op" id="1627689">=</span>&nbsp;<span class="ident" id="1627691">rw</span><span class="op" id="1627693">.</span><span class="ident" id="1627694">w</span><span class="op" id="1627695">.</span><span class="ident" id="1627696">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627704">raceDisable</span><span class="op" id="1627715">(</span><span class="op" id="1627716">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1627719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1627722">//&nbsp;First,&nbsp;resolve&nbsp;competition&nbsp;with&nbsp;other&nbsp;writers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627773">rw</span><span class="op" id="1627775">.</span><span class="ident" id="1627776">w</span><span class="op" id="1627777">.</span><span class="ident" id="1627778">Lock</span><span class="op" id="1627782">(</span><span class="op" id="1627783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1627786">//&nbsp;Announce&nbsp;to&nbsp;readers&nbsp;there&nbsp;is&nbsp;a&nbsp;pending&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627837">r</span>&nbsp;<span class="op" id="1627839">:=</span>&nbsp;<span class="ident" id="1627842">atomic</span><span class="op" id="1627848">.</span><span class="ident" id="1627849">AddInt32</span><span class="op" id="1627857">(</span><span class="op" id="1627858">&amp;</span><span class="ident" id="1627859">rw</span><span class="op" id="1627861">.</span><span class="ident" id="1627862">readerCount</span><span class="op" id="1627873">,</span>&nbsp;<span class="op" id="1627875">-</span><span class="ident" id="1627876">rwmutexMaxReaders</span><span class="op" id="1627893">)</span>&nbsp;<span class="op" id="1627895">+</span>&nbsp;<span class="ident" id="1627897">rwmutexMaxReaders</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1627916">//&nbsp;Wait&nbsp;for&nbsp;active&nbsp;readers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1627945">if</span>&nbsp;<span class="ident" id="1627948">r</span>&nbsp;<span class="op" id="1627950">!=</span>&nbsp;<span class="num" id="1627953">0</span>&nbsp;<span class="op" id="1627955">&amp;&amp;</span>&nbsp;<span class="ident" id="1627958">atomic</span><span class="op" id="1627964">.</span><span class="ident" id="1627965">AddInt32</span><span class="op" id="1627973">(</span><span class="op" id="1627974">&amp;</span><span class="ident" id="1627975">rw</span><span class="op" id="1627977">.</span><span class="ident" id="1627978">readerWait</span><span class="op" id="1627988">,</span>&nbsp;<span class="ident" id="1627990">r</span><span class="op" id="1627991">)</span>&nbsp;<span class="op" id="1627993">!=</span>&nbsp;<span class="num" id="1627996">0</span>&nbsp;<span class="op" id="1627998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628002">runtime_Semacquire</span><span class="op" id="1628020">(</span><span class="op" id="1628021">&amp;</span><span class="ident" id="1628022">rw</span><span class="op" id="1628024">.</span><span class="ident" id="1628025">writerSem</span><span class="op" id="1628034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1628037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1628040">if</span>&nbsp;<span class="ident" id="1628043">raceenabled</span>&nbsp;<span class="op" id="1628055">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628059">raceEnable</span><span class="op" id="1628069">(</span><span class="op" id="1628070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628074">raceAcquire</span><span class="op" id="1628085">(</span><span class="ident" id="1628086">unsafe</span><span class="op" id="1628092">.</span><span class="ident" id="1628093">Pointer</span><span class="op" id="1628100">(</span><span class="op" id="1628101">&amp;</span><span class="ident" id="1628102">rw</span><span class="op" id="1628104">.</span><span class="ident" id="1628105">readerSem</span><span class="op" id="1628114">)</span><span class="op" id="1628115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628119">raceAcquire</span><span class="op" id="1628130">(</span><span class="ident" id="1628131">unsafe</span><span class="op" id="1628137">.</span><span class="ident" id="1628138">Pointer</span><span class="op" id="1628145">(</span><span class="op" id="1628146">&amp;</span><span class="ident" id="1628147">rw</span><span class="op" id="1628149">.</span><span class="ident" id="1628150">writerSem</span><span class="op" id="1628159">)</span><span class="op" id="1628160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1628163">}</span><br>
<span class="lineno"></span><span class="op" id="1628165">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="1628168">//&nbsp;Unlock&nbsp;unlocks&nbsp;rw&nbsp;for&nbsp;writing.&nbsp;&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;rw&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1628235">//&nbsp;not&nbsp;locked&nbsp;for&nbsp;writing&nbsp;on&nbsp;entry&nbsp;to&nbsp;Unlock.</span><br>
<span class="lineno"></span><span class="comment" id="1628281">//</span><br>
<span class="lineno"></span><span class="comment" id="1628284">//&nbsp;As&nbsp;with&nbsp;Mutexes,&nbsp;a&nbsp;locked&nbsp;RWMutex&nbsp;is&nbsp;not&nbsp;associated&nbsp;with&nbsp;a&nbsp;particular</span><br>
<span class="lineno">100</span><span class="comment" id="1628357">//&nbsp;goroutine.&nbsp;&nbsp;One&nbsp;goroutine&nbsp;may&nbsp;RLock&nbsp;(Lock)&nbsp;an&nbsp;RWMutex&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="1628423">//&nbsp;arrange&nbsp;for&nbsp;another&nbsp;goroutine&nbsp;to&nbsp;RUnlock&nbsp;(Unlock)&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="1628480">func</span>&nbsp;<span class="op" id="1628485">(</span><span class="ident" id="1628486">rw</span>&nbsp;<span class="op" id="1628489">*</span><span class="ident" id="1628490">RWMutex</span><span class="op" id="1628497">)</span>&nbsp;<span class="ident" id="1628499">Unlock</span><span class="op" id="1628505">(</span><span class="op" id="1628506">)</span>&nbsp;<span class="op" id="1628508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1628511">if</span>&nbsp;<span class="ident" id="1628514">raceenabled</span>&nbsp;<span class="op" id="1628526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628530">_</span>&nbsp;<span class="op" id="1628532">=</span>&nbsp;<span class="ident" id="1628534">rw</span><span class="op" id="1628536">.</span><span class="ident" id="1628537">w</span><span class="op" id="1628538">.</span><span class="ident" id="1628539">state</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628547">raceRelease</span><span class="op" id="1628558">(</span><span class="ident" id="1628559">unsafe</span><span class="op" id="1628565">.</span><span class="ident" id="1628566">Pointer</span><span class="op" id="1628573">(</span><span class="op" id="1628574">&amp;</span><span class="ident" id="1628575">rw</span><span class="op" id="1628577">.</span><span class="ident" id="1628578">readerSem</span><span class="op" id="1628587">)</span><span class="op" id="1628588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628592">raceRelease</span><span class="op" id="1628603">(</span><span class="ident" id="1628604">unsafe</span><span class="op" id="1628610">.</span><span class="ident" id="1628611">Pointer</span><span class="op" id="1628618">(</span><span class="op" id="1628619">&amp;</span><span class="ident" id="1628620">rw</span><span class="op" id="1628622">.</span><span class="ident" id="1628623">writerSem</span><span class="op" id="1628632">)</span><span class="op" id="1628633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628637">raceDisable</span><span class="op" id="1628648">(</span><span class="op" id="1628649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1628652">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1628656">//&nbsp;Announce&nbsp;to&nbsp;readers&nbsp;there&nbsp;is&nbsp;no&nbsp;active&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628707">r</span>&nbsp;<span class="op" id="1628709">:=</span>&nbsp;<span class="ident" id="1628712">atomic</span><span class="op" id="1628718">.</span><span class="ident" id="1628719">AddInt32</span><span class="op" id="1628727">(</span><span class="op" id="1628728">&amp;</span><span class="ident" id="1628729">rw</span><span class="op" id="1628731">.</span><span class="ident" id="1628732">readerCount</span><span class="op" id="1628743">,</span>&nbsp;<span class="ident" id="1628745">rwmutexMaxReaders</span><span class="op" id="1628762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1628765">if</span>&nbsp;<span class="ident" id="1628768">r</span>&nbsp;<span class="op" id="1628770">&gt;=</span>&nbsp;<span class="ident" id="1628773">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1628791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628795">raceEnable</span><span class="op" id="1628805">(</span><span class="op" id="1628806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1628810">panic</span><span class="op" id="1628815">(</span><span class="string" id="1628816">&#34;sync:&nbsp;Unlock&nbsp;of&nbsp;unlocked&nbsp;RWMutex&#34;</span><span class="op" id="1628850">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1628853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1628856">//&nbsp;Unblock&nbsp;blocked&nbsp;readers,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1628893">for</span>&nbsp;<span class="ident" id="1628897">i</span>&nbsp;<span class="op" id="1628899">:=</span>&nbsp;<span class="num" id="1628902">0</span><span class="op" id="1628903">;</span>&nbsp;<span class="ident" id="1628905">i</span>&nbsp;<span class="op" id="1628907">&lt;</span>&nbsp;<span class="builtintype" id="1628909">int</span><span class="op" id="1628912">(</span><span class="ident" id="1628913">r</span><span class="op" id="1628914">)</span><span class="op" id="1628915">;</span>&nbsp;<span class="ident" id="1628917">i</span><span class="op" id="1628918">++</span>&nbsp;<span class="op" id="1628921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628925">runtime_Semrelease</span><span class="op" id="1628943">(</span><span class="op" id="1628944">&amp;</span><span class="ident" id="1628945">rw</span><span class="op" id="1628947">.</span><span class="ident" id="1628948">readerSem</span><span class="op" id="1628957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1628960">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1628963">//&nbsp;Allow&nbsp;other&nbsp;writers&nbsp;to&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628999">rw</span><span class="op" id="1629001">.</span><span class="ident" id="1629002">w</span><span class="op" id="1629003">.</span><span class="ident" id="1629004">Unlock</span><span class="op" id="1629010">(</span><span class="op" id="1629011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1629014">if</span>&nbsp;<span class="ident" id="1629017">raceenabled</span>&nbsp;<span class="op" id="1629029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629033">raceEnable</span><span class="op" id="1629043">(</span><span class="op" id="1629044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1629047">}</span><br>
<span class="lineno">125</span><span class="op" id="1629049">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1629052">//&nbsp;RLocker&nbsp;returns&nbsp;a&nbsp;Locker&nbsp;interface&nbsp;that&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1629106">//&nbsp;the&nbsp;Lock&nbsp;and&nbsp;Unlock&nbsp;methods&nbsp;by&nbsp;calling&nbsp;rw.RLock&nbsp;and&nbsp;rw.RUnlock.</span><br>
<span class="lineno"></span><span class="keyword" id="1629173">func</span>&nbsp;<span class="op" id="1629178">(</span><span class="ident" id="1629179">rw</span>&nbsp;<span class="op" id="1629182">*</span><span class="ident" id="1629183">RWMutex</span><span class="op" id="1629190">)</span>&nbsp;<span class="ident" id="1629192">RLocker</span><span class="op" id="1629199">(</span><span class="op" id="1629200">)</span>&nbsp;<span class="ident" id="1629202">Locker</span>&nbsp;<span class="op" id="1629209">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1629212">return</span>&nbsp;<span class="op" id="1629219">(</span><span class="op" id="1629220">*</span><span class="ident" id="1629221">rlocker</span><span class="op" id="1629228">)</span><span class="op" id="1629229">(</span><span class="ident" id="1629230">rw</span><span class="op" id="1629232">)</span><br>
<span class="lineno"></span><span class="op" id="1629234">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1629237">type</span>&nbsp;<span class="ident" id="1629242">rlocker</span>&nbsp;<span class="ident" id="1629250">RWMutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="1629259">func</span>&nbsp;<span class="op" id="1629264">(</span><span class="ident" id="1629265">r</span>&nbsp;<span class="op" id="1629267">*</span><span class="ident" id="1629268">rlocker</span><span class="op" id="1629275">)</span>&nbsp;<span class="ident" id="1629277">Lock</span><span class="op" id="1629281">(</span><span class="op" id="1629282">)</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1629286">{</span>&nbsp;<span class="op" id="1629288">(</span><span class="op" id="1629289">*</span><span class="ident" id="1629290">RWMutex</span><span class="op" id="1629297">)</span><span class="op" id="1629298">(</span><span class="ident" id="1629299">r</span><span class="op" id="1629300">)</span><span class="op" id="1629301">.</span><span class="ident" id="1629302">RLock</span><span class="op" id="1629307">(</span><span class="op" id="1629308">)</span>&nbsp;<span class="op" id="1629310">}</span><br>
<span class="lineno"></span><span class="keyword" id="1629312">func</span>&nbsp;<span class="op" id="1629317">(</span><span class="ident" id="1629318">r</span>&nbsp;<span class="op" id="1629320">*</span><span class="ident" id="1629321">rlocker</span><span class="op" id="1629328">)</span>&nbsp;<span class="ident" id="1629330">Unlock</span><span class="op" id="1629336">(</span><span class="op" id="1629337">)</span>&nbsp;<span class="op" id="1629339">{</span>&nbsp;<span class="op" id="1629341">(</span><span class="op" id="1629342">*</span><span class="ident" id="1629343">RWMutex</span><span class="op" id="1629350">)</span><span class="op" id="1629351">(</span><span class="ident" id="1629352">r</span><span class="op" id="1629353">)</span><span class="op" id="1629354">.</span><span class="ident" id="1629355">RUnlock</span><span class="op" id="1629362">(</span><span class="op" id="1629363">)</span>&nbsp;<span class="op" id="1629365">}</span>
</div>
</body>
</html>
