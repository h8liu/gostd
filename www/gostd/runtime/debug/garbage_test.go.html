<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime/debug</h2>
<ul>
<li><a href="/gostd/runtime/debug/garbage.go.html">garbage.go</a></li>
<li><a href="/gostd/runtime/debug/garbage_test.go.html" class="current">garbage_test.go</a></li>
<li><a href="/gostd/runtime/debug/heapdump_test.go.html">heapdump_test.go</a></li>
<li><a href="/gostd/runtime/debug/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/debug/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/debug/stubs.go.html">stubs.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6954291">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6954347">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6954401">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6954452">package</span>&nbsp;<span class="ident" id="6954460">debug</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6954467">import</span>&nbsp;<span class="op" id="6954474">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6954477">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6954488">&#34;testing&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6954499">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6954506">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6954509">func</span>&nbsp;<span class="ident" id="6954514">TestReadGCStats</span><span class="op" id="6954529">(</span><span class="ident" id="6954530">t</span>&nbsp;<span class="op" id="6954532">*</span><span class="ident" id="6954533">testing</span><span class="op" id="6954540">.</span><span class="ident" id="6954541">T</span><span class="op" id="6954542">)</span>&nbsp;<span class="op" id="6954544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6954547">defer</span>&nbsp;<span class="ident" id="6954553">SetGCPercent</span><span class="op" id="6954565">(</span><span class="ident" id="6954566">SetGCPercent</span><span class="op" id="6954578">(</span><span class="op" id="6954579">-</span><span class="num" id="6954580">1</span><span class="op" id="6954581">)</span><span class="op" id="6954582">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6954586">var</span>&nbsp;<span class="ident" id="6954590">stats</span>&nbsp;<span class="ident" id="6954596">GCStats</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6954605">var</span>&nbsp;<span class="ident" id="6954609">mstats</span>&nbsp;<span class="ident" id="6954616">runtime</span><span class="op" id="6954623">.</span><span class="ident" id="6954624">MemStats</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6954634">var</span>&nbsp;<span class="ident" id="6954638">min</span><span class="op" id="6954641">,</span>&nbsp;<span class="ident" id="6954643">max</span>&nbsp;<span class="ident" id="6954647">time</span><span class="op" id="6954651">.</span><span class="ident" id="6954652">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6954663">//&nbsp;First&nbsp;ReadGCStats&nbsp;will&nbsp;allocate,&nbsp;second&nbsp;should&nbsp;not,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6954719">//&nbsp;especially&nbsp;if&nbsp;we&nbsp;follow&nbsp;up&nbsp;with&nbsp;an&nbsp;explicit&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6954787">stats</span><span class="op" id="6954792">.</span><span class="ident" id="6954793">PauseQuantiles</span>&nbsp;<span class="op" id="6954808">=</span>&nbsp;<span class="builtinfunc" id="6954810">make</span><span class="op" id="6954814">(</span><span class="op" id="6954815">[</span><span class="op" id="6954816">]</span><span class="ident" id="6954817">time</span><span class="op" id="6954821">.</span><span class="ident" id="6954822">Duration</span><span class="op" id="6954830">,</span>&nbsp;<span class="num" id="6954832">10</span><span class="op" id="6954834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6954837">ReadGCStats</span><span class="op" id="6954848">(</span><span class="op" id="6954849">&amp;</span><span class="ident" id="6954850">stats</span><span class="op" id="6954855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6954858">runtime</span><span class="op" id="6954865">.</span><span class="ident" id="6954866">GC</span><span class="op" id="6954868">(</span><span class="op" id="6954869">)</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6954873">//&nbsp;Assume&nbsp;these&nbsp;will&nbsp;return&nbsp;same&nbsp;data:&nbsp;no&nbsp;GC&nbsp;during&nbsp;ReadGCStats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6954939">ReadGCStats</span><span class="op" id="6954950">(</span><span class="op" id="6954951">&amp;</span><span class="ident" id="6954952">stats</span><span class="op" id="6954957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6954960">runtime</span><span class="op" id="6954967">.</span><span class="ident" id="6954968">ReadMemStats</span><span class="op" id="6954980">(</span><span class="op" id="6954981">&amp;</span><span class="ident" id="6954982">mstats</span><span class="op" id="6954988">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6954992">if</span>&nbsp;<span class="ident" id="6954995">stats</span><span class="op" id="6955000">.</span><span class="ident" id="6955001">NumGC</span>&nbsp;<span class="op" id="6955007">!=</span>&nbsp;<span class="ident" id="6955010">int64</span><span class="op" id="6955015">(</span><span class="ident" id="6955016">mstats</span><span class="op" id="6955022">.</span><span class="ident" id="6955023">NumGC</span><span class="op" id="6955028">)</span>&nbsp;<span class="op" id="6955030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6955034">t</span><span class="op" id="6955035">.</span><span class="ident" id="6955036">Errorf</span><span class="op" id="6955042">(</span><span class="string" id="6955043">&#34;stats.NumGC&nbsp;=&nbsp;%d,&nbsp;but&nbsp;mstats.NumGC&nbsp;=&nbsp;%d&#34;</span><span class="op" id="6955084">,</span>&nbsp;<span class="ident" id="6955086">stats</span><span class="op" id="6955091">.</span><span class="ident" id="6955092">NumGC</span><span class="op" id="6955097">,</span>&nbsp;<span class="ident" id="6955099">mstats</span><span class="op" id="6955105">.</span><span class="ident" id="6955106">NumGC</span><span class="op" id="6955111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6955114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6955117">if</span>&nbsp;<span class="ident" id="6955120">stats</span><span class="op" id="6955125">.</span><span class="ident" id="6955126">PauseTotal</span>&nbsp;<span class="op" id="6955137">!=</span>&nbsp;<span class="ident" id="6955140">time</span><span class="op" id="6955144">.</span><span class="ident" id="6955145">Duration</span><span class="op" id="6955153">(</span><span class="ident" id="6955154">mstats</span><span class="op" id="6955160">.</span><span class="ident" id="6955161">PauseTotalNs</span><span class="op" id="6955173">)</span>&nbsp;<span class="op" id="6955175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6955179">t</span><span class="op" id="6955180">.</span><span class="ident" id="6955181">Errorf</span><span class="op" id="6955187">(</span><span class="string" id="6955188">&#34;stats.PauseTotal&nbsp;=&nbsp;%d,&nbsp;but&nbsp;mstats.PauseTotalNs&nbsp;=&nbsp;%d&#34;</span><span class="op" id="6955241">,</span>&nbsp;<span class="ident" id="6955243">stats</span><span class="op" id="6955248">.</span><span class="ident" id="6955249">PauseTotal</span><span class="op" id="6955259">,</span>&nbsp;<span class="ident" id="6955261">mstats</span><span class="op" id="6955267">.</span><span class="ident" id="6955268">PauseTotalNs</span><span class="op" id="6955280">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6955283">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6955286">if</span>&nbsp;<span class="ident" id="6955289">stats</span><span class="op" id="6955294">.</span><span class="ident" id="6955295">LastGC</span><span class="op" id="6955301">.</span><span class="ident" id="6955302">UnixNano</span><span class="op" id="6955310">(</span><span class="op" id="6955311">)</span>&nbsp;<span class="op" id="6955313">!=</span>&nbsp;<span class="ident" id="6955316">int64</span><span class="op" id="6955321">(</span><span class="ident" id="6955322">mstats</span><span class="op" id="6955328">.</span><span class="ident" id="6955329">LastGC</span><span class="op" id="6955335">)</span>&nbsp;<span class="op" id="6955337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6955341">t</span><span class="op" id="6955342">.</span><span class="ident" id="6955343">Errorf</span><span class="op" id="6955349">(</span><span class="string" id="6955350">&#34;stats.LastGC.UnixNano&nbsp;=&nbsp;%d,&nbsp;but&nbsp;mstats.LastGC&nbsp;=&nbsp;%d&#34;</span><span class="op" id="6955402">,</span>&nbsp;<span class="ident" id="6955404">stats</span><span class="op" id="6955409">.</span><span class="ident" id="6955410">LastGC</span><span class="op" id="6955416">.</span><span class="ident" id="6955417">UnixNano</span><span class="op" id="6955425">(</span><span class="op" id="6955426">)</span><span class="op" id="6955427">,</span>&nbsp;<span class="ident" id="6955429">mstats</span><span class="op" id="6955435">.</span><span class="ident" id="6955436">LastGC</span><span class="op" id="6955442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6955445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6955448">n</span>&nbsp;<span class="op" id="6955450">:=</span>&nbsp;<span class="builtintype" id="6955453">int</span><span class="op" id="6955456">(</span><span class="ident" id="6955457">mstats</span><span class="op" id="6955463">.</span><span class="ident" id="6955464">NumGC</span><span class="op" id="6955469">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6955472">if</span>&nbsp;<span class="ident" id="6955475">n</span>&nbsp;<span class="op" id="6955477">&gt;</span>&nbsp;<span class="builtinfunc" id="6955479">len</span><span class="op" id="6955482">(</span><span class="ident" id="6955483">mstats</span><span class="op" id="6955489">.</span><span class="ident" id="6955490">PauseNs</span><span class="op" id="6955497">)</span>&nbsp;<span class="op" id="6955499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6955503">n</span>&nbsp;<span class="op" id="6955505">=</span>&nbsp;<span class="builtinfunc" id="6955507">len</span><span class="op" id="6955510">(</span><span class="ident" id="6955511">mstats</span><span class="op" id="6955517">.</span><span class="ident" id="6955518">PauseNs</span><span class="op" id="6955525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6955528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6955531">if</span>&nbsp;<span class="builtinfunc" id="6955534">len</span><span class="op" id="6955537">(</span><span class="ident" id="6955538">stats</span><span class="op" id="6955543">.</span><span class="ident" id="6955544">Pause</span><span class="op" id="6955549">)</span>&nbsp;<span class="op" id="6955551">!=</span>&nbsp;<span class="ident" id="6955554">n</span>&nbsp;<span class="op" id="6955556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6955560">t</span><span class="op" id="6955561">.</span><span class="ident" id="6955562">Errorf</span><span class="op" id="6955568">(</span><span class="string" id="6955569">&#34;len(stats.Pause)&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6955601">,</span>&nbsp;<span class="builtinfunc" id="6955603">len</span><span class="op" id="6955606">(</span><span class="ident" id="6955607">stats</span><span class="op" id="6955612">.</span><span class="ident" id="6955613">Pause</span><span class="op" id="6955618">)</span><span class="op" id="6955619">,</span>&nbsp;<span class="ident" id="6955621">n</span><span class="op" id="6955622">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6955625">}</span>&nbsp;<span class="keyword" id="6955627">else</span>&nbsp;<span class="op" id="6955632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6955636">off</span>&nbsp;<span class="op" id="6955640">:=</span>&nbsp;<span class="op" id="6955643">(</span><span class="builtintype" id="6955644">int</span><span class="op" id="6955647">(</span><span class="ident" id="6955648">mstats</span><span class="op" id="6955654">.</span><span class="ident" id="6955655">NumGC</span><span class="op" id="6955660">)</span>&nbsp;<span class="op" id="6955662">+</span>&nbsp;<span class="builtinfunc" id="6955664">len</span><span class="op" id="6955667">(</span><span class="ident" id="6955668">mstats</span><span class="op" id="6955674">.</span><span class="ident" id="6955675">PauseNs</span><span class="op" id="6955682">)</span>&nbsp;<span class="op" id="6955684">-</span>&nbsp;<span class="num" id="6955686">1</span><span class="op" id="6955687">)</span>&nbsp;<span class="op" id="6955689">%</span>&nbsp;<span class="builtinfunc" id="6955691">len</span><span class="op" id="6955694">(</span><span class="ident" id="6955695">mstats</span><span class="op" id="6955701">.</span><span class="ident" id="6955702">PauseNs</span><span class="op" id="6955709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6955713">for</span>&nbsp;<span class="ident" id="6955717">i</span>&nbsp;<span class="op" id="6955719">:=</span>&nbsp;<span class="num" id="6955722">0</span><span class="op" id="6955723">;</span>&nbsp;<span class="ident" id="6955725">i</span>&nbsp;<span class="op" id="6955727">&lt;</span>&nbsp;<span class="ident" id="6955729">n</span><span class="op" id="6955730">;</span>&nbsp;<span class="ident" id="6955732">i</span><span class="op" id="6955733">++</span>&nbsp;<span class="op" id="6955736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6955741">dt</span>&nbsp;<span class="op" id="6955744">:=</span>&nbsp;<span class="ident" id="6955747">stats</span><span class="op" id="6955752">.</span><span class="ident" id="6955753">Pause</span><span class="op" id="6955758">[</span><span class="ident" id="6955759">i</span><span class="op" id="6955760">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6955765">if</span>&nbsp;<span class="ident" id="6955768">dt</span>&nbsp;<span class="op" id="6955771">!=</span>&nbsp;<span class="ident" id="6955774">time</span><span class="op" id="6955778">.</span><span class="ident" id="6955779">Duration</span><span class="op" id="6955787">(</span><span class="ident" id="6955788">mstats</span><span class="op" id="6955794">.</span><span class="ident" id="6955795">PauseNs</span><span class="op" id="6955802">[</span><span class="ident" id="6955803">off</span><span class="op" id="6955806">]</span><span class="op" id="6955807">)</span>&nbsp;<span class="op" id="6955809">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6955815">t</span><span class="op" id="6955816">.</span><span class="ident" id="6955817">Errorf</span><span class="op" id="6955823">(</span><span class="string" id="6955824">&#34;stats.Pause[%d]&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6955855">,</span>&nbsp;<span class="ident" id="6955857">i</span><span class="op" id="6955858">,</span>&nbsp;<span class="ident" id="6955860">dt</span><span class="op" id="6955862">,</span>&nbsp;<span class="ident" id="6955864">mstats</span><span class="op" id="6955870">.</span><span class="ident" id="6955871">PauseNs</span><span class="op" id="6955878">[</span><span class="ident" id="6955879">off</span><span class="op" id="6955882">]</span><span class="op" id="6955883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6955888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6955893">if</span>&nbsp;<span class="ident" id="6955896">max</span>&nbsp;<span class="op" id="6955900">&lt;</span>&nbsp;<span class="ident" id="6955902">dt</span>&nbsp;<span class="op" id="6955905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6955911">max</span>&nbsp;<span class="op" id="6955915">=</span>&nbsp;<span class="ident" id="6955917">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6955923">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6955928">if</span>&nbsp;<span class="ident" id="6955931">min</span>&nbsp;<span class="op" id="6955935">&gt;</span>&nbsp;<span class="ident" id="6955937">dt</span>&nbsp;<span class="op" id="6955940">||</span>&nbsp;<span class="ident" id="6955943">i</span>&nbsp;<span class="op" id="6955945">==</span>&nbsp;<span class="num" id="6955948">0</span>&nbsp;<span class="op" id="6955950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6955956">min</span>&nbsp;<span class="op" id="6955960">=</span>&nbsp;<span class="ident" id="6955962">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6955968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6955973">off</span>&nbsp;<span class="op" id="6955977">=</span>&nbsp;<span class="op" id="6955979">(</span><span class="ident" id="6955980">off</span>&nbsp;<span class="op" id="6955984">+</span>&nbsp;<span class="builtinfunc" id="6955986">len</span><span class="op" id="6955989">(</span><span class="ident" id="6955990">mstats</span><span class="op" id="6955996">.</span><span class="ident" id="6955997">PauseNs</span><span class="op" id="6956004">)</span>&nbsp;<span class="op" id="6956006">-</span>&nbsp;<span class="num" id="6956008">1</span><span class="op" id="6956009">)</span>&nbsp;<span class="op" id="6956011">%</span>&nbsp;<span class="builtinfunc" id="6956013">len</span><span class="op" id="6956016">(</span><span class="ident" id="6956017">mstats</span><span class="op" id="6956023">.</span><span class="ident" id="6956024">PauseNs</span><span class="op" id="6956031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6956035">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6956038">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6956042">q</span>&nbsp;<span class="op" id="6956044">:=</span>&nbsp;<span class="ident" id="6956047">stats</span><span class="op" id="6956052">.</span><span class="ident" id="6956053">PauseQuantiles</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6956069">nq</span>&nbsp;<span class="op" id="6956072">:=</span>&nbsp;<span class="builtinfunc" id="6956075">len</span><span class="op" id="6956078">(</span><span class="ident" id="6956079">q</span><span class="op" id="6956080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6956083">if</span>&nbsp;<span class="ident" id="6956086">q</span><span class="op" id="6956087">[</span><span class="num" id="6956088">0</span><span class="op" id="6956089">]</span>&nbsp;<span class="op" id="6956091">!=</span>&nbsp;<span class="ident" id="6956094">min</span>&nbsp;<span class="op" id="6956098">||</span>&nbsp;<span class="ident" id="6956101">q</span><span class="op" id="6956102">[</span><span class="ident" id="6956103">nq</span><span class="op" id="6956105">-</span><span class="num" id="6956106">1</span><span class="op" id="6956107">]</span>&nbsp;<span class="op" id="6956109">!=</span>&nbsp;<span class="ident" id="6956112">max</span>&nbsp;<span class="op" id="6956116">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6956120">t</span><span class="op" id="6956121">.</span><span class="ident" id="6956122">Errorf</span><span class="op" id="6956128">(</span><span class="string" id="6956129">&#34;stats.PauseQuantiles&nbsp;=&nbsp;[%d,&nbsp;...,&nbsp;%d],&nbsp;want&nbsp;[%d,&nbsp;...,&nbsp;%d]&#34;</span><span class="op" id="6956187">,</span>&nbsp;<span class="ident" id="6956189">q</span><span class="op" id="6956190">[</span><span class="num" id="6956191">0</span><span class="op" id="6956192">]</span><span class="op" id="6956193">,</span>&nbsp;<span class="ident" id="6956195">q</span><span class="op" id="6956196">[</span><span class="ident" id="6956197">nq</span><span class="op" id="6956199">-</span><span class="num" id="6956200">1</span><span class="op" id="6956201">]</span><span class="op" id="6956202">,</span>&nbsp;<span class="ident" id="6956204">min</span><span class="op" id="6956207">,</span>&nbsp;<span class="ident" id="6956209">max</span><span class="op" id="6956212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6956215">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6956219">for</span>&nbsp;<span class="ident" id="6956223">i</span>&nbsp;<span class="op" id="6956225">:=</span>&nbsp;<span class="num" id="6956228">0</span><span class="op" id="6956229">;</span>&nbsp;<span class="ident" id="6956231">i</span>&nbsp;<span class="op" id="6956233">&lt;</span>&nbsp;<span class="ident" id="6956235">nq</span><span class="op" id="6956237">-</span><span class="num" id="6956238">1</span><span class="op" id="6956239">;</span>&nbsp;<span class="ident" id="6956241">i</span><span class="op" id="6956242">++</span>&nbsp;<span class="op" id="6956245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6956249">if</span>&nbsp;<span class="ident" id="6956252">q</span><span class="op" id="6956253">[</span><span class="ident" id="6956254">i</span><span class="op" id="6956255">]</span>&nbsp;<span class="op" id="6956257">&gt;</span>&nbsp;<span class="ident" id="6956259">q</span><span class="op" id="6956260">[</span><span class="ident" id="6956261">i</span><span class="op" id="6956262">+</span><span class="num" id="6956263">1</span><span class="op" id="6956264">]</span>&nbsp;<span class="op" id="6956266">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6956271">t</span><span class="op" id="6956272">.</span><span class="ident" id="6956273">Errorf</span><span class="op" id="6956279">(</span><span class="string" id="6956280">&#34;stats.PauseQuantiles[%d]=%d&nbsp;&gt;&nbsp;stats.PauseQuantiles[%d]=%d&#34;</span><span class="op" id="6956339">,</span>&nbsp;<span class="ident" id="6956341">i</span><span class="op" id="6956342">,</span>&nbsp;<span class="ident" id="6956344">q</span><span class="op" id="6956345">[</span><span class="ident" id="6956346">i</span><span class="op" id="6956347">]</span><span class="op" id="6956348">,</span>&nbsp;<span class="ident" id="6956350">i</span><span class="op" id="6956351">+</span><span class="num" id="6956352">1</span><span class="op" id="6956353">,</span>&nbsp;<span class="ident" id="6956355">q</span><span class="op" id="6956356">[</span><span class="ident" id="6956357">i</span><span class="op" id="6956358">+</span><span class="num" id="6956359">1</span><span class="op" id="6956360">]</span><span class="op" id="6956361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6956365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6956368">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6956372">//&nbsp;compare&nbsp;memory&nbsp;stats&nbsp;with&nbsp;gc&nbsp;stats:</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6956412">if</span>&nbsp;<span class="builtinfunc" id="6956415">len</span><span class="op" id="6956418">(</span><span class="ident" id="6956419">stats</span><span class="op" id="6956424">.</span><span class="ident" id="6956425">PauseEnd</span><span class="op" id="6956433">)</span>&nbsp;<span class="op" id="6956435">!=</span>&nbsp;<span class="ident" id="6956438">n</span>&nbsp;<span class="op" id="6956440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6956444">t</span><span class="op" id="6956445">.</span><span class="ident" id="6956446">Fatalf</span><span class="op" id="6956452">(</span><span class="string" id="6956453">&#34;len(stats.PauseEnd)&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6956488">,</span>&nbsp;<span class="builtinfunc" id="6956490">len</span><span class="op" id="6956493">(</span><span class="ident" id="6956494">stats</span><span class="op" id="6956499">.</span><span class="ident" id="6956500">PauseEnd</span><span class="op" id="6956508">)</span><span class="op" id="6956509">,</span>&nbsp;<span class="ident" id="6956511">n</span><span class="op" id="6956512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6956515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6956518">off</span>&nbsp;<span class="op" id="6956522">:=</span>&nbsp;<span class="op" id="6956525">(</span><span class="builtintype" id="6956526">int</span><span class="op" id="6956529">(</span><span class="ident" id="6956530">mstats</span><span class="op" id="6956536">.</span><span class="ident" id="6956537">NumGC</span><span class="op" id="6956542">)</span>&nbsp;<span class="op" id="6956544">+</span>&nbsp;<span class="builtinfunc" id="6956546">len</span><span class="op" id="6956549">(</span><span class="ident" id="6956550">mstats</span><span class="op" id="6956556">.</span><span class="ident" id="6956557">PauseEnd</span><span class="op" id="6956565">)</span>&nbsp;<span class="op" id="6956567">-</span>&nbsp;<span class="num" id="6956569">1</span><span class="op" id="6956570">)</span>&nbsp;<span class="op" id="6956572">%</span>&nbsp;<span class="builtinfunc" id="6956574">len</span><span class="op" id="6956577">(</span><span class="ident" id="6956578">mstats</span><span class="op" id="6956584">.</span><span class="ident" id="6956585">PauseEnd</span><span class="op" id="6956593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6956596">for</span>&nbsp;<span class="ident" id="6956600">i</span>&nbsp;<span class="op" id="6956602">:=</span>&nbsp;<span class="num" id="6956605">0</span><span class="op" id="6956606">;</span>&nbsp;<span class="ident" id="6956608">i</span>&nbsp;<span class="op" id="6956610">&lt;</span>&nbsp;<span class="ident" id="6956612">n</span><span class="op" id="6956613">;</span>&nbsp;<span class="ident" id="6956615">i</span><span class="op" id="6956616">++</span>&nbsp;<span class="op" id="6956619">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6956623">dt</span>&nbsp;<span class="op" id="6956626">:=</span>&nbsp;<span class="ident" id="6956629">stats</span><span class="op" id="6956634">.</span><span class="ident" id="6956635">PauseEnd</span><span class="op" id="6956643">[</span><span class="ident" id="6956644">i</span><span class="op" id="6956645">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6956649">if</span>&nbsp;<span class="ident" id="6956652">dt</span><span class="op" id="6956654">.</span><span class="ident" id="6956655">UnixNano</span><span class="op" id="6956663">(</span><span class="op" id="6956664">)</span>&nbsp;<span class="op" id="6956666">!=</span>&nbsp;<span class="ident" id="6956669">int64</span><span class="op" id="6956674">(</span><span class="ident" id="6956675">mstats</span><span class="op" id="6956681">.</span><span class="ident" id="6956682">PauseEnd</span><span class="op" id="6956690">[</span><span class="ident" id="6956691">off</span><span class="op" id="6956694">]</span><span class="op" id="6956695">)</span>&nbsp;<span class="op" id="6956697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6956702">t</span><span class="op" id="6956703">.</span><span class="ident" id="6956704">Errorf</span><span class="op" id="6956710">(</span><span class="string" id="6956711">&#34;stats.PauseEnd[%d]&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6956745">,</span>&nbsp;<span class="ident" id="6956747">i</span><span class="op" id="6956748">,</span>&nbsp;<span class="ident" id="6956750">dt</span><span class="op" id="6956752">,</span>&nbsp;<span class="ident" id="6956754">mstats</span><span class="op" id="6956760">.</span><span class="ident" id="6956761">PauseEnd</span><span class="op" id="6956769">[</span><span class="ident" id="6956770">off</span><span class="op" id="6956773">]</span><span class="op" id="6956774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6956778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6956782">off</span>&nbsp;<span class="op" id="6956786">=</span>&nbsp;<span class="op" id="6956788">(</span><span class="ident" id="6956789">off</span>&nbsp;<span class="op" id="6956793">+</span>&nbsp;<span class="builtinfunc" id="6956795">len</span><span class="op" id="6956798">(</span><span class="ident" id="6956799">mstats</span><span class="op" id="6956805">.</span><span class="ident" id="6956806">PauseEnd</span><span class="op" id="6956814">)</span>&nbsp;<span class="op" id="6956816">-</span>&nbsp;<span class="num" id="6956818">1</span><span class="op" id="6956819">)</span>&nbsp;<span class="op" id="6956821">%</span>&nbsp;<span class="builtinfunc" id="6956823">len</span><span class="op" id="6956826">(</span><span class="ident" id="6956827">mstats</span><span class="op" id="6956833">.</span><span class="ident" id="6956834">PauseEnd</span><span class="op" id="6956842">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6956845">}</span><br>
<span class="lineno"></span><span class="op" id="6956847">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6956850">var</span>&nbsp;<span class="ident" id="6956854">big</span>&nbsp;<span class="op" id="6956858">=</span>&nbsp;<span class="builtinfunc" id="6956860">make</span><span class="op" id="6956864">(</span><span class="op" id="6956865">[</span><span class="op" id="6956866">]</span><span class="builtintype" id="6956867">byte</span><span class="op" id="6956871">,</span>&nbsp;<span class="num" id="6956873">1</span><span class="op" id="6956874">&lt;&lt;</span><span class="num" id="6956876">20</span><span class="op" id="6956878">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="6956881">func</span>&nbsp;<span class="ident" id="6956886">TestFreeOSMemory</span><span class="op" id="6956902">(</span><span class="ident" id="6956903">t</span>&nbsp;<span class="op" id="6956905">*</span><span class="ident" id="6956906">testing</span><span class="op" id="6956913">.</span><span class="ident" id="6956914">T</span><span class="op" id="6956915">)</span>&nbsp;<span class="op" id="6956917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6956920">var</span>&nbsp;<span class="ident" id="6956924">ms1</span><span class="op" id="6956927">,</span>&nbsp;<span class="ident" id="6956929">ms2</span>&nbsp;<span class="ident" id="6956933">runtime</span><span class="op" id="6956940">.</span><span class="ident" id="6956941">MemStats</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6956952">if</span>&nbsp;<span class="ident" id="6956955">big</span>&nbsp;<span class="op" id="6956959">==</span>&nbsp;<span class="ident" id="6956962">nil</span>&nbsp;<span class="op" id="6956966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6956970">t</span><span class="op" id="6956971">.</span><span class="ident" id="6956972">Skip</span><span class="op" id="6956976">(</span><span class="string" id="6956977">&#34;test&nbsp;is&nbsp;not&nbsp;reliable&nbsp;when&nbsp;run&nbsp;multiple&nbsp;times&#34;</span><span class="op" id="6957023">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6957026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6957029">big</span>&nbsp;<span class="op" id="6957033">=</span>&nbsp;<span class="ident" id="6957035">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6957040">runtime</span><span class="op" id="6957047">.</span><span class="ident" id="6957048">GC</span><span class="op" id="6957050">(</span><span class="op" id="6957051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6957054">runtime</span><span class="op" id="6957061">.</span><span class="ident" id="6957062">ReadMemStats</span><span class="op" id="6957074">(</span><span class="op" id="6957075">&amp;</span><span class="ident" id="6957076">ms1</span><span class="op" id="6957079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6957082">FreeOSMemory</span><span class="op" id="6957094">(</span><span class="op" id="6957095">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6957098">runtime</span><span class="op" id="6957105">.</span><span class="ident" id="6957106">ReadMemStats</span><span class="op" id="6957118">(</span><span class="op" id="6957119">&amp;</span><span class="ident" id="6957120">ms2</span><span class="op" id="6957123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6957126">if</span>&nbsp;<span class="ident" id="6957129">ms1</span><span class="op" id="6957132">.</span><span class="ident" id="6957133">HeapReleased</span>&nbsp;<span class="op" id="6957146">&gt;=</span>&nbsp;<span class="ident" id="6957149">ms2</span><span class="op" id="6957152">.</span><span class="ident" id="6957153">HeapReleased</span>&nbsp;<span class="op" id="6957166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6957170">t</span><span class="op" id="6957171">.</span><span class="ident" id="6957172">Errorf</span><span class="op" id="6957178">(</span><span class="string" id="6957179">&#34;released&nbsp;before=%d;&nbsp;released&nbsp;after=%d;&nbsp;did&nbsp;not&nbsp;go&nbsp;up&#34;</span><span class="op" id="6957233">,</span>&nbsp;<span class="ident" id="6957235">ms1</span><span class="op" id="6957238">.</span><span class="ident" id="6957239">HeapReleased</span><span class="op" id="6957251">,</span>&nbsp;<span class="ident" id="6957253">ms2</span><span class="op" id="6957256">.</span><span class="ident" id="6957257">HeapReleased</span><span class="op" id="6957269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6957272">}</span><br>
<span class="lineno"></span><span class="op" id="6957274">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="6957277">func</span>&nbsp;<span class="ident" id="6957282">TestSetGCPercent</span><span class="op" id="6957298">(</span><span class="ident" id="6957299">t</span>&nbsp;<span class="op" id="6957301">*</span><span class="ident" id="6957302">testing</span><span class="op" id="6957309">.</span><span class="ident" id="6957310">T</span><span class="op" id="6957311">)</span>&nbsp;<span class="op" id="6957313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6957316">//&nbsp;Test&nbsp;that&nbsp;the&nbsp;variable&nbsp;is&nbsp;being&nbsp;set&nbsp;and&nbsp;returned&nbsp;correctly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6957380">//&nbsp;Assume&nbsp;the&nbsp;percentage&nbsp;itself&nbsp;is&nbsp;implemented&nbsp;fine&nbsp;during&nbsp;GC,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6957444">//&nbsp;which&nbsp;is&nbsp;harder&nbsp;to&nbsp;test.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6957473">old</span>&nbsp;<span class="op" id="6957477">:=</span>&nbsp;<span class="ident" id="6957480">SetGCPercent</span><span class="op" id="6957492">(</span><span class="num" id="6957493">123</span><span class="op" id="6957496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6957499">new</span>&nbsp;<span class="op" id="6957503">:=</span>&nbsp;<span class="ident" id="6957506">SetGCPercent</span><span class="op" id="6957518">(</span><span class="ident" id="6957519">old</span><span class="op" id="6957522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6957525">if</span>&nbsp;<span class="builtinfunc" id="6957528">new</span>&nbsp;<span class="op" id="6957532">!=</span>&nbsp;<span class="num" id="6957535">123</span>&nbsp;<span class="op" id="6957539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6957543">t</span><span class="op" id="6957544">.</span><span class="ident" id="6957545">Errorf</span><span class="op" id="6957551">(</span><span class="string" id="6957552">&#34;SetGCPercent(123);&nbsp;SetGCPercent(x)&nbsp;=&nbsp;%d,&nbsp;want&nbsp;123&#34;</span><span class="op" id="6957603">,</span>&nbsp;<span class="builtinfunc" id="6957605">new</span><span class="op" id="6957608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6957611">}</span><br>
<span class="lineno">115</span><span class="op" id="6957613">}</span>
</div>
</body>
</html>
