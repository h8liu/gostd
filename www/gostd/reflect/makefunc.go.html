<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>reflect</h2>
<ul>
<li><a href="/gostd/reflect/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/reflect/deepequal.go.html">deepequal.go</a></li>
<li><a href="/gostd/reflect/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/reflect/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/reflect/makefunc.go.html">makefunc.go</a></li>
<li><a href="/gostd/reflect/set_test.go.html">set_test.go</a></li>
<li><a href="/gostd/reflect/tostring_test.go.html">tostring_test.go</a></li>
<li><a href="/gostd/reflect/type.go.html">type.go</a></li>
<li><a href="/gostd/reflect/value.go.html">value.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2806995">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2807051">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2807105">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2807156">//&nbsp;MakeFunc&nbsp;implementation.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2807185">package</span>&nbsp;<span class="ident" id="2807193">reflect</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2807202">import</span>&nbsp;<span class="op" id="2807209">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2807212">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="2807221">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2807224">//&nbsp;makeFuncImpl&nbsp;is&nbsp;the&nbsp;closure&nbsp;value&nbsp;implementing&nbsp;the&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="2807287">//&nbsp;returned&nbsp;by&nbsp;MakeFunc.</span><br>
<span class="lineno">15</span><span class="keyword" id="2807312">type</span>&nbsp;<span class="ident" id="2807317">makeFuncImpl</span>&nbsp;<span class="keyword" id="2807330">struct</span>&nbsp;<span class="op" id="2807337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2807340">code</span>&nbsp;&nbsp;<span class="builtintype" id="2807346">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2807355">stack</span>&nbsp;<span class="op" id="2807361">*</span><span class="ident" id="2807362">bitVector</span>&nbsp;<span class="comment" id="2807372">//&nbsp;stack&nbsp;bitmap&nbsp;for&nbsp;args&nbsp;-&nbsp;offset&nbsp;known&nbsp;to&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2807424">typ</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2807430">*</span><span class="ident" id="2807431">funcType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2807441">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2807447">func</span><span class="op" id="2807451">(</span><span class="op" id="2807452">[</span><span class="op" id="2807453">]</span><span class="ident" id="2807454">Value</span><span class="op" id="2807459">)</span>&nbsp;<span class="op" id="2807461">[</span><span class="op" id="2807462">]</span><span class="ident" id="2807463">Value</span><br>
<span class="lineno">20</span><span class="op" id="2807469">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2807472">//&nbsp;MakeFunc&nbsp;returns&nbsp;a&nbsp;new&nbsp;function&nbsp;of&nbsp;the&nbsp;given&nbsp;Type</span><br>
<span class="lineno"></span><span class="comment" id="2807525">//&nbsp;that&nbsp;wraps&nbsp;the&nbsp;function&nbsp;fn.&nbsp;When&nbsp;called,&nbsp;that&nbsp;new&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="2807587">//&nbsp;does&nbsp;the&nbsp;following:</span><br>
<span class="lineno">25</span><span class="comment" id="2807610">//</span><br>
<span class="lineno"></span><span class="comment" id="2807613">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;converts&nbsp;its&nbsp;arguments&nbsp;to&nbsp;a&nbsp;slice&nbsp;of&nbsp;Values.</span><br>
<span class="lineno"></span><span class="comment" id="2807663">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;runs&nbsp;results&nbsp;:=&nbsp;fn(args).</span><br>
<span class="lineno"></span><span class="comment" id="2807694">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;returns&nbsp;the&nbsp;results&nbsp;as&nbsp;a&nbsp;slice&nbsp;of&nbsp;Values,&nbsp;one&nbsp;per&nbsp;formal&nbsp;result.</span><br>
<span class="lineno"></span><span class="comment" id="2807764">//</span><br>
<span class="lineno">30</span><span class="comment" id="2807767">//&nbsp;The&nbsp;implementation&nbsp;fn&nbsp;can&nbsp;assume&nbsp;that&nbsp;the&nbsp;argument&nbsp;Value&nbsp;slice</span><br>
<span class="lineno"></span><span class="comment" id="2807833">//&nbsp;has&nbsp;the&nbsp;number&nbsp;and&nbsp;type&nbsp;of&nbsp;arguments&nbsp;given&nbsp;by&nbsp;typ.</span><br>
<span class="lineno"></span><span class="comment" id="2807887">//&nbsp;If&nbsp;typ&nbsp;describes&nbsp;a&nbsp;variadic&nbsp;function,&nbsp;the&nbsp;final&nbsp;Value&nbsp;is&nbsp;itself</span><br>
<span class="lineno"></span><span class="comment" id="2807954">//&nbsp;a&nbsp;slice&nbsp;representing&nbsp;the&nbsp;variadic&nbsp;arguments,&nbsp;as&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2808012">//&nbsp;body&nbsp;of&nbsp;a&nbsp;variadic&nbsp;function.&nbsp;The&nbsp;result&nbsp;Value&nbsp;slice&nbsp;returned&nbsp;by&nbsp;fn</span><br>
<span class="lineno">35</span><span class="comment" id="2808082">//&nbsp;must&nbsp;have&nbsp;the&nbsp;number&nbsp;and&nbsp;type&nbsp;of&nbsp;results&nbsp;given&nbsp;by&nbsp;typ.</span><br>
<span class="lineno"></span><span class="comment" id="2808140">//</span><br>
<span class="lineno"></span><span class="comment" id="2808143">//&nbsp;The&nbsp;Value.Call&nbsp;method&nbsp;allows&nbsp;the&nbsp;caller&nbsp;to&nbsp;invoke&nbsp;a&nbsp;typed&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="2808213">//&nbsp;in&nbsp;terms&nbsp;of&nbsp;Values;&nbsp;in&nbsp;contrast,&nbsp;MakeFunc&nbsp;allows&nbsp;the&nbsp;caller&nbsp;to&nbsp;implement</span><br>
<span class="lineno"></span><span class="comment" id="2808289">//&nbsp;a&nbsp;typed&nbsp;function&nbsp;in&nbsp;terms&nbsp;of&nbsp;Values.</span><br>
<span class="lineno">40</span><span class="comment" id="2808329">//</span><br>
<span class="lineno"></span><span class="comment" id="2808332">//&nbsp;The&nbsp;Examples&nbsp;section&nbsp;of&nbsp;the&nbsp;documentation&nbsp;includes&nbsp;an&nbsp;illustration</span><br>
<span class="lineno"></span><span class="comment" id="2808402">//&nbsp;of&nbsp;how&nbsp;to&nbsp;use&nbsp;MakeFunc&nbsp;to&nbsp;build&nbsp;a&nbsp;swap&nbsp;function&nbsp;for&nbsp;different&nbsp;types.</span><br>
<span class="lineno"></span><span class="comment" id="2808474">//</span><br>
<span class="lineno"></span><span class="keyword" id="2808477">func</span>&nbsp;<span class="ident" id="2808482">MakeFunc</span><span class="op" id="2808490">(</span><span class="ident" id="2808491">typ</span>&nbsp;<span class="ident" id="2808495">Type</span><span class="op" id="2808499">,</span>&nbsp;<span class="ident" id="2808501">fn</span>&nbsp;<span class="keyword" id="2808504">func</span><span class="op" id="2808508">(</span><span class="ident" id="2808509">args</span>&nbsp;<span class="op" id="2808514">[</span><span class="op" id="2808515">]</span><span class="ident" id="2808516">Value</span><span class="op" id="2808521">)</span>&nbsp;<span class="op" id="2808523">(</span><span class="ident" id="2808524">results</span>&nbsp;<span class="op" id="2808532">[</span><span class="op" id="2808533">]</span><span class="ident" id="2808534">Value</span><span class="op" id="2808539">)</span><span class="op" id="2808540">)</span>&nbsp;<span class="ident" id="2808542">Value</span>&nbsp;<span class="op" id="2808548">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2808551">if</span>&nbsp;<span class="ident" id="2808554">typ</span><span class="op" id="2808557">.</span><span class="ident" id="2808558">Kind</span><span class="op" id="2808562">(</span><span class="op" id="2808563">)</span>&nbsp;<span class="op" id="2808565">!=</span>&nbsp;<span class="ident" id="2808568">Func</span>&nbsp;<span class="op" id="2808573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2808577">panic</span><span class="op" id="2808582">(</span><span class="string" id="2808583">&#34;reflect:&nbsp;call&nbsp;of&nbsp;MakeFunc&nbsp;with&nbsp;non-Func&nbsp;type&#34;</span><span class="op" id="2808629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2808632">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2808636">t</span>&nbsp;<span class="op" id="2808638">:=</span>&nbsp;<span class="ident" id="2808641">typ</span><span class="op" id="2808644">.</span><span class="ident" id="2808645">common</span><span class="op" id="2808651">(</span><span class="op" id="2808652">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2808655">ftyp</span>&nbsp;<span class="op" id="2808660">:=</span>&nbsp;<span class="op" id="2808663">(</span><span class="op" id="2808664">*</span><span class="ident" id="2808665">funcType</span><span class="op" id="2808673">)</span><span class="op" id="2808674">(</span><span class="ident" id="2808675">unsafe</span><span class="op" id="2808681">.</span><span class="ident" id="2808682">Pointer</span><span class="op" id="2808689">(</span><span class="ident" id="2808690">t</span><span class="op" id="2808691">)</span><span class="op" id="2808692">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2808696">//&nbsp;Indirect&nbsp;Go&nbsp;func&nbsp;value&nbsp;(dummy)&nbsp;to&nbsp;obtain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2808741">//&nbsp;actual&nbsp;code&nbsp;address.&nbsp;(A&nbsp;Go&nbsp;func&nbsp;value&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2808796">//&nbsp;to&nbsp;a&nbsp;C&nbsp;function&nbsp;pointer.&nbsp;http://golang.org/s/go11func.)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2808856">dummy</span>&nbsp;<span class="op" id="2808862">:=</span>&nbsp;<span class="ident" id="2808865">makeFuncStub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2808879">code</span>&nbsp;<span class="op" id="2808884">:=</span>&nbsp;<span class="op" id="2808887">*</span><span class="op" id="2808888">*</span><span class="op" id="2808889">(</span><span class="op" id="2808890">*</span><span class="op" id="2808891">*</span><span class="builtintype" id="2808892">uintptr</span><span class="op" id="2808899">)</span><span class="op" id="2808900">(</span><span class="ident" id="2808901">unsafe</span><span class="op" id="2808907">.</span><span class="ident" id="2808908">Pointer</span><span class="op" id="2808915">(</span><span class="op" id="2808916">&amp;</span><span class="ident" id="2808917">dummy</span><span class="op" id="2808922">)</span><span class="op" id="2808923">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2808927">//&nbsp;makeFuncImpl&nbsp;contains&nbsp;a&nbsp;stack&nbsp;map&nbsp;for&nbsp;use&nbsp;by&nbsp;the&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2808988">_</span><span class="op" id="2808989">,</span>&nbsp;<span class="ident" id="2808991">_</span><span class="op" id="2808992">,</span>&nbsp;<span class="ident" id="2808994">_</span><span class="op" id="2808995">,</span>&nbsp;<span class="ident" id="2808997">stack</span>&nbsp;<span class="op" id="2809003">:=</span>&nbsp;<span class="ident" id="2809006">funcLayout</span><span class="op" id="2809016">(</span><span class="ident" id="2809017">t</span><span class="op" id="2809018">,</span>&nbsp;<span class="ident" id="2809020">nil</span><span class="op" id="2809023">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2809027">impl</span>&nbsp;<span class="op" id="2809032">:=</span>&nbsp;<span class="op" id="2809035">&amp;</span><span class="ident" id="2809036">makeFuncImpl</span><span class="op" id="2809048">{</span><span class="ident" id="2809049">code</span><span class="op" id="2809053">:</span>&nbsp;<span class="ident" id="2809055">code</span><span class="op" id="2809059">,</span>&nbsp;<span class="ident" id="2809061">stack</span><span class="op" id="2809066">:</span>&nbsp;<span class="ident" id="2809068">stack</span><span class="op" id="2809073">,</span>&nbsp;<span class="ident" id="2809075">typ</span><span class="op" id="2809078">:</span>&nbsp;<span class="ident" id="2809080">ftyp</span><span class="op" id="2809084">,</span>&nbsp;<span class="ident" id="2809086">fn</span><span class="op" id="2809088">:</span>&nbsp;<span class="ident" id="2809090">fn</span><span class="op" id="2809092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2809096">return</span>&nbsp;<span class="ident" id="2809103">Value</span><span class="op" id="2809108">{</span><span class="ident" id="2809109">t</span><span class="op" id="2809110">,</span>&nbsp;<span class="ident" id="2809112">unsafe</span><span class="op" id="2809118">.</span><span class="ident" id="2809119">Pointer</span><span class="op" id="2809126">(</span><span class="ident" id="2809127">impl</span><span class="op" id="2809131">)</span><span class="op" id="2809132">,</span>&nbsp;<span class="ident" id="2809134">flag</span><span class="op" id="2809138">(</span><span class="ident" id="2809139">Func</span><span class="op" id="2809143">)</span><span class="op" id="2809144">}</span><br>
<span class="lineno"></span><span class="op" id="2809146">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="2809149">//&nbsp;makeFuncStub&nbsp;is&nbsp;an&nbsp;assembly&nbsp;function&nbsp;that&nbsp;is&nbsp;the&nbsp;code&nbsp;half&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="2809214">//&nbsp;the&nbsp;function&nbsp;returned&nbsp;from&nbsp;MakeFunc.&nbsp;It&nbsp;expects&nbsp;a&nbsp;*callReflectFunc</span><br>
<span class="lineno"></span><span class="comment" id="2809284">//&nbsp;as&nbsp;its&nbsp;context&nbsp;register,&nbsp;and&nbsp;its&nbsp;job&nbsp;is&nbsp;to&nbsp;invoke&nbsp;callReflect(ctxt,&nbsp;frame)</span><br>
<span class="lineno"></span><span class="comment" id="2809362">//&nbsp;where&nbsp;ctxt&nbsp;is&nbsp;the&nbsp;context&nbsp;register&nbsp;and&nbsp;frame&nbsp;is&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;first</span><br>
<span class="lineno">70</span><span class="comment" id="2809436">//&nbsp;word&nbsp;in&nbsp;the&nbsp;passed-in&nbsp;argument&nbsp;frame.</span><br>
<span class="lineno"></span><span class="keyword" id="2809477">func</span>&nbsp;<span class="ident" id="2809482">makeFuncStub</span><span class="op" id="2809494">(</span><span class="op" id="2809495">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2809498">type</span>&nbsp;<span class="ident" id="2809503">methodValue</span>&nbsp;<span class="keyword" id="2809515">struct</span>&nbsp;<span class="op" id="2809522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2809525">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2809532">uintptr</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2809541">stack</span>&nbsp;&nbsp;<span class="op" id="2809548">*</span><span class="ident" id="2809549">bitVector</span>&nbsp;<span class="comment" id="2809559">//&nbsp;stack&nbsp;bitmap&nbsp;for&nbsp;args&nbsp;-&nbsp;offset&nbsp;known&nbsp;to&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2809611">method</span>&nbsp;<span class="builtintype" id="2809618">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2809623">rcvr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2809630">Value</span><br>
<span class="lineno"></span><span class="op" id="2809636">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="2809639">//&nbsp;makeMethodValue&nbsp;converts&nbsp;v&nbsp;from&nbsp;the&nbsp;rcvr+method&nbsp;index&nbsp;representation</span><br>
<span class="lineno"></span><span class="comment" id="2809711">//&nbsp;of&nbsp;a&nbsp;method&nbsp;value&nbsp;to&nbsp;an&nbsp;actual&nbsp;method&nbsp;func&nbsp;value,&nbsp;which&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="2809773">//&nbsp;basically&nbsp;the&nbsp;receiver&nbsp;value&nbsp;with&nbsp;a&nbsp;special&nbsp;bit&nbsp;set,&nbsp;into&nbsp;a&nbsp;true</span><br>
<span class="lineno"></span><span class="comment" id="2809841">//&nbsp;func&nbsp;value&nbsp;-&nbsp;a&nbsp;value&nbsp;holding&nbsp;an&nbsp;actual&nbsp;func.&nbsp;The&nbsp;output&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="2809903">//&nbsp;semantically&nbsp;equivalent&nbsp;to&nbsp;the&nbsp;input&nbsp;as&nbsp;far&nbsp;as&nbsp;the&nbsp;user&nbsp;of&nbsp;package</span><br>
<span class="lineno">85</span><span class="comment" id="2809973">//&nbsp;reflect&nbsp;can&nbsp;tell,&nbsp;but&nbsp;the&nbsp;true&nbsp;func&nbsp;representation&nbsp;can&nbsp;be&nbsp;handled</span><br>
<span class="lineno"></span><span class="comment" id="2810042">//&nbsp;by&nbsp;code&nbsp;like&nbsp;Convert&nbsp;and&nbsp;Interface&nbsp;and&nbsp;Assign.</span><br>
<span class="lineno"></span><span class="keyword" id="2810092">func</span>&nbsp;<span class="ident" id="2810097">makeMethodValue</span><span class="op" id="2810112">(</span><span class="ident" id="2810113">op</span>&nbsp;<span class="builtintype" id="2810116">string</span><span class="op" id="2810122">,</span>&nbsp;<span class="ident" id="2810124">v</span>&nbsp;<span class="ident" id="2810126">Value</span><span class="op" id="2810131">)</span>&nbsp;<span class="ident" id="2810133">Value</span>&nbsp;<span class="op" id="2810139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2810142">if</span>&nbsp;<span class="ident" id="2810145">v</span><span class="op" id="2810146">.</span><span class="ident" id="2810147">flag</span><span class="op" id="2810151">&amp;</span><span class="ident" id="2810152">flagMethod</span>&nbsp;<span class="op" id="2810163">==</span>&nbsp;<span class="num" id="2810166">0</span>&nbsp;<span class="op" id="2810168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2810172">panic</span><span class="op" id="2810177">(</span><span class="string" id="2810178">&#34;reflect:&nbsp;internal&nbsp;error:&nbsp;invalid&nbsp;use&nbsp;of&nbsp;makeMethodValue&#34;</span><span class="op" id="2810235">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2810238">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2810242">//&nbsp;Ignoring&nbsp;the&nbsp;flagMethod&nbsp;bit,&nbsp;v&nbsp;describes&nbsp;the&nbsp;receiver,&nbsp;not&nbsp;the&nbsp;method&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2810322">fl</span>&nbsp;<span class="op" id="2810325">:=</span>&nbsp;<span class="ident" id="2810328">v</span><span class="op" id="2810329">.</span><span class="ident" id="2810330">flag</span>&nbsp;<span class="op" id="2810335">&amp;</span>&nbsp;<span class="op" id="2810337">(</span><span class="ident" id="2810338">flagRO</span>&nbsp;<span class="op" id="2810345">|</span>&nbsp;<span class="ident" id="2810347">flagAddr</span>&nbsp;<span class="op" id="2810356">|</span>&nbsp;<span class="ident" id="2810358">flagIndir</span><span class="op" id="2810367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2810370">fl</span>&nbsp;<span class="op" id="2810373">|=</span>&nbsp;<span class="ident" id="2810376">flag</span><span class="op" id="2810380">(</span><span class="ident" id="2810381">v</span><span class="op" id="2810382">.</span><span class="ident" id="2810383">typ</span><span class="op" id="2810386">.</span><span class="ident" id="2810387">Kind</span><span class="op" id="2810391">(</span><span class="op" id="2810392">)</span><span class="op" id="2810393">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2810396">rcvr</span>&nbsp;<span class="op" id="2810401">:=</span>&nbsp;<span class="ident" id="2810404">Value</span><span class="op" id="2810409">{</span><span class="ident" id="2810410">v</span><span class="op" id="2810411">.</span><span class="ident" id="2810412">typ</span><span class="op" id="2810415">,</span>&nbsp;<span class="ident" id="2810417">v</span><span class="op" id="2810418">.</span><span class="ident" id="2810419">ptr</span><span class="op" id="2810422">,</span>&nbsp;<span class="ident" id="2810424">fl</span><span class="op" id="2810426">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2810430">//&nbsp;v.Type&nbsp;returns&nbsp;the&nbsp;actual&nbsp;type&nbsp;of&nbsp;the&nbsp;method&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2810486">funcType</span>&nbsp;<span class="op" id="2810495">:=</span>&nbsp;<span class="ident" id="2810498">v</span><span class="op" id="2810499">.</span><span class="ident" id="2810500">Type</span><span class="op" id="2810504">(</span><span class="op" id="2810505">)</span><span class="op" id="2810506">.</span><span class="op" id="2810507">(</span><span class="op" id="2810508">*</span><span class="ident" id="2810509">rtype</span><span class="op" id="2810514">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2810518">//&nbsp;Indirect&nbsp;Go&nbsp;func&nbsp;value&nbsp;(dummy)&nbsp;to&nbsp;obtain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2810563">//&nbsp;actual&nbsp;code&nbsp;address.&nbsp;(A&nbsp;Go&nbsp;func&nbsp;value&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2810618">//&nbsp;to&nbsp;a&nbsp;C&nbsp;function&nbsp;pointer.&nbsp;http://golang.org/s/go11func.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2810678">dummy</span>&nbsp;<span class="op" id="2810684">:=</span>&nbsp;<span class="ident" id="2810687">methodValueCall</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2810704">code</span>&nbsp;<span class="op" id="2810709">:=</span>&nbsp;<span class="op" id="2810712">*</span><span class="op" id="2810713">*</span><span class="op" id="2810714">(</span><span class="op" id="2810715">*</span><span class="op" id="2810716">*</span><span class="builtintype" id="2810717">uintptr</span><span class="op" id="2810724">)</span><span class="op" id="2810725">(</span><span class="ident" id="2810726">unsafe</span><span class="op" id="2810732">.</span><span class="ident" id="2810733">Pointer</span><span class="op" id="2810740">(</span><span class="op" id="2810741">&amp;</span><span class="ident" id="2810742">dummy</span><span class="op" id="2810747">)</span><span class="op" id="2810748">)</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2810752">//&nbsp;methodValue&nbsp;contains&nbsp;a&nbsp;stack&nbsp;map&nbsp;for&nbsp;use&nbsp;by&nbsp;the&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2810812">_</span><span class="op" id="2810813">,</span>&nbsp;<span class="ident" id="2810815">_</span><span class="op" id="2810816">,</span>&nbsp;<span class="ident" id="2810818">_</span><span class="op" id="2810819">,</span>&nbsp;<span class="ident" id="2810821">stack</span>&nbsp;<span class="op" id="2810827">:=</span>&nbsp;<span class="ident" id="2810830">funcLayout</span><span class="op" id="2810840">(</span><span class="ident" id="2810841">funcType</span><span class="op" id="2810849">,</span>&nbsp;<span class="ident" id="2810851">nil</span><span class="op" id="2810854">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2810858">fv</span>&nbsp;<span class="op" id="2810861">:=</span>&nbsp;<span class="op" id="2810864">&amp;</span><span class="ident" id="2810865">methodValue</span><span class="op" id="2810876">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2810880">fn</span><span class="op" id="2810882">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2810888">code</span><span class="op" id="2810892">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2810896">stack</span><span class="op" id="2810901">:</span>&nbsp;&nbsp;<span class="ident" id="2810904">stack</span><span class="op" id="2810909">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2810913">method</span><span class="op" id="2810919">:</span>&nbsp;<span class="builtintype" id="2810921">int</span><span class="op" id="2810924">(</span><span class="ident" id="2810925">v</span><span class="op" id="2810926">.</span><span class="ident" id="2810927">flag</span><span class="op" id="2810931">)</span>&nbsp;<span class="op" id="2810933">&gt;&gt;</span>&nbsp;<span class="ident" id="2810936">flagMethodShift</span><span class="op" id="2810951">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2810955">rcvr</span><span class="op" id="2810959">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2810963">rcvr</span><span class="op" id="2810967">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2810970">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2810974">//&nbsp;Cause&nbsp;panic&nbsp;if&nbsp;method&nbsp;is&nbsp;not&nbsp;appropriate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2811020">//&nbsp;The&nbsp;panic&nbsp;would&nbsp;still&nbsp;happen&nbsp;during&nbsp;the&nbsp;call&nbsp;if&nbsp;we&nbsp;omit&nbsp;this,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2811086">//&nbsp;but&nbsp;we&nbsp;want&nbsp;Interface()&nbsp;and&nbsp;other&nbsp;operations&nbsp;to&nbsp;fail&nbsp;early.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2811150">methodReceiver</span><span class="op" id="2811164">(</span><span class="ident" id="2811165">op</span><span class="op" id="2811167">,</span>&nbsp;<span class="ident" id="2811169">fv</span><span class="op" id="2811171">.</span><span class="ident" id="2811172">rcvr</span><span class="op" id="2811176">,</span>&nbsp;<span class="ident" id="2811178">fv</span><span class="op" id="2811180">.</span><span class="ident" id="2811181">method</span><span class="op" id="2811187">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2811191">return</span>&nbsp;<span class="ident" id="2811198">Value</span><span class="op" id="2811203">{</span><span class="ident" id="2811204">funcType</span><span class="op" id="2811212">,</span>&nbsp;<span class="ident" id="2811214">unsafe</span><span class="op" id="2811220">.</span><span class="ident" id="2811221">Pointer</span><span class="op" id="2811228">(</span><span class="ident" id="2811229">fv</span><span class="op" id="2811231">)</span><span class="op" id="2811232">,</span>&nbsp;<span class="ident" id="2811234">v</span><span class="op" id="2811235">.</span><span class="ident" id="2811236">flag</span><span class="op" id="2811240">&amp;</span><span class="ident" id="2811241">flagRO</span>&nbsp;<span class="op" id="2811248">|</span>&nbsp;<span class="ident" id="2811250">flag</span><span class="op" id="2811254">(</span><span class="ident" id="2811255">Func</span><span class="op" id="2811259">)</span><span class="op" id="2811260">}</span><br>
<span class="lineno"></span><span class="op" id="2811262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2811265">//&nbsp;methodValueCall&nbsp;is&nbsp;an&nbsp;assembly&nbsp;function&nbsp;that&nbsp;is&nbsp;the&nbsp;code&nbsp;half&nbsp;of</span><br>
<span class="lineno">125</span><span class="comment" id="2811333">//&nbsp;the&nbsp;function&nbsp;returned&nbsp;from&nbsp;makeMethodValue.&nbsp;It&nbsp;expects&nbsp;a&nbsp;*methodValue</span><br>
<span class="lineno"></span><span class="comment" id="2811406">//&nbsp;as&nbsp;its&nbsp;context&nbsp;register,&nbsp;and&nbsp;its&nbsp;job&nbsp;is&nbsp;to&nbsp;invoke&nbsp;callMethod(ctxt,&nbsp;frame)</span><br>
<span class="lineno"></span><span class="comment" id="2811483">//&nbsp;where&nbsp;ctxt&nbsp;is&nbsp;the&nbsp;context&nbsp;register&nbsp;and&nbsp;frame&nbsp;is&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="2811557">//&nbsp;word&nbsp;in&nbsp;the&nbsp;passed-in&nbsp;argument&nbsp;frame.</span><br>
<span class="lineno"></span><span class="keyword" id="2811598">func</span>&nbsp;<span class="ident" id="2811603">methodValueCall</span><span class="op" id="2811618">(</span><span class="op" id="2811619">)</span>
</div>
</body>
</html>
