<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/rc4</h2>
<ul>
<li><a href="/gostd/crypto/rc4/rc4.go.html">rc4.go</a></li>
<li><a href="/gostd/crypto/rc4/rc4_asm.go.html">rc4_asm.go</a></li>
<li><a href="/gostd/crypto/rc4/rc4_test.go.html">rc4_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4233300">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4233355">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4233409">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4233460">//&nbsp;Package&nbsp;rc4&nbsp;implements&nbsp;RC4&nbsp;encryption,&nbsp;as&nbsp;defined&nbsp;in&nbsp;Bruce&nbsp;Schneier&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="4233533">//&nbsp;Applied&nbsp;Cryptography.</span><br>
<span class="lineno"></span><span class="keyword" id="4233558">package</span>&nbsp;<span class="ident" id="4233566">rc4</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4233571">//&nbsp;BUG(agl):&nbsp;RC4&nbsp;is&nbsp;in&nbsp;common&nbsp;use&nbsp;but&nbsp;has&nbsp;design&nbsp;weaknesses&nbsp;that&nbsp;make</span><br>
<span class="lineno">10</span><span class="comment" id="4233641">//&nbsp;it&nbsp;a&nbsp;poor&nbsp;choice&nbsp;for&nbsp;new&nbsp;protocols.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4233681">import</span>&nbsp;<span class="string" id="4233688">&#34;strconv&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4233699">//&nbsp;A&nbsp;Cipher&nbsp;is&nbsp;an&nbsp;instance&nbsp;of&nbsp;RC4&nbsp;using&nbsp;a&nbsp;particular&nbsp;key.</span><br>
<span class="lineno">15</span><span class="keyword" id="4233757">type</span>&nbsp;<span class="ident" id="4233762">Cipher</span>&nbsp;<span class="keyword" id="4233769">struct</span>&nbsp;<span class="op" id="4233776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4233779">s</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4233784">[</span><span class="num" id="4233785">256</span><span class="op" id="4233788">]</span><span class="builtintype" id="4233789">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4233797">i</span><span class="op" id="4233798">,</span>&nbsp;<span class="ident" id="4233800">j</span>&nbsp;<span class="builtintype" id="4233802">uint8</span><br>
<span class="lineno"></span><span class="op" id="4233808">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="4233811">type</span>&nbsp;<span class="ident" id="4233816">KeySizeError</span>&nbsp;<span class="builtintype" id="4233829">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4233834">func</span>&nbsp;<span class="op" id="4233839">(</span><span class="ident" id="4233840">k</span>&nbsp;<span class="ident" id="4233842">KeySizeError</span><span class="op" id="4233854">)</span>&nbsp;<span class="ident" id="4233856">Error</span><span class="op" id="4233861">(</span><span class="op" id="4233862">)</span>&nbsp;<span class="builtintype" id="4233864">string</span>&nbsp;<span class="op" id="4233871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4233874">return</span>&nbsp;<span class="string" id="4233881">&#34;crypto/rc4:&nbsp;invalid&nbsp;key&nbsp;size&nbsp;&#34;</span>&nbsp;<span class="op" id="4233913">+</span>&nbsp;<span class="ident" id="4233915">strconv</span><span class="op" id="4233922">.</span><span class="ident" id="4233923">Itoa</span><span class="op" id="4233927">(</span><span class="builtintype" id="4233928">int</span><span class="op" id="4233931">(</span><span class="ident" id="4233932">k</span><span class="op" id="4233933">)</span><span class="op" id="4233934">)</span><br>
<span class="lineno"></span><span class="op" id="4233936">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="comment" id="4233939">//&nbsp;NewCipher&nbsp;creates&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;Cipher.&nbsp;&nbsp;The&nbsp;key&nbsp;argument&nbsp;should&nbsp;be&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4234018">//&nbsp;RC4&nbsp;key,&nbsp;at&nbsp;least&nbsp;1&nbsp;byte&nbsp;and&nbsp;at&nbsp;most&nbsp;256&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="4234069">func</span>&nbsp;<span class="ident" id="4234074">NewCipher</span><span class="op" id="4234083">(</span><span class="ident" id="4234084">key</span>&nbsp;<span class="op" id="4234088">[</span><span class="op" id="4234089">]</span><span class="builtintype" id="4234090">byte</span><span class="op" id="4234094">)</span>&nbsp;<span class="op" id="4234096">(</span><span class="op" id="4234097">*</span><span class="ident" id="4234098">Cipher</span><span class="op" id="4234104">,</span>&nbsp;<span class="builtintype" id="4234106">error</span><span class="op" id="4234111">)</span>&nbsp;<span class="op" id="4234113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4234116">k</span>&nbsp;<span class="op" id="4234118">:=</span>&nbsp;<span class="builtinfunc" id="4234121">len</span><span class="op" id="4234124">(</span><span class="ident" id="4234125">key</span><span class="op" id="4234128">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4234131">if</span>&nbsp;<span class="ident" id="4234134">k</span>&nbsp;<span class="op" id="4234136">&lt;</span>&nbsp;<span class="num" id="4234138">1</span>&nbsp;<span class="op" id="4234140">||</span>&nbsp;<span class="ident" id="4234143">k</span>&nbsp;<span class="op" id="4234145">&gt;</span>&nbsp;<span class="num" id="4234147">256</span>&nbsp;<span class="op" id="4234151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4234155">return</span>&nbsp;<span class="ident" id="4234162">nil</span><span class="op" id="4234165">,</span>&nbsp;<span class="ident" id="4234167">KeySizeError</span><span class="op" id="4234179">(</span><span class="ident" id="4234180">k</span><span class="op" id="4234181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4234184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4234187">var</span>&nbsp;<span class="ident" id="4234191">c</span>&nbsp;<span class="ident" id="4234193">Cipher</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4234201">for</span>&nbsp;<span class="ident" id="4234205">i</span>&nbsp;<span class="op" id="4234207">:=</span>&nbsp;<span class="num" id="4234210">0</span><span class="op" id="4234211">;</span>&nbsp;<span class="ident" id="4234213">i</span>&nbsp;<span class="op" id="4234215">&lt;</span>&nbsp;<span class="num" id="4234217">256</span><span class="op" id="4234220">;</span>&nbsp;<span class="ident" id="4234222">i</span><span class="op" id="4234223">++</span>&nbsp;<span class="op" id="4234226">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4234230">c</span><span class="op" id="4234231">.</span><span class="ident" id="4234232">s</span><span class="op" id="4234233">[</span><span class="ident" id="4234234">i</span><span class="op" id="4234235">]</span>&nbsp;<span class="op" id="4234237">=</span>&nbsp;<span class="builtintype" id="4234239">uint32</span><span class="op" id="4234245">(</span><span class="ident" id="4234246">i</span><span class="op" id="4234247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4234250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4234253">var</span>&nbsp;<span class="ident" id="4234257">j</span>&nbsp;<span class="builtintype" id="4234259">uint8</span>&nbsp;<span class="op" id="4234265">=</span>&nbsp;<span class="num" id="4234267">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4234270">for</span>&nbsp;<span class="ident" id="4234274">i</span>&nbsp;<span class="op" id="4234276">:=</span>&nbsp;<span class="num" id="4234279">0</span><span class="op" id="4234280">;</span>&nbsp;<span class="ident" id="4234282">i</span>&nbsp;<span class="op" id="4234284">&lt;</span>&nbsp;<span class="num" id="4234286">256</span><span class="op" id="4234289">;</span>&nbsp;<span class="ident" id="4234291">i</span><span class="op" id="4234292">++</span>&nbsp;<span class="op" id="4234295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4234299">j</span>&nbsp;<span class="op" id="4234301">+=</span>&nbsp;<span class="builtintype" id="4234304">uint8</span><span class="op" id="4234309">(</span><span class="ident" id="4234310">c</span><span class="op" id="4234311">.</span><span class="ident" id="4234312">s</span><span class="op" id="4234313">[</span><span class="ident" id="4234314">i</span><span class="op" id="4234315">]</span><span class="op" id="4234316">)</span>&nbsp;<span class="op" id="4234318">+</span>&nbsp;<span class="ident" id="4234320">key</span><span class="op" id="4234323">[</span><span class="ident" id="4234324">i</span><span class="op" id="4234325">%</span><span class="ident" id="4234326">k</span><span class="op" id="4234327">]</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4234331">c</span><span class="op" id="4234332">.</span><span class="ident" id="4234333">s</span><span class="op" id="4234334">[</span><span class="ident" id="4234335">i</span><span class="op" id="4234336">]</span><span class="op" id="4234337">,</span>&nbsp;<span class="ident" id="4234339">c</span><span class="op" id="4234340">.</span><span class="ident" id="4234341">s</span><span class="op" id="4234342">[</span><span class="ident" id="4234343">j</span><span class="op" id="4234344">]</span>&nbsp;<span class="op" id="4234346">=</span>&nbsp;<span class="ident" id="4234348">c</span><span class="op" id="4234349">.</span><span class="ident" id="4234350">s</span><span class="op" id="4234351">[</span><span class="ident" id="4234352">j</span><span class="op" id="4234353">]</span><span class="op" id="4234354">,</span>&nbsp;<span class="ident" id="4234356">c</span><span class="op" id="4234357">.</span><span class="ident" id="4234358">s</span><span class="op" id="4234359">[</span><span class="ident" id="4234360">i</span><span class="op" id="4234361">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4234364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4234367">return</span>&nbsp;<span class="op" id="4234374">&amp;</span><span class="ident" id="4234375">c</span><span class="op" id="4234376">,</span>&nbsp;<span class="ident" id="4234378">nil</span><br>
<span class="lineno"></span><span class="op" id="4234382">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="4234385">//&nbsp;Reset&nbsp;zeros&nbsp;the&nbsp;key&nbsp;data&nbsp;so&nbsp;that&nbsp;it&nbsp;will&nbsp;no&nbsp;longer&nbsp;appear&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4234453">//&nbsp;process&#39;s&nbsp;memory.</span><br>
<span class="lineno"></span><span class="keyword" id="4234474">func</span>&nbsp;<span class="op" id="4234479">(</span><span class="ident" id="4234480">c</span>&nbsp;<span class="op" id="4234482">*</span><span class="ident" id="4234483">Cipher</span><span class="op" id="4234489">)</span>&nbsp;<span class="ident" id="4234491">Reset</span><span class="op" id="4234496">(</span><span class="op" id="4234497">)</span>&nbsp;<span class="op" id="4234499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4234502">for</span>&nbsp;<span class="ident" id="4234506">i</span>&nbsp;<span class="op" id="4234508">:=</span>&nbsp;<span class="keyword" id="4234511">range</span>&nbsp;<span class="ident" id="4234517">c</span><span class="op" id="4234518">.</span><span class="ident" id="4234519">s</span>&nbsp;<span class="op" id="4234521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4234525">c</span><span class="op" id="4234526">.</span><span class="ident" id="4234527">s</span><span class="op" id="4234528">[</span><span class="ident" id="4234529">i</span><span class="op" id="4234530">]</span>&nbsp;<span class="op" id="4234532">=</span>&nbsp;<span class="num" id="4234534">0</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4234537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4234540">c</span><span class="op" id="4234541">.</span><span class="ident" id="4234542">i</span><span class="op" id="4234543">,</span>&nbsp;<span class="ident" id="4234545">c</span><span class="op" id="4234546">.</span><span class="ident" id="4234547">j</span>&nbsp;<span class="op" id="4234549">=</span>&nbsp;<span class="num" id="4234551">0</span><span class="op" id="4234552">,</span>&nbsp;<span class="num" id="4234554">0</span><br>
<span class="lineno"></span><span class="op" id="4234556">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4234559">//&nbsp;xorKeyStreamGeneric&nbsp;sets&nbsp;dst&nbsp;to&nbsp;the&nbsp;result&nbsp;of&nbsp;XORing&nbsp;src&nbsp;with&nbsp;the</span><br>
<span class="lineno">55</span><span class="comment" id="4234628">//&nbsp;key&nbsp;stream.&nbsp;&nbsp;Dst&nbsp;and&nbsp;src&nbsp;may&nbsp;be&nbsp;the&nbsp;same&nbsp;slice&nbsp;but&nbsp;otherwise&nbsp;should</span><br>
<span class="lineno"></span><span class="comment" id="4234699">//&nbsp;not&nbsp;overlap.</span><br>
<span class="lineno"></span><span class="comment" id="4234715">//</span><br>
<span class="lineno"></span><span class="comment" id="4234718">//&nbsp;This&nbsp;is&nbsp;the&nbsp;pure&nbsp;Go&nbsp;version.&nbsp;rc4_{amd64,386,arm}*&nbsp;contain&nbsp;assembly</span><br>
<span class="lineno"></span><span class="comment" id="4234788">//&nbsp;implementations.&nbsp;This&nbsp;is&nbsp;here&nbsp;for&nbsp;tests&nbsp;and&nbsp;to&nbsp;prevent&nbsp;bitrot.</span><br>
<span class="lineno">60</span><span class="keyword" id="4234854">func</span>&nbsp;<span class="op" id="4234859">(</span><span class="ident" id="4234860">c</span>&nbsp;<span class="op" id="4234862">*</span><span class="ident" id="4234863">Cipher</span><span class="op" id="4234869">)</span>&nbsp;<span class="ident" id="4234871">xorKeyStreamGeneric</span><span class="op" id="4234890">(</span><span class="ident" id="4234891">dst</span><span class="op" id="4234894">,</span>&nbsp;<span class="ident" id="4234896">src</span>&nbsp;<span class="op" id="4234900">[</span><span class="op" id="4234901">]</span><span class="builtintype" id="4234902">byte</span><span class="op" id="4234906">)</span>&nbsp;<span class="op" id="4234908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4234911">i</span><span class="op" id="4234912">,</span>&nbsp;<span class="ident" id="4234914">j</span>&nbsp;<span class="op" id="4234916">:=</span>&nbsp;<span class="ident" id="4234919">c</span><span class="op" id="4234920">.</span><span class="ident" id="4234921">i</span><span class="op" id="4234922">,</span>&nbsp;<span class="ident" id="4234924">c</span><span class="op" id="4234925">.</span><span class="ident" id="4234926">j</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4234929">for</span>&nbsp;<span class="ident" id="4234933">k</span><span class="op" id="4234934">,</span>&nbsp;<span class="ident" id="4234936">v</span>&nbsp;<span class="op" id="4234938">:=</span>&nbsp;<span class="keyword" id="4234941">range</span>&nbsp;<span class="ident" id="4234947">src</span>&nbsp;<span class="op" id="4234951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4234955">i</span>&nbsp;<span class="op" id="4234957">+=</span>&nbsp;<span class="num" id="4234960">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4234964">j</span>&nbsp;<span class="op" id="4234966">+=</span>&nbsp;<span class="builtintype" id="4234969">uint8</span><span class="op" id="4234974">(</span><span class="ident" id="4234975">c</span><span class="op" id="4234976">.</span><span class="ident" id="4234977">s</span><span class="op" id="4234978">[</span><span class="ident" id="4234979">i</span><span class="op" id="4234980">]</span><span class="op" id="4234981">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4234985">c</span><span class="op" id="4234986">.</span><span class="ident" id="4234987">s</span><span class="op" id="4234988">[</span><span class="ident" id="4234989">i</span><span class="op" id="4234990">]</span><span class="op" id="4234991">,</span>&nbsp;<span class="ident" id="4234993">c</span><span class="op" id="4234994">.</span><span class="ident" id="4234995">s</span><span class="op" id="4234996">[</span><span class="ident" id="4234997">j</span><span class="op" id="4234998">]</span>&nbsp;<span class="op" id="4235000">=</span>&nbsp;<span class="ident" id="4235002">c</span><span class="op" id="4235003">.</span><span class="ident" id="4235004">s</span><span class="op" id="4235005">[</span><span class="ident" id="4235006">j</span><span class="op" id="4235007">]</span><span class="op" id="4235008">,</span>&nbsp;<span class="ident" id="4235010">c</span><span class="op" id="4235011">.</span><span class="ident" id="4235012">s</span><span class="op" id="4235013">[</span><span class="ident" id="4235014">i</span><span class="op" id="4235015">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4235019">dst</span><span class="op" id="4235022">[</span><span class="ident" id="4235023">k</span><span class="op" id="4235024">]</span>&nbsp;<span class="op" id="4235026">=</span>&nbsp;<span class="ident" id="4235028">v</span>&nbsp;<span class="op" id="4235030">^</span>&nbsp;<span class="builtintype" id="4235032">uint8</span><span class="op" id="4235037">(</span><span class="ident" id="4235038">c</span><span class="op" id="4235039">.</span><span class="ident" id="4235040">s</span><span class="op" id="4235041">[</span><span class="builtintype" id="4235042">uint8</span><span class="op" id="4235047">(</span><span class="ident" id="4235048">c</span><span class="op" id="4235049">.</span><span class="ident" id="4235050">s</span><span class="op" id="4235051">[</span><span class="ident" id="4235052">i</span><span class="op" id="4235053">]</span><span class="op" id="4235054">+</span><span class="ident" id="4235055">c</span><span class="op" id="4235056">.</span><span class="ident" id="4235057">s</span><span class="op" id="4235058">[</span><span class="ident" id="4235059">j</span><span class="op" id="4235060">]</span><span class="op" id="4235061">)</span><span class="op" id="4235062">]</span><span class="op" id="4235063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4235066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4235069">c</span><span class="op" id="4235070">.</span><span class="ident" id="4235071">i</span><span class="op" id="4235072">,</span>&nbsp;<span class="ident" id="4235074">c</span><span class="op" id="4235075">.</span><span class="ident" id="4235076">j</span>&nbsp;<span class="op" id="4235078">=</span>&nbsp;<span class="ident" id="4235080">i</span><span class="op" id="4235081">,</span>&nbsp;<span class="ident" id="4235083">j</span><br>
<span class="lineno"></span><span class="op" id="4235085">}</span>
</div>
</body>
</html>
