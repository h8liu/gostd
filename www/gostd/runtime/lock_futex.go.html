<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html" class="current">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1530782">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1530837">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1530891">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1530942">//&nbsp;+build&nbsp;dragonfly&nbsp;freebsd&nbsp;linux</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1530977">package</span>&nbsp;<span class="ident" id="1530985">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1530994">import</span>&nbsp;<span class="string" id="1531001">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="1531011">//&nbsp;This&nbsp;implementation&nbsp;depends&nbsp;on&nbsp;OS-specific&nbsp;implementations&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1531076">//</span><br>
<span class="lineno"></span><span class="comment" id="1531079">//&nbsp;&nbsp;&nbsp;&nbsp;runtime路futexsleep(uint32&nbsp;*addr,&nbsp;uint32&nbsp;val,&nbsp;int64&nbsp;ns)</span><br>
<span class="lineno"></span><span class="comment" id="1531138">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Atomically,</span><br>
<span class="lineno">15</span><span class="comment" id="1531154">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(*addr&nbsp;==&nbsp;val)&nbsp;sleep</span><br>
<span class="lineno"></span><span class="comment" id="1531182">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Might&nbsp;be&nbsp;woken&nbsp;up&nbsp;spuriously;&nbsp;that&#39;s&nbsp;allowed.</span><br>
<span class="lineno"></span><span class="comment" id="1531232">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Don&#39;t&nbsp;sleep&nbsp;longer&nbsp;than&nbsp;ns;&nbsp;ns&nbsp;&lt;&nbsp;0&nbsp;means&nbsp;forever.</span><br>
<span class="lineno"></span><span class="comment" id="1531286">//</span><br>
<span class="lineno"></span><span class="comment" id="1531289">//&nbsp;&nbsp;&nbsp;&nbsp;runtime路futexwakeup(uint32&nbsp;*addr,&nbsp;uint32&nbsp;cnt)</span><br>
<span class="lineno">20</span><span class="comment" id="1531339">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;any&nbsp;procs&nbsp;are&nbsp;sleeping&nbsp;on&nbsp;addr,&nbsp;wake&nbsp;up&nbsp;at&nbsp;most&nbsp;cnt.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1531400">const</span>&nbsp;<span class="op" id="1531406">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1531409">mutex_unlocked</span>&nbsp;<span class="op" id="1531424">=</span>&nbsp;<span class="num" id="1531426">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1531429">mutex_locked</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1531444">=</span>&nbsp;<span class="num" id="1531446">1</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1531449">mutex_sleeping</span>&nbsp;<span class="op" id="1531464">=</span>&nbsp;<span class="num" id="1531466">2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1531470">active_spin</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1531486">=</span>&nbsp;<span class="num" id="1531488">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1531491">active_spin_cnt</span>&nbsp;<span class="op" id="1531507">=</span>&nbsp;<span class="num" id="1531509">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1531513">passive_spin</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1531529">=</span>&nbsp;<span class="num" id="1531531">1</span><br>
<span class="lineno">30</span><span class="op" id="1531533">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1531536">//&nbsp;Possible&nbsp;lock&nbsp;states&nbsp;are&nbsp;mutex_unlocked,&nbsp;mutex_locked&nbsp;and&nbsp;mutex_sleeping.</span><br>
<span class="lineno"></span><span class="comment" id="1531613">//&nbsp;mutex_sleeping&nbsp;means&nbsp;that&nbsp;there&nbsp;is&nbsp;presumably&nbsp;at&nbsp;least&nbsp;one&nbsp;sleeping&nbsp;thread.</span><br>
<span class="lineno"></span><span class="comment" id="1531692">//&nbsp;Note&nbsp;that&nbsp;there&nbsp;can&nbsp;be&nbsp;spinning&nbsp;threads&nbsp;during&nbsp;all&nbsp;states&nbsp;-&nbsp;they&nbsp;do&nbsp;not</span><br>
<span class="lineno">35</span><span class="comment" id="1531767">//&nbsp;affect&nbsp;mutex&#39;s&nbsp;state.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1531793">func</span>&nbsp;<span class="ident" id="1531798">futexsleep</span><span class="op" id="1531808">(</span><span class="ident" id="1531809">addr</span>&nbsp;<span class="op" id="1531814">*</span><span class="builtintype" id="1531815">uint32</span><span class="op" id="1531821">,</span>&nbsp;<span class="ident" id="1531823">val</span>&nbsp;<span class="builtintype" id="1531827">uint32</span><span class="op" id="1531833">,</span>&nbsp;<span class="ident" id="1531835">ns</span>&nbsp;<span class="ident" id="1531838">int64</span><span class="op" id="1531843">)</span><br>
<span class="lineno"></span><span class="keyword" id="1531845">func</span>&nbsp;<span class="ident" id="1531850">futexwakeup</span><span class="op" id="1531861">(</span><span class="ident" id="1531862">addr</span>&nbsp;<span class="op" id="1531867">*</span><span class="builtintype" id="1531868">uint32</span><span class="op" id="1531874">,</span>&nbsp;<span class="ident" id="1531876">cnt</span>&nbsp;<span class="builtintype" id="1531880">uint32</span><span class="op" id="1531886">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="1531889">//&nbsp;We&nbsp;use&nbsp;the&nbsp;uintptr&nbsp;mutex.key&nbsp;and&nbsp;note.key&nbsp;as&nbsp;a&nbsp;uint32.</span><br>
<span class="lineno"></span><span class="keyword" id="1531947">func</span>&nbsp;<span class="ident" id="1531952">key32</span><span class="op" id="1531957">(</span><span class="ident" id="1531958">p</span>&nbsp;<span class="op" id="1531960">*</span><span class="builtintype" id="1531961">uintptr</span><span class="op" id="1531968">)</span>&nbsp;<span class="op" id="1531970">*</span><span class="builtintype" id="1531971">uint32</span>&nbsp;<span class="op" id="1531978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1531981">return</span>&nbsp;<span class="op" id="1531988">(</span><span class="op" id="1531989">*</span><span class="builtintype" id="1531990">uint32</span><span class="op" id="1531996">)</span><span class="op" id="1531997">(</span><span class="ident" id="1531998">unsafe</span><span class="op" id="1532004">.</span><span class="ident" id="1532005">Pointer</span><span class="op" id="1532012">(</span><span class="ident" id="1532013">p</span><span class="op" id="1532014">)</span><span class="op" id="1532015">)</span><br>
<span class="lineno"></span><span class="op" id="1532017">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="1532020">func</span>&nbsp;<span class="ident" id="1532025">lock</span><span class="op" id="1532029">(</span><span class="ident" id="1532030">l</span>&nbsp;<span class="op" id="1532032">*</span><span class="ident" id="1532033">mutex</span><span class="op" id="1532038">)</span>&nbsp;<span class="op" id="1532040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1532043">gp</span>&nbsp;<span class="op" id="1532046">:=</span>&nbsp;<span class="ident" id="1532049">getg</span><span class="op" id="1532053">(</span><span class="op" id="1532054">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1532058">if</span>&nbsp;<span class="ident" id="1532061">gp</span><span class="op" id="1532063">.</span><span class="ident" id="1532064">m</span><span class="op" id="1532065">.</span><span class="ident" id="1532066">locks</span>&nbsp;<span class="op" id="1532072">&lt;</span>&nbsp;<span class="num" id="1532074">0</span>&nbsp;<span class="op" id="1532076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1532080">gothrow</span><span class="op" id="1532087">(</span><span class="string" id="1532088">&#34;runtime路lock:&nbsp;lock&nbsp;count&#34;</span><span class="op" id="1532115">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1532118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1532121">gp</span><span class="op" id="1532123">.</span><span class="ident" id="1532124">m</span><span class="op" id="1532125">.</span><span class="ident" id="1532126">locks</span><span class="op" id="1532131">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1532136">//&nbsp;Speculative&nbsp;grab&nbsp;for&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1532167">v</span>&nbsp;<span class="op" id="1532169">:=</span>&nbsp;<span class="ident" id="1532172">xchg</span><span class="op" id="1532176">(</span><span class="ident" id="1532177">key32</span><span class="op" id="1532182">(</span><span class="op" id="1532183">&amp;</span><span class="ident" id="1532184">l</span><span class="op" id="1532185">.</span><span class="ident" id="1532186">key</span><span class="op" id="1532189">)</span><span class="op" id="1532190">,</span>&nbsp;<span class="ident" id="1532192">mutex_locked</span><span class="op" id="1532204">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1532207">if</span>&nbsp;<span class="ident" id="1532210">v</span>&nbsp;<span class="op" id="1532212">==</span>&nbsp;<span class="ident" id="1532215">mutex_unlocked</span>&nbsp;<span class="op" id="1532230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1532234">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1532242">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1532246">//&nbsp;wait&nbsp;is&nbsp;either&nbsp;MUTEX_LOCKED&nbsp;or&nbsp;MUTEX_SLEEPING</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1532296">//&nbsp;depending&nbsp;on&nbsp;whether&nbsp;there&nbsp;is&nbsp;a&nbsp;thread&nbsp;sleeping</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1532348">//&nbsp;on&nbsp;this&nbsp;mutex.&nbsp;&nbsp;If&nbsp;we&nbsp;ever&nbsp;change&nbsp;l-&gt;key&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1532398">//&nbsp;MUTEX_SLEEPING&nbsp;to&nbsp;some&nbsp;other&nbsp;value,&nbsp;we&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1532449">//&nbsp;careful&nbsp;to&nbsp;change&nbsp;it&nbsp;back&nbsp;to&nbsp;MUTEX_SLEEPING&nbsp;before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1532504">//&nbsp;returning,&nbsp;to&nbsp;ensure&nbsp;that&nbsp;the&nbsp;sleeping&nbsp;thread&nbsp;gets</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1532559">//&nbsp;its&nbsp;wakeup&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1532580">wait</span>&nbsp;<span class="op" id="1532585">:=</span>&nbsp;<span class="ident" id="1532588">v</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1532592">//&nbsp;On&nbsp;uniprocessors,&nbsp;no&nbsp;point&nbsp;spinning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1532633">//&nbsp;On&nbsp;multiprocessors,&nbsp;spin&nbsp;for&nbsp;ACTIVE_SPIN&nbsp;attempts.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1532688">spin</span>&nbsp;<span class="op" id="1532693">:=</span>&nbsp;<span class="num" id="1532696">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1532699">if</span>&nbsp;<span class="ident" id="1532702">ncpu</span>&nbsp;<span class="op" id="1532707">&gt;</span>&nbsp;<span class="num" id="1532709">1</span>&nbsp;<span class="op" id="1532711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1532715">spin</span>&nbsp;<span class="op" id="1532720">=</span>&nbsp;<span class="ident" id="1532722">active_spin</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1532735">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1532738">for</span>&nbsp;<span class="op" id="1532742">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1532746">//&nbsp;Try&nbsp;for&nbsp;lock,&nbsp;spinning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1532775">for</span>&nbsp;<span class="ident" id="1532779">i</span>&nbsp;<span class="op" id="1532781">:=</span>&nbsp;<span class="num" id="1532784">0</span><span class="op" id="1532785">;</span>&nbsp;<span class="ident" id="1532787">i</span>&nbsp;<span class="op" id="1532789">&lt;</span>&nbsp;<span class="ident" id="1532791">spin</span><span class="op" id="1532795">;</span>&nbsp;<span class="ident" id="1532797">i</span><span class="op" id="1532798">++</span>&nbsp;<span class="op" id="1532801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1532806">for</span>&nbsp;<span class="ident" id="1532810">l</span><span class="op" id="1532811">.</span><span class="ident" id="1532812">key</span>&nbsp;<span class="op" id="1532816">==</span>&nbsp;<span class="ident" id="1532819">mutex_unlocked</span>&nbsp;<span class="op" id="1532834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1532840">if</span>&nbsp;<span class="ident" id="1532843">cas</span><span class="op" id="1532846">(</span><span class="ident" id="1532847">key32</span><span class="op" id="1532852">(</span><span class="op" id="1532853">&amp;</span><span class="ident" id="1532854">l</span><span class="op" id="1532855">.</span><span class="ident" id="1532856">key</span><span class="op" id="1532859">)</span><span class="op" id="1532860">,</span>&nbsp;<span class="ident" id="1532862">mutex_unlocked</span><span class="op" id="1532876">,</span>&nbsp;<span class="ident" id="1532878">wait</span><span class="op" id="1532882">)</span>&nbsp;<span class="op" id="1532884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1532891">return</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1532902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1532907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1532912">procyield</span><span class="op" id="1532921">(</span><span class="ident" id="1532922">active_spin_cnt</span><span class="op" id="1532937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1532941">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1532946">//&nbsp;Try&nbsp;for&nbsp;lock,&nbsp;rescheduling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1532979">for</span>&nbsp;<span class="ident" id="1532983">i</span>&nbsp;<span class="op" id="1532985">:=</span>&nbsp;<span class="num" id="1532988">0</span><span class="op" id="1532989">;</span>&nbsp;<span class="ident" id="1532991">i</span>&nbsp;<span class="op" id="1532993">&lt;</span>&nbsp;<span class="ident" id="1532995">passive_spin</span><span class="op" id="1533007">;</span>&nbsp;<span class="ident" id="1533009">i</span><span class="op" id="1533010">++</span>&nbsp;<span class="op" id="1533013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1533018">for</span>&nbsp;<span class="ident" id="1533022">l</span><span class="op" id="1533023">.</span><span class="ident" id="1533024">key</span>&nbsp;<span class="op" id="1533028">==</span>&nbsp;<span class="ident" id="1533031">mutex_unlocked</span>&nbsp;<span class="op" id="1533046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1533052">if</span>&nbsp;<span class="ident" id="1533055">cas</span><span class="op" id="1533058">(</span><span class="ident" id="1533059">key32</span><span class="op" id="1533064">(</span><span class="op" id="1533065">&amp;</span><span class="ident" id="1533066">l</span><span class="op" id="1533067">.</span><span class="ident" id="1533068">key</span><span class="op" id="1533071">)</span><span class="op" id="1533072">,</span>&nbsp;<span class="ident" id="1533074">mutex_unlocked</span><span class="op" id="1533088">,</span>&nbsp;<span class="ident" id="1533090">wait</span><span class="op" id="1533094">)</span>&nbsp;<span class="op" id="1533096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1533103">return</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1533114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1533119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1533124">osyield</span><span class="op" id="1533131">(</span><span class="op" id="1533132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1533136">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1533141">//&nbsp;Sleep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1533153">v</span>&nbsp;<span class="op" id="1533155">=</span>&nbsp;<span class="ident" id="1533157">xchg</span><span class="op" id="1533161">(</span><span class="ident" id="1533162">key32</span><span class="op" id="1533167">(</span><span class="op" id="1533168">&amp;</span><span class="ident" id="1533169">l</span><span class="op" id="1533170">.</span><span class="ident" id="1533171">key</span><span class="op" id="1533174">)</span><span class="op" id="1533175">,</span>&nbsp;<span class="ident" id="1533177">mutex_sleeping</span><span class="op" id="1533191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1533195">if</span>&nbsp;<span class="ident" id="1533198">v</span>&nbsp;<span class="op" id="1533200">==</span>&nbsp;<span class="ident" id="1533203">mutex_unlocked</span>&nbsp;<span class="op" id="1533218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1533223">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1533232">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1533236">wait</span>&nbsp;<span class="op" id="1533241">=</span>&nbsp;<span class="ident" id="1533243">mutex_sleeping</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1533260">futexsleep</span><span class="op" id="1533270">(</span><span class="ident" id="1533271">key32</span><span class="op" id="1533276">(</span><span class="op" id="1533277">&amp;</span><span class="ident" id="1533278">l</span><span class="op" id="1533279">.</span><span class="ident" id="1533280">key</span><span class="op" id="1533283">)</span><span class="op" id="1533284">,</span>&nbsp;<span class="ident" id="1533286">mutex_sleeping</span><span class="op" id="1533300">,</span>&nbsp;<span class="op" id="1533302">-</span><span class="num" id="1533303">1</span><span class="op" id="1533304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1533307">}</span><br>
<span class="lineno"></span><span class="op" id="1533309">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="1533312">func</span>&nbsp;<span class="ident" id="1533317">unlock</span><span class="op" id="1533323">(</span><span class="ident" id="1533324">l</span>&nbsp;<span class="op" id="1533326">*</span><span class="ident" id="1533327">mutex</span><span class="op" id="1533332">)</span>&nbsp;<span class="op" id="1533334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1533337">v</span>&nbsp;<span class="op" id="1533339">:=</span>&nbsp;<span class="ident" id="1533342">xchg</span><span class="op" id="1533346">(</span><span class="ident" id="1533347">key32</span><span class="op" id="1533352">(</span><span class="op" id="1533353">&amp;</span><span class="ident" id="1533354">l</span><span class="op" id="1533355">.</span><span class="ident" id="1533356">key</span><span class="op" id="1533359">)</span><span class="op" id="1533360">,</span>&nbsp;<span class="ident" id="1533362">mutex_unlocked</span><span class="op" id="1533376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1533379">if</span>&nbsp;<span class="ident" id="1533382">v</span>&nbsp;<span class="op" id="1533384">==</span>&nbsp;<span class="ident" id="1533387">mutex_unlocked</span>&nbsp;<span class="op" id="1533402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1533406">gothrow</span><span class="op" id="1533413">(</span><span class="string" id="1533414">&#34;unlock&nbsp;of&nbsp;unlocked&nbsp;lock&#34;</span><span class="op" id="1533439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1533442">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1533445">if</span>&nbsp;<span class="ident" id="1533448">v</span>&nbsp;<span class="op" id="1533450">==</span>&nbsp;<span class="ident" id="1533453">mutex_sleeping</span>&nbsp;<span class="op" id="1533468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1533472">futexwakeup</span><span class="op" id="1533483">(</span><span class="ident" id="1533484">key32</span><span class="op" id="1533489">(</span><span class="op" id="1533490">&amp;</span><span class="ident" id="1533491">l</span><span class="op" id="1533492">.</span><span class="ident" id="1533493">key</span><span class="op" id="1533496">)</span><span class="op" id="1533497">,</span>&nbsp;<span class="num" id="1533499">1</span><span class="op" id="1533500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1533503">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1533507">gp</span>&nbsp;<span class="op" id="1533510">:=</span>&nbsp;<span class="ident" id="1533513">getg</span><span class="op" id="1533517">(</span><span class="op" id="1533518">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1533521">gp</span><span class="op" id="1533523">.</span><span class="ident" id="1533524">m</span><span class="op" id="1533525">.</span><span class="ident" id="1533526">locks</span><span class="op" id="1533531">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1533535">if</span>&nbsp;<span class="ident" id="1533538">gp</span><span class="op" id="1533540">.</span><span class="ident" id="1533541">m</span><span class="op" id="1533542">.</span><span class="ident" id="1533543">locks</span>&nbsp;<span class="op" id="1533549">&lt;</span>&nbsp;<span class="num" id="1533551">0</span>&nbsp;<span class="op" id="1533553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1533557">gothrow</span><span class="op" id="1533564">(</span><span class="string" id="1533565">&#34;runtime路unlock:&nbsp;lock&nbsp;count&#34;</span><span class="op" id="1533594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1533597">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1533600">if</span>&nbsp;<span class="ident" id="1533603">gp</span><span class="op" id="1533605">.</span><span class="ident" id="1533606">m</span><span class="op" id="1533607">.</span><span class="ident" id="1533608">locks</span>&nbsp;<span class="op" id="1533614">==</span>&nbsp;<span class="num" id="1533617">0</span>&nbsp;<span class="op" id="1533619">&amp;&amp;</span>&nbsp;<span class="ident" id="1533622">gp</span><span class="op" id="1533624">.</span><span class="ident" id="1533625">preempt</span>&nbsp;<span class="op" id="1533633">{</span>&nbsp;<span class="comment" id="1533635">//&nbsp;restore&nbsp;the&nbsp;preemption&nbsp;request&nbsp;in&nbsp;case&nbsp;we&#39;ve&nbsp;cleared&nbsp;it&nbsp;in&nbsp;newstack</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1533708">gp</span><span class="op" id="1533710">.</span><span class="ident" id="1533711">stackguard0</span>&nbsp;<span class="op" id="1533723">=</span>&nbsp;<span class="ident" id="1533725">stackPreempt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1533739">}</span><br>
<span class="lineno"></span><span class="op" id="1533741">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1533744">//&nbsp;One-time&nbsp;notifications.</span><br>
<span class="lineno">125</span><span class="keyword" id="1533771">func</span>&nbsp;<span class="ident" id="1533776">noteclear</span><span class="op" id="1533785">(</span><span class="ident" id="1533786">n</span>&nbsp;<span class="op" id="1533788">*</span><span class="ident" id="1533789">note</span><span class="op" id="1533793">)</span>&nbsp;<span class="op" id="1533795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1533798">n</span><span class="op" id="1533799">.</span><span class="ident" id="1533800">key</span>&nbsp;<span class="op" id="1533804">=</span>&nbsp;<span class="num" id="1533806">0</span><br>
<span class="lineno"></span><span class="op" id="1533808">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1533811">func</span>&nbsp;<span class="ident" id="1533816">notewakeup</span><span class="op" id="1533826">(</span><span class="ident" id="1533827">n</span>&nbsp;<span class="op" id="1533829">*</span><span class="ident" id="1533830">note</span><span class="op" id="1533834">)</span>&nbsp;<span class="op" id="1533836">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1533839">old</span>&nbsp;<span class="op" id="1533843">:=</span>&nbsp;<span class="ident" id="1533846">xchg</span><span class="op" id="1533850">(</span><span class="ident" id="1533851">key32</span><span class="op" id="1533856">(</span><span class="op" id="1533857">&amp;</span><span class="ident" id="1533858">n</span><span class="op" id="1533859">.</span><span class="ident" id="1533860">key</span><span class="op" id="1533863">)</span><span class="op" id="1533864">,</span>&nbsp;<span class="num" id="1533866">1</span><span class="op" id="1533867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1533870">if</span>&nbsp;<span class="ident" id="1533873">old</span>&nbsp;<span class="op" id="1533877">!=</span>&nbsp;<span class="num" id="1533880">0</span>&nbsp;<span class="op" id="1533882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1533886">print</span><span class="op" id="1533891">(</span><span class="string" id="1533892">&#34;notewakeup&nbsp;-&nbsp;double&nbsp;wakeup&nbsp;(&#34;</span><span class="op" id="1533922">,</span>&nbsp;<span class="ident" id="1533924">old</span><span class="op" id="1533927">,</span>&nbsp;<span class="string" id="1533929">&#34;)\n&#34;</span><span class="op" id="1533934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1533938">gothrow</span><span class="op" id="1533945">(</span><span class="string" id="1533946">&#34;notewakeup&nbsp;-&nbsp;double&nbsp;wakeup&#34;</span><span class="op" id="1533974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1533977">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1533980">futexwakeup</span><span class="op" id="1533991">(</span><span class="ident" id="1533992">key32</span><span class="op" id="1533997">(</span><span class="op" id="1533998">&amp;</span><span class="ident" id="1533999">n</span><span class="op" id="1534000">.</span><span class="ident" id="1534001">key</span><span class="op" id="1534004">)</span><span class="op" id="1534005">,</span>&nbsp;<span class="num" id="1534007">1</span><span class="op" id="1534008">)</span><br>
<span class="lineno"></span><span class="op" id="1534010">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1534013">func</span>&nbsp;<span class="ident" id="1534018">notesleep</span><span class="op" id="1534027">(</span><span class="ident" id="1534028">n</span>&nbsp;<span class="op" id="1534030">*</span><span class="ident" id="1534031">note</span><span class="op" id="1534035">)</span>&nbsp;<span class="op" id="1534037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534040">gp</span>&nbsp;<span class="op" id="1534043">:=</span>&nbsp;<span class="ident" id="1534046">getg</span><span class="op" id="1534050">(</span><span class="op" id="1534051">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1534054">if</span>&nbsp;<span class="ident" id="1534057">gp</span>&nbsp;<span class="op" id="1534060">!=</span>&nbsp;<span class="ident" id="1534063">gp</span><span class="op" id="1534065">.</span><span class="ident" id="1534066">m</span><span class="op" id="1534067">.</span><span class="ident" id="1534068">g0</span>&nbsp;<span class="op" id="1534071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534075">gothrow</span><span class="op" id="1534082">(</span><span class="string" id="1534083">&#34;notesleep&nbsp;not&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1534104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1534107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1534110">for</span>&nbsp;<span class="ident" id="1534114">atomicload</span><span class="op" id="1534124">(</span><span class="ident" id="1534125">key32</span><span class="op" id="1534130">(</span><span class="op" id="1534131">&amp;</span><span class="ident" id="1534132">n</span><span class="op" id="1534133">.</span><span class="ident" id="1534134">key</span><span class="op" id="1534137">)</span><span class="op" id="1534138">)</span>&nbsp;<span class="op" id="1534140">==</span>&nbsp;<span class="num" id="1534143">0</span>&nbsp;<span class="op" id="1534145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534149">gp</span><span class="op" id="1534151">.</span><span class="ident" id="1534152">m</span><span class="op" id="1534153">.</span><span class="ident" id="1534154">blocked</span>&nbsp;<span class="op" id="1534162">=</span>&nbsp;<span class="builtintype" id="1534164">true</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534171">futexsleep</span><span class="op" id="1534181">(</span><span class="ident" id="1534182">key32</span><span class="op" id="1534187">(</span><span class="op" id="1534188">&amp;</span><span class="ident" id="1534189">n</span><span class="op" id="1534190">.</span><span class="ident" id="1534191">key</span><span class="op" id="1534194">)</span><span class="op" id="1534195">,</span>&nbsp;<span class="num" id="1534197">0</span><span class="op" id="1534198">,</span>&nbsp;<span class="op" id="1534200">-</span><span class="num" id="1534201">1</span><span class="op" id="1534202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534206">gp</span><span class="op" id="1534208">.</span><span class="ident" id="1534209">m</span><span class="op" id="1534210">.</span><span class="ident" id="1534211">blocked</span>&nbsp;<span class="op" id="1534219">=</span>&nbsp;<span class="builtintype" id="1534221">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1534228">}</span><br>
<span class="lineno"></span><span class="op" id="1534230">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="1534233">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1534246">func</span>&nbsp;<span class="ident" id="1534251">notetsleep_internal</span><span class="op" id="1534270">(</span><span class="ident" id="1534271">n</span>&nbsp;<span class="op" id="1534273">*</span><span class="ident" id="1534274">note</span><span class="op" id="1534278">,</span>&nbsp;<span class="ident" id="1534280">ns</span>&nbsp;<span class="ident" id="1534283">int64</span><span class="op" id="1534288">)</span>&nbsp;<span class="builtintype" id="1534290">bool</span>&nbsp;<span class="op" id="1534295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534298">gp</span>&nbsp;<span class="op" id="1534301">:=</span>&nbsp;<span class="ident" id="1534304">getg</span><span class="op" id="1534308">(</span><span class="op" id="1534309">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1534313">if</span>&nbsp;<span class="ident" id="1534316">ns</span>&nbsp;<span class="op" id="1534319">&lt;</span>&nbsp;<span class="num" id="1534321">0</span>&nbsp;<span class="op" id="1534323">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1534327">for</span>&nbsp;<span class="ident" id="1534331">atomicload</span><span class="op" id="1534341">(</span><span class="ident" id="1534342">key32</span><span class="op" id="1534347">(</span><span class="op" id="1534348">&amp;</span><span class="ident" id="1534349">n</span><span class="op" id="1534350">.</span><span class="ident" id="1534351">key</span><span class="op" id="1534354">)</span><span class="op" id="1534355">)</span>&nbsp;<span class="op" id="1534357">==</span>&nbsp;<span class="num" id="1534360">0</span>&nbsp;<span class="op" id="1534362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534367">gp</span><span class="op" id="1534369">.</span><span class="ident" id="1534370">m</span><span class="op" id="1534371">.</span><span class="ident" id="1534372">blocked</span>&nbsp;<span class="op" id="1534380">=</span>&nbsp;<span class="builtintype" id="1534382">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534390">futexsleep</span><span class="op" id="1534400">(</span><span class="ident" id="1534401">key32</span><span class="op" id="1534406">(</span><span class="op" id="1534407">&amp;</span><span class="ident" id="1534408">n</span><span class="op" id="1534409">.</span><span class="ident" id="1534410">key</span><span class="op" id="1534413">)</span><span class="op" id="1534414">,</span>&nbsp;<span class="num" id="1534416">0</span><span class="op" id="1534417">,</span>&nbsp;<span class="op" id="1534419">-</span><span class="num" id="1534420">1</span><span class="op" id="1534421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534426">gp</span><span class="op" id="1534428">.</span><span class="ident" id="1534429">m</span><span class="op" id="1534430">.</span><span class="ident" id="1534431">blocked</span>&nbsp;<span class="op" id="1534439">=</span>&nbsp;<span class="builtintype" id="1534441">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1534449">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1534453">return</span>&nbsp;<span class="builtintype" id="1534460">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1534466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1534470">if</span>&nbsp;<span class="ident" id="1534473">atomicload</span><span class="op" id="1534483">(</span><span class="ident" id="1534484">key32</span><span class="op" id="1534489">(</span><span class="op" id="1534490">&amp;</span><span class="ident" id="1534491">n</span><span class="op" id="1534492">.</span><span class="ident" id="1534493">key</span><span class="op" id="1534496">)</span><span class="op" id="1534497">)</span>&nbsp;<span class="op" id="1534499">!=</span>&nbsp;<span class="num" id="1534502">0</span>&nbsp;<span class="op" id="1534504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1534508">return</span>&nbsp;<span class="builtintype" id="1534515">true</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1534521">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534525">deadline</span>&nbsp;<span class="op" id="1534534">:=</span>&nbsp;<span class="ident" id="1534537">nanotime</span><span class="op" id="1534545">(</span><span class="op" id="1534546">)</span>&nbsp;<span class="op" id="1534548">+</span>&nbsp;<span class="ident" id="1534550">ns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1534554">for</span>&nbsp;<span class="op" id="1534558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534562">gp</span><span class="op" id="1534564">.</span><span class="ident" id="1534565">m</span><span class="op" id="1534566">.</span><span class="ident" id="1534567">blocked</span>&nbsp;<span class="op" id="1534575">=</span>&nbsp;<span class="builtintype" id="1534577">true</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534584">futexsleep</span><span class="op" id="1534594">(</span><span class="ident" id="1534595">key32</span><span class="op" id="1534600">(</span><span class="op" id="1534601">&amp;</span><span class="ident" id="1534602">n</span><span class="op" id="1534603">.</span><span class="ident" id="1534604">key</span><span class="op" id="1534607">)</span><span class="op" id="1534608">,</span>&nbsp;<span class="num" id="1534610">0</span><span class="op" id="1534611">,</span>&nbsp;<span class="ident" id="1534613">ns</span><span class="op" id="1534615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534619">gp</span><span class="op" id="1534621">.</span><span class="ident" id="1534622">m</span><span class="op" id="1534623">.</span><span class="ident" id="1534624">blocked</span>&nbsp;<span class="op" id="1534632">=</span>&nbsp;<span class="builtintype" id="1534634">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1534642">if</span>&nbsp;<span class="ident" id="1534645">atomicload</span><span class="op" id="1534655">(</span><span class="ident" id="1534656">key32</span><span class="op" id="1534661">(</span><span class="op" id="1534662">&amp;</span><span class="ident" id="1534663">n</span><span class="op" id="1534664">.</span><span class="ident" id="1534665">key</span><span class="op" id="1534668">)</span><span class="op" id="1534669">)</span>&nbsp;<span class="op" id="1534671">!=</span>&nbsp;<span class="num" id="1534674">0</span>&nbsp;<span class="op" id="1534676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1534681">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1534689">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534693">now</span>&nbsp;<span class="op" id="1534697">:=</span>&nbsp;<span class="ident" id="1534700">nanotime</span><span class="op" id="1534708">(</span><span class="op" id="1534709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1534713">if</span>&nbsp;<span class="ident" id="1534716">now</span>&nbsp;<span class="op" id="1534720">&gt;=</span>&nbsp;<span class="ident" id="1534723">deadline</span>&nbsp;<span class="op" id="1534732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1534737">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1534745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534749">ns</span>&nbsp;<span class="op" id="1534752">=</span>&nbsp;<span class="ident" id="1534754">deadline</span>&nbsp;<span class="op" id="1534763">-</span>&nbsp;<span class="ident" id="1534765">now</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1534770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1534773">return</span>&nbsp;<span class="ident" id="1534780">atomicload</span><span class="op" id="1534790">(</span><span class="ident" id="1534791">key32</span><span class="op" id="1534796">(</span><span class="op" id="1534797">&amp;</span><span class="ident" id="1534798">n</span><span class="op" id="1534799">.</span><span class="ident" id="1534800">key</span><span class="op" id="1534803">)</span><span class="op" id="1534804">)</span>&nbsp;<span class="op" id="1534806">!=</span>&nbsp;<span class="num" id="1534809">0</span><br>
<span class="lineno"></span><span class="op" id="1534811">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1534814">func</span>&nbsp;<span class="ident" id="1534819">notetsleep</span><span class="op" id="1534829">(</span><span class="ident" id="1534830">n</span>&nbsp;<span class="op" id="1534832">*</span><span class="ident" id="1534833">note</span><span class="op" id="1534837">,</span>&nbsp;<span class="ident" id="1534839">ns</span>&nbsp;<span class="ident" id="1534842">int64</span><span class="op" id="1534847">)</span>&nbsp;<span class="builtintype" id="1534849">bool</span>&nbsp;<span class="op" id="1534854">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534857">gp</span>&nbsp;<span class="op" id="1534860">:=</span>&nbsp;<span class="ident" id="1534863">getg</span><span class="op" id="1534867">(</span><span class="op" id="1534868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1534871">if</span>&nbsp;<span class="ident" id="1534874">gp</span>&nbsp;<span class="op" id="1534877">!=</span>&nbsp;<span class="ident" id="1534880">gp</span><span class="op" id="1534882">.</span><span class="ident" id="1534883">m</span><span class="op" id="1534884">.</span><span class="ident" id="1534885">g0</span>&nbsp;<span class="op" id="1534888">&amp;&amp;</span>&nbsp;<span class="ident" id="1534891">gp</span><span class="op" id="1534893">.</span><span class="ident" id="1534894">m</span><span class="op" id="1534895">.</span><span class="ident" id="1534896">gcing</span>&nbsp;<span class="op" id="1534902">==</span>&nbsp;<span class="num" id="1534905">0</span>&nbsp;<span class="op" id="1534907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534911">gothrow</span><span class="op" id="1534918">(</span><span class="string" id="1534919">&#34;notetsleep&nbsp;not&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1534941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1534944">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1534948">return</span>&nbsp;<span class="ident" id="1534955">notetsleep_internal</span><span class="op" id="1534974">(</span><span class="ident" id="1534975">n</span><span class="op" id="1534976">,</span>&nbsp;<span class="ident" id="1534978">ns</span><span class="op" id="1534980">)</span><br>
<span class="lineno"></span><span class="op" id="1534982">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1534985">//&nbsp;same&nbsp;as&nbsp;runtime路notetsleep,&nbsp;but&nbsp;called&nbsp;on&nbsp;user&nbsp;g&nbsp;(not&nbsp;g0)</span><br>
<span class="lineno"></span><span class="comment" id="1535047">//&nbsp;calls&nbsp;only&nbsp;nosplit&nbsp;functions&nbsp;between&nbsp;entersyscallblock/exitsyscall</span><br>
<span class="lineno">195</span><span class="keyword" id="1535117">func</span>&nbsp;<span class="ident" id="1535122">notetsleepg</span><span class="op" id="1535133">(</span><span class="ident" id="1535134">n</span>&nbsp;<span class="op" id="1535136">*</span><span class="ident" id="1535137">note</span><span class="op" id="1535141">,</span>&nbsp;<span class="ident" id="1535143">ns</span>&nbsp;<span class="ident" id="1535146">int64</span><span class="op" id="1535151">)</span>&nbsp;<span class="builtintype" id="1535153">bool</span>&nbsp;<span class="op" id="1535158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1535161">gp</span>&nbsp;<span class="op" id="1535164">:=</span>&nbsp;<span class="ident" id="1535167">getg</span><span class="op" id="1535171">(</span><span class="op" id="1535172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1535175">if</span>&nbsp;<span class="ident" id="1535178">gp</span>&nbsp;<span class="op" id="1535181">==</span>&nbsp;<span class="ident" id="1535184">gp</span><span class="op" id="1535186">.</span><span class="ident" id="1535187">m</span><span class="op" id="1535188">.</span><span class="ident" id="1535189">g0</span>&nbsp;<span class="op" id="1535192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1535196">gothrow</span><span class="op" id="1535203">(</span><span class="string" id="1535204">&#34;notetsleepg&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1535223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1535226">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1535230">entersyscallblock</span><span class="op" id="1535247">(</span><span class="op" id="1535248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1535251">ok</span>&nbsp;<span class="op" id="1535254">:=</span>&nbsp;<span class="ident" id="1535257">notetsleep_internal</span><span class="op" id="1535276">(</span><span class="ident" id="1535277">n</span><span class="op" id="1535278">,</span>&nbsp;<span class="ident" id="1535280">ns</span><span class="op" id="1535282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1535285">exitsyscall</span><span class="op" id="1535296">(</span><span class="op" id="1535297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1535300">return</span>&nbsp;<span class="ident" id="1535307">ok</span><br>
<span class="lineno">205</span><span class="op" id="1535310">}</span>
</div>
</body>
</html>
