<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4724691">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4724746">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4724800">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4724851">//&nbsp;HTTP&nbsp;reverse&nbsp;proxy&nbsp;handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4724882">package</span>&nbsp;<span class="ident" id="4724890">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4724900">import</span>&nbsp;<span class="op" id="4724907">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4724910">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4724916">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4724923">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4724930">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4724942">&#34;net/url&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4724953">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4724964">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4724972">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="4724979">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="4724982">//&nbsp;onExitFlushLoop&nbsp;is&nbsp;a&nbsp;callback&nbsp;set&nbsp;by&nbsp;tests&nbsp;to&nbsp;detect&nbsp;the&nbsp;state&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4725055">//&nbsp;flushLoop()&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="4725081">var</span>&nbsp;<span class="ident" id="4725085">onExitFlushLoop</span>&nbsp;<span class="keyword" id="4725101">func</span><span class="op" id="4725105">(</span><span class="op" id="4725106">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4725109">//&nbsp;ReverseProxy&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;Handler&nbsp;that&nbsp;takes&nbsp;an&nbsp;incoming&nbsp;request&nbsp;and</span><br>
<span class="lineno">25</span><span class="comment" id="4725179">//&nbsp;sends&nbsp;it&nbsp;to&nbsp;another&nbsp;server,&nbsp;proxying&nbsp;the&nbsp;response&nbsp;back&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4725244">//&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="4725255">type</span>&nbsp;<span class="ident" id="4725260">ReverseProxy</span>&nbsp;<span class="keyword" id="4725273">struct</span>&nbsp;<span class="op" id="4725280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4725283">//&nbsp;Director&nbsp;must&nbsp;be&nbsp;a&nbsp;function&nbsp;which&nbsp;modifies</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4725330">//&nbsp;the&nbsp;request&nbsp;into&nbsp;a&nbsp;new&nbsp;request&nbsp;to&nbsp;be&nbsp;sent</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4725376">//&nbsp;using&nbsp;Transport.&nbsp;Its&nbsp;response&nbsp;is&nbsp;then&nbsp;copied</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4725425">//&nbsp;back&nbsp;to&nbsp;the&nbsp;original&nbsp;client&nbsp;unmodified.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4725469">Director</span>&nbsp;<span class="keyword" id="4725478">func</span><span class="op" id="4725482">(</span><span class="op" id="4725483">*</span><span class="ident" id="4725484">http</span><span class="op" id="4725488">.</span><span class="ident" id="4725489">Request</span><span class="op" id="4725496">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4725500">//&nbsp;The&nbsp;transport&nbsp;used&nbsp;to&nbsp;perform&nbsp;proxy&nbsp;requests.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4725550">//&nbsp;If&nbsp;nil,&nbsp;http.DefaultTransport&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4725593">Transport</span>&nbsp;<span class="ident" id="4725603">http</span><span class="op" id="4725607">.</span><span class="ident" id="4725608">RoundTripper</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4725623">//&nbsp;FlushInterval&nbsp;specifies&nbsp;the&nbsp;flush&nbsp;interval</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4725670">//&nbsp;to&nbsp;flush&nbsp;to&nbsp;the&nbsp;client&nbsp;while&nbsp;copying&nbsp;the</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4725715">//&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4725734">//&nbsp;If&nbsp;zero,&nbsp;no&nbsp;periodic&nbsp;flushing&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4725777">FlushInterval</span>&nbsp;<span class="ident" id="4725791">time</span><span class="op" id="4725795">.</span><span class="ident" id="4725796">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4725807">//&nbsp;ErrorLog&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;logger&nbsp;for&nbsp;errors</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4725860">//&nbsp;that&nbsp;occur&nbsp;when&nbsp;attempting&nbsp;to&nbsp;proxy&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4725913">//&nbsp;If&nbsp;nil,&nbsp;logging&nbsp;goes&nbsp;to&nbsp;os.Stderr&nbsp;via&nbsp;the&nbsp;log&nbsp;package&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4725973">//&nbsp;standard&nbsp;logger.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4725994">ErrorLog</span>&nbsp;<span class="op" id="4726003">*</span><span class="ident" id="4726004">log</span><span class="op" id="4726007">.</span><span class="ident" id="4726008">Logger</span><br>
<span class="lineno"></span><span class="op" id="4726015">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="4726018">func</span>&nbsp;<span class="ident" id="4726023">singleJoiningSlash</span><span class="op" id="4726041">(</span><span class="ident" id="4726042">a</span><span class="op" id="4726043">,</span>&nbsp;<span class="ident" id="4726045">b</span>&nbsp;<span class="builtintype" id="4726047">string</span><span class="op" id="4726053">)</span>&nbsp;<span class="builtintype" id="4726055">string</span>&nbsp;<span class="op" id="4726062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4726065">aslash</span>&nbsp;<span class="op" id="4726072">:=</span>&nbsp;<span class="ident" id="4726075">strings</span><span class="op" id="4726082">.</span><span class="ident" id="4726083">HasSuffix</span><span class="op" id="4726092">(</span><span class="ident" id="4726093">a</span><span class="op" id="4726094">,</span>&nbsp;<span class="string" id="4726096">&#34;/&#34;</span><span class="op" id="4726099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4726102">bslash</span>&nbsp;<span class="op" id="4726109">:=</span>&nbsp;<span class="ident" id="4726112">strings</span><span class="op" id="4726119">.</span><span class="ident" id="4726120">HasPrefix</span><span class="op" id="4726129">(</span><span class="ident" id="4726130">b</span><span class="op" id="4726131">,</span>&nbsp;<span class="string" id="4726133">&#34;/&#34;</span><span class="op" id="4726136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4726139">switch</span>&nbsp;<span class="op" id="4726146">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4726149">case</span>&nbsp;<span class="ident" id="4726154">aslash</span>&nbsp;<span class="op" id="4726161">&amp;&amp;</span>&nbsp;<span class="ident" id="4726164">bslash</span><span class="op" id="4726170">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4726174">return</span>&nbsp;<span class="ident" id="4726181">a</span>&nbsp;<span class="op" id="4726183">+</span>&nbsp;<span class="ident" id="4726185">b</span><span class="op" id="4726186">[</span><span class="num" id="4726187">1</span><span class="op" id="4726188">:</span><span class="op" id="4726189">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4726192">case</span>&nbsp;<span class="op" id="4726197">!</span><span class="ident" id="4726198">aslash</span>&nbsp;<span class="op" id="4726205">&amp;&amp;</span>&nbsp;<span class="op" id="4726208">!</span><span class="ident" id="4726209">bslash</span><span class="op" id="4726215">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4726219">return</span>&nbsp;<span class="ident" id="4726226">a</span>&nbsp;<span class="op" id="4726228">+</span>&nbsp;<span class="string" id="4726230">&#34;/&#34;</span>&nbsp;<span class="op" id="4726234">+</span>&nbsp;<span class="ident" id="4726236">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4726239">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4726242">return</span>&nbsp;<span class="ident" id="4726249">a</span>&nbsp;<span class="op" id="4726251">+</span>&nbsp;<span class="ident" id="4726253">b</span><br>
<span class="lineno"></span><span class="op" id="4726255">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4726258">//&nbsp;NewSingleHostReverseProxy&nbsp;returns&nbsp;a&nbsp;new&nbsp;ReverseProxy&nbsp;that&nbsp;rewrites</span><br>
<span class="lineno"></span><span class="comment" id="4726328">//&nbsp;URLs&nbsp;to&nbsp;the&nbsp;scheme,&nbsp;host,&nbsp;and&nbsp;base&nbsp;path&nbsp;provided&nbsp;in&nbsp;target.&nbsp;If&nbsp;the</span><br>
<span class="lineno">65</span><span class="comment" id="4726398">//&nbsp;target&#39;s&nbsp;path&nbsp;is&nbsp;&#34;/base&#34;&nbsp;and&nbsp;the&nbsp;incoming&nbsp;request&nbsp;was&nbsp;for&nbsp;&#34;/dir&#34;,</span><br>
<span class="lineno"></span><span class="comment" id="4726467">//&nbsp;the&nbsp;target&nbsp;request&nbsp;will&nbsp;be&nbsp;for&nbsp;/base/dir.</span><br>
<span class="lineno"></span><span class="keyword" id="4726512">func</span>&nbsp;<span class="ident" id="4726517">NewSingleHostReverseProxy</span><span class="op" id="4726542">(</span><span class="ident" id="4726543">target</span>&nbsp;<span class="op" id="4726550">*</span><span class="ident" id="4726551">url</span><span class="op" id="4726554">.</span><span class="ident" id="4726555">URL</span><span class="op" id="4726558">)</span>&nbsp;<span class="op" id="4726560">*</span><span class="ident" id="4726561">ReverseProxy</span>&nbsp;<span class="op" id="4726574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4726577">targetQuery</span>&nbsp;<span class="op" id="4726589">:=</span>&nbsp;<span class="ident" id="4726592">target</span><span class="op" id="4726598">.</span><span class="ident" id="4726599">RawQuery</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4726609">director</span>&nbsp;<span class="op" id="4726618">:=</span>&nbsp;<span class="keyword" id="4726621">func</span><span class="op" id="4726625">(</span><span class="ident" id="4726626">req</span>&nbsp;<span class="op" id="4726630">*</span><span class="ident" id="4726631">http</span><span class="op" id="4726635">.</span><span class="ident" id="4726636">Request</span><span class="op" id="4726643">)</span>&nbsp;<span class="op" id="4726645">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4726649">req</span><span class="op" id="4726652">.</span><span class="ident" id="4726653">URL</span><span class="op" id="4726656">.</span><span class="ident" id="4726657">Scheme</span>&nbsp;<span class="op" id="4726664">=</span>&nbsp;<span class="ident" id="4726666">target</span><span class="op" id="4726672">.</span><span class="ident" id="4726673">Scheme</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4726682">req</span><span class="op" id="4726685">.</span><span class="ident" id="4726686">URL</span><span class="op" id="4726689">.</span><span class="ident" id="4726690">Host</span>&nbsp;<span class="op" id="4726695">=</span>&nbsp;<span class="ident" id="4726697">target</span><span class="op" id="4726703">.</span><span class="ident" id="4726704">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4726711">req</span><span class="op" id="4726714">.</span><span class="ident" id="4726715">URL</span><span class="op" id="4726718">.</span><span class="ident" id="4726719">Path</span>&nbsp;<span class="op" id="4726724">=</span>&nbsp;<span class="ident" id="4726726">singleJoiningSlash</span><span class="op" id="4726744">(</span><span class="ident" id="4726745">target</span><span class="op" id="4726751">.</span><span class="ident" id="4726752">Path</span><span class="op" id="4726756">,</span>&nbsp;<span class="ident" id="4726758">req</span><span class="op" id="4726761">.</span><span class="ident" id="4726762">URL</span><span class="op" id="4726765">.</span><span class="ident" id="4726766">Path</span><span class="op" id="4726770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4726774">if</span>&nbsp;<span class="ident" id="4726777">targetQuery</span>&nbsp;<span class="op" id="4726789">==</span>&nbsp;<span class="string" id="4726792">&#34;&#34;</span>&nbsp;<span class="op" id="4726795">||</span>&nbsp;<span class="ident" id="4726798">req</span><span class="op" id="4726801">.</span><span class="ident" id="4726802">URL</span><span class="op" id="4726805">.</span><span class="ident" id="4726806">RawQuery</span>&nbsp;<span class="op" id="4726815">==</span>&nbsp;<span class="string" id="4726818">&#34;&#34;</span>&nbsp;<span class="op" id="4726821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4726826">req</span><span class="op" id="4726829">.</span><span class="ident" id="4726830">URL</span><span class="op" id="4726833">.</span><span class="ident" id="4726834">RawQuery</span>&nbsp;<span class="op" id="4726843">=</span>&nbsp;<span class="ident" id="4726845">targetQuery</span>&nbsp;<span class="op" id="4726857">+</span>&nbsp;<span class="ident" id="4726859">req</span><span class="op" id="4726862">.</span><span class="ident" id="4726863">URL</span><span class="op" id="4726866">.</span><span class="ident" id="4726867">RawQuery</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4726878">}</span>&nbsp;<span class="keyword" id="4726880">else</span>&nbsp;<span class="op" id="4726885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4726890">req</span><span class="op" id="4726893">.</span><span class="ident" id="4726894">URL</span><span class="op" id="4726897">.</span><span class="ident" id="4726898">RawQuery</span>&nbsp;<span class="op" id="4726907">=</span>&nbsp;<span class="ident" id="4726909">targetQuery</span>&nbsp;<span class="op" id="4726921">+</span>&nbsp;<span class="string" id="4726923">&#34;&amp;&#34;</span>&nbsp;<span class="op" id="4726927">+</span>&nbsp;<span class="ident" id="4726929">req</span><span class="op" id="4726932">.</span><span class="ident" id="4726933">URL</span><span class="op" id="4726936">.</span><span class="ident" id="4726937">RawQuery</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4726948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4726951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4726954">return</span>&nbsp;<span class="op" id="4726961">&amp;</span><span class="ident" id="4726962">ReverseProxy</span><span class="op" id="4726974">{</span><span class="ident" id="4726975">Director</span><span class="op" id="4726983">:</span>&nbsp;<span class="ident" id="4726985">director</span><span class="op" id="4726993">}</span><br>
<span class="lineno">80</span><span class="op" id="4726995">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4726998">func</span>&nbsp;<span class="ident" id="4727003">copyHeader</span><span class="op" id="4727013">(</span><span class="ident" id="4727014">dst</span><span class="op" id="4727017">,</span>&nbsp;<span class="ident" id="4727019">src</span>&nbsp;<span class="ident" id="4727023">http</span><span class="op" id="4727027">.</span><span class="ident" id="4727028">Header</span><span class="op" id="4727034">)</span>&nbsp;<span class="op" id="4727036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4727039">for</span>&nbsp;<span class="ident" id="4727043">k</span><span class="op" id="4727044">,</span>&nbsp;<span class="ident" id="4727046">vv</span>&nbsp;<span class="op" id="4727049">:=</span>&nbsp;<span class="keyword" id="4727052">range</span>&nbsp;<span class="ident" id="4727058">src</span>&nbsp;<span class="op" id="4727062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4727066">for</span>&nbsp;<span class="ident" id="4727070">_</span><span class="op" id="4727071">,</span>&nbsp;<span class="ident" id="4727073">v</span>&nbsp;<span class="op" id="4727075">:=</span>&nbsp;<span class="keyword" id="4727078">range</span>&nbsp;<span class="ident" id="4727084">vv</span>&nbsp;<span class="op" id="4727087">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4727092">dst</span><span class="op" id="4727095">.</span><span class="ident" id="4727096">Add</span><span class="op" id="4727099">(</span><span class="ident" id="4727100">k</span><span class="op" id="4727101">,</span>&nbsp;<span class="ident" id="4727103">v</span><span class="op" id="4727104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4727108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4727111">}</span><br>
<span class="lineno"></span><span class="op" id="4727113">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="4727116">//&nbsp;Hop-by-hop&nbsp;headers.&nbsp;These&nbsp;are&nbsp;removed&nbsp;when&nbsp;sent&nbsp;to&nbsp;the&nbsp;backend.</span><br>
<span class="lineno"></span><span class="comment" id="4727183">//&nbsp;http://www.w3.org/Protocols/rfc2616/rfc2616-sec13.html</span><br>
<span class="lineno"></span><span class="keyword" id="4727241">var</span>&nbsp;<span class="ident" id="4727245">hopHeaders</span>&nbsp;<span class="op" id="4727256">=</span>&nbsp;<span class="op" id="4727258">[</span><span class="op" id="4727259">]</span><span class="builtintype" id="4727260">string</span><span class="op" id="4727266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4727269">&#34;Connection&#34;</span><span class="op" id="4727281">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4727284">&#34;Keep-Alive&#34;</span><span class="op" id="4727296">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4727299">&#34;Proxy-Authenticate&#34;</span><span class="op" id="4727319">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4727322">&#34;Proxy-Authorization&#34;</span><span class="op" id="4727343">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4727346">&#34;Te&#34;</span><span class="op" id="4727350">,</span>&nbsp;<span class="comment" id="4727352">//&nbsp;canonicalized&nbsp;version&nbsp;of&nbsp;&#34;TE&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4727386">&#34;Trailers&#34;</span><span class="op" id="4727396">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4727399">&#34;Transfer-Encoding&#34;</span><span class="op" id="4727418">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4727421">&#34;Upgrade&#34;</span><span class="op" id="4727430">,</span><br>
<span class="lineno"></span><span class="op" id="4727432">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4727435">func</span>&nbsp;<span class="op" id="4727440">(</span><span class="ident" id="4727441">p</span>&nbsp;<span class="op" id="4727443">*</span><span class="ident" id="4727444">ReverseProxy</span><span class="op" id="4727456">)</span>&nbsp;<span class="ident" id="4727458">ServeHTTP</span><span class="op" id="4727467">(</span><span class="ident" id="4727468">rw</span>&nbsp;<span class="ident" id="4727471">http</span><span class="op" id="4727475">.</span><span class="ident" id="4727476">ResponseWriter</span><span class="op" id="4727490">,</span>&nbsp;<span class="ident" id="4727492">req</span>&nbsp;<span class="op" id="4727496">*</span><span class="ident" id="4727497">http</span><span class="op" id="4727501">.</span><span class="ident" id="4727502">Request</span><span class="op" id="4727509">)</span>&nbsp;<span class="op" id="4727511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4727514">transport</span>&nbsp;<span class="op" id="4727524">:=</span>&nbsp;<span class="ident" id="4727527">p</span><span class="op" id="4727528">.</span><span class="ident" id="4727529">Transport</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4727540">if</span>&nbsp;<span class="ident" id="4727543">transport</span>&nbsp;<span class="op" id="4727553">==</span>&nbsp;<span class="ident" id="4727556">nil</span>&nbsp;<span class="op" id="4727560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4727564">transport</span>&nbsp;<span class="op" id="4727574">=</span>&nbsp;<span class="ident" id="4727576">http</span><span class="op" id="4727580">.</span><span class="ident" id="4727581">DefaultTransport</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4727599">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4727603">outreq</span>&nbsp;<span class="op" id="4727610">:=</span>&nbsp;<span class="builtinfunc" id="4727613">new</span><span class="op" id="4727616">(</span><span class="ident" id="4727617">http</span><span class="op" id="4727621">.</span><span class="ident" id="4727622">Request</span><span class="op" id="4727629">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4727632">*</span><span class="ident" id="4727633">outreq</span>&nbsp;<span class="op" id="4727640">=</span>&nbsp;<span class="op" id="4727642">*</span><span class="ident" id="4727643">req</span>&nbsp;<span class="comment" id="4727647">//&nbsp;includes&nbsp;shallow&nbsp;copies&nbsp;of&nbsp;maps,&nbsp;but&nbsp;okay</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4727694">p</span><span class="op" id="4727695">.</span><span class="ident" id="4727696">Director</span><span class="op" id="4727704">(</span><span class="ident" id="4727705">outreq</span><span class="op" id="4727711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4727714">outreq</span><span class="op" id="4727720">.</span><span class="ident" id="4727721">Proto</span>&nbsp;<span class="op" id="4727727">=</span>&nbsp;<span class="string" id="4727729">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4727741">outreq</span><span class="op" id="4727747">.</span><span class="ident" id="4727748">ProtoMajor</span>&nbsp;<span class="op" id="4727759">=</span>&nbsp;<span class="num" id="4727761">1</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4727764">outreq</span><span class="op" id="4727770">.</span><span class="ident" id="4727771">ProtoMinor</span>&nbsp;<span class="op" id="4727782">=</span>&nbsp;<span class="num" id="4727784">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4727787">outreq</span><span class="op" id="4727793">.</span><span class="ident" id="4727794">Close</span>&nbsp;<span class="op" id="4727800">=</span>&nbsp;<span class="builtintype" id="4727802">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4727810">//&nbsp;Remove&nbsp;hop-by-hop&nbsp;headers&nbsp;to&nbsp;the&nbsp;backend.&nbsp;&nbsp;Especially</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4727868">//&nbsp;important&nbsp;is&nbsp;&#34;Connection&#34;&nbsp;because&nbsp;we&nbsp;want&nbsp;a&nbsp;persistent</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4727927">//&nbsp;connection,&nbsp;regardless&nbsp;of&nbsp;what&nbsp;the&nbsp;client&nbsp;sent&nbsp;to&nbsp;us.&nbsp;&nbsp;This</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4727991">//&nbsp;is&nbsp;modifying&nbsp;the&nbsp;same&nbsp;underlying&nbsp;map&nbsp;from&nbsp;req&nbsp;(shallow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4728050">//&nbsp;copied&nbsp;above)&nbsp;so&nbsp;we&nbsp;only&nbsp;copy&nbsp;it&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4728101">copiedHeaders</span>&nbsp;<span class="op" id="4728115">:=</span>&nbsp;<span class="builtintype" id="4728118">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4728125">for</span>&nbsp;<span class="ident" id="4728129">_</span><span class="op" id="4728130">,</span>&nbsp;<span class="ident" id="4728132">h</span>&nbsp;<span class="op" id="4728134">:=</span>&nbsp;<span class="keyword" id="4728137">range</span>&nbsp;<span class="ident" id="4728143">hopHeaders</span>&nbsp;<span class="op" id="4728154">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4728158">if</span>&nbsp;<span class="ident" id="4728161">outreq</span><span class="op" id="4728167">.</span><span class="ident" id="4728168">Header</span><span class="op" id="4728174">.</span><span class="ident" id="4728175">Get</span><span class="op" id="4728178">(</span><span class="ident" id="4728179">h</span><span class="op" id="4728180">)</span>&nbsp;<span class="op" id="4728182">!=</span>&nbsp;<span class="string" id="4728185">&#34;&#34;</span>&nbsp;<span class="op" id="4728188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4728193">if</span>&nbsp;<span class="op" id="4728196">!</span><span class="ident" id="4728197">copiedHeaders</span>&nbsp;<span class="op" id="4728211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4728217">outreq</span><span class="op" id="4728223">.</span><span class="ident" id="4728224">Header</span>&nbsp;<span class="op" id="4728231">=</span>&nbsp;<span class="builtinfunc" id="4728233">make</span><span class="op" id="4728237">(</span><span class="ident" id="4728238">http</span><span class="op" id="4728242">.</span><span class="ident" id="4728243">Header</span><span class="op" id="4728249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4728255">copyHeader</span><span class="op" id="4728265">(</span><span class="ident" id="4728266">outreq</span><span class="op" id="4728272">.</span><span class="ident" id="4728273">Header</span><span class="op" id="4728279">,</span>&nbsp;<span class="ident" id="4728281">req</span><span class="op" id="4728284">.</span><span class="ident" id="4728285">Header</span><span class="op" id="4728291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4728297">copiedHeaders</span>&nbsp;<span class="op" id="4728311">=</span>&nbsp;<span class="builtintype" id="4728313">true</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4728321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4728326">outreq</span><span class="op" id="4728332">.</span><span class="ident" id="4728333">Header</span><span class="op" id="4728339">.</span><span class="ident" id="4728340">Del</span><span class="op" id="4728343">(</span><span class="ident" id="4728344">h</span><span class="op" id="4728345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4728349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4728352">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4728356">if</span>&nbsp;<span class="ident" id="4728359">clientIP</span><span class="op" id="4728367">,</span>&nbsp;<span class="ident" id="4728369">_</span><span class="op" id="4728370">,</span>&nbsp;<span class="ident" id="4728372">err</span>&nbsp;<span class="op" id="4728376">:=</span>&nbsp;<span class="ident" id="4728379">net</span><span class="op" id="4728382">.</span><span class="ident" id="4728383">SplitHostPort</span><span class="op" id="4728396">(</span><span class="ident" id="4728397">req</span><span class="op" id="4728400">.</span><span class="ident" id="4728401">RemoteAddr</span><span class="op" id="4728411">)</span><span class="op" id="4728412">;</span>&nbsp;<span class="ident" id="4728414">err</span>&nbsp;<span class="op" id="4728418">==</span>&nbsp;<span class="ident" id="4728421">nil</span>&nbsp;<span class="op" id="4728425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4728429">//&nbsp;If&nbsp;we&nbsp;aren&#39;t&nbsp;the&nbsp;first&nbsp;proxy&nbsp;retain&nbsp;prior</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4728476">//&nbsp;X-Forwarded-For&nbsp;information&nbsp;as&nbsp;a&nbsp;comma+space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4728526">//&nbsp;separated&nbsp;list&nbsp;and&nbsp;fold&nbsp;multiple&nbsp;headers&nbsp;into&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4728582">if</span>&nbsp;<span class="ident" id="4728585">prior</span><span class="op" id="4728590">,</span>&nbsp;<span class="ident" id="4728592">ok</span>&nbsp;<span class="op" id="4728595">:=</span>&nbsp;<span class="ident" id="4728598">outreq</span><span class="op" id="4728604">.</span><span class="ident" id="4728605">Header</span><span class="op" id="4728611">[</span><span class="string" id="4728612">&#34;X-Forwarded-For&#34;</span><span class="op" id="4728629">]</span><span class="op" id="4728630">;</span>&nbsp;<span class="ident" id="4728632">ok</span>&nbsp;<span class="op" id="4728635">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4728640">clientIP</span>&nbsp;<span class="op" id="4728649">=</span>&nbsp;<span class="ident" id="4728651">strings</span><span class="op" id="4728658">.</span><span class="ident" id="4728659">Join</span><span class="op" id="4728663">(</span><span class="ident" id="4728664">prior</span><span class="op" id="4728669">,</span>&nbsp;<span class="string" id="4728671">&#34;,&nbsp;&#34;</span><span class="op" id="4728675">)</span>&nbsp;<span class="op" id="4728677">+</span>&nbsp;<span class="string" id="4728679">&#34;,&nbsp;&#34;</span>&nbsp;<span class="op" id="4728684">+</span>&nbsp;<span class="ident" id="4728686">clientIP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4728697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4728701">outreq</span><span class="op" id="4728707">.</span><span class="ident" id="4728708">Header</span><span class="op" id="4728714">.</span><span class="ident" id="4728715">Set</span><span class="op" id="4728718">(</span><span class="string" id="4728719">&#34;X-Forwarded-For&#34;</span><span class="op" id="4728736">,</span>&nbsp;<span class="ident" id="4728738">clientIP</span><span class="op" id="4728746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4728749">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4728753">res</span><span class="op" id="4728756">,</span>&nbsp;<span class="ident" id="4728758">err</span>&nbsp;<span class="op" id="4728762">:=</span>&nbsp;<span class="ident" id="4728765">transport</span><span class="op" id="4728774">.</span><span class="ident" id="4728775">RoundTrip</span><span class="op" id="4728784">(</span><span class="ident" id="4728785">outreq</span><span class="op" id="4728791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4728794">if</span>&nbsp;<span class="ident" id="4728797">err</span>&nbsp;<span class="op" id="4728801">!=</span>&nbsp;<span class="ident" id="4728804">nil</span>&nbsp;<span class="op" id="4728808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4728812">p</span><span class="op" id="4728813">.</span><span class="ident" id="4728814">logf</span><span class="op" id="4728818">(</span><span class="string" id="4728819">&#34;http:&nbsp;proxy&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="4728842">,</span>&nbsp;<span class="ident" id="4728844">err</span><span class="op" id="4728847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4728851">rw</span><span class="op" id="4728853">.</span><span class="ident" id="4728854">WriteHeader</span><span class="op" id="4728865">(</span><span class="ident" id="4728866">http</span><span class="op" id="4728870">.</span><span class="ident" id="4728871">StatusInternalServerError</span><span class="op" id="4728896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4728900">return</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4728908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4728911">defer</span>&nbsp;<span class="ident" id="4728917">res</span><span class="op" id="4728920">.</span><span class="ident" id="4728921">Body</span><span class="op" id="4728925">.</span><span class="ident" id="4728926">Close</span><span class="op" id="4728931">(</span><span class="op" id="4728932">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4728936">for</span>&nbsp;<span class="ident" id="4728940">_</span><span class="op" id="4728941">,</span>&nbsp;<span class="ident" id="4728943">h</span>&nbsp;<span class="op" id="4728945">:=</span>&nbsp;<span class="keyword" id="4728948">range</span>&nbsp;<span class="ident" id="4728954">hopHeaders</span>&nbsp;<span class="op" id="4728965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4728969">res</span><span class="op" id="4728972">.</span><span class="ident" id="4728973">Header</span><span class="op" id="4728979">.</span><span class="ident" id="4728980">Del</span><span class="op" id="4728983">(</span><span class="ident" id="4728984">h</span><span class="op" id="4728985">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4728988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4728992">copyHeader</span><span class="op" id="4729002">(</span><span class="ident" id="4729003">rw</span><span class="op" id="4729005">.</span><span class="ident" id="4729006">Header</span><span class="op" id="4729012">(</span><span class="op" id="4729013">)</span><span class="op" id="4729014">,</span>&nbsp;<span class="ident" id="4729016">res</span><span class="op" id="4729019">.</span><span class="ident" id="4729020">Header</span><span class="op" id="4729026">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4729030">rw</span><span class="op" id="4729032">.</span><span class="ident" id="4729033">WriteHeader</span><span class="op" id="4729044">(</span><span class="ident" id="4729045">res</span><span class="op" id="4729048">.</span><span class="ident" id="4729049">StatusCode</span><span class="op" id="4729059">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4729062">p</span><span class="op" id="4729063">.</span><span class="ident" id="4729064">copyResponse</span><span class="op" id="4729076">(</span><span class="ident" id="4729077">rw</span><span class="op" id="4729079">,</span>&nbsp;<span class="ident" id="4729081">res</span><span class="op" id="4729084">.</span><span class="ident" id="4729085">Body</span><span class="op" id="4729089">)</span><br>
<span class="lineno"></span><span class="op" id="4729091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4729094">func</span>&nbsp;<span class="op" id="4729099">(</span><span class="ident" id="4729100">p</span>&nbsp;<span class="op" id="4729102">*</span><span class="ident" id="4729103">ReverseProxy</span><span class="op" id="4729115">)</span>&nbsp;<span class="ident" id="4729117">copyResponse</span><span class="op" id="4729129">(</span><span class="ident" id="4729130">dst</span>&nbsp;<span class="ident" id="4729134">io</span><span class="op" id="4729136">.</span><span class="ident" id="4729137">Writer</span><span class="op" id="4729143">,</span>&nbsp;<span class="ident" id="4729145">src</span>&nbsp;<span class="ident" id="4729149">io</span><span class="op" id="4729151">.</span><span class="ident" id="4729152">Reader</span><span class="op" id="4729158">)</span>&nbsp;<span class="op" id="4729160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4729163">if</span>&nbsp;<span class="ident" id="4729166">p</span><span class="op" id="4729167">.</span><span class="ident" id="4729168">FlushInterval</span>&nbsp;<span class="op" id="4729182">!=</span>&nbsp;<span class="num" id="4729185">0</span>&nbsp;<span class="op" id="4729187">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4729191">if</span>&nbsp;<span class="ident" id="4729194">wf</span><span class="op" id="4729196">,</span>&nbsp;<span class="ident" id="4729198">ok</span>&nbsp;<span class="op" id="4729201">:=</span>&nbsp;<span class="ident" id="4729204">dst</span><span class="op" id="4729207">.</span><span class="op" id="4729208">(</span><span class="ident" id="4729209">writeFlusher</span><span class="op" id="4729221">)</span><span class="op" id="4729222">;</span>&nbsp;<span class="ident" id="4729224">ok</span>&nbsp;<span class="op" id="4729227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4729232">mlw</span>&nbsp;<span class="op" id="4729236">:=</span>&nbsp;<span class="op" id="4729239">&amp;</span><span class="ident" id="4729240">maxLatencyWriter</span><span class="op" id="4729256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4729262">dst</span><span class="op" id="4729265">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4729271">wf</span><span class="op" id="4729273">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4729279">latency</span><span class="op" id="4729286">:</span>&nbsp;<span class="ident" id="4729288">p</span><span class="op" id="4729289">.</span><span class="ident" id="4729290">FlushInterval</span><span class="op" id="4729303">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4729309">done</span><span class="op" id="4729313">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4729318">make</span><span class="op" id="4729322">(</span><span class="keyword" id="4729323">chan</span>&nbsp;<span class="builtintype" id="4729328">bool</span><span class="op" id="4729332">)</span><span class="op" id="4729333">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4729338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4729343">go</span>&nbsp;<span class="ident" id="4729346">mlw</span><span class="op" id="4729349">.</span><span class="ident" id="4729350">flushLoop</span><span class="op" id="4729359">(</span><span class="op" id="4729360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4729365">defer</span>&nbsp;<span class="ident" id="4729371">mlw</span><span class="op" id="4729374">.</span><span class="ident" id="4729375">stop</span><span class="op" id="4729379">(</span><span class="op" id="4729380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4729385">dst</span>&nbsp;<span class="op" id="4729389">=</span>&nbsp;<span class="ident" id="4729391">mlw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4729397">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4729400">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4729404">io</span><span class="op" id="4729406">.</span><span class="ident" id="4729407">Copy</span><span class="op" id="4729411">(</span><span class="ident" id="4729412">dst</span><span class="op" id="4729415">,</span>&nbsp;<span class="ident" id="4729417">src</span><span class="op" id="4729420">)</span><br>
<span class="lineno"></span><span class="op" id="4729422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="4729425">func</span>&nbsp;<span class="op" id="4729430">(</span><span class="ident" id="4729431">p</span>&nbsp;<span class="op" id="4729433">*</span><span class="ident" id="4729434">ReverseProxy</span><span class="op" id="4729446">)</span>&nbsp;<span class="ident" id="4729448">logf</span><span class="op" id="4729452">(</span><span class="ident" id="4729453">format</span>&nbsp;<span class="builtintype" id="4729460">string</span><span class="op" id="4729466">,</span>&nbsp;<span class="ident" id="4729468">args</span>&nbsp;<span class="op" id="4729473">...</span><span class="keyword" id="4729476">interface</span><span class="op" id="4729485">{</span><span class="op" id="4729486">}</span><span class="op" id="4729487">)</span>&nbsp;<span class="op" id="4729489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4729492">if</span>&nbsp;<span class="ident" id="4729495">p</span><span class="op" id="4729496">.</span><span class="ident" id="4729497">ErrorLog</span>&nbsp;<span class="op" id="4729506">!=</span>&nbsp;<span class="ident" id="4729509">nil</span>&nbsp;<span class="op" id="4729513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4729517">p</span><span class="op" id="4729518">.</span><span class="ident" id="4729519">ErrorLog</span><span class="op" id="4729527">.</span><span class="ident" id="4729528">Printf</span><span class="op" id="4729534">(</span><span class="ident" id="4729535">format</span><span class="op" id="4729541">,</span>&nbsp;<span class="ident" id="4729543">args</span><span class="op" id="4729547">...</span><span class="op" id="4729550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4729553">}</span>&nbsp;<span class="keyword" id="4729555">else</span>&nbsp;<span class="op" id="4729560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4729564">log</span><span class="op" id="4729567">.</span><span class="ident" id="4729568">Printf</span><span class="op" id="4729574">(</span><span class="ident" id="4729575">format</span><span class="op" id="4729581">,</span>&nbsp;<span class="ident" id="4729583">args</span><span class="op" id="4729587">...</span><span class="op" id="4729590">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4729593">}</span><br>
<span class="lineno"></span><span class="op" id="4729595">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4729598">type</span>&nbsp;<span class="ident" id="4729603">writeFlusher</span>&nbsp;<span class="keyword" id="4729616">interface</span>&nbsp;<span class="op" id="4729626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4729629">io</span><span class="op" id="4729631">.</span><span class="ident" id="4729632">Writer</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4729640">http</span><span class="op" id="4729644">.</span><span class="ident" id="4729645">Flusher</span><br>
<span class="lineno"></span><span class="op" id="4729653">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4729656">type</span>&nbsp;<span class="ident" id="4729661">maxLatencyWriter</span>&nbsp;<span class="keyword" id="4729678">struct</span>&nbsp;<span class="op" id="4729685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4729688">dst</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4729696">writeFlusher</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4729710">latency</span>&nbsp;<span class="ident" id="4729718">time</span><span class="op" id="4729722">.</span><span class="ident" id="4729723">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4729734">lk</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4729739">sync</span><span class="op" id="4729743">.</span><span class="ident" id="4729744">Mutex</span>&nbsp;<span class="comment" id="4729750">//&nbsp;protects&nbsp;Write&nbsp;+&nbsp;Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4729777">done</span>&nbsp;<span class="keyword" id="4729782">chan</span>&nbsp;<span class="builtintype" id="4729787">bool</span><br>
<span class="lineno"></span><span class="op" id="4729792">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="keyword" id="4729795">func</span>&nbsp;<span class="op" id="4729800">(</span><span class="ident" id="4729801">m</span>&nbsp;<span class="op" id="4729803">*</span><span class="ident" id="4729804">maxLatencyWriter</span><span class="op" id="4729820">)</span>&nbsp;<span class="ident" id="4729822">Write</span><span class="op" id="4729827">(</span><span class="ident" id="4729828">p</span>&nbsp;<span class="op" id="4729830">[</span><span class="op" id="4729831">]</span><span class="builtintype" id="4729832">byte</span><span class="op" id="4729836">)</span>&nbsp;<span class="op" id="4729838">(</span><span class="builtintype" id="4729839">int</span><span class="op" id="4729842">,</span>&nbsp;<span class="builtintype" id="4729844">error</span><span class="op" id="4729849">)</span>&nbsp;<span class="op" id="4729851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4729854">m</span><span class="op" id="4729855">.</span><span class="ident" id="4729856">lk</span><span class="op" id="4729858">.</span><span class="ident" id="4729859">Lock</span><span class="op" id="4729863">(</span><span class="op" id="4729864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4729867">defer</span>&nbsp;<span class="ident" id="4729873">m</span><span class="op" id="4729874">.</span><span class="ident" id="4729875">lk</span><span class="op" id="4729877">.</span><span class="ident" id="4729878">Unlock</span><span class="op" id="4729884">(</span><span class="op" id="4729885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4729888">return</span>&nbsp;<span class="ident" id="4729895">m</span><span class="op" id="4729896">.</span><span class="ident" id="4729897">dst</span><span class="op" id="4729900">.</span><span class="ident" id="4729901">Write</span><span class="op" id="4729906">(</span><span class="ident" id="4729907">p</span><span class="op" id="4729908">)</span><br>
<span class="lineno">205</span><span class="op" id="4729910">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4729913">func</span>&nbsp;<span class="op" id="4729918">(</span><span class="ident" id="4729919">m</span>&nbsp;<span class="op" id="4729921">*</span><span class="ident" id="4729922">maxLatencyWriter</span><span class="op" id="4729938">)</span>&nbsp;<span class="ident" id="4729940">flushLoop</span><span class="op" id="4729949">(</span><span class="op" id="4729950">)</span>&nbsp;<span class="op" id="4729952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4729955">t</span>&nbsp;<span class="op" id="4729957">:=</span>&nbsp;<span class="ident" id="4729960">time</span><span class="op" id="4729964">.</span><span class="ident" id="4729965">NewTicker</span><span class="op" id="4729974">(</span><span class="ident" id="4729975">m</span><span class="op" id="4729976">.</span><span class="ident" id="4729977">latency</span><span class="op" id="4729984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4729987">defer</span>&nbsp;<span class="ident" id="4729993">t</span><span class="op" id="4729994">.</span><span class="ident" id="4729995">Stop</span><span class="op" id="4729999">(</span><span class="op" id="4730000">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4730003">for</span>&nbsp;<span class="op" id="4730007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4730011">select</span>&nbsp;<span class="op" id="4730018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4730022">case</span>&nbsp;<span class="op" id="4730027">&lt;-</span><span class="ident" id="4730029">m</span><span class="op" id="4730030">.</span><span class="ident" id="4730031">done</span><span class="op" id="4730035">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4730040">if</span>&nbsp;<span class="ident" id="4730043">onExitFlushLoop</span>&nbsp;<span class="op" id="4730059">!=</span>&nbsp;<span class="ident" id="4730062">nil</span>&nbsp;<span class="op" id="4730066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4730072">onExitFlushLoop</span><span class="op" id="4730087">(</span><span class="op" id="4730088">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4730093">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4730098">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4730107">case</span>&nbsp;<span class="op" id="4730112">&lt;-</span><span class="ident" id="4730114">t</span><span class="op" id="4730115">.</span><span class="ident" id="4730116">C</span><span class="op" id="4730117">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4730122">m</span><span class="op" id="4730123">.</span><span class="ident" id="4730124">lk</span><span class="op" id="4730126">.</span><span class="ident" id="4730127">Lock</span><span class="op" id="4730131">(</span><span class="op" id="4730132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4730137">m</span><span class="op" id="4730138">.</span><span class="ident" id="4730139">dst</span><span class="op" id="4730142">.</span><span class="ident" id="4730143">Flush</span><span class="op" id="4730148">(</span><span class="op" id="4730149">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4730154">m</span><span class="op" id="4730155">.</span><span class="ident" id="4730156">lk</span><span class="op" id="4730158">.</span><span class="ident" id="4730159">Unlock</span><span class="op" id="4730165">(</span><span class="op" id="4730166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4730170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4730173">}</span><br>
<span class="lineno"></span><span class="op" id="4730175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="4730178">func</span>&nbsp;<span class="op" id="4730183">(</span><span class="ident" id="4730184">m</span>&nbsp;<span class="op" id="4730186">*</span><span class="ident" id="4730187">maxLatencyWriter</span><span class="op" id="4730203">)</span>&nbsp;<span class="ident" id="4730205">stop</span><span class="op" id="4730209">(</span><span class="op" id="4730210">)</span>&nbsp;<span class="op" id="4730212">{</span>&nbsp;<span class="ident" id="4730214">m</span><span class="op" id="4730215">.</span><span class="ident" id="4730216">done</span>&nbsp;<span class="op" id="4730221">&lt;-</span>&nbsp;<span class="builtintype" id="4730224">true</span>&nbsp;<span class="op" id="4730229">}</span>
</div>
</body>
</html>
