<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="4077598">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4077653">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4077707">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4077758">package</span>&nbsp;<span class="ident" id="4077766">x509</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4077772">import</span>&nbsp;<span class="op" id="4077779">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4077782">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4077789">&#34;net&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4077796">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4077807">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4077818">&#34;time&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4077826">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="4077841">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="4077844">type</span>&nbsp;<span class="ident" id="4077849">InvalidReason</span>&nbsp;<span class="builtintype" id="4077863">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4077868">const</span>&nbsp;<span class="op" id="4077874">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4077877">//&nbsp;NotAuthorizedToSign&nbsp;results&nbsp;when&nbsp;a&nbsp;certificate&nbsp;is&nbsp;signed&nbsp;by&nbsp;another</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4077949">//&nbsp;which&nbsp;isn&#39;t&nbsp;marked&nbsp;as&nbsp;a&nbsp;CA&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4077993">NotAuthorizedToSign</span>&nbsp;<span class="ident" id="4078013">InvalidReason</span>&nbsp;<span class="op" id="4078027">=</span>&nbsp;<span class="ident" id="4078029">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4078035">//&nbsp;Expired&nbsp;results&nbsp;when&nbsp;a&nbsp;certificate&nbsp;has&nbsp;expired,&nbsp;based&nbsp;on&nbsp;the&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4078105">//&nbsp;given&nbsp;in&nbsp;the&nbsp;VerifyOptions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4078137">Expired</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4078146">//&nbsp;CANotAuthorizedForThisName&nbsp;results&nbsp;when&nbsp;an&nbsp;intermediate&nbsp;or&nbsp;root</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4078214">//&nbsp;certificate&nbsp;has&nbsp;a&nbsp;name&nbsp;constraint&nbsp;which&nbsp;doesn&#39;t&nbsp;include&nbsp;the&nbsp;name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4078283">//&nbsp;being&nbsp;checked.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4078302">CANotAuthorizedForThisName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4078330">//&nbsp;TooManyIntermediates&nbsp;results&nbsp;when&nbsp;a&nbsp;path&nbsp;length&nbsp;constraint&nbsp;is</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4078396">//&nbsp;violated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4078410">TooManyIntermediates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4078432">//&nbsp;IncompatibleUsage&nbsp;results&nbsp;when&nbsp;the&nbsp;certificate&#39;s&nbsp;key&nbsp;usage&nbsp;indicates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4078505">//&nbsp;that&nbsp;it&nbsp;may&nbsp;only&nbsp;be&nbsp;used&nbsp;for&nbsp;a&nbsp;different&nbsp;purpose.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4078559">IncompatibleUsage</span><br>
<span class="lineno">35</span><span class="op" id="4078577">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4078580">//&nbsp;CertificateInvalidError&nbsp;results&nbsp;when&nbsp;an&nbsp;odd&nbsp;error&nbsp;occurs.&nbsp;Users&nbsp;of&nbsp;this</span><br>
<span class="lineno"></span><span class="comment" id="4078655">//&nbsp;library&nbsp;probably&nbsp;want&nbsp;to&nbsp;handle&nbsp;all&nbsp;these&nbsp;errors&nbsp;uniformly.</span><br>
<span class="lineno"></span><span class="keyword" id="4078718">type</span>&nbsp;<span class="ident" id="4078723">CertificateInvalidError</span>&nbsp;<span class="keyword" id="4078747">struct</span>&nbsp;<span class="op" id="4078754">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4078757">Cert</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4078764">*</span><span class="ident" id="4078765">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4078778">Reason</span>&nbsp;<span class="ident" id="4078785">InvalidReason</span><br>
<span class="lineno"></span><span class="op" id="4078799">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4078802">func</span>&nbsp;<span class="op" id="4078807">(</span><span class="ident" id="4078808">e</span>&nbsp;<span class="ident" id="4078810">CertificateInvalidError</span><span class="op" id="4078833">)</span>&nbsp;<span class="ident" id="4078835">Error</span><span class="op" id="4078840">(</span><span class="op" id="4078841">)</span>&nbsp;<span class="builtintype" id="4078843">string</span>&nbsp;<span class="op" id="4078850">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4078853">switch</span>&nbsp;<span class="ident" id="4078860">e</span><span class="op" id="4078861">.</span><span class="ident" id="4078862">Reason</span>&nbsp;<span class="op" id="4078869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4078872">case</span>&nbsp;<span class="ident" id="4078877">NotAuthorizedToSign</span><span class="op" id="4078896">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4078900">return</span>&nbsp;<span class="string" id="4078907">&#34;x509:&nbsp;certificate&nbsp;is&nbsp;not&nbsp;authorized&nbsp;to&nbsp;sign&nbsp;other&nbsp;certificates&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4078973">case</span>&nbsp;<span class="ident" id="4078978">Expired</span><span class="op" id="4078985">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4078989">return</span>&nbsp;<span class="string" id="4078996">&#34;x509:&nbsp;certificate&nbsp;has&nbsp;expired&nbsp;or&nbsp;is&nbsp;not&nbsp;yet&nbsp;valid&#34;</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4079049">case</span>&nbsp;<span class="ident" id="4079054">CANotAuthorizedForThisName</span><span class="op" id="4079080">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4079084">return</span>&nbsp;<span class="string" id="4079091">&#34;x509:&nbsp;a&nbsp;root&nbsp;or&nbsp;intermediate&nbsp;certificate&nbsp;is&nbsp;not&nbsp;authorized&nbsp;to&nbsp;sign&nbsp;in&nbsp;this&nbsp;domain&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4079176">case</span>&nbsp;<span class="ident" id="4079181">TooManyIntermediates</span><span class="op" id="4079201">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4079205">return</span>&nbsp;<span class="string" id="4079212">&#34;x509:&nbsp;too&nbsp;many&nbsp;intermediates&nbsp;for&nbsp;path&nbsp;length&nbsp;constraint&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4079271">case</span>&nbsp;<span class="ident" id="4079276">IncompatibleUsage</span><span class="op" id="4079293">:</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4079297">return</span>&nbsp;<span class="string" id="4079304">&#34;x509:&nbsp;certificate&nbsp;specifies&nbsp;an&nbsp;incompatible&nbsp;key&nbsp;usage&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4079361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4079364">return</span>&nbsp;<span class="string" id="4079371">&#34;x509:&nbsp;unknown&nbsp;error&#34;</span><br>
<span class="lineno"></span><span class="op" id="4079393">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="4079396">//&nbsp;HostnameError&nbsp;results&nbsp;when&nbsp;the&nbsp;set&nbsp;of&nbsp;authorized&nbsp;names&nbsp;doesn&#39;t&nbsp;match&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4079472">//&nbsp;requested&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="4079491">type</span>&nbsp;<span class="ident" id="4079496">HostnameError</span>&nbsp;<span class="keyword" id="4079510">struct</span>&nbsp;<span class="op" id="4079517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4079520">Certificate</span>&nbsp;<span class="op" id="4079532">*</span><span class="ident" id="4079533">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4079546">Host</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4079558">string</span><br>
<span class="lineno">65</span><span class="op" id="4079565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4079568">func</span>&nbsp;<span class="op" id="4079573">(</span><span class="ident" id="4079574">h</span>&nbsp;<span class="ident" id="4079576">HostnameError</span><span class="op" id="4079589">)</span>&nbsp;<span class="ident" id="4079591">Error</span><span class="op" id="4079596">(</span><span class="op" id="4079597">)</span>&nbsp;<span class="builtintype" id="4079599">string</span>&nbsp;<span class="op" id="4079606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4079609">c</span>&nbsp;<span class="op" id="4079611">:=</span>&nbsp;<span class="ident" id="4079614">h</span><span class="op" id="4079615">.</span><span class="ident" id="4079616">Certificate</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4079630">var</span>&nbsp;<span class="ident" id="4079634">valid</span>&nbsp;<span class="builtintype" id="4079640">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4079648">if</span>&nbsp;<span class="ident" id="4079651">ip</span>&nbsp;<span class="op" id="4079654">:=</span>&nbsp;<span class="ident" id="4079657">net</span><span class="op" id="4079660">.</span><span class="ident" id="4079661">ParseIP</span><span class="op" id="4079668">(</span><span class="ident" id="4079669">h</span><span class="op" id="4079670">.</span><span class="ident" id="4079671">Host</span><span class="op" id="4079675">)</span><span class="op" id="4079676">;</span>&nbsp;<span class="ident" id="4079678">ip</span>&nbsp;<span class="op" id="4079681">!=</span>&nbsp;<span class="ident" id="4079684">nil</span>&nbsp;<span class="op" id="4079688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4079692">//&nbsp;Trying&nbsp;to&nbsp;validate&nbsp;an&nbsp;IP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4079722">if</span>&nbsp;<span class="builtinfunc" id="4079725">len</span><span class="op" id="4079728">(</span><span class="ident" id="4079729">c</span><span class="op" id="4079730">.</span><span class="ident" id="4079731">IPAddresses</span><span class="op" id="4079742">)</span>&nbsp;<span class="op" id="4079744">==</span>&nbsp;<span class="num" id="4079747">0</span>&nbsp;<span class="op" id="4079749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4079754">return</span>&nbsp;<span class="string" id="4079761">&#34;x509:&nbsp;cannot&nbsp;validate&nbsp;certificate&nbsp;for&nbsp;&#34;</span>&nbsp;<span class="op" id="4079802">+</span>&nbsp;<span class="ident" id="4079804">h</span><span class="op" id="4079805">.</span><span class="ident" id="4079806">Host</span>&nbsp;<span class="op" id="4079811">+</span>&nbsp;<span class="string" id="4079813">&#34;&nbsp;because&nbsp;it&nbsp;doesn&#39;t&nbsp;contain&nbsp;any&nbsp;IP&nbsp;SANs&#34;</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4079857">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4079861">for</span>&nbsp;<span class="ident" id="4079865">_</span><span class="op" id="4079866">,</span>&nbsp;<span class="ident" id="4079868">san</span>&nbsp;<span class="op" id="4079872">:=</span>&nbsp;<span class="keyword" id="4079875">range</span>&nbsp;<span class="ident" id="4079881">c</span><span class="op" id="4079882">.</span><span class="ident" id="4079883">IPAddresses</span>&nbsp;<span class="op" id="4079895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4079900">if</span>&nbsp;<span class="builtinfunc" id="4079903">len</span><span class="op" id="4079906">(</span><span class="ident" id="4079907">valid</span><span class="op" id="4079912">)</span>&nbsp;<span class="op" id="4079914">&gt;</span>&nbsp;<span class="num" id="4079916">0</span>&nbsp;<span class="op" id="4079918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4079924">valid</span>&nbsp;<span class="op" id="4079930">+=</span>&nbsp;<span class="string" id="4079933">&#34;,&nbsp;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4079941">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4079946">valid</span>&nbsp;<span class="op" id="4079952">+=</span>&nbsp;<span class="ident" id="4079955">san</span><span class="op" id="4079958">.</span><span class="ident" id="4079959">String</span><span class="op" id="4079965">(</span><span class="op" id="4079966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4079970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4079973">}</span>&nbsp;<span class="keyword" id="4079975">else</span>&nbsp;<span class="op" id="4079980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4079984">if</span>&nbsp;<span class="builtinfunc" id="4079987">len</span><span class="op" id="4079990">(</span><span class="ident" id="4079991">c</span><span class="op" id="4079992">.</span><span class="ident" id="4079993">DNSNames</span><span class="op" id="4080001">)</span>&nbsp;<span class="op" id="4080003">&gt;</span>&nbsp;<span class="num" id="4080005">0</span>&nbsp;<span class="op" id="4080007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4080012">valid</span>&nbsp;<span class="op" id="4080018">=</span>&nbsp;<span class="ident" id="4080020">strings</span><span class="op" id="4080027">.</span><span class="ident" id="4080028">Join</span><span class="op" id="4080032">(</span><span class="ident" id="4080033">c</span><span class="op" id="4080034">.</span><span class="ident" id="4080035">DNSNames</span><span class="op" id="4080043">,</span>&nbsp;<span class="string" id="4080045">&#34;,&nbsp;&#34;</span><span class="op" id="4080049">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4080053">}</span>&nbsp;<span class="keyword" id="4080055">else</span>&nbsp;<span class="op" id="4080060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4080065">valid</span>&nbsp;<span class="op" id="4080071">=</span>&nbsp;<span class="ident" id="4080073">c</span><span class="op" id="4080074">.</span><span class="ident" id="4080075">Subject</span><span class="op" id="4080082">.</span><span class="ident" id="4080083">CommonName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4080096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4080099">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4080102">return</span>&nbsp;<span class="string" id="4080109">&#34;x509:&nbsp;certificate&nbsp;is&nbsp;valid&nbsp;for&nbsp;&#34;</span>&nbsp;<span class="op" id="4080143">+</span>&nbsp;<span class="ident" id="4080145">valid</span>&nbsp;<span class="op" id="4080151">+</span>&nbsp;<span class="string" id="4080153">&#34;,&nbsp;not&nbsp;&#34;</span>&nbsp;<span class="op" id="4080162">+</span>&nbsp;<span class="ident" id="4080164">h</span><span class="op" id="4080165">.</span><span class="ident" id="4080166">Host</span><br>
<span class="lineno">90</span><span class="op" id="4080171">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4080174">//&nbsp;UnknownAuthorityError&nbsp;results&nbsp;when&nbsp;the&nbsp;certificate&nbsp;issuer&nbsp;is&nbsp;unknown</span><br>
<span class="lineno"></span><span class="keyword" id="4080246">type</span>&nbsp;<span class="ident" id="4080251">UnknownAuthorityError</span>&nbsp;<span class="keyword" id="4080273">struct</span>&nbsp;<span class="op" id="4080280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4080283">cert</span>&nbsp;<span class="op" id="4080288">*</span><span class="ident" id="4080289">Certificate</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4080302">//&nbsp;hintErr&nbsp;contains&nbsp;an&nbsp;error&nbsp;that&nbsp;may&nbsp;be&nbsp;helpful&nbsp;in&nbsp;determining&nbsp;why&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4080374">//&nbsp;authority&nbsp;wasn&#39;t&nbsp;found.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4080402">hintErr</span>&nbsp;<span class="builtintype" id="4080410">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4080417">//&nbsp;hintCert&nbsp;contains&nbsp;a&nbsp;possible&nbsp;authority&nbsp;certificate&nbsp;that&nbsp;was&nbsp;rejected</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4080490">//&nbsp;because&nbsp;of&nbsp;the&nbsp;error&nbsp;in&nbsp;hintErr.</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4080527">hintCert</span>&nbsp;<span class="op" id="4080536">*</span><span class="ident" id="4080537">Certificate</span><br>
<span class="lineno"></span><span class="op" id="4080549">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4080552">func</span>&nbsp;<span class="op" id="4080557">(</span><span class="ident" id="4080558">e</span>&nbsp;<span class="ident" id="4080560">UnknownAuthorityError</span><span class="op" id="4080581">)</span>&nbsp;<span class="ident" id="4080583">Error</span><span class="op" id="4080588">(</span><span class="op" id="4080589">)</span>&nbsp;<span class="builtintype" id="4080591">string</span>&nbsp;<span class="op" id="4080598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4080601">s</span>&nbsp;<span class="op" id="4080603">:=</span>&nbsp;<span class="string" id="4080606">&#34;x509:&nbsp;certificate&nbsp;signed&nbsp;by&nbsp;unknown&nbsp;authority&#34;</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4080655">if</span>&nbsp;<span class="ident" id="4080658">e</span><span class="op" id="4080659">.</span><span class="ident" id="4080660">hintErr</span>&nbsp;<span class="op" id="4080668">!=</span>&nbsp;<span class="ident" id="4080671">nil</span>&nbsp;<span class="op" id="4080675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4080679">certName</span>&nbsp;<span class="op" id="4080688">:=</span>&nbsp;<span class="ident" id="4080691">e</span><span class="op" id="4080692">.</span><span class="ident" id="4080693">hintCert</span><span class="op" id="4080701">.</span><span class="ident" id="4080702">Subject</span><span class="op" id="4080709">.</span><span class="ident" id="4080710">CommonName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4080723">if</span>&nbsp;<span class="builtinfunc" id="4080726">len</span><span class="op" id="4080729">(</span><span class="ident" id="4080730">certName</span><span class="op" id="4080738">)</span>&nbsp;<span class="op" id="4080740">==</span>&nbsp;<span class="num" id="4080743">0</span>&nbsp;<span class="op" id="4080745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4080750">if</span>&nbsp;<span class="builtinfunc" id="4080753">len</span><span class="op" id="4080756">(</span><span class="ident" id="4080757">e</span><span class="op" id="4080758">.</span><span class="ident" id="4080759">hintCert</span><span class="op" id="4080767">.</span><span class="ident" id="4080768">Subject</span><span class="op" id="4080775">.</span><span class="ident" id="4080776">Organization</span><span class="op" id="4080788">)</span>&nbsp;<span class="op" id="4080790">&gt;</span>&nbsp;<span class="num" id="4080792">0</span>&nbsp;<span class="op" id="4080794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4080800">certName</span>&nbsp;<span class="op" id="4080809">=</span>&nbsp;<span class="ident" id="4080811">e</span><span class="op" id="4080812">.</span><span class="ident" id="4080813">hintCert</span><span class="op" id="4080821">.</span><span class="ident" id="4080822">Subject</span><span class="op" id="4080829">.</span><span class="ident" id="4080830">Organization</span><span class="op" id="4080842">[</span><span class="num" id="4080843">0</span><span class="op" id="4080844">]</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4080849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4080854">certName</span>&nbsp;<span class="op" id="4080863">=</span>&nbsp;<span class="string" id="4080865">&#34;serial:&#34;</span>&nbsp;<span class="op" id="4080875">+</span>&nbsp;<span class="ident" id="4080877">e</span><span class="op" id="4080878">.</span><span class="ident" id="4080879">hintCert</span><span class="op" id="4080887">.</span><span class="ident" id="4080888">SerialNumber</span><span class="op" id="4080900">.</span><span class="ident" id="4080901">String</span><span class="op" id="4080907">(</span><span class="op" id="4080908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4080912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4080916">s</span>&nbsp;<span class="op" id="4080918">+=</span>&nbsp;<span class="ident" id="4080921">fmt</span><span class="op" id="4080924">.</span><span class="ident" id="4080925">Sprintf</span><span class="op" id="4080932">(</span><span class="string" id="4080933">&#34;&nbsp;(possibly&nbsp;because&nbsp;of&nbsp;%q&nbsp;while&nbsp;trying&nbsp;to&nbsp;verify&nbsp;candidate&nbsp;authority&nbsp;certificate&nbsp;%q)&#34;</span><span class="op" id="4081018">,</span>&nbsp;<span class="ident" id="4081020">e</span><span class="op" id="4081021">.</span><span class="ident" id="4081022">hintErr</span><span class="op" id="4081029">,</span>&nbsp;<span class="ident" id="4081031">certName</span><span class="op" id="4081039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4081042">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4081045">return</span>&nbsp;<span class="ident" id="4081052">s</span><br>
<span class="lineno"></span><span class="op" id="4081054">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4081057">//&nbsp;SystemRootsError&nbsp;results&nbsp;when&nbsp;we&nbsp;fail&nbsp;to&nbsp;load&nbsp;the&nbsp;system&nbsp;root&nbsp;certificates.</span><br>
<span class="lineno"></span><span class="keyword" id="4081136">type</span>&nbsp;<span class="ident" id="4081141">SystemRootsError</span>&nbsp;<span class="keyword" id="4081158">struct</span><span class="op" id="4081164">{</span><span class="op" id="4081165">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="keyword" id="4081168">func</span>&nbsp;<span class="op" id="4081173">(</span><span class="ident" id="4081174">SystemRootsError</span><span class="op" id="4081190">)</span>&nbsp;<span class="ident" id="4081192">Error</span><span class="op" id="4081197">(</span><span class="op" id="4081198">)</span>&nbsp;<span class="builtintype" id="4081200">string</span>&nbsp;<span class="op" id="4081207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4081210">return</span>&nbsp;<span class="string" id="4081217">&#34;x509:&nbsp;failed&nbsp;to&nbsp;load&nbsp;system&nbsp;roots&nbsp;and&nbsp;no&nbsp;roots&nbsp;provided&#34;</span><br>
<span class="lineno"></span><span class="op" id="4081275">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="comment" id="4081278">//&nbsp;VerifyOptions&nbsp;contains&nbsp;parameters&nbsp;for&nbsp;Certificate.Verify.&nbsp;It&#39;s&nbsp;a&nbsp;structure</span><br>
<span class="lineno"></span><span class="comment" id="4081356">//&nbsp;because&nbsp;other&nbsp;PKIX&nbsp;verification&nbsp;APIs&nbsp;have&nbsp;ended&nbsp;up&nbsp;needing&nbsp;many&nbsp;options.</span><br>
<span class="lineno"></span><span class="keyword" id="4081432">type</span>&nbsp;<span class="ident" id="4081437">VerifyOptions</span>&nbsp;<span class="keyword" id="4081451">struct</span>&nbsp;<span class="op" id="4081458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4081461">DNSName</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4081475">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4081483">Intermediates</span>&nbsp;<span class="op" id="4081497">*</span><span class="ident" id="4081498">CertPool</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4081508">Roots</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4081522">*</span><span class="ident" id="4081523">CertPool</span>&nbsp;<span class="comment" id="4081532">//&nbsp;if&nbsp;nil,&nbsp;the&nbsp;system&nbsp;roots&nbsp;are&nbsp;used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4081570">CurrentTime</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4081584">time</span><span class="op" id="4081588">.</span><span class="ident" id="4081589">Time</span>&nbsp;<span class="comment" id="4081594">//&nbsp;if&nbsp;zero,&nbsp;the&nbsp;current&nbsp;time&nbsp;is&nbsp;used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4081632">//&nbsp;KeyUsage&nbsp;specifies&nbsp;which&nbsp;Extended&nbsp;Key&nbsp;Usage&nbsp;values&nbsp;are&nbsp;acceptable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4081703">//&nbsp;An&nbsp;empty&nbsp;list&nbsp;means&nbsp;ExtKeyUsageServerAuth.&nbsp;Key&nbsp;usage&nbsp;is&nbsp;considered&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4081776">//&nbsp;constraint&nbsp;down&nbsp;the&nbsp;chain&nbsp;which&nbsp;mirrors&nbsp;Windows&nbsp;CryptoAPI&nbsp;behaviour,</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4081849">//&nbsp;but&nbsp;not&nbsp;the&nbsp;spec.&nbsp;To&nbsp;accept&nbsp;any&nbsp;key&nbsp;usage,&nbsp;include&nbsp;ExtKeyUsageAny.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4081920">KeyUsages</span>&nbsp;<span class="op" id="4081930">[</span><span class="op" id="4081931">]</span><span class="ident" id="4081932">ExtKeyUsage</span><br>
<span class="lineno"></span><span class="op" id="4081944">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4081947">const</span>&nbsp;<span class="op" id="4081953">(</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4081956">leafCertificate</span>&nbsp;<span class="op" id="4081972">=</span>&nbsp;<span class="ident" id="4081974">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4081980">intermediateCertificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4082005">rootCertificate</span><br>
<span class="lineno"></span><span class="op" id="4082021">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="comment" id="4082024">//&nbsp;isValid&nbsp;performs&nbsp;validity&nbsp;checks&nbsp;on&nbsp;the&nbsp;c.</span><br>
<span class="lineno"></span><span class="keyword" id="4082070">func</span>&nbsp;<span class="op" id="4082075">(</span><span class="ident" id="4082076">c</span>&nbsp;<span class="op" id="4082078">*</span><span class="ident" id="4082079">Certificate</span><span class="op" id="4082090">)</span>&nbsp;<span class="ident" id="4082092">isValid</span><span class="op" id="4082099">(</span><span class="ident" id="4082100">certType</span>&nbsp;<span class="builtintype" id="4082109">int</span><span class="op" id="4082112">,</span>&nbsp;<span class="ident" id="4082114">currentChain</span>&nbsp;<span class="op" id="4082127">[</span><span class="op" id="4082128">]</span><span class="op" id="4082129">*</span><span class="ident" id="4082130">Certificate</span><span class="op" id="4082141">,</span>&nbsp;<span class="ident" id="4082143">opts</span>&nbsp;<span class="op" id="4082148">*</span><span class="ident" id="4082149">VerifyOptions</span><span class="op" id="4082162">)</span>&nbsp;<span class="builtintype" id="4082164">error</span>&nbsp;<span class="op" id="4082170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4082173">now</span>&nbsp;<span class="op" id="4082177">:=</span>&nbsp;<span class="ident" id="4082180">opts</span><span class="op" id="4082184">.</span><span class="ident" id="4082185">CurrentTime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4082198">if</span>&nbsp;<span class="ident" id="4082201">now</span><span class="op" id="4082204">.</span><span class="ident" id="4082205">IsZero</span><span class="op" id="4082211">(</span><span class="op" id="4082212">)</span>&nbsp;<span class="op" id="4082214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4082218">now</span>&nbsp;<span class="op" id="4082222">=</span>&nbsp;<span class="ident" id="4082224">time</span><span class="op" id="4082228">.</span><span class="ident" id="4082229">Now</span><span class="op" id="4082232">(</span><span class="op" id="4082233">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4082236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4082239">if</span>&nbsp;<span class="ident" id="4082242">now</span><span class="op" id="4082245">.</span><span class="ident" id="4082246">Before</span><span class="op" id="4082252">(</span><span class="ident" id="4082253">c</span><span class="op" id="4082254">.</span><span class="ident" id="4082255">NotBefore</span><span class="op" id="4082264">)</span>&nbsp;<span class="op" id="4082266">||</span>&nbsp;<span class="ident" id="4082269">now</span><span class="op" id="4082272">.</span><span class="ident" id="4082273">After</span><span class="op" id="4082278">(</span><span class="ident" id="4082279">c</span><span class="op" id="4082280">.</span><span class="ident" id="4082281">NotAfter</span><span class="op" id="4082289">)</span>&nbsp;<span class="op" id="4082291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4082295">return</span>&nbsp;<span class="ident" id="4082302">CertificateInvalidError</span><span class="op" id="4082325">{</span><span class="ident" id="4082326">c</span><span class="op" id="4082327">,</span>&nbsp;<span class="ident" id="4082329">Expired</span><span class="op" id="4082336">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4082339">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4082343">if</span>&nbsp;<span class="builtinfunc" id="4082346">len</span><span class="op" id="4082349">(</span><span class="ident" id="4082350">c</span><span class="op" id="4082351">.</span><span class="ident" id="4082352">PermittedDNSDomains</span><span class="op" id="4082371">)</span>&nbsp;<span class="op" id="4082373">&gt;</span>&nbsp;<span class="num" id="4082375">0</span>&nbsp;<span class="op" id="4082377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4082381">ok</span>&nbsp;<span class="op" id="4082384">:=</span>&nbsp;<span class="ident" id="4082387">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4082395">for</span>&nbsp;<span class="ident" id="4082399">_</span><span class="op" id="4082400">,</span>&nbsp;<span class="ident" id="4082402">domain</span>&nbsp;<span class="op" id="4082409">:=</span>&nbsp;<span class="keyword" id="4082412">range</span>&nbsp;<span class="ident" id="4082418">c</span><span class="op" id="4082419">.</span><span class="ident" id="4082420">PermittedDNSDomains</span>&nbsp;<span class="op" id="4082440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4082445">if</span>&nbsp;<span class="ident" id="4082448">opts</span><span class="op" id="4082452">.</span><span class="ident" id="4082453">DNSName</span>&nbsp;<span class="op" id="4082461">==</span>&nbsp;<span class="ident" id="4082464">domain</span>&nbsp;<span class="op" id="4082471">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4082478">(</span><span class="ident" id="4082479">strings</span><span class="op" id="4082486">.</span><span class="ident" id="4082487">HasSuffix</span><span class="op" id="4082496">(</span><span class="ident" id="4082497">opts</span><span class="op" id="4082501">.</span><span class="ident" id="4082502">DNSName</span><span class="op" id="4082509">,</span>&nbsp;<span class="ident" id="4082511">domain</span><span class="op" id="4082517">)</span>&nbsp;<span class="op" id="4082519">&amp;&amp;</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4082527">len</span><span class="op" id="4082530">(</span><span class="ident" id="4082531">opts</span><span class="op" id="4082535">.</span><span class="ident" id="4082536">DNSName</span><span class="op" id="4082543">)</span>&nbsp;<span class="op" id="4082545">&gt;=</span>&nbsp;<span class="num" id="4082548">1</span><span class="op" id="4082549">+</span><span class="builtinfunc" id="4082550">len</span><span class="op" id="4082553">(</span><span class="ident" id="4082554">domain</span><span class="op" id="4082560">)</span>&nbsp;<span class="op" id="4082562">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4082570">opts</span><span class="op" id="4082574">.</span><span class="ident" id="4082575">DNSName</span><span class="op" id="4082582">[</span><span class="builtinfunc" id="4082583">len</span><span class="op" id="4082586">(</span><span class="ident" id="4082587">opts</span><span class="op" id="4082591">.</span><span class="ident" id="4082592">DNSName</span><span class="op" id="4082599">)</span><span class="op" id="4082600">-</span><span class="builtinfunc" id="4082601">len</span><span class="op" id="4082604">(</span><span class="ident" id="4082605">domain</span><span class="op" id="4082611">)</span><span class="op" id="4082612">-</span><span class="num" id="4082613">1</span><span class="op" id="4082614">]</span>&nbsp;<span class="op" id="4082616">==</span>&nbsp;<span class="string" id="4082619">&#39;.&#39;</span><span class="op" id="4082622">)</span>&nbsp;<span class="op" id="4082624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4082630">ok</span>&nbsp;<span class="op" id="4082633">=</span>&nbsp;<span class="ident" id="4082635">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4082644">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4082653">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4082657">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4082662">if</span>&nbsp;<span class="op" id="4082665">!</span><span class="ident" id="4082666">ok</span>&nbsp;<span class="op" id="4082669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4082674">return</span>&nbsp;<span class="ident" id="4082681">CertificateInvalidError</span><span class="op" id="4082704">{</span><span class="ident" id="4082705">c</span><span class="op" id="4082706">,</span>&nbsp;<span class="ident" id="4082708">CANotAuthorizedForThisName</span><span class="op" id="4082734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4082738">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4082741">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4082745">//&nbsp;KeyUsage&nbsp;status&nbsp;flags&nbsp;are&nbsp;ignored.&nbsp;From&nbsp;Engineering&nbsp;Security,&nbsp;Peter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4082817">//&nbsp;Gutmann:&nbsp;A&nbsp;European&nbsp;government&nbsp;CA&nbsp;marked&nbsp;its&nbsp;signing&nbsp;certificates&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4082890">//&nbsp;being&nbsp;valid&nbsp;for&nbsp;encryption&nbsp;only,&nbsp;but&nbsp;no-one&nbsp;noticed.&nbsp;Another</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4082955">//&nbsp;European&nbsp;CA&nbsp;marked&nbsp;its&nbsp;signature&nbsp;keys&nbsp;as&nbsp;not&nbsp;being&nbsp;valid&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4083020">//&nbsp;signatures.&nbsp;A&nbsp;different&nbsp;CA&nbsp;marked&nbsp;its&nbsp;own&nbsp;trusted&nbsp;root&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4083091">//&nbsp;as&nbsp;being&nbsp;invalid&nbsp;for&nbsp;certificate&nbsp;signing.&nbsp;&nbsp;Another&nbsp;national&nbsp;CA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4083158">//&nbsp;distributed&nbsp;a&nbsp;certificate&nbsp;to&nbsp;be&nbsp;used&nbsp;to&nbsp;encrypt&nbsp;data&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4083223">//&nbsp;countryâ€™s&nbsp;tax&nbsp;authority&nbsp;that&nbsp;was&nbsp;marked&nbsp;as&nbsp;only&nbsp;being&nbsp;usable&nbsp;for</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4083294">//&nbsp;digital&nbsp;signatures&nbsp;but&nbsp;not&nbsp;for&nbsp;encryption.&nbsp;Yet&nbsp;another&nbsp;CA&nbsp;reversed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4083365">//&nbsp;the&nbsp;order&nbsp;of&nbsp;the&nbsp;bit&nbsp;flags&nbsp;in&nbsp;the&nbsp;keyUsage&nbsp;due&nbsp;to&nbsp;confusion&nbsp;over</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4083434">//&nbsp;encoding&nbsp;endianness,&nbsp;essentially&nbsp;setting&nbsp;a&nbsp;random&nbsp;keyUsage&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4083500">//&nbsp;certificates&nbsp;that&nbsp;it&nbsp;issued.&nbsp;Another&nbsp;CA&nbsp;created&nbsp;a&nbsp;self-invalidating</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4083572">//&nbsp;certificate&nbsp;by&nbsp;adding&nbsp;a&nbsp;certificate&nbsp;policy&nbsp;statement&nbsp;stipulating</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4083641">//&nbsp;that&nbsp;the&nbsp;certificate&nbsp;had&nbsp;to&nbsp;be&nbsp;used&nbsp;strictly&nbsp;as&nbsp;specified&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4083710">//&nbsp;keyUsage,&nbsp;and&nbsp;a&nbsp;keyUsage&nbsp;containing&nbsp;a&nbsp;flag&nbsp;indicating&nbsp;that&nbsp;the&nbsp;RSA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4083781">//&nbsp;encryption&nbsp;key&nbsp;could&nbsp;only&nbsp;be&nbsp;used&nbsp;for&nbsp;Diffie-Hellman&nbsp;key&nbsp;agreement.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4083854">if</span>&nbsp;<span class="ident" id="4083857">certType</span>&nbsp;<span class="op" id="4083866">==</span>&nbsp;<span class="ident" id="4083869">intermediateCertificate</span>&nbsp;<span class="op" id="4083893">&amp;&amp;</span>&nbsp;<span class="op" id="4083896">(</span><span class="op" id="4083897">!</span><span class="ident" id="4083898">c</span><span class="op" id="4083899">.</span><span class="ident" id="4083900">BasicConstraintsValid</span>&nbsp;<span class="op" id="4083922">||</span>&nbsp;<span class="op" id="4083925">!</span><span class="ident" id="4083926">c</span><span class="op" id="4083927">.</span><span class="ident" id="4083928">IsCA</span><span class="op" id="4083932">)</span>&nbsp;<span class="op" id="4083934">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4083938">return</span>&nbsp;<span class="ident" id="4083945">CertificateInvalidError</span><span class="op" id="4083968">{</span><span class="ident" id="4083969">c</span><span class="op" id="4083970">,</span>&nbsp;<span class="ident" id="4083972">NotAuthorizedToSign</span><span class="op" id="4083991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4083994">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4083998">if</span>&nbsp;<span class="ident" id="4084001">c</span><span class="op" id="4084002">.</span><span class="ident" id="4084003">BasicConstraintsValid</span>&nbsp;<span class="op" id="4084025">&amp;&amp;</span>&nbsp;<span class="ident" id="4084028">c</span><span class="op" id="4084029">.</span><span class="ident" id="4084030">MaxPathLen</span>&nbsp;<span class="op" id="4084041">&gt;=</span>&nbsp;<span class="num" id="4084044">0</span>&nbsp;<span class="op" id="4084046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4084050">numIntermediates</span>&nbsp;<span class="op" id="4084067">:=</span>&nbsp;<span class="builtinfunc" id="4084070">len</span><span class="op" id="4084073">(</span><span class="ident" id="4084074">currentChain</span><span class="op" id="4084086">)</span>&nbsp;<span class="op" id="4084088">-</span>&nbsp;<span class="num" id="4084090">1</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4084094">if</span>&nbsp;<span class="ident" id="4084097">numIntermediates</span>&nbsp;<span class="op" id="4084114">&gt;</span>&nbsp;<span class="ident" id="4084116">c</span><span class="op" id="4084117">.</span><span class="ident" id="4084118">MaxPathLen</span>&nbsp;<span class="op" id="4084129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4084134">return</span>&nbsp;<span class="ident" id="4084141">CertificateInvalidError</span><span class="op" id="4084164">{</span><span class="ident" id="4084165">c</span><span class="op" id="4084166">,</span>&nbsp;<span class="ident" id="4084168">TooManyIntermediates</span><span class="op" id="4084188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4084192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4084195">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4084199">return</span>&nbsp;<span class="ident" id="4084206">nil</span><br>
<span class="lineno"></span><span class="op" id="4084210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4084213">//&nbsp;Verify&nbsp;attempts&nbsp;to&nbsp;verify&nbsp;c&nbsp;by&nbsp;building&nbsp;one&nbsp;or&nbsp;more&nbsp;chains&nbsp;from&nbsp;c&nbsp;to&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4084287">//&nbsp;certificate&nbsp;in&nbsp;opts.Roots,&nbsp;using&nbsp;certificates&nbsp;in&nbsp;opts.Intermediates&nbsp;if</span><br>
<span class="lineno">205</span><span class="comment" id="4084361">//&nbsp;needed.&nbsp;If&nbsp;successful,&nbsp;it&nbsp;returns&nbsp;one&nbsp;or&nbsp;more&nbsp;chains&nbsp;where&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="4084433">//&nbsp;element&nbsp;of&nbsp;the&nbsp;chain&nbsp;is&nbsp;c&nbsp;and&nbsp;the&nbsp;last&nbsp;element&nbsp;is&nbsp;from&nbsp;opts.Roots.</span><br>
<span class="lineno"></span><span class="comment" id="4084503">//</span><br>
<span class="lineno"></span><span class="comment" id="4084506">//&nbsp;If&nbsp;opts.Roots&nbsp;is&nbsp;nil&nbsp;and&nbsp;system&nbsp;roots&nbsp;are&nbsp;unavailable&nbsp;the&nbsp;returned&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="4084582">//&nbsp;will&nbsp;be&nbsp;of&nbsp;type&nbsp;SystemRootsError.</span><br>
<span class="lineno">210</span><span class="comment" id="4084619">//</span><br>
<span class="lineno"></span><span class="comment" id="4084622">//&nbsp;WARNING:&nbsp;this&nbsp;doesn&#39;t&nbsp;do&nbsp;any&nbsp;revocation&nbsp;checking.</span><br>
<span class="lineno"></span><span class="keyword" id="4084675">func</span>&nbsp;<span class="op" id="4084680">(</span><span class="ident" id="4084681">c</span>&nbsp;<span class="op" id="4084683">*</span><span class="ident" id="4084684">Certificate</span><span class="op" id="4084695">)</span>&nbsp;<span class="ident" id="4084697">Verify</span><span class="op" id="4084703">(</span><span class="ident" id="4084704">opts</span>&nbsp;<span class="ident" id="4084709">VerifyOptions</span><span class="op" id="4084722">)</span>&nbsp;<span class="op" id="4084724">(</span><span class="ident" id="4084725">chains</span>&nbsp;<span class="op" id="4084732">[</span><span class="op" id="4084733">]</span><span class="op" id="4084734">[</span><span class="op" id="4084735">]</span><span class="op" id="4084736">*</span><span class="ident" id="4084737">Certificate</span><span class="op" id="4084748">,</span>&nbsp;<span class="ident" id="4084750">err</span>&nbsp;<span class="builtintype" id="4084754">error</span><span class="op" id="4084759">)</span>&nbsp;<span class="op" id="4084761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4084764">//&nbsp;Use&nbsp;Windows&#39;s&nbsp;own&nbsp;verification&nbsp;and&nbsp;chain&nbsp;building.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4084819">if</span>&nbsp;<span class="ident" id="4084822">opts</span><span class="op" id="4084826">.</span><span class="ident" id="4084827">Roots</span>&nbsp;<span class="op" id="4084833">==</span>&nbsp;<span class="ident" id="4084836">nil</span>&nbsp;<span class="op" id="4084840">&amp;&amp;</span>&nbsp;<span class="ident" id="4084843">runtime</span><span class="op" id="4084850">.</span><span class="ident" id="4084851">GOOS</span>&nbsp;<span class="op" id="4084856">==</span>&nbsp;<span class="string" id="4084859">&#34;windows&#34;</span>&nbsp;<span class="op" id="4084869">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4084873">return</span>&nbsp;<span class="ident" id="4084880">c</span><span class="op" id="4084881">.</span><span class="ident" id="4084882">systemVerify</span><span class="op" id="4084894">(</span><span class="op" id="4084895">&amp;</span><span class="ident" id="4084896">opts</span><span class="op" id="4084900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4084903">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4084907">if</span>&nbsp;<span class="ident" id="4084910">opts</span><span class="op" id="4084914">.</span><span class="ident" id="4084915">Roots</span>&nbsp;<span class="op" id="4084921">==</span>&nbsp;<span class="ident" id="4084924">nil</span>&nbsp;<span class="op" id="4084928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4084932">opts</span><span class="op" id="4084936">.</span><span class="ident" id="4084937">Roots</span>&nbsp;<span class="op" id="4084943">=</span>&nbsp;<span class="ident" id="4084945">systemRootsPool</span><span class="op" id="4084960">(</span><span class="op" id="4084961">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4084965">if</span>&nbsp;<span class="ident" id="4084968">opts</span><span class="op" id="4084972">.</span><span class="ident" id="4084973">Roots</span>&nbsp;<span class="op" id="4084979">==</span>&nbsp;<span class="ident" id="4084982">nil</span>&nbsp;<span class="op" id="4084986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4084991">return</span>&nbsp;<span class="ident" id="4084998">nil</span><span class="op" id="4085001">,</span>&nbsp;<span class="ident" id="4085003">SystemRootsError</span><span class="op" id="4085019">{</span><span class="op" id="4085020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4085024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4085027">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4085031">err</span>&nbsp;<span class="op" id="4085035">=</span>&nbsp;<span class="ident" id="4085037">c</span><span class="op" id="4085038">.</span><span class="ident" id="4085039">isValid</span><span class="op" id="4085046">(</span><span class="ident" id="4085047">leafCertificate</span><span class="op" id="4085062">,</span>&nbsp;<span class="ident" id="4085064">nil</span><span class="op" id="4085067">,</span>&nbsp;<span class="op" id="4085069">&amp;</span><span class="ident" id="4085070">opts</span><span class="op" id="4085074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4085077">if</span>&nbsp;<span class="ident" id="4085080">err</span>&nbsp;<span class="op" id="4085084">!=</span>&nbsp;<span class="ident" id="4085087">nil</span>&nbsp;<span class="op" id="4085091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4085095">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4085103">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4085107">if</span>&nbsp;<span class="builtinfunc" id="4085110">len</span><span class="op" id="4085113">(</span><span class="ident" id="4085114">opts</span><span class="op" id="4085118">.</span><span class="ident" id="4085119">DNSName</span><span class="op" id="4085126">)</span>&nbsp;<span class="op" id="4085128">&gt;</span>&nbsp;<span class="num" id="4085130">0</span>&nbsp;<span class="op" id="4085132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4085136">err</span>&nbsp;<span class="op" id="4085140">=</span>&nbsp;<span class="ident" id="4085142">c</span><span class="op" id="4085143">.</span><span class="ident" id="4085144">VerifyHostname</span><span class="op" id="4085158">(</span><span class="ident" id="4085159">opts</span><span class="op" id="4085163">.</span><span class="ident" id="4085164">DNSName</span><span class="op" id="4085171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4085175">if</span>&nbsp;<span class="ident" id="4085178">err</span>&nbsp;<span class="op" id="4085182">!=</span>&nbsp;<span class="ident" id="4085185">nil</span>&nbsp;<span class="op" id="4085189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4085194">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4085203">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4085206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4085210">candidateChains</span><span class="op" id="4085225">,</span>&nbsp;<span class="ident" id="4085227">err</span>&nbsp;<span class="op" id="4085231">:=</span>&nbsp;<span class="ident" id="4085234">c</span><span class="op" id="4085235">.</span><span class="ident" id="4085236">buildChains</span><span class="op" id="4085247">(</span><span class="builtinfunc" id="4085248">make</span><span class="op" id="4085252">(</span><span class="keyword" id="4085253">map</span><span class="op" id="4085256">[</span><span class="builtintype" id="4085257">int</span><span class="op" id="4085260">]</span><span class="op" id="4085261">[</span><span class="op" id="4085262">]</span><span class="op" id="4085263">[</span><span class="op" id="4085264">]</span><span class="op" id="4085265">*</span><span class="ident" id="4085266">Certificate</span><span class="op" id="4085277">)</span><span class="op" id="4085278">,</span>&nbsp;<span class="op" id="4085280">[</span><span class="op" id="4085281">]</span><span class="op" id="4085282">*</span><span class="ident" id="4085283">Certificate</span><span class="op" id="4085294">{</span><span class="ident" id="4085295">c</span><span class="op" id="4085296">}</span><span class="op" id="4085297">,</span>&nbsp;<span class="op" id="4085299">&amp;</span><span class="ident" id="4085300">opts</span><span class="op" id="4085304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4085307">if</span>&nbsp;<span class="ident" id="4085310">err</span>&nbsp;<span class="op" id="4085314">!=</span>&nbsp;<span class="ident" id="4085317">nil</span>&nbsp;<span class="op" id="4085321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4085325">return</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4085333">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4085337">keyUsages</span>&nbsp;<span class="op" id="4085347">:=</span>&nbsp;<span class="ident" id="4085350">opts</span><span class="op" id="4085354">.</span><span class="ident" id="4085355">KeyUsages</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4085366">if</span>&nbsp;<span class="builtinfunc" id="4085369">len</span><span class="op" id="4085372">(</span><span class="ident" id="4085373">keyUsages</span><span class="op" id="4085382">)</span>&nbsp;<span class="op" id="4085384">==</span>&nbsp;<span class="num" id="4085387">0</span>&nbsp;<span class="op" id="4085389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4085393">keyUsages</span>&nbsp;<span class="op" id="4085403">=</span>&nbsp;<span class="op" id="4085405">[</span><span class="op" id="4085406">]</span><span class="ident" id="4085407">ExtKeyUsage</span><span class="op" id="4085418">{</span><span class="ident" id="4085419">ExtKeyUsageServerAuth</span><span class="op" id="4085440">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4085443">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4085447">//&nbsp;If&nbsp;any&nbsp;key&nbsp;usage&nbsp;is&nbsp;acceptable&nbsp;then&nbsp;we&#39;re&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4085499">for</span>&nbsp;<span class="ident" id="4085503">_</span><span class="op" id="4085504">,</span>&nbsp;<span class="ident" id="4085506">usage</span>&nbsp;<span class="op" id="4085512">:=</span>&nbsp;<span class="keyword" id="4085515">range</span>&nbsp;<span class="ident" id="4085521">keyUsages</span>&nbsp;<span class="op" id="4085531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4085535">if</span>&nbsp;<span class="ident" id="4085538">usage</span>&nbsp;<span class="op" id="4085544">==</span>&nbsp;<span class="ident" id="4085547">ExtKeyUsageAny</span>&nbsp;<span class="op" id="4085562">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4085567">chains</span>&nbsp;<span class="op" id="4085574">=</span>&nbsp;<span class="ident" id="4085576">candidateChains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4085595">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4085604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4085607">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4085611">for</span>&nbsp;<span class="ident" id="4085615">_</span><span class="op" id="4085616">,</span>&nbsp;<span class="ident" id="4085618">candidate</span>&nbsp;<span class="op" id="4085628">:=</span>&nbsp;<span class="keyword" id="4085631">range</span>&nbsp;<span class="ident" id="4085637">candidateChains</span>&nbsp;<span class="op" id="4085653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4085657">if</span>&nbsp;<span class="ident" id="4085660">checkChainForKeyUsage</span><span class="op" id="4085681">(</span><span class="ident" id="4085682">candidate</span><span class="op" id="4085691">,</span>&nbsp;<span class="ident" id="4085693">keyUsages</span><span class="op" id="4085702">)</span>&nbsp;<span class="op" id="4085704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4085709">chains</span>&nbsp;<span class="op" id="4085716">=</span>&nbsp;<span class="builtinfunc" id="4085718">append</span><span class="op" id="4085724">(</span><span class="ident" id="4085725">chains</span><span class="op" id="4085731">,</span>&nbsp;<span class="ident" id="4085733">candidate</span><span class="op" id="4085742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4085746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4085749">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4085753">if</span>&nbsp;<span class="builtinfunc" id="4085756">len</span><span class="op" id="4085759">(</span><span class="ident" id="4085760">chains</span><span class="op" id="4085766">)</span>&nbsp;<span class="op" id="4085768">==</span>&nbsp;<span class="num" id="4085771">0</span>&nbsp;<span class="op" id="4085773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4085777">err</span>&nbsp;<span class="op" id="4085781">=</span>&nbsp;<span class="ident" id="4085783">CertificateInvalidError</span><span class="op" id="4085806">{</span><span class="ident" id="4085807">c</span><span class="op" id="4085808">,</span>&nbsp;<span class="ident" id="4085810">IncompatibleUsage</span><span class="op" id="4085827">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4085830">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4085834">return</span><br>
<span class="lineno"></span><span class="op" id="4085841">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4085844">func</span>&nbsp;<span class="ident" id="4085849">appendToFreshChain</span><span class="op" id="4085867">(</span><span class="ident" id="4085868">chain</span>&nbsp;<span class="op" id="4085874">[</span><span class="op" id="4085875">]</span><span class="op" id="4085876">*</span><span class="ident" id="4085877">Certificate</span><span class="op" id="4085888">,</span>&nbsp;<span class="ident" id="4085890">cert</span>&nbsp;<span class="op" id="4085895">*</span><span class="ident" id="4085896">Certificate</span><span class="op" id="4085907">)</span>&nbsp;<span class="op" id="4085909">[</span><span class="op" id="4085910">]</span><span class="op" id="4085911">*</span><span class="ident" id="4085912">Certificate</span>&nbsp;<span class="op" id="4085924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4085927">n</span>&nbsp;<span class="op" id="4085929">:=</span>&nbsp;<span class="builtinfunc" id="4085932">make</span><span class="op" id="4085936">(</span><span class="op" id="4085937">[</span><span class="op" id="4085938">]</span><span class="op" id="4085939">*</span><span class="ident" id="4085940">Certificate</span><span class="op" id="4085951">,</span>&nbsp;<span class="builtinfunc" id="4085953">len</span><span class="op" id="4085956">(</span><span class="ident" id="4085957">chain</span><span class="op" id="4085962">)</span><span class="op" id="4085963">+</span><span class="num" id="4085964">1</span><span class="op" id="4085965">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4085968">copy</span><span class="op" id="4085972">(</span><span class="ident" id="4085973">n</span><span class="op" id="4085974">,</span>&nbsp;<span class="ident" id="4085976">chain</span><span class="op" id="4085981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4085984">n</span><span class="op" id="4085985">[</span><span class="builtinfunc" id="4085986">len</span><span class="op" id="4085989">(</span><span class="ident" id="4085990">chain</span><span class="op" id="4085995">)</span><span class="op" id="4085996">]</span>&nbsp;<span class="op" id="4085998">=</span>&nbsp;<span class="ident" id="4086000">cert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4086006">return</span>&nbsp;<span class="ident" id="4086013">n</span><br>
<span class="lineno"></span><span class="op" id="4086015">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span><span class="keyword" id="4086018">func</span>&nbsp;<span class="op" id="4086023">(</span><span class="ident" id="4086024">c</span>&nbsp;<span class="op" id="4086026">*</span><span class="ident" id="4086027">Certificate</span><span class="op" id="4086038">)</span>&nbsp;<span class="ident" id="4086040">buildChains</span><span class="op" id="4086051">(</span><span class="ident" id="4086052">cache</span>&nbsp;<span class="keyword" id="4086058">map</span><span class="op" id="4086061">[</span><span class="builtintype" id="4086062">int</span><span class="op" id="4086065">]</span><span class="op" id="4086066">[</span><span class="op" id="4086067">]</span><span class="op" id="4086068">[</span><span class="op" id="4086069">]</span><span class="op" id="4086070">*</span><span class="ident" id="4086071">Certificate</span><span class="op" id="4086082">,</span>&nbsp;<span class="ident" id="4086084">currentChain</span>&nbsp;<span class="op" id="4086097">[</span><span class="op" id="4086098">]</span><span class="op" id="4086099">*</span><span class="ident" id="4086100">Certificate</span><span class="op" id="4086111">,</span>&nbsp;<span class="ident" id="4086113">opts</span>&nbsp;<span class="op" id="4086118">*</span><span class="ident" id="4086119">VerifyOptions</span><span class="op" id="4086132">)</span>&nbsp;<span class="op" id="4086134">(</span><span class="ident" id="4086135">chains</span>&nbsp;<span class="op" id="4086142">[</span><span class="op" id="4086143">]</span><span class="op" id="4086144">[</span><span class="op" id="4086145">]</span><span class="op" id="4086146">*</span><span class="ident" id="4086147">Certificate</span><span class="op" id="4086158">,</span>&nbsp;<span class="ident" id="4086160">err</span>&nbsp;<span class="builtintype" id="4086164">error</span><span class="op" id="4086169">)</span>&nbsp;<span class="op" id="4086171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4086174">possibleRoots</span><span class="op" id="4086187">,</span>&nbsp;<span class="ident" id="4086189">failedRoot</span><span class="op" id="4086199">,</span>&nbsp;<span class="ident" id="4086201">rootErr</span>&nbsp;<span class="op" id="4086209">:=</span>&nbsp;<span class="ident" id="4086212">opts</span><span class="op" id="4086216">.</span><span class="ident" id="4086217">Roots</span><span class="op" id="4086222">.</span><span class="ident" id="4086223">findVerifiedParents</span><span class="op" id="4086242">(</span><span class="ident" id="4086243">c</span><span class="op" id="4086244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4086247">for</span>&nbsp;<span class="ident" id="4086251">_</span><span class="op" id="4086252">,</span>&nbsp;<span class="ident" id="4086254">rootNum</span>&nbsp;<span class="op" id="4086262">:=</span>&nbsp;<span class="keyword" id="4086265">range</span>&nbsp;<span class="ident" id="4086271">possibleRoots</span>&nbsp;<span class="op" id="4086285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4086289">root</span>&nbsp;<span class="op" id="4086294">:=</span>&nbsp;<span class="ident" id="4086297">opts</span><span class="op" id="4086301">.</span><span class="ident" id="4086302">Roots</span><span class="op" id="4086307">.</span><span class="ident" id="4086308">certs</span><span class="op" id="4086313">[</span><span class="ident" id="4086314">rootNum</span><span class="op" id="4086321">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4086325">err</span>&nbsp;<span class="op" id="4086329">=</span>&nbsp;<span class="ident" id="4086331">root</span><span class="op" id="4086335">.</span><span class="ident" id="4086336">isValid</span><span class="op" id="4086343">(</span><span class="ident" id="4086344">rootCertificate</span><span class="op" id="4086359">,</span>&nbsp;<span class="ident" id="4086361">currentChain</span><span class="op" id="4086373">,</span>&nbsp;<span class="ident" id="4086375">opts</span><span class="op" id="4086379">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4086383">if</span>&nbsp;<span class="ident" id="4086386">err</span>&nbsp;<span class="op" id="4086390">!=</span>&nbsp;<span class="ident" id="4086393">nil</span>&nbsp;<span class="op" id="4086397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4086402">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4086413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4086417">chains</span>&nbsp;<span class="op" id="4086424">=</span>&nbsp;<span class="builtinfunc" id="4086426">append</span><span class="op" id="4086432">(</span><span class="ident" id="4086433">chains</span><span class="op" id="4086439">,</span>&nbsp;<span class="ident" id="4086441">appendToFreshChain</span><span class="op" id="4086459">(</span><span class="ident" id="4086460">currentChain</span><span class="op" id="4086472">,</span>&nbsp;<span class="ident" id="4086474">root</span><span class="op" id="4086478">)</span><span class="op" id="4086479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4086482">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4086486">possibleIntermediates</span><span class="op" id="4086507">,</span>&nbsp;<span class="ident" id="4086509">failedIntermediate</span><span class="op" id="4086527">,</span>&nbsp;<span class="ident" id="4086529">intermediateErr</span>&nbsp;<span class="op" id="4086545">:=</span>&nbsp;<span class="ident" id="4086548">opts</span><span class="op" id="4086552">.</span><span class="ident" id="4086553">Intermediates</span><span class="op" id="4086566">.</span><span class="ident" id="4086567">findVerifiedParents</span><span class="op" id="4086586">(</span><span class="ident" id="4086587">c</span><span class="op" id="4086588">)</span><br>
<span class="lineno"></span><span class="ident" id="4086590">nextIntermediate</span><span class="op" id="4086606">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4086609">for</span>&nbsp;<span class="ident" id="4086613">_</span><span class="op" id="4086614">,</span>&nbsp;<span class="ident" id="4086616">intermediateNum</span>&nbsp;<span class="op" id="4086632">:=</span>&nbsp;<span class="keyword" id="4086635">range</span>&nbsp;<span class="ident" id="4086641">possibleIntermediates</span>&nbsp;<span class="op" id="4086663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4086667">intermediate</span>&nbsp;<span class="op" id="4086680">:=</span>&nbsp;<span class="ident" id="4086683">opts</span><span class="op" id="4086687">.</span><span class="ident" id="4086688">Intermediates</span><span class="op" id="4086701">.</span><span class="ident" id="4086702">certs</span><span class="op" id="4086707">[</span><span class="ident" id="4086708">intermediateNum</span><span class="op" id="4086723">]</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4086727">for</span>&nbsp;<span class="ident" id="4086731">_</span><span class="op" id="4086732">,</span>&nbsp;<span class="ident" id="4086734">cert</span>&nbsp;<span class="op" id="4086739">:=</span>&nbsp;<span class="keyword" id="4086742">range</span>&nbsp;<span class="ident" id="4086748">currentChain</span>&nbsp;<span class="op" id="4086761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4086766">if</span>&nbsp;<span class="ident" id="4086769">cert</span>&nbsp;<span class="op" id="4086774">==</span>&nbsp;<span class="ident" id="4086777">intermediate</span>&nbsp;<span class="op" id="4086790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4086796">continue</span>&nbsp;<span class="ident" id="4086805">nextIntermediate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4086825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4086829">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4086833">err</span>&nbsp;<span class="op" id="4086837">=</span>&nbsp;<span class="ident" id="4086839">intermediate</span><span class="op" id="4086851">.</span><span class="ident" id="4086852">isValid</span><span class="op" id="4086859">(</span><span class="ident" id="4086860">intermediateCertificate</span><span class="op" id="4086883">,</span>&nbsp;<span class="ident" id="4086885">currentChain</span><span class="op" id="4086897">,</span>&nbsp;<span class="ident" id="4086899">opts</span><span class="op" id="4086903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4086907">if</span>&nbsp;<span class="ident" id="4086910">err</span>&nbsp;<span class="op" id="4086914">!=</span>&nbsp;<span class="ident" id="4086917">nil</span>&nbsp;<span class="op" id="4086921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4086926">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4086937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4086941">var</span>&nbsp;<span class="ident" id="4086945">childChains</span>&nbsp;<span class="op" id="4086957">[</span><span class="op" id="4086958">]</span><span class="op" id="4086959">[</span><span class="op" id="4086960">]</span><span class="op" id="4086961">*</span><span class="ident" id="4086962">Certificate</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4086976">childChains</span><span class="op" id="4086987">,</span>&nbsp;<span class="ident" id="4086989">ok</span>&nbsp;<span class="op" id="4086992">:=</span>&nbsp;<span class="ident" id="4086995">cache</span><span class="op" id="4087000">[</span><span class="ident" id="4087001">intermediateNum</span><span class="op" id="4087016">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4087020">if</span>&nbsp;<span class="op" id="4087023">!</span><span class="ident" id="4087024">ok</span>&nbsp;<span class="op" id="4087027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4087032">childChains</span><span class="op" id="4087043">,</span>&nbsp;<span class="ident" id="4087045">err</span>&nbsp;<span class="op" id="4087049">=</span>&nbsp;<span class="ident" id="4087051">intermediate</span><span class="op" id="4087063">.</span><span class="ident" id="4087064">buildChains</span><span class="op" id="4087075">(</span><span class="ident" id="4087076">cache</span><span class="op" id="4087081">,</span>&nbsp;<span class="ident" id="4087083">appendToFreshChain</span><span class="op" id="4087101">(</span><span class="ident" id="4087102">currentChain</span><span class="op" id="4087114">,</span>&nbsp;<span class="ident" id="4087116">intermediate</span><span class="op" id="4087128">)</span><span class="op" id="4087129">,</span>&nbsp;<span class="ident" id="4087131">opts</span><span class="op" id="4087135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4087140">cache</span><span class="op" id="4087145">[</span><span class="ident" id="4087146">intermediateNum</span><span class="op" id="4087161">]</span>&nbsp;<span class="op" id="4087163">=</span>&nbsp;<span class="ident" id="4087165">childChains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4087179">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4087183">chains</span>&nbsp;<span class="op" id="4087190">=</span>&nbsp;<span class="builtinfunc" id="4087192">append</span><span class="op" id="4087198">(</span><span class="ident" id="4087199">chains</span><span class="op" id="4087205">,</span>&nbsp;<span class="ident" id="4087207">childChains</span><span class="op" id="4087218">...</span><span class="op" id="4087221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4087224">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4087228">if</span>&nbsp;<span class="builtinfunc" id="4087231">len</span><span class="op" id="4087234">(</span><span class="ident" id="4087235">chains</span><span class="op" id="4087241">)</span>&nbsp;<span class="op" id="4087243">&gt;</span>&nbsp;<span class="num" id="4087245">0</span>&nbsp;<span class="op" id="4087247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4087251">err</span>&nbsp;<span class="op" id="4087255">=</span>&nbsp;<span class="ident" id="4087257">nil</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4087262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4087266">if</span>&nbsp;<span class="builtinfunc" id="4087269">len</span><span class="op" id="4087272">(</span><span class="ident" id="4087273">chains</span><span class="op" id="4087279">)</span>&nbsp;<span class="op" id="4087281">==</span>&nbsp;<span class="num" id="4087284">0</span>&nbsp;<span class="op" id="4087286">&amp;&amp;</span>&nbsp;<span class="ident" id="4087289">err</span>&nbsp;<span class="op" id="4087293">==</span>&nbsp;<span class="ident" id="4087296">nil</span>&nbsp;<span class="op" id="4087300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4087304">hintErr</span>&nbsp;<span class="op" id="4087312">:=</span>&nbsp;<span class="ident" id="4087315">rootErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4087325">hintCert</span>&nbsp;<span class="op" id="4087334">:=</span>&nbsp;<span class="ident" id="4087337">failedRoot</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4087350">if</span>&nbsp;<span class="ident" id="4087353">hintErr</span>&nbsp;<span class="op" id="4087361">==</span>&nbsp;<span class="ident" id="4087364">nil</span>&nbsp;<span class="op" id="4087368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4087373">hintErr</span>&nbsp;<span class="op" id="4087381">=</span>&nbsp;<span class="ident" id="4087383">intermediateErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4087402">hintCert</span>&nbsp;<span class="op" id="4087411">=</span>&nbsp;<span class="ident" id="4087413">failedIntermediate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4087434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4087438">err</span>&nbsp;<span class="op" id="4087442">=</span>&nbsp;<span class="ident" id="4087444">UnknownAuthorityError</span><span class="op" id="4087465">{</span><span class="ident" id="4087466">c</span><span class="op" id="4087467">,</span>&nbsp;<span class="ident" id="4087469">hintErr</span><span class="op" id="4087476">,</span>&nbsp;<span class="ident" id="4087478">hintCert</span><span class="op" id="4087486">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4087489">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4087493">return</span><br>
<span class="lineno"></span><span class="op" id="4087500">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="keyword" id="4087503">func</span>&nbsp;<span class="ident" id="4087508">matchHostnames</span><span class="op" id="4087522">(</span><span class="ident" id="4087523">pattern</span><span class="op" id="4087530">,</span>&nbsp;<span class="ident" id="4087532">host</span>&nbsp;<span class="builtintype" id="4087537">string</span><span class="op" id="4087543">)</span>&nbsp;<span class="builtintype" id="4087545">bool</span>&nbsp;<span class="op" id="4087550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4087553">if</span>&nbsp;<span class="builtinfunc" id="4087556">len</span><span class="op" id="4087559">(</span><span class="ident" id="4087560">pattern</span><span class="op" id="4087567">)</span>&nbsp;<span class="op" id="4087569">==</span>&nbsp;<span class="num" id="4087572">0</span>&nbsp;<span class="op" id="4087574">||</span>&nbsp;<span class="builtinfunc" id="4087577">len</span><span class="op" id="4087580">(</span><span class="ident" id="4087581">host</span><span class="op" id="4087585">)</span>&nbsp;<span class="op" id="4087587">==</span>&nbsp;<span class="num" id="4087590">0</span>&nbsp;<span class="op" id="4087592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4087596">return</span>&nbsp;<span class="ident" id="4087603">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4087610">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4087614">patternParts</span>&nbsp;<span class="op" id="4087627">:=</span>&nbsp;<span class="ident" id="4087630">strings</span><span class="op" id="4087637">.</span><span class="ident" id="4087638">Split</span><span class="op" id="4087643">(</span><span class="ident" id="4087644">pattern</span><span class="op" id="4087651">,</span>&nbsp;<span class="string" id="4087653">&#34;.&#34;</span><span class="op" id="4087656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4087659">hostParts</span>&nbsp;<span class="op" id="4087669">:=</span>&nbsp;<span class="ident" id="4087672">strings</span><span class="op" id="4087679">.</span><span class="ident" id="4087680">Split</span><span class="op" id="4087685">(</span><span class="ident" id="4087686">host</span><span class="op" id="4087690">,</span>&nbsp;<span class="string" id="4087692">&#34;.&#34;</span><span class="op" id="4087695">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4087699">if</span>&nbsp;<span class="builtinfunc" id="4087702">len</span><span class="op" id="4087705">(</span><span class="ident" id="4087706">patternParts</span><span class="op" id="4087718">)</span>&nbsp;<span class="op" id="4087720">!=</span>&nbsp;<span class="builtinfunc" id="4087723">len</span><span class="op" id="4087726">(</span><span class="ident" id="4087727">hostParts</span><span class="op" id="4087736">)</span>&nbsp;<span class="op" id="4087738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4087742">return</span>&nbsp;<span class="ident" id="4087749">false</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4087756">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4087760">for</span>&nbsp;<span class="ident" id="4087764">i</span><span class="op" id="4087765">,</span>&nbsp;<span class="ident" id="4087767">patternPart</span>&nbsp;<span class="op" id="4087779">:=</span>&nbsp;<span class="keyword" id="4087782">range</span>&nbsp;<span class="ident" id="4087788">patternParts</span>&nbsp;<span class="op" id="4087801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4087805">if</span>&nbsp;<span class="ident" id="4087808">patternPart</span>&nbsp;<span class="op" id="4087820">==</span>&nbsp;<span class="string" id="4087823">&#34;*&#34;</span>&nbsp;<span class="op" id="4087827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4087832">continue</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4087843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4087847">if</span>&nbsp;<span class="ident" id="4087850">patternPart</span>&nbsp;<span class="op" id="4087862">!=</span>&nbsp;<span class="ident" id="4087865">hostParts</span><span class="op" id="4087874">[</span><span class="ident" id="4087875">i</span><span class="op" id="4087876">]</span>&nbsp;<span class="op" id="4087878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4087883">return</span>&nbsp;<span class="ident" id="4087890">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4087898">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4087901">}</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4087905">return</span>&nbsp;<span class="ident" id="4087912">true</span><br>
<span class="lineno"></span><span class="op" id="4087917">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4087920">//&nbsp;toLowerCaseASCII&nbsp;returns&nbsp;a&nbsp;lower-case&nbsp;version&nbsp;of&nbsp;in.&nbsp;See&nbsp;RFC&nbsp;6125&nbsp;6.4.1.&nbsp;We&nbsp;use</span><br>
<span class="lineno">350</span><span class="comment" id="4088003">//&nbsp;an&nbsp;explicitly&nbsp;ASCII&nbsp;function&nbsp;to&nbsp;avoid&nbsp;any&nbsp;sharp&nbsp;corners&nbsp;resulting&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="4088077">//&nbsp;performing&nbsp;Unicode&nbsp;operations&nbsp;on&nbsp;DNS&nbsp;labels.</span><br>
<span class="lineno"></span><span class="keyword" id="4088125">func</span>&nbsp;<span class="ident" id="4088130">toLowerCaseASCII</span><span class="op" id="4088146">(</span><span class="ident" id="4088147">in</span>&nbsp;<span class="builtintype" id="4088150">string</span><span class="op" id="4088156">)</span>&nbsp;<span class="builtintype" id="4088158">string</span>&nbsp;<span class="op" id="4088165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4088168">//&nbsp;If&nbsp;the&nbsp;string&nbsp;is&nbsp;already&nbsp;lower-case&nbsp;then&nbsp;there&#39;s&nbsp;nothing&nbsp;to&nbsp;do.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4088236">isAlreadyLowerCase</span>&nbsp;<span class="op" id="4088255">:=</span>&nbsp;<span class="ident" id="4088258">true</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4088264">for</span>&nbsp;<span class="ident" id="4088268">_</span><span class="op" id="4088269">,</span>&nbsp;<span class="ident" id="4088271">c</span>&nbsp;<span class="op" id="4088273">:=</span>&nbsp;<span class="keyword" id="4088276">range</span>&nbsp;<span class="ident" id="4088282">in</span>&nbsp;<span class="op" id="4088285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4088289">if</span>&nbsp;<span class="ident" id="4088292">c</span>&nbsp;<span class="op" id="4088294">==</span>&nbsp;<span class="ident" id="4088297">utf8</span><span class="op" id="4088301">.</span><span class="ident" id="4088302">RuneError</span>&nbsp;<span class="op" id="4088312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4088317">//&nbsp;If&nbsp;we&nbsp;get&nbsp;a&nbsp;UTF-8&nbsp;error&nbsp;then&nbsp;there&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4088367">//&nbsp;upper-case&nbsp;ASCII&nbsp;bytes&nbsp;in&nbsp;the&nbsp;invalid&nbsp;sequence.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4088421">isAlreadyLowerCase</span>&nbsp;<span class="op" id="4088440">=</span>&nbsp;<span class="ident" id="4088442">false</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4088451">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4088459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4088463">if</span>&nbsp;<span class="string" id="4088466">&#39;A&#39;</span>&nbsp;<span class="op" id="4088470">&lt;=</span>&nbsp;<span class="ident" id="4088473">c</span>&nbsp;<span class="op" id="4088475">&amp;&amp;</span>&nbsp;<span class="ident" id="4088478">c</span>&nbsp;<span class="op" id="4088480">&lt;=</span>&nbsp;<span class="string" id="4088483">&#39;Z&#39;</span>&nbsp;<span class="op" id="4088487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4088492">isAlreadyLowerCase</span>&nbsp;<span class="op" id="4088511">=</span>&nbsp;<span class="ident" id="4088513">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4088522">break</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4088530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4088533">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4088537">if</span>&nbsp;<span class="ident" id="4088540">isAlreadyLowerCase</span>&nbsp;<span class="op" id="4088559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4088563">return</span>&nbsp;<span class="ident" id="4088570">in</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4088574">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4088578">out</span>&nbsp;<span class="op" id="4088582">:=</span>&nbsp;<span class="op" id="4088585">[</span><span class="op" id="4088586">]</span><span class="builtintype" id="4088587">byte</span><span class="op" id="4088591">(</span><span class="ident" id="4088592">in</span><span class="op" id="4088594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4088597">for</span>&nbsp;<span class="ident" id="4088601">i</span><span class="op" id="4088602">,</span>&nbsp;<span class="ident" id="4088604">c</span>&nbsp;<span class="op" id="4088606">:=</span>&nbsp;<span class="keyword" id="4088609">range</span>&nbsp;<span class="ident" id="4088615">out</span>&nbsp;<span class="op" id="4088619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4088623">if</span>&nbsp;<span class="string" id="4088626">&#39;A&#39;</span>&nbsp;<span class="op" id="4088630">&lt;=</span>&nbsp;<span class="ident" id="4088633">c</span>&nbsp;<span class="op" id="4088635">&amp;&amp;</span>&nbsp;<span class="ident" id="4088638">c</span>&nbsp;<span class="op" id="4088640">&lt;=</span>&nbsp;<span class="string" id="4088643">&#39;Z&#39;</span>&nbsp;<span class="op" id="4088647">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4088652">out</span><span class="op" id="4088655">[</span><span class="ident" id="4088656">i</span><span class="op" id="4088657">]</span>&nbsp;<span class="op" id="4088659">+=</span>&nbsp;<span class="string" id="4088662">&#39;a&#39;</span>&nbsp;<span class="op" id="4088666">-</span>&nbsp;<span class="string" id="4088668">&#39;A&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4088674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4088677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4088680">return</span>&nbsp;<span class="builtintype" id="4088687">string</span><span class="op" id="4088693">(</span><span class="ident" id="4088694">out</span><span class="op" id="4088697">)</span><br>
<span class="lineno"></span><span class="op" id="4088699">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span><span class="comment" id="4088702">//&nbsp;VerifyHostname&nbsp;returns&nbsp;nil&nbsp;if&nbsp;c&nbsp;is&nbsp;a&nbsp;valid&nbsp;certificate&nbsp;for&nbsp;the&nbsp;named&nbsp;host.</span><br>
<span class="lineno"></span><span class="comment" id="4088780">//&nbsp;Otherwise&nbsp;it&nbsp;returns&nbsp;an&nbsp;error&nbsp;describing&nbsp;the&nbsp;mismatch.</span><br>
<span class="lineno"></span><span class="keyword" id="4088838">func</span>&nbsp;<span class="op" id="4088843">(</span><span class="ident" id="4088844">c</span>&nbsp;<span class="op" id="4088846">*</span><span class="ident" id="4088847">Certificate</span><span class="op" id="4088858">)</span>&nbsp;<span class="ident" id="4088860">VerifyHostname</span><span class="op" id="4088874">(</span><span class="ident" id="4088875">h</span>&nbsp;<span class="builtintype" id="4088877">string</span><span class="op" id="4088883">)</span>&nbsp;<span class="builtintype" id="4088885">error</span>&nbsp;<span class="op" id="4088891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4088894">//&nbsp;IP&nbsp;addresses&nbsp;may&nbsp;be&nbsp;written&nbsp;in&nbsp;[&nbsp;].</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4088934">candidateIP</span>&nbsp;<span class="op" id="4088946">:=</span>&nbsp;<span class="ident" id="4088949">h</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4088952">if</span>&nbsp;<span class="builtinfunc" id="4088955">len</span><span class="op" id="4088958">(</span><span class="ident" id="4088959">h</span><span class="op" id="4088960">)</span>&nbsp;<span class="op" id="4088962">&gt;=</span>&nbsp;<span class="num" id="4088965">3</span>&nbsp;<span class="op" id="4088967">&amp;&amp;</span>&nbsp;<span class="ident" id="4088970">h</span><span class="op" id="4088971">[</span><span class="num" id="4088972">0</span><span class="op" id="4088973">]</span>&nbsp;<span class="op" id="4088975">==</span>&nbsp;<span class="string" id="4088978">&#39;[&#39;</span>&nbsp;<span class="op" id="4088982">&amp;&amp;</span>&nbsp;<span class="ident" id="4088985">h</span><span class="op" id="4088986">[</span><span class="builtinfunc" id="4088987">len</span><span class="op" id="4088990">(</span><span class="ident" id="4088991">h</span><span class="op" id="4088992">)</span><span class="op" id="4088993">-</span><span class="num" id="4088994">1</span><span class="op" id="4088995">]</span>&nbsp;<span class="op" id="4088997">==</span>&nbsp;<span class="string" id="4089000">&#39;]&#39;</span>&nbsp;<span class="op" id="4089004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4089008">candidateIP</span>&nbsp;<span class="op" id="4089020">=</span>&nbsp;<span class="ident" id="4089022">h</span><span class="op" id="4089023">[</span><span class="num" id="4089024">1</span>&nbsp;<span class="op" id="4089026">:</span>&nbsp;<span class="builtinfunc" id="4089028">len</span><span class="op" id="4089031">(</span><span class="ident" id="4089032">h</span><span class="op" id="4089033">)</span><span class="op" id="4089034">-</span><span class="num" id="4089035">1</span><span class="op" id="4089036">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4089039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4089042">if</span>&nbsp;<span class="ident" id="4089045">ip</span>&nbsp;<span class="op" id="4089048">:=</span>&nbsp;<span class="ident" id="4089051">net</span><span class="op" id="4089054">.</span><span class="ident" id="4089055">ParseIP</span><span class="op" id="4089062">(</span><span class="ident" id="4089063">candidateIP</span><span class="op" id="4089074">)</span><span class="op" id="4089075">;</span>&nbsp;<span class="ident" id="4089077">ip</span>&nbsp;<span class="op" id="4089080">!=</span>&nbsp;<span class="ident" id="4089083">nil</span>&nbsp;<span class="op" id="4089087">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4089091">//&nbsp;We&nbsp;only&nbsp;match&nbsp;IP&nbsp;addresses&nbsp;against&nbsp;IP&nbsp;SANs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4089140">//&nbsp;https://tools.ietf.org/html/rfc6125#appendix-B.2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4089194">for</span>&nbsp;<span class="ident" id="4089198">_</span><span class="op" id="4089199">,</span>&nbsp;<span class="ident" id="4089201">candidate</span>&nbsp;<span class="op" id="4089211">:=</span>&nbsp;<span class="keyword" id="4089214">range</span>&nbsp;<span class="ident" id="4089220">c</span><span class="op" id="4089221">.</span><span class="ident" id="4089222">IPAddresses</span>&nbsp;<span class="op" id="4089234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4089239">if</span>&nbsp;<span class="ident" id="4089242">ip</span><span class="op" id="4089244">.</span><span class="ident" id="4089245">Equal</span><span class="op" id="4089250">(</span><span class="ident" id="4089251">candidate</span><span class="op" id="4089260">)</span>&nbsp;<span class="op" id="4089262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4089268">return</span>&nbsp;<span class="ident" id="4089275">nil</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4089282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4089286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4089290">return</span>&nbsp;<span class="ident" id="4089297">HostnameError</span><span class="op" id="4089310">{</span><span class="ident" id="4089311">c</span><span class="op" id="4089312">,</span>&nbsp;<span class="ident" id="4089314">candidateIP</span><span class="op" id="4089325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4089328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4089332">lowered</span>&nbsp;<span class="op" id="4089340">:=</span>&nbsp;<span class="ident" id="4089343">toLowerCaseASCII</span><span class="op" id="4089359">(</span><span class="ident" id="4089360">h</span><span class="op" id="4089361">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4089365">if</span>&nbsp;<span class="builtinfunc" id="4089368">len</span><span class="op" id="4089371">(</span><span class="ident" id="4089372">c</span><span class="op" id="4089373">.</span><span class="ident" id="4089374">DNSNames</span><span class="op" id="4089382">)</span>&nbsp;<span class="op" id="4089384">&gt;</span>&nbsp;<span class="num" id="4089386">0</span>&nbsp;<span class="op" id="4089388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4089392">for</span>&nbsp;<span class="ident" id="4089396">_</span><span class="op" id="4089397">,</span>&nbsp;<span class="ident" id="4089399">match</span>&nbsp;<span class="op" id="4089405">:=</span>&nbsp;<span class="keyword" id="4089408">range</span>&nbsp;<span class="ident" id="4089414">c</span><span class="op" id="4089415">.</span><span class="ident" id="4089416">DNSNames</span>&nbsp;<span class="op" id="4089425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4089430">if</span>&nbsp;<span class="ident" id="4089433">matchHostnames</span><span class="op" id="4089447">(</span><span class="ident" id="4089448">toLowerCaseASCII</span><span class="op" id="4089464">(</span><span class="ident" id="4089465">match</span><span class="op" id="4089470">)</span><span class="op" id="4089471">,</span>&nbsp;<span class="ident" id="4089473">lowered</span><span class="op" id="4089480">)</span>&nbsp;<span class="op" id="4089482">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4089488">return</span>&nbsp;<span class="ident" id="4089495">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4089502">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4089506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4089510">//&nbsp;If&nbsp;Subject&nbsp;Alt&nbsp;Name&nbsp;is&nbsp;given,&nbsp;we&nbsp;ignore&nbsp;the&nbsp;common&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4089571">}</span>&nbsp;<span class="keyword" id="4089573">else</span>&nbsp;<span class="keyword" id="4089578">if</span>&nbsp;<span class="ident" id="4089581">matchHostnames</span><span class="op" id="4089595">(</span><span class="ident" id="4089596">toLowerCaseASCII</span><span class="op" id="4089612">(</span><span class="ident" id="4089613">c</span><span class="op" id="4089614">.</span><span class="ident" id="4089615">Subject</span><span class="op" id="4089622">.</span><span class="ident" id="4089623">CommonName</span><span class="op" id="4089633">)</span><span class="op" id="4089634">,</span>&nbsp;<span class="ident" id="4089636">lowered</span><span class="op" id="4089643">)</span>&nbsp;<span class="op" id="4089645">{</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4089649">return</span>&nbsp;<span class="ident" id="4089656">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4089661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4089665">return</span>&nbsp;<span class="ident" id="4089672">HostnameError</span><span class="op" id="4089685">{</span><span class="ident" id="4089686">c</span><span class="op" id="4089687">,</span>&nbsp;<span class="ident" id="4089689">h</span><span class="op" id="4089690">}</span><br>
<span class="lineno"></span><span class="op" id="4089692">}</span><br>
<span class="lineno">415</span><br>
<span class="lineno"></span><span class="keyword" id="4089695">func</span>&nbsp;<span class="ident" id="4089700">checkChainForKeyUsage</span><span class="op" id="4089721">(</span><span class="ident" id="4089722">chain</span>&nbsp;<span class="op" id="4089728">[</span><span class="op" id="4089729">]</span><span class="op" id="4089730">*</span><span class="ident" id="4089731">Certificate</span><span class="op" id="4089742">,</span>&nbsp;<span class="ident" id="4089744">keyUsages</span>&nbsp;<span class="op" id="4089754">[</span><span class="op" id="4089755">]</span><span class="ident" id="4089756">ExtKeyUsage</span><span class="op" id="4089767">)</span>&nbsp;<span class="builtintype" id="4089769">bool</span>&nbsp;<span class="op" id="4089774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4089777">usages</span>&nbsp;<span class="op" id="4089784">:=</span>&nbsp;<span class="builtinfunc" id="4089787">make</span><span class="op" id="4089791">(</span><span class="op" id="4089792">[</span><span class="op" id="4089793">]</span><span class="ident" id="4089794">ExtKeyUsage</span><span class="op" id="4089805">,</span>&nbsp;<span class="builtinfunc" id="4089807">len</span><span class="op" id="4089810">(</span><span class="ident" id="4089811">keyUsages</span><span class="op" id="4089820">)</span><span class="op" id="4089821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4089824">copy</span><span class="op" id="4089828">(</span><span class="ident" id="4089829">usages</span><span class="op" id="4089835">,</span>&nbsp;<span class="ident" id="4089837">keyUsages</span><span class="op" id="4089846">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4089850">if</span>&nbsp;<span class="builtinfunc" id="4089853">len</span><span class="op" id="4089856">(</span><span class="ident" id="4089857">chain</span><span class="op" id="4089862">)</span>&nbsp;<span class="op" id="4089864">==</span>&nbsp;<span class="num" id="4089867">0</span>&nbsp;<span class="op" id="4089869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4089873">return</span>&nbsp;<span class="ident" id="4089880">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4089887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4089891">usagesRemaining</span>&nbsp;<span class="op" id="4089907">:=</span>&nbsp;<span class="builtinfunc" id="4089910">len</span><span class="op" id="4089913">(</span><span class="ident" id="4089914">usages</span><span class="op" id="4089920">)</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4089924">//&nbsp;We&nbsp;walk&nbsp;down&nbsp;the&nbsp;list&nbsp;and&nbsp;cross&nbsp;out&nbsp;any&nbsp;usages&nbsp;that&nbsp;aren&#39;t&nbsp;supported</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4089997">//&nbsp;by&nbsp;each&nbsp;certificate.&nbsp;If&nbsp;we&nbsp;cross&nbsp;out&nbsp;all&nbsp;the&nbsp;usages,&nbsp;then&nbsp;the&nbsp;chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4090069">//&nbsp;is&nbsp;unacceptable.</span><br>
<span class="lineno"></span><br>
<span class="lineno">430</span><span class="ident" id="4090090">NextCert</span><span class="op" id="4090098">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4090101">for</span>&nbsp;<span class="ident" id="4090105">i</span>&nbsp;<span class="op" id="4090107">:=</span>&nbsp;<span class="builtinfunc" id="4090110">len</span><span class="op" id="4090113">(</span><span class="ident" id="4090114">chain</span><span class="op" id="4090119">)</span>&nbsp;<span class="op" id="4090121">-</span>&nbsp;<span class="num" id="4090123">1</span><span class="op" id="4090124">;</span>&nbsp;<span class="ident" id="4090126">i</span>&nbsp;<span class="op" id="4090128">&gt;=</span>&nbsp;<span class="num" id="4090131">0</span><span class="op" id="4090132">;</span>&nbsp;<span class="ident" id="4090134">i</span><span class="op" id="4090135">--</span>&nbsp;<span class="op" id="4090138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4090142">cert</span>&nbsp;<span class="op" id="4090147">:=</span>&nbsp;<span class="ident" id="4090150">chain</span><span class="op" id="4090155">[</span><span class="ident" id="4090156">i</span><span class="op" id="4090157">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4090161">if</span>&nbsp;<span class="builtinfunc" id="4090164">len</span><span class="op" id="4090167">(</span><span class="ident" id="4090168">cert</span><span class="op" id="4090172">.</span><span class="ident" id="4090173">ExtKeyUsage</span><span class="op" id="4090184">)</span>&nbsp;<span class="op" id="4090186">==</span>&nbsp;<span class="num" id="4090189">0</span>&nbsp;<span class="op" id="4090191">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4090194">len</span><span class="op" id="4090197">(</span><span class="ident" id="4090198">cert</span><span class="op" id="4090202">.</span><span class="ident" id="4090203">UnknownExtKeyUsage</span><span class="op" id="4090221">)</span>&nbsp;<span class="op" id="4090223">==</span>&nbsp;<span class="num" id="4090226">0</span>&nbsp;<span class="op" id="4090228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4090233">//&nbsp;The&nbsp;certificate&nbsp;doesn&#39;t&nbsp;have&nbsp;any&nbsp;extended&nbsp;key&nbsp;usage&nbsp;specified.</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4090302">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4090313">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4090318">for</span>&nbsp;<span class="ident" id="4090322">_</span><span class="op" id="4090323">,</span>&nbsp;<span class="ident" id="4090325">usage</span>&nbsp;<span class="op" id="4090331">:=</span>&nbsp;<span class="keyword" id="4090334">range</span>&nbsp;<span class="ident" id="4090340">cert</span><span class="op" id="4090344">.</span><span class="ident" id="4090345">ExtKeyUsage</span>&nbsp;<span class="op" id="4090357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4090362">if</span>&nbsp;<span class="ident" id="4090365">usage</span>&nbsp;<span class="op" id="4090371">==</span>&nbsp;<span class="ident" id="4090374">ExtKeyUsageAny</span>&nbsp;<span class="op" id="4090389">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4090395">//&nbsp;The&nbsp;certificate&nbsp;is&nbsp;explicitly&nbsp;good&nbsp;for&nbsp;any&nbsp;usage.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4090452">continue</span>&nbsp;<span class="ident" id="4090461">NextCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4090473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4090477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4090482">const</span>&nbsp;<span class="ident" id="4090488">invalidUsage</span>&nbsp;<span class="ident" id="4090501">ExtKeyUsage</span>&nbsp;<span class="op" id="4090513">=</span>&nbsp;<span class="op" id="4090515">-</span><span class="num" id="4090516">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4090520">NextRequestedUsage</span><span class="op" id="4090538">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4090542">for</span>&nbsp;<span class="ident" id="4090546">i</span><span class="op" id="4090547">,</span>&nbsp;<span class="ident" id="4090549">requestedUsage</span>&nbsp;<span class="op" id="4090564">:=</span>&nbsp;<span class="keyword" id="4090567">range</span>&nbsp;<span class="ident" id="4090573">usages</span>&nbsp;<span class="op" id="4090580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4090585">if</span>&nbsp;<span class="ident" id="4090588">requestedUsage</span>&nbsp;<span class="op" id="4090603">==</span>&nbsp;<span class="ident" id="4090606">invalidUsage</span>&nbsp;<span class="op" id="4090619">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4090625">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4090637">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4090643">for</span>&nbsp;<span class="ident" id="4090647">_</span><span class="op" id="4090648">,</span>&nbsp;<span class="ident" id="4090650">usage</span>&nbsp;<span class="op" id="4090656">:=</span>&nbsp;<span class="keyword" id="4090659">range</span>&nbsp;<span class="ident" id="4090665">cert</span><span class="op" id="4090669">.</span><span class="ident" id="4090670">ExtKeyUsage</span>&nbsp;<span class="op" id="4090682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4090688">if</span>&nbsp;<span class="ident" id="4090691">requestedUsage</span>&nbsp;<span class="op" id="4090706">==</span>&nbsp;<span class="ident" id="4090709">usage</span>&nbsp;<span class="op" id="4090715">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4090722">continue</span>&nbsp;<span class="ident" id="4090731">NextRequestedUsage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4090754">}</span>&nbsp;<span class="keyword" id="4090756">else</span>&nbsp;<span class="keyword" id="4090761">if</span>&nbsp;<span class="ident" id="4090764">requestedUsage</span>&nbsp;<span class="op" id="4090779">==</span>&nbsp;<span class="ident" id="4090782">ExtKeyUsageServerAuth</span>&nbsp;<span class="op" id="4090804">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4090812">(</span><span class="ident" id="4090813">usage</span>&nbsp;<span class="op" id="4090819">==</span>&nbsp;<span class="ident" id="4090822">ExtKeyUsageNetscapeServerGatedCrypto</span>&nbsp;<span class="op" id="4090859">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4090868">usage</span>&nbsp;<span class="op" id="4090874">==</span>&nbsp;<span class="ident" id="4090877">ExtKeyUsageMicrosoftServerGatedCrypto</span><span class="op" id="4090914">)</span>&nbsp;<span class="op" id="4090916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4090923">//&nbsp;In&nbsp;order&nbsp;to&nbsp;support&nbsp;COMODO</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4090958">//&nbsp;certificate&nbsp;chains,&nbsp;we&nbsp;have&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4090997">//&nbsp;accept&nbsp;Netscape&nbsp;or&nbsp;Microsoft&nbsp;SGC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4091038">//&nbsp;usages&nbsp;as&nbsp;equal&nbsp;to&nbsp;ServerAuth.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4091077">continue</span>&nbsp;<span class="ident" id="4091086">NextRequestedUsage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4091109">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4091114">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4091120">usages</span><span class="op" id="4091126">[</span><span class="ident" id="4091127">i</span><span class="op" id="4091128">]</span>&nbsp;<span class="op" id="4091130">=</span>&nbsp;<span class="ident" id="4091132">invalidUsage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4091148">usagesRemaining</span><span class="op" id="4091163">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4091169">if</span>&nbsp;<span class="ident" id="4091172">usagesRemaining</span>&nbsp;<span class="op" id="4091188">==</span>&nbsp;<span class="num" id="4091191">0</span>&nbsp;<span class="op" id="4091193">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4091199">return</span>&nbsp;<span class="ident" id="4091206">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4091215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4091219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4091222">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4091226">return</span>&nbsp;<span class="ident" id="4091233">true</span><br>
<span class="lineno"></span><span class="op" id="4091238">}</span>
</div>
</body>
</html>
