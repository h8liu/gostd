<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/bzip2</h2>
<ul>
<li><a href="/gostd/compress/bzip2/bit_reader.go.html">bit_reader.go</a></li>
<li><a href="/gostd/compress/bzip2/bzip2.go.html">bzip2.go</a></li>
<li><a href="/gostd/compress/bzip2/bzip2_test.go.html">bzip2_test.go</a></li>
<li><a href="/gostd/compress/bzip2/huffman.go.html">huffman.go</a></li>
<li><a href="/gostd/compress/bzip2/move_to_front.go.html">move_to_front.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5378426">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5378481">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5378535">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5378586">//&nbsp;Package&nbsp;bzip2&nbsp;implements&nbsp;bzip2&nbsp;decompression.</span><br>
<span class="lineno"></span><span class="keyword" id="5378635">package</span>&nbsp;<span class="ident" id="5378643">bzip2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5378650">import</span>&nbsp;<span class="string" id="5378657">&#34;io&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="5378663">//&nbsp;There&#39;s&nbsp;no&nbsp;RFC&nbsp;for&nbsp;bzip2.&nbsp;I&nbsp;used&nbsp;the&nbsp;Wikipedia&nbsp;page&nbsp;for&nbsp;reference&nbsp;and&nbsp;a&nbsp;lot</span><br>
<span class="lineno"></span><span class="comment" id="5378742">//&nbsp;of&nbsp;guessing:&nbsp;http://en.wikipedia.org/wiki/Bzip2</span><br>
<span class="lineno"></span><span class="comment" id="5378793">//&nbsp;The&nbsp;source&nbsp;code&nbsp;to&nbsp;pyflate&nbsp;was&nbsp;useful&nbsp;for&nbsp;debugging:</span><br>
<span class="lineno"></span><span class="comment" id="5378849">//&nbsp;http://www.paul.sladen.org/projects/pyflate</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="5378897">//&nbsp;A&nbsp;StructuralError&nbsp;is&nbsp;returned&nbsp;when&nbsp;the&nbsp;bzip2&nbsp;data&nbsp;is&nbsp;found&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5378965">//&nbsp;syntactically&nbsp;invalid.</span><br>
<span class="lineno"></span><span class="keyword" id="5378991">type</span>&nbsp;<span class="ident" id="5378996">StructuralError</span>&nbsp;<span class="builtintype" id="5379012">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5379020">func</span>&nbsp;<span class="op" id="5379025">(</span><span class="ident" id="5379026">s</span>&nbsp;<span class="ident" id="5379028">StructuralError</span><span class="op" id="5379043">)</span>&nbsp;<span class="ident" id="5379045">Error</span><span class="op" id="5379050">(</span><span class="op" id="5379051">)</span>&nbsp;<span class="builtintype" id="5379053">string</span>&nbsp;<span class="op" id="5379060">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5379063">return</span>&nbsp;<span class="string" id="5379070">&#34;bzip2&nbsp;data&nbsp;invalid:&nbsp;&#34;</span>&nbsp;<span class="op" id="5379093">+</span>&nbsp;<span class="builtintype" id="5379095">string</span><span class="op" id="5379101">(</span><span class="ident" id="5379102">s</span><span class="op" id="5379103">)</span><br>
<span class="lineno"></span><span class="op" id="5379105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5379108">//&nbsp;A&nbsp;reader&nbsp;decompresses&nbsp;bzip2&nbsp;compressed&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5379156">type</span>&nbsp;<span class="ident" id="5379161">reader</span>&nbsp;<span class="keyword" id="5379168">struct</span>&nbsp;<span class="op" id="5379175">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379178">br</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5379191">bitReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379202">fileCRC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5379215">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379223">blockCRC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5379236">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379244">wantBlockCRC</span>&nbsp;<span class="builtintype" id="5379257">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379265">setupDone</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5379278">bool</span>&nbsp;<span class="comment" id="5379283">//&nbsp;true&nbsp;if&nbsp;we&nbsp;have&nbsp;parsed&nbsp;the&nbsp;bzip2&nbsp;header.</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379328">blockSize</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5379341">int</span>&nbsp;&nbsp;<span class="comment" id="5379346">//&nbsp;blockSize&nbsp;in&nbsp;bytes,&nbsp;i.e.&nbsp;900&nbsp;*&nbsp;1024.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379387">eof</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5379400">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379406">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5379419">[</span><span class="op" id="5379420">]</span><span class="builtintype" id="5379421">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5379429">//&nbsp;stores&nbsp;Burrows-Wheeler&nbsp;transformed&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379474">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5379487">[</span><span class="num" id="5379488">256</span><span class="op" id="5379491">]</span><span class="builtintype" id="5379492">uint</span>&nbsp;<span class="comment" id="5379497">//&nbsp;the&nbsp;`C&#39;&nbsp;array&nbsp;for&nbsp;the&nbsp;inverse&nbsp;BWT.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379536">tt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5379549">[</span><span class="op" id="5379550">]</span><span class="builtintype" id="5379551">uint32</span>&nbsp;&nbsp;<span class="comment" id="5379559">//&nbsp;mirrors&nbsp;the&nbsp;`tt&#39;&nbsp;array&nbsp;in&nbsp;the&nbsp;bzip2&nbsp;source&nbsp;and&nbsp;contains&nbsp;the&nbsp;P&nbsp;array&nbsp;in&nbsp;the&nbsp;upper&nbsp;24&nbsp;bits.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379653">tPos</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5379666">uint32</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5379676">//&nbsp;Index&nbsp;of&nbsp;the&nbsp;next&nbsp;output&nbsp;byte&nbsp;in&nbsp;tt.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379718">preRLE</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5379730">[</span><span class="op" id="5379731">]</span><span class="builtintype" id="5379732">uint32</span>&nbsp;<span class="comment" id="5379739">//&nbsp;contains&nbsp;the&nbsp;RLE&nbsp;data&nbsp;still&nbsp;to&nbsp;be&nbsp;processed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379788">preRLEUsed</span>&nbsp;&nbsp;<span class="builtintype" id="5379800">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5379809">//&nbsp;number&nbsp;of&nbsp;entries&nbsp;of&nbsp;preRLE&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379847">lastByte</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5379859">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5379868">//&nbsp;the&nbsp;last&nbsp;byte&nbsp;value&nbsp;seen.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379898">byteRepeats</span>&nbsp;<span class="builtintype" id="5379910">uint</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5379919">//&nbsp;the&nbsp;number&nbsp;of&nbsp;repeats&nbsp;of&nbsp;lastByte&nbsp;seen.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379963">repeats</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5379975">uint</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5379984">//&nbsp;the&nbsp;number&nbsp;of&nbsp;copies&nbsp;of&nbsp;lastByte&nbsp;to&nbsp;output.</span><br>
<span class="lineno"></span><span class="op" id="5380031">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5380034">//&nbsp;NewReader&nbsp;returns&nbsp;an&nbsp;io.Reader&nbsp;which&nbsp;decompresses&nbsp;bzip2&nbsp;data&nbsp;from&nbsp;r.</span><br>
<span class="lineno">45</span><span class="comment" id="5380106">//&nbsp;If&nbsp;r&nbsp;does&nbsp;not&nbsp;also&nbsp;implement&nbsp;io.ByteReader,</span><br>
<span class="lineno"></span><span class="comment" id="5380153">//&nbsp;the&nbsp;decompressor&nbsp;may&nbsp;read&nbsp;more&nbsp;data&nbsp;than&nbsp;necessary&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="5380215">func</span>&nbsp;<span class="ident" id="5380220">NewReader</span><span class="op" id="5380229">(</span><span class="ident" id="5380230">r</span>&nbsp;<span class="ident" id="5380232">io</span><span class="op" id="5380234">.</span><span class="ident" id="5380235">Reader</span><span class="op" id="5380241">)</span>&nbsp;<span class="ident" id="5380243">io</span><span class="op" id="5380245">.</span><span class="ident" id="5380246">Reader</span>&nbsp;<span class="op" id="5380253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380256">bz2</span>&nbsp;<span class="op" id="5380260">:=</span>&nbsp;<span class="builtinfunc" id="5380263">new</span><span class="op" id="5380266">(</span><span class="ident" id="5380267">reader</span><span class="op" id="5380273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380276">bz2</span><span class="op" id="5380279">.</span><span class="ident" id="5380280">br</span>&nbsp;<span class="op" id="5380283">=</span>&nbsp;<span class="ident" id="5380285">newBitReader</span><span class="op" id="5380297">(</span><span class="ident" id="5380298">r</span><span class="op" id="5380299">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5380302">return</span>&nbsp;<span class="ident" id="5380309">bz2</span><br>
<span class="lineno"></span><span class="op" id="5380313">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5380316">const</span>&nbsp;<span class="ident" id="5380322">bzip2FileMagic</span>&nbsp;<span class="op" id="5380337">=</span>&nbsp;<span class="num" id="5380339">0x425a</span>&nbsp;<span class="comment" id="5380346">//&nbsp;&#34;BZ&#34;</span><br>
<span class="lineno"></span><span class="keyword" id="5380354">const</span>&nbsp;<span class="ident" id="5380360">bzip2BlockMagic</span>&nbsp;<span class="op" id="5380376">=</span>&nbsp;<span class="num" id="5380378">0x314159265359</span><br>
<span class="lineno">55</span><span class="keyword" id="5380393">const</span>&nbsp;<span class="ident" id="5380399">bzip2FinalMagic</span>&nbsp;<span class="op" id="5380415">=</span>&nbsp;<span class="num" id="5380417">0x177245385090</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5380433">//&nbsp;setup&nbsp;parses&nbsp;the&nbsp;bzip2&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="5380467">func</span>&nbsp;<span class="op" id="5380472">(</span><span class="ident" id="5380473">bz2</span>&nbsp;<span class="op" id="5380477">*</span><span class="ident" id="5380478">reader</span><span class="op" id="5380484">)</span>&nbsp;<span class="ident" id="5380486">setup</span><span class="op" id="5380491">(</span><span class="ident" id="5380492">needMagic</span>&nbsp;<span class="builtintype" id="5380502">bool</span><span class="op" id="5380506">)</span>&nbsp;<span class="builtintype" id="5380508">error</span>&nbsp;<span class="op" id="5380514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380517">br</span>&nbsp;<span class="op" id="5380520">:=</span>&nbsp;<span class="op" id="5380523">&amp;</span><span class="ident" id="5380524">bz2</span><span class="op" id="5380527">.</span><span class="ident" id="5380528">br</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5380533">if</span>&nbsp;<span class="ident" id="5380536">needMagic</span>&nbsp;<span class="op" id="5380546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380550">magic</span>&nbsp;<span class="op" id="5380556">:=</span>&nbsp;<span class="ident" id="5380559">br</span><span class="op" id="5380561">.</span><span class="ident" id="5380562">ReadBits</span><span class="op" id="5380570">(</span><span class="num" id="5380571">16</span><span class="op" id="5380573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5380577">if</span>&nbsp;<span class="ident" id="5380580">magic</span>&nbsp;<span class="op" id="5380586">!=</span>&nbsp;<span class="ident" id="5380589">bzip2FileMagic</span>&nbsp;<span class="op" id="5380604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5380609">return</span>&nbsp;<span class="ident" id="5380616">StructuralError</span><span class="op" id="5380631">(</span><span class="string" id="5380632">&#34;bad&nbsp;magic&nbsp;value&#34;</span><span class="op" id="5380649">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5380653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5380656">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380660">t</span>&nbsp;<span class="op" id="5380662">:=</span>&nbsp;<span class="ident" id="5380665">br</span><span class="op" id="5380667">.</span><span class="ident" id="5380668">ReadBits</span><span class="op" id="5380676">(</span><span class="num" id="5380677">8</span><span class="op" id="5380678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5380681">if</span>&nbsp;<span class="ident" id="5380684">t</span>&nbsp;<span class="op" id="5380686">!=</span>&nbsp;<span class="string" id="5380689">&#39;h&#39;</span>&nbsp;<span class="op" id="5380693">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5380697">return</span>&nbsp;<span class="ident" id="5380704">StructuralError</span><span class="op" id="5380719">(</span><span class="string" id="5380720">&#34;non-Huffman&nbsp;entropy&nbsp;encoding&#34;</span><span class="op" id="5380750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5380753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380757">level</span>&nbsp;<span class="op" id="5380763">:=</span>&nbsp;<span class="ident" id="5380766">br</span><span class="op" id="5380768">.</span><span class="ident" id="5380769">ReadBits</span><span class="op" id="5380777">(</span><span class="num" id="5380778">8</span><span class="op" id="5380779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5380782">if</span>&nbsp;<span class="ident" id="5380785">level</span>&nbsp;<span class="op" id="5380791">&lt;</span>&nbsp;<span class="string" id="5380793">&#39;1&#39;</span>&nbsp;<span class="op" id="5380797">||</span>&nbsp;<span class="ident" id="5380800">level</span>&nbsp;<span class="op" id="5380806">&gt;</span>&nbsp;<span class="string" id="5380808">&#39;9&#39;</span>&nbsp;<span class="op" id="5380812">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5380816">return</span>&nbsp;<span class="ident" id="5380823">StructuralError</span><span class="op" id="5380838">(</span><span class="string" id="5380839">&#34;invalid&nbsp;compression&nbsp;level&#34;</span><span class="op" id="5380866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5380869">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380873">bz2</span><span class="op" id="5380876">.</span><span class="ident" id="5380877">fileCRC</span>&nbsp;<span class="op" id="5380885">=</span>&nbsp;<span class="num" id="5380887">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380890">bz2</span><span class="op" id="5380893">.</span><span class="ident" id="5380894">blockSize</span>&nbsp;<span class="op" id="5380904">=</span>&nbsp;<span class="num" id="5380906">100</span>&nbsp;<span class="op" id="5380910">*</span>&nbsp;<span class="num" id="5380912">1024</span>&nbsp;<span class="op" id="5380917">*</span>&nbsp;<span class="op" id="5380919">(</span><span class="builtintype" id="5380920">int</span><span class="op" id="5380923">(</span><span class="ident" id="5380924">level</span><span class="op" id="5380929">)</span>&nbsp;<span class="op" id="5380931">-</span>&nbsp;<span class="string" id="5380933">&#39;0&#39;</span><span class="op" id="5380936">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5380939">if</span>&nbsp;<span class="ident" id="5380942">bz2</span><span class="op" id="5380945">.</span><span class="ident" id="5380946">blockSize</span>&nbsp;<span class="op" id="5380956">&gt;</span>&nbsp;<span class="builtinfunc" id="5380958">len</span><span class="op" id="5380961">(</span><span class="ident" id="5380962">bz2</span><span class="op" id="5380965">.</span><span class="ident" id="5380966">tt</span><span class="op" id="5380968">)</span>&nbsp;<span class="op" id="5380970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380974">bz2</span><span class="op" id="5380977">.</span><span class="ident" id="5380978">tt</span>&nbsp;<span class="op" id="5380981">=</span>&nbsp;<span class="builtinfunc" id="5380983">make</span><span class="op" id="5380987">(</span><span class="op" id="5380988">[</span><span class="op" id="5380989">]</span><span class="builtintype" id="5380990">uint32</span><span class="op" id="5380996">,</span>&nbsp;<span class="ident" id="5380998">bz2</span><span class="op" id="5381001">.</span><span class="ident" id="5381002">blockSize</span><span class="op" id="5381011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5381014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5381017">return</span>&nbsp;<span class="ident" id="5381024">nil</span><br>
<span class="lineno"></span><span class="op" id="5381028">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="keyword" id="5381031">func</span>&nbsp;<span class="op" id="5381036">(</span><span class="ident" id="5381037">bz2</span>&nbsp;<span class="op" id="5381041">*</span><span class="ident" id="5381042">reader</span><span class="op" id="5381048">)</span>&nbsp;<span class="ident" id="5381050">Read</span><span class="op" id="5381054">(</span><span class="ident" id="5381055">buf</span>&nbsp;<span class="op" id="5381059">[</span><span class="op" id="5381060">]</span><span class="builtintype" id="5381061">byte</span><span class="op" id="5381065">)</span>&nbsp;<span class="op" id="5381067">(</span><span class="ident" id="5381068">n</span>&nbsp;<span class="builtintype" id="5381070">int</span><span class="op" id="5381073">,</span>&nbsp;<span class="ident" id="5381075">err</span>&nbsp;<span class="builtintype" id="5381079">error</span><span class="op" id="5381084">)</span>&nbsp;<span class="op" id="5381086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5381089">if</span>&nbsp;<span class="ident" id="5381092">bz2</span><span class="op" id="5381095">.</span><span class="ident" id="5381096">eof</span>&nbsp;<span class="op" id="5381100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5381104">return</span>&nbsp;<span class="num" id="5381111">0</span><span class="op" id="5381112">,</span>&nbsp;<span class="ident" id="5381114">io</span><span class="op" id="5381116">.</span><span class="ident" id="5381117">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5381122">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5381126">if</span>&nbsp;<span class="op" id="5381129">!</span><span class="ident" id="5381130">bz2</span><span class="op" id="5381133">.</span><span class="ident" id="5381134">setupDone</span>&nbsp;<span class="op" id="5381144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381148">err</span>&nbsp;<span class="op" id="5381152">=</span>&nbsp;<span class="ident" id="5381154">bz2</span><span class="op" id="5381157">.</span><span class="ident" id="5381158">setup</span><span class="op" id="5381163">(</span><span class="builtintype" id="5381164">true</span><span class="op" id="5381168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381172">brErr</span>&nbsp;<span class="op" id="5381178">:=</span>&nbsp;<span class="ident" id="5381181">bz2</span><span class="op" id="5381184">.</span><span class="ident" id="5381185">br</span><span class="op" id="5381187">.</span><span class="ident" id="5381188">Err</span><span class="op" id="5381191">(</span><span class="op" id="5381192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5381196">if</span>&nbsp;<span class="ident" id="5381199">brErr</span>&nbsp;<span class="op" id="5381205">!=</span>&nbsp;<span class="ident" id="5381208">nil</span>&nbsp;<span class="op" id="5381212">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381217">err</span>&nbsp;<span class="op" id="5381221">=</span>&nbsp;<span class="ident" id="5381223">brErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5381231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5381235">if</span>&nbsp;<span class="ident" id="5381238">err</span>&nbsp;<span class="op" id="5381242">!=</span>&nbsp;<span class="ident" id="5381245">nil</span>&nbsp;<span class="op" id="5381249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5381254">return</span>&nbsp;<span class="num" id="5381261">0</span><span class="op" id="5381262">,</span>&nbsp;<span class="ident" id="5381264">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5381270">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381274">bz2</span><span class="op" id="5381277">.</span><span class="ident" id="5381278">setupDone</span>&nbsp;<span class="op" id="5381288">=</span>&nbsp;<span class="builtintype" id="5381290">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5381296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381300">n</span><span class="op" id="5381301">,</span>&nbsp;<span class="ident" id="5381303">err</span>&nbsp;<span class="op" id="5381307">=</span>&nbsp;<span class="ident" id="5381309">bz2</span><span class="op" id="5381312">.</span><span class="ident" id="5381313">read</span><span class="op" id="5381317">(</span><span class="ident" id="5381318">buf</span><span class="op" id="5381321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381324">brErr</span>&nbsp;<span class="op" id="5381330">:=</span>&nbsp;<span class="ident" id="5381333">bz2</span><span class="op" id="5381336">.</span><span class="ident" id="5381337">br</span><span class="op" id="5381339">.</span><span class="ident" id="5381340">Err</span><span class="op" id="5381343">(</span><span class="op" id="5381344">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5381347">if</span>&nbsp;<span class="ident" id="5381350">brErr</span>&nbsp;<span class="op" id="5381356">!=</span>&nbsp;<span class="ident" id="5381359">nil</span>&nbsp;<span class="op" id="5381363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381367">err</span>&nbsp;<span class="op" id="5381371">=</span>&nbsp;<span class="ident" id="5381373">brErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5381380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5381383">return</span><br>
<span class="lineno"></span><span class="op" id="5381390">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="keyword" id="5381393">func</span>&nbsp;<span class="op" id="5381398">(</span><span class="ident" id="5381399">bz2</span>&nbsp;<span class="op" id="5381403">*</span><span class="ident" id="5381404">reader</span><span class="op" id="5381410">)</span>&nbsp;<span class="ident" id="5381412">readFromBlock</span><span class="op" id="5381425">(</span><span class="ident" id="5381426">buf</span>&nbsp;<span class="op" id="5381430">[</span><span class="op" id="5381431">]</span><span class="builtintype" id="5381432">byte</span><span class="op" id="5381436">)</span>&nbsp;<span class="builtintype" id="5381438">int</span>&nbsp;<span class="op" id="5381442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5381445">//&nbsp;bzip2&nbsp;is&nbsp;a&nbsp;block&nbsp;based&nbsp;compressor,&nbsp;except&nbsp;that&nbsp;it&nbsp;has&nbsp;a&nbsp;run-length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5381516">//&nbsp;preprocessing&nbsp;step.&nbsp;The&nbsp;block&nbsp;based&nbsp;nature&nbsp;means&nbsp;that&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5381581">//&nbsp;preallocate&nbsp;fixed-size&nbsp;buffers&nbsp;and&nbsp;reuse&nbsp;them.&nbsp;However,&nbsp;the&nbsp;RLE</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5381649">//&nbsp;preprocessing&nbsp;would&nbsp;require&nbsp;allocating&nbsp;huge&nbsp;buffers&nbsp;to&nbsp;store&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5381718">//&nbsp;maximum&nbsp;expansion.&nbsp;Thus&nbsp;we&nbsp;process&nbsp;blocks&nbsp;all&nbsp;at&nbsp;once,&nbsp;except&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5381788">//&nbsp;the&nbsp;RLE&nbsp;which&nbsp;we&nbsp;decompress&nbsp;as&nbsp;required.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381833">n</span>&nbsp;<span class="op" id="5381835">:=</span>&nbsp;<span class="num" id="5381838">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5381841">for</span>&nbsp;<span class="op" id="5381845">(</span><span class="ident" id="5381846">bz2</span><span class="op" id="5381849">.</span><span class="ident" id="5381850">repeats</span>&nbsp;<span class="op" id="5381858">&gt;</span>&nbsp;<span class="num" id="5381860">0</span>&nbsp;<span class="op" id="5381862">||</span>&nbsp;<span class="ident" id="5381865">bz2</span><span class="op" id="5381868">.</span><span class="ident" id="5381869">preRLEUsed</span>&nbsp;<span class="op" id="5381880">&lt;</span>&nbsp;<span class="builtinfunc" id="5381882">len</span><span class="op" id="5381885">(</span><span class="ident" id="5381886">bz2</span><span class="op" id="5381889">.</span><span class="ident" id="5381890">preRLE</span><span class="op" id="5381896">)</span><span class="op" id="5381897">)</span>&nbsp;<span class="op" id="5381899">&amp;&amp;</span>&nbsp;<span class="ident" id="5381902">n</span>&nbsp;<span class="op" id="5381904">&lt;</span>&nbsp;<span class="builtinfunc" id="5381906">len</span><span class="op" id="5381909">(</span><span class="ident" id="5381910">buf</span><span class="op" id="5381913">)</span>&nbsp;<span class="op" id="5381915">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5381919">//&nbsp;We&nbsp;have&nbsp;RLE&nbsp;data&nbsp;pending.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5381951">//&nbsp;The&nbsp;run-length&nbsp;encoding&nbsp;works&nbsp;like&nbsp;this:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5381997">//&nbsp;Any&nbsp;sequence&nbsp;of&nbsp;four&nbsp;equal&nbsp;bytes&nbsp;is&nbsp;followed&nbsp;by&nbsp;a&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5382059">//&nbsp;byte&nbsp;which&nbsp;contains&nbsp;the&nbsp;number&nbsp;of&nbsp;repeats&nbsp;of&nbsp;that&nbsp;byte&nbsp;to</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5382122">//&nbsp;include.&nbsp;(The&nbsp;number&nbsp;of&nbsp;repeats&nbsp;can&nbsp;be&nbsp;zero.)&nbsp;Because&nbsp;we&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5382188">//&nbsp;decompressing&nbsp;on-demand&nbsp;our&nbsp;state&nbsp;is&nbsp;kept&nbsp;in&nbsp;the&nbsp;reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5382249">//&nbsp;object.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5382263">if</span>&nbsp;<span class="ident" id="5382266">bz2</span><span class="op" id="5382269">.</span><span class="ident" id="5382270">repeats</span>&nbsp;<span class="op" id="5382278">&gt;</span>&nbsp;<span class="num" id="5382280">0</span>&nbsp;<span class="op" id="5382282">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382287">buf</span><span class="op" id="5382290">[</span><span class="ident" id="5382291">n</span><span class="op" id="5382292">]</span>&nbsp;<span class="op" id="5382294">=</span>&nbsp;<span class="builtintype" id="5382296">byte</span><span class="op" id="5382300">(</span><span class="ident" id="5382301">bz2</span><span class="op" id="5382304">.</span><span class="ident" id="5382305">lastByte</span><span class="op" id="5382313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382318">n</span><span class="op" id="5382319">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382325">bz2</span><span class="op" id="5382328">.</span><span class="ident" id="5382329">repeats</span><span class="op" id="5382336">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5382342">if</span>&nbsp;<span class="ident" id="5382345">bz2</span><span class="op" id="5382348">.</span><span class="ident" id="5382349">repeats</span>&nbsp;<span class="op" id="5382357">==</span>&nbsp;<span class="num" id="5382360">0</span>&nbsp;<span class="op" id="5382362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382368">bz2</span><span class="op" id="5382371">.</span><span class="ident" id="5382372">lastByte</span>&nbsp;<span class="op" id="5382381">=</span>&nbsp;<span class="op" id="5382383">-</span><span class="num" id="5382384">1</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5382389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5382394">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5382405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382410">bz2</span><span class="op" id="5382413">.</span><span class="ident" id="5382414">tPos</span>&nbsp;<span class="op" id="5382419">=</span>&nbsp;<span class="ident" id="5382421">bz2</span><span class="op" id="5382424">.</span><span class="ident" id="5382425">preRLE</span><span class="op" id="5382431">[</span><span class="ident" id="5382432">bz2</span><span class="op" id="5382435">.</span><span class="ident" id="5382436">tPos</span><span class="op" id="5382440">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382444">b</span>&nbsp;<span class="op" id="5382446">:=</span>&nbsp;<span class="builtintype" id="5382449">byte</span><span class="op" id="5382453">(</span><span class="ident" id="5382454">bz2</span><span class="op" id="5382457">.</span><span class="ident" id="5382458">tPos</span><span class="op" id="5382462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382466">bz2</span><span class="op" id="5382469">.</span><span class="ident" id="5382470">tPos</span>&nbsp;<span class="op" id="5382475">&gt;&gt;=</span>&nbsp;<span class="num" id="5382479">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382483">bz2</span><span class="op" id="5382486">.</span><span class="ident" id="5382487">preRLEUsed</span><span class="op" id="5382497">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5382503">if</span>&nbsp;<span class="ident" id="5382506">bz2</span><span class="op" id="5382509">.</span><span class="ident" id="5382510">byteRepeats</span>&nbsp;<span class="op" id="5382522">==</span>&nbsp;<span class="num" id="5382525">3</span>&nbsp;<span class="op" id="5382527">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382532">bz2</span><span class="op" id="5382535">.</span><span class="ident" id="5382536">repeats</span>&nbsp;<span class="op" id="5382544">=</span>&nbsp;<span class="builtintype" id="5382546">uint</span><span class="op" id="5382550">(</span><span class="ident" id="5382551">b</span><span class="op" id="5382552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382557">bz2</span><span class="op" id="5382560">.</span><span class="ident" id="5382561">byteRepeats</span>&nbsp;<span class="op" id="5382573">=</span>&nbsp;<span class="num" id="5382575">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5382580">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5382591">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5382596">if</span>&nbsp;<span class="ident" id="5382599">bz2</span><span class="op" id="5382602">.</span><span class="ident" id="5382603">lastByte</span>&nbsp;<span class="op" id="5382612">==</span>&nbsp;<span class="builtintype" id="5382615">int</span><span class="op" id="5382618">(</span><span class="ident" id="5382619">b</span><span class="op" id="5382620">)</span>&nbsp;<span class="op" id="5382622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382627">bz2</span><span class="op" id="5382630">.</span><span class="ident" id="5382631">byteRepeats</span><span class="op" id="5382642">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5382647">}</span>&nbsp;<span class="keyword" id="5382649">else</span>&nbsp;<span class="op" id="5382654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382659">bz2</span><span class="op" id="5382662">.</span><span class="ident" id="5382663">byteRepeats</span>&nbsp;<span class="op" id="5382675">=</span>&nbsp;<span class="num" id="5382677">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5382681">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382685">bz2</span><span class="op" id="5382688">.</span><span class="ident" id="5382689">lastByte</span>&nbsp;<span class="op" id="5382698">=</span>&nbsp;<span class="builtintype" id="5382700">int</span><span class="op" id="5382703">(</span><span class="ident" id="5382704">b</span><span class="op" id="5382705">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382710">buf</span><span class="op" id="5382713">[</span><span class="ident" id="5382714">n</span><span class="op" id="5382715">]</span>&nbsp;<span class="op" id="5382717">=</span>&nbsp;<span class="ident" id="5382719">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382723">n</span><span class="op" id="5382724">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5382728">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5382732">return</span>&nbsp;<span class="ident" id="5382739">n</span><br>
<span class="lineno"></span><span class="op" id="5382741">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5382744">func</span>&nbsp;<span class="op" id="5382749">(</span><span class="ident" id="5382750">bz2</span>&nbsp;<span class="op" id="5382754">*</span><span class="ident" id="5382755">reader</span><span class="op" id="5382761">)</span>&nbsp;<span class="ident" id="5382763">read</span><span class="op" id="5382767">(</span><span class="ident" id="5382768">buf</span>&nbsp;<span class="op" id="5382772">[</span><span class="op" id="5382773">]</span><span class="builtintype" id="5382774">byte</span><span class="op" id="5382778">)</span>&nbsp;<span class="op" id="5382780">(</span><span class="builtintype" id="5382781">int</span><span class="op" id="5382784">,</span>&nbsp;<span class="builtintype" id="5382786">error</span><span class="op" id="5382791">)</span>&nbsp;<span class="op" id="5382793">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5382796">for</span>&nbsp;<span class="op" id="5382800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382804">n</span>&nbsp;<span class="op" id="5382806">:=</span>&nbsp;<span class="ident" id="5382809">bz2</span><span class="op" id="5382812">.</span><span class="ident" id="5382813">readFromBlock</span><span class="op" id="5382826">(</span><span class="ident" id="5382827">buf</span><span class="op" id="5382830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5382834">if</span>&nbsp;<span class="ident" id="5382837">n</span>&nbsp;<span class="op" id="5382839">&gt;</span>&nbsp;<span class="num" id="5382841">0</span>&nbsp;<span class="op" id="5382843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382848">bz2</span><span class="op" id="5382851">.</span><span class="ident" id="5382852">blockCRC</span>&nbsp;<span class="op" id="5382861">=</span>&nbsp;<span class="ident" id="5382863">updateCRC</span><span class="op" id="5382872">(</span><span class="ident" id="5382873">bz2</span><span class="op" id="5382876">.</span><span class="ident" id="5382877">blockCRC</span><span class="op" id="5382885">,</span>&nbsp;<span class="ident" id="5382887">buf</span><span class="op" id="5382890">[</span><span class="op" id="5382891">:</span><span class="ident" id="5382892">n</span><span class="op" id="5382893">]</span><span class="op" id="5382894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5382899">return</span>&nbsp;<span class="ident" id="5382906">n</span><span class="op" id="5382907">,</span>&nbsp;<span class="ident" id="5382909">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5382915">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5382920">//&nbsp;End&nbsp;of&nbsp;block.&nbsp;Check&nbsp;CRC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5382950">if</span>&nbsp;<span class="ident" id="5382953">bz2</span><span class="op" id="5382956">.</span><span class="ident" id="5382957">blockCRC</span>&nbsp;<span class="op" id="5382966">!=</span>&nbsp;<span class="ident" id="5382969">bz2</span><span class="op" id="5382972">.</span><span class="ident" id="5382973">wantBlockCRC</span>&nbsp;<span class="op" id="5382986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382991">bz2</span><span class="op" id="5382994">.</span><span class="ident" id="5382995">br</span><span class="op" id="5382997">.</span><span class="ident" id="5382998">err</span>&nbsp;<span class="op" id="5383002">=</span>&nbsp;<span class="ident" id="5383004">StructuralError</span><span class="op" id="5383019">(</span><span class="string" id="5383020">&#34;block&nbsp;checksum&nbsp;mismatch&#34;</span><span class="op" id="5383045">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383050">return</span>&nbsp;<span class="num" id="5383057">0</span><span class="op" id="5383058">,</span>&nbsp;<span class="ident" id="5383060">bz2</span><span class="op" id="5383063">.</span><span class="ident" id="5383064">br</span><span class="op" id="5383066">.</span><span class="ident" id="5383067">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5383073">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5383078">//&nbsp;Find&nbsp;next&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383100">br</span>&nbsp;<span class="op" id="5383103">:=</span>&nbsp;<span class="op" id="5383106">&amp;</span><span class="ident" id="5383107">bz2</span><span class="op" id="5383110">.</span><span class="ident" id="5383111">br</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383116">switch</span>&nbsp;<span class="ident" id="5383123">br</span><span class="op" id="5383125">.</span><span class="ident" id="5383126">ReadBits64</span><span class="op" id="5383136">(</span><span class="num" id="5383137">48</span><span class="op" id="5383139">)</span>&nbsp;<span class="op" id="5383141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383145">default</span><span class="op" id="5383152">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383157">return</span>&nbsp;<span class="num" id="5383164">0</span><span class="op" id="5383165">,</span>&nbsp;<span class="ident" id="5383167">StructuralError</span><span class="op" id="5383182">(</span><span class="string" id="5383183">&#34;bad&nbsp;magic&nbsp;value&nbsp;found&#34;</span><span class="op" id="5383206">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383211">case</span>&nbsp;<span class="ident" id="5383216">bzip2BlockMagic</span><span class="op" id="5383231">:</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5383236">//&nbsp;Start&nbsp;of&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383258">err</span>&nbsp;<span class="op" id="5383262">:=</span>&nbsp;<span class="ident" id="5383265">bz2</span><span class="op" id="5383268">.</span><span class="ident" id="5383269">readBlock</span><span class="op" id="5383278">(</span><span class="op" id="5383279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383284">if</span>&nbsp;<span class="ident" id="5383287">err</span>&nbsp;<span class="op" id="5383291">!=</span>&nbsp;<span class="ident" id="5383294">nil</span>&nbsp;<span class="op" id="5383298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383304">return</span>&nbsp;<span class="num" id="5383311">0</span><span class="op" id="5383312">,</span>&nbsp;<span class="ident" id="5383314">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5383321">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383326">case</span>&nbsp;<span class="ident" id="5383331">bzip2FinalMagic</span><span class="op" id="5383346">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5383351">//&nbsp;Check&nbsp;end-of-file&nbsp;CRC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383380">wantFileCRC</span>&nbsp;<span class="op" id="5383392">:=</span>&nbsp;<span class="builtintype" id="5383395">uint32</span><span class="op" id="5383401">(</span><span class="ident" id="5383402">br</span><span class="op" id="5383404">.</span><span class="ident" id="5383405">ReadBits64</span><span class="op" id="5383415">(</span><span class="num" id="5383416">32</span><span class="op" id="5383418">)</span><span class="op" id="5383419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383424">if</span>&nbsp;<span class="ident" id="5383427">br</span><span class="op" id="5383429">.</span><span class="ident" id="5383430">err</span>&nbsp;<span class="op" id="5383434">!=</span>&nbsp;<span class="ident" id="5383437">nil</span>&nbsp;<span class="op" id="5383441">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383447">return</span>&nbsp;<span class="num" id="5383454">0</span><span class="op" id="5383455">,</span>&nbsp;<span class="ident" id="5383457">br</span><span class="op" id="5383459">.</span><span class="ident" id="5383460">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5383467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383472">if</span>&nbsp;<span class="ident" id="5383475">bz2</span><span class="op" id="5383478">.</span><span class="ident" id="5383479">fileCRC</span>&nbsp;<span class="op" id="5383487">!=</span>&nbsp;<span class="ident" id="5383490">wantFileCRC</span>&nbsp;<span class="op" id="5383502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383508">br</span><span class="op" id="5383510">.</span><span class="ident" id="5383511">err</span>&nbsp;<span class="op" id="5383515">=</span>&nbsp;<span class="ident" id="5383517">StructuralError</span><span class="op" id="5383532">(</span><span class="string" id="5383533">&#34;file&nbsp;checksum&nbsp;mismatch&#34;</span><span class="op" id="5383557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383563">return</span>&nbsp;<span class="num" id="5383570">0</span><span class="op" id="5383571">,</span>&nbsp;<span class="ident" id="5383573">br</span><span class="op" id="5383575">.</span><span class="ident" id="5383576">err</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5383583">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5383589">//&nbsp;Skip&nbsp;ahead&nbsp;to&nbsp;byte&nbsp;boundary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5383624">//&nbsp;Is&nbsp;there&nbsp;a&nbsp;file&nbsp;concatenated&nbsp;to&nbsp;this&nbsp;one?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5383672">//&nbsp;It&nbsp;would&nbsp;start&nbsp;with&nbsp;BZ.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383702">if</span>&nbsp;<span class="ident" id="5383705">br</span><span class="op" id="5383707">.</span><span class="ident" id="5383708">bits</span><span class="op" id="5383712">%</span><span class="num" id="5383713">8</span>&nbsp;<span class="op" id="5383715">!=</span>&nbsp;<span class="num" id="5383718">0</span>&nbsp;<span class="op" id="5383720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383726">br</span><span class="op" id="5383728">.</span><span class="ident" id="5383729">ReadBits</span><span class="op" id="5383737">(</span><span class="ident" id="5383738">br</span><span class="op" id="5383740">.</span><span class="ident" id="5383741">bits</span>&nbsp;<span class="op" id="5383746">%</span>&nbsp;<span class="num" id="5383748">8</span><span class="op" id="5383749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5383754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383759">b</span><span class="op" id="5383760">,</span>&nbsp;<span class="ident" id="5383762">err</span>&nbsp;<span class="op" id="5383766">:=</span>&nbsp;<span class="ident" id="5383769">br</span><span class="op" id="5383771">.</span><span class="ident" id="5383772">r</span><span class="op" id="5383773">.</span><span class="ident" id="5383774">ReadByte</span><span class="op" id="5383782">(</span><span class="op" id="5383783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383788">if</span>&nbsp;<span class="ident" id="5383791">err</span>&nbsp;<span class="op" id="5383795">==</span>&nbsp;<span class="ident" id="5383798">io</span><span class="op" id="5383800">.</span><span class="ident" id="5383801">EOF</span>&nbsp;<span class="op" id="5383805">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383811">br</span><span class="op" id="5383813">.</span><span class="ident" id="5383814">err</span>&nbsp;<span class="op" id="5383818">=</span>&nbsp;<span class="ident" id="5383820">io</span><span class="op" id="5383822">.</span><span class="ident" id="5383823">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383831">bz2</span><span class="op" id="5383834">.</span><span class="ident" id="5383835">eof</span>&nbsp;<span class="op" id="5383839">=</span>&nbsp;<span class="builtintype" id="5383841">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383850">return</span>&nbsp;<span class="num" id="5383857">0</span><span class="op" id="5383858">,</span>&nbsp;<span class="ident" id="5383860">io</span><span class="op" id="5383862">.</span><span class="ident" id="5383863">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5383870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383875">if</span>&nbsp;<span class="ident" id="5383878">err</span>&nbsp;<span class="op" id="5383882">!=</span>&nbsp;<span class="ident" id="5383885">nil</span>&nbsp;<span class="op" id="5383889">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383895">br</span><span class="op" id="5383897">.</span><span class="ident" id="5383898">err</span>&nbsp;<span class="op" id="5383902">=</span>&nbsp;<span class="ident" id="5383904">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383912">return</span>&nbsp;<span class="num" id="5383919">0</span><span class="op" id="5383920">,</span>&nbsp;<span class="ident" id="5383922">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5383929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383934">z</span><span class="op" id="5383935">,</span>&nbsp;<span class="ident" id="5383937">err</span>&nbsp;<span class="op" id="5383941">:=</span>&nbsp;<span class="ident" id="5383944">br</span><span class="op" id="5383946">.</span><span class="ident" id="5383947">r</span><span class="op" id="5383948">.</span><span class="ident" id="5383949">ReadByte</span><span class="op" id="5383957">(</span><span class="op" id="5383958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383963">if</span>&nbsp;<span class="ident" id="5383966">err</span>&nbsp;<span class="op" id="5383970">!=</span>&nbsp;<span class="ident" id="5383973">nil</span>&nbsp;<span class="op" id="5383977">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383983">if</span>&nbsp;<span class="ident" id="5383986">err</span>&nbsp;<span class="op" id="5383990">==</span>&nbsp;<span class="ident" id="5383993">io</span><span class="op" id="5383995">.</span><span class="ident" id="5383996">EOF</span>&nbsp;<span class="op" id="5384000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384007">err</span>&nbsp;<span class="op" id="5384011">=</span>&nbsp;<span class="ident" id="5384013">io</span><span class="op" id="5384015">.</span><span class="ident" id="5384016">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5384037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384043">br</span><span class="op" id="5384045">.</span><span class="ident" id="5384046">err</span>&nbsp;<span class="op" id="5384050">=</span>&nbsp;<span class="ident" id="5384052">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5384060">return</span>&nbsp;<span class="num" id="5384067">0</span><span class="op" id="5384068">,</span>&nbsp;<span class="ident" id="5384070">err</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5384077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5384082">if</span>&nbsp;<span class="ident" id="5384085">b</span>&nbsp;<span class="op" id="5384087">!=</span>&nbsp;<span class="string" id="5384090">&#39;B&#39;</span>&nbsp;<span class="op" id="5384094">||</span>&nbsp;<span class="ident" id="5384097">z</span>&nbsp;<span class="op" id="5384099">!=</span>&nbsp;<span class="string" id="5384102">&#39;Z&#39;</span>&nbsp;<span class="op" id="5384106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5384112">return</span>&nbsp;<span class="num" id="5384119">0</span><span class="op" id="5384120">,</span>&nbsp;<span class="ident" id="5384122">StructuralError</span><span class="op" id="5384137">(</span><span class="string" id="5384138">&#34;bad&nbsp;magic&nbsp;value&nbsp;in&nbsp;continuation&nbsp;file&#34;</span><span class="op" id="5384176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5384181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5384186">if</span>&nbsp;<span class="ident" id="5384189">err</span>&nbsp;<span class="op" id="5384193">:=</span>&nbsp;<span class="ident" id="5384196">bz2</span><span class="op" id="5384199">.</span><span class="ident" id="5384200">setup</span><span class="op" id="5384205">(</span><span class="builtintype" id="5384206">false</span><span class="op" id="5384211">)</span><span class="op" id="5384212">;</span>&nbsp;<span class="ident" id="5384214">err</span>&nbsp;<span class="op" id="5384218">!=</span>&nbsp;<span class="ident" id="5384221">nil</span>&nbsp;<span class="op" id="5384225">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5384231">return</span>&nbsp;<span class="num" id="5384238">0</span><span class="op" id="5384239">,</span>&nbsp;<span class="ident" id="5384241">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5384248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5384252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5384255">}</span><br>
<span class="lineno"></span><span class="op" id="5384257">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="5384260">//&nbsp;readBlock&nbsp;reads&nbsp;a&nbsp;bzip2&nbsp;block.&nbsp;The&nbsp;magic&nbsp;number&nbsp;should&nbsp;already&nbsp;have&nbsp;been&nbsp;consumed.</span><br>
<span class="lineno"></span><span class="keyword" id="5384346">func</span>&nbsp;<span class="op" id="5384351">(</span><span class="ident" id="5384352">bz2</span>&nbsp;<span class="op" id="5384356">*</span><span class="ident" id="5384357">reader</span><span class="op" id="5384363">)</span>&nbsp;<span class="ident" id="5384365">readBlock</span><span class="op" id="5384374">(</span><span class="op" id="5384375">)</span>&nbsp;<span class="op" id="5384377">(</span><span class="ident" id="5384378">err</span>&nbsp;<span class="builtintype" id="5384382">error</span><span class="op" id="5384387">)</span>&nbsp;<span class="op" id="5384389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384392">br</span>&nbsp;<span class="op" id="5384395">:=</span>&nbsp;<span class="op" id="5384398">&amp;</span><span class="ident" id="5384399">bz2</span><span class="op" id="5384402">.</span><span class="ident" id="5384403">br</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384407">bz2</span><span class="op" id="5384410">.</span><span class="ident" id="5384411">wantBlockCRC</span>&nbsp;<span class="op" id="5384424">=</span>&nbsp;<span class="builtintype" id="5384426">uint32</span><span class="op" id="5384432">(</span><span class="ident" id="5384433">br</span><span class="op" id="5384435">.</span><span class="ident" id="5384436">ReadBits64</span><span class="op" id="5384446">(</span><span class="num" id="5384447">32</span><span class="op" id="5384449">)</span><span class="op" id="5384450">)</span>&nbsp;<span class="comment" id="5384452">//&nbsp;skip&nbsp;checksum.&nbsp;TODO:&nbsp;check&nbsp;it&nbsp;if&nbsp;we&nbsp;can&nbsp;figure&nbsp;out&nbsp;what&nbsp;it&nbsp;is.</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384519">bz2</span><span class="op" id="5384522">.</span><span class="ident" id="5384523">blockCRC</span>&nbsp;<span class="op" id="5384532">=</span>&nbsp;<span class="num" id="5384534">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384537">bz2</span><span class="op" id="5384540">.</span><span class="ident" id="5384541">fileCRC</span>&nbsp;<span class="op" id="5384549">=</span>&nbsp;<span class="op" id="5384551">(</span><span class="ident" id="5384552">bz2</span><span class="op" id="5384555">.</span><span class="ident" id="5384556">fileCRC</span><span class="op" id="5384563">&lt;&lt;</span><span class="num" id="5384565">1</span>&nbsp;<span class="op" id="5384567">|</span>&nbsp;<span class="ident" id="5384569">bz2</span><span class="op" id="5384572">.</span><span class="ident" id="5384573">fileCRC</span><span class="op" id="5384580">&gt;&gt;</span><span class="num" id="5384582">31</span><span class="op" id="5384584">)</span>&nbsp;<span class="op" id="5384586">^</span>&nbsp;<span class="ident" id="5384588">bz2</span><span class="op" id="5384591">.</span><span class="ident" id="5384592">wantBlockCRC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384606">randomized</span>&nbsp;<span class="op" id="5384617">:=</span>&nbsp;<span class="ident" id="5384620">br</span><span class="op" id="5384622">.</span><span class="ident" id="5384623">ReadBits</span><span class="op" id="5384631">(</span><span class="num" id="5384632">1</span><span class="op" id="5384633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5384636">if</span>&nbsp;<span class="ident" id="5384639">randomized</span>&nbsp;<span class="op" id="5384650">!=</span>&nbsp;<span class="num" id="5384653">0</span>&nbsp;<span class="op" id="5384655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5384659">return</span>&nbsp;<span class="ident" id="5384666">StructuralError</span><span class="op" id="5384681">(</span><span class="string" id="5384682">&#34;deprecated&nbsp;randomized&nbsp;files&#34;</span><span class="op" id="5384711">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5384714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384717">origPtr</span>&nbsp;<span class="op" id="5384725">:=</span>&nbsp;<span class="builtintype" id="5384728">uint</span><span class="op" id="5384732">(</span><span class="ident" id="5384733">br</span><span class="op" id="5384735">.</span><span class="ident" id="5384736">ReadBits</span><span class="op" id="5384744">(</span><span class="num" id="5384745">24</span><span class="op" id="5384747">)</span><span class="op" id="5384748">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5384752">//&nbsp;If&nbsp;not&nbsp;every&nbsp;byte&nbsp;value&nbsp;is&nbsp;used&nbsp;in&nbsp;the&nbsp;block&nbsp;(i.e.,&nbsp;it&#39;s&nbsp;text)&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5384824">//&nbsp;the&nbsp;symbol&nbsp;set&nbsp;is&nbsp;reduced.&nbsp;The&nbsp;symbols&nbsp;used&nbsp;are&nbsp;stored&nbsp;as&nbsp;a</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5384888">//&nbsp;two-level,&nbsp;16x16&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384917">symbolRangeUsedBitmap</span>&nbsp;<span class="op" id="5384939">:=</span>&nbsp;<span class="ident" id="5384942">br</span><span class="op" id="5384944">.</span><span class="ident" id="5384945">ReadBits</span><span class="op" id="5384953">(</span><span class="num" id="5384954">16</span><span class="op" id="5384956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384959">symbolPresent</span>&nbsp;<span class="op" id="5384973">:=</span>&nbsp;<span class="builtinfunc" id="5384976">make</span><span class="op" id="5384980">(</span><span class="op" id="5384981">[</span><span class="op" id="5384982">]</span><span class="builtintype" id="5384983">bool</span><span class="op" id="5384987">,</span>&nbsp;<span class="num" id="5384989">256</span><span class="op" id="5384992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384995">numSymbols</span>&nbsp;<span class="op" id="5385006">:=</span>&nbsp;<span class="num" id="5385009">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5385012">for</span>&nbsp;<span class="ident" id="5385016">symRange</span>&nbsp;<span class="op" id="5385025">:=</span>&nbsp;<span class="builtintype" id="5385028">uint</span><span class="op" id="5385032">(</span><span class="num" id="5385033">0</span><span class="op" id="5385034">)</span><span class="op" id="5385035">;</span>&nbsp;<span class="ident" id="5385037">symRange</span>&nbsp;<span class="op" id="5385046">&lt;</span>&nbsp;<span class="num" id="5385048">16</span><span class="op" id="5385050">;</span>&nbsp;<span class="ident" id="5385052">symRange</span><span class="op" id="5385060">++</span>&nbsp;<span class="op" id="5385063">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5385067">if</span>&nbsp;<span class="ident" id="5385070">symbolRangeUsedBitmap</span><span class="op" id="5385091">&amp;</span><span class="op" id="5385092">(</span><span class="num" id="5385093">1</span><span class="op" id="5385094">&lt;&lt;</span><span class="op" id="5385096">(</span><span class="num" id="5385097">15</span><span class="op" id="5385099">-</span><span class="ident" id="5385100">symRange</span><span class="op" id="5385108">)</span><span class="op" id="5385109">)</span>&nbsp;<span class="op" id="5385111">!=</span>&nbsp;<span class="num" id="5385114">0</span>&nbsp;<span class="op" id="5385116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385121">bits</span>&nbsp;<span class="op" id="5385126">:=</span>&nbsp;<span class="ident" id="5385129">br</span><span class="op" id="5385131">.</span><span class="ident" id="5385132">ReadBits</span><span class="op" id="5385140">(</span><span class="num" id="5385141">16</span><span class="op" id="5385143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5385148">for</span>&nbsp;<span class="ident" id="5385152">symbol</span>&nbsp;<span class="op" id="5385159">:=</span>&nbsp;<span class="builtintype" id="5385162">uint</span><span class="op" id="5385166">(</span><span class="num" id="5385167">0</span><span class="op" id="5385168">)</span><span class="op" id="5385169">;</span>&nbsp;<span class="ident" id="5385171">symbol</span>&nbsp;<span class="op" id="5385178">&lt;</span>&nbsp;<span class="num" id="5385180">16</span><span class="op" id="5385182">;</span>&nbsp;<span class="ident" id="5385184">symbol</span><span class="op" id="5385190">++</span>&nbsp;<span class="op" id="5385193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5385199">if</span>&nbsp;<span class="ident" id="5385202">bits</span><span class="op" id="5385206">&amp;</span><span class="op" id="5385207">(</span><span class="num" id="5385208">1</span><span class="op" id="5385209">&lt;&lt;</span><span class="op" id="5385211">(</span><span class="num" id="5385212">15</span><span class="op" id="5385214">-</span><span class="ident" id="5385215">symbol</span><span class="op" id="5385221">)</span><span class="op" id="5385222">)</span>&nbsp;<span class="op" id="5385224">!=</span>&nbsp;<span class="num" id="5385227">0</span>&nbsp;<span class="op" id="5385229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385236">symbolPresent</span><span class="op" id="5385249">[</span><span class="num" id="5385250">16</span><span class="op" id="5385252">*</span><span class="ident" id="5385253">symRange</span><span class="op" id="5385261">+</span><span class="ident" id="5385262">symbol</span><span class="op" id="5385268">]</span>&nbsp;<span class="op" id="5385270">=</span>&nbsp;<span class="builtintype" id="5385272">true</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385282">numSymbols</span><span class="op" id="5385292">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5385299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5385304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5385308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5385311">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5385315">if</span>&nbsp;<span class="ident" id="5385318">numSymbols</span>&nbsp;<span class="op" id="5385329">==</span>&nbsp;<span class="num" id="5385332">0</span>&nbsp;<span class="op" id="5385334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5385338">//&nbsp;There&nbsp;must&nbsp;be&nbsp;an&nbsp;EOF&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5385372">return</span>&nbsp;<span class="ident" id="5385379">StructuralError</span><span class="op" id="5385394">(</span><span class="string" id="5385395">&#34;no&nbsp;symbols&nbsp;in&nbsp;input&#34;</span><span class="op" id="5385416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5385419">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5385423">//&nbsp;A&nbsp;block&nbsp;uses&nbsp;between&nbsp;two&nbsp;and&nbsp;six&nbsp;different&nbsp;Huffman&nbsp;trees.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385485">numHuffmanTrees</span>&nbsp;<span class="op" id="5385501">:=</span>&nbsp;<span class="ident" id="5385504">br</span><span class="op" id="5385506">.</span><span class="ident" id="5385507">ReadBits</span><span class="op" id="5385515">(</span><span class="num" id="5385516">3</span><span class="op" id="5385517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5385520">if</span>&nbsp;<span class="ident" id="5385523">numHuffmanTrees</span>&nbsp;<span class="op" id="5385539">&lt;</span>&nbsp;<span class="num" id="5385541">2</span>&nbsp;<span class="op" id="5385543">||</span>&nbsp;<span class="ident" id="5385546">numHuffmanTrees</span>&nbsp;<span class="op" id="5385562">&gt;</span>&nbsp;<span class="num" id="5385564">6</span>&nbsp;<span class="op" id="5385566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5385570">return</span>&nbsp;<span class="ident" id="5385577">StructuralError</span><span class="op" id="5385592">(</span><span class="string" id="5385593">&#34;invalid&nbsp;number&nbsp;of&nbsp;Huffman&nbsp;trees&#34;</span><span class="op" id="5385626">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5385629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5385633">//&nbsp;The&nbsp;Huffman&nbsp;tree&nbsp;can&nbsp;switch&nbsp;every&nbsp;50&nbsp;symbols&nbsp;so&nbsp;there&#39;s&nbsp;a&nbsp;list&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5385703">//&nbsp;tree&nbsp;indexes&nbsp;telling&nbsp;us&nbsp;which&nbsp;tree&nbsp;to&nbsp;use&nbsp;for&nbsp;each&nbsp;50&nbsp;symbol&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385775">numSelectors</span>&nbsp;<span class="op" id="5385788">:=</span>&nbsp;<span class="ident" id="5385791">br</span><span class="op" id="5385793">.</span><span class="ident" id="5385794">ReadBits</span><span class="op" id="5385802">(</span><span class="num" id="5385803">15</span><span class="op" id="5385805">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385808">treeIndexes</span>&nbsp;<span class="op" id="5385820">:=</span>&nbsp;<span class="builtinfunc" id="5385823">make</span><span class="op" id="5385827">(</span><span class="op" id="5385828">[</span><span class="op" id="5385829">]</span><span class="builtintype" id="5385830">uint8</span><span class="op" id="5385835">,</span>&nbsp;<span class="ident" id="5385837">numSelectors</span><span class="op" id="5385849">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5385853">//&nbsp;The&nbsp;tree&nbsp;indexes&nbsp;are&nbsp;move-to-front&nbsp;transformed&nbsp;and&nbsp;stored&nbsp;as&nbsp;unary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5385924">//&nbsp;numbers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385937">mtfTreeDecoder</span>&nbsp;<span class="op" id="5385952">:=</span>&nbsp;<span class="ident" id="5385955">newMTFDecoderWithRange</span><span class="op" id="5385977">(</span><span class="ident" id="5385978">numHuffmanTrees</span><span class="op" id="5385993">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5385996">for</span>&nbsp;<span class="ident" id="5386000">i</span>&nbsp;<span class="op" id="5386002">:=</span>&nbsp;<span class="keyword" id="5386005">range</span>&nbsp;<span class="ident" id="5386011">treeIndexes</span>&nbsp;<span class="op" id="5386023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386027">c</span>&nbsp;<span class="op" id="5386029">:=</span>&nbsp;<span class="num" id="5386032">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386036">for</span>&nbsp;<span class="op" id="5386040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386045">inc</span>&nbsp;<span class="op" id="5386049">:=</span>&nbsp;<span class="ident" id="5386052">br</span><span class="op" id="5386054">.</span><span class="ident" id="5386055">ReadBits</span><span class="op" id="5386063">(</span><span class="num" id="5386064">1</span><span class="op" id="5386065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386070">if</span>&nbsp;<span class="ident" id="5386073">inc</span>&nbsp;<span class="op" id="5386077">==</span>&nbsp;<span class="num" id="5386080">0</span>&nbsp;<span class="op" id="5386082">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386088">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5386097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386102">c</span><span class="op" id="5386103">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5386108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386112">if</span>&nbsp;<span class="ident" id="5386115">c</span>&nbsp;<span class="op" id="5386117">&gt;=</span>&nbsp;<span class="ident" id="5386120">numHuffmanTrees</span>&nbsp;<span class="op" id="5386136">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386141">return</span>&nbsp;<span class="ident" id="5386148">StructuralError</span><span class="op" id="5386163">(</span><span class="string" id="5386164">&#34;tree&nbsp;index&nbsp;too&nbsp;large&#34;</span><span class="op" id="5386186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5386190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386194">treeIndexes</span><span class="op" id="5386205">[</span><span class="ident" id="5386206">i</span><span class="op" id="5386207">]</span>&nbsp;<span class="op" id="5386209">=</span>&nbsp;<span class="builtintype" id="5386211">uint8</span><span class="op" id="5386216">(</span><span class="ident" id="5386217">mtfTreeDecoder</span><span class="op" id="5386231">.</span><span class="ident" id="5386232">Decode</span><span class="op" id="5386238">(</span><span class="ident" id="5386239">c</span><span class="op" id="5386240">)</span><span class="op" id="5386241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5386244">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5386248">//&nbsp;The&nbsp;list&nbsp;of&nbsp;symbols&nbsp;for&nbsp;the&nbsp;move-to-front&nbsp;transform&nbsp;is&nbsp;taken&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5386318">//&nbsp;the&nbsp;previously&nbsp;decoded&nbsp;symbol&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386360">symbols</span>&nbsp;<span class="op" id="5386368">:=</span>&nbsp;<span class="builtinfunc" id="5386371">make</span><span class="op" id="5386375">(</span><span class="op" id="5386376">[</span><span class="op" id="5386377">]</span><span class="builtintype" id="5386378">byte</span><span class="op" id="5386382">,</span>&nbsp;<span class="ident" id="5386384">numSymbols</span><span class="op" id="5386394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386397">nextSymbol</span>&nbsp;<span class="op" id="5386408">:=</span>&nbsp;<span class="num" id="5386411">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386414">for</span>&nbsp;<span class="ident" id="5386418">i</span>&nbsp;<span class="op" id="5386420">:=</span>&nbsp;<span class="num" id="5386423">0</span><span class="op" id="5386424">;</span>&nbsp;<span class="ident" id="5386426">i</span>&nbsp;<span class="op" id="5386428">&lt;</span>&nbsp;<span class="num" id="5386430">256</span><span class="op" id="5386433">;</span>&nbsp;<span class="ident" id="5386435">i</span><span class="op" id="5386436">++</span>&nbsp;<span class="op" id="5386439">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386443">if</span>&nbsp;<span class="ident" id="5386446">symbolPresent</span><span class="op" id="5386459">[</span><span class="ident" id="5386460">i</span><span class="op" id="5386461">]</span>&nbsp;<span class="op" id="5386463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386468">symbols</span><span class="op" id="5386475">[</span><span class="ident" id="5386476">nextSymbol</span><span class="op" id="5386486">]</span>&nbsp;<span class="op" id="5386488">=</span>&nbsp;<span class="builtintype" id="5386490">byte</span><span class="op" id="5386494">(</span><span class="ident" id="5386495">i</span><span class="op" id="5386496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386501">nextSymbol</span><span class="op" id="5386511">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5386516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5386519">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386522">mtf</span>&nbsp;<span class="op" id="5386526">:=</span>&nbsp;<span class="ident" id="5386529">newMTFDecoder</span><span class="op" id="5386542">(</span><span class="ident" id="5386543">symbols</span><span class="op" id="5386550">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386554">numSymbols</span>&nbsp;<span class="op" id="5386565">+=</span>&nbsp;<span class="num" id="5386568">2</span>&nbsp;<span class="comment" id="5386570">//&nbsp;to&nbsp;account&nbsp;for&nbsp;RUNA&nbsp;and&nbsp;RUNB&nbsp;symbols</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386611">huffmanTrees</span>&nbsp;<span class="op" id="5386624">:=</span>&nbsp;<span class="builtinfunc" id="5386627">make</span><span class="op" id="5386631">(</span><span class="op" id="5386632">[</span><span class="op" id="5386633">]</span><span class="ident" id="5386634">huffmanTree</span><span class="op" id="5386645">,</span>&nbsp;<span class="ident" id="5386647">numHuffmanTrees</span><span class="op" id="5386662">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5386666">//&nbsp;Now&nbsp;we&nbsp;decode&nbsp;the&nbsp;arrays&nbsp;of&nbsp;code-lengths&nbsp;for&nbsp;each&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386726">lengths</span>&nbsp;<span class="op" id="5386734">:=</span>&nbsp;<span class="builtinfunc" id="5386737">make</span><span class="op" id="5386741">(</span><span class="op" id="5386742">[</span><span class="op" id="5386743">]</span><span class="builtintype" id="5386744">uint8</span><span class="op" id="5386749">,</span>&nbsp;<span class="ident" id="5386751">numSymbols</span><span class="op" id="5386761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386764">for</span>&nbsp;<span class="ident" id="5386768">i</span>&nbsp;<span class="op" id="5386770">:=</span>&nbsp;<span class="keyword" id="5386773">range</span>&nbsp;<span class="ident" id="5386779">huffmanTrees</span>&nbsp;<span class="op" id="5386792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5386796">//&nbsp;The&nbsp;code&nbsp;lengths&nbsp;are&nbsp;delta&nbsp;encoded&nbsp;from&nbsp;a&nbsp;5-bit&nbsp;base&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386861">length</span>&nbsp;<span class="op" id="5386868">:=</span>&nbsp;<span class="ident" id="5386871">br</span><span class="op" id="5386873">.</span><span class="ident" id="5386874">ReadBits</span><span class="op" id="5386882">(</span><span class="num" id="5386883">5</span><span class="op" id="5386884">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386888">for</span>&nbsp;<span class="ident" id="5386892">j</span>&nbsp;<span class="op" id="5386894">:=</span>&nbsp;<span class="keyword" id="5386897">range</span>&nbsp;<span class="ident" id="5386903">lengths</span>&nbsp;<span class="op" id="5386911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386916">for</span>&nbsp;<span class="op" id="5386920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386926">if</span>&nbsp;<span class="op" id="5386929">!</span><span class="ident" id="5386930">br</span><span class="op" id="5386932">.</span><span class="ident" id="5386933">ReadBit</span><span class="op" id="5386940">(</span><span class="op" id="5386941">)</span>&nbsp;<span class="op" id="5386943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386950">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5386960">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386966">if</span>&nbsp;<span class="ident" id="5386969">br</span><span class="op" id="5386971">.</span><span class="ident" id="5386972">ReadBit</span><span class="op" id="5386979">(</span><span class="op" id="5386980">)</span>&nbsp;<span class="op" id="5386982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386989">length</span><span class="op" id="5386995">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5387002">}</span>&nbsp;<span class="keyword" id="5387004">else</span>&nbsp;<span class="op" id="5387009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5387016">length</span><span class="op" id="5387022">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5387029">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5387034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5387039">if</span>&nbsp;<span class="ident" id="5387042">length</span>&nbsp;<span class="op" id="5387049">&lt;</span>&nbsp;<span class="num" id="5387051">0</span>&nbsp;<span class="op" id="5387053">||</span>&nbsp;<span class="ident" id="5387056">length</span>&nbsp;<span class="op" id="5387063">&gt;</span>&nbsp;<span class="num" id="5387065">20</span>&nbsp;<span class="op" id="5387068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5387074">return</span>&nbsp;<span class="ident" id="5387081">StructuralError</span><span class="op" id="5387096">(</span><span class="string" id="5387097">&#34;Huffman&nbsp;length&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="5387126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5387131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5387136">lengths</span><span class="op" id="5387143">[</span><span class="ident" id="5387144">j</span><span class="op" id="5387145">]</span>&nbsp;<span class="op" id="5387147">=</span>&nbsp;<span class="builtintype" id="5387149">uint8</span><span class="op" id="5387154">(</span><span class="ident" id="5387155">length</span><span class="op" id="5387161">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5387165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5387169">huffmanTrees</span><span class="op" id="5387181">[</span><span class="ident" id="5387182">i</span><span class="op" id="5387183">]</span><span class="op" id="5387184">,</span>&nbsp;<span class="ident" id="5387186">err</span>&nbsp;<span class="op" id="5387190">=</span>&nbsp;<span class="ident" id="5387192">newHuffmanTree</span><span class="op" id="5387206">(</span><span class="ident" id="5387207">lengths</span><span class="op" id="5387214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5387218">if</span>&nbsp;<span class="ident" id="5387221">err</span>&nbsp;<span class="op" id="5387225">!=</span>&nbsp;<span class="ident" id="5387228">nil</span>&nbsp;<span class="op" id="5387232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5387237">return</span>&nbsp;<span class="ident" id="5387244">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5387250">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5387253">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5387257">selectorIndex</span>&nbsp;<span class="op" id="5387271">:=</span>&nbsp;<span class="num" id="5387274">1</span>&nbsp;<span class="comment" id="5387276">//&nbsp;the&nbsp;next&nbsp;tree&nbsp;index&nbsp;to&nbsp;use</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5387307">if</span>&nbsp;<span class="builtinfunc" id="5387310">len</span><span class="op" id="5387313">(</span><span class="ident" id="5387314">treeIndexes</span><span class="op" id="5387325">)</span>&nbsp;<span class="op" id="5387327">==</span>&nbsp;<span class="num" id="5387330">0</span>&nbsp;<span class="op" id="5387332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5387336">return</span>&nbsp;<span class="ident" id="5387343">StructuralError</span><span class="op" id="5387358">(</span><span class="string" id="5387359">&#34;no&nbsp;tree&nbsp;selectors&nbsp;given&#34;</span><span class="op" id="5387384">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5387387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5387390">if</span>&nbsp;<span class="builtintype" id="5387393">int</span><span class="op" id="5387396">(</span><span class="ident" id="5387397">treeIndexes</span><span class="op" id="5387408">[</span><span class="num" id="5387409">0</span><span class="op" id="5387410">]</span><span class="op" id="5387411">)</span>&nbsp;<span class="op" id="5387413">&gt;=</span>&nbsp;<span class="builtinfunc" id="5387416">len</span><span class="op" id="5387419">(</span><span class="ident" id="5387420">huffmanTrees</span><span class="op" id="5387432">)</span>&nbsp;<span class="op" id="5387434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5387438">return</span>&nbsp;<span class="ident" id="5387445">StructuralError</span><span class="op" id="5387460">(</span><span class="string" id="5387461">&#34;tree&nbsp;selector&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="5387489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5387492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5387495">currentHuffmanTree</span>&nbsp;<span class="op" id="5387514">:=</span>&nbsp;<span class="ident" id="5387517">huffmanTrees</span><span class="op" id="5387529">[</span><span class="ident" id="5387530">treeIndexes</span><span class="op" id="5387541">[</span><span class="num" id="5387542">0</span><span class="op" id="5387543">]</span><span class="op" id="5387544">]</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5387547">bufIndex</span>&nbsp;<span class="op" id="5387556">:=</span>&nbsp;<span class="num" id="5387559">0</span>&nbsp;<span class="comment" id="5387561">//&nbsp;indexes&nbsp;bz2.buf,&nbsp;the&nbsp;output&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5387601">//&nbsp;The&nbsp;output&nbsp;of&nbsp;the&nbsp;move-to-front&nbsp;transform&nbsp;is&nbsp;run-length&nbsp;encoded&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5387673">//&nbsp;we&nbsp;merge&nbsp;the&nbsp;decoding&nbsp;into&nbsp;the&nbsp;Huffman&nbsp;parsing&nbsp;loop.&nbsp;These&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5387740">//&nbsp;variables&nbsp;accumulate&nbsp;the&nbsp;repeat&nbsp;count.&nbsp;See&nbsp;the&nbsp;Wikipedia&nbsp;page&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5387810">//&nbsp;details.</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5387823">repeat</span>&nbsp;<span class="op" id="5387830">:=</span>&nbsp;<span class="num" id="5387833">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5387836">repeat_power</span>&nbsp;<span class="op" id="5387849">:=</span>&nbsp;<span class="num" id="5387852">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5387856">//&nbsp;The&nbsp;`C&#39;&nbsp;array&nbsp;(used&nbsp;by&nbsp;the&nbsp;inverse&nbsp;BWT)&nbsp;needs&nbsp;to&nbsp;be&nbsp;zero&nbsp;initialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5387930">for</span>&nbsp;<span class="ident" id="5387934">i</span>&nbsp;<span class="op" id="5387936">:=</span>&nbsp;<span class="keyword" id="5387939">range</span>&nbsp;<span class="ident" id="5387945">bz2</span><span class="op" id="5387948">.</span><span class="ident" id="5387949">c</span>&nbsp;<span class="op" id="5387951">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5387955">bz2</span><span class="op" id="5387958">.</span><span class="ident" id="5387959">c</span><span class="op" id="5387960">[</span><span class="ident" id="5387961">i</span><span class="op" id="5387962">]</span>&nbsp;<span class="op" id="5387964">=</span>&nbsp;<span class="num" id="5387966">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5387969">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5387973">decoded</span>&nbsp;<span class="op" id="5387981">:=</span>&nbsp;<span class="num" id="5387984">0</span>&nbsp;<span class="comment" id="5387986">//&nbsp;counts&nbsp;the&nbsp;number&nbsp;of&nbsp;symbols&nbsp;decoded&nbsp;by&nbsp;the&nbsp;current&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5388048">for</span>&nbsp;<span class="op" id="5388052">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5388056">if</span>&nbsp;<span class="ident" id="5388059">decoded</span>&nbsp;<span class="op" id="5388067">==</span>&nbsp;<span class="num" id="5388070">50</span>&nbsp;<span class="op" id="5388073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5388078">if</span>&nbsp;<span class="ident" id="5388081">selectorIndex</span>&nbsp;<span class="op" id="5388095">&gt;=</span>&nbsp;<span class="ident" id="5388098">numSelectors</span>&nbsp;<span class="op" id="5388111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5388117">return</span>&nbsp;<span class="ident" id="5388124">StructuralError</span><span class="op" id="5388139">(</span><span class="string" id="5388140">&#34;insufficient&nbsp;selector&nbsp;indices&nbsp;for&nbsp;number&nbsp;of&nbsp;symbols&#34;</span><span class="op" id="5388193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5388198">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5388203">if</span>&nbsp;<span class="builtintype" id="5388206">int</span><span class="op" id="5388209">(</span><span class="ident" id="5388210">treeIndexes</span><span class="op" id="5388221">[</span><span class="ident" id="5388222">selectorIndex</span><span class="op" id="5388235">]</span><span class="op" id="5388236">)</span>&nbsp;<span class="op" id="5388238">&gt;=</span>&nbsp;<span class="builtinfunc" id="5388241">len</span><span class="op" id="5388244">(</span><span class="ident" id="5388245">huffmanTrees</span><span class="op" id="5388257">)</span>&nbsp;<span class="op" id="5388259">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5388265">return</span>&nbsp;<span class="ident" id="5388272">StructuralError</span><span class="op" id="5388287">(</span><span class="string" id="5388288">&#34;tree&nbsp;selector&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="5388316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5388321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388326">currentHuffmanTree</span>&nbsp;<span class="op" id="5388345">=</span>&nbsp;<span class="ident" id="5388347">huffmanTrees</span><span class="op" id="5388359">[</span><span class="ident" id="5388360">treeIndexes</span><span class="op" id="5388371">[</span><span class="ident" id="5388372">selectorIndex</span><span class="op" id="5388385">]</span><span class="op" id="5388386">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388391">selectorIndex</span><span class="op" id="5388404">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388410">decoded</span>&nbsp;<span class="op" id="5388418">=</span>&nbsp;<span class="num" id="5388420">0</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5388424">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388429">v</span>&nbsp;<span class="op" id="5388431">:=</span>&nbsp;<span class="ident" id="5388434">currentHuffmanTree</span><span class="op" id="5388452">.</span><span class="ident" id="5388453">Decode</span><span class="op" id="5388459">(</span><span class="ident" id="5388460">br</span><span class="op" id="5388462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388466">decoded</span><span class="op" id="5388473">++</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5388479">if</span>&nbsp;<span class="ident" id="5388482">v</span>&nbsp;<span class="op" id="5388484">&lt;</span>&nbsp;<span class="num" id="5388486">2</span>&nbsp;<span class="op" id="5388488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5388493">//&nbsp;This&nbsp;is&nbsp;either&nbsp;the&nbsp;RUNA&nbsp;or&nbsp;RUNB&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5388539">if</span>&nbsp;<span class="ident" id="5388542">repeat</span>&nbsp;<span class="op" id="5388549">==</span>&nbsp;<span class="num" id="5388552">0</span>&nbsp;<span class="op" id="5388554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388560">repeat_power</span>&nbsp;<span class="op" id="5388573">=</span>&nbsp;<span class="num" id="5388575">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5388580">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388585">repeat</span>&nbsp;<span class="op" id="5388592">+=</span>&nbsp;<span class="ident" id="5388595">repeat_power</span>&nbsp;<span class="op" id="5388608">&lt;&lt;</span>&nbsp;<span class="ident" id="5388611">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388616">repeat_power</span>&nbsp;<span class="op" id="5388629">&lt;&lt;=</span>&nbsp;<span class="num" id="5388633">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5388639">//&nbsp;This&nbsp;limit&nbsp;of&nbsp;2&nbsp;million&nbsp;comes&nbsp;from&nbsp;the&nbsp;bzip2&nbsp;source</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5388697">//&nbsp;code.&nbsp;It&nbsp;prevents&nbsp;repeat&nbsp;from&nbsp;overflowing.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5388746">if</span>&nbsp;<span class="ident" id="5388749">repeat</span>&nbsp;<span class="op" id="5388756">&gt;</span>&nbsp;<span class="num" id="5388758">2</span><span class="op" id="5388759">*</span><span class="num" id="5388760">1024</span><span class="op" id="5388764">*</span><span class="num" id="5388765">1024</span>&nbsp;<span class="op" id="5388770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5388776">return</span>&nbsp;<span class="ident" id="5388783">StructuralError</span><span class="op" id="5388798">(</span><span class="string" id="5388799">&#34;repeat&nbsp;count&nbsp;too&nbsp;large&#34;</span><span class="op" id="5388823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5388828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5388833">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5388844">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5388849">if</span>&nbsp;<span class="ident" id="5388852">repeat</span>&nbsp;<span class="op" id="5388859">&gt;</span>&nbsp;<span class="num" id="5388861">0</span>&nbsp;<span class="op" id="5388863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5388868">//&nbsp;We&nbsp;have&nbsp;decoded&nbsp;a&nbsp;complete&nbsp;run-length&nbsp;so&nbsp;we&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5388926">//&nbsp;replicate&nbsp;the&nbsp;last&nbsp;output&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5388966">if</span>&nbsp;<span class="ident" id="5388969">repeat</span>&nbsp;<span class="op" id="5388976">&gt;</span>&nbsp;<span class="ident" id="5388978">bz2</span><span class="op" id="5388981">.</span><span class="ident" id="5388982">blockSize</span><span class="op" id="5388991">-</span><span class="ident" id="5388992">bufIndex</span>&nbsp;<span class="op" id="5389001">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5389007">return</span>&nbsp;<span class="ident" id="5389014">StructuralError</span><span class="op" id="5389029">(</span><span class="string" id="5389030">&#34;repeats&nbsp;past&nbsp;end&nbsp;of&nbsp;block&#34;</span><span class="op" id="5389057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5389062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5389067">for</span>&nbsp;<span class="ident" id="5389071">i</span>&nbsp;<span class="op" id="5389073">:=</span>&nbsp;<span class="num" id="5389076">0</span><span class="op" id="5389077">;</span>&nbsp;<span class="ident" id="5389079">i</span>&nbsp;<span class="op" id="5389081">&lt;</span>&nbsp;<span class="ident" id="5389083">repeat</span><span class="op" id="5389089">;</span>&nbsp;<span class="ident" id="5389091">i</span><span class="op" id="5389092">++</span>&nbsp;<span class="op" id="5389095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5389101">b</span>&nbsp;<span class="op" id="5389103">:=</span>&nbsp;<span class="builtintype" id="5389106">byte</span><span class="op" id="5389110">(</span><span class="ident" id="5389111">mtf</span><span class="op" id="5389114">.</span><span class="ident" id="5389115">First</span><span class="op" id="5389120">(</span><span class="op" id="5389121">)</span><span class="op" id="5389122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5389128">bz2</span><span class="op" id="5389131">.</span><span class="ident" id="5389132">tt</span><span class="op" id="5389134">[</span><span class="ident" id="5389135">bufIndex</span><span class="op" id="5389143">]</span>&nbsp;<span class="op" id="5389145">=</span>&nbsp;<span class="builtintype" id="5389147">uint32</span><span class="op" id="5389153">(</span><span class="ident" id="5389154">b</span><span class="op" id="5389155">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5389161">bz2</span><span class="op" id="5389164">.</span><span class="ident" id="5389165">c</span><span class="op" id="5389166">[</span><span class="ident" id="5389167">b</span><span class="op" id="5389168">]</span><span class="op" id="5389169">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5389176">bufIndex</span><span class="op" id="5389184">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5389190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5389195">repeat</span>&nbsp;<span class="op" id="5389202">=</span>&nbsp;<span class="num" id="5389204">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5389208">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5389213">if</span>&nbsp;<span class="builtintype" id="5389216">int</span><span class="op" id="5389219">(</span><span class="ident" id="5389220">v</span><span class="op" id="5389221">)</span>&nbsp;<span class="op" id="5389223">==</span>&nbsp;<span class="ident" id="5389226">numSymbols</span><span class="op" id="5389236">-</span><span class="num" id="5389237">1</span>&nbsp;<span class="op" id="5389239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5389244">//&nbsp;This&nbsp;is&nbsp;the&nbsp;EOF&nbsp;symbol.&nbsp;Because&nbsp;it&#39;s&nbsp;always&nbsp;at&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5389301">//&nbsp;end&nbsp;of&nbsp;the&nbsp;move-to-front&nbsp;list,&nbsp;and&nbsp;never&nbsp;gets&nbsp;moved</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5389359">//&nbsp;to&nbsp;the&nbsp;front,&nbsp;it&nbsp;has&nbsp;this&nbsp;unique&nbsp;value.</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5389405">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5389413">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5389418">//&nbsp;Since&nbsp;two&nbsp;metasymbols&nbsp;(RUNA&nbsp;and&nbsp;RUNB)&nbsp;have&nbsp;values&nbsp;0&nbsp;and&nbsp;1,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5389482">//&nbsp;one&nbsp;would&nbsp;expect&nbsp;|v-2|&nbsp;to&nbsp;be&nbsp;passed&nbsp;to&nbsp;the&nbsp;MTF&nbsp;decoder.</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5389543">//&nbsp;However,&nbsp;the&nbsp;front&nbsp;of&nbsp;the&nbsp;MTF&nbsp;list&nbsp;is&nbsp;never&nbsp;referenced&nbsp;as&nbsp;0,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5389609">//&nbsp;it&#39;s&nbsp;always&nbsp;referenced&nbsp;with&nbsp;a&nbsp;run-length&nbsp;of&nbsp;1.&nbsp;Thus&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5389668">//&nbsp;doesn&#39;t&nbsp;need&nbsp;to&nbsp;be&nbsp;encoded&nbsp;and&nbsp;we&nbsp;have&nbsp;|v-1|&nbsp;in&nbsp;the&nbsp;next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5389730">//&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5389741">b</span>&nbsp;<span class="op" id="5389743">:=</span>&nbsp;<span class="builtintype" id="5389746">byte</span><span class="op" id="5389750">(</span><span class="ident" id="5389751">mtf</span><span class="op" id="5389754">.</span><span class="ident" id="5389755">Decode</span><span class="op" id="5389761">(</span><span class="builtintype" id="5389762">int</span><span class="op" id="5389765">(</span><span class="ident" id="5389766">v</span>&nbsp;<span class="op" id="5389768">-</span>&nbsp;<span class="num" id="5389770">1</span><span class="op" id="5389771">)</span><span class="op" id="5389772">)</span><span class="op" id="5389773">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5389777">if</span>&nbsp;<span class="ident" id="5389780">bufIndex</span>&nbsp;<span class="op" id="5389789">&gt;=</span>&nbsp;<span class="ident" id="5389792">bz2</span><span class="op" id="5389795">.</span><span class="ident" id="5389796">blockSize</span>&nbsp;<span class="op" id="5389806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5389811">return</span>&nbsp;<span class="ident" id="5389818">StructuralError</span><span class="op" id="5389833">(</span><span class="string" id="5389834">&#34;data&nbsp;exceeds&nbsp;block&nbsp;size&#34;</span><span class="op" id="5389859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5389863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5389867">bz2</span><span class="op" id="5389870">.</span><span class="ident" id="5389871">tt</span><span class="op" id="5389873">[</span><span class="ident" id="5389874">bufIndex</span><span class="op" id="5389882">]</span>&nbsp;<span class="op" id="5389884">=</span>&nbsp;<span class="builtintype" id="5389886">uint32</span><span class="op" id="5389892">(</span><span class="ident" id="5389893">b</span><span class="op" id="5389894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5389898">bz2</span><span class="op" id="5389901">.</span><span class="ident" id="5389902">c</span><span class="op" id="5389903">[</span><span class="ident" id="5389904">b</span><span class="op" id="5389905">]</span><span class="op" id="5389906">++</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5389911">bufIndex</span><span class="op" id="5389919">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5389923">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5389927">if</span>&nbsp;<span class="ident" id="5389930">origPtr</span>&nbsp;<span class="op" id="5389938">&gt;=</span>&nbsp;<span class="builtintype" id="5389941">uint</span><span class="op" id="5389945">(</span><span class="ident" id="5389946">bufIndex</span><span class="op" id="5389954">)</span>&nbsp;<span class="op" id="5389956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5389960">return</span>&nbsp;<span class="ident" id="5389967">StructuralError</span><span class="op" id="5389982">(</span><span class="string" id="5389983">&#34;origPtr&nbsp;out&nbsp;of&nbsp;bounds&#34;</span><span class="op" id="5390006">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5390009">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5390013">//&nbsp;We&nbsp;have&nbsp;completed&nbsp;the&nbsp;entropy&nbsp;decoding.&nbsp;Now&nbsp;we&nbsp;can&nbsp;perform&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5390080">//&nbsp;inverse&nbsp;BWT&nbsp;and&nbsp;setup&nbsp;the&nbsp;RLE&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5390122">bz2</span><span class="op" id="5390125">.</span><span class="ident" id="5390126">preRLE</span>&nbsp;<span class="op" id="5390133">=</span>&nbsp;<span class="ident" id="5390135">bz2</span><span class="op" id="5390138">.</span><span class="ident" id="5390139">tt</span><span class="op" id="5390141">[</span><span class="op" id="5390142">:</span><span class="ident" id="5390143">bufIndex</span><span class="op" id="5390151">]</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5390154">bz2</span><span class="op" id="5390157">.</span><span class="ident" id="5390158">preRLEUsed</span>&nbsp;<span class="op" id="5390169">=</span>&nbsp;<span class="num" id="5390171">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5390174">bz2</span><span class="op" id="5390177">.</span><span class="ident" id="5390178">tPos</span>&nbsp;<span class="op" id="5390183">=</span>&nbsp;<span class="ident" id="5390185">inverseBWT</span><span class="op" id="5390195">(</span><span class="ident" id="5390196">bz2</span><span class="op" id="5390199">.</span><span class="ident" id="5390200">preRLE</span><span class="op" id="5390206">,</span>&nbsp;<span class="ident" id="5390208">origPtr</span><span class="op" id="5390215">,</span>&nbsp;<span class="ident" id="5390217">bz2</span><span class="op" id="5390220">.</span><span class="ident" id="5390221">c</span><span class="op" id="5390222">[</span><span class="op" id="5390223">:</span><span class="op" id="5390224">]</span><span class="op" id="5390225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5390228">bz2</span><span class="op" id="5390231">.</span><span class="ident" id="5390232">lastByte</span>&nbsp;<span class="op" id="5390241">=</span>&nbsp;<span class="op" id="5390243">-</span><span class="num" id="5390244">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5390247">bz2</span><span class="op" id="5390250">.</span><span class="ident" id="5390251">byteRepeats</span>&nbsp;<span class="op" id="5390263">=</span>&nbsp;<span class="num" id="5390265">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5390268">bz2</span><span class="op" id="5390271">.</span><span class="ident" id="5390272">repeats</span>&nbsp;<span class="op" id="5390280">=</span>&nbsp;<span class="num" id="5390282">0</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5390286">return</span>&nbsp;<span class="ident" id="5390293">nil</span><br>
<span class="lineno"></span><span class="op" id="5390297">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5390300">//&nbsp;inverseBWT&nbsp;implements&nbsp;the&nbsp;inverse&nbsp;Burrows-Wheeler&nbsp;transform&nbsp;as&nbsp;described&nbsp;in</span><br>
<span class="lineno">450</span><span class="comment" id="5390379">//&nbsp;http://www.hpl.hp.com/techreports/Compaq-DEC/SRC-RR-124.pdf,&nbsp;section&nbsp;4.2.</span><br>
<span class="lineno"></span><span class="comment" id="5390456">//&nbsp;In&nbsp;that&nbsp;document,&nbsp;origPtr&nbsp;is&nbsp;called&nbsp;`I&#39;&nbsp;and&nbsp;c&nbsp;is&nbsp;the&nbsp;`C&#39;&nbsp;array&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5390532">//&nbsp;first&nbsp;pass&nbsp;over&nbsp;the&nbsp;data.&nbsp;It&#39;s&nbsp;an&nbsp;argument&nbsp;here&nbsp;because&nbsp;we&nbsp;merge&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="5390610">//&nbsp;pass&nbsp;with&nbsp;the&nbsp;Huffman&nbsp;decoding.</span><br>
<span class="lineno"></span><span class="comment" id="5390645">//</span><br>
<span class="lineno">455</span><span class="comment" id="5390648">//&nbsp;This&nbsp;also&nbsp;implements&nbsp;the&nbsp;`single&nbsp;array&#39;&nbsp;method&nbsp;from&nbsp;the&nbsp;bzip2&nbsp;source&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="5390725">//&nbsp;which&nbsp;leaves&nbsp;the&nbsp;output,&nbsp;still&nbsp;shuffled,&nbsp;in&nbsp;the&nbsp;bottom&nbsp;8&nbsp;bits&nbsp;of&nbsp;tt&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5390805">//&nbsp;index&nbsp;of&nbsp;the&nbsp;next&nbsp;byte&nbsp;in&nbsp;the&nbsp;top&nbsp;24-bits.&nbsp;The&nbsp;index&nbsp;of&nbsp;the&nbsp;first&nbsp;byte&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="5390882">//&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="5390895">func</span>&nbsp;<span class="ident" id="5390900">inverseBWT</span><span class="op" id="5390910">(</span><span class="ident" id="5390911">tt</span>&nbsp;<span class="op" id="5390914">[</span><span class="op" id="5390915">]</span><span class="builtintype" id="5390916">uint32</span><span class="op" id="5390922">,</span>&nbsp;<span class="ident" id="5390924">origPtr</span>&nbsp;<span class="builtintype" id="5390932">uint</span><span class="op" id="5390936">,</span>&nbsp;<span class="ident" id="5390938">c</span>&nbsp;<span class="op" id="5390940">[</span><span class="op" id="5390941">]</span><span class="builtintype" id="5390942">uint</span><span class="op" id="5390946">)</span>&nbsp;<span class="builtintype" id="5390948">uint32</span>&nbsp;<span class="op" id="5390955">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5390958">sum</span>&nbsp;<span class="op" id="5390962">:=</span>&nbsp;<span class="builtintype" id="5390965">uint</span><span class="op" id="5390969">(</span><span class="num" id="5390970">0</span><span class="op" id="5390971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5390974">for</span>&nbsp;<span class="ident" id="5390978">i</span>&nbsp;<span class="op" id="5390980">:=</span>&nbsp;<span class="num" id="5390983">0</span><span class="op" id="5390984">;</span>&nbsp;<span class="ident" id="5390986">i</span>&nbsp;<span class="op" id="5390988">&lt;</span>&nbsp;<span class="num" id="5390990">256</span><span class="op" id="5390993">;</span>&nbsp;<span class="ident" id="5390995">i</span><span class="op" id="5390996">++</span>&nbsp;<span class="op" id="5390999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391003">sum</span>&nbsp;<span class="op" id="5391007">+=</span>&nbsp;<span class="ident" id="5391010">c</span><span class="op" id="5391011">[</span><span class="ident" id="5391012">i</span><span class="op" id="5391013">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391017">c</span><span class="op" id="5391018">[</span><span class="ident" id="5391019">i</span><span class="op" id="5391020">]</span>&nbsp;<span class="op" id="5391022">=</span>&nbsp;<span class="ident" id="5391024">sum</span>&nbsp;<span class="op" id="5391028">-</span>&nbsp;<span class="ident" id="5391030">c</span><span class="op" id="5391031">[</span><span class="ident" id="5391032">i</span><span class="op" id="5391033">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5391036">}</span><br>
<span class="lineno">465</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5391040">for</span>&nbsp;<span class="ident" id="5391044">i</span>&nbsp;<span class="op" id="5391046">:=</span>&nbsp;<span class="keyword" id="5391049">range</span>&nbsp;<span class="ident" id="5391055">tt</span>&nbsp;<span class="op" id="5391058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391062">b</span>&nbsp;<span class="op" id="5391064">:=</span>&nbsp;<span class="ident" id="5391067">tt</span><span class="op" id="5391069">[</span><span class="ident" id="5391070">i</span><span class="op" id="5391071">]</span>&nbsp;<span class="op" id="5391073">&amp;</span>&nbsp;<span class="num" id="5391075">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391082">tt</span><span class="op" id="5391084">[</span><span class="ident" id="5391085">c</span><span class="op" id="5391086">[</span><span class="ident" id="5391087">b</span><span class="op" id="5391088">]</span><span class="op" id="5391089">]</span>&nbsp;<span class="op" id="5391091">|=</span>&nbsp;<span class="builtintype" id="5391094">uint32</span><span class="op" id="5391100">(</span><span class="ident" id="5391101">i</span><span class="op" id="5391102">)</span>&nbsp;<span class="op" id="5391104">&lt;&lt;</span>&nbsp;<span class="num" id="5391107">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391111">c</span><span class="op" id="5391112">[</span><span class="ident" id="5391113">b</span><span class="op" id="5391114">]</span><span class="op" id="5391115">++</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5391119">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5391123">return</span>&nbsp;<span class="ident" id="5391130">tt</span><span class="op" id="5391132">[</span><span class="ident" id="5391133">origPtr</span><span class="op" id="5391140">]</span>&nbsp;<span class="op" id="5391142">&gt;&gt;</span>&nbsp;<span class="num" id="5391145">8</span><br>
<span class="lineno"></span><span class="op" id="5391147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span><span class="comment" id="5391150">//&nbsp;This&nbsp;is&nbsp;a&nbsp;standard&nbsp;CRC32&nbsp;like&nbsp;in&nbsp;hash/crc32&nbsp;except&nbsp;that&nbsp;all&nbsp;the&nbsp;shifts&nbsp;are&nbsp;reversed,</span><br>
<span class="lineno"></span><span class="comment" id="5391238">//&nbsp;causing&nbsp;the&nbsp;bits&nbsp;in&nbsp;the&nbsp;input&nbsp;to&nbsp;be&nbsp;processed&nbsp;in&nbsp;the&nbsp;reverse&nbsp;of&nbsp;the&nbsp;usual&nbsp;order.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5391323">var</span>&nbsp;<span class="ident" id="5391327">crctab</span>&nbsp;<span class="op" id="5391334">[</span><span class="num" id="5391335">256</span><span class="op" id="5391338">]</span><span class="builtintype" id="5391339">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno">480</span><span class="keyword" id="5391347">func</span>&nbsp;<span class="ident" id="5391352">init</span><span class="op" id="5391356">(</span><span class="op" id="5391357">)</span>&nbsp;<span class="op" id="5391359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5391362">const</span>&nbsp;<span class="ident" id="5391368">poly</span>&nbsp;<span class="op" id="5391373">=</span>&nbsp;<span class="num" id="5391375">0x04C11DB7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5391387">for</span>&nbsp;<span class="ident" id="5391391">i</span>&nbsp;<span class="op" id="5391393">:=</span>&nbsp;<span class="keyword" id="5391396">range</span>&nbsp;<span class="ident" id="5391402">crctab</span>&nbsp;<span class="op" id="5391409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391413">crc</span>&nbsp;<span class="op" id="5391417">:=</span>&nbsp;<span class="builtintype" id="5391420">uint32</span><span class="op" id="5391426">(</span><span class="ident" id="5391427">i</span><span class="op" id="5391428">)</span>&nbsp;<span class="op" id="5391430">&lt;&lt;</span>&nbsp;<span class="num" id="5391433">24</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5391438">for</span>&nbsp;<span class="ident" id="5391442">j</span>&nbsp;<span class="op" id="5391444">:=</span>&nbsp;<span class="num" id="5391447">0</span><span class="op" id="5391448">;</span>&nbsp;<span class="ident" id="5391450">j</span>&nbsp;<span class="op" id="5391452">&lt;</span>&nbsp;<span class="num" id="5391454">8</span><span class="op" id="5391455">;</span>&nbsp;<span class="ident" id="5391457">j</span><span class="op" id="5391458">++</span>&nbsp;<span class="op" id="5391461">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5391466">if</span>&nbsp;<span class="ident" id="5391469">crc</span><span class="op" id="5391472">&amp;</span><span class="num" id="5391473">0x80000000</span>&nbsp;<span class="op" id="5391484">!=</span>&nbsp;<span class="num" id="5391487">0</span>&nbsp;<span class="op" id="5391489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391495">crc</span>&nbsp;<span class="op" id="5391499">=</span>&nbsp;<span class="op" id="5391501">(</span><span class="ident" id="5391502">crc</span>&nbsp;<span class="op" id="5391506">&lt;&lt;</span>&nbsp;<span class="num" id="5391509">1</span><span class="op" id="5391510">)</span>&nbsp;<span class="op" id="5391512">^</span>&nbsp;<span class="ident" id="5391514">poly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5391522">}</span>&nbsp;<span class="keyword" id="5391524">else</span>&nbsp;<span class="op" id="5391529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391535">crc</span>&nbsp;<span class="op" id="5391539">&lt;&lt;=</span>&nbsp;<span class="num" id="5391543">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5391548">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5391552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391556">crctab</span><span class="op" id="5391562">[</span><span class="ident" id="5391563">i</span><span class="op" id="5391564">]</span>&nbsp;<span class="op" id="5391566">=</span>&nbsp;<span class="ident" id="5391568">crc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5391573">}</span><br>
<span class="lineno"></span><span class="op" id="5391575">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="5391578">//&nbsp;updateCRC&nbsp;updates&nbsp;the&nbsp;crc&nbsp;value&nbsp;to&nbsp;incorporate&nbsp;the&nbsp;data&nbsp;in&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="5391643">//&nbsp;The&nbsp;initial&nbsp;value&nbsp;is&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="5391670">func</span>&nbsp;<span class="ident" id="5391675">updateCRC</span><span class="op" id="5391684">(</span><span class="ident" id="5391685">val</span>&nbsp;<span class="builtintype" id="5391689">uint32</span><span class="op" id="5391695">,</span>&nbsp;<span class="ident" id="5391697">b</span>&nbsp;<span class="op" id="5391699">[</span><span class="op" id="5391700">]</span><span class="builtintype" id="5391701">byte</span><span class="op" id="5391705">)</span>&nbsp;<span class="builtintype" id="5391707">uint32</span>&nbsp;<span class="op" id="5391714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391717">crc</span>&nbsp;<span class="op" id="5391721">:=</span>&nbsp;<span class="op" id="5391724">^</span><span class="ident" id="5391725">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5391730">for</span>&nbsp;<span class="ident" id="5391734">_</span><span class="op" id="5391735">,</span>&nbsp;<span class="ident" id="5391737">v</span>&nbsp;<span class="op" id="5391739">:=</span>&nbsp;<span class="keyword" id="5391742">range</span>&nbsp;<span class="ident" id="5391748">b</span>&nbsp;<span class="op" id="5391750">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391754">crc</span>&nbsp;<span class="op" id="5391758">=</span>&nbsp;<span class="ident" id="5391760">crctab</span><span class="op" id="5391766">[</span><span class="builtintype" id="5391767">byte</span><span class="op" id="5391771">(</span><span class="ident" id="5391772">crc</span><span class="op" id="5391775">&gt;&gt;</span><span class="num" id="5391777">24</span><span class="op" id="5391779">)</span><span class="op" id="5391780">^</span><span class="ident" id="5391781">v</span><span class="op" id="5391782">]</span>&nbsp;<span class="op" id="5391784">^</span>&nbsp;<span class="op" id="5391786">(</span><span class="ident" id="5391787">crc</span>&nbsp;<span class="op" id="5391791">&lt;&lt;</span>&nbsp;<span class="num" id="5391794">8</span><span class="op" id="5391795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5391798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5391801">return</span>&nbsp;<span class="op" id="5391808">^</span><span class="ident" id="5391809">crc</span><br>
<span class="lineno"></span><span class="op" id="5391813">}</span>
</div>
</body>
</html>
