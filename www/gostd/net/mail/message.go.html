<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/mail</h2>
<ul>
<li><a href="/gostd/net/mail/message.go.html" class="current">message.go</a></li>
<li><a href="/gostd/net/mail/message_test.go.html">message_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2829279">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2829334">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2829388">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2829439">/*<br>
<span class="lineno"></span>Package&nbsp;mail&nbsp;implements&nbsp;parsing&nbsp;of&nbsp;mail&nbsp;messages.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>For&nbsp;the&nbsp;most&nbsp;part,&nbsp;this&nbsp;package&nbsp;follows&nbsp;the&nbsp;syntax&nbsp;as&nbsp;specified&nbsp;by&nbsp;RFC&nbsp;5322.<br>
<span class="lineno"></span>Notable&nbsp;divergences:<br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Obsolete&nbsp;address&nbsp;formats&nbsp;are&nbsp;not&nbsp;parsed,&nbsp;including&nbsp;addresses&nbsp;with<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;embedded&nbsp;route&nbsp;information.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Group&nbsp;addresses&nbsp;are&nbsp;not&nbsp;parsed.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;full&nbsp;range&nbsp;of&nbsp;spacing&nbsp;(the&nbsp;CFWS&nbsp;syntax&nbsp;element)&nbsp;is&nbsp;not&nbsp;supported,<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;such&nbsp;as&nbsp;breaking&nbsp;addresses&nbsp;across&nbsp;lines.<br>
<span class="lineno">15</span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="2829846">package</span>&nbsp;<span class="ident" id="2829854">mail</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2829860">import</span>&nbsp;<span class="op" id="2829867">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2829870">&#34;bufio&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2829879">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2829888">&#34;encoding/base64&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2829907">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2829917">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2829924">&#34;io&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2829930">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2829943">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2829950">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2829967">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2829978">&#34;strings&#34;</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2829989">&#34;time&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2829997">&#34;unicode&#34;</span><br>
<span class="lineno"></span><span class="op" id="2830007">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2830010">var</span>&nbsp;<span class="ident" id="2830014">debug</span>&nbsp;<span class="op" id="2830020">=</span>&nbsp;<span class="ident" id="2830022">debugT</span><span class="op" id="2830028">(</span><span class="builtintype" id="2830029">false</span><span class="op" id="2830034">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="2830037">type</span>&nbsp;<span class="ident" id="2830042">debugT</span>&nbsp;<span class="builtintype" id="2830049">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2830055">func</span>&nbsp;<span class="op" id="2830060">(</span><span class="ident" id="2830061">d</span>&nbsp;<span class="ident" id="2830063">debugT</span><span class="op" id="2830069">)</span>&nbsp;<span class="ident" id="2830071">Printf</span><span class="op" id="2830077">(</span><span class="ident" id="2830078">format</span>&nbsp;<span class="builtintype" id="2830085">string</span><span class="op" id="2830091">,</span>&nbsp;<span class="ident" id="2830093">args</span>&nbsp;<span class="op" id="2830098">...</span><span class="keyword" id="2830101">interface</span><span class="op" id="2830110">{</span><span class="op" id="2830111">}</span><span class="op" id="2830112">)</span>&nbsp;<span class="op" id="2830114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2830117">if</span>&nbsp;<span class="ident" id="2830120">d</span>&nbsp;<span class="op" id="2830122">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2830126">log</span><span class="op" id="2830129">.</span><span class="ident" id="2830130">Printf</span><span class="op" id="2830136">(</span><span class="ident" id="2830137">format</span><span class="op" id="2830143">,</span>&nbsp;<span class="ident" id="2830145">args</span><span class="op" id="2830149">...</span><span class="op" id="2830152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2830155">}</span><br>
<span class="lineno"></span><span class="op" id="2830157">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2830160">//&nbsp;A&nbsp;Message&nbsp;represents&nbsp;a&nbsp;parsed&nbsp;mail&nbsp;message.</span><br>
<span class="lineno">45</span><span class="keyword" id="2830207">type</span>&nbsp;<span class="ident" id="2830212">Message</span>&nbsp;<span class="keyword" id="2830220">struct</span>&nbsp;<span class="op" id="2830227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2830230">Header</span>&nbsp;<span class="ident" id="2830237">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2830245">Body</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2830252">io</span><span class="op" id="2830254">.</span><span class="ident" id="2830255">Reader</span><br>
<span class="lineno"></span><span class="op" id="2830262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="2830265">//&nbsp;ReadMessage&nbsp;reads&nbsp;a&nbsp;message&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="comment" id="2830304">//&nbsp;The&nbsp;headers&nbsp;are&nbsp;parsed,&nbsp;and&nbsp;the&nbsp;body&nbsp;of&nbsp;the&nbsp;message&nbsp;will&nbsp;be&nbsp;available</span><br>
<span class="lineno"></span><span class="comment" id="2830377">//&nbsp;for&nbsp;reading&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="2830400">func</span>&nbsp;<span class="ident" id="2830405">ReadMessage</span><span class="op" id="2830416">(</span><span class="ident" id="2830417">r</span>&nbsp;<span class="ident" id="2830419">io</span><span class="op" id="2830421">.</span><span class="ident" id="2830422">Reader</span><span class="op" id="2830428">)</span>&nbsp;<span class="op" id="2830430">(</span><span class="ident" id="2830431">msg</span>&nbsp;<span class="op" id="2830435">*</span><span class="ident" id="2830436">Message</span><span class="op" id="2830443">,</span>&nbsp;<span class="ident" id="2830445">err</span>&nbsp;<span class="builtintype" id="2830449">error</span><span class="op" id="2830454">)</span>&nbsp;<span class="op" id="2830456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2830459">tp</span>&nbsp;<span class="op" id="2830462">:=</span>&nbsp;<span class="ident" id="2830465">textproto</span><span class="op" id="2830474">.</span><span class="ident" id="2830475">NewReader</span><span class="op" id="2830484">(</span><span class="ident" id="2830485">bufio</span><span class="op" id="2830490">.</span><span class="ident" id="2830491">NewReader</span><span class="op" id="2830500">(</span><span class="ident" id="2830501">r</span><span class="op" id="2830502">)</span><span class="op" id="2830503">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2830507">hdr</span><span class="op" id="2830510">,</span>&nbsp;<span class="ident" id="2830512">err</span>&nbsp;<span class="op" id="2830516">:=</span>&nbsp;<span class="ident" id="2830519">tp</span><span class="op" id="2830521">.</span><span class="ident" id="2830522">ReadMIMEHeader</span><span class="op" id="2830536">(</span><span class="op" id="2830537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2830540">if</span>&nbsp;<span class="ident" id="2830543">err</span>&nbsp;<span class="op" id="2830547">!=</span>&nbsp;<span class="ident" id="2830550">nil</span>&nbsp;<span class="op" id="2830554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2830558">return</span>&nbsp;<span class="ident" id="2830565">nil</span><span class="op" id="2830568">,</span>&nbsp;<span class="ident" id="2830570">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2830575">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2830579">return</span>&nbsp;<span class="op" id="2830586">&amp;</span><span class="ident" id="2830587">Message</span><span class="op" id="2830594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2830598">Header</span><span class="op" id="2830604">:</span>&nbsp;<span class="ident" id="2830606">Header</span><span class="op" id="2830612">(</span><span class="ident" id="2830613">hdr</span><span class="op" id="2830616">)</span><span class="op" id="2830617">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2830621">Body</span><span class="op" id="2830625">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2830629">tp</span><span class="op" id="2830631">.</span><span class="ident" id="2830632">R</span><span class="op" id="2830633">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2830636">}</span><span class="op" id="2830637">,</span>&nbsp;<span class="ident" id="2830639">nil</span><br>
<span class="lineno">65</span><span class="op" id="2830643">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2830646">//&nbsp;Layouts&nbsp;suitable&nbsp;for&nbsp;passing&nbsp;to&nbsp;time.Parse.</span><br>
<span class="lineno"></span><span class="comment" id="2830693">//&nbsp;These&nbsp;are&nbsp;tried&nbsp;in&nbsp;order.</span><br>
<span class="lineno"></span><span class="keyword" id="2830722">var</span>&nbsp;<span class="ident" id="2830726">dateLayouts</span>&nbsp;<span class="op" id="2830738">[</span><span class="op" id="2830739">]</span><span class="builtintype" id="2830740">string</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="2830748">func</span>&nbsp;<span class="ident" id="2830753">init</span><span class="op" id="2830757">(</span><span class="op" id="2830758">)</span>&nbsp;<span class="op" id="2830760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2830763">//&nbsp;Generate&nbsp;layouts&nbsp;based&nbsp;on&nbsp;RFC&nbsp;5322,&nbsp;section&nbsp;3.3.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2830817">dows</span>&nbsp;<span class="op" id="2830822">:=</span>&nbsp;<span class="op" id="2830825">[</span><span class="op" id="2830826">...</span><span class="op" id="2830829">]</span><span class="builtintype" id="2830830">string</span><span class="op" id="2830836">{</span><span class="string" id="2830837">&#34;&#34;</span><span class="op" id="2830839">,</span>&nbsp;<span class="string" id="2830841">&#34;Mon,&nbsp;&#34;</span><span class="op" id="2830848">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="2830852">//&nbsp;day-of-week</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2830868">days</span>&nbsp;<span class="op" id="2830873">:=</span>&nbsp;<span class="op" id="2830876">[</span><span class="op" id="2830877">...</span><span class="op" id="2830880">]</span><span class="builtintype" id="2830881">string</span><span class="op" id="2830887">{</span><span class="string" id="2830888">&#34;2&#34;</span><span class="op" id="2830891">,</span>&nbsp;<span class="string" id="2830893">&#34;02&#34;</span><span class="op" id="2830897">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2830903">//&nbsp;day&nbsp;=&nbsp;1*2DIGIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2830922">years</span>&nbsp;<span class="op" id="2830928">:=</span>&nbsp;<span class="op" id="2830931">[</span><span class="op" id="2830932">...</span><span class="op" id="2830935">]</span><span class="builtintype" id="2830936">string</span><span class="op" id="2830942">{</span><span class="string" id="2830943">&#34;2006&#34;</span><span class="op" id="2830949">,</span>&nbsp;<span class="string" id="2830951">&#34;06&#34;</span><span class="op" id="2830955">}</span>&nbsp;<span class="comment" id="2830957">//&nbsp;year&nbsp;=&nbsp;4*DIGIT&nbsp;/&nbsp;2*DIGIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2830986">seconds</span>&nbsp;<span class="op" id="2830994">:=</span>&nbsp;<span class="op" id="2830997">[</span><span class="op" id="2830998">...</span><span class="op" id="2831001">]</span><span class="builtintype" id="2831002">string</span><span class="op" id="2831008">{</span><span class="string" id="2831009">&#34;:05&#34;</span><span class="op" id="2831014">,</span>&nbsp;<span class="string" id="2831016">&#34;&#34;</span><span class="op" id="2831018">}</span>&nbsp;&nbsp;<span class="comment" id="2831021">//&nbsp;second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2831032">//&nbsp;&#34;-0700&nbsp;(MST)&#34;&nbsp;is&nbsp;not&nbsp;in&nbsp;RFC&nbsp;5322,&nbsp;but&nbsp;is&nbsp;common.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2831085">zones</span>&nbsp;<span class="op" id="2831091">:=</span>&nbsp;<span class="op" id="2831094">[</span><span class="op" id="2831095">...</span><span class="op" id="2831098">]</span><span class="builtintype" id="2831099">string</span><span class="op" id="2831105">{</span><span class="string" id="2831106">&#34;-0700&#34;</span><span class="op" id="2831113">,</span>&nbsp;<span class="string" id="2831115">&#34;MST&#34;</span><span class="op" id="2831120">,</span>&nbsp;<span class="string" id="2831122">&#34;-0700&nbsp;(MST)&#34;</span><span class="op" id="2831135">}</span>&nbsp;<span class="comment" id="2831137">//&nbsp;zone&nbsp;=&nbsp;((&#34;+&#34;&nbsp;/&nbsp;&#34;-&#34;)&nbsp;4DIGIT)&nbsp;/&nbsp;&#34;GMT&#34;&nbsp;/&nbsp;...</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2831184">for</span>&nbsp;<span class="ident" id="2831188">_</span><span class="op" id="2831189">,</span>&nbsp;<span class="ident" id="2831191">dow</span>&nbsp;<span class="op" id="2831195">:=</span>&nbsp;<span class="keyword" id="2831198">range</span>&nbsp;<span class="ident" id="2831204">dows</span>&nbsp;<span class="op" id="2831209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2831213">for</span>&nbsp;<span class="ident" id="2831217">_</span><span class="op" id="2831218">,</span>&nbsp;<span class="ident" id="2831220">day</span>&nbsp;<span class="op" id="2831224">:=</span>&nbsp;<span class="keyword" id="2831227">range</span>&nbsp;<span class="ident" id="2831233">days</span>&nbsp;<span class="op" id="2831238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2831243">for</span>&nbsp;<span class="ident" id="2831247">_</span><span class="op" id="2831248">,</span>&nbsp;<span class="ident" id="2831250">year</span>&nbsp;<span class="op" id="2831255">:=</span>&nbsp;<span class="keyword" id="2831258">range</span>&nbsp;<span class="ident" id="2831264">years</span>&nbsp;<span class="op" id="2831270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2831276">for</span>&nbsp;<span class="ident" id="2831280">_</span><span class="op" id="2831281">,</span>&nbsp;<span class="ident" id="2831283">second</span>&nbsp;<span class="op" id="2831290">:=</span>&nbsp;<span class="keyword" id="2831293">range</span>&nbsp;<span class="ident" id="2831299">seconds</span>&nbsp;<span class="op" id="2831307">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2831314">for</span>&nbsp;<span class="ident" id="2831318">_</span><span class="op" id="2831319">,</span>&nbsp;<span class="ident" id="2831321">zone</span>&nbsp;<span class="op" id="2831326">:=</span>&nbsp;<span class="keyword" id="2831329">range</span>&nbsp;<span class="ident" id="2831335">zones</span>&nbsp;<span class="op" id="2831341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2831349">s</span>&nbsp;<span class="op" id="2831351">:=</span>&nbsp;<span class="ident" id="2831354">dow</span>&nbsp;<span class="op" id="2831358">+</span>&nbsp;<span class="ident" id="2831360">day</span>&nbsp;<span class="op" id="2831364">+</span>&nbsp;<span class="string" id="2831366">&#34;&nbsp;Jan&nbsp;&#34;</span>&nbsp;<span class="op" id="2831374">+</span>&nbsp;<span class="ident" id="2831376">year</span>&nbsp;<span class="op" id="2831381">+</span>&nbsp;<span class="string" id="2831383">&#34;&nbsp;15:04&#34;</span>&nbsp;<span class="op" id="2831392">+</span>&nbsp;<span class="ident" id="2831394">second</span>&nbsp;<span class="op" id="2831401">+</span>&nbsp;<span class="string" id="2831403">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="2831407">+</span>&nbsp;<span class="ident" id="2831409">zone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2831420">dateLayouts</span>&nbsp;<span class="op" id="2831432">=</span>&nbsp;<span class="builtinfunc" id="2831434">append</span><span class="op" id="2831440">(</span><span class="ident" id="2831441">dateLayouts</span><span class="op" id="2831452">,</span>&nbsp;<span class="ident" id="2831454">s</span><span class="op" id="2831455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2831462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2831468">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2831473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2831477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2831480">}</span><br>
<span class="lineno"></span><span class="op" id="2831482">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="2831485">func</span>&nbsp;<span class="ident" id="2831490">parseDate</span><span class="op" id="2831499">(</span><span class="ident" id="2831500">date</span>&nbsp;<span class="builtintype" id="2831505">string</span><span class="op" id="2831511">)</span>&nbsp;<span class="op" id="2831513">(</span><span class="ident" id="2831514">time</span><span class="op" id="2831518">.</span><span class="ident" id="2831519">Time</span><span class="op" id="2831523">,</span>&nbsp;<span class="builtintype" id="2831525">error</span><span class="op" id="2831530">)</span>&nbsp;<span class="op" id="2831532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2831535">for</span>&nbsp;<span class="ident" id="2831539">_</span><span class="op" id="2831540">,</span>&nbsp;<span class="ident" id="2831542">layout</span>&nbsp;<span class="op" id="2831549">:=</span>&nbsp;<span class="keyword" id="2831552">range</span>&nbsp;<span class="ident" id="2831558">dateLayouts</span>&nbsp;<span class="op" id="2831570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2831574">t</span><span class="op" id="2831575">,</span>&nbsp;<span class="ident" id="2831577">err</span>&nbsp;<span class="op" id="2831581">:=</span>&nbsp;<span class="ident" id="2831584">time</span><span class="op" id="2831588">.</span><span class="ident" id="2831589">Parse</span><span class="op" id="2831594">(</span><span class="ident" id="2831595">layout</span><span class="op" id="2831601">,</span>&nbsp;<span class="ident" id="2831603">date</span><span class="op" id="2831607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2831611">if</span>&nbsp;<span class="ident" id="2831614">err</span>&nbsp;<span class="op" id="2831618">==</span>&nbsp;<span class="ident" id="2831621">nil</span>&nbsp;<span class="op" id="2831625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2831630">return</span>&nbsp;<span class="ident" id="2831637">t</span><span class="op" id="2831638">,</span>&nbsp;<span class="ident" id="2831640">nil</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2831646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2831649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2831652">return</span>&nbsp;<span class="ident" id="2831659">time</span><span class="op" id="2831663">.</span><span class="ident" id="2831664">Time</span><span class="op" id="2831668">{</span><span class="op" id="2831669">}</span><span class="op" id="2831670">,</span>&nbsp;<span class="ident" id="2831672">errors</span><span class="op" id="2831678">.</span><span class="ident" id="2831679">New</span><span class="op" id="2831682">(</span><span class="string" id="2831683">&#34;mail:&nbsp;header&nbsp;could&nbsp;not&nbsp;be&nbsp;parsed&#34;</span><span class="op" id="2831717">)</span><br>
<span class="lineno"></span><span class="op" id="2831719">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="2831722">//&nbsp;A&nbsp;Header&nbsp;represents&nbsp;the&nbsp;key-value&nbsp;pairs&nbsp;in&nbsp;a&nbsp;mail&nbsp;message&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="2831791">type</span>&nbsp;<span class="ident" id="2831796">Header</span>&nbsp;<span class="keyword" id="2831803">map</span><span class="op" id="2831806">[</span><span class="builtintype" id="2831807">string</span><span class="op" id="2831813">]</span><span class="op" id="2831814">[</span><span class="op" id="2831815">]</span><span class="builtintype" id="2831816">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2831824">//&nbsp;Get&nbsp;gets&nbsp;the&nbsp;first&nbsp;value&nbsp;associated&nbsp;with&nbsp;the&nbsp;given&nbsp;key.</span><br>
<span class="lineno"></span><span class="comment" id="2831883">//&nbsp;If&nbsp;there&nbsp;are&nbsp;no&nbsp;values&nbsp;associated&nbsp;with&nbsp;the&nbsp;key,&nbsp;Get&nbsp;returns&nbsp;&#34;&#34;.</span><br>
<span class="lineno">110</span><span class="keyword" id="2831950">func</span>&nbsp;<span class="op" id="2831955">(</span><span class="ident" id="2831956">h</span>&nbsp;<span class="ident" id="2831958">Header</span><span class="op" id="2831964">)</span>&nbsp;<span class="ident" id="2831966">Get</span><span class="op" id="2831969">(</span><span class="ident" id="2831970">key</span>&nbsp;<span class="builtintype" id="2831974">string</span><span class="op" id="2831980">)</span>&nbsp;<span class="builtintype" id="2831982">string</span>&nbsp;<span class="op" id="2831989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2831992">return</span>&nbsp;<span class="ident" id="2831999">textproto</span><span class="op" id="2832008">.</span><span class="ident" id="2832009">MIMEHeader</span><span class="op" id="2832019">(</span><span class="ident" id="2832020">h</span><span class="op" id="2832021">)</span><span class="op" id="2832022">.</span><span class="ident" id="2832023">Get</span><span class="op" id="2832026">(</span><span class="ident" id="2832027">key</span><span class="op" id="2832030">)</span><br>
<span class="lineno"></span><span class="op" id="2832032">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2832035">var</span>&nbsp;<span class="ident" id="2832039">ErrHeaderNotPresent</span>&nbsp;<span class="op" id="2832059">=</span>&nbsp;<span class="ident" id="2832061">errors</span><span class="op" id="2832067">.</span><span class="ident" id="2832068">New</span><span class="op" id="2832071">(</span><span class="string" id="2832072">&#34;mail:&nbsp;header&nbsp;not&nbsp;in&nbsp;message&#34;</span><span class="op" id="2832101">)</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="2832104">//&nbsp;Date&nbsp;parses&nbsp;the&nbsp;Date&nbsp;header&nbsp;field.</span><br>
<span class="lineno"></span><span class="keyword" id="2832142">func</span>&nbsp;<span class="op" id="2832147">(</span><span class="ident" id="2832148">h</span>&nbsp;<span class="ident" id="2832150">Header</span><span class="op" id="2832156">)</span>&nbsp;<span class="ident" id="2832158">Date</span><span class="op" id="2832162">(</span><span class="op" id="2832163">)</span>&nbsp;<span class="op" id="2832165">(</span><span class="ident" id="2832166">time</span><span class="op" id="2832170">.</span><span class="ident" id="2832171">Time</span><span class="op" id="2832175">,</span>&nbsp;<span class="builtintype" id="2832177">error</span><span class="op" id="2832182">)</span>&nbsp;<span class="op" id="2832184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2832187">hdr</span>&nbsp;<span class="op" id="2832191">:=</span>&nbsp;<span class="ident" id="2832194">h</span><span class="op" id="2832195">.</span><span class="ident" id="2832196">Get</span><span class="op" id="2832199">(</span><span class="string" id="2832200">&#34;Date&#34;</span><span class="op" id="2832206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2832209">if</span>&nbsp;<span class="ident" id="2832212">hdr</span>&nbsp;<span class="op" id="2832216">==</span>&nbsp;<span class="string" id="2832219">&#34;&#34;</span>&nbsp;<span class="op" id="2832222">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2832226">return</span>&nbsp;<span class="ident" id="2832233">time</span><span class="op" id="2832237">.</span><span class="ident" id="2832238">Time</span><span class="op" id="2832242">{</span><span class="op" id="2832243">}</span><span class="op" id="2832244">,</span>&nbsp;<span class="ident" id="2832246">ErrHeaderNotPresent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2832267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2832270">return</span>&nbsp;<span class="ident" id="2832277">parseDate</span><span class="op" id="2832286">(</span><span class="ident" id="2832287">hdr</span><span class="op" id="2832290">)</span><br>
<span class="lineno"></span><span class="op" id="2832292">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="comment" id="2832295">//&nbsp;AddressList&nbsp;parses&nbsp;the&nbsp;named&nbsp;header&nbsp;field&nbsp;as&nbsp;a&nbsp;list&nbsp;of&nbsp;addresses.</span><br>
<span class="lineno"></span><span class="keyword" id="2832364">func</span>&nbsp;<span class="op" id="2832369">(</span><span class="ident" id="2832370">h</span>&nbsp;<span class="ident" id="2832372">Header</span><span class="op" id="2832378">)</span>&nbsp;<span class="ident" id="2832380">AddressList</span><span class="op" id="2832391">(</span><span class="ident" id="2832392">key</span>&nbsp;<span class="builtintype" id="2832396">string</span><span class="op" id="2832402">)</span>&nbsp;<span class="op" id="2832404">(</span><span class="op" id="2832405">[</span><span class="op" id="2832406">]</span><span class="op" id="2832407">*</span><span class="ident" id="2832408">Address</span><span class="op" id="2832415">,</span>&nbsp;<span class="builtintype" id="2832417">error</span><span class="op" id="2832422">)</span>&nbsp;<span class="op" id="2832424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2832427">hdr</span>&nbsp;<span class="op" id="2832431">:=</span>&nbsp;<span class="ident" id="2832434">h</span><span class="op" id="2832435">.</span><span class="ident" id="2832436">Get</span><span class="op" id="2832439">(</span><span class="ident" id="2832440">key</span><span class="op" id="2832443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2832446">if</span>&nbsp;<span class="ident" id="2832449">hdr</span>&nbsp;<span class="op" id="2832453">==</span>&nbsp;<span class="string" id="2832456">&#34;&#34;</span>&nbsp;<span class="op" id="2832459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2832463">return</span>&nbsp;<span class="ident" id="2832470">nil</span><span class="op" id="2832473">,</span>&nbsp;<span class="ident" id="2832475">ErrHeaderNotPresent</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2832496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2832499">return</span>&nbsp;<span class="ident" id="2832506">ParseAddressList</span><span class="op" id="2832522">(</span><span class="ident" id="2832523">hdr</span><span class="op" id="2832526">)</span><br>
<span class="lineno"></span><span class="op" id="2832528">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2832531">//&nbsp;Address&nbsp;represents&nbsp;a&nbsp;single&nbsp;mail&nbsp;address.</span><br>
<span class="lineno">135</span><span class="comment" id="2832576">//&nbsp;An&nbsp;address&nbsp;such&nbsp;as&nbsp;&#34;Barry&nbsp;Gibbs&nbsp;&lt;bg@example.com&gt;&#34;&nbsp;is&nbsp;represented</span><br>
<span class="lineno"></span><span class="comment" id="2832644">//&nbsp;as&nbsp;Address{Name:&nbsp;&#34;Barry&nbsp;Gibbs&#34;,&nbsp;Address:&nbsp;&#34;bg@example.com&#34;}.</span><br>
<span class="lineno"></span><span class="keyword" id="2832707">type</span>&nbsp;<span class="ident" id="2832712">Address</span>&nbsp;<span class="keyword" id="2832720">struct</span>&nbsp;<span class="op" id="2832727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2832730">Name</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2832738">string</span>&nbsp;<span class="comment" id="2832745">//&nbsp;Proper&nbsp;name;&nbsp;may&nbsp;be&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2832776">Address</span>&nbsp;<span class="builtintype" id="2832784">string</span>&nbsp;<span class="comment" id="2832791">//&nbsp;user@domain</span><br>
<span class="lineno">140</span><span class="op" id="2832806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2832809">//&nbsp;Parses&nbsp;a&nbsp;single&nbsp;RFC&nbsp;5322&nbsp;address,&nbsp;e.g.&nbsp;&#34;Barry&nbsp;Gibbs&nbsp;&lt;bg@example.com&gt;&#34;</span><br>
<span class="lineno"></span><span class="keyword" id="2832882">func</span>&nbsp;<span class="ident" id="2832887">ParseAddress</span><span class="op" id="2832899">(</span><span class="ident" id="2832900">address</span>&nbsp;<span class="builtintype" id="2832908">string</span><span class="op" id="2832914">)</span>&nbsp;<span class="op" id="2832916">(</span><span class="op" id="2832917">*</span><span class="ident" id="2832918">Address</span><span class="op" id="2832925">,</span>&nbsp;<span class="builtintype" id="2832927">error</span><span class="op" id="2832932">)</span>&nbsp;<span class="op" id="2832934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2832937">return</span>&nbsp;<span class="ident" id="2832944">newAddrParser</span><span class="op" id="2832957">(</span><span class="ident" id="2832958">address</span><span class="op" id="2832965">)</span><span class="op" id="2832966">.</span><span class="ident" id="2832967">parseAddress</span><span class="op" id="2832979">(</span><span class="op" id="2832980">)</span><br>
<span class="lineno">145</span><span class="op" id="2832982">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2832985">//&nbsp;ParseAddressList&nbsp;parses&nbsp;the&nbsp;given&nbsp;string&nbsp;as&nbsp;a&nbsp;list&nbsp;of&nbsp;addresses.</span><br>
<span class="lineno"></span><span class="keyword" id="2833053">func</span>&nbsp;<span class="ident" id="2833058">ParseAddressList</span><span class="op" id="2833074">(</span><span class="ident" id="2833075">list</span>&nbsp;<span class="builtintype" id="2833080">string</span><span class="op" id="2833086">)</span>&nbsp;<span class="op" id="2833088">(</span><span class="op" id="2833089">[</span><span class="op" id="2833090">]</span><span class="op" id="2833091">*</span><span class="ident" id="2833092">Address</span><span class="op" id="2833099">,</span>&nbsp;<span class="builtintype" id="2833101">error</span><span class="op" id="2833106">)</span>&nbsp;<span class="op" id="2833108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2833111">return</span>&nbsp;<span class="ident" id="2833118">newAddrParser</span><span class="op" id="2833131">(</span><span class="ident" id="2833132">list</span><span class="op" id="2833136">)</span><span class="op" id="2833137">.</span><span class="ident" id="2833138">parseAddressList</span><span class="op" id="2833154">(</span><span class="op" id="2833155">)</span><br>
<span class="lineno">150</span><span class="op" id="2833157">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2833160">//&nbsp;String&nbsp;formats&nbsp;the&nbsp;address&nbsp;as&nbsp;a&nbsp;valid&nbsp;RFC&nbsp;5322&nbsp;address.</span><br>
<span class="lineno"></span><span class="comment" id="2833219">//&nbsp;If&nbsp;the&nbsp;address&#39;s&nbsp;name&nbsp;contains&nbsp;non-ASCII&nbsp;characters</span><br>
<span class="lineno"></span><span class="comment" id="2833274">//&nbsp;the&nbsp;name&nbsp;will&nbsp;be&nbsp;rendered&nbsp;according&nbsp;to&nbsp;RFC&nbsp;2047.</span><br>
<span class="lineno">155</span><span class="keyword" id="2833326">func</span>&nbsp;<span class="op" id="2833331">(</span><span class="ident" id="2833332">a</span>&nbsp;<span class="op" id="2833334">*</span><span class="ident" id="2833335">Address</span><span class="op" id="2833342">)</span>&nbsp;<span class="ident" id="2833344">String</span><span class="op" id="2833350">(</span><span class="op" id="2833351">)</span>&nbsp;<span class="builtintype" id="2833353">string</span>&nbsp;<span class="op" id="2833360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2833363">s</span>&nbsp;<span class="op" id="2833365">:=</span>&nbsp;<span class="string" id="2833368">&#34;&lt;&#34;</span>&nbsp;<span class="op" id="2833372">+</span>&nbsp;<span class="ident" id="2833374">a</span><span class="op" id="2833375">.</span><span class="ident" id="2833376">Address</span>&nbsp;<span class="op" id="2833384">+</span>&nbsp;<span class="string" id="2833386">&#34;&gt;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2833391">if</span>&nbsp;<span class="ident" id="2833394">a</span><span class="op" id="2833395">.</span><span class="ident" id="2833396">Name</span>&nbsp;<span class="op" id="2833401">==</span>&nbsp;<span class="string" id="2833404">&#34;&#34;</span>&nbsp;<span class="op" id="2833407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2833411">return</span>&nbsp;<span class="ident" id="2833418">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2833421">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2833424">//&nbsp;If&nbsp;every&nbsp;character&nbsp;is&nbsp;printable&nbsp;ASCII,&nbsp;quoting&nbsp;is&nbsp;simple.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2833486">allPrintable</span>&nbsp;<span class="op" id="2833499">:=</span>&nbsp;<span class="builtintype" id="2833502">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2833508">for</span>&nbsp;<span class="ident" id="2833512">i</span>&nbsp;<span class="op" id="2833514">:=</span>&nbsp;<span class="num" id="2833517">0</span><span class="op" id="2833518">;</span>&nbsp;<span class="ident" id="2833520">i</span>&nbsp;<span class="op" id="2833522">&lt;</span>&nbsp;<span class="builtinfunc" id="2833524">len</span><span class="op" id="2833527">(</span><span class="ident" id="2833528">a</span><span class="op" id="2833529">.</span><span class="ident" id="2833530">Name</span><span class="op" id="2833534">)</span><span class="op" id="2833535">;</span>&nbsp;<span class="ident" id="2833537">i</span><span class="op" id="2833538">++</span>&nbsp;<span class="op" id="2833541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2833545">//&nbsp;isWSP&nbsp;here&nbsp;should&nbsp;actually&nbsp;be&nbsp;isFWS,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2833587">//&nbsp;but&nbsp;we&nbsp;don&#39;t&nbsp;support&nbsp;folding&nbsp;yet.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2833626">if</span>&nbsp;<span class="op" id="2833629">!</span><span class="ident" id="2833630">isVchar</span><span class="op" id="2833637">(</span><span class="ident" id="2833638">a</span><span class="op" id="2833639">.</span><span class="ident" id="2833640">Name</span><span class="op" id="2833644">[</span><span class="ident" id="2833645">i</span><span class="op" id="2833646">]</span><span class="op" id="2833647">)</span>&nbsp;<span class="op" id="2833649">&amp;&amp;</span>&nbsp;<span class="op" id="2833652">!</span><span class="ident" id="2833653">isWSP</span><span class="op" id="2833658">(</span><span class="ident" id="2833659">a</span><span class="op" id="2833660">.</span><span class="ident" id="2833661">Name</span><span class="op" id="2833665">[</span><span class="ident" id="2833666">i</span><span class="op" id="2833667">]</span><span class="op" id="2833668">)</span>&nbsp;<span class="op" id="2833670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2833675">allPrintable</span>&nbsp;<span class="op" id="2833688">=</span>&nbsp;<span class="builtintype" id="2833690">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2833699">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2833707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2833710">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2833713">if</span>&nbsp;<span class="ident" id="2833716">allPrintable</span>&nbsp;<span class="op" id="2833729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2833733">b</span>&nbsp;<span class="op" id="2833735">:=</span>&nbsp;<span class="ident" id="2833738">bytes</span><span class="op" id="2833743">.</span><span class="ident" id="2833744">NewBufferString</span><span class="op" id="2833759">(</span><span class="string" id="2833760">`&#34;`</span><span class="op" id="2833763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2833767">for</span>&nbsp;<span class="ident" id="2833771">i</span>&nbsp;<span class="op" id="2833773">:=</span>&nbsp;<span class="num" id="2833776">0</span><span class="op" id="2833777">;</span>&nbsp;<span class="ident" id="2833779">i</span>&nbsp;<span class="op" id="2833781">&lt;</span>&nbsp;<span class="builtinfunc" id="2833783">len</span><span class="op" id="2833786">(</span><span class="ident" id="2833787">a</span><span class="op" id="2833788">.</span><span class="ident" id="2833789">Name</span><span class="op" id="2833793">)</span><span class="op" id="2833794">;</span>&nbsp;<span class="ident" id="2833796">i</span><span class="op" id="2833797">++</span>&nbsp;<span class="op" id="2833800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2833805">if</span>&nbsp;<span class="op" id="2833808">!</span><span class="ident" id="2833809">isQtext</span><span class="op" id="2833816">(</span><span class="ident" id="2833817">a</span><span class="op" id="2833818">.</span><span class="ident" id="2833819">Name</span><span class="op" id="2833823">[</span><span class="ident" id="2833824">i</span><span class="op" id="2833825">]</span><span class="op" id="2833826">)</span>&nbsp;<span class="op" id="2833828">&amp;&amp;</span>&nbsp;<span class="op" id="2833831">!</span><span class="ident" id="2833832">isWSP</span><span class="op" id="2833837">(</span><span class="ident" id="2833838">a</span><span class="op" id="2833839">.</span><span class="ident" id="2833840">Name</span><span class="op" id="2833844">[</span><span class="ident" id="2833845">i</span><span class="op" id="2833846">]</span><span class="op" id="2833847">)</span>&nbsp;<span class="op" id="2833849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2833855">b</span><span class="op" id="2833856">.</span><span class="ident" id="2833857">WriteByte</span><span class="op" id="2833866">(</span><span class="string" id="2833867">&#39;\\&#39;</span><span class="op" id="2833871">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2833876">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2833881">b</span><span class="op" id="2833882">.</span><span class="ident" id="2833883">WriteByte</span><span class="op" id="2833892">(</span><span class="ident" id="2833893">a</span><span class="op" id="2833894">.</span><span class="ident" id="2833895">Name</span><span class="op" id="2833899">[</span><span class="ident" id="2833900">i</span><span class="op" id="2833901">]</span><span class="op" id="2833902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2833906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2833910">b</span><span class="op" id="2833911">.</span><span class="ident" id="2833912">WriteString</span><span class="op" id="2833923">(</span><span class="string" id="2833924">`&#34;&nbsp;`</span><span class="op" id="2833928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2833932">b</span><span class="op" id="2833933">.</span><span class="ident" id="2833934">WriteString</span><span class="op" id="2833945">(</span><span class="ident" id="2833946">s</span><span class="op" id="2833947">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2833951">return</span>&nbsp;<span class="ident" id="2833958">b</span><span class="op" id="2833959">.</span><span class="ident" id="2833960">String</span><span class="op" id="2833966">(</span><span class="op" id="2833967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2833970">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2833974">//&nbsp;UTF-8&nbsp;&#34;Q&#34;&nbsp;encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2833997">b</span>&nbsp;<span class="op" id="2833999">:=</span>&nbsp;<span class="ident" id="2834002">bytes</span><span class="op" id="2834007">.</span><span class="ident" id="2834008">NewBufferString</span><span class="op" id="2834023">(</span><span class="string" id="2834024">&#34;=?utf-8?q?&#34;</span><span class="op" id="2834036">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2834039">for</span>&nbsp;<span class="ident" id="2834043">i</span>&nbsp;<span class="op" id="2834045">:=</span>&nbsp;<span class="num" id="2834048">0</span><span class="op" id="2834049">;</span>&nbsp;<span class="ident" id="2834051">i</span>&nbsp;<span class="op" id="2834053">&lt;</span>&nbsp;<span class="builtinfunc" id="2834055">len</span><span class="op" id="2834058">(</span><span class="ident" id="2834059">a</span><span class="op" id="2834060">.</span><span class="ident" id="2834061">Name</span><span class="op" id="2834065">)</span><span class="op" id="2834066">;</span>&nbsp;<span class="ident" id="2834068">i</span><span class="op" id="2834069">++</span>&nbsp;<span class="op" id="2834072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2834076">switch</span>&nbsp;<span class="ident" id="2834083">c</span>&nbsp;<span class="op" id="2834085">:=</span>&nbsp;<span class="ident" id="2834088">a</span><span class="op" id="2834089">.</span><span class="ident" id="2834090">Name</span><span class="op" id="2834094">[</span><span class="ident" id="2834095">i</span><span class="op" id="2834096">]</span><span class="op" id="2834097">;</span>&nbsp;<span class="op" id="2834099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2834103">case</span>&nbsp;<span class="ident" id="2834108">c</span>&nbsp;<span class="op" id="2834110">==</span>&nbsp;<span class="string" id="2834113">&#39;&nbsp;&#39;</span><span class="op" id="2834116">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2834121">b</span><span class="op" id="2834122">.</span><span class="ident" id="2834123">WriteByte</span><span class="op" id="2834132">(</span><span class="string" id="2834133">&#39;_&#39;</span><span class="op" id="2834136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2834140">case</span>&nbsp;<span class="ident" id="2834145">isVchar</span><span class="op" id="2834152">(</span><span class="ident" id="2834153">c</span><span class="op" id="2834154">)</span>&nbsp;<span class="op" id="2834156">&amp;&amp;</span>&nbsp;<span class="ident" id="2834159">c</span>&nbsp;<span class="op" id="2834161">!=</span>&nbsp;<span class="string" id="2834164">&#39;=&#39;</span>&nbsp;<span class="op" id="2834168">&amp;&amp;</span>&nbsp;<span class="ident" id="2834171">c</span>&nbsp;<span class="op" id="2834173">!=</span>&nbsp;<span class="string" id="2834176">&#39;?&#39;</span>&nbsp;<span class="op" id="2834180">&amp;&amp;</span>&nbsp;<span class="ident" id="2834183">c</span>&nbsp;<span class="op" id="2834185">!=</span>&nbsp;<span class="string" id="2834188">&#39;_&#39;</span><span class="op" id="2834191">:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2834196">b</span><span class="op" id="2834197">.</span><span class="ident" id="2834198">WriteByte</span><span class="op" id="2834207">(</span><span class="ident" id="2834208">c</span><span class="op" id="2834209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2834213">default</span><span class="op" id="2834220">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2834225">fmt</span><span class="op" id="2834228">.</span><span class="ident" id="2834229">Fprintf</span><span class="op" id="2834236">(</span><span class="ident" id="2834237">b</span><span class="op" id="2834238">,</span>&nbsp;<span class="string" id="2834240">&#34;=%02X&#34;</span><span class="op" id="2834247">,</span>&nbsp;<span class="ident" id="2834249">c</span><span class="op" id="2834250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2834254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2834257">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2834260">b</span><span class="op" id="2834261">.</span><span class="ident" id="2834262">WriteString</span><span class="op" id="2834273">(</span><span class="string" id="2834274">&#34;?=&nbsp;&#34;</span><span class="op" id="2834279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2834282">b</span><span class="op" id="2834283">.</span><span class="ident" id="2834284">WriteString</span><span class="op" id="2834295">(</span><span class="ident" id="2834296">s</span><span class="op" id="2834297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2834300">return</span>&nbsp;<span class="ident" id="2834307">b</span><span class="op" id="2834308">.</span><span class="ident" id="2834309">String</span><span class="op" id="2834315">(</span><span class="op" id="2834316">)</span><br>
<span class="lineno"></span><span class="op" id="2834318">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span><span class="keyword" id="2834321">type</span>&nbsp;<span class="ident" id="2834326">addrParser</span>&nbsp;<span class="op" id="2834337">[</span><span class="op" id="2834338">]</span><span class="builtintype" id="2834339">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2834345">func</span>&nbsp;<span class="ident" id="2834350">newAddrParser</span><span class="op" id="2834363">(</span><span class="ident" id="2834364">s</span>&nbsp;<span class="builtintype" id="2834366">string</span><span class="op" id="2834372">)</span>&nbsp;<span class="op" id="2834374">*</span><span class="ident" id="2834375">addrParser</span>&nbsp;<span class="op" id="2834386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2834389">p</span>&nbsp;<span class="op" id="2834391">:=</span>&nbsp;<span class="ident" id="2834394">addrParser</span><span class="op" id="2834404">(</span><span class="ident" id="2834405">s</span><span class="op" id="2834406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2834409">return</span>&nbsp;<span class="op" id="2834416">&amp;</span><span class="ident" id="2834417">p</span><br>
<span class="lineno">205</span><span class="op" id="2834419">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2834422">func</span>&nbsp;<span class="op" id="2834427">(</span><span class="ident" id="2834428">p</span>&nbsp;<span class="op" id="2834430">*</span><span class="ident" id="2834431">addrParser</span><span class="op" id="2834441">)</span>&nbsp;<span class="ident" id="2834443">parseAddressList</span><span class="op" id="2834459">(</span><span class="op" id="2834460">)</span>&nbsp;<span class="op" id="2834462">(</span><span class="op" id="2834463">[</span><span class="op" id="2834464">]</span><span class="op" id="2834465">*</span><span class="ident" id="2834466">Address</span><span class="op" id="2834473">,</span>&nbsp;<span class="builtintype" id="2834475">error</span><span class="op" id="2834480">)</span>&nbsp;<span class="op" id="2834482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2834485">var</span>&nbsp;<span class="ident" id="2834489">list</span>&nbsp;<span class="op" id="2834494">[</span><span class="op" id="2834495">]</span><span class="op" id="2834496">*</span><span class="ident" id="2834497">Address</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2834506">for</span>&nbsp;<span class="op" id="2834510">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2834514">p</span><span class="op" id="2834515">.</span><span class="ident" id="2834516">skipSpace</span><span class="op" id="2834525">(</span><span class="op" id="2834526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2834530">addr</span><span class="op" id="2834534">,</span>&nbsp;<span class="ident" id="2834536">err</span>&nbsp;<span class="op" id="2834540">:=</span>&nbsp;<span class="ident" id="2834543">p</span><span class="op" id="2834544">.</span><span class="ident" id="2834545">parseAddress</span><span class="op" id="2834557">(</span><span class="op" id="2834558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2834562">if</span>&nbsp;<span class="ident" id="2834565">err</span>&nbsp;<span class="op" id="2834569">!=</span>&nbsp;<span class="ident" id="2834572">nil</span>&nbsp;<span class="op" id="2834576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2834581">return</span>&nbsp;<span class="ident" id="2834588">nil</span><span class="op" id="2834591">,</span>&nbsp;<span class="ident" id="2834593">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2834599">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2834603">list</span>&nbsp;<span class="op" id="2834608">=</span>&nbsp;<span class="builtinfunc" id="2834610">append</span><span class="op" id="2834616">(</span><span class="ident" id="2834617">list</span><span class="op" id="2834621">,</span>&nbsp;<span class="ident" id="2834623">addr</span><span class="op" id="2834627">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2834632">p</span><span class="op" id="2834633">.</span><span class="ident" id="2834634">skipSpace</span><span class="op" id="2834643">(</span><span class="op" id="2834644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2834648">if</span>&nbsp;<span class="ident" id="2834651">p</span><span class="op" id="2834652">.</span><span class="ident" id="2834653">empty</span><span class="op" id="2834658">(</span><span class="op" id="2834659">)</span>&nbsp;<span class="op" id="2834661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2834666">break</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2834674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2834678">if</span>&nbsp;<span class="op" id="2834681">!</span><span class="ident" id="2834682">p</span><span class="op" id="2834683">.</span><span class="ident" id="2834684">consume</span><span class="op" id="2834691">(</span><span class="string" id="2834692">&#39;,&#39;</span><span class="op" id="2834695">)</span>&nbsp;<span class="op" id="2834697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2834702">return</span>&nbsp;<span class="ident" id="2834709">nil</span><span class="op" id="2834712">,</span>&nbsp;<span class="ident" id="2834714">errors</span><span class="op" id="2834720">.</span><span class="ident" id="2834721">New</span><span class="op" id="2834724">(</span><span class="string" id="2834725">&#34;mail:&nbsp;expected&nbsp;comma&#34;</span><span class="op" id="2834747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2834751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2834754">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2834757">return</span>&nbsp;<span class="ident" id="2834764">list</span><span class="op" id="2834768">,</span>&nbsp;<span class="ident" id="2834770">nil</span><br>
<span class="lineno"></span><span class="op" id="2834774">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2834777">//&nbsp;parseAddress&nbsp;parses&nbsp;a&nbsp;single&nbsp;RFC&nbsp;5322&nbsp;address&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="2834845">func</span>&nbsp;<span class="op" id="2834850">(</span><span class="ident" id="2834851">p</span>&nbsp;<span class="op" id="2834853">*</span><span class="ident" id="2834854">addrParser</span><span class="op" id="2834864">)</span>&nbsp;<span class="ident" id="2834866">parseAddress</span><span class="op" id="2834878">(</span><span class="op" id="2834879">)</span>&nbsp;<span class="op" id="2834881">(</span><span class="ident" id="2834882">addr</span>&nbsp;<span class="op" id="2834887">*</span><span class="ident" id="2834888">Address</span><span class="op" id="2834895">,</span>&nbsp;<span class="ident" id="2834897">err</span>&nbsp;<span class="builtintype" id="2834901">error</span><span class="op" id="2834906">)</span>&nbsp;<span class="op" id="2834908">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2834911">debug</span><span class="op" id="2834916">.</span><span class="ident" id="2834917">Printf</span><span class="op" id="2834923">(</span><span class="string" id="2834924">&#34;parseAddress:&nbsp;%q&#34;</span><span class="op" id="2834942">,</span>&nbsp;<span class="op" id="2834944">*</span><span class="ident" id="2834945">p</span><span class="op" id="2834946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2834949">p</span><span class="op" id="2834950">.</span><span class="ident" id="2834951">skipSpace</span><span class="op" id="2834960">(</span><span class="op" id="2834961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2834964">if</span>&nbsp;<span class="ident" id="2834967">p</span><span class="op" id="2834968">.</span><span class="ident" id="2834969">empty</span><span class="op" id="2834974">(</span><span class="op" id="2834975">)</span>&nbsp;<span class="op" id="2834977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2834981">return</span>&nbsp;<span class="ident" id="2834988">nil</span><span class="op" id="2834991">,</span>&nbsp;<span class="ident" id="2834993">errors</span><span class="op" id="2834999">.</span><span class="ident" id="2835000">New</span><span class="op" id="2835003">(</span><span class="string" id="2835004">&#34;mail:&nbsp;no&nbsp;address&#34;</span><span class="op" id="2835022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2835025">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2835029">//&nbsp;address&nbsp;=&nbsp;name-addr&nbsp;/&nbsp;addr-spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2835065">//&nbsp;TODO(dsymonds):&nbsp;Support&nbsp;parsing&nbsp;group&nbsp;address.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2835117">//&nbsp;addr-spec&nbsp;has&nbsp;a&nbsp;more&nbsp;restricted&nbsp;grammar&nbsp;than&nbsp;name-addr,</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2835177">//&nbsp;so&nbsp;try&nbsp;parsing&nbsp;it&nbsp;first,&nbsp;and&nbsp;fallback&nbsp;to&nbsp;name-addr.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2835233">//&nbsp;TODO(dsymonds):&nbsp;Is&nbsp;this&nbsp;really&nbsp;correct?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2835277">spec</span><span class="op" id="2835281">,</span>&nbsp;<span class="ident" id="2835283">err</span>&nbsp;<span class="op" id="2835287">:=</span>&nbsp;<span class="ident" id="2835290">p</span><span class="op" id="2835291">.</span><span class="ident" id="2835292">consumeAddrSpec</span><span class="op" id="2835307">(</span><span class="op" id="2835308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2835311">if</span>&nbsp;<span class="ident" id="2835314">err</span>&nbsp;<span class="op" id="2835318">==</span>&nbsp;<span class="ident" id="2835321">nil</span>&nbsp;<span class="op" id="2835325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2835329">return</span>&nbsp;<span class="op" id="2835336">&amp;</span><span class="ident" id="2835337">Address</span><span class="op" id="2835344">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2835349">Address</span><span class="op" id="2835356">:</span>&nbsp;<span class="ident" id="2835358">spec</span><span class="op" id="2835362">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2835366">}</span><span class="op" id="2835367">,</span>&nbsp;<span class="ident" id="2835369">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2835374">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2835377">debug</span><span class="op" id="2835382">.</span><span class="ident" id="2835383">Printf</span><span class="op" id="2835389">(</span><span class="string" id="2835390">&#34;parseAddress:&nbsp;not&nbsp;an&nbsp;addr-spec:&nbsp;%v&#34;</span><span class="op" id="2835426">,</span>&nbsp;<span class="ident" id="2835428">err</span><span class="op" id="2835431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2835434">debug</span><span class="op" id="2835439">.</span><span class="ident" id="2835440">Printf</span><span class="op" id="2835446">(</span><span class="string" id="2835447">&#34;parseAddress:&nbsp;state&nbsp;is&nbsp;now&nbsp;%q&#34;</span><span class="op" id="2835478">,</span>&nbsp;<span class="op" id="2835480">*</span><span class="ident" id="2835481">p</span><span class="op" id="2835482">)</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2835486">//&nbsp;display-name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2835503">var</span>&nbsp;<span class="ident" id="2835507">displayName</span>&nbsp;<span class="builtintype" id="2835519">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2835527">if</span>&nbsp;<span class="ident" id="2835530">p</span><span class="op" id="2835531">.</span><span class="ident" id="2835532">peek</span><span class="op" id="2835536">(</span><span class="op" id="2835537">)</span>&nbsp;<span class="op" id="2835539">!=</span>&nbsp;<span class="string" id="2835542">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="2835546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2835550">displayName</span><span class="op" id="2835561">,</span>&nbsp;<span class="ident" id="2835563">err</span>&nbsp;<span class="op" id="2835567">=</span>&nbsp;<span class="ident" id="2835569">p</span><span class="op" id="2835570">.</span><span class="ident" id="2835571">consumePhrase</span><span class="op" id="2835584">(</span><span class="op" id="2835585">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2835589">if</span>&nbsp;<span class="ident" id="2835592">err</span>&nbsp;<span class="op" id="2835596">!=</span>&nbsp;<span class="ident" id="2835599">nil</span>&nbsp;<span class="op" id="2835603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2835608">return</span>&nbsp;<span class="ident" id="2835615">nil</span><span class="op" id="2835618">,</span>&nbsp;<span class="ident" id="2835620">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2835626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2835629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2835632">debug</span><span class="op" id="2835637">.</span><span class="ident" id="2835638">Printf</span><span class="op" id="2835644">(</span><span class="string" id="2835645">&#34;parseAddress:&nbsp;displayName=%q&#34;</span><span class="op" id="2835675">,</span>&nbsp;<span class="ident" id="2835677">displayName</span><span class="op" id="2835688">)</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2835692">//&nbsp;angle-addr&nbsp;=&nbsp;&#34;&lt;&#34;&nbsp;addr-spec&nbsp;&#34;&gt;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2835727">p</span><span class="op" id="2835728">.</span><span class="ident" id="2835729">skipSpace</span><span class="op" id="2835738">(</span><span class="op" id="2835739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2835742">if</span>&nbsp;<span class="op" id="2835745">!</span><span class="ident" id="2835746">p</span><span class="op" id="2835747">.</span><span class="ident" id="2835748">consume</span><span class="op" id="2835755">(</span><span class="string" id="2835756">&#39;&lt;&#39;</span><span class="op" id="2835759">)</span>&nbsp;<span class="op" id="2835761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2835765">return</span>&nbsp;<span class="ident" id="2835772">nil</span><span class="op" id="2835775">,</span>&nbsp;<span class="ident" id="2835777">errors</span><span class="op" id="2835783">.</span><span class="ident" id="2835784">New</span><span class="op" id="2835787">(</span><span class="string" id="2835788">&#34;mail:&nbsp;no&nbsp;angle-addr&#34;</span><span class="op" id="2835809">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2835812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2835815">spec</span><span class="op" id="2835819">,</span>&nbsp;<span class="ident" id="2835821">err</span>&nbsp;<span class="op" id="2835825">=</span>&nbsp;<span class="ident" id="2835827">p</span><span class="op" id="2835828">.</span><span class="ident" id="2835829">consumeAddrSpec</span><span class="op" id="2835844">(</span><span class="op" id="2835845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2835848">if</span>&nbsp;<span class="ident" id="2835851">err</span>&nbsp;<span class="op" id="2835855">!=</span>&nbsp;<span class="ident" id="2835858">nil</span>&nbsp;<span class="op" id="2835862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2835866">return</span>&nbsp;<span class="ident" id="2835873">nil</span><span class="op" id="2835876">,</span>&nbsp;<span class="ident" id="2835878">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2835883">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2835886">if</span>&nbsp;<span class="op" id="2835889">!</span><span class="ident" id="2835890">p</span><span class="op" id="2835891">.</span><span class="ident" id="2835892">consume</span><span class="op" id="2835899">(</span><span class="string" id="2835900">&#39;&gt;&#39;</span><span class="op" id="2835903">)</span>&nbsp;<span class="op" id="2835905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2835909">return</span>&nbsp;<span class="ident" id="2835916">nil</span><span class="op" id="2835919">,</span>&nbsp;<span class="ident" id="2835921">errors</span><span class="op" id="2835927">.</span><span class="ident" id="2835928">New</span><span class="op" id="2835931">(</span><span class="string" id="2835932">&#34;mail:&nbsp;unclosed&nbsp;angle-addr&#34;</span><span class="op" id="2835959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2835962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2835965">debug</span><span class="op" id="2835970">.</span><span class="ident" id="2835971">Printf</span><span class="op" id="2835977">(</span><span class="string" id="2835978">&#34;parseAddress:&nbsp;spec=%q&#34;</span><span class="op" id="2836001">,</span>&nbsp;<span class="ident" id="2836003">spec</span><span class="op" id="2836007">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2836011">return</span>&nbsp;<span class="op" id="2836018">&amp;</span><span class="ident" id="2836019">Address</span><span class="op" id="2836026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2836030">Name</span><span class="op" id="2836034">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2836039">displayName</span><span class="op" id="2836050">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2836054">Address</span><span class="op" id="2836061">:</span>&nbsp;<span class="ident" id="2836063">spec</span><span class="op" id="2836067">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2836070">}</span><span class="op" id="2836071">,</span>&nbsp;<span class="ident" id="2836073">nil</span><br>
<span class="lineno"></span><span class="op" id="2836077">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="2836080">//&nbsp;consumeAddrSpec&nbsp;parses&nbsp;a&nbsp;single&nbsp;RFC&nbsp;5322&nbsp;addr-spec&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="2836153">func</span>&nbsp;<span class="op" id="2836158">(</span><span class="ident" id="2836159">p</span>&nbsp;<span class="op" id="2836161">*</span><span class="ident" id="2836162">addrParser</span><span class="op" id="2836172">)</span>&nbsp;<span class="ident" id="2836174">consumeAddrSpec</span><span class="op" id="2836189">(</span><span class="op" id="2836190">)</span>&nbsp;<span class="op" id="2836192">(</span><span class="ident" id="2836193">spec</span>&nbsp;<span class="builtintype" id="2836198">string</span><span class="op" id="2836204">,</span>&nbsp;<span class="ident" id="2836206">err</span>&nbsp;<span class="builtintype" id="2836210">error</span><span class="op" id="2836215">)</span>&nbsp;<span class="op" id="2836217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2836220">debug</span><span class="op" id="2836225">.</span><span class="ident" id="2836226">Printf</span><span class="op" id="2836232">(</span><span class="string" id="2836233">&#34;consumeAddrSpec:&nbsp;%q&#34;</span><span class="op" id="2836254">,</span>&nbsp;<span class="op" id="2836256">*</span><span class="ident" id="2836257">p</span><span class="op" id="2836258">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2836262">orig</span>&nbsp;<span class="op" id="2836267">:=</span>&nbsp;<span class="op" id="2836270">*</span><span class="ident" id="2836271">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2836274">defer</span>&nbsp;<span class="keyword" id="2836280">func</span><span class="op" id="2836284">(</span><span class="op" id="2836285">)</span>&nbsp;<span class="op" id="2836287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2836291">if</span>&nbsp;<span class="ident" id="2836294">err</span>&nbsp;<span class="op" id="2836298">!=</span>&nbsp;<span class="ident" id="2836301">nil</span>&nbsp;<span class="op" id="2836305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2836310">*</span><span class="ident" id="2836311">p</span>&nbsp;<span class="op" id="2836313">=</span>&nbsp;<span class="ident" id="2836315">orig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2836322">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2836325">}</span><span class="op" id="2836326">(</span><span class="op" id="2836327">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2836331">//&nbsp;local-part&nbsp;=&nbsp;dot-atom&nbsp;/&nbsp;quoted-string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2836373">var</span>&nbsp;<span class="ident" id="2836377">localPart</span>&nbsp;<span class="builtintype" id="2836387">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2836395">p</span><span class="op" id="2836396">.</span><span class="ident" id="2836397">skipSpace</span><span class="op" id="2836406">(</span><span class="op" id="2836407">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2836410">if</span>&nbsp;<span class="ident" id="2836413">p</span><span class="op" id="2836414">.</span><span class="ident" id="2836415">empty</span><span class="op" id="2836420">(</span><span class="op" id="2836421">)</span>&nbsp;<span class="op" id="2836423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2836427">return</span>&nbsp;<span class="string" id="2836434">&#34;&#34;</span><span class="op" id="2836436">,</span>&nbsp;<span class="ident" id="2836438">errors</span><span class="op" id="2836444">.</span><span class="ident" id="2836445">New</span><span class="op" id="2836448">(</span><span class="string" id="2836449">&#34;mail:&nbsp;no&nbsp;addr-spec&#34;</span><span class="op" id="2836469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2836472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2836475">if</span>&nbsp;<span class="ident" id="2836478">p</span><span class="op" id="2836479">.</span><span class="ident" id="2836480">peek</span><span class="op" id="2836484">(</span><span class="op" id="2836485">)</span>&nbsp;<span class="op" id="2836487">==</span>&nbsp;<span class="string" id="2836490">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="2836494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2836498">//&nbsp;quoted-string</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2836517">debug</span><span class="op" id="2836522">.</span><span class="ident" id="2836523">Printf</span><span class="op" id="2836529">(</span><span class="string" id="2836530">&#34;consumeAddrSpec:&nbsp;parsing&nbsp;quoted-string&#34;</span><span class="op" id="2836570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2836574">localPart</span><span class="op" id="2836583">,</span>&nbsp;<span class="ident" id="2836585">err</span>&nbsp;<span class="op" id="2836589">=</span>&nbsp;<span class="ident" id="2836591">p</span><span class="op" id="2836592">.</span><span class="ident" id="2836593">consumeQuotedString</span><span class="op" id="2836612">(</span><span class="op" id="2836613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2836616">}</span>&nbsp;<span class="keyword" id="2836618">else</span>&nbsp;<span class="op" id="2836623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2836627">//&nbsp;dot-atom</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2836641">debug</span><span class="op" id="2836646">.</span><span class="ident" id="2836647">Printf</span><span class="op" id="2836653">(</span><span class="string" id="2836654">&#34;consumeAddrSpec:&nbsp;parsing&nbsp;dot-atom&#34;</span><span class="op" id="2836689">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2836693">localPart</span><span class="op" id="2836702">,</span>&nbsp;<span class="ident" id="2836704">err</span>&nbsp;<span class="op" id="2836708">=</span>&nbsp;<span class="ident" id="2836710">p</span><span class="op" id="2836711">.</span><span class="ident" id="2836712">consumeAtom</span><span class="op" id="2836723">(</span><span class="builtintype" id="2836724">true</span><span class="op" id="2836728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2836731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2836734">if</span>&nbsp;<span class="ident" id="2836737">err</span>&nbsp;<span class="op" id="2836741">!=</span>&nbsp;<span class="ident" id="2836744">nil</span>&nbsp;<span class="op" id="2836748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2836752">debug</span><span class="op" id="2836757">.</span><span class="ident" id="2836758">Printf</span><span class="op" id="2836764">(</span><span class="string" id="2836765">&#34;consumeAddrSpec:&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="2836794">,</span>&nbsp;<span class="ident" id="2836796">err</span><span class="op" id="2836799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2836803">return</span>&nbsp;<span class="string" id="2836810">&#34;&#34;</span><span class="op" id="2836812">,</span>&nbsp;<span class="ident" id="2836814">err</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2836819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2836823">if</span>&nbsp;<span class="op" id="2836826">!</span><span class="ident" id="2836827">p</span><span class="op" id="2836828">.</span><span class="ident" id="2836829">consume</span><span class="op" id="2836836">(</span><span class="string" id="2836837">&#39;@&#39;</span><span class="op" id="2836840">)</span>&nbsp;<span class="op" id="2836842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2836846">return</span>&nbsp;<span class="string" id="2836853">&#34;&#34;</span><span class="op" id="2836855">,</span>&nbsp;<span class="ident" id="2836857">errors</span><span class="op" id="2836863">.</span><span class="ident" id="2836864">New</span><span class="op" id="2836867">(</span><span class="string" id="2836868">&#34;mail:&nbsp;missing&nbsp;@&nbsp;in&nbsp;addr-spec&#34;</span><span class="op" id="2836898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2836901">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2836905">//&nbsp;domain&nbsp;=&nbsp;dot-atom&nbsp;/&nbsp;domain-literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2836944">var</span>&nbsp;<span class="ident" id="2836948">domain</span>&nbsp;<span class="builtintype" id="2836955">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2836963">p</span><span class="op" id="2836964">.</span><span class="ident" id="2836965">skipSpace</span><span class="op" id="2836974">(</span><span class="op" id="2836975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2836978">if</span>&nbsp;<span class="ident" id="2836981">p</span><span class="op" id="2836982">.</span><span class="ident" id="2836983">empty</span><span class="op" id="2836988">(</span><span class="op" id="2836989">)</span>&nbsp;<span class="op" id="2836991">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2836995">return</span>&nbsp;<span class="string" id="2837002">&#34;&#34;</span><span class="op" id="2837004">,</span>&nbsp;<span class="ident" id="2837006">errors</span><span class="op" id="2837012">.</span><span class="ident" id="2837013">New</span><span class="op" id="2837016">(</span><span class="string" id="2837017">&#34;mail:&nbsp;no&nbsp;domain&nbsp;in&nbsp;addr-spec&#34;</span><span class="op" id="2837047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2837050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2837053">//&nbsp;TODO(dsymonds):&nbsp;Handle&nbsp;domain-literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2837095">domain</span><span class="op" id="2837101">,</span>&nbsp;<span class="ident" id="2837103">err</span>&nbsp;<span class="op" id="2837107">=</span>&nbsp;<span class="ident" id="2837109">p</span><span class="op" id="2837110">.</span><span class="ident" id="2837111">consumeAtom</span><span class="op" id="2837122">(</span><span class="builtintype" id="2837123">true</span><span class="op" id="2837127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2837130">if</span>&nbsp;<span class="ident" id="2837133">err</span>&nbsp;<span class="op" id="2837137">!=</span>&nbsp;<span class="ident" id="2837140">nil</span>&nbsp;<span class="op" id="2837144">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2837148">return</span>&nbsp;<span class="string" id="2837155">&#34;&#34;</span><span class="op" id="2837157">,</span>&nbsp;<span class="ident" id="2837159">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2837164">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2837168">return</span>&nbsp;<span class="ident" id="2837175">localPart</span>&nbsp;<span class="op" id="2837185">+</span>&nbsp;<span class="string" id="2837187">&#34;@&#34;</span>&nbsp;<span class="op" id="2837191">+</span>&nbsp;<span class="ident" id="2837193">domain</span><span class="op" id="2837199">,</span>&nbsp;<span class="ident" id="2837201">nil</span><br>
<span class="lineno"></span><span class="op" id="2837205">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span><span class="comment" id="2837208">//&nbsp;consumePhrase&nbsp;parses&nbsp;the&nbsp;RFC&nbsp;5322&nbsp;phrase&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="2837271">func</span>&nbsp;<span class="op" id="2837276">(</span><span class="ident" id="2837277">p</span>&nbsp;<span class="op" id="2837279">*</span><span class="ident" id="2837280">addrParser</span><span class="op" id="2837290">)</span>&nbsp;<span class="ident" id="2837292">consumePhrase</span><span class="op" id="2837305">(</span><span class="op" id="2837306">)</span>&nbsp;<span class="op" id="2837308">(</span><span class="ident" id="2837309">phrase</span>&nbsp;<span class="builtintype" id="2837316">string</span><span class="op" id="2837322">,</span>&nbsp;<span class="ident" id="2837324">err</span>&nbsp;<span class="builtintype" id="2837328">error</span><span class="op" id="2837333">)</span>&nbsp;<span class="op" id="2837335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2837338">debug</span><span class="op" id="2837343">.</span><span class="ident" id="2837344">Printf</span><span class="op" id="2837350">(</span><span class="string" id="2837351">&#34;consumePhrase:&nbsp;[%s]&#34;</span><span class="op" id="2837372">,</span>&nbsp;<span class="op" id="2837374">*</span><span class="ident" id="2837375">p</span><span class="op" id="2837376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2837379">//&nbsp;phrase&nbsp;=&nbsp;1*word</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2837399">var</span>&nbsp;<span class="ident" id="2837403">words</span>&nbsp;<span class="op" id="2837409">[</span><span class="op" id="2837410">]</span><span class="builtintype" id="2837411">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2837419">for</span>&nbsp;<span class="op" id="2837423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2837427">//&nbsp;word&nbsp;=&nbsp;atom&nbsp;/&nbsp;quoted-string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2837460">var</span>&nbsp;<span class="ident" id="2837464">word</span>&nbsp;<span class="builtintype" id="2837469">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2837478">p</span><span class="op" id="2837479">.</span><span class="ident" id="2837480">skipSpace</span><span class="op" id="2837489">(</span><span class="op" id="2837490">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2837494">if</span>&nbsp;<span class="ident" id="2837497">p</span><span class="op" id="2837498">.</span><span class="ident" id="2837499">empty</span><span class="op" id="2837504">(</span><span class="op" id="2837505">)</span>&nbsp;<span class="op" id="2837507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2837512">return</span>&nbsp;<span class="string" id="2837519">&#34;&#34;</span><span class="op" id="2837521">,</span>&nbsp;<span class="ident" id="2837523">errors</span><span class="op" id="2837529">.</span><span class="ident" id="2837530">New</span><span class="op" id="2837533">(</span><span class="string" id="2837534">&#34;mail:&nbsp;missing&nbsp;phrase&#34;</span><span class="op" id="2837556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2837560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2837564">if</span>&nbsp;<span class="ident" id="2837567">p</span><span class="op" id="2837568">.</span><span class="ident" id="2837569">peek</span><span class="op" id="2837573">(</span><span class="op" id="2837574">)</span>&nbsp;<span class="op" id="2837576">==</span>&nbsp;<span class="string" id="2837579">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="2837583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2837588">//&nbsp;quoted-string</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2837608">word</span><span class="op" id="2837612">,</span>&nbsp;<span class="ident" id="2837614">err</span>&nbsp;<span class="op" id="2837618">=</span>&nbsp;<span class="ident" id="2837620">p</span><span class="op" id="2837621">.</span><span class="ident" id="2837622">consumeQuotedString</span><span class="op" id="2837641">(</span><span class="op" id="2837642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2837646">}</span>&nbsp;<span class="keyword" id="2837648">else</span>&nbsp;<span class="op" id="2837653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2837658">//&nbsp;atom</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2837669">//&nbsp;We&nbsp;actually&nbsp;parse&nbsp;dot-atom&nbsp;here&nbsp;to&nbsp;be&nbsp;more&nbsp;permissive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2837729">//&nbsp;than&nbsp;what&nbsp;RFC&nbsp;5322&nbsp;specifies.</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2837765">word</span><span class="op" id="2837769">,</span>&nbsp;<span class="ident" id="2837771">err</span>&nbsp;<span class="op" id="2837775">=</span>&nbsp;<span class="ident" id="2837777">p</span><span class="op" id="2837778">.</span><span class="ident" id="2837779">consumeAtom</span><span class="op" id="2837790">(</span><span class="builtintype" id="2837791">true</span><span class="op" id="2837795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2837799">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2837804">//&nbsp;RFC&nbsp;2047&nbsp;encoded-word&nbsp;starts&nbsp;with&nbsp;=?,&nbsp;ends&nbsp;with&nbsp;?=,&nbsp;and&nbsp;has&nbsp;two&nbsp;other&nbsp;?s.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2837883">if</span>&nbsp;<span class="ident" id="2837886">err</span>&nbsp;<span class="op" id="2837890">==</span>&nbsp;<span class="ident" id="2837893">nil</span>&nbsp;<span class="op" id="2837897">&amp;&amp;</span>&nbsp;<span class="ident" id="2837900">strings</span><span class="op" id="2837907">.</span><span class="ident" id="2837908">HasPrefix</span><span class="op" id="2837917">(</span><span class="ident" id="2837918">word</span><span class="op" id="2837922">,</span>&nbsp;<span class="string" id="2837924">&#34;=?&#34;</span><span class="op" id="2837928">)</span>&nbsp;<span class="op" id="2837930">&amp;&amp;</span>&nbsp;<span class="ident" id="2837933">strings</span><span class="op" id="2837940">.</span><span class="ident" id="2837941">HasSuffix</span><span class="op" id="2837950">(</span><span class="ident" id="2837951">word</span><span class="op" id="2837955">,</span>&nbsp;<span class="string" id="2837957">&#34;?=&#34;</span><span class="op" id="2837961">)</span>&nbsp;<span class="op" id="2837963">&amp;&amp;</span>&nbsp;<span class="ident" id="2837966">strings</span><span class="op" id="2837973">.</span><span class="ident" id="2837974">Count</span><span class="op" id="2837979">(</span><span class="ident" id="2837980">word</span><span class="op" id="2837984">,</span>&nbsp;<span class="string" id="2837986">&#34;?&#34;</span><span class="op" id="2837989">)</span>&nbsp;<span class="op" id="2837991">==</span>&nbsp;<span class="num" id="2837994">4</span>&nbsp;<span class="op" id="2837996">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2838001">word</span><span class="op" id="2838005">,</span>&nbsp;<span class="ident" id="2838007">err</span>&nbsp;<span class="op" id="2838011">=</span>&nbsp;<span class="ident" id="2838013">decodeRFC2047Word</span><span class="op" id="2838030">(</span><span class="ident" id="2838031">word</span><span class="op" id="2838035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2838039">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2838044">if</span>&nbsp;<span class="ident" id="2838047">err</span>&nbsp;<span class="op" id="2838051">!=</span>&nbsp;<span class="ident" id="2838054">nil</span>&nbsp;<span class="op" id="2838058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2838063">break</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2838071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2838075">debug</span><span class="op" id="2838080">.</span><span class="ident" id="2838081">Printf</span><span class="op" id="2838087">(</span><span class="string" id="2838088">&#34;consumePhrase:&nbsp;consumed&nbsp;%q&#34;</span><span class="op" id="2838116">,</span>&nbsp;<span class="ident" id="2838118">word</span><span class="op" id="2838122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2838126">words</span>&nbsp;<span class="op" id="2838132">=</span>&nbsp;<span class="builtinfunc" id="2838134">append</span><span class="op" id="2838140">(</span><span class="ident" id="2838141">words</span><span class="op" id="2838146">,</span>&nbsp;<span class="ident" id="2838148">word</span><span class="op" id="2838152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2838155">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2838158">//&nbsp;Ignore&nbsp;any&nbsp;error&nbsp;if&nbsp;we&nbsp;got&nbsp;at&nbsp;least&nbsp;one&nbsp;word.</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2838208">if</span>&nbsp;<span class="ident" id="2838211">err</span>&nbsp;<span class="op" id="2838215">!=</span>&nbsp;<span class="ident" id="2838218">nil</span>&nbsp;<span class="op" id="2838222">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="2838225">len</span><span class="op" id="2838228">(</span><span class="ident" id="2838229">words</span><span class="op" id="2838234">)</span>&nbsp;<span class="op" id="2838236">==</span>&nbsp;<span class="num" id="2838239">0</span>&nbsp;<span class="op" id="2838241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2838245">debug</span><span class="op" id="2838250">.</span><span class="ident" id="2838251">Printf</span><span class="op" id="2838257">(</span><span class="string" id="2838258">&#34;consumePhrase:&nbsp;hit&nbsp;err:&nbsp;%v&#34;</span><span class="op" id="2838286">,</span>&nbsp;<span class="ident" id="2838288">err</span><span class="op" id="2838291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2838295">return</span>&nbsp;<span class="string" id="2838302">&#34;&#34;</span><span class="op" id="2838304">,</span>&nbsp;<span class="ident" id="2838306">fmt</span><span class="op" id="2838309">.</span><span class="ident" id="2838310">Errorf</span><span class="op" id="2838316">(</span><span class="string" id="2838317">&#34;mail:&nbsp;missing&nbsp;word&nbsp;in&nbsp;phrase:&nbsp;%v&#34;</span><span class="op" id="2838351">,</span>&nbsp;<span class="ident" id="2838353">err</span><span class="op" id="2838356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2838359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2838362">phrase</span>&nbsp;<span class="op" id="2838369">=</span>&nbsp;<span class="ident" id="2838371">strings</span><span class="op" id="2838378">.</span><span class="ident" id="2838379">Join</span><span class="op" id="2838383">(</span><span class="ident" id="2838384">words</span><span class="op" id="2838389">,</span>&nbsp;<span class="string" id="2838391">&#34;&nbsp;&#34;</span><span class="op" id="2838394">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2838397">return</span>&nbsp;<span class="ident" id="2838404">phrase</span><span class="op" id="2838410">,</span>&nbsp;<span class="ident" id="2838412">nil</span><br>
<span class="lineno"></span><span class="op" id="2838416">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2838419">//&nbsp;consumeQuotedString&nbsp;parses&nbsp;the&nbsp;quoted&nbsp;string&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="2838486">func</span>&nbsp;<span class="op" id="2838491">(</span><span class="ident" id="2838492">p</span>&nbsp;<span class="op" id="2838494">*</span><span class="ident" id="2838495">addrParser</span><span class="op" id="2838505">)</span>&nbsp;<span class="ident" id="2838507">consumeQuotedString</span><span class="op" id="2838526">(</span><span class="op" id="2838527">)</span>&nbsp;<span class="op" id="2838529">(</span><span class="ident" id="2838530">qs</span>&nbsp;<span class="builtintype" id="2838533">string</span><span class="op" id="2838539">,</span>&nbsp;<span class="ident" id="2838541">err</span>&nbsp;<span class="builtintype" id="2838545">error</span><span class="op" id="2838550">)</span>&nbsp;<span class="op" id="2838552">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2838555">//&nbsp;Assume&nbsp;first&nbsp;byte&nbsp;is&nbsp;&#39;&#34;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2838585">i</span>&nbsp;<span class="op" id="2838587">:=</span>&nbsp;<span class="num" id="2838590">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2838593">qsb</span>&nbsp;<span class="op" id="2838597">:=</span>&nbsp;<span class="builtinfunc" id="2838600">make</span><span class="op" id="2838604">(</span><span class="op" id="2838605">[</span><span class="op" id="2838606">]</span><span class="builtintype" id="2838607">byte</span><span class="op" id="2838611">,</span>&nbsp;<span class="num" id="2838613">0</span><span class="op" id="2838614">,</span>&nbsp;<span class="num" id="2838616">10</span><span class="op" id="2838618">)</span><br>
<span class="lineno"></span><span class="ident" id="2838620">Loop</span><span class="op" id="2838624">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2838627">for</span>&nbsp;<span class="op" id="2838631">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2838635">if</span>&nbsp;<span class="ident" id="2838638">i</span>&nbsp;<span class="op" id="2838640">&gt;=</span>&nbsp;<span class="ident" id="2838643">p</span><span class="op" id="2838644">.</span><span class="builtinfunc" id="2838645">len</span><span class="op" id="2838648">(</span><span class="op" id="2838649">)</span>&nbsp;<span class="op" id="2838651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2838656">return</span>&nbsp;<span class="string" id="2838663">&#34;&#34;</span><span class="op" id="2838665">,</span>&nbsp;<span class="ident" id="2838667">errors</span><span class="op" id="2838673">.</span><span class="ident" id="2838674">New</span><span class="op" id="2838677">(</span><span class="string" id="2838678">&#34;mail:&nbsp;unclosed&nbsp;quoted-string&#34;</span><span class="op" id="2838708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2838712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2838716">switch</span>&nbsp;<span class="ident" id="2838723">c</span>&nbsp;<span class="op" id="2838725">:=</span>&nbsp;<span class="op" id="2838728">(</span><span class="op" id="2838729">*</span><span class="ident" id="2838730">p</span><span class="op" id="2838731">)</span><span class="op" id="2838732">[</span><span class="ident" id="2838733">i</span><span class="op" id="2838734">]</span><span class="op" id="2838735">;</span>&nbsp;<span class="op" id="2838737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2838741">case</span>&nbsp;<span class="ident" id="2838746">c</span>&nbsp;<span class="op" id="2838748">==</span>&nbsp;<span class="string" id="2838751">&#39;&#34;&#39;</span><span class="op" id="2838754">:</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2838759">break</span>&nbsp;<span class="ident" id="2838765">Loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2838772">case</span>&nbsp;<span class="ident" id="2838777">c</span>&nbsp;<span class="op" id="2838779">==</span>&nbsp;<span class="string" id="2838782">&#39;\\&#39;</span><span class="op" id="2838786">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2838791">if</span>&nbsp;<span class="ident" id="2838794">i</span><span class="op" id="2838795">+</span><span class="num" id="2838796">1</span>&nbsp;<span class="op" id="2838798">==</span>&nbsp;<span class="ident" id="2838801">p</span><span class="op" id="2838802">.</span><span class="builtinfunc" id="2838803">len</span><span class="op" id="2838806">(</span><span class="op" id="2838807">)</span>&nbsp;<span class="op" id="2838809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2838815">return</span>&nbsp;<span class="string" id="2838822">&#34;&#34;</span><span class="op" id="2838824">,</span>&nbsp;<span class="ident" id="2838826">errors</span><span class="op" id="2838832">.</span><span class="ident" id="2838833">New</span><span class="op" id="2838836">(</span><span class="string" id="2838837">&#34;mail:&nbsp;unclosed&nbsp;quoted-string&#34;</span><span class="op" id="2838867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2838872">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2838877">qsb</span>&nbsp;<span class="op" id="2838881">=</span>&nbsp;<span class="builtinfunc" id="2838883">append</span><span class="op" id="2838889">(</span><span class="ident" id="2838890">qsb</span><span class="op" id="2838893">,</span>&nbsp;<span class="op" id="2838895">(</span><span class="op" id="2838896">*</span><span class="ident" id="2838897">p</span><span class="op" id="2838898">)</span><span class="op" id="2838899">[</span><span class="ident" id="2838900">i</span><span class="op" id="2838901">+</span><span class="num" id="2838902">1</span><span class="op" id="2838903">]</span><span class="op" id="2838904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2838909">i</span>&nbsp;<span class="op" id="2838911">+=</span>&nbsp;<span class="num" id="2838914">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2838918">case</span>&nbsp;<span class="ident" id="2838923">isQtext</span><span class="op" id="2838930">(</span><span class="ident" id="2838931">c</span><span class="op" id="2838932">)</span><span class="op" id="2838933">,</span>&nbsp;<span class="ident" id="2838935">c</span>&nbsp;<span class="op" id="2838937">==</span>&nbsp;<span class="string" id="2838940">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="2838944">||</span>&nbsp;<span class="ident" id="2838947">c</span>&nbsp;<span class="op" id="2838949">==</span>&nbsp;<span class="string" id="2838952">&#39;\t&#39;</span><span class="op" id="2838956">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2838961">//&nbsp;qtext&nbsp;(printable&nbsp;US-ASCII&nbsp;excluding&nbsp;&#34;&nbsp;and&nbsp;\),&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2839016">//&nbsp;FWS&nbsp;(almost;&nbsp;we&#39;re&nbsp;ignoring&nbsp;CRLF)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2839056">qsb</span>&nbsp;<span class="op" id="2839060">=</span>&nbsp;<span class="builtinfunc" id="2839062">append</span><span class="op" id="2839068">(</span><span class="ident" id="2839069">qsb</span><span class="op" id="2839072">,</span>&nbsp;<span class="ident" id="2839074">c</span><span class="op" id="2839075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2839080">i</span><span class="op" id="2839081">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2839086">default</span><span class="op" id="2839093">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2839098">return</span>&nbsp;<span class="string" id="2839105">&#34;&#34;</span><span class="op" id="2839107">,</span>&nbsp;<span class="ident" id="2839109">fmt</span><span class="op" id="2839112">.</span><span class="ident" id="2839113">Errorf</span><span class="op" id="2839119">(</span><span class="string" id="2839120">&#34;mail:&nbsp;bad&nbsp;character&nbsp;in&nbsp;quoted-string:&nbsp;%q&#34;</span><span class="op" id="2839162">,</span>&nbsp;<span class="ident" id="2839164">c</span><span class="op" id="2839165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2839169">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2839172">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2839175">*</span><span class="ident" id="2839176">p</span>&nbsp;<span class="op" id="2839178">=</span>&nbsp;<span class="op" id="2839180">(</span><span class="op" id="2839181">*</span><span class="ident" id="2839182">p</span><span class="op" id="2839183">)</span><span class="op" id="2839184">[</span><span class="ident" id="2839185">i</span><span class="op" id="2839186">+</span><span class="num" id="2839187">1</span><span class="op" id="2839188">:</span><span class="op" id="2839189">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2839192">return</span>&nbsp;<span class="builtintype" id="2839199">string</span><span class="op" id="2839205">(</span><span class="ident" id="2839206">qsb</span><span class="op" id="2839209">)</span><span class="op" id="2839210">,</span>&nbsp;<span class="ident" id="2839212">nil</span><br>
<span class="lineno"></span><span class="op" id="2839216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="comment" id="2839219">//&nbsp;consumeAtom&nbsp;parses&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;atom&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="comment" id="2839277">//&nbsp;If&nbsp;dot&nbsp;is&nbsp;true,&nbsp;consumeAtom&nbsp;parses&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;dot-atom&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="2839345">func</span>&nbsp;<span class="op" id="2839350">(</span><span class="ident" id="2839351">p</span>&nbsp;<span class="op" id="2839353">*</span><span class="ident" id="2839354">addrParser</span><span class="op" id="2839364">)</span>&nbsp;<span class="ident" id="2839366">consumeAtom</span><span class="op" id="2839377">(</span><span class="ident" id="2839378">dot</span>&nbsp;<span class="builtintype" id="2839382">bool</span><span class="op" id="2839386">)</span>&nbsp;<span class="op" id="2839388">(</span><span class="ident" id="2839389">atom</span>&nbsp;<span class="builtintype" id="2839394">string</span><span class="op" id="2839400">,</span>&nbsp;<span class="ident" id="2839402">err</span>&nbsp;<span class="builtintype" id="2839406">error</span><span class="op" id="2839411">)</span>&nbsp;<span class="op" id="2839413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2839416">if</span>&nbsp;<span class="op" id="2839419">!</span><span class="ident" id="2839420">isAtext</span><span class="op" id="2839427">(</span><span class="ident" id="2839428">p</span><span class="op" id="2839429">.</span><span class="ident" id="2839430">peek</span><span class="op" id="2839434">(</span><span class="op" id="2839435">)</span><span class="op" id="2839436">,</span>&nbsp;<span class="builtintype" id="2839438">false</span><span class="op" id="2839443">)</span>&nbsp;<span class="op" id="2839445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2839449">return</span>&nbsp;<span class="string" id="2839456">&#34;&#34;</span><span class="op" id="2839458">,</span>&nbsp;<span class="ident" id="2839460">errors</span><span class="op" id="2839466">.</span><span class="ident" id="2839467">New</span><span class="op" id="2839470">(</span><span class="string" id="2839471">&#34;mail:&nbsp;invalid&nbsp;string&#34;</span><span class="op" id="2839493">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2839496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2839499">i</span>&nbsp;<span class="op" id="2839501">:=</span>&nbsp;<span class="num" id="2839504">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2839507">for</span>&nbsp;<span class="op" id="2839511">;</span>&nbsp;<span class="ident" id="2839513">i</span>&nbsp;<span class="op" id="2839515">&lt;</span>&nbsp;<span class="ident" id="2839517">p</span><span class="op" id="2839518">.</span><span class="builtinfunc" id="2839519">len</span><span class="op" id="2839522">(</span><span class="op" id="2839523">)</span>&nbsp;<span class="op" id="2839525">&amp;&amp;</span>&nbsp;<span class="ident" id="2839528">isAtext</span><span class="op" id="2839535">(</span><span class="op" id="2839536">(</span><span class="op" id="2839537">*</span><span class="ident" id="2839538">p</span><span class="op" id="2839539">)</span><span class="op" id="2839540">[</span><span class="ident" id="2839541">i</span><span class="op" id="2839542">]</span><span class="op" id="2839543">,</span>&nbsp;<span class="ident" id="2839545">dot</span><span class="op" id="2839548">)</span><span class="op" id="2839549">;</span>&nbsp;<span class="ident" id="2839551">i</span><span class="op" id="2839552">++</span>&nbsp;<span class="op" id="2839555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2839558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2839561">atom</span><span class="op" id="2839565">,</span>&nbsp;<span class="op" id="2839567">*</span><span class="ident" id="2839568">p</span>&nbsp;<span class="op" id="2839570">=</span>&nbsp;<span class="builtintype" id="2839572">string</span><span class="op" id="2839578">(</span><span class="op" id="2839579">(</span><span class="op" id="2839580">*</span><span class="ident" id="2839581">p</span><span class="op" id="2839582">)</span><span class="op" id="2839583">[</span><span class="op" id="2839584">:</span><span class="ident" id="2839585">i</span><span class="op" id="2839586">]</span><span class="op" id="2839587">)</span><span class="op" id="2839588">,</span>&nbsp;<span class="op" id="2839590">(</span><span class="op" id="2839591">*</span><span class="ident" id="2839592">p</span><span class="op" id="2839593">)</span><span class="op" id="2839594">[</span><span class="ident" id="2839595">i</span><span class="op" id="2839596">:</span><span class="op" id="2839597">]</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2839600">return</span>&nbsp;<span class="ident" id="2839607">atom</span><span class="op" id="2839611">,</span>&nbsp;<span class="ident" id="2839613">nil</span><br>
<span class="lineno"></span><span class="op" id="2839617">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2839620">func</span>&nbsp;<span class="op" id="2839625">(</span><span class="ident" id="2839626">p</span>&nbsp;<span class="op" id="2839628">*</span><span class="ident" id="2839629">addrParser</span><span class="op" id="2839639">)</span>&nbsp;<span class="ident" id="2839641">consume</span><span class="op" id="2839648">(</span><span class="ident" id="2839649">c</span>&nbsp;<span class="builtintype" id="2839651">byte</span><span class="op" id="2839655">)</span>&nbsp;<span class="builtintype" id="2839657">bool</span>&nbsp;<span class="op" id="2839662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2839665">if</span>&nbsp;<span class="ident" id="2839668">p</span><span class="op" id="2839669">.</span><span class="ident" id="2839670">empty</span><span class="op" id="2839675">(</span><span class="op" id="2839676">)</span>&nbsp;<span class="op" id="2839678">||</span>&nbsp;<span class="ident" id="2839681">p</span><span class="op" id="2839682">.</span><span class="ident" id="2839683">peek</span><span class="op" id="2839687">(</span><span class="op" id="2839688">)</span>&nbsp;<span class="op" id="2839690">!=</span>&nbsp;<span class="ident" id="2839693">c</span>&nbsp;<span class="op" id="2839695">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2839699">return</span>&nbsp;<span class="builtintype" id="2839706">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2839713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2839716">*</span><span class="ident" id="2839717">p</span>&nbsp;<span class="op" id="2839719">=</span>&nbsp;<span class="op" id="2839721">(</span><span class="op" id="2839722">*</span><span class="ident" id="2839723">p</span><span class="op" id="2839724">)</span><span class="op" id="2839725">[</span><span class="num" id="2839726">1</span><span class="op" id="2839727">:</span><span class="op" id="2839728">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2839731">return</span>&nbsp;<span class="builtintype" id="2839738">true</span><br>
<span class="lineno"></span><span class="op" id="2839743">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="comment" id="2839746">//&nbsp;skipSpace&nbsp;skips&nbsp;the&nbsp;leading&nbsp;space&nbsp;and&nbsp;tab&nbsp;characters.</span><br>
<span class="lineno"></span><span class="keyword" id="2839803">func</span>&nbsp;<span class="op" id="2839808">(</span><span class="ident" id="2839809">p</span>&nbsp;<span class="op" id="2839811">*</span><span class="ident" id="2839812">addrParser</span><span class="op" id="2839822">)</span>&nbsp;<span class="ident" id="2839824">skipSpace</span><span class="op" id="2839833">(</span><span class="op" id="2839834">)</span>&nbsp;<span class="op" id="2839836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2839839">*</span><span class="ident" id="2839840">p</span>&nbsp;<span class="op" id="2839842">=</span>&nbsp;<span class="ident" id="2839844">bytes</span><span class="op" id="2839849">.</span><span class="ident" id="2839850">TrimLeft</span><span class="op" id="2839858">(</span><span class="op" id="2839859">*</span><span class="ident" id="2839860">p</span><span class="op" id="2839861">,</span>&nbsp;<span class="string" id="2839863">&#34;&nbsp;\t&#34;</span><span class="op" id="2839868">)</span><br>
<span class="lineno"></span><span class="op" id="2839870">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="2839873">func</span>&nbsp;<span class="op" id="2839878">(</span><span class="ident" id="2839879">p</span>&nbsp;<span class="op" id="2839881">*</span><span class="ident" id="2839882">addrParser</span><span class="op" id="2839892">)</span>&nbsp;<span class="ident" id="2839894">peek</span><span class="op" id="2839898">(</span><span class="op" id="2839899">)</span>&nbsp;<span class="builtintype" id="2839901">byte</span>&nbsp;<span class="op" id="2839906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2839909">return</span>&nbsp;<span class="op" id="2839916">(</span><span class="op" id="2839917">*</span><span class="ident" id="2839918">p</span><span class="op" id="2839919">)</span><span class="op" id="2839920">[</span><span class="num" id="2839921">0</span><span class="op" id="2839922">]</span><br>
<span class="lineno"></span><span class="op" id="2839924">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="keyword" id="2839927">func</span>&nbsp;<span class="op" id="2839932">(</span><span class="ident" id="2839933">p</span>&nbsp;<span class="op" id="2839935">*</span><span class="ident" id="2839936">addrParser</span><span class="op" id="2839946">)</span>&nbsp;<span class="ident" id="2839948">empty</span><span class="op" id="2839953">(</span><span class="op" id="2839954">)</span>&nbsp;<span class="builtintype" id="2839956">bool</span>&nbsp;<span class="op" id="2839961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2839964">return</span>&nbsp;<span class="ident" id="2839971">p</span><span class="op" id="2839972">.</span><span class="builtinfunc" id="2839973">len</span><span class="op" id="2839976">(</span><span class="op" id="2839977">)</span>&nbsp;<span class="op" id="2839979">==</span>&nbsp;<span class="num" id="2839982">0</span><br>
<span class="lineno"></span><span class="op" id="2839984">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2839987">func</span>&nbsp;<span class="op" id="2839992">(</span><span class="ident" id="2839993">p</span>&nbsp;<span class="op" id="2839995">*</span><span class="ident" id="2839996">addrParser</span><span class="op" id="2840006">)</span>&nbsp;<span class="builtinfunc" id="2840008">len</span><span class="op" id="2840011">(</span><span class="op" id="2840012">)</span>&nbsp;<span class="builtintype" id="2840014">int</span>&nbsp;<span class="op" id="2840018">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2840021">return</span>&nbsp;<span class="builtinfunc" id="2840028">len</span><span class="op" id="2840031">(</span><span class="op" id="2840032">*</span><span class="ident" id="2840033">p</span><span class="op" id="2840034">)</span><br>
<span class="lineno"></span><span class="op" id="2840036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2840039">func</span>&nbsp;<span class="ident" id="2840044">decodeRFC2047Word</span><span class="op" id="2840061">(</span><span class="ident" id="2840062">s</span>&nbsp;<span class="builtintype" id="2840064">string</span><span class="op" id="2840070">)</span>&nbsp;<span class="op" id="2840072">(</span><span class="builtintype" id="2840073">string</span><span class="op" id="2840079">,</span>&nbsp;<span class="builtintype" id="2840081">error</span><span class="op" id="2840086">)</span>&nbsp;<span class="op" id="2840088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2840091">fields</span>&nbsp;<span class="op" id="2840098">:=</span>&nbsp;<span class="ident" id="2840101">strings</span><span class="op" id="2840108">.</span><span class="ident" id="2840109">Split</span><span class="op" id="2840114">(</span><span class="ident" id="2840115">s</span><span class="op" id="2840116">,</span>&nbsp;<span class="string" id="2840118">&#34;?&#34;</span><span class="op" id="2840121">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2840124">if</span>&nbsp;<span class="builtinfunc" id="2840127">len</span><span class="op" id="2840130">(</span><span class="ident" id="2840131">fields</span><span class="op" id="2840137">)</span>&nbsp;<span class="op" id="2840139">!=</span>&nbsp;<span class="num" id="2840142">5</span>&nbsp;<span class="op" id="2840144">||</span>&nbsp;<span class="ident" id="2840147">fields</span><span class="op" id="2840153">[</span><span class="num" id="2840154">0</span><span class="op" id="2840155">]</span>&nbsp;<span class="op" id="2840157">!=</span>&nbsp;<span class="string" id="2840160">&#34;=&#34;</span>&nbsp;<span class="op" id="2840164">||</span>&nbsp;<span class="ident" id="2840167">fields</span><span class="op" id="2840173">[</span><span class="num" id="2840174">4</span><span class="op" id="2840175">]</span>&nbsp;<span class="op" id="2840177">!=</span>&nbsp;<span class="string" id="2840180">&#34;=&#34;</span>&nbsp;<span class="op" id="2840184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2840188">return</span>&nbsp;<span class="string" id="2840195">&#34;&#34;</span><span class="op" id="2840197">,</span>&nbsp;<span class="ident" id="2840199">errors</span><span class="op" id="2840205">.</span><span class="ident" id="2840206">New</span><span class="op" id="2840209">(</span><span class="string" id="2840210">&#34;address&nbsp;not&nbsp;RFC&nbsp;2047&nbsp;encoded&#34;</span><span class="op" id="2840240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2840243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2840246">charset</span><span class="op" id="2840253">,</span>&nbsp;<span class="ident" id="2840255">enc</span>&nbsp;<span class="op" id="2840259">:=</span>&nbsp;<span class="ident" id="2840262">strings</span><span class="op" id="2840269">.</span><span class="ident" id="2840270">ToLower</span><span class="op" id="2840277">(</span><span class="ident" id="2840278">fields</span><span class="op" id="2840284">[</span><span class="num" id="2840285">1</span><span class="op" id="2840286">]</span><span class="op" id="2840287">)</span><span class="op" id="2840288">,</span>&nbsp;<span class="ident" id="2840290">strings</span><span class="op" id="2840297">.</span><span class="ident" id="2840298">ToLower</span><span class="op" id="2840305">(</span><span class="ident" id="2840306">fields</span><span class="op" id="2840312">[</span><span class="num" id="2840313">2</span><span class="op" id="2840314">]</span><span class="op" id="2840315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2840318">if</span>&nbsp;<span class="ident" id="2840321">charset</span>&nbsp;<span class="op" id="2840329">!=</span>&nbsp;<span class="string" id="2840332">&#34;us-ascii&#34;</span>&nbsp;<span class="op" id="2840343">&amp;&amp;</span>&nbsp;<span class="ident" id="2840346">charset</span>&nbsp;<span class="op" id="2840354">!=</span>&nbsp;<span class="string" id="2840357">&#34;iso-8859-1&#34;</span>&nbsp;<span class="op" id="2840370">&amp;&amp;</span>&nbsp;<span class="ident" id="2840373">charset</span>&nbsp;<span class="op" id="2840381">!=</span>&nbsp;<span class="string" id="2840384">&#34;utf-8&#34;</span>&nbsp;<span class="op" id="2840392">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2840396">return</span>&nbsp;<span class="string" id="2840403">&#34;&#34;</span><span class="op" id="2840405">,</span>&nbsp;<span class="ident" id="2840407">fmt</span><span class="op" id="2840410">.</span><span class="ident" id="2840411">Errorf</span><span class="op" id="2840417">(</span><span class="string" id="2840418">&#34;charset&nbsp;not&nbsp;supported:&nbsp;%q&#34;</span><span class="op" id="2840445">,</span>&nbsp;<span class="ident" id="2840447">charset</span><span class="op" id="2840454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2840457">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2840461">in</span>&nbsp;<span class="op" id="2840464">:=</span>&nbsp;<span class="ident" id="2840467">bytes</span><span class="op" id="2840472">.</span><span class="ident" id="2840473">NewBufferString</span><span class="op" id="2840488">(</span><span class="ident" id="2840489">fields</span><span class="op" id="2840495">[</span><span class="num" id="2840496">3</span><span class="op" id="2840497">]</span><span class="op" id="2840498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2840501">var</span>&nbsp;<span class="ident" id="2840505">r</span>&nbsp;<span class="ident" id="2840507">io</span><span class="op" id="2840509">.</span><span class="ident" id="2840510">Reader</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2840518">switch</span>&nbsp;<span class="ident" id="2840525">enc</span>&nbsp;<span class="op" id="2840529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2840532">case</span>&nbsp;<span class="string" id="2840537">&#34;b&#34;</span><span class="op" id="2840540">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2840544">r</span>&nbsp;<span class="op" id="2840546">=</span>&nbsp;<span class="ident" id="2840548">base64</span><span class="op" id="2840554">.</span><span class="ident" id="2840555">NewDecoder</span><span class="op" id="2840565">(</span><span class="ident" id="2840566">base64</span><span class="op" id="2840572">.</span><span class="ident" id="2840573">StdEncoding</span><span class="op" id="2840584">,</span>&nbsp;<span class="ident" id="2840586">in</span><span class="op" id="2840588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2840591">case</span>&nbsp;<span class="string" id="2840596">&#34;q&#34;</span><span class="op" id="2840599">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2840603">r</span>&nbsp;<span class="op" id="2840605">=</span>&nbsp;<span class="ident" id="2840607">qDecoder</span><span class="op" id="2840615">{</span><span class="ident" id="2840616">r</span><span class="op" id="2840617">:</span>&nbsp;<span class="ident" id="2840619">in</span><span class="op" id="2840621">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2840624">default</span><span class="op" id="2840631">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2840635">return</span>&nbsp;<span class="string" id="2840642">&#34;&#34;</span><span class="op" id="2840644">,</span>&nbsp;<span class="ident" id="2840646">fmt</span><span class="op" id="2840649">.</span><span class="ident" id="2840650">Errorf</span><span class="op" id="2840656">(</span><span class="string" id="2840657">&#34;RFC&nbsp;2047&nbsp;encoding&nbsp;not&nbsp;supported:&nbsp;%q&#34;</span><span class="op" id="2840694">,</span>&nbsp;<span class="ident" id="2840696">enc</span><span class="op" id="2840699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2840702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2840706">dec</span><span class="op" id="2840709">,</span>&nbsp;<span class="ident" id="2840711">err</span>&nbsp;<span class="op" id="2840715">:=</span>&nbsp;<span class="ident" id="2840718">ioutil</span><span class="op" id="2840724">.</span><span class="ident" id="2840725">ReadAll</span><span class="op" id="2840732">(</span><span class="ident" id="2840733">r</span><span class="op" id="2840734">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2840737">if</span>&nbsp;<span class="ident" id="2840740">err</span>&nbsp;<span class="op" id="2840744">!=</span>&nbsp;<span class="ident" id="2840747">nil</span>&nbsp;<span class="op" id="2840751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2840755">return</span>&nbsp;<span class="string" id="2840762">&#34;&#34;</span><span class="op" id="2840764">,</span>&nbsp;<span class="ident" id="2840766">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2840771">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2840775">switch</span>&nbsp;<span class="ident" id="2840782">charset</span>&nbsp;<span class="op" id="2840790">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2840793">case</span>&nbsp;<span class="string" id="2840798">&#34;us-ascii&#34;</span><span class="op" id="2840808">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2840812">b</span>&nbsp;<span class="op" id="2840814">:=</span>&nbsp;<span class="builtinfunc" id="2840817">new</span><span class="op" id="2840820">(</span><span class="ident" id="2840821">bytes</span><span class="op" id="2840826">.</span><span class="ident" id="2840827">Buffer</span><span class="op" id="2840833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2840837">for</span>&nbsp;<span class="ident" id="2840841">_</span><span class="op" id="2840842">,</span>&nbsp;<span class="ident" id="2840844">c</span>&nbsp;<span class="op" id="2840846">:=</span>&nbsp;<span class="keyword" id="2840849">range</span>&nbsp;<span class="ident" id="2840855">dec</span>&nbsp;<span class="op" id="2840859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2840864">if</span>&nbsp;<span class="ident" id="2840867">c</span>&nbsp;<span class="op" id="2840869">&gt;=</span>&nbsp;<span class="num" id="2840872">0x80</span>&nbsp;<span class="op" id="2840877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2840883">b</span><span class="op" id="2840884">.</span><span class="ident" id="2840885">WriteRune</span><span class="op" id="2840894">(</span><span class="ident" id="2840895">unicode</span><span class="op" id="2840902">.</span><span class="ident" id="2840903">ReplacementChar</span><span class="op" id="2840918">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2840923">}</span>&nbsp;<span class="keyword" id="2840925">else</span>&nbsp;<span class="op" id="2840930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2840936">b</span><span class="op" id="2840937">.</span><span class="ident" id="2840938">WriteRune</span><span class="op" id="2840947">(</span><span class="builtintype" id="2840948">rune</span><span class="op" id="2840952">(</span><span class="ident" id="2840953">c</span><span class="op" id="2840954">)</span><span class="op" id="2840955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2840960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2840964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2840968">return</span>&nbsp;<span class="ident" id="2840975">b</span><span class="op" id="2840976">.</span><span class="ident" id="2840977">String</span><span class="op" id="2840983">(</span><span class="op" id="2840984">)</span><span class="op" id="2840985">,</span>&nbsp;<span class="ident" id="2840987">nil</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2840992">case</span>&nbsp;<span class="string" id="2840997">&#34;iso-8859-1&#34;</span><span class="op" id="2841009">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2841013">b</span>&nbsp;<span class="op" id="2841015">:=</span>&nbsp;<span class="builtinfunc" id="2841018">new</span><span class="op" id="2841021">(</span><span class="ident" id="2841022">bytes</span><span class="op" id="2841027">.</span><span class="ident" id="2841028">Buffer</span><span class="op" id="2841034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2841038">for</span>&nbsp;<span class="ident" id="2841042">_</span><span class="op" id="2841043">,</span>&nbsp;<span class="ident" id="2841045">c</span>&nbsp;<span class="op" id="2841047">:=</span>&nbsp;<span class="keyword" id="2841050">range</span>&nbsp;<span class="ident" id="2841056">dec</span>&nbsp;<span class="op" id="2841060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2841065">b</span><span class="op" id="2841066">.</span><span class="ident" id="2841067">WriteRune</span><span class="op" id="2841076">(</span><span class="builtintype" id="2841077">rune</span><span class="op" id="2841081">(</span><span class="ident" id="2841082">c</span><span class="op" id="2841083">)</span><span class="op" id="2841084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2841088">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2841092">return</span>&nbsp;<span class="ident" id="2841099">b</span><span class="op" id="2841100">.</span><span class="ident" id="2841101">String</span><span class="op" id="2841107">(</span><span class="op" id="2841108">)</span><span class="op" id="2841109">,</span>&nbsp;<span class="ident" id="2841111">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2841116">case</span>&nbsp;<span class="string" id="2841121">&#34;utf-8&#34;</span><span class="op" id="2841128">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2841132">return</span>&nbsp;<span class="builtintype" id="2841139">string</span><span class="op" id="2841145">(</span><span class="ident" id="2841146">dec</span><span class="op" id="2841149">)</span><span class="op" id="2841150">,</span>&nbsp;<span class="ident" id="2841152">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2841157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="2841160">panic</span><span class="op" id="2841165">(</span><span class="string" id="2841166">&#34;unreachable&#34;</span><span class="op" id="2841179">)</span><br>
<span class="lineno">490</span><span class="op" id="2841181">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2841184">type</span>&nbsp;<span class="ident" id="2841189">qDecoder</span>&nbsp;<span class="keyword" id="2841198">struct</span>&nbsp;<span class="op" id="2841205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2841208">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2841216">io</span><span class="op" id="2841218">.</span><span class="ident" id="2841219">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2841227">scratch</span>&nbsp;<span class="op" id="2841235">[</span><span class="num" id="2841236">2</span><span class="op" id="2841237">]</span><span class="builtintype" id="2841238">byte</span><br>
<span class="lineno">495</span><span class="op" id="2841243">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2841246">func</span>&nbsp;<span class="op" id="2841251">(</span><span class="ident" id="2841252">qd</span>&nbsp;<span class="ident" id="2841255">qDecoder</span><span class="op" id="2841263">)</span>&nbsp;<span class="ident" id="2841265">Read</span><span class="op" id="2841269">(</span><span class="ident" id="2841270">p</span>&nbsp;<span class="op" id="2841272">[</span><span class="op" id="2841273">]</span><span class="builtintype" id="2841274">byte</span><span class="op" id="2841278">)</span>&nbsp;<span class="op" id="2841280">(</span><span class="ident" id="2841281">n</span>&nbsp;<span class="builtintype" id="2841283">int</span><span class="op" id="2841286">,</span>&nbsp;<span class="ident" id="2841288">err</span>&nbsp;<span class="builtintype" id="2841292">error</span><span class="op" id="2841297">)</span>&nbsp;<span class="op" id="2841299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2841302">//&nbsp;This&nbsp;method&nbsp;writes&nbsp;at&nbsp;most&nbsp;one&nbsp;byte&nbsp;into&nbsp;p.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2841350">if</span>&nbsp;<span class="builtinfunc" id="2841353">len</span><span class="op" id="2841356">(</span><span class="ident" id="2841357">p</span><span class="op" id="2841358">)</span>&nbsp;<span class="op" id="2841360">==</span>&nbsp;<span class="num" id="2841363">0</span>&nbsp;<span class="op" id="2841365">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2841369">return</span>&nbsp;<span class="num" id="2841376">0</span><span class="op" id="2841377">,</span>&nbsp;<span class="ident" id="2841379">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2841384">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2841387">if</span>&nbsp;<span class="ident" id="2841390">_</span><span class="op" id="2841391">,</span>&nbsp;<span class="ident" id="2841393">err</span>&nbsp;<span class="op" id="2841397">:=</span>&nbsp;<span class="ident" id="2841400">qd</span><span class="op" id="2841402">.</span><span class="ident" id="2841403">r</span><span class="op" id="2841404">.</span><span class="ident" id="2841405">Read</span><span class="op" id="2841409">(</span><span class="ident" id="2841410">qd</span><span class="op" id="2841412">.</span><span class="ident" id="2841413">scratch</span><span class="op" id="2841420">[</span><span class="op" id="2841421">:</span><span class="num" id="2841422">1</span><span class="op" id="2841423">]</span><span class="op" id="2841424">)</span><span class="op" id="2841425">;</span>&nbsp;<span class="ident" id="2841427">err</span>&nbsp;<span class="op" id="2841431">!=</span>&nbsp;<span class="ident" id="2841434">nil</span>&nbsp;<span class="op" id="2841438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2841442">return</span>&nbsp;<span class="num" id="2841449">0</span><span class="op" id="2841450">,</span>&nbsp;<span class="ident" id="2841452">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2841457">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2841460">switch</span>&nbsp;<span class="ident" id="2841467">c</span>&nbsp;<span class="op" id="2841469">:=</span>&nbsp;<span class="ident" id="2841472">qd</span><span class="op" id="2841474">.</span><span class="ident" id="2841475">scratch</span><span class="op" id="2841482">[</span><span class="num" id="2841483">0</span><span class="op" id="2841484">]</span><span class="op" id="2841485">;</span>&nbsp;<span class="op" id="2841487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2841490">case</span>&nbsp;<span class="ident" id="2841495">c</span>&nbsp;<span class="op" id="2841497">==</span>&nbsp;<span class="string" id="2841500">&#39;=&#39;</span><span class="op" id="2841503">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2841507">if</span>&nbsp;<span class="ident" id="2841510">_</span><span class="op" id="2841511">,</span>&nbsp;<span class="ident" id="2841513">err</span>&nbsp;<span class="op" id="2841517">:=</span>&nbsp;<span class="ident" id="2841520">io</span><span class="op" id="2841522">.</span><span class="ident" id="2841523">ReadFull</span><span class="op" id="2841531">(</span><span class="ident" id="2841532">qd</span><span class="op" id="2841534">.</span><span class="ident" id="2841535">r</span><span class="op" id="2841536">,</span>&nbsp;<span class="ident" id="2841538">qd</span><span class="op" id="2841540">.</span><span class="ident" id="2841541">scratch</span><span class="op" id="2841548">[</span><span class="op" id="2841549">:</span><span class="num" id="2841550">2</span><span class="op" id="2841551">]</span><span class="op" id="2841552">)</span><span class="op" id="2841553">;</span>&nbsp;<span class="ident" id="2841555">err</span>&nbsp;<span class="op" id="2841559">!=</span>&nbsp;<span class="ident" id="2841562">nil</span>&nbsp;<span class="op" id="2841566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2841571">return</span>&nbsp;<span class="num" id="2841578">0</span><span class="op" id="2841579">,</span>&nbsp;<span class="ident" id="2841581">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2841587">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2841591">x</span><span class="op" id="2841592">,</span>&nbsp;<span class="ident" id="2841594">err</span>&nbsp;<span class="op" id="2841598">:=</span>&nbsp;<span class="ident" id="2841601">strconv</span><span class="op" id="2841608">.</span><span class="ident" id="2841609">ParseInt</span><span class="op" id="2841617">(</span><span class="builtintype" id="2841618">string</span><span class="op" id="2841624">(</span><span class="ident" id="2841625">qd</span><span class="op" id="2841627">.</span><span class="ident" id="2841628">scratch</span><span class="op" id="2841635">[</span><span class="op" id="2841636">:</span><span class="num" id="2841637">2</span><span class="op" id="2841638">]</span><span class="op" id="2841639">)</span><span class="op" id="2841640">,</span>&nbsp;<span class="num" id="2841642">16</span><span class="op" id="2841644">,</span>&nbsp;<span class="num" id="2841646">64</span><span class="op" id="2841648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2841652">if</span>&nbsp;<span class="ident" id="2841655">err</span>&nbsp;<span class="op" id="2841659">!=</span>&nbsp;<span class="ident" id="2841662">nil</span>&nbsp;<span class="op" id="2841666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2841671">return</span>&nbsp;<span class="num" id="2841678">0</span><span class="op" id="2841679">,</span>&nbsp;<span class="ident" id="2841681">fmt</span><span class="op" id="2841684">.</span><span class="ident" id="2841685">Errorf</span><span class="op" id="2841691">(</span><span class="string" id="2841692">&#34;mail:&nbsp;invalid&nbsp;RFC&nbsp;2047&nbsp;encoding:&nbsp;%q&#34;</span><span class="op" id="2841729">,</span>&nbsp;<span class="ident" id="2841731">qd</span><span class="op" id="2841733">.</span><span class="ident" id="2841734">scratch</span><span class="op" id="2841741">[</span><span class="op" id="2841742">:</span><span class="num" id="2841743">2</span><span class="op" id="2841744">]</span><span class="op" id="2841745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2841749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2841753">p</span><span class="op" id="2841754">[</span><span class="num" id="2841755">0</span><span class="op" id="2841756">]</span>&nbsp;<span class="op" id="2841758">=</span>&nbsp;<span class="builtintype" id="2841760">byte</span><span class="op" id="2841764">(</span><span class="ident" id="2841765">x</span><span class="op" id="2841766">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2841769">case</span>&nbsp;<span class="ident" id="2841774">c</span>&nbsp;<span class="op" id="2841776">==</span>&nbsp;<span class="string" id="2841779">&#39;_&#39;</span><span class="op" id="2841782">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2841786">p</span><span class="op" id="2841787">[</span><span class="num" id="2841788">0</span><span class="op" id="2841789">]</span>&nbsp;<span class="op" id="2841791">=</span>&nbsp;<span class="string" id="2841793">&#39;&nbsp;&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2841798">default</span><span class="op" id="2841805">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2841809">p</span><span class="op" id="2841810">[</span><span class="num" id="2841811">0</span><span class="op" id="2841812">]</span>&nbsp;<span class="op" id="2841814">=</span>&nbsp;<span class="ident" id="2841816">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2841819">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2841822">return</span>&nbsp;<span class="num" id="2841829">1</span><span class="op" id="2841830">,</span>&nbsp;<span class="ident" id="2841832">nil</span><br>
<span class="lineno"></span><span class="op" id="2841836">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2841839">var</span>&nbsp;<span class="ident" id="2841843">atextChars</span>&nbsp;<span class="op" id="2841854">=</span>&nbsp;<span class="op" id="2841856">[</span><span class="op" id="2841857">]</span><span class="builtintype" id="2841858">byte</span><span class="op" id="2841862">(</span><span class="string" id="2841863">&#34;ABCDEFGHIJKLMNOPQRSTUVWXYZ&#34;</span>&nbsp;<span class="op" id="2841892">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2841895">&#34;abcdefghijklmnopqrstuvwxyz&#34;</span>&nbsp;<span class="op" id="2841924">+</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2841927">&#34;0123456789&#34;</span>&nbsp;<span class="op" id="2841940">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2841943">&#34;!#$%&amp;&#39;*+-/=?^_`{|}~&#34;</span><span class="op" id="2841964">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2841967">//&nbsp;isAtext&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;atext&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="2842028">//&nbsp;If&nbsp;dot&nbsp;is&nbsp;true,&nbsp;period&nbsp;is&nbsp;included.</span><br>
<span class="lineno">530</span><span class="keyword" id="2842067">func</span>&nbsp;<span class="ident" id="2842072">isAtext</span><span class="op" id="2842079">(</span><span class="ident" id="2842080">c</span>&nbsp;<span class="builtintype" id="2842082">byte</span><span class="op" id="2842086">,</span>&nbsp;<span class="ident" id="2842088">dot</span>&nbsp;<span class="builtintype" id="2842092">bool</span><span class="op" id="2842096">)</span>&nbsp;<span class="builtintype" id="2842098">bool</span>&nbsp;<span class="op" id="2842103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2842106">if</span>&nbsp;<span class="ident" id="2842109">dot</span>&nbsp;<span class="op" id="2842113">&amp;&amp;</span>&nbsp;<span class="ident" id="2842116">c</span>&nbsp;<span class="op" id="2842118">==</span>&nbsp;<span class="string" id="2842121">&#39;.&#39;</span>&nbsp;<span class="op" id="2842125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2842129">return</span>&nbsp;<span class="builtintype" id="2842136">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2842142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2842145">return</span>&nbsp;<span class="ident" id="2842152">bytes</span><span class="op" id="2842157">.</span><span class="ident" id="2842158">IndexByte</span><span class="op" id="2842167">(</span><span class="ident" id="2842168">atextChars</span><span class="op" id="2842178">,</span>&nbsp;<span class="ident" id="2842180">c</span><span class="op" id="2842181">)</span>&nbsp;<span class="op" id="2842183">&gt;=</span>&nbsp;<span class="num" id="2842186">0</span><br>
<span class="lineno">535</span><span class="op" id="2842188">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2842191">//&nbsp;isQtext&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;qtext&nbsp;character.</span><br>
<span class="lineno"></span><span class="keyword" id="2842252">func</span>&nbsp;<span class="ident" id="2842257">isQtext</span><span class="op" id="2842264">(</span><span class="ident" id="2842265">c</span>&nbsp;<span class="builtintype" id="2842267">byte</span><span class="op" id="2842271">)</span>&nbsp;<span class="builtintype" id="2842273">bool</span>&nbsp;<span class="op" id="2842278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2842281">//&nbsp;Printable&nbsp;US-ASCII,&nbsp;excluding&nbsp;backslash&nbsp;or&nbsp;quote.</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2842335">if</span>&nbsp;<span class="ident" id="2842338">c</span>&nbsp;<span class="op" id="2842340">==</span>&nbsp;<span class="string" id="2842343">&#39;\\&#39;</span>&nbsp;<span class="op" id="2842348">||</span>&nbsp;<span class="ident" id="2842351">c</span>&nbsp;<span class="op" id="2842353">==</span>&nbsp;<span class="string" id="2842356">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="2842360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2842364">return</span>&nbsp;<span class="builtintype" id="2842371">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2842378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2842381">return</span>&nbsp;<span class="string" id="2842388">&#39;!&#39;</span>&nbsp;<span class="op" id="2842392">&lt;=</span>&nbsp;<span class="ident" id="2842395">c</span>&nbsp;<span class="op" id="2842397">&amp;&amp;</span>&nbsp;<span class="ident" id="2842400">c</span>&nbsp;<span class="op" id="2842402">&lt;=</span>&nbsp;<span class="string" id="2842405">&#39;~&#39;</span><br>
<span class="lineno"></span><span class="op" id="2842409">}</span><br>
<span class="lineno">545</span><br>
<span class="lineno"></span><span class="comment" id="2842412">//&nbsp;isVchar&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;VCHAR&nbsp;character.</span><br>
<span class="lineno"></span><span class="keyword" id="2842473">func</span>&nbsp;<span class="ident" id="2842478">isVchar</span><span class="op" id="2842485">(</span><span class="ident" id="2842486">c</span>&nbsp;<span class="builtintype" id="2842488">byte</span><span class="op" id="2842492">)</span>&nbsp;<span class="builtintype" id="2842494">bool</span>&nbsp;<span class="op" id="2842499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2842502">//&nbsp;Visible&nbsp;(printing)&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2842537">return</span>&nbsp;<span class="string" id="2842544">&#39;!&#39;</span>&nbsp;<span class="op" id="2842548">&lt;=</span>&nbsp;<span class="ident" id="2842551">c</span>&nbsp;<span class="op" id="2842553">&amp;&amp;</span>&nbsp;<span class="ident" id="2842556">c</span>&nbsp;<span class="op" id="2842558">&lt;=</span>&nbsp;<span class="string" id="2842561">&#39;~&#39;</span><br>
<span class="lineno">550</span><span class="op" id="2842565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2842568">//&nbsp;isWSP&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;a&nbsp;WSP&nbsp;(white&nbsp;space).</span><br>
<span class="lineno"></span><span class="comment" id="2842619">//&nbsp;WSP&nbsp;is&nbsp;a&nbsp;space&nbsp;or&nbsp;horizontal&nbsp;tab&nbsp;(RFC5234&nbsp;Appendix&nbsp;B).</span><br>
<span class="lineno"></span><span class="keyword" id="2842677">func</span>&nbsp;<span class="ident" id="2842682">isWSP</span><span class="op" id="2842687">(</span><span class="ident" id="2842688">c</span>&nbsp;<span class="builtintype" id="2842690">byte</span><span class="op" id="2842694">)</span>&nbsp;<span class="builtintype" id="2842696">bool</span>&nbsp;<span class="op" id="2842701">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2842704">return</span>&nbsp;<span class="ident" id="2842711">c</span>&nbsp;<span class="op" id="2842713">==</span>&nbsp;<span class="string" id="2842716">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="2842720">||</span>&nbsp;<span class="ident" id="2842723">c</span>&nbsp;<span class="op" id="2842725">==</span>&nbsp;<span class="string" id="2842728">&#39;\t&#39;</span><br>
<span class="lineno"></span><span class="op" id="2842733">}</span>
</div>
</body>
</html>
