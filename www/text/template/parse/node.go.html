<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment">//&nbsp;Parse&nbsp;nodes.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">package</span>&nbsp;<span class="ident">parse</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">textFormat</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#34;%s&#34;</span>&nbsp;<span class="comment">//&nbsp;Changed&nbsp;to&nbsp;&#34;%q&#34;&nbsp;in&nbsp;tests&nbsp;for&nbsp;better&nbsp;error&nbsp;messages.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;A&nbsp;Node&nbsp;is&nbsp;an&nbsp;element&nbsp;in&nbsp;the&nbsp;parse&nbsp;tree.&nbsp;The&nbsp;interface&nbsp;is&nbsp;trivial.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;interface&nbsp;contains&nbsp;an&nbsp;unexported&nbsp;method&nbsp;so&nbsp;that&nbsp;only</span><br>
<span class="lineno">20</span><span class="comment">//&nbsp;types&nbsp;local&nbsp;to&nbsp;this&nbsp;package&nbsp;can&nbsp;satisfy&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">Node</span>&nbsp;<span class="keyword">interface</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Type</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">NodeType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">String</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Copy&nbsp;does&nbsp;a&nbsp;deep&nbsp;copy&nbsp;of&nbsp;the&nbsp;Node&nbsp;and&nbsp;all&nbsp;its&nbsp;components.</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;To&nbsp;avoid&nbsp;type&nbsp;assertions,&nbsp;some&nbsp;XxxNodes&nbsp;also&nbsp;have&nbsp;specialized</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;CopyXxx&nbsp;methods&nbsp;that&nbsp;return&nbsp;*XxxNode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Copy</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">Node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Position</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">Pos</span>&nbsp;<span class="comment">//&nbsp;byte&nbsp;position&nbsp;of&nbsp;start&nbsp;of&nbsp;node&nbsp;in&nbsp;full&nbsp;original&nbsp;input&nbsp;string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;tree&nbsp;returns&nbsp;the&nbsp;containing&nbsp;*Tree.</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;It&nbsp;is&nbsp;unexported&nbsp;so&nbsp;all&nbsp;implementations&nbsp;of&nbsp;Node&nbsp;are&nbsp;in&nbsp;this&nbsp;package.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tree</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;NodeType&nbsp;identifies&nbsp;the&nbsp;type&nbsp;of&nbsp;a&nbsp;parse&nbsp;tree&nbsp;node.</span><br>
<span class="lineno">35</span><span class="keyword">type</span>&nbsp;<span class="ident">NodeType</span>&nbsp;<span class="builtintype">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Pos&nbsp;represents&nbsp;a&nbsp;byte&nbsp;position&nbsp;in&nbsp;the&nbsp;original&nbsp;input&nbsp;text&nbsp;from&nbsp;which</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;this&nbsp;template&nbsp;was&nbsp;parsed.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">Pos</span>&nbsp;<span class="builtintype">int</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">p</span>&nbsp;<span class="ident">Pos</span><span class="op">)</span>&nbsp;<span class="ident">Position</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">Pos</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">p</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment">//&nbsp;Type&nbsp;returns&nbsp;itself&nbsp;and&nbsp;provides&nbsp;an&nbsp;easy&nbsp;default&nbsp;implementation</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;for&nbsp;embedding&nbsp;in&nbsp;a&nbsp;Node.&nbsp;Embedded&nbsp;in&nbsp;all&nbsp;non-trivial&nbsp;Nodes.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="ident">NodeType</span><span class="op">)</span>&nbsp;<span class="ident">Type</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">NodeType</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">t</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword">const</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeText</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">NodeType</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">iota</span>&nbsp;<span class="comment">//&nbsp;Plain&nbsp;text.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeAction</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;A&nbsp;non-control&nbsp;action&nbsp;such&nbsp;as&nbsp;a&nbsp;field&nbsp;evaluation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeBool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;A&nbsp;boolean&nbsp;constant.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeChain</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;A&nbsp;sequence&nbsp;of&nbsp;field&nbsp;accesses.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeCommand</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;An&nbsp;element&nbsp;of&nbsp;a&nbsp;pipeline.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeDot</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;The&nbsp;cursor,&nbsp;dot.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nodeElse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;An&nbsp;else&nbsp;action.&nbsp;Not&nbsp;added&nbsp;to&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nodeEnd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;An&nbsp;end&nbsp;action.&nbsp;Not&nbsp;added&nbsp;to&nbsp;tree.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeField</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;A&nbsp;field&nbsp;or&nbsp;method&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeIdentifier</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;An&nbsp;identifier;&nbsp;always&nbsp;a&nbsp;function&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeIf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;An&nbsp;if&nbsp;action.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeList</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;A&nbsp;list&nbsp;of&nbsp;Nodes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeNil</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;An&nbsp;untyped&nbsp;nil&nbsp;constant.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeNumber</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;A&nbsp;numerical&nbsp;constant.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodePipe</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;A&nbsp;pipeline&nbsp;of&nbsp;commands.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeRange</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;A&nbsp;range&nbsp;action.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeString</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;A&nbsp;string&nbsp;constant.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeTemplate</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;A&nbsp;template&nbsp;invocation&nbsp;action.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeVariable</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;A&nbsp;$&nbsp;variable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeWith</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;A&nbsp;with&nbsp;action.</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Nodes.</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ListNode&nbsp;holds&nbsp;a&nbsp;sequence&nbsp;of&nbsp;nodes.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">ListNode</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Pos</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tr</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">Tree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Nodes</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">Node</span>&nbsp;<span class="comment">//&nbsp;The&nbsp;element&nbsp;nodes&nbsp;in&nbsp;lexical&nbsp;order.</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span><span class="op">)</span>&nbsp;<span class="ident">newList</span><span class="op">(</span><span class="ident">pos</span>&nbsp;<span class="ident">Pos</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">ListNode</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">ListNode</span><span class="op">{</span><span class="ident">tr</span><span class="op">:</span>&nbsp;<span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">NodeType</span><span class="op">:</span>&nbsp;<span class="ident">NodeList</span><span class="op">,</span>&nbsp;<span class="ident">Pos</span><span class="op">:</span>&nbsp;<span class="ident">pos</span><span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">l</span>&nbsp;<span class="op">*</span><span class="ident">ListNode</span><span class="op">)</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">n</span>&nbsp;<span class="ident">Node</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">.</span><span class="ident">Nodes</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">l</span><span class="op">.</span><span class="ident">Nodes</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">)</span><br>
<span class="lineno">90</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">l</span>&nbsp;<span class="op">*</span><span class="ident">ListNode</span><span class="op">)</span>&nbsp;<span class="ident">tree</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="ident">tr</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">l</span>&nbsp;<span class="op">*</span><span class="ident">ListNode</span><span class="op">)</span>&nbsp;<span class="ident">String</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">bytes</span><span class="op">.</span><span class="ident">Buffer</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="ident">Nodes</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fmt</span><span class="op">.</span><span class="ident">Fprint</span><span class="op">(</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">String</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">l</span>&nbsp;<span class="op">*</span><span class="ident">ListNode</span><span class="op">)</span>&nbsp;<span class="ident">CopyList</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">ListNode</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">l</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="ident">tr</span><span class="op">.</span><span class="ident">newList</span><span class="op">(</span><span class="ident">l</span><span class="op">.</span><span class="ident">Pos</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">elem</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="ident">Nodes</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="builtinfunc">append</span><span class="op">(</span><span class="ident">elem</span><span class="op">.</span><span class="ident">Copy</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">n</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">l</span>&nbsp;<span class="op">*</span><span class="ident">ListNode</span><span class="op">)</span>&nbsp;<span class="ident">Copy</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">Node</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="ident">CopyList</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;TextNode&nbsp;holds&nbsp;plain&nbsp;text.</span><br>
<span class="lineno">120</span><span class="keyword">type</span>&nbsp;<span class="ident">TextNode</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tr</span>&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">Tree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Text</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span>&nbsp;<span class="comment">//&nbsp;The&nbsp;text;&nbsp;may&nbsp;span&nbsp;newlines.</span><br>
<span class="lineno">125</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span><span class="op">)</span>&nbsp;<span class="ident">newText</span><span class="op">(</span><span class="ident">pos</span>&nbsp;<span class="ident">Pos</span><span class="op">,</span>&nbsp;<span class="ident">text</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">TextNode</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">TextNode</span><span class="op">{</span><span class="ident">tr</span><span class="op">:</span>&nbsp;<span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">NodeType</span><span class="op">:</span>&nbsp;<span class="ident">NodeText</span><span class="op">,</span>&nbsp;<span class="ident">Pos</span><span class="op">:</span>&nbsp;<span class="ident">pos</span><span class="op">,</span>&nbsp;<span class="ident">Text</span><span class="op">:</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">(</span><span class="ident">text</span><span class="op">)</span><span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">TextNode</span><span class="op">)</span>&nbsp;<span class="ident">String</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fmt</span><span class="op">.</span><span class="ident">Sprintf</span><span class="op">(</span><span class="ident">textFormat</span><span class="op">,</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Text</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">TextNode</span><span class="op">)</span>&nbsp;<span class="ident">tree</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">tr</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">TextNode</span><span class="op">)</span>&nbsp;<span class="ident">Copy</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">Node</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">TextNode</span><span class="op">{</span><span class="ident">tr</span><span class="op">:</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">tr</span><span class="op">,</span>&nbsp;<span class="ident">NodeType</span><span class="op">:</span>&nbsp;<span class="ident">NodeText</span><span class="op">,</span>&nbsp;<span class="ident">Pos</span><span class="op">:</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Pos</span><span class="op">,</span>&nbsp;<span class="ident">Text</span><span class="op">:</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">{</span><span class="op">}</span><span class="op">,</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Text</span><span class="op">...</span><span class="op">)</span><span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;PipeNode&nbsp;holds&nbsp;a&nbsp;pipeline&nbsp;with&nbsp;optional&nbsp;declaration</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">PipeNode</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tr</span>&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">Tree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Line</span>&nbsp;<span class="builtintype">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;The&nbsp;line&nbsp;number&nbsp;in&nbsp;the&nbsp;input&nbsp;(deprecated;&nbsp;kept&nbsp;for&nbsp;compatibility)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Decl</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="op">*</span><span class="ident">VariableNode</span>&nbsp;<span class="comment">//&nbsp;Variable&nbsp;declarations&nbsp;in&nbsp;lexical&nbsp;order.</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Cmds</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="op">*</span><span class="ident">CommandNode</span>&nbsp;&nbsp;<span class="comment">//&nbsp;The&nbsp;commands&nbsp;in&nbsp;lexical&nbsp;order.</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span><span class="op">)</span>&nbsp;<span class="ident">newPipeline</span><span class="op">(</span><span class="ident">pos</span>&nbsp;<span class="ident">Pos</span><span class="op">,</span>&nbsp;<span class="ident">line</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">decl</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="op">*</span><span class="ident">VariableNode</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">PipeNode</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">PipeNode</span><span class="op">{</span><span class="ident">tr</span><span class="op">:</span>&nbsp;<span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">NodeType</span><span class="op">:</span>&nbsp;<span class="ident">NodePipe</span><span class="op">,</span>&nbsp;<span class="ident">Pos</span><span class="op">:</span>&nbsp;<span class="ident">pos</span><span class="op">,</span>&nbsp;<span class="ident">Line</span><span class="op">:</span>&nbsp;<span class="ident">line</span><span class="op">,</span>&nbsp;<span class="ident">Decl</span><span class="op">:</span>&nbsp;<span class="ident">decl</span><span class="op">}</span><br>
<span class="lineno">155</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">p</span>&nbsp;<span class="op">*</span><span class="ident">PipeNode</span><span class="op">)</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">command</span>&nbsp;<span class="op">*</span><span class="ident">CommandNode</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">p</span><span class="op">.</span><span class="ident">Cmds</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">p</span><span class="op">.</span><span class="ident">Cmds</span><span class="op">,</span>&nbsp;<span class="ident">command</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">p</span>&nbsp;<span class="op">*</span><span class="ident">PipeNode</span><span class="op">)</span>&nbsp;<span class="ident">String</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="string">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">p</span><span class="op">.</span><span class="ident">Decl</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">Decl</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="string">&#34;,&nbsp;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">v</span><span class="op">.</span><span class="ident">String</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="string">&#34;&nbsp;:=&nbsp;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">c</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">Cmds</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="string">&#34;&nbsp;|&nbsp;&#34;</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">String</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">s</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">p</span>&nbsp;<span class="op">*</span><span class="ident">PipeNode</span><span class="op">)</span>&nbsp;<span class="ident">tree</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">tr</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">p</span>&nbsp;<span class="op">*</span><span class="ident">PipeNode</span><span class="op">)</span>&nbsp;<span class="ident">CopyPipe</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">PipeNode</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">p</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">decl</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="op">*</span><span class="ident">VariableNode</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">d</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">Decl</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">decl</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">decl</span><span class="op">,</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">Copy</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">VariableNode</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">tr</span><span class="op">.</span><span class="ident">newPipeline</span><span class="op">(</span><span class="ident">p</span><span class="op">.</span><span class="ident">Pos</span><span class="op">,</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">Line</span><span class="op">,</span>&nbsp;<span class="ident">decl</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">c</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">Cmds</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="builtinfunc">append</span><span class="op">(</span><span class="ident">c</span><span class="op">.</span><span class="ident">Copy</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">CommandNode</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">n</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">p</span>&nbsp;<span class="op">*</span><span class="ident">PipeNode</span><span class="op">)</span>&nbsp;<span class="ident">Copy</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">Node</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">CopyPipe</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ActionNode&nbsp;holds&nbsp;an&nbsp;action&nbsp;(something&nbsp;bounded&nbsp;by&nbsp;delimiters).</span><br>
<span class="lineno">205</span><span class="comment">//&nbsp;Control&nbsp;actions&nbsp;have&nbsp;their&nbsp;own&nbsp;nodes;&nbsp;ActionNode&nbsp;represents&nbsp;simple</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ones&nbsp;such&nbsp;as&nbsp;field&nbsp;evaluations&nbsp;and&nbsp;parenthesized&nbsp;pipelines.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">ActionNode</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Pos</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tr</span>&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">Tree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Line</span>&nbsp;<span class="builtintype">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;The&nbsp;line&nbsp;number&nbsp;in&nbsp;the&nbsp;input&nbsp;(deprecated;&nbsp;kept&nbsp;for&nbsp;compatibility)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Pipe</span>&nbsp;<span class="op">*</span><span class="ident">PipeNode</span>&nbsp;<span class="comment">//&nbsp;The&nbsp;pipeline&nbsp;in&nbsp;the&nbsp;action.</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span><span class="op">)</span>&nbsp;<span class="ident">newAction</span><span class="op">(</span><span class="ident">pos</span>&nbsp;<span class="ident">Pos</span><span class="op">,</span>&nbsp;<span class="ident">line</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">pipe</span>&nbsp;<span class="op">*</span><span class="ident">PipeNode</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">ActionNode</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">ActionNode</span><span class="op">{</span><span class="ident">tr</span><span class="op">:</span>&nbsp;<span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">NodeType</span><span class="op">:</span>&nbsp;<span class="ident">NodeAction</span><span class="op">,</span>&nbsp;<span class="ident">Pos</span><span class="op">:</span>&nbsp;<span class="ident">pos</span><span class="op">,</span>&nbsp;<span class="ident">Line</span><span class="op">:</span>&nbsp;<span class="ident">line</span><span class="op">,</span>&nbsp;<span class="ident">Pipe</span><span class="op">:</span>&nbsp;<span class="ident">pipe</span><span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">a</span>&nbsp;<span class="op">*</span><span class="ident">ActionNode</span><span class="op">)</span>&nbsp;<span class="ident">String</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fmt</span><span class="op">.</span><span class="ident">Sprintf</span><span class="op">(</span><span class="string">&#34;{{%s}}&#34;</span><span class="op">,</span>&nbsp;<span class="ident">a</span><span class="op">.</span><span class="ident">Pipe</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">a</span>&nbsp;<span class="op">*</span><span class="ident">ActionNode</span><span class="op">)</span>&nbsp;<span class="ident">tree</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">a</span><span class="op">.</span><span class="ident">tr</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">a</span>&nbsp;<span class="op">*</span><span class="ident">ActionNode</span><span class="op">)</span>&nbsp;<span class="ident">Copy</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">Node</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">a</span><span class="op">.</span><span class="ident">tr</span><span class="op">.</span><span class="ident">newAction</span><span class="op">(</span><span class="ident">a</span><span class="op">.</span><span class="ident">Pos</span><span class="op">,</span>&nbsp;<span class="ident">a</span><span class="op">.</span><span class="ident">Line</span><span class="op">,</span>&nbsp;<span class="ident">a</span><span class="op">.</span><span class="ident">Pipe</span><span class="op">.</span><span class="ident">CopyPipe</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;CommandNode&nbsp;holds&nbsp;a&nbsp;command&nbsp;(a&nbsp;pipeline&nbsp;inside&nbsp;an&nbsp;evaluating&nbsp;action).</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">CommandNode</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tr</span>&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">Tree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Args</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">Node</span>&nbsp;<span class="comment">//&nbsp;Arguments&nbsp;in&nbsp;lexical&nbsp;order:&nbsp;Identifier,&nbsp;field,&nbsp;or&nbsp;constant.</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span><span class="op">)</span>&nbsp;<span class="ident">newCommand</span><span class="op">(</span><span class="ident">pos</span>&nbsp;<span class="ident">Pos</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">CommandNode</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">CommandNode</span><span class="op">{</span><span class="ident">tr</span><span class="op">:</span>&nbsp;<span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">NodeType</span><span class="op">:</span>&nbsp;<span class="ident">NodeCommand</span><span class="op">,</span>&nbsp;<span class="ident">Pos</span><span class="op">:</span>&nbsp;<span class="ident">pos</span><span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">CommandNode</span><span class="op">)</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">arg</span>&nbsp;<span class="ident">Node</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">.</span><span class="ident">Args</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">c</span><span class="op">.</span><span class="ident">Args</span><span class="op">,</span>&nbsp;<span class="ident">arg</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">CommandNode</span><span class="op">)</span>&nbsp;<span class="ident">String</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="string">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">arg</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">Args</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="string">&#34;&nbsp;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">arg</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">arg</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">PipeNode</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="string">&#34;(&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">arg</span><span class="op">.</span><span class="ident">String</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">+</span>&nbsp;<span class="string">&#34;)&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">arg</span><span class="op">.</span><span class="ident">String</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">s</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">CommandNode</span><span class="op">)</span>&nbsp;<span class="ident">tree</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">tr</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">CommandNode</span><span class="op">)</span>&nbsp;<span class="ident">Copy</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">Node</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">c</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">tr</span><span class="op">.</span><span class="ident">newCommand</span><span class="op">(</span><span class="ident">c</span><span class="op">.</span><span class="ident">Pos</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">c</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">Args</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="builtinfunc">append</span><span class="op">(</span><span class="ident">c</span><span class="op">.</span><span class="ident">Copy</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">n</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;IdentifierNode&nbsp;holds&nbsp;an&nbsp;identifier.</span><br>
<span class="lineno">280</span><span class="keyword">type</span>&nbsp;<span class="ident">IdentifierNode</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tr</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">Tree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Ident</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="comment">//&nbsp;The&nbsp;identifier&#39;s&nbsp;name.</span><br>
<span class="lineno">285</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;NewIdentifier&nbsp;returns&nbsp;a&nbsp;new&nbsp;IdentifierNode&nbsp;with&nbsp;the&nbsp;given&nbsp;identifier&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">NewIdentifier</span><span class="op">(</span><span class="ident">ident</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">IdentifierNode</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">IdentifierNode</span><span class="op">{</span><span class="ident">NodeType</span><span class="op">:</span>&nbsp;<span class="ident">NodeIdentifier</span><span class="op">,</span>&nbsp;<span class="ident">Ident</span><span class="op">:</span>&nbsp;<span class="ident">ident</span><span class="op">}</span><br>
<span class="lineno">290</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;SetPos&nbsp;sets&nbsp;the&nbsp;position.&nbsp;NewIdentifier&nbsp;is&nbsp;a&nbsp;public&nbsp;method&nbsp;so&nbsp;we&nbsp;can&#39;t&nbsp;modify&nbsp;its&nbsp;signature.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Chained&nbsp;for&nbsp;convenience.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;TODO:&nbsp;fix&nbsp;one&nbsp;day?</span><br>
<span class="lineno">295</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">IdentifierNode</span><span class="op">)</span>&nbsp;<span class="ident">SetPos</span><span class="op">(</span><span class="ident">pos</span>&nbsp;<span class="ident">Pos</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">IdentifierNode</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">.</span><span class="ident">Pos</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">i</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="comment">//&nbsp;SetTree&nbsp;sets&nbsp;the&nbsp;parent&nbsp;tree&nbsp;for&nbsp;the&nbsp;node.&nbsp;NewIdentifier&nbsp;is&nbsp;a&nbsp;public&nbsp;method&nbsp;so&nbsp;we&nbsp;can&#39;t&nbsp;modify&nbsp;its&nbsp;signature.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Chained&nbsp;for&nbsp;convenience.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;TODO:&nbsp;fix&nbsp;one&nbsp;day?</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">IdentifierNode</span><span class="op">)</span>&nbsp;<span class="ident">SetTree</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">IdentifierNode</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">.</span><span class="ident">tr</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">t</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">i</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">IdentifierNode</span><span class="op">)</span>&nbsp;<span class="ident">String</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">i</span><span class="op">.</span><span class="ident">Ident</span><br>
<span class="lineno">310</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">IdentifierNode</span><span class="op">)</span>&nbsp;<span class="ident">tree</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">i</span><span class="op">.</span><span class="ident">tr</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">IdentifierNode</span><span class="op">)</span>&nbsp;<span class="ident">Copy</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">Node</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">NewIdentifier</span><span class="op">(</span><span class="ident">i</span><span class="op">.</span><span class="ident">Ident</span><span class="op">)</span><span class="op">.</span><span class="ident">SetTree</span><span class="op">(</span><span class="ident">i</span><span class="op">.</span><span class="ident">tr</span><span class="op">)</span><span class="op">.</span><span class="ident">SetPos</span><span class="op">(</span><span class="ident">i</span><span class="op">.</span><span class="ident">Pos</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span><span class="comment">//&nbsp;VariableNode&nbsp;holds&nbsp;a&nbsp;list&nbsp;of&nbsp;variable&nbsp;names,&nbsp;possibly&nbsp;with&nbsp;chained&nbsp;field</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;accesses.&nbsp;The&nbsp;dollar&nbsp;sign&nbsp;is&nbsp;part&nbsp;of&nbsp;the&nbsp;(first)&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">VariableNode</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Pos</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tr</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">Tree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Ident</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">string</span>&nbsp;<span class="comment">//&nbsp;Variable&nbsp;name&nbsp;and&nbsp;fields&nbsp;in&nbsp;lexical&nbsp;order.</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span><span class="op">)</span>&nbsp;<span class="ident">newVariable</span><span class="op">(</span><span class="ident">pos</span>&nbsp;<span class="ident">Pos</span><span class="op">,</span>&nbsp;<span class="ident">ident</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">VariableNode</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">VariableNode</span><span class="op">{</span><span class="ident">tr</span><span class="op">:</span>&nbsp;<span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">NodeType</span><span class="op">:</span>&nbsp;<span class="ident">NodeVariable</span><span class="op">,</span>&nbsp;<span class="ident">Pos</span><span class="op">:</span>&nbsp;<span class="ident">pos</span><span class="op">,</span>&nbsp;<span class="ident">Ident</span><span class="op">:</span>&nbsp;<span class="ident">strings</span><span class="op">.</span><span class="ident">Split</span><span class="op">(</span><span class="ident">ident</span><span class="op">,</span>&nbsp;<span class="string">&#34;.&#34;</span><span class="op">)</span><span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">v</span>&nbsp;<span class="op">*</span><span class="ident">VariableNode</span><span class="op">)</span>&nbsp;<span class="ident">String</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="string">&#34;&#34;</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">id</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">v</span><span class="op">.</span><span class="ident">Ident</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="string">&#34;.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">id</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">s</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">v</span>&nbsp;<span class="op">*</span><span class="ident">VariableNode</span><span class="op">)</span>&nbsp;<span class="ident">tree</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">v</span><span class="op">.</span><span class="ident">tr</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">v</span>&nbsp;<span class="op">*</span><span class="ident">VariableNode</span><span class="op">)</span>&nbsp;<span class="ident">Copy</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">Node</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">VariableNode</span><span class="op">{</span><span class="ident">tr</span><span class="op">:</span>&nbsp;<span class="ident">v</span><span class="op">.</span><span class="ident">tr</span><span class="op">,</span>&nbsp;<span class="ident">NodeType</span><span class="op">:</span>&nbsp;<span class="ident">NodeVariable</span><span class="op">,</span>&nbsp;<span class="ident">Pos</span><span class="op">:</span>&nbsp;<span class="ident">v</span><span class="op">.</span><span class="ident">Pos</span><span class="op">,</span>&nbsp;<span class="ident">Ident</span><span class="op">:</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">string</span><span class="op">{</span><span class="op">}</span><span class="op">,</span>&nbsp;<span class="ident">v</span><span class="op">.</span><span class="ident">Ident</span><span class="op">...</span><span class="op">)</span><span class="op">}</span><br>
<span class="lineno">350</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;DotNode&nbsp;holds&nbsp;the&nbsp;special&nbsp;identifier&nbsp;&#39;.&#39;.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">DotNode</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeType</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tr</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span><span class="op">)</span>&nbsp;<span class="ident">newDot</span><span class="op">(</span><span class="ident">pos</span>&nbsp;<span class="ident">Pos</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">DotNode</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">DotNode</span><span class="op">{</span><span class="ident">tr</span><span class="op">:</span>&nbsp;<span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">NodeType</span><span class="op">:</span>&nbsp;<span class="ident">NodeDot</span><span class="op">,</span>&nbsp;<span class="ident">Pos</span><span class="op">:</span>&nbsp;<span class="ident">pos</span><span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">d</span>&nbsp;<span class="op">*</span><span class="ident">DotNode</span><span class="op">)</span>&nbsp;<span class="ident">Type</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">NodeType</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Override&nbsp;method&nbsp;on&nbsp;embedded&nbsp;NodeType&nbsp;for&nbsp;API&nbsp;compatibility.</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;TODO:&nbsp;Not&nbsp;really&nbsp;a&nbsp;problem;&nbsp;could&nbsp;change&nbsp;API&nbsp;without&nbsp;effect&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;api&nbsp;tool&nbsp;complains.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">NodeDot</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">370</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">d</span>&nbsp;<span class="op">*</span><span class="ident">DotNode</span><span class="op">)</span>&nbsp;<span class="ident">String</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="string">&#34;.&#34;</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">d</span>&nbsp;<span class="op">*</span><span class="ident">DotNode</span><span class="op">)</span>&nbsp;<span class="ident">tree</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">tr</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">d</span>&nbsp;<span class="op">*</span><span class="ident">DotNode</span><span class="op">)</span>&nbsp;<span class="ident">Copy</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">Node</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">tr</span><span class="op">.</span><span class="ident">newDot</span><span class="op">(</span><span class="ident">d</span><span class="op">.</span><span class="ident">Pos</span><span class="op">)</span><br>
<span class="lineno">380</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;NilNode&nbsp;holds&nbsp;the&nbsp;special&nbsp;identifier&nbsp;&#39;nil&#39;&nbsp;representing&nbsp;an&nbsp;untyped&nbsp;nil&nbsp;constant.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">NilNode</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeType</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tr</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span><span class="op">)</span>&nbsp;<span class="ident">newNil</span><span class="op">(</span><span class="ident">pos</span>&nbsp;<span class="ident">Pos</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">NilNode</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">NilNode</span><span class="op">{</span><span class="ident">tr</span><span class="op">:</span>&nbsp;<span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">NodeType</span><span class="op">:</span>&nbsp;<span class="ident">NodeNil</span><span class="op">,</span>&nbsp;<span class="ident">Pos</span><span class="op">:</span>&nbsp;<span class="ident">pos</span><span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">n</span>&nbsp;<span class="op">*</span><span class="ident">NilNode</span><span class="op">)</span>&nbsp;<span class="ident">Type</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">NodeType</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Override&nbsp;method&nbsp;on&nbsp;embedded&nbsp;NodeType&nbsp;for&nbsp;API&nbsp;compatibility.</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;TODO:&nbsp;Not&nbsp;really&nbsp;a&nbsp;problem;&nbsp;could&nbsp;change&nbsp;API&nbsp;without&nbsp;effect&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;api&nbsp;tool&nbsp;complains.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">NodeNil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">n</span>&nbsp;<span class="op">*</span><span class="ident">NilNode</span><span class="op">)</span>&nbsp;<span class="ident">String</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="string">&#34;nil&#34;</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">n</span>&nbsp;<span class="op">*</span><span class="ident">NilNode</span><span class="op">)</span>&nbsp;<span class="ident">tree</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">n</span><span class="op">.</span><span class="ident">tr</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">n</span>&nbsp;<span class="op">*</span><span class="ident">NilNode</span><span class="op">)</span>&nbsp;<span class="ident">Copy</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">Node</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">n</span><span class="op">.</span><span class="ident">tr</span><span class="op">.</span><span class="ident">newNil</span><span class="op">(</span><span class="ident">n</span><span class="op">.</span><span class="ident">Pos</span><span class="op">)</span><br>
<span class="lineno">410</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;FieldNode&nbsp;holds&nbsp;a&nbsp;field&nbsp;(identifier&nbsp;starting&nbsp;with&nbsp;&#39;.&#39;).</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;names&nbsp;may&nbsp;be&nbsp;chained&nbsp;(&#39;.x.y&#39;).</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;period&nbsp;is&nbsp;dropped&nbsp;from&nbsp;each&nbsp;ident.</span><br>
<span class="lineno">415</span><span class="keyword">type</span>&nbsp;<span class="ident">FieldNode</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tr</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">Tree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Ident</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">string</span>&nbsp;<span class="comment">//&nbsp;The&nbsp;identifiers&nbsp;in&nbsp;lexical&nbsp;order.</span><br>
<span class="lineno">420</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span><span class="op">)</span>&nbsp;<span class="ident">newField</span><span class="op">(</span><span class="ident">pos</span>&nbsp;<span class="ident">Pos</span><span class="op">,</span>&nbsp;<span class="ident">ident</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">FieldNode</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">FieldNode</span><span class="op">{</span><span class="ident">tr</span><span class="op">:</span>&nbsp;<span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">NodeType</span><span class="op">:</span>&nbsp;<span class="ident">NodeField</span><span class="op">,</span>&nbsp;<span class="ident">Pos</span><span class="op">:</span>&nbsp;<span class="ident">pos</span><span class="op">,</span>&nbsp;<span class="ident">Ident</span><span class="op">:</span>&nbsp;<span class="ident">strings</span><span class="op">.</span><span class="ident">Split</span><span class="op">(</span><span class="ident">ident</span><span class="op">[</span><span class="num">1</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="string">&#34;.&#34;</span><span class="op">)</span><span class="op">}</span>&nbsp;<span class="comment">//&nbsp;[1:]&nbsp;to&nbsp;drop&nbsp;leading&nbsp;period</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">f</span>&nbsp;<span class="op">*</span><span class="ident">FieldNode</span><span class="op">)</span>&nbsp;<span class="ident">String</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="string">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">id</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">f</span><span class="op">.</span><span class="ident">Ident</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="string">&#34;.&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">id</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">s</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">f</span>&nbsp;<span class="op">*</span><span class="ident">FieldNode</span><span class="op">)</span>&nbsp;<span class="ident">tree</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">f</span><span class="op">.</span><span class="ident">tr</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">f</span>&nbsp;<span class="op">*</span><span class="ident">FieldNode</span><span class="op">)</span>&nbsp;<span class="ident">Copy</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">Node</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">FieldNode</span><span class="op">{</span><span class="ident">tr</span><span class="op">:</span>&nbsp;<span class="ident">f</span><span class="op">.</span><span class="ident">tr</span><span class="op">,</span>&nbsp;<span class="ident">NodeType</span><span class="op">:</span>&nbsp;<span class="ident">NodeField</span><span class="op">,</span>&nbsp;<span class="ident">Pos</span><span class="op">:</span>&nbsp;<span class="ident">f</span><span class="op">.</span><span class="ident">Pos</span><span class="op">,</span>&nbsp;<span class="ident">Ident</span><span class="op">:</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">string</span><span class="op">{</span><span class="op">}</span><span class="op">,</span>&nbsp;<span class="ident">f</span><span class="op">.</span><span class="ident">Ident</span><span class="op">...</span><span class="op">)</span><span class="op">}</span><br>
<span class="lineno">440</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ChainNode&nbsp;holds&nbsp;a&nbsp;term&nbsp;followed&nbsp;by&nbsp;a&nbsp;chain&nbsp;of&nbsp;field&nbsp;accesses&nbsp;(identifier&nbsp;starting&nbsp;with&nbsp;&#39;.&#39;).</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;names&nbsp;may&nbsp;be&nbsp;chained&nbsp;(&#39;.x.y&#39;).</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;periods&nbsp;are&nbsp;dropped&nbsp;from&nbsp;each&nbsp;ident.</span><br>
<span class="lineno">445</span><span class="keyword">type</span>&nbsp;<span class="ident">ChainNode</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tr</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">Tree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Node</span>&nbsp;&nbsp;<span class="ident">Node</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Field</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">string</span>&nbsp;<span class="comment">//&nbsp;The&nbsp;identifiers&nbsp;in&nbsp;lexical&nbsp;order.</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span><span class="op">)</span>&nbsp;<span class="ident">newChain</span><span class="op">(</span><span class="ident">pos</span>&nbsp;<span class="ident">Pos</span><span class="op">,</span>&nbsp;<span class="ident">node</span>&nbsp;<span class="ident">Node</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">ChainNode</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">ChainNode</span><span class="op">{</span><span class="ident">tr</span><span class="op">:</span>&nbsp;<span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">NodeType</span><span class="op">:</span>&nbsp;<span class="ident">NodeChain</span><span class="op">,</span>&nbsp;<span class="ident">Pos</span><span class="op">:</span>&nbsp;<span class="ident">pos</span><span class="op">,</span>&nbsp;<span class="ident">Node</span><span class="op">:</span>&nbsp;<span class="ident">node</span><span class="op">}</span><br>
<span class="lineno">455</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Add&nbsp;adds&nbsp;the&nbsp;named&nbsp;field&nbsp;(which&nbsp;should&nbsp;start&nbsp;with&nbsp;a&nbsp;period)&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;chain.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">ChainNode</span><span class="op">)</span>&nbsp;<span class="ident">Add</span><span class="op">(</span><span class="ident">field</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">field</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">field</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="string">&#39;.&#39;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;no&nbsp;dot&nbsp;in&nbsp;field&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">field</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">field</span><span class="op">[</span><span class="num">1</span><span class="op">:</span><span class="op">]</span>&nbsp;<span class="comment">//&nbsp;Remove&nbsp;leading&nbsp;dot.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">field</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;empty&nbsp;field&#34;</span><span class="op">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">.</span><span class="ident">Field</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">c</span><span class="op">.</span><span class="ident">Field</span><span class="op">,</span>&nbsp;<span class="ident">field</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">ChainNode</span><span class="op">)</span>&nbsp;<span class="ident">String</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">Node</span><span class="op">.</span><span class="ident">String</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">Node</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">PipeNode</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#34;(&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">+</span>&nbsp;<span class="string">&#34;)&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">field</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">Field</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="string">&#34;.&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">field</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">s</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">480</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">ChainNode</span><span class="op">)</span>&nbsp;<span class="ident">tree</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">tr</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">ChainNode</span><span class="op">)</span>&nbsp;<span class="ident">Copy</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">Node</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">ChainNode</span><span class="op">{</span><span class="ident">tr</span><span class="op">:</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">tr</span><span class="op">,</span>&nbsp;<span class="ident">NodeType</span><span class="op">:</span>&nbsp;<span class="ident">NodeChain</span><span class="op">,</span>&nbsp;<span class="ident">Pos</span><span class="op">:</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">Pos</span><span class="op">,</span>&nbsp;<span class="ident">Node</span><span class="op">:</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">Node</span><span class="op">,</span>&nbsp;<span class="ident">Field</span><span class="op">:</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">string</span><span class="op">{</span><span class="op">}</span><span class="op">,</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">Field</span><span class="op">...</span><span class="op">)</span><span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;BoolNode&nbsp;holds&nbsp;a&nbsp;boolean&nbsp;constant.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">BoolNode</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tr</span>&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">Tree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">True</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="comment">//&nbsp;The&nbsp;value&nbsp;of&nbsp;the&nbsp;boolean&nbsp;constant.</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span><span class="op">)</span>&nbsp;<span class="ident">newBool</span><span class="op">(</span><span class="ident">pos</span>&nbsp;<span class="ident">Pos</span><span class="op">,</span>&nbsp;<span class="ident">true</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">BoolNode</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">BoolNode</span><span class="op">{</span><span class="ident">tr</span><span class="op">:</span>&nbsp;<span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">NodeType</span><span class="op">:</span>&nbsp;<span class="ident">NodeBool</span><span class="op">,</span>&nbsp;<span class="ident">Pos</span><span class="op">:</span>&nbsp;<span class="ident">pos</span><span class="op">,</span>&nbsp;<span class="ident">True</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">500</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">BoolNode</span><span class="op">)</span>&nbsp;<span class="ident">String</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">True</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="string">&#34;true&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="string">&#34;false&#34;</span><br>
<span class="lineno">505</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">BoolNode</span><span class="op">)</span>&nbsp;<span class="ident">tree</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">tr</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">510</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">BoolNode</span><span class="op">)</span>&nbsp;<span class="ident">Copy</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">Node</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">tr</span><span class="op">.</span><span class="ident">newBool</span><span class="op">(</span><span class="ident">b</span><span class="op">.</span><span class="ident">Pos</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">True</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">515</span><span class="comment">//&nbsp;NumberNode&nbsp;holds&nbsp;a&nbsp;number:&nbsp;signed&nbsp;or&nbsp;unsigned&nbsp;integer,&nbsp;float,&nbsp;or&nbsp;complex.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;value&nbsp;is&nbsp;parsed&nbsp;and&nbsp;stored&nbsp;under&nbsp;all&nbsp;the&nbsp;types&nbsp;that&nbsp;can&nbsp;represent&nbsp;the&nbsp;value.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;This&nbsp;simulates&nbsp;in&nbsp;a&nbsp;small&nbsp;amount&nbsp;of&nbsp;code&nbsp;the&nbsp;behavior&nbsp;of&nbsp;Go&#39;s&nbsp;ideal&nbsp;constants.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">NumberNode</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeType</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">Tree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">IsInt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Number&nbsp;has&nbsp;an&nbsp;integral&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">IsUint</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Number&nbsp;has&nbsp;an&nbsp;unsigned&nbsp;integral&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">IsFloat</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Number&nbsp;has&nbsp;a&nbsp;floating-point&nbsp;value.</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">IsComplex</span>&nbsp;&nbsp;<span class="builtintype">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Number&nbsp;is&nbsp;complex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;The&nbsp;signed&nbsp;integer&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Uint64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">uint64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;The&nbsp;unsigned&nbsp;integer&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Float64</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">float64</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;The&nbsp;floating-point&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Complex128</span>&nbsp;<span class="builtintype">complex128</span>&nbsp;<span class="comment">//&nbsp;The&nbsp;complex&nbsp;value.</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Text</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;The&nbsp;original&nbsp;textual&nbsp;representation&nbsp;from&nbsp;the&nbsp;input.</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span><span class="op">)</span>&nbsp;<span class="ident">newNumber</span><span class="op">(</span><span class="ident">pos</span>&nbsp;<span class="ident">Pos</span><span class="op">,</span>&nbsp;<span class="ident">text</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">typ</span>&nbsp;<span class="ident">itemType</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">NumberNode</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">NumberNode</span><span class="op">{</span><span class="ident">tr</span><span class="op">:</span>&nbsp;<span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">NodeType</span><span class="op">:</span>&nbsp;<span class="ident">NodeNumber</span><span class="op">,</span>&nbsp;<span class="ident">Pos</span><span class="op">:</span>&nbsp;<span class="ident">pos</span><span class="op">,</span>&nbsp;<span class="ident">Text</span><span class="op">:</span>&nbsp;<span class="ident">text</span><span class="op">}</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">typ</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">itemCharConstant</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype">rune</span><span class="op">,</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">tail</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">strconv</span><span class="op">.</span><span class="ident">UnquoteChar</span><span class="op">(</span><span class="ident">text</span><span class="op">[</span><span class="num">1</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">text</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">tail</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="string">&#34;&#39;&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">fmt</span><span class="op">.</span><span class="ident">Errorf</span><span class="op">(</span><span class="string">&#34;malformed&nbsp;character&nbsp;constant:&nbsp;%s&#34;</span><span class="op">,</span>&nbsp;<span class="ident">text</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">Int64</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="builtintype">rune</span><span class="op">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">IsInt</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">Uint64</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">uint64</span><span class="op">(</span><span class="builtintype">rune</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">IsUint</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">Float64</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">float64</span><span class="op">(</span><span class="builtintype">rune</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;odd&nbsp;but&nbsp;those&nbsp;are&nbsp;the&nbsp;rules.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">IsFloat</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">itemComplex</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;fmt.Sscan&nbsp;can&nbsp;parse&nbsp;the&nbsp;pair,&nbsp;so&nbsp;let&nbsp;it&nbsp;do&nbsp;the&nbsp;work.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">fmt</span><span class="op">.</span><span class="ident">Sscan</span><span class="op">(</span><span class="ident">text</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">n</span><span class="op">.</span><span class="ident">Complex128</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">IsComplex</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">simplifyComplex</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Imaginary&nbsp;constants&nbsp;can&nbsp;only&nbsp;be&nbsp;complex&nbsp;unless&nbsp;they&nbsp;are&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">text</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">text</span><span class="op">[</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">text</span><span class="op">)</span><span class="op">-</span><span class="num">1</span><span class="op">]</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#39;i&#39;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">strconv</span><span class="op">.</span><span class="ident">ParseFloat</span><span class="op">(</span><span class="ident">text</span><span class="op">[</span><span class="op">:</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">text</span><span class="op">)</span><span class="op">-</span><span class="num">1</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="num">64</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">IsComplex</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">Complex128</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">complex</span><span class="op">(</span><span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">f</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">simplifyComplex</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Do&nbsp;integer&nbsp;test&nbsp;first&nbsp;so&nbsp;we&nbsp;get&nbsp;0x123&nbsp;etc.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">u</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">strconv</span><span class="op">.</span><span class="ident">ParseUint</span><span class="op">(</span><span class="ident">text</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">64</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;will&nbsp;fail&nbsp;for&nbsp;-0;&nbsp;fixed&nbsp;below.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">IsUint</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">Uint64</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">u</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">strconv</span><span class="op">.</span><span class="ident">ParseInt</span><span class="op">(</span><span class="ident">text</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">64</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">IsInt</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">Int64</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">i</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">IsUint</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span>&nbsp;<span class="comment">//&nbsp;in&nbsp;case&nbsp;of&nbsp;-0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">Uint64</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">u</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;If&nbsp;an&nbsp;integer&nbsp;extraction&nbsp;succeeded,&nbsp;promote&nbsp;the&nbsp;float.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span><span class="op">.</span><span class="ident">IsInt</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">IsFloat</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">Float64</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">float64</span><span class="op">(</span><span class="ident">n</span><span class="op">.</span><span class="ident">Int64</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="keyword">if</span>&nbsp;<span class="ident">n</span><span class="op">.</span><span class="ident">IsUint</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">IsFloat</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">Float64</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">float64</span><span class="op">(</span><span class="ident">n</span><span class="op">.</span><span class="ident">Uint64</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">strconv</span><span class="op">.</span><span class="ident">ParseFloat</span><span class="op">(</span><span class="ident">text</span><span class="op">,</span>&nbsp;<span class="num">64</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">IsFloat</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">Float64</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;If&nbsp;a&nbsp;floating-point&nbsp;extraction&nbsp;succeeded,&nbsp;extract&nbsp;the&nbsp;int&nbsp;if&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">n</span><span class="op">.</span><span class="ident">IsInt</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="builtintype">float64</span><span class="op">(</span><span class="ident">int64</span><span class="op">(</span><span class="ident">f</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">f</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">IsInt</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">Int64</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="ident">f</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">n</span><span class="op">.</span><span class="ident">IsUint</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="builtintype">float64</span><span class="op">(</span><span class="ident">uint64</span><span class="op">(</span><span class="ident">f</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">f</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">IsUint</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">Uint64</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">uint64</span><span class="op">(</span><span class="ident">f</span><span class="op">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">n</span><span class="op">.</span><span class="ident">IsInt</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="op">!</span><span class="ident">n</span><span class="op">.</span><span class="ident">IsUint</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="op">!</span><span class="ident">n</span><span class="op">.</span><span class="ident">IsFloat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">fmt</span><span class="op">.</span><span class="ident">Errorf</span><span class="op">(</span><span class="string">&#34;illegal&nbsp;number&nbsp;syntax:&nbsp;%q&#34;</span><span class="op">,</span>&nbsp;<span class="ident">text</span><span class="op">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;simplifyComplex&nbsp;pulls&nbsp;out&nbsp;any&nbsp;other&nbsp;types&nbsp;that&nbsp;are&nbsp;represented&nbsp;by&nbsp;the&nbsp;complex&nbsp;number.</span><br>
<span class="lineno">615</span><span class="comment">//&nbsp;These&nbsp;all&nbsp;require&nbsp;that&nbsp;the&nbsp;imaginary&nbsp;part&nbsp;be&nbsp;zero.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">n</span>&nbsp;<span class="op">*</span><span class="ident">NumberNode</span><span class="op">)</span>&nbsp;<span class="ident">simplifyComplex</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">IsFloat</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">imag</span><span class="op">(</span><span class="ident">n</span><span class="op">.</span><span class="ident">Complex128</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span><span class="op">.</span><span class="ident">IsFloat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">Float64</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">real</span><span class="op">(</span><span class="ident">n</span><span class="op">.</span><span class="ident">Complex128</span><span class="op">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">IsInt</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">float64</span><span class="op">(</span><span class="ident">int64</span><span class="op">(</span><span class="ident">n</span><span class="op">.</span><span class="ident">Float64</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">n</span><span class="op">.</span><span class="ident">Float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span><span class="op">.</span><span class="ident">IsInt</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">Int64</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="ident">n</span><span class="op">.</span><span class="ident">Float64</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">IsUint</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">float64</span><span class="op">(</span><span class="ident">uint64</span><span class="op">(</span><span class="ident">n</span><span class="op">.</span><span class="ident">Float64</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">n</span><span class="op">.</span><span class="ident">Float64</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span><span class="op">.</span><span class="ident">IsUint</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">Uint64</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">uint64</span><span class="op">(</span><span class="ident">n</span><span class="op">.</span><span class="ident">Float64</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">630</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">n</span>&nbsp;<span class="op">*</span><span class="ident">NumberNode</span><span class="op">)</span>&nbsp;<span class="ident">String</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">n</span><span class="op">.</span><span class="ident">Text</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">635</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">n</span>&nbsp;<span class="op">*</span><span class="ident">NumberNode</span><span class="op">)</span>&nbsp;<span class="ident">tree</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">n</span><span class="op">.</span><span class="ident">tr</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">n</span>&nbsp;<span class="op">*</span><span class="ident">NumberNode</span><span class="op">)</span>&nbsp;<span class="ident">Copy</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">Node</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nn</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">NumberNode</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">*</span><span class="ident">nn</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">*</span><span class="ident">n</span>&nbsp;<span class="comment">//&nbsp;Easy,&nbsp;fast,&nbsp;correct.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nn</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span><span class="comment">//&nbsp;StringNode&nbsp;holds&nbsp;a&nbsp;string&nbsp;constant.&nbsp;The&nbsp;value&nbsp;has&nbsp;been&nbsp;&#34;unquoted&#34;.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">StringNode</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">Tree</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Quoted</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="comment">//&nbsp;The&nbsp;original&nbsp;text&nbsp;of&nbsp;the&nbsp;string,&nbsp;with&nbsp;quotes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Text</span>&nbsp;&nbsp;&nbsp;<span class="builtintype">string</span>&nbsp;<span class="comment">//&nbsp;The&nbsp;string,&nbsp;after&nbsp;quote&nbsp;processing.</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span><span class="op">)</span>&nbsp;<span class="ident">newString</span><span class="op">(</span><span class="ident">pos</span>&nbsp;<span class="ident">Pos</span><span class="op">,</span>&nbsp;<span class="ident">orig</span><span class="op">,</span>&nbsp;<span class="ident">text</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">StringNode</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">StringNode</span><span class="op">{</span><span class="ident">tr</span><span class="op">:</span>&nbsp;<span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">NodeType</span><span class="op">:</span>&nbsp;<span class="ident">NodeString</span><span class="op">,</span>&nbsp;<span class="ident">Pos</span><span class="op">:</span>&nbsp;<span class="ident">pos</span><span class="op">,</span>&nbsp;<span class="ident">Quoted</span><span class="op">:</span>&nbsp;<span class="ident">orig</span><span class="op">,</span>&nbsp;<span class="ident">Text</span><span class="op">:</span>&nbsp;<span class="ident">text</span><span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">s</span>&nbsp;<span class="op">*</span><span class="ident">StringNode</span><span class="op">)</span>&nbsp;<span class="ident">String</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">s</span><span class="op">.</span><span class="ident">Quoted</span><br>
<span class="lineno">660</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">s</span>&nbsp;<span class="op">*</span><span class="ident">StringNode</span><span class="op">)</span>&nbsp;<span class="ident">tree</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">s</span><span class="op">.</span><span class="ident">tr</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">665</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">s</span>&nbsp;<span class="op">*</span><span class="ident">StringNode</span><span class="op">)</span>&nbsp;<span class="ident">Copy</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">Node</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">s</span><span class="op">.</span><span class="ident">tr</span><span class="op">.</span><span class="ident">newString</span><span class="op">(</span><span class="ident">s</span><span class="op">.</span><span class="ident">Pos</span><span class="op">,</span>&nbsp;<span class="ident">s</span><span class="op">.</span><span class="ident">Quoted</span><span class="op">,</span>&nbsp;<span class="ident">s</span><span class="op">.</span><span class="ident">Text</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">670</span><span class="comment">//&nbsp;endNode&nbsp;represents&nbsp;an&nbsp;{{end}}&nbsp;action.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;It&nbsp;does&nbsp;not&nbsp;appear&nbsp;in&nbsp;the&nbsp;final&nbsp;parse&nbsp;tree.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">endNode</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Pos</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tr</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span><span class="op">)</span>&nbsp;<span class="ident">newEnd</span><span class="op">(</span><span class="ident">pos</span>&nbsp;<span class="ident">Pos</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">endNode</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">endNode</span><span class="op">{</span><span class="ident">tr</span><span class="op">:</span>&nbsp;<span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">NodeType</span><span class="op">:</span>&nbsp;<span class="ident">nodeEnd</span><span class="op">,</span>&nbsp;<span class="ident">Pos</span><span class="op">:</span>&nbsp;<span class="ident">pos</span><span class="op">}</span><br>
<span class="lineno">680</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">e</span>&nbsp;<span class="op">*</span><span class="ident">endNode</span><span class="op">)</span>&nbsp;<span class="ident">String</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="string">&#34;{{end}}&#34;</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">685</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">e</span>&nbsp;<span class="op">*</span><span class="ident">endNode</span><span class="op">)</span>&nbsp;<span class="ident">tree</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">e</span><span class="op">.</span><span class="ident">tr</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">690</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">e</span>&nbsp;<span class="op">*</span><span class="ident">endNode</span><span class="op">)</span>&nbsp;<span class="ident">Copy</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">Node</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">e</span><span class="op">.</span><span class="ident">tr</span><span class="op">.</span><span class="ident">newEnd</span><span class="op">(</span><span class="ident">e</span><span class="op">.</span><span class="ident">Pos</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;elseNode&nbsp;represents&nbsp;an&nbsp;{{else}}&nbsp;action.&nbsp;Does&nbsp;not&nbsp;appear&nbsp;in&nbsp;the&nbsp;final&nbsp;tree.</span><br>
<span class="lineno">695</span><span class="keyword">type</span>&nbsp;<span class="ident">elseNode</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tr</span>&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">Tree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Line</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="comment">//&nbsp;The&nbsp;line&nbsp;number&nbsp;in&nbsp;the&nbsp;input&nbsp;(deprecated;&nbsp;kept&nbsp;for&nbsp;compatibility)</span><br>
<span class="lineno">700</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span><span class="op">)</span>&nbsp;<span class="ident">newElse</span><span class="op">(</span><span class="ident">pos</span>&nbsp;<span class="ident">Pos</span><span class="op">,</span>&nbsp;<span class="ident">line</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">elseNode</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">elseNode</span><span class="op">{</span><span class="ident">tr</span><span class="op">:</span>&nbsp;<span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">NodeType</span><span class="op">:</span>&nbsp;<span class="ident">nodeElse</span><span class="op">,</span>&nbsp;<span class="ident">Pos</span><span class="op">:</span>&nbsp;<span class="ident">pos</span><span class="op">,</span>&nbsp;<span class="ident">Line</span><span class="op">:</span>&nbsp;<span class="ident">line</span><span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">705</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">e</span>&nbsp;<span class="op">*</span><span class="ident">elseNode</span><span class="op">)</span>&nbsp;<span class="ident">Type</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">NodeType</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nodeElse</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">710</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">e</span>&nbsp;<span class="op">*</span><span class="ident">elseNode</span><span class="op">)</span>&nbsp;<span class="ident">String</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="string">&#34;{{else}}&#34;</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">e</span>&nbsp;<span class="op">*</span><span class="ident">elseNode</span><span class="op">)</span>&nbsp;<span class="ident">tree</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">e</span><span class="op">.</span><span class="ident">tr</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">e</span>&nbsp;<span class="op">*</span><span class="ident">elseNode</span><span class="op">)</span>&nbsp;<span class="ident">Copy</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">Node</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">e</span><span class="op">.</span><span class="ident">tr</span><span class="op">.</span><span class="ident">newElse</span><span class="op">(</span><span class="ident">e</span><span class="op">.</span><span class="ident">Pos</span><span class="op">,</span>&nbsp;<span class="ident">e</span><span class="op">.</span><span class="ident">Line</span><span class="op">)</span><br>
<span class="lineno">720</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;BranchNode&nbsp;is&nbsp;the&nbsp;common&nbsp;representation&nbsp;of&nbsp;if,&nbsp;range,&nbsp;and&nbsp;with.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">BranchNode</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeType</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">Tree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Line</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;The&nbsp;line&nbsp;number&nbsp;in&nbsp;the&nbsp;input&nbsp;(deprecated;&nbsp;kept&nbsp;for&nbsp;compatibility)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Pipe</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">PipeNode</span>&nbsp;<span class="comment">//&nbsp;The&nbsp;pipeline&nbsp;to&nbsp;be&nbsp;evaluated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">List</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">ListNode</span>&nbsp;<span class="comment">//&nbsp;What&nbsp;to&nbsp;execute&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;non-empty.</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ElseList</span>&nbsp;<span class="op">*</span><span class="ident">ListNode</span>&nbsp;<span class="comment">//&nbsp;What&nbsp;to&nbsp;execute&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;empty&nbsp;(nil&nbsp;if&nbsp;absent).</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">BranchNode</span><span class="op">)</span>&nbsp;<span class="ident">String</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="string">&#34;&#34;</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">NodeType</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">NodeIf</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#34;if&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">NodeRange</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#34;range&#34;</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">NodeWith</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#34;with&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;unknown&nbsp;branch&nbsp;type&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">ElseList</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fmt</span><span class="op">.</span><span class="ident">Sprintf</span><span class="op">(</span><span class="string">&#34;{{%s&nbsp;%s}}%s{{else}}%s{{end}}&#34;</span><span class="op">,</span>&nbsp;<span class="ident">name</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">Pipe</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">List</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">ElseList</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fmt</span><span class="op">.</span><span class="ident">Sprintf</span><span class="op">(</span><span class="string">&#34;{{%s&nbsp;%s}}%s{{end}}&#34;</span><span class="op">,</span>&nbsp;<span class="ident">name</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">Pipe</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">List</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">750</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">BranchNode</span><span class="op">)</span>&nbsp;<span class="ident">tree</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">tr</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">755</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">BranchNode</span><span class="op">)</span>&nbsp;<span class="ident">Copy</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">Node</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">NodeType</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">NodeIf</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">tr</span><span class="op">.</span><span class="ident">newIf</span><span class="op">(</span><span class="ident">b</span><span class="op">.</span><span class="ident">Pos</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">Line</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">Pipe</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">List</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">ElseList</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">NodeRange</span><span class="op">:</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">tr</span><span class="op">.</span><span class="ident">newRange</span><span class="op">(</span><span class="ident">b</span><span class="op">.</span><span class="ident">Pos</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">Line</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">Pipe</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">List</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">ElseList</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">NodeWith</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">tr</span><span class="op">.</span><span class="ident">newWith</span><span class="op">(</span><span class="ident">b</span><span class="op">.</span><span class="ident">Pos</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">Line</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">Pipe</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">List</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">ElseList</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;unknown&nbsp;branch&nbsp;type&#34;</span><span class="op">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;IfNode&nbsp;represents&nbsp;an&nbsp;{{if}}&nbsp;action&nbsp;and&nbsp;its&nbsp;commands.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">IfNode</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">BranchNode</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span><span class="op">)</span>&nbsp;<span class="ident">newIf</span><span class="op">(</span><span class="ident">pos</span>&nbsp;<span class="ident">Pos</span><span class="op">,</span>&nbsp;<span class="ident">line</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">pipe</span>&nbsp;<span class="op">*</span><span class="ident">PipeNode</span><span class="op">,</span>&nbsp;<span class="ident">list</span><span class="op">,</span>&nbsp;<span class="ident">elseList</span>&nbsp;<span class="op">*</span><span class="ident">ListNode</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">IfNode</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">IfNode</span><span class="op">{</span><span class="ident">BranchNode</span><span class="op">{</span><span class="ident">tr</span><span class="op">:</span>&nbsp;<span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">NodeType</span><span class="op">:</span>&nbsp;<span class="ident">NodeIf</span><span class="op">,</span>&nbsp;<span class="ident">Pos</span><span class="op">:</span>&nbsp;<span class="ident">pos</span><span class="op">,</span>&nbsp;<span class="ident">Line</span><span class="op">:</span>&nbsp;<span class="ident">line</span><span class="op">,</span>&nbsp;<span class="ident">Pipe</span><span class="op">:</span>&nbsp;<span class="ident">pipe</span><span class="op">,</span>&nbsp;<span class="ident">List</span><span class="op">:</span>&nbsp;<span class="ident">list</span><span class="op">,</span>&nbsp;<span class="ident">ElseList</span><span class="op">:</span>&nbsp;<span class="ident">elseList</span><span class="op">}</span><span class="op">}</span><br>
<span class="lineno">775</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">IfNode</span><span class="op">)</span>&nbsp;<span class="ident">Copy</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">Node</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">i</span><span class="op">.</span><span class="ident">tr</span><span class="op">.</span><span class="ident">newIf</span><span class="op">(</span><span class="ident">i</span><span class="op">.</span><span class="ident">Pos</span><span class="op">,</span>&nbsp;<span class="ident">i</span><span class="op">.</span><span class="ident">Line</span><span class="op">,</span>&nbsp;<span class="ident">i</span><span class="op">.</span><span class="ident">Pipe</span><span class="op">.</span><span class="ident">CopyPipe</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">i</span><span class="op">.</span><span class="ident">List</span><span class="op">.</span><span class="ident">CopyList</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">i</span><span class="op">.</span><span class="ident">ElseList</span><span class="op">.</span><span class="ident">CopyList</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">780</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;RangeNode&nbsp;represents&nbsp;a&nbsp;{{range}}&nbsp;action&nbsp;and&nbsp;its&nbsp;commands.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">RangeNode</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">BranchNode</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">785</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span><span class="op">)</span>&nbsp;<span class="ident">newRange</span><span class="op">(</span><span class="ident">pos</span>&nbsp;<span class="ident">Pos</span><span class="op">,</span>&nbsp;<span class="ident">line</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">pipe</span>&nbsp;<span class="op">*</span><span class="ident">PipeNode</span><span class="op">,</span>&nbsp;<span class="ident">list</span><span class="op">,</span>&nbsp;<span class="ident">elseList</span>&nbsp;<span class="op">*</span><span class="ident">ListNode</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">RangeNode</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">RangeNode</span><span class="op">{</span><span class="ident">BranchNode</span><span class="op">{</span><span class="ident">tr</span><span class="op">:</span>&nbsp;<span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">NodeType</span><span class="op">:</span>&nbsp;<span class="ident">NodeRange</span><span class="op">,</span>&nbsp;<span class="ident">Pos</span><span class="op">:</span>&nbsp;<span class="ident">pos</span><span class="op">,</span>&nbsp;<span class="ident">Line</span><span class="op">:</span>&nbsp;<span class="ident">line</span><span class="op">,</span>&nbsp;<span class="ident">Pipe</span><span class="op">:</span>&nbsp;<span class="ident">pipe</span><span class="op">,</span>&nbsp;<span class="ident">List</span><span class="op">:</span>&nbsp;<span class="ident">list</span><span class="op">,</span>&nbsp;<span class="ident">ElseList</span><span class="op">:</span>&nbsp;<span class="ident">elseList</span><span class="op">}</span><span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">790</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">RangeNode</span><span class="op">)</span>&nbsp;<span class="ident">Copy</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">Node</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">tr</span><span class="op">.</span><span class="ident">newRange</span><span class="op">(</span><span class="ident">r</span><span class="op">.</span><span class="ident">Pos</span><span class="op">,</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">Line</span><span class="op">,</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">Pipe</span><span class="op">.</span><span class="ident">CopyPipe</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">List</span><span class="op">.</span><span class="ident">CopyList</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ElseList</span><span class="op">.</span><span class="ident">CopyList</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;WithNode&nbsp;represents&nbsp;a&nbsp;{{with}}&nbsp;action&nbsp;and&nbsp;its&nbsp;commands.</span><br>
<span class="lineno">795</span><span class="keyword">type</span>&nbsp;<span class="ident">WithNode</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">BranchNode</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span><span class="op">)</span>&nbsp;<span class="ident">newWith</span><span class="op">(</span><span class="ident">pos</span>&nbsp;<span class="ident">Pos</span><span class="op">,</span>&nbsp;<span class="ident">line</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">pipe</span>&nbsp;<span class="op">*</span><span class="ident">PipeNode</span><span class="op">,</span>&nbsp;<span class="ident">list</span><span class="op">,</span>&nbsp;<span class="ident">elseList</span>&nbsp;<span class="op">*</span><span class="ident">ListNode</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">WithNode</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">WithNode</span><span class="op">{</span><span class="ident">BranchNode</span><span class="op">{</span><span class="ident">tr</span><span class="op">:</span>&nbsp;<span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">NodeType</span><span class="op">:</span>&nbsp;<span class="ident">NodeWith</span><span class="op">,</span>&nbsp;<span class="ident">Pos</span><span class="op">:</span>&nbsp;<span class="ident">pos</span><span class="op">,</span>&nbsp;<span class="ident">Line</span><span class="op">:</span>&nbsp;<span class="ident">line</span><span class="op">,</span>&nbsp;<span class="ident">Pipe</span><span class="op">:</span>&nbsp;<span class="ident">pipe</span><span class="op">,</span>&nbsp;<span class="ident">List</span><span class="op">:</span>&nbsp;<span class="ident">list</span><span class="op">,</span>&nbsp;<span class="ident">ElseList</span><span class="op">:</span>&nbsp;<span class="ident">elseList</span><span class="op">}</span><span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">w</span>&nbsp;<span class="op">*</span><span class="ident">WithNode</span><span class="op">)</span>&nbsp;<span class="ident">Copy</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">Node</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">tr</span><span class="op">.</span><span class="ident">newWith</span><span class="op">(</span><span class="ident">w</span><span class="op">.</span><span class="ident">Pos</span><span class="op">,</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">Line</span><span class="op">,</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">Pipe</span><span class="op">.</span><span class="ident">CopyPipe</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">List</span><span class="op">.</span><span class="ident">CopyList</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">ElseList</span><span class="op">.</span><span class="ident">CopyList</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">805</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;TemplateNode&nbsp;represents&nbsp;a&nbsp;{{template}}&nbsp;action.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">TemplateNode</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NodeType</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tr</span>&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">Tree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Line</span>&nbsp;<span class="builtintype">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;The&nbsp;line&nbsp;number&nbsp;in&nbsp;the&nbsp;input&nbsp;(deprecated;&nbsp;kept&nbsp;for&nbsp;compatibility)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Name</span>&nbsp;<span class="builtintype">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;The&nbsp;name&nbsp;of&nbsp;the&nbsp;template&nbsp;(unquoted).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Pipe</span>&nbsp;<span class="op">*</span><span class="ident">PipeNode</span>&nbsp;<span class="comment">//&nbsp;The&nbsp;command&nbsp;to&nbsp;evaluate&nbsp;as&nbsp;dot&nbsp;for&nbsp;the&nbsp;template.</span><br>
<span class="lineno">815</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span><span class="op">)</span>&nbsp;<span class="ident">newTemplate</span><span class="op">(</span><span class="ident">pos</span>&nbsp;<span class="ident">Pos</span><span class="op">,</span>&nbsp;<span class="ident">line</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">name</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">pipe</span>&nbsp;<span class="op">*</span><span class="ident">PipeNode</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">TemplateNode</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">TemplateNode</span><span class="op">{</span><span class="ident">tr</span><span class="op">:</span>&nbsp;<span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">NodeType</span><span class="op">:</span>&nbsp;<span class="ident">NodeTemplate</span><span class="op">,</span>&nbsp;<span class="ident">Pos</span><span class="op">:</span>&nbsp;<span class="ident">pos</span><span class="op">,</span>&nbsp;<span class="ident">Line</span><span class="op">:</span>&nbsp;<span class="ident">line</span><span class="op">,</span>&nbsp;<span class="ident">Name</span><span class="op">:</span>&nbsp;<span class="ident">name</span><span class="op">,</span>&nbsp;<span class="ident">Pipe</span><span class="op">:</span>&nbsp;<span class="ident">pipe</span><span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">820</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">TemplateNode</span><span class="op">)</span>&nbsp;<span class="ident">String</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Pipe</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fmt</span><span class="op">.</span><span class="ident">Sprintf</span><span class="op">(</span><span class="string">&#34;{{template&nbsp;%q}}&#34;</span><span class="op">,</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Name</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fmt</span><span class="op">.</span><span class="ident">Sprintf</span><span class="op">(</span><span class="string">&#34;{{template&nbsp;%q&nbsp;%s}}&#34;</span><span class="op">,</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Name</span><span class="op">,</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Pipe</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">TemplateNode</span><span class="op">)</span>&nbsp;<span class="ident">tree</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Tree</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">tr</span><br>
<span class="lineno">830</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">TemplateNode</span><span class="op">)</span>&nbsp;<span class="ident">Copy</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">Node</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">tr</span><span class="op">.</span><span class="ident">newTemplate</span><span class="op">(</span><span class="ident">t</span><span class="op">.</span><span class="ident">Pos</span><span class="op">,</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Line</span><span class="op">,</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Name</span><span class="op">,</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Pipe</span><span class="op">.</span><span class="ident">CopyPipe</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span>
</div>
</body>
</html>
