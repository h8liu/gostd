<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment">//&nbsp;Package&nbsp;bzip2&nbsp;implements&nbsp;bzip2&nbsp;decompression.</span><br>
<span class="lineno"></span><span class="keyword">package</span>&nbsp;<span class="ident">bzip2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="string">&#34;io&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment">//&nbsp;There&#39;s&nbsp;no&nbsp;RFC&nbsp;for&nbsp;bzip2.&nbsp;I&nbsp;used&nbsp;the&nbsp;Wikipedia&nbsp;page&nbsp;for&nbsp;reference&nbsp;and&nbsp;a&nbsp;lot</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;of&nbsp;guessing:&nbsp;http://en.wikipedia.org/wiki/Bzip2</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;source&nbsp;code&nbsp;to&nbsp;pyflate&nbsp;was&nbsp;useful&nbsp;for&nbsp;debugging:</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;http://www.paul.sladen.org/projects/pyflate</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment">//&nbsp;A&nbsp;StructuralError&nbsp;is&nbsp;returned&nbsp;when&nbsp;the&nbsp;bzip2&nbsp;data&nbsp;is&nbsp;found&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;syntactically&nbsp;invalid.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">StructuralError</span>&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">s</span>&nbsp;<span class="ident">StructuralError</span><span class="op">)</span>&nbsp;<span class="ident">Error</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="string">&#34;bzip2&nbsp;data&nbsp;invalid:&nbsp;&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="builtintype">string</span><span class="op">(</span><span class="ident">s</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;A&nbsp;reader&nbsp;decompresses&nbsp;bzip2&nbsp;compressed&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">reader</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">br</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">bitReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fileCRC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">blockCRC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">wantBlockCRC</span>&nbsp;<span class="builtintype">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">setupDone</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="comment">//&nbsp;true&nbsp;if&nbsp;we&nbsp;have&nbsp;parsed&nbsp;the&nbsp;bzip2&nbsp;header.</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">blockSize</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">int</span>&nbsp;&nbsp;<span class="comment">//&nbsp;blockSize&nbsp;in&nbsp;bytes,&nbsp;i.e.&nbsp;900&nbsp;*&nbsp;1024.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">eof</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;stores&nbsp;Burrows-Wheeler&nbsp;transformed&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">[</span><span class="num">256</span><span class="op">]</span><span class="builtintype">uint</span>&nbsp;<span class="comment">//&nbsp;the&nbsp;`C&#39;&nbsp;array&nbsp;for&nbsp;the&nbsp;inverse&nbsp;BWT.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uint32</span>&nbsp;&nbsp;<span class="comment">//&nbsp;mirrors&nbsp;the&nbsp;`tt&#39;&nbsp;array&nbsp;in&nbsp;the&nbsp;bzip2&nbsp;source&nbsp;and&nbsp;contains&nbsp;the&nbsp;P&nbsp;array&nbsp;in&nbsp;the&nbsp;upper&nbsp;24&nbsp;bits.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tPos</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">uint32</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Index&nbsp;of&nbsp;the&nbsp;next&nbsp;output&nbsp;byte&nbsp;in&nbsp;tt.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">preRLE</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uint32</span>&nbsp;<span class="comment">//&nbsp;contains&nbsp;the&nbsp;RLE&nbsp;data&nbsp;still&nbsp;to&nbsp;be&nbsp;processed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">preRLEUsed</span>&nbsp;&nbsp;<span class="builtintype">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;number&nbsp;of&nbsp;entries&nbsp;of&nbsp;preRLE&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lastByte</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;the&nbsp;last&nbsp;byte&nbsp;value&nbsp;seen.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">byteRepeats</span>&nbsp;<span class="builtintype">uint</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;the&nbsp;number&nbsp;of&nbsp;repeats&nbsp;of&nbsp;lastByte&nbsp;seen.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">repeats</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">uint</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;the&nbsp;number&nbsp;of&nbsp;copies&nbsp;of&nbsp;lastByte&nbsp;to&nbsp;output.</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;NewReader&nbsp;returns&nbsp;an&nbsp;io.Reader&nbsp;which&nbsp;decompresses&nbsp;bzip2&nbsp;data&nbsp;from&nbsp;r.</span><br>
<span class="lineno">45</span><span class="comment">//&nbsp;If&nbsp;r&nbsp;does&nbsp;not&nbsp;also&nbsp;implement&nbsp;io.ByteReader,</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;the&nbsp;decompressor&nbsp;may&nbsp;read&nbsp;more&nbsp;data&nbsp;than&nbsp;necessary&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">NewReader</span><span class="op">(</span><span class="ident">r</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">Reader</span><span class="op">)</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">Reader</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">reader</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span><span class="op">.</span><span class="ident">br</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">newBitReader</span><span class="op">(</span><span class="ident">r</span><span class="op">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">bz2</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">const</span>&nbsp;<span class="ident">bzip2FileMagic</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0x425a</span>&nbsp;<span class="comment">//&nbsp;&#34;BZ&#34;</span><br>
<span class="lineno"></span><span class="keyword">const</span>&nbsp;<span class="ident">bzip2BlockMagic</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0x314159265359</span><br>
<span class="lineno">55</span><span class="keyword">const</span>&nbsp;<span class="ident">bzip2FinalMagic</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0x177245385090</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;setup&nbsp;parses&nbsp;the&nbsp;bzip2&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">bz2</span>&nbsp;<span class="op">*</span><span class="ident">reader</span><span class="op">)</span>&nbsp;<span class="ident">setup</span><span class="op">(</span><span class="ident">needMagic</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">br</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">bz2</span><span class="op">.</span><span class="ident">br</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">needMagic</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">magic</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">br</span><span class="op">.</span><span class="ident">ReadBits</span><span class="op">(</span><span class="num">16</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">magic</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">bzip2FileMagic</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">StructuralError</span><span class="op">(</span><span class="string">&#34;bad&nbsp;magic&nbsp;value&#34;</span><span class="op">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">br</span><span class="op">.</span><span class="ident">ReadBits</span><span class="op">(</span><span class="num">8</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">t</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="string">&#39;h&#39;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">StructuralError</span><span class="op">(</span><span class="string">&#34;non-Huffman&nbsp;entropy&nbsp;encoding&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">level</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">br</span><span class="op">.</span><span class="ident">ReadBits</span><span class="op">(</span><span class="num">8</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">level</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="string">&#39;1&#39;</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">level</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="string">&#39;9&#39;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">StructuralError</span><span class="op">(</span><span class="string">&#34;invalid&nbsp;compression&nbsp;level&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span><span class="op">.</span><span class="ident">fileCRC</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span><span class="op">.</span><span class="ident">blockSize</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">100</span>&nbsp;<span class="op">*</span>&nbsp;<span class="num">1024</span>&nbsp;<span class="op">*</span>&nbsp;<span class="op">(</span><span class="builtintype">int</span><span class="op">(</span><span class="ident">level</span><span class="op">)</span>&nbsp;<span class="op">-</span>&nbsp;<span class="string">&#39;0&#39;</span><span class="op">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">bz2</span><span class="op">.</span><span class="ident">blockSize</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">bz2</span><span class="op">.</span><span class="ident">tt</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span><span class="op">.</span><span class="ident">tt</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">uint32</span><span class="op">,</span>&nbsp;<span class="ident">bz2</span><span class="op">.</span><span class="ident">blockSize</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">bz2</span>&nbsp;<span class="op">*</span><span class="ident">reader</span><span class="op">)</span>&nbsp;<span class="ident">Read</span><span class="op">(</span><span class="ident">buf</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">n</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">bz2</span><span class="op">.</span><span class="ident">eof</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">bz2</span><span class="op">.</span><span class="ident">setupDone</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">bz2</span><span class="op">.</span><span class="ident">setup</span><span class="op">(</span><span class="ident">true</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">brErr</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">bz2</span><span class="op">.</span><span class="ident">br</span><span class="op">.</span><span class="ident">Err</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">brErr</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">brErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span><span class="op">.</span><span class="ident">setupDone</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">bz2</span><span class="op">.</span><span class="ident">read</span><span class="op">(</span><span class="ident">buf</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">brErr</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">bz2</span><span class="op">.</span><span class="ident">br</span><span class="op">.</span><span class="ident">Err</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">brErr</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">brErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">bz2</span>&nbsp;<span class="op">*</span><span class="ident">reader</span><span class="op">)</span>&nbsp;<span class="ident">readFromBlock</span><span class="op">(</span><span class="ident">buf</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;bzip2&nbsp;is&nbsp;a&nbsp;block&nbsp;based&nbsp;compressor,&nbsp;except&nbsp;that&nbsp;it&nbsp;has&nbsp;a&nbsp;run-length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;preprocessing&nbsp;step.&nbsp;The&nbsp;block&nbsp;based&nbsp;nature&nbsp;means&nbsp;that&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;preallocate&nbsp;fixed-size&nbsp;buffers&nbsp;and&nbsp;reuse&nbsp;them.&nbsp;However,&nbsp;the&nbsp;RLE</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;preprocessing&nbsp;would&nbsp;require&nbsp;allocating&nbsp;huge&nbsp;buffers&nbsp;to&nbsp;store&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;maximum&nbsp;expansion.&nbsp;Thus&nbsp;we&nbsp;process&nbsp;blocks&nbsp;all&nbsp;at&nbsp;once,&nbsp;except&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;the&nbsp;RLE&nbsp;which&nbsp;we&nbsp;decompress&nbsp;as&nbsp;required.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="op">(</span><span class="ident">bz2</span><span class="op">.</span><span class="ident">repeats</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">bz2</span><span class="op">.</span><span class="ident">preRLEUsed</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">bz2</span><span class="op">.</span><span class="ident">preRLE</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">buf</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&nbsp;have&nbsp;RLE&nbsp;data&nbsp;pending.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;run-length&nbsp;encoding&nbsp;works&nbsp;like&nbsp;this:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Any&nbsp;sequence&nbsp;of&nbsp;four&nbsp;equal&nbsp;bytes&nbsp;is&nbsp;followed&nbsp;by&nbsp;a&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;byte&nbsp;which&nbsp;contains&nbsp;the&nbsp;number&nbsp;of&nbsp;repeats&nbsp;of&nbsp;that&nbsp;byte&nbsp;to</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;include.&nbsp;(The&nbsp;number&nbsp;of&nbsp;repeats&nbsp;can&nbsp;be&nbsp;zero.)&nbsp;Because&nbsp;we&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;decompressing&nbsp;on-demand&nbsp;our&nbsp;state&nbsp;is&nbsp;kept&nbsp;in&nbsp;the&nbsp;reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;object.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">bz2</span><span class="op">.</span><span class="ident">repeats</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">buf</span><span class="op">[</span><span class="ident">n</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">byte</span><span class="op">(</span><span class="ident">bz2</span><span class="op">.</span><span class="ident">lastByte</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span><span class="op">.</span><span class="ident">repeats</span><span class="op">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">bz2</span><span class="op">.</span><span class="ident">repeats</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span><span class="op">.</span><span class="ident">lastByte</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">-</span><span class="num">1</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span><span class="op">.</span><span class="ident">tPos</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">bz2</span><span class="op">.</span><span class="ident">preRLE</span><span class="op">[</span><span class="ident">bz2</span><span class="op">.</span><span class="ident">tPos</span><span class="op">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">byte</span><span class="op">(</span><span class="ident">bz2</span><span class="op">.</span><span class="ident">tPos</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span><span class="op">.</span><span class="ident">tPos</span>&nbsp;<span class="op">&gt;&gt;=</span>&nbsp;<span class="num">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span><span class="op">.</span><span class="ident">preRLEUsed</span><span class="op">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">bz2</span><span class="op">.</span><span class="ident">byteRepeats</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">3</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span><span class="op">.</span><span class="ident">repeats</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">uint</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span><span class="op">.</span><span class="ident">byteRepeats</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">bz2</span><span class="op">.</span><span class="ident">lastByte</span>&nbsp;<span class="op">==</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span><span class="op">.</span><span class="ident">byteRepeats</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span><span class="op">.</span><span class="ident">byteRepeats</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span><span class="op">.</span><span class="ident">lastByte</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">buf</span><span class="op">[</span><span class="ident">n</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">n</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">bz2</span>&nbsp;<span class="op">*</span><span class="ident">reader</span><span class="op">)</span>&nbsp;<span class="ident">read</span><span class="op">(</span><span class="ident">buf</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">bz2</span><span class="op">.</span><span class="ident">readFromBlock</span><span class="op">(</span><span class="ident">buf</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span><span class="op">.</span><span class="ident">blockCRC</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">updateCRC</span><span class="op">(</span><span class="ident">bz2</span><span class="op">.</span><span class="ident">blockCRC</span><span class="op">,</span>&nbsp;<span class="ident">buf</span><span class="op">[</span><span class="op">:</span><span class="ident">n</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;End&nbsp;of&nbsp;block.&nbsp;Check&nbsp;CRC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">bz2</span><span class="op">.</span><span class="ident">blockCRC</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">bz2</span><span class="op">.</span><span class="ident">wantBlockCRC</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span><span class="op">.</span><span class="ident">br</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">StructuralError</span><span class="op">(</span><span class="string">&#34;block&nbsp;checksum&nbsp;mismatch&#34;</span><span class="op">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">bz2</span><span class="op">.</span><span class="ident">br</span><span class="op">.</span><span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Find&nbsp;next&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">br</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">bz2</span><span class="op">.</span><span class="ident">br</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">br</span><span class="op">.</span><span class="ident">ReadBits64</span><span class="op">(</span><span class="num">48</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">StructuralError</span><span class="op">(</span><span class="string">&#34;bad&nbsp;magic&nbsp;value&nbsp;found&#34;</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">bzip2BlockMagic</span><span class="op">:</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Start&nbsp;of&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">bz2</span><span class="op">.</span><span class="ident">readBlock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">bzip2FinalMagic</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Check&nbsp;end-of-file&nbsp;CRC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">wantFileCRC</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">uint32</span><span class="op">(</span><span class="ident">br</span><span class="op">.</span><span class="ident">ReadBits64</span><span class="op">(</span><span class="num">32</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">br</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">br</span><span class="op">.</span><span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">bz2</span><span class="op">.</span><span class="ident">fileCRC</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">wantFileCRC</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">br</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">StructuralError</span><span class="op">(</span><span class="string">&#34;file&nbsp;checksum&nbsp;mismatch&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">br</span><span class="op">.</span><span class="ident">err</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Skip&nbsp;ahead&nbsp;to&nbsp;byte&nbsp;boundary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Is&nbsp;there&nbsp;a&nbsp;file&nbsp;concatenated&nbsp;to&nbsp;this&nbsp;one?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;It&nbsp;would&nbsp;start&nbsp;with&nbsp;BZ.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">br</span><span class="op">.</span><span class="ident">bits</span><span class="op">%</span><span class="num">8</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">br</span><span class="op">.</span><span class="ident">ReadBits</span><span class="op">(</span><span class="ident">br</span><span class="op">.</span><span class="ident">bits</span>&nbsp;<span class="op">%</span>&nbsp;<span class="num">8</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">br</span><span class="op">.</span><span class="ident">r</span><span class="op">.</span><span class="ident">ReadByte</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">EOF</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">br</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span><span class="op">.</span><span class="ident">eof</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">br</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">br</span><span class="op">.</span><span class="ident">r</span><span class="op">.</span><span class="ident">ReadByte</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">EOF</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">br</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="string">&#39;B&#39;</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">z</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="string">&#39;Z&#39;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">StructuralError</span><span class="op">(</span><span class="string">&#34;bad&nbsp;magic&nbsp;value&nbsp;in&nbsp;continuation&nbsp;file&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">bz2</span><span class="op">.</span><span class="ident">setup</span><span class="op">(</span><span class="ident">false</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;readBlock&nbsp;reads&nbsp;a&nbsp;bzip2&nbsp;block.&nbsp;The&nbsp;magic&nbsp;number&nbsp;should&nbsp;already&nbsp;have&nbsp;been&nbsp;consumed.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">bz2</span>&nbsp;<span class="op">*</span><span class="ident">reader</span><span class="op">)</span>&nbsp;<span class="ident">readBlock</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">br</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">bz2</span><span class="op">.</span><span class="ident">br</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span><span class="op">.</span><span class="ident">wantBlockCRC</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">uint32</span><span class="op">(</span><span class="ident">br</span><span class="op">.</span><span class="ident">ReadBits64</span><span class="op">(</span><span class="num">32</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;skip&nbsp;checksum.&nbsp;TODO:&nbsp;check&nbsp;it&nbsp;if&nbsp;we&nbsp;can&nbsp;figure&nbsp;out&nbsp;what&nbsp;it&nbsp;is.</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span><span class="op">.</span><span class="ident">blockCRC</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span><span class="op">.</span><span class="ident">fileCRC</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">(</span><span class="ident">bz2</span><span class="op">.</span><span class="ident">fileCRC</span><span class="op">&lt;&lt;</span><span class="num">1</span>&nbsp;<span class="op">|</span>&nbsp;<span class="ident">bz2</span><span class="op">.</span><span class="ident">fileCRC</span><span class="op">&gt;&gt;</span><span class="num">31</span><span class="op">)</span>&nbsp;<span class="op">^</span>&nbsp;<span class="ident">bz2</span><span class="op">.</span><span class="ident">wantBlockCRC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">randomized</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">br</span><span class="op">.</span><span class="ident">ReadBits</span><span class="op">(</span><span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">randomized</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">StructuralError</span><span class="op">(</span><span class="string">&#34;deprecated&nbsp;randomized&nbsp;files&#34;</span><span class="op">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">origPtr</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">uint</span><span class="op">(</span><span class="ident">br</span><span class="op">.</span><span class="ident">ReadBits</span><span class="op">(</span><span class="num">24</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;If&nbsp;not&nbsp;every&nbsp;byte&nbsp;value&nbsp;is&nbsp;used&nbsp;in&nbsp;the&nbsp;block&nbsp;(i.e.,&nbsp;it&#39;s&nbsp;text)&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;the&nbsp;symbol&nbsp;set&nbsp;is&nbsp;reduced.&nbsp;The&nbsp;symbols&nbsp;used&nbsp;are&nbsp;stored&nbsp;as&nbsp;a</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;two-level,&nbsp;16x16&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">symbolRangeUsedBitmap</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">br</span><span class="op">.</span><span class="ident">ReadBits</span><span class="op">(</span><span class="num">16</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">symbolPresent</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">bool</span><span class="op">,</span>&nbsp;<span class="num">256</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">numSymbols</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">symRange</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">uint</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">symRange</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">16</span><span class="op">;</span>&nbsp;<span class="ident">symRange</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">symbolRangeUsedBitmap</span><span class="op">&amp;</span><span class="op">(</span><span class="num">1</span><span class="op">&lt;&lt;</span><span class="op">(</span><span class="num">15</span><span class="op">-</span><span class="ident">symRange</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bits</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">br</span><span class="op">.</span><span class="ident">ReadBits</span><span class="op">(</span><span class="num">16</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">symbol</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">uint</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">symbol</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">16</span><span class="op">;</span>&nbsp;<span class="ident">symbol</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">bits</span><span class="op">&amp;</span><span class="op">(</span><span class="num">1</span><span class="op">&lt;&lt;</span><span class="op">(</span><span class="num">15</span><span class="op">-</span><span class="ident">symbol</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">symbolPresent</span><span class="op">[</span><span class="num">16</span><span class="op">*</span><span class="ident">symRange</span><span class="op">+</span><span class="ident">symbol</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">numSymbols</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">numSymbols</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;There&nbsp;must&nbsp;be&nbsp;an&nbsp;EOF&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">StructuralError</span><span class="op">(</span><span class="string">&#34;no&nbsp;symbols&nbsp;in&nbsp;input&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;A&nbsp;block&nbsp;uses&nbsp;between&nbsp;two&nbsp;and&nbsp;six&nbsp;different&nbsp;Huffman&nbsp;trees.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">numHuffmanTrees</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">br</span><span class="op">.</span><span class="ident">ReadBits</span><span class="op">(</span><span class="num">3</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">numHuffmanTrees</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">2</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">numHuffmanTrees</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">6</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">StructuralError</span><span class="op">(</span><span class="string">&#34;invalid&nbsp;number&nbsp;of&nbsp;Huffman&nbsp;trees&#34;</span><span class="op">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;Huffman&nbsp;tree&nbsp;can&nbsp;switch&nbsp;every&nbsp;50&nbsp;symbols&nbsp;so&nbsp;there&#39;s&nbsp;a&nbsp;list&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;tree&nbsp;indexes&nbsp;telling&nbsp;us&nbsp;which&nbsp;tree&nbsp;to&nbsp;use&nbsp;for&nbsp;each&nbsp;50&nbsp;symbol&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">numSelectors</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">br</span><span class="op">.</span><span class="ident">ReadBits</span><span class="op">(</span><span class="num">15</span><span class="op">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">treeIndexes</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">uint8</span><span class="op">,</span>&nbsp;<span class="ident">numSelectors</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;tree&nbsp;indexes&nbsp;are&nbsp;move-to-front&nbsp;transformed&nbsp;and&nbsp;stored&nbsp;as&nbsp;unary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;numbers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mtfTreeDecoder</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">newMTFDecoderWithRange</span><span class="op">(</span><span class="ident">numHuffmanTrees</span><span class="op">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">treeIndexes</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">inc</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">br</span><span class="op">.</span><span class="ident">ReadBits</span><span class="op">(</span><span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">inc</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">c</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="ident">numHuffmanTrees</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">StructuralError</span><span class="op">(</span><span class="string">&#34;tree&nbsp;index&nbsp;too&nbsp;large&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">treeIndexes</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">uint8</span><span class="op">(</span><span class="ident">mtfTreeDecoder</span><span class="op">.</span><span class="ident">Decode</span><span class="op">(</span><span class="ident">c</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;list&nbsp;of&nbsp;symbols&nbsp;for&nbsp;the&nbsp;move-to-front&nbsp;transform&nbsp;is&nbsp;taken&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;the&nbsp;previously&nbsp;decoded&nbsp;symbol&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">symbols</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">numSymbols</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nextSymbol</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">256</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">symbolPresent</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">symbols</span><span class="op">[</span><span class="ident">nextSymbol</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">byte</span><span class="op">(</span><span class="ident">i</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nextSymbol</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mtf</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">newMTFDecoder</span><span class="op">(</span><span class="ident">symbols</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">numSymbols</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="num">2</span>&nbsp;<span class="comment">//&nbsp;to&nbsp;account&nbsp;for&nbsp;RUNA&nbsp;and&nbsp;RUNB&nbsp;symbols</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">huffmanTrees</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="ident">huffmanTree</span><span class="op">,</span>&nbsp;<span class="ident">numHuffmanTrees</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Now&nbsp;we&nbsp;decode&nbsp;the&nbsp;arrays&nbsp;of&nbsp;code-lengths&nbsp;for&nbsp;each&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lengths</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">uint8</span><span class="op">,</span>&nbsp;<span class="ident">numSymbols</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">huffmanTrees</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;code&nbsp;lengths&nbsp;are&nbsp;delta&nbsp;encoded&nbsp;from&nbsp;a&nbsp;5-bit&nbsp;base&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">length</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">br</span><span class="op">.</span><span class="ident">ReadBits</span><span class="op">(</span><span class="num">5</span><span class="op">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">lengths</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">br</span><span class="op">.</span><span class="ident">ReadBit</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">br</span><span class="op">.</span><span class="ident">ReadBit</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">length</span><span class="op">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">length</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">length</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">length</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">20</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">StructuralError</span><span class="op">(</span><span class="string">&#34;Huffman&nbsp;length&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lengths</span><span class="op">[</span><span class="ident">j</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">uint8</span><span class="op">(</span><span class="ident">length</span><span class="op">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">huffmanTrees</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">newHuffmanTree</span><span class="op">(</span><span class="ident">lengths</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">selectorIndex</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="comment">//&nbsp;the&nbsp;next&nbsp;tree&nbsp;index&nbsp;to&nbsp;use</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">treeIndexes</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">StructuralError</span><span class="op">(</span><span class="string">&#34;no&nbsp;tree&nbsp;selectors&nbsp;given&#34;</span><span class="op">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">treeIndexes</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">huffmanTrees</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">StructuralError</span><span class="op">(</span><span class="string">&#34;tree&nbsp;selector&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">currentHuffmanTree</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">huffmanTrees</span><span class="op">[</span><span class="ident">treeIndexes</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">]</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bufIndex</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="comment">//&nbsp;indexes&nbsp;bz2.buf,&nbsp;the&nbsp;output&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;output&nbsp;of&nbsp;the&nbsp;move-to-front&nbsp;transform&nbsp;is&nbsp;run-length&nbsp;encoded&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;we&nbsp;merge&nbsp;the&nbsp;decoding&nbsp;into&nbsp;the&nbsp;Huffman&nbsp;parsing&nbsp;loop.&nbsp;These&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;variables&nbsp;accumulate&nbsp;the&nbsp;repeat&nbsp;count.&nbsp;See&nbsp;the&nbsp;Wikipedia&nbsp;page&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;details.</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">repeat</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">repeat_power</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;`C&#39;&nbsp;array&nbsp;(used&nbsp;by&nbsp;the&nbsp;inverse&nbsp;BWT)&nbsp;needs&nbsp;to&nbsp;be&nbsp;zero&nbsp;initialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">bz2</span><span class="op">.</span><span class="ident">c</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span><span class="op">.</span><span class="ident">c</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">decoded</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="comment">//&nbsp;counts&nbsp;the&nbsp;number&nbsp;of&nbsp;symbols&nbsp;decoded&nbsp;by&nbsp;the&nbsp;current&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">decoded</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">50</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">selectorIndex</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="ident">numSelectors</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">StructuralError</span><span class="op">(</span><span class="string">&#34;insufficient&nbsp;selector&nbsp;indices&nbsp;for&nbsp;number&nbsp;of&nbsp;symbols&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">treeIndexes</span><span class="op">[</span><span class="ident">selectorIndex</span><span class="op">]</span><span class="op">)</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">huffmanTrees</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">StructuralError</span><span class="op">(</span><span class="string">&#34;tree&nbsp;selector&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">currentHuffmanTree</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">huffmanTrees</span><span class="op">[</span><span class="ident">treeIndexes</span><span class="op">[</span><span class="ident">selectorIndex</span><span class="op">]</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">selectorIndex</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">decoded</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">currentHuffmanTree</span><span class="op">.</span><span class="ident">Decode</span><span class="op">(</span><span class="ident">br</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">decoded</span><span class="op">++</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">2</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;This&nbsp;is&nbsp;either&nbsp;the&nbsp;RUNA&nbsp;or&nbsp;RUNB&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">repeat</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">repeat_power</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">repeat</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">repeat_power</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="ident">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">repeat_power</span>&nbsp;<span class="op">&lt;&lt;=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;This&nbsp;limit&nbsp;of&nbsp;2&nbsp;million&nbsp;comes&nbsp;from&nbsp;the&nbsp;bzip2&nbsp;source</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;code.&nbsp;It&nbsp;prevents&nbsp;repeat&nbsp;from&nbsp;overflowing.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">repeat</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">2</span><span class="op">*</span><span class="num">1024</span><span class="op">*</span><span class="num">1024</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">StructuralError</span><span class="op">(</span><span class="string">&#34;repeat&nbsp;count&nbsp;too&nbsp;large&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">repeat</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&nbsp;have&nbsp;decoded&nbsp;a&nbsp;complete&nbsp;run-length&nbsp;so&nbsp;we&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;replicate&nbsp;the&nbsp;last&nbsp;output&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">repeat</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">bz2</span><span class="op">.</span><span class="ident">blockSize</span><span class="op">-</span><span class="ident">bufIndex</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">StructuralError</span><span class="op">(</span><span class="string">&#34;repeats&nbsp;past&nbsp;end&nbsp;of&nbsp;block&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">repeat</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">byte</span><span class="op">(</span><span class="ident">mtf</span><span class="op">.</span><span class="ident">First</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span><span class="op">.</span><span class="ident">tt</span><span class="op">[</span><span class="ident">bufIndex</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">uint32</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span><span class="op">.</span><span class="ident">c</span><span class="op">[</span><span class="ident">b</span><span class="op">]</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bufIndex</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">repeat</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">v</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">numSymbols</span><span class="op">-</span><span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;This&nbsp;is&nbsp;the&nbsp;EOF&nbsp;symbol.&nbsp;Because&nbsp;it&#39;s&nbsp;always&nbsp;at&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;end&nbsp;of&nbsp;the&nbsp;move-to-front&nbsp;list,&nbsp;and&nbsp;never&nbsp;gets&nbsp;moved</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;to&nbsp;the&nbsp;front,&nbsp;it&nbsp;has&nbsp;this&nbsp;unique&nbsp;value.</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Since&nbsp;two&nbsp;metasymbols&nbsp;(RUNA&nbsp;and&nbsp;RUNB)&nbsp;have&nbsp;values&nbsp;0&nbsp;and&nbsp;1,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;one&nbsp;would&nbsp;expect&nbsp;|v-2|&nbsp;to&nbsp;be&nbsp;passed&nbsp;to&nbsp;the&nbsp;MTF&nbsp;decoder.</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;However,&nbsp;the&nbsp;front&nbsp;of&nbsp;the&nbsp;MTF&nbsp;list&nbsp;is&nbsp;never&nbsp;referenced&nbsp;as&nbsp;0,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;it&#39;s&nbsp;always&nbsp;referenced&nbsp;with&nbsp;a&nbsp;run-length&nbsp;of&nbsp;1.&nbsp;Thus&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;doesn&#39;t&nbsp;need&nbsp;to&nbsp;be&nbsp;encoded&nbsp;and&nbsp;we&nbsp;have&nbsp;|v-1|&nbsp;in&nbsp;the&nbsp;next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">byte</span><span class="op">(</span><span class="ident">mtf</span><span class="op">.</span><span class="ident">Decode</span><span class="op">(</span><span class="builtintype">int</span><span class="op">(</span><span class="ident">v</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">bufIndex</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="ident">bz2</span><span class="op">.</span><span class="ident">blockSize</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">StructuralError</span><span class="op">(</span><span class="string">&#34;data&nbsp;exceeds&nbsp;block&nbsp;size&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span><span class="op">.</span><span class="ident">tt</span><span class="op">[</span><span class="ident">bufIndex</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">uint32</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span><span class="op">.</span><span class="ident">c</span><span class="op">[</span><span class="ident">b</span><span class="op">]</span><span class="op">++</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bufIndex</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">origPtr</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="builtintype">uint</span><span class="op">(</span><span class="ident">bufIndex</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">StructuralError</span><span class="op">(</span><span class="string">&#34;origPtr&nbsp;out&nbsp;of&nbsp;bounds&#34;</span><span class="op">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&nbsp;have&nbsp;completed&nbsp;the&nbsp;entropy&nbsp;decoding.&nbsp;Now&nbsp;we&nbsp;can&nbsp;perform&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;inverse&nbsp;BWT&nbsp;and&nbsp;setup&nbsp;the&nbsp;RLE&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span><span class="op">.</span><span class="ident">preRLE</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">bz2</span><span class="op">.</span><span class="ident">tt</span><span class="op">[</span><span class="op">:</span><span class="ident">bufIndex</span><span class="op">]</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span><span class="op">.</span><span class="ident">preRLEUsed</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span><span class="op">.</span><span class="ident">tPos</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">inverseBWT</span><span class="op">(</span><span class="ident">bz2</span><span class="op">.</span><span class="ident">preRLE</span><span class="op">,</span>&nbsp;<span class="ident">origPtr</span><span class="op">,</span>&nbsp;<span class="ident">bz2</span><span class="op">.</span><span class="ident">c</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span><span class="op">.</span><span class="ident">lastByte</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">-</span><span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span><span class="op">.</span><span class="ident">byteRepeats</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bz2</span><span class="op">.</span><span class="ident">repeats</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;inverseBWT&nbsp;implements&nbsp;the&nbsp;inverse&nbsp;Burrows-Wheeler&nbsp;transform&nbsp;as&nbsp;described&nbsp;in</span><br>
<span class="lineno">450</span><span class="comment">//&nbsp;http://www.hpl.hp.com/techreports/Compaq-DEC/SRC-RR-124.pdf,&nbsp;section&nbsp;4.2.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;In&nbsp;that&nbsp;document,&nbsp;origPtr&nbsp;is&nbsp;called&nbsp;`I&#39;&nbsp;and&nbsp;c&nbsp;is&nbsp;the&nbsp;`C&#39;&nbsp;array&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;first&nbsp;pass&nbsp;over&nbsp;the&nbsp;data.&nbsp;It&#39;s&nbsp;an&nbsp;argument&nbsp;here&nbsp;because&nbsp;we&nbsp;merge&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;pass&nbsp;with&nbsp;the&nbsp;Huffman&nbsp;decoding.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno">455</span><span class="comment">//&nbsp;This&nbsp;also&nbsp;implements&nbsp;the&nbsp;`single&nbsp;array&#39;&nbsp;method&nbsp;from&nbsp;the&nbsp;bzip2&nbsp;source&nbsp;code</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;which&nbsp;leaves&nbsp;the&nbsp;output,&nbsp;still&nbsp;shuffled,&nbsp;in&nbsp;the&nbsp;bottom&nbsp;8&nbsp;bits&nbsp;of&nbsp;tt&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;index&nbsp;of&nbsp;the&nbsp;next&nbsp;byte&nbsp;in&nbsp;the&nbsp;top&nbsp;24-bits.&nbsp;The&nbsp;index&nbsp;of&nbsp;the&nbsp;first&nbsp;byte&nbsp;is</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">inverseBWT</span><span class="op">(</span><span class="ident">tt</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uint32</span><span class="op">,</span>&nbsp;<span class="ident">origPtr</span>&nbsp;<span class="builtintype">uint</span><span class="op">,</span>&nbsp;<span class="ident">c</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uint</span><span class="op">)</span>&nbsp;<span class="builtintype">uint32</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sum</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">uint</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">256</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sum</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">c</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">sum</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">c</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">465</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">tt</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">tt</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">&amp;</span>&nbsp;<span class="num">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tt</span><span class="op">[</span><span class="ident">c</span><span class="op">[</span><span class="ident">b</span><span class="op">]</span><span class="op">]</span>&nbsp;<span class="op">|=</span>&nbsp;<span class="builtintype">uint32</span><span class="op">(</span><span class="ident">i</span><span class="op">)</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="num">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">[</span><span class="ident">b</span><span class="op">]</span><span class="op">++</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">tt</span><span class="op">[</span><span class="ident">origPtr</span><span class="op">]</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="num">8</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span><span class="comment">//&nbsp;This&nbsp;is&nbsp;a&nbsp;standard&nbsp;CRC32&nbsp;like&nbsp;in&nbsp;hash/crc32&nbsp;except&nbsp;that&nbsp;all&nbsp;the&nbsp;shifts&nbsp;are&nbsp;reversed,</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;causing&nbsp;the&nbsp;bits&nbsp;in&nbsp;the&nbsp;input&nbsp;to&nbsp;be&nbsp;processed&nbsp;in&nbsp;the&nbsp;reverse&nbsp;of&nbsp;the&nbsp;usual&nbsp;order.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">crctab</span>&nbsp;<span class="op">[</span><span class="num">256</span><span class="op">]</span><span class="builtintype">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno">480</span><span class="keyword">func</span>&nbsp;<span class="ident">init</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">const</span>&nbsp;<span class="ident">poly</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0x04C11DB7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">crctab</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">crc</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">uint32</span><span class="op">(</span><span class="ident">i</span><span class="op">)</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="num">24</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">8</span><span class="op">;</span>&nbsp;<span class="ident">j</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">crc</span><span class="op">&amp;</span><span class="num">0x80000000</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">crc</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">(</span><span class="ident">crc</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="num">1</span><span class="op">)</span>&nbsp;<span class="op">^</span>&nbsp;<span class="ident">poly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">crc</span>&nbsp;<span class="op">&lt;&lt;=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">crctab</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">crc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment">//&nbsp;updateCRC&nbsp;updates&nbsp;the&nbsp;crc&nbsp;value&nbsp;to&nbsp;incorporate&nbsp;the&nbsp;data&nbsp;in&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;initial&nbsp;value&nbsp;is&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">updateCRC</span><span class="op">(</span><span class="ident">val</span>&nbsp;<span class="builtintype">uint32</span><span class="op">,</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="builtintype">uint32</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">crc</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">^</span><span class="ident">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">crc</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">crctab</span><span class="op">[</span><span class="builtintype">byte</span><span class="op">(</span><span class="ident">crc</span><span class="op">&gt;&gt;</span><span class="num">24</span><span class="op">)</span><span class="op">^</span><span class="ident">v</span><span class="op">]</span>&nbsp;<span class="op">^</span>&nbsp;<span class="op">(</span><span class="ident">crc</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="num">8</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">^</span><span class="ident">crc</span><br>
<span class="lineno"></span><span class="op">}</span>
</div>
</body>
</html>
