<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/rand</h2>
<ul>
<li><a href="/gostd/crypto/rand/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/rand/rand.go.html">rand.go</a></li>
<li><a href="/gostd/crypto/rand/rand_linux.go.html">rand_linux.go</a></li>
<li><a href="/gostd/crypto/rand/rand_test.go.html">rand_test.go</a></li>
<li><a href="/gostd/crypto/rand/rand_unix.go.html">rand_unix.go</a></li>
<li><a href="/gostd/crypto/rand/util.go.html" class="current">util.go</a></li>
<li><a href="/gostd/crypto/rand/util_test.go.html">util_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3978039">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3978095">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3978149">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3978200">package</span>&nbsp;<span class="ident" id="3978208">rand</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3978214">import</span>&nbsp;<span class="op" id="3978221">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3978224">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3978234">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3978240">&#34;math/big&#34;</span><br>
<span class="lineno"></span><span class="op" id="3978251">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3978254">//&nbsp;smallPrimes&nbsp;is&nbsp;a&nbsp;list&nbsp;of&nbsp;small,&nbsp;prime&nbsp;numbers&nbsp;that&nbsp;allows&nbsp;us&nbsp;to&nbsp;rapidly</span><br>
<span class="lineno"></span><span class="comment" id="3978329">//&nbsp;exclude&nbsp;some&nbsp;fraction&nbsp;of&nbsp;composite&nbsp;candidates&nbsp;when&nbsp;searching&nbsp;for&nbsp;a&nbsp;random</span><br>
<span class="lineno">15</span><span class="comment" id="3978406">//&nbsp;prime.&nbsp;This&nbsp;list&nbsp;is&nbsp;truncated&nbsp;at&nbsp;the&nbsp;point&nbsp;where&nbsp;smallPrimesProduct&nbsp;exceeds</span><br>
<span class="lineno"></span><span class="comment" id="3978485">//&nbsp;a&nbsp;uint64.&nbsp;It&nbsp;does&nbsp;not&nbsp;include&nbsp;two&nbsp;because&nbsp;we&nbsp;ensure&nbsp;that&nbsp;the&nbsp;candidates&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="3978564">//&nbsp;odd&nbsp;by&nbsp;construction.</span><br>
<span class="lineno"></span><span class="keyword" id="3978588">var</span>&nbsp;<span class="ident" id="3978592">smallPrimes</span>&nbsp;<span class="op" id="3978604">=</span>&nbsp;<span class="op" id="3978606">[</span><span class="op" id="3978607">]</span><span class="builtintype" id="3978608">uint8</span><span class="op" id="3978613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="3978616">3</span><span class="op" id="3978617">,</span>&nbsp;<span class="num" id="3978619">5</span><span class="op" id="3978620">,</span>&nbsp;<span class="num" id="3978622">7</span><span class="op" id="3978623">,</span>&nbsp;<span class="num" id="3978625">11</span><span class="op" id="3978627">,</span>&nbsp;<span class="num" id="3978629">13</span><span class="op" id="3978631">,</span>&nbsp;<span class="num" id="3978633">17</span><span class="op" id="3978635">,</span>&nbsp;<span class="num" id="3978637">19</span><span class="op" id="3978639">,</span>&nbsp;<span class="num" id="3978641">23</span><span class="op" id="3978643">,</span>&nbsp;<span class="num" id="3978645">29</span><span class="op" id="3978647">,</span>&nbsp;<span class="num" id="3978649">31</span><span class="op" id="3978651">,</span>&nbsp;<span class="num" id="3978653">37</span><span class="op" id="3978655">,</span>&nbsp;<span class="num" id="3978657">41</span><span class="op" id="3978659">,</span>&nbsp;<span class="num" id="3978661">43</span><span class="op" id="3978663">,</span>&nbsp;<span class="num" id="3978665">47</span><span class="op" id="3978667">,</span>&nbsp;<span class="num" id="3978669">53</span><span class="op" id="3978671">,</span><br>
<span class="lineno">20</span><span class="op" id="3978673">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3978676">//&nbsp;smallPrimesProduct&nbsp;is&nbsp;the&nbsp;product&nbsp;of&nbsp;the&nbsp;values&nbsp;in&nbsp;smallPrimes&nbsp;and&nbsp;allows&nbsp;us</span><br>
<span class="lineno"></span><span class="comment" id="3978756">//&nbsp;to&nbsp;reduce&nbsp;a&nbsp;candidate&nbsp;prime&nbsp;by&nbsp;this&nbsp;number&nbsp;and&nbsp;then&nbsp;determine&nbsp;whether&nbsp;it&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3978834">//&nbsp;coprime&nbsp;to&nbsp;all&nbsp;the&nbsp;elements&nbsp;of&nbsp;smallPrimes&nbsp;without&nbsp;further&nbsp;big.Int</span><br>
<span class="lineno">25</span><span class="comment" id="3978904">//&nbsp;operations.</span><br>
<span class="lineno"></span><span class="keyword" id="3978919">var</span>&nbsp;<span class="ident" id="3978923">smallPrimesProduct</span>&nbsp;<span class="op" id="3978942">=</span>&nbsp;<span class="builtinfunc" id="3978944">new</span><span class="op" id="3978947">(</span><span class="ident" id="3978948">big</span><span class="op" id="3978951">.</span><span class="ident" id="3978952">Int</span><span class="op" id="3978955">)</span><span class="op" id="3978956">.</span><span class="ident" id="3978957">SetUint64</span><span class="op" id="3978966">(</span><span class="num" id="3978967">16294579238595022365</span><span class="op" id="3978987">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3978990">//&nbsp;Prime&nbsp;returns&nbsp;a&nbsp;number,&nbsp;p,&nbsp;of&nbsp;the&nbsp;given&nbsp;size,&nbsp;such&nbsp;that&nbsp;p&nbsp;is&nbsp;prime</span><br>
<span class="lineno"></span><span class="comment" id="3979060">//&nbsp;with&nbsp;high&nbsp;probability.</span><br>
<span class="lineno">30</span><span class="comment" id="3979086">//&nbsp;Prime&nbsp;will&nbsp;return&nbsp;error&nbsp;for&nbsp;any&nbsp;error&nbsp;returned&nbsp;by&nbsp;rand.Read&nbsp;or&nbsp;if&nbsp;bits&nbsp;&lt;&nbsp;2.</span><br>
<span class="lineno"></span><span class="keyword" id="3979165">func</span>&nbsp;<span class="ident" id="3979170">Prime</span><span class="op" id="3979175">(</span><span class="ident" id="3979176">rand</span>&nbsp;<span class="ident" id="3979181">io</span><span class="op" id="3979183">.</span><span class="ident" id="3979184">Reader</span><span class="op" id="3979190">,</span>&nbsp;<span class="ident" id="3979192">bits</span>&nbsp;<span class="builtintype" id="3979197">int</span><span class="op" id="3979200">)</span>&nbsp;<span class="op" id="3979202">(</span><span class="ident" id="3979203">p</span>&nbsp;<span class="op" id="3979205">*</span><span class="ident" id="3979206">big</span><span class="op" id="3979209">.</span><span class="ident" id="3979210">Int</span><span class="op" id="3979213">,</span>&nbsp;<span class="ident" id="3979215">err</span>&nbsp;<span class="builtintype" id="3979219">error</span><span class="op" id="3979224">)</span>&nbsp;<span class="op" id="3979226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3979229">if</span>&nbsp;<span class="ident" id="3979232">bits</span>&nbsp;<span class="op" id="3979237">&lt;</span>&nbsp;<span class="num" id="3979239">2</span>&nbsp;<span class="op" id="3979241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3979245">err</span>&nbsp;<span class="op" id="3979249">=</span>&nbsp;<span class="ident" id="3979251">errors</span><span class="op" id="3979257">.</span><span class="ident" id="3979258">New</span><span class="op" id="3979261">(</span><span class="string" id="3979262">&#34;crypto/rand:&nbsp;prime&nbsp;size&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;2-bit&#34;</span><span class="op" id="3979310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3979314">return</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3979322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3979326">b</span>&nbsp;<span class="op" id="3979328">:=</span>&nbsp;<span class="builtintype" id="3979331">uint</span><span class="op" id="3979335">(</span><span class="ident" id="3979336">bits</span>&nbsp;<span class="op" id="3979341">%</span>&nbsp;<span class="num" id="3979343">8</span><span class="op" id="3979344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3979347">if</span>&nbsp;<span class="ident" id="3979350">b</span>&nbsp;<span class="op" id="3979352">==</span>&nbsp;<span class="num" id="3979355">0</span>&nbsp;<span class="op" id="3979357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3979361">b</span>&nbsp;<span class="op" id="3979363">=</span>&nbsp;<span class="num" id="3979365">8</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3979368">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3979372">bytes</span>&nbsp;<span class="op" id="3979378">:=</span>&nbsp;<span class="builtinfunc" id="3979381">make</span><span class="op" id="3979385">(</span><span class="op" id="3979386">[</span><span class="op" id="3979387">]</span><span class="builtintype" id="3979388">byte</span><span class="op" id="3979392">,</span>&nbsp;<span class="op" id="3979394">(</span><span class="ident" id="3979395">bits</span><span class="op" id="3979399">+</span><span class="num" id="3979400">7</span><span class="op" id="3979401">)</span><span class="op" id="3979402">/</span><span class="num" id="3979403">8</span><span class="op" id="3979404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3979407">p</span>&nbsp;<span class="op" id="3979409">=</span>&nbsp;<span class="builtinfunc" id="3979411">new</span><span class="op" id="3979414">(</span><span class="ident" id="3979415">big</span><span class="op" id="3979418">.</span><span class="ident" id="3979419">Int</span><span class="op" id="3979422">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3979426">bigMod</span>&nbsp;<span class="op" id="3979433">:=</span>&nbsp;<span class="builtinfunc" id="3979436">new</span><span class="op" id="3979439">(</span><span class="ident" id="3979440">big</span><span class="op" id="3979443">.</span><span class="ident" id="3979444">Int</span><span class="op" id="3979447">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3979451">for</span>&nbsp;<span class="op" id="3979455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3979459">_</span><span class="op" id="3979460">,</span>&nbsp;<span class="ident" id="3979462">err</span>&nbsp;<span class="op" id="3979466">=</span>&nbsp;<span class="ident" id="3979468">io</span><span class="op" id="3979470">.</span><span class="ident" id="3979471">ReadFull</span><span class="op" id="3979479">(</span><span class="ident" id="3979480">rand</span><span class="op" id="3979484">,</span>&nbsp;<span class="ident" id="3979486">bytes</span><span class="op" id="3979491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3979495">if</span>&nbsp;<span class="ident" id="3979498">err</span>&nbsp;<span class="op" id="3979502">!=</span>&nbsp;<span class="builtintype" id="3979505">nil</span>&nbsp;<span class="op" id="3979509">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3979514">return</span>&nbsp;<span class="builtintype" id="3979521">nil</span><span class="op" id="3979524">,</span>&nbsp;<span class="ident" id="3979526">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3979532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3979537">//&nbsp;Clear&nbsp;bits&nbsp;in&nbsp;the&nbsp;first&nbsp;byte&nbsp;to&nbsp;make&nbsp;sure&nbsp;the&nbsp;candidate&nbsp;has&nbsp;a&nbsp;size&nbsp;&lt;=&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3979618">bytes</span><span class="op" id="3979623">[</span><span class="num" id="3979624">0</span><span class="op" id="3979625">]</span>&nbsp;<span class="op" id="3979627">&amp;=</span>&nbsp;<span class="builtintype" id="3979630">uint8</span><span class="op" id="3979635">(</span><span class="builtintype" id="3979636">int</span><span class="op" id="3979639">(</span><span class="num" id="3979640">1</span><span class="op" id="3979641">&lt;&lt;</span><span class="ident" id="3979643">b</span><span class="op" id="3979644">)</span>&nbsp;<span class="op" id="3979646">-</span>&nbsp;<span class="num" id="3979648">1</span><span class="op" id="3979649">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3979653">//&nbsp;Don&#39;t&nbsp;let&nbsp;the&nbsp;value&nbsp;be&nbsp;too&nbsp;small,&nbsp;i.e,&nbsp;set&nbsp;the&nbsp;most&nbsp;significant&nbsp;two&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3979732">//&nbsp;Setting&nbsp;the&nbsp;top&nbsp;two&nbsp;bits,&nbsp;rather&nbsp;than&nbsp;just&nbsp;the&nbsp;top&nbsp;bit,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3979793">//&nbsp;means&nbsp;that&nbsp;when&nbsp;two&nbsp;of&nbsp;these&nbsp;values&nbsp;are&nbsp;multiplied&nbsp;together,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3979859">//&nbsp;the&nbsp;result&nbsp;isn&#39;t&nbsp;ever&nbsp;one&nbsp;bit&nbsp;short.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3979901">if</span>&nbsp;<span class="ident" id="3979904">b</span>&nbsp;<span class="op" id="3979906">&gt;=</span>&nbsp;<span class="num" id="3979909">2</span>&nbsp;<span class="op" id="3979911">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3979916">bytes</span><span class="op" id="3979921">[</span><span class="num" id="3979922">0</span><span class="op" id="3979923">]</span>&nbsp;<span class="op" id="3979925">|=</span>&nbsp;<span class="num" id="3979928">3</span>&nbsp;<span class="op" id="3979930">&lt;&lt;</span>&nbsp;<span class="op" id="3979933">(</span><span class="ident" id="3979934">b</span>&nbsp;<span class="op" id="3979936">-</span>&nbsp;<span class="num" id="3979938">2</span><span class="op" id="3979939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3979943">}</span>&nbsp;<span class="keyword" id="3979945">else</span>&nbsp;<span class="op" id="3979950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3979955">//&nbsp;Here&nbsp;b==1,&nbsp;because&nbsp;b&nbsp;cannot&nbsp;be&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3979998">bytes</span><span class="op" id="3980003">[</span><span class="num" id="3980004">0</span><span class="op" id="3980005">]</span>&nbsp;<span class="op" id="3980007">|=</span>&nbsp;<span class="num" id="3980010">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3980015">if</span>&nbsp;<span class="builtinfunc" id="3980018">len</span><span class="op" id="3980021">(</span><span class="ident" id="3980022">bytes</span><span class="op" id="3980027">)</span>&nbsp;<span class="op" id="3980029">&gt;</span>&nbsp;<span class="num" id="3980031">1</span>&nbsp;<span class="op" id="3980033">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3980039">bytes</span><span class="op" id="3980044">[</span><span class="num" id="3980045">1</span><span class="op" id="3980046">]</span>&nbsp;<span class="op" id="3980048">|=</span>&nbsp;<span class="num" id="3980051">0x80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3980059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3980063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3980067">//&nbsp;Make&nbsp;the&nbsp;value&nbsp;odd&nbsp;since&nbsp;an&nbsp;even&nbsp;number&nbsp;this&nbsp;large&nbsp;certainly&nbsp;isn&#39;t&nbsp;prime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3980146">bytes</span><span class="op" id="3980151">[</span><span class="builtinfunc" id="3980152">len</span><span class="op" id="3980155">(</span><span class="ident" id="3980156">bytes</span><span class="op" id="3980161">)</span><span class="op" id="3980162">-</span><span class="num" id="3980163">1</span><span class="op" id="3980164">]</span>&nbsp;<span class="op" id="3980166">|=</span>&nbsp;<span class="num" id="3980169">1</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3980174">p</span><span class="op" id="3980175">.</span><span class="ident" id="3980176">SetBytes</span><span class="op" id="3980184">(</span><span class="ident" id="3980185">bytes</span><span class="op" id="3980190">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3980195">//&nbsp;Calculate&nbsp;the&nbsp;value&nbsp;mod&nbsp;the&nbsp;product&nbsp;of&nbsp;smallPrimes.&nbsp;&nbsp;If&nbsp;it&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3980261">//&nbsp;a&nbsp;multiple&nbsp;of&nbsp;any&nbsp;of&nbsp;these&nbsp;primes&nbsp;we&nbsp;add&nbsp;two&nbsp;until&nbsp;it&nbsp;isn&#39;t.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3980327">//&nbsp;The&nbsp;probability&nbsp;of&nbsp;overflowing&nbsp;is&nbsp;minimal&nbsp;and&nbsp;can&nbsp;be&nbsp;ignored</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3980393">//&nbsp;because&nbsp;we&nbsp;still&nbsp;perform&nbsp;Miller-Rabin&nbsp;tests&nbsp;on&nbsp;the&nbsp;result.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3980457">bigMod</span><span class="op" id="3980463">.</span><span class="ident" id="3980464">Mod</span><span class="op" id="3980467">(</span><span class="ident" id="3980468">p</span><span class="op" id="3980469">,</span>&nbsp;<span class="ident" id="3980471">smallPrimesProduct</span><span class="op" id="3980489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3980493">mod</span>&nbsp;<span class="op" id="3980497">:=</span>&nbsp;<span class="ident" id="3980500">bigMod</span><span class="op" id="3980506">.</span><span class="ident" id="3980507">Uint64</span><span class="op" id="3980513">(</span><span class="op" id="3980514">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3980518">NextDelta</span><span class="op" id="3980527">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3980531">for</span>&nbsp;<span class="ident" id="3980535">delta</span>&nbsp;<span class="op" id="3980541">:=</span>&nbsp;<span class="builtintype" id="3980544">uint64</span><span class="op" id="3980550">(</span><span class="num" id="3980551">0</span><span class="op" id="3980552">)</span><span class="op" id="3980553">;</span>&nbsp;<span class="ident" id="3980555">delta</span>&nbsp;<span class="op" id="3980561">&lt;</span>&nbsp;<span class="num" id="3980563">1</span><span class="op" id="3980564">&lt;&lt;</span><span class="num" id="3980566">20</span><span class="op" id="3980568">;</span>&nbsp;<span class="ident" id="3980570">delta</span>&nbsp;<span class="op" id="3980576">+=</span>&nbsp;<span class="num" id="3980579">2</span>&nbsp;<span class="op" id="3980581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3980586">m</span>&nbsp;<span class="op" id="3980588">:=</span>&nbsp;<span class="ident" id="3980591">mod</span>&nbsp;<span class="op" id="3980595">+</span>&nbsp;<span class="ident" id="3980597">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3980606">for</span>&nbsp;<span class="ident" id="3980610">_</span><span class="op" id="3980611">,</span>&nbsp;<span class="ident" id="3980613">prime</span>&nbsp;<span class="op" id="3980619">:=</span>&nbsp;<span class="keyword" id="3980622">range</span>&nbsp;<span class="ident" id="3980628">smallPrimes</span>&nbsp;<span class="op" id="3980640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3980646">if</span>&nbsp;<span class="ident" id="3980649">m</span><span class="op" id="3980650">%</span><span class="builtintype" id="3980651">uint64</span><span class="op" id="3980657">(</span><span class="ident" id="3980658">prime</span><span class="op" id="3980663">)</span>&nbsp;<span class="op" id="3980665">==</span>&nbsp;<span class="num" id="3980668">0</span>&nbsp;<span class="op" id="3980670">&amp;&amp;</span>&nbsp;<span class="op" id="3980673">(</span><span class="ident" id="3980674">bits</span>&nbsp;<span class="op" id="3980679">&gt;</span>&nbsp;<span class="num" id="3980681">6</span>&nbsp;<span class="op" id="3980683">||</span>&nbsp;<span class="ident" id="3980686">m</span>&nbsp;<span class="op" id="3980688">!=</span>&nbsp;<span class="builtintype" id="3980691">uint64</span><span class="op" id="3980697">(</span><span class="ident" id="3980698">prime</span><span class="op" id="3980703">)</span><span class="op" id="3980704">)</span>&nbsp;<span class="op" id="3980706">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3980713">continue</span>&nbsp;<span class="ident" id="3980722">NextDelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3980736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3980741">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3980747">if</span>&nbsp;<span class="ident" id="3980750">delta</span>&nbsp;<span class="op" id="3980756">&gt;</span>&nbsp;<span class="num" id="3980758">0</span>&nbsp;<span class="op" id="3980760">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3980766">bigMod</span><span class="op" id="3980772">.</span><span class="ident" id="3980773">SetUint64</span><span class="op" id="3980782">(</span><span class="ident" id="3980783">delta</span><span class="op" id="3980788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3980794">p</span><span class="op" id="3980795">.</span><span class="ident" id="3980796">Add</span><span class="op" id="3980799">(</span><span class="ident" id="3980800">p</span><span class="op" id="3980801">,</span>&nbsp;<span class="ident" id="3980803">bigMod</span><span class="op" id="3980809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3980814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3980819">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3980827">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3980832">//&nbsp;There&nbsp;is&nbsp;a&nbsp;tiny&nbsp;possibility&nbsp;that,&nbsp;by&nbsp;adding&nbsp;delta,&nbsp;we&nbsp;caused</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3980898">//&nbsp;the&nbsp;number&nbsp;to&nbsp;be&nbsp;one&nbsp;bit&nbsp;too&nbsp;long.&nbsp;Thus&nbsp;we&nbsp;check&nbsp;BitLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3980959">//&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3980970">if</span>&nbsp;<span class="ident" id="3980973">p</span><span class="op" id="3980974">.</span><span class="ident" id="3980975">ProbablyPrime</span><span class="op" id="3980988">(</span><span class="num" id="3980989">20</span><span class="op" id="3980991">)</span>&nbsp;<span class="op" id="3980993">&amp;&amp;</span>&nbsp;<span class="ident" id="3980996">p</span><span class="op" id="3980997">.</span><span class="ident" id="3980998">BitLen</span><span class="op" id="3981004">(</span><span class="op" id="3981005">)</span>&nbsp;<span class="op" id="3981007">==</span>&nbsp;<span class="ident" id="3981010">bits</span>&nbsp;<span class="op" id="3981015">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3981020">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3981029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3981032">}</span><br>
<span class="lineno"></span><span class="op" id="3981034">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="3981037">//&nbsp;Int&nbsp;returns&nbsp;a&nbsp;uniform&nbsp;random&nbsp;value&nbsp;in&nbsp;[0,&nbsp;max).&nbsp;It&nbsp;panics&nbsp;if&nbsp;max&nbsp;&lt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="3981111">func</span>&nbsp;<span class="ident" id="3981116">Int</span><span class="op" id="3981119">(</span><span class="ident" id="3981120">rand</span>&nbsp;<span class="ident" id="3981125">io</span><span class="op" id="3981127">.</span><span class="ident" id="3981128">Reader</span><span class="op" id="3981134">,</span>&nbsp;<span class="ident" id="3981136">max</span>&nbsp;<span class="op" id="3981140">*</span><span class="ident" id="3981141">big</span><span class="op" id="3981144">.</span><span class="ident" id="3981145">Int</span><span class="op" id="3981148">)</span>&nbsp;<span class="op" id="3981150">(</span><span class="ident" id="3981151">n</span>&nbsp;<span class="op" id="3981153">*</span><span class="ident" id="3981154">big</span><span class="op" id="3981157">.</span><span class="ident" id="3981158">Int</span><span class="op" id="3981161">,</span>&nbsp;<span class="ident" id="3981163">err</span>&nbsp;<span class="builtintype" id="3981167">error</span><span class="op" id="3981172">)</span>&nbsp;<span class="op" id="3981174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3981177">if</span>&nbsp;<span class="ident" id="3981180">max</span><span class="op" id="3981183">.</span><span class="ident" id="3981184">Sign</span><span class="op" id="3981188">(</span><span class="op" id="3981189">)</span>&nbsp;<span class="op" id="3981191">&lt;=</span>&nbsp;<span class="num" id="3981194">0</span>&nbsp;<span class="op" id="3981196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3981200">panic</span><span class="op" id="3981205">(</span><span class="string" id="3981206">&#34;crypto/rand:&nbsp;argument&nbsp;to&nbsp;Int&nbsp;is&nbsp;&lt;=&nbsp;0&#34;</span><span class="op" id="3981244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3981247">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3981250">k</span>&nbsp;<span class="op" id="3981252">:=</span>&nbsp;<span class="op" id="3981255">(</span><span class="ident" id="3981256">max</span><span class="op" id="3981259">.</span><span class="ident" id="3981260">BitLen</span><span class="op" id="3981266">(</span><span class="op" id="3981267">)</span>&nbsp;<span class="op" id="3981269">+</span>&nbsp;<span class="num" id="3981271">7</span><span class="op" id="3981272">)</span>&nbsp;<span class="op" id="3981274">/</span>&nbsp;<span class="num" id="3981276">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3981280">//&nbsp;b&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;bits&nbsp;in&nbsp;the&nbsp;most&nbsp;significant&nbsp;byte&nbsp;of&nbsp;max.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3981345">b</span>&nbsp;<span class="op" id="3981347">:=</span>&nbsp;<span class="builtintype" id="3981350">uint</span><span class="op" id="3981354">(</span><span class="ident" id="3981355">max</span><span class="op" id="3981358">.</span><span class="ident" id="3981359">BitLen</span><span class="op" id="3981365">(</span><span class="op" id="3981366">)</span>&nbsp;<span class="op" id="3981368">%</span>&nbsp;<span class="num" id="3981370">8</span><span class="op" id="3981371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3981374">if</span>&nbsp;<span class="ident" id="3981377">b</span>&nbsp;<span class="op" id="3981379">==</span>&nbsp;<span class="num" id="3981382">0</span>&nbsp;<span class="op" id="3981384">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3981388">b</span>&nbsp;<span class="op" id="3981390">=</span>&nbsp;<span class="num" id="3981392">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3981395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3981399">bytes</span>&nbsp;<span class="op" id="3981405">:=</span>&nbsp;<span class="builtinfunc" id="3981408">make</span><span class="op" id="3981412">(</span><span class="op" id="3981413">[</span><span class="op" id="3981414">]</span><span class="builtintype" id="3981415">byte</span><span class="op" id="3981419">,</span>&nbsp;<span class="ident" id="3981421">k</span><span class="op" id="3981422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3981425">n</span>&nbsp;<span class="op" id="3981427">=</span>&nbsp;<span class="builtinfunc" id="3981429">new</span><span class="op" id="3981432">(</span><span class="ident" id="3981433">big</span><span class="op" id="3981436">.</span><span class="ident" id="3981437">Int</span><span class="op" id="3981440">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3981444">for</span>&nbsp;<span class="op" id="3981448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3981452">_</span><span class="op" id="3981453">,</span>&nbsp;<span class="ident" id="3981455">err</span>&nbsp;<span class="op" id="3981459">=</span>&nbsp;<span class="ident" id="3981461">io</span><span class="op" id="3981463">.</span><span class="ident" id="3981464">ReadFull</span><span class="op" id="3981472">(</span><span class="ident" id="3981473">rand</span><span class="op" id="3981477">,</span>&nbsp;<span class="ident" id="3981479">bytes</span><span class="op" id="3981484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3981488">if</span>&nbsp;<span class="ident" id="3981491">err</span>&nbsp;<span class="op" id="3981495">!=</span>&nbsp;<span class="builtintype" id="3981498">nil</span>&nbsp;<span class="op" id="3981502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3981507">return</span>&nbsp;<span class="builtintype" id="3981514">nil</span><span class="op" id="3981517">,</span>&nbsp;<span class="ident" id="3981519">err</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3981525">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3981530">//&nbsp;Clear&nbsp;bits&nbsp;in&nbsp;the&nbsp;first&nbsp;byte&nbsp;to&nbsp;increase&nbsp;the&nbsp;probability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3981592">//&nbsp;that&nbsp;the&nbsp;candidate&nbsp;is&nbsp;&lt;&nbsp;max.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3981626">bytes</span><span class="op" id="3981631">[</span><span class="num" id="3981632">0</span><span class="op" id="3981633">]</span>&nbsp;<span class="op" id="3981635">&amp;=</span>&nbsp;<span class="builtintype" id="3981638">uint8</span><span class="op" id="3981643">(</span><span class="builtintype" id="3981644">int</span><span class="op" id="3981647">(</span><span class="num" id="3981648">1</span><span class="op" id="3981649">&lt;&lt;</span><span class="ident" id="3981651">b</span><span class="op" id="3981652">)</span>&nbsp;<span class="op" id="3981654">-</span>&nbsp;<span class="num" id="3981656">1</span><span class="op" id="3981657">)</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3981662">n</span><span class="op" id="3981663">.</span><span class="ident" id="3981664">SetBytes</span><span class="op" id="3981672">(</span><span class="ident" id="3981673">bytes</span><span class="op" id="3981678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3981682">if</span>&nbsp;<span class="ident" id="3981685">n</span><span class="op" id="3981686">.</span><span class="ident" id="3981687">Cmp</span><span class="op" id="3981690">(</span><span class="ident" id="3981691">max</span><span class="op" id="3981694">)</span>&nbsp;<span class="op" id="3981696">&lt;</span>&nbsp;<span class="num" id="3981698">0</span>&nbsp;<span class="op" id="3981700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3981705">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3981714">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3981717">}</span><br>
<span class="lineno"></span><span class="op" id="3981719">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
