<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="5124170">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5124225">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5124279">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5124330">//&nbsp;Package&nbsp;fcgi&nbsp;implements&nbsp;the&nbsp;FastCGI&nbsp;protocol.</span><br>
<span class="lineno"></span><span class="comment" id="5124379">//&nbsp;Currently&nbsp;only&nbsp;the&nbsp;responder&nbsp;role&nbsp;is&nbsp;supported.</span><br>
<span class="lineno"></span><span class="comment" id="5124430">//&nbsp;The&nbsp;protocol&nbsp;is&nbsp;defined&nbsp;at&nbsp;http://www.fastcgi.com/drupal/node/6?q=node/22</span><br>
<span class="lineno"></span><span class="keyword" id="5124507">package</span>&nbsp;<span class="ident" id="5124515">fcgi</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="5124521">//&nbsp;This&nbsp;file&nbsp;defines&nbsp;the&nbsp;raw&nbsp;protocol&nbsp;and&nbsp;some&nbsp;utilities&nbsp;used&nbsp;by&nbsp;the&nbsp;child&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5124600">//&nbsp;the&nbsp;host.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5124614">import</span>&nbsp;<span class="op" id="5124621">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5124624">&#34;bufio&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5124633">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5124642">&#34;encoding/binary&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5124661">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5124671">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5124677">&#34;sync&#34;</span><br>
<span class="lineno">20</span><span class="op" id="5124684">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5124687">//&nbsp;recType&nbsp;is&nbsp;a&nbsp;record&nbsp;type,&nbsp;as&nbsp;defined&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="5124730">//&nbsp;http://www.fastcgi.com/devkit/doc/fcgi-spec.html#S8</span><br>
<span class="lineno"></span><span class="keyword" id="5124785">type</span>&nbsp;<span class="ident" id="5124790">recType</span>&nbsp;<span class="builtintype" id="5124798">uint8</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="5124805">const</span>&nbsp;<span class="op" id="5124811">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5124814">typeBeginRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5124834">recType</span>&nbsp;<span class="op" id="5124842">=</span>&nbsp;<span class="num" id="5124844">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5124847">typeAbortRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5124867">recType</span>&nbsp;<span class="op" id="5124875">=</span>&nbsp;<span class="num" id="5124877">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5124880">typeEndRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5124900">recType</span>&nbsp;<span class="op" id="5124908">=</span>&nbsp;<span class="num" id="5124910">3</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5124913">typeParams</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5124933">recType</span>&nbsp;<span class="op" id="5124941">=</span>&nbsp;<span class="num" id="5124943">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5124946">typeStdin</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5124966">recType</span>&nbsp;<span class="op" id="5124974">=</span>&nbsp;<span class="num" id="5124976">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5124979">typeStdout</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5124999">recType</span>&nbsp;<span class="op" id="5125007">=</span>&nbsp;<span class="num" id="5125009">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125012">typeStderr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5125032">recType</span>&nbsp;<span class="op" id="5125040">=</span>&nbsp;<span class="num" id="5125042">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125045">typeData</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5125065">recType</span>&nbsp;<span class="op" id="5125073">=</span>&nbsp;<span class="num" id="5125075">8</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125078">typeGetValues</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5125098">recType</span>&nbsp;<span class="op" id="5125106">=</span>&nbsp;<span class="num" id="5125108">9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125111">typeGetValuesResult</span>&nbsp;<span class="ident" id="5125131">recType</span>&nbsp;<span class="op" id="5125139">=</span>&nbsp;<span class="num" id="5125141">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125145">typeUnknownType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5125165">recType</span>&nbsp;<span class="op" id="5125173">=</span>&nbsp;<span class="num" id="5125175">11</span><br>
<span class="lineno"></span><span class="op" id="5125178">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="5125181">//&nbsp;keep&nbsp;the&nbsp;connection&nbsp;between&nbsp;web-server&nbsp;and&nbsp;responder&nbsp;open&nbsp;after&nbsp;request</span><br>
<span class="lineno"></span><span class="keyword" id="5125256">const</span>&nbsp;<span class="ident" id="5125262">flagKeepConn</span>&nbsp;<span class="op" id="5125275">=</span>&nbsp;<span class="num" id="5125277">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5125280">const</span>&nbsp;<span class="op" id="5125286">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125289">maxWrite</span>&nbsp;<span class="op" id="5125298">=</span>&nbsp;<span class="num" id="5125300">65535</span>&nbsp;<span class="comment" id="5125306">//&nbsp;maximum&nbsp;record&nbsp;body</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125330">maxPad</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5125339">=</span>&nbsp;<span class="num" id="5125341">255</span><br>
<span class="lineno"></span><span class="op" id="5125345">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5125348">const</span>&nbsp;<span class="op" id="5125354">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125357">roleResponder</span>&nbsp;<span class="op" id="5125371">=</span>&nbsp;<span class="ident" id="5125373">iota</span>&nbsp;<span class="op" id="5125378">+</span>&nbsp;<span class="num" id="5125380">1</span>&nbsp;<span class="comment" id="5125382">//&nbsp;only&nbsp;Responders&nbsp;are&nbsp;implemented.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125419">roleAuthorizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125435">roleFilter</span><br>
<span class="lineno"></span><span class="op" id="5125446">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5125449">const</span>&nbsp;<span class="op" id="5125455">(</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125458">statusRequestComplete</span>&nbsp;<span class="op" id="5125480">=</span>&nbsp;<span class="ident" id="5125482">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125488">statusCantMultiplex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125509">statusOverloaded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125527">statusUnknownRole</span><br>
<span class="lineno"></span><span class="op" id="5125545">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="5125548">const</span>&nbsp;<span class="ident" id="5125554">headerLen</span>&nbsp;<span class="op" id="5125564">=</span>&nbsp;<span class="num" id="5125566">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5125569">type</span>&nbsp;<span class="ident" id="5125574">header</span>&nbsp;<span class="keyword" id="5125581">struct</span>&nbsp;<span class="op" id="5125588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125591">Version</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5125605">uint8</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125612">Type</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5125626">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125635">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5125649">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125657">ContentLength</span>&nbsp;<span class="builtintype" id="5125671">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125679">PaddingLength</span>&nbsp;<span class="builtintype" id="5125693">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125700">Reserved</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5125714">uint8</span><br>
<span class="lineno">70</span><span class="op" id="5125720">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5125723">type</span>&nbsp;<span class="ident" id="5125728">beginRequest</span>&nbsp;<span class="keyword" id="5125741">struct</span>&nbsp;<span class="op" id="5125748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125751">role</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5125760">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125768">flags</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5125777">uint8</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125784">reserved</span>&nbsp;<span class="op" id="5125793">[</span><span class="num" id="5125794">5</span><span class="op" id="5125795">]</span><span class="builtintype" id="5125796">uint8</span><br>
<span class="lineno"></span><span class="op" id="5125802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5125805">func</span>&nbsp;<span class="op" id="5125810">(</span><span class="ident" id="5125811">br</span>&nbsp;<span class="op" id="5125814">*</span><span class="ident" id="5125815">beginRequest</span><span class="op" id="5125827">)</span>&nbsp;<span class="ident" id="5125829">read</span><span class="op" id="5125833">(</span><span class="ident" id="5125834">content</span>&nbsp;<span class="op" id="5125842">[</span><span class="op" id="5125843">]</span><span class="builtintype" id="5125844">byte</span><span class="op" id="5125848">)</span>&nbsp;<span class="builtintype" id="5125850">error</span>&nbsp;<span class="op" id="5125856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5125859">if</span>&nbsp;<span class="builtinfunc" id="5125862">len</span><span class="op" id="5125865">(</span><span class="ident" id="5125866">content</span><span class="op" id="5125873">)</span>&nbsp;<span class="op" id="5125875">!=</span>&nbsp;<span class="num" id="5125878">8</span>&nbsp;<span class="op" id="5125880">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5125884">return</span>&nbsp;<span class="ident" id="5125891">errors</span><span class="op" id="5125897">.</span><span class="ident" id="5125898">New</span><span class="op" id="5125901">(</span><span class="string" id="5125902">&#34;fcgi:&nbsp;invalid&nbsp;begin&nbsp;request&nbsp;record&#34;</span><span class="op" id="5125938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5125941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125944">br</span><span class="op" id="5125946">.</span><span class="ident" id="5125947">role</span>&nbsp;<span class="op" id="5125952">=</span>&nbsp;<span class="ident" id="5125954">binary</span><span class="op" id="5125960">.</span><span class="ident" id="5125961">BigEndian</span><span class="op" id="5125970">.</span><span class="ident" id="5125971">Uint16</span><span class="op" id="5125977">(</span><span class="ident" id="5125978">content</span><span class="op" id="5125985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125988">br</span><span class="op" id="5125990">.</span><span class="ident" id="5125991">flags</span>&nbsp;<span class="op" id="5125997">=</span>&nbsp;<span class="ident" id="5125999">content</span><span class="op" id="5126006">[</span><span class="num" id="5126007">2</span><span class="op" id="5126008">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5126011">return</span>&nbsp;<span class="ident" id="5126018">nil</span><br>
<span class="lineno">85</span><span class="op" id="5126022">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5126025">//&nbsp;for&nbsp;padding&nbsp;so&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;to&nbsp;allocate&nbsp;all&nbsp;the&nbsp;time</span><br>
<span class="lineno"></span><span class="comment" id="5126082">//&nbsp;not&nbsp;synchronized&nbsp;because&nbsp;we&nbsp;don&#39;t&nbsp;care&nbsp;what&nbsp;the&nbsp;contents&nbsp;are</span><br>
<span class="lineno"></span><span class="keyword" id="5126146">var</span>&nbsp;<span class="ident" id="5126150">pad</span>&nbsp;<span class="op" id="5126154">[</span><span class="ident" id="5126155">maxPad</span><span class="op" id="5126161">]</span><span class="builtintype" id="5126162">byte</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="5126168">func</span>&nbsp;<span class="op" id="5126173">(</span><span class="ident" id="5126174">h</span>&nbsp;<span class="op" id="5126176">*</span><span class="ident" id="5126177">header</span><span class="op" id="5126183">)</span>&nbsp;<span class="ident" id="5126185">init</span><span class="op" id="5126189">(</span><span class="ident" id="5126190">recType</span>&nbsp;<span class="ident" id="5126198">recType</span><span class="op" id="5126205">,</span>&nbsp;<span class="ident" id="5126207">reqId</span>&nbsp;<span class="builtintype" id="5126213">uint16</span><span class="op" id="5126219">,</span>&nbsp;<span class="ident" id="5126221">contentLength</span>&nbsp;<span class="builtintype" id="5126235">int</span><span class="op" id="5126238">)</span>&nbsp;<span class="op" id="5126240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5126243">h</span><span class="op" id="5126244">.</span><span class="ident" id="5126245">Version</span>&nbsp;<span class="op" id="5126253">=</span>&nbsp;<span class="num" id="5126255">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5126258">h</span><span class="op" id="5126259">.</span><span class="ident" id="5126260">Type</span>&nbsp;<span class="op" id="5126265">=</span>&nbsp;<span class="ident" id="5126267">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5126276">h</span><span class="op" id="5126277">.</span><span class="ident" id="5126278">Id</span>&nbsp;<span class="op" id="5126281">=</span>&nbsp;<span class="ident" id="5126283">reqId</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5126290">h</span><span class="op" id="5126291">.</span><span class="ident" id="5126292">ContentLength</span>&nbsp;<span class="op" id="5126306">=</span>&nbsp;<span class="builtintype" id="5126308">uint16</span><span class="op" id="5126314">(</span><span class="ident" id="5126315">contentLength</span><span class="op" id="5126328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5126331">h</span><span class="op" id="5126332">.</span><span class="ident" id="5126333">PaddingLength</span>&nbsp;<span class="op" id="5126347">=</span>&nbsp;<span class="builtintype" id="5126349">uint8</span><span class="op" id="5126354">(</span><span class="op" id="5126355">-</span><span class="ident" id="5126356">contentLength</span>&nbsp;<span class="op" id="5126370">&amp;</span>&nbsp;<span class="num" id="5126372">7</span><span class="op" id="5126373">)</span><br>
<span class="lineno"></span><span class="op" id="5126375">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5126378">//&nbsp;conn&nbsp;sends&nbsp;records&nbsp;over&nbsp;rwc</span><br>
<span class="lineno">100</span><span class="keyword" id="5126409">type</span>&nbsp;<span class="ident" id="5126414">conn</span>&nbsp;<span class="keyword" id="5126419">struct</span>&nbsp;<span class="op" id="5126426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5126429">mutex</span>&nbsp;<span class="ident" id="5126435">sync</span><span class="op" id="5126439">.</span><span class="ident" id="5126440">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5126447">rwc</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5126453">io</span><span class="op" id="5126455">.</span><span class="ident" id="5126456">ReadWriteCloser</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5126474">//&nbsp;to&nbsp;avoid&nbsp;allocations</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5126499">buf</span>&nbsp;<span class="ident" id="5126503">bytes</span><span class="op" id="5126508">.</span><span class="ident" id="5126509">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5126517">h</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5126521">header</span><br>
<span class="lineno"></span><span class="op" id="5126528">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5126531">func</span>&nbsp;<span class="ident" id="5126536">newConn</span><span class="op" id="5126543">(</span><span class="ident" id="5126544">rwc</span>&nbsp;<span class="ident" id="5126548">io</span><span class="op" id="5126550">.</span><span class="ident" id="5126551">ReadWriteCloser</span><span class="op" id="5126566">)</span>&nbsp;<span class="op" id="5126568">*</span><span class="ident" id="5126569">conn</span>&nbsp;<span class="op" id="5126574">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5126577">return</span>&nbsp;<span class="op" id="5126584">&amp;</span><span class="ident" id="5126585">conn</span><span class="op" id="5126589">{</span><span class="ident" id="5126590">rwc</span><span class="op" id="5126593">:</span>&nbsp;<span class="ident" id="5126595">rwc</span><span class="op" id="5126598">}</span><br>
<span class="lineno"></span><span class="op" id="5126600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5126603">func</span>&nbsp;<span class="op" id="5126608">(</span><span class="ident" id="5126609">c</span>&nbsp;<span class="op" id="5126611">*</span><span class="ident" id="5126612">conn</span><span class="op" id="5126616">)</span>&nbsp;<span class="ident" id="5126618">Close</span><span class="op" id="5126623">(</span><span class="op" id="5126624">)</span>&nbsp;<span class="builtintype" id="5126626">error</span>&nbsp;<span class="op" id="5126632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5126635">c</span><span class="op" id="5126636">.</span><span class="ident" id="5126637">mutex</span><span class="op" id="5126642">.</span><span class="ident" id="5126643">Lock</span><span class="op" id="5126647">(</span><span class="op" id="5126648">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5126651">defer</span>&nbsp;<span class="ident" id="5126657">c</span><span class="op" id="5126658">.</span><span class="ident" id="5126659">mutex</span><span class="op" id="5126664">.</span><span class="ident" id="5126665">Unlock</span><span class="op" id="5126671">(</span><span class="op" id="5126672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5126675">return</span>&nbsp;<span class="ident" id="5126682">c</span><span class="op" id="5126683">.</span><span class="ident" id="5126684">rwc</span><span class="op" id="5126687">.</span><span class="ident" id="5126688">Close</span><span class="op" id="5126693">(</span><span class="op" id="5126694">)</span><br>
<span class="lineno"></span><span class="op" id="5126696">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5126699">type</span>&nbsp;<span class="ident" id="5126704">record</span>&nbsp;<span class="keyword" id="5126711">struct</span>&nbsp;<span class="op" id="5126718">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5126721">h</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5126725">header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5126733">buf</span>&nbsp;<span class="op" id="5126737">[</span><span class="ident" id="5126738">maxWrite</span>&nbsp;<span class="op" id="5126747">+</span>&nbsp;<span class="ident" id="5126749">maxPad</span><span class="op" id="5126755">]</span><span class="builtintype" id="5126756">byte</span><br>
<span class="lineno"></span><span class="op" id="5126761">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5126764">func</span>&nbsp;<span class="op" id="5126769">(</span><span class="ident" id="5126770">rec</span>&nbsp;<span class="op" id="5126774">*</span><span class="ident" id="5126775">record</span><span class="op" id="5126781">)</span>&nbsp;<span class="ident" id="5126783">read</span><span class="op" id="5126787">(</span><span class="ident" id="5126788">r</span>&nbsp;<span class="ident" id="5126790">io</span><span class="op" id="5126792">.</span><span class="ident" id="5126793">Reader</span><span class="op" id="5126799">)</span>&nbsp;<span class="op" id="5126801">(</span><span class="ident" id="5126802">err</span>&nbsp;<span class="builtintype" id="5126806">error</span><span class="op" id="5126811">)</span>&nbsp;<span class="op" id="5126813">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5126816">if</span>&nbsp;<span class="ident" id="5126819">err</span>&nbsp;<span class="op" id="5126823">=</span>&nbsp;<span class="ident" id="5126825">binary</span><span class="op" id="5126831">.</span><span class="ident" id="5126832">Read</span><span class="op" id="5126836">(</span><span class="ident" id="5126837">r</span><span class="op" id="5126838">,</span>&nbsp;<span class="ident" id="5126840">binary</span><span class="op" id="5126846">.</span><span class="ident" id="5126847">BigEndian</span><span class="op" id="5126856">,</span>&nbsp;<span class="op" id="5126858">&amp;</span><span class="ident" id="5126859">rec</span><span class="op" id="5126862">.</span><span class="ident" id="5126863">h</span><span class="op" id="5126864">)</span><span class="op" id="5126865">;</span>&nbsp;<span class="ident" id="5126867">err</span>&nbsp;<span class="op" id="5126871">!=</span>&nbsp;<span class="ident" id="5126874">nil</span>&nbsp;<span class="op" id="5126878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5126882">return</span>&nbsp;<span class="ident" id="5126889">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5126894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5126897">if</span>&nbsp;<span class="ident" id="5126900">rec</span><span class="op" id="5126903">.</span><span class="ident" id="5126904">h</span><span class="op" id="5126905">.</span><span class="ident" id="5126906">Version</span>&nbsp;<span class="op" id="5126914">!=</span>&nbsp;<span class="num" id="5126917">1</span>&nbsp;<span class="op" id="5126919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5126923">return</span>&nbsp;<span class="ident" id="5126930">errors</span><span class="op" id="5126936">.</span><span class="ident" id="5126937">New</span><span class="op" id="5126940">(</span><span class="string" id="5126941">&#34;fcgi:&nbsp;invalid&nbsp;header&nbsp;version&#34;</span><span class="op" id="5126971">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5126974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5126977">n</span>&nbsp;<span class="op" id="5126979">:=</span>&nbsp;<span class="builtintype" id="5126982">int</span><span class="op" id="5126985">(</span><span class="ident" id="5126986">rec</span><span class="op" id="5126989">.</span><span class="ident" id="5126990">h</span><span class="op" id="5126991">.</span><span class="ident" id="5126992">ContentLength</span><span class="op" id="5127005">)</span>&nbsp;<span class="op" id="5127007">+</span>&nbsp;<span class="builtintype" id="5127009">int</span><span class="op" id="5127012">(</span><span class="ident" id="5127013">rec</span><span class="op" id="5127016">.</span><span class="ident" id="5127017">h</span><span class="op" id="5127018">.</span><span class="ident" id="5127019">PaddingLength</span><span class="op" id="5127032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5127035">if</span>&nbsp;<span class="ident" id="5127038">_</span><span class="op" id="5127039">,</span>&nbsp;<span class="ident" id="5127041">err</span>&nbsp;<span class="op" id="5127045">=</span>&nbsp;<span class="ident" id="5127047">io</span><span class="op" id="5127049">.</span><span class="ident" id="5127050">ReadFull</span><span class="op" id="5127058">(</span><span class="ident" id="5127059">r</span><span class="op" id="5127060">,</span>&nbsp;<span class="ident" id="5127062">rec</span><span class="op" id="5127065">.</span><span class="ident" id="5127066">buf</span><span class="op" id="5127069">[</span><span class="op" id="5127070">:</span><span class="ident" id="5127071">n</span><span class="op" id="5127072">]</span><span class="op" id="5127073">)</span><span class="op" id="5127074">;</span>&nbsp;<span class="ident" id="5127076">err</span>&nbsp;<span class="op" id="5127080">!=</span>&nbsp;<span class="ident" id="5127083">nil</span>&nbsp;<span class="op" id="5127087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5127091">return</span>&nbsp;<span class="ident" id="5127098">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5127103">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5127106">return</span>&nbsp;<span class="ident" id="5127113">nil</span><br>
<span class="lineno"></span><span class="op" id="5127117">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5127120">func</span>&nbsp;<span class="op" id="5127125">(</span><span class="ident" id="5127126">r</span>&nbsp;<span class="op" id="5127128">*</span><span class="ident" id="5127129">record</span><span class="op" id="5127135">)</span>&nbsp;<span class="ident" id="5127137">content</span><span class="op" id="5127144">(</span><span class="op" id="5127145">)</span>&nbsp;<span class="op" id="5127147">[</span><span class="op" id="5127148">]</span><span class="builtintype" id="5127149">byte</span>&nbsp;<span class="op" id="5127154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5127157">return</span>&nbsp;<span class="ident" id="5127164">r</span><span class="op" id="5127165">.</span><span class="ident" id="5127166">buf</span><span class="op" id="5127169">[</span><span class="op" id="5127170">:</span><span class="ident" id="5127171">r</span><span class="op" id="5127172">.</span><span class="ident" id="5127173">h</span><span class="op" id="5127174">.</span><span class="ident" id="5127175">ContentLength</span><span class="op" id="5127188">]</span><br>
<span class="lineno">140</span><span class="op" id="5127190">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5127193">//&nbsp;writeRecord&nbsp;writes&nbsp;and&nbsp;sends&nbsp;a&nbsp;single&nbsp;record.</span><br>
<span class="lineno"></span><span class="keyword" id="5127242">func</span>&nbsp;<span class="op" id="5127247">(</span><span class="ident" id="5127248">c</span>&nbsp;<span class="op" id="5127250">*</span><span class="ident" id="5127251">conn</span><span class="op" id="5127255">)</span>&nbsp;<span class="ident" id="5127257">writeRecord</span><span class="op" id="5127268">(</span><span class="ident" id="5127269">recType</span>&nbsp;<span class="ident" id="5127277">recType</span><span class="op" id="5127284">,</span>&nbsp;<span class="ident" id="5127286">reqId</span>&nbsp;<span class="builtintype" id="5127292">uint16</span><span class="op" id="5127298">,</span>&nbsp;<span class="ident" id="5127300">b</span>&nbsp;<span class="op" id="5127302">[</span><span class="op" id="5127303">]</span><span class="builtintype" id="5127304">byte</span><span class="op" id="5127308">)</span>&nbsp;<span class="builtintype" id="5127310">error</span>&nbsp;<span class="op" id="5127316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5127319">c</span><span class="op" id="5127320">.</span><span class="ident" id="5127321">mutex</span><span class="op" id="5127326">.</span><span class="ident" id="5127327">Lock</span><span class="op" id="5127331">(</span><span class="op" id="5127332">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5127335">defer</span>&nbsp;<span class="ident" id="5127341">c</span><span class="op" id="5127342">.</span><span class="ident" id="5127343">mutex</span><span class="op" id="5127348">.</span><span class="ident" id="5127349">Unlock</span><span class="op" id="5127355">(</span><span class="op" id="5127356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5127359">c</span><span class="op" id="5127360">.</span><span class="ident" id="5127361">buf</span><span class="op" id="5127364">.</span><span class="ident" id="5127365">Reset</span><span class="op" id="5127370">(</span><span class="op" id="5127371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5127374">c</span><span class="op" id="5127375">.</span><span class="ident" id="5127376">h</span><span class="op" id="5127377">.</span><span class="ident" id="5127378">init</span><span class="op" id="5127382">(</span><span class="ident" id="5127383">recType</span><span class="op" id="5127390">,</span>&nbsp;<span class="ident" id="5127392">reqId</span><span class="op" id="5127397">,</span>&nbsp;<span class="builtinfunc" id="5127399">len</span><span class="op" id="5127402">(</span><span class="ident" id="5127403">b</span><span class="op" id="5127404">)</span><span class="op" id="5127405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5127408">if</span>&nbsp;<span class="ident" id="5127411">err</span>&nbsp;<span class="op" id="5127415">:=</span>&nbsp;<span class="ident" id="5127418">binary</span><span class="op" id="5127424">.</span><span class="ident" id="5127425">Write</span><span class="op" id="5127430">(</span><span class="op" id="5127431">&amp;</span><span class="ident" id="5127432">c</span><span class="op" id="5127433">.</span><span class="ident" id="5127434">buf</span><span class="op" id="5127437">,</span>&nbsp;<span class="ident" id="5127439">binary</span><span class="op" id="5127445">.</span><span class="ident" id="5127446">BigEndian</span><span class="op" id="5127455">,</span>&nbsp;<span class="ident" id="5127457">c</span><span class="op" id="5127458">.</span><span class="ident" id="5127459">h</span><span class="op" id="5127460">)</span><span class="op" id="5127461">;</span>&nbsp;<span class="ident" id="5127463">err</span>&nbsp;<span class="op" id="5127467">!=</span>&nbsp;<span class="ident" id="5127470">nil</span>&nbsp;<span class="op" id="5127474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5127478">return</span>&nbsp;<span class="ident" id="5127485">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5127490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5127493">if</span>&nbsp;<span class="ident" id="5127496">_</span><span class="op" id="5127497">,</span>&nbsp;<span class="ident" id="5127499">err</span>&nbsp;<span class="op" id="5127503">:=</span>&nbsp;<span class="ident" id="5127506">c</span><span class="op" id="5127507">.</span><span class="ident" id="5127508">buf</span><span class="op" id="5127511">.</span><span class="ident" id="5127512">Write</span><span class="op" id="5127517">(</span><span class="ident" id="5127518">b</span><span class="op" id="5127519">)</span><span class="op" id="5127520">;</span>&nbsp;<span class="ident" id="5127522">err</span>&nbsp;<span class="op" id="5127526">!=</span>&nbsp;<span class="ident" id="5127529">nil</span>&nbsp;<span class="op" id="5127533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5127537">return</span>&nbsp;<span class="ident" id="5127544">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5127549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5127552">if</span>&nbsp;<span class="ident" id="5127555">_</span><span class="op" id="5127556">,</span>&nbsp;<span class="ident" id="5127558">err</span>&nbsp;<span class="op" id="5127562">:=</span>&nbsp;<span class="ident" id="5127565">c</span><span class="op" id="5127566">.</span><span class="ident" id="5127567">buf</span><span class="op" id="5127570">.</span><span class="ident" id="5127571">Write</span><span class="op" id="5127576">(</span><span class="ident" id="5127577">pad</span><span class="op" id="5127580">[</span><span class="op" id="5127581">:</span><span class="ident" id="5127582">c</span><span class="op" id="5127583">.</span><span class="ident" id="5127584">h</span><span class="op" id="5127585">.</span><span class="ident" id="5127586">PaddingLength</span><span class="op" id="5127599">]</span><span class="op" id="5127600">)</span><span class="op" id="5127601">;</span>&nbsp;<span class="ident" id="5127603">err</span>&nbsp;<span class="op" id="5127607">!=</span>&nbsp;<span class="ident" id="5127610">nil</span>&nbsp;<span class="op" id="5127614">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5127618">return</span>&nbsp;<span class="ident" id="5127625">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5127630">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5127633">_</span><span class="op" id="5127634">,</span>&nbsp;<span class="ident" id="5127636">err</span>&nbsp;<span class="op" id="5127640">:=</span>&nbsp;<span class="ident" id="5127643">c</span><span class="op" id="5127644">.</span><span class="ident" id="5127645">rwc</span><span class="op" id="5127648">.</span><span class="ident" id="5127649">Write</span><span class="op" id="5127654">(</span><span class="ident" id="5127655">c</span><span class="op" id="5127656">.</span><span class="ident" id="5127657">buf</span><span class="op" id="5127660">.</span><span class="ident" id="5127661">Bytes</span><span class="op" id="5127666">(</span><span class="op" id="5127667">)</span><span class="op" id="5127668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5127671">return</span>&nbsp;<span class="ident" id="5127678">err</span><br>
<span class="lineno"></span><span class="op" id="5127682">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="keyword" id="5127685">func</span>&nbsp;<span class="op" id="5127690">(</span><span class="ident" id="5127691">c</span>&nbsp;<span class="op" id="5127693">*</span><span class="ident" id="5127694">conn</span><span class="op" id="5127698">)</span>&nbsp;<span class="ident" id="5127700">writeBeginRequest</span><span class="op" id="5127717">(</span><span class="ident" id="5127718">reqId</span>&nbsp;<span class="builtintype" id="5127724">uint16</span><span class="op" id="5127730">,</span>&nbsp;<span class="ident" id="5127732">role</span>&nbsp;<span class="builtintype" id="5127737">uint16</span><span class="op" id="5127743">,</span>&nbsp;<span class="ident" id="5127745">flags</span>&nbsp;<span class="builtintype" id="5127751">uint8</span><span class="op" id="5127756">)</span>&nbsp;<span class="builtintype" id="5127758">error</span>&nbsp;<span class="op" id="5127764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5127767">b</span>&nbsp;<span class="op" id="5127769">:=</span>&nbsp;<span class="op" id="5127772">[</span><span class="num" id="5127773">8</span><span class="op" id="5127774">]</span><span class="builtintype" id="5127775">byte</span><span class="op" id="5127779">{</span><span class="builtintype" id="5127780">byte</span><span class="op" id="5127784">(</span><span class="ident" id="5127785">role</span>&nbsp;<span class="op" id="5127790">&gt;&gt;</span>&nbsp;<span class="num" id="5127793">8</span><span class="op" id="5127794">)</span><span class="op" id="5127795">,</span>&nbsp;<span class="builtintype" id="5127797">byte</span><span class="op" id="5127801">(</span><span class="ident" id="5127802">role</span><span class="op" id="5127806">)</span><span class="op" id="5127807">,</span>&nbsp;<span class="ident" id="5127809">flags</span><span class="op" id="5127814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5127817">return</span>&nbsp;<span class="ident" id="5127824">c</span><span class="op" id="5127825">.</span><span class="ident" id="5127826">writeRecord</span><span class="op" id="5127837">(</span><span class="ident" id="5127838">typeBeginRequest</span><span class="op" id="5127854">,</span>&nbsp;<span class="ident" id="5127856">reqId</span><span class="op" id="5127861">,</span>&nbsp;<span class="ident" id="5127863">b</span><span class="op" id="5127864">[</span><span class="op" id="5127865">:</span><span class="op" id="5127866">]</span><span class="op" id="5127867">)</span><br>
<span class="lineno"></span><span class="op" id="5127869">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="5127872">func</span>&nbsp;<span class="op" id="5127877">(</span><span class="ident" id="5127878">c</span>&nbsp;<span class="op" id="5127880">*</span><span class="ident" id="5127881">conn</span><span class="op" id="5127885">)</span>&nbsp;<span class="ident" id="5127887">writeEndRequest</span><span class="op" id="5127902">(</span><span class="ident" id="5127903">reqId</span>&nbsp;<span class="builtintype" id="5127909">uint16</span><span class="op" id="5127915">,</span>&nbsp;<span class="ident" id="5127917">appStatus</span>&nbsp;<span class="builtintype" id="5127927">int</span><span class="op" id="5127930">,</span>&nbsp;<span class="ident" id="5127932">protocolStatus</span>&nbsp;<span class="builtintype" id="5127947">uint8</span><span class="op" id="5127952">)</span>&nbsp;<span class="builtintype" id="5127954">error</span>&nbsp;<span class="op" id="5127960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5127963">b</span>&nbsp;<span class="op" id="5127965">:=</span>&nbsp;<span class="builtinfunc" id="5127968">make</span><span class="op" id="5127972">(</span><span class="op" id="5127973">[</span><span class="op" id="5127974">]</span><span class="builtintype" id="5127975">byte</span><span class="op" id="5127979">,</span>&nbsp;<span class="num" id="5127981">8</span><span class="op" id="5127982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5127985">binary</span><span class="op" id="5127991">.</span><span class="ident" id="5127992">BigEndian</span><span class="op" id="5128001">.</span><span class="ident" id="5128002">PutUint32</span><span class="op" id="5128011">(</span><span class="ident" id="5128012">b</span><span class="op" id="5128013">,</span>&nbsp;<span class="builtintype" id="5128015">uint32</span><span class="op" id="5128021">(</span><span class="ident" id="5128022">appStatus</span><span class="op" id="5128031">)</span><span class="op" id="5128032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128035">b</span><span class="op" id="5128036">[</span><span class="num" id="5128037">4</span><span class="op" id="5128038">]</span>&nbsp;<span class="op" id="5128040">=</span>&nbsp;<span class="ident" id="5128042">protocolStatus</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128058">return</span>&nbsp;<span class="ident" id="5128065">c</span><span class="op" id="5128066">.</span><span class="ident" id="5128067">writeRecord</span><span class="op" id="5128078">(</span><span class="ident" id="5128079">typeEndRequest</span><span class="op" id="5128093">,</span>&nbsp;<span class="ident" id="5128095">reqId</span><span class="op" id="5128100">,</span>&nbsp;<span class="ident" id="5128102">b</span><span class="op" id="5128103">)</span><br>
<span class="lineno"></span><span class="op" id="5128105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5128108">func</span>&nbsp;<span class="op" id="5128113">(</span><span class="ident" id="5128114">c</span>&nbsp;<span class="op" id="5128116">*</span><span class="ident" id="5128117">conn</span><span class="op" id="5128121">)</span>&nbsp;<span class="ident" id="5128123">writePairs</span><span class="op" id="5128133">(</span><span class="ident" id="5128134">recType</span>&nbsp;<span class="ident" id="5128142">recType</span><span class="op" id="5128149">,</span>&nbsp;<span class="ident" id="5128151">reqId</span>&nbsp;<span class="builtintype" id="5128157">uint16</span><span class="op" id="5128163">,</span>&nbsp;<span class="ident" id="5128165">pairs</span>&nbsp;<span class="keyword" id="5128171">map</span><span class="op" id="5128174">[</span><span class="builtintype" id="5128175">string</span><span class="op" id="5128181">]</span><span class="builtintype" id="5128182">string</span><span class="op" id="5128188">)</span>&nbsp;<span class="builtintype" id="5128190">error</span>&nbsp;<span class="op" id="5128196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128199">w</span>&nbsp;<span class="op" id="5128201">:=</span>&nbsp;<span class="ident" id="5128204">newWriter</span><span class="op" id="5128213">(</span><span class="ident" id="5128214">c</span><span class="op" id="5128215">,</span>&nbsp;<span class="ident" id="5128217">recType</span><span class="op" id="5128224">,</span>&nbsp;<span class="ident" id="5128226">reqId</span><span class="op" id="5128231">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128234">b</span>&nbsp;<span class="op" id="5128236">:=</span>&nbsp;<span class="builtinfunc" id="5128239">make</span><span class="op" id="5128243">(</span><span class="op" id="5128244">[</span><span class="op" id="5128245">]</span><span class="builtintype" id="5128246">byte</span><span class="op" id="5128250">,</span>&nbsp;<span class="num" id="5128252">8</span><span class="op" id="5128253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128256">for</span>&nbsp;<span class="ident" id="5128260">k</span><span class="op" id="5128261">,</span>&nbsp;<span class="ident" id="5128263">v</span>&nbsp;<span class="op" id="5128265">:=</span>&nbsp;<span class="keyword" id="5128268">range</span>&nbsp;<span class="ident" id="5128274">pairs</span>&nbsp;<span class="op" id="5128280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128284">n</span>&nbsp;<span class="op" id="5128286">:=</span>&nbsp;<span class="ident" id="5128289">encodeSize</span><span class="op" id="5128299">(</span><span class="ident" id="5128300">b</span><span class="op" id="5128301">,</span>&nbsp;<span class="builtintype" id="5128303">uint32</span><span class="op" id="5128309">(</span><span class="builtinfunc" id="5128310">len</span><span class="op" id="5128313">(</span><span class="ident" id="5128314">k</span><span class="op" id="5128315">)</span><span class="op" id="5128316">)</span><span class="op" id="5128317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128321">n</span>&nbsp;<span class="op" id="5128323">+=</span>&nbsp;<span class="ident" id="5128326">encodeSize</span><span class="op" id="5128336">(</span><span class="ident" id="5128337">b</span><span class="op" id="5128338">[</span><span class="ident" id="5128339">n</span><span class="op" id="5128340">:</span><span class="op" id="5128341">]</span><span class="op" id="5128342">,</span>&nbsp;<span class="builtintype" id="5128344">uint32</span><span class="op" id="5128350">(</span><span class="builtinfunc" id="5128351">len</span><span class="op" id="5128354">(</span><span class="ident" id="5128355">v</span><span class="op" id="5128356">)</span><span class="op" id="5128357">)</span><span class="op" id="5128358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128362">if</span>&nbsp;<span class="ident" id="5128365">_</span><span class="op" id="5128366">,</span>&nbsp;<span class="ident" id="5128368">err</span>&nbsp;<span class="op" id="5128372">:=</span>&nbsp;<span class="ident" id="5128375">w</span><span class="op" id="5128376">.</span><span class="ident" id="5128377">Write</span><span class="op" id="5128382">(</span><span class="ident" id="5128383">b</span><span class="op" id="5128384">[</span><span class="op" id="5128385">:</span><span class="ident" id="5128386">n</span><span class="op" id="5128387">]</span><span class="op" id="5128388">)</span><span class="op" id="5128389">;</span>&nbsp;<span class="ident" id="5128391">err</span>&nbsp;<span class="op" id="5128395">!=</span>&nbsp;<span class="ident" id="5128398">nil</span>&nbsp;<span class="op" id="5128402">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128407">return</span>&nbsp;<span class="ident" id="5128414">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5128420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128424">if</span>&nbsp;<span class="ident" id="5128427">_</span><span class="op" id="5128428">,</span>&nbsp;<span class="ident" id="5128430">err</span>&nbsp;<span class="op" id="5128434">:=</span>&nbsp;<span class="ident" id="5128437">w</span><span class="op" id="5128438">.</span><span class="ident" id="5128439">WriteString</span><span class="op" id="5128450">(</span><span class="ident" id="5128451">k</span><span class="op" id="5128452">)</span><span class="op" id="5128453">;</span>&nbsp;<span class="ident" id="5128455">err</span>&nbsp;<span class="op" id="5128459">!=</span>&nbsp;<span class="ident" id="5128462">nil</span>&nbsp;<span class="op" id="5128466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128471">return</span>&nbsp;<span class="ident" id="5128478">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5128484">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128488">if</span>&nbsp;<span class="ident" id="5128491">_</span><span class="op" id="5128492">,</span>&nbsp;<span class="ident" id="5128494">err</span>&nbsp;<span class="op" id="5128498">:=</span>&nbsp;<span class="ident" id="5128501">w</span><span class="op" id="5128502">.</span><span class="ident" id="5128503">WriteString</span><span class="op" id="5128514">(</span><span class="ident" id="5128515">v</span><span class="op" id="5128516">)</span><span class="op" id="5128517">;</span>&nbsp;<span class="ident" id="5128519">err</span>&nbsp;<span class="op" id="5128523">!=</span>&nbsp;<span class="ident" id="5128526">nil</span>&nbsp;<span class="op" id="5128530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128535">return</span>&nbsp;<span class="ident" id="5128542">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5128548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5128551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128554">w</span><span class="op" id="5128555">.</span><span class="ident" id="5128556">Close</span><span class="op" id="5128561">(</span><span class="op" id="5128562">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128565">return</span>&nbsp;<span class="ident" id="5128572">nil</span><br>
<span class="lineno"></span><span class="op" id="5128576">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5128579">func</span>&nbsp;<span class="ident" id="5128584">readSize</span><span class="op" id="5128592">(</span><span class="ident" id="5128593">s</span>&nbsp;<span class="op" id="5128595">[</span><span class="op" id="5128596">]</span><span class="builtintype" id="5128597">byte</span><span class="op" id="5128601">)</span>&nbsp;<span class="op" id="5128603">(</span><span class="builtintype" id="5128604">uint32</span><span class="op" id="5128610">,</span>&nbsp;<span class="builtintype" id="5128612">int</span><span class="op" id="5128615">)</span>&nbsp;<span class="op" id="5128617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128620">if</span>&nbsp;<span class="builtinfunc" id="5128623">len</span><span class="op" id="5128626">(</span><span class="ident" id="5128627">s</span><span class="op" id="5128628">)</span>&nbsp;<span class="op" id="5128630">==</span>&nbsp;<span class="num" id="5128633">0</span>&nbsp;<span class="op" id="5128635">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128639">return</span>&nbsp;<span class="num" id="5128646">0</span><span class="op" id="5128647">,</span>&nbsp;<span class="num" id="5128649">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5128652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128655">size</span><span class="op" id="5128659">,</span>&nbsp;<span class="ident" id="5128661">n</span>&nbsp;<span class="op" id="5128663">:=</span>&nbsp;<span class="builtintype" id="5128666">uint32</span><span class="op" id="5128672">(</span><span class="ident" id="5128673">s</span><span class="op" id="5128674">[</span><span class="num" id="5128675">0</span><span class="op" id="5128676">]</span><span class="op" id="5128677">)</span><span class="op" id="5128678">,</span>&nbsp;<span class="num" id="5128680">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128683">if</span>&nbsp;<span class="ident" id="5128686">size</span><span class="op" id="5128690">&amp;</span><span class="op" id="5128691">(</span><span class="num" id="5128692">1</span><span class="op" id="5128693">&lt;&lt;</span><span class="num" id="5128695">7</span><span class="op" id="5128696">)</span>&nbsp;<span class="op" id="5128698">!=</span>&nbsp;<span class="num" id="5128701">0</span>&nbsp;<span class="op" id="5128703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128707">if</span>&nbsp;<span class="builtinfunc" id="5128710">len</span><span class="op" id="5128713">(</span><span class="ident" id="5128714">s</span><span class="op" id="5128715">)</span>&nbsp;<span class="op" id="5128717">&lt;</span>&nbsp;<span class="num" id="5128719">4</span>&nbsp;<span class="op" id="5128721">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128726">return</span>&nbsp;<span class="num" id="5128733">0</span><span class="op" id="5128734">,</span>&nbsp;<span class="num" id="5128736">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5128740">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128744">n</span>&nbsp;<span class="op" id="5128746">=</span>&nbsp;<span class="num" id="5128748">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128752">size</span>&nbsp;<span class="op" id="5128757">=</span>&nbsp;<span class="ident" id="5128759">binary</span><span class="op" id="5128765">.</span><span class="ident" id="5128766">BigEndian</span><span class="op" id="5128775">.</span><span class="ident" id="5128776">Uint32</span><span class="op" id="5128782">(</span><span class="ident" id="5128783">s</span><span class="op" id="5128784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128788">size</span>&nbsp;<span class="op" id="5128793">&amp;^=</span>&nbsp;<span class="num" id="5128797">1</span>&nbsp;<span class="op" id="5128799">&lt;&lt;</span>&nbsp;<span class="num" id="5128802">31</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5128806">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128809">return</span>&nbsp;<span class="ident" id="5128816">size</span><span class="op" id="5128820">,</span>&nbsp;<span class="ident" id="5128822">n</span><br>
<span class="lineno"></span><span class="op" id="5128824">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5128827">func</span>&nbsp;<span class="ident" id="5128832">readString</span><span class="op" id="5128842">(</span><span class="ident" id="5128843">s</span>&nbsp;<span class="op" id="5128845">[</span><span class="op" id="5128846">]</span><span class="builtintype" id="5128847">byte</span><span class="op" id="5128851">,</span>&nbsp;<span class="ident" id="5128853">size</span>&nbsp;<span class="builtintype" id="5128858">uint32</span><span class="op" id="5128864">)</span>&nbsp;<span class="builtintype" id="5128866">string</span>&nbsp;<span class="op" id="5128873">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128876">if</span>&nbsp;<span class="ident" id="5128879">size</span>&nbsp;<span class="op" id="5128884">&gt;</span>&nbsp;<span class="builtintype" id="5128886">uint32</span><span class="op" id="5128892">(</span><span class="builtinfunc" id="5128893">len</span><span class="op" id="5128896">(</span><span class="ident" id="5128897">s</span><span class="op" id="5128898">)</span><span class="op" id="5128899">)</span>&nbsp;<span class="op" id="5128901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128905">return</span>&nbsp;<span class="string" id="5128912">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5128916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128919">return</span>&nbsp;<span class="builtintype" id="5128926">string</span><span class="op" id="5128932">(</span><span class="ident" id="5128933">s</span><span class="op" id="5128934">[</span><span class="op" id="5128935">:</span><span class="ident" id="5128936">size</span><span class="op" id="5128940">]</span><span class="op" id="5128941">)</span><br>
<span class="lineno"></span><span class="op" id="5128943">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="5128946">func</span>&nbsp;<span class="ident" id="5128951">encodeSize</span><span class="op" id="5128961">(</span><span class="ident" id="5128962">b</span>&nbsp;<span class="op" id="5128964">[</span><span class="op" id="5128965">]</span><span class="builtintype" id="5128966">byte</span><span class="op" id="5128970">,</span>&nbsp;<span class="ident" id="5128972">size</span>&nbsp;<span class="builtintype" id="5128977">uint32</span><span class="op" id="5128983">)</span>&nbsp;<span class="builtintype" id="5128985">int</span>&nbsp;<span class="op" id="5128989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128992">if</span>&nbsp;<span class="ident" id="5128995">size</span>&nbsp;<span class="op" id="5129000">&gt;</span>&nbsp;<span class="num" id="5129002">127</span>&nbsp;<span class="op" id="5129006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5129010">size</span>&nbsp;<span class="op" id="5129015">|=</span>&nbsp;<span class="num" id="5129018">1</span>&nbsp;<span class="op" id="5129020">&lt;&lt;</span>&nbsp;<span class="num" id="5129023">31</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5129028">binary</span><span class="op" id="5129034">.</span><span class="ident" id="5129035">BigEndian</span><span class="op" id="5129044">.</span><span class="ident" id="5129045">PutUint32</span><span class="op" id="5129054">(</span><span class="ident" id="5129055">b</span><span class="op" id="5129056">,</span>&nbsp;<span class="ident" id="5129058">size</span><span class="op" id="5129062">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5129066">return</span>&nbsp;<span class="num" id="5129073">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5129076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5129079">b</span><span class="op" id="5129080">[</span><span class="num" id="5129081">0</span><span class="op" id="5129082">]</span>&nbsp;<span class="op" id="5129084">=</span>&nbsp;<span class="builtintype" id="5129086">byte</span><span class="op" id="5129090">(</span><span class="ident" id="5129091">size</span><span class="op" id="5129095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5129098">return</span>&nbsp;<span class="num" id="5129105">1</span><br>
<span class="lineno"></span><span class="op" id="5129107">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="comment" id="5129110">//&nbsp;bufWriter&nbsp;encapsulates&nbsp;bufio.Writer&nbsp;but&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;stream&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="5129192">//&nbsp;Closed.</span><br>
<span class="lineno"></span><span class="keyword" id="5129203">type</span>&nbsp;<span class="ident" id="5129208">bufWriter</span>&nbsp;<span class="keyword" id="5129218">struct</span>&nbsp;<span class="op" id="5129225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5129228">closer</span>&nbsp;<span class="ident" id="5129235">io</span><span class="op" id="5129237">.</span><span class="ident" id="5129238">Closer</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5129246">*</span><span class="ident" id="5129247">bufio</span><span class="op" id="5129252">.</span><span class="ident" id="5129253">Writer</span><br>
<span class="lineno"></span><span class="op" id="5129260">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5129263">func</span>&nbsp;<span class="op" id="5129268">(</span><span class="ident" id="5129269">w</span>&nbsp;<span class="op" id="5129271">*</span><span class="ident" id="5129272">bufWriter</span><span class="op" id="5129281">)</span>&nbsp;<span class="ident" id="5129283">Close</span><span class="op" id="5129288">(</span><span class="op" id="5129289">)</span>&nbsp;<span class="builtintype" id="5129291">error</span>&nbsp;<span class="op" id="5129297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5129300">if</span>&nbsp;<span class="ident" id="5129303">err</span>&nbsp;<span class="op" id="5129307">:=</span>&nbsp;<span class="ident" id="5129310">w</span><span class="op" id="5129311">.</span><span class="ident" id="5129312">Writer</span><span class="op" id="5129318">.</span><span class="ident" id="5129319">Flush</span><span class="op" id="5129324">(</span><span class="op" id="5129325">)</span><span class="op" id="5129326">;</span>&nbsp;<span class="ident" id="5129328">err</span>&nbsp;<span class="op" id="5129332">!=</span>&nbsp;<span class="ident" id="5129335">nil</span>&nbsp;<span class="op" id="5129339">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5129343">w</span><span class="op" id="5129344">.</span><span class="ident" id="5129345">closer</span><span class="op" id="5129351">.</span><span class="ident" id="5129352">Close</span><span class="op" id="5129357">(</span><span class="op" id="5129358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5129362">return</span>&nbsp;<span class="ident" id="5129369">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5129374">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5129377">return</span>&nbsp;<span class="ident" id="5129384">w</span><span class="op" id="5129385">.</span><span class="ident" id="5129386">closer</span><span class="op" id="5129392">.</span><span class="ident" id="5129393">Close</span><span class="op" id="5129398">(</span><span class="op" id="5129399">)</span><br>
<span class="lineno"></span><span class="op" id="5129401">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="keyword" id="5129404">func</span>&nbsp;<span class="ident" id="5129409">newWriter</span><span class="op" id="5129418">(</span><span class="ident" id="5129419">c</span>&nbsp;<span class="op" id="5129421">*</span><span class="ident" id="5129422">conn</span><span class="op" id="5129426">,</span>&nbsp;<span class="ident" id="5129428">recType</span>&nbsp;<span class="ident" id="5129436">recType</span><span class="op" id="5129443">,</span>&nbsp;<span class="ident" id="5129445">reqId</span>&nbsp;<span class="builtintype" id="5129451">uint16</span><span class="op" id="5129457">)</span>&nbsp;<span class="op" id="5129459">*</span><span class="ident" id="5129460">bufWriter</span>&nbsp;<span class="op" id="5129470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5129473">s</span>&nbsp;<span class="op" id="5129475">:=</span>&nbsp;<span class="op" id="5129478">&amp;</span><span class="ident" id="5129479">streamWriter</span><span class="op" id="5129491">{</span><span class="ident" id="5129492">c</span><span class="op" id="5129493">:</span>&nbsp;<span class="ident" id="5129495">c</span><span class="op" id="5129496">,</span>&nbsp;<span class="ident" id="5129498">recType</span><span class="op" id="5129505">:</span>&nbsp;<span class="ident" id="5129507">recType</span><span class="op" id="5129514">,</span>&nbsp;<span class="ident" id="5129516">reqId</span><span class="op" id="5129521">:</span>&nbsp;<span class="ident" id="5129523">reqId</span><span class="op" id="5129528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5129531">w</span>&nbsp;<span class="op" id="5129533">:=</span>&nbsp;<span class="ident" id="5129536">bufio</span><span class="op" id="5129541">.</span><span class="ident" id="5129542">NewWriterSize</span><span class="op" id="5129555">(</span><span class="ident" id="5129556">s</span><span class="op" id="5129557">,</span>&nbsp;<span class="ident" id="5129559">maxWrite</span><span class="op" id="5129567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5129570">return</span>&nbsp;<span class="op" id="5129577">&amp;</span><span class="ident" id="5129578">bufWriter</span><span class="op" id="5129587">{</span><span class="ident" id="5129588">s</span><span class="op" id="5129589">,</span>&nbsp;<span class="ident" id="5129591">w</span><span class="op" id="5129592">}</span><br>
<span class="lineno">245</span><span class="op" id="5129594">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5129597">//&nbsp;streamWriter&nbsp;abstracts&nbsp;out&nbsp;the&nbsp;separation&nbsp;of&nbsp;a&nbsp;stream&nbsp;into&nbsp;discrete&nbsp;records.</span><br>
<span class="lineno"></span><span class="comment" id="5129677">//&nbsp;It&nbsp;only&nbsp;writes&nbsp;maxWrite&nbsp;bytes&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="5129721">type</span>&nbsp;<span class="ident" id="5129726">streamWriter</span>&nbsp;<span class="keyword" id="5129739">struct</span>&nbsp;<span class="op" id="5129746">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5129749">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5129757">*</span><span class="ident" id="5129758">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5129764">recType</span>&nbsp;<span class="ident" id="5129772">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5129781">reqId</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5129789">uint16</span><br>
<span class="lineno"></span><span class="op" id="5129796">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="keyword" id="5129799">func</span>&nbsp;<span class="op" id="5129804">(</span><span class="ident" id="5129805">w</span>&nbsp;<span class="op" id="5129807">*</span><span class="ident" id="5129808">streamWriter</span><span class="op" id="5129820">)</span>&nbsp;<span class="ident" id="5129822">Write</span><span class="op" id="5129827">(</span><span class="ident" id="5129828">p</span>&nbsp;<span class="op" id="5129830">[</span><span class="op" id="5129831">]</span><span class="builtintype" id="5129832">byte</span><span class="op" id="5129836">)</span>&nbsp;<span class="op" id="5129838">(</span><span class="builtintype" id="5129839">int</span><span class="op" id="5129842">,</span>&nbsp;<span class="builtintype" id="5129844">error</span><span class="op" id="5129849">)</span>&nbsp;<span class="op" id="5129851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5129854">nn</span>&nbsp;<span class="op" id="5129857">:=</span>&nbsp;<span class="num" id="5129860">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5129863">for</span>&nbsp;<span class="builtinfunc" id="5129867">len</span><span class="op" id="5129870">(</span><span class="ident" id="5129871">p</span><span class="op" id="5129872">)</span>&nbsp;<span class="op" id="5129874">&gt;</span>&nbsp;<span class="num" id="5129876">0</span>&nbsp;<span class="op" id="5129878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5129882">n</span>&nbsp;<span class="op" id="5129884">:=</span>&nbsp;<span class="builtinfunc" id="5129887">len</span><span class="op" id="5129890">(</span><span class="ident" id="5129891">p</span><span class="op" id="5129892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5129896">if</span>&nbsp;<span class="ident" id="5129899">n</span>&nbsp;<span class="op" id="5129901">&gt;</span>&nbsp;<span class="ident" id="5129903">maxWrite</span>&nbsp;<span class="op" id="5129912">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5129917">n</span>&nbsp;<span class="op" id="5129919">=</span>&nbsp;<span class="ident" id="5129921">maxWrite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5129932">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5129936">if</span>&nbsp;<span class="ident" id="5129939">err</span>&nbsp;<span class="op" id="5129943">:=</span>&nbsp;<span class="ident" id="5129946">w</span><span class="op" id="5129947">.</span><span class="ident" id="5129948">c</span><span class="op" id="5129949">.</span><span class="ident" id="5129950">writeRecord</span><span class="op" id="5129961">(</span><span class="ident" id="5129962">w</span><span class="op" id="5129963">.</span><span class="ident" id="5129964">recType</span><span class="op" id="5129971">,</span>&nbsp;<span class="ident" id="5129973">w</span><span class="op" id="5129974">.</span><span class="ident" id="5129975">reqId</span><span class="op" id="5129980">,</span>&nbsp;<span class="ident" id="5129982">p</span><span class="op" id="5129983">[</span><span class="op" id="5129984">:</span><span class="ident" id="5129985">n</span><span class="op" id="5129986">]</span><span class="op" id="5129987">)</span><span class="op" id="5129988">;</span>&nbsp;<span class="ident" id="5129990">err</span>&nbsp;<span class="op" id="5129994">!=</span>&nbsp;<span class="ident" id="5129997">nil</span>&nbsp;<span class="op" id="5130001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5130006">return</span>&nbsp;<span class="ident" id="5130013">nn</span><span class="op" id="5130015">,</span>&nbsp;<span class="ident" id="5130017">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5130023">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5130027">nn</span>&nbsp;<span class="op" id="5130030">+=</span>&nbsp;<span class="ident" id="5130033">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5130037">p</span>&nbsp;<span class="op" id="5130039">=</span>&nbsp;<span class="ident" id="5130041">p</span><span class="op" id="5130042">[</span><span class="ident" id="5130043">n</span><span class="op" id="5130044">:</span><span class="op" id="5130045">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5130048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5130051">return</span>&nbsp;<span class="ident" id="5130058">nn</span><span class="op" id="5130060">,</span>&nbsp;<span class="ident" id="5130062">nil</span><br>
<span class="lineno"></span><span class="op" id="5130066">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="keyword" id="5130069">func</span>&nbsp;<span class="op" id="5130074">(</span><span class="ident" id="5130075">w</span>&nbsp;<span class="op" id="5130077">*</span><span class="ident" id="5130078">streamWriter</span><span class="op" id="5130090">)</span>&nbsp;<span class="ident" id="5130092">Close</span><span class="op" id="5130097">(</span><span class="op" id="5130098">)</span>&nbsp;<span class="builtintype" id="5130100">error</span>&nbsp;<span class="op" id="5130106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5130109">//&nbsp;send&nbsp;empty&nbsp;record&nbsp;to&nbsp;close&nbsp;the&nbsp;stream</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5130151">return</span>&nbsp;<span class="ident" id="5130158">w</span><span class="op" id="5130159">.</span><span class="ident" id="5130160">c</span><span class="op" id="5130161">.</span><span class="ident" id="5130162">writeRecord</span><span class="op" id="5130173">(</span><span class="ident" id="5130174">w</span><span class="op" id="5130175">.</span><span class="ident" id="5130176">recType</span><span class="op" id="5130183">,</span>&nbsp;<span class="ident" id="5130185">w</span><span class="op" id="5130186">.</span><span class="ident" id="5130187">reqId</span><span class="op" id="5130192">,</span>&nbsp;<span class="ident" id="5130194">nil</span><span class="op" id="5130197">)</span><br>
<span class="lineno"></span><span class="op" id="5130199">}</span>
</div>
</body>
</html>
