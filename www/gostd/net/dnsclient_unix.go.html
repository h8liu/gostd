<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3239284">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3239339">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3239393">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3239444">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3239509">//&nbsp;DNS&nbsp;client:&nbsp;see&nbsp;RFC&nbsp;1035.</span><br>
<span class="lineno"></span><span class="comment" id="3239538">//&nbsp;Has&nbsp;to&nbsp;be&nbsp;linked&nbsp;into&nbsp;package&nbsp;net&nbsp;for&nbsp;Dial.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="3239586">//&nbsp;TODO(rsc):</span><br>
<span class="lineno"></span><span class="comment" id="3239600">//&nbsp;&nbsp;&nbsp;&nbspCould&nbsp;potentially&nbsp;handle&nbsp;many&nbsp;outstanding&nbsp;lookups&nbsp;faster.</span><br>
<span class="lineno"></span><span class="comment" id="3239661">//&nbsp;&nbsp;&nbsp;&nbspCould&nbsp;have&nbsp;a&nbsp;small&nbsp;cache.</span><br>
<span class="lineno"></span><span class="comment" id="3239690">//&nbsp;&nbsp;&nbsp;&nbspRandom&nbsp;UDP&nbsp;source&nbsp;port&nbsp;(net.Dial&nbsp;should&nbsp;do&nbsp;that&nbsp;for&nbsp;us).</span><br>
<span class="lineno"></span><span class="comment" id="3239750">//&nbsp;&nbsp;&nbsp;&nbspRandom&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="3239774">package</span>&nbsp;<span class="ident" id="3239782">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3239787">import</span>&nbsp;<span class="op" id="3239794">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3239797">&#34;errors&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3239807">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3239813">&#34;math/rand&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3239826">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3239832">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3239840">&#34;time&#34;</span><br>
<span class="lineno">25</span><span class="op" id="3239847">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3239850">//&nbsp;A&nbsp;dnsConn&nbsp;represents&nbsp;a&nbsp;DNS&nbsp;transport&nbsp;endpoint.</span><br>
<span class="lineno"></span><span class="keyword" id="3239900">type</span>&nbsp;<span class="ident" id="3239905">dnsConn</span>&nbsp;<span class="keyword" id="3239913">interface</span>&nbsp;<span class="op" id="3239923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239926">Conn</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3239933">//&nbsp;readDNSResponse&nbsp;reads&nbsp;a&nbsp;DNS&nbsp;response&nbsp;message&nbsp;from&nbsp;the&nbsp;DNS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3239995">//&nbsp;transport&nbsp;endpoint&nbsp;and&nbsp;returns&nbsp;the&nbsp;received&nbsp;DNS&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3240056">//&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3240069">readDNSResponse</span><span class="op" id="3240084">(</span><span class="op" id="3240085">)</span>&nbsp;<span class="op" id="3240087">(</span><span class="op" id="3240088">*</span><span class="ident" id="3240089">dnsMsg</span><span class="op" id="3240095">,</span>&nbsp;<span class="builtintype" id="3240097">error</span><span class="op" id="3240102">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3240106">//&nbsp;writeDNSQuery&nbsp;writes&nbsp;a&nbsp;DNS&nbsp;query&nbsp;message&nbsp;to&nbsp;the&nbsp;DNS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3240162">//&nbsp;connection&nbsp;endpoint.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3240187">writeDNSQuery</span><span class="op" id="3240200">(</span><span class="op" id="3240201">*</span><span class="ident" id="3240202">dnsMsg</span><span class="op" id="3240208">)</span>&nbsp;<span class="builtintype" id="3240210">error</span><br>
<span class="lineno"></span><span class="op" id="3240216">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="keyword" id="3240219">func</span>&nbsp;<span class="op" id="3240224">(</span><span class="ident" id="3240225">c</span>&nbsp;<span class="op" id="3240227">*</span><span class="ident" id="3240228">UDPConn</span><span class="op" id="3240235">)</span>&nbsp;<span class="ident" id="3240237">readDNSResponse</span><span class="op" id="3240252">(</span><span class="op" id="3240253">)</span>&nbsp;<span class="op" id="3240255">(</span><span class="op" id="3240256">*</span><span class="ident" id="3240257">dnsMsg</span><span class="op" id="3240263">,</span>&nbsp;<span class="builtintype" id="3240265">error</span><span class="op" id="3240270">)</span>&nbsp;<span class="op" id="3240272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3240275">b</span>&nbsp;<span class="op" id="3240277">:=</span>&nbsp;<span class="builtinfunc" id="3240280">make</span><span class="op" id="3240284">(</span><span class="op" id="3240285">[</span><span class="op" id="3240286">]</span><span class="builtintype" id="3240287">byte</span><span class="op" id="3240291">,</span>&nbsp;<span class="num" id="3240293">512</span><span class="op" id="3240296">)</span>&nbsp;<span class="comment" id="3240298">//&nbsp;see&nbsp;RFC&nbsp;1035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3240315">n</span><span class="op" id="3240316">,</span>&nbsp;<span class="ident" id="3240318">err</span>&nbsp;<span class="op" id="3240322">:=</span>&nbsp;<span class="ident" id="3240325">c</span><span class="op" id="3240326">.</span><span class="ident" id="3240327">Read</span><span class="op" id="3240331">(</span><span class="ident" id="3240332">b</span><span class="op" id="3240333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3240336">if</span>&nbsp;<span class="ident" id="3240339">err</span>&nbsp;<span class="op" id="3240343">!=</span>&nbsp;<span class="ident" id="3240346">nil</span>&nbsp;<span class="op" id="3240350">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3240354">return</span>&nbsp;<span class="ident" id="3240361">nil</span><span class="op" id="3240364">,</span>&nbsp;<span class="ident" id="3240366">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3240371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3240374">msg</span>&nbsp;<span class="op" id="3240378">:=</span>&nbsp;<span class="op" id="3240381">&amp;</span><span class="ident" id="3240382">dnsMsg</span><span class="op" id="3240388">{</span><span class="op" id="3240389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3240392">if</span>&nbsp;<span class="op" id="3240395">!</span><span class="ident" id="3240396">msg</span><span class="op" id="3240399">.</span><span class="ident" id="3240400">Unpack</span><span class="op" id="3240406">(</span><span class="ident" id="3240407">b</span><span class="op" id="3240408">[</span><span class="op" id="3240409">:</span><span class="ident" id="3240410">n</span><span class="op" id="3240411">]</span><span class="op" id="3240412">)</span>&nbsp;<span class="op" id="3240414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3240418">return</span>&nbsp;<span class="ident" id="3240425">nil</span><span class="op" id="3240428">,</span>&nbsp;<span class="ident" id="3240430">errors</span><span class="op" id="3240436">.</span><span class="ident" id="3240437">New</span><span class="op" id="3240440">(</span><span class="string" id="3240441">&#34;cannot&nbsp;unmarshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3240471">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3240474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3240477">return</span>&nbsp;<span class="ident" id="3240484">msg</span><span class="op" id="3240487">,</span>&nbsp;<span class="ident" id="3240489">nil</span><br>
<span class="lineno"></span><span class="op" id="3240493">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3240496">func</span>&nbsp;<span class="op" id="3240501">(</span><span class="ident" id="3240502">c</span>&nbsp;<span class="op" id="3240504">*</span><span class="ident" id="3240505">UDPConn</span><span class="op" id="3240512">)</span>&nbsp;<span class="ident" id="3240514">writeDNSQuery</span><span class="op" id="3240527">(</span><span class="ident" id="3240528">msg</span>&nbsp;<span class="op" id="3240532">*</span><span class="ident" id="3240533">dnsMsg</span><span class="op" id="3240539">)</span>&nbsp;<span class="builtintype" id="3240541">error</span>&nbsp;<span class="op" id="3240547">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3240550">b</span><span class="op" id="3240551">,</span>&nbsp;<span class="ident" id="3240553">ok</span>&nbsp;<span class="op" id="3240556">:=</span>&nbsp;<span class="ident" id="3240559">msg</span><span class="op" id="3240562">.</span><span class="ident" id="3240563">Pack</span><span class="op" id="3240567">(</span><span class="op" id="3240568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3240571">if</span>&nbsp;<span class="op" id="3240574">!</span><span class="ident" id="3240575">ok</span>&nbsp;<span class="op" id="3240578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3240582">return</span>&nbsp;<span class="ident" id="3240589">errors</span><span class="op" id="3240595">.</span><span class="ident" id="3240596">New</span><span class="op" id="3240599">(</span><span class="string" id="3240600">&#34;cannot&nbsp;marshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3240628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3240631">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3240634">if</span>&nbsp;<span class="ident" id="3240637">_</span><span class="op" id="3240638">,</span>&nbsp;<span class="ident" id="3240640">err</span>&nbsp;<span class="op" id="3240644">:=</span>&nbsp;<span class="ident" id="3240647">c</span><span class="op" id="3240648">.</span><span class="ident" id="3240649">Write</span><span class="op" id="3240654">(</span><span class="ident" id="3240655">b</span><span class="op" id="3240656">)</span><span class="op" id="3240657">;</span>&nbsp;<span class="ident" id="3240659">err</span>&nbsp;<span class="op" id="3240663">!=</span>&nbsp;<span class="ident" id="3240666">nil</span>&nbsp;<span class="op" id="3240670">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3240674">return</span>&nbsp;<span class="ident" id="3240681">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3240686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3240689">return</span>&nbsp;<span class="ident" id="3240696">nil</span><br>
<span class="lineno"></span><span class="op" id="3240700">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="keyword" id="3240703">func</span>&nbsp;<span class="op" id="3240708">(</span><span class="ident" id="3240709">c</span>&nbsp;<span class="op" id="3240711">*</span><span class="ident" id="3240712">TCPConn</span><span class="op" id="3240719">)</span>&nbsp;<span class="ident" id="3240721">readDNSResponse</span><span class="op" id="3240736">(</span><span class="op" id="3240737">)</span>&nbsp;<span class="op" id="3240739">(</span><span class="op" id="3240740">*</span><span class="ident" id="3240741">dnsMsg</span><span class="op" id="3240747">,</span>&nbsp;<span class="builtintype" id="3240749">error</span><span class="op" id="3240754">)</span>&nbsp;<span class="op" id="3240756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3240759">b</span>&nbsp;<span class="op" id="3240761">:=</span>&nbsp;<span class="builtinfunc" id="3240764">make</span><span class="op" id="3240768">(</span><span class="op" id="3240769">[</span><span class="op" id="3240770">]</span><span class="builtintype" id="3240771">byte</span><span class="op" id="3240775">,</span>&nbsp;<span class="num" id="3240777">1280</span><span class="op" id="3240781">)</span>&nbsp;<span class="comment" id="3240783">//&nbsp;1280&nbsp;is&nbsp;a&nbsp;reasonable&nbsp;initial&nbsp;size&nbsp;for&nbsp;IP&nbsp;over&nbsp;Ethernet,&nbsp;see&nbsp;RFC&nbsp;4035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3240856">if</span>&nbsp;<span class="ident" id="3240859">_</span><span class="op" id="3240860">,</span>&nbsp;<span class="ident" id="3240862">err</span>&nbsp;<span class="op" id="3240866">:=</span>&nbsp;<span class="ident" id="3240869">io</span><span class="op" id="3240871">.</span><span class="ident" id="3240872">ReadFull</span><span class="op" id="3240880">(</span><span class="ident" id="3240881">c</span><span class="op" id="3240882">,</span>&nbsp;<span class="ident" id="3240884">b</span><span class="op" id="3240885">[</span><span class="op" id="3240886">:</span><span class="num" id="3240887">2</span><span class="op" id="3240888">]</span><span class="op" id="3240889">)</span><span class="op" id="3240890">;</span>&nbsp;<span class="ident" id="3240892">err</span>&nbsp;<span class="op" id="3240896">!=</span>&nbsp;<span class="ident" id="3240899">nil</span>&nbsp;<span class="op" id="3240903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3240907">return</span>&nbsp;<span class="ident" id="3240914">nil</span><span class="op" id="3240917">,</span>&nbsp;<span class="ident" id="3240919">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3240924">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3240927">l</span>&nbsp;<span class="op" id="3240929">:=</span>&nbsp;<span class="builtintype" id="3240932">int</span><span class="op" id="3240935">(</span><span class="ident" id="3240936">b</span><span class="op" id="3240937">[</span><span class="num" id="3240938">0</span><span class="op" id="3240939">]</span><span class="op" id="3240940">)</span><span class="op" id="3240941">&lt;&lt;</span><span class="num" id="3240943">8</span>&nbsp;<span class="op" id="3240945">|</span>&nbsp;<span class="builtintype" id="3240947">int</span><span class="op" id="3240950">(</span><span class="ident" id="3240951">b</span><span class="op" id="3240952">[</span><span class="num" id="3240953">1</span><span class="op" id="3240954">]</span><span class="op" id="3240955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3240958">if</span>&nbsp;<span class="ident" id="3240961">l</span>&nbsp;<span class="op" id="3240963">&gt;</span>&nbsp;<span class="builtinfunc" id="3240965">len</span><span class="op" id="3240968">(</span><span class="ident" id="3240969">b</span><span class="op" id="3240970">)</span>&nbsp;<span class="op" id="3240972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3240976">b</span>&nbsp;<span class="op" id="3240978">=</span>&nbsp;<span class="builtinfunc" id="3240980">make</span><span class="op" id="3240984">(</span><span class="op" id="3240985">[</span><span class="op" id="3240986">]</span><span class="builtintype" id="3240987">byte</span><span class="op" id="3240991">,</span>&nbsp;<span class="ident" id="3240993">l</span><span class="op" id="3240994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3240997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3241000">n</span><span class="op" id="3241001">,</span>&nbsp;<span class="ident" id="3241003">err</span>&nbsp;<span class="op" id="3241007">:=</span>&nbsp;<span class="ident" id="3241010">io</span><span class="op" id="3241012">.</span><span class="ident" id="3241013">ReadFull</span><span class="op" id="3241021">(</span><span class="ident" id="3241022">c</span><span class="op" id="3241023">,</span>&nbsp;<span class="ident" id="3241025">b</span><span class="op" id="3241026">[</span><span class="op" id="3241027">:</span><span class="ident" id="3241028">l</span><span class="op" id="3241029">]</span><span class="op" id="3241030">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3241033">if</span>&nbsp;<span class="ident" id="3241036">err</span>&nbsp;<span class="op" id="3241040">!=</span>&nbsp;<span class="ident" id="3241043">nil</span>&nbsp;<span class="op" id="3241047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3241051">return</span>&nbsp;<span class="ident" id="3241058">nil</span><span class="op" id="3241061">,</span>&nbsp;<span class="ident" id="3241063">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3241068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3241071">msg</span>&nbsp;<span class="op" id="3241075">:=</span>&nbsp;<span class="op" id="3241078">&amp;</span><span class="ident" id="3241079">dnsMsg</span><span class="op" id="3241085">{</span><span class="op" id="3241086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3241089">if</span>&nbsp;<span class="op" id="3241092">!</span><span class="ident" id="3241093">msg</span><span class="op" id="3241096">.</span><span class="ident" id="3241097">Unpack</span><span class="op" id="3241103">(</span><span class="ident" id="3241104">b</span><span class="op" id="3241105">[</span><span class="op" id="3241106">:</span><span class="ident" id="3241107">n</span><span class="op" id="3241108">]</span><span class="op" id="3241109">)</span>&nbsp;<span class="op" id="3241111">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3241115">return</span>&nbsp;<span class="ident" id="3241122">nil</span><span class="op" id="3241125">,</span>&nbsp;<span class="ident" id="3241127">errors</span><span class="op" id="3241133">.</span><span class="ident" id="3241134">New</span><span class="op" id="3241137">(</span><span class="string" id="3241138">&#34;cannot&nbsp;unmarshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3241168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3241171">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3241174">return</span>&nbsp;<span class="ident" id="3241181">msg</span><span class="op" id="3241184">,</span>&nbsp;<span class="ident" id="3241186">nil</span><br>
<span class="lineno"></span><span class="op" id="3241190">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="keyword" id="3241193">func</span>&nbsp;<span class="op" id="3241198">(</span><span class="ident" id="3241199">c</span>&nbsp;<span class="op" id="3241201">*</span><span class="ident" id="3241202">TCPConn</span><span class="op" id="3241209">)</span>&nbsp;<span class="ident" id="3241211">writeDNSQuery</span><span class="op" id="3241224">(</span><span class="ident" id="3241225">msg</span>&nbsp;<span class="op" id="3241229">*</span><span class="ident" id="3241230">dnsMsg</span><span class="op" id="3241236">)</span>&nbsp;<span class="builtintype" id="3241238">error</span>&nbsp;<span class="op" id="3241244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3241247">b</span><span class="op" id="3241248">,</span>&nbsp;<span class="ident" id="3241250">ok</span>&nbsp;<span class="op" id="3241253">:=</span>&nbsp;<span class="ident" id="3241256">msg</span><span class="op" id="3241259">.</span><span class="ident" id="3241260">Pack</span><span class="op" id="3241264">(</span><span class="op" id="3241265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3241268">if</span>&nbsp;<span class="op" id="3241271">!</span><span class="ident" id="3241272">ok</span>&nbsp;<span class="op" id="3241275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3241279">return</span>&nbsp;<span class="ident" id="3241286">errors</span><span class="op" id="3241292">.</span><span class="ident" id="3241293">New</span><span class="op" id="3241296">(</span><span class="string" id="3241297">&#34;cannot&nbsp;marshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3241325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3241328">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3241331">l</span>&nbsp;<span class="op" id="3241333">:=</span>&nbsp;<span class="builtintype" id="3241336">uint16</span><span class="op" id="3241342">(</span><span class="builtinfunc" id="3241343">len</span><span class="op" id="3241346">(</span><span class="ident" id="3241347">b</span><span class="op" id="3241348">)</span><span class="op" id="3241349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3241352">b</span>&nbsp;<span class="op" id="3241354">=</span>&nbsp;<span class="builtinfunc" id="3241356">append</span><span class="op" id="3241362">(</span><span class="op" id="3241363">[</span><span class="op" id="3241364">]</span><span class="builtintype" id="3241365">byte</span><span class="op" id="3241369">{</span><span class="builtintype" id="3241370">byte</span><span class="op" id="3241374">(</span><span class="ident" id="3241375">l</span>&nbsp;<span class="op" id="3241377">&gt;&gt;</span>&nbsp;<span class="num" id="3241380">8</span><span class="op" id="3241381">)</span><span class="op" id="3241382">,</span>&nbsp;<span class="builtintype" id="3241384">byte</span><span class="op" id="3241388">(</span><span class="ident" id="3241389">l</span><span class="op" id="3241390">)</span><span class="op" id="3241391">}</span><span class="op" id="3241392">,</span>&nbsp;<span class="ident" id="3241394">b</span><span class="op" id="3241395">...</span><span class="op" id="3241398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3241401">if</span>&nbsp;<span class="ident" id="3241404">_</span><span class="op" id="3241405">,</span>&nbsp;<span class="ident" id="3241407">err</span>&nbsp;<span class="op" id="3241411">:=</span>&nbsp;<span class="ident" id="3241414">c</span><span class="op" id="3241415">.</span><span class="ident" id="3241416">Write</span><span class="op" id="3241421">(</span><span class="ident" id="3241422">b</span><span class="op" id="3241423">)</span><span class="op" id="3241424">;</span>&nbsp;<span class="ident" id="3241426">err</span>&nbsp;<span class="op" id="3241430">!=</span>&nbsp;<span class="ident" id="3241433">nil</span>&nbsp;<span class="op" id="3241437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3241441">return</span>&nbsp;<span class="ident" id="3241448">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3241453">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3241456">return</span>&nbsp;<span class="ident" id="3241463">nil</span><br>
<span class="lineno"></span><span class="op" id="3241467">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3241470">func</span>&nbsp;<span class="op" id="3241475">(</span><span class="ident" id="3241476">d</span>&nbsp;<span class="op" id="3241478">*</span><span class="ident" id="3241479">Dialer</span><span class="op" id="3241485">)</span>&nbsp;<span class="ident" id="3241487">dialDNS</span><span class="op" id="3241494">(</span><span class="ident" id="3241495">network</span><span class="op" id="3241502">,</span>&nbsp;<span class="ident" id="3241504">server</span>&nbsp;<span class="builtintype" id="3241511">string</span><span class="op" id="3241517">)</span>&nbsp;<span class="op" id="3241519">(</span><span class="ident" id="3241520">dnsConn</span><span class="op" id="3241527">,</span>&nbsp;<span class="builtintype" id="3241529">error</span><span class="op" id="3241534">)</span>&nbsp;<span class="op" id="3241536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3241539">switch</span>&nbsp;<span class="ident" id="3241546">network</span>&nbsp;<span class="op" id="3241554">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3241557">case</span>&nbsp;<span class="string" id="3241562">&#34;tcp&#34;</span><span class="op" id="3241567">,</span>&nbsp;<span class="string" id="3241569">&#34;tcp4&#34;</span><span class="op" id="3241575">,</span>&nbsp;<span class="string" id="3241577">&#34;tcp6&#34;</span><span class="op" id="3241583">,</span>&nbsp;<span class="string" id="3241585">&#34;udp&#34;</span><span class="op" id="3241590">,</span>&nbsp;<span class="string" id="3241592">&#34;udp4&#34;</span><span class="op" id="3241598">,</span>&nbsp;<span class="string" id="3241600">&#34;udp6&#34;</span><span class="op" id="3241606">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3241609">default</span><span class="op" id="3241616">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3241620">return</span>&nbsp;<span class="ident" id="3241627">nil</span><span class="op" id="3241630">,</span>&nbsp;<span class="ident" id="3241632">UnknownNetworkError</span><span class="op" id="3241651">(</span><span class="ident" id="3241652">network</span><span class="op" id="3241659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3241662">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3241665">//&nbsp;Calling&nbsp;Dial&nbsp;here&nbsp;is&nbsp;scary&nbsp;--&nbsp;we&nbsp;have&nbsp;to&nbsp;be&nbsp;sure&nbsp;not&nbsp;to</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3241725">//&nbsp;dial&nbsp;a&nbsp;name&nbsp;that&nbsp;will&nbsp;require&nbsp;a&nbsp;DNS&nbsp;lookup,&nbsp;or&nbsp;Dial&nbsp;will</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3241786">//&nbsp;call&nbsp;back&nbsp;here&nbsp;to&nbsp;translate&nbsp;it.&nbsp;The&nbsp;DNS&nbsp;config&nbsp;parser&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3241848">//&nbsp;already&nbsp;checked&nbsp;that&nbsp;all&nbsp;the&nbsp;cfg.servers[i]&nbsp;are&nbsp;IP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3241903">//&nbsp;addresses,&nbsp;which&nbsp;Dial&nbsp;will&nbsp;use&nbsp;without&nbsp;a&nbsp;DNS&nbsp;lookup.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3241960">c</span><span class="op" id="3241961">,</span>&nbsp;<span class="ident" id="3241963">err</span>&nbsp;<span class="op" id="3241967">:=</span>&nbsp;<span class="ident" id="3241970">d</span><span class="op" id="3241971">.</span><span class="ident" id="3241972">Dial</span><span class="op" id="3241976">(</span><span class="ident" id="3241977">network</span><span class="op" id="3241984">,</span>&nbsp;<span class="ident" id="3241986">server</span><span class="op" id="3241992">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3241995">if</span>&nbsp;<span class="ident" id="3241998">err</span>&nbsp;<span class="op" id="3242002">!=</span>&nbsp;<span class="ident" id="3242005">nil</span>&nbsp;<span class="op" id="3242009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3242013">return</span>&nbsp;<span class="ident" id="3242020">nil</span><span class="op" id="3242023">,</span>&nbsp;<span class="ident" id="3242025">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3242030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3242033">switch</span>&nbsp;<span class="ident" id="3242040">network</span>&nbsp;<span class="op" id="3242048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3242051">case</span>&nbsp;<span class="string" id="3242056">&#34;tcp&#34;</span><span class="op" id="3242061">,</span>&nbsp;<span class="string" id="3242063">&#34;tcp4&#34;</span><span class="op" id="3242069">,</span>&nbsp;<span class="string" id="3242071">&#34;tcp6&#34;</span><span class="op" id="3242077">:</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3242081">return</span>&nbsp;<span class="ident" id="3242088">c</span><span class="op" id="3242089">.</span><span class="op" id="3242090">(</span><span class="op" id="3242091">*</span><span class="ident" id="3242092">TCPConn</span><span class="op" id="3242099">)</span><span class="op" id="3242100">,</span>&nbsp;<span class="ident" id="3242102">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3242107">case</span>&nbsp;<span class="string" id="3242112">&#34;udp&#34;</span><span class="op" id="3242117">,</span>&nbsp;<span class="string" id="3242119">&#34;udp4&#34;</span><span class="op" id="3242125">,</span>&nbsp;<span class="string" id="3242127">&#34;udp6&#34;</span><span class="op" id="3242133">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3242137">return</span>&nbsp;<span class="ident" id="3242144">c</span><span class="op" id="3242145">.</span><span class="op" id="3242146">(</span><span class="op" id="3242147">*</span><span class="ident" id="3242148">UDPConn</span><span class="op" id="3242155">)</span><span class="op" id="3242156">,</span>&nbsp;<span class="ident" id="3242158">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3242163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3242166">panic</span><span class="op" id="3242171">(</span><span class="string" id="3242172">&#34;unreachable&#34;</span><span class="op" id="3242185">)</span><br>
<span class="lineno">120</span><span class="op" id="3242187">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3242190">//&nbsp;exchange&nbsp;sends&nbsp;a&nbsp;query&nbsp;on&nbsp;the&nbsp;connection&nbsp;and&nbsp;hopes&nbsp;for&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3242260">func</span>&nbsp;<span class="ident" id="3242265">exchange</span><span class="op" id="3242273">(</span><span class="ident" id="3242274">server</span><span class="op" id="3242280">,</span>&nbsp;<span class="ident" id="3242282">name</span>&nbsp;<span class="builtintype" id="3242287">string</span><span class="op" id="3242293">,</span>&nbsp;<span class="ident" id="3242295">qtype</span>&nbsp;<span class="builtintype" id="3242301">uint16</span><span class="op" id="3242307">,</span>&nbsp;<span class="ident" id="3242309">timeout</span>&nbsp;<span class="ident" id="3242317">time</span><span class="op" id="3242321">.</span><span class="ident" id="3242322">Duration</span><span class="op" id="3242330">)</span>&nbsp;<span class="op" id="3242332">(</span><span class="op" id="3242333">*</span><span class="ident" id="3242334">dnsMsg</span><span class="op" id="3242340">,</span>&nbsp;<span class="builtintype" id="3242342">error</span><span class="op" id="3242347">)</span>&nbsp;<span class="op" id="3242349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3242352">d</span>&nbsp;<span class="op" id="3242354">:=</span>&nbsp;<span class="ident" id="3242357">Dialer</span><span class="op" id="3242363">{</span><span class="ident" id="3242364">Timeout</span><span class="op" id="3242371">:</span>&nbsp;<span class="ident" id="3242373">timeout</span><span class="op" id="3242380">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3242383">out</span>&nbsp;<span class="op" id="3242387">:=</span>&nbsp;<span class="ident" id="3242390">dnsMsg</span><span class="op" id="3242396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3242400">dnsMsgHdr</span><span class="op" id="3242409">:</span>&nbsp;<span class="ident" id="3242411">dnsMsgHdr</span><span class="op" id="3242420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3242425">recursion_desired</span><span class="op" id="3242442">:</span>&nbsp;<span class="builtintype" id="3242444">true</span><span class="op" id="3242448">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3242452">}</span><span class="op" id="3242453">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3242457">question</span><span class="op" id="3242465">:</span>&nbsp;<span class="op" id="3242467">[</span><span class="op" id="3242468">]</span><span class="ident" id="3242469">dnsQuestion</span><span class="op" id="3242480">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3242485">{</span><span class="ident" id="3242486">name</span><span class="op" id="3242490">,</span>&nbsp;<span class="ident" id="3242492">qtype</span><span class="op" id="3242497">,</span>&nbsp;<span class="ident" id="3242499">dnsClassINET</span><span class="op" id="3242511">}</span><span class="op" id="3242512">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3242516">}</span><span class="op" id="3242517">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3242520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3242523">for</span>&nbsp;<span class="ident" id="3242527">_</span><span class="op" id="3242528">,</span>&nbsp;<span class="ident" id="3242530">network</span>&nbsp;<span class="op" id="3242538">:=</span>&nbsp;<span class="keyword" id="3242541">range</span>&nbsp;<span class="op" id="3242547">[</span><span class="op" id="3242548">]</span><span class="builtintype" id="3242549">string</span><span class="op" id="3242555">{</span><span class="string" id="3242556">&#34;udp&#34;</span><span class="op" id="3242561">,</span>&nbsp;<span class="string" id="3242563">&#34;tcp&#34;</span><span class="op" id="3242568">}</span>&nbsp;<span class="op" id="3242570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3242574">c</span><span class="op" id="3242575">,</span>&nbsp;<span class="ident" id="3242577">err</span>&nbsp;<span class="op" id="3242581">:=</span>&nbsp;<span class="ident" id="3242584">d</span><span class="op" id="3242585">.</span><span class="ident" id="3242586">dialDNS</span><span class="op" id="3242593">(</span><span class="ident" id="3242594">network</span><span class="op" id="3242601">,</span>&nbsp;<span class="ident" id="3242603">server</span><span class="op" id="3242609">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3242613">if</span>&nbsp;<span class="ident" id="3242616">err</span>&nbsp;<span class="op" id="3242620">!=</span>&nbsp;<span class="ident" id="3242623">nil</span>&nbsp;<span class="op" id="3242627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3242632">return</span>&nbsp;<span class="ident" id="3242639">nil</span><span class="op" id="3242642">,</span>&nbsp;<span class="ident" id="3242644">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3242650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3242654">defer</span>&nbsp;<span class="ident" id="3242660">c</span><span class="op" id="3242661">.</span><span class="ident" id="3242662">Close</span><span class="op" id="3242667">(</span><span class="op" id="3242668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3242672">if</span>&nbsp;<span class="ident" id="3242675">timeout</span>&nbsp;<span class="op" id="3242683">&gt;</span>&nbsp;<span class="num" id="3242685">0</span>&nbsp;<span class="op" id="3242687">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3242692">c</span><span class="op" id="3242693">.</span><span class="ident" id="3242694">SetDeadline</span><span class="op" id="3242705">(</span><span class="ident" id="3242706">time</span><span class="op" id="3242710">.</span><span class="ident" id="3242711">Now</span><span class="op" id="3242714">(</span><span class="op" id="3242715">)</span><span class="op" id="3242716">.</span><span class="ident" id="3242717">Add</span><span class="op" id="3242720">(</span><span class="ident" id="3242721">timeout</span><span class="op" id="3242728">)</span><span class="op" id="3242729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3242733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3242737">out</span><span class="op" id="3242740">.</span><span class="ident" id="3242741">id</span>&nbsp;<span class="op" id="3242744">=</span>&nbsp;<span class="builtintype" id="3242746">uint16</span><span class="op" id="3242752">(</span><span class="ident" id="3242753">rand</span><span class="op" id="3242757">.</span><span class="ident" id="3242758">Int</span><span class="op" id="3242761">(</span><span class="op" id="3242762">)</span><span class="op" id="3242763">)</span>&nbsp;<span class="op" id="3242765">^</span>&nbsp;<span class="builtintype" id="3242767">uint16</span><span class="op" id="3242773">(</span><span class="ident" id="3242774">time</span><span class="op" id="3242778">.</span><span class="ident" id="3242779">Now</span><span class="op" id="3242782">(</span><span class="op" id="3242783">)</span><span class="op" id="3242784">.</span><span class="ident" id="3242785">UnixNano</span><span class="op" id="3242793">(</span><span class="op" id="3242794">)</span><span class="op" id="3242795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3242799">if</span>&nbsp;<span class="ident" id="3242802">err</span>&nbsp;<span class="op" id="3242806">:=</span>&nbsp;<span class="ident" id="3242809">c</span><span class="op" id="3242810">.</span><span class="ident" id="3242811">writeDNSQuery</span><span class="op" id="3242824">(</span><span class="op" id="3242825">&amp;</span><span class="ident" id="3242826">out</span><span class="op" id="3242829">)</span><span class="op" id="3242830">;</span>&nbsp;<span class="ident" id="3242832">err</span>&nbsp;<span class="op" id="3242836">!=</span>&nbsp;<span class="ident" id="3242839">nil</span>&nbsp;<span class="op" id="3242843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3242848">return</span>&nbsp;<span class="ident" id="3242855">nil</span><span class="op" id="3242858">,</span>&nbsp;<span class="ident" id="3242860">err</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3242866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3242870">in</span><span class="op" id="3242872">,</span>&nbsp;<span class="ident" id="3242874">err</span>&nbsp;<span class="op" id="3242878">:=</span>&nbsp;<span class="ident" id="3242881">c</span><span class="op" id="3242882">.</span><span class="ident" id="3242883">readDNSResponse</span><span class="op" id="3242898">(</span><span class="op" id="3242899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3242903">if</span>&nbsp;<span class="ident" id="3242906">err</span>&nbsp;<span class="op" id="3242910">!=</span>&nbsp;<span class="ident" id="3242913">nil</span>&nbsp;<span class="op" id="3242917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3242922">return</span>&nbsp;<span class="ident" id="3242929">nil</span><span class="op" id="3242932">,</span>&nbsp;<span class="ident" id="3242934">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3242940">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3242944">if</span>&nbsp;<span class="ident" id="3242947">in</span><span class="op" id="3242949">.</span><span class="ident" id="3242950">id</span>&nbsp;<span class="op" id="3242953">!=</span>&nbsp;<span class="ident" id="3242956">out</span><span class="op" id="3242959">.</span><span class="ident" id="3242960">id</span>&nbsp;<span class="op" id="3242963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3242968">return</span>&nbsp;<span class="ident" id="3242975">nil</span><span class="op" id="3242978">,</span>&nbsp;<span class="ident" id="3242980">errors</span><span class="op" id="3242986">.</span><span class="ident" id="3242987">New</span><span class="op" id="3242990">(</span><span class="string" id="3242991">&#34;DNS&nbsp;message&nbsp;ID&nbsp;mismatch&#34;</span><span class="op" id="3243016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3243020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3243024">if</span>&nbsp;<span class="ident" id="3243027">in</span><span class="op" id="3243029">.</span><span class="ident" id="3243030">truncated</span>&nbsp;<span class="op" id="3243040">{</span>&nbsp;<span class="comment" id="3243042">//&nbsp;see&nbsp;RFC&nbsp;5966</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3243061">continue</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3243072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3243076">return</span>&nbsp;<span class="ident" id="3243083">in</span><span class="op" id="3243085">,</span>&nbsp;<span class="ident" id="3243087">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3243092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3243095">return</span>&nbsp;<span class="ident" id="3243102">nil</span><span class="op" id="3243105">,</span>&nbsp;<span class="ident" id="3243107">errors</span><span class="op" id="3243113">.</span><span class="ident" id="3243114">New</span><span class="op" id="3243117">(</span><span class="string" id="3243118">&#34;no&nbsp;answer&nbsp;from&nbsp;DNS&nbsp;server&#34;</span><span class="op" id="3243145">)</span><br>
<span class="lineno"></span><span class="op" id="3243147">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="comment" id="3243150">//&nbsp;Do&nbsp;a&nbsp;lookup&nbsp;for&nbsp;a&nbsp;single&nbsp;name,&nbsp;which&nbsp;must&nbsp;be&nbsp;rooted</span><br>
<span class="lineno"></span><span class="comment" id="3243205">//&nbsp;(otherwise&nbsp;answer&nbsp;will&nbsp;not&nbsp;find&nbsp;the&nbsp;answers).</span><br>
<span class="lineno"></span><span class="keyword" id="3243254">func</span>&nbsp;<span class="ident" id="3243259">tryOneName</span><span class="op" id="3243269">(</span><span class="ident" id="3243270">cfg</span>&nbsp;<span class="op" id="3243274">*</span><span class="ident" id="3243275">dnsConfig</span><span class="op" id="3243284">,</span>&nbsp;<span class="ident" id="3243286">name</span>&nbsp;<span class="builtintype" id="3243291">string</span><span class="op" id="3243297">,</span>&nbsp;<span class="ident" id="3243299">qtype</span>&nbsp;<span class="builtintype" id="3243305">uint16</span><span class="op" id="3243311">)</span>&nbsp;<span class="op" id="3243313">(</span><span class="builtintype" id="3243314">string</span><span class="op" id="3243320">,</span>&nbsp;<span class="op" id="3243322">[</span><span class="op" id="3243323">]</span><span class="ident" id="3243324">dnsRR</span><span class="op" id="3243329">,</span>&nbsp;<span class="builtintype" id="3243331">error</span><span class="op" id="3243336">)</span>&nbsp;<span class="op" id="3243338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3243341">if</span>&nbsp;<span class="builtinfunc" id="3243344">len</span><span class="op" id="3243347">(</span><span class="ident" id="3243348">cfg</span><span class="op" id="3243351">.</span><span class="ident" id="3243352">servers</span><span class="op" id="3243359">)</span>&nbsp;<span class="op" id="3243361">==</span>&nbsp;<span class="num" id="3243364">0</span>&nbsp;<span class="op" id="3243366">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3243370">return</span>&nbsp;<span class="string" id="3243377">&#34;&#34;</span><span class="op" id="3243379">,</span>&nbsp;<span class="ident" id="3243381">nil</span><span class="op" id="3243384">,</span>&nbsp;<span class="op" id="3243386">&amp;</span><span class="ident" id="3243387">DNSError</span><span class="op" id="3243395">{</span><span class="ident" id="3243396">Err</span><span class="op" id="3243399">:</span>&nbsp;<span class="string" id="3243401">&#34;no&nbsp;DNS&nbsp;servers&#34;</span><span class="op" id="3243417">,</span>&nbsp;<span class="ident" id="3243419">Name</span><span class="op" id="3243423">:</span>&nbsp;<span class="ident" id="3243425">name</span><span class="op" id="3243429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3243432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3243435">if</span>&nbsp;<span class="builtinfunc" id="3243438">len</span><span class="op" id="3243441">(</span><span class="ident" id="3243442">name</span><span class="op" id="3243446">)</span>&nbsp;<span class="op" id="3243448">&gt;=</span>&nbsp;<span class="num" id="3243451">256</span>&nbsp;<span class="op" id="3243455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3243459">return</span>&nbsp;<span class="string" id="3243466">&#34;&#34;</span><span class="op" id="3243468">,</span>&nbsp;<span class="ident" id="3243470">nil</span><span class="op" id="3243473">,</span>&nbsp;<span class="op" id="3243475">&amp;</span><span class="ident" id="3243476">DNSError</span><span class="op" id="3243484">{</span><span class="ident" id="3243485">Err</span><span class="op" id="3243488">:</span>&nbsp;<span class="string" id="3243490">&#34;DNS&nbsp;name&nbsp;too&nbsp;long&#34;</span><span class="op" id="3243509">,</span>&nbsp;<span class="ident" id="3243511">Name</span><span class="op" id="3243515">:</span>&nbsp;<span class="ident" id="3243517">name</span><span class="op" id="3243521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3243524">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3243527">timeout</span>&nbsp;<span class="op" id="3243535">:=</span>&nbsp;<span class="ident" id="3243538">time</span><span class="op" id="3243542">.</span><span class="ident" id="3243543">Duration</span><span class="op" id="3243551">(</span><span class="ident" id="3243552">cfg</span><span class="op" id="3243555">.</span><span class="ident" id="3243556">timeout</span><span class="op" id="3243563">)</span>&nbsp;<span class="op" id="3243565">*</span>&nbsp;<span class="ident" id="3243567">time</span><span class="op" id="3243571">.</span><span class="ident" id="3243572">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3243580">var</span>&nbsp;<span class="ident" id="3243584">lastErr</span>&nbsp;<span class="builtintype" id="3243592">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3243599">for</span>&nbsp;<span class="ident" id="3243603">i</span>&nbsp;<span class="op" id="3243605">:=</span>&nbsp;<span class="num" id="3243608">0</span><span class="op" id="3243609">;</span>&nbsp;<span class="ident" id="3243611">i</span>&nbsp;<span class="op" id="3243613">&lt;</span>&nbsp;<span class="ident" id="3243615">cfg</span><span class="op" id="3243618">.</span><span class="ident" id="3243619">attempts</span><span class="op" id="3243627">;</span>&nbsp;<span class="ident" id="3243629">i</span><span class="op" id="3243630">++</span>&nbsp;<span class="op" id="3243633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3243637">for</span>&nbsp;<span class="ident" id="3243641">_</span><span class="op" id="3243642">,</span>&nbsp;<span class="ident" id="3243644">server</span>&nbsp;<span class="op" id="3243651">:=</span>&nbsp;<span class="keyword" id="3243654">range</span>&nbsp;<span class="ident" id="3243660">cfg</span><span class="op" id="3243663">.</span><span class="ident" id="3243664">servers</span>&nbsp;<span class="op" id="3243672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3243677">server</span>&nbsp;<span class="op" id="3243684">=</span>&nbsp;<span class="ident" id="3243686">JoinHostPort</span><span class="op" id="3243698">(</span><span class="ident" id="3243699">server</span><span class="op" id="3243705">,</span>&nbsp;<span class="string" id="3243707">&#34;53&#34;</span><span class="op" id="3243711">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3243716">msg</span><span class="op" id="3243719">,</span>&nbsp;<span class="ident" id="3243721">err</span>&nbsp;<span class="op" id="3243725">:=</span>&nbsp;<span class="ident" id="3243728">exchange</span><span class="op" id="3243736">(</span><span class="ident" id="3243737">server</span><span class="op" id="3243743">,</span>&nbsp;<span class="ident" id="3243745">name</span><span class="op" id="3243749">,</span>&nbsp;<span class="ident" id="3243751">qtype</span><span class="op" id="3243756">,</span>&nbsp;<span class="ident" id="3243758">timeout</span><span class="op" id="3243765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3243770">if</span>&nbsp;<span class="ident" id="3243773">err</span>&nbsp;<span class="op" id="3243777">!=</span>&nbsp;<span class="ident" id="3243780">nil</span>&nbsp;<span class="op" id="3243784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3243790">lastErr</span>&nbsp;<span class="op" id="3243798">=</span>&nbsp;<span class="op" id="3243800">&amp;</span><span class="ident" id="3243801">DNSError</span><span class="op" id="3243809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3243816">Err</span><span class="op" id="3243819">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3243824">err</span><span class="op" id="3243827">.</span><span class="ident" id="3243828">Error</span><span class="op" id="3243833">(</span><span class="op" id="3243834">)</span><span class="op" id="3243835">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3243842">Name</span><span class="op" id="3243846">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3243850">name</span><span class="op" id="3243854">,</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3243861">Server</span><span class="op" id="3243867">:</span>&nbsp;<span class="ident" id="3243869">server</span><span class="op" id="3243875">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3243881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3243887">if</span>&nbsp;<span class="ident" id="3243890">nerr</span><span class="op" id="3243894">,</span>&nbsp;<span class="ident" id="3243896">ok</span>&nbsp;<span class="op" id="3243899">:=</span>&nbsp;<span class="ident" id="3243902">err</span><span class="op" id="3243905">.</span><span class="op" id="3243906">(</span><span class="ident" id="3243907">Error</span><span class="op" id="3243912">)</span><span class="op" id="3243913">;</span>&nbsp;<span class="ident" id="3243915">ok</span>&nbsp;<span class="op" id="3243918">&amp;&amp;</span>&nbsp;<span class="ident" id="3243921">nerr</span><span class="op" id="3243925">.</span><span class="ident" id="3243926">Timeout</span><span class="op" id="3243933">(</span><span class="op" id="3243934">)</span>&nbsp;<span class="op" id="3243936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3243943">lastErr</span><span class="op" id="3243950">.</span><span class="op" id="3243951">(</span><span class="op" id="3243952">*</span><span class="ident" id="3243953">DNSError</span><span class="op" id="3243961">)</span><span class="op" id="3243962">.</span><span class="ident" id="3243963">IsTimeout</span>&nbsp;<span class="op" id="3243973">=</span>&nbsp;<span class="builtintype" id="3243975">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3243984">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3243990">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3244002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3244007">cname</span><span class="op" id="3244012">,</span>&nbsp;<span class="ident" id="3244014">addrs</span><span class="op" id="3244019">,</span>&nbsp;<span class="ident" id="3244021">err</span>&nbsp;<span class="op" id="3244025">:=</span>&nbsp;<span class="ident" id="3244028">answer</span><span class="op" id="3244034">(</span><span class="ident" id="3244035">name</span><span class="op" id="3244039">,</span>&nbsp;<span class="ident" id="3244041">server</span><span class="op" id="3244047">,</span>&nbsp;<span class="ident" id="3244049">msg</span><span class="op" id="3244052">,</span>&nbsp;<span class="ident" id="3244054">qtype</span><span class="op" id="3244059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3244064">if</span>&nbsp;<span class="ident" id="3244067">err</span>&nbsp;<span class="op" id="3244071">==</span>&nbsp;<span class="ident" id="3244074">nil</span>&nbsp;<span class="op" id="3244078">||</span>&nbsp;<span class="ident" id="3244081">err</span><span class="op" id="3244084">.</span><span class="op" id="3244085">(</span><span class="op" id="3244086">*</span><span class="ident" id="3244087">DNSError</span><span class="op" id="3244095">)</span><span class="op" id="3244096">.</span><span class="ident" id="3244097">Err</span>&nbsp;<span class="op" id="3244101">==</span>&nbsp;<span class="ident" id="3244104">noSuchHost</span>&nbsp;<span class="op" id="3244115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3244121">return</span>&nbsp;<span class="ident" id="3244128">cname</span><span class="op" id="3244133">,</span>&nbsp;<span class="ident" id="3244135">addrs</span><span class="op" id="3244140">,</span>&nbsp;<span class="ident" id="3244142">err</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3244149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3244154">lastErr</span>&nbsp;<span class="op" id="3244162">=</span>&nbsp;<span class="ident" id="3244164">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3244170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3244173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3244176">return</span>&nbsp;<span class="string" id="3244183">&#34;&#34;</span><span class="op" id="3244185">,</span>&nbsp;<span class="ident" id="3244187">nil</span><span class="op" id="3244190">,</span>&nbsp;<span class="ident" id="3244192">lastErr</span><br>
<span class="lineno">195</span><span class="op" id="3244200">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3244203">func</span>&nbsp;<span class="ident" id="3244208">convertRR_A</span><span class="op" id="3244219">(</span><span class="ident" id="3244220">records</span>&nbsp;<span class="op" id="3244228">[</span><span class="op" id="3244229">]</span><span class="ident" id="3244230">dnsRR</span><span class="op" id="3244235">)</span>&nbsp;<span class="op" id="3244237">[</span><span class="op" id="3244238">]</span><span class="ident" id="3244239">IP</span>&nbsp;<span class="op" id="3244242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3244245">addrs</span>&nbsp;<span class="op" id="3244251">:=</span>&nbsp;<span class="builtinfunc" id="3244254">make</span><span class="op" id="3244258">(</span><span class="op" id="3244259">[</span><span class="op" id="3244260">]</span><span class="ident" id="3244261">IP</span><span class="op" id="3244263">,</span>&nbsp;<span class="builtinfunc" id="3244265">len</span><span class="op" id="3244268">(</span><span class="ident" id="3244269">records</span><span class="op" id="3244276">)</span><span class="op" id="3244277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3244280">for</span>&nbsp;<span class="ident" id="3244284">i</span><span class="op" id="3244285">,</span>&nbsp;<span class="ident" id="3244287">rr</span>&nbsp;<span class="op" id="3244290">:=</span>&nbsp;<span class="keyword" id="3244293">range</span>&nbsp;<span class="ident" id="3244299">records</span>&nbsp;<span class="op" id="3244307">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3244311">a</span>&nbsp;<span class="op" id="3244313">:=</span>&nbsp;<span class="ident" id="3244316">rr</span><span class="op" id="3244318">.</span><span class="op" id="3244319">(</span><span class="op" id="3244320">*</span><span class="ident" id="3244321">dnsRR_A</span><span class="op" id="3244328">)</span><span class="op" id="3244329">.</span><span class="ident" id="3244330">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3244334">addrs</span><span class="op" id="3244339">[</span><span class="ident" id="3244340">i</span><span class="op" id="3244341">]</span>&nbsp;<span class="op" id="3244343">=</span>&nbsp;<span class="ident" id="3244345">IPv4</span><span class="op" id="3244349">(</span><span class="builtintype" id="3244350">byte</span><span class="op" id="3244354">(</span><span class="ident" id="3244355">a</span><span class="op" id="3244356">&gt;&gt;</span><span class="num" id="3244358">24</span><span class="op" id="3244360">)</span><span class="op" id="3244361">,</span>&nbsp;<span class="builtintype" id="3244363">byte</span><span class="op" id="3244367">(</span><span class="ident" id="3244368">a</span><span class="op" id="3244369">&gt;&gt;</span><span class="num" id="3244371">16</span><span class="op" id="3244373">)</span><span class="op" id="3244374">,</span>&nbsp;<span class="builtintype" id="3244376">byte</span><span class="op" id="3244380">(</span><span class="ident" id="3244381">a</span><span class="op" id="3244382">&gt;&gt;</span><span class="num" id="3244384">8</span><span class="op" id="3244385">)</span><span class="op" id="3244386">,</span>&nbsp;<span class="builtintype" id="3244388">byte</span><span class="op" id="3244392">(</span><span class="ident" id="3244393">a</span><span class="op" id="3244394">)</span><span class="op" id="3244395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3244398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3244401">return</span>&nbsp;<span class="ident" id="3244408">addrs</span><br>
<span class="lineno"></span><span class="op" id="3244414">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="3244417">func</span>&nbsp;<span class="ident" id="3244422">convertRR_AAAA</span><span class="op" id="3244436">(</span><span class="ident" id="3244437">records</span>&nbsp;<span class="op" id="3244445">[</span><span class="op" id="3244446">]</span><span class="ident" id="3244447">dnsRR</span><span class="op" id="3244452">)</span>&nbsp;<span class="op" id="3244454">[</span><span class="op" id="3244455">]</span><span class="ident" id="3244456">IP</span>&nbsp;<span class="op" id="3244459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3244462">addrs</span>&nbsp;<span class="op" id="3244468">:=</span>&nbsp;<span class="builtinfunc" id="3244471">make</span><span class="op" id="3244475">(</span><span class="op" id="3244476">[</span><span class="op" id="3244477">]</span><span class="ident" id="3244478">IP</span><span class="op" id="3244480">,</span>&nbsp;<span class="builtinfunc" id="3244482">len</span><span class="op" id="3244485">(</span><span class="ident" id="3244486">records</span><span class="op" id="3244493">)</span><span class="op" id="3244494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3244497">for</span>&nbsp;<span class="ident" id="3244501">i</span><span class="op" id="3244502">,</span>&nbsp;<span class="ident" id="3244504">rr</span>&nbsp;<span class="op" id="3244507">:=</span>&nbsp;<span class="keyword" id="3244510">range</span>&nbsp;<span class="ident" id="3244516">records</span>&nbsp;<span class="op" id="3244524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3244528">a</span>&nbsp;<span class="op" id="3244530">:=</span>&nbsp;<span class="builtinfunc" id="3244533">make</span><span class="op" id="3244537">(</span><span class="ident" id="3244538">IP</span><span class="op" id="3244540">,</span>&nbsp;<span class="ident" id="3244542">IPv6len</span><span class="op" id="3244549">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3244553">copy</span><span class="op" id="3244557">(</span><span class="ident" id="3244558">a</span><span class="op" id="3244559">,</span>&nbsp;<span class="ident" id="3244561">rr</span><span class="op" id="3244563">.</span><span class="op" id="3244564">(</span><span class="op" id="3244565">*</span><span class="ident" id="3244566">dnsRR_AAAA</span><span class="op" id="3244576">)</span><span class="op" id="3244577">.</span><span class="ident" id="3244578">AAAA</span><span class="op" id="3244582">[</span><span class="op" id="3244583">:</span><span class="op" id="3244584">]</span><span class="op" id="3244585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3244589">addrs</span><span class="op" id="3244594">[</span><span class="ident" id="3244595">i</span><span class="op" id="3244596">]</span>&nbsp;<span class="op" id="3244598">=</span>&nbsp;<span class="ident" id="3244600">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3244603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3244606">return</span>&nbsp;<span class="ident" id="3244613">addrs</span><br>
<span class="lineno"></span><span class="op" id="3244619">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="3244622">var</span>&nbsp;<span class="ident" id="3244626">cfg</span>&nbsp;<span class="keyword" id="3244630">struct</span>&nbsp;<span class="op" id="3244637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3244640">ch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3244650">chan</span>&nbsp;<span class="keyword" id="3244655">struct</span><span class="op" id="3244661">{</span><span class="op" id="3244662">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3244665">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3244675">sync</span><span class="op" id="3244679">.</span><span class="ident" id="3244680">RWMutex</span>&nbsp;<span class="comment" id="3244688">//&nbsp;protects&nbsp;dnsConfig&nbsp;and&nbsp;dnserr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3244722">dnsConfig</span>&nbsp;<span class="op" id="3244732">*</span><span class="ident" id="3244733">dnsConfig</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3244744">dnserr</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3244754">error</span><br>
<span class="lineno"></span><span class="op" id="3244760">}</span><br>
<span class="lineno"></span><span class="keyword" id="3244762">var</span>&nbsp;<span class="ident" id="3244766">onceLoadConfig</span>&nbsp;<span class="ident" id="3244781">sync</span><span class="op" id="3244785">.</span><span class="ident" id="3244786">Once</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3244792">//&nbsp;Assume&nbsp;dns&nbsp;config&nbsp;file&nbsp;is&nbsp;/etc/resolv.conf&nbsp;here</span><br>
<span class="lineno">225</span><span class="keyword" id="3244843">func</span>&nbsp;<span class="ident" id="3244848">loadDefaultConfig</span><span class="op" id="3244865">(</span><span class="op" id="3244866">)</span>&nbsp;<span class="op" id="3244868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3244871">loadConfig</span><span class="op" id="3244881">(</span><span class="string" id="3244882">&#34;/etc/resolv.conf&#34;</span><span class="op" id="3244900">,</span>&nbsp;<span class="num" id="3244902">5</span><span class="op" id="3244903">*</span><span class="ident" id="3244904">time</span><span class="op" id="3244908">.</span><span class="ident" id="3244909">Second</span><span class="op" id="3244915">,</span>&nbsp;<span class="ident" id="3244917">nil</span><span class="op" id="3244920">)</span><br>
<span class="lineno"></span><span class="op" id="3244922">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3244925">func</span>&nbsp;<span class="ident" id="3244930">loadConfig</span><span class="op" id="3244940">(</span><span class="ident" id="3244941">resolvConfPath</span>&nbsp;<span class="builtintype" id="3244956">string</span><span class="op" id="3244962">,</span>&nbsp;<span class="ident" id="3244964">reloadTime</span>&nbsp;<span class="ident" id="3244975">time</span><span class="op" id="3244979">.</span><span class="ident" id="3244980">Duration</span><span class="op" id="3244988">,</span>&nbsp;<span class="ident" id="3244990">quit</span>&nbsp;<span class="op" id="3244995">&lt;-</span><span class="keyword" id="3244997">chan</span>&nbsp;<span class="keyword" id="3245002">chan</span>&nbsp;<span class="keyword" id="3245007">struct</span><span class="op" id="3245013">{</span><span class="op" id="3245014">}</span><span class="op" id="3245015">)</span>&nbsp;<span class="op" id="3245017">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3245020">var</span>&nbsp;<span class="ident" id="3245024">mtime</span>&nbsp;<span class="ident" id="3245030">time</span><span class="op" id="3245034">.</span><span class="ident" id="3245035">Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3245041">cfg</span><span class="op" id="3245044">.</span><span class="ident" id="3245045">ch</span>&nbsp;<span class="op" id="3245048">=</span>&nbsp;<span class="builtinfunc" id="3245050">make</span><span class="op" id="3245054">(</span><span class="keyword" id="3245055">chan</span>&nbsp;<span class="keyword" id="3245060">struct</span><span class="op" id="3245066">{</span><span class="op" id="3245067">}</span><span class="op" id="3245068">,</span>&nbsp;<span class="num" id="3245070">1</span><span class="op" id="3245071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3245074">if</span>&nbsp;<span class="ident" id="3245077">fi</span><span class="op" id="3245079">,</span>&nbsp;<span class="ident" id="3245081">err</span>&nbsp;<span class="op" id="3245085">:=</span>&nbsp;<span class="ident" id="3245088">os</span><span class="op" id="3245090">.</span><span class="ident" id="3245091">Stat</span><span class="op" id="3245095">(</span><span class="ident" id="3245096">resolvConfPath</span><span class="op" id="3245110">)</span><span class="op" id="3245111">;</span>&nbsp;<span class="ident" id="3245113">err</span>&nbsp;<span class="op" id="3245117">!=</span>&nbsp;<span class="ident" id="3245120">nil</span>&nbsp;<span class="op" id="3245124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3245128">cfg</span><span class="op" id="3245131">.</span><span class="ident" id="3245132">dnserr</span>&nbsp;<span class="op" id="3245139">=</span>&nbsp;<span class="ident" id="3245141">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3245146">}</span>&nbsp;<span class="keyword" id="3245148">else</span>&nbsp;<span class="op" id="3245153">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3245157">mtime</span>&nbsp;<span class="op" id="3245163">=</span>&nbsp;<span class="ident" id="3245165">fi</span><span class="op" id="3245167">.</span><span class="ident" id="3245168">ModTime</span><span class="op" id="3245175">(</span><span class="op" id="3245176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3245180">cfg</span><span class="op" id="3245183">.</span><span class="ident" id="3245184">dnsConfig</span><span class="op" id="3245193">,</span>&nbsp;<span class="ident" id="3245195">cfg</span><span class="op" id="3245198">.</span><span class="ident" id="3245199">dnserr</span>&nbsp;<span class="op" id="3245206">=</span>&nbsp;<span class="ident" id="3245208">dnsReadConfig</span><span class="op" id="3245221">(</span><span class="ident" id="3245222">resolvConfPath</span><span class="op" id="3245236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3245239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3245242">go</span>&nbsp;<span class="keyword" id="3245245">func</span><span class="op" id="3245249">(</span><span class="op" id="3245250">)</span>&nbsp;<span class="op" id="3245252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3245256">for</span>&nbsp;<span class="op" id="3245260">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3245265">time</span><span class="op" id="3245269">.</span><span class="ident" id="3245270">Sleep</span><span class="op" id="3245275">(</span><span class="ident" id="3245276">reloadTime</span><span class="op" id="3245286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3245291">select</span>&nbsp;<span class="op" id="3245298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3245303">case</span>&nbsp;<span class="ident" id="3245308">qresp</span>&nbsp;<span class="op" id="3245314">:=</span>&nbsp;<span class="op" id="3245317">&lt;-</span><span class="ident" id="3245319">quit</span><span class="op" id="3245323">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3245329">qresp</span>&nbsp;<span class="op" id="3245335">&lt;-</span>&nbsp;<span class="keyword" id="3245338">struct</span><span class="op" id="3245344">{</span><span class="op" id="3245345">}</span><span class="op" id="3245346">{</span><span class="op" id="3245347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3245353">return</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3245363">case</span>&nbsp;<span class="op" id="3245368">&lt;-</span><span class="ident" id="3245370">cfg</span><span class="op" id="3245373">.</span><span class="ident" id="3245374">ch</span><span class="op" id="3245376">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3245381">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3245387">//&nbsp;In&nbsp;case&nbsp;of&nbsp;error,&nbsp;we&nbsp;keep&nbsp;the&nbsp;previous&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3245439">fi</span><span class="op" id="3245441">,</span>&nbsp;<span class="ident" id="3245443">err</span>&nbsp;<span class="op" id="3245447">:=</span>&nbsp;<span class="ident" id="3245450">os</span><span class="op" id="3245452">.</span><span class="ident" id="3245453">Stat</span><span class="op" id="3245457">(</span><span class="ident" id="3245458">resolvConfPath</span><span class="op" id="3245472">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3245477">if</span>&nbsp;<span class="ident" id="3245480">err</span>&nbsp;<span class="op" id="3245484">!=</span>&nbsp;<span class="ident" id="3245487">nil</span>&nbsp;<span class="op" id="3245491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3245497">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3245509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3245514">//&nbsp;If&nbsp;the&nbsp;resolv.conf&nbsp;mtime&nbsp;didn&#39;t&nbsp;change,&nbsp;do&nbsp;not&nbsp;reload</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3245574">m</span>&nbsp;<span class="op" id="3245576">:=</span>&nbsp;<span class="ident" id="3245579">fi</span><span class="op" id="3245581">.</span><span class="ident" id="3245582">ModTime</span><span class="op" id="3245589">(</span><span class="op" id="3245590">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3245595">if</span>&nbsp;<span class="ident" id="3245598">m</span><span class="op" id="3245599">.</span><span class="ident" id="3245600">Equal</span><span class="op" id="3245605">(</span><span class="ident" id="3245606">mtime</span><span class="op" id="3245611">)</span>&nbsp;<span class="op" id="3245613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3245619">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3245631">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3245636">mtime</span>&nbsp;<span class="op" id="3245642">=</span>&nbsp;<span class="ident" id="3245644">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3245649">//&nbsp;In&nbsp;case&nbsp;of&nbsp;error,&nbsp;we&nbsp;keep&nbsp;the&nbsp;previous&nbsp;config</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3245701">ncfg</span><span class="op" id="3245705">,</span>&nbsp;<span class="ident" id="3245707">err</span>&nbsp;<span class="op" id="3245711">:=</span>&nbsp;<span class="ident" id="3245714">dnsReadConfig</span><span class="op" id="3245727">(</span><span class="ident" id="3245728">resolvConfPath</span><span class="op" id="3245742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3245747">if</span>&nbsp;<span class="ident" id="3245750">err</span>&nbsp;<span class="op" id="3245754">!=</span>&nbsp;<span class="ident" id="3245757">nil</span>&nbsp;<span class="op" id="3245761">||</span>&nbsp;<span class="builtinfunc" id="3245764">len</span><span class="op" id="3245767">(</span><span class="ident" id="3245768">ncfg</span><span class="op" id="3245772">.</span><span class="ident" id="3245773">servers</span><span class="op" id="3245780">)</span>&nbsp;<span class="op" id="3245782">==</span>&nbsp;<span class="num" id="3245785">0</span>&nbsp;<span class="op" id="3245787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3245793">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3245805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3245810">cfg</span><span class="op" id="3245813">.</span><span class="ident" id="3245814">mu</span><span class="op" id="3245816">.</span><span class="ident" id="3245817">Lock</span><span class="op" id="3245821">(</span><span class="op" id="3245822">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3245827">cfg</span><span class="op" id="3245830">.</span><span class="ident" id="3245831">dnsConfig</span>&nbsp;<span class="op" id="3245841">=</span>&nbsp;<span class="ident" id="3245843">ncfg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3245851">cfg</span><span class="op" id="3245854">.</span><span class="ident" id="3245855">dnserr</span>&nbsp;<span class="op" id="3245862">=</span>&nbsp;<span class="ident" id="3245864">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3245871">cfg</span><span class="op" id="3245874">.</span><span class="ident" id="3245875">mu</span><span class="op" id="3245877">.</span><span class="ident" id="3245878">Unlock</span><span class="op" id="3245884">(</span><span class="op" id="3245885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3245889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3245892">}</span><span class="op" id="3245893">(</span><span class="op" id="3245894">)</span><br>
<span class="lineno">270</span><span class="op" id="3245896">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3245899">func</span>&nbsp;<span class="ident" id="3245904">lookup</span><span class="op" id="3245910">(</span><span class="ident" id="3245911">name</span>&nbsp;<span class="builtintype" id="3245916">string</span><span class="op" id="3245922">,</span>&nbsp;<span class="ident" id="3245924">qtype</span>&nbsp;<span class="builtintype" id="3245930">uint16</span><span class="op" id="3245936">)</span>&nbsp;<span class="op" id="3245938">(</span><span class="ident" id="3245939">cname</span>&nbsp;<span class="builtintype" id="3245945">string</span><span class="op" id="3245951">,</span>&nbsp;<span class="ident" id="3245953">addrs</span>&nbsp;<span class="op" id="3245959">[</span><span class="op" id="3245960">]</span><span class="ident" id="3245961">dnsRR</span><span class="op" id="3245966">,</span>&nbsp;<span class="ident" id="3245968">err</span>&nbsp;<span class="builtintype" id="3245972">error</span><span class="op" id="3245977">)</span>&nbsp;<span class="op" id="3245979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3245982">if</span>&nbsp;<span class="op" id="3245985">!</span><span class="ident" id="3245986">isDomainName</span><span class="op" id="3245998">(</span><span class="ident" id="3245999">name</span><span class="op" id="3246003">)</span>&nbsp;<span class="op" id="3246005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3246009">return</span>&nbsp;<span class="ident" id="3246016">name</span><span class="op" id="3246020">,</span>&nbsp;<span class="ident" id="3246022">nil</span><span class="op" id="3246025">,</span>&nbsp;<span class="op" id="3246027">&amp;</span><span class="ident" id="3246028">DNSError</span><span class="op" id="3246036">{</span><span class="ident" id="3246037">Err</span><span class="op" id="3246040">:</span>&nbsp;<span class="string" id="3246042">&#34;invalid&nbsp;domain&nbsp;name&#34;</span><span class="op" id="3246063">,</span>&nbsp;<span class="ident" id="3246065">Name</span><span class="op" id="3246069">:</span>&nbsp;<span class="ident" id="3246071">name</span><span class="op" id="3246075">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3246078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3246081">onceLoadConfig</span><span class="op" id="3246095">.</span><span class="ident" id="3246096">Do</span><span class="op" id="3246098">(</span><span class="ident" id="3246099">loadDefaultConfig</span><span class="op" id="3246116">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3246120">select</span>&nbsp;<span class="op" id="3246127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3246130">case</span>&nbsp;<span class="ident" id="3246135">cfg</span><span class="op" id="3246138">.</span><span class="ident" id="3246139">ch</span>&nbsp;<span class="op" id="3246142">&lt;-</span>&nbsp;<span class="keyword" id="3246145">struct</span><span class="op" id="3246151">{</span><span class="op" id="3246152">}</span><span class="op" id="3246153">{</span><span class="op" id="3246154">}</span><span class="op" id="3246155">:</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3246158">default</span><span class="op" id="3246165">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3246168">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3246172">cfg</span><span class="op" id="3246175">.</span><span class="ident" id="3246176">mu</span><span class="op" id="3246178">.</span><span class="ident" id="3246179">RLock</span><span class="op" id="3246184">(</span><span class="op" id="3246185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3246188">defer</span>&nbsp;<span class="ident" id="3246194">cfg</span><span class="op" id="3246197">.</span><span class="ident" id="3246198">mu</span><span class="op" id="3246200">.</span><span class="ident" id="3246201">RUnlock</span><span class="op" id="3246208">(</span><span class="op" id="3246209">)</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3246213">if</span>&nbsp;<span class="ident" id="3246216">cfg</span><span class="op" id="3246219">.</span><span class="ident" id="3246220">dnserr</span>&nbsp;<span class="op" id="3246227">!=</span>&nbsp;<span class="ident" id="3246230">nil</span>&nbsp;<span class="op" id="3246234">||</span>&nbsp;<span class="ident" id="3246237">cfg</span><span class="op" id="3246240">.</span><span class="ident" id="3246241">dnsConfig</span>&nbsp;<span class="op" id="3246251">==</span>&nbsp;<span class="ident" id="3246254">nil</span>&nbsp;<span class="op" id="3246258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3246262">err</span>&nbsp;<span class="op" id="3246266">=</span>&nbsp;<span class="ident" id="3246268">cfg</span><span class="op" id="3246271">.</span><span class="ident" id="3246272">dnserr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3246281">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3246289">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3246292">//&nbsp;If&nbsp;name&nbsp;is&nbsp;rooted&nbsp;(trailing&nbsp;dot)&nbsp;or&nbsp;has&nbsp;enough&nbsp;dots,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3246349">//&nbsp;try&nbsp;it&nbsp;by&nbsp;itself&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3246377">rooted</span>&nbsp;<span class="op" id="3246384">:=</span>&nbsp;<span class="builtinfunc" id="3246387">len</span><span class="op" id="3246390">(</span><span class="ident" id="3246391">name</span><span class="op" id="3246395">)</span>&nbsp;<span class="op" id="3246397">&gt;</span>&nbsp;<span class="num" id="3246399">0</span>&nbsp;<span class="op" id="3246401">&amp;&amp;</span>&nbsp;<span class="ident" id="3246404">name</span><span class="op" id="3246408">[</span><span class="builtinfunc" id="3246409">len</span><span class="op" id="3246412">(</span><span class="ident" id="3246413">name</span><span class="op" id="3246417">)</span><span class="op" id="3246418">-</span><span class="num" id="3246419">1</span><span class="op" id="3246420">]</span>&nbsp;<span class="op" id="3246422">==</span>&nbsp;<span class="string" id="3246425">&#39;.&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3246430">if</span>&nbsp;<span class="ident" id="3246433">rooted</span>&nbsp;<span class="op" id="3246440">||</span>&nbsp;<span class="ident" id="3246443">count</span><span class="op" id="3246448">(</span><span class="ident" id="3246449">name</span><span class="op" id="3246453">,</span>&nbsp;<span class="string" id="3246455">&#39;.&#39;</span><span class="op" id="3246458">)</span>&nbsp;<span class="op" id="3246460">&gt;=</span>&nbsp;<span class="ident" id="3246463">cfg</span><span class="op" id="3246466">.</span><span class="ident" id="3246467">dnsConfig</span><span class="op" id="3246476">.</span><span class="ident" id="3246477">ndots</span>&nbsp;<span class="op" id="3246483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3246487">rname</span>&nbsp;<span class="op" id="3246493">:=</span>&nbsp;<span class="ident" id="3246496">name</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3246503">if</span>&nbsp;<span class="op" id="3246506">!</span><span class="ident" id="3246507">rooted</span>&nbsp;<span class="op" id="3246514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3246519">rname</span>&nbsp;<span class="op" id="3246525">+=</span>&nbsp;<span class="string" id="3246528">&#34;.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3246534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3246538">//&nbsp;Can&nbsp;try&nbsp;as&nbsp;ordinary&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3246569">cname</span><span class="op" id="3246574">,</span>&nbsp;<span class="ident" id="3246576">addrs</span><span class="op" id="3246581">,</span>&nbsp;<span class="ident" id="3246583">err</span>&nbsp;<span class="op" id="3246587">=</span>&nbsp;<span class="ident" id="3246589">tryOneName</span><span class="op" id="3246599">(</span><span class="ident" id="3246600">cfg</span><span class="op" id="3246603">.</span><span class="ident" id="3246604">dnsConfig</span><span class="op" id="3246613">,</span>&nbsp;<span class="ident" id="3246615">rname</span><span class="op" id="3246620">,</span>&nbsp;<span class="ident" id="3246622">qtype</span><span class="op" id="3246627">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3246631">if</span>&nbsp;<span class="ident" id="3246634">rooted</span>&nbsp;<span class="op" id="3246641">||</span>&nbsp;<span class="ident" id="3246644">err</span>&nbsp;<span class="op" id="3246648">==</span>&nbsp;<span class="ident" id="3246651">nil</span>&nbsp;<span class="op" id="3246655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3246660">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3246669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3246672">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3246676">//&nbsp;Otherwise,&nbsp;try&nbsp;suffixes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3246705">for</span>&nbsp;<span class="ident" id="3246709">i</span>&nbsp;<span class="op" id="3246711">:=</span>&nbsp;<span class="num" id="3246714">0</span><span class="op" id="3246715">;</span>&nbsp;<span class="ident" id="3246717">i</span>&nbsp;<span class="op" id="3246719">&lt;</span>&nbsp;<span class="builtinfunc" id="3246721">len</span><span class="op" id="3246724">(</span><span class="ident" id="3246725">cfg</span><span class="op" id="3246728">.</span><span class="ident" id="3246729">dnsConfig</span><span class="op" id="3246738">.</span><span class="ident" id="3246739">search</span><span class="op" id="3246745">)</span><span class="op" id="3246746">;</span>&nbsp;<span class="ident" id="3246748">i</span><span class="op" id="3246749">++</span>&nbsp;<span class="op" id="3246752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3246756">rname</span>&nbsp;<span class="op" id="3246762">:=</span>&nbsp;<span class="ident" id="3246765">name</span>&nbsp;<span class="op" id="3246770">+</span>&nbsp;<span class="string" id="3246772">&#34;.&#34;</span>&nbsp;<span class="op" id="3246776">+</span>&nbsp;<span class="ident" id="3246778">cfg</span><span class="op" id="3246781">.</span><span class="ident" id="3246782">dnsConfig</span><span class="op" id="3246791">.</span><span class="ident" id="3246792">search</span><span class="op" id="3246798">[</span><span class="ident" id="3246799">i</span><span class="op" id="3246800">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3246804">if</span>&nbsp;<span class="ident" id="3246807">rname</span><span class="op" id="3246812">[</span><span class="builtinfunc" id="3246813">len</span><span class="op" id="3246816">(</span><span class="ident" id="3246817">rname</span><span class="op" id="3246822">)</span><span class="op" id="3246823">-</span><span class="num" id="3246824">1</span><span class="op" id="3246825">]</span>&nbsp;<span class="op" id="3246827">!=</span>&nbsp;<span class="string" id="3246830">&#39;.&#39;</span>&nbsp;<span class="op" id="3246834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3246839">rname</span>&nbsp;<span class="op" id="3246845">+=</span>&nbsp;<span class="string" id="3246848">&#34;.&#34;</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3246854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3246858">cname</span><span class="op" id="3246863">,</span>&nbsp;<span class="ident" id="3246865">addrs</span><span class="op" id="3246870">,</span>&nbsp;<span class="ident" id="3246872">err</span>&nbsp;<span class="op" id="3246876">=</span>&nbsp;<span class="ident" id="3246878">tryOneName</span><span class="op" id="3246888">(</span><span class="ident" id="3246889">cfg</span><span class="op" id="3246892">.</span><span class="ident" id="3246893">dnsConfig</span><span class="op" id="3246902">,</span>&nbsp;<span class="ident" id="3246904">rname</span><span class="op" id="3246909">,</span>&nbsp;<span class="ident" id="3246911">qtype</span><span class="op" id="3246916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3246920">if</span>&nbsp;<span class="ident" id="3246923">err</span>&nbsp;<span class="op" id="3246927">==</span>&nbsp;<span class="ident" id="3246930">nil</span>&nbsp;<span class="op" id="3246934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3246939">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3246948">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3246951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3246955">//&nbsp;Last&nbsp;ditch&nbsp;effort:&nbsp;try&nbsp;unsuffixed&nbsp;only&nbsp;if&nbsp;we&nbsp;haven&#39;t&nbsp;already,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3247021">//&nbsp;that&nbsp;is,&nbsp;name&nbsp;is&nbsp;not&nbsp;rooted&nbsp;and&nbsp;has&nbsp;less&nbsp;than&nbsp;ndots&nbsp;dots.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3247083">if</span>&nbsp;<span class="ident" id="3247086">count</span><span class="op" id="3247091">(</span><span class="ident" id="3247092">name</span><span class="op" id="3247096">,</span>&nbsp;<span class="string" id="3247098">&#39;.&#39;</span><span class="op" id="3247101">)</span>&nbsp;<span class="op" id="3247103">&lt;</span>&nbsp;<span class="ident" id="3247105">cfg</span><span class="op" id="3247108">.</span><span class="ident" id="3247109">dnsConfig</span><span class="op" id="3247118">.</span><span class="ident" id="3247119">ndots</span>&nbsp;<span class="op" id="3247125">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3247129">cname</span><span class="op" id="3247134">,</span>&nbsp;<span class="ident" id="3247136">addrs</span><span class="op" id="3247141">,</span>&nbsp;<span class="ident" id="3247143">err</span>&nbsp;<span class="op" id="3247147">=</span>&nbsp;<span class="ident" id="3247149">tryOneName</span><span class="op" id="3247159">(</span><span class="ident" id="3247160">cfg</span><span class="op" id="3247163">.</span><span class="ident" id="3247164">dnsConfig</span><span class="op" id="3247173">,</span>&nbsp;<span class="ident" id="3247175">name</span><span class="op" id="3247179">+</span><span class="string" id="3247180">&#34;.&#34;</span><span class="op" id="3247183">,</span>&nbsp;<span class="ident" id="3247185">qtype</span><span class="op" id="3247190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3247194">if</span>&nbsp;<span class="ident" id="3247197">err</span>&nbsp;<span class="op" id="3247201">==</span>&nbsp;<span class="ident" id="3247204">nil</span>&nbsp;<span class="op" id="3247208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3247213">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3247222">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3247225">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3247229">if</span>&nbsp;<span class="ident" id="3247232">e</span><span class="op" id="3247233">,</span>&nbsp;<span class="ident" id="3247235">ok</span>&nbsp;<span class="op" id="3247238">:=</span>&nbsp;<span class="ident" id="3247241">err</span><span class="op" id="3247244">.</span><span class="op" id="3247245">(</span><span class="op" id="3247246">*</span><span class="ident" id="3247247">DNSError</span><span class="op" id="3247255">)</span><span class="op" id="3247256">;</span>&nbsp;<span class="ident" id="3247258">ok</span>&nbsp;<span class="op" id="3247261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3247265">//&nbsp;Show&nbsp;original&nbsp;name&nbsp;passed&nbsp;to&nbsp;lookup,&nbsp;not&nbsp;suffixed&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3247325">//&nbsp;In&nbsp;general&nbsp;we&nbsp;might&nbsp;have&nbsp;tried&nbsp;many&nbsp;suffixes;&nbsp;showing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3247384">//&nbsp;just&nbsp;one&nbsp;is&nbsp;misleading.&nbsp;See&nbsp;also&nbsp;golang.org/issue/6324.</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3247445">e</span><span class="op" id="3247446">.</span><span class="ident" id="3247447">Name</span>&nbsp;<span class="op" id="3247452">=</span>&nbsp;<span class="ident" id="3247454">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3247460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3247463">return</span><br>
<span class="lineno"></span><span class="op" id="3247470">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span><span class="comment" id="3247473">//&nbsp;goLookupHost&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupHost.</span><br>
<span class="lineno"></span><span class="comment" id="3247536">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupHost&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="3247596">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupHost&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="3247660">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3247721">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno">340</span><span class="comment" id="3247784">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="3247796">func</span>&nbsp;<span class="ident" id="3247801">goLookupHost</span><span class="op" id="3247813">(</span><span class="ident" id="3247814">name</span>&nbsp;<span class="builtintype" id="3247819">string</span><span class="op" id="3247825">)</span>&nbsp;<span class="op" id="3247827">(</span><span class="ident" id="3247828">addrs</span>&nbsp;<span class="op" id="3247834">[</span><span class="op" id="3247835">]</span><span class="builtintype" id="3247836">string</span><span class="op" id="3247842">,</span>&nbsp;<span class="ident" id="3247844">err</span>&nbsp;<span class="builtintype" id="3247848">error</span><span class="op" id="3247853">)</span>&nbsp;<span class="op" id="3247855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3247858">//&nbsp;Use&nbsp;entries&nbsp;from&nbsp;/etc/hosts&nbsp;if&nbsp;they&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3247905">addrs</span>&nbsp;<span class="op" id="3247911">=</span>&nbsp;<span class="ident" id="3247913">lookupStaticHost</span><span class="op" id="3247929">(</span><span class="ident" id="3247930">name</span><span class="op" id="3247934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3247937">if</span>&nbsp;<span class="builtinfunc" id="3247940">len</span><span class="op" id="3247943">(</span><span class="ident" id="3247944">addrs</span><span class="op" id="3247949">)</span>&nbsp;<span class="op" id="3247951">&gt;</span>&nbsp;<span class="num" id="3247953">0</span>&nbsp;<span class="op" id="3247955">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3247959">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3247967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3247970">ips</span><span class="op" id="3247973">,</span>&nbsp;<span class="ident" id="3247975">err</span>&nbsp;<span class="op" id="3247979">:=</span>&nbsp;<span class="ident" id="3247982">goLookupIP</span><span class="op" id="3247992">(</span><span class="ident" id="3247993">name</span><span class="op" id="3247997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3248000">if</span>&nbsp;<span class="ident" id="3248003">err</span>&nbsp;<span class="op" id="3248007">!=</span>&nbsp;<span class="ident" id="3248010">nil</span>&nbsp;<span class="op" id="3248014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3248018">return</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3248026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3248029">addrs</span>&nbsp;<span class="op" id="3248035">=</span>&nbsp;<span class="builtinfunc" id="3248037">make</span><span class="op" id="3248041">(</span><span class="op" id="3248042">[</span><span class="op" id="3248043">]</span><span class="builtintype" id="3248044">string</span><span class="op" id="3248050">,</span>&nbsp;<span class="num" id="3248052">0</span><span class="op" id="3248053">,</span>&nbsp;<span class="builtinfunc" id="3248055">len</span><span class="op" id="3248058">(</span><span class="ident" id="3248059">ips</span><span class="op" id="3248062">)</span><span class="op" id="3248063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3248066">for</span>&nbsp;<span class="ident" id="3248070">_</span><span class="op" id="3248071">,</span>&nbsp;<span class="ident" id="3248073">ip</span>&nbsp;<span class="op" id="3248076">:=</span>&nbsp;<span class="keyword" id="3248079">range</span>&nbsp;<span class="ident" id="3248085">ips</span>&nbsp;<span class="op" id="3248089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3248093">addrs</span>&nbsp;<span class="op" id="3248099">=</span>&nbsp;<span class="builtinfunc" id="3248101">append</span><span class="op" id="3248107">(</span><span class="ident" id="3248108">addrs</span><span class="op" id="3248113">,</span>&nbsp;<span class="ident" id="3248115">ip</span><span class="op" id="3248117">.</span><span class="ident" id="3248118">String</span><span class="op" id="3248124">(</span><span class="op" id="3248125">)</span><span class="op" id="3248126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3248129">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3248132">return</span><br>
<span class="lineno"></span><span class="op" id="3248139">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3248142">//&nbsp;goLookupIP&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupIP.</span><br>
<span class="lineno"></span><span class="comment" id="3248201">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupIP&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno">360</span><span class="comment" id="3248259">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupIP&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="3248321">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3248382">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span><span class="comment" id="3248445">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="3248457">func</span>&nbsp;<span class="ident" id="3248462">goLookupIP</span><span class="op" id="3248472">(</span><span class="ident" id="3248473">name</span>&nbsp;<span class="builtintype" id="3248478">string</span><span class="op" id="3248484">)</span>&nbsp;<span class="op" id="3248486">(</span><span class="ident" id="3248487">addrs</span>&nbsp;<span class="op" id="3248493">[</span><span class="op" id="3248494">]</span><span class="ident" id="3248495">IP</span><span class="op" id="3248497">,</span>&nbsp;<span class="ident" id="3248499">err</span>&nbsp;<span class="builtintype" id="3248503">error</span><span class="op" id="3248508">)</span>&nbsp;<span class="op" id="3248510">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3248513">//&nbsp;Use&nbsp;entries&nbsp;from&nbsp;/etc/hosts&nbsp;if&nbsp;possible.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3248558">haddrs</span>&nbsp;<span class="op" id="3248565">:=</span>&nbsp;<span class="ident" id="3248568">lookupStaticHost</span><span class="op" id="3248584">(</span><span class="ident" id="3248585">name</span><span class="op" id="3248589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3248592">if</span>&nbsp;<span class="builtinfunc" id="3248595">len</span><span class="op" id="3248598">(</span><span class="ident" id="3248599">haddrs</span><span class="op" id="3248605">)</span>&nbsp;<span class="op" id="3248607">&gt;</span>&nbsp;<span class="num" id="3248609">0</span>&nbsp;<span class="op" id="3248611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3248615">for</span>&nbsp;<span class="ident" id="3248619">_</span><span class="op" id="3248620">,</span>&nbsp;<span class="ident" id="3248622">haddr</span>&nbsp;<span class="op" id="3248628">:=</span>&nbsp;<span class="keyword" id="3248631">range</span>&nbsp;<span class="ident" id="3248637">haddrs</span>&nbsp;<span class="op" id="3248644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3248649">if</span>&nbsp;<span class="ident" id="3248652">ip</span>&nbsp;<span class="op" id="3248655">:=</span>&nbsp;<span class="ident" id="3248658">ParseIP</span><span class="op" id="3248665">(</span><span class="ident" id="3248666">haddr</span><span class="op" id="3248671">)</span><span class="op" id="3248672">;</span>&nbsp;<span class="ident" id="3248674">ip</span>&nbsp;<span class="op" id="3248677">!=</span>&nbsp;<span class="ident" id="3248680">nil</span>&nbsp;<span class="op" id="3248684">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3248690">addrs</span>&nbsp;<span class="op" id="3248696">=</span>&nbsp;<span class="builtinfunc" id="3248698">append</span><span class="op" id="3248704">(</span><span class="ident" id="3248705">addrs</span><span class="op" id="3248710">,</span>&nbsp;<span class="ident" id="3248712">ip</span><span class="op" id="3248714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3248719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3248723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3248727">if</span>&nbsp;<span class="builtinfunc" id="3248730">len</span><span class="op" id="3248733">(</span><span class="ident" id="3248734">addrs</span><span class="op" id="3248739">)</span>&nbsp;<span class="op" id="3248741">&gt;</span>&nbsp;<span class="num" id="3248743">0</span>&nbsp;<span class="op" id="3248745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3248750">return</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3248759">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3248762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3248765">type</span>&nbsp;<span class="ident" id="3248770">racer</span>&nbsp;<span class="keyword" id="3248776">struct</span>&nbsp;<span class="op" id="3248783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3248787">qtype</span>&nbsp;<span class="builtintype" id="3248793">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3248802">rrs</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3248808">[</span><span class="op" id="3248809">]</span><span class="ident" id="3248810">dnsRR</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3248818">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3248825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3248828">lane</span>&nbsp;<span class="op" id="3248833">:=</span>&nbsp;<span class="builtinfunc" id="3248836">make</span><span class="op" id="3248840">(</span><span class="keyword" id="3248841">chan</span>&nbsp;<span class="ident" id="3248846">racer</span><span class="op" id="3248851">,</span>&nbsp;<span class="num" id="3248853">1</span><span class="op" id="3248854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3248857">qtypes</span>&nbsp;<span class="op" id="3248864">:=</span>&nbsp;<span class="op" id="3248867">[</span><span class="op" id="3248868">...</span><span class="op" id="3248871">]</span><span class="builtintype" id="3248872">uint16</span><span class="op" id="3248878">{</span><span class="ident" id="3248879">dnsTypeA</span><span class="op" id="3248887">,</span>&nbsp;<span class="ident" id="3248889">dnsTypeAAAA</span><span class="op" id="3248900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3248903">for</span>&nbsp;<span class="ident" id="3248907">_</span><span class="op" id="3248908">,</span>&nbsp;<span class="ident" id="3248910">qtype</span>&nbsp;<span class="op" id="3248916">:=</span>&nbsp;<span class="keyword" id="3248919">range</span>&nbsp;<span class="ident" id="3248925">qtypes</span>&nbsp;<span class="op" id="3248932">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3248936">go</span>&nbsp;<span class="keyword" id="3248939">func</span><span class="op" id="3248943">(</span><span class="ident" id="3248944">qtype</span>&nbsp;<span class="builtintype" id="3248950">uint16</span><span class="op" id="3248956">)</span>&nbsp;<span class="op" id="3248958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3248963">_</span><span class="op" id="3248964">,</span>&nbsp;<span class="ident" id="3248966">rrs</span><span class="op" id="3248969">,</span>&nbsp;<span class="ident" id="3248971">err</span>&nbsp;<span class="op" id="3248975">:=</span>&nbsp;<span class="ident" id="3248978">lookup</span><span class="op" id="3248984">(</span><span class="ident" id="3248985">name</span><span class="op" id="3248989">,</span>&nbsp;<span class="ident" id="3248991">qtype</span><span class="op" id="3248996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3249001">lane</span>&nbsp;<span class="op" id="3249006">&lt;-</span>&nbsp;<span class="ident" id="3249009">racer</span><span class="op" id="3249014">{</span><span class="ident" id="3249015">qtype</span><span class="op" id="3249020">,</span>&nbsp;<span class="ident" id="3249022">rrs</span><span class="op" id="3249025">,</span>&nbsp;<span class="ident" id="3249027">err</span><span class="op" id="3249030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3249034">}</span><span class="op" id="3249035">(</span><span class="ident" id="3249036">qtype</span><span class="op" id="3249041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3249044">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3249047">var</span>&nbsp;<span class="ident" id="3249051">lastErr</span>&nbsp;<span class="builtintype" id="3249059">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3249066">for</span>&nbsp;<span class="keyword" id="3249070">range</span>&nbsp;<span class="ident" id="3249076">qtypes</span>&nbsp;<span class="op" id="3249083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3249087">racer</span>&nbsp;<span class="op" id="3249093">:=</span>&nbsp;<span class="op" id="3249096">&lt;-</span><span class="ident" id="3249098">lane</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3249105">if</span>&nbsp;<span class="ident" id="3249108">racer</span><span class="op" id="3249113">.</span><span class="builtintype" id="3249114">error</span>&nbsp;<span class="op" id="3249120">!=</span>&nbsp;<span class="ident" id="3249123">nil</span>&nbsp;<span class="op" id="3249127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3249132">lastErr</span>&nbsp;<span class="op" id="3249140">=</span>&nbsp;<span class="ident" id="3249142">racer</span><span class="op" id="3249147">.</span><span class="builtintype" id="3249148">error</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3249157">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3249168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3249172">switch</span>&nbsp;<span class="ident" id="3249179">racer</span><span class="op" id="3249184">.</span><span class="ident" id="3249185">qtype</span>&nbsp;<span class="op" id="3249191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3249195">case</span>&nbsp;<span class="ident" id="3249200">dnsTypeA</span><span class="op" id="3249208">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3249213">addrs</span>&nbsp;<span class="op" id="3249219">=</span>&nbsp;<span class="builtinfunc" id="3249221">append</span><span class="op" id="3249227">(</span><span class="ident" id="3249228">addrs</span><span class="op" id="3249233">,</span>&nbsp;<span class="ident" id="3249235">convertRR_A</span><span class="op" id="3249246">(</span><span class="ident" id="3249247">racer</span><span class="op" id="3249252">.</span><span class="ident" id="3249253">rrs</span><span class="op" id="3249256">)</span><span class="op" id="3249257">...</span><span class="op" id="3249260">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3249264">case</span>&nbsp;<span class="ident" id="3249269">dnsTypeAAAA</span><span class="op" id="3249280">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3249285">addrs</span>&nbsp;<span class="op" id="3249291">=</span>&nbsp;<span class="builtinfunc" id="3249293">append</span><span class="op" id="3249299">(</span><span class="ident" id="3249300">addrs</span><span class="op" id="3249305">,</span>&nbsp;<span class="ident" id="3249307">convertRR_AAAA</span><span class="op" id="3249321">(</span><span class="ident" id="3249322">racer</span><span class="op" id="3249327">.</span><span class="ident" id="3249328">rrs</span><span class="op" id="3249331">)</span><span class="op" id="3249332">...</span><span class="op" id="3249335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3249339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3249342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3249345">if</span>&nbsp;<span class="builtinfunc" id="3249348">len</span><span class="op" id="3249351">(</span><span class="ident" id="3249352">addrs</span><span class="op" id="3249357">)</span>&nbsp;<span class="op" id="3249359">==</span>&nbsp;<span class="num" id="3249362">0</span>&nbsp;<span class="op" id="3249364">&amp;&amp;</span>&nbsp;<span class="ident" id="3249367">lastErr</span>&nbsp;<span class="op" id="3249375">!=</span>&nbsp;<span class="ident" id="3249378">nil</span>&nbsp;<span class="op" id="3249382">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3249386">return</span>&nbsp;<span class="ident" id="3249393">nil</span><span class="op" id="3249396">,</span>&nbsp;<span class="ident" id="3249398">lastErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3249407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3249410">return</span>&nbsp;<span class="ident" id="3249417">addrs</span><span class="op" id="3249422">,</span>&nbsp;<span class="ident" id="3249424">nil</span><br>
<span class="lineno"></span><span class="op" id="3249428">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="3249431">//&nbsp;goLookupCNAME&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupCNAME.</span><br>
<span class="lineno"></span><span class="comment" id="3249496">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupCNAME&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="3249557">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupCNAME&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="3249622">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3249683">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno">415</span><span class="comment" id="3249746">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="3249758">func</span>&nbsp;<span class="ident" id="3249763">goLookupCNAME</span><span class="op" id="3249776">(</span><span class="ident" id="3249777">name</span>&nbsp;<span class="builtintype" id="3249782">string</span><span class="op" id="3249788">)</span>&nbsp;<span class="op" id="3249790">(</span><span class="ident" id="3249791">cname</span>&nbsp;<span class="builtintype" id="3249797">string</span><span class="op" id="3249803">,</span>&nbsp;<span class="ident" id="3249805">err</span>&nbsp;<span class="builtintype" id="3249809">error</span><span class="op" id="3249814">)</span>&nbsp;<span class="op" id="3249816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3249819">_</span><span class="op" id="3249820">,</span>&nbsp;<span class="ident" id="3249822">rr</span><span class="op" id="3249824">,</span>&nbsp;<span class="ident" id="3249826">err</span>&nbsp;<span class="op" id="3249830">:=</span>&nbsp;<span class="ident" id="3249833">lookup</span><span class="op" id="3249839">(</span><span class="ident" id="3249840">name</span><span class="op" id="3249844">,</span>&nbsp;<span class="ident" id="3249846">dnsTypeCNAME</span><span class="op" id="3249858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3249861">if</span>&nbsp;<span class="ident" id="3249864">err</span>&nbsp;<span class="op" id="3249868">!=</span>&nbsp;<span class="ident" id="3249871">nil</span>&nbsp;<span class="op" id="3249875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3249879">return</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3249887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3249890">cname</span>&nbsp;<span class="op" id="3249896">=</span>&nbsp;<span class="ident" id="3249898">rr</span><span class="op" id="3249900">[</span><span class="num" id="3249901">0</span><span class="op" id="3249902">]</span><span class="op" id="3249903">.</span><span class="op" id="3249904">(</span><span class="op" id="3249905">*</span><span class="ident" id="3249906">dnsRR_CNAME</span><span class="op" id="3249917">)</span><span class="op" id="3249918">.</span><span class="ident" id="3249919">Cname</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3249926">return</span><br>
<span class="lineno"></span><span class="op" id="3249933">}</span>
</div>
</body>
</html>
