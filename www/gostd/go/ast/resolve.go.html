<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>go/ast</h2>
<ul>
<li><a href="/gostd/go/ast/ast.go.html">ast.go</a></li>
<li><a href="/gostd/go/ast/ast_test.go.html">ast_test.go</a></li>
<li><a href="/gostd/go/ast/commentmap.go.html">commentmap.go</a></li>
<li><a href="/gostd/go/ast/commentmap_test.go.html">commentmap_test.go</a></li>
<li><a href="/gostd/go/ast/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/go/ast/filter.go.html">filter.go</a></li>
<li><a href="/gostd/go/ast/filter_test.go.html">filter_test.go</a></li>
<li><a href="/gostd/go/ast/import.go.html">import.go</a></li>
<li><a href="/gostd/go/ast/print.go.html">print.go</a></li>
<li><a href="/gostd/go/ast/print_test.go.html">print_test.go</a></li>
<li><a href="/gostd/go/ast/resolve.go.html">resolve.go</a></li>
<li><a href="/gostd/go/ast/scope.go.html">scope.go</a></li>
<li><a href="/gostd/go/ast/walk.go.html">walk.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3623604">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3623659">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3623713">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3623764">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;NewPackage.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3623801">package</span>&nbsp;<span class="ident" id="3623809">ast</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3623814">import</span>&nbsp;<span class="op" id="3623821">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3623824">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3623831">&#34;go/scanner&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3623845">&#34;go/token&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3623857">&#34;strconv&#34;</span><br>
<span class="lineno"></span><span class="op" id="3623867">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="3623870">type</span>&nbsp;<span class="ident" id="3623875">pkgBuilder</span>&nbsp;<span class="keyword" id="3623886">struct</span>&nbsp;<span class="op" id="3623893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3623896">fset</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3623903">*</span><span class="ident" id="3623904">token</span><span class="op" id="3623909">.</span><span class="ident" id="3623910">FileSet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3623919">errors</span>&nbsp;<span class="ident" id="3623926">scanner</span><span class="op" id="3623933">.</span><span class="ident" id="3623934">ErrorList</span><br>
<span class="lineno"></span><span class="op" id="3623944">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3623947">func</span>&nbsp;<span class="op" id="3623952">(</span><span class="ident" id="3623953">p</span>&nbsp;<span class="op" id="3623955">*</span><span class="ident" id="3623956">pkgBuilder</span><span class="op" id="3623966">)</span>&nbsp;<span class="builtintype" id="3623968">error</span><span class="op" id="3623973">(</span><span class="ident" id="3623974">pos</span>&nbsp;<span class="ident" id="3623978">token</span><span class="op" id="3623983">.</span><span class="ident" id="3623984">Pos</span><span class="op" id="3623987">,</span>&nbsp;<span class="ident" id="3623989">msg</span>&nbsp;<span class="builtintype" id="3623993">string</span><span class="op" id="3623999">)</span>&nbsp;<span class="op" id="3624001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3624004">p</span><span class="op" id="3624005">.</span><span class="ident" id="3624006">errors</span><span class="op" id="3624012">.</span><span class="ident" id="3624013">Add</span><span class="op" id="3624016">(</span><span class="ident" id="3624017">p</span><span class="op" id="3624018">.</span><span class="ident" id="3624019">fset</span><span class="op" id="3624023">.</span><span class="ident" id="3624024">Position</span><span class="op" id="3624032">(</span><span class="ident" id="3624033">pos</span><span class="op" id="3624036">)</span><span class="op" id="3624037">,</span>&nbsp;<span class="ident" id="3624039">msg</span><span class="op" id="3624042">)</span><br>
<span class="lineno"></span><span class="op" id="3624044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="3624047">func</span>&nbsp;<span class="op" id="3624052">(</span><span class="ident" id="3624053">p</span>&nbsp;<span class="op" id="3624055">*</span><span class="ident" id="3624056">pkgBuilder</span><span class="op" id="3624066">)</span>&nbsp;<span class="ident" id="3624068">errorf</span><span class="op" id="3624074">(</span><span class="ident" id="3624075">pos</span>&nbsp;<span class="ident" id="3624079">token</span><span class="op" id="3624084">.</span><span class="ident" id="3624085">Pos</span><span class="op" id="3624088">,</span>&nbsp;<span class="ident" id="3624090">format</span>&nbsp;<span class="builtintype" id="3624097">string</span><span class="op" id="3624103">,</span>&nbsp;<span class="ident" id="3624105">args</span>&nbsp;<span class="op" id="3624110">...</span><span class="keyword" id="3624113">interface</span><span class="op" id="3624122">{</span><span class="op" id="3624123">}</span><span class="op" id="3624124">)</span>&nbsp;<span class="op" id="3624126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3624129">p</span><span class="op" id="3624130">.</span><span class="builtintype" id="3624131">error</span><span class="op" id="3624136">(</span><span class="ident" id="3624137">pos</span><span class="op" id="3624140">,</span>&nbsp;<span class="ident" id="3624142">fmt</span><span class="op" id="3624145">.</span><span class="ident" id="3624146">Sprintf</span><span class="op" id="3624153">(</span><span class="ident" id="3624154">format</span><span class="op" id="3624160">,</span>&nbsp;<span class="ident" id="3624162">args</span><span class="op" id="3624166">...</span><span class="op" id="3624169">)</span><span class="op" id="3624170">)</span><br>
<span class="lineno"></span><span class="op" id="3624172">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3624175">func</span>&nbsp;<span class="op" id="3624180">(</span><span class="ident" id="3624181">p</span>&nbsp;<span class="op" id="3624183">*</span><span class="ident" id="3624184">pkgBuilder</span><span class="op" id="3624194">)</span>&nbsp;<span class="ident" id="3624196">declare</span><span class="op" id="3624203">(</span><span class="ident" id="3624204">scope</span><span class="op" id="3624209">,</span>&nbsp;<span class="ident" id="3624211">altScope</span>&nbsp;<span class="op" id="3624220">*</span><span class="ident" id="3624221">Scope</span><span class="op" id="3624226">,</span>&nbsp;<span class="ident" id="3624228">obj</span>&nbsp;<span class="op" id="3624232">*</span><span class="ident" id="3624233">Object</span><span class="op" id="3624239">)</span>&nbsp;<span class="op" id="3624241">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3624244">alt</span>&nbsp;<span class="op" id="3624248">:=</span>&nbsp;<span class="ident" id="3624251">scope</span><span class="op" id="3624256">.</span><span class="ident" id="3624257">Insert</span><span class="op" id="3624263">(</span><span class="ident" id="3624264">obj</span><span class="op" id="3624267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624270">if</span>&nbsp;<span class="ident" id="3624273">alt</span>&nbsp;<span class="op" id="3624277">==</span>&nbsp;<span class="ident" id="3624280">nil</span>&nbsp;<span class="op" id="3624284">&amp;&amp;</span>&nbsp;<span class="ident" id="3624287">altScope</span>&nbsp;<span class="op" id="3624296">!=</span>&nbsp;<span class="ident" id="3624299">nil</span>&nbsp;<span class="op" id="3624303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3624307">//&nbsp;see&nbsp;if&nbsp;there&nbsp;is&nbsp;a&nbsp;conflicting&nbsp;declaration&nbsp;in&nbsp;altScope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3624366">alt</span>&nbsp;<span class="op" id="3624370">=</span>&nbsp;<span class="ident" id="3624372">altScope</span><span class="op" id="3624380">.</span><span class="ident" id="3624381">Lookup</span><span class="op" id="3624387">(</span><span class="ident" id="3624388">obj</span><span class="op" id="3624391">.</span><span class="ident" id="3624392">Name</span><span class="op" id="3624396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3624399">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624402">if</span>&nbsp;<span class="ident" id="3624405">alt</span>&nbsp;<span class="op" id="3624409">!=</span>&nbsp;<span class="ident" id="3624412">nil</span>&nbsp;<span class="op" id="3624416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3624420">prevDecl</span>&nbsp;<span class="op" id="3624429">:=</span>&nbsp;<span class="string" id="3624432">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624437">if</span>&nbsp;<span class="ident" id="3624440">pos</span>&nbsp;<span class="op" id="3624444">:=</span>&nbsp;<span class="ident" id="3624447">alt</span><span class="op" id="3624450">.</span><span class="ident" id="3624451">Pos</span><span class="op" id="3624454">(</span><span class="op" id="3624455">)</span><span class="op" id="3624456">;</span>&nbsp;<span class="ident" id="3624458">pos</span><span class="op" id="3624461">.</span><span class="ident" id="3624462">IsValid</span><span class="op" id="3624469">(</span><span class="op" id="3624470">)</span>&nbsp;<span class="op" id="3624472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3624477">prevDecl</span>&nbsp;<span class="op" id="3624486">=</span>&nbsp;<span class="ident" id="3624488">fmt</span><span class="op" id="3624491">.</span><span class="ident" id="3624492">Sprintf</span><span class="op" id="3624499">(</span><span class="string" id="3624500">&#34;\n\tprevious&nbsp;declaration&nbsp;at&nbsp;%s&#34;</span><span class="op" id="3624532">,</span>&nbsp;<span class="ident" id="3624534">p</span><span class="op" id="3624535">.</span><span class="ident" id="3624536">fset</span><span class="op" id="3624540">.</span><span class="ident" id="3624541">Position</span><span class="op" id="3624549">(</span><span class="ident" id="3624550">pos</span><span class="op" id="3624553">)</span><span class="op" id="3624554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3624558">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3624562">p</span><span class="op" id="3624563">.</span><span class="builtintype" id="3624564">error</span><span class="op" id="3624569">(</span><span class="ident" id="3624570">obj</span><span class="op" id="3624573">.</span><span class="ident" id="3624574">Pos</span><span class="op" id="3624577">(</span><span class="op" id="3624578">)</span><span class="op" id="3624579">,</span>&nbsp;<span class="ident" id="3624581">fmt</span><span class="op" id="3624584">.</span><span class="ident" id="3624585">Sprintf</span><span class="op" id="3624592">(</span><span class="string" id="3624593">&#34;%s&nbsp;redeclared&nbsp;in&nbsp;this&nbsp;block%s&#34;</span><span class="op" id="3624624">,</span>&nbsp;<span class="ident" id="3624626">obj</span><span class="op" id="3624629">.</span><span class="ident" id="3624630">Name</span><span class="op" id="3624634">,</span>&nbsp;<span class="ident" id="3624636">prevDecl</span><span class="op" id="3624644">)</span><span class="op" id="3624645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3624648">}</span><br>
<span class="lineno"></span><span class="op" id="3624650">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3624653">func</span>&nbsp;<span class="ident" id="3624658">resolve</span><span class="op" id="3624665">(</span><span class="ident" id="3624666">scope</span>&nbsp;<span class="op" id="3624672">*</span><span class="ident" id="3624673">Scope</span><span class="op" id="3624678">,</span>&nbsp;<span class="ident" id="3624680">ident</span>&nbsp;<span class="op" id="3624686">*</span><span class="ident" id="3624687">Ident</span><span class="op" id="3624692">)</span>&nbsp;<span class="builtintype" id="3624694">bool</span>&nbsp;<span class="op" id="3624699">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624702">for</span>&nbsp;<span class="op" id="3624706">;</span>&nbsp;<span class="ident" id="3624708">scope</span>&nbsp;<span class="op" id="3624714">!=</span>&nbsp;<span class="ident" id="3624717">nil</span><span class="op" id="3624720">;</span>&nbsp;<span class="ident" id="3624722">scope</span>&nbsp;<span class="op" id="3624728">=</span>&nbsp;<span class="ident" id="3624730">scope</span><span class="op" id="3624735">.</span><span class="ident" id="3624736">Outer</span>&nbsp;<span class="op" id="3624742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624746">if</span>&nbsp;<span class="ident" id="3624749">obj</span>&nbsp;<span class="op" id="3624753">:=</span>&nbsp;<span class="ident" id="3624756">scope</span><span class="op" id="3624761">.</span><span class="ident" id="3624762">Lookup</span><span class="op" id="3624768">(</span><span class="ident" id="3624769">ident</span><span class="op" id="3624774">.</span><span class="ident" id="3624775">Name</span><span class="op" id="3624779">)</span><span class="op" id="3624780">;</span>&nbsp;<span class="ident" id="3624782">obj</span>&nbsp;<span class="op" id="3624786">!=</span>&nbsp;<span class="ident" id="3624789">nil</span>&nbsp;<span class="op" id="3624793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3624798">ident</span><span class="op" id="3624803">.</span><span class="ident" id="3624804">Obj</span>&nbsp;<span class="op" id="3624808">=</span>&nbsp;<span class="ident" id="3624810">obj</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624817">return</span>&nbsp;<span class="builtintype" id="3624824">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3624831">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3624834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624837">return</span>&nbsp;<span class="builtintype" id="3624844">false</span><br>
<span class="lineno"></span><span class="op" id="3624850">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3624853">//&nbsp;An&nbsp;Importer&nbsp;resolves&nbsp;import&nbsp;paths&nbsp;to&nbsp;package&nbsp;Objects.</span><br>
<span class="lineno">55</span><span class="comment" id="3624910">//&nbsp;The&nbsp;imports&nbsp;map&nbsp;records&nbsp;the&nbsp;packages&nbsp;already&nbsp;imported,</span><br>
<span class="lineno"></span><span class="comment" id="3624968">//&nbsp;indexed&nbsp;by&nbsp;package&nbsp;id&nbsp;(canonical&nbsp;import&nbsp;path).</span><br>
<span class="lineno"></span><span class="comment" id="3625018">//&nbsp;An&nbsp;Importer&nbsp;must&nbsp;determine&nbsp;the&nbsp;canonical&nbsp;import&nbsp;path&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3625078">//&nbsp;check&nbsp;the&nbsp;map&nbsp;to&nbsp;see&nbsp;if&nbsp;it&nbsp;is&nbsp;already&nbsp;present&nbsp;in&nbsp;the&nbsp;imports&nbsp;map.</span><br>
<span class="lineno"></span><span class="comment" id="3625147">//&nbsp;If&nbsp;so,&nbsp;the&nbsp;Importer&nbsp;can&nbsp;return&nbsp;the&nbsp;map&nbsp;entry.&nbsp;&nbsp;Otherwise,&nbsp;the</span><br>
<span class="lineno">60</span><span class="comment" id="3625212">//&nbsp;Importer&nbsp;should&nbsp;load&nbsp;the&nbsp;package&nbsp;data&nbsp;for&nbsp;the&nbsp;given&nbsp;path&nbsp;into</span><br>
<span class="lineno"></span><span class="comment" id="3625277">//&nbsp;a&nbsp;new&nbsp;*Object&nbsp;(pkg),&nbsp;record&nbsp;pkg&nbsp;in&nbsp;the&nbsp;imports&nbsp;map,&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="3625341">//&nbsp;return&nbsp;pkg.</span><br>
<span class="lineno"></span><span class="keyword" id="3625356">type</span>&nbsp;<span class="ident" id="3625361">Importer</span>&nbsp;<span class="keyword" id="3625370">func</span><span class="op" id="3625374">(</span><span class="ident" id="3625375">imports</span>&nbsp;<span class="keyword" id="3625383">map</span><span class="op" id="3625386">[</span><span class="builtintype" id="3625387">string</span><span class="op" id="3625393">]</span><span class="op" id="3625394">*</span><span class="ident" id="3625395">Object</span><span class="op" id="3625401">,</span>&nbsp;<span class="ident" id="3625403">path</span>&nbsp;<span class="builtintype" id="3625408">string</span><span class="op" id="3625414">)</span>&nbsp;<span class="op" id="3625416">(</span><span class="ident" id="3625417">pkg</span>&nbsp;<span class="op" id="3625421">*</span><span class="ident" id="3625422">Object</span><span class="op" id="3625428">,</span>&nbsp;<span class="ident" id="3625430">err</span>&nbsp;<span class="builtintype" id="3625434">error</span><span class="op" id="3625439">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3625442">//&nbsp;NewPackage&nbsp;creates&nbsp;a&nbsp;new&nbsp;Package&nbsp;node&nbsp;from&nbsp;a&nbsp;set&nbsp;of&nbsp;File&nbsp;nodes.&nbsp;It&nbsp;resolves</span><br>
<span class="lineno"></span><span class="comment" id="3625521">//&nbsp;unresolved&nbsp;identifiers&nbsp;across&nbsp;files&nbsp;and&nbsp;updates&nbsp;each&nbsp;file&#39;s&nbsp;Unresolved&nbsp;list</span><br>
<span class="lineno"></span><span class="comment" id="3625600">//&nbsp;accordingly.&nbsp;If&nbsp;a&nbsp;non-nil&nbsp;importer&nbsp;and&nbsp;universe&nbsp;scope&nbsp;are&nbsp;provided,&nbsp;they&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="3625680">//&nbsp;used&nbsp;to&nbsp;resolve&nbsp;identifiers&nbsp;not&nbsp;declared&nbsp;in&nbsp;any&nbsp;of&nbsp;the&nbsp;package&nbsp;files.&nbsp;Any</span><br>
<span class="lineno"></span><span class="comment" id="3625757">//&nbsp;remaining&nbsp;unresolved&nbsp;identifiers&nbsp;are&nbsp;reported&nbsp;as&nbsp;undeclared.&nbsp;If&nbsp;the&nbsp;files</span><br>
<span class="lineno">70</span><span class="comment" id="3625834">//&nbsp;belong&nbsp;to&nbsp;different&nbsp;packages,&nbsp;one&nbsp;package&nbsp;name&nbsp;is&nbsp;selected&nbsp;and&nbsp;files&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="3625911">//&nbsp;different&nbsp;package&nbsp;names&nbsp;are&nbsp;reported&nbsp;and&nbsp;then&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="3625969">//&nbsp;The&nbsp;result&nbsp;is&nbsp;a&nbsp;package&nbsp;node&nbsp;and&nbsp;a&nbsp;scanner.ErrorList&nbsp;if&nbsp;there&nbsp;were&nbsp;errors.</span><br>
<span class="lineno"></span><span class="comment" id="3626047">//</span><br>
<span class="lineno"></span><span class="keyword" id="3626050">func</span>&nbsp;<span class="ident" id="3626055">NewPackage</span><span class="op" id="3626065">(</span><span class="ident" id="3626066">fset</span>&nbsp;<span class="op" id="3626071">*</span><span class="ident" id="3626072">token</span><span class="op" id="3626077">.</span><span class="ident" id="3626078">FileSet</span><span class="op" id="3626085">,</span>&nbsp;<span class="ident" id="3626087">files</span>&nbsp;<span class="keyword" id="3626093">map</span><span class="op" id="3626096">[</span><span class="builtintype" id="3626097">string</span><span class="op" id="3626103">]</span><span class="op" id="3626104">*</span><span class="ident" id="3626105">File</span><span class="op" id="3626109">,</span>&nbsp;<span class="ident" id="3626111">importer</span>&nbsp;<span class="ident" id="3626120">Importer</span><span class="op" id="3626128">,</span>&nbsp;<span class="ident" id="3626130">universe</span>&nbsp;<span class="op" id="3626139">*</span><span class="ident" id="3626140">Scope</span><span class="op" id="3626145">)</span>&nbsp;<span class="op" id="3626147">(</span><span class="op" id="3626148">*</span><span class="ident" id="3626149">Package</span><span class="op" id="3626156">,</span>&nbsp;<span class="builtintype" id="3626158">error</span><span class="op" id="3626163">)</span>&nbsp;<span class="op" id="3626165">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626168">var</span>&nbsp;<span class="ident" id="3626172">p</span>&nbsp;<span class="ident" id="3626174">pkgBuilder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3626186">p</span><span class="op" id="3626187">.</span><span class="ident" id="3626188">fset</span>&nbsp;<span class="op" id="3626193">=</span>&nbsp;<span class="ident" id="3626195">fset</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3626202">//&nbsp;complete&nbsp;package&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3626229">pkgName</span>&nbsp;<span class="op" id="3626237">:=</span>&nbsp;<span class="string" id="3626240">&#34;&#34;</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3626244">pkgScope</span>&nbsp;<span class="op" id="3626253">:=</span>&nbsp;<span class="ident" id="3626256">NewScope</span><span class="op" id="3626264">(</span><span class="ident" id="3626265">universe</span><span class="op" id="3626273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626276">for</span>&nbsp;<span class="ident" id="3626280">_</span><span class="op" id="3626281">,</span>&nbsp;<span class="ident" id="3626283">file</span>&nbsp;<span class="op" id="3626288">:=</span>&nbsp;<span class="keyword" id="3626291">range</span>&nbsp;<span class="ident" id="3626297">files</span>&nbsp;<span class="op" id="3626303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3626307">//&nbsp;package&nbsp;names&nbsp;must&nbsp;match</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626337">switch</span>&nbsp;<span class="ident" id="3626344">name</span>&nbsp;<span class="op" id="3626349">:=</span>&nbsp;<span class="ident" id="3626352">file</span><span class="op" id="3626356">.</span><span class="ident" id="3626357">Name</span><span class="op" id="3626361">.</span><span class="ident" id="3626362">Name</span><span class="op" id="3626366">;</span>&nbsp;<span class="op" id="3626368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626372">case</span>&nbsp;<span class="ident" id="3626377">pkgName</span>&nbsp;<span class="op" id="3626385">==</span>&nbsp;<span class="string" id="3626388">&#34;&#34;</span><span class="op" id="3626390">:</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3626395">pkgName</span>&nbsp;<span class="op" id="3626403">=</span>&nbsp;<span class="ident" id="3626405">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626412">case</span>&nbsp;<span class="ident" id="3626417">name</span>&nbsp;<span class="op" id="3626422">!=</span>&nbsp;<span class="ident" id="3626425">pkgName</span><span class="op" id="3626432">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3626437">p</span><span class="op" id="3626438">.</span><span class="ident" id="3626439">errorf</span><span class="op" id="3626445">(</span><span class="ident" id="3626446">file</span><span class="op" id="3626450">.</span><span class="ident" id="3626451">Package</span><span class="op" id="3626458">,</span>&nbsp;<span class="string" id="3626460">&#34;package&nbsp;%s;&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="3626485">,</span>&nbsp;<span class="ident" id="3626487">name</span><span class="op" id="3626491">,</span>&nbsp;<span class="ident" id="3626493">pkgName</span><span class="op" id="3626500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626505">continue</span>&nbsp;<span class="comment" id="3626514">//&nbsp;ignore&nbsp;this&nbsp;file</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3626536">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3626541">//&nbsp;collect&nbsp;top-level&nbsp;file&nbsp;objects&nbsp;in&nbsp;package&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626594">for</span>&nbsp;<span class="ident" id="3626598">_</span><span class="op" id="3626599">,</span>&nbsp;<span class="ident" id="3626601">obj</span>&nbsp;<span class="op" id="3626605">:=</span>&nbsp;<span class="keyword" id="3626608">range</span>&nbsp;<span class="ident" id="3626614">file</span><span class="op" id="3626618">.</span><span class="ident" id="3626619">Scope</span><span class="op" id="3626624">.</span><span class="ident" id="3626625">Objects</span>&nbsp;<span class="op" id="3626633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3626638">p</span><span class="op" id="3626639">.</span><span class="ident" id="3626640">declare</span><span class="op" id="3626647">(</span><span class="ident" id="3626648">pkgScope</span><span class="op" id="3626656">,</span>&nbsp;<span class="ident" id="3626658">nil</span><span class="op" id="3626661">,</span>&nbsp;<span class="ident" id="3626663">obj</span><span class="op" id="3626666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3626670">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3626673">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3626677">//&nbsp;package&nbsp;global&nbsp;mapping&nbsp;of&nbsp;imported&nbsp;package&nbsp;ids&nbsp;to&nbsp;package&nbsp;objects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3626747">imports</span>&nbsp;<span class="op" id="3626755">:=</span>&nbsp;<span class="builtinfunc" id="3626758">make</span><span class="op" id="3626762">(</span><span class="keyword" id="3626763">map</span><span class="op" id="3626766">[</span><span class="builtintype" id="3626767">string</span><span class="op" id="3626773">]</span><span class="op" id="3626774">*</span><span class="ident" id="3626775">Object</span><span class="op" id="3626781">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3626785">//&nbsp;complete&nbsp;file&nbsp;scopes&nbsp;with&nbsp;imports&nbsp;and&nbsp;resolve&nbsp;identifiers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626847">for</span>&nbsp;<span class="ident" id="3626851">_</span><span class="op" id="3626852">,</span>&nbsp;<span class="ident" id="3626854">file</span>&nbsp;<span class="op" id="3626859">:=</span>&nbsp;<span class="keyword" id="3626862">range</span>&nbsp;<span class="ident" id="3626868">files</span>&nbsp;<span class="op" id="3626874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3626878">//&nbsp;ignore&nbsp;file&nbsp;if&nbsp;it&nbsp;belongs&nbsp;to&nbsp;a&nbsp;different&nbsp;package</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3626932">//&nbsp;(error&nbsp;has&nbsp;already&nbsp;been&nbsp;reported)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626971">if</span>&nbsp;<span class="ident" id="3626974">file</span><span class="op" id="3626978">.</span><span class="ident" id="3626979">Name</span><span class="op" id="3626983">.</span><span class="ident" id="3626984">Name</span>&nbsp;<span class="op" id="3626989">!=</span>&nbsp;<span class="ident" id="3626992">pkgName</span>&nbsp;<span class="op" id="3627000">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3627005">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3627016">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3627021">//&nbsp;build&nbsp;file&nbsp;scope&nbsp;by&nbsp;processing&nbsp;all&nbsp;imports</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3627069">importErrors</span>&nbsp;<span class="op" id="3627082">:=</span>&nbsp;<span class="builtintype" id="3627085">false</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3627093">fileScope</span>&nbsp;<span class="op" id="3627103">:=</span>&nbsp;<span class="ident" id="3627106">NewScope</span><span class="op" id="3627114">(</span><span class="ident" id="3627115">pkgScope</span><span class="op" id="3627123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3627127">for</span>&nbsp;<span class="ident" id="3627131">_</span><span class="op" id="3627132">,</span>&nbsp;<span class="ident" id="3627134">spec</span>&nbsp;<span class="op" id="3627139">:=</span>&nbsp;<span class="keyword" id="3627142">range</span>&nbsp;<span class="ident" id="3627148">file</span><span class="op" id="3627152">.</span><span class="ident" id="3627153">Imports</span>&nbsp;<span class="op" id="3627161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3627166">if</span>&nbsp;<span class="ident" id="3627169">importer</span>&nbsp;<span class="op" id="3627178">==</span>&nbsp;<span class="ident" id="3627181">nil</span>&nbsp;<span class="op" id="3627185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3627191">importErrors</span>&nbsp;<span class="op" id="3627204">=</span>&nbsp;<span class="builtintype" id="3627206">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3627215">continue</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3627227">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3627232">path</span><span class="op" id="3627236">,</span>&nbsp;<span class="ident" id="3627238">_</span>&nbsp;<span class="op" id="3627240">:=</span>&nbsp;<span class="ident" id="3627243">strconv</span><span class="op" id="3627250">.</span><span class="ident" id="3627251">Unquote</span><span class="op" id="3627258">(</span><span class="ident" id="3627259">spec</span><span class="op" id="3627263">.</span><span class="ident" id="3627264">Path</span><span class="op" id="3627268">.</span><span class="ident" id="3627269">Value</span><span class="op" id="3627274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3627279">pkg</span><span class="op" id="3627282">,</span>&nbsp;<span class="ident" id="3627284">err</span>&nbsp;<span class="op" id="3627288">:=</span>&nbsp;<span class="ident" id="3627291">importer</span><span class="op" id="3627299">(</span><span class="ident" id="3627300">imports</span><span class="op" id="3627307">,</span>&nbsp;<span class="ident" id="3627309">path</span><span class="op" id="3627313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3627318">if</span>&nbsp;<span class="ident" id="3627321">err</span>&nbsp;<span class="op" id="3627325">!=</span>&nbsp;<span class="ident" id="3627328">nil</span>&nbsp;<span class="op" id="3627332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3627338">p</span><span class="op" id="3627339">.</span><span class="ident" id="3627340">errorf</span><span class="op" id="3627346">(</span><span class="ident" id="3627347">spec</span><span class="op" id="3627351">.</span><span class="ident" id="3627352">Path</span><span class="op" id="3627356">.</span><span class="ident" id="3627357">Pos</span><span class="op" id="3627360">(</span><span class="op" id="3627361">)</span><span class="op" id="3627362">,</span>&nbsp;<span class="string" id="3627364">&#34;could&nbsp;not&nbsp;import&nbsp;%s&nbsp;(%s)&#34;</span><span class="op" id="3627390">,</span>&nbsp;<span class="ident" id="3627392">path</span><span class="op" id="3627396">,</span>&nbsp;<span class="ident" id="3627398">err</span><span class="op" id="3627401">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3627407">importErrors</span>&nbsp;<span class="op" id="3627420">=</span>&nbsp;<span class="builtintype" id="3627422">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3627431">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3627443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3627448">//&nbsp;TODO(gri)&nbsp;If&nbsp;a&nbsp;local&nbsp;package&nbsp;name&nbsp;!=&nbsp;&#34;.&#34;&nbsp;is&nbsp;provided,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3627508">//&nbsp;global&nbsp;identifier&nbsp;resolution&nbsp;could&nbsp;proceed&nbsp;even&nbsp;if&nbsp;the</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3627569">//&nbsp;import&nbsp;failed.&nbsp;Consider&nbsp;adjusting&nbsp;the&nbsp;logic&nbsp;here&nbsp;a&nbsp;bit.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3627632">//&nbsp;local&nbsp;name&nbsp;overrides&nbsp;imported&nbsp;package&nbsp;name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3627681">name</span>&nbsp;<span class="op" id="3627686">:=</span>&nbsp;<span class="ident" id="3627689">pkg</span><span class="op" id="3627692">.</span><span class="ident" id="3627693">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3627701">if</span>&nbsp;<span class="ident" id="3627704">spec</span><span class="op" id="3627708">.</span><span class="ident" id="3627709">Name</span>&nbsp;<span class="op" id="3627714">!=</span>&nbsp;<span class="ident" id="3627717">nil</span>&nbsp;<span class="op" id="3627721">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3627727">name</span>&nbsp;<span class="op" id="3627732">=</span>&nbsp;<span class="ident" id="3627734">spec</span><span class="op" id="3627738">.</span><span class="ident" id="3627739">Name</span><span class="op" id="3627743">.</span><span class="ident" id="3627744">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3627752">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3627758">//&nbsp;add&nbsp;import&nbsp;to&nbsp;file&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3627789">if</span>&nbsp;<span class="ident" id="3627792">name</span>&nbsp;<span class="op" id="3627797">==</span>&nbsp;<span class="string" id="3627800">&#34;.&#34;</span>&nbsp;<span class="op" id="3627804">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3627810">//&nbsp;merge&nbsp;imported&nbsp;scope&nbsp;with&nbsp;file&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3627854">for</span>&nbsp;<span class="ident" id="3627858">_</span><span class="op" id="3627859">,</span>&nbsp;<span class="ident" id="3627861">obj</span>&nbsp;<span class="op" id="3627865">:=</span>&nbsp;<span class="keyword" id="3627868">range</span>&nbsp;<span class="ident" id="3627874">pkg</span><span class="op" id="3627877">.</span><span class="ident" id="3627878">Data</span><span class="op" id="3627882">.</span><span class="op" id="3627883">(</span><span class="op" id="3627884">*</span><span class="ident" id="3627885">Scope</span><span class="op" id="3627890">)</span><span class="op" id="3627891">.</span><span class="ident" id="3627892">Objects</span>&nbsp;<span class="op" id="3627900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3627907">p</span><span class="op" id="3627908">.</span><span class="ident" id="3627909">declare</span><span class="op" id="3627916">(</span><span class="ident" id="3627917">fileScope</span><span class="op" id="3627926">,</span>&nbsp;<span class="ident" id="3627928">pkgScope</span><span class="op" id="3627936">,</span>&nbsp;<span class="ident" id="3627938">obj</span><span class="op" id="3627941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3627947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3627952">}</span>&nbsp;<span class="keyword" id="3627954">else</span>&nbsp;<span class="keyword" id="3627959">if</span>&nbsp;<span class="ident" id="3627962">name</span>&nbsp;<span class="op" id="3627967">!=</span>&nbsp;<span class="string" id="3627970">&#34;_&#34;</span>&nbsp;<span class="op" id="3627974">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3627980">//&nbsp;declare&nbsp;imported&nbsp;package&nbsp;object&nbsp;in&nbsp;file&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3628033">//&nbsp;(do&nbsp;not&nbsp;re-use&nbsp;pkg&nbsp;in&nbsp;the&nbsp;file&nbsp;scope&nbsp;but&nbsp;create</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3628088">//&nbsp;a&nbsp;new&nbsp;object&nbsp;instead;&nbsp;the&nbsp;Decl&nbsp;field&nbsp;is&nbsp;different</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3628145">//&nbsp;for&nbsp;different&nbsp;files)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3628173">obj</span>&nbsp;<span class="op" id="3628177">:=</span>&nbsp;<span class="ident" id="3628180">NewObj</span><span class="op" id="3628186">(</span><span class="ident" id="3628187">Pkg</span><span class="op" id="3628190">,</span>&nbsp;<span class="ident" id="3628192">name</span><span class="op" id="3628196">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3628202">obj</span><span class="op" id="3628205">.</span><span class="ident" id="3628206">Decl</span>&nbsp;<span class="op" id="3628211">=</span>&nbsp;<span class="ident" id="3628213">spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3628222">obj</span><span class="op" id="3628225">.</span><span class="ident" id="3628226">Data</span>&nbsp;<span class="op" id="3628231">=</span>&nbsp;<span class="ident" id="3628233">pkg</span><span class="op" id="3628236">.</span><span class="ident" id="3628237">Data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3628246">p</span><span class="op" id="3628247">.</span><span class="ident" id="3628248">declare</span><span class="op" id="3628255">(</span><span class="ident" id="3628256">fileScope</span><span class="op" id="3628265">,</span>&nbsp;<span class="ident" id="3628267">pkgScope</span><span class="op" id="3628275">,</span>&nbsp;<span class="ident" id="3628277">obj</span><span class="op" id="3628280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3628285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3628289">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3628294">//&nbsp;resolve&nbsp;identifiers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3628319">if</span>&nbsp;<span class="ident" id="3628322">importErrors</span>&nbsp;<span class="op" id="3628335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3628340">//&nbsp;don&#39;t&nbsp;use&nbsp;the&nbsp;universe&nbsp;scope&nbsp;without&nbsp;correct&nbsp;imports</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3628399">//&nbsp;(objects&nbsp;in&nbsp;the&nbsp;universe&nbsp;may&nbsp;be&nbsp;shadowed&nbsp;by&nbsp;imports;</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3628458">//&nbsp;with&nbsp;missing&nbsp;imports,&nbsp;identifiers&nbsp;might&nbsp;get&nbsp;resolved</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3628517">//&nbsp;incorrectly&nbsp;to&nbsp;universe&nbsp;objects)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3628556">pkgScope</span><span class="op" id="3628564">.</span><span class="ident" id="3628565">Outer</span>&nbsp;<span class="op" id="3628571">=</span>&nbsp;<span class="ident" id="3628573">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3628579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3628583">i</span>&nbsp;<span class="op" id="3628585">:=</span>&nbsp;<span class="num" id="3628588">0</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3628592">for</span>&nbsp;<span class="ident" id="3628596">_</span><span class="op" id="3628597">,</span>&nbsp;<span class="ident" id="3628599">ident</span>&nbsp;<span class="op" id="3628605">:=</span>&nbsp;<span class="keyword" id="3628608">range</span>&nbsp;<span class="ident" id="3628614">file</span><span class="op" id="3628618">.</span><span class="ident" id="3628619">Unresolved</span>&nbsp;<span class="op" id="3628630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3628635">if</span>&nbsp;<span class="op" id="3628638">!</span><span class="ident" id="3628639">resolve</span><span class="op" id="3628646">(</span><span class="ident" id="3628647">fileScope</span><span class="op" id="3628656">,</span>&nbsp;<span class="ident" id="3628658">ident</span><span class="op" id="3628663">)</span>&nbsp;<span class="op" id="3628665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3628671">p</span><span class="op" id="3628672">.</span><span class="ident" id="3628673">errorf</span><span class="op" id="3628679">(</span><span class="ident" id="3628680">ident</span><span class="op" id="3628685">.</span><span class="ident" id="3628686">Pos</span><span class="op" id="3628689">(</span><span class="op" id="3628690">)</span><span class="op" id="3628691">,</span>&nbsp;<span class="string" id="3628693">&#34;undeclared&nbsp;name:&nbsp;%s&#34;</span><span class="op" id="3628714">,</span>&nbsp;<span class="ident" id="3628716">ident</span><span class="op" id="3628721">.</span><span class="ident" id="3628722">Name</span><span class="op" id="3628726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3628732">file</span><span class="op" id="3628736">.</span><span class="ident" id="3628737">Unresolved</span><span class="op" id="3628747">[</span><span class="ident" id="3628748">i</span><span class="op" id="3628749">]</span>&nbsp;<span class="op" id="3628751">=</span>&nbsp;<span class="ident" id="3628753">ident</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3628763">i</span><span class="op" id="3628764">++</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3628770">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3628775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3628779">file</span><span class="op" id="3628783">.</span><span class="ident" id="3628784">Unresolved</span>&nbsp;<span class="op" id="3628795">=</span>&nbsp;<span class="ident" id="3628797">file</span><span class="op" id="3628801">.</span><span class="ident" id="3628802">Unresolved</span><span class="op" id="3628812">[</span><span class="num" id="3628813">0</span><span class="op" id="3628814">:</span><span class="ident" id="3628815">i</span><span class="op" id="3628816">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3628820">pkgScope</span><span class="op" id="3628828">.</span><span class="ident" id="3628829">Outer</span>&nbsp;<span class="op" id="3628835">=</span>&nbsp;<span class="ident" id="3628837">universe</span>&nbsp;<span class="comment" id="3628846">//&nbsp;reset&nbsp;universe&nbsp;scope</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3628871">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3628875">p</span><span class="op" id="3628876">.</span><span class="ident" id="3628877">errors</span><span class="op" id="3628883">.</span><span class="ident" id="3628884">Sort</span><span class="op" id="3628888">(</span><span class="op" id="3628889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3628892">return</span>&nbsp;<span class="op" id="3628899">&amp;</span><span class="ident" id="3628900">Package</span><span class="op" id="3628907">{</span><span class="ident" id="3628908">pkgName</span><span class="op" id="3628915">,</span>&nbsp;<span class="ident" id="3628917">pkgScope</span><span class="op" id="3628925">,</span>&nbsp;<span class="ident" id="3628927">imports</span><span class="op" id="3628934">,</span>&nbsp;<span class="ident" id="3628936">files</span><span class="op" id="3628941">}</span><span class="op" id="3628942">,</span>&nbsp;<span class="ident" id="3628944">p</span><span class="op" id="3628945">.</span><span class="ident" id="3628946">errors</span><span class="op" id="3628952">.</span><span class="ident" id="3628953">Err</span><span class="op" id="3628956">(</span><span class="op" id="3628957">)</span><br>
<span class="lineno"></span><span class="op" id="3628959">}</span>
</div>
</body>
</html>
