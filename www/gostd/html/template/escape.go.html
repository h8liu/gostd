<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>html/template</h2>
<ul>
<li><a href="/gostd/html/template/attr.go.html">attr.go</a></li>
<li><a href="/gostd/html/template/clone_test.go.html">clone_test.go</a></li>
<li><a href="/gostd/html/template/content.go.html">content.go</a></li>
<li><a href="/gostd/html/template/content_test.go.html">content_test.go</a></li>
<li><a href="/gostd/html/template/context.go.html">context.go</a></li>
<li><a href="/gostd/html/template/css.go.html">css.go</a></li>
<li><a href="/gostd/html/template/css_test.go.html">css_test.go</a></li>
<li><a href="/gostd/html/template/doc.go.html">doc.go</a></li>
<li><a href="/gostd/html/template/error.go.html">error.go</a></li>
<li><a href="/gostd/html/template/escape.go.html" class="current">escape.go</a></li>
<li><a href="/gostd/html/template/escape_test.go.html">escape_test.go</a></li>
<li><a href="/gostd/html/template/html.go.html">html.go</a></li>
<li><a href="/gostd/html/template/html_test.go.html">html_test.go</a></li>
<li><a href="/gostd/html/template/js.go.html">js.go</a></li>
<li><a href="/gostd/html/template/js_test.go.html">js_test.go</a></li>
<li><a href="/gostd/html/template/template.go.html">template.go</a></li>
<li><a href="/gostd/html/template/transition.go.html">transition.go</a></li>
<li><a href="/gostd/html/template/url.go.html">url.go</a></li>
<li><a href="/gostd/html/template/url_test.go.html">url_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3004315">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3004370">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3004424">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3004475">package</span>&nbsp;<span class="ident" id="3004483">template</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3004493">import</span>&nbsp;<span class="op" id="3004500">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3004503">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3004512">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3004519">&#34;html&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3004527">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3004533">&#34;text/template&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3004550">&#34;text/template/parse&#34;</span><br>
<span class="lineno"></span><span class="op" id="3004572">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="3004575">//&nbsp;escapeTemplate&nbsp;rewrites&nbsp;the&nbsp;named&nbsp;template,&nbsp;which&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3004636">//&nbsp;associated&nbsp;with&nbsp;t,&nbsp;to&nbsp;guarantee&nbsp;that&nbsp;the&nbsp;output&nbsp;of&nbsp;any&nbsp;of&nbsp;the&nbsp;named</span><br>
<span class="lineno"></span><span class="comment" id="3004707">//&nbsp;templates&nbsp;is&nbsp;properly&nbsp;escaped.&nbsp;&nbsp;If&nbsp;no&nbsp;error&nbsp;is&nbsp;returned,&nbsp;then&nbsp;the&nbsp;named&nbsp;templates&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="3004797">//&nbsp;been&nbsp;modified.&nbsp;&nbsp;Otherwise&nbsp;the&nbsp;named&nbsp;templates&nbsp;have&nbsp;been&nbsp;rendered</span><br>
<span class="lineno">20</span><span class="comment" id="3004865">//&nbsp;unusable.</span><br>
<span class="lineno"></span><span class="keyword" id="3004878">func</span>&nbsp;<span class="ident" id="3004883">escapeTemplate</span><span class="op" id="3004897">(</span><span class="ident" id="3004898">tmpl</span>&nbsp;<span class="op" id="3004903">*</span><span class="ident" id="3004904">Template</span><span class="op" id="3004912">,</span>&nbsp;<span class="ident" id="3004914">node</span>&nbsp;<span class="ident" id="3004919">parse</span><span class="op" id="3004924">.</span><span class="ident" id="3004925">Node</span><span class="op" id="3004929">,</span>&nbsp;<span class="ident" id="3004931">name</span>&nbsp;<span class="builtintype" id="3004936">string</span><span class="op" id="3004942">)</span>&nbsp;<span class="builtintype" id="3004944">error</span>&nbsp;<span class="op" id="3004950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3004953">e</span>&nbsp;<span class="op" id="3004955">:=</span>&nbsp;<span class="ident" id="3004958">newEscaper</span><span class="op" id="3004968">(</span><span class="ident" id="3004969">tmpl</span><span class="op" id="3004973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3004976">c</span><span class="op" id="3004977">,</span>&nbsp;<span class="ident" id="3004979">_</span>&nbsp;<span class="op" id="3004981">:=</span>&nbsp;<span class="ident" id="3004984">e</span><span class="op" id="3004985">.</span><span class="ident" id="3004986">escapeTree</span><span class="op" id="3004996">(</span><span class="ident" id="3004997">context</span><span class="op" id="3005004">{</span><span class="op" id="3005005">}</span><span class="op" id="3005006">,</span>&nbsp;<span class="ident" id="3005008">node</span><span class="op" id="3005012">,</span>&nbsp;<span class="ident" id="3005014">name</span><span class="op" id="3005018">,</span>&nbsp;<span class="num" id="3005020">0</span><span class="op" id="3005021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3005024">var</span>&nbsp;<span class="ident" id="3005028">err</span>&nbsp;<span class="builtintype" id="3005032">error</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3005039">if</span>&nbsp;<span class="ident" id="3005042">c</span><span class="op" id="3005043">.</span><span class="ident" id="3005044">err</span>&nbsp;<span class="op" id="3005048">!=</span>&nbsp;<span class="builtintype" id="3005051">nil</span>&nbsp;<span class="op" id="3005055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3005059">err</span><span class="op" id="3005062">,</span>&nbsp;<span class="ident" id="3005064">c</span><span class="op" id="3005065">.</span><span class="ident" id="3005066">err</span><span class="op" id="3005069">.</span><span class="ident" id="3005070">Name</span>&nbsp;<span class="op" id="3005075">=</span>&nbsp;<span class="ident" id="3005077">c</span><span class="op" id="3005078">.</span><span class="ident" id="3005079">err</span><span class="op" id="3005082">,</span>&nbsp;<span class="ident" id="3005084">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3005090">}</span>&nbsp;<span class="keyword" id="3005092">else</span>&nbsp;<span class="keyword" id="3005097">if</span>&nbsp;<span class="ident" id="3005100">c</span><span class="op" id="3005101">.</span><span class="ident" id="3005102">state</span>&nbsp;<span class="op" id="3005108">!=</span>&nbsp;<span class="ident" id="3005111">stateText</span>&nbsp;<span class="op" id="3005121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3005125">err</span>&nbsp;<span class="op" id="3005129">=</span>&nbsp;<span class="op" id="3005131">&amp;</span><span class="ident" id="3005132">Error</span><span class="op" id="3005137">{</span><span class="ident" id="3005138">ErrEndContext</span><span class="op" id="3005151">,</span>&nbsp;<span class="builtintype" id="3005153">nil</span><span class="op" id="3005156">,</span>&nbsp;<span class="ident" id="3005158">name</span><span class="op" id="3005162">,</span>&nbsp;<span class="num" id="3005164">0</span><span class="op" id="3005165">,</span>&nbsp;<span class="ident" id="3005167">fmt</span><span class="op" id="3005170">.</span><span class="ident" id="3005171">Sprintf</span><span class="op" id="3005178">(</span><span class="string" id="3005179">&#34;ends&nbsp;in&nbsp;a&nbsp;non-text&nbsp;context:&nbsp;%v&#34;</span><span class="op" id="3005211">,</span>&nbsp;<span class="ident" id="3005213">c</span><span class="op" id="3005214">)</span><span class="op" id="3005215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3005218">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3005221">if</span>&nbsp;<span class="ident" id="3005224">err</span>&nbsp;<span class="op" id="3005228">!=</span>&nbsp;<span class="builtintype" id="3005231">nil</span>&nbsp;<span class="op" id="3005235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3005239">//&nbsp;Prevent&nbsp;execution&nbsp;of&nbsp;unsafe&nbsp;templates.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3005283">if</span>&nbsp;<span class="ident" id="3005286">t</span>&nbsp;<span class="op" id="3005288">:=</span>&nbsp;<span class="ident" id="3005291">tmpl</span><span class="op" id="3005295">.</span><span class="ident" id="3005296">set</span><span class="op" id="3005299">[</span><span class="ident" id="3005300">name</span><span class="op" id="3005304">]</span><span class="op" id="3005305">;</span>&nbsp;<span class="ident" id="3005307">t</span>&nbsp;<span class="op" id="3005309">!=</span>&nbsp;<span class="builtintype" id="3005312">nil</span>&nbsp;<span class="op" id="3005316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3005321">t</span><span class="op" id="3005322">.</span><span class="ident" id="3005323">escapeErr</span>&nbsp;<span class="op" id="3005333">=</span>&nbsp;<span class="ident" id="3005335">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3005342">t</span><span class="op" id="3005343">.</span><span class="ident" id="3005344">text</span><span class="op" id="3005348">.</span><span class="ident" id="3005349">Tree</span>&nbsp;<span class="op" id="3005354">=</span>&nbsp;<span class="builtintype" id="3005356">nil</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3005363">t</span><span class="op" id="3005364">.</span><span class="ident" id="3005365">Tree</span>&nbsp;<span class="op" id="3005370">=</span>&nbsp;<span class="builtintype" id="3005372">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3005378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3005382">return</span>&nbsp;<span class="ident" id="3005389">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3005394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3005397">e</span><span class="op" id="3005398">.</span><span class="ident" id="3005399">commit</span><span class="op" id="3005405">(</span><span class="op" id="3005406">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3005409">if</span>&nbsp;<span class="ident" id="3005412">t</span>&nbsp;<span class="op" id="3005414">:=</span>&nbsp;<span class="ident" id="3005417">tmpl</span><span class="op" id="3005421">.</span><span class="ident" id="3005422">set</span><span class="op" id="3005425">[</span><span class="ident" id="3005426">name</span><span class="op" id="3005430">]</span><span class="op" id="3005431">;</span>&nbsp;<span class="ident" id="3005433">t</span>&nbsp;<span class="op" id="3005435">!=</span>&nbsp;<span class="builtintype" id="3005438">nil</span>&nbsp;<span class="op" id="3005442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3005446">t</span><span class="op" id="3005447">.</span><span class="ident" id="3005448">escapeErr</span>&nbsp;<span class="op" id="3005458">=</span>&nbsp;<span class="ident" id="3005460">escapeOK</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3005471">t</span><span class="op" id="3005472">.</span><span class="ident" id="3005473">Tree</span>&nbsp;<span class="op" id="3005478">=</span>&nbsp;<span class="ident" id="3005480">t</span><span class="op" id="3005481">.</span><span class="ident" id="3005482">text</span><span class="op" id="3005486">.</span><span class="ident" id="3005487">Tree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3005493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3005496">return</span>&nbsp;<span class="builtintype" id="3005503">nil</span><br>
<span class="lineno">45</span><span class="op" id="3005507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3005510">//&nbsp;funcMap&nbsp;maps&nbsp;command&nbsp;names&nbsp;to&nbsp;functions&nbsp;that&nbsp;render&nbsp;their&nbsp;inputs&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="3005584">var</span>&nbsp;<span class="ident" id="3005588">funcMap</span>&nbsp;<span class="op" id="3005596">=</span>&nbsp;<span class="ident" id="3005598">template</span><span class="op" id="3005606">.</span><span class="ident" id="3005607">FuncMap</span><span class="op" id="3005614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3005617">&#34;html_template_attrescaper&#34;</span><span class="op" id="3005644">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3005650">attrEscaper</span><span class="op" id="3005661">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3005664">&#34;html_template_commentescaper&#34;</span><span class="op" id="3005694">:</span>&nbsp;&nbsp;<span class="ident" id="3005697">commentEscaper</span><span class="op" id="3005711">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3005714">&#34;html_template_cssescaper&#34;</span><span class="op" id="3005740">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3005747">cssEscaper</span><span class="op" id="3005757">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3005760">&#34;html_template_cssvaluefilter&#34;</span><span class="op" id="3005790">:</span>&nbsp;&nbsp;<span class="ident" id="3005793">cssValueFilter</span><span class="op" id="3005807">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3005810">&#34;html_template_htmlnamefilter&#34;</span><span class="op" id="3005840">:</span>&nbsp;&nbsp;<span class="ident" id="3005843">htmlNameFilter</span><span class="op" id="3005857">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3005860">&#34;html_template_htmlescaper&#34;</span><span class="op" id="3005887">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3005893">htmlEscaper</span><span class="op" id="3005904">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3005907">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="3005938">:</span>&nbsp;<span class="ident" id="3005940">jsRegexpEscaper</span><span class="op" id="3005955">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3005958">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="3005986">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3005991">jsStrEscaper</span><span class="op" id="3006003">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3006006">&#34;html_template_jsvalescaper&#34;</span><span class="op" id="3006034">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3006039">jsValEscaper</span><span class="op" id="3006051">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3006054">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="3006084">:</span>&nbsp;&nbsp;<span class="ident" id="3006087">htmlNospaceEscaper</span><span class="op" id="3006105">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3006108">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="3006137">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3006141">rcdataEscaper</span><span class="op" id="3006154">,</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3006157">&#34;html_template_urlescaper&#34;</span><span class="op" id="3006183">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3006190">urlEscaper</span><span class="op" id="3006200">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3006203">&#34;html_template_urlfilter&#34;</span><span class="op" id="3006228">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3006236">urlFilter</span><span class="op" id="3006245">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3006248">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="3006277">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3006281">urlNormalizer</span><span class="op" id="3006294">,</span><br>
<span class="lineno"></span><span class="op" id="3006296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3006299">//&nbsp;equivEscapers&nbsp;matches&nbsp;contextual&nbsp;escapers&nbsp;to&nbsp;equivalent&nbsp;template&nbsp;builtins.</span><br>
<span class="lineno"></span><span class="keyword" id="3006377">var</span>&nbsp;<span class="ident" id="3006381">equivEscapers</span>&nbsp;<span class="op" id="3006395">=</span>&nbsp;<span class="keyword" id="3006397">map</span><span class="op" id="3006400">[</span><span class="builtintype" id="3006401">string</span><span class="op" id="3006407">]</span><span class="builtintype" id="3006408">string</span><span class="op" id="3006414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3006417">&#34;html_template_attrescaper&#34;</span><span class="op" id="3006444">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3006449">&#34;html&#34;</span><span class="op" id="3006455">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3006458">&#34;html_template_htmlescaper&#34;</span><span class="op" id="3006485">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3006490">&#34;html&#34;</span><span class="op" id="3006496">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3006499">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="3006529">:</span>&nbsp;<span class="string" id="3006531">&#34;html&#34;</span><span class="op" id="3006537">,</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3006540">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="3006569">:</span>&nbsp;&nbsp;<span class="string" id="3006572">&#34;html&#34;</span><span class="op" id="3006578">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3006581">&#34;html_template_urlescaper&#34;</span><span class="op" id="3006607">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3006613">&#34;urlquery&#34;</span><span class="op" id="3006623">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3006626">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="3006655">:</span>&nbsp;&nbsp;<span class="string" id="3006658">&#34;urlquery&#34;</span><span class="op" id="3006668">,</span><br>
<span class="lineno"></span><span class="op" id="3006670">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="3006673">//&nbsp;escaper&nbsp;collects&nbsp;type&nbsp;inferences&nbsp;about&nbsp;templates&nbsp;and&nbsp;changes&nbsp;needed&nbsp;to&nbsp;make</span><br>
<span class="lineno"></span><span class="comment" id="3006752">//&nbsp;templates&nbsp;injection&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="3006781">type</span>&nbsp;<span class="ident" id="3006786">escaper</span>&nbsp;<span class="keyword" id="3006794">struct</span>&nbsp;<span class="op" id="3006801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3006804">tmpl</span>&nbsp;<span class="op" id="3006809">*</span><span class="ident" id="3006810">Template</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3006820">//&nbsp;output[templateName]&nbsp;is&nbsp;the&nbsp;output&nbsp;context&nbsp;for&nbsp;a&nbsp;templateName&nbsp;that</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3006891">//&nbsp;has&nbsp;been&nbsp;mangled&nbsp;to&nbsp;include&nbsp;its&nbsp;input&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3006942">output</span>&nbsp;<span class="keyword" id="3006949">map</span><span class="op" id="3006952">[</span><span class="builtintype" id="3006953">string</span><span class="op" id="3006959">]</span><span class="ident" id="3006960">context</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3006969">//&nbsp;derived[c.mangle(name)]&nbsp;maps&nbsp;to&nbsp;a&nbsp;template&nbsp;derived&nbsp;from&nbsp;the&nbsp;template</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3007042">//&nbsp;named&nbsp;name&nbsp;templateName&nbsp;for&nbsp;the&nbsp;start&nbsp;context&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3007095">derived</span>&nbsp;<span class="keyword" id="3007103">map</span><span class="op" id="3007106">[</span><span class="builtintype" id="3007107">string</span><span class="op" id="3007113">]</span><span class="op" id="3007114">*</span><span class="ident" id="3007115">template</span><span class="op" id="3007123">.</span><span class="ident" id="3007124">Template</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3007134">//&nbsp;called[templateName]&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;called&nbsp;mangled&nbsp;template&nbsp;names.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3007202">called</span>&nbsp;<span class="keyword" id="3007209">map</span><span class="op" id="3007212">[</span><span class="builtintype" id="3007213">string</span><span class="op" id="3007219">]</span><span class="builtintype" id="3007220">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3007226">//&nbsp;xxxNodeEdits&nbsp;are&nbsp;the&nbsp;accumulated&nbsp;edits&nbsp;to&nbsp;apply&nbsp;during&nbsp;commit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3007293">//&nbsp;Such&nbsp;edits&nbsp;are&nbsp;not&nbsp;applied&nbsp;immediately&nbsp;in&nbsp;case&nbsp;a&nbsp;template&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3007359">//&nbsp;executes&nbsp;a&nbsp;given&nbsp;template&nbsp;in&nbsp;different&nbsp;escaping&nbsp;contexts.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3007421">actionNodeEdits</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="3007439">map</span><span class="op" id="3007442">[</span><span class="op" id="3007443">*</span><span class="ident" id="3007444">parse</span><span class="op" id="3007449">.</span><span class="ident" id="3007450">ActionNode</span><span class="op" id="3007460">]</span><span class="op" id="3007461">[</span><span class="op" id="3007462">]</span><span class="builtintype" id="3007463">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3007471">templateNodeEdits</span>&nbsp;<span class="keyword" id="3007489">map</span><span class="op" id="3007492">[</span><span class="op" id="3007493">*</span><span class="ident" id="3007494">parse</span><span class="op" id="3007499">.</span><span class="ident" id="3007500">TemplateNode</span><span class="op" id="3007512">]</span><span class="builtintype" id="3007513">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3007521">textNodeEdits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3007539">map</span><span class="op" id="3007542">[</span><span class="op" id="3007543">*</span><span class="ident" id="3007544">parse</span><span class="op" id="3007549">.</span><span class="ident" id="3007550">TextNode</span><span class="op" id="3007558">]</span><span class="op" id="3007559">[</span><span class="op" id="3007560">]</span><span class="builtintype" id="3007561">byte</span><br>
<span class="lineno"></span><span class="op" id="3007566">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="3007569">//&nbsp;newEscaper&nbsp;creates&nbsp;a&nbsp;blank&nbsp;escaper&nbsp;for&nbsp;the&nbsp;given&nbsp;set.</span><br>
<span class="lineno"></span><span class="keyword" id="3007626">func</span>&nbsp;<span class="ident" id="3007631">newEscaper</span><span class="op" id="3007641">(</span><span class="ident" id="3007642">t</span>&nbsp;<span class="op" id="3007644">*</span><span class="ident" id="3007645">Template</span><span class="op" id="3007653">)</span>&nbsp;<span class="op" id="3007655">*</span><span class="ident" id="3007656">escaper</span>&nbsp;<span class="op" id="3007664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3007667">return</span>&nbsp;<span class="op" id="3007674">&amp;</span><span class="ident" id="3007675">escaper</span><span class="op" id="3007682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3007686">t</span><span class="op" id="3007687">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3007691">map</span><span class="op" id="3007694">[</span><span class="builtintype" id="3007695">string</span><span class="op" id="3007701">]</span><span class="ident" id="3007702">context</span><span class="op" id="3007709">{</span><span class="op" id="3007710">}</span><span class="op" id="3007711">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3007715">map</span><span class="op" id="3007718">[</span><span class="builtintype" id="3007719">string</span><span class="op" id="3007725">]</span><span class="op" id="3007726">*</span><span class="ident" id="3007727">template</span><span class="op" id="3007735">.</span><span class="ident" id="3007736">Template</span><span class="op" id="3007744">{</span><span class="op" id="3007745">}</span><span class="op" id="3007746">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3007750">map</span><span class="op" id="3007753">[</span><span class="builtintype" id="3007754">string</span><span class="op" id="3007760">]</span><span class="builtintype" id="3007761">bool</span><span class="op" id="3007765">{</span><span class="op" id="3007766">}</span><span class="op" id="3007767">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3007771">map</span><span class="op" id="3007774">[</span><span class="op" id="3007775">*</span><span class="ident" id="3007776">parse</span><span class="op" id="3007781">.</span><span class="ident" id="3007782">ActionNode</span><span class="op" id="3007792">]</span><span class="op" id="3007793">[</span><span class="op" id="3007794">]</span><span class="builtintype" id="3007795">string</span><span class="op" id="3007801">{</span><span class="op" id="3007802">}</span><span class="op" id="3007803">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3007807">map</span><span class="op" id="3007810">[</span><span class="op" id="3007811">*</span><span class="ident" id="3007812">parse</span><span class="op" id="3007817">.</span><span class="ident" id="3007818">TemplateNode</span><span class="op" id="3007830">]</span><span class="builtintype" id="3007831">string</span><span class="op" id="3007837">{</span><span class="op" id="3007838">}</span><span class="op" id="3007839">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3007843">map</span><span class="op" id="3007846">[</span><span class="op" id="3007847">*</span><span class="ident" id="3007848">parse</span><span class="op" id="3007853">.</span><span class="ident" id="3007854">TextNode</span><span class="op" id="3007862">]</span><span class="op" id="3007863">[</span><span class="op" id="3007864">]</span><span class="builtintype" id="3007865">byte</span><span class="op" id="3007869">{</span><span class="op" id="3007870">}</span><span class="op" id="3007871">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3007874">}</span><br>
<span class="lineno"></span><span class="op" id="3007876">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3007879">//&nbsp;filterFailsafe&nbsp;is&nbsp;an&nbsp;innocuous&nbsp;word&nbsp;that&nbsp;is&nbsp;emitted&nbsp;in&nbsp;place&nbsp;of&nbsp;unsafe&nbsp;values</span><br>
<span class="lineno"></span><span class="comment" id="3007960">//&nbsp;by&nbsp;sanitizer&nbsp;functions.&nbsp;It&nbsp;is&nbsp;not&nbsp;a&nbsp;keyword&nbsp;in&nbsp;any&nbsp;programming&nbsp;language,</span><br>
<span class="lineno">110</span><span class="comment" id="3008036">//&nbsp;contains&nbsp;no&nbsp;special&nbsp;characters,&nbsp;is&nbsp;not&nbsp;empty,&nbsp;and&nbsp;when&nbsp;it&nbsp;appears&nbsp;in&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="3008115">//&nbsp;it&nbsp;is&nbsp;distinct&nbsp;enough&nbsp;that&nbsp;a&nbsp;developer&nbsp;can&nbsp;find&nbsp;the&nbsp;source&nbsp;of&nbsp;the&nbsp;problem</span><br>
<span class="lineno"></span><span class="comment" id="3008192">//&nbsp;via&nbsp;a&nbsp;search&nbsp;engine.</span><br>
<span class="lineno"></span><span class="keyword" id="3008216">const</span>&nbsp;<span class="ident" id="3008222">filterFailsafe</span>&nbsp;<span class="op" id="3008237">=</span>&nbsp;<span class="string" id="3008239">&#34;ZgotmplZ&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="comment" id="3008251">//&nbsp;escape&nbsp;escapes&nbsp;a&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="3008286">func</span>&nbsp;<span class="op" id="3008291">(</span><span class="ident" id="3008292">e</span>&nbsp;<span class="op" id="3008294">*</span><span class="ident" id="3008295">escaper</span><span class="op" id="3008302">)</span>&nbsp;<span class="ident" id="3008304">escape</span><span class="op" id="3008310">(</span><span class="ident" id="3008311">c</span>&nbsp;<span class="ident" id="3008313">context</span><span class="op" id="3008320">,</span>&nbsp;<span class="ident" id="3008322">n</span>&nbsp;<span class="ident" id="3008324">parse</span><span class="op" id="3008329">.</span><span class="ident" id="3008330">Node</span><span class="op" id="3008334">)</span>&nbsp;<span class="ident" id="3008336">context</span>&nbsp;<span class="op" id="3008344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3008347">switch</span>&nbsp;<span class="ident" id="3008354">n</span>&nbsp;<span class="op" id="3008356">:=</span>&nbsp;<span class="ident" id="3008359">n</span><span class="op" id="3008360">.</span><span class="op" id="3008361">(</span><span class="keyword" id="3008362">type</span><span class="op" id="3008366">)</span>&nbsp;<span class="op" id="3008368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3008371">case</span>&nbsp;<span class="op" id="3008376">*</span><span class="ident" id="3008377">parse</span><span class="op" id="3008382">.</span><span class="ident" id="3008383">ActionNode</span><span class="op" id="3008393">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3008397">return</span>&nbsp;<span class="ident" id="3008404">e</span><span class="op" id="3008405">.</span><span class="ident" id="3008406">escapeAction</span><span class="op" id="3008418">(</span><span class="ident" id="3008419">c</span><span class="op" id="3008420">,</span>&nbsp;<span class="ident" id="3008422">n</span><span class="op" id="3008423">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3008426">case</span>&nbsp;<span class="op" id="3008431">*</span><span class="ident" id="3008432">parse</span><span class="op" id="3008437">.</span><span class="ident" id="3008438">IfNode</span><span class="op" id="3008444">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3008448">return</span>&nbsp;<span class="ident" id="3008455">e</span><span class="op" id="3008456">.</span><span class="ident" id="3008457">escapeBranch</span><span class="op" id="3008469">(</span><span class="ident" id="3008470">c</span><span class="op" id="3008471">,</span>&nbsp;<span class="op" id="3008473">&amp;</span><span class="ident" id="3008474">n</span><span class="op" id="3008475">.</span><span class="ident" id="3008476">BranchNode</span><span class="op" id="3008486">,</span>&nbsp;<span class="string" id="3008488">&#34;if&#34;</span><span class="op" id="3008492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3008495">case</span>&nbsp;<span class="op" id="3008500">*</span><span class="ident" id="3008501">parse</span><span class="op" id="3008506">.</span><span class="ident" id="3008507">ListNode</span><span class="op" id="3008515">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3008519">return</span>&nbsp;<span class="ident" id="3008526">e</span><span class="op" id="3008527">.</span><span class="ident" id="3008528">escapeList</span><span class="op" id="3008538">(</span><span class="ident" id="3008539">c</span><span class="op" id="3008540">,</span>&nbsp;<span class="ident" id="3008542">n</span><span class="op" id="3008543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3008546">case</span>&nbsp;<span class="op" id="3008551">*</span><span class="ident" id="3008552">parse</span><span class="op" id="3008557">.</span><span class="ident" id="3008558">RangeNode</span><span class="op" id="3008567">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3008571">return</span>&nbsp;<span class="ident" id="3008578">e</span><span class="op" id="3008579">.</span><span class="ident" id="3008580">escapeBranch</span><span class="op" id="3008592">(</span><span class="ident" id="3008593">c</span><span class="op" id="3008594">,</span>&nbsp;<span class="op" id="3008596">&amp;</span><span class="ident" id="3008597">n</span><span class="op" id="3008598">.</span><span class="ident" id="3008599">BranchNode</span><span class="op" id="3008609">,</span>&nbsp;<span class="string" id="3008611">&#34;range&#34;</span><span class="op" id="3008618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3008621">case</span>&nbsp;<span class="op" id="3008626">*</span><span class="ident" id="3008627">parse</span><span class="op" id="3008632">.</span><span class="ident" id="3008633">TemplateNode</span><span class="op" id="3008645">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3008649">return</span>&nbsp;<span class="ident" id="3008656">e</span><span class="op" id="3008657">.</span><span class="ident" id="3008658">escapeTemplate</span><span class="op" id="3008672">(</span><span class="ident" id="3008673">c</span><span class="op" id="3008674">,</span>&nbsp;<span class="ident" id="3008676">n</span><span class="op" id="3008677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3008680">case</span>&nbsp;<span class="op" id="3008685">*</span><span class="ident" id="3008686">parse</span><span class="op" id="3008691">.</span><span class="ident" id="3008692">TextNode</span><span class="op" id="3008700">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3008704">return</span>&nbsp;<span class="ident" id="3008711">e</span><span class="op" id="3008712">.</span><span class="ident" id="3008713">escapeText</span><span class="op" id="3008723">(</span><span class="ident" id="3008724">c</span><span class="op" id="3008725">,</span>&nbsp;<span class="ident" id="3008727">n</span><span class="op" id="3008728">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3008731">case</span>&nbsp;<span class="op" id="3008736">*</span><span class="ident" id="3008737">parse</span><span class="op" id="3008742">.</span><span class="ident" id="3008743">WithNode</span><span class="op" id="3008751">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3008755">return</span>&nbsp;<span class="ident" id="3008762">e</span><span class="op" id="3008763">.</span><span class="ident" id="3008764">escapeBranch</span><span class="op" id="3008776">(</span><span class="ident" id="3008777">c</span><span class="op" id="3008778">,</span>&nbsp;<span class="op" id="3008780">&amp;</span><span class="ident" id="3008781">n</span><span class="op" id="3008782">.</span><span class="ident" id="3008783">BranchNode</span><span class="op" id="3008793">,</span>&nbsp;<span class="string" id="3008795">&#34;with&#34;</span><span class="op" id="3008801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3008804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3008807">panic</span><span class="op" id="3008812">(</span><span class="string" id="3008813">&#34;escaping&nbsp;&#34;</span>&nbsp;<span class="op" id="3008825">+</span>&nbsp;<span class="ident" id="3008827">n</span><span class="op" id="3008828">.</span><span class="ident" id="3008829">String</span><span class="op" id="3008835">(</span><span class="op" id="3008836">)</span>&nbsp;<span class="op" id="3008838">+</span>&nbsp;<span class="string" id="3008840">&#34;&nbsp;is&nbsp;unimplemented&#34;</span><span class="op" id="3008859">)</span><br>
<span class="lineno"></span><span class="op" id="3008861">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="comment" id="3008864">//&nbsp;escapeAction&nbsp;escapes&nbsp;an&nbsp;action&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="3008913">func</span>&nbsp;<span class="op" id="3008918">(</span><span class="ident" id="3008919">e</span>&nbsp;<span class="op" id="3008921">*</span><span class="ident" id="3008922">escaper</span><span class="op" id="3008929">)</span>&nbsp;<span class="ident" id="3008931">escapeAction</span><span class="op" id="3008943">(</span><span class="ident" id="3008944">c</span>&nbsp;<span class="ident" id="3008946">context</span><span class="op" id="3008953">,</span>&nbsp;<span class="ident" id="3008955">n</span>&nbsp;<span class="op" id="3008957">*</span><span class="ident" id="3008958">parse</span><span class="op" id="3008963">.</span><span class="ident" id="3008964">ActionNode</span><span class="op" id="3008974">)</span>&nbsp;<span class="ident" id="3008976">context</span>&nbsp;<span class="op" id="3008984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3008987">if</span>&nbsp;<span class="builtinfunc" id="3008990">len</span><span class="op" id="3008993">(</span><span class="ident" id="3008994">n</span><span class="op" id="3008995">.</span><span class="ident" id="3008996">Pipe</span><span class="op" id="3009000">.</span><span class="ident" id="3009001">Decl</span><span class="op" id="3009005">)</span>&nbsp;<span class="op" id="3009007">!=</span>&nbsp;<span class="num" id="3009010">0</span>&nbsp;<span class="op" id="3009012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3009016">//&nbsp;A&nbsp;local&nbsp;variable&nbsp;assignment,&nbsp;not&nbsp;an&nbsp;interpolation.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3009072">return</span>&nbsp;<span class="ident" id="3009079">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3009082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3009085">c</span>&nbsp;<span class="op" id="3009087">=</span>&nbsp;<span class="ident" id="3009089">nudge</span><span class="op" id="3009094">(</span><span class="ident" id="3009095">c</span><span class="op" id="3009096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3009099">s</span>&nbsp;<span class="op" id="3009101">:=</span>&nbsp;<span class="builtinfunc" id="3009104">make</span><span class="op" id="3009108">(</span><span class="op" id="3009109">[</span><span class="op" id="3009110">]</span><span class="builtintype" id="3009111">string</span><span class="op" id="3009117">,</span>&nbsp;<span class="num" id="3009119">0</span><span class="op" id="3009120">,</span>&nbsp;<span class="num" id="3009122">3</span><span class="op" id="3009123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3009126">switch</span>&nbsp;<span class="ident" id="3009133">c</span><span class="op" id="3009134">.</span><span class="ident" id="3009135">state</span>&nbsp;<span class="op" id="3009141">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3009144">case</span>&nbsp;<span class="ident" id="3009149">stateError</span><span class="op" id="3009159">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3009163">return</span>&nbsp;<span class="ident" id="3009170">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3009173">case</span>&nbsp;<span class="ident" id="3009178">stateURL</span><span class="op" id="3009186">,</span>&nbsp;<span class="ident" id="3009188">stateCSSDqStr</span><span class="op" id="3009201">,</span>&nbsp;<span class="ident" id="3009203">stateCSSSqStr</span><span class="op" id="3009216">,</span>&nbsp;<span class="ident" id="3009218">stateCSSDqURL</span><span class="op" id="3009231">,</span>&nbsp;<span class="ident" id="3009233">stateCSSSqURL</span><span class="op" id="3009246">,</span>&nbsp;<span class="ident" id="3009248">stateCSSURL</span><span class="op" id="3009259">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3009263">switch</span>&nbsp;<span class="ident" id="3009270">c</span><span class="op" id="3009271">.</span><span class="ident" id="3009272">urlPart</span>&nbsp;<span class="op" id="3009280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3009284">case</span>&nbsp;<span class="ident" id="3009289">urlPartNone</span><span class="op" id="3009300">:</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3009305">s</span>&nbsp;<span class="op" id="3009307">=</span>&nbsp;<span class="builtinfunc" id="3009309">append</span><span class="op" id="3009315">(</span><span class="ident" id="3009316">s</span><span class="op" id="3009317">,</span>&nbsp;<span class="string" id="3009319">&#34;html_template_urlfilter&#34;</span><span class="op" id="3009344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3009349">fallthrough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3009363">case</span>&nbsp;<span class="ident" id="3009368">urlPartPreQuery</span><span class="op" id="3009383">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3009388">switch</span>&nbsp;<span class="ident" id="3009395">c</span><span class="op" id="3009396">.</span><span class="ident" id="3009397">state</span>&nbsp;<span class="op" id="3009403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3009408">case</span>&nbsp;<span class="ident" id="3009413">stateCSSDqStr</span><span class="op" id="3009426">,</span>&nbsp;<span class="ident" id="3009428">stateCSSSqStr</span><span class="op" id="3009441">:</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3009447">s</span>&nbsp;<span class="op" id="3009449">=</span>&nbsp;<span class="builtinfunc" id="3009451">append</span><span class="op" id="3009457">(</span><span class="ident" id="3009458">s</span><span class="op" id="3009459">,</span>&nbsp;<span class="string" id="3009461">&#34;html_template_cssescaper&#34;</span><span class="op" id="3009487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3009492">default</span><span class="op" id="3009499">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3009505">s</span>&nbsp;<span class="op" id="3009507">=</span>&nbsp;<span class="builtinfunc" id="3009509">append</span><span class="op" id="3009515">(</span><span class="ident" id="3009516">s</span><span class="op" id="3009517">,</span>&nbsp;<span class="string" id="3009519">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="3009548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3009553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3009557">case</span>&nbsp;<span class="ident" id="3009562">urlPartQueryOrFrag</span><span class="op" id="3009580">:</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3009585">s</span>&nbsp;<span class="op" id="3009587">=</span>&nbsp;<span class="builtinfunc" id="3009589">append</span><span class="op" id="3009595">(</span><span class="ident" id="3009596">s</span><span class="op" id="3009597">,</span>&nbsp;<span class="string" id="3009599">&#34;html_template_urlescaper&#34;</span><span class="op" id="3009625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3009629">case</span>&nbsp;<span class="ident" id="3009634">urlPartUnknown</span><span class="op" id="3009648">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3009653">return</span>&nbsp;<span class="ident" id="3009660">context</span><span class="op" id="3009667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3009673">state</span><span class="op" id="3009678">:</span>&nbsp;<span class="ident" id="3009680">stateError</span><span class="op" id="3009690">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3009696">err</span><span class="op" id="3009699">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3009703">errorf</span><span class="op" id="3009709">(</span><span class="ident" id="3009710">ErrAmbigContext</span><span class="op" id="3009725">,</span>&nbsp;<span class="ident" id="3009727">n</span><span class="op" id="3009728">,</span>&nbsp;<span class="ident" id="3009730">n</span><span class="op" id="3009731">.</span><span class="ident" id="3009732">Line</span><span class="op" id="3009736">,</span>&nbsp;<span class="string" id="3009738">&#34;%s&nbsp;appears&nbsp;in&nbsp;an&nbsp;ambiguous&nbsp;URL&nbsp;context&#34;</span><span class="op" id="3009778">,</span>&nbsp;<span class="ident" id="3009780">n</span><span class="op" id="3009781">)</span><span class="op" id="3009782">,</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3009787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3009791">default</span><span class="op" id="3009798">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3009803">panic</span><span class="op" id="3009808">(</span><span class="ident" id="3009809">c</span><span class="op" id="3009810">.</span><span class="ident" id="3009811">urlPart</span><span class="op" id="3009818">.</span><span class="ident" id="3009819">String</span><span class="op" id="3009825">(</span><span class="op" id="3009826">)</span><span class="op" id="3009827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3009831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3009834">case</span>&nbsp;<span class="ident" id="3009839">stateJS</span><span class="op" id="3009846">:</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3009850">s</span>&nbsp;<span class="op" id="3009852">=</span>&nbsp;<span class="builtinfunc" id="3009854">append</span><span class="op" id="3009860">(</span><span class="ident" id="3009861">s</span><span class="op" id="3009862">,</span>&nbsp;<span class="string" id="3009864">&#34;html_template_jsvalescaper&#34;</span><span class="op" id="3009892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3009896">//&nbsp;A&nbsp;slash&nbsp;after&nbsp;a&nbsp;value&nbsp;starts&nbsp;a&nbsp;div&nbsp;operator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3009946">c</span><span class="op" id="3009947">.</span><span class="ident" id="3009948">jsCtx</span>&nbsp;<span class="op" id="3009954">=</span>&nbsp;<span class="ident" id="3009956">jsCtxDivOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3009968">case</span>&nbsp;<span class="ident" id="3009973">stateJSDqStr</span><span class="op" id="3009985">,</span>&nbsp;<span class="ident" id="3009987">stateJSSqStr</span><span class="op" id="3009999">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3010003">s</span>&nbsp;<span class="op" id="3010005">=</span>&nbsp;<span class="builtinfunc" id="3010007">append</span><span class="op" id="3010013">(</span><span class="ident" id="3010014">s</span><span class="op" id="3010015">,</span>&nbsp;<span class="string" id="3010017">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="3010045">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3010048">case</span>&nbsp;<span class="ident" id="3010053">stateJSRegexp</span><span class="op" id="3010066">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3010070">s</span>&nbsp;<span class="op" id="3010072">=</span>&nbsp;<span class="builtinfunc" id="3010074">append</span><span class="op" id="3010080">(</span><span class="ident" id="3010081">s</span><span class="op" id="3010082">,</span>&nbsp;<span class="string" id="3010084">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="3010115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3010118">case</span>&nbsp;<span class="ident" id="3010123">stateCSS</span><span class="op" id="3010131">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3010135">s</span>&nbsp;<span class="op" id="3010137">=</span>&nbsp;<span class="builtinfunc" id="3010139">append</span><span class="op" id="3010145">(</span><span class="ident" id="3010146">s</span><span class="op" id="3010147">,</span>&nbsp;<span class="string" id="3010149">&#34;html_template_cssvaluefilter&#34;</span><span class="op" id="3010179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3010182">case</span>&nbsp;<span class="ident" id="3010187">stateText</span><span class="op" id="3010196">:</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3010200">s</span>&nbsp;<span class="op" id="3010202">=</span>&nbsp;<span class="builtinfunc" id="3010204">append</span><span class="op" id="3010210">(</span><span class="ident" id="3010211">s</span><span class="op" id="3010212">,</span>&nbsp;<span class="string" id="3010214">&#34;html_template_htmlescaper&#34;</span><span class="op" id="3010241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3010244">case</span>&nbsp;<span class="ident" id="3010249">stateRCDATA</span><span class="op" id="3010260">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3010264">s</span>&nbsp;<span class="op" id="3010266">=</span>&nbsp;<span class="builtinfunc" id="3010268">append</span><span class="op" id="3010274">(</span><span class="ident" id="3010275">s</span><span class="op" id="3010276">,</span>&nbsp;<span class="string" id="3010278">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="3010307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3010310">case</span>&nbsp;<span class="ident" id="3010315">stateAttr</span><span class="op" id="3010324">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3010328">//&nbsp;Handled&nbsp;below&nbsp;in&nbsp;delim&nbsp;check.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3010362">case</span>&nbsp;<span class="ident" id="3010367">stateAttrName</span><span class="op" id="3010380">,</span>&nbsp;<span class="ident" id="3010382">stateTag</span><span class="op" id="3010390">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3010394">c</span><span class="op" id="3010395">.</span><span class="ident" id="3010396">state</span>&nbsp;<span class="op" id="3010402">=</span>&nbsp;<span class="ident" id="3010404">stateAttrName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3010420">s</span>&nbsp;<span class="op" id="3010422">=</span>&nbsp;<span class="builtinfunc" id="3010424">append</span><span class="op" id="3010430">(</span><span class="ident" id="3010431">s</span><span class="op" id="3010432">,</span>&nbsp;<span class="string" id="3010434">&#34;html_template_htmlnamefilter&#34;</span><span class="op" id="3010464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3010467">default</span><span class="op" id="3010474">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3010478">if</span>&nbsp;<span class="ident" id="3010481">isComment</span><span class="op" id="3010490">(</span><span class="ident" id="3010491">c</span><span class="op" id="3010492">.</span><span class="ident" id="3010493">state</span><span class="op" id="3010498">)</span>&nbsp;<span class="op" id="3010500">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3010505">s</span>&nbsp;<span class="op" id="3010507">=</span>&nbsp;<span class="builtinfunc" id="3010509">append</span><span class="op" id="3010515">(</span><span class="ident" id="3010516">s</span><span class="op" id="3010517">,</span>&nbsp;<span class="string" id="3010519">&#34;html_template_commentescaper&#34;</span><span class="op" id="3010549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3010553">}</span>&nbsp;<span class="keyword" id="3010555">else</span>&nbsp;<span class="op" id="3010560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3010565">panic</span><span class="op" id="3010570">(</span><span class="string" id="3010571">&#34;unexpected&nbsp;state&nbsp;&#34;</span>&nbsp;<span class="op" id="3010591">+</span>&nbsp;<span class="ident" id="3010593">c</span><span class="op" id="3010594">.</span><span class="ident" id="3010595">state</span><span class="op" id="3010600">.</span><span class="ident" id="3010601">String</span><span class="op" id="3010607">(</span><span class="op" id="3010608">)</span><span class="op" id="3010609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3010613">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3010616">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3010619">switch</span>&nbsp;<span class="ident" id="3010626">c</span><span class="op" id="3010627">.</span><span class="ident" id="3010628">delim</span>&nbsp;<span class="op" id="3010634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3010637">case</span>&nbsp;<span class="ident" id="3010642">delimNone</span><span class="op" id="3010651">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3010655">//&nbsp;No&nbsp;extra-escaping&nbsp;needed&nbsp;for&nbsp;raw&nbsp;text&nbsp;content.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3010706">case</span>&nbsp;<span class="ident" id="3010711">delimSpaceOrTagEnd</span><span class="op" id="3010729">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3010733">s</span>&nbsp;<span class="op" id="3010735">=</span>&nbsp;<span class="builtinfunc" id="3010737">append</span><span class="op" id="3010743">(</span><span class="ident" id="3010744">s</span><span class="op" id="3010745">,</span>&nbsp;<span class="string" id="3010747">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="3010777">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3010780">default</span><span class="op" id="3010787">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3010791">s</span>&nbsp;<span class="op" id="3010793">=</span>&nbsp;<span class="builtinfunc" id="3010795">append</span><span class="op" id="3010801">(</span><span class="ident" id="3010802">s</span><span class="op" id="3010803">,</span>&nbsp;<span class="string" id="3010805">&#34;html_template_attrescaper&#34;</span><span class="op" id="3010832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3010835">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3010838">e</span><span class="op" id="3010839">.</span><span class="ident" id="3010840">editActionNode</span><span class="op" id="3010854">(</span><span class="ident" id="3010855">n</span><span class="op" id="3010856">,</span>&nbsp;<span class="ident" id="3010858">s</span><span class="op" id="3010859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3010862">return</span>&nbsp;<span class="ident" id="3010869">c</span><br>
<span class="lineno">205</span><span class="op" id="3010871">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3010874">//&nbsp;allIdents&nbsp;returns&nbsp;the&nbsp;names&nbsp;of&nbsp;the&nbsp;identifiers&nbsp;under&nbsp;the&nbsp;Ident&nbsp;field&nbsp;of&nbsp;the&nbsp;node,</span><br>
<span class="lineno"></span><span class="comment" id="3010959">//&nbsp;which&nbsp;might&nbsp;be&nbsp;a&nbsp;singleton&nbsp;(Identifier)&nbsp;or&nbsp;a&nbsp;slice&nbsp;(Field).</span><br>
<span class="lineno"></span><span class="keyword" id="3011022">func</span>&nbsp;<span class="ident" id="3011027">allIdents</span><span class="op" id="3011036">(</span><span class="ident" id="3011037">node</span>&nbsp;<span class="ident" id="3011042">parse</span><span class="op" id="3011047">.</span><span class="ident" id="3011048">Node</span><span class="op" id="3011052">)</span>&nbsp;<span class="op" id="3011054">[</span><span class="op" id="3011055">]</span><span class="builtintype" id="3011056">string</span>&nbsp;<span class="op" id="3011063">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3011066">switch</span>&nbsp;<span class="ident" id="3011073">node</span>&nbsp;<span class="op" id="3011078">:=</span>&nbsp;<span class="ident" id="3011081">node</span><span class="op" id="3011085">.</span><span class="op" id="3011086">(</span><span class="keyword" id="3011087">type</span><span class="op" id="3011091">)</span>&nbsp;<span class="op" id="3011093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3011096">case</span>&nbsp;<span class="op" id="3011101">*</span><span class="ident" id="3011102">parse</span><span class="op" id="3011107">.</span><span class="ident" id="3011108">IdentifierNode</span><span class="op" id="3011122">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3011126">return</span>&nbsp;<span class="op" id="3011133">[</span><span class="op" id="3011134">]</span><span class="builtintype" id="3011135">string</span><span class="op" id="3011141">{</span><span class="ident" id="3011142">node</span><span class="op" id="3011146">.</span><span class="ident" id="3011147">Ident</span><span class="op" id="3011152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3011155">case</span>&nbsp;<span class="op" id="3011160">*</span><span class="ident" id="3011161">parse</span><span class="op" id="3011166">.</span><span class="ident" id="3011167">FieldNode</span><span class="op" id="3011176">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3011180">return</span>&nbsp;<span class="ident" id="3011187">node</span><span class="op" id="3011191">.</span><span class="ident" id="3011192">Ident</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3011199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3011202">panic</span><span class="op" id="3011207">(</span><span class="string" id="3011208">&#34;unidentified&nbsp;node&nbsp;type&nbsp;in&nbsp;allIdents&#34;</span><span class="op" id="3011245">)</span><br>
<span class="lineno"></span><span class="op" id="3011247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3011250">//&nbsp;ensurePipelineContains&nbsp;ensures&nbsp;that&nbsp;the&nbsp;pipeline&nbsp;has&nbsp;commands&nbsp;with</span><br>
<span class="lineno">220</span><span class="comment" id="3011320">//&nbsp;the&nbsp;identifiers&nbsp;in&nbsp;s&nbsp;in&nbsp;order.</span><br>
<span class="lineno"></span><span class="comment" id="3011354">//&nbsp;If&nbsp;the&nbsp;pipeline&nbsp;already&nbsp;has&nbsp;some&nbsp;of&nbsp;the&nbsp;sanitizers,&nbsp;do&nbsp;not&nbsp;interfere.</span><br>
<span class="lineno"></span><span class="comment" id="3011427">//&nbsp;For&nbsp;example,&nbsp;if&nbsp;p&nbsp;is&nbsp;(.X&nbsp;|&nbsp;html)&nbsp;and&nbsp;s&nbsp;is&nbsp;[&#34;escapeJSVal&#34;,&nbsp;&#34;html&#34;]&nbsp;then&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="3011504">//&nbsp;has&nbsp;one&nbsp;matching,&nbsp;&#34;html&#34;,&nbsp;and&nbsp;one&nbsp;to&nbsp;insert,&nbsp;&#34;escapeJSVal&#34;,&nbsp;to&nbsp;produce</span><br>
<span class="lineno"></span><span class="comment" id="3011578">//&nbsp;(.X&nbsp;|&nbsp;escapeJSVal&nbsp;|&nbsp;html).</span><br>
<span class="lineno">225</span><span class="keyword" id="3011608">func</span>&nbsp;<span class="ident" id="3011613">ensurePipelineContains</span><span class="op" id="3011635">(</span><span class="ident" id="3011636">p</span>&nbsp;<span class="op" id="3011638">*</span><span class="ident" id="3011639">parse</span><span class="op" id="3011644">.</span><span class="ident" id="3011645">PipeNode</span><span class="op" id="3011653">,</span>&nbsp;<span class="ident" id="3011655">s</span>&nbsp;<span class="op" id="3011657">[</span><span class="op" id="3011658">]</span><span class="builtintype" id="3011659">string</span><span class="op" id="3011665">)</span>&nbsp;<span class="op" id="3011667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3011670">if</span>&nbsp;<span class="builtinfunc" id="3011673">len</span><span class="op" id="3011676">(</span><span class="ident" id="3011677">s</span><span class="op" id="3011678">)</span>&nbsp;<span class="op" id="3011680">==</span>&nbsp;<span class="num" id="3011683">0</span>&nbsp;<span class="op" id="3011685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3011689">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3011697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3011700">n</span>&nbsp;<span class="op" id="3011702">:=</span>&nbsp;<span class="builtinfunc" id="3011705">len</span><span class="op" id="3011708">(</span><span class="ident" id="3011709">p</span><span class="op" id="3011710">.</span><span class="ident" id="3011711">Cmds</span><span class="op" id="3011715">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3011718">//&nbsp;Find&nbsp;the&nbsp;identifiers&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;command&nbsp;chain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3011776">idents</span>&nbsp;<span class="op" id="3011783">:=</span>&nbsp;<span class="ident" id="3011786">p</span><span class="op" id="3011787">.</span><span class="ident" id="3011788">Cmds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3011794">for</span>&nbsp;<span class="ident" id="3011798">i</span>&nbsp;<span class="op" id="3011800">:=</span>&nbsp;<span class="ident" id="3011803">n</span>&nbsp;<span class="op" id="3011805">-</span>&nbsp;<span class="num" id="3011807">1</span><span class="op" id="3011808">;</span>&nbsp;<span class="ident" id="3011810">i</span>&nbsp;<span class="op" id="3011812">&gt;=</span>&nbsp;<span class="num" id="3011815">0</span><span class="op" id="3011816">;</span>&nbsp;<span class="ident" id="3011818">i</span><span class="op" id="3011819">--</span>&nbsp;<span class="op" id="3011822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3011826">if</span>&nbsp;<span class="ident" id="3011829">cmd</span>&nbsp;<span class="op" id="3011833">:=</span>&nbsp;<span class="ident" id="3011836">p</span><span class="op" id="3011837">.</span><span class="ident" id="3011838">Cmds</span><span class="op" id="3011842">[</span><span class="ident" id="3011843">i</span><span class="op" id="3011844">]</span><span class="op" id="3011845">;</span>&nbsp;<span class="builtinfunc" id="3011847">len</span><span class="op" id="3011850">(</span><span class="ident" id="3011851">cmd</span><span class="op" id="3011854">.</span><span class="ident" id="3011855">Args</span><span class="op" id="3011859">)</span>&nbsp;<span class="op" id="3011861">!=</span>&nbsp;<span class="num" id="3011864">0</span>&nbsp;<span class="op" id="3011866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3011871">if</span>&nbsp;<span class="ident" id="3011874">_</span><span class="op" id="3011875">,</span>&nbsp;<span class="ident" id="3011877">ok</span>&nbsp;<span class="op" id="3011880">:=</span>&nbsp;<span class="ident" id="3011883">cmd</span><span class="op" id="3011886">.</span><span class="ident" id="3011887">Args</span><span class="op" id="3011891">[</span><span class="num" id="3011892">0</span><span class="op" id="3011893">]</span><span class="op" id="3011894">.</span><span class="op" id="3011895">(</span><span class="op" id="3011896">*</span><span class="ident" id="3011897">parse</span><span class="op" id="3011902">.</span><span class="ident" id="3011903">IdentifierNode</span><span class="op" id="3011917">)</span><span class="op" id="3011918">;</span>&nbsp;<span class="ident" id="3011920">ok</span>&nbsp;<span class="op" id="3011923">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3011929">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3011941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3011945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3011949">idents</span>&nbsp;<span class="op" id="3011956">=</span>&nbsp;<span class="ident" id="3011958">p</span><span class="op" id="3011959">.</span><span class="ident" id="3011960">Cmds</span><span class="op" id="3011964">[</span><span class="ident" id="3011965">i</span><span class="op" id="3011966">+</span><span class="num" id="3011967">1</span><span class="op" id="3011968">:</span><span class="op" id="3011969">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3011972">}</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3011975">dups</span>&nbsp;<span class="op" id="3011980">:=</span>&nbsp;<span class="num" id="3011983">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3011986">for</span>&nbsp;<span class="ident" id="3011990">_</span><span class="op" id="3011991">,</span>&nbsp;<span class="ident" id="3011993">idNode</span>&nbsp;<span class="op" id="3012000">:=</span>&nbsp;<span class="keyword" id="3012003">range</span>&nbsp;<span class="ident" id="3012009">idents</span>&nbsp;<span class="op" id="3012016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3012020">for</span>&nbsp;<span class="ident" id="3012024">_</span><span class="op" id="3012025">,</span>&nbsp;<span class="ident" id="3012027">ident</span>&nbsp;<span class="op" id="3012033">:=</span>&nbsp;<span class="keyword" id="3012036">range</span>&nbsp;<span class="ident" id="3012042">allIdents</span><span class="op" id="3012051">(</span><span class="ident" id="3012052">idNode</span><span class="op" id="3012058">.</span><span class="ident" id="3012059">Args</span><span class="op" id="3012063">[</span><span class="num" id="3012064">0</span><span class="op" id="3012065">]</span><span class="op" id="3012066">)</span>&nbsp;<span class="op" id="3012068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3012073">if</span>&nbsp;<span class="ident" id="3012076">escFnsEq</span><span class="op" id="3012084">(</span><span class="ident" id="3012085">s</span><span class="op" id="3012086">[</span><span class="ident" id="3012087">dups</span><span class="op" id="3012091">]</span><span class="op" id="3012092">,</span>&nbsp;<span class="ident" id="3012094">ident</span><span class="op" id="3012099">)</span>&nbsp;<span class="op" id="3012101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3012107">dups</span><span class="op" id="3012111">++</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3012118">if</span>&nbsp;<span class="ident" id="3012121">dups</span>&nbsp;<span class="op" id="3012126">==</span>&nbsp;<span class="builtinfunc" id="3012129">len</span><span class="op" id="3012132">(</span><span class="ident" id="3012133">s</span><span class="op" id="3012134">)</span>&nbsp;<span class="op" id="3012136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3012143">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3012154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3012159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3012163">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3012166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3012169">newCmds</span>&nbsp;<span class="op" id="3012177">:=</span>&nbsp;<span class="builtinfunc" id="3012180">make</span><span class="op" id="3012184">(</span><span class="op" id="3012185">[</span><span class="op" id="3012186">]</span><span class="op" id="3012187">*</span><span class="ident" id="3012188">parse</span><span class="op" id="3012193">.</span><span class="ident" id="3012194">CommandNode</span><span class="op" id="3012205">,</span>&nbsp;<span class="ident" id="3012207">n</span><span class="op" id="3012208">-</span><span class="builtinfunc" id="3012209">len</span><span class="op" id="3012212">(</span><span class="ident" id="3012213">idents</span><span class="op" id="3012219">)</span><span class="op" id="3012220">,</span>&nbsp;<span class="ident" id="3012222">n</span><span class="op" id="3012223">+</span><span class="builtinfunc" id="3012224">len</span><span class="op" id="3012227">(</span><span class="ident" id="3012228">s</span><span class="op" id="3012229">)</span><span class="op" id="3012230">-</span><span class="ident" id="3012231">dups</span><span class="op" id="3012235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3012238">copy</span><span class="op" id="3012242">(</span><span class="ident" id="3012243">newCmds</span><span class="op" id="3012250">,</span>&nbsp;<span class="ident" id="3012252">p</span><span class="op" id="3012253">.</span><span class="ident" id="3012254">Cmds</span><span class="op" id="3012258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3012261">//&nbsp;Merge&nbsp;existing&nbsp;identifier&nbsp;commands&nbsp;with&nbsp;the&nbsp;sanitizers&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3012328">for</span>&nbsp;<span class="ident" id="3012332">_</span><span class="op" id="3012333">,</span>&nbsp;<span class="ident" id="3012335">idNode</span>&nbsp;<span class="op" id="3012342">:=</span>&nbsp;<span class="keyword" id="3012345">range</span>&nbsp;<span class="ident" id="3012351">idents</span>&nbsp;<span class="op" id="3012358">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3012362">pos</span>&nbsp;<span class="op" id="3012366">:=</span>&nbsp;<span class="ident" id="3012369">idNode</span><span class="op" id="3012375">.</span><span class="ident" id="3012376">Args</span><span class="op" id="3012380">[</span><span class="num" id="3012381">0</span><span class="op" id="3012382">]</span><span class="op" id="3012383">.</span><span class="ident" id="3012384">Position</span><span class="op" id="3012392">(</span><span class="op" id="3012393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3012397">for</span>&nbsp;<span class="ident" id="3012401">_</span><span class="op" id="3012402">,</span>&nbsp;<span class="ident" id="3012404">ident</span>&nbsp;<span class="op" id="3012410">:=</span>&nbsp;<span class="keyword" id="3012413">range</span>&nbsp;<span class="ident" id="3012419">allIdents</span><span class="op" id="3012428">(</span><span class="ident" id="3012429">idNode</span><span class="op" id="3012435">.</span><span class="ident" id="3012436">Args</span><span class="op" id="3012440">[</span><span class="num" id="3012441">0</span><span class="op" id="3012442">]</span><span class="op" id="3012443">)</span>&nbsp;<span class="op" id="3012445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3012450">i</span>&nbsp;<span class="op" id="3012452">:=</span>&nbsp;<span class="ident" id="3012455">indexOfStr</span><span class="op" id="3012465">(</span><span class="ident" id="3012466">ident</span><span class="op" id="3012471">,</span>&nbsp;<span class="ident" id="3012473">s</span><span class="op" id="3012474">,</span>&nbsp;<span class="ident" id="3012476">escFnsEq</span><span class="op" id="3012484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3012489">if</span>&nbsp;<span class="ident" id="3012492">i</span>&nbsp;<span class="op" id="3012494">!=</span>&nbsp;<span class="op" id="3012497">-</span><span class="num" id="3012498">1</span>&nbsp;<span class="op" id="3012500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3012506">for</span>&nbsp;<span class="ident" id="3012510">_</span><span class="op" id="3012511">,</span>&nbsp;<span class="ident" id="3012513">name</span>&nbsp;<span class="op" id="3012518">:=</span>&nbsp;<span class="keyword" id="3012521">range</span>&nbsp;<span class="ident" id="3012527">s</span><span class="op" id="3012528">[</span><span class="op" id="3012529">:</span><span class="ident" id="3012530">i</span><span class="op" id="3012531">]</span>&nbsp;<span class="op" id="3012533">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3012540">newCmds</span>&nbsp;<span class="op" id="3012548">=</span>&nbsp;<span class="ident" id="3012550">appendCmd</span><span class="op" id="3012559">(</span><span class="ident" id="3012560">newCmds</span><span class="op" id="3012567">,</span>&nbsp;<span class="ident" id="3012569">newIdentCmd</span><span class="op" id="3012580">(</span><span class="ident" id="3012581">name</span><span class="op" id="3012585">,</span>&nbsp;<span class="ident" id="3012587">pos</span><span class="op" id="3012590">)</span><span class="op" id="3012591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3012597">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3012603">s</span>&nbsp;<span class="op" id="3012605">=</span>&nbsp;<span class="ident" id="3012607">s</span><span class="op" id="3012608">[</span><span class="ident" id="3012609">i</span><span class="op" id="3012610">+</span><span class="num" id="3012611">1</span><span class="op" id="3012612">:</span><span class="op" id="3012613">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3012618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3012622">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3012626">newCmds</span>&nbsp;<span class="op" id="3012634">=</span>&nbsp;<span class="ident" id="3012636">appendCmd</span><span class="op" id="3012645">(</span><span class="ident" id="3012646">newCmds</span><span class="op" id="3012653">,</span>&nbsp;<span class="ident" id="3012655">idNode</span><span class="op" id="3012661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3012664">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3012667">//&nbsp;Create&nbsp;any&nbsp;remaining&nbsp;sanitizers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3012704">for</span>&nbsp;<span class="ident" id="3012708">_</span><span class="op" id="3012709">,</span>&nbsp;<span class="ident" id="3012711">name</span>&nbsp;<span class="op" id="3012716">:=</span>&nbsp;<span class="keyword" id="3012719">range</span>&nbsp;<span class="ident" id="3012725">s</span>&nbsp;<span class="op" id="3012727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3012731">newCmds</span>&nbsp;<span class="op" id="3012739">=</span>&nbsp;<span class="ident" id="3012741">appendCmd</span><span class="op" id="3012750">(</span><span class="ident" id="3012751">newCmds</span><span class="op" id="3012758">,</span>&nbsp;<span class="ident" id="3012760">newIdentCmd</span><span class="op" id="3012771">(</span><span class="ident" id="3012772">name</span><span class="op" id="3012776">,</span>&nbsp;<span class="ident" id="3012778">p</span><span class="op" id="3012779">.</span><span class="ident" id="3012780">Position</span><span class="op" id="3012788">(</span><span class="op" id="3012789">)</span><span class="op" id="3012790">)</span><span class="op" id="3012791">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3012794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3012797">p</span><span class="op" id="3012798">.</span><span class="ident" id="3012799">Cmds</span>&nbsp;<span class="op" id="3012804">=</span>&nbsp;<span class="ident" id="3012806">newCmds</span><br>
<span class="lineno"></span><span class="op" id="3012814">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3012817">//&nbsp;redundantFuncs[a][b]&nbsp;implies&nbsp;that&nbsp;funcMap[b](funcMap[a](x))&nbsp;==&nbsp;funcMap[a](x)</span><br>
<span class="lineno">275</span><span class="comment" id="3012897">//&nbsp;for&nbsp;all&nbsp;x.</span><br>
<span class="lineno"></span><span class="keyword" id="3012911">var</span>&nbsp;<span class="ident" id="3012915">redundantFuncs</span>&nbsp;<span class="op" id="3012930">=</span>&nbsp;<span class="keyword" id="3012932">map</span><span class="op" id="3012935">[</span><span class="builtintype" id="3012936">string</span><span class="op" id="3012942">]</span><span class="keyword" id="3012943">map</span><span class="op" id="3012946">[</span><span class="builtintype" id="3012947">string</span><span class="op" id="3012953">]</span><span class="builtintype" id="3012954">bool</span><span class="op" id="3012958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3012961">&#34;html_template_commentescaper&#34;</span><span class="op" id="3012991">:</span>&nbsp;<span class="op" id="3012993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3012997">&#34;html_template_attrescaper&#34;</span><span class="op" id="3013024">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3013029">true</span><span class="op" id="3013033">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3013037">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="3013067">:</span>&nbsp;<span class="builtintype" id="3013069">true</span><span class="op" id="3013073">,</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3013077">&#34;html_template_htmlescaper&#34;</span><span class="op" id="3013104">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3013109">true</span><span class="op" id="3013113">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3013116">}</span><span class="op" id="3013117">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3013120">&#34;html_template_cssescaper&#34;</span><span class="op" id="3013146">:</span>&nbsp;<span class="op" id="3013148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3013152">&#34;html_template_attrescaper&#34;</span><span class="op" id="3013179">:</span>&nbsp;<span class="builtintype" id="3013181">true</span><span class="op" id="3013185">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3013188">}</span><span class="op" id="3013189">,</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3013192">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="3013223">:</span>&nbsp;<span class="op" id="3013225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3013229">&#34;html_template_attrescaper&#34;</span><span class="op" id="3013256">:</span>&nbsp;<span class="builtintype" id="3013258">true</span><span class="op" id="3013262">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3013265">}</span><span class="op" id="3013266">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3013269">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="3013297">:</span>&nbsp;<span class="op" id="3013299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3013303">&#34;html_template_attrescaper&#34;</span><span class="op" id="3013330">:</span>&nbsp;<span class="builtintype" id="3013332">true</span><span class="op" id="3013336">,</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3013339">}</span><span class="op" id="3013340">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3013343">&#34;html_template_urlescaper&#34;</span><span class="op" id="3013369">:</span>&nbsp;<span class="op" id="3013371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3013375">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="3013404">:</span>&nbsp;<span class="builtintype" id="3013406">true</span><span class="op" id="3013410">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3013413">}</span><span class="op" id="3013414">,</span><br>
<span class="lineno"></span><span class="op" id="3013416">}</span><br>
<span class="lineno">295</span><br>
<span class="lineno"></span><span class="comment" id="3013419">//&nbsp;appendCmd&nbsp;appends&nbsp;the&nbsp;given&nbsp;command&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;command&nbsp;pipeline</span><br>
<span class="lineno"></span><span class="comment" id="3013493">//&nbsp;unless&nbsp;it&nbsp;is&nbsp;redundant&nbsp;with&nbsp;the&nbsp;last&nbsp;command.</span><br>
<span class="lineno"></span><span class="keyword" id="3013542">func</span>&nbsp;<span class="ident" id="3013547">appendCmd</span><span class="op" id="3013556">(</span><span class="ident" id="3013557">cmds</span>&nbsp;<span class="op" id="3013562">[</span><span class="op" id="3013563">]</span><span class="op" id="3013564">*</span><span class="ident" id="3013565">parse</span><span class="op" id="3013570">.</span><span class="ident" id="3013571">CommandNode</span><span class="op" id="3013582">,</span>&nbsp;<span class="ident" id="3013584">cmd</span>&nbsp;<span class="op" id="3013588">*</span><span class="ident" id="3013589">parse</span><span class="op" id="3013594">.</span><span class="ident" id="3013595">CommandNode</span><span class="op" id="3013606">)</span>&nbsp;<span class="op" id="3013608">[</span><span class="op" id="3013609">]</span><span class="op" id="3013610">*</span><span class="ident" id="3013611">parse</span><span class="op" id="3013616">.</span><span class="ident" id="3013617">CommandNode</span>&nbsp;<span class="op" id="3013629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3013632">if</span>&nbsp;<span class="ident" id="3013635">n</span>&nbsp;<span class="op" id="3013637">:=</span>&nbsp;<span class="builtinfunc" id="3013640">len</span><span class="op" id="3013643">(</span><span class="ident" id="3013644">cmds</span><span class="op" id="3013648">)</span><span class="op" id="3013649">;</span>&nbsp;<span class="ident" id="3013651">n</span>&nbsp;<span class="op" id="3013653">!=</span>&nbsp;<span class="num" id="3013656">0</span>&nbsp;<span class="op" id="3013658">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3013662">last</span><span class="op" id="3013666">,</span>&nbsp;<span class="ident" id="3013668">ok</span>&nbsp;<span class="op" id="3013671">:=</span>&nbsp;<span class="ident" id="3013674">cmds</span><span class="op" id="3013678">[</span><span class="ident" id="3013679">n</span><span class="op" id="3013680">-</span><span class="num" id="3013681">1</span><span class="op" id="3013682">]</span><span class="op" id="3013683">.</span><span class="ident" id="3013684">Args</span><span class="op" id="3013688">[</span><span class="num" id="3013689">0</span><span class="op" id="3013690">]</span><span class="op" id="3013691">.</span><span class="op" id="3013692">(</span><span class="op" id="3013693">*</span><span class="ident" id="3013694">parse</span><span class="op" id="3013699">.</span><span class="ident" id="3013700">IdentifierNode</span><span class="op" id="3013714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3013718">next</span><span class="op" id="3013722">,</span>&nbsp;<span class="ident" id="3013724">_</span>&nbsp;<span class="op" id="3013726">:=</span>&nbsp;<span class="ident" id="3013729">cmd</span><span class="op" id="3013732">.</span><span class="ident" id="3013733">Args</span><span class="op" id="3013737">[</span><span class="num" id="3013738">0</span><span class="op" id="3013739">]</span><span class="op" id="3013740">.</span><span class="op" id="3013741">(</span><span class="op" id="3013742">*</span><span class="ident" id="3013743">parse</span><span class="op" id="3013748">.</span><span class="ident" id="3013749">IdentifierNode</span><span class="op" id="3013763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3013767">if</span>&nbsp;<span class="ident" id="3013770">ok</span>&nbsp;<span class="op" id="3013773">&amp;&amp;</span>&nbsp;<span class="ident" id="3013776">redundantFuncs</span><span class="op" id="3013790">[</span><span class="ident" id="3013791">last</span><span class="op" id="3013795">.</span><span class="ident" id="3013796">Ident</span><span class="op" id="3013801">]</span><span class="op" id="3013802">[</span><span class="ident" id="3013803">next</span><span class="op" id="3013807">.</span><span class="ident" id="3013808">Ident</span><span class="op" id="3013813">]</span>&nbsp;<span class="op" id="3013815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3013820">return</span>&nbsp;<span class="ident" id="3013827">cmds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3013834">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3013837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3013840">return</span>&nbsp;<span class="builtinfunc" id="3013847">append</span><span class="op" id="3013853">(</span><span class="ident" id="3013854">cmds</span><span class="op" id="3013858">,</span>&nbsp;<span class="ident" id="3013860">cmd</span><span class="op" id="3013863">)</span><br>
<span class="lineno"></span><span class="op" id="3013865">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3013868">//&nbsp;indexOfStr&nbsp;is&nbsp;the&nbsp;first&nbsp;i&nbsp;such&nbsp;that&nbsp;eq(s,&nbsp;strs[i])&nbsp;or&nbsp;-1&nbsp;if&nbsp;s&nbsp;was&nbsp;not&nbsp;found.</span><br>
<span class="lineno">310</span><span class="keyword" id="3013948">func</span>&nbsp;<span class="ident" id="3013953">indexOfStr</span><span class="op" id="3013963">(</span><span class="ident" id="3013964">s</span>&nbsp;<span class="builtintype" id="3013966">string</span><span class="op" id="3013972">,</span>&nbsp;<span class="ident" id="3013974">strs</span>&nbsp;<span class="op" id="3013979">[</span><span class="op" id="3013980">]</span><span class="builtintype" id="3013981">string</span><span class="op" id="3013987">,</span>&nbsp;<span class="ident" id="3013989">eq</span>&nbsp;<span class="keyword" id="3013992">func</span><span class="op" id="3013996">(</span><span class="ident" id="3013997">a</span><span class="op" id="3013998">,</span>&nbsp;<span class="ident" id="3014000">b</span>&nbsp;<span class="builtintype" id="3014002">string</span><span class="op" id="3014008">)</span>&nbsp;<span class="builtintype" id="3014010">bool</span><span class="op" id="3014014">)</span>&nbsp;<span class="builtintype" id="3014016">int</span>&nbsp;<span class="op" id="3014020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3014023">for</span>&nbsp;<span class="ident" id="3014027">i</span><span class="op" id="3014028">,</span>&nbsp;<span class="ident" id="3014030">t</span>&nbsp;<span class="op" id="3014032">:=</span>&nbsp;<span class="keyword" id="3014035">range</span>&nbsp;<span class="ident" id="3014041">strs</span>&nbsp;<span class="op" id="3014046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3014050">if</span>&nbsp;<span class="ident" id="3014053">eq</span><span class="op" id="3014055">(</span><span class="ident" id="3014056">s</span><span class="op" id="3014057">,</span>&nbsp;<span class="ident" id="3014059">t</span><span class="op" id="3014060">)</span>&nbsp;<span class="op" id="3014062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3014067">return</span>&nbsp;<span class="ident" id="3014074">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3014078">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3014081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3014084">return</span>&nbsp;<span class="op" id="3014091">-</span><span class="num" id="3014092">1</span><br>
<span class="lineno"></span><span class="op" id="3014094">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3014097">//&nbsp;escFnsEq&nbsp;reports&nbsp;whether&nbsp;the&nbsp;two&nbsp;escaping&nbsp;functions&nbsp;are&nbsp;equivalent.</span><br>
<span class="lineno">320</span><span class="keyword" id="3014168">func</span>&nbsp;<span class="ident" id="3014173">escFnsEq</span><span class="op" id="3014181">(</span><span class="ident" id="3014182">a</span><span class="op" id="3014183">,</span>&nbsp;<span class="ident" id="3014185">b</span>&nbsp;<span class="builtintype" id="3014187">string</span><span class="op" id="3014193">)</span>&nbsp;<span class="builtintype" id="3014195">bool</span>&nbsp;<span class="op" id="3014200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3014203">if</span>&nbsp;<span class="ident" id="3014206">e</span>&nbsp;<span class="op" id="3014208">:=</span>&nbsp;<span class="ident" id="3014211">equivEscapers</span><span class="op" id="3014224">[</span><span class="ident" id="3014225">a</span><span class="op" id="3014226">]</span><span class="op" id="3014227">;</span>&nbsp;<span class="ident" id="3014229">e</span>&nbsp;<span class="op" id="3014231">!=</span>&nbsp;<span class="string" id="3014234">&#34;&#34;</span>&nbsp;<span class="op" id="3014237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3014241">a</span>&nbsp;<span class="op" id="3014243">=</span>&nbsp;<span class="ident" id="3014245">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3014248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3014251">if</span>&nbsp;<span class="ident" id="3014254">e</span>&nbsp;<span class="op" id="3014256">:=</span>&nbsp;<span class="ident" id="3014259">equivEscapers</span><span class="op" id="3014272">[</span><span class="ident" id="3014273">b</span><span class="op" id="3014274">]</span><span class="op" id="3014275">;</span>&nbsp;<span class="ident" id="3014277">e</span>&nbsp;<span class="op" id="3014279">!=</span>&nbsp;<span class="string" id="3014282">&#34;&#34;</span>&nbsp;<span class="op" id="3014285">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3014289">b</span>&nbsp;<span class="op" id="3014291">=</span>&nbsp;<span class="ident" id="3014293">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3014296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3014299">return</span>&nbsp;<span class="ident" id="3014306">a</span>&nbsp;<span class="op" id="3014308">==</span>&nbsp;<span class="ident" id="3014311">b</span><br>
<span class="lineno"></span><span class="op" id="3014313">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span><span class="comment" id="3014316">//&nbsp;newIdentCmd&nbsp;produces&nbsp;a&nbsp;command&nbsp;containing&nbsp;a&nbsp;single&nbsp;identifier&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="3014387">func</span>&nbsp;<span class="ident" id="3014392">newIdentCmd</span><span class="op" id="3014403">(</span><span class="ident" id="3014404">identifier</span>&nbsp;<span class="builtintype" id="3014415">string</span><span class="op" id="3014421">,</span>&nbsp;<span class="ident" id="3014423">pos</span>&nbsp;<span class="ident" id="3014427">parse</span><span class="op" id="3014432">.</span><span class="ident" id="3014433">Pos</span><span class="op" id="3014436">)</span>&nbsp;<span class="op" id="3014438">*</span><span class="ident" id="3014439">parse</span><span class="op" id="3014444">.</span><span class="ident" id="3014445">CommandNode</span>&nbsp;<span class="op" id="3014457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3014460">return</span>&nbsp;<span class="op" id="3014467">&amp;</span><span class="ident" id="3014468">parse</span><span class="op" id="3014473">.</span><span class="ident" id="3014474">CommandNode</span><span class="op" id="3014485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3014489">NodeType</span><span class="op" id="3014497">:</span>&nbsp;<span class="ident" id="3014499">parse</span><span class="op" id="3014504">.</span><span class="ident" id="3014505">NodeCommand</span><span class="op" id="3014516">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3014520">Args</span><span class="op" id="3014524">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3014530">[</span><span class="op" id="3014531">]</span><span class="ident" id="3014532">parse</span><span class="op" id="3014537">.</span><span class="ident" id="3014538">Node</span><span class="op" id="3014542">{</span><span class="ident" id="3014543">parse</span><span class="op" id="3014548">.</span><span class="ident" id="3014549">NewIdentifier</span><span class="op" id="3014562">(</span><span class="ident" id="3014563">identifier</span><span class="op" id="3014573">)</span><span class="op" id="3014574">.</span><span class="ident" id="3014575">SetTree</span><span class="op" id="3014582">(</span><span class="builtintype" id="3014583">nil</span><span class="op" id="3014586">)</span><span class="op" id="3014587">.</span><span class="ident" id="3014588">SetPos</span><span class="op" id="3014594">(</span><span class="ident" id="3014595">pos</span><span class="op" id="3014598">)</span><span class="op" id="3014599">}</span><span class="op" id="3014600">,</span>&nbsp;<span class="comment" id="3014602">//&nbsp;TODO:&nbsp;SetTree.</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3014621">}</span><br>
<span class="lineno"></span><span class="op" id="3014623">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3014626">//&nbsp;nudge&nbsp;returns&nbsp;the&nbsp;context&nbsp;that&nbsp;would&nbsp;result&nbsp;from&nbsp;following&nbsp;empty&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="3014701">//&nbsp;transitions&nbsp;from&nbsp;the&nbsp;input&nbsp;context.</span><br>
<span class="lineno">340</span><span class="comment" id="3014740">//&nbsp;For&nbsp;example,&nbsp;parsing:</span><br>
<span class="lineno"></span><span class="comment" id="3014765">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`&lt;a&nbsp;href=`</span><br>
<span class="lineno"></span><span class="comment" id="3014783">//&nbsp;will&nbsp;end&nbsp;in&nbsp;context{stateBeforeValue,&nbsp;attrURL},&nbsp;but&nbsp;parsing&nbsp;one&nbsp;extra&nbsp;rune:</span><br>
<span class="lineno"></span><span class="comment" id="3014862">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`&lt;a&nbsp;href=x`</span><br>
<span class="lineno"></span><span class="comment" id="3014881">//&nbsp;will&nbsp;end&nbsp;in&nbsp;context{stateURL,&nbsp;delimSpaceOrTagEnd,&nbsp;...}.</span><br>
<span class="lineno">345</span><span class="comment" id="3014940">//&nbsp;There&nbsp;are&nbsp;two&nbsp;transitions&nbsp;that&nbsp;happen&nbsp;when&nbsp;the&nbsp;&#39;x&#39;&nbsp;is&nbsp;seen:</span><br>
<span class="lineno"></span><span class="comment" id="3015003">//&nbsp;(1)&nbsp;Transition&nbsp;from&nbsp;a&nbsp;before-value&nbsp;state&nbsp;to&nbsp;a&nbsp;start-of-value&nbsp;state&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="3015081">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;consuming&nbsp;any&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="3015113">//&nbsp;(2)&nbsp;Consume&nbsp;&#39;x&#39;&nbsp;and&nbsp;transition&nbsp;past&nbsp;the&nbsp;first&nbsp;value&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="3015179">//&nbsp;In&nbsp;this&nbsp;case,&nbsp;nudging&nbsp;produces&nbsp;the&nbsp;context&nbsp;after&nbsp;(1)&nbsp;happens.</span><br>
<span class="lineno">350</span><span class="keyword" id="3015244">func</span>&nbsp;<span class="ident" id="3015249">nudge</span><span class="op" id="3015254">(</span><span class="ident" id="3015255">c</span>&nbsp;<span class="ident" id="3015257">context</span><span class="op" id="3015264">)</span>&nbsp;<span class="ident" id="3015266">context</span>&nbsp;<span class="op" id="3015274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3015277">switch</span>&nbsp;<span class="ident" id="3015284">c</span><span class="op" id="3015285">.</span><span class="ident" id="3015286">state</span>&nbsp;<span class="op" id="3015292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3015295">case</span>&nbsp;<span class="ident" id="3015300">stateTag</span><span class="op" id="3015308">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3015312">//&nbsp;In&nbsp;`&lt;foo&nbsp;{{.}}`,&nbsp;the&nbsp;action&nbsp;should&nbsp;emit&nbsp;an&nbsp;attribute.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3015371">c</span><span class="op" id="3015372">.</span><span class="ident" id="3015373">state</span>&nbsp;<span class="op" id="3015379">=</span>&nbsp;<span class="ident" id="3015381">stateAttrName</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3015396">case</span>&nbsp;<span class="ident" id="3015401">stateBeforeValue</span><span class="op" id="3015417">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3015421">//&nbsp;In&nbsp;`&lt;foo&nbsp;bar={{.}}`,&nbsp;the&nbsp;action&nbsp;is&nbsp;an&nbsp;undelimited&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3015483">c</span><span class="op" id="3015484">.</span><span class="ident" id="3015485">state</span><span class="op" id="3015490">,</span>&nbsp;<span class="ident" id="3015492">c</span><span class="op" id="3015493">.</span><span class="ident" id="3015494">delim</span><span class="op" id="3015499">,</span>&nbsp;<span class="ident" id="3015501">c</span><span class="op" id="3015502">.</span><span class="ident" id="3015503">attr</span>&nbsp;<span class="op" id="3015508">=</span>&nbsp;<span class="ident" id="3015510">attrStartStates</span><span class="op" id="3015525">[</span><span class="ident" id="3015526">c</span><span class="op" id="3015527">.</span><span class="ident" id="3015528">attr</span><span class="op" id="3015532">]</span><span class="op" id="3015533">,</span>&nbsp;<span class="ident" id="3015535">delimSpaceOrTagEnd</span><span class="op" id="3015553">,</span>&nbsp;<span class="ident" id="3015555">attrNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3015565">case</span>&nbsp;<span class="ident" id="3015570">stateAfterName</span><span class="op" id="3015584">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3015588">//&nbsp;In&nbsp;`&lt;foo&nbsp;bar&nbsp;{{.}}`,&nbsp;the&nbsp;action&nbsp;is&nbsp;an&nbsp;attribute&nbsp;name.</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3015647">c</span><span class="op" id="3015648">.</span><span class="ident" id="3015649">state</span><span class="op" id="3015654">,</span>&nbsp;<span class="ident" id="3015656">c</span><span class="op" id="3015657">.</span><span class="ident" id="3015658">attr</span>&nbsp;<span class="op" id="3015663">=</span>&nbsp;<span class="ident" id="3015665">stateAttrName</span><span class="op" id="3015678">,</span>&nbsp;<span class="ident" id="3015680">attrNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3015690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3015693">return</span>&nbsp;<span class="ident" id="3015700">c</span><br>
<span class="lineno"></span><span class="op" id="3015702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="comment" id="3015705">//&nbsp;join&nbsp;joins&nbsp;the&nbsp;two&nbsp;contexts&nbsp;of&nbsp;a&nbsp;branch&nbsp;template&nbsp;node.&nbsp;The&nbsp;result&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="3015780">//&nbsp;error&nbsp;context&nbsp;if&nbsp;either&nbsp;of&nbsp;the&nbsp;input&nbsp;contexts&nbsp;are&nbsp;error&nbsp;contexts,&nbsp;or&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3015859">//&nbsp;the&nbsp;input&nbsp;contexts&nbsp;differ.</span><br>
<span class="lineno"></span><span class="keyword" id="3015889">func</span>&nbsp;<span class="ident" id="3015894">join</span><span class="op" id="3015898">(</span><span class="ident" id="3015899">a</span><span class="op" id="3015900">,</span>&nbsp;<span class="ident" id="3015902">b</span>&nbsp;<span class="ident" id="3015904">context</span><span class="op" id="3015911">,</span>&nbsp;<span class="ident" id="3015913">node</span>&nbsp;<span class="ident" id="3015918">parse</span><span class="op" id="3015923">.</span><span class="ident" id="3015924">Node</span><span class="op" id="3015928">,</span>&nbsp;<span class="ident" id="3015930">nodeName</span>&nbsp;<span class="builtintype" id="3015939">string</span><span class="op" id="3015945">)</span>&nbsp;<span class="ident" id="3015947">context</span>&nbsp;<span class="op" id="3015955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3015958">if</span>&nbsp;<span class="ident" id="3015961">a</span><span class="op" id="3015962">.</span><span class="ident" id="3015963">state</span>&nbsp;<span class="op" id="3015969">==</span>&nbsp;<span class="ident" id="3015972">stateError</span>&nbsp;<span class="op" id="3015983">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3015987">return</span>&nbsp;<span class="ident" id="3015994">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3015997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3016000">if</span>&nbsp;<span class="ident" id="3016003">b</span><span class="op" id="3016004">.</span><span class="ident" id="3016005">state</span>&nbsp;<span class="op" id="3016011">==</span>&nbsp;<span class="ident" id="3016014">stateError</span>&nbsp;<span class="op" id="3016025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3016029">return</span>&nbsp;<span class="ident" id="3016036">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3016039">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3016042">if</span>&nbsp;<span class="ident" id="3016045">a</span><span class="op" id="3016046">.</span><span class="ident" id="3016047">eq</span><span class="op" id="3016049">(</span><span class="ident" id="3016050">b</span><span class="op" id="3016051">)</span>&nbsp;<span class="op" id="3016053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3016057">return</span>&nbsp;<span class="ident" id="3016064">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3016067">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3016071">c</span>&nbsp;<span class="op" id="3016073">:=</span>&nbsp;<span class="ident" id="3016076">a</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3016079">c</span><span class="op" id="3016080">.</span><span class="ident" id="3016081">urlPart</span>&nbsp;<span class="op" id="3016089">=</span>&nbsp;<span class="ident" id="3016091">b</span><span class="op" id="3016092">.</span><span class="ident" id="3016093">urlPart</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3016102">if</span>&nbsp;<span class="ident" id="3016105">c</span><span class="op" id="3016106">.</span><span class="ident" id="3016107">eq</span><span class="op" id="3016109">(</span><span class="ident" id="3016110">b</span><span class="op" id="3016111">)</span>&nbsp;<span class="op" id="3016113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3016117">//&nbsp;The&nbsp;contexts&nbsp;differ&nbsp;only&nbsp;by&nbsp;urlPart.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3016159">c</span><span class="op" id="3016160">.</span><span class="ident" id="3016161">urlPart</span>&nbsp;<span class="op" id="3016169">=</span>&nbsp;<span class="ident" id="3016171">urlPartUnknown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3016188">return</span>&nbsp;<span class="ident" id="3016195">c</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3016198">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3016202">c</span>&nbsp;<span class="op" id="3016204">=</span>&nbsp;<span class="ident" id="3016206">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3016209">c</span><span class="op" id="3016210">.</span><span class="ident" id="3016211">jsCtx</span>&nbsp;<span class="op" id="3016217">=</span>&nbsp;<span class="ident" id="3016219">b</span><span class="op" id="3016220">.</span><span class="ident" id="3016221">jsCtx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3016228">if</span>&nbsp;<span class="ident" id="3016231">c</span><span class="op" id="3016232">.</span><span class="ident" id="3016233">eq</span><span class="op" id="3016235">(</span><span class="ident" id="3016236">b</span><span class="op" id="3016237">)</span>&nbsp;<span class="op" id="3016239">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3016243">//&nbsp;The&nbsp;contexts&nbsp;differ&nbsp;only&nbsp;by&nbsp;jsCtx.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3016283">c</span><span class="op" id="3016284">.</span><span class="ident" id="3016285">jsCtx</span>&nbsp;<span class="op" id="3016291">=</span>&nbsp;<span class="ident" id="3016293">jsCtxUnknown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3016308">return</span>&nbsp;<span class="ident" id="3016315">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3016318">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3016322">//&nbsp;Allow&nbsp;a&nbsp;nudged&nbsp;context&nbsp;to&nbsp;join&nbsp;with&nbsp;an&nbsp;unnudged&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3016379">//&nbsp;This&nbsp;means&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3016399">//&nbsp;&nbsp;&nbsp;&lt;p&nbsp;title={{if&nbsp;.C}}{{.}}{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3016436">//&nbsp;ends&nbsp;in&nbsp;an&nbsp;unquoted&nbsp;value&nbsp;state&nbsp;even&nbsp;though&nbsp;the&nbsp;else&nbsp;branch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3016500">//&nbsp;ends&nbsp;in&nbsp;stateBeforeValue.</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3016530">if</span>&nbsp;<span class="ident" id="3016533">c</span><span class="op" id="3016534">,</span>&nbsp;<span class="ident" id="3016536">d</span>&nbsp;<span class="op" id="3016538">:=</span>&nbsp;<span class="ident" id="3016541">nudge</span><span class="op" id="3016546">(</span><span class="ident" id="3016547">a</span><span class="op" id="3016548">)</span><span class="op" id="3016549">,</span>&nbsp;<span class="ident" id="3016551">nudge</span><span class="op" id="3016556">(</span><span class="ident" id="3016557">b</span><span class="op" id="3016558">)</span><span class="op" id="3016559">;</span>&nbsp;<span class="op" id="3016561">!</span><span class="op" id="3016562">(</span><span class="ident" id="3016563">c</span><span class="op" id="3016564">.</span><span class="ident" id="3016565">eq</span><span class="op" id="3016567">(</span><span class="ident" id="3016568">a</span><span class="op" id="3016569">)</span>&nbsp;<span class="op" id="3016571">&amp;&amp;</span>&nbsp;<span class="ident" id="3016574">d</span><span class="op" id="3016575">.</span><span class="ident" id="3016576">eq</span><span class="op" id="3016578">(</span><span class="ident" id="3016579">b</span><span class="op" id="3016580">)</span><span class="op" id="3016581">)</span>&nbsp;<span class="op" id="3016583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3016587">if</span>&nbsp;<span class="ident" id="3016590">e</span>&nbsp;<span class="op" id="3016592">:=</span>&nbsp;<span class="ident" id="3016595">join</span><span class="op" id="3016599">(</span><span class="ident" id="3016600">c</span><span class="op" id="3016601">,</span>&nbsp;<span class="ident" id="3016603">d</span><span class="op" id="3016604">,</span>&nbsp;<span class="ident" id="3016606">node</span><span class="op" id="3016610">,</span>&nbsp;<span class="ident" id="3016612">nodeName</span><span class="op" id="3016620">)</span><span class="op" id="3016621">;</span>&nbsp;<span class="ident" id="3016623">e</span><span class="op" id="3016624">.</span><span class="ident" id="3016625">state</span>&nbsp;<span class="op" id="3016631">!=</span>&nbsp;<span class="ident" id="3016634">stateError</span>&nbsp;<span class="op" id="3016645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3016650">return</span>&nbsp;<span class="ident" id="3016657">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3016661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3016664">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3016668">return</span>&nbsp;<span class="ident" id="3016675">context</span><span class="op" id="3016682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3016686">state</span><span class="op" id="3016691">:</span>&nbsp;<span class="ident" id="3016693">stateError</span><span class="op" id="3016703">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3016707">err</span><span class="op" id="3016710">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3016714">errorf</span><span class="op" id="3016720">(</span><span class="ident" id="3016721">ErrBranchEnd</span><span class="op" id="3016733">,</span>&nbsp;<span class="ident" id="3016735">node</span><span class="op" id="3016739">,</span>&nbsp;<span class="num" id="3016741">0</span><span class="op" id="3016742">,</span>&nbsp;<span class="string" id="3016744">&#34;{{%s}}&nbsp;branches&nbsp;end&nbsp;in&nbsp;different&nbsp;contexts:&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="3016795">,</span>&nbsp;<span class="ident" id="3016797">nodeName</span><span class="op" id="3016805">,</span>&nbsp;<span class="ident" id="3016807">a</span><span class="op" id="3016808">,</span>&nbsp;<span class="ident" id="3016810">b</span><span class="op" id="3016811">)</span><span class="op" id="3016812">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3016815">}</span><br>
<span class="lineno">410</span><span class="op" id="3016817">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3016820">//&nbsp;escapeBranch&nbsp;escapes&nbsp;a&nbsp;branch&nbsp;template&nbsp;node:&nbsp;&#34;if&#34;,&nbsp;&#34;range&#34;&nbsp;and&nbsp;&#34;with&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="3016894">func</span>&nbsp;<span class="op" id="3016899">(</span><span class="ident" id="3016900">e</span>&nbsp;<span class="op" id="3016902">*</span><span class="ident" id="3016903">escaper</span><span class="op" id="3016910">)</span>&nbsp;<span class="ident" id="3016912">escapeBranch</span><span class="op" id="3016924">(</span><span class="ident" id="3016925">c</span>&nbsp;<span class="ident" id="3016927">context</span><span class="op" id="3016934">,</span>&nbsp;<span class="ident" id="3016936">n</span>&nbsp;<span class="op" id="3016938">*</span><span class="ident" id="3016939">parse</span><span class="op" id="3016944">.</span><span class="ident" id="3016945">BranchNode</span><span class="op" id="3016955">,</span>&nbsp;<span class="ident" id="3016957">nodeName</span>&nbsp;<span class="builtintype" id="3016966">string</span><span class="op" id="3016972">)</span>&nbsp;<span class="ident" id="3016974">context</span>&nbsp;<span class="op" id="3016982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3016985">c0</span>&nbsp;<span class="op" id="3016988">:=</span>&nbsp;<span class="ident" id="3016991">e</span><span class="op" id="3016992">.</span><span class="ident" id="3016993">escapeList</span><span class="op" id="3017003">(</span><span class="ident" id="3017004">c</span><span class="op" id="3017005">,</span>&nbsp;<span class="ident" id="3017007">n</span><span class="op" id="3017008">.</span><span class="ident" id="3017009">List</span><span class="op" id="3017013">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3017016">if</span>&nbsp;<span class="ident" id="3017019">nodeName</span>&nbsp;<span class="op" id="3017028">==</span>&nbsp;<span class="string" id="3017031">&#34;range&#34;</span>&nbsp;<span class="op" id="3017039">&amp;&amp;</span>&nbsp;<span class="ident" id="3017042">c0</span><span class="op" id="3017044">.</span><span class="ident" id="3017045">state</span>&nbsp;<span class="op" id="3017051">!=</span>&nbsp;<span class="ident" id="3017054">stateError</span>&nbsp;<span class="op" id="3017065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3017069">//&nbsp;The&nbsp;&#34;true&#34;&nbsp;branch&nbsp;of&nbsp;a&nbsp;&#34;range&#34;&nbsp;node&nbsp;can&nbsp;execute&nbsp;multiple&nbsp;times.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3017138">//&nbsp;We&nbsp;check&nbsp;that&nbsp;executing&nbsp;n.List&nbsp;once&nbsp;results&nbsp;in&nbsp;the&nbsp;same&nbsp;context</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3017207">//&nbsp;as&nbsp;executing&nbsp;n.List&nbsp;twice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3017239">c1</span><span class="op" id="3017241">,</span>&nbsp;<span class="ident" id="3017243">_</span>&nbsp;<span class="op" id="3017245">:=</span>&nbsp;<span class="ident" id="3017248">e</span><span class="op" id="3017249">.</span><span class="ident" id="3017250">escapeListConditionally</span><span class="op" id="3017273">(</span><span class="ident" id="3017274">c0</span><span class="op" id="3017276">,</span>&nbsp;<span class="ident" id="3017278">n</span><span class="op" id="3017279">.</span><span class="ident" id="3017280">List</span><span class="op" id="3017284">,</span>&nbsp;<span class="builtintype" id="3017286">nil</span><span class="op" id="3017289">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3017293">c0</span>&nbsp;<span class="op" id="3017296">=</span>&nbsp;<span class="ident" id="3017298">join</span><span class="op" id="3017302">(</span><span class="ident" id="3017303">c0</span><span class="op" id="3017305">,</span>&nbsp;<span class="ident" id="3017307">c1</span><span class="op" id="3017309">,</span>&nbsp;<span class="ident" id="3017311">n</span><span class="op" id="3017312">,</span>&nbsp;<span class="ident" id="3017314">nodeName</span><span class="op" id="3017322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3017326">if</span>&nbsp;<span class="ident" id="3017329">c0</span><span class="op" id="3017331">.</span><span class="ident" id="3017332">state</span>&nbsp;<span class="op" id="3017338">==</span>&nbsp;<span class="ident" id="3017341">stateError</span>&nbsp;<span class="op" id="3017352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3017357">//&nbsp;Make&nbsp;clear&nbsp;that&nbsp;this&nbsp;is&nbsp;a&nbsp;problem&nbsp;on&nbsp;loop&nbsp;re-entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3017414">//&nbsp;since&nbsp;developers&nbsp;tend&nbsp;to&nbsp;overlook&nbsp;that&nbsp;branch&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3017471">//&nbsp;debugging&nbsp;templates.</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3017498">c0</span><span class="op" id="3017500">.</span><span class="ident" id="3017501">err</span><span class="op" id="3017504">.</span><span class="ident" id="3017505">Line</span>&nbsp;<span class="op" id="3017510">=</span>&nbsp;<span class="ident" id="3017512">n</span><span class="op" id="3017513">.</span><span class="ident" id="3017514">Line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3017522">c0</span><span class="op" id="3017524">.</span><span class="ident" id="3017525">err</span><span class="op" id="3017528">.</span><span class="ident" id="3017529">Description</span>&nbsp;<span class="op" id="3017541">=</span>&nbsp;<span class="string" id="3017543">&#34;on&nbsp;range&nbsp;loop&nbsp;re-entry:&nbsp;&#34;</span>&nbsp;<span class="op" id="3017570">+</span>&nbsp;<span class="ident" id="3017572">c0</span><span class="op" id="3017574">.</span><span class="ident" id="3017575">err</span><span class="op" id="3017578">.</span><span class="ident" id="3017579">Description</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3017594">return</span>&nbsp;<span class="ident" id="3017601">c0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3017606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3017609">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3017612">c1</span>&nbsp;<span class="op" id="3017615">:=</span>&nbsp;<span class="ident" id="3017618">e</span><span class="op" id="3017619">.</span><span class="ident" id="3017620">escapeList</span><span class="op" id="3017630">(</span><span class="ident" id="3017631">c</span><span class="op" id="3017632">,</span>&nbsp;<span class="ident" id="3017634">n</span><span class="op" id="3017635">.</span><span class="ident" id="3017636">ElseList</span><span class="op" id="3017644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3017647">return</span>&nbsp;<span class="ident" id="3017654">join</span><span class="op" id="3017658">(</span><span class="ident" id="3017659">c0</span><span class="op" id="3017661">,</span>&nbsp;<span class="ident" id="3017663">c1</span><span class="op" id="3017665">,</span>&nbsp;<span class="ident" id="3017667">n</span><span class="op" id="3017668">,</span>&nbsp;<span class="ident" id="3017670">nodeName</span><span class="op" id="3017678">)</span><br>
<span class="lineno"></span><span class="op" id="3017680">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3017683">//&nbsp;escapeList&nbsp;escapes&nbsp;a&nbsp;list&nbsp;template&nbsp;node.</span><br>
<span class="lineno">435</span><span class="keyword" id="3017727">func</span>&nbsp;<span class="op" id="3017732">(</span><span class="ident" id="3017733">e</span>&nbsp;<span class="op" id="3017735">*</span><span class="ident" id="3017736">escaper</span><span class="op" id="3017743">)</span>&nbsp;<span class="ident" id="3017745">escapeList</span><span class="op" id="3017755">(</span><span class="ident" id="3017756">c</span>&nbsp;<span class="ident" id="3017758">context</span><span class="op" id="3017765">,</span>&nbsp;<span class="ident" id="3017767">n</span>&nbsp;<span class="op" id="3017769">*</span><span class="ident" id="3017770">parse</span><span class="op" id="3017775">.</span><span class="ident" id="3017776">ListNode</span><span class="op" id="3017784">)</span>&nbsp;<span class="ident" id="3017786">context</span>&nbsp;<span class="op" id="3017794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3017797">if</span>&nbsp;<span class="ident" id="3017800">n</span>&nbsp;<span class="op" id="3017802">==</span>&nbsp;<span class="builtintype" id="3017805">nil</span>&nbsp;<span class="op" id="3017809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3017813">return</span>&nbsp;<span class="ident" id="3017820">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3017823">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3017826">for</span>&nbsp;<span class="ident" id="3017830">_</span><span class="op" id="3017831">,</span>&nbsp;<span class="ident" id="3017833">m</span>&nbsp;<span class="op" id="3017835">:=</span>&nbsp;<span class="keyword" id="3017838">range</span>&nbsp;<span class="ident" id="3017844">n</span><span class="op" id="3017845">.</span><span class="ident" id="3017846">Nodes</span>&nbsp;<span class="op" id="3017852">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3017856">c</span>&nbsp;<span class="op" id="3017858">=</span>&nbsp;<span class="ident" id="3017860">e</span><span class="op" id="3017861">.</span><span class="ident" id="3017862">escape</span><span class="op" id="3017868">(</span><span class="ident" id="3017869">c</span><span class="op" id="3017870">,</span>&nbsp;<span class="ident" id="3017872">m</span><span class="op" id="3017873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3017876">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3017879">return</span>&nbsp;<span class="ident" id="3017886">c</span><br>
<span class="lineno"></span><span class="op" id="3017888">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span><span class="comment" id="3017891">//&nbsp;escapeListConditionally&nbsp;escapes&nbsp;a&nbsp;list&nbsp;node&nbsp;but&nbsp;only&nbsp;preserves&nbsp;edits&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3017967">//&nbsp;inferences&nbsp;in&nbsp;e&nbsp;if&nbsp;the&nbsp;inferences&nbsp;and&nbsp;output&nbsp;context&nbsp;satisfy&nbsp;filter.</span><br>
<span class="lineno"></span><span class="comment" id="3018039">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;best&nbsp;guess&nbsp;at&nbsp;an&nbsp;output&nbsp;context,&nbsp;and&nbsp;the&nbsp;result&nbsp;of&nbsp;the&nbsp;filter</span><br>
<span class="lineno"></span><span class="comment" id="3018119">//&nbsp;which&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;whether&nbsp;e&nbsp;was&nbsp;updated.</span><br>
<span class="lineno"></span><span class="keyword" id="3018166">func</span>&nbsp;<span class="op" id="3018171">(</span><span class="ident" id="3018172">e</span>&nbsp;<span class="op" id="3018174">*</span><span class="ident" id="3018175">escaper</span><span class="op" id="3018182">)</span>&nbsp;<span class="ident" id="3018184">escapeListConditionally</span><span class="op" id="3018207">(</span><span class="ident" id="3018208">c</span>&nbsp;<span class="ident" id="3018210">context</span><span class="op" id="3018217">,</span>&nbsp;<span class="ident" id="3018219">n</span>&nbsp;<span class="op" id="3018221">*</span><span class="ident" id="3018222">parse</span><span class="op" id="3018227">.</span><span class="ident" id="3018228">ListNode</span><span class="op" id="3018236">,</span>&nbsp;<span class="ident" id="3018238">filter</span>&nbsp;<span class="keyword" id="3018245">func</span><span class="op" id="3018249">(</span><span class="op" id="3018250">*</span><span class="ident" id="3018251">escaper</span><span class="op" id="3018258">,</span>&nbsp;<span class="ident" id="3018260">context</span><span class="op" id="3018267">)</span>&nbsp;<span class="builtintype" id="3018269">bool</span><span class="op" id="3018273">)</span>&nbsp;<span class="op" id="3018275">(</span><span class="ident" id="3018276">context</span><span class="op" id="3018283">,</span>&nbsp;<span class="builtintype" id="3018285">bool</span><span class="op" id="3018289">)</span>&nbsp;<span class="op" id="3018291">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3018294">e1</span>&nbsp;<span class="op" id="3018297">:=</span>&nbsp;<span class="ident" id="3018300">newEscaper</span><span class="op" id="3018310">(</span><span class="ident" id="3018311">e</span><span class="op" id="3018312">.</span><span class="ident" id="3018313">tmpl</span><span class="op" id="3018317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3018320">//&nbsp;Make&nbsp;type&nbsp;inferences&nbsp;available&nbsp;to&nbsp;f.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3018361">for</span>&nbsp;<span class="ident" id="3018365">k</span><span class="op" id="3018366">,</span>&nbsp;<span class="ident" id="3018368">v</span>&nbsp;<span class="op" id="3018370">:=</span>&nbsp;<span class="keyword" id="3018373">range</span>&nbsp;<span class="ident" id="3018379">e</span><span class="op" id="3018380">.</span><span class="ident" id="3018381">output</span>&nbsp;<span class="op" id="3018388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3018392">e1</span><span class="op" id="3018394">.</span><span class="ident" id="3018395">output</span><span class="op" id="3018401">[</span><span class="ident" id="3018402">k</span><span class="op" id="3018403">]</span>&nbsp;<span class="op" id="3018405">=</span>&nbsp;<span class="ident" id="3018407">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3018410">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3018413">c</span>&nbsp;<span class="op" id="3018415">=</span>&nbsp;<span class="ident" id="3018417">e1</span><span class="op" id="3018419">.</span><span class="ident" id="3018420">escapeList</span><span class="op" id="3018430">(</span><span class="ident" id="3018431">c</span><span class="op" id="3018432">,</span>&nbsp;<span class="ident" id="3018434">n</span><span class="op" id="3018435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3018438">ok</span>&nbsp;<span class="op" id="3018441">:=</span>&nbsp;<span class="ident" id="3018444">filter</span>&nbsp;<span class="op" id="3018451">!=</span>&nbsp;<span class="builtintype" id="3018454">nil</span>&nbsp;<span class="op" id="3018458">&amp;&amp;</span>&nbsp;<span class="ident" id="3018461">filter</span><span class="op" id="3018467">(</span><span class="ident" id="3018468">e1</span><span class="op" id="3018470">,</span>&nbsp;<span class="ident" id="3018472">c</span><span class="op" id="3018473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3018476">if</span>&nbsp;<span class="ident" id="3018479">ok</span>&nbsp;<span class="op" id="3018482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3018486">//&nbsp;Copy&nbsp;inferences&nbsp;and&nbsp;edits&nbsp;from&nbsp;e1&nbsp;back&nbsp;into&nbsp;e.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3018538">for</span>&nbsp;<span class="ident" id="3018542">k</span><span class="op" id="3018543">,</span>&nbsp;<span class="ident" id="3018545">v</span>&nbsp;<span class="op" id="3018547">:=</span>&nbsp;<span class="keyword" id="3018550">range</span>&nbsp;<span class="ident" id="3018556">e1</span><span class="op" id="3018558">.</span><span class="ident" id="3018559">output</span>&nbsp;<span class="op" id="3018566">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3018571">e</span><span class="op" id="3018572">.</span><span class="ident" id="3018573">output</span><span class="op" id="3018579">[</span><span class="ident" id="3018580">k</span><span class="op" id="3018581">]</span>&nbsp;<span class="op" id="3018583">=</span>&nbsp;<span class="ident" id="3018585">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3018589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3018593">for</span>&nbsp;<span class="ident" id="3018597">k</span><span class="op" id="3018598">,</span>&nbsp;<span class="ident" id="3018600">v</span>&nbsp;<span class="op" id="3018602">:=</span>&nbsp;<span class="keyword" id="3018605">range</span>&nbsp;<span class="ident" id="3018611">e1</span><span class="op" id="3018613">.</span><span class="ident" id="3018614">derived</span>&nbsp;<span class="op" id="3018622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3018627">e</span><span class="op" id="3018628">.</span><span class="ident" id="3018629">derived</span><span class="op" id="3018636">[</span><span class="ident" id="3018637">k</span><span class="op" id="3018638">]</span>&nbsp;<span class="op" id="3018640">=</span>&nbsp;<span class="ident" id="3018642">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3018646">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3018650">for</span>&nbsp;<span class="ident" id="3018654">k</span><span class="op" id="3018655">,</span>&nbsp;<span class="ident" id="3018657">v</span>&nbsp;<span class="op" id="3018659">:=</span>&nbsp;<span class="keyword" id="3018662">range</span>&nbsp;<span class="ident" id="3018668">e1</span><span class="op" id="3018670">.</span><span class="ident" id="3018671">called</span>&nbsp;<span class="op" id="3018678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3018683">e</span><span class="op" id="3018684">.</span><span class="ident" id="3018685">called</span><span class="op" id="3018691">[</span><span class="ident" id="3018692">k</span><span class="op" id="3018693">]</span>&nbsp;<span class="op" id="3018695">=</span>&nbsp;<span class="ident" id="3018697">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3018701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3018705">for</span>&nbsp;<span class="ident" id="3018709">k</span><span class="op" id="3018710">,</span>&nbsp;<span class="ident" id="3018712">v</span>&nbsp;<span class="op" id="3018714">:=</span>&nbsp;<span class="keyword" id="3018717">range</span>&nbsp;<span class="ident" id="3018723">e1</span><span class="op" id="3018725">.</span><span class="ident" id="3018726">actionNodeEdits</span>&nbsp;<span class="op" id="3018742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3018747">e</span><span class="op" id="3018748">.</span><span class="ident" id="3018749">editActionNode</span><span class="op" id="3018763">(</span><span class="ident" id="3018764">k</span><span class="op" id="3018765">,</span>&nbsp;<span class="ident" id="3018767">v</span><span class="op" id="3018768">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3018772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3018776">for</span>&nbsp;<span class="ident" id="3018780">k</span><span class="op" id="3018781">,</span>&nbsp;<span class="ident" id="3018783">v</span>&nbsp;<span class="op" id="3018785">:=</span>&nbsp;<span class="keyword" id="3018788">range</span>&nbsp;<span class="ident" id="3018794">e1</span><span class="op" id="3018796">.</span><span class="ident" id="3018797">templateNodeEdits</span>&nbsp;<span class="op" id="3018815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3018820">e</span><span class="op" id="3018821">.</span><span class="ident" id="3018822">editTemplateNode</span><span class="op" id="3018838">(</span><span class="ident" id="3018839">k</span><span class="op" id="3018840">,</span>&nbsp;<span class="ident" id="3018842">v</span><span class="op" id="3018843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3018847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3018851">for</span>&nbsp;<span class="ident" id="3018855">k</span><span class="op" id="3018856">,</span>&nbsp;<span class="ident" id="3018858">v</span>&nbsp;<span class="op" id="3018860">:=</span>&nbsp;<span class="keyword" id="3018863">range</span>&nbsp;<span class="ident" id="3018869">e1</span><span class="op" id="3018871">.</span><span class="ident" id="3018872">textNodeEdits</span>&nbsp;<span class="op" id="3018886">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3018891">e</span><span class="op" id="3018892">.</span><span class="ident" id="3018893">editTextNode</span><span class="op" id="3018905">(</span><span class="ident" id="3018906">k</span><span class="op" id="3018907">,</span>&nbsp;<span class="ident" id="3018909">v</span><span class="op" id="3018910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3018914">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3018917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3018920">return</span>&nbsp;<span class="ident" id="3018927">c</span><span class="op" id="3018928">,</span>&nbsp;<span class="ident" id="3018930">ok</span><br>
<span class="lineno"></span><span class="op" id="3018933">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="3018936">//&nbsp;escapeTemplate&nbsp;escapes&nbsp;a&nbsp;{{template}}&nbsp;call&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="3018988">func</span>&nbsp;<span class="op" id="3018993">(</span><span class="ident" id="3018994">e</span>&nbsp;<span class="op" id="3018996">*</span><span class="ident" id="3018997">escaper</span><span class="op" id="3019004">)</span>&nbsp;<span class="ident" id="3019006">escapeTemplate</span><span class="op" id="3019020">(</span><span class="ident" id="3019021">c</span>&nbsp;<span class="ident" id="3019023">context</span><span class="op" id="3019030">,</span>&nbsp;<span class="ident" id="3019032">n</span>&nbsp;<span class="op" id="3019034">*</span><span class="ident" id="3019035">parse</span><span class="op" id="3019040">.</span><span class="ident" id="3019041">TemplateNode</span><span class="op" id="3019053">)</span>&nbsp;<span class="ident" id="3019055">context</span>&nbsp;<span class="op" id="3019063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3019066">c</span><span class="op" id="3019067">,</span>&nbsp;<span class="ident" id="3019069">name</span>&nbsp;<span class="op" id="3019074">:=</span>&nbsp;<span class="ident" id="3019077">e</span><span class="op" id="3019078">.</span><span class="ident" id="3019079">escapeTree</span><span class="op" id="3019089">(</span><span class="ident" id="3019090">c</span><span class="op" id="3019091">,</span>&nbsp;<span class="ident" id="3019093">n</span><span class="op" id="3019094">,</span>&nbsp;<span class="ident" id="3019096">n</span><span class="op" id="3019097">.</span><span class="ident" id="3019098">Name</span><span class="op" id="3019102">,</span>&nbsp;<span class="ident" id="3019104">n</span><span class="op" id="3019105">.</span><span class="ident" id="3019106">Line</span><span class="op" id="3019110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3019113">if</span>&nbsp;<span class="ident" id="3019116">name</span>&nbsp;<span class="op" id="3019121">!=</span>&nbsp;<span class="ident" id="3019124">n</span><span class="op" id="3019125">.</span><span class="ident" id="3019126">Name</span>&nbsp;<span class="op" id="3019131">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3019135">e</span><span class="op" id="3019136">.</span><span class="ident" id="3019137">editTemplateNode</span><span class="op" id="3019153">(</span><span class="ident" id="3019154">n</span><span class="op" id="3019155">,</span>&nbsp;<span class="ident" id="3019157">name</span><span class="op" id="3019161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3019164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3019167">return</span>&nbsp;<span class="ident" id="3019174">c</span><br>
<span class="lineno"></span><span class="op" id="3019176">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span><span class="comment" id="3019179">//&nbsp;escapeTree&nbsp;escapes&nbsp;the&nbsp;named&nbsp;template&nbsp;starting&nbsp;in&nbsp;the&nbsp;given&nbsp;context&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="3019253">//&nbsp;necessary&nbsp;and&nbsp;returns&nbsp;its&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span><span class="keyword" id="3019298">func</span>&nbsp;<span class="op" id="3019303">(</span><span class="ident" id="3019304">e</span>&nbsp;<span class="op" id="3019306">*</span><span class="ident" id="3019307">escaper</span><span class="op" id="3019314">)</span>&nbsp;<span class="ident" id="3019316">escapeTree</span><span class="op" id="3019326">(</span><span class="ident" id="3019327">c</span>&nbsp;<span class="ident" id="3019329">context</span><span class="op" id="3019336">,</span>&nbsp;<span class="ident" id="3019338">node</span>&nbsp;<span class="ident" id="3019343">parse</span><span class="op" id="3019348">.</span><span class="ident" id="3019349">Node</span><span class="op" id="3019353">,</span>&nbsp;<span class="ident" id="3019355">name</span>&nbsp;<span class="builtintype" id="3019360">string</span><span class="op" id="3019366">,</span>&nbsp;<span class="ident" id="3019368">line</span>&nbsp;<span class="builtintype" id="3019373">int</span><span class="op" id="3019376">)</span>&nbsp;<span class="op" id="3019378">(</span><span class="ident" id="3019379">context</span><span class="op" id="3019386">,</span>&nbsp;<span class="builtintype" id="3019388">string</span><span class="op" id="3019394">)</span>&nbsp;<span class="op" id="3019396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3019399">//&nbsp;Mangle&nbsp;the&nbsp;template&nbsp;name&nbsp;with&nbsp;the&nbsp;input&nbsp;context&nbsp;to&nbsp;produce&nbsp;a&nbsp;reliable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3019473">//&nbsp;identifier.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3019489">dname</span>&nbsp;<span class="op" id="3019495">:=</span>&nbsp;<span class="ident" id="3019498">c</span><span class="op" id="3019499">.</span><span class="ident" id="3019500">mangle</span><span class="op" id="3019506">(</span><span class="ident" id="3019507">name</span><span class="op" id="3019511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3019514">e</span><span class="op" id="3019515">.</span><span class="ident" id="3019516">called</span><span class="op" id="3019522">[</span><span class="ident" id="3019523">dname</span><span class="op" id="3019528">]</span>&nbsp;<span class="op" id="3019530">=</span>&nbsp;<span class="builtintype" id="3019532">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3019538">if</span>&nbsp;<span class="ident" id="3019541">out</span><span class="op" id="3019544">,</span>&nbsp;<span class="ident" id="3019546">ok</span>&nbsp;<span class="op" id="3019549">:=</span>&nbsp;<span class="ident" id="3019552">e</span><span class="op" id="3019553">.</span><span class="ident" id="3019554">output</span><span class="op" id="3019560">[</span><span class="ident" id="3019561">dname</span><span class="op" id="3019566">]</span><span class="op" id="3019567">;</span>&nbsp;<span class="ident" id="3019569">ok</span>&nbsp;<span class="op" id="3019572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3019576">//&nbsp;Already&nbsp;escaped.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3019598">return</span>&nbsp;<span class="ident" id="3019605">out</span><span class="op" id="3019608">,</span>&nbsp;<span class="ident" id="3019610">dname</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3019617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3019620">t</span>&nbsp;<span class="op" id="3019622">:=</span>&nbsp;<span class="ident" id="3019625">e</span><span class="op" id="3019626">.</span><span class="ident" id="3019627">template</span><span class="op" id="3019635">(</span><span class="ident" id="3019636">name</span><span class="op" id="3019640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3019643">if</span>&nbsp;<span class="ident" id="3019646">t</span>&nbsp;<span class="op" id="3019648">==</span>&nbsp;<span class="builtintype" id="3019651">nil</span>&nbsp;<span class="op" id="3019655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3019659">//&nbsp;Two&nbsp;cases:&nbsp;The&nbsp;template&nbsp;exists&nbsp;but&nbsp;is&nbsp;empty,&nbsp;or&nbsp;has&nbsp;never&nbsp;been&nbsp;mentioned&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3019740">//&nbsp;all.&nbsp;Distinguish&nbsp;the&nbsp;cases&nbsp;in&nbsp;the&nbsp;error&nbsp;messages.</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3019795">if</span>&nbsp;<span class="ident" id="3019798">e</span><span class="op" id="3019799">.</span><span class="ident" id="3019800">tmpl</span><span class="op" id="3019804">.</span><span class="ident" id="3019805">set</span><span class="op" id="3019808">[</span><span class="ident" id="3019809">name</span><span class="op" id="3019813">]</span>&nbsp;<span class="op" id="3019815">!=</span>&nbsp;<span class="builtintype" id="3019818">nil</span>&nbsp;<span class="op" id="3019822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3019827">return</span>&nbsp;<span class="ident" id="3019834">context</span><span class="op" id="3019841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3019847">state</span><span class="op" id="3019852">:</span>&nbsp;<span class="ident" id="3019854">stateError</span><span class="op" id="3019864">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3019870">err</span><span class="op" id="3019873">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3019877">errorf</span><span class="op" id="3019883">(</span><span class="ident" id="3019884">ErrNoSuchTemplate</span><span class="op" id="3019901">,</span>&nbsp;<span class="ident" id="3019903">node</span><span class="op" id="3019907">,</span>&nbsp;<span class="ident" id="3019909">line</span><span class="op" id="3019913">,</span>&nbsp;<span class="string" id="3019915">&#34;%q&nbsp;is&nbsp;an&nbsp;incomplete&nbsp;or&nbsp;empty&nbsp;template&#34;</span><span class="op" id="3019954">,</span>&nbsp;<span class="ident" id="3019956">name</span><span class="op" id="3019960">)</span><span class="op" id="3019961">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3019966">}</span><span class="op" id="3019967">,</span>&nbsp;<span class="ident" id="3019969">dname</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3019977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3019981">return</span>&nbsp;<span class="ident" id="3019988">context</span><span class="op" id="3019995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3020000">state</span><span class="op" id="3020005">:</span>&nbsp;<span class="ident" id="3020007">stateError</span><span class="op" id="3020017">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3020022">err</span><span class="op" id="3020025">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3020029">errorf</span><span class="op" id="3020035">(</span><span class="ident" id="3020036">ErrNoSuchTemplate</span><span class="op" id="3020053">,</span>&nbsp;<span class="ident" id="3020055">node</span><span class="op" id="3020059">,</span>&nbsp;<span class="ident" id="3020061">line</span><span class="op" id="3020065">,</span>&nbsp;<span class="string" id="3020067">&#34;no&nbsp;such&nbsp;template&nbsp;%q&#34;</span><span class="op" id="3020088">,</span>&nbsp;<span class="ident" id="3020090">name</span><span class="op" id="3020094">)</span><span class="op" id="3020095">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3020099">}</span><span class="op" id="3020100">,</span>&nbsp;<span class="ident" id="3020102">dname</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3020109">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3020112">if</span>&nbsp;<span class="ident" id="3020115">dname</span>&nbsp;<span class="op" id="3020121">!=</span>&nbsp;<span class="ident" id="3020124">name</span>&nbsp;<span class="op" id="3020129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3020133">//&nbsp;Use&nbsp;any&nbsp;template&nbsp;derived&nbsp;during&nbsp;an&nbsp;earlier&nbsp;call&nbsp;to&nbsp;escapeTemplate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3020204">//&nbsp;with&nbsp;different&nbsp;top&nbsp;level&nbsp;templates,&nbsp;or&nbsp;clone&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3020268">dt</span>&nbsp;<span class="op" id="3020271">:=</span>&nbsp;<span class="ident" id="3020274">e</span><span class="op" id="3020275">.</span><span class="ident" id="3020276">template</span><span class="op" id="3020284">(</span><span class="ident" id="3020285">dname</span><span class="op" id="3020290">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3020294">if</span>&nbsp;<span class="ident" id="3020297">dt</span>&nbsp;<span class="op" id="3020300">==</span>&nbsp;<span class="builtintype" id="3020303">nil</span>&nbsp;<span class="op" id="3020307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3020312">dt</span>&nbsp;<span class="op" id="3020315">=</span>&nbsp;<span class="ident" id="3020317">template</span><span class="op" id="3020325">.</span><span class="ident" id="3020326">New</span><span class="op" id="3020329">(</span><span class="ident" id="3020330">dname</span><span class="op" id="3020335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3020340">dt</span><span class="op" id="3020342">.</span><span class="ident" id="3020343">Tree</span>&nbsp;<span class="op" id="3020348">=</span>&nbsp;<span class="op" id="3020350">&amp;</span><span class="ident" id="3020351">parse</span><span class="op" id="3020356">.</span><span class="ident" id="3020357">Tree</span><span class="op" id="3020361">{</span><span class="ident" id="3020362">Name</span><span class="op" id="3020366">:</span>&nbsp;<span class="ident" id="3020368">dname</span><span class="op" id="3020373">,</span>&nbsp;<span class="ident" id="3020375">Root</span><span class="op" id="3020379">:</span>&nbsp;<span class="ident" id="3020381">t</span><span class="op" id="3020382">.</span><span class="ident" id="3020383">Root</span><span class="op" id="3020387">.</span><span class="ident" id="3020388">CopyList</span><span class="op" id="3020396">(</span><span class="op" id="3020397">)</span><span class="op" id="3020398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3020403">e</span><span class="op" id="3020404">.</span><span class="ident" id="3020405">derived</span><span class="op" id="3020412">[</span><span class="ident" id="3020413">dname</span><span class="op" id="3020418">]</span>&nbsp;<span class="op" id="3020420">=</span>&nbsp;<span class="ident" id="3020422">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3020427">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3020431">t</span>&nbsp;<span class="op" id="3020433">=</span>&nbsp;<span class="ident" id="3020435">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3020439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3020442">return</span>&nbsp;<span class="ident" id="3020449">e</span><span class="op" id="3020450">.</span><span class="ident" id="3020451">computeOutCtx</span><span class="op" id="3020464">(</span><span class="ident" id="3020465">c</span><span class="op" id="3020466">,</span>&nbsp;<span class="ident" id="3020468">t</span><span class="op" id="3020469">)</span><span class="op" id="3020470">,</span>&nbsp;<span class="ident" id="3020472">dname</span><br>
<span class="lineno"></span><span class="op" id="3020478">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">530</span><span class="comment" id="3020481">//&nbsp;computeOutCtx&nbsp;takes&nbsp;a&nbsp;template&nbsp;and&nbsp;its&nbsp;start&nbsp;context&nbsp;and&nbsp;computes&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="3020561">//&nbsp;context&nbsp;while&nbsp;storing&nbsp;any&nbsp;inferences&nbsp;in&nbsp;e.</span><br>
<span class="lineno"></span><span class="keyword" id="3020607">func</span>&nbsp;<span class="op" id="3020612">(</span><span class="ident" id="3020613">e</span>&nbsp;<span class="op" id="3020615">*</span><span class="ident" id="3020616">escaper</span><span class="op" id="3020623">)</span>&nbsp;<span class="ident" id="3020625">computeOutCtx</span><span class="op" id="3020638">(</span><span class="ident" id="3020639">c</span>&nbsp;<span class="ident" id="3020641">context</span><span class="op" id="3020648">,</span>&nbsp;<span class="ident" id="3020650">t</span>&nbsp;<span class="op" id="3020652">*</span><span class="ident" id="3020653">template</span><span class="op" id="3020661">.</span><span class="ident" id="3020662">Template</span><span class="op" id="3020670">)</span>&nbsp;<span class="ident" id="3020672">context</span>&nbsp;<span class="op" id="3020680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3020683">//&nbsp;Propagate&nbsp;context&nbsp;over&nbsp;the&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3020720">c1</span><span class="op" id="3020722">,</span>&nbsp;<span class="ident" id="3020724">ok</span>&nbsp;<span class="op" id="3020727">:=</span>&nbsp;<span class="ident" id="3020730">e</span><span class="op" id="3020731">.</span><span class="ident" id="3020732">escapeTemplateBody</span><span class="op" id="3020750">(</span><span class="ident" id="3020751">c</span><span class="op" id="3020752">,</span>&nbsp;<span class="ident" id="3020754">t</span><span class="op" id="3020755">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3020758">if</span>&nbsp;<span class="op" id="3020761">!</span><span class="ident" id="3020762">ok</span>&nbsp;<span class="op" id="3020765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3020769">//&nbsp;Look&nbsp;for&nbsp;a&nbsp;fixed&nbsp;point&nbsp;by&nbsp;assuming&nbsp;c1&nbsp;as&nbsp;the&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3020835">if</span>&nbsp;<span class="ident" id="3020838">c2</span><span class="op" id="3020840">,</span>&nbsp;<span class="ident" id="3020842">ok2</span>&nbsp;<span class="op" id="3020846">:=</span>&nbsp;<span class="ident" id="3020849">e</span><span class="op" id="3020850">.</span><span class="ident" id="3020851">escapeTemplateBody</span><span class="op" id="3020869">(</span><span class="ident" id="3020870">c1</span><span class="op" id="3020872">,</span>&nbsp;<span class="ident" id="3020874">t</span><span class="op" id="3020875">)</span><span class="op" id="3020876">;</span>&nbsp;<span class="ident" id="3020878">ok2</span>&nbsp;<span class="op" id="3020882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3020887">c1</span><span class="op" id="3020889">,</span>&nbsp;<span class="ident" id="3020891">ok</span>&nbsp;<span class="op" id="3020894">=</span>&nbsp;<span class="ident" id="3020896">c2</span><span class="op" id="3020898">,</span>&nbsp;<span class="builtintype" id="3020900">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3020907">}</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3020911">//&nbsp;Use&nbsp;c1&nbsp;as&nbsp;the&nbsp;error&nbsp;context&nbsp;if&nbsp;neither&nbsp;assumption&nbsp;worked.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3020973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3020976">if</span>&nbsp;<span class="op" id="3020979">!</span><span class="ident" id="3020980">ok</span>&nbsp;<span class="op" id="3020983">&amp;&amp;</span>&nbsp;<span class="ident" id="3020986">c1</span><span class="op" id="3020988">.</span><span class="ident" id="3020989">state</span>&nbsp;<span class="op" id="3020995">!=</span>&nbsp;<span class="ident" id="3020998">stateError</span>&nbsp;<span class="op" id="3021009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3021013">return</span>&nbsp;<span class="ident" id="3021020">context</span><span class="op" id="3021027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3021032">state</span><span class="op" id="3021037">:</span>&nbsp;<span class="ident" id="3021039">stateError</span><span class="op" id="3021049">,</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3021054">err</span><span class="op" id="3021057">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3021061">errorf</span><span class="op" id="3021067">(</span><span class="ident" id="3021068">ErrOutputContext</span><span class="op" id="3021084">,</span>&nbsp;<span class="ident" id="3021086">t</span><span class="op" id="3021087">.</span><span class="ident" id="3021088">Tree</span><span class="op" id="3021092">.</span><span class="ident" id="3021093">Root</span><span class="op" id="3021097">,</span>&nbsp;<span class="num" id="3021099">0</span><span class="op" id="3021100">,</span>&nbsp;<span class="string" id="3021102">&#34;cannot&nbsp;compute&nbsp;output&nbsp;context&nbsp;for&nbsp;template&nbsp;%s&#34;</span><span class="op" id="3021149">,</span>&nbsp;<span class="ident" id="3021151">t</span><span class="op" id="3021152">.</span><span class="ident" id="3021153">Name</span><span class="op" id="3021157">(</span><span class="op" id="3021158">)</span><span class="op" id="3021159">)</span><span class="op" id="3021160">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3021164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3021167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3021170">return</span>&nbsp;<span class="ident" id="3021177">c1</span><br>
<span class="lineno"></span><span class="op" id="3021180">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="comment" id="3021183">//&nbsp;escapeTemplateBody&nbsp;escapes&nbsp;the&nbsp;given&nbsp;template&nbsp;assuming&nbsp;the&nbsp;given&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="3021258">//&nbsp;context,&nbsp;and&nbsp;returns&nbsp;the&nbsp;best&nbsp;guess&nbsp;at&nbsp;the&nbsp;output&nbsp;context&nbsp;and&nbsp;whether&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3021335">//&nbsp;assumption&nbsp;was&nbsp;correct.</span><br>
<span class="lineno"></span><span class="keyword" id="3021362">func</span>&nbsp;<span class="op" id="3021367">(</span><span class="ident" id="3021368">e</span>&nbsp;<span class="op" id="3021370">*</span><span class="ident" id="3021371">escaper</span><span class="op" id="3021378">)</span>&nbsp;<span class="ident" id="3021380">escapeTemplateBody</span><span class="op" id="3021398">(</span><span class="ident" id="3021399">c</span>&nbsp;<span class="ident" id="3021401">context</span><span class="op" id="3021408">,</span>&nbsp;<span class="ident" id="3021410">t</span>&nbsp;<span class="op" id="3021412">*</span><span class="ident" id="3021413">template</span><span class="op" id="3021421">.</span><span class="ident" id="3021422">Template</span><span class="op" id="3021430">)</span>&nbsp;<span class="op" id="3021432">(</span><span class="ident" id="3021433">context</span><span class="op" id="3021440">,</span>&nbsp;<span class="builtintype" id="3021442">bool</span><span class="op" id="3021446">)</span>&nbsp;<span class="op" id="3021448">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3021451">filter</span>&nbsp;<span class="op" id="3021458">:=</span>&nbsp;<span class="keyword" id="3021461">func</span><span class="op" id="3021465">(</span><span class="ident" id="3021466">e1</span>&nbsp;<span class="op" id="3021469">*</span><span class="ident" id="3021470">escaper</span><span class="op" id="3021477">,</span>&nbsp;<span class="ident" id="3021479">c1</span>&nbsp;<span class="ident" id="3021482">context</span><span class="op" id="3021489">)</span>&nbsp;<span class="builtintype" id="3021491">bool</span>&nbsp;<span class="op" id="3021496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3021500">if</span>&nbsp;<span class="ident" id="3021503">c1</span><span class="op" id="3021505">.</span><span class="ident" id="3021506">state</span>&nbsp;<span class="op" id="3021512">==</span>&nbsp;<span class="ident" id="3021515">stateError</span>&nbsp;<span class="op" id="3021526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3021531">//&nbsp;Do&nbsp;not&nbsp;update&nbsp;the&nbsp;input&nbsp;escaper,&nbsp;e.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3021573">return</span>&nbsp;<span class="builtintype" id="3021580">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3021588">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3021592">if</span>&nbsp;<span class="op" id="3021595">!</span><span class="ident" id="3021596">e1</span><span class="op" id="3021598">.</span><span class="ident" id="3021599">called</span><span class="op" id="3021605">[</span><span class="ident" id="3021606">t</span><span class="op" id="3021607">.</span><span class="ident" id="3021608">Name</span><span class="op" id="3021612">(</span><span class="op" id="3021613">)</span><span class="op" id="3021614">]</span>&nbsp;<span class="op" id="3021616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3021621">//&nbsp;If&nbsp;t&nbsp;is&nbsp;not&nbsp;recursively&nbsp;called,&nbsp;then&nbsp;c1&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3021673">//&nbsp;accurate&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3021704">return</span>&nbsp;<span class="builtintype" id="3021711">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3021718">}</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3021722">//&nbsp;c1&nbsp;is&nbsp;accurate&nbsp;if&nbsp;it&nbsp;matches&nbsp;our&nbsp;assumed&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3021784">return</span>&nbsp;<span class="ident" id="3021791">c</span><span class="op" id="3021792">.</span><span class="ident" id="3021793">eq</span><span class="op" id="3021795">(</span><span class="ident" id="3021796">c1</span><span class="op" id="3021798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3021801">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3021804">//&nbsp;We&nbsp;need&nbsp;to&nbsp;assume&nbsp;an&nbsp;output&nbsp;context&nbsp;so&nbsp;that&nbsp;recursive&nbsp;template&nbsp;calls</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3021877">//&nbsp;take&nbsp;the&nbsp;fast&nbsp;path&nbsp;out&nbsp;of&nbsp;escapeTree&nbsp;instead&nbsp;of&nbsp;infinitely&nbsp;recursing.</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3021951">//&nbsp;Naively&nbsp;assuming&nbsp;that&nbsp;the&nbsp;input&nbsp;context&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3022021">//&nbsp;works&nbsp;&gt;90%&nbsp;of&nbsp;the&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3022049">e</span><span class="op" id="3022050">.</span><span class="ident" id="3022051">output</span><span class="op" id="3022057">[</span><span class="ident" id="3022058">t</span><span class="op" id="3022059">.</span><span class="ident" id="3022060">Name</span><span class="op" id="3022064">(</span><span class="op" id="3022065">)</span><span class="op" id="3022066">]</span>&nbsp;<span class="op" id="3022068">=</span>&nbsp;<span class="ident" id="3022070">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3022073">return</span>&nbsp;<span class="ident" id="3022080">e</span><span class="op" id="3022081">.</span><span class="ident" id="3022082">escapeListConditionally</span><span class="op" id="3022105">(</span><span class="ident" id="3022106">c</span><span class="op" id="3022107">,</span>&nbsp;<span class="ident" id="3022109">t</span><span class="op" id="3022110">.</span><span class="ident" id="3022111">Tree</span><span class="op" id="3022115">.</span><span class="ident" id="3022116">Root</span><span class="op" id="3022120">,</span>&nbsp;<span class="ident" id="3022122">filter</span><span class="op" id="3022128">)</span><br>
<span class="lineno"></span><span class="op" id="3022130">}</span><br>
<span class="lineno">575</span><br>
<span class="lineno"></span><span class="comment" id="3022133">//&nbsp;delimEnds&nbsp;maps&nbsp;each&nbsp;delim&nbsp;to&nbsp;a&nbsp;string&nbsp;of&nbsp;characters&nbsp;that&nbsp;terminate&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="3022207">var</span>&nbsp;<span class="ident" id="3022211">delimEnds</span>&nbsp;<span class="op" id="3022221">=</span>&nbsp;<span class="op" id="3022223">[</span><span class="op" id="3022224">...</span><span class="op" id="3022227">]</span><span class="builtintype" id="3022228">string</span><span class="op" id="3022234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3022237">delimDoubleQuote</span><span class="op" id="3022253">:</span>&nbsp;<span class="string" id="3022255">`&#34;`</span><span class="op" id="3022258">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3022261">delimSingleQuote</span><span class="op" id="3022277">:</span>&nbsp;<span class="string" id="3022279">&#34;&#39;&#34;</span><span class="op" id="3022282">,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3022285">//&nbsp;Determined&nbsp;empirically&nbsp;by&nbsp;running&nbsp;the&nbsp;below&nbsp;in&nbsp;various&nbsp;browsers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3022354">//&nbsp;var&nbsp;div&nbsp;=&nbsp;document.createElement(&#34;DIV&#34;);</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3022399">//&nbsp;for&nbsp;(var&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;0x10000;&nbsp;++i)&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3022439">//&nbsp;&nbsp;&nbsp;div.innerHTML&nbsp;=&nbsp;&#34;&lt;span&nbsp;title=x&#34;&nbsp;+&nbsp;String.fromCharCode(i)&nbsp;+&nbsp;&#34;-bar&gt;&#34;;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3022513">//&nbsp;&nbsp;&nbsp;if&nbsp;(div.getElementsByTagName(&#34;SPAN&#34;)[0].title.indexOf(&#34;bar&#34;)&nbsp;&lt;&nbsp;0)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3022585">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;document.write(&#34;&lt;p&gt;U+&#34;&nbsp;+&nbsp;i.toString(16));</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3022635">//&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3022641">delimSpaceOrTagEnd</span><span class="op" id="3022659">:</span>&nbsp;<span class="string" id="3022661">&#34;&nbsp;\t\n\f\r&gt;&#34;</span><span class="op" id="3022673">,</span><br>
<span class="lineno"></span><span class="op" id="3022675">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span><span class="keyword" id="3022678">var</span>&nbsp;<span class="ident" id="3022682">doctypeBytes</span>&nbsp;<span class="op" id="3022695">=</span>&nbsp;<span class="op" id="3022697">[</span><span class="op" id="3022698">]</span><span class="builtintype" id="3022699">byte</span><span class="op" id="3022703">(</span><span class="string" id="3022704">&#34;&lt;!DOCTYPE&#34;</span><span class="op" id="3022715">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3022718">//&nbsp;escapeText&nbsp;escapes&nbsp;a&nbsp;text&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="3022762">func</span>&nbsp;<span class="op" id="3022767">(</span><span class="ident" id="3022768">e</span>&nbsp;<span class="op" id="3022770">*</span><span class="ident" id="3022771">escaper</span><span class="op" id="3022778">)</span>&nbsp;<span class="ident" id="3022780">escapeText</span><span class="op" id="3022790">(</span><span class="ident" id="3022791">c</span>&nbsp;<span class="ident" id="3022793">context</span><span class="op" id="3022800">,</span>&nbsp;<span class="ident" id="3022802">n</span>&nbsp;<span class="op" id="3022804">*</span><span class="ident" id="3022805">parse</span><span class="op" id="3022810">.</span><span class="ident" id="3022811">TextNode</span><span class="op" id="3022819">)</span>&nbsp;<span class="ident" id="3022821">context</span>&nbsp;<span class="op" id="3022829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3022832">s</span><span class="op" id="3022833">,</span>&nbsp;<span class="ident" id="3022835">written</span><span class="op" id="3022842">,</span>&nbsp;<span class="ident" id="3022844">i</span><span class="op" id="3022845">,</span>&nbsp;<span class="ident" id="3022847">b</span>&nbsp;<span class="op" id="3022849">:=</span>&nbsp;<span class="ident" id="3022852">n</span><span class="op" id="3022853">.</span><span class="ident" id="3022854">Text</span><span class="op" id="3022858">,</span>&nbsp;<span class="num" id="3022860">0</span><span class="op" id="3022861">,</span>&nbsp;<span class="num" id="3022863">0</span><span class="op" id="3022864">,</span>&nbsp;<span class="builtinfunc" id="3022866">new</span><span class="op" id="3022869">(</span><span class="ident" id="3022870">bytes</span><span class="op" id="3022875">.</span><span class="ident" id="3022876">Buffer</span><span class="op" id="3022882">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3022885">for</span>&nbsp;<span class="ident" id="3022889">i</span>&nbsp;<span class="op" id="3022891">!=</span>&nbsp;<span class="builtinfunc" id="3022894">len</span><span class="op" id="3022897">(</span><span class="ident" id="3022898">s</span><span class="op" id="3022899">)</span>&nbsp;<span class="op" id="3022901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3022905">c1</span><span class="op" id="3022907">,</span>&nbsp;<span class="ident" id="3022909">nread</span>&nbsp;<span class="op" id="3022915">:=</span>&nbsp;<span class="ident" id="3022918">contextAfterText</span><span class="op" id="3022934">(</span><span class="ident" id="3022935">c</span><span class="op" id="3022936">,</span>&nbsp;<span class="ident" id="3022938">s</span><span class="op" id="3022939">[</span><span class="ident" id="3022940">i</span><span class="op" id="3022941">:</span><span class="op" id="3022942">]</span><span class="op" id="3022943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3022947">i1</span>&nbsp;<span class="op" id="3022950">:=</span>&nbsp;<span class="ident" id="3022953">i</span>&nbsp;<span class="op" id="3022955">+</span>&nbsp;<span class="ident" id="3022957">nread</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3022965">if</span>&nbsp;<span class="ident" id="3022968">c</span><span class="op" id="3022969">.</span><span class="ident" id="3022970">state</span>&nbsp;<span class="op" id="3022976">==</span>&nbsp;<span class="ident" id="3022979">stateText</span>&nbsp;<span class="op" id="3022989">||</span>&nbsp;<span class="ident" id="3022992">c</span><span class="op" id="3022993">.</span><span class="ident" id="3022994">state</span>&nbsp;<span class="op" id="3023000">==</span>&nbsp;<span class="ident" id="3023003">stateRCDATA</span>&nbsp;<span class="op" id="3023015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3023020">end</span>&nbsp;<span class="op" id="3023024">:=</span>&nbsp;<span class="ident" id="3023027">i1</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3023033">if</span>&nbsp;<span class="ident" id="3023036">c1</span><span class="op" id="3023038">.</span><span class="ident" id="3023039">state</span>&nbsp;<span class="op" id="3023045">!=</span>&nbsp;<span class="ident" id="3023048">c</span><span class="op" id="3023049">.</span><span class="ident" id="3023050">state</span>&nbsp;<span class="op" id="3023056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3023062">for</span>&nbsp;<span class="ident" id="3023066">j</span>&nbsp;<span class="op" id="3023068">:=</span>&nbsp;<span class="ident" id="3023071">end</span>&nbsp;<span class="op" id="3023075">-</span>&nbsp;<span class="num" id="3023077">1</span><span class="op" id="3023078">;</span>&nbsp;<span class="ident" id="3023080">j</span>&nbsp;<span class="op" id="3023082">&gt;=</span>&nbsp;<span class="ident" id="3023085">i</span><span class="op" id="3023086">;</span>&nbsp;<span class="ident" id="3023088">j</span><span class="op" id="3023089">--</span>&nbsp;<span class="op" id="3023092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3023099">if</span>&nbsp;<span class="ident" id="3023102">s</span><span class="op" id="3023103">[</span><span class="ident" id="3023104">j</span><span class="op" id="3023105">]</span>&nbsp;<span class="op" id="3023107">==</span>&nbsp;<span class="string" id="3023110">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="3023114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3023122">end</span>&nbsp;<span class="op" id="3023126">=</span>&nbsp;<span class="ident" id="3023128">j</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3023136">break</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3023147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3023153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3023158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3023163">for</span>&nbsp;<span class="ident" id="3023167">j</span>&nbsp;<span class="op" id="3023169">:=</span>&nbsp;<span class="ident" id="3023172">i</span><span class="op" id="3023173">;</span>&nbsp;<span class="ident" id="3023175">j</span>&nbsp;<span class="op" id="3023177">&lt;</span>&nbsp;<span class="ident" id="3023179">end</span><span class="op" id="3023182">;</span>&nbsp;<span class="ident" id="3023184">j</span><span class="op" id="3023185">++</span>&nbsp;<span class="op" id="3023188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3023194">if</span>&nbsp;<span class="ident" id="3023197">s</span><span class="op" id="3023198">[</span><span class="ident" id="3023199">j</span><span class="op" id="3023200">]</span>&nbsp;<span class="op" id="3023202">==</span>&nbsp;<span class="string" id="3023205">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="3023209">&amp;&amp;</span>&nbsp;<span class="op" id="3023212">!</span><span class="ident" id="3023213">bytes</span><span class="op" id="3023218">.</span><span class="ident" id="3023219">HasPrefix</span><span class="op" id="3023228">(</span><span class="ident" id="3023229">bytes</span><span class="op" id="3023234">.</span><span class="ident" id="3023235">ToUpper</span><span class="op" id="3023242">(</span><span class="ident" id="3023243">s</span><span class="op" id="3023244">[</span><span class="ident" id="3023245">j</span><span class="op" id="3023246">:</span><span class="op" id="3023247">]</span><span class="op" id="3023248">)</span><span class="op" id="3023249">,</span>&nbsp;<span class="ident" id="3023251">doctypeBytes</span><span class="op" id="3023263">)</span>&nbsp;<span class="op" id="3023265">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3023272">b</span><span class="op" id="3023273">.</span><span class="ident" id="3023274">Write</span><span class="op" id="3023279">(</span><span class="ident" id="3023280">s</span><span class="op" id="3023281">[</span><span class="ident" id="3023282">written</span><span class="op" id="3023289">:</span><span class="ident" id="3023290">j</span><span class="op" id="3023291">]</span><span class="op" id="3023292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3023299">b</span><span class="op" id="3023300">.</span><span class="ident" id="3023301">WriteString</span><span class="op" id="3023312">(</span><span class="string" id="3023313">&#34;&amp;lt;&#34;</span><span class="op" id="3023319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3023326">written</span>&nbsp;<span class="op" id="3023334">=</span>&nbsp;<span class="ident" id="3023336">j</span>&nbsp;<span class="op" id="3023338">+</span>&nbsp;<span class="num" id="3023340">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3023346">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3023351">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3023355">}</span>&nbsp;<span class="keyword" id="3023357">else</span>&nbsp;<span class="keyword" id="3023362">if</span>&nbsp;<span class="ident" id="3023365">isComment</span><span class="op" id="3023374">(</span><span class="ident" id="3023375">c</span><span class="op" id="3023376">.</span><span class="ident" id="3023377">state</span><span class="op" id="3023382">)</span>&nbsp;<span class="op" id="3023384">&amp;&amp;</span>&nbsp;<span class="ident" id="3023387">c</span><span class="op" id="3023388">.</span><span class="ident" id="3023389">delim</span>&nbsp;<span class="op" id="3023395">==</span>&nbsp;<span class="ident" id="3023398">delimNone</span>&nbsp;<span class="op" id="3023408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3023413">switch</span>&nbsp;<span class="ident" id="3023420">c</span><span class="op" id="3023421">.</span><span class="ident" id="3023422">state</span>&nbsp;<span class="op" id="3023428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3023433">case</span>&nbsp;<span class="ident" id="3023438">stateJSBlockCmt</span><span class="op" id="3023453">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3023459">//&nbsp;http://es5.github.com/#x7.4:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3023495">//&nbsp;&#34;Comments&nbsp;behave&nbsp;like&nbsp;white&nbsp;space&nbsp;and&nbsp;are</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3023544">//&nbsp;discarded&nbsp;except&nbsp;that,&nbsp;if&nbsp;a&nbsp;MultiLineComment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3023596">//&nbsp;contains&nbsp;a&nbsp;line&nbsp;terminator&nbsp;character,&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3023646">//&nbsp;the&nbsp;entire&nbsp;comment&nbsp;is&nbsp;considered&nbsp;to&nbsp;be&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3023694">//&nbsp;LineTerminator&nbsp;for&nbsp;purposes&nbsp;of&nbsp;parsing&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3023743">//&nbsp;the&nbsp;syntactic&nbsp;grammar.&#34;</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3023774">if</span>&nbsp;<span class="ident" id="3023777">bytes</span><span class="op" id="3023782">.</span><span class="ident" id="3023783">IndexAny</span><span class="op" id="3023791">(</span><span class="ident" id="3023792">s</span><span class="op" id="3023793">[</span><span class="ident" id="3023794">written</span><span class="op" id="3023801">:</span><span class="ident" id="3023802">i1</span><span class="op" id="3023804">]</span><span class="op" id="3023805">,</span>&nbsp;<span class="string" id="3023807">&#34;\n\r\u2028\u2029&#34;</span><span class="op" id="3023825">)</span>&nbsp;<span class="op" id="3023827">!=</span>&nbsp;<span class="op" id="3023830">-</span><span class="num" id="3023831">1</span>&nbsp;<span class="op" id="3023833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3023840">b</span><span class="op" id="3023841">.</span><span class="ident" id="3023842">WriteByte</span><span class="op" id="3023851">(</span><span class="string" id="3023852">&#39;\n&#39;</span><span class="op" id="3023856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3023862">}</span>&nbsp;<span class="keyword" id="3023864">else</span>&nbsp;<span class="op" id="3023869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3023876">b</span><span class="op" id="3023877">.</span><span class="ident" id="3023878">WriteByte</span><span class="op" id="3023887">(</span><span class="string" id="3023888">&#39;&nbsp;&#39;</span><span class="op" id="3023891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3023897">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3023902">case</span>&nbsp;<span class="ident" id="3023907">stateCSSBlockCmt</span><span class="op" id="3023923">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3023929">b</span><span class="op" id="3023930">.</span><span class="ident" id="3023931">WriteByte</span><span class="op" id="3023940">(</span><span class="string" id="3023941">&#39;&nbsp;&#39;</span><span class="op" id="3023944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3023949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3023954">written</span>&nbsp;<span class="op" id="3023962">=</span>&nbsp;<span class="ident" id="3023964">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3023969">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3023973">if</span>&nbsp;<span class="ident" id="3023976">c</span><span class="op" id="3023977">.</span><span class="ident" id="3023978">state</span>&nbsp;<span class="op" id="3023984">!=</span>&nbsp;<span class="ident" id="3023987">c1</span><span class="op" id="3023989">.</span><span class="ident" id="3023990">state</span>&nbsp;<span class="op" id="3023996">&amp;&amp;</span>&nbsp;<span class="ident" id="3023999">isComment</span><span class="op" id="3024008">(</span><span class="ident" id="3024009">c1</span><span class="op" id="3024011">.</span><span class="ident" id="3024012">state</span><span class="op" id="3024017">)</span>&nbsp;<span class="op" id="3024019">&amp;&amp;</span>&nbsp;<span class="ident" id="3024022">c1</span><span class="op" id="3024024">.</span><span class="ident" id="3024025">delim</span>&nbsp;<span class="op" id="3024031">==</span>&nbsp;<span class="ident" id="3024034">delimNone</span>&nbsp;<span class="op" id="3024044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3024049">//&nbsp;Preserve&nbsp;the&nbsp;portion&nbsp;between&nbsp;written&nbsp;and&nbsp;the&nbsp;comment&nbsp;start.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3024115">cs</span>&nbsp;<span class="op" id="3024118">:=</span>&nbsp;<span class="ident" id="3024121">i1</span>&nbsp;<span class="op" id="3024124">-</span>&nbsp;<span class="num" id="3024126">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024131">if</span>&nbsp;<span class="ident" id="3024134">c1</span><span class="op" id="3024136">.</span><span class="ident" id="3024137">state</span>&nbsp;<span class="op" id="3024143">==</span>&nbsp;<span class="ident" id="3024146">stateHTMLCmt</span>&nbsp;<span class="op" id="3024159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3024165">//&nbsp;&#34;&lt;!--&#34;&nbsp;instead&nbsp;of&nbsp;&#34;/*&#34;&nbsp;or&nbsp;&#34;//&#34;</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3024203">cs</span>&nbsp;<span class="op" id="3024206">-=</span>&nbsp;<span class="num" id="3024209">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3024214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3024219">b</span><span class="op" id="3024220">.</span><span class="ident" id="3024221">Write</span><span class="op" id="3024226">(</span><span class="ident" id="3024227">s</span><span class="op" id="3024228">[</span><span class="ident" id="3024229">written</span><span class="op" id="3024236">:</span><span class="ident" id="3024237">cs</span><span class="op" id="3024239">]</span><span class="op" id="3024240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3024245">written</span>&nbsp;<span class="op" id="3024253">=</span>&nbsp;<span class="ident" id="3024255">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3024260">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024264">if</span>&nbsp;<span class="ident" id="3024267">i</span>&nbsp;<span class="op" id="3024269">==</span>&nbsp;<span class="ident" id="3024272">i1</span>&nbsp;<span class="op" id="3024275">&amp;&amp;</span>&nbsp;<span class="ident" id="3024278">c</span><span class="op" id="3024279">.</span><span class="ident" id="3024280">state</span>&nbsp;<span class="op" id="3024286">==</span>&nbsp;<span class="ident" id="3024289">c1</span><span class="op" id="3024291">.</span><span class="ident" id="3024292">state</span>&nbsp;<span class="op" id="3024298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3024303">panic</span><span class="op" id="3024308">(</span><span class="ident" id="3024309">fmt</span><span class="op" id="3024312">.</span><span class="ident" id="3024313">Sprintf</span><span class="op" id="3024320">(</span><span class="string" id="3024321">&#34;infinite&nbsp;loop&nbsp;from&nbsp;%v&nbsp;to&nbsp;%v&nbsp;on&nbsp;%q..%q&#34;</span><span class="op" id="3024360">,</span>&nbsp;<span class="ident" id="3024362">c</span><span class="op" id="3024363">,</span>&nbsp;<span class="ident" id="3024365">c1</span><span class="op" id="3024367">,</span>&nbsp;<span class="ident" id="3024369">s</span><span class="op" id="3024370">[</span><span class="op" id="3024371">:</span><span class="ident" id="3024372">i</span><span class="op" id="3024373">]</span><span class="op" id="3024374">,</span>&nbsp;<span class="ident" id="3024376">s</span><span class="op" id="3024377">[</span><span class="ident" id="3024378">i</span><span class="op" id="3024379">:</span><span class="op" id="3024380">]</span><span class="op" id="3024381">)</span><span class="op" id="3024382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3024386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3024390">c</span><span class="op" id="3024391">,</span>&nbsp;<span class="ident" id="3024393">i</span>&nbsp;<span class="op" id="3024395">=</span>&nbsp;<span class="ident" id="3024397">c1</span><span class="op" id="3024399">,</span>&nbsp;<span class="ident" id="3024401">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3024405">}</span><br>
<span class="lineno">650</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024409">if</span>&nbsp;<span class="ident" id="3024412">written</span>&nbsp;<span class="op" id="3024420">!=</span>&nbsp;<span class="num" id="3024423">0</span>&nbsp;<span class="op" id="3024425">&amp;&amp;</span>&nbsp;<span class="ident" id="3024428">c</span><span class="op" id="3024429">.</span><span class="ident" id="3024430">state</span>&nbsp;<span class="op" id="3024436">!=</span>&nbsp;<span class="ident" id="3024439">stateError</span>&nbsp;<span class="op" id="3024450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024454">if</span>&nbsp;<span class="op" id="3024457">!</span><span class="ident" id="3024458">isComment</span><span class="op" id="3024467">(</span><span class="ident" id="3024468">c</span><span class="op" id="3024469">.</span><span class="ident" id="3024470">state</span><span class="op" id="3024475">)</span>&nbsp;<span class="op" id="3024477">||</span>&nbsp;<span class="ident" id="3024480">c</span><span class="op" id="3024481">.</span><span class="ident" id="3024482">delim</span>&nbsp;<span class="op" id="3024488">!=</span>&nbsp;<span class="ident" id="3024491">delimNone</span>&nbsp;<span class="op" id="3024501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3024506">b</span><span class="op" id="3024507">.</span><span class="ident" id="3024508">Write</span><span class="op" id="3024513">(</span><span class="ident" id="3024514">n</span><span class="op" id="3024515">.</span><span class="ident" id="3024516">Text</span><span class="op" id="3024520">[</span><span class="ident" id="3024521">written</span><span class="op" id="3024528">:</span><span class="op" id="3024529">]</span><span class="op" id="3024530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3024534">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3024538">e</span><span class="op" id="3024539">.</span><span class="ident" id="3024540">editTextNode</span><span class="op" id="3024552">(</span><span class="ident" id="3024553">n</span><span class="op" id="3024554">,</span>&nbsp;<span class="ident" id="3024556">b</span><span class="op" id="3024557">.</span><span class="ident" id="3024558">Bytes</span><span class="op" id="3024563">(</span><span class="op" id="3024564">)</span><span class="op" id="3024565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3024568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024571">return</span>&nbsp;<span class="ident" id="3024578">c</span><br>
<span class="lineno"></span><span class="op" id="3024580">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span><span class="comment" id="3024583">//&nbsp;contextAfterText&nbsp;starts&nbsp;in&nbsp;context&nbsp;c,&nbsp;consumes&nbsp;some&nbsp;tokens&nbsp;from&nbsp;the&nbsp;front&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3024663">//&nbsp;s,&nbsp;then&nbsp;returns&nbsp;the&nbsp;context&nbsp;after&nbsp;those&nbsp;tokens&nbsp;and&nbsp;the&nbsp;unprocessed&nbsp;suffix.</span><br>
<span class="lineno"></span><span class="keyword" id="3024741">func</span>&nbsp;<span class="ident" id="3024746">contextAfterText</span><span class="op" id="3024762">(</span><span class="ident" id="3024763">c</span>&nbsp;<span class="ident" id="3024765">context</span><span class="op" id="3024772">,</span>&nbsp;<span class="ident" id="3024774">s</span>&nbsp;<span class="op" id="3024776">[</span><span class="op" id="3024777">]</span><span class="builtintype" id="3024778">byte</span><span class="op" id="3024782">)</span>&nbsp;<span class="op" id="3024784">(</span><span class="ident" id="3024785">context</span><span class="op" id="3024792">,</span>&nbsp;<span class="builtintype" id="3024794">int</span><span class="op" id="3024797">)</span>&nbsp;<span class="op" id="3024799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024802">if</span>&nbsp;<span class="ident" id="3024805">c</span><span class="op" id="3024806">.</span><span class="ident" id="3024807">delim</span>&nbsp;<span class="op" id="3024813">==</span>&nbsp;<span class="ident" id="3024816">delimNone</span>&nbsp;<span class="op" id="3024826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3024830">c1</span><span class="op" id="3024832">,</span>&nbsp;<span class="ident" id="3024834">i</span>&nbsp;<span class="op" id="3024836">:=</span>&nbsp;<span class="ident" id="3024839">tSpecialTagEnd</span><span class="op" id="3024853">(</span><span class="ident" id="3024854">c</span><span class="op" id="3024855">,</span>&nbsp;<span class="ident" id="3024857">s</span><span class="op" id="3024858">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024862">if</span>&nbsp;<span class="ident" id="3024865">i</span>&nbsp;<span class="op" id="3024867">==</span>&nbsp;<span class="num" id="3024870">0</span>&nbsp;<span class="op" id="3024872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3024877">//&nbsp;A&nbsp;special&nbsp;end&nbsp;tag&nbsp;(`&lt;/script&gt;`)&nbsp;has&nbsp;been&nbsp;seen&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3024933">//&nbsp;all&nbsp;content&nbsp;preceding&nbsp;it&nbsp;has&nbsp;been&nbsp;consumed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024983">return</span>&nbsp;<span class="ident" id="3024990">c1</span><span class="op" id="3024992">,</span>&nbsp;<span class="num" id="3024994">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3024998">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3025002">//&nbsp;Consider&nbsp;all&nbsp;content&nbsp;up&nbsp;to&nbsp;any&nbsp;end&nbsp;tag.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3025047">return</span>&nbsp;<span class="ident" id="3025054">transitionFunc</span><span class="op" id="3025068">[</span><span class="ident" id="3025069">c</span><span class="op" id="3025070">.</span><span class="ident" id="3025071">state</span><span class="op" id="3025076">]</span><span class="op" id="3025077">(</span><span class="ident" id="3025078">c</span><span class="op" id="3025079">,</span>&nbsp;<span class="ident" id="3025081">s</span><span class="op" id="3025082">[</span><span class="op" id="3025083">:</span><span class="ident" id="3025084">i</span><span class="op" id="3025085">]</span><span class="op" id="3025086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3025089">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025093">i</span>&nbsp;<span class="op" id="3025095">:=</span>&nbsp;<span class="ident" id="3025098">bytes</span><span class="op" id="3025103">.</span><span class="ident" id="3025104">IndexAny</span><span class="op" id="3025112">(</span><span class="ident" id="3025113">s</span><span class="op" id="3025114">,</span>&nbsp;<span class="ident" id="3025116">delimEnds</span><span class="op" id="3025125">[</span><span class="ident" id="3025126">c</span><span class="op" id="3025127">.</span><span class="ident" id="3025128">delim</span><span class="op" id="3025133">]</span><span class="op" id="3025134">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3025137">if</span>&nbsp;<span class="ident" id="3025140">i</span>&nbsp;<span class="op" id="3025142">==</span>&nbsp;<span class="op" id="3025145">-</span><span class="num" id="3025146">1</span>&nbsp;<span class="op" id="3025148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025152">i</span>&nbsp;<span class="op" id="3025154">=</span>&nbsp;<span class="builtinfunc" id="3025156">len</span><span class="op" id="3025159">(</span><span class="ident" id="3025160">s</span><span class="op" id="3025161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3025164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3025167">if</span>&nbsp;<span class="ident" id="3025170">c</span><span class="op" id="3025171">.</span><span class="ident" id="3025172">delim</span>&nbsp;<span class="op" id="3025178">==</span>&nbsp;<span class="ident" id="3025181">delimSpaceOrTagEnd</span>&nbsp;<span class="op" id="3025200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3025204">//&nbsp;http://www.w3.org/TR/html5/syntax.html#attribute-value-(unquoted)-state</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3025281">//&nbsp;lists&nbsp;the&nbsp;runes&nbsp;below&nbsp;as&nbsp;error&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3025329">//&nbsp;Error&nbsp;out&nbsp;because&nbsp;HTML&nbsp;parsers&nbsp;may&nbsp;differ&nbsp;on&nbsp;whether</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3025387">//&nbsp;&#34;&lt;a&nbsp;id=&nbsp;onclick=f(&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ends&nbsp;inside&nbsp;id&#39;s&nbsp;or&nbsp;onclick&#39;s&nbsp;value,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3025453">//&nbsp;&#34;&lt;a&nbsp;class=`foo&nbsp;&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ends&nbsp;inside&nbsp;a&nbsp;value,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3025503">//&nbsp;&#34;&lt;a&nbsp;style=font:&#39;Arial&#39;&#34;&nbsp;needs&nbsp;open-quote&nbsp;fixup.</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3025556">//&nbsp;IE&nbsp;treats&nbsp;&#39;`&#39;&nbsp;as&nbsp;a&nbsp;quotation&nbsp;character.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3025601">if</span>&nbsp;<span class="ident" id="3025604">j</span>&nbsp;<span class="op" id="3025606">:=</span>&nbsp;<span class="ident" id="3025609">bytes</span><span class="op" id="3025614">.</span><span class="ident" id="3025615">IndexAny</span><span class="op" id="3025623">(</span><span class="ident" id="3025624">s</span><span class="op" id="3025625">[</span><span class="op" id="3025626">:</span><span class="ident" id="3025627">i</span><span class="op" id="3025628">]</span><span class="op" id="3025629">,</span>&nbsp;<span class="string" id="3025631">&#34;\&#34;&#39;&lt;=`&#34;</span><span class="op" id="3025639">)</span><span class="op" id="3025640">;</span>&nbsp;<span class="ident" id="3025642">j</span>&nbsp;<span class="op" id="3025644">&gt;=</span>&nbsp;<span class="num" id="3025647">0</span>&nbsp;<span class="op" id="3025649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3025654">return</span>&nbsp;<span class="ident" id="3025661">context</span><span class="op" id="3025668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025674">state</span><span class="op" id="3025679">:</span>&nbsp;<span class="ident" id="3025681">stateError</span><span class="op" id="3025691">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025697">err</span><span class="op" id="3025700">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3025704">errorf</span><span class="op" id="3025710">(</span><span class="ident" id="3025711">ErrBadHTML</span><span class="op" id="3025721">,</span>&nbsp;<span class="builtintype" id="3025723">nil</span><span class="op" id="3025726">,</span>&nbsp;<span class="num" id="3025728">0</span><span class="op" id="3025729">,</span>&nbsp;<span class="string" id="3025731">&#34;%q&nbsp;in&nbsp;unquoted&nbsp;attr:&nbsp;%q&#34;</span><span class="op" id="3025756">,</span>&nbsp;<span class="ident" id="3025758">s</span><span class="op" id="3025759">[</span><span class="ident" id="3025760">j</span><span class="op" id="3025761">:</span><span class="ident" id="3025762">j</span><span class="op" id="3025763">+</span><span class="num" id="3025764">1</span><span class="op" id="3025765">]</span><span class="op" id="3025766">,</span>&nbsp;<span class="ident" id="3025768">s</span><span class="op" id="3025769">[</span><span class="op" id="3025770">:</span><span class="ident" id="3025771">i</span><span class="op" id="3025772">]</span><span class="op" id="3025773">)</span><span class="op" id="3025774">,</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3025779">}</span><span class="op" id="3025780">,</span>&nbsp;<span class="builtinfunc" id="3025782">len</span><span class="op" id="3025785">(</span><span class="ident" id="3025786">s</span><span class="op" id="3025787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3025791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3025794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3025797">if</span>&nbsp;<span class="ident" id="3025800">i</span>&nbsp;<span class="op" id="3025802">==</span>&nbsp;<span class="builtinfunc" id="3025805">len</span><span class="op" id="3025808">(</span><span class="ident" id="3025809">s</span><span class="op" id="3025810">)</span>&nbsp;<span class="op" id="3025812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3025816">//&nbsp;Remain&nbsp;inside&nbsp;the&nbsp;attribute.</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3025850">//&nbsp;Decode&nbsp;the&nbsp;value&nbsp;so&nbsp;non-HTML&nbsp;rules&nbsp;can&nbsp;easily&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3025908">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;button&nbsp;onclick=&#34;alert(&amp;quot;Hi!&amp;quot;)&#34;&gt;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3025959">//&nbsp;without&nbsp;having&nbsp;to&nbsp;entity&nbsp;decode&nbsp;token&nbsp;boundaries.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026014">for</span>&nbsp;<span class="ident" id="3026018">u</span>&nbsp;<span class="op" id="3026020">:=</span>&nbsp;<span class="op" id="3026023">[</span><span class="op" id="3026024">]</span><span class="builtintype" id="3026025">byte</span><span class="op" id="3026029">(</span><span class="ident" id="3026030">html</span><span class="op" id="3026034">.</span><span class="ident" id="3026035">UnescapeString</span><span class="op" id="3026049">(</span><span class="builtintype" id="3026050">string</span><span class="op" id="3026056">(</span><span class="ident" id="3026057">s</span><span class="op" id="3026058">)</span><span class="op" id="3026059">)</span><span class="op" id="3026060">)</span><span class="op" id="3026061">;</span>&nbsp;<span class="builtinfunc" id="3026063">len</span><span class="op" id="3026066">(</span><span class="ident" id="3026067">u</span><span class="op" id="3026068">)</span>&nbsp;<span class="op" id="3026070">!=</span>&nbsp;<span class="num" id="3026073">0</span><span class="op" id="3026074">;</span>&nbsp;<span class="op" id="3026076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3026081">c1</span><span class="op" id="3026083">,</span>&nbsp;<span class="ident" id="3026085">i1</span>&nbsp;<span class="op" id="3026088">:=</span>&nbsp;<span class="ident" id="3026091">transitionFunc</span><span class="op" id="3026105">[</span><span class="ident" id="3026106">c</span><span class="op" id="3026107">.</span><span class="ident" id="3026108">state</span><span class="op" id="3026113">]</span><span class="op" id="3026114">(</span><span class="ident" id="3026115">c</span><span class="op" id="3026116">,</span>&nbsp;<span class="ident" id="3026118">u</span><span class="op" id="3026119">)</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3026124">c</span><span class="op" id="3026125">,</span>&nbsp;<span class="ident" id="3026127">u</span>&nbsp;<span class="op" id="3026129">=</span>&nbsp;<span class="ident" id="3026131">c1</span><span class="op" id="3026133">,</span>&nbsp;<span class="ident" id="3026135">u</span><span class="op" id="3026136">[</span><span class="ident" id="3026137">i1</span><span class="op" id="3026139">:</span><span class="op" id="3026140">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3026144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026148">return</span>&nbsp;<span class="ident" id="3026155">c</span><span class="op" id="3026156">,</span>&nbsp;<span class="builtinfunc" id="3026158">len</span><span class="op" id="3026161">(</span><span class="ident" id="3026162">s</span><span class="op" id="3026163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3026166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026169">if</span>&nbsp;<span class="ident" id="3026172">c</span><span class="op" id="3026173">.</span><span class="ident" id="3026174">delim</span>&nbsp;<span class="op" id="3026180">!=</span>&nbsp;<span class="ident" id="3026183">delimSpaceOrTagEnd</span>&nbsp;<span class="op" id="3026202">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3026206">//&nbsp;Consume&nbsp;any&nbsp;quote.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3026230">i</span><span class="op" id="3026231">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3026235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3026238">//&nbsp;On&nbsp;exiting&nbsp;an&nbsp;attribute,&nbsp;we&nbsp;discard&nbsp;all&nbsp;state&nbsp;information</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3026300">//&nbsp;except&nbsp;the&nbsp;state&nbsp;and&nbsp;element.</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026334">return</span>&nbsp;<span class="ident" id="3026341">context</span><span class="op" id="3026348">{</span><span class="ident" id="3026349">state</span><span class="op" id="3026354">:</span>&nbsp;<span class="ident" id="3026356">stateTag</span><span class="op" id="3026364">,</span>&nbsp;<span class="ident" id="3026366">element</span><span class="op" id="3026373">:</span>&nbsp;<span class="ident" id="3026375">c</span><span class="op" id="3026376">.</span><span class="ident" id="3026377">element</span><span class="op" id="3026384">}</span><span class="op" id="3026385">,</span>&nbsp;<span class="ident" id="3026387">i</span><br>
<span class="lineno"></span><span class="op" id="3026389">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3026392">//&nbsp;editActionNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;an&nbsp;action&nbsp;pipeline&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno"></span><span class="keyword" id="3026467">func</span>&nbsp;<span class="op" id="3026472">(</span><span class="ident" id="3026473">e</span>&nbsp;<span class="op" id="3026475">*</span><span class="ident" id="3026476">escaper</span><span class="op" id="3026483">)</span>&nbsp;<span class="ident" id="3026485">editActionNode</span><span class="op" id="3026499">(</span><span class="ident" id="3026500">n</span>&nbsp;<span class="op" id="3026502">*</span><span class="ident" id="3026503">parse</span><span class="op" id="3026508">.</span><span class="ident" id="3026509">ActionNode</span><span class="op" id="3026519">,</span>&nbsp;<span class="ident" id="3026521">cmds</span>&nbsp;<span class="op" id="3026526">[</span><span class="op" id="3026527">]</span><span class="builtintype" id="3026528">string</span><span class="op" id="3026534">)</span>&nbsp;<span class="op" id="3026536">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026539">if</span>&nbsp;<span class="ident" id="3026542">_</span><span class="op" id="3026543">,</span>&nbsp;<span class="ident" id="3026545">ok</span>&nbsp;<span class="op" id="3026548">:=</span>&nbsp;<span class="ident" id="3026551">e</span><span class="op" id="3026552">.</span><span class="ident" id="3026553">actionNodeEdits</span><span class="op" id="3026568">[</span><span class="ident" id="3026569">n</span><span class="op" id="3026570">]</span><span class="op" id="3026571">;</span>&nbsp;<span class="ident" id="3026573">ok</span>&nbsp;<span class="op" id="3026576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3026580">panic</span><span class="op" id="3026585">(</span><span class="ident" id="3026586">fmt</span><span class="op" id="3026589">.</span><span class="ident" id="3026590">Sprintf</span><span class="op" id="3026597">(</span><span class="string" id="3026598">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="3026632">,</span>&nbsp;<span class="ident" id="3026634">n</span><span class="op" id="3026635">)</span><span class="op" id="3026636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3026639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3026642">e</span><span class="op" id="3026643">.</span><span class="ident" id="3026644">actionNodeEdits</span><span class="op" id="3026659">[</span><span class="ident" id="3026660">n</span><span class="op" id="3026661">]</span>&nbsp;<span class="op" id="3026663">=</span>&nbsp;<span class="ident" id="3026665">cmds</span><br>
<span class="lineno"></span><span class="op" id="3026670">}</span><br>
<span class="lineno">720</span><br>
<span class="lineno"></span><span class="comment" id="3026673">//&nbsp;editTemplateNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;a&nbsp;{{template}}&nbsp;callee&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno"></span><span class="keyword" id="3026753">func</span>&nbsp;<span class="op" id="3026758">(</span><span class="ident" id="3026759">e</span>&nbsp;<span class="op" id="3026761">*</span><span class="ident" id="3026762">escaper</span><span class="op" id="3026769">)</span>&nbsp;<span class="ident" id="3026771">editTemplateNode</span><span class="op" id="3026787">(</span><span class="ident" id="3026788">n</span>&nbsp;<span class="op" id="3026790">*</span><span class="ident" id="3026791">parse</span><span class="op" id="3026796">.</span><span class="ident" id="3026797">TemplateNode</span><span class="op" id="3026809">,</span>&nbsp;<span class="ident" id="3026811">callee</span>&nbsp;<span class="builtintype" id="3026818">string</span><span class="op" id="3026824">)</span>&nbsp;<span class="op" id="3026826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026829">if</span>&nbsp;<span class="ident" id="3026832">_</span><span class="op" id="3026833">,</span>&nbsp;<span class="ident" id="3026835">ok</span>&nbsp;<span class="op" id="3026838">:=</span>&nbsp;<span class="ident" id="3026841">e</span><span class="op" id="3026842">.</span><span class="ident" id="3026843">templateNodeEdits</span><span class="op" id="3026860">[</span><span class="ident" id="3026861">n</span><span class="op" id="3026862">]</span><span class="op" id="3026863">;</span>&nbsp;<span class="ident" id="3026865">ok</span>&nbsp;<span class="op" id="3026868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3026872">panic</span><span class="op" id="3026877">(</span><span class="ident" id="3026878">fmt</span><span class="op" id="3026881">.</span><span class="ident" id="3026882">Sprintf</span><span class="op" id="3026889">(</span><span class="string" id="3026890">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="3026924">,</span>&nbsp;<span class="ident" id="3026926">n</span><span class="op" id="3026927">)</span><span class="op" id="3026928">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3026931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3026934">e</span><span class="op" id="3026935">.</span><span class="ident" id="3026936">templateNodeEdits</span><span class="op" id="3026953">[</span><span class="ident" id="3026954">n</span><span class="op" id="3026955">]</span>&nbsp;<span class="op" id="3026957">=</span>&nbsp;<span class="ident" id="3026959">callee</span><br>
<span class="lineno"></span><span class="op" id="3026966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3026969">//&nbsp;editTextNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;a&nbsp;text&nbsp;node&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno">730</span><span class="keyword" id="3027035">func</span>&nbsp;<span class="op" id="3027040">(</span><span class="ident" id="3027041">e</span>&nbsp;<span class="op" id="3027043">*</span><span class="ident" id="3027044">escaper</span><span class="op" id="3027051">)</span>&nbsp;<span class="ident" id="3027053">editTextNode</span><span class="op" id="3027065">(</span><span class="ident" id="3027066">n</span>&nbsp;<span class="op" id="3027068">*</span><span class="ident" id="3027069">parse</span><span class="op" id="3027074">.</span><span class="ident" id="3027075">TextNode</span><span class="op" id="3027083">,</span>&nbsp;<span class="ident" id="3027085">text</span>&nbsp;<span class="op" id="3027090">[</span><span class="op" id="3027091">]</span><span class="builtintype" id="3027092">byte</span><span class="op" id="3027096">)</span>&nbsp;<span class="op" id="3027098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3027101">if</span>&nbsp;<span class="ident" id="3027104">_</span><span class="op" id="3027105">,</span>&nbsp;<span class="ident" id="3027107">ok</span>&nbsp;<span class="op" id="3027110">:=</span>&nbsp;<span class="ident" id="3027113">e</span><span class="op" id="3027114">.</span><span class="ident" id="3027115">textNodeEdits</span><span class="op" id="3027128">[</span><span class="ident" id="3027129">n</span><span class="op" id="3027130">]</span><span class="op" id="3027131">;</span>&nbsp;<span class="ident" id="3027133">ok</span>&nbsp;<span class="op" id="3027136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3027140">panic</span><span class="op" id="3027145">(</span><span class="ident" id="3027146">fmt</span><span class="op" id="3027149">.</span><span class="ident" id="3027150">Sprintf</span><span class="op" id="3027157">(</span><span class="string" id="3027158">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="3027192">,</span>&nbsp;<span class="ident" id="3027194">n</span><span class="op" id="3027195">)</span><span class="op" id="3027196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3027199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3027202">e</span><span class="op" id="3027203">.</span><span class="ident" id="3027204">textNodeEdits</span><span class="op" id="3027217">[</span><span class="ident" id="3027218">n</span><span class="op" id="3027219">]</span>&nbsp;<span class="op" id="3027221">=</span>&nbsp;<span class="ident" id="3027223">text</span><br>
<span class="lineno">735</span><span class="op" id="3027228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3027231">//&nbsp;commit&nbsp;applies&nbsp;changes&nbsp;to&nbsp;actions&nbsp;and&nbsp;template&nbsp;calls&nbsp;needed&nbsp;to&nbsp;contextually</span><br>
<span class="lineno"></span><span class="comment" id="3027310">//&nbsp;autoescape&nbsp;content&nbsp;and&nbsp;adds&nbsp;any&nbsp;derived&nbsp;templates&nbsp;to&nbsp;the&nbsp;set.</span><br>
<span class="lineno"></span><span class="keyword" id="3027375">func</span>&nbsp;<span class="op" id="3027380">(</span><span class="ident" id="3027381">e</span>&nbsp;<span class="op" id="3027383">*</span><span class="ident" id="3027384">escaper</span><span class="op" id="3027391">)</span>&nbsp;<span class="ident" id="3027393">commit</span><span class="op" id="3027399">(</span><span class="op" id="3027400">)</span>&nbsp;<span class="op" id="3027402">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3027405">for</span>&nbsp;<span class="ident" id="3027409">name</span>&nbsp;<span class="op" id="3027414">:=</span>&nbsp;<span class="keyword" id="3027417">range</span>&nbsp;<span class="ident" id="3027423">e</span><span class="op" id="3027424">.</span><span class="ident" id="3027425">output</span>&nbsp;<span class="op" id="3027432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3027436">e</span><span class="op" id="3027437">.</span><span class="ident" id="3027438">template</span><span class="op" id="3027446">(</span><span class="ident" id="3027447">name</span><span class="op" id="3027451">)</span><span class="op" id="3027452">.</span><span class="ident" id="3027453">Funcs</span><span class="op" id="3027458">(</span><span class="ident" id="3027459">funcMap</span><span class="op" id="3027466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3027469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3027472">for</span>&nbsp;<span class="ident" id="3027476">_</span><span class="op" id="3027477">,</span>&nbsp;<span class="ident" id="3027479">t</span>&nbsp;<span class="op" id="3027481">:=</span>&nbsp;<span class="keyword" id="3027484">range</span>&nbsp;<span class="ident" id="3027490">e</span><span class="op" id="3027491">.</span><span class="ident" id="3027492">derived</span>&nbsp;<span class="op" id="3027500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3027504">if</span>&nbsp;<span class="ident" id="3027507">_</span><span class="op" id="3027508">,</span>&nbsp;<span class="ident" id="3027510">err</span>&nbsp;<span class="op" id="3027514">:=</span>&nbsp;<span class="ident" id="3027517">e</span><span class="op" id="3027518">.</span><span class="ident" id="3027519">tmpl</span><span class="op" id="3027523">.</span><span class="ident" id="3027524">text</span><span class="op" id="3027528">.</span><span class="ident" id="3027529">AddParseTree</span><span class="op" id="3027541">(</span><span class="ident" id="3027542">t</span><span class="op" id="3027543">.</span><span class="ident" id="3027544">Name</span><span class="op" id="3027548">(</span><span class="op" id="3027549">)</span><span class="op" id="3027550">,</span>&nbsp;<span class="ident" id="3027552">t</span><span class="op" id="3027553">.</span><span class="ident" id="3027554">Tree</span><span class="op" id="3027558">)</span><span class="op" id="3027559">;</span>&nbsp;<span class="ident" id="3027561">err</span>&nbsp;<span class="op" id="3027565">!=</span>&nbsp;<span class="builtintype" id="3027568">nil</span>&nbsp;<span class="op" id="3027572">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3027577">panic</span><span class="op" id="3027582">(</span><span class="string" id="3027583">&#34;error&nbsp;adding&nbsp;derived&nbsp;template&#34;</span><span class="op" id="3027614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3027618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3027621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3027624">for</span>&nbsp;<span class="ident" id="3027628">n</span><span class="op" id="3027629">,</span>&nbsp;<span class="ident" id="3027631">s</span>&nbsp;<span class="op" id="3027633">:=</span>&nbsp;<span class="keyword" id="3027636">range</span>&nbsp;<span class="ident" id="3027642">e</span><span class="op" id="3027643">.</span><span class="ident" id="3027644">actionNodeEdits</span>&nbsp;<span class="op" id="3027660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3027664">ensurePipelineContains</span><span class="op" id="3027686">(</span><span class="ident" id="3027687">n</span><span class="op" id="3027688">.</span><span class="ident" id="3027689">Pipe</span><span class="op" id="3027693">,</span>&nbsp;<span class="ident" id="3027695">s</span><span class="op" id="3027696">)</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3027699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3027702">for</span>&nbsp;<span class="ident" id="3027706">n</span><span class="op" id="3027707">,</span>&nbsp;<span class="ident" id="3027709">name</span>&nbsp;<span class="op" id="3027714">:=</span>&nbsp;<span class="keyword" id="3027717">range</span>&nbsp;<span class="ident" id="3027723">e</span><span class="op" id="3027724">.</span><span class="ident" id="3027725">templateNodeEdits</span>&nbsp;<span class="op" id="3027743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3027747">n</span><span class="op" id="3027748">.</span><span class="ident" id="3027749">Name</span>&nbsp;<span class="op" id="3027754">=</span>&nbsp;<span class="ident" id="3027756">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3027762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3027765">for</span>&nbsp;<span class="ident" id="3027769">n</span><span class="op" id="3027770">,</span>&nbsp;<span class="ident" id="3027772">s</span>&nbsp;<span class="op" id="3027774">:=</span>&nbsp;<span class="keyword" id="3027777">range</span>&nbsp;<span class="ident" id="3027783">e</span><span class="op" id="3027784">.</span><span class="ident" id="3027785">textNodeEdits</span>&nbsp;<span class="op" id="3027799">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3027803">n</span><span class="op" id="3027804">.</span><span class="ident" id="3027805">Text</span>&nbsp;<span class="op" id="3027810">=</span>&nbsp;<span class="ident" id="3027812">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3027815">}</span><br>
<span class="lineno"></span><span class="op" id="3027817">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3027820">//&nbsp;template&nbsp;returns&nbsp;the&nbsp;named&nbsp;template&nbsp;given&nbsp;a&nbsp;mangled&nbsp;template&nbsp;name.</span><br>
<span class="lineno">760</span><span class="keyword" id="3027890">func</span>&nbsp;<span class="op" id="3027895">(</span><span class="ident" id="3027896">e</span>&nbsp;<span class="op" id="3027898">*</span><span class="ident" id="3027899">escaper</span><span class="op" id="3027906">)</span>&nbsp;<span class="ident" id="3027908">template</span><span class="op" id="3027916">(</span><span class="ident" id="3027917">name</span>&nbsp;<span class="builtintype" id="3027922">string</span><span class="op" id="3027928">)</span>&nbsp;<span class="op" id="3027930">*</span><span class="ident" id="3027931">template</span><span class="op" id="3027939">.</span><span class="ident" id="3027940">Template</span>&nbsp;<span class="op" id="3027949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3027952">t</span>&nbsp;<span class="op" id="3027954">:=</span>&nbsp;<span class="ident" id="3027957">e</span><span class="op" id="3027958">.</span><span class="ident" id="3027959">tmpl</span><span class="op" id="3027963">.</span><span class="ident" id="3027964">text</span><span class="op" id="3027968">.</span><span class="ident" id="3027969">Lookup</span><span class="op" id="3027975">(</span><span class="ident" id="3027976">name</span><span class="op" id="3027980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3027983">if</span>&nbsp;<span class="ident" id="3027986">t</span>&nbsp;<span class="op" id="3027988">==</span>&nbsp;<span class="builtintype" id="3027991">nil</span>&nbsp;<span class="op" id="3027995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3027999">t</span>&nbsp;<span class="op" id="3028001">=</span>&nbsp;<span class="ident" id="3028003">e</span><span class="op" id="3028004">.</span><span class="ident" id="3028005">derived</span><span class="op" id="3028012">[</span><span class="ident" id="3028013">name</span><span class="op" id="3028017">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3028020">}</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3028023">return</span>&nbsp;<span class="ident" id="3028030">t</span><br>
<span class="lineno"></span><span class="op" id="3028032">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3028035">//&nbsp;Forwarding&nbsp;functions&nbsp;so&nbsp;that&nbsp;clients&nbsp;need&nbsp;only&nbsp;import&nbsp;this&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="3028105">//&nbsp;to&nbsp;reach&nbsp;the&nbsp;general&nbsp;escaping&nbsp;functions&nbsp;of&nbsp;text/template.</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span><span class="comment" id="3028167">//&nbsp;HTMLEscape&nbsp;writes&nbsp;to&nbsp;w&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="3028247">func</span>&nbsp;<span class="ident" id="3028252">HTMLEscape</span><span class="op" id="3028262">(</span><span class="ident" id="3028263">w</span>&nbsp;<span class="ident" id="3028265">io</span><span class="op" id="3028267">.</span><span class="ident" id="3028268">Writer</span><span class="op" id="3028274">,</span>&nbsp;<span class="ident" id="3028276">b</span>&nbsp;<span class="op" id="3028278">[</span><span class="op" id="3028279">]</span><span class="builtintype" id="3028280">byte</span><span class="op" id="3028284">)</span>&nbsp;<span class="op" id="3028286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3028289">template</span><span class="op" id="3028297">.</span><span class="ident" id="3028298">HTMLEscape</span><span class="op" id="3028308">(</span><span class="ident" id="3028309">w</span><span class="op" id="3028310">,</span>&nbsp;<span class="ident" id="3028312">b</span><span class="op" id="3028313">)</span><br>
<span class="lineno"></span><span class="op" id="3028315">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span><span class="comment" id="3028318">//&nbsp;HTMLEscapeString&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="3028400">func</span>&nbsp;<span class="ident" id="3028405">HTMLEscapeString</span><span class="op" id="3028421">(</span><span class="ident" id="3028422">s</span>&nbsp;<span class="builtintype" id="3028424">string</span><span class="op" id="3028430">)</span>&nbsp;<span class="builtintype" id="3028432">string</span>&nbsp;<span class="op" id="3028439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3028442">return</span>&nbsp;<span class="ident" id="3028449">template</span><span class="op" id="3028457">.</span><span class="ident" id="3028458">HTMLEscapeString</span><span class="op" id="3028474">(</span><span class="ident" id="3028475">s</span><span class="op" id="3028476">)</span><br>
<span class="lineno"></span><span class="op" id="3028478">}</span><br>
<span class="lineno">780</span><br>
<span class="lineno"></span><span class="comment" id="3028481">//&nbsp;HTMLEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;textual</span><br>
<span class="lineno"></span><span class="comment" id="3028547">//&nbsp;representation&nbsp;of&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="keyword" id="3028583">func</span>&nbsp;<span class="ident" id="3028588">HTMLEscaper</span><span class="op" id="3028599">(</span><span class="ident" id="3028600">args</span>&nbsp;<span class="op" id="3028605">...</span><span class="keyword" id="3028608">interface</span><span class="op" id="3028617">{</span><span class="op" id="3028618">}</span><span class="op" id="3028619">)</span>&nbsp;<span class="builtintype" id="3028621">string</span>&nbsp;<span class="op" id="3028628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3028631">return</span>&nbsp;<span class="ident" id="3028638">template</span><span class="op" id="3028646">.</span><span class="ident" id="3028647">HTMLEscaper</span><span class="op" id="3028658">(</span><span class="ident" id="3028659">args</span><span class="op" id="3028663">...</span><span class="op" id="3028666">)</span><br>
<span class="lineno">785</span><span class="op" id="3028668">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3028671">//&nbsp;JSEscape&nbsp;writes&nbsp;to&nbsp;w&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="3028755">func</span>&nbsp;<span class="ident" id="3028760">JSEscape</span><span class="op" id="3028768">(</span><span class="ident" id="3028769">w</span>&nbsp;<span class="ident" id="3028771">io</span><span class="op" id="3028773">.</span><span class="ident" id="3028774">Writer</span><span class="op" id="3028780">,</span>&nbsp;<span class="ident" id="3028782">b</span>&nbsp;<span class="op" id="3028784">[</span><span class="op" id="3028785">]</span><span class="builtintype" id="3028786">byte</span><span class="op" id="3028790">)</span>&nbsp;<span class="op" id="3028792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3028795">template</span><span class="op" id="3028803">.</span><span class="ident" id="3028804">JSEscape</span><span class="op" id="3028812">(</span><span class="ident" id="3028813">w</span><span class="op" id="3028814">,</span>&nbsp;<span class="ident" id="3028816">b</span><span class="op" id="3028817">)</span><br>
<span class="lineno">790</span><span class="op" id="3028819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3028822">//&nbsp;JSEscapeString&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="3028908">func</span>&nbsp;<span class="ident" id="3028913">JSEscapeString</span><span class="op" id="3028927">(</span><span class="ident" id="3028928">s</span>&nbsp;<span class="builtintype" id="3028930">string</span><span class="op" id="3028936">)</span>&nbsp;<span class="builtintype" id="3028938">string</span>&nbsp;<span class="op" id="3028945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3028948">return</span>&nbsp;<span class="ident" id="3028955">template</span><span class="op" id="3028963">.</span><span class="ident" id="3028964">JSEscapeString</span><span class="op" id="3028978">(</span><span class="ident" id="3028979">s</span><span class="op" id="3028980">)</span><br>
<span class="lineno">795</span><span class="op" id="3028982">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3028985">//&nbsp;JSEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;textual</span><br>
<span class="lineno"></span><span class="comment" id="3029055">//&nbsp;representation&nbsp;of&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="keyword" id="3029091">func</span>&nbsp;<span class="ident" id="3029096">JSEscaper</span><span class="op" id="3029105">(</span><span class="ident" id="3029106">args</span>&nbsp;<span class="op" id="3029111">...</span><span class="keyword" id="3029114">interface</span><span class="op" id="3029123">{</span><span class="op" id="3029124">}</span><span class="op" id="3029125">)</span>&nbsp;<span class="builtintype" id="3029127">string</span>&nbsp;<span class="op" id="3029134">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3029137">return</span>&nbsp;<span class="ident" id="3029144">template</span><span class="op" id="3029152">.</span><span class="ident" id="3029153">JSEscaper</span><span class="op" id="3029162">(</span><span class="ident" id="3029163">args</span><span class="op" id="3029167">...</span><span class="op" id="3029170">)</span><br>
<span class="lineno"></span><span class="op" id="3029172">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3029175">//&nbsp;URLQueryEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;value&nbsp;of&nbsp;the&nbsp;textual&nbsp;representation&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3029253">//&nbsp;its&nbsp;arguments&nbsp;in&nbsp;a&nbsp;form&nbsp;suitable&nbsp;for&nbsp;embedding&nbsp;in&nbsp;a&nbsp;URL&nbsp;query.</span><br>
<span class="lineno">805</span><span class="keyword" id="3029319">func</span>&nbsp;<span class="ident" id="3029324">URLQueryEscaper</span><span class="op" id="3029339">(</span><span class="ident" id="3029340">args</span>&nbsp;<span class="op" id="3029345">...</span><span class="keyword" id="3029348">interface</span><span class="op" id="3029357">{</span><span class="op" id="3029358">}</span><span class="op" id="3029359">)</span>&nbsp;<span class="builtintype" id="3029361">string</span>&nbsp;<span class="op" id="3029368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3029371">return</span>&nbsp;<span class="ident" id="3029378">template</span><span class="op" id="3029386">.</span><span class="ident" id="3029387">URLQueryEscaper</span><span class="op" id="3029402">(</span><span class="ident" id="3029403">args</span><span class="op" id="3029407">...</span><span class="op" id="3029410">)</span><br>
<span class="lineno"></span><span class="op" id="3029412">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
