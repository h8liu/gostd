<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3428857">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3428913">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3428967">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3429018">package</span>&nbsp;<span class="ident" id="3429026">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3429031">import</span>&nbsp;<span class="op" id="3429038">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3429041">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3429047">&#34;os&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3429053">&#34;syscall&#34;</span><br>
<span class="lineno"></span><span class="op" id="3429063">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3429066">//&nbsp;maxSendfileSize&nbsp;is&nbsp;the&nbsp;largest&nbsp;chunk&nbsp;size&nbsp;we&nbsp;ask&nbsp;the&nbsp;kernel&nbsp;to&nbsp;copy</span><br>
<span class="lineno"></span><span class="comment" id="3429137">//&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno">15</span><span class="keyword" id="3429151">const</span>&nbsp;<span class="ident" id="3429157">maxSendfileSize</span>&nbsp;<span class="builtintype" id="3429173">int</span>&nbsp;<span class="op" id="3429177">=</span>&nbsp;<span class="num" id="3429179">4</span>&nbsp;<span class="op" id="3429181">&lt;&lt;</span>&nbsp;<span class="num" id="3429184">20</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3429188">//&nbsp;sendFile&nbsp;copies&nbsp;the&nbsp;contents&nbsp;of&nbsp;r&nbsp;to&nbsp;c&nbsp;using&nbsp;the&nbsp;sendfile</span><br>
<span class="lineno"></span><span class="comment" id="3429249">//&nbsp;system&nbsp;call&nbsp;to&nbsp;minimize&nbsp;copies.</span><br>
<span class="lineno"></span><span class="comment" id="3429284">//</span><br>
<span class="lineno">20</span><span class="comment" id="3429287">//&nbsp;if&nbsp;handled&nbsp;==&nbsp;true,&nbsp;sendFile&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;copied&nbsp;and&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="3429362">//&nbsp;non-EOF&nbsp;error.</span><br>
<span class="lineno"></span><span class="comment" id="3429380">//</span><br>
<span class="lineno"></span><span class="comment" id="3429383">//&nbsp;if&nbsp;handled&nbsp;==&nbsp;false,&nbsp;sendFile&nbsp;performed&nbsp;no&nbsp;work.</span><br>
<span class="lineno"></span><span class="keyword" id="3429435">func</span>&nbsp;<span class="ident" id="3429440">sendFile</span><span class="op" id="3429448">(</span><span class="ident" id="3429449">c</span>&nbsp;<span class="op" id="3429451">*</span><span class="ident" id="3429452">netFD</span><span class="op" id="3429457">,</span>&nbsp;<span class="ident" id="3429459">r</span>&nbsp;<span class="ident" id="3429461">io</span><span class="op" id="3429463">.</span><span class="ident" id="3429464">Reader</span><span class="op" id="3429470">)</span>&nbsp;<span class="op" id="3429472">(</span><span class="ident" id="3429473">written</span>&nbsp;<span class="ident" id="3429481">int64</span><span class="op" id="3429486">,</span>&nbsp;<span class="ident" id="3429488">err</span>&nbsp;<span class="builtintype" id="3429492">error</span><span class="op" id="3429497">,</span>&nbsp;<span class="ident" id="3429499">handled</span>&nbsp;<span class="builtintype" id="3429507">bool</span><span class="op" id="3429511">)</span>&nbsp;<span class="op" id="3429513">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429516">var</span>&nbsp;<span class="ident" id="3429520">remain</span>&nbsp;<span class="ident" id="3429527">int64</span>&nbsp;<span class="op" id="3429533">=</span>&nbsp;<span class="num" id="3429535">1</span>&nbsp;<span class="op" id="3429537">&lt;&lt;</span>&nbsp;<span class="num" id="3429540">62</span>&nbsp;<span class="comment" id="3429543">//&nbsp;by&nbsp;default,&nbsp;copy&nbsp;until&nbsp;EOF</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429575">lr</span><span class="op" id="3429577">,</span>&nbsp;<span class="ident" id="3429579">ok</span>&nbsp;<span class="op" id="3429582">:=</span>&nbsp;<span class="ident" id="3429585">r</span><span class="op" id="3429586">.</span><span class="op" id="3429587">(</span><span class="op" id="3429588">*</span><span class="ident" id="3429589">io</span><span class="op" id="3429591">.</span><span class="ident" id="3429592">LimitedReader</span><span class="op" id="3429605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429608">if</span>&nbsp;<span class="ident" id="3429611">ok</span>&nbsp;<span class="op" id="3429614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429618">remain</span><span class="op" id="3429624">,</span>&nbsp;<span class="ident" id="3429626">r</span>&nbsp;<span class="op" id="3429628">=</span>&nbsp;<span class="ident" id="3429630">lr</span><span class="op" id="3429632">.</span><span class="ident" id="3429633">N</span><span class="op" id="3429634">,</span>&nbsp;<span class="ident" id="3429636">lr</span><span class="op" id="3429638">.</span><span class="ident" id="3429639">R</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429643">if</span>&nbsp;<span class="ident" id="3429646">remain</span>&nbsp;<span class="op" id="3429653">&lt;=</span>&nbsp;<span class="num" id="3429656">0</span>&nbsp;<span class="op" id="3429658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429663">return</span>&nbsp;<span class="num" id="3429670">0</span><span class="op" id="3429671">,</span>&nbsp;<span class="ident" id="3429673">nil</span><span class="op" id="3429676">,</span>&nbsp;<span class="ident" id="3429678">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3429685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3429688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429691">f</span><span class="op" id="3429692">,</span>&nbsp;<span class="ident" id="3429694">ok</span>&nbsp;<span class="op" id="3429697">:=</span>&nbsp;<span class="ident" id="3429700">r</span><span class="op" id="3429701">.</span><span class="op" id="3429702">(</span><span class="op" id="3429703">*</span><span class="ident" id="3429704">os</span><span class="op" id="3429706">.</span><span class="ident" id="3429707">File</span><span class="op" id="3429711">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429714">if</span>&nbsp;<span class="op" id="3429717">!</span><span class="ident" id="3429718">ok</span>&nbsp;<span class="op" id="3429721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429725">return</span>&nbsp;<span class="num" id="3429732">0</span><span class="op" id="3429733">,</span>&nbsp;<span class="ident" id="3429735">nil</span><span class="op" id="3429738">,</span>&nbsp;<span class="ident" id="3429740">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3429747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429751">if</span>&nbsp;<span class="ident" id="3429754">err</span>&nbsp;<span class="op" id="3429758">:=</span>&nbsp;<span class="ident" id="3429761">c</span><span class="op" id="3429762">.</span><span class="ident" id="3429763">writeLock</span><span class="op" id="3429772">(</span><span class="op" id="3429773">)</span><span class="op" id="3429774">;</span>&nbsp;<span class="ident" id="3429776">err</span>&nbsp;<span class="op" id="3429780">!=</span>&nbsp;<span class="ident" id="3429783">nil</span>&nbsp;<span class="op" id="3429787">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429791">return</span>&nbsp;<span class="num" id="3429798">0</span><span class="op" id="3429799">,</span>&nbsp;<span class="ident" id="3429801">err</span><span class="op" id="3429804">,</span>&nbsp;<span class="ident" id="3429806">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3429812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429815">defer</span>&nbsp;<span class="ident" id="3429821">c</span><span class="op" id="3429822">.</span><span class="ident" id="3429823">writeUnlock</span><span class="op" id="3429834">(</span><span class="op" id="3429835">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429839">dst</span>&nbsp;<span class="op" id="3429843">:=</span>&nbsp;<span class="ident" id="3429846">c</span><span class="op" id="3429847">.</span><span class="ident" id="3429848">sysfd</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429855">src</span>&nbsp;<span class="op" id="3429859">:=</span>&nbsp;<span class="builtintype" id="3429862">int</span><span class="op" id="3429865">(</span><span class="ident" id="3429866">f</span><span class="op" id="3429867">.</span><span class="ident" id="3429868">Fd</span><span class="op" id="3429870">(</span><span class="op" id="3429871">)</span><span class="op" id="3429872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429875">for</span>&nbsp;<span class="ident" id="3429879">remain</span>&nbsp;<span class="op" id="3429886">&gt;</span>&nbsp;<span class="num" id="3429888">0</span>&nbsp;<span class="op" id="3429890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429894">n</span>&nbsp;<span class="op" id="3429896">:=</span>&nbsp;<span class="ident" id="3429899">maxSendfileSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429917">if</span>&nbsp;<span class="ident" id="3429920">int64</span><span class="op" id="3429925">(</span><span class="ident" id="3429926">n</span><span class="op" id="3429927">)</span>&nbsp;<span class="op" id="3429929">&gt;</span>&nbsp;<span class="ident" id="3429931">remain</span>&nbsp;<span class="op" id="3429938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429943">n</span>&nbsp;<span class="op" id="3429945">=</span>&nbsp;<span class="builtintype" id="3429947">int</span><span class="op" id="3429950">(</span><span class="ident" id="3429951">remain</span><span class="op" id="3429957">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3429961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429965">n</span><span class="op" id="3429966">,</span>&nbsp;<span class="ident" id="3429968">err1</span>&nbsp;<span class="op" id="3429973">:=</span>&nbsp;<span class="ident" id="3429976">syscall</span><span class="op" id="3429983">.</span><span class="ident" id="3429984">Sendfile</span><span class="op" id="3429992">(</span><span class="ident" id="3429993">dst</span><span class="op" id="3429996">,</span>&nbsp;<span class="ident" id="3429998">src</span><span class="op" id="3430001">,</span>&nbsp;<span class="ident" id="3430003">nil</span><span class="op" id="3430006">,</span>&nbsp;<span class="ident" id="3430008">n</span><span class="op" id="3430009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430013">if</span>&nbsp;<span class="ident" id="3430016">n</span>&nbsp;<span class="op" id="3430018">&gt;</span>&nbsp;<span class="num" id="3430020">0</span>&nbsp;<span class="op" id="3430022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430027">written</span>&nbsp;<span class="op" id="3430035">+=</span>&nbsp;<span class="ident" id="3430038">int64</span><span class="op" id="3430043">(</span><span class="ident" id="3430044">n</span><span class="op" id="3430045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430050">remain</span>&nbsp;<span class="op" id="3430057">-=</span>&nbsp;<span class="ident" id="3430060">int64</span><span class="op" id="3430065">(</span><span class="ident" id="3430066">n</span><span class="op" id="3430067">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3430071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430075">if</span>&nbsp;<span class="ident" id="3430078">n</span>&nbsp;<span class="op" id="3430080">==</span>&nbsp;<span class="num" id="3430083">0</span>&nbsp;<span class="op" id="3430085">&amp;&amp;</span>&nbsp;<span class="ident" id="3430088">err1</span>&nbsp;<span class="op" id="3430093">==</span>&nbsp;<span class="ident" id="3430096">nil</span>&nbsp;<span class="op" id="3430100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430105">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3430113">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430117">if</span>&nbsp;<span class="ident" id="3430120">err1</span>&nbsp;<span class="op" id="3430125">==</span>&nbsp;<span class="ident" id="3430128">syscall</span><span class="op" id="3430135">.</span><span class="ident" id="3430136">EAGAIN</span>&nbsp;<span class="op" id="3430143">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430148">if</span>&nbsp;<span class="ident" id="3430151">err1</span>&nbsp;<span class="op" id="3430156">=</span>&nbsp;<span class="ident" id="3430158">c</span><span class="op" id="3430159">.</span><span class="ident" id="3430160">pd</span><span class="op" id="3430162">.</span><span class="ident" id="3430163">WaitWrite</span><span class="op" id="3430172">(</span><span class="op" id="3430173">)</span><span class="op" id="3430174">;</span>&nbsp;<span class="ident" id="3430176">err1</span>&nbsp;<span class="op" id="3430181">==</span>&nbsp;<span class="ident" id="3430184">nil</span>&nbsp;<span class="op" id="3430188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430194">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3430206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3430210">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430214">if</span>&nbsp;<span class="ident" id="3430217">err1</span>&nbsp;<span class="op" id="3430222">!=</span>&nbsp;<span class="ident" id="3430225">nil</span>&nbsp;<span class="op" id="3430229">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3430234">//&nbsp;This&nbsp;includes&nbsp;syscall.ENOSYS&nbsp;(no&nbsp;kernel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3430280">//&nbsp;support)&nbsp;and&nbsp;syscall.EINVAL&nbsp;(fd&nbsp;types&nbsp;which</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3430330">//&nbsp;don&#39;t&nbsp;implement&nbsp;sendfile&nbsp;together)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430371">err</span>&nbsp;<span class="op" id="3430375">=</span>&nbsp;<span class="op" id="3430377">&amp;</span><span class="ident" id="3430378">OpError</span><span class="op" id="3430385">{</span><span class="string" id="3430386">&#34;sendfile&#34;</span><span class="op" id="3430396">,</span>&nbsp;<span class="ident" id="3430398">c</span><span class="op" id="3430399">.</span><span class="ident" id="3430400">net</span><span class="op" id="3430403">,</span>&nbsp;<span class="ident" id="3430405">c</span><span class="op" id="3430406">.</span><span class="ident" id="3430407">raddr</span><span class="op" id="3430412">,</span>&nbsp;<span class="ident" id="3430414">err1</span><span class="op" id="3430418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430423">break</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3430431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3430434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430437">if</span>&nbsp;<span class="ident" id="3430440">lr</span>&nbsp;<span class="op" id="3430443">!=</span>&nbsp;<span class="ident" id="3430446">nil</span>&nbsp;<span class="op" id="3430450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430454">lr</span><span class="op" id="3430456">.</span><span class="ident" id="3430457">N</span>&nbsp;<span class="op" id="3430459">=</span>&nbsp;<span class="ident" id="3430461">remain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3430469">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430472">return</span>&nbsp;<span class="ident" id="3430479">written</span><span class="op" id="3430486">,</span>&nbsp;<span class="ident" id="3430488">err</span><span class="op" id="3430491">,</span>&nbsp;<span class="ident" id="3430493">written</span>&nbsp;<span class="op" id="3430501">&gt;</span>&nbsp;<span class="num" id="3430503">0</span><br>
<span class="lineno"></span><span class="op" id="3430505">}</span>
</div>
</body>
</html>
