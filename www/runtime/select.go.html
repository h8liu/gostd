<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1673139">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1673194">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1673248">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1673299">package</span>&nbsp;<span class="ident" id="1673307">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1673316">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&nbsp;select&nbsp;statements.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1673383">import</span>&nbsp;<span class="string" id="1673390">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1673400">const</span>&nbsp;<span class="op" id="1673406">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1673409">debugSelect</span>&nbsp;<span class="op" id="1673421">=</span>&nbsp;<span class="ident" id="1673423">false</span><br>
<span class="lineno"></span><span class="op" id="1673429">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="1673432">var</span>&nbsp;<span class="op" id="1673436">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1673439">chansendpc</span>&nbsp;<span class="op" id="1673450">=</span>&nbsp;<span class="ident" id="1673452">funcPC</span><span class="op" id="1673458">(</span><span class="ident" id="1673459">chansend</span><span class="op" id="1673467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1673470">chanrecvpc</span>&nbsp;<span class="op" id="1673481">=</span>&nbsp;<span class="ident" id="1673483">funcPC</span><span class="op" id="1673489">(</span><span class="ident" id="1673490">chanrecv</span><span class="op" id="1673498">)</span><br>
<span class="lineno"></span><span class="op" id="1673500">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1673503">func</span>&nbsp;<span class="ident" id="1673508">selectsize</span><span class="op" id="1673518">(</span><span class="ident" id="1673519">size</span>&nbsp;<span class="builtintype" id="1673524">uintptr</span><span class="op" id="1673531">)</span>&nbsp;<span class="builtintype" id="1673533">uintptr</span>&nbsp;<span class="op" id="1673541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1673544">selsize</span>&nbsp;<span class="op" id="1673552">:=</span>&nbsp;<span class="ident" id="1673555">unsafe</span><span class="op" id="1673561">.</span><span class="ident" id="1673562">Sizeof</span><span class="op" id="1673568">(</span><span class="ident" id="1673569">_select</span><span class="op" id="1673576">{</span><span class="op" id="1673577">}</span><span class="op" id="1673578">)</span>&nbsp;<span class="op" id="1673580">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1673584">(</span><span class="ident" id="1673585">size</span><span class="op" id="1673589">-</span><span class="num" id="1673590">1</span><span class="op" id="1673591">)</span><span class="op" id="1673592">*</span><span class="ident" id="1673593">unsafe</span><span class="op" id="1673599">.</span><span class="ident" id="1673600">Sizeof</span><span class="op" id="1673606">(</span><span class="ident" id="1673607">_select</span><span class="op" id="1673614">{</span><span class="op" id="1673615">}</span><span class="op" id="1673616">.</span><span class="ident" id="1673617">scase</span><span class="op" id="1673622">[</span><span class="num" id="1673623">0</span><span class="op" id="1673624">]</span><span class="op" id="1673625">)</span>&nbsp;<span class="op" id="1673627">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1673631">size</span><span class="op" id="1673635">*</span><span class="ident" id="1673636">unsafe</span><span class="op" id="1673642">.</span><span class="ident" id="1673643">Sizeof</span><span class="op" id="1673649">(</span><span class="op" id="1673650">*</span><span class="ident" id="1673651">_select</span><span class="op" id="1673658">{</span><span class="op" id="1673659">}</span><span class="op" id="1673660">.</span><span class="ident" id="1673661">lockorder</span><span class="op" id="1673670">)</span>&nbsp;<span class="op" id="1673672">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1673676">size</span><span class="op" id="1673680">*</span><span class="ident" id="1673681">unsafe</span><span class="op" id="1673687">.</span><span class="ident" id="1673688">Sizeof</span><span class="op" id="1673694">(</span><span class="op" id="1673695">*</span><span class="ident" id="1673696">_select</span><span class="op" id="1673703">{</span><span class="op" id="1673704">}</span><span class="op" id="1673705">.</span><span class="ident" id="1673706">pollorder</span><span class="op" id="1673715">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1673718">return</span>&nbsp;<span class="ident" id="1673725">round</span><span class="op" id="1673730">(</span><span class="ident" id="1673731">selsize</span><span class="op" id="1673738">,</span>&nbsp;<span class="ident" id="1673740">_Int64Align</span><span class="op" id="1673751">)</span><br>
<span class="lineno"></span><span class="op" id="1673753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1673756">func</span>&nbsp;<span class="ident" id="1673761">newselect</span><span class="op" id="1673770">(</span><span class="ident" id="1673771">sel</span>&nbsp;<span class="op" id="1673775">*</span><span class="ident" id="1673776">_select</span><span class="op" id="1673783">,</span>&nbsp;<span class="ident" id="1673785">selsize</span>&nbsp;<span class="ident" id="1673793">int64</span><span class="op" id="1673798">,</span>&nbsp;<span class="ident" id="1673800">size</span>&nbsp;<span class="builtintype" id="1673805">int32</span><span class="op" id="1673810">)</span>&nbsp;<span class="op" id="1673812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1673815">if</span>&nbsp;<span class="ident" id="1673818">selsize</span>&nbsp;<span class="op" id="1673826">!=</span>&nbsp;<span class="ident" id="1673829">int64</span><span class="op" id="1673834">(</span><span class="ident" id="1673835">selectsize</span><span class="op" id="1673845">(</span><span class="builtintype" id="1673846">uintptr</span><span class="op" id="1673853">(</span><span class="ident" id="1673854">size</span><span class="op" id="1673858">)</span><span class="op" id="1673859">)</span><span class="op" id="1673860">)</span>&nbsp;<span class="op" id="1673862">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1673866">print</span><span class="op" id="1673871">(</span><span class="string" id="1673872">&#34;runtime:&nbsp;bad&nbsp;select&nbsp;size&nbsp;&#34;</span><span class="op" id="1673899">,</span>&nbsp;<span class="ident" id="1673901">selsize</span><span class="op" id="1673908">,</span>&nbsp;<span class="string" id="1673910">&#34;,&nbsp;want&nbsp;&#34;</span><span class="op" id="1673919">,</span>&nbsp;<span class="ident" id="1673921">selectsize</span><span class="op" id="1673931">(</span><span class="builtintype" id="1673932">uintptr</span><span class="op" id="1673939">(</span><span class="ident" id="1673940">size</span><span class="op" id="1673944">)</span><span class="op" id="1673945">)</span><span class="op" id="1673946">,</span>&nbsp;<span class="string" id="1673948">&#34;\n&#34;</span><span class="op" id="1673952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1673956">gothrow</span><span class="op" id="1673963">(</span><span class="string" id="1673964">&#34;bad&nbsp;select&nbsp;size&#34;</span><span class="op" id="1673981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1673984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1673987">sel</span><span class="op" id="1673990">.</span><span class="ident" id="1673991">tcase</span>&nbsp;<span class="op" id="1673997">=</span>&nbsp;<span class="builtintype" id="1673999">uint16</span><span class="op" id="1674005">(</span><span class="ident" id="1674006">size</span><span class="op" id="1674010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1674013">sel</span><span class="op" id="1674016">.</span><span class="ident" id="1674017">ncase</span>&nbsp;<span class="op" id="1674023">=</span>&nbsp;<span class="num" id="1674025">0</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1674028">sel</span><span class="op" id="1674031">.</span><span class="ident" id="1674032">lockorder</span>&nbsp;<span class="op" id="1674042">=</span>&nbsp;<span class="op" id="1674044">(</span><span class="op" id="1674045">*</span><span class="op" id="1674046">*</span><span class="ident" id="1674047">hchan</span><span class="op" id="1674052">)</span><span class="op" id="1674053">(</span><span class="ident" id="1674054">add</span><span class="op" id="1674057">(</span><span class="ident" id="1674058">unsafe</span><span class="op" id="1674064">.</span><span class="ident" id="1674065">Pointer</span><span class="op" id="1674072">(</span><span class="op" id="1674073">&amp;</span><span class="ident" id="1674074">sel</span><span class="op" id="1674077">.</span><span class="ident" id="1674078">scase</span><span class="op" id="1674083">)</span><span class="op" id="1674084">,</span>&nbsp;<span class="builtintype" id="1674086">uintptr</span><span class="op" id="1674093">(</span><span class="ident" id="1674094">size</span><span class="op" id="1674098">)</span><span class="op" id="1674099">*</span><span class="ident" id="1674100">unsafe</span><span class="op" id="1674106">.</span><span class="ident" id="1674107">Sizeof</span><span class="op" id="1674113">(</span><span class="ident" id="1674114">_select</span><span class="op" id="1674121">{</span><span class="op" id="1674122">}</span><span class="op" id="1674123">.</span><span class="ident" id="1674124">scase</span><span class="op" id="1674129">[</span><span class="num" id="1674130">0</span><span class="op" id="1674131">]</span><span class="op" id="1674132">)</span><span class="op" id="1674133">)</span><span class="op" id="1674134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1674137">sel</span><span class="op" id="1674140">.</span><span class="ident" id="1674141">pollorder</span>&nbsp;<span class="op" id="1674151">=</span>&nbsp;<span class="op" id="1674153">(</span><span class="op" id="1674154">*</span><span class="builtintype" id="1674155">uint16</span><span class="op" id="1674161">)</span><span class="op" id="1674162">(</span><span class="ident" id="1674163">add</span><span class="op" id="1674166">(</span><span class="ident" id="1674167">unsafe</span><span class="op" id="1674173">.</span><span class="ident" id="1674174">Pointer</span><span class="op" id="1674181">(</span><span class="ident" id="1674182">sel</span><span class="op" id="1674185">.</span><span class="ident" id="1674186">lockorder</span><span class="op" id="1674195">)</span><span class="op" id="1674196">,</span>&nbsp;<span class="builtintype" id="1674198">uintptr</span><span class="op" id="1674205">(</span><span class="ident" id="1674206">size</span><span class="op" id="1674210">)</span><span class="op" id="1674211">*</span><span class="ident" id="1674212">unsafe</span><span class="op" id="1674218">.</span><span class="ident" id="1674219">Sizeof</span><span class="op" id="1674225">(</span><span class="op" id="1674226">*</span><span class="ident" id="1674227">_select</span><span class="op" id="1674234">{</span><span class="op" id="1674235">}</span><span class="op" id="1674236">.</span><span class="ident" id="1674237">lockorder</span><span class="op" id="1674246">)</span><span class="op" id="1674247">)</span><span class="op" id="1674248">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1674252">if</span>&nbsp;<span class="ident" id="1674255">debugSelect</span>&nbsp;<span class="op" id="1674267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1674271">print</span><span class="op" id="1674276">(</span><span class="string" id="1674277">&#34;newselect&nbsp;s=&#34;</span><span class="op" id="1674291">,</span>&nbsp;<span class="ident" id="1674293">sel</span><span class="op" id="1674296">,</span>&nbsp;<span class="string" id="1674298">&#34;&nbsp;size=&#34;</span><span class="op" id="1674306">,</span>&nbsp;<span class="ident" id="1674308">size</span><span class="op" id="1674312">,</span>&nbsp;<span class="string" id="1674314">&#34;\n&#34;</span><span class="op" id="1674318">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1674321">}</span><br>
<span class="lineno"></span><span class="op" id="1674323">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1674326">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1674339">func</span>&nbsp;<span class="ident" id="1674344">selectsend</span><span class="op" id="1674354">(</span><span class="ident" id="1674355">sel</span>&nbsp;<span class="op" id="1674359">*</span><span class="ident" id="1674360">_select</span><span class="op" id="1674367">,</span>&nbsp;<span class="ident" id="1674369">c</span>&nbsp;<span class="op" id="1674371">*</span><span class="ident" id="1674372">hchan</span><span class="op" id="1674377">,</span>&nbsp;<span class="ident" id="1674379">elem</span>&nbsp;<span class="ident" id="1674384">unsafe</span><span class="op" id="1674390">.</span><span class="ident" id="1674391">Pointer</span><span class="op" id="1674398">)</span>&nbsp;<span class="op" id="1674400">(</span><span class="ident" id="1674401">selected</span>&nbsp;<span class="builtintype" id="1674410">bool</span><span class="op" id="1674414">)</span>&nbsp;<span class="op" id="1674416">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1674419">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1674448">if</span>&nbsp;<span class="ident" id="1674451">c</span>&nbsp;<span class="op" id="1674453">!=</span>&nbsp;<span class="ident" id="1674456">nil</span>&nbsp;<span class="op" id="1674460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1674464">selectsendImpl</span><span class="op" id="1674478">(</span><span class="ident" id="1674479">sel</span><span class="op" id="1674482">,</span>&nbsp;<span class="ident" id="1674484">c</span><span class="op" id="1674485">,</span>&nbsp;<span class="ident" id="1674487">getcallerpc</span><span class="op" id="1674498">(</span><span class="ident" id="1674499">unsafe</span><span class="op" id="1674505">.</span><span class="ident" id="1674506">Pointer</span><span class="op" id="1674513">(</span><span class="op" id="1674514">&amp;</span><span class="ident" id="1674515">sel</span><span class="op" id="1674518">)</span><span class="op" id="1674519">)</span><span class="op" id="1674520">,</span>&nbsp;<span class="ident" id="1674522">elem</span><span class="op" id="1674526">,</span>&nbsp;<span class="builtintype" id="1674528">uintptr</span><span class="op" id="1674535">(</span><span class="ident" id="1674536">unsafe</span><span class="op" id="1674542">.</span><span class="ident" id="1674543">Pointer</span><span class="op" id="1674550">(</span><span class="op" id="1674551">&amp;</span><span class="ident" id="1674552">selected</span><span class="op" id="1674560">)</span><span class="op" id="1674561">)</span><span class="op" id="1674562">-</span><span class="builtintype" id="1674563">uintptr</span><span class="op" id="1674570">(</span><span class="ident" id="1674571">unsafe</span><span class="op" id="1674577">.</span><span class="ident" id="1674578">Pointer</span><span class="op" id="1674585">(</span><span class="op" id="1674586">&amp;</span><span class="ident" id="1674587">sel</span><span class="op" id="1674590">)</span><span class="op" id="1674591">)</span><span class="op" id="1674592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1674595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1674598">return</span><br>
<span class="lineno">50</span><span class="op" id="1674605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1674608">//&nbsp;cut&nbsp;in&nbsp;half&nbsp;to&nbsp;give&nbsp;stack&nbsp;a&nbsp;chance&nbsp;to&nbsp;split</span><br>
<span class="lineno"></span><span class="keyword" id="1674655">func</span>&nbsp;<span class="ident" id="1674660">selectsendImpl</span><span class="op" id="1674674">(</span><span class="ident" id="1674675">sel</span>&nbsp;<span class="op" id="1674679">*</span><span class="ident" id="1674680">_select</span><span class="op" id="1674687">,</span>&nbsp;<span class="ident" id="1674689">c</span>&nbsp;<span class="op" id="1674691">*</span><span class="ident" id="1674692">hchan</span><span class="op" id="1674697">,</span>&nbsp;<span class="ident" id="1674699">pc</span>&nbsp;<span class="builtintype" id="1674702">uintptr</span><span class="op" id="1674709">,</span>&nbsp;<span class="ident" id="1674711">elem</span>&nbsp;<span class="ident" id="1674716">unsafe</span><span class="op" id="1674722">.</span><span class="ident" id="1674723">Pointer</span><span class="op" id="1674730">,</span>&nbsp;<span class="ident" id="1674732">so</span>&nbsp;<span class="builtintype" id="1674735">uintptr</span><span class="op" id="1674742">)</span>&nbsp;<span class="op" id="1674744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1674747">i</span>&nbsp;<span class="op" id="1674749">:=</span>&nbsp;<span class="ident" id="1674752">sel</span><span class="op" id="1674755">.</span><span class="ident" id="1674756">ncase</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1674763">if</span>&nbsp;<span class="ident" id="1674766">i</span>&nbsp;<span class="op" id="1674768">&gt;=</span>&nbsp;<span class="ident" id="1674771">sel</span><span class="op" id="1674774">.</span><span class="ident" id="1674775">tcase</span>&nbsp;<span class="op" id="1674781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1674785">gothrow</span><span class="op" id="1674792">(</span><span class="string" id="1674793">&#34;selectsend:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="1674821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1674824">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1674827">sel</span><span class="op" id="1674830">.</span><span class="ident" id="1674831">ncase</span>&nbsp;<span class="op" id="1674837">=</span>&nbsp;<span class="ident" id="1674839">i</span>&nbsp;<span class="op" id="1674841">+</span>&nbsp;<span class="num" id="1674843">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1674846">cas</span>&nbsp;<span class="op" id="1674850">:=</span>&nbsp;<span class="op" id="1674853">(</span><span class="op" id="1674854">*</span><span class="ident" id="1674855">scase</span><span class="op" id="1674860">)</span><span class="op" id="1674861">(</span><span class="ident" id="1674862">add</span><span class="op" id="1674865">(</span><span class="ident" id="1674866">unsafe</span><span class="op" id="1674872">.</span><span class="ident" id="1674873">Pointer</span><span class="op" id="1674880">(</span><span class="op" id="1674881">&amp;</span><span class="ident" id="1674882">sel</span><span class="op" id="1674885">.</span><span class="ident" id="1674886">scase</span><span class="op" id="1674891">)</span><span class="op" id="1674892">,</span>&nbsp;<span class="builtintype" id="1674894">uintptr</span><span class="op" id="1674901">(</span><span class="ident" id="1674902">i</span><span class="op" id="1674903">)</span><span class="op" id="1674904">*</span><span class="ident" id="1674905">unsafe</span><span class="op" id="1674911">.</span><span class="ident" id="1674912">Sizeof</span><span class="op" id="1674918">(</span><span class="ident" id="1674919">sel</span><span class="op" id="1674922">.</span><span class="ident" id="1674923">scase</span><span class="op" id="1674928">[</span><span class="num" id="1674929">0</span><span class="op" id="1674930">]</span><span class="op" id="1674931">)</span><span class="op" id="1674932">)</span><span class="op" id="1674933">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1674937">cas</span><span class="op" id="1674940">.</span><span class="ident" id="1674941">pc</span>&nbsp;<span class="op" id="1674944">=</span>&nbsp;<span class="ident" id="1674946">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1674950">cas</span><span class="op" id="1674953">.</span><span class="ident" id="1674954">_chan</span>&nbsp;<span class="op" id="1674960">=</span>&nbsp;<span class="ident" id="1674962">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1674965">cas</span><span class="op" id="1674968">.</span><span class="ident" id="1674969">so</span>&nbsp;<span class="op" id="1674972">=</span>&nbsp;<span class="builtintype" id="1674974">uint16</span><span class="op" id="1674980">(</span><span class="ident" id="1674981">so</span><span class="op" id="1674983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1674986">cas</span><span class="op" id="1674989">.</span><span class="ident" id="1674990">kind</span>&nbsp;<span class="op" id="1674995">=</span>&nbsp;<span class="ident" id="1674997">_CaseSend</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1675008">cas</span><span class="op" id="1675011">.</span><span class="ident" id="1675012">elem</span>&nbsp;<span class="op" id="1675017">=</span>&nbsp;<span class="ident" id="1675019">elem</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1675026">if</span>&nbsp;<span class="ident" id="1675029">debugSelect</span>&nbsp;<span class="op" id="1675041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1675045">print</span><span class="op" id="1675050">(</span><span class="string" id="1675051">&#34;selectsend&nbsp;s=&#34;</span><span class="op" id="1675066">,</span>&nbsp;<span class="ident" id="1675068">sel</span><span class="op" id="1675071">,</span>&nbsp;<span class="string" id="1675073">&#34;&nbsp;pc=&#34;</span><span class="op" id="1675079">,</span>&nbsp;<span class="ident" id="1675081">hex</span><span class="op" id="1675084">(</span><span class="ident" id="1675085">cas</span><span class="op" id="1675088">.</span><span class="ident" id="1675089">pc</span><span class="op" id="1675091">)</span><span class="op" id="1675092">,</span>&nbsp;<span class="string" id="1675094">&#34;&nbsp;chan=&#34;</span><span class="op" id="1675102">,</span>&nbsp;<span class="ident" id="1675104">cas</span><span class="op" id="1675107">.</span><span class="ident" id="1675108">_chan</span><span class="op" id="1675113">,</span>&nbsp;<span class="string" id="1675115">&#34;&nbsp;so=&#34;</span><span class="op" id="1675121">,</span>&nbsp;<span class="ident" id="1675123">cas</span><span class="op" id="1675126">.</span><span class="ident" id="1675127">so</span><span class="op" id="1675129">,</span>&nbsp;<span class="string" id="1675131">&#34;\n&#34;</span><span class="op" id="1675135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1675138">}</span><br>
<span class="lineno">70</span><span class="op" id="1675140">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1675143">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1675156">func</span>&nbsp;<span class="ident" id="1675161">selectrecv</span><span class="op" id="1675171">(</span><span class="ident" id="1675172">sel</span>&nbsp;<span class="op" id="1675176">*</span><span class="ident" id="1675177">_select</span><span class="op" id="1675184">,</span>&nbsp;<span class="ident" id="1675186">c</span>&nbsp;<span class="op" id="1675188">*</span><span class="ident" id="1675189">hchan</span><span class="op" id="1675194">,</span>&nbsp;<span class="ident" id="1675196">elem</span>&nbsp;<span class="ident" id="1675201">unsafe</span><span class="op" id="1675207">.</span><span class="ident" id="1675208">Pointer</span><span class="op" id="1675215">)</span>&nbsp;<span class="op" id="1675217">(</span><span class="ident" id="1675218">selected</span>&nbsp;<span class="builtintype" id="1675227">bool</span><span class="op" id="1675231">)</span>&nbsp;<span class="op" id="1675233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1675236">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1675265">if</span>&nbsp;<span class="ident" id="1675268">c</span>&nbsp;<span class="op" id="1675270">!=</span>&nbsp;<span class="ident" id="1675273">nil</span>&nbsp;<span class="op" id="1675277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1675281">selectrecvImpl</span><span class="op" id="1675295">(</span><span class="ident" id="1675296">sel</span><span class="op" id="1675299">,</span>&nbsp;<span class="ident" id="1675301">c</span><span class="op" id="1675302">,</span>&nbsp;<span class="ident" id="1675304">getcallerpc</span><span class="op" id="1675315">(</span><span class="ident" id="1675316">unsafe</span><span class="op" id="1675322">.</span><span class="ident" id="1675323">Pointer</span><span class="op" id="1675330">(</span><span class="op" id="1675331">&amp;</span><span class="ident" id="1675332">sel</span><span class="op" id="1675335">)</span><span class="op" id="1675336">)</span><span class="op" id="1675337">,</span>&nbsp;<span class="ident" id="1675339">elem</span><span class="op" id="1675343">,</span>&nbsp;<span class="ident" id="1675345">nil</span><span class="op" id="1675348">,</span>&nbsp;<span class="builtintype" id="1675350">uintptr</span><span class="op" id="1675357">(</span><span class="ident" id="1675358">unsafe</span><span class="op" id="1675364">.</span><span class="ident" id="1675365">Pointer</span><span class="op" id="1675372">(</span><span class="op" id="1675373">&amp;</span><span class="ident" id="1675374">selected</span><span class="op" id="1675382">)</span><span class="op" id="1675383">)</span><span class="op" id="1675384">-</span><span class="builtintype" id="1675385">uintptr</span><span class="op" id="1675392">(</span><span class="ident" id="1675393">unsafe</span><span class="op" id="1675399">.</span><span class="ident" id="1675400">Pointer</span><span class="op" id="1675407">(</span><span class="op" id="1675408">&amp;</span><span class="ident" id="1675409">sel</span><span class="op" id="1675412">)</span><span class="op" id="1675413">)</span><span class="op" id="1675414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1675417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1675420">return</span><br>
<span class="lineno"></span><span class="op" id="1675427">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="comment" id="1675430">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1675443">func</span>&nbsp;<span class="ident" id="1675448">selectrecv2</span><span class="op" id="1675459">(</span><span class="ident" id="1675460">sel</span>&nbsp;<span class="op" id="1675464">*</span><span class="ident" id="1675465">_select</span><span class="op" id="1675472">,</span>&nbsp;<span class="ident" id="1675474">c</span>&nbsp;<span class="op" id="1675476">*</span><span class="ident" id="1675477">hchan</span><span class="op" id="1675482">,</span>&nbsp;<span class="ident" id="1675484">elem</span>&nbsp;<span class="ident" id="1675489">unsafe</span><span class="op" id="1675495">.</span><span class="ident" id="1675496">Pointer</span><span class="op" id="1675503">,</span>&nbsp;<span class="ident" id="1675505">received</span>&nbsp;<span class="op" id="1675514">*</span><span class="builtintype" id="1675515">bool</span><span class="op" id="1675519">)</span>&nbsp;<span class="op" id="1675521">(</span><span class="ident" id="1675522">selected</span>&nbsp;<span class="builtintype" id="1675531">bool</span><span class="op" id="1675535">)</span>&nbsp;<span class="op" id="1675537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1675540">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1675569">if</span>&nbsp;<span class="ident" id="1675572">c</span>&nbsp;<span class="op" id="1675574">!=</span>&nbsp;<span class="ident" id="1675577">nil</span>&nbsp;<span class="op" id="1675581">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1675585">selectrecvImpl</span><span class="op" id="1675599">(</span><span class="ident" id="1675600">sel</span><span class="op" id="1675603">,</span>&nbsp;<span class="ident" id="1675605">c</span><span class="op" id="1675606">,</span>&nbsp;<span class="ident" id="1675608">getcallerpc</span><span class="op" id="1675619">(</span><span class="ident" id="1675620">unsafe</span><span class="op" id="1675626">.</span><span class="ident" id="1675627">Pointer</span><span class="op" id="1675634">(</span><span class="op" id="1675635">&amp;</span><span class="ident" id="1675636">sel</span><span class="op" id="1675639">)</span><span class="op" id="1675640">)</span><span class="op" id="1675641">,</span>&nbsp;<span class="ident" id="1675643">elem</span><span class="op" id="1675647">,</span>&nbsp;<span class="ident" id="1675649">received</span><span class="op" id="1675657">,</span>&nbsp;<span class="builtintype" id="1675659">uintptr</span><span class="op" id="1675666">(</span><span class="ident" id="1675667">unsafe</span><span class="op" id="1675673">.</span><span class="ident" id="1675674">Pointer</span><span class="op" id="1675681">(</span><span class="op" id="1675682">&amp;</span><span class="ident" id="1675683">selected</span><span class="op" id="1675691">)</span><span class="op" id="1675692">)</span><span class="op" id="1675693">-</span><span class="builtintype" id="1675694">uintptr</span><span class="op" id="1675701">(</span><span class="ident" id="1675702">unsafe</span><span class="op" id="1675708">.</span><span class="ident" id="1675709">Pointer</span><span class="op" id="1675716">(</span><span class="op" id="1675717">&amp;</span><span class="ident" id="1675718">sel</span><span class="op" id="1675721">)</span><span class="op" id="1675722">)</span><span class="op" id="1675723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1675726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1675729">return</span><br>
<span class="lineno"></span><span class="op" id="1675736">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="1675739">func</span>&nbsp;<span class="ident" id="1675744">selectrecvImpl</span><span class="op" id="1675758">(</span><span class="ident" id="1675759">sel</span>&nbsp;<span class="op" id="1675763">*</span><span class="ident" id="1675764">_select</span><span class="op" id="1675771">,</span>&nbsp;<span class="ident" id="1675773">c</span>&nbsp;<span class="op" id="1675775">*</span><span class="ident" id="1675776">hchan</span><span class="op" id="1675781">,</span>&nbsp;<span class="ident" id="1675783">pc</span>&nbsp;<span class="builtintype" id="1675786">uintptr</span><span class="op" id="1675793">,</span>&nbsp;<span class="ident" id="1675795">elem</span>&nbsp;<span class="ident" id="1675800">unsafe</span><span class="op" id="1675806">.</span><span class="ident" id="1675807">Pointer</span><span class="op" id="1675814">,</span>&nbsp;<span class="ident" id="1675816">received</span>&nbsp;<span class="op" id="1675825">*</span><span class="builtintype" id="1675826">bool</span><span class="op" id="1675830">,</span>&nbsp;<span class="ident" id="1675832">so</span>&nbsp;<span class="builtintype" id="1675835">uintptr</span><span class="op" id="1675842">)</span>&nbsp;<span class="op" id="1675844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1675847">i</span>&nbsp;<span class="op" id="1675849">:=</span>&nbsp;<span class="ident" id="1675852">sel</span><span class="op" id="1675855">.</span><span class="ident" id="1675856">ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1675863">if</span>&nbsp;<span class="ident" id="1675866">i</span>&nbsp;<span class="op" id="1675868">&gt;=</span>&nbsp;<span class="ident" id="1675871">sel</span><span class="op" id="1675874">.</span><span class="ident" id="1675875">tcase</span>&nbsp;<span class="op" id="1675881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1675885">gothrow</span><span class="op" id="1675892">(</span><span class="string" id="1675893">&#34;selectrecv:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="1675921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1675924">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1675927">sel</span><span class="op" id="1675930">.</span><span class="ident" id="1675931">ncase</span>&nbsp;<span class="op" id="1675937">=</span>&nbsp;<span class="ident" id="1675939">i</span>&nbsp;<span class="op" id="1675941">+</span>&nbsp;<span class="num" id="1675943">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1675946">cas</span>&nbsp;<span class="op" id="1675950">:=</span>&nbsp;<span class="op" id="1675953">(</span><span class="op" id="1675954">*</span><span class="ident" id="1675955">scase</span><span class="op" id="1675960">)</span><span class="op" id="1675961">(</span><span class="ident" id="1675962">add</span><span class="op" id="1675965">(</span><span class="ident" id="1675966">unsafe</span><span class="op" id="1675972">.</span><span class="ident" id="1675973">Pointer</span><span class="op" id="1675980">(</span><span class="op" id="1675981">&amp;</span><span class="ident" id="1675982">sel</span><span class="op" id="1675985">.</span><span class="ident" id="1675986">scase</span><span class="op" id="1675991">)</span><span class="op" id="1675992">,</span>&nbsp;<span class="builtintype" id="1675994">uintptr</span><span class="op" id="1676001">(</span><span class="ident" id="1676002">i</span><span class="op" id="1676003">)</span><span class="op" id="1676004">*</span><span class="ident" id="1676005">unsafe</span><span class="op" id="1676011">.</span><span class="ident" id="1676012">Sizeof</span><span class="op" id="1676018">(</span><span class="ident" id="1676019">sel</span><span class="op" id="1676022">.</span><span class="ident" id="1676023">scase</span><span class="op" id="1676028">[</span><span class="num" id="1676029">0</span><span class="op" id="1676030">]</span><span class="op" id="1676031">)</span><span class="op" id="1676032">)</span><span class="op" id="1676033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1676036">cas</span><span class="op" id="1676039">.</span><span class="ident" id="1676040">pc</span>&nbsp;<span class="op" id="1676043">=</span>&nbsp;<span class="ident" id="1676045">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1676049">cas</span><span class="op" id="1676052">.</span><span class="ident" id="1676053">_chan</span>&nbsp;<span class="op" id="1676059">=</span>&nbsp;<span class="ident" id="1676061">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1676064">cas</span><span class="op" id="1676067">.</span><span class="ident" id="1676068">so</span>&nbsp;<span class="op" id="1676071">=</span>&nbsp;<span class="builtintype" id="1676073">uint16</span><span class="op" id="1676079">(</span><span class="ident" id="1676080">so</span><span class="op" id="1676082">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1676085">cas</span><span class="op" id="1676088">.</span><span class="ident" id="1676089">kind</span>&nbsp;<span class="op" id="1676094">=</span>&nbsp;<span class="ident" id="1676096">_CaseRecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1676107">cas</span><span class="op" id="1676110">.</span><span class="ident" id="1676111">elem</span>&nbsp;<span class="op" id="1676116">=</span>&nbsp;<span class="ident" id="1676118">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1676124">cas</span><span class="op" id="1676127">.</span><span class="ident" id="1676128">receivedp</span>&nbsp;<span class="op" id="1676138">=</span>&nbsp;<span class="ident" id="1676140">received</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1676151">if</span>&nbsp;<span class="ident" id="1676154">debugSelect</span>&nbsp;<span class="op" id="1676166">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1676170">print</span><span class="op" id="1676175">(</span><span class="string" id="1676176">&#34;selectrecv&nbsp;s=&#34;</span><span class="op" id="1676191">,</span>&nbsp;<span class="ident" id="1676193">sel</span><span class="op" id="1676196">,</span>&nbsp;<span class="string" id="1676198">&#34;&nbsp;pc=&#34;</span><span class="op" id="1676204">,</span>&nbsp;<span class="ident" id="1676206">hex</span><span class="op" id="1676209">(</span><span class="ident" id="1676210">cas</span><span class="op" id="1676213">.</span><span class="ident" id="1676214">pc</span><span class="op" id="1676216">)</span><span class="op" id="1676217">,</span>&nbsp;<span class="string" id="1676219">&#34;&nbsp;chan=&#34;</span><span class="op" id="1676227">,</span>&nbsp;<span class="ident" id="1676229">cas</span><span class="op" id="1676232">.</span><span class="ident" id="1676233">_chan</span><span class="op" id="1676238">,</span>&nbsp;<span class="string" id="1676240">&#34;&nbsp;so=&#34;</span><span class="op" id="1676246">,</span>&nbsp;<span class="ident" id="1676248">cas</span><span class="op" id="1676251">.</span><span class="ident" id="1676252">so</span><span class="op" id="1676254">,</span>&nbsp;<span class="string" id="1676256">&#34;\n&#34;</span><span class="op" id="1676260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1676263">}</span><br>
<span class="lineno"></span><span class="op" id="1676265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1676268">//go:nosplit</span><br>
<span class="lineno">110</span><span class="keyword" id="1676281">func</span>&nbsp;<span class="ident" id="1676286">selectdefault</span><span class="op" id="1676299">(</span><span class="ident" id="1676300">sel</span>&nbsp;<span class="op" id="1676304">*</span><span class="ident" id="1676305">_select</span><span class="op" id="1676312">)</span>&nbsp;<span class="op" id="1676314">(</span><span class="ident" id="1676315">selected</span>&nbsp;<span class="builtintype" id="1676324">bool</span><span class="op" id="1676328">)</span>&nbsp;<span class="op" id="1676330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1676333">selectdefaultImpl</span><span class="op" id="1676350">(</span><span class="ident" id="1676351">sel</span><span class="op" id="1676354">,</span>&nbsp;<span class="ident" id="1676356">getcallerpc</span><span class="op" id="1676367">(</span><span class="ident" id="1676368">unsafe</span><span class="op" id="1676374">.</span><span class="ident" id="1676375">Pointer</span><span class="op" id="1676382">(</span><span class="op" id="1676383">&amp;</span><span class="ident" id="1676384">sel</span><span class="op" id="1676387">)</span><span class="op" id="1676388">)</span><span class="op" id="1676389">,</span>&nbsp;<span class="builtintype" id="1676391">uintptr</span><span class="op" id="1676398">(</span><span class="ident" id="1676399">unsafe</span><span class="op" id="1676405">.</span><span class="ident" id="1676406">Pointer</span><span class="op" id="1676413">(</span><span class="op" id="1676414">&amp;</span><span class="ident" id="1676415">selected</span><span class="op" id="1676423">)</span><span class="op" id="1676424">)</span><span class="op" id="1676425">-</span><span class="builtintype" id="1676426">uintptr</span><span class="op" id="1676433">(</span><span class="ident" id="1676434">unsafe</span><span class="op" id="1676440">.</span><span class="ident" id="1676441">Pointer</span><span class="op" id="1676448">(</span><span class="op" id="1676449">&amp;</span><span class="ident" id="1676450">sel</span><span class="op" id="1676453">)</span><span class="op" id="1676454">)</span><span class="op" id="1676455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1676458">return</span><br>
<span class="lineno"></span><span class="op" id="1676465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="1676468">func</span>&nbsp;<span class="ident" id="1676473">selectdefaultImpl</span><span class="op" id="1676490">(</span><span class="ident" id="1676491">sel</span>&nbsp;<span class="op" id="1676495">*</span><span class="ident" id="1676496">_select</span><span class="op" id="1676503">,</span>&nbsp;<span class="ident" id="1676505">callerpc</span>&nbsp;<span class="builtintype" id="1676514">uintptr</span><span class="op" id="1676521">,</span>&nbsp;<span class="ident" id="1676523">so</span>&nbsp;<span class="builtintype" id="1676526">uintptr</span><span class="op" id="1676533">)</span>&nbsp;<span class="op" id="1676535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1676538">i</span>&nbsp;<span class="op" id="1676540">:=</span>&nbsp;<span class="ident" id="1676543">sel</span><span class="op" id="1676546">.</span><span class="ident" id="1676547">ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1676554">if</span>&nbsp;<span class="ident" id="1676557">i</span>&nbsp;<span class="op" id="1676559">&gt;=</span>&nbsp;<span class="ident" id="1676562">sel</span><span class="op" id="1676565">.</span><span class="ident" id="1676566">tcase</span>&nbsp;<span class="op" id="1676572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1676576">gothrow</span><span class="op" id="1676583">(</span><span class="string" id="1676584">&#34;selectdefault:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="1676615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1676618">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1676621">sel</span><span class="op" id="1676624">.</span><span class="ident" id="1676625">ncase</span>&nbsp;<span class="op" id="1676631">=</span>&nbsp;<span class="ident" id="1676633">i</span>&nbsp;<span class="op" id="1676635">+</span>&nbsp;<span class="num" id="1676637">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1676640">cas</span>&nbsp;<span class="op" id="1676644">:=</span>&nbsp;<span class="op" id="1676647">(</span><span class="op" id="1676648">*</span><span class="ident" id="1676649">scase</span><span class="op" id="1676654">)</span><span class="op" id="1676655">(</span><span class="ident" id="1676656">add</span><span class="op" id="1676659">(</span><span class="ident" id="1676660">unsafe</span><span class="op" id="1676666">.</span><span class="ident" id="1676667">Pointer</span><span class="op" id="1676674">(</span><span class="op" id="1676675">&amp;</span><span class="ident" id="1676676">sel</span><span class="op" id="1676679">.</span><span class="ident" id="1676680">scase</span><span class="op" id="1676685">)</span><span class="op" id="1676686">,</span>&nbsp;<span class="builtintype" id="1676688">uintptr</span><span class="op" id="1676695">(</span><span class="ident" id="1676696">i</span><span class="op" id="1676697">)</span><span class="op" id="1676698">*</span><span class="ident" id="1676699">unsafe</span><span class="op" id="1676705">.</span><span class="ident" id="1676706">Sizeof</span><span class="op" id="1676712">(</span><span class="ident" id="1676713">sel</span><span class="op" id="1676716">.</span><span class="ident" id="1676717">scase</span><span class="op" id="1676722">[</span><span class="num" id="1676723">0</span><span class="op" id="1676724">]</span><span class="op" id="1676725">)</span><span class="op" id="1676726">)</span><span class="op" id="1676727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1676730">cas</span><span class="op" id="1676733">.</span><span class="ident" id="1676734">pc</span>&nbsp;<span class="op" id="1676737">=</span>&nbsp;<span class="ident" id="1676739">callerpc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1676749">cas</span><span class="op" id="1676752">.</span><span class="ident" id="1676753">_chan</span>&nbsp;<span class="op" id="1676759">=</span>&nbsp;<span class="ident" id="1676761">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1676766">cas</span><span class="op" id="1676769">.</span><span class="ident" id="1676770">so</span>&nbsp;<span class="op" id="1676773">=</span>&nbsp;<span class="builtintype" id="1676775">uint16</span><span class="op" id="1676781">(</span><span class="ident" id="1676782">so</span><span class="op" id="1676784">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1676787">cas</span><span class="op" id="1676790">.</span><span class="ident" id="1676791">kind</span>&nbsp;<span class="op" id="1676796">=</span>&nbsp;<span class="ident" id="1676798">_CaseDefault</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1676813">if</span>&nbsp;<span class="ident" id="1676816">debugSelect</span>&nbsp;<span class="op" id="1676828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1676832">print</span><span class="op" id="1676837">(</span><span class="string" id="1676838">&#34;selectdefault&nbsp;s=&#34;</span><span class="op" id="1676856">,</span>&nbsp;<span class="ident" id="1676858">sel</span><span class="op" id="1676861">,</span>&nbsp;<span class="string" id="1676863">&#34;&nbsp;pc=&#34;</span><span class="op" id="1676869">,</span>&nbsp;<span class="ident" id="1676871">hex</span><span class="op" id="1676874">(</span><span class="ident" id="1676875">cas</span><span class="op" id="1676878">.</span><span class="ident" id="1676879">pc</span><span class="op" id="1676881">)</span><span class="op" id="1676882">,</span>&nbsp;<span class="string" id="1676884">&#34;&nbsp;so=&#34;</span><span class="op" id="1676890">,</span>&nbsp;<span class="ident" id="1676892">cas</span><span class="op" id="1676895">.</span><span class="ident" id="1676896">so</span><span class="op" id="1676898">,</span>&nbsp;<span class="string" id="1676900">&#34;\n&#34;</span><span class="op" id="1676904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1676907">}</span><br>
<span class="lineno">130</span><span class="op" id="1676909">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1676912">func</span>&nbsp;<span class="ident" id="1676917">sellock</span><span class="op" id="1676924">(</span><span class="ident" id="1676925">sel</span>&nbsp;<span class="op" id="1676929">*</span><span class="ident" id="1676930">_select</span><span class="op" id="1676937">)</span>&nbsp;<span class="op" id="1676939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1676942">lockslice</span>&nbsp;<span class="op" id="1676952">:=</span>&nbsp;<span class="ident" id="1676955">sliceStruct</span><span class="op" id="1676966">{</span><span class="ident" id="1676967">unsafe</span><span class="op" id="1676973">.</span><span class="ident" id="1676974">Pointer</span><span class="op" id="1676981">(</span><span class="ident" id="1676982">sel</span><span class="op" id="1676985">.</span><span class="ident" id="1676986">lockorder</span><span class="op" id="1676995">)</span><span class="op" id="1676996">,</span>&nbsp;<span class="builtintype" id="1676998">int</span><span class="op" id="1677001">(</span><span class="ident" id="1677002">sel</span><span class="op" id="1677005">.</span><span class="ident" id="1677006">ncase</span><span class="op" id="1677011">)</span><span class="op" id="1677012">,</span>&nbsp;<span class="builtintype" id="1677014">int</span><span class="op" id="1677017">(</span><span class="ident" id="1677018">sel</span><span class="op" id="1677021">.</span><span class="ident" id="1677022">ncase</span><span class="op" id="1677027">)</span><span class="op" id="1677028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1677031">lockorder</span>&nbsp;<span class="op" id="1677041">:=</span>&nbsp;<span class="op" id="1677044">*</span><span class="op" id="1677045">(</span><span class="op" id="1677046">*</span><span class="op" id="1677047">[</span><span class="op" id="1677048">]</span><span class="op" id="1677049">*</span><span class="ident" id="1677050">hchan</span><span class="op" id="1677055">)</span><span class="op" id="1677056">(</span><span class="ident" id="1677057">unsafe</span><span class="op" id="1677063">.</span><span class="ident" id="1677064">Pointer</span><span class="op" id="1677071">(</span><span class="op" id="1677072">&amp;</span><span class="ident" id="1677073">lockslice</span><span class="op" id="1677082">)</span><span class="op" id="1677083">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1677086">var</span>&nbsp;<span class="ident" id="1677090">c</span>&nbsp;<span class="op" id="1677092">*</span><span class="ident" id="1677093">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1677100">for</span>&nbsp;<span class="ident" id="1677104">_</span><span class="op" id="1677105">,</span>&nbsp;<span class="ident" id="1677107">c0</span>&nbsp;<span class="op" id="1677110">:=</span>&nbsp;<span class="keyword" id="1677113">range</span>&nbsp;<span class="ident" id="1677119">lockorder</span>&nbsp;<span class="op" id="1677129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1677133">if</span>&nbsp;<span class="ident" id="1677136">c0</span>&nbsp;<span class="op" id="1677139">!=</span>&nbsp;<span class="ident" id="1677142">nil</span>&nbsp;<span class="op" id="1677146">&amp;&amp;</span>&nbsp;<span class="ident" id="1677149">c0</span>&nbsp;<span class="op" id="1677152">!=</span>&nbsp;<span class="ident" id="1677155">c</span>&nbsp;<span class="op" id="1677157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1677162">c</span>&nbsp;<span class="op" id="1677164">=</span>&nbsp;<span class="ident" id="1677166">c0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1677172">lock</span><span class="op" id="1677176">(</span><span class="op" id="1677177">&amp;</span><span class="ident" id="1677178">c</span><span class="op" id="1677179">.</span><span class="ident" id="1677180">lock</span><span class="op" id="1677184">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1677188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1677191">}</span><br>
<span class="lineno"></span><span class="op" id="1677193">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1677196">func</span>&nbsp;<span class="ident" id="1677201">selunlock</span><span class="op" id="1677210">(</span><span class="ident" id="1677211">sel</span>&nbsp;<span class="op" id="1677215">*</span><span class="ident" id="1677216">_select</span><span class="op" id="1677223">)</span>&nbsp;<span class="op" id="1677225">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1677228">//&nbsp;We&nbsp;must&nbsp;be&nbsp;very&nbsp;careful&nbsp;here&nbsp;to&nbsp;not&nbsp;touch&nbsp;sel&nbsp;after&nbsp;we&nbsp;have&nbsp;unlocked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1677301">//&nbsp;the&nbsp;last&nbsp;lock,&nbsp;because&nbsp;sel&nbsp;can&nbsp;be&nbsp;freed&nbsp;right&nbsp;after&nbsp;the&nbsp;last&nbsp;unlock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1677374">//&nbsp;Consider&nbsp;the&nbsp;following&nbsp;situation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1677412">//&nbsp;First&nbsp;M&nbsp;calls&nbsp;runtime·park()&nbsp;in&nbsp;runtime·selectgo()&nbsp;passing&nbsp;the&nbsp;sel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1677486">//&nbsp;Once&nbsp;runtime·park()&nbsp;has&nbsp;unlocked&nbsp;the&nbsp;last&nbsp;lock,&nbsp;another&nbsp;M&nbsp;makes</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1677555">//&nbsp;the&nbsp;G&nbsp;that&nbsp;calls&nbsp;select&nbsp;runnable&nbsp;again&nbsp;and&nbsp;schedules&nbsp;it&nbsp;for&nbsp;execution.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1677630">//&nbsp;When&nbsp;the&nbsp;G&nbsp;runs&nbsp;on&nbsp;another&nbsp;M,&nbsp;it&nbsp;locks&nbsp;all&nbsp;the&nbsp;locks&nbsp;and&nbsp;frees&nbsp;sel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1677702">//&nbsp;Now&nbsp;if&nbsp;the&nbsp;first&nbsp;M&nbsp;touches&nbsp;sel,&nbsp;it&nbsp;will&nbsp;access&nbsp;freed&nbsp;memory.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1677767">n</span>&nbsp;<span class="op" id="1677769">:=</span>&nbsp;<span class="builtintype" id="1677772">int</span><span class="op" id="1677775">(</span><span class="ident" id="1677776">sel</span><span class="op" id="1677779">.</span><span class="ident" id="1677780">ncase</span><span class="op" id="1677785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1677788">r</span>&nbsp;<span class="op" id="1677790">:=</span>&nbsp;<span class="num" id="1677793">0</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1677796">lockslice</span>&nbsp;<span class="op" id="1677806">:=</span>&nbsp;<span class="ident" id="1677809">sliceStruct</span><span class="op" id="1677820">{</span><span class="ident" id="1677821">unsafe</span><span class="op" id="1677827">.</span><span class="ident" id="1677828">Pointer</span><span class="op" id="1677835">(</span><span class="ident" id="1677836">sel</span><span class="op" id="1677839">.</span><span class="ident" id="1677840">lockorder</span><span class="op" id="1677849">)</span><span class="op" id="1677850">,</span>&nbsp;<span class="ident" id="1677852">n</span><span class="op" id="1677853">,</span>&nbsp;<span class="ident" id="1677855">n</span><span class="op" id="1677856">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1677859">lockorder</span>&nbsp;<span class="op" id="1677869">:=</span>&nbsp;<span class="op" id="1677872">*</span><span class="op" id="1677873">(</span><span class="op" id="1677874">*</span><span class="op" id="1677875">[</span><span class="op" id="1677876">]</span><span class="op" id="1677877">*</span><span class="ident" id="1677878">hchan</span><span class="op" id="1677883">)</span><span class="op" id="1677884">(</span><span class="ident" id="1677885">unsafe</span><span class="op" id="1677891">.</span><span class="ident" id="1677892">Pointer</span><span class="op" id="1677899">(</span><span class="op" id="1677900">&amp;</span><span class="ident" id="1677901">lockslice</span><span class="op" id="1677910">)</span><span class="op" id="1677911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1677914">//&nbsp;skip&nbsp;the&nbsp;default&nbsp;case</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1677940">if</span>&nbsp;<span class="ident" id="1677943">n</span>&nbsp;<span class="op" id="1677945">&gt;</span>&nbsp;<span class="num" id="1677947">0</span>&nbsp;<span class="op" id="1677949">&amp;&amp;</span>&nbsp;<span class="ident" id="1677952">lockorder</span><span class="op" id="1677961">[</span><span class="num" id="1677962">0</span><span class="op" id="1677963">]</span>&nbsp;<span class="op" id="1677965">==</span>&nbsp;<span class="ident" id="1677968">nil</span>&nbsp;<span class="op" id="1677972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1677976">r</span>&nbsp;<span class="op" id="1677978">=</span>&nbsp;<span class="num" id="1677980">1</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1677983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1677986">for</span>&nbsp;<span class="ident" id="1677990">i</span>&nbsp;<span class="op" id="1677992">:=</span>&nbsp;<span class="ident" id="1677995">n</span>&nbsp;<span class="op" id="1677997">-</span>&nbsp;<span class="num" id="1677999">1</span><span class="op" id="1678000">;</span>&nbsp;<span class="ident" id="1678002">i</span>&nbsp;<span class="op" id="1678004">&gt;=</span>&nbsp;<span class="ident" id="1678007">r</span><span class="op" id="1678008">;</span>&nbsp;<span class="ident" id="1678010">i</span><span class="op" id="1678011">--</span>&nbsp;<span class="op" id="1678014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1678018">c</span>&nbsp;<span class="op" id="1678020">:=</span>&nbsp;<span class="ident" id="1678023">lockorder</span><span class="op" id="1678032">[</span><span class="ident" id="1678033">i</span><span class="op" id="1678034">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1678038">if</span>&nbsp;<span class="ident" id="1678041">i</span>&nbsp;<span class="op" id="1678043">&gt;</span>&nbsp;<span class="num" id="1678045">0</span>&nbsp;<span class="op" id="1678047">&amp;&amp;</span>&nbsp;<span class="ident" id="1678050">c</span>&nbsp;<span class="op" id="1678052">==</span>&nbsp;<span class="ident" id="1678055">lockorder</span><span class="op" id="1678064">[</span><span class="ident" id="1678065">i</span><span class="op" id="1678066">-</span><span class="num" id="1678067">1</span><span class="op" id="1678068">]</span>&nbsp;<span class="op" id="1678070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1678075">continue</span>&nbsp;<span class="comment" id="1678084">//&nbsp;will&nbsp;unlock&nbsp;it&nbsp;on&nbsp;the&nbsp;next&nbsp;iteration</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1678126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1678130">unlock</span><span class="op" id="1678136">(</span><span class="op" id="1678137">&amp;</span><span class="ident" id="1678138">c</span><span class="op" id="1678139">.</span><span class="ident" id="1678140">lock</span><span class="op" id="1678144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1678147">}</span><br>
<span class="lineno"></span><span class="op" id="1678149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="keyword" id="1678152">func</span>&nbsp;<span class="ident" id="1678157">selparkcommit</span><span class="op" id="1678170">(</span><span class="ident" id="1678171">gp</span>&nbsp;<span class="op" id="1678174">*</span><span class="ident" id="1678175">g</span><span class="op" id="1678176">,</span>&nbsp;<span class="ident" id="1678178">sel</span>&nbsp;<span class="op" id="1678182">*</span><span class="ident" id="1678183">_select</span><span class="op" id="1678190">)</span>&nbsp;<span class="builtintype" id="1678192">bool</span>&nbsp;<span class="op" id="1678197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1678200">selunlock</span><span class="op" id="1678209">(</span><span class="ident" id="1678210">sel</span><span class="op" id="1678213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1678216">return</span>&nbsp;<span class="ident" id="1678223">true</span><br>
<span class="lineno"></span><span class="op" id="1678228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="keyword" id="1678231">func</span>&nbsp;<span class="ident" id="1678236">block</span><span class="op" id="1678241">(</span><span class="op" id="1678242">)</span>&nbsp;<span class="op" id="1678244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1678247">gopark</span><span class="op" id="1678253">(</span><span class="ident" id="1678254">nil</span><span class="op" id="1678257">,</span>&nbsp;<span class="ident" id="1678259">nil</span><span class="op" id="1678262">,</span>&nbsp;<span class="string" id="1678264">&#34;select&nbsp;(no&nbsp;cases)&#34;</span><span class="op" id="1678283">)</span>&nbsp;<span class="comment" id="1678285">//&nbsp;forever</span><br>
<span class="lineno"></span><span class="op" id="1678296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1678299">//&nbsp;overwrites&nbsp;return&nbsp;pc&nbsp;on&nbsp;stack&nbsp;to&nbsp;signal&nbsp;which&nbsp;case&nbsp;of&nbsp;the&nbsp;select</span><br>
<span class="lineno">180</span><span class="comment" id="1678367">//&nbsp;to&nbsp;run,&nbsp;so&nbsp;cannot&nbsp;appear&nbsp;at&nbsp;the&nbsp;top&nbsp;of&nbsp;a&nbsp;split&nbsp;stack.</span><br>
<span class="lineno"></span><span class="comment" id="1678424">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1678437">func</span>&nbsp;<span class="ident" id="1678442">selectgo</span><span class="op" id="1678450">(</span><span class="ident" id="1678451">sel</span>&nbsp;<span class="op" id="1678455">*</span><span class="ident" id="1678456">_select</span><span class="op" id="1678463">)</span>&nbsp;<span class="op" id="1678465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1678468">pc</span><span class="op" id="1678470">,</span>&nbsp;<span class="ident" id="1678472">offset</span>&nbsp;<span class="op" id="1678479">:=</span>&nbsp;<span class="ident" id="1678482">selectgoImpl</span><span class="op" id="1678494">(</span><span class="ident" id="1678495">sel</span><span class="op" id="1678498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1678501">*</span><span class="op" id="1678502">(</span><span class="op" id="1678503">*</span><span class="builtintype" id="1678504">bool</span><span class="op" id="1678508">)</span><span class="op" id="1678509">(</span><span class="ident" id="1678510">add</span><span class="op" id="1678513">(</span><span class="ident" id="1678514">unsafe</span><span class="op" id="1678520">.</span><span class="ident" id="1678521">Pointer</span><span class="op" id="1678528">(</span><span class="op" id="1678529">&amp;</span><span class="ident" id="1678530">sel</span><span class="op" id="1678533">)</span><span class="op" id="1678534">,</span>&nbsp;<span class="builtintype" id="1678536">uintptr</span><span class="op" id="1678543">(</span><span class="ident" id="1678544">offset</span><span class="op" id="1678550">)</span><span class="op" id="1678551">)</span><span class="op" id="1678552">)</span>&nbsp;<span class="op" id="1678554">=</span>&nbsp;<span class="ident" id="1678556">true</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1678562">setcallerpc</span><span class="op" id="1678573">(</span><span class="ident" id="1678574">unsafe</span><span class="op" id="1678580">.</span><span class="ident" id="1678581">Pointer</span><span class="op" id="1678588">(</span><span class="op" id="1678589">&amp;</span><span class="ident" id="1678590">sel</span><span class="op" id="1678593">)</span><span class="op" id="1678594">,</span>&nbsp;<span class="ident" id="1678596">pc</span><span class="op" id="1678598">)</span><br>
<span class="lineno"></span><span class="op" id="1678600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1678603">//&nbsp;selectgoImpl&nbsp;returns&nbsp;scase.pc&nbsp;and&nbsp;scase.so&nbsp;for&nbsp;the&nbsp;select</span><br>
<span class="lineno"></span><span class="comment" id="1678664">//&nbsp;case&nbsp;which&nbsp;fired.</span><br>
<span class="lineno">190</span><span class="keyword" id="1678685">func</span>&nbsp;<span class="ident" id="1678690">selectgoImpl</span><span class="op" id="1678702">(</span><span class="ident" id="1678703">sel</span>&nbsp;<span class="op" id="1678707">*</span><span class="ident" id="1678708">_select</span><span class="op" id="1678715">)</span>&nbsp;<span class="op" id="1678717">(</span><span class="builtintype" id="1678718">uintptr</span><span class="op" id="1678725">,</span>&nbsp;<span class="builtintype" id="1678727">uint16</span><span class="op" id="1678733">)</span>&nbsp;<span class="op" id="1678735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1678738">if</span>&nbsp;<span class="ident" id="1678741">debugSelect</span>&nbsp;<span class="op" id="1678753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1678757">print</span><span class="op" id="1678762">(</span><span class="string" id="1678763">&#34;select:&nbsp;sel=&#34;</span><span class="op" id="1678777">,</span>&nbsp;<span class="ident" id="1678779">sel</span><span class="op" id="1678782">,</span>&nbsp;<span class="string" id="1678784">&#34;\n&#34;</span><span class="op" id="1678788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1678791">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1678795">scaseslice</span>&nbsp;<span class="op" id="1678806">:=</span>&nbsp;<span class="ident" id="1678809">sliceStruct</span><span class="op" id="1678820">{</span><span class="ident" id="1678821">unsafe</span><span class="op" id="1678827">.</span><span class="ident" id="1678828">Pointer</span><span class="op" id="1678835">(</span><span class="op" id="1678836">&amp;</span><span class="ident" id="1678837">sel</span><span class="op" id="1678840">.</span><span class="ident" id="1678841">scase</span><span class="op" id="1678846">)</span><span class="op" id="1678847">,</span>&nbsp;<span class="builtintype" id="1678849">int</span><span class="op" id="1678852">(</span><span class="ident" id="1678853">sel</span><span class="op" id="1678856">.</span><span class="ident" id="1678857">ncase</span><span class="op" id="1678862">)</span><span class="op" id="1678863">,</span>&nbsp;<span class="builtintype" id="1678865">int</span><span class="op" id="1678868">(</span><span class="ident" id="1678869">sel</span><span class="op" id="1678872">.</span><span class="ident" id="1678873">ncase</span><span class="op" id="1678878">)</span><span class="op" id="1678879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1678882">scases</span>&nbsp;<span class="op" id="1678889">:=</span>&nbsp;<span class="op" id="1678892">*</span><span class="op" id="1678893">(</span><span class="op" id="1678894">*</span><span class="op" id="1678895">[</span><span class="op" id="1678896">]</span><span class="ident" id="1678897">scase</span><span class="op" id="1678902">)</span><span class="op" id="1678903">(</span><span class="ident" id="1678904">unsafe</span><span class="op" id="1678910">.</span><span class="ident" id="1678911">Pointer</span><span class="op" id="1678918">(</span><span class="op" id="1678919">&amp;</span><span class="ident" id="1678920">scaseslice</span><span class="op" id="1678930">)</span><span class="op" id="1678931">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1678935">var</span>&nbsp;<span class="ident" id="1678939">t0</span>&nbsp;<span class="ident" id="1678942">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1678949">if</span>&nbsp;<span class="ident" id="1678952">blockprofilerate</span>&nbsp;<span class="op" id="1678969">&gt;</span>&nbsp;<span class="num" id="1678971">0</span>&nbsp;<span class="op" id="1678973">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1678977">t0</span>&nbsp;<span class="op" id="1678980">=</span>&nbsp;<span class="ident" id="1678982">cputicks</span><span class="op" id="1678990">(</span><span class="op" id="1678991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1678995">for</span>&nbsp;<span class="ident" id="1678999">i</span>&nbsp;<span class="op" id="1679001">:=</span>&nbsp;<span class="num" id="1679004">0</span><span class="op" id="1679005">;</span>&nbsp;<span class="ident" id="1679007">i</span>&nbsp;<span class="op" id="1679009">&lt;</span>&nbsp;<span class="builtintype" id="1679011">int</span><span class="op" id="1679014">(</span><span class="ident" id="1679015">sel</span><span class="op" id="1679018">.</span><span class="ident" id="1679019">ncase</span><span class="op" id="1679024">)</span><span class="op" id="1679025">;</span>&nbsp;<span class="ident" id="1679027">i</span><span class="op" id="1679028">++</span>&nbsp;<span class="op" id="1679031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1679036">scases</span><span class="op" id="1679042">[</span><span class="ident" id="1679043">i</span><span class="op" id="1679044">]</span><span class="op" id="1679045">.</span><span class="ident" id="1679046">releasetime</span>&nbsp;<span class="op" id="1679058">=</span>&nbsp;<span class="op" id="1679060">-</span><span class="num" id="1679061">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1679065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1679068">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1679072">//&nbsp;The&nbsp;compiler&nbsp;rewrites&nbsp;selects&nbsp;that&nbsp;statically&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1679127">//&nbsp;only&nbsp;0&nbsp;or&nbsp;1&nbsp;cases&nbsp;plus&nbsp;default&nbsp;into&nbsp;simpler&nbsp;constructs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1679187">//&nbsp;The&nbsp;only&nbsp;way&nbsp;we&nbsp;can&nbsp;end&nbsp;up&nbsp;with&nbsp;such&nbsp;small&nbsp;sel.ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1679244">//&nbsp;values&nbsp;here&nbsp;is&nbsp;for&nbsp;a&nbsp;larger&nbsp;select&nbsp;in&nbsp;which&nbsp;most&nbsp;channels</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1679306">//&nbsp;have&nbsp;been&nbsp;nilled&nbsp;out.&nbsp;&nbsp;The&nbsp;general&nbsp;code&nbsp;handles&nbsp;those</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1679364">//&nbsp;cases&nbsp;correctly,&nbsp;and&nbsp;they&nbsp;are&nbsp;rare&nbsp;enough&nbsp;not&nbsp;to&nbsp;bother</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1679424">//&nbsp;optimizing&nbsp;(and&nbsp;needing&nbsp;to&nbsp;test).</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1679463">//&nbsp;generate&nbsp;permuted&nbsp;order</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1679491">pollslice</span>&nbsp;<span class="op" id="1679501">:=</span>&nbsp;<span class="ident" id="1679504">sliceStruct</span><span class="op" id="1679515">{</span><span class="ident" id="1679516">unsafe</span><span class="op" id="1679522">.</span><span class="ident" id="1679523">Pointer</span><span class="op" id="1679530">(</span><span class="ident" id="1679531">sel</span><span class="op" id="1679534">.</span><span class="ident" id="1679535">pollorder</span><span class="op" id="1679544">)</span><span class="op" id="1679545">,</span>&nbsp;<span class="builtintype" id="1679547">int</span><span class="op" id="1679550">(</span><span class="ident" id="1679551">sel</span><span class="op" id="1679554">.</span><span class="ident" id="1679555">ncase</span><span class="op" id="1679560">)</span><span class="op" id="1679561">,</span>&nbsp;<span class="builtintype" id="1679563">int</span><span class="op" id="1679566">(</span><span class="ident" id="1679567">sel</span><span class="op" id="1679570">.</span><span class="ident" id="1679571">ncase</span><span class="op" id="1679576">)</span><span class="op" id="1679577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1679580">pollorder</span>&nbsp;<span class="op" id="1679590">:=</span>&nbsp;<span class="op" id="1679593">*</span><span class="op" id="1679594">(</span><span class="op" id="1679595">*</span><span class="op" id="1679596">[</span><span class="op" id="1679597">]</span><span class="builtintype" id="1679598">uint16</span><span class="op" id="1679604">)</span><span class="op" id="1679605">(</span><span class="ident" id="1679606">unsafe</span><span class="op" id="1679612">.</span><span class="ident" id="1679613">Pointer</span><span class="op" id="1679620">(</span><span class="op" id="1679621">&amp;</span><span class="ident" id="1679622">pollslice</span><span class="op" id="1679631">)</span><span class="op" id="1679632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1679635">for</span>&nbsp;<span class="ident" id="1679639">i</span>&nbsp;<span class="op" id="1679641">:=</span>&nbsp;<span class="num" id="1679644">0</span><span class="op" id="1679645">;</span>&nbsp;<span class="ident" id="1679647">i</span>&nbsp;<span class="op" id="1679649">&lt;</span>&nbsp;<span class="builtintype" id="1679651">int</span><span class="op" id="1679654">(</span><span class="ident" id="1679655">sel</span><span class="op" id="1679658">.</span><span class="ident" id="1679659">ncase</span><span class="op" id="1679664">)</span><span class="op" id="1679665">;</span>&nbsp;<span class="ident" id="1679667">i</span><span class="op" id="1679668">++</span>&nbsp;<span class="op" id="1679671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1679675">pollorder</span><span class="op" id="1679684">[</span><span class="ident" id="1679685">i</span><span class="op" id="1679686">]</span>&nbsp;<span class="op" id="1679688">=</span>&nbsp;<span class="builtintype" id="1679690">uint16</span><span class="op" id="1679696">(</span><span class="ident" id="1679697">i</span><span class="op" id="1679698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1679701">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1679704">for</span>&nbsp;<span class="ident" id="1679708">i</span>&nbsp;<span class="op" id="1679710">:=</span>&nbsp;<span class="num" id="1679713">1</span><span class="op" id="1679714">;</span>&nbsp;<span class="ident" id="1679716">i</span>&nbsp;<span class="op" id="1679718">&lt;</span>&nbsp;<span class="builtintype" id="1679720">int</span><span class="op" id="1679723">(</span><span class="ident" id="1679724">sel</span><span class="op" id="1679727">.</span><span class="ident" id="1679728">ncase</span><span class="op" id="1679733">)</span><span class="op" id="1679734">;</span>&nbsp;<span class="ident" id="1679736">i</span><span class="op" id="1679737">++</span>&nbsp;<span class="op" id="1679740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1679744">o</span>&nbsp;<span class="op" id="1679746">:=</span>&nbsp;<span class="ident" id="1679749">pollorder</span><span class="op" id="1679758">[</span><span class="ident" id="1679759">i</span><span class="op" id="1679760">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1679764">j</span>&nbsp;<span class="op" id="1679766">:=</span>&nbsp;<span class="builtintype" id="1679769">int</span><span class="op" id="1679772">(</span><span class="ident" id="1679773">fastrand1</span><span class="op" id="1679782">(</span><span class="op" id="1679783">)</span><span class="op" id="1679784">)</span>&nbsp;<span class="op" id="1679786">%</span>&nbsp;<span class="op" id="1679788">(</span><span class="ident" id="1679789">i</span>&nbsp;<span class="op" id="1679791">+</span>&nbsp;<span class="num" id="1679793">1</span><span class="op" id="1679794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1679798">pollorder</span><span class="op" id="1679807">[</span><span class="ident" id="1679808">i</span><span class="op" id="1679809">]</span>&nbsp;<span class="op" id="1679811">=</span>&nbsp;<span class="ident" id="1679813">pollorder</span><span class="op" id="1679822">[</span><span class="ident" id="1679823">j</span><span class="op" id="1679824">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1679828">pollorder</span><span class="op" id="1679837">[</span><span class="ident" id="1679838">j</span><span class="op" id="1679839">]</span>&nbsp;<span class="op" id="1679841">=</span>&nbsp;<span class="ident" id="1679843">o</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1679846">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1679850">//&nbsp;sort&nbsp;the&nbsp;cases&nbsp;by&nbsp;Hchan&nbsp;address&nbsp;to&nbsp;get&nbsp;the&nbsp;locking&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1679912">//&nbsp;simple&nbsp;heap&nbsp;sort,&nbsp;to&nbsp;guarantee&nbsp;n&nbsp;log&nbsp;n&nbsp;time&nbsp;and&nbsp;constant&nbsp;stack&nbsp;footprint.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1679990">lockslice</span>&nbsp;<span class="op" id="1680000">:=</span>&nbsp;<span class="ident" id="1680003">sliceStruct</span><span class="op" id="1680014">{</span><span class="ident" id="1680015">unsafe</span><span class="op" id="1680021">.</span><span class="ident" id="1680022">Pointer</span><span class="op" id="1680029">(</span><span class="ident" id="1680030">sel</span><span class="op" id="1680033">.</span><span class="ident" id="1680034">lockorder</span><span class="op" id="1680043">)</span><span class="op" id="1680044">,</span>&nbsp;<span class="builtintype" id="1680046">int</span><span class="op" id="1680049">(</span><span class="ident" id="1680050">sel</span><span class="op" id="1680053">.</span><span class="ident" id="1680054">ncase</span><span class="op" id="1680059">)</span><span class="op" id="1680060">,</span>&nbsp;<span class="builtintype" id="1680062">int</span><span class="op" id="1680065">(</span><span class="ident" id="1680066">sel</span><span class="op" id="1680069">.</span><span class="ident" id="1680070">ncase</span><span class="op" id="1680075">)</span><span class="op" id="1680076">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1680079">lockorder</span>&nbsp;<span class="op" id="1680089">:=</span>&nbsp;<span class="op" id="1680092">*</span><span class="op" id="1680093">(</span><span class="op" id="1680094">*</span><span class="op" id="1680095">[</span><span class="op" id="1680096">]</span><span class="op" id="1680097">*</span><span class="ident" id="1680098">hchan</span><span class="op" id="1680103">)</span><span class="op" id="1680104">(</span><span class="ident" id="1680105">unsafe</span><span class="op" id="1680111">.</span><span class="ident" id="1680112">Pointer</span><span class="op" id="1680119">(</span><span class="op" id="1680120">&amp;</span><span class="ident" id="1680121">lockslice</span><span class="op" id="1680130">)</span><span class="op" id="1680131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1680134">for</span>&nbsp;<span class="ident" id="1680138">i</span>&nbsp;<span class="op" id="1680140">:=</span>&nbsp;<span class="num" id="1680143">0</span><span class="op" id="1680144">;</span>&nbsp;<span class="ident" id="1680146">i</span>&nbsp;<span class="op" id="1680148">&lt;</span>&nbsp;<span class="builtintype" id="1680150">int</span><span class="op" id="1680153">(</span><span class="ident" id="1680154">sel</span><span class="op" id="1680157">.</span><span class="ident" id="1680158">ncase</span><span class="op" id="1680163">)</span><span class="op" id="1680164">;</span>&nbsp;<span class="ident" id="1680166">i</span><span class="op" id="1680167">++</span>&nbsp;<span class="op" id="1680170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1680174">j</span>&nbsp;<span class="op" id="1680176">:=</span>&nbsp;<span class="ident" id="1680179">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1680183">c</span>&nbsp;<span class="op" id="1680185">:=</span>&nbsp;<span class="ident" id="1680188">scases</span><span class="op" id="1680194">[</span><span class="ident" id="1680195">j</span><span class="op" id="1680196">]</span><span class="op" id="1680197">.</span><span class="ident" id="1680198">_chan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1680206">for</span>&nbsp;<span class="ident" id="1680210">j</span>&nbsp;<span class="op" id="1680212">&gt;</span>&nbsp;<span class="num" id="1680214">0</span>&nbsp;<span class="op" id="1680216">&amp;&amp;</span>&nbsp;<span class="ident" id="1680219">lockorder</span><span class="op" id="1680228">[</span><span class="op" id="1680229">(</span><span class="ident" id="1680230">j</span><span class="op" id="1680231">-</span><span class="num" id="1680232">1</span><span class="op" id="1680233">)</span><span class="op" id="1680234">/</span><span class="num" id="1680235">2</span><span class="op" id="1680236">]</span><span class="op" id="1680237">.</span><span class="ident" id="1680238">sortkey</span><span class="op" id="1680245">(</span><span class="op" id="1680246">)</span>&nbsp;<span class="op" id="1680248">&lt;</span>&nbsp;<span class="ident" id="1680250">c</span><span class="op" id="1680251">.</span><span class="ident" id="1680252">sortkey</span><span class="op" id="1680259">(</span><span class="op" id="1680260">)</span>&nbsp;<span class="op" id="1680262">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1680267">k</span>&nbsp;<span class="op" id="1680269">:=</span>&nbsp;<span class="op" id="1680272">(</span><span class="ident" id="1680273">j</span>&nbsp;<span class="op" id="1680275">-</span>&nbsp;<span class="num" id="1680277">1</span><span class="op" id="1680278">)</span>&nbsp;<span class="op" id="1680280">/</span>&nbsp;<span class="num" id="1680282">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1680287">lockorder</span><span class="op" id="1680296">[</span><span class="ident" id="1680297">j</span><span class="op" id="1680298">]</span>&nbsp;<span class="op" id="1680300">=</span>&nbsp;<span class="ident" id="1680302">lockorder</span><span class="op" id="1680311">[</span><span class="ident" id="1680312">k</span><span class="op" id="1680313">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1680318">j</span>&nbsp;<span class="op" id="1680320">=</span>&nbsp;<span class="ident" id="1680322">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1680326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1680330">lockorder</span><span class="op" id="1680339">[</span><span class="ident" id="1680340">j</span><span class="op" id="1680341">]</span>&nbsp;<span class="op" id="1680343">=</span>&nbsp;<span class="ident" id="1680345">c</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1680348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1680351">for</span>&nbsp;<span class="ident" id="1680355">i</span>&nbsp;<span class="op" id="1680357">:=</span>&nbsp;<span class="builtintype" id="1680360">int</span><span class="op" id="1680363">(</span><span class="ident" id="1680364">sel</span><span class="op" id="1680367">.</span><span class="ident" id="1680368">ncase</span><span class="op" id="1680373">)</span>&nbsp;<span class="op" id="1680375">-</span>&nbsp;<span class="num" id="1680377">1</span><span class="op" id="1680378">;</span>&nbsp;<span class="ident" id="1680380">i</span>&nbsp;<span class="op" id="1680382">&gt;=</span>&nbsp;<span class="num" id="1680385">0</span><span class="op" id="1680386">;</span>&nbsp;<span class="ident" id="1680388">i</span><span class="op" id="1680389">--</span>&nbsp;<span class="op" id="1680392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1680396">c</span>&nbsp;<span class="op" id="1680398">:=</span>&nbsp;<span class="ident" id="1680401">lockorder</span><span class="op" id="1680410">[</span><span class="ident" id="1680411">i</span><span class="op" id="1680412">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1680416">lockorder</span><span class="op" id="1680425">[</span><span class="ident" id="1680426">i</span><span class="op" id="1680427">]</span>&nbsp;<span class="op" id="1680429">=</span>&nbsp;<span class="ident" id="1680431">lockorder</span><span class="op" id="1680440">[</span><span class="num" id="1680441">0</span><span class="op" id="1680442">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1680446">j</span>&nbsp;<span class="op" id="1680448">:=</span>&nbsp;<span class="num" id="1680451">0</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1680455">for</span>&nbsp;<span class="op" id="1680459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1680464">k</span>&nbsp;<span class="op" id="1680466">:=</span>&nbsp;<span class="ident" id="1680469">j</span><span class="op" id="1680470">*</span><span class="num" id="1680471">2</span>&nbsp;<span class="op" id="1680473">+</span>&nbsp;<span class="num" id="1680475">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1680480">if</span>&nbsp;<span class="ident" id="1680483">k</span>&nbsp;<span class="op" id="1680485">&gt;=</span>&nbsp;<span class="ident" id="1680488">i</span>&nbsp;<span class="op" id="1680490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1680496">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1680505">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1680510">if</span>&nbsp;<span class="ident" id="1680513">k</span><span class="op" id="1680514">+</span><span class="num" id="1680515">1</span>&nbsp;<span class="op" id="1680517">&lt;</span>&nbsp;<span class="ident" id="1680519">i</span>&nbsp;<span class="op" id="1680521">&amp;&amp;</span>&nbsp;<span class="ident" id="1680524">lockorder</span><span class="op" id="1680533">[</span><span class="ident" id="1680534">k</span><span class="op" id="1680535">]</span><span class="op" id="1680536">.</span><span class="ident" id="1680537">sortkey</span><span class="op" id="1680544">(</span><span class="op" id="1680545">)</span>&nbsp;<span class="op" id="1680547">&lt;</span>&nbsp;<span class="ident" id="1680549">lockorder</span><span class="op" id="1680558">[</span><span class="ident" id="1680559">k</span><span class="op" id="1680560">+</span><span class="num" id="1680561">1</span><span class="op" id="1680562">]</span><span class="op" id="1680563">.</span><span class="ident" id="1680564">sortkey</span><span class="op" id="1680571">(</span><span class="op" id="1680572">)</span>&nbsp;<span class="op" id="1680574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1680580">k</span><span class="op" id="1680581">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1680587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1680592">if</span>&nbsp;<span class="ident" id="1680595">c</span><span class="op" id="1680596">.</span><span class="ident" id="1680597">sortkey</span><span class="op" id="1680604">(</span><span class="op" id="1680605">)</span>&nbsp;<span class="op" id="1680607">&lt;</span>&nbsp;<span class="ident" id="1680609">lockorder</span><span class="op" id="1680618">[</span><span class="ident" id="1680619">k</span><span class="op" id="1680620">]</span><span class="op" id="1680621">.</span><span class="ident" id="1680622">sortkey</span><span class="op" id="1680629">(</span><span class="op" id="1680630">)</span>&nbsp;<span class="op" id="1680632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1680638">lockorder</span><span class="op" id="1680647">[</span><span class="ident" id="1680648">j</span><span class="op" id="1680649">]</span>&nbsp;<span class="op" id="1680651">=</span>&nbsp;<span class="ident" id="1680653">lockorder</span><span class="op" id="1680662">[</span><span class="ident" id="1680663">k</span><span class="op" id="1680664">]</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1680670">j</span>&nbsp;<span class="op" id="1680672">=</span>&nbsp;<span class="ident" id="1680674">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1680680">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1680692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1680697">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1680705">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1680709">lockorder</span><span class="op" id="1680718">[</span><span class="ident" id="1680719">j</span><span class="op" id="1680720">]</span>&nbsp;<span class="op" id="1680722">=</span>&nbsp;<span class="ident" id="1680724">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1680727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1680730">/*<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfor&nbsp;i&nbsp;:=&nbsp;0;&nbsp;i+1&nbsp;&lt;&nbsp;int(sel.ncase);&nbsp;i++&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;lockorder[i].sortkey()&nbsp;&gt;&nbsp;lockorder[i+1].sortkey()&nbsp;{<br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspprint(&#34;i=&#34;,&nbsp;i,&nbsp;&#34;&nbsp;x=&#34;,&nbsp;lockorder[i],&nbsp;&#34;&nbsp;y=&#34;,&nbsp;lockorder[i+1],&nbsp;&#34;\n&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspgothrow(&#34;select:&nbsp;broken&nbsp;sort&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp*/</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1680952">//&nbsp;lock&nbsp;all&nbsp;the&nbsp;channels&nbsp;involved&nbsp;in&nbsp;the&nbsp;select</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681001">sellock</span><span class="op" id="1681008">(</span><span class="ident" id="1681009">sel</span><span class="op" id="1681012">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1681016">var</span>&nbsp;<span class="op" id="1681020">(</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681024">gp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1681031">*</span><span class="ident" id="1681032">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681036">done</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1681043">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681052">sg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1681059">*</span><span class="ident" id="1681060">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681068">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1681075">*</span><span class="ident" id="1681076">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681084">k</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1681091">*</span><span class="ident" id="1681092">scase</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681100">sglist</span>&nbsp;<span class="op" id="1681107">*</span><span class="ident" id="1681108">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681116">sgnext</span>&nbsp;<span class="op" id="1681123">*</span><span class="ident" id="1681124">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1681131">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1681134">loop</span><span class="op" id="1681138">:</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1681141">//&nbsp;pass&nbsp;1&nbsp;-&nbsp;look&nbsp;for&nbsp;something&nbsp;already&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1681189">var</span>&nbsp;<span class="ident" id="1681193">dfl</span>&nbsp;<span class="op" id="1681197">*</span><span class="ident" id="1681198">scase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1681205">var</span>&nbsp;<span class="ident" id="1681209">cas</span>&nbsp;<span class="op" id="1681213">*</span><span class="ident" id="1681214">scase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1681221">for</span>&nbsp;<span class="ident" id="1681225">i</span>&nbsp;<span class="op" id="1681227">:=</span>&nbsp;<span class="num" id="1681230">0</span><span class="op" id="1681231">;</span>&nbsp;<span class="ident" id="1681233">i</span>&nbsp;<span class="op" id="1681235">&lt;</span>&nbsp;<span class="builtintype" id="1681237">int</span><span class="op" id="1681240">(</span><span class="ident" id="1681241">sel</span><span class="op" id="1681244">.</span><span class="ident" id="1681245">ncase</span><span class="op" id="1681250">)</span><span class="op" id="1681251">;</span>&nbsp;<span class="ident" id="1681253">i</span><span class="op" id="1681254">++</span>&nbsp;<span class="op" id="1681257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681261">cas</span>&nbsp;<span class="op" id="1681265">=</span>&nbsp;<span class="op" id="1681267">&amp;</span><span class="ident" id="1681268">scases</span><span class="op" id="1681274">[</span><span class="ident" id="1681275">pollorder</span><span class="op" id="1681284">[</span><span class="ident" id="1681285">i</span><span class="op" id="1681286">]</span><span class="op" id="1681287">]</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681291">c</span>&nbsp;<span class="op" id="1681293">=</span>&nbsp;<span class="ident" id="1681295">cas</span><span class="op" id="1681298">.</span><span class="ident" id="1681299">_chan</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1681308">switch</span>&nbsp;<span class="ident" id="1681315">cas</span><span class="op" id="1681318">.</span><span class="ident" id="1681319">kind</span>&nbsp;<span class="op" id="1681324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1681328">case</span>&nbsp;<span class="ident" id="1681333">_CaseRecv</span><span class="op" id="1681342">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1681347">if</span>&nbsp;<span class="ident" id="1681350">c</span><span class="op" id="1681351">.</span><span class="ident" id="1681352">dataqsiz</span>&nbsp;<span class="op" id="1681361">&gt;</span>&nbsp;<span class="num" id="1681363">0</span>&nbsp;<span class="op" id="1681365">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1681371">if</span>&nbsp;<span class="ident" id="1681374">c</span><span class="op" id="1681375">.</span><span class="ident" id="1681376">qcount</span>&nbsp;<span class="op" id="1681383">&gt;</span>&nbsp;<span class="num" id="1681385">0</span>&nbsp;<span class="op" id="1681387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1681394">goto</span>&nbsp;<span class="ident" id="1681399">asyncrecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1681413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1681418">}</span>&nbsp;<span class="keyword" id="1681420">else</span>&nbsp;<span class="op" id="1681425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681431">sg</span>&nbsp;<span class="op" id="1681434">=</span>&nbsp;<span class="ident" id="1681436">c</span><span class="op" id="1681437">.</span><span class="ident" id="1681438">sendq</span><span class="op" id="1681443">.</span><span class="ident" id="1681444">dequeue</span><span class="op" id="1681451">(</span><span class="op" id="1681452">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1681458">if</span>&nbsp;<span class="ident" id="1681461">sg</span>&nbsp;<span class="op" id="1681464">!=</span>&nbsp;<span class="ident" id="1681467">nil</span>&nbsp;<span class="op" id="1681471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1681478">goto</span>&nbsp;<span class="ident" id="1681483">syncrecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1681496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1681501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1681506">if</span>&nbsp;<span class="ident" id="1681509">c</span><span class="op" id="1681510">.</span><span class="ident" id="1681511">closed</span>&nbsp;<span class="op" id="1681518">!=</span>&nbsp;<span class="num" id="1681521">0</span>&nbsp;<span class="op" id="1681523">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1681529">goto</span>&nbsp;<span class="ident" id="1681534">rclose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1681544">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1681549">case</span>&nbsp;<span class="ident" id="1681554">_CaseSend</span><span class="op" id="1681563">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1681568">if</span>&nbsp;<span class="ident" id="1681571">raceenabled</span>&nbsp;<span class="op" id="1681583">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681589">racereadpc</span><span class="op" id="1681599">(</span><span class="ident" id="1681600">unsafe</span><span class="op" id="1681606">.</span><span class="ident" id="1681607">Pointer</span><span class="op" id="1681614">(</span><span class="ident" id="1681615">c</span><span class="op" id="1681616">)</span><span class="op" id="1681617">,</span>&nbsp;<span class="ident" id="1681619">cas</span><span class="op" id="1681622">.</span><span class="ident" id="1681623">pc</span><span class="op" id="1681625">,</span>&nbsp;<span class="ident" id="1681627">chansendpc</span><span class="op" id="1681637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1681642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1681647">if</span>&nbsp;<span class="ident" id="1681650">c</span><span class="op" id="1681651">.</span><span class="ident" id="1681652">closed</span>&nbsp;<span class="op" id="1681659">!=</span>&nbsp;<span class="num" id="1681662">0</span>&nbsp;<span class="op" id="1681664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1681670">goto</span>&nbsp;<span class="ident" id="1681675">sclose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1681685">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1681690">if</span>&nbsp;<span class="ident" id="1681693">c</span><span class="op" id="1681694">.</span><span class="ident" id="1681695">dataqsiz</span>&nbsp;<span class="op" id="1681704">&gt;</span>&nbsp;<span class="num" id="1681706">0</span>&nbsp;<span class="op" id="1681708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1681714">if</span>&nbsp;<span class="ident" id="1681717">c</span><span class="op" id="1681718">.</span><span class="ident" id="1681719">qcount</span>&nbsp;<span class="op" id="1681726">&lt;</span>&nbsp;<span class="ident" id="1681728">c</span><span class="op" id="1681729">.</span><span class="ident" id="1681730">dataqsiz</span>&nbsp;<span class="op" id="1681739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1681746">goto</span>&nbsp;<span class="ident" id="1681751">asyncsend</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1681765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1681770">}</span>&nbsp;<span class="keyword" id="1681772">else</span>&nbsp;<span class="op" id="1681777">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681783">sg</span>&nbsp;<span class="op" id="1681786">=</span>&nbsp;<span class="ident" id="1681788">c</span><span class="op" id="1681789">.</span><span class="ident" id="1681790">recvq</span><span class="op" id="1681795">.</span><span class="ident" id="1681796">dequeue</span><span class="op" id="1681803">(</span><span class="op" id="1681804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1681810">if</span>&nbsp;<span class="ident" id="1681813">sg</span>&nbsp;<span class="op" id="1681816">!=</span>&nbsp;<span class="ident" id="1681819">nil</span>&nbsp;<span class="op" id="1681823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1681830">goto</span>&nbsp;<span class="ident" id="1681835">syncsend</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1681848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1681853">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1681858">case</span>&nbsp;<span class="ident" id="1681863">_CaseDefault</span><span class="op" id="1681875">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681880">dfl</span>&nbsp;<span class="op" id="1681884">=</span>&nbsp;<span class="ident" id="1681886">cas</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1681892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1681895">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1681899">if</span>&nbsp;<span class="ident" id="1681902">dfl</span>&nbsp;<span class="op" id="1681906">!=</span>&nbsp;<span class="ident" id="1681909">nil</span>&nbsp;<span class="op" id="1681913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681917">selunlock</span><span class="op" id="1681926">(</span><span class="ident" id="1681927">sel</span><span class="op" id="1681930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681934">cas</span>&nbsp;<span class="op" id="1681938">=</span>&nbsp;<span class="ident" id="1681940">dfl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1681946">goto</span>&nbsp;<span class="ident" id="1681951">retc</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1681957">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1681961">//&nbsp;pass&nbsp;2&nbsp;-&nbsp;enqueue&nbsp;on&nbsp;all&nbsp;chans</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681995">gp</span>&nbsp;<span class="op" id="1681998">=</span>&nbsp;<span class="ident" id="1682000">getg</span><span class="op" id="1682004">(</span><span class="op" id="1682005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682008">done</span>&nbsp;<span class="op" id="1682013">=</span>&nbsp;<span class="num" id="1682015">0</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1682018">for</span>&nbsp;<span class="ident" id="1682022">i</span>&nbsp;<span class="op" id="1682024">:=</span>&nbsp;<span class="num" id="1682027">0</span><span class="op" id="1682028">;</span>&nbsp;<span class="ident" id="1682030">i</span>&nbsp;<span class="op" id="1682032">&lt;</span>&nbsp;<span class="builtintype" id="1682034">int</span><span class="op" id="1682037">(</span><span class="ident" id="1682038">sel</span><span class="op" id="1682041">.</span><span class="ident" id="1682042">ncase</span><span class="op" id="1682047">)</span><span class="op" id="1682048">;</span>&nbsp;<span class="ident" id="1682050">i</span><span class="op" id="1682051">++</span>&nbsp;<span class="op" id="1682054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682058">cas</span>&nbsp;<span class="op" id="1682062">=</span>&nbsp;<span class="op" id="1682064">&amp;</span><span class="ident" id="1682065">scases</span><span class="op" id="1682071">[</span><span class="ident" id="1682072">pollorder</span><span class="op" id="1682081">[</span><span class="ident" id="1682082">i</span><span class="op" id="1682083">]</span><span class="op" id="1682084">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682088">c</span>&nbsp;<span class="op" id="1682090">=</span>&nbsp;<span class="ident" id="1682092">cas</span><span class="op" id="1682095">.</span><span class="ident" id="1682096">_chan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682104">sg</span>&nbsp;<span class="op" id="1682107">:=</span>&nbsp;<span class="ident" id="1682110">acquireSudog</span><span class="op" id="1682122">(</span><span class="op" id="1682123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682127">sg</span><span class="op" id="1682129">.</span><span class="ident" id="1682130">g</span>&nbsp;<span class="op" id="1682132">=</span>&nbsp;<span class="ident" id="1682134">gp</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1682139">//&nbsp;Note:&nbsp;selectdone&nbsp;is&nbsp;adjusted&nbsp;for&nbsp;stack&nbsp;copies&nbsp;in&nbsp;stack.c:adjustsudogs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682214">sg</span><span class="op" id="1682216">.</span><span class="ident" id="1682217">selectdone</span>&nbsp;<span class="op" id="1682228">=</span>&nbsp;<span class="op" id="1682230">(</span><span class="op" id="1682231">*</span><span class="builtintype" id="1682232">uint32</span><span class="op" id="1682238">)</span><span class="op" id="1682239">(</span><span class="ident" id="1682240">noescape</span><span class="op" id="1682248">(</span><span class="ident" id="1682249">unsafe</span><span class="op" id="1682255">.</span><span class="ident" id="1682256">Pointer</span><span class="op" id="1682263">(</span><span class="op" id="1682264">&amp;</span><span class="ident" id="1682265">done</span><span class="op" id="1682269">)</span><span class="op" id="1682270">)</span><span class="op" id="1682271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682275">sg</span><span class="op" id="1682277">.</span><span class="ident" id="1682278">elem</span>&nbsp;<span class="op" id="1682283">=</span>&nbsp;<span class="ident" id="1682285">cas</span><span class="op" id="1682288">.</span><span class="ident" id="1682289">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682296">sg</span><span class="op" id="1682298">.</span><span class="ident" id="1682299">releasetime</span>&nbsp;<span class="op" id="1682311">=</span>&nbsp;<span class="num" id="1682313">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1682317">if</span>&nbsp;<span class="ident" id="1682320">t0</span>&nbsp;<span class="op" id="1682323">!=</span>&nbsp;<span class="num" id="1682326">0</span>&nbsp;<span class="op" id="1682328">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682333">sg</span><span class="op" id="1682335">.</span><span class="ident" id="1682336">releasetime</span>&nbsp;<span class="op" id="1682348">=</span>&nbsp;<span class="op" id="1682350">-</span><span class="num" id="1682351">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1682355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682359">sg</span><span class="op" id="1682361">.</span><span class="ident" id="1682362">waitlink</span>&nbsp;<span class="op" id="1682371">=</span>&nbsp;<span class="ident" id="1682373">gp</span><span class="op" id="1682375">.</span><span class="ident" id="1682376">waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682386">gp</span><span class="op" id="1682388">.</span><span class="ident" id="1682389">waiting</span>&nbsp;<span class="op" id="1682397">=</span>&nbsp;<span class="ident" id="1682399">sg</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1682405">switch</span>&nbsp;<span class="ident" id="1682412">cas</span><span class="op" id="1682415">.</span><span class="ident" id="1682416">kind</span>&nbsp;<span class="op" id="1682421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1682425">case</span>&nbsp;<span class="ident" id="1682430">_CaseRecv</span><span class="op" id="1682439">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682444">c</span><span class="op" id="1682445">.</span><span class="ident" id="1682446">recvq</span><span class="op" id="1682451">.</span><span class="ident" id="1682452">enqueue</span><span class="op" id="1682459">(</span><span class="ident" id="1682460">sg</span><span class="op" id="1682462">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1682467">case</span>&nbsp;<span class="ident" id="1682472">_CaseSend</span><span class="op" id="1682481">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682486">c</span><span class="op" id="1682487">.</span><span class="ident" id="1682488">sendq</span><span class="op" id="1682493">.</span><span class="ident" id="1682494">enqueue</span><span class="op" id="1682501">(</span><span class="ident" id="1682502">sg</span><span class="op" id="1682504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1682508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1682511">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1682515">//&nbsp;wait&nbsp;for&nbsp;someone&nbsp;to&nbsp;wake&nbsp;us&nbsp;up</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682550">gp</span><span class="op" id="1682552">.</span><span class="ident" id="1682553">param</span>&nbsp;<span class="op" id="1682559">=</span>&nbsp;<span class="ident" id="1682561">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682566">gopark</span><span class="op" id="1682572">(</span><span class="ident" id="1682573">unsafe</span><span class="op" id="1682579">.</span><span class="ident" id="1682580">Pointer</span><span class="op" id="1682587">(</span><span class="ident" id="1682588">funcPC</span><span class="op" id="1682594">(</span><span class="ident" id="1682595">selparkcommit</span><span class="op" id="1682608">)</span><span class="op" id="1682609">)</span><span class="op" id="1682610">,</span>&nbsp;<span class="ident" id="1682612">unsafe</span><span class="op" id="1682618">.</span><span class="ident" id="1682619">Pointer</span><span class="op" id="1682626">(</span><span class="ident" id="1682627">sel</span><span class="op" id="1682630">)</span><span class="op" id="1682631">,</span>&nbsp;<span class="string" id="1682633">&#34;select&#34;</span><span class="op" id="1682641">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1682645">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682668">sellock</span><span class="op" id="1682675">(</span><span class="ident" id="1682676">sel</span><span class="op" id="1682679">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682682">sg</span>&nbsp;<span class="op" id="1682685">=</span>&nbsp;<span class="op" id="1682687">(</span><span class="op" id="1682688">*</span><span class="ident" id="1682689">sudog</span><span class="op" id="1682694">)</span><span class="op" id="1682695">(</span><span class="ident" id="1682696">gp</span><span class="op" id="1682698">.</span><span class="ident" id="1682699">param</span><span class="op" id="1682704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682707">gp</span><span class="op" id="1682709">.</span><span class="ident" id="1682710">param</span>&nbsp;<span class="op" id="1682716">=</span>&nbsp;<span class="ident" id="1682718">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1682724">//&nbsp;pass&nbsp;3&nbsp;-&nbsp;dequeue&nbsp;from&nbsp;unsuccessful&nbsp;chans</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1682769">//&nbsp;otherwise&nbsp;they&nbsp;stack&nbsp;up&nbsp;on&nbsp;quiet&nbsp;channels</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1682815">//&nbsp;record&nbsp;the&nbsp;successful&nbsp;case,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1682855">//&nbsp;We&nbsp;singly-linked&nbsp;up&nbsp;the&nbsp;SudoGs&nbsp;in&nbsp;case&nbsp;order,&nbsp;so&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1682913">//&nbsp;iterating&nbsp;through&nbsp;the&nbsp;linked&nbsp;list&nbsp;they&nbsp;are&nbsp;in&nbsp;reverse&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682978">cas</span>&nbsp;<span class="op" id="1682982">=</span>&nbsp;<span class="ident" id="1682984">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682989">sglist</span>&nbsp;<span class="op" id="1682996">=</span>&nbsp;<span class="ident" id="1682998">gp</span><span class="op" id="1683000">.</span><span class="ident" id="1683001">waiting</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1683010">//&nbsp;Clear&nbsp;all&nbsp;selectdone&nbsp;and&nbsp;elem&nbsp;before&nbsp;unlinking&nbsp;from&nbsp;gp.waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1683078">//&nbsp;They&nbsp;must&nbsp;be&nbsp;cleared&nbsp;before&nbsp;being&nbsp;put&nbsp;back&nbsp;into&nbsp;the&nbsp;sudog&nbsp;cache.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1683147">//&nbsp;Clear&nbsp;before&nbsp;unlinking,&nbsp;because&nbsp;if&nbsp;a&nbsp;stack&nbsp;copy&nbsp;happens&nbsp;after&nbsp;the&nbsp;unlink,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1683225">//&nbsp;they&nbsp;will&nbsp;not&nbsp;be&nbsp;updated,&nbsp;they&nbsp;will&nbsp;be&nbsp;left&nbsp;pointing&nbsp;to&nbsp;the&nbsp;old&nbsp;stack,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1683300">//&nbsp;which&nbsp;creates&nbsp;dangling&nbsp;pointers,&nbsp;which&nbsp;may&nbsp;be&nbsp;detected&nbsp;by&nbsp;the</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1683366">//&nbsp;garbage&nbsp;collector.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683389">for</span>&nbsp;<span class="ident" id="1683393">sg1</span>&nbsp;<span class="op" id="1683397">:=</span>&nbsp;<span class="ident" id="1683400">gp</span><span class="op" id="1683402">.</span><span class="ident" id="1683403">waiting</span><span class="op" id="1683410">;</span>&nbsp;<span class="ident" id="1683412">sg1</span>&nbsp;<span class="op" id="1683416">!=</span>&nbsp;<span class="ident" id="1683419">nil</span><span class="op" id="1683422">;</span>&nbsp;<span class="ident" id="1683424">sg1</span>&nbsp;<span class="op" id="1683428">=</span>&nbsp;<span class="ident" id="1683430">sg1</span><span class="op" id="1683433">.</span><span class="ident" id="1683434">waitlink</span>&nbsp;<span class="op" id="1683443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683447">sg1</span><span class="op" id="1683450">.</span><span class="ident" id="1683451">selectdone</span>&nbsp;<span class="op" id="1683462">=</span>&nbsp;<span class="ident" id="1683464">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683470">sg1</span><span class="op" id="1683473">.</span><span class="ident" id="1683474">elem</span>&nbsp;<span class="op" id="1683479">=</span>&nbsp;<span class="ident" id="1683481">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1683486">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683489">gp</span><span class="op" id="1683491">.</span><span class="ident" id="1683492">waiting</span>&nbsp;<span class="op" id="1683500">=</span>&nbsp;<span class="ident" id="1683502">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683507">for</span>&nbsp;<span class="ident" id="1683511">i</span>&nbsp;<span class="op" id="1683513">:=</span>&nbsp;<span class="builtintype" id="1683516">int</span><span class="op" id="1683519">(</span><span class="ident" id="1683520">sel</span><span class="op" id="1683523">.</span><span class="ident" id="1683524">ncase</span><span class="op" id="1683529">)</span>&nbsp;<span class="op" id="1683531">-</span>&nbsp;<span class="num" id="1683533">1</span><span class="op" id="1683534">;</span>&nbsp;<span class="ident" id="1683536">i</span>&nbsp;<span class="op" id="1683538">&gt;=</span>&nbsp;<span class="num" id="1683541">0</span><span class="op" id="1683542">;</span>&nbsp;<span class="ident" id="1683544">i</span><span class="op" id="1683545">--</span>&nbsp;<span class="op" id="1683548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683552">k</span>&nbsp;<span class="op" id="1683554">=</span>&nbsp;<span class="op" id="1683556">&amp;</span><span class="ident" id="1683557">scases</span><span class="op" id="1683563">[</span><span class="ident" id="1683564">pollorder</span><span class="op" id="1683573">[</span><span class="ident" id="1683574">i</span><span class="op" id="1683575">]</span><span class="op" id="1683576">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683580">if</span>&nbsp;<span class="ident" id="1683583">sglist</span><span class="op" id="1683589">.</span><span class="ident" id="1683590">releasetime</span>&nbsp;<span class="op" id="1683602">&gt;</span>&nbsp;<span class="num" id="1683604">0</span>&nbsp;<span class="op" id="1683606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683611">k</span><span class="op" id="1683612">.</span><span class="ident" id="1683613">releasetime</span>&nbsp;<span class="op" id="1683625">=</span>&nbsp;<span class="ident" id="1683627">sglist</span><span class="op" id="1683633">.</span><span class="ident" id="1683634">releasetime</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1683648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683652">if</span>&nbsp;<span class="ident" id="1683655">sg</span>&nbsp;<span class="op" id="1683658">==</span>&nbsp;<span class="ident" id="1683661">sglist</span>&nbsp;<span class="op" id="1683668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683673">cas</span>&nbsp;<span class="op" id="1683677">=</span>&nbsp;<span class="ident" id="1683679">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1683683">}</span>&nbsp;<span class="keyword" id="1683685">else</span>&nbsp;<span class="op" id="1683690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683695">c</span>&nbsp;<span class="op" id="1683697">=</span>&nbsp;<span class="ident" id="1683699">k</span><span class="op" id="1683700">.</span><span class="ident" id="1683701">_chan</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683710">if</span>&nbsp;<span class="ident" id="1683713">k</span><span class="op" id="1683714">.</span><span class="ident" id="1683715">kind</span>&nbsp;<span class="op" id="1683720">==</span>&nbsp;<span class="ident" id="1683723">_CaseSend</span>&nbsp;<span class="op" id="1683733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683739">c</span><span class="op" id="1683740">.</span><span class="ident" id="1683741">sendq</span><span class="op" id="1683746">.</span><span class="ident" id="1683747">dequeueSudoG</span><span class="op" id="1683759">(</span><span class="ident" id="1683760">sglist</span><span class="op" id="1683766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1683771">}</span>&nbsp;<span class="keyword" id="1683773">else</span>&nbsp;<span class="op" id="1683778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683784">c</span><span class="op" id="1683785">.</span><span class="ident" id="1683786">recvq</span><span class="op" id="1683791">.</span><span class="ident" id="1683792">dequeueSudoG</span><span class="op" id="1683804">(</span><span class="ident" id="1683805">sglist</span><span class="op" id="1683811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1683816">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1683820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683824">sgnext</span>&nbsp;<span class="op" id="1683831">=</span>&nbsp;<span class="ident" id="1683833">sglist</span><span class="op" id="1683839">.</span><span class="ident" id="1683840">waitlink</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683851">sglist</span><span class="op" id="1683857">.</span><span class="ident" id="1683858">waitlink</span>&nbsp;<span class="op" id="1683867">=</span>&nbsp;<span class="ident" id="1683869">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683875">releaseSudog</span><span class="op" id="1683887">(</span><span class="ident" id="1683888">sglist</span><span class="op" id="1683894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683898">sglist</span>&nbsp;<span class="op" id="1683905">=</span>&nbsp;<span class="ident" id="1683907">sgnext</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1683915">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683919">if</span>&nbsp;<span class="ident" id="1683922">cas</span>&nbsp;<span class="op" id="1683926">==</span>&nbsp;<span class="ident" id="1683929">nil</span>&nbsp;<span class="op" id="1683933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683937">goto</span>&nbsp;<span class="ident" id="1683942">loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1683948">}</span><br>
<span class="lineno">415</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683952">c</span>&nbsp;<span class="op" id="1683954">=</span>&nbsp;<span class="ident" id="1683956">cas</span><span class="op" id="1683959">.</span><span class="ident" id="1683960">_chan</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683968">if</span>&nbsp;<span class="ident" id="1683971">c</span><span class="op" id="1683972">.</span><span class="ident" id="1683973">dataqsiz</span>&nbsp;<span class="op" id="1683982">&gt;</span>&nbsp;<span class="num" id="1683984">0</span>&nbsp;<span class="op" id="1683986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683990">gothrow</span><span class="op" id="1683997">(</span><span class="string" id="1683998">&#34;selectgo:&nbsp;shouldn&#39;t&nbsp;happen&#34;</span><span class="op" id="1684026">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684029">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684033">if</span>&nbsp;<span class="ident" id="1684036">debugSelect</span>&nbsp;<span class="op" id="1684048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1684052">print</span><span class="op" id="1684057">(</span><span class="string" id="1684058">&#34;wait-return:&nbsp;sel=&#34;</span><span class="op" id="1684077">,</span>&nbsp;<span class="ident" id="1684079">sel</span><span class="op" id="1684082">,</span>&nbsp;<span class="string" id="1684084">&#34;&nbsp;c=&#34;</span><span class="op" id="1684089">,</span>&nbsp;<span class="ident" id="1684091">c</span><span class="op" id="1684092">,</span>&nbsp;<span class="string" id="1684094">&#34;&nbsp;cas=&#34;</span><span class="op" id="1684101">,</span>&nbsp;<span class="ident" id="1684103">cas</span><span class="op" id="1684106">,</span>&nbsp;<span class="string" id="1684108">&#34;&nbsp;kind=&#34;</span><span class="op" id="1684116">,</span>&nbsp;<span class="ident" id="1684118">cas</span><span class="op" id="1684121">.</span><span class="ident" id="1684122">kind</span><span class="op" id="1684126">,</span>&nbsp;<span class="string" id="1684128">&#34;\n&#34;</span><span class="op" id="1684132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684135">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684139">if</span>&nbsp;<span class="ident" id="1684142">cas</span><span class="op" id="1684145">.</span><span class="ident" id="1684146">kind</span>&nbsp;<span class="op" id="1684151">==</span>&nbsp;<span class="ident" id="1684154">_CaseRecv</span>&nbsp;<span class="op" id="1684164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684168">if</span>&nbsp;<span class="ident" id="1684171">cas</span><span class="op" id="1684174">.</span><span class="ident" id="1684175">receivedp</span>&nbsp;<span class="op" id="1684185">!=</span>&nbsp;<span class="ident" id="1684188">nil</span>&nbsp;<span class="op" id="1684192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684197">*</span><span class="ident" id="1684198">cas</span><span class="op" id="1684201">.</span><span class="ident" id="1684202">receivedp</span>&nbsp;<span class="op" id="1684212">=</span>&nbsp;<span class="ident" id="1684214">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684221">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684224">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684228">if</span>&nbsp;<span class="ident" id="1684231">raceenabled</span>&nbsp;<span class="op" id="1684243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684247">if</span>&nbsp;<span class="ident" id="1684250">cas</span><span class="op" id="1684253">.</span><span class="ident" id="1684254">kind</span>&nbsp;<span class="op" id="1684259">==</span>&nbsp;<span class="ident" id="1684262">_CaseRecv</span>&nbsp;<span class="op" id="1684272">&amp;&amp;</span>&nbsp;<span class="ident" id="1684275">cas</span><span class="op" id="1684278">.</span><span class="ident" id="1684279">elem</span>&nbsp;<span class="op" id="1684284">!=</span>&nbsp;<span class="ident" id="1684287">nil</span>&nbsp;<span class="op" id="1684291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684296">raceWriteObjectPC</span><span class="op" id="1684313">(</span><span class="ident" id="1684314">c</span><span class="op" id="1684315">.</span><span class="ident" id="1684316">elemtype</span><span class="op" id="1684324">,</span>&nbsp;<span class="ident" id="1684326">cas</span><span class="op" id="1684329">.</span><span class="ident" id="1684330">elem</span><span class="op" id="1684334">,</span>&nbsp;<span class="ident" id="1684336">cas</span><span class="op" id="1684339">.</span><span class="ident" id="1684340">pc</span><span class="op" id="1684342">,</span>&nbsp;<span class="ident" id="1684344">chanrecvpc</span><span class="op" id="1684354">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684358">}</span>&nbsp;<span class="keyword" id="1684360">else</span>&nbsp;<span class="keyword" id="1684365">if</span>&nbsp;<span class="ident" id="1684368">cas</span><span class="op" id="1684371">.</span><span class="ident" id="1684372">kind</span>&nbsp;<span class="op" id="1684377">==</span>&nbsp;<span class="ident" id="1684380">_CaseSend</span>&nbsp;<span class="op" id="1684390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684395">raceReadObjectPC</span><span class="op" id="1684411">(</span><span class="ident" id="1684412">c</span><span class="op" id="1684413">.</span><span class="ident" id="1684414">elemtype</span><span class="op" id="1684422">,</span>&nbsp;<span class="ident" id="1684424">cas</span><span class="op" id="1684427">.</span><span class="ident" id="1684428">elem</span><span class="op" id="1684432">,</span>&nbsp;<span class="ident" id="1684434">cas</span><span class="op" id="1684437">.</span><span class="ident" id="1684438">pc</span><span class="op" id="1684440">,</span>&nbsp;<span class="ident" id="1684442">chansendpc</span><span class="op" id="1684452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684459">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684463">selunlock</span><span class="op" id="1684472">(</span><span class="ident" id="1684473">sel</span><span class="op" id="1684476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684479">goto</span>&nbsp;<span class="ident" id="1684484">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1684490">asyncrecv</span><span class="op" id="1684499">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1684502">//&nbsp;can&nbsp;receive&nbsp;from&nbsp;buffer</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684530">if</span>&nbsp;<span class="ident" id="1684533">raceenabled</span>&nbsp;<span class="op" id="1684545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684549">if</span>&nbsp;<span class="ident" id="1684552">cas</span><span class="op" id="1684555">.</span><span class="ident" id="1684556">elem</span>&nbsp;<span class="op" id="1684561">!=</span>&nbsp;<span class="ident" id="1684564">nil</span>&nbsp;<span class="op" id="1684568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684573">raceWriteObjectPC</span><span class="op" id="1684590">(</span><span class="ident" id="1684591">c</span><span class="op" id="1684592">.</span><span class="ident" id="1684593">elemtype</span><span class="op" id="1684601">,</span>&nbsp;<span class="ident" id="1684603">cas</span><span class="op" id="1684606">.</span><span class="ident" id="1684607">elem</span><span class="op" id="1684611">,</span>&nbsp;<span class="ident" id="1684613">cas</span><span class="op" id="1684616">.</span><span class="ident" id="1684617">pc</span><span class="op" id="1684619">,</span>&nbsp;<span class="ident" id="1684621">chanrecvpc</span><span class="op" id="1684631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684639">raceacquire</span><span class="op" id="1684650">(</span><span class="ident" id="1684651">chanbuf</span><span class="op" id="1684658">(</span><span class="ident" id="1684659">c</span><span class="op" id="1684660">,</span>&nbsp;<span class="ident" id="1684662">c</span><span class="op" id="1684663">.</span><span class="ident" id="1684664">recvx</span><span class="op" id="1684669">)</span><span class="op" id="1684670">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684674">racerelease</span><span class="op" id="1684685">(</span><span class="ident" id="1684686">chanbuf</span><span class="op" id="1684693">(</span><span class="ident" id="1684694">c</span><span class="op" id="1684695">,</span>&nbsp;<span class="ident" id="1684697">c</span><span class="op" id="1684698">.</span><span class="ident" id="1684699">recvx</span><span class="op" id="1684704">)</span><span class="op" id="1684705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684711">if</span>&nbsp;<span class="ident" id="1684714">cas</span><span class="op" id="1684717">.</span><span class="ident" id="1684718">receivedp</span>&nbsp;<span class="op" id="1684728">!=</span>&nbsp;<span class="ident" id="1684731">nil</span>&nbsp;<span class="op" id="1684735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684739">*</span><span class="ident" id="1684740">cas</span><span class="op" id="1684743">.</span><span class="ident" id="1684744">receivedp</span>&nbsp;<span class="op" id="1684754">=</span>&nbsp;<span class="ident" id="1684756">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684762">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684765">if</span>&nbsp;<span class="ident" id="1684768">cas</span><span class="op" id="1684771">.</span><span class="ident" id="1684772">elem</span>&nbsp;<span class="op" id="1684777">!=</span>&nbsp;<span class="ident" id="1684780">nil</span>&nbsp;<span class="op" id="1684784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684788">memmove</span><span class="op" id="1684795">(</span><span class="ident" id="1684796">cas</span><span class="op" id="1684799">.</span><span class="ident" id="1684800">elem</span><span class="op" id="1684804">,</span>&nbsp;<span class="ident" id="1684806">chanbuf</span><span class="op" id="1684813">(</span><span class="ident" id="1684814">c</span><span class="op" id="1684815">,</span>&nbsp;<span class="ident" id="1684817">c</span><span class="op" id="1684818">.</span><span class="ident" id="1684819">recvx</span><span class="op" id="1684824">)</span><span class="op" id="1684825">,</span>&nbsp;<span class="builtintype" id="1684827">uintptr</span><span class="op" id="1684834">(</span><span class="ident" id="1684835">c</span><span class="op" id="1684836">.</span><span class="ident" id="1684837">elemsize</span><span class="op" id="1684845">)</span><span class="op" id="1684846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684852">memclr</span><span class="op" id="1684858">(</span><span class="ident" id="1684859">chanbuf</span><span class="op" id="1684866">(</span><span class="ident" id="1684867">c</span><span class="op" id="1684868">,</span>&nbsp;<span class="ident" id="1684870">c</span><span class="op" id="1684871">.</span><span class="ident" id="1684872">recvx</span><span class="op" id="1684877">)</span><span class="op" id="1684878">,</span>&nbsp;<span class="builtintype" id="1684880">uintptr</span><span class="op" id="1684887">(</span><span class="ident" id="1684888">c</span><span class="op" id="1684889">.</span><span class="ident" id="1684890">elemsize</span><span class="op" id="1684898">)</span><span class="op" id="1684899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684902">c</span><span class="op" id="1684903">.</span><span class="ident" id="1684904">recvx</span><span class="op" id="1684909">++</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684913">if</span>&nbsp;<span class="ident" id="1684916">c</span><span class="op" id="1684917">.</span><span class="ident" id="1684918">recvx</span>&nbsp;<span class="op" id="1684924">==</span>&nbsp;<span class="ident" id="1684927">c</span><span class="op" id="1684928">.</span><span class="ident" id="1684929">dataqsiz</span>&nbsp;<span class="op" id="1684938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684942">c</span><span class="op" id="1684943">.</span><span class="ident" id="1684944">recvx</span>&nbsp;<span class="op" id="1684950">=</span>&nbsp;<span class="num" id="1684952">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684958">c</span><span class="op" id="1684959">.</span><span class="ident" id="1684960">qcount</span><span class="op" id="1684966">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684970">sg</span>&nbsp;<span class="op" id="1684973">=</span>&nbsp;<span class="ident" id="1684975">c</span><span class="op" id="1684976">.</span><span class="ident" id="1684977">sendq</span><span class="op" id="1684982">.</span><span class="ident" id="1684983">dequeue</span><span class="op" id="1684990">(</span><span class="op" id="1684991">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684994">if</span>&nbsp;<span class="ident" id="1684997">sg</span>&nbsp;<span class="op" id="1685000">!=</span>&nbsp;<span class="ident" id="1685003">nil</span>&nbsp;<span class="op" id="1685007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685011">gp</span>&nbsp;<span class="op" id="1685014">=</span>&nbsp;<span class="ident" id="1685016">sg</span><span class="op" id="1685018">.</span><span class="ident" id="1685019">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685023">selunlock</span><span class="op" id="1685032">(</span><span class="ident" id="1685033">sel</span><span class="op" id="1685036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685040">if</span>&nbsp;<span class="ident" id="1685043">sg</span><span class="op" id="1685045">.</span><span class="ident" id="1685046">releasetime</span>&nbsp;<span class="op" id="1685058">!=</span>&nbsp;<span class="num" id="1685061">0</span>&nbsp;<span class="op" id="1685063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685068">sg</span><span class="op" id="1685070">.</span><span class="ident" id="1685071">releasetime</span>&nbsp;<span class="op" id="1685083">=</span>&nbsp;<span class="ident" id="1685085">cputicks</span><span class="op" id="1685093">(</span><span class="op" id="1685094">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1685098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685102">goready</span><span class="op" id="1685109">(</span><span class="ident" id="1685110">gp</span><span class="op" id="1685112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1685115">}</span>&nbsp;<span class="keyword" id="1685117">else</span>&nbsp;<span class="op" id="1685122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685126">selunlock</span><span class="op" id="1685135">(</span><span class="ident" id="1685136">sel</span><span class="op" id="1685139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1685142">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685145">goto</span>&nbsp;<span class="ident" id="1685150">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1685156">asyncsend</span><span class="op" id="1685165">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1685168">//&nbsp;can&nbsp;send&nbsp;to&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685191">if</span>&nbsp;<span class="ident" id="1685194">raceenabled</span>&nbsp;<span class="op" id="1685206">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685210">raceacquire</span><span class="op" id="1685221">(</span><span class="ident" id="1685222">chanbuf</span><span class="op" id="1685229">(</span><span class="ident" id="1685230">c</span><span class="op" id="1685231">,</span>&nbsp;<span class="ident" id="1685233">c</span><span class="op" id="1685234">.</span><span class="ident" id="1685235">sendx</span><span class="op" id="1685240">)</span><span class="op" id="1685241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685245">racerelease</span><span class="op" id="1685256">(</span><span class="ident" id="1685257">chanbuf</span><span class="op" id="1685264">(</span><span class="ident" id="1685265">c</span><span class="op" id="1685266">,</span>&nbsp;<span class="ident" id="1685268">c</span><span class="op" id="1685269">.</span><span class="ident" id="1685270">sendx</span><span class="op" id="1685275">)</span><span class="op" id="1685276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685280">raceReadObjectPC</span><span class="op" id="1685296">(</span><span class="ident" id="1685297">c</span><span class="op" id="1685298">.</span><span class="ident" id="1685299">elemtype</span><span class="op" id="1685307">,</span>&nbsp;<span class="ident" id="1685309">cas</span><span class="op" id="1685312">.</span><span class="ident" id="1685313">elem</span><span class="op" id="1685317">,</span>&nbsp;<span class="ident" id="1685319">cas</span><span class="op" id="1685322">.</span><span class="ident" id="1685323">pc</span><span class="op" id="1685325">,</span>&nbsp;<span class="ident" id="1685327">chansendpc</span><span class="op" id="1685337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1685340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685343">memmove</span><span class="op" id="1685350">(</span><span class="ident" id="1685351">chanbuf</span><span class="op" id="1685358">(</span><span class="ident" id="1685359">c</span><span class="op" id="1685360">,</span>&nbsp;<span class="ident" id="1685362">c</span><span class="op" id="1685363">.</span><span class="ident" id="1685364">sendx</span><span class="op" id="1685369">)</span><span class="op" id="1685370">,</span>&nbsp;<span class="ident" id="1685372">cas</span><span class="op" id="1685375">.</span><span class="ident" id="1685376">elem</span><span class="op" id="1685380">,</span>&nbsp;<span class="builtintype" id="1685382">uintptr</span><span class="op" id="1685389">(</span><span class="ident" id="1685390">c</span><span class="op" id="1685391">.</span><span class="ident" id="1685392">elemsize</span><span class="op" id="1685400">)</span><span class="op" id="1685401">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685404">c</span><span class="op" id="1685405">.</span><span class="ident" id="1685406">sendx</span><span class="op" id="1685411">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685415">if</span>&nbsp;<span class="ident" id="1685418">c</span><span class="op" id="1685419">.</span><span class="ident" id="1685420">sendx</span>&nbsp;<span class="op" id="1685426">==</span>&nbsp;<span class="ident" id="1685429">c</span><span class="op" id="1685430">.</span><span class="ident" id="1685431">dataqsiz</span>&nbsp;<span class="op" id="1685440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685444">c</span><span class="op" id="1685445">.</span><span class="ident" id="1685446">sendx</span>&nbsp;<span class="op" id="1685452">=</span>&nbsp;<span class="num" id="1685454">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1685457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685460">c</span><span class="op" id="1685461">.</span><span class="ident" id="1685462">qcount</span><span class="op" id="1685468">++</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685472">sg</span>&nbsp;<span class="op" id="1685475">=</span>&nbsp;<span class="ident" id="1685477">c</span><span class="op" id="1685478">.</span><span class="ident" id="1685479">recvq</span><span class="op" id="1685484">.</span><span class="ident" id="1685485">dequeue</span><span class="op" id="1685492">(</span><span class="op" id="1685493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685496">if</span>&nbsp;<span class="ident" id="1685499">sg</span>&nbsp;<span class="op" id="1685502">!=</span>&nbsp;<span class="ident" id="1685505">nil</span>&nbsp;<span class="op" id="1685509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685513">gp</span>&nbsp;<span class="op" id="1685516">=</span>&nbsp;<span class="ident" id="1685518">sg</span><span class="op" id="1685520">.</span><span class="ident" id="1685521">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685525">selunlock</span><span class="op" id="1685534">(</span><span class="ident" id="1685535">sel</span><span class="op" id="1685538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685542">if</span>&nbsp;<span class="ident" id="1685545">sg</span><span class="op" id="1685547">.</span><span class="ident" id="1685548">releasetime</span>&nbsp;<span class="op" id="1685560">!=</span>&nbsp;<span class="num" id="1685563">0</span>&nbsp;<span class="op" id="1685565">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685570">sg</span><span class="op" id="1685572">.</span><span class="ident" id="1685573">releasetime</span>&nbsp;<span class="op" id="1685585">=</span>&nbsp;<span class="ident" id="1685587">cputicks</span><span class="op" id="1685595">(</span><span class="op" id="1685596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1685600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685604">goready</span><span class="op" id="1685611">(</span><span class="ident" id="1685612">gp</span><span class="op" id="1685614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1685617">}</span>&nbsp;<span class="keyword" id="1685619">else</span>&nbsp;<span class="op" id="1685624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685628">selunlock</span><span class="op" id="1685637">(</span><span class="ident" id="1685638">sel</span><span class="op" id="1685641">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1685644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685647">goto</span>&nbsp;<span class="ident" id="1685652">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1685658">syncrecv</span><span class="op" id="1685666">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1685669">//&nbsp;can&nbsp;receive&nbsp;from&nbsp;sleeping&nbsp;sender&nbsp;(sg)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685711">if</span>&nbsp;<span class="ident" id="1685714">raceenabled</span>&nbsp;<span class="op" id="1685726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685730">if</span>&nbsp;<span class="ident" id="1685733">cas</span><span class="op" id="1685736">.</span><span class="ident" id="1685737">elem</span>&nbsp;<span class="op" id="1685742">!=</span>&nbsp;<span class="ident" id="1685745">nil</span>&nbsp;<span class="op" id="1685749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685754">raceWriteObjectPC</span><span class="op" id="1685771">(</span><span class="ident" id="1685772">c</span><span class="op" id="1685773">.</span><span class="ident" id="1685774">elemtype</span><span class="op" id="1685782">,</span>&nbsp;<span class="ident" id="1685784">cas</span><span class="op" id="1685787">.</span><span class="ident" id="1685788">elem</span><span class="op" id="1685792">,</span>&nbsp;<span class="ident" id="1685794">cas</span><span class="op" id="1685797">.</span><span class="ident" id="1685798">pc</span><span class="op" id="1685800">,</span>&nbsp;<span class="ident" id="1685802">chanrecvpc</span><span class="op" id="1685812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1685816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685820">racesync</span><span class="op" id="1685828">(</span><span class="ident" id="1685829">c</span><span class="op" id="1685830">,</span>&nbsp;<span class="ident" id="1685832">sg</span><span class="op" id="1685834">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1685837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685840">selunlock</span><span class="op" id="1685849">(</span><span class="ident" id="1685850">sel</span><span class="op" id="1685853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685856">if</span>&nbsp;<span class="ident" id="1685859">debugSelect</span>&nbsp;<span class="op" id="1685871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1685875">print</span><span class="op" id="1685880">(</span><span class="string" id="1685881">&#34;syncrecv:&nbsp;sel=&#34;</span><span class="op" id="1685897">,</span>&nbsp;<span class="ident" id="1685899">sel</span><span class="op" id="1685902">,</span>&nbsp;<span class="string" id="1685904">&#34;&nbsp;c=&#34;</span><span class="op" id="1685909">,</span>&nbsp;<span class="ident" id="1685911">c</span><span class="op" id="1685912">,</span>&nbsp;<span class="string" id="1685914">&#34;\n&#34;</span><span class="op" id="1685918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1685921">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685924">if</span>&nbsp;<span class="ident" id="1685927">cas</span><span class="op" id="1685930">.</span><span class="ident" id="1685931">receivedp</span>&nbsp;<span class="op" id="1685941">!=</span>&nbsp;<span class="ident" id="1685944">nil</span>&nbsp;<span class="op" id="1685948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1685952">*</span><span class="ident" id="1685953">cas</span><span class="op" id="1685956">.</span><span class="ident" id="1685957">receivedp</span>&nbsp;<span class="op" id="1685967">=</span>&nbsp;<span class="ident" id="1685969">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1685975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685978">if</span>&nbsp;<span class="ident" id="1685981">cas</span><span class="op" id="1685984">.</span><span class="ident" id="1685985">elem</span>&nbsp;<span class="op" id="1685990">!=</span>&nbsp;<span class="ident" id="1685993">nil</span>&nbsp;<span class="op" id="1685997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686001">memmove</span><span class="op" id="1686008">(</span><span class="ident" id="1686009">cas</span><span class="op" id="1686012">.</span><span class="ident" id="1686013">elem</span><span class="op" id="1686017">,</span>&nbsp;<span class="ident" id="1686019">sg</span><span class="op" id="1686021">.</span><span class="ident" id="1686022">elem</span><span class="op" id="1686026">,</span>&nbsp;<span class="builtintype" id="1686028">uintptr</span><span class="op" id="1686035">(</span><span class="ident" id="1686036">c</span><span class="op" id="1686037">.</span><span class="ident" id="1686038">elemsize</span><span class="op" id="1686046">)</span><span class="op" id="1686047">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686053">sg</span><span class="op" id="1686055">.</span><span class="ident" id="1686056">elem</span>&nbsp;<span class="op" id="1686061">=</span>&nbsp;<span class="ident" id="1686063">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686068">gp</span>&nbsp;<span class="op" id="1686071">=</span>&nbsp;<span class="ident" id="1686073">sg</span><span class="op" id="1686075">.</span><span class="ident" id="1686076">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686079">gp</span><span class="op" id="1686081">.</span><span class="ident" id="1686082">param</span>&nbsp;<span class="op" id="1686088">=</span>&nbsp;<span class="ident" id="1686090">unsafe</span><span class="op" id="1686096">.</span><span class="ident" id="1686097">Pointer</span><span class="op" id="1686104">(</span><span class="ident" id="1686105">sg</span><span class="op" id="1686107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686110">if</span>&nbsp;<span class="ident" id="1686113">sg</span><span class="op" id="1686115">.</span><span class="ident" id="1686116">releasetime</span>&nbsp;<span class="op" id="1686128">!=</span>&nbsp;<span class="num" id="1686131">0</span>&nbsp;<span class="op" id="1686133">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686137">sg</span><span class="op" id="1686139">.</span><span class="ident" id="1686140">releasetime</span>&nbsp;<span class="op" id="1686152">=</span>&nbsp;<span class="ident" id="1686154">cputicks</span><span class="op" id="1686162">(</span><span class="op" id="1686163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686169">goready</span><span class="op" id="1686176">(</span><span class="ident" id="1686177">gp</span><span class="op" id="1686179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686182">goto</span>&nbsp;<span class="ident" id="1686187">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno">530</span><span class="ident" id="1686193">rclose</span><span class="op" id="1686199">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1686202">//&nbsp;read&nbsp;at&nbsp;end&nbsp;of&nbsp;closed&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686236">selunlock</span><span class="op" id="1686245">(</span><span class="ident" id="1686246">sel</span><span class="op" id="1686249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686252">if</span>&nbsp;<span class="ident" id="1686255">cas</span><span class="op" id="1686258">.</span><span class="ident" id="1686259">receivedp</span>&nbsp;<span class="op" id="1686269">!=</span>&nbsp;<span class="ident" id="1686272">nil</span>&nbsp;<span class="op" id="1686276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686280">*</span><span class="ident" id="1686281">cas</span><span class="op" id="1686284">.</span><span class="ident" id="1686285">receivedp</span>&nbsp;<span class="op" id="1686295">=</span>&nbsp;<span class="ident" id="1686297">false</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686307">if</span>&nbsp;<span class="ident" id="1686310">cas</span><span class="op" id="1686313">.</span><span class="ident" id="1686314">elem</span>&nbsp;<span class="op" id="1686319">!=</span>&nbsp;<span class="ident" id="1686322">nil</span>&nbsp;<span class="op" id="1686326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686330">memclr</span><span class="op" id="1686336">(</span><span class="ident" id="1686337">cas</span><span class="op" id="1686340">.</span><span class="ident" id="1686341">elem</span><span class="op" id="1686345">,</span>&nbsp;<span class="builtintype" id="1686347">uintptr</span><span class="op" id="1686354">(</span><span class="ident" id="1686355">c</span><span class="op" id="1686356">.</span><span class="ident" id="1686357">elemsize</span><span class="op" id="1686365">)</span><span class="op" id="1686366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686372">if</span>&nbsp;<span class="ident" id="1686375">raceenabled</span>&nbsp;<span class="op" id="1686387">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686391">raceacquire</span><span class="op" id="1686402">(</span><span class="ident" id="1686403">unsafe</span><span class="op" id="1686409">.</span><span class="ident" id="1686410">Pointer</span><span class="op" id="1686417">(</span><span class="ident" id="1686418">c</span><span class="op" id="1686419">)</span><span class="op" id="1686420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686426">goto</span>&nbsp;<span class="ident" id="1686431">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1686437">syncsend</span><span class="op" id="1686445">:</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1686448">//&nbsp;can&nbsp;send&nbsp;to&nbsp;sleeping&nbsp;receiver&nbsp;(sg)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686487">if</span>&nbsp;<span class="ident" id="1686490">raceenabled</span>&nbsp;<span class="op" id="1686502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686506">raceReadObjectPC</span><span class="op" id="1686522">(</span><span class="ident" id="1686523">c</span><span class="op" id="1686524">.</span><span class="ident" id="1686525">elemtype</span><span class="op" id="1686533">,</span>&nbsp;<span class="ident" id="1686535">cas</span><span class="op" id="1686538">.</span><span class="ident" id="1686539">elem</span><span class="op" id="1686543">,</span>&nbsp;<span class="ident" id="1686545">cas</span><span class="op" id="1686548">.</span><span class="ident" id="1686549">pc</span><span class="op" id="1686551">,</span>&nbsp;<span class="ident" id="1686553">chansendpc</span><span class="op" id="1686563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686567">racesync</span><span class="op" id="1686575">(</span><span class="ident" id="1686576">c</span><span class="op" id="1686577">,</span>&nbsp;<span class="ident" id="1686579">sg</span><span class="op" id="1686581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686584">}</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686587">selunlock</span><span class="op" id="1686596">(</span><span class="ident" id="1686597">sel</span><span class="op" id="1686600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686603">if</span>&nbsp;<span class="ident" id="1686606">debugSelect</span>&nbsp;<span class="op" id="1686618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1686622">print</span><span class="op" id="1686627">(</span><span class="string" id="1686628">&#34;syncsend:&nbsp;sel=&#34;</span><span class="op" id="1686644">,</span>&nbsp;<span class="ident" id="1686646">sel</span><span class="op" id="1686649">,</span>&nbsp;<span class="string" id="1686651">&#34;&nbsp;c=&#34;</span><span class="op" id="1686656">,</span>&nbsp;<span class="ident" id="1686658">c</span><span class="op" id="1686659">,</span>&nbsp;<span class="string" id="1686661">&#34;\n&#34;</span><span class="op" id="1686665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686671">if</span>&nbsp;<span class="ident" id="1686674">sg</span><span class="op" id="1686676">.</span><span class="ident" id="1686677">elem</span>&nbsp;<span class="op" id="1686682">!=</span>&nbsp;<span class="ident" id="1686685">nil</span>&nbsp;<span class="op" id="1686689">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686693">memmove</span><span class="op" id="1686700">(</span><span class="ident" id="1686701">sg</span><span class="op" id="1686703">.</span><span class="ident" id="1686704">elem</span><span class="op" id="1686708">,</span>&nbsp;<span class="ident" id="1686710">cas</span><span class="op" id="1686713">.</span><span class="ident" id="1686714">elem</span><span class="op" id="1686718">,</span>&nbsp;<span class="builtintype" id="1686720">uintptr</span><span class="op" id="1686727">(</span><span class="ident" id="1686728">c</span><span class="op" id="1686729">.</span><span class="ident" id="1686730">elemsize</span><span class="op" id="1686738">)</span><span class="op" id="1686739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686745">sg</span><span class="op" id="1686747">.</span><span class="ident" id="1686748">elem</span>&nbsp;<span class="op" id="1686753">=</span>&nbsp;<span class="ident" id="1686755">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686760">gp</span>&nbsp;<span class="op" id="1686763">=</span>&nbsp;<span class="ident" id="1686765">sg</span><span class="op" id="1686767">.</span><span class="ident" id="1686768">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686771">gp</span><span class="op" id="1686773">.</span><span class="ident" id="1686774">param</span>&nbsp;<span class="op" id="1686780">=</span>&nbsp;<span class="ident" id="1686782">unsafe</span><span class="op" id="1686788">.</span><span class="ident" id="1686789">Pointer</span><span class="op" id="1686796">(</span><span class="ident" id="1686797">sg</span><span class="op" id="1686799">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686802">if</span>&nbsp;<span class="ident" id="1686805">sg</span><span class="op" id="1686807">.</span><span class="ident" id="1686808">releasetime</span>&nbsp;<span class="op" id="1686820">!=</span>&nbsp;<span class="num" id="1686823">0</span>&nbsp;<span class="op" id="1686825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686829">sg</span><span class="op" id="1686831">.</span><span class="ident" id="1686832">releasetime</span>&nbsp;<span class="op" id="1686844">=</span>&nbsp;<span class="ident" id="1686846">cputicks</span><span class="op" id="1686854">(</span><span class="op" id="1686855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686861">goready</span><span class="op" id="1686868">(</span><span class="ident" id="1686869">gp</span><span class="op" id="1686871">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">565</span><span class="ident" id="1686874">retc</span><span class="op" id="1686878">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686881">if</span>&nbsp;<span class="ident" id="1686884">cas</span><span class="op" id="1686887">.</span><span class="ident" id="1686888">releasetime</span>&nbsp;<span class="op" id="1686900">&gt;</span>&nbsp;<span class="num" id="1686902">0</span>&nbsp;<span class="op" id="1686904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686908">blockevent</span><span class="op" id="1686918">(</span><span class="ident" id="1686919">cas</span><span class="op" id="1686922">.</span><span class="ident" id="1686923">releasetime</span><span class="op" id="1686934">-</span><span class="ident" id="1686935">t0</span><span class="op" id="1686937">,</span>&nbsp;<span class="num" id="1686939">2</span><span class="op" id="1686940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686946">return</span>&nbsp;<span class="ident" id="1686953">cas</span><span class="op" id="1686956">.</span><span class="ident" id="1686957">pc</span><span class="op" id="1686959">,</span>&nbsp;<span class="ident" id="1686961">cas</span><span class="op" id="1686964">.</span><span class="ident" id="1686965">so</span><br>
<span class="lineno">570</span><br>
<span class="lineno"></span><span class="ident" id="1686969">sclose</span><span class="op" id="1686975">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1686978">//&nbsp;send&nbsp;on&nbsp;closed&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687005">selunlock</span><span class="op" id="1687014">(</span><span class="ident" id="1687015">sel</span><span class="op" id="1687018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1687021">panic</span><span class="op" id="1687026">(</span><span class="string" id="1687027">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1687051">)</span><br>
<span class="lineno">575</span><span class="op" id="1687053">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1687056">func</span>&nbsp;<span class="op" id="1687061">(</span><span class="ident" id="1687062">c</span>&nbsp;<span class="op" id="1687064">*</span><span class="ident" id="1687065">hchan</span><span class="op" id="1687070">)</span>&nbsp;<span class="ident" id="1687072">sortkey</span><span class="op" id="1687079">(</span><span class="op" id="1687080">)</span>&nbsp;<span class="builtintype" id="1687082">uintptr</span>&nbsp;<span class="op" id="1687090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1687093">//&nbsp;TODO(khr):&nbsp;if&nbsp;we&nbsp;have&nbsp;a&nbsp;moving&nbsp;garbage&nbsp;collector,&nbsp;we&#39;ll&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1687161">//&nbsp;change&nbsp;this&nbsp;function.</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687187">return</span>&nbsp;<span class="builtintype" id="1687194">uintptr</span><span class="op" id="1687201">(</span><span class="ident" id="1687202">unsafe</span><span class="op" id="1687208">.</span><span class="ident" id="1687209">Pointer</span><span class="op" id="1687216">(</span><span class="ident" id="1687217">c</span><span class="op" id="1687218">)</span><span class="op" id="1687219">)</span><br>
<span class="lineno"></span><span class="op" id="1687221">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1687224">//&nbsp;A&nbsp;runtimeSelect&nbsp;is&nbsp;a&nbsp;single&nbsp;case&nbsp;passed&nbsp;to&nbsp;rselect.</span><br>
<span class="lineno"></span><span class="comment" id="1687279">//&nbsp;This&nbsp;must&nbsp;match&nbsp;../reflect/value.go:/runtimeSelect</span><br>
<span class="lineno">585</span><span class="keyword" id="1687333">type</span>&nbsp;<span class="ident" id="1687338">runtimeSelect</span>&nbsp;<span class="keyword" id="1687352">struct</span>&nbsp;<span class="op" id="1687359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687362">dir</span>&nbsp;<span class="ident" id="1687366">selectDir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687377">typ</span>&nbsp;<span class="ident" id="1687381">unsafe</span><span class="op" id="1687387">.</span><span class="ident" id="1687388">Pointer</span>&nbsp;<span class="comment" id="1687396">//&nbsp;channel&nbsp;type&nbsp;(not&nbsp;used&nbsp;here)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687429">ch</span>&nbsp;&nbsp;<span class="op" id="1687433">*</span><span class="ident" id="1687434">hchan</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1687448">//&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687460">val</span>&nbsp;<span class="ident" id="1687464">unsafe</span><span class="op" id="1687470">.</span><span class="ident" id="1687471">Pointer</span>&nbsp;<span class="comment" id="1687479">//&nbsp;ptr&nbsp;to&nbsp;data&nbsp;(SendDir)&nbsp;or&nbsp;ptr&nbsp;to&nbsp;receive&nbsp;buffer&nbsp;(RecvDir)</span><br>
<span class="lineno">590</span><span class="op" id="1687539">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1687542">//&nbsp;These&nbsp;values&nbsp;must&nbsp;match&nbsp;../reflect/value.go:/SelectDir.</span><br>
<span class="lineno"></span><span class="keyword" id="1687601">type</span>&nbsp;<span class="ident" id="1687606">selectDir</span>&nbsp;<span class="builtintype" id="1687616">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">595</span><span class="keyword" id="1687621">const</span>&nbsp;<span class="op" id="1687627">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687630">_</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1687644">selectDir</span>&nbsp;<span class="op" id="1687654">=</span>&nbsp;<span class="ident" id="1687656">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687662">selectSend</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1687686">//&nbsp;case&nbsp;Chan&nbsp;&lt;-&nbsp;Send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687708">selectRecv</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1687732">//&nbsp;case&nbsp;&lt;-Chan:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687749">selectDefault</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1687773">//&nbsp;default</span><br>
<span class="lineno">600</span><span class="op" id="1687784">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1687787">func</span>&nbsp;<span class="ident" id="1687792">reflect_rselect</span><span class="op" id="1687807">(</span><span class="ident" id="1687808">cases</span>&nbsp;<span class="op" id="1687814">[</span><span class="op" id="1687815">]</span><span class="ident" id="1687816">runtimeSelect</span><span class="op" id="1687829">)</span>&nbsp;<span class="op" id="1687831">(</span><span class="ident" id="1687832">chosen</span>&nbsp;<span class="builtintype" id="1687839">int</span><span class="op" id="1687842">,</span>&nbsp;<span class="ident" id="1687844">recvOK</span>&nbsp;<span class="builtintype" id="1687851">bool</span><span class="op" id="1687855">)</span>&nbsp;<span class="op" id="1687857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1687860">//&nbsp;flagNoScan&nbsp;is&nbsp;safe&nbsp;here,&nbsp;because&nbsp;all&nbsp;objects&nbsp;are&nbsp;also&nbsp;referenced&nbsp;from&nbsp;cases.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687941">size</span>&nbsp;<span class="op" id="1687946">:=</span>&nbsp;<span class="ident" id="1687949">selectsize</span><span class="op" id="1687959">(</span><span class="builtintype" id="1687960">uintptr</span><span class="op" id="1687967">(</span><span class="builtinfunc" id="1687968">len</span><span class="op" id="1687971">(</span><span class="ident" id="1687972">cases</span><span class="op" id="1687977">)</span><span class="op" id="1687978">)</span><span class="op" id="1687979">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687982">sel</span>&nbsp;<span class="op" id="1687986">:=</span>&nbsp;<span class="op" id="1687989">(</span><span class="op" id="1687990">*</span><span class="ident" id="1687991">_select</span><span class="op" id="1687998">)</span><span class="op" id="1687999">(</span><span class="ident" id="1688000">mallocgc</span><span class="op" id="1688008">(</span><span class="ident" id="1688009">size</span><span class="op" id="1688013">,</span>&nbsp;<span class="ident" id="1688015">nil</span><span class="op" id="1688018">,</span>&nbsp;<span class="ident" id="1688020">flagNoScan</span><span class="op" id="1688030">)</span><span class="op" id="1688031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688034">newselect</span><span class="op" id="1688043">(</span><span class="ident" id="1688044">sel</span><span class="op" id="1688047">,</span>&nbsp;<span class="ident" id="1688049">int64</span><span class="op" id="1688054">(</span><span class="ident" id="1688055">size</span><span class="op" id="1688059">)</span><span class="op" id="1688060">,</span>&nbsp;<span class="builtintype" id="1688062">int32</span><span class="op" id="1688067">(</span><span class="builtinfunc" id="1688068">len</span><span class="op" id="1688071">(</span><span class="ident" id="1688072">cases</span><span class="op" id="1688077">)</span><span class="op" id="1688078">)</span><span class="op" id="1688079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688082">r</span>&nbsp;<span class="op" id="1688084">:=</span>&nbsp;<span class="builtinfunc" id="1688087">new</span><span class="op" id="1688090">(</span><span class="builtintype" id="1688091">bool</span><span class="op" id="1688095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688098">for</span>&nbsp;<span class="ident" id="1688102">i</span>&nbsp;<span class="op" id="1688104">:=</span>&nbsp;<span class="keyword" id="1688107">range</span>&nbsp;<span class="ident" id="1688113">cases</span>&nbsp;<span class="op" id="1688119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688123">rc</span>&nbsp;<span class="op" id="1688126">:=</span>&nbsp;<span class="op" id="1688129">&amp;</span><span class="ident" id="1688130">cases</span><span class="op" id="1688135">[</span><span class="ident" id="1688136">i</span><span class="op" id="1688137">]</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688141">switch</span>&nbsp;<span class="ident" id="1688148">rc</span><span class="op" id="1688150">.</span><span class="ident" id="1688151">dir</span>&nbsp;<span class="op" id="1688155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688159">case</span>&nbsp;<span class="ident" id="1688164">selectDefault</span><span class="op" id="1688177">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688182">selectdefaultImpl</span><span class="op" id="1688199">(</span><span class="ident" id="1688200">sel</span><span class="op" id="1688203">,</span>&nbsp;<span class="builtintype" id="1688205">uintptr</span><span class="op" id="1688212">(</span><span class="ident" id="1688213">i</span><span class="op" id="1688214">)</span><span class="op" id="1688215">,</span>&nbsp;<span class="num" id="1688217">0</span><span class="op" id="1688218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688222">case</span>&nbsp;<span class="ident" id="1688227">selectSend</span><span class="op" id="1688237">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688242">if</span>&nbsp;<span class="ident" id="1688245">rc</span><span class="op" id="1688247">.</span><span class="ident" id="1688248">ch</span>&nbsp;<span class="op" id="1688251">==</span>&nbsp;<span class="ident" id="1688254">nil</span>&nbsp;<span class="op" id="1688258">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688264">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688278">selectsendImpl</span><span class="op" id="1688292">(</span><span class="ident" id="1688293">sel</span><span class="op" id="1688296">,</span>&nbsp;<span class="ident" id="1688298">rc</span><span class="op" id="1688300">.</span><span class="ident" id="1688301">ch</span><span class="op" id="1688303">,</span>&nbsp;<span class="builtintype" id="1688305">uintptr</span><span class="op" id="1688312">(</span><span class="ident" id="1688313">i</span><span class="op" id="1688314">)</span><span class="op" id="1688315">,</span>&nbsp;<span class="ident" id="1688317">rc</span><span class="op" id="1688319">.</span><span class="ident" id="1688320">val</span><span class="op" id="1688323">,</span>&nbsp;<span class="num" id="1688325">0</span><span class="op" id="1688326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688330">case</span>&nbsp;<span class="ident" id="1688335">selectRecv</span><span class="op" id="1688345">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688350">if</span>&nbsp;<span class="ident" id="1688353">rc</span><span class="op" id="1688355">.</span><span class="ident" id="1688356">ch</span>&nbsp;<span class="op" id="1688359">==</span>&nbsp;<span class="ident" id="1688362">nil</span>&nbsp;<span class="op" id="1688366">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688372">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688381">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688386">selectrecvImpl</span><span class="op" id="1688400">(</span><span class="ident" id="1688401">sel</span><span class="op" id="1688404">,</span>&nbsp;<span class="ident" id="1688406">rc</span><span class="op" id="1688408">.</span><span class="ident" id="1688409">ch</span><span class="op" id="1688411">,</span>&nbsp;<span class="builtintype" id="1688413">uintptr</span><span class="op" id="1688420">(</span><span class="ident" id="1688421">i</span><span class="op" id="1688422">)</span><span class="op" id="1688423">,</span>&nbsp;<span class="ident" id="1688425">rc</span><span class="op" id="1688427">.</span><span class="ident" id="1688428">val</span><span class="op" id="1688431">,</span>&nbsp;<span class="ident" id="1688433">r</span><span class="op" id="1688434">,</span>&nbsp;<span class="num" id="1688436">0</span><span class="op" id="1688437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688444">}</span><br>
<span class="lineno">625</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688448">pc</span><span class="op" id="1688450">,</span>&nbsp;<span class="ident" id="1688452">_</span>&nbsp;<span class="op" id="1688454">:=</span>&nbsp;<span class="ident" id="1688457">selectgoImpl</span><span class="op" id="1688469">(</span><span class="ident" id="1688470">sel</span><span class="op" id="1688473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688476">chosen</span>&nbsp;<span class="op" id="1688483">=</span>&nbsp;<span class="builtintype" id="1688485">int</span><span class="op" id="1688488">(</span><span class="ident" id="1688489">pc</span><span class="op" id="1688491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688494">recvOK</span>&nbsp;<span class="op" id="1688501">=</span>&nbsp;<span class="op" id="1688503">*</span><span class="ident" id="1688504">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688507">return</span><br>
<span class="lineno">630</span><span class="op" id="1688514">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1688517">func</span>&nbsp;<span class="op" id="1688522">(</span><span class="ident" id="1688523">q</span>&nbsp;<span class="op" id="1688525">*</span><span class="ident" id="1688526">waitq</span><span class="op" id="1688531">)</span>&nbsp;<span class="ident" id="1688533">dequeueSudoG</span><span class="op" id="1688545">(</span><span class="ident" id="1688546">s</span>&nbsp;<span class="op" id="1688548">*</span><span class="ident" id="1688549">sudog</span><span class="op" id="1688554">)</span>&nbsp;<span class="op" id="1688556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688559">var</span>&nbsp;<span class="ident" id="1688563">prevsgp</span>&nbsp;<span class="op" id="1688571">*</span><span class="ident" id="1688572">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688579">l</span>&nbsp;<span class="op" id="1688581">:=</span>&nbsp;<span class="op" id="1688584">&amp;</span><span class="ident" id="1688585">q</span><span class="op" id="1688586">.</span><span class="ident" id="1688587">first</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688594">for</span>&nbsp;<span class="op" id="1688598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688602">sgp</span>&nbsp;<span class="op" id="1688606">:=</span>&nbsp;<span class="op" id="1688609">*</span><span class="ident" id="1688610">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688614">if</span>&nbsp;<span class="ident" id="1688617">sgp</span>&nbsp;<span class="op" id="1688621">==</span>&nbsp;<span class="ident" id="1688624">nil</span>&nbsp;<span class="op" id="1688628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688633">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688642">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688646">if</span>&nbsp;<span class="ident" id="1688649">sgp</span>&nbsp;<span class="op" id="1688653">==</span>&nbsp;<span class="ident" id="1688656">s</span>&nbsp;<span class="op" id="1688658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688663">*</span><span class="ident" id="1688664">l</span>&nbsp;<span class="op" id="1688666">=</span>&nbsp;<span class="ident" id="1688668">sgp</span><span class="op" id="1688671">.</span><span class="ident" id="1688672">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688680">if</span>&nbsp;<span class="ident" id="1688683">q</span><span class="op" id="1688684">.</span><span class="ident" id="1688685">last</span>&nbsp;<span class="op" id="1688690">==</span>&nbsp;<span class="ident" id="1688693">sgp</span>&nbsp;<span class="op" id="1688697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688703">q</span><span class="op" id="1688704">.</span><span class="ident" id="1688705">last</span>&nbsp;<span class="op" id="1688710">=</span>&nbsp;<span class="ident" id="1688712">prevsgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688723">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688728">s</span><span class="op" id="1688729">.</span><span class="ident" id="1688730">next</span>&nbsp;<span class="op" id="1688735">=</span>&nbsp;<span class="ident" id="1688737">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688744">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688757">l</span>&nbsp;<span class="op" id="1688759">=</span>&nbsp;<span class="op" id="1688761">&amp;</span><span class="ident" id="1688762">sgp</span><span class="op" id="1688765">.</span><span class="ident" id="1688766">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688773">prevsgp</span>&nbsp;<span class="op" id="1688781">=</span>&nbsp;<span class="ident" id="1688783">sgp</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688788">}</span><br>
<span class="lineno"></span><span class="op" id="1688790">}</span>
</div>
</body>
</html>
