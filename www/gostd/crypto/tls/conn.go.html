<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4434409">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4434464">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4434518">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4434569">//&nbsp;TLS&nbsp;low&nbsp;level&nbsp;connection&nbsp;and&nbsp;record&nbsp;layer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4434615">package</span>&nbsp;<span class="ident" id="4434623">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4434628">import</span>&nbsp;<span class="op" id="4434635">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4434638">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4434647">&#34;crypto/cipher&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4434664">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4434681">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4434696">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4434706">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4434713">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4434719">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4434726">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4434734">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="4434741">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4434744">//&nbsp;A&nbsp;Conn&nbsp;represents&nbsp;a&nbsp;secured&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4434787">//&nbsp;It&nbsp;implements&nbsp;the&nbsp;net.Conn&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="4434828">type</span>&nbsp;<span class="ident" id="4434833">Conn</span>&nbsp;<span class="keyword" id="4434838">struct</span>&nbsp;<span class="op" id="4434845">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4434848">//&nbsp;constant</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4434861">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4434870">net</span><span class="op" id="4434873">.</span><span class="ident" id="4434874">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4434880">isClient</span>&nbsp;<span class="builtintype" id="4434889">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4434896">//&nbsp;constant&nbsp;after&nbsp;handshake;&nbsp;protected&nbsp;by&nbsp;handshakeMutex</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4434954">handshakeMutex</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4434972">sync</span><span class="op" id="4434976">.</span><span class="ident" id="4434977">Mutex</span>&nbsp;<span class="comment" id="4434983">//&nbsp;handshakeMutex&nbsp;&lt;&nbsp;in.Mutex,&nbsp;out.Mutex,&nbsp;errMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4435034">handshakeErr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4435052">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4435063">//&nbsp;error&nbsp;resulting&nbsp;from&nbsp;handshake</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4435098">vers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4435116">uint16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4435127">//&nbsp;TLS&nbsp;version</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4435143">haveVers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4435161">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4435172">//&nbsp;version&nbsp;has&nbsp;been&nbsp;negotiated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4435204">config</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4435222">*</span><span class="ident" id="4435223">Config</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4435233">//&nbsp;configuration&nbsp;passed&nbsp;to&nbsp;constructor</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4435273">handshakeComplete</span>&nbsp;<span class="builtintype" id="4435291">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4435297">didResume</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4435315">bool</span>&nbsp;<span class="comment" id="4435320">//&nbsp;whether&nbsp;this&nbsp;connection&nbsp;was&nbsp;a&nbsp;session&nbsp;resumption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4435373">cipherSuite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4435391">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4435399">ocspResponse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4435417">[</span><span class="op" id="4435418">]</span><span class="builtintype" id="4435419">byte</span>&nbsp;<span class="comment" id="4435424">//&nbsp;stapled&nbsp;OCSP&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4435450">peerCertificates</span>&nbsp;&nbsp;<span class="op" id="4435468">[</span><span class="op" id="4435469">]</span><span class="op" id="4435470">*</span><span class="ident" id="4435471">x509</span><span class="op" id="4435475">.</span><span class="ident" id="4435476">Certificate</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4435489">//&nbsp;verifiedChains&nbsp;contains&nbsp;the&nbsp;certificate&nbsp;chains&nbsp;that&nbsp;we&nbsp;built,&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4435558">//&nbsp;opposed&nbsp;to&nbsp;the&nbsp;ones&nbsp;presented&nbsp;by&nbsp;the&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4435607">verifiedChains</span>&nbsp;<span class="op" id="4435622">[</span><span class="op" id="4435623">]</span><span class="op" id="4435624">[</span><span class="op" id="4435625">]</span><span class="op" id="4435626">*</span><span class="ident" id="4435627">x509</span><span class="op" id="4435631">.</span><span class="ident" id="4435632">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4435645">//&nbsp;serverName&nbsp;contains&nbsp;the&nbsp;server&nbsp;name&nbsp;indicated&nbsp;by&nbsp;the&nbsp;client,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4435718">serverName</span>&nbsp;<span class="builtintype" id="4435729">string</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4435737">//&nbsp;firstFinished&nbsp;contains&nbsp;the&nbsp;first&nbsp;Finished&nbsp;hash&nbsp;sent&nbsp;during&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4435804">//&nbsp;handshake.&nbsp;This&nbsp;is&nbsp;the&nbsp;&#34;tls-unique&#34;&nbsp;channel&nbsp;binding&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4435867">firstFinished</span>&nbsp;<span class="op" id="4435881">[</span><span class="num" id="4435882">12</span><span class="op" id="4435884">]</span><span class="builtintype" id="4435885">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4435892">clientProtocol</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4435915">string</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4435923">clientProtocolFallback</span>&nbsp;<span class="builtintype" id="4435946">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4435953">//&nbsp;input/output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4435970">in</span><span class="op" id="4435972">,</span>&nbsp;<span class="ident" id="4435974">out</span>&nbsp;&nbsp;<span class="ident" id="4435979">halfConn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4435992">//&nbsp;in.Mutex&nbsp;&lt;&nbsp;out.Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4436017">rawInput</span>&nbsp;<span class="op" id="4436026">*</span><span class="ident" id="4436027">block</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4436039">//&nbsp;raw&nbsp;input,&nbsp;right&nbsp;off&nbsp;the&nbsp;wire</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4436073">input</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4436082">*</span><span class="ident" id="4436083">block</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4436095">//&nbsp;application&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4436135">hand</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4436144">bytes</span><span class="op" id="4436149">.</span><span class="ident" id="4436150">Buffer</span>&nbsp;<span class="comment" id="4436157">//&nbsp;handshake&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;read</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4436196">tmp</span>&nbsp;<span class="op" id="4436200">[</span><span class="num" id="4436201">16</span><span class="op" id="4436203">]</span><span class="builtintype" id="4436204">byte</span><br>
<span class="lineno"></span><span class="op" id="4436209">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="4436212">//&nbsp;Access&nbsp;to&nbsp;net.Conn&nbsp;methods.</span><br>
<span class="lineno"></span><span class="comment" id="4436243">//&nbsp;Cannot&nbsp;just&nbsp;embed&nbsp;net.Conn&nbsp;because&nbsp;that&nbsp;would</span><br>
<span class="lineno"></span><span class="comment" id="4436292">//&nbsp;export&nbsp;the&nbsp;struct&nbsp;field&nbsp;too.</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="4436325">//&nbsp;LocalAddr&nbsp;returns&nbsp;the&nbsp;local&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="4436373">func</span>&nbsp;<span class="op" id="4436378">(</span><span class="ident" id="4436379">c</span>&nbsp;<span class="op" id="4436381">*</span><span class="ident" id="4436382">Conn</span><span class="op" id="4436386">)</span>&nbsp;<span class="ident" id="4436388">LocalAddr</span><span class="op" id="4436397">(</span><span class="op" id="4436398">)</span>&nbsp;<span class="ident" id="4436400">net</span><span class="op" id="4436403">.</span><span class="ident" id="4436404">Addr</span>&nbsp;<span class="op" id="4436409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4436412">return</span>&nbsp;<span class="ident" id="4436419">c</span><span class="op" id="4436420">.</span><span class="ident" id="4436421">conn</span><span class="op" id="4436425">.</span><span class="ident" id="4436426">LocalAddr</span><span class="op" id="4436435">(</span><span class="op" id="4436436">)</span><br>
<span class="lineno"></span><span class="op" id="4436438">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="comment" id="4436441">//&nbsp;RemoteAddr&nbsp;returns&nbsp;the&nbsp;remote&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="4436491">func</span>&nbsp;<span class="op" id="4436496">(</span><span class="ident" id="4436497">c</span>&nbsp;<span class="op" id="4436499">*</span><span class="ident" id="4436500">Conn</span><span class="op" id="4436504">)</span>&nbsp;<span class="ident" id="4436506">RemoteAddr</span><span class="op" id="4436516">(</span><span class="op" id="4436517">)</span>&nbsp;<span class="ident" id="4436519">net</span><span class="op" id="4436522">.</span><span class="ident" id="4436523">Addr</span>&nbsp;<span class="op" id="4436528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4436531">return</span>&nbsp;<span class="ident" id="4436538">c</span><span class="op" id="4436539">.</span><span class="ident" id="4436540">conn</span><span class="op" id="4436544">.</span><span class="ident" id="4436545">RemoteAddr</span><span class="op" id="4436555">(</span><span class="op" id="4436556">)</span><br>
<span class="lineno"></span><span class="op" id="4436558">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="4436561">//&nbsp;SetDeadline&nbsp;sets&nbsp;the&nbsp;read&nbsp;and&nbsp;write&nbsp;deadlines&nbsp;associated&nbsp;with&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4436642">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Read&nbsp;and&nbsp;Write&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno"></span><span class="comment" id="4436704">//&nbsp;After&nbsp;a&nbsp;Write&nbsp;has&nbsp;timed&nbsp;out,&nbsp;the&nbsp;TLS&nbsp;state&nbsp;is&nbsp;corrupt&nbsp;and&nbsp;all&nbsp;future&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;same&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="4436811">func</span>&nbsp;<span class="op" id="4436816">(</span><span class="ident" id="4436817">c</span>&nbsp;<span class="op" id="4436819">*</span><span class="ident" id="4436820">Conn</span><span class="op" id="4436824">)</span>&nbsp;<span class="ident" id="4436826">SetDeadline</span><span class="op" id="4436837">(</span><span class="ident" id="4436838">t</span>&nbsp;<span class="ident" id="4436840">time</span><span class="op" id="4436844">.</span><span class="ident" id="4436845">Time</span><span class="op" id="4436849">)</span>&nbsp;<span class="builtintype" id="4436851">error</span>&nbsp;<span class="op" id="4436857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4436860">return</span>&nbsp;<span class="ident" id="4436867">c</span><span class="op" id="4436868">.</span><span class="ident" id="4436869">conn</span><span class="op" id="4436873">.</span><span class="ident" id="4436874">SetDeadline</span><span class="op" id="4436885">(</span><span class="ident" id="4436886">t</span><span class="op" id="4436887">)</span><br>
<span class="lineno">80</span><span class="op" id="4436889">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4436892">//&nbsp;SetReadDeadline&nbsp;sets&nbsp;the&nbsp;read&nbsp;deadline&nbsp;on&nbsp;the&nbsp;underlying&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4436964">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Read&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="4437016">func</span>&nbsp;<span class="op" id="4437021">(</span><span class="ident" id="4437022">c</span>&nbsp;<span class="op" id="4437024">*</span><span class="ident" id="4437025">Conn</span><span class="op" id="4437029">)</span>&nbsp;<span class="ident" id="4437031">SetReadDeadline</span><span class="op" id="4437046">(</span><span class="ident" id="4437047">t</span>&nbsp;<span class="ident" id="4437049">time</span><span class="op" id="4437053">.</span><span class="ident" id="4437054">Time</span><span class="op" id="4437058">)</span>&nbsp;<span class="builtintype" id="4437060">error</span>&nbsp;<span class="op" id="4437066">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4437069">return</span>&nbsp;<span class="ident" id="4437076">c</span><span class="op" id="4437077">.</span><span class="ident" id="4437078">conn</span><span class="op" id="4437082">.</span><span class="ident" id="4437083">SetReadDeadline</span><span class="op" id="4437098">(</span><span class="ident" id="4437099">t</span><span class="op" id="4437100">)</span><br>
<span class="lineno"></span><span class="op" id="4437102">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4437105">//&nbsp;SetWriteDeadline&nbsp;sets&nbsp;the&nbsp;write&nbsp;deadline&nbsp;on&nbsp;the&nbsp;underlying&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4437179">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Write&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno">90</span><span class="comment" id="4437232">//&nbsp;After&nbsp;a&nbsp;Write&nbsp;has&nbsp;timed&nbsp;out,&nbsp;the&nbsp;TLS&nbsp;state&nbsp;is&nbsp;corrupt&nbsp;and&nbsp;all&nbsp;future&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;same&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="4437339">func</span>&nbsp;<span class="op" id="4437344">(</span><span class="ident" id="4437345">c</span>&nbsp;<span class="op" id="4437347">*</span><span class="ident" id="4437348">Conn</span><span class="op" id="4437352">)</span>&nbsp;<span class="ident" id="4437354">SetWriteDeadline</span><span class="op" id="4437370">(</span><span class="ident" id="4437371">t</span>&nbsp;<span class="ident" id="4437373">time</span><span class="op" id="4437377">.</span><span class="ident" id="4437378">Time</span><span class="op" id="4437382">)</span>&nbsp;<span class="builtintype" id="4437384">error</span>&nbsp;<span class="op" id="4437390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4437393">return</span>&nbsp;<span class="ident" id="4437400">c</span><span class="op" id="4437401">.</span><span class="ident" id="4437402">conn</span><span class="op" id="4437406">.</span><span class="ident" id="4437407">SetWriteDeadline</span><span class="op" id="4437423">(</span><span class="ident" id="4437424">t</span><span class="op" id="4437425">)</span><br>
<span class="lineno"></span><span class="op" id="4437427">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="4437430">//&nbsp;A&nbsp;halfConn&nbsp;represents&nbsp;one&nbsp;direction&nbsp;of&nbsp;the&nbsp;record&nbsp;layer</span><br>
<span class="lineno"></span><span class="comment" id="4437489">//&nbsp;connection,&nbsp;either&nbsp;sending&nbsp;or&nbsp;receiving.</span><br>
<span class="lineno"></span><span class="keyword" id="4437533">type</span>&nbsp;<span class="ident" id="4437538">halfConn</span>&nbsp;<span class="keyword" id="4437547">struct</span>&nbsp;<span class="op" id="4437554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4437557">sync</span><span class="op" id="4437561">.</span><span class="ident" id="4437562">Mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4437570">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4437578">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4437590">//&nbsp;first&nbsp;permanent&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4437616">version</span>&nbsp;<span class="builtintype" id="4437624">uint16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4437636">//&nbsp;protocol&nbsp;version</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4437657">cipher</span>&nbsp;&nbsp;<span class="keyword" id="4437665">interface</span><span class="op" id="4437674">{</span><span class="op" id="4437675">}</span>&nbsp;<span class="comment" id="4437677">//&nbsp;cipher&nbsp;algorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4437698">mac</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4437706">macFunction</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4437719">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4437727">[</span><span class="num" id="4437728">8</span><span class="op" id="4437729">]</span><span class="builtintype" id="4437730">byte</span>&nbsp;<span class="comment" id="4437735">//&nbsp;64-bit&nbsp;sequence&nbsp;number</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4437762">bfree</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4437770">*</span><span class="ident" id="4437771">block</span>&nbsp;&nbsp;<span class="comment" id="4437778">//&nbsp;list&nbsp;of&nbsp;free&nbsp;blocks</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4437803">nextCipher</span>&nbsp;<span class="keyword" id="4437814">interface</span><span class="op" id="4437823">{</span><span class="op" id="4437824">}</span>&nbsp;<span class="comment" id="4437826">//&nbsp;next&nbsp;encryption&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4437852">nextMac</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4437863">macFunction</span>&nbsp;<span class="comment" id="4437875">//&nbsp;next&nbsp;MAC&nbsp;algorithm</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4437899">//&nbsp;used&nbsp;to&nbsp;save&nbsp;allocating&nbsp;a&nbsp;new&nbsp;buffer&nbsp;for&nbsp;each&nbsp;MAC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4437954">inDigestBuf</span><span class="op" id="4437965">,</span>&nbsp;<span class="ident" id="4437967">outDigestBuf</span>&nbsp;<span class="op" id="4437980">[</span><span class="op" id="4437981">]</span><span class="builtintype" id="4437982">byte</span><br>
<span class="lineno"></span><span class="op" id="4437987">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4437990">func</span>&nbsp;<span class="op" id="4437995">(</span><span class="ident" id="4437996">hc</span>&nbsp;<span class="op" id="4437999">*</span><span class="ident" id="4438000">halfConn</span><span class="op" id="4438008">)</span>&nbsp;<span class="ident" id="4438010">setErrorLocked</span><span class="op" id="4438024">(</span><span class="ident" id="4438025">err</span>&nbsp;<span class="builtintype" id="4438029">error</span><span class="op" id="4438034">)</span>&nbsp;<span class="builtintype" id="4438036">error</span>&nbsp;<span class="op" id="4438042">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4438045">hc</span><span class="op" id="4438047">.</span><span class="ident" id="4438048">err</span>&nbsp;<span class="op" id="4438052">=</span>&nbsp;<span class="ident" id="4438054">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4438059">return</span>&nbsp;<span class="ident" id="4438066">err</span><br>
<span class="lineno"></span><span class="op" id="4438070">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4438073">func</span>&nbsp;<span class="op" id="4438078">(</span><span class="ident" id="4438079">hc</span>&nbsp;<span class="op" id="4438082">*</span><span class="ident" id="4438083">halfConn</span><span class="op" id="4438091">)</span>&nbsp;<span class="builtintype" id="4438093">error</span><span class="op" id="4438098">(</span><span class="op" id="4438099">)</span>&nbsp;<span class="builtintype" id="4438101">error</span>&nbsp;<span class="op" id="4438107">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4438110">hc</span><span class="op" id="4438112">.</span><span class="ident" id="4438113">Lock</span><span class="op" id="4438117">(</span><span class="op" id="4438118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4438121">err</span>&nbsp;<span class="op" id="4438125">:=</span>&nbsp;<span class="ident" id="4438128">hc</span><span class="op" id="4438130">.</span><span class="ident" id="4438131">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4438136">hc</span><span class="op" id="4438138">.</span><span class="ident" id="4438139">Unlock</span><span class="op" id="4438145">(</span><span class="op" id="4438146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4438149">return</span>&nbsp;<span class="ident" id="4438156">err</span><br>
<span class="lineno"></span><span class="op" id="4438160">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="comment" id="4438163">//&nbsp;prepareCipherSpec&nbsp;sets&nbsp;the&nbsp;encryption&nbsp;and&nbsp;MAC&nbsp;states</span><br>
<span class="lineno"></span><span class="comment" id="4438219">//&nbsp;that&nbsp;a&nbsp;subsequent&nbsp;changeCipherSpec&nbsp;will&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="4438267">func</span>&nbsp;<span class="op" id="4438272">(</span><span class="ident" id="4438273">hc</span>&nbsp;<span class="op" id="4438276">*</span><span class="ident" id="4438277">halfConn</span><span class="op" id="4438285">)</span>&nbsp;<span class="ident" id="4438287">prepareCipherSpec</span><span class="op" id="4438304">(</span><span class="ident" id="4438305">version</span>&nbsp;<span class="builtintype" id="4438313">uint16</span><span class="op" id="4438319">,</span>&nbsp;<span class="ident" id="4438321">cipher</span>&nbsp;<span class="keyword" id="4438328">interface</span><span class="op" id="4438337">{</span><span class="op" id="4438338">}</span><span class="op" id="4438339">,</span>&nbsp;<span class="ident" id="4438341">mac</span>&nbsp;<span class="ident" id="4438345">macFunction</span><span class="op" id="4438356">)</span>&nbsp;<span class="op" id="4438358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4438361">hc</span><span class="op" id="4438363">.</span><span class="ident" id="4438364">version</span>&nbsp;<span class="op" id="4438372">=</span>&nbsp;<span class="ident" id="4438374">version</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4438383">hc</span><span class="op" id="4438385">.</span><span class="ident" id="4438386">nextCipher</span>&nbsp;<span class="op" id="4438397">=</span>&nbsp;<span class="ident" id="4438399">cipher</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4438407">hc</span><span class="op" id="4438409">.</span><span class="ident" id="4438410">nextMac</span>&nbsp;<span class="op" id="4438418">=</span>&nbsp;<span class="ident" id="4438420">mac</span><br>
<span class="lineno"></span><span class="op" id="4438424">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4438427">//&nbsp;changeCipherSpec&nbsp;changes&nbsp;the&nbsp;encryption&nbsp;and&nbsp;MAC&nbsp;states</span><br>
<span class="lineno">135</span><span class="comment" id="4438485">//&nbsp;to&nbsp;the&nbsp;ones&nbsp;previously&nbsp;passed&nbsp;to&nbsp;prepareCipherSpec.</span><br>
<span class="lineno"></span><span class="keyword" id="4438540">func</span>&nbsp;<span class="op" id="4438545">(</span><span class="ident" id="4438546">hc</span>&nbsp;<span class="op" id="4438549">*</span><span class="ident" id="4438550">halfConn</span><span class="op" id="4438558">)</span>&nbsp;<span class="ident" id="4438560">changeCipherSpec</span><span class="op" id="4438576">(</span><span class="op" id="4438577">)</span>&nbsp;<span class="builtintype" id="4438579">error</span>&nbsp;<span class="op" id="4438585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4438588">if</span>&nbsp;<span class="ident" id="4438591">hc</span><span class="op" id="4438593">.</span><span class="ident" id="4438594">nextCipher</span>&nbsp;<span class="op" id="4438605">==</span>&nbsp;<span class="ident" id="4438608">nil</span>&nbsp;<span class="op" id="4438612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4438616">return</span>&nbsp;<span class="ident" id="4438623">alertInternalError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4438643">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4438646">hc</span><span class="op" id="4438648">.</span><span class="ident" id="4438649">cipher</span>&nbsp;<span class="op" id="4438656">=</span>&nbsp;<span class="ident" id="4438658">hc</span><span class="op" id="4438660">.</span><span class="ident" id="4438661">nextCipher</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4438673">hc</span><span class="op" id="4438675">.</span><span class="ident" id="4438676">mac</span>&nbsp;<span class="op" id="4438680">=</span>&nbsp;<span class="ident" id="4438682">hc</span><span class="op" id="4438684">.</span><span class="ident" id="4438685">nextMac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4438694">hc</span><span class="op" id="4438696">.</span><span class="ident" id="4438697">nextCipher</span>&nbsp;<span class="op" id="4438708">=</span>&nbsp;<span class="ident" id="4438710">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4438715">hc</span><span class="op" id="4438717">.</span><span class="ident" id="4438718">nextMac</span>&nbsp;<span class="op" id="4438726">=</span>&nbsp;<span class="ident" id="4438728">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4438733">for</span>&nbsp;<span class="ident" id="4438737">i</span>&nbsp;<span class="op" id="4438739">:=</span>&nbsp;<span class="keyword" id="4438742">range</span>&nbsp;<span class="ident" id="4438748">hc</span><span class="op" id="4438750">.</span><span class="ident" id="4438751">seq</span>&nbsp;<span class="op" id="4438755">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4438759">hc</span><span class="op" id="4438761">.</span><span class="ident" id="4438762">seq</span><span class="op" id="4438765">[</span><span class="ident" id="4438766">i</span><span class="op" id="4438767">]</span>&nbsp;<span class="op" id="4438769">=</span>&nbsp;<span class="num" id="4438771">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4438774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4438777">return</span>&nbsp;<span class="ident" id="4438784">nil</span><br>
<span class="lineno"></span><span class="op" id="4438788">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="4438791">//&nbsp;incSeq&nbsp;increments&nbsp;the&nbsp;sequence&nbsp;number.</span><br>
<span class="lineno"></span><span class="keyword" id="4438833">func</span>&nbsp;<span class="op" id="4438838">(</span><span class="ident" id="4438839">hc</span>&nbsp;<span class="op" id="4438842">*</span><span class="ident" id="4438843">halfConn</span><span class="op" id="4438851">)</span>&nbsp;<span class="ident" id="4438853">incSeq</span><span class="op" id="4438859">(</span><span class="op" id="4438860">)</span>&nbsp;<span class="op" id="4438862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4438865">for</span>&nbsp;<span class="ident" id="4438869">i</span>&nbsp;<span class="op" id="4438871">:=</span>&nbsp;<span class="num" id="4438874">7</span><span class="op" id="4438875">;</span>&nbsp;<span class="ident" id="4438877">i</span>&nbsp;<span class="op" id="4438879">&gt;=</span>&nbsp;<span class="num" id="4438882">0</span><span class="op" id="4438883">;</span>&nbsp;<span class="ident" id="4438885">i</span><span class="op" id="4438886">--</span>&nbsp;<span class="op" id="4438889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4438893">hc</span><span class="op" id="4438895">.</span><span class="ident" id="4438896">seq</span><span class="op" id="4438899">[</span><span class="ident" id="4438900">i</span><span class="op" id="4438901">]</span><span class="op" id="4438902">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4438907">if</span>&nbsp;<span class="ident" id="4438910">hc</span><span class="op" id="4438912">.</span><span class="ident" id="4438913">seq</span><span class="op" id="4438916">[</span><span class="ident" id="4438917">i</span><span class="op" id="4438918">]</span>&nbsp;<span class="op" id="4438920">!=</span>&nbsp;<span class="num" id="4438923">0</span>&nbsp;<span class="op" id="4438925">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4438930">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4438939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4438942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4438946">//&nbsp;Not&nbsp;allowed&nbsp;to&nbsp;let&nbsp;sequence&nbsp;number&nbsp;wrap.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4438991">//&nbsp;Instead,&nbsp;must&nbsp;renegotiate&nbsp;before&nbsp;it&nbsp;does.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4439037">//&nbsp;Not&nbsp;likely&nbsp;enough&nbsp;to&nbsp;bother.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4439070">panic</span><span class="op" id="4439075">(</span><span class="string" id="4439076">&#34;TLS:&nbsp;sequence&nbsp;number&nbsp;wraparound&#34;</span><span class="op" id="4439109">)</span><br>
<span class="lineno"></span><span class="op" id="4439111">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="4439114">//&nbsp;resetSeq&nbsp;resets&nbsp;the&nbsp;sequence&nbsp;number&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span><span class="keyword" id="4439162">func</span>&nbsp;<span class="op" id="4439167">(</span><span class="ident" id="4439168">hc</span>&nbsp;<span class="op" id="4439171">*</span><span class="ident" id="4439172">halfConn</span><span class="op" id="4439180">)</span>&nbsp;<span class="ident" id="4439182">resetSeq</span><span class="op" id="4439190">(</span><span class="op" id="4439191">)</span>&nbsp;<span class="op" id="4439193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4439196">for</span>&nbsp;<span class="ident" id="4439200">i</span>&nbsp;<span class="op" id="4439202">:=</span>&nbsp;<span class="keyword" id="4439205">range</span>&nbsp;<span class="ident" id="4439211">hc</span><span class="op" id="4439213">.</span><span class="ident" id="4439214">seq</span>&nbsp;<span class="op" id="4439218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4439222">hc</span><span class="op" id="4439224">.</span><span class="ident" id="4439225">seq</span><span class="op" id="4439228">[</span><span class="ident" id="4439229">i</span><span class="op" id="4439230">]</span>&nbsp;<span class="op" id="4439232">=</span>&nbsp;<span class="num" id="4439234">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4439237">}</span><br>
<span class="lineno">170</span><span class="op" id="4439239">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4439242">//&nbsp;removePadding&nbsp;returns&nbsp;an&nbsp;unpadded&nbsp;slice,&nbsp;in&nbsp;constant&nbsp;time,&nbsp;which&nbsp;is&nbsp;a&nbsp;prefix</span><br>
<span class="lineno"></span><span class="comment" id="4439322">//&nbsp;of&nbsp;the&nbsp;input.&nbsp;It&nbsp;also&nbsp;returns&nbsp;a&nbsp;byte&nbsp;which&nbsp;is&nbsp;equal&nbsp;to&nbsp;255&nbsp;if&nbsp;the&nbsp;padding</span><br>
<span class="lineno"></span><span class="comment" id="4439399">//&nbsp;was&nbsp;valid&nbsp;and&nbsp;0&nbsp;otherwise.&nbsp;See&nbsp;RFC&nbsp;2246,&nbsp;section&nbsp;6.2.3.2</span><br>
<span class="lineno">175</span><span class="keyword" id="4439459">func</span>&nbsp;<span class="ident" id="4439464">removePadding</span><span class="op" id="4439477">(</span><span class="ident" id="4439478">payload</span>&nbsp;<span class="op" id="4439486">[</span><span class="op" id="4439487">]</span><span class="builtintype" id="4439488">byte</span><span class="op" id="4439492">)</span>&nbsp;<span class="op" id="4439494">(</span><span class="op" id="4439495">[</span><span class="op" id="4439496">]</span><span class="builtintype" id="4439497">byte</span><span class="op" id="4439501">,</span>&nbsp;<span class="builtintype" id="4439503">byte</span><span class="op" id="4439507">)</span>&nbsp;<span class="op" id="4439509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4439512">if</span>&nbsp;<span class="builtinfunc" id="4439515">len</span><span class="op" id="4439518">(</span><span class="ident" id="4439519">payload</span><span class="op" id="4439526">)</span>&nbsp;<span class="op" id="4439528">&lt;</span>&nbsp;<span class="num" id="4439530">1</span>&nbsp;<span class="op" id="4439532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4439536">return</span>&nbsp;<span class="ident" id="4439543">payload</span><span class="op" id="4439550">,</span>&nbsp;<span class="num" id="4439552">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4439555">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4439559">paddingLen</span>&nbsp;<span class="op" id="4439570">:=</span>&nbsp;<span class="ident" id="4439573">payload</span><span class="op" id="4439580">[</span><span class="builtinfunc" id="4439581">len</span><span class="op" id="4439584">(</span><span class="ident" id="4439585">payload</span><span class="op" id="4439592">)</span><span class="op" id="4439593">-</span><span class="num" id="4439594">1</span><span class="op" id="4439595">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4439598">t</span>&nbsp;<span class="op" id="4439600">:=</span>&nbsp;<span class="builtintype" id="4439603">uint</span><span class="op" id="4439607">(</span><span class="builtinfunc" id="4439608">len</span><span class="op" id="4439611">(</span><span class="ident" id="4439612">payload</span><span class="op" id="4439619">)</span><span class="op" id="4439620">-</span><span class="num" id="4439621">1</span><span class="op" id="4439622">)</span>&nbsp;<span class="op" id="4439624">-</span>&nbsp;<span class="builtintype" id="4439626">uint</span><span class="op" id="4439630">(</span><span class="ident" id="4439631">paddingLen</span><span class="op" id="4439641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4439644">//&nbsp;if&nbsp;len(payload)&nbsp;&gt;=&nbsp;(paddingLen&nbsp;-&nbsp;1)&nbsp;then&nbsp;the&nbsp;MSB&nbsp;of&nbsp;t&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4439710">good</span>&nbsp;<span class="op" id="4439715">:=</span>&nbsp;<span class="builtintype" id="4439718">byte</span><span class="op" id="4439722">(</span><span class="builtintype" id="4439723">int32</span><span class="op" id="4439728">(</span><span class="op" id="4439729">^</span><span class="ident" id="4439730">t</span><span class="op" id="4439731">)</span>&nbsp;<span class="op" id="4439733">&gt;&gt;</span>&nbsp;<span class="num" id="4439736">31</span><span class="op" id="4439738">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4439742">toCheck</span>&nbsp;<span class="op" id="4439750">:=</span>&nbsp;<span class="num" id="4439753">255</span>&nbsp;<span class="comment" id="4439757">//&nbsp;the&nbsp;maximum&nbsp;possible&nbsp;padding&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4439797">//&nbsp;The&nbsp;length&nbsp;of&nbsp;the&nbsp;padded&nbsp;data&nbsp;is&nbsp;public,&nbsp;so&nbsp;we&nbsp;can&nbsp;use&nbsp;an&nbsp;if&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4439867">if</span>&nbsp;<span class="ident" id="4439870">toCheck</span><span class="op" id="4439877">+</span><span class="num" id="4439878">1</span>&nbsp;<span class="op" id="4439880">&gt;</span>&nbsp;<span class="builtinfunc" id="4439882">len</span><span class="op" id="4439885">(</span><span class="ident" id="4439886">payload</span><span class="op" id="4439893">)</span>&nbsp;<span class="op" id="4439895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4439899">toCheck</span>&nbsp;<span class="op" id="4439907">=</span>&nbsp;<span class="builtinfunc" id="4439909">len</span><span class="op" id="4439912">(</span><span class="ident" id="4439913">payload</span><span class="op" id="4439920">)</span>&nbsp;<span class="op" id="4439922">-</span>&nbsp;<span class="num" id="4439924">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4439927">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4439931">for</span>&nbsp;<span class="ident" id="4439935">i</span>&nbsp;<span class="op" id="4439937">:=</span>&nbsp;<span class="num" id="4439940">0</span><span class="op" id="4439941">;</span>&nbsp;<span class="ident" id="4439943">i</span>&nbsp;<span class="op" id="4439945">&lt;</span>&nbsp;<span class="ident" id="4439947">toCheck</span><span class="op" id="4439954">;</span>&nbsp;<span class="ident" id="4439956">i</span><span class="op" id="4439957">++</span>&nbsp;<span class="op" id="4439960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4439964">t</span>&nbsp;<span class="op" id="4439966">:=</span>&nbsp;<span class="builtintype" id="4439969">uint</span><span class="op" id="4439973">(</span><span class="ident" id="4439974">paddingLen</span><span class="op" id="4439984">)</span>&nbsp;<span class="op" id="4439986">-</span>&nbsp;<span class="builtintype" id="4439988">uint</span><span class="op" id="4439992">(</span><span class="ident" id="4439993">i</span><span class="op" id="4439994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4439998">//&nbsp;if&nbsp;i&nbsp;&lt;=&nbsp;paddingLen&nbsp;then&nbsp;the&nbsp;MSB&nbsp;of&nbsp;t&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4440048">mask</span>&nbsp;<span class="op" id="4440053">:=</span>&nbsp;<span class="builtintype" id="4440056">byte</span><span class="op" id="4440060">(</span><span class="builtintype" id="4440061">int32</span><span class="op" id="4440066">(</span><span class="op" id="4440067">^</span><span class="ident" id="4440068">t</span><span class="op" id="4440069">)</span>&nbsp;<span class="op" id="4440071">&gt;&gt;</span>&nbsp;<span class="num" id="4440074">31</span><span class="op" id="4440076">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4440080">b</span>&nbsp;<span class="op" id="4440082">:=</span>&nbsp;<span class="ident" id="4440085">payload</span><span class="op" id="4440092">[</span><span class="builtinfunc" id="4440093">len</span><span class="op" id="4440096">(</span><span class="ident" id="4440097">payload</span><span class="op" id="4440104">)</span><span class="op" id="4440105">-</span><span class="num" id="4440106">1</span><span class="op" id="4440107">-</span><span class="ident" id="4440108">i</span><span class="op" id="4440109">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4440113">good</span>&nbsp;<span class="op" id="4440118">&amp;^=</span>&nbsp;<span class="ident" id="4440122">mask</span><span class="op" id="4440126">&amp;</span><span class="ident" id="4440127">paddingLen</span>&nbsp;<span class="op" id="4440138">^</span>&nbsp;<span class="ident" id="4440140">mask</span><span class="op" id="4440144">&amp;</span><span class="ident" id="4440145">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4440148">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4440152">//&nbsp;We&nbsp;AND&nbsp;together&nbsp;the&nbsp;bits&nbsp;of&nbsp;good&nbsp;and&nbsp;replicate&nbsp;the&nbsp;result&nbsp;across</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4440221">//&nbsp;all&nbsp;the&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4440239">good</span>&nbsp;<span class="op" id="4440244">&amp;=</span>&nbsp;<span class="ident" id="4440247">good</span>&nbsp;<span class="op" id="4440252">&lt;&lt;</span>&nbsp;<span class="num" id="4440255">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4440258">good</span>&nbsp;<span class="op" id="4440263">&amp;=</span>&nbsp;<span class="ident" id="4440266">good</span>&nbsp;<span class="op" id="4440271">&lt;&lt;</span>&nbsp;<span class="num" id="4440274">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4440277">good</span>&nbsp;<span class="op" id="4440282">&amp;=</span>&nbsp;<span class="ident" id="4440285">good</span>&nbsp;<span class="op" id="4440290">&lt;&lt;</span>&nbsp;<span class="num" id="4440293">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4440296">good</span>&nbsp;<span class="op" id="4440301">=</span>&nbsp;<span class="builtintype" id="4440303">uint8</span><span class="op" id="4440308">(</span><span class="builtintype" id="4440309">int8</span><span class="op" id="4440313">(</span><span class="ident" id="4440314">good</span><span class="op" id="4440318">)</span>&nbsp;<span class="op" id="4440320">&gt;&gt;</span>&nbsp;<span class="num" id="4440323">7</span><span class="op" id="4440324">)</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4440328">toRemove</span>&nbsp;<span class="op" id="4440337">:=</span>&nbsp;<span class="ident" id="4440340">good</span><span class="op" id="4440344">&amp;</span><span class="ident" id="4440345">paddingLen</span>&nbsp;<span class="op" id="4440356">+</span>&nbsp;<span class="num" id="4440358">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4440361">return</span>&nbsp;<span class="ident" id="4440368">payload</span><span class="op" id="4440375">[</span><span class="op" id="4440376">:</span><span class="builtinfunc" id="4440377">len</span><span class="op" id="4440380">(</span><span class="ident" id="4440381">payload</span><span class="op" id="4440388">)</span><span class="op" id="4440389">-</span><span class="builtintype" id="4440390">int</span><span class="op" id="4440393">(</span><span class="ident" id="4440394">toRemove</span><span class="op" id="4440402">)</span><span class="op" id="4440403">]</span><span class="op" id="4440404">,</span>&nbsp;<span class="ident" id="4440406">good</span><br>
<span class="lineno"></span><span class="op" id="4440411">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="comment" id="4440414">//&nbsp;removePaddingSSL30&nbsp;is&nbsp;a&nbsp;replacement&nbsp;for&nbsp;removePadding&nbsp;in&nbsp;the&nbsp;case&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4440492">//&nbsp;protocol&nbsp;version&nbsp;is&nbsp;SSLv3.&nbsp;In&nbsp;this&nbsp;version,&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;padding</span><br>
<span class="lineno"></span><span class="comment" id="4440567">//&nbsp;are&nbsp;random&nbsp;and&nbsp;cannot&nbsp;be&nbsp;checked.</span><br>
<span class="lineno"></span><span class="keyword" id="4440604">func</span>&nbsp;<span class="ident" id="4440609">removePaddingSSL30</span><span class="op" id="4440627">(</span><span class="ident" id="4440628">payload</span>&nbsp;<span class="op" id="4440636">[</span><span class="op" id="4440637">]</span><span class="builtintype" id="4440638">byte</span><span class="op" id="4440642">)</span>&nbsp;<span class="op" id="4440644">(</span><span class="op" id="4440645">[</span><span class="op" id="4440646">]</span><span class="builtintype" id="4440647">byte</span><span class="op" id="4440651">,</span>&nbsp;<span class="builtintype" id="4440653">byte</span><span class="op" id="4440657">)</span>&nbsp;<span class="op" id="4440659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4440662">if</span>&nbsp;<span class="builtinfunc" id="4440665">len</span><span class="op" id="4440668">(</span><span class="ident" id="4440669">payload</span><span class="op" id="4440676">)</span>&nbsp;<span class="op" id="4440678">&lt;</span>&nbsp;<span class="num" id="4440680">1</span>&nbsp;<span class="op" id="4440682">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4440686">return</span>&nbsp;<span class="ident" id="4440693">payload</span><span class="op" id="4440700">,</span>&nbsp;<span class="num" id="4440702">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4440705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4440709">paddingLen</span>&nbsp;<span class="op" id="4440720">:=</span>&nbsp;<span class="builtintype" id="4440723">int</span><span class="op" id="4440726">(</span><span class="ident" id="4440727">payload</span><span class="op" id="4440734">[</span><span class="builtinfunc" id="4440735">len</span><span class="op" id="4440738">(</span><span class="ident" id="4440739">payload</span><span class="op" id="4440746">)</span><span class="op" id="4440747">-</span><span class="num" id="4440748">1</span><span class="op" id="4440749">]</span><span class="op" id="4440750">)</span>&nbsp;<span class="op" id="4440752">+</span>&nbsp;<span class="num" id="4440754">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4440757">if</span>&nbsp;<span class="ident" id="4440760">paddingLen</span>&nbsp;<span class="op" id="4440771">&gt;</span>&nbsp;<span class="builtinfunc" id="4440773">len</span><span class="op" id="4440776">(</span><span class="ident" id="4440777">payload</span><span class="op" id="4440784">)</span>&nbsp;<span class="op" id="4440786">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4440790">return</span>&nbsp;<span class="ident" id="4440797">payload</span><span class="op" id="4440804">,</span>&nbsp;<span class="num" id="4440806">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4440809">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4440813">return</span>&nbsp;<span class="ident" id="4440820">payload</span><span class="op" id="4440827">[</span><span class="op" id="4440828">:</span><span class="builtinfunc" id="4440829">len</span><span class="op" id="4440832">(</span><span class="ident" id="4440833">payload</span><span class="op" id="4440840">)</span><span class="op" id="4440841">-</span><span class="ident" id="4440842">paddingLen</span><span class="op" id="4440852">]</span><span class="op" id="4440853">,</span>&nbsp;<span class="num" id="4440855">255</span><br>
<span class="lineno"></span><span class="op" id="4440859">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="keyword" id="4440862">func</span>&nbsp;<span class="ident" id="4440867">roundUp</span><span class="op" id="4440874">(</span><span class="ident" id="4440875">a</span><span class="op" id="4440876">,</span>&nbsp;<span class="ident" id="4440878">b</span>&nbsp;<span class="builtintype" id="4440880">int</span><span class="op" id="4440883">)</span>&nbsp;<span class="builtintype" id="4440885">int</span>&nbsp;<span class="op" id="4440889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4440892">return</span>&nbsp;<span class="ident" id="4440899">a</span>&nbsp;<span class="op" id="4440901">+</span>&nbsp;<span class="op" id="4440903">(</span><span class="ident" id="4440904">b</span><span class="op" id="4440905">-</span><span class="ident" id="4440906">a</span><span class="op" id="4440907">%</span><span class="ident" id="4440908">b</span><span class="op" id="4440909">)</span><span class="op" id="4440910">%</span><span class="ident" id="4440911">b</span><br>
<span class="lineno"></span><span class="op" id="4440913">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="comment" id="4440916">//&nbsp;cbcMode&nbsp;is&nbsp;an&nbsp;interface&nbsp;for&nbsp;block&nbsp;ciphers&nbsp;using&nbsp;cipher&nbsp;block&nbsp;chaining.</span><br>
<span class="lineno"></span><span class="keyword" id="4440990">type</span>&nbsp;<span class="ident" id="4440995">cbcMode</span>&nbsp;<span class="keyword" id="4441003">interface</span>&nbsp;<span class="op" id="4441013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4441016">cipher</span><span class="op" id="4441022">.</span><span class="ident" id="4441023">BlockMode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4441034">SetIV</span><span class="op" id="4441039">(</span><span class="op" id="4441040">[</span><span class="op" id="4441041">]</span><span class="builtintype" id="4441042">byte</span><span class="op" id="4441046">)</span><br>
<span class="lineno"></span><span class="op" id="4441048">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="4441051">//&nbsp;decrypt&nbsp;checks&nbsp;and&nbsp;strips&nbsp;the&nbsp;mac&nbsp;and&nbsp;decrypts&nbsp;the&nbsp;data&nbsp;in&nbsp;b.&nbsp;Returns&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4441126">//&nbsp;success&nbsp;boolean,&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;to&nbsp;skip&nbsp;from&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;record&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="4441206">//&nbsp;order&nbsp;to&nbsp;get&nbsp;the&nbsp;application&nbsp;payload,&nbsp;and&nbsp;an&nbsp;optional&nbsp;alert&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="4441276">func</span>&nbsp;<span class="op" id="4441281">(</span><span class="ident" id="4441282">hc</span>&nbsp;<span class="op" id="4441285">*</span><span class="ident" id="4441286">halfConn</span><span class="op" id="4441294">)</span>&nbsp;<span class="ident" id="4441296">decrypt</span><span class="op" id="4441303">(</span><span class="ident" id="4441304">b</span>&nbsp;<span class="op" id="4441306">*</span><span class="ident" id="4441307">block</span><span class="op" id="4441312">)</span>&nbsp;<span class="op" id="4441314">(</span><span class="ident" id="4441315">ok</span>&nbsp;<span class="builtintype" id="4441318">bool</span><span class="op" id="4441322">,</span>&nbsp;<span class="ident" id="4441324">prefixLen</span>&nbsp;<span class="builtintype" id="4441334">int</span><span class="op" id="4441337">,</span>&nbsp;<span class="ident" id="4441339">alertValue</span>&nbsp;<span class="ident" id="4441350">alert</span><span class="op" id="4441355">)</span>&nbsp;<span class="op" id="4441357">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4441360">//&nbsp;pull&nbsp;out&nbsp;payload</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4441381">payload</span>&nbsp;<span class="op" id="4441389">:=</span>&nbsp;<span class="ident" id="4441392">b</span><span class="op" id="4441393">.</span><span class="ident" id="4441394">data</span><span class="op" id="4441398">[</span><span class="ident" id="4441399">recordHeaderLen</span><span class="op" id="4441414">:</span><span class="op" id="4441415">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4441419">macSize</span>&nbsp;<span class="op" id="4441427">:=</span>&nbsp;<span class="num" id="4441430">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4441433">if</span>&nbsp;<span class="ident" id="4441436">hc</span><span class="op" id="4441438">.</span><span class="ident" id="4441439">mac</span>&nbsp;<span class="op" id="4441443">!=</span>&nbsp;<span class="ident" id="4441446">nil</span>&nbsp;<span class="op" id="4441450">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4441454">macSize</span>&nbsp;<span class="op" id="4441462">=</span>&nbsp;<span class="ident" id="4441464">hc</span><span class="op" id="4441466">.</span><span class="ident" id="4441467">mac</span><span class="op" id="4441470">.</span><span class="ident" id="4441471">Size</span><span class="op" id="4441475">(</span><span class="op" id="4441476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4441479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4441483">paddingGood</span>&nbsp;<span class="op" id="4441495">:=</span>&nbsp;<span class="builtintype" id="4441498">byte</span><span class="op" id="4441502">(</span><span class="num" id="4441503">255</span><span class="op" id="4441506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4441509">explicitIVLen</span>&nbsp;<span class="op" id="4441523">:=</span>&nbsp;<span class="num" id="4441526">0</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4441530">//&nbsp;decrypt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4441542">if</span>&nbsp;<span class="ident" id="4441545">hc</span><span class="op" id="4441547">.</span><span class="ident" id="4441548">cipher</span>&nbsp;<span class="op" id="4441555">!=</span>&nbsp;<span class="ident" id="4441558">nil</span>&nbsp;<span class="op" id="4441562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4441566">switch</span>&nbsp;<span class="ident" id="4441573">c</span>&nbsp;<span class="op" id="4441575">:=</span>&nbsp;<span class="ident" id="4441578">hc</span><span class="op" id="4441580">.</span><span class="ident" id="4441581">cipher</span><span class="op" id="4441587">.</span><span class="op" id="4441588">(</span><span class="keyword" id="4441589">type</span><span class="op" id="4441593">)</span>&nbsp;<span class="op" id="4441595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4441599">case</span>&nbsp;<span class="ident" id="4441604">cipher</span><span class="op" id="4441610">.</span><span class="ident" id="4441611">Stream</span><span class="op" id="4441617">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4441622">c</span><span class="op" id="4441623">.</span><span class="ident" id="4441624">XORKeyStream</span><span class="op" id="4441636">(</span><span class="ident" id="4441637">payload</span><span class="op" id="4441644">,</span>&nbsp;<span class="ident" id="4441646">payload</span><span class="op" id="4441653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4441657">case</span>&nbsp;<span class="ident" id="4441662">cipher</span><span class="op" id="4441668">.</span><span class="ident" id="4441669">AEAD</span><span class="op" id="4441673">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4441678">explicitIVLen</span>&nbsp;<span class="op" id="4441692">=</span>&nbsp;<span class="num" id="4441694">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4441699">if</span>&nbsp;<span class="builtinfunc" id="4441702">len</span><span class="op" id="4441705">(</span><span class="ident" id="4441706">payload</span><span class="op" id="4441713">)</span>&nbsp;<span class="op" id="4441715">&lt;</span>&nbsp;<span class="ident" id="4441717">explicitIVLen</span>&nbsp;<span class="op" id="4441731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4441737">return</span>&nbsp;<span class="builtintype" id="4441744">false</span><span class="op" id="4441749">,</span>&nbsp;<span class="num" id="4441751">0</span><span class="op" id="4441752">,</span>&nbsp;<span class="ident" id="4441754">alertBadRecordMAC</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4441775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4441780">nonce</span>&nbsp;<span class="op" id="4441786">:=</span>&nbsp;<span class="ident" id="4441789">payload</span><span class="op" id="4441796">[</span><span class="op" id="4441797">:</span><span class="num" id="4441798">8</span><span class="op" id="4441799">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4441804">payload</span>&nbsp;<span class="op" id="4441812">=</span>&nbsp;<span class="ident" id="4441814">payload</span><span class="op" id="4441821">[</span><span class="num" id="4441822">8</span><span class="op" id="4441823">:</span><span class="op" id="4441824">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4441830">var</span>&nbsp;<span class="ident" id="4441834">additionalData</span>&nbsp;<span class="op" id="4441849">[</span><span class="num" id="4441850">13</span><span class="op" id="4441852">]</span><span class="builtintype" id="4441853">byte</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4441861">copy</span><span class="op" id="4441865">(</span><span class="ident" id="4441866">additionalData</span><span class="op" id="4441880">[</span><span class="op" id="4441881">:</span><span class="op" id="4441882">]</span><span class="op" id="4441883">,</span>&nbsp;<span class="ident" id="4441885">hc</span><span class="op" id="4441887">.</span><span class="ident" id="4441888">seq</span><span class="op" id="4441891">[</span><span class="op" id="4441892">:</span><span class="op" id="4441893">]</span><span class="op" id="4441894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4441899">copy</span><span class="op" id="4441903">(</span><span class="ident" id="4441904">additionalData</span><span class="op" id="4441918">[</span><span class="num" id="4441919">8</span><span class="op" id="4441920">:</span><span class="op" id="4441921">]</span><span class="op" id="4441922">,</span>&nbsp;<span class="ident" id="4441924">b</span><span class="op" id="4441925">.</span><span class="ident" id="4441926">data</span><span class="op" id="4441930">[</span><span class="op" id="4441931">:</span><span class="num" id="4441932">3</span><span class="op" id="4441933">]</span><span class="op" id="4441934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4441939">n</span>&nbsp;<span class="op" id="4441941">:=</span>&nbsp;<span class="builtinfunc" id="4441944">len</span><span class="op" id="4441947">(</span><span class="ident" id="4441948">payload</span><span class="op" id="4441955">)</span>&nbsp;<span class="op" id="4441957">-</span>&nbsp;<span class="ident" id="4441959">c</span><span class="op" id="4441960">.</span><span class="ident" id="4441961">Overhead</span><span class="op" id="4441969">(</span><span class="op" id="4441970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4441975">additionalData</span><span class="op" id="4441989">[</span><span class="num" id="4441990">11</span><span class="op" id="4441992">]</span>&nbsp;<span class="op" id="4441994">=</span>&nbsp;<span class="builtintype" id="4441996">byte</span><span class="op" id="4442000">(</span><span class="ident" id="4442001">n</span>&nbsp;<span class="op" id="4442003">&gt;&gt;</span>&nbsp;<span class="num" id="4442006">8</span><span class="op" id="4442007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4442012">additionalData</span><span class="op" id="4442026">[</span><span class="num" id="4442027">12</span><span class="op" id="4442029">]</span>&nbsp;<span class="op" id="4442031">=</span>&nbsp;<span class="builtintype" id="4442033">byte</span><span class="op" id="4442037">(</span><span class="ident" id="4442038">n</span><span class="op" id="4442039">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4442044">var</span>&nbsp;<span class="ident" id="4442048">err</span>&nbsp;<span class="builtintype" id="4442052">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4442061">payload</span><span class="op" id="4442068">,</span>&nbsp;<span class="ident" id="4442070">err</span>&nbsp;<span class="op" id="4442074">=</span>&nbsp;<span class="ident" id="4442076">c</span><span class="op" id="4442077">.</span><span class="ident" id="4442078">Open</span><span class="op" id="4442082">(</span><span class="ident" id="4442083">payload</span><span class="op" id="4442090">[</span><span class="op" id="4442091">:</span><span class="num" id="4442092">0</span><span class="op" id="4442093">]</span><span class="op" id="4442094">,</span>&nbsp;<span class="ident" id="4442096">nonce</span><span class="op" id="4442101">,</span>&nbsp;<span class="ident" id="4442103">payload</span><span class="op" id="4442110">,</span>&nbsp;<span class="ident" id="4442112">additionalData</span><span class="op" id="4442126">[</span><span class="op" id="4442127">:</span><span class="op" id="4442128">]</span><span class="op" id="4442129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4442134">if</span>&nbsp;<span class="ident" id="4442137">err</span>&nbsp;<span class="op" id="4442141">!=</span>&nbsp;<span class="ident" id="4442144">nil</span>&nbsp;<span class="op" id="4442148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4442154">return</span>&nbsp;<span class="builtintype" id="4442161">false</span><span class="op" id="4442166">,</span>&nbsp;<span class="num" id="4442168">0</span><span class="op" id="4442169">,</span>&nbsp;<span class="ident" id="4442171">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4442192">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4442197">b</span><span class="op" id="4442198">.</span><span class="ident" id="4442199">resize</span><span class="op" id="4442205">(</span><span class="ident" id="4442206">recordHeaderLen</span>&nbsp;<span class="op" id="4442222">+</span>&nbsp;<span class="ident" id="4442224">explicitIVLen</span>&nbsp;<span class="op" id="4442238">+</span>&nbsp;<span class="builtinfunc" id="4442240">len</span><span class="op" id="4442243">(</span><span class="ident" id="4442244">payload</span><span class="op" id="4442251">)</span><span class="op" id="4442252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4442256">case</span>&nbsp;<span class="ident" id="4442261">cbcMode</span><span class="op" id="4442268">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4442273">blockSize</span>&nbsp;<span class="op" id="4442283">:=</span>&nbsp;<span class="ident" id="4442286">c</span><span class="op" id="4442287">.</span><span class="ident" id="4442288">BlockSize</span><span class="op" id="4442297">(</span><span class="op" id="4442298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4442303">if</span>&nbsp;<span class="ident" id="4442306">hc</span><span class="op" id="4442308">.</span><span class="ident" id="4442309">version</span>&nbsp;<span class="op" id="4442317">&gt;=</span>&nbsp;<span class="ident" id="4442320">VersionTLS11</span>&nbsp;<span class="op" id="4442333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4442339">explicitIVLen</span>&nbsp;<span class="op" id="4442353">=</span>&nbsp;<span class="ident" id="4442355">blockSize</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4442368">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4442374">if</span>&nbsp;<span class="builtinfunc" id="4442377">len</span><span class="op" id="4442380">(</span><span class="ident" id="4442381">payload</span><span class="op" id="4442388">)</span><span class="op" id="4442389">%</span><span class="ident" id="4442390">blockSize</span>&nbsp;<span class="op" id="4442400">!=</span>&nbsp;<span class="num" id="4442403">0</span>&nbsp;<span class="op" id="4442405">||</span>&nbsp;<span class="builtinfunc" id="4442408">len</span><span class="op" id="4442411">(</span><span class="ident" id="4442412">payload</span><span class="op" id="4442419">)</span>&nbsp;<span class="op" id="4442421">&lt;</span>&nbsp;<span class="ident" id="4442423">roundUp</span><span class="op" id="4442430">(</span><span class="ident" id="4442431">explicitIVLen</span><span class="op" id="4442444">+</span><span class="ident" id="4442445">macSize</span><span class="op" id="4442452">+</span><span class="num" id="4442453">1</span><span class="op" id="4442454">,</span>&nbsp;<span class="ident" id="4442456">blockSize</span><span class="op" id="4442465">)</span>&nbsp;<span class="op" id="4442467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4442473">return</span>&nbsp;<span class="builtintype" id="4442480">false</span><span class="op" id="4442485">,</span>&nbsp;<span class="num" id="4442487">0</span><span class="op" id="4442488">,</span>&nbsp;<span class="ident" id="4442490">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4442511">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4442517">if</span>&nbsp;<span class="ident" id="4442520">explicitIVLen</span>&nbsp;<span class="op" id="4442534">&gt;</span>&nbsp;<span class="num" id="4442536">0</span>&nbsp;<span class="op" id="4442538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4442544">c</span><span class="op" id="4442545">.</span><span class="ident" id="4442546">SetIV</span><span class="op" id="4442551">(</span><span class="ident" id="4442552">payload</span><span class="op" id="4442559">[</span><span class="op" id="4442560">:</span><span class="ident" id="4442561">explicitIVLen</span><span class="op" id="4442574">]</span><span class="op" id="4442575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4442581">payload</span>&nbsp;<span class="op" id="4442589">=</span>&nbsp;<span class="ident" id="4442591">payload</span><span class="op" id="4442598">[</span><span class="ident" id="4442599">explicitIVLen</span><span class="op" id="4442612">:</span><span class="op" id="4442613">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4442618">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4442623">c</span><span class="op" id="4442624">.</span><span class="ident" id="4442625">CryptBlocks</span><span class="op" id="4442636">(</span><span class="ident" id="4442637">payload</span><span class="op" id="4442644">,</span>&nbsp;<span class="ident" id="4442646">payload</span><span class="op" id="4442653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4442658">if</span>&nbsp;<span class="ident" id="4442661">hc</span><span class="op" id="4442663">.</span><span class="ident" id="4442664">version</span>&nbsp;<span class="op" id="4442672">==</span>&nbsp;<span class="ident" id="4442675">VersionSSL30</span>&nbsp;<span class="op" id="4442688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4442694">payload</span><span class="op" id="4442701">,</span>&nbsp;<span class="ident" id="4442703">paddingGood</span>&nbsp;<span class="op" id="4442715">=</span>&nbsp;<span class="ident" id="4442717">removePaddingSSL30</span><span class="op" id="4442735">(</span><span class="ident" id="4442736">payload</span><span class="op" id="4442743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4442748">}</span>&nbsp;<span class="keyword" id="4442750">else</span>&nbsp;<span class="op" id="4442755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4442761">payload</span><span class="op" id="4442768">,</span>&nbsp;<span class="ident" id="4442770">paddingGood</span>&nbsp;<span class="op" id="4442782">=</span>&nbsp;<span class="ident" id="4442784">removePadding</span><span class="op" id="4442797">(</span><span class="ident" id="4442798">payload</span><span class="op" id="4442805">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4442810">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4442815">b</span><span class="op" id="4442816">.</span><span class="ident" id="4442817">resize</span><span class="op" id="4442823">(</span><span class="ident" id="4442824">recordHeaderLen</span>&nbsp;<span class="op" id="4442840">+</span>&nbsp;<span class="ident" id="4442842">explicitIVLen</span>&nbsp;<span class="op" id="4442856">+</span>&nbsp;<span class="builtinfunc" id="4442858">len</span><span class="op" id="4442861">(</span><span class="ident" id="4442862">payload</span><span class="op" id="4442869">)</span><span class="op" id="4442870">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4442876">//&nbsp;note&nbsp;that&nbsp;we&nbsp;still&nbsp;have&nbsp;a&nbsp;timing&nbsp;side-channel&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4442935">//&nbsp;MAC&nbsp;check,&nbsp;below.&nbsp;An&nbsp;attacker&nbsp;can&nbsp;align&nbsp;the&nbsp;record</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4442992">//&nbsp;so&nbsp;that&nbsp;a&nbsp;correct&nbsp;padding&nbsp;will&nbsp;cause&nbsp;one&nbsp;less&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4443049">//&nbsp;block&nbsp;to&nbsp;be&nbsp;calculated.&nbsp;Then&nbsp;they&nbsp;can&nbsp;iteratively</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4443105">//&nbsp;decrypt&nbsp;a&nbsp;record&nbsp;by&nbsp;breaking&nbsp;each&nbsp;byte.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4443155">//&nbsp;&#34;Password&nbsp;Interception&nbsp;in&nbsp;a&nbsp;SSL/TLS&nbsp;Channel&#34;,&nbsp;Brice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4443213">//&nbsp;Canvel&nbsp;et&nbsp;al.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4443233">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4443239">//&nbsp;However,&nbsp;our&nbsp;behavior&nbsp;matches&nbsp;OpenSSL,&nbsp;so&nbsp;we&nbsp;leak</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4443295">//&nbsp;only&nbsp;as&nbsp;much&nbsp;as&nbsp;they&nbsp;do.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4443325">default</span><span class="op" id="4443332">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4443337">panic</span><span class="op" id="4443342">(</span><span class="string" id="4443343">&#34;unknown&nbsp;cipher&nbsp;type&#34;</span><span class="op" id="4443364">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4443368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4443371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4443375">//&nbsp;check,&nbsp;strip&nbsp;mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4443396">if</span>&nbsp;<span class="ident" id="4443399">hc</span><span class="op" id="4443401">.</span><span class="ident" id="4443402">mac</span>&nbsp;<span class="op" id="4443406">!=</span>&nbsp;<span class="ident" id="4443409">nil</span>&nbsp;<span class="op" id="4443413">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4443417">if</span>&nbsp;<span class="builtinfunc" id="4443420">len</span><span class="op" id="4443423">(</span><span class="ident" id="4443424">payload</span><span class="op" id="4443431">)</span>&nbsp;<span class="op" id="4443433">&lt;</span>&nbsp;<span class="ident" id="4443435">macSize</span>&nbsp;<span class="op" id="4443443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4443448">return</span>&nbsp;<span class="builtintype" id="4443455">false</span><span class="op" id="4443460">,</span>&nbsp;<span class="num" id="4443462">0</span><span class="op" id="4443463">,</span>&nbsp;<span class="ident" id="4443465">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4443485">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4443490">//&nbsp;strip&nbsp;mac&nbsp;off&nbsp;payload,&nbsp;b.data</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4443525">n</span>&nbsp;<span class="op" id="4443527">:=</span>&nbsp;<span class="builtinfunc" id="4443530">len</span><span class="op" id="4443533">(</span><span class="ident" id="4443534">payload</span><span class="op" id="4443541">)</span>&nbsp;<span class="op" id="4443543">-</span>&nbsp;<span class="ident" id="4443545">macSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4443555">b</span><span class="op" id="4443556">.</span><span class="ident" id="4443557">data</span><span class="op" id="4443561">[</span><span class="num" id="4443562">3</span><span class="op" id="4443563">]</span>&nbsp;<span class="op" id="4443565">=</span>&nbsp;<span class="builtintype" id="4443567">byte</span><span class="op" id="4443571">(</span><span class="ident" id="4443572">n</span>&nbsp;<span class="op" id="4443574">&gt;&gt;</span>&nbsp;<span class="num" id="4443577">8</span><span class="op" id="4443578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4443582">b</span><span class="op" id="4443583">.</span><span class="ident" id="4443584">data</span><span class="op" id="4443588">[</span><span class="num" id="4443589">4</span><span class="op" id="4443590">]</span>&nbsp;<span class="op" id="4443592">=</span>&nbsp;<span class="builtintype" id="4443594">byte</span><span class="op" id="4443598">(</span><span class="ident" id="4443599">n</span><span class="op" id="4443600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4443604">b</span><span class="op" id="4443605">.</span><span class="ident" id="4443606">resize</span><span class="op" id="4443612">(</span><span class="ident" id="4443613">recordHeaderLen</span>&nbsp;<span class="op" id="4443629">+</span>&nbsp;<span class="ident" id="4443631">explicitIVLen</span>&nbsp;<span class="op" id="4443645">+</span>&nbsp;<span class="ident" id="4443647">n</span><span class="op" id="4443648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4443652">remoteMAC</span>&nbsp;<span class="op" id="4443662">:=</span>&nbsp;<span class="ident" id="4443665">payload</span><span class="op" id="4443672">[</span><span class="ident" id="4443673">n</span><span class="op" id="4443674">:</span><span class="op" id="4443675">]</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4443679">localMAC</span>&nbsp;<span class="op" id="4443688">:=</span>&nbsp;<span class="ident" id="4443691">hc</span><span class="op" id="4443693">.</span><span class="ident" id="4443694">mac</span><span class="op" id="4443697">.</span><span class="ident" id="4443698">MAC</span><span class="op" id="4443701">(</span><span class="ident" id="4443702">hc</span><span class="op" id="4443704">.</span><span class="ident" id="4443705">inDigestBuf</span><span class="op" id="4443716">,</span>&nbsp;<span class="ident" id="4443718">hc</span><span class="op" id="4443720">.</span><span class="ident" id="4443721">seq</span><span class="op" id="4443724">[</span><span class="num" id="4443725">0</span><span class="op" id="4443726">:</span><span class="op" id="4443727">]</span><span class="op" id="4443728">,</span>&nbsp;<span class="ident" id="4443730">b</span><span class="op" id="4443731">.</span><span class="ident" id="4443732">data</span><span class="op" id="4443736">[</span><span class="op" id="4443737">:</span><span class="ident" id="4443738">recordHeaderLen</span><span class="op" id="4443753">]</span><span class="op" id="4443754">,</span>&nbsp;<span class="ident" id="4443756">payload</span><span class="op" id="4443763">[</span><span class="op" id="4443764">:</span><span class="ident" id="4443765">n</span><span class="op" id="4443766">]</span><span class="op" id="4443767">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4443772">if</span>&nbsp;<span class="ident" id="4443775">subtle</span><span class="op" id="4443781">.</span><span class="ident" id="4443782">ConstantTimeCompare</span><span class="op" id="4443801">(</span><span class="ident" id="4443802">localMAC</span><span class="op" id="4443810">,</span>&nbsp;<span class="ident" id="4443812">remoteMAC</span><span class="op" id="4443821">)</span>&nbsp;<span class="op" id="4443823">!=</span>&nbsp;<span class="num" id="4443826">1</span>&nbsp;<span class="op" id="4443828">||</span>&nbsp;<span class="ident" id="4443831">paddingGood</span>&nbsp;<span class="op" id="4443843">!=</span>&nbsp;<span class="num" id="4443846">255</span>&nbsp;<span class="op" id="4443850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4443855">return</span>&nbsp;<span class="builtintype" id="4443862">false</span><span class="op" id="4443867">,</span>&nbsp;<span class="num" id="4443869">0</span><span class="op" id="4443870">,</span>&nbsp;<span class="ident" id="4443872">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4443892">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4443896">hc</span><span class="op" id="4443898">.</span><span class="ident" id="4443899">inDigestBuf</span>&nbsp;<span class="op" id="4443911">=</span>&nbsp;<span class="ident" id="4443913">localMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4443923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4443926">hc</span><span class="op" id="4443928">.</span><span class="ident" id="4443929">incSeq</span><span class="op" id="4443935">(</span><span class="op" id="4443936">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4443940">return</span>&nbsp;<span class="builtintype" id="4443947">true</span><span class="op" id="4443951">,</span>&nbsp;<span class="ident" id="4443953">recordHeaderLen</span>&nbsp;<span class="op" id="4443969">+</span>&nbsp;<span class="ident" id="4443971">explicitIVLen</span><span class="op" id="4443984">,</span>&nbsp;<span class="num" id="4443986">0</span><br>
<span class="lineno">335</span><span class="op" id="4443988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4443991">//&nbsp;padToBlockSize&nbsp;calculates&nbsp;the&nbsp;needed&nbsp;padding&nbsp;block,&nbsp;if&nbsp;any,&nbsp;for&nbsp;a&nbsp;payload.</span><br>
<span class="lineno"></span><span class="comment" id="4444069">//&nbsp;On&nbsp;exit,&nbsp;prefix&nbsp;aliases&nbsp;payload&nbsp;and&nbsp;extends&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;last&nbsp;full</span><br>
<span class="lineno"></span><span class="comment" id="4444144">//&nbsp;block&nbsp;of&nbsp;payload.&nbsp;finalBlock&nbsp;is&nbsp;a&nbsp;fresh&nbsp;slice&nbsp;which&nbsp;contains&nbsp;the&nbsp;contents&nbsp;of</span><br>
<span class="lineno">340</span><span class="comment" id="4444224">//&nbsp;any&nbsp;suffix&nbsp;of&nbsp;payload&nbsp;as&nbsp;well&nbsp;as&nbsp;the&nbsp;needed&nbsp;padding&nbsp;to&nbsp;make&nbsp;finalBlock&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4444300">//&nbsp;full&nbsp;block.</span><br>
<span class="lineno"></span><span class="keyword" id="4444315">func</span>&nbsp;<span class="ident" id="4444320">padToBlockSize</span><span class="op" id="4444334">(</span><span class="ident" id="4444335">payload</span>&nbsp;<span class="op" id="4444343">[</span><span class="op" id="4444344">]</span><span class="builtintype" id="4444345">byte</span><span class="op" id="4444349">,</span>&nbsp;<span class="ident" id="4444351">blockSize</span>&nbsp;<span class="builtintype" id="4444361">int</span><span class="op" id="4444364">)</span>&nbsp;<span class="op" id="4444366">(</span><span class="ident" id="4444367">prefix</span><span class="op" id="4444373">,</span>&nbsp;<span class="ident" id="4444375">finalBlock</span>&nbsp;<span class="op" id="4444386">[</span><span class="op" id="4444387">]</span><span class="builtintype" id="4444388">byte</span><span class="op" id="4444392">)</span>&nbsp;<span class="op" id="4444394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4444397">overrun</span>&nbsp;<span class="op" id="4444405">:=</span>&nbsp;<span class="builtinfunc" id="4444408">len</span><span class="op" id="4444411">(</span><span class="ident" id="4444412">payload</span><span class="op" id="4444419">)</span>&nbsp;<span class="op" id="4444421">%</span>&nbsp;<span class="ident" id="4444423">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4444434">paddingLen</span>&nbsp;<span class="op" id="4444445">:=</span>&nbsp;<span class="ident" id="4444448">blockSize</span>&nbsp;<span class="op" id="4444458">-</span>&nbsp;<span class="ident" id="4444460">overrun</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4444469">prefix</span>&nbsp;<span class="op" id="4444476">=</span>&nbsp;<span class="ident" id="4444478">payload</span><span class="op" id="4444485">[</span><span class="op" id="4444486">:</span><span class="builtinfunc" id="4444487">len</span><span class="op" id="4444490">(</span><span class="ident" id="4444491">payload</span><span class="op" id="4444498">)</span><span class="op" id="4444499">-</span><span class="ident" id="4444500">overrun</span><span class="op" id="4444507">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4444510">finalBlock</span>&nbsp;<span class="op" id="4444521">=</span>&nbsp;<span class="builtinfunc" id="4444523">make</span><span class="op" id="4444527">(</span><span class="op" id="4444528">[</span><span class="op" id="4444529">]</span><span class="builtintype" id="4444530">byte</span><span class="op" id="4444534">,</span>&nbsp;<span class="ident" id="4444536">blockSize</span><span class="op" id="4444545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4444548">copy</span><span class="op" id="4444552">(</span><span class="ident" id="4444553">finalBlock</span><span class="op" id="4444563">,</span>&nbsp;<span class="ident" id="4444565">payload</span><span class="op" id="4444572">[</span><span class="builtinfunc" id="4444573">len</span><span class="op" id="4444576">(</span><span class="ident" id="4444577">payload</span><span class="op" id="4444584">)</span><span class="op" id="4444585">-</span><span class="ident" id="4444586">overrun</span><span class="op" id="4444593">:</span><span class="op" id="4444594">]</span><span class="op" id="4444595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4444598">for</span>&nbsp;<span class="ident" id="4444602">i</span>&nbsp;<span class="op" id="4444604">:=</span>&nbsp;<span class="ident" id="4444607">overrun</span><span class="op" id="4444614">;</span>&nbsp;<span class="ident" id="4444616">i</span>&nbsp;<span class="op" id="4444618">&lt;</span>&nbsp;<span class="ident" id="4444620">blockSize</span><span class="op" id="4444629">;</span>&nbsp;<span class="ident" id="4444631">i</span><span class="op" id="4444632">++</span>&nbsp;<span class="op" id="4444635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4444639">finalBlock</span><span class="op" id="4444649">[</span><span class="ident" id="4444650">i</span><span class="op" id="4444651">]</span>&nbsp;<span class="op" id="4444653">=</span>&nbsp;<span class="builtintype" id="4444655">byte</span><span class="op" id="4444659">(</span><span class="ident" id="4444660">paddingLen</span>&nbsp;<span class="op" id="4444671">-</span>&nbsp;<span class="num" id="4444673">1</span><span class="op" id="4444674">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4444677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4444680">return</span><br>
<span class="lineno"></span><span class="op" id="4444687">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4444690">//&nbsp;encrypt&nbsp;encrypts&nbsp;and&nbsp;macs&nbsp;the&nbsp;data&nbsp;in&nbsp;b.</span><br>
<span class="lineno">355</span><span class="keyword" id="4444734">func</span>&nbsp;<span class="op" id="4444739">(</span><span class="ident" id="4444740">hc</span>&nbsp;<span class="op" id="4444743">*</span><span class="ident" id="4444744">halfConn</span><span class="op" id="4444752">)</span>&nbsp;<span class="ident" id="4444754">encrypt</span><span class="op" id="4444761">(</span><span class="ident" id="4444762">b</span>&nbsp;<span class="op" id="4444764">*</span><span class="ident" id="4444765">block</span><span class="op" id="4444770">,</span>&nbsp;<span class="ident" id="4444772">explicitIVLen</span>&nbsp;<span class="builtintype" id="4444786">int</span><span class="op" id="4444789">)</span>&nbsp;<span class="op" id="4444791">(</span><span class="builtintype" id="4444792">bool</span><span class="op" id="4444796">,</span>&nbsp;<span class="ident" id="4444798">alert</span><span class="op" id="4444803">)</span>&nbsp;<span class="op" id="4444805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4444808">//&nbsp;mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4444816">if</span>&nbsp;<span class="ident" id="4444819">hc</span><span class="op" id="4444821">.</span><span class="ident" id="4444822">mac</span>&nbsp;<span class="op" id="4444826">!=</span>&nbsp;<span class="ident" id="4444829">nil</span>&nbsp;<span class="op" id="4444833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4444837">mac</span>&nbsp;<span class="op" id="4444841">:=</span>&nbsp;<span class="ident" id="4444844">hc</span><span class="op" id="4444846">.</span><span class="ident" id="4444847">mac</span><span class="op" id="4444850">.</span><span class="ident" id="4444851">MAC</span><span class="op" id="4444854">(</span><span class="ident" id="4444855">hc</span><span class="op" id="4444857">.</span><span class="ident" id="4444858">outDigestBuf</span><span class="op" id="4444870">,</span>&nbsp;<span class="ident" id="4444872">hc</span><span class="op" id="4444874">.</span><span class="ident" id="4444875">seq</span><span class="op" id="4444878">[</span><span class="num" id="4444879">0</span><span class="op" id="4444880">:</span><span class="op" id="4444881">]</span><span class="op" id="4444882">,</span>&nbsp;<span class="ident" id="4444884">b</span><span class="op" id="4444885">.</span><span class="ident" id="4444886">data</span><span class="op" id="4444890">[</span><span class="op" id="4444891">:</span><span class="ident" id="4444892">recordHeaderLen</span><span class="op" id="4444907">]</span><span class="op" id="4444908">,</span>&nbsp;<span class="ident" id="4444910">b</span><span class="op" id="4444911">.</span><span class="ident" id="4444912">data</span><span class="op" id="4444916">[</span><span class="ident" id="4444917">recordHeaderLen</span><span class="op" id="4444932">+</span><span class="ident" id="4444933">explicitIVLen</span><span class="op" id="4444946">:</span><span class="op" id="4444947">]</span><span class="op" id="4444948">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4444953">n</span>&nbsp;<span class="op" id="4444955">:=</span>&nbsp;<span class="builtinfunc" id="4444958">len</span><span class="op" id="4444961">(</span><span class="ident" id="4444962">b</span><span class="op" id="4444963">.</span><span class="ident" id="4444964">data</span><span class="op" id="4444968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4444972">b</span><span class="op" id="4444973">.</span><span class="ident" id="4444974">resize</span><span class="op" id="4444980">(</span><span class="ident" id="4444981">n</span>&nbsp;<span class="op" id="4444983">+</span>&nbsp;<span class="builtinfunc" id="4444985">len</span><span class="op" id="4444988">(</span><span class="ident" id="4444989">mac</span><span class="op" id="4444992">)</span><span class="op" id="4444993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4444997">copy</span><span class="op" id="4445001">(</span><span class="ident" id="4445002">b</span><span class="op" id="4445003">.</span><span class="ident" id="4445004">data</span><span class="op" id="4445008">[</span><span class="ident" id="4445009">n</span><span class="op" id="4445010">:</span><span class="op" id="4445011">]</span><span class="op" id="4445012">,</span>&nbsp;<span class="ident" id="4445014">mac</span><span class="op" id="4445017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4445021">hc</span><span class="op" id="4445023">.</span><span class="ident" id="4445024">outDigestBuf</span>&nbsp;<span class="op" id="4445037">=</span>&nbsp;<span class="ident" id="4445039">mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4445044">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4445048">payload</span>&nbsp;<span class="op" id="4445056">:=</span>&nbsp;<span class="ident" id="4445059">b</span><span class="op" id="4445060">.</span><span class="ident" id="4445061">data</span><span class="op" id="4445065">[</span><span class="ident" id="4445066">recordHeaderLen</span><span class="op" id="4445081">:</span><span class="op" id="4445082">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4445086">//&nbsp;encrypt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4445098">if</span>&nbsp;<span class="ident" id="4445101">hc</span><span class="op" id="4445103">.</span><span class="ident" id="4445104">cipher</span>&nbsp;<span class="op" id="4445111">!=</span>&nbsp;<span class="ident" id="4445114">nil</span>&nbsp;<span class="op" id="4445118">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4445122">switch</span>&nbsp;<span class="ident" id="4445129">c</span>&nbsp;<span class="op" id="4445131">:=</span>&nbsp;<span class="ident" id="4445134">hc</span><span class="op" id="4445136">.</span><span class="ident" id="4445137">cipher</span><span class="op" id="4445143">.</span><span class="op" id="4445144">(</span><span class="keyword" id="4445145">type</span><span class="op" id="4445149">)</span>&nbsp;<span class="op" id="4445151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4445155">case</span>&nbsp;<span class="ident" id="4445160">cipher</span><span class="op" id="4445166">.</span><span class="ident" id="4445167">Stream</span><span class="op" id="4445173">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4445178">c</span><span class="op" id="4445179">.</span><span class="ident" id="4445180">XORKeyStream</span><span class="op" id="4445192">(</span><span class="ident" id="4445193">payload</span><span class="op" id="4445200">,</span>&nbsp;<span class="ident" id="4445202">payload</span><span class="op" id="4445209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4445213">case</span>&nbsp;<span class="ident" id="4445218">cipher</span><span class="op" id="4445224">.</span><span class="ident" id="4445225">AEAD</span><span class="op" id="4445229">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4445234">payloadLen</span>&nbsp;<span class="op" id="4445245">:=</span>&nbsp;<span class="builtinfunc" id="4445248">len</span><span class="op" id="4445251">(</span><span class="ident" id="4445252">b</span><span class="op" id="4445253">.</span><span class="ident" id="4445254">data</span><span class="op" id="4445258">)</span>&nbsp;<span class="op" id="4445260">-</span>&nbsp;<span class="ident" id="4445262">recordHeaderLen</span>&nbsp;<span class="op" id="4445278">-</span>&nbsp;<span class="ident" id="4445280">explicitIVLen</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4445297">b</span><span class="op" id="4445298">.</span><span class="ident" id="4445299">resize</span><span class="op" id="4445305">(</span><span class="builtinfunc" id="4445306">len</span><span class="op" id="4445309">(</span><span class="ident" id="4445310">b</span><span class="op" id="4445311">.</span><span class="ident" id="4445312">data</span><span class="op" id="4445316">)</span>&nbsp;<span class="op" id="4445318">+</span>&nbsp;<span class="ident" id="4445320">c</span><span class="op" id="4445321">.</span><span class="ident" id="4445322">Overhead</span><span class="op" id="4445330">(</span><span class="op" id="4445331">)</span><span class="op" id="4445332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4445337">nonce</span>&nbsp;<span class="op" id="4445343">:=</span>&nbsp;<span class="ident" id="4445346">b</span><span class="op" id="4445347">.</span><span class="ident" id="4445348">data</span><span class="op" id="4445352">[</span><span class="ident" id="4445353">recordHeaderLen</span>&nbsp;<span class="op" id="4445369">:</span>&nbsp;<span class="ident" id="4445371">recordHeaderLen</span><span class="op" id="4445386">+</span><span class="ident" id="4445387">explicitIVLen</span><span class="op" id="4445400">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4445405">payload</span>&nbsp;<span class="op" id="4445413">:=</span>&nbsp;<span class="ident" id="4445416">b</span><span class="op" id="4445417">.</span><span class="ident" id="4445418">data</span><span class="op" id="4445422">[</span><span class="ident" id="4445423">recordHeaderLen</span><span class="op" id="4445438">+</span><span class="ident" id="4445439">explicitIVLen</span><span class="op" id="4445452">:</span><span class="op" id="4445453">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4445458">payload</span>&nbsp;<span class="op" id="4445466">=</span>&nbsp;<span class="ident" id="4445468">payload</span><span class="op" id="4445475">[</span><span class="op" id="4445476">:</span><span class="ident" id="4445477">payloadLen</span><span class="op" id="4445487">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4445493">var</span>&nbsp;<span class="ident" id="4445497">additionalData</span>&nbsp;<span class="op" id="4445512">[</span><span class="num" id="4445513">13</span><span class="op" id="4445515">]</span><span class="builtintype" id="4445516">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4445524">copy</span><span class="op" id="4445528">(</span><span class="ident" id="4445529">additionalData</span><span class="op" id="4445543">[</span><span class="op" id="4445544">:</span><span class="op" id="4445545">]</span><span class="op" id="4445546">,</span>&nbsp;<span class="ident" id="4445548">hc</span><span class="op" id="4445550">.</span><span class="ident" id="4445551">seq</span><span class="op" id="4445554">[</span><span class="op" id="4445555">:</span><span class="op" id="4445556">]</span><span class="op" id="4445557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4445562">copy</span><span class="op" id="4445566">(</span><span class="ident" id="4445567">additionalData</span><span class="op" id="4445581">[</span><span class="num" id="4445582">8</span><span class="op" id="4445583">:</span><span class="op" id="4445584">]</span><span class="op" id="4445585">,</span>&nbsp;<span class="ident" id="4445587">b</span><span class="op" id="4445588">.</span><span class="ident" id="4445589">data</span><span class="op" id="4445593">[</span><span class="op" id="4445594">:</span><span class="num" id="4445595">3</span><span class="op" id="4445596">]</span><span class="op" id="4445597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4445602">additionalData</span><span class="op" id="4445616">[</span><span class="num" id="4445617">11</span><span class="op" id="4445619">]</span>&nbsp;<span class="op" id="4445621">=</span>&nbsp;<span class="builtintype" id="4445623">byte</span><span class="op" id="4445627">(</span><span class="ident" id="4445628">payloadLen</span>&nbsp;<span class="op" id="4445639">&gt;&gt;</span>&nbsp;<span class="num" id="4445642">8</span><span class="op" id="4445643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4445648">additionalData</span><span class="op" id="4445662">[</span><span class="num" id="4445663">12</span><span class="op" id="4445665">]</span>&nbsp;<span class="op" id="4445667">=</span>&nbsp;<span class="builtintype" id="4445669">byte</span><span class="op" id="4445673">(</span><span class="ident" id="4445674">payloadLen</span><span class="op" id="4445684">)</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4445690">c</span><span class="op" id="4445691">.</span><span class="ident" id="4445692">Seal</span><span class="op" id="4445696">(</span><span class="ident" id="4445697">payload</span><span class="op" id="4445704">[</span><span class="op" id="4445705">:</span><span class="num" id="4445706">0</span><span class="op" id="4445707">]</span><span class="op" id="4445708">,</span>&nbsp;<span class="ident" id="4445710">nonce</span><span class="op" id="4445715">,</span>&nbsp;<span class="ident" id="4445717">payload</span><span class="op" id="4445724">,</span>&nbsp;<span class="ident" id="4445726">additionalData</span><span class="op" id="4445740">[</span><span class="op" id="4445741">:</span><span class="op" id="4445742">]</span><span class="op" id="4445743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4445747">case</span>&nbsp;<span class="ident" id="4445752">cbcMode</span><span class="op" id="4445759">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4445764">blockSize</span>&nbsp;<span class="op" id="4445774">:=</span>&nbsp;<span class="ident" id="4445777">c</span><span class="op" id="4445778">.</span><span class="ident" id="4445779">BlockSize</span><span class="op" id="4445788">(</span><span class="op" id="4445789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4445794">if</span>&nbsp;<span class="ident" id="4445797">explicitIVLen</span>&nbsp;<span class="op" id="4445811">&gt;</span>&nbsp;<span class="num" id="4445813">0</span>&nbsp;<span class="op" id="4445815">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4445821">c</span><span class="op" id="4445822">.</span><span class="ident" id="4445823">SetIV</span><span class="op" id="4445828">(</span><span class="ident" id="4445829">payload</span><span class="op" id="4445836">[</span><span class="op" id="4445837">:</span><span class="ident" id="4445838">explicitIVLen</span><span class="op" id="4445851">]</span><span class="op" id="4445852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4445858">payload</span>&nbsp;<span class="op" id="4445866">=</span>&nbsp;<span class="ident" id="4445868">payload</span><span class="op" id="4445875">[</span><span class="ident" id="4445876">explicitIVLen</span><span class="op" id="4445889">:</span><span class="op" id="4445890">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4445895">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4445900">prefix</span><span class="op" id="4445906">,</span>&nbsp;<span class="ident" id="4445908">finalBlock</span>&nbsp;<span class="op" id="4445919">:=</span>&nbsp;<span class="ident" id="4445922">padToBlockSize</span><span class="op" id="4445936">(</span><span class="ident" id="4445937">payload</span><span class="op" id="4445944">,</span>&nbsp;<span class="ident" id="4445946">blockSize</span><span class="op" id="4445955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4445960">b</span><span class="op" id="4445961">.</span><span class="ident" id="4445962">resize</span><span class="op" id="4445968">(</span><span class="ident" id="4445969">recordHeaderLen</span>&nbsp;<span class="op" id="4445985">+</span>&nbsp;<span class="ident" id="4445987">explicitIVLen</span>&nbsp;<span class="op" id="4446001">+</span>&nbsp;<span class="builtinfunc" id="4446003">len</span><span class="op" id="4446006">(</span><span class="ident" id="4446007">prefix</span><span class="op" id="4446013">)</span>&nbsp;<span class="op" id="4446015">+</span>&nbsp;<span class="builtinfunc" id="4446017">len</span><span class="op" id="4446020">(</span><span class="ident" id="4446021">finalBlock</span><span class="op" id="4446031">)</span><span class="op" id="4446032">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4446037">c</span><span class="op" id="4446038">.</span><span class="ident" id="4446039">CryptBlocks</span><span class="op" id="4446050">(</span><span class="ident" id="4446051">b</span><span class="op" id="4446052">.</span><span class="ident" id="4446053">data</span><span class="op" id="4446057">[</span><span class="ident" id="4446058">recordHeaderLen</span><span class="op" id="4446073">+</span><span class="ident" id="4446074">explicitIVLen</span><span class="op" id="4446087">:</span><span class="op" id="4446088">]</span><span class="op" id="4446089">,</span>&nbsp;<span class="ident" id="4446091">prefix</span><span class="op" id="4446097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4446102">c</span><span class="op" id="4446103">.</span><span class="ident" id="4446104">CryptBlocks</span><span class="op" id="4446115">(</span><span class="ident" id="4446116">b</span><span class="op" id="4446117">.</span><span class="ident" id="4446118">data</span><span class="op" id="4446122">[</span><span class="ident" id="4446123">recordHeaderLen</span><span class="op" id="4446138">+</span><span class="ident" id="4446139">explicitIVLen</span><span class="op" id="4446152">+</span><span class="builtinfunc" id="4446153">len</span><span class="op" id="4446156">(</span><span class="ident" id="4446157">prefix</span><span class="op" id="4446163">)</span><span class="op" id="4446164">:</span><span class="op" id="4446165">]</span><span class="op" id="4446166">,</span>&nbsp;<span class="ident" id="4446168">finalBlock</span><span class="op" id="4446178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4446182">default</span><span class="op" id="4446189">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4446194">panic</span><span class="op" id="4446199">(</span><span class="string" id="4446200">&#34;unknown&nbsp;cipher&nbsp;type&#34;</span><span class="op" id="4446221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4446225">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4446228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4446232">//&nbsp;update&nbsp;length&nbsp;to&nbsp;include&nbsp;MAC&nbsp;and&nbsp;any&nbsp;block&nbsp;padding&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4446295">n</span>&nbsp;<span class="op" id="4446297">:=</span>&nbsp;<span class="builtinfunc" id="4446300">len</span><span class="op" id="4446303">(</span><span class="ident" id="4446304">b</span><span class="op" id="4446305">.</span><span class="ident" id="4446306">data</span><span class="op" id="4446310">)</span>&nbsp;<span class="op" id="4446312">-</span>&nbsp;<span class="ident" id="4446314">recordHeaderLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4446331">b</span><span class="op" id="4446332">.</span><span class="ident" id="4446333">data</span><span class="op" id="4446337">[</span><span class="num" id="4446338">3</span><span class="op" id="4446339">]</span>&nbsp;<span class="op" id="4446341">=</span>&nbsp;<span class="builtintype" id="4446343">byte</span><span class="op" id="4446347">(</span><span class="ident" id="4446348">n</span>&nbsp;<span class="op" id="4446350">&gt;&gt;</span>&nbsp;<span class="num" id="4446353">8</span><span class="op" id="4446354">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4446357">b</span><span class="op" id="4446358">.</span><span class="ident" id="4446359">data</span><span class="op" id="4446363">[</span><span class="num" id="4446364">4</span><span class="op" id="4446365">]</span>&nbsp;<span class="op" id="4446367">=</span>&nbsp;<span class="builtintype" id="4446369">byte</span><span class="op" id="4446373">(</span><span class="ident" id="4446374">n</span><span class="op" id="4446375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4446378">hc</span><span class="op" id="4446380">.</span><span class="ident" id="4446381">incSeq</span><span class="op" id="4446387">(</span><span class="op" id="4446388">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4446392">return</span>&nbsp;<span class="builtintype" id="4446399">true</span><span class="op" id="4446403">,</span>&nbsp;<span class="num" id="4446405">0</span><br>
<span class="lineno"></span><span class="op" id="4446407">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span><span class="comment" id="4446410">//&nbsp;A&nbsp;block&nbsp;is&nbsp;a&nbsp;simple&nbsp;data&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="4446446">type</span>&nbsp;<span class="ident" id="4446451">block</span>&nbsp;<span class="keyword" id="4446457">struct</span>&nbsp;<span class="op" id="4446464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4446467">data</span>&nbsp;<span class="op" id="4446472">[</span><span class="op" id="4446473">]</span><span class="builtintype" id="4446474">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4446480">off</span>&nbsp;&nbsp;<span class="builtintype" id="4446485">int</span>&nbsp;<span class="comment" id="4446489">//&nbsp;index&nbsp;for&nbsp;Read</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4446508">link</span>&nbsp;<span class="op" id="4446513">*</span><span class="ident" id="4446514">block</span><br>
<span class="lineno"></span><span class="op" id="4446520">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4446523">//&nbsp;resize&nbsp;resizes&nbsp;block&nbsp;to&nbsp;be&nbsp;n&nbsp;bytes,&nbsp;growing&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="4446584">func</span>&nbsp;<span class="op" id="4446589">(</span><span class="ident" id="4446590">b</span>&nbsp;<span class="op" id="4446592">*</span><span class="ident" id="4446593">block</span><span class="op" id="4446598">)</span>&nbsp;<span class="ident" id="4446600">resize</span><span class="op" id="4446606">(</span><span class="ident" id="4446607">n</span>&nbsp;<span class="builtintype" id="4446609">int</span><span class="op" id="4446612">)</span>&nbsp;<span class="op" id="4446614">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4446617">if</span>&nbsp;<span class="ident" id="4446620">n</span>&nbsp;<span class="op" id="4446622">&gt;</span>&nbsp;<span class="builtinfunc" id="4446624">cap</span><span class="op" id="4446627">(</span><span class="ident" id="4446628">b</span><span class="op" id="4446629">.</span><span class="ident" id="4446630">data</span><span class="op" id="4446634">)</span>&nbsp;<span class="op" id="4446636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4446640">b</span><span class="op" id="4446641">.</span><span class="ident" id="4446642">reserve</span><span class="op" id="4446649">(</span><span class="ident" id="4446650">n</span><span class="op" id="4446651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4446654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4446657">b</span><span class="op" id="4446658">.</span><span class="ident" id="4446659">data</span>&nbsp;<span class="op" id="4446664">=</span>&nbsp;<span class="ident" id="4446666">b</span><span class="op" id="4446667">.</span><span class="ident" id="4446668">data</span><span class="op" id="4446672">[</span><span class="num" id="4446673">0</span><span class="op" id="4446674">:</span><span class="ident" id="4446675">n</span><span class="op" id="4446676">]</span><br>
<span class="lineno"></span><span class="op" id="4446678">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="comment" id="4446681">//&nbsp;reserve&nbsp;makes&nbsp;sure&nbsp;that&nbsp;block&nbsp;contains&nbsp;a&nbsp;capacity&nbsp;of&nbsp;at&nbsp;least&nbsp;n&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="4446755">func</span>&nbsp;<span class="op" id="4446760">(</span><span class="ident" id="4446761">b</span>&nbsp;<span class="op" id="4446763">*</span><span class="ident" id="4446764">block</span><span class="op" id="4446769">)</span>&nbsp;<span class="ident" id="4446771">reserve</span><span class="op" id="4446778">(</span><span class="ident" id="4446779">n</span>&nbsp;<span class="builtintype" id="4446781">int</span><span class="op" id="4446784">)</span>&nbsp;<span class="op" id="4446786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4446789">if</span>&nbsp;<span class="builtinfunc" id="4446792">cap</span><span class="op" id="4446795">(</span><span class="ident" id="4446796">b</span><span class="op" id="4446797">.</span><span class="ident" id="4446798">data</span><span class="op" id="4446802">)</span>&nbsp;<span class="op" id="4446804">&gt;=</span>&nbsp;<span class="ident" id="4446807">n</span>&nbsp;<span class="op" id="4446809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4446813">return</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4446821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4446824">m</span>&nbsp;<span class="op" id="4446826">:=</span>&nbsp;<span class="builtinfunc" id="4446829">cap</span><span class="op" id="4446832">(</span><span class="ident" id="4446833">b</span><span class="op" id="4446834">.</span><span class="ident" id="4446835">data</span><span class="op" id="4446839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4446842">if</span>&nbsp;<span class="ident" id="4446845">m</span>&nbsp;<span class="op" id="4446847">==</span>&nbsp;<span class="num" id="4446850">0</span>&nbsp;<span class="op" id="4446852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4446856">m</span>&nbsp;<span class="op" id="4446858">=</span>&nbsp;<span class="num" id="4446860">1024</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4446866">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4446869">for</span>&nbsp;<span class="ident" id="4446873">m</span>&nbsp;<span class="op" id="4446875">&lt;</span>&nbsp;<span class="ident" id="4446877">n</span>&nbsp;<span class="op" id="4446879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4446883">m</span>&nbsp;<span class="op" id="4446885">*=</span>&nbsp;<span class="num" id="4446888">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4446891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4446894">data</span>&nbsp;<span class="op" id="4446899">:=</span>&nbsp;<span class="builtinfunc" id="4446902">make</span><span class="op" id="4446906">(</span><span class="op" id="4446907">[</span><span class="op" id="4446908">]</span><span class="builtintype" id="4446909">byte</span><span class="op" id="4446913">,</span>&nbsp;<span class="builtinfunc" id="4446915">len</span><span class="op" id="4446918">(</span><span class="ident" id="4446919">b</span><span class="op" id="4446920">.</span><span class="ident" id="4446921">data</span><span class="op" id="4446925">)</span><span class="op" id="4446926">,</span>&nbsp;<span class="ident" id="4446928">m</span><span class="op" id="4446929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4446932">copy</span><span class="op" id="4446936">(</span><span class="ident" id="4446937">data</span><span class="op" id="4446941">,</span>&nbsp;<span class="ident" id="4446943">b</span><span class="op" id="4446944">.</span><span class="ident" id="4446945">data</span><span class="op" id="4446949">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4446952">b</span><span class="op" id="4446953">.</span><span class="ident" id="4446954">data</span>&nbsp;<span class="op" id="4446959">=</span>&nbsp;<span class="ident" id="4446961">data</span><br>
<span class="lineno"></span><span class="op" id="4446966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4446969">//&nbsp;readFromUntil&nbsp;reads&nbsp;from&nbsp;r&nbsp;into&nbsp;b&nbsp;until&nbsp;b&nbsp;contains&nbsp;at&nbsp;least&nbsp;n&nbsp;bytes</span><br>
<span class="lineno"></span><span class="comment" id="4447040">//&nbsp;or&nbsp;else&nbsp;returns&nbsp;an&nbsp;error.</span><br>
<span class="lineno">445</span><span class="keyword" id="4447069">func</span>&nbsp;<span class="op" id="4447074">(</span><span class="ident" id="4447075">b</span>&nbsp;<span class="op" id="4447077">*</span><span class="ident" id="4447078">block</span><span class="op" id="4447083">)</span>&nbsp;<span class="ident" id="4447085">readFromUntil</span><span class="op" id="4447098">(</span><span class="ident" id="4447099">r</span>&nbsp;<span class="ident" id="4447101">io</span><span class="op" id="4447103">.</span><span class="ident" id="4447104">Reader</span><span class="op" id="4447110">,</span>&nbsp;<span class="ident" id="4447112">n</span>&nbsp;<span class="builtintype" id="4447114">int</span><span class="op" id="4447117">)</span>&nbsp;<span class="builtintype" id="4447119">error</span>&nbsp;<span class="op" id="4447125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4447128">//&nbsp;quick&nbsp;case</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4447143">if</span>&nbsp;<span class="builtinfunc" id="4447146">len</span><span class="op" id="4447149">(</span><span class="ident" id="4447150">b</span><span class="op" id="4447151">.</span><span class="ident" id="4447152">data</span><span class="op" id="4447156">)</span>&nbsp;<span class="op" id="4447158">&gt;=</span>&nbsp;<span class="ident" id="4447161">n</span>&nbsp;<span class="op" id="4447163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4447167">return</span>&nbsp;<span class="ident" id="4447174">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4447179">}</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4447183">//&nbsp;read&nbsp;until&nbsp;have&nbsp;enough.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4447211">b</span><span class="op" id="4447212">.</span><span class="ident" id="4447213">reserve</span><span class="op" id="4447220">(</span><span class="ident" id="4447221">n</span><span class="op" id="4447222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4447225">for</span>&nbsp;<span class="op" id="4447229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4447233">m</span><span class="op" id="4447234">,</span>&nbsp;<span class="ident" id="4447236">err</span>&nbsp;<span class="op" id="4447240">:=</span>&nbsp;<span class="ident" id="4447243">r</span><span class="op" id="4447244">.</span><span class="ident" id="4447245">Read</span><span class="op" id="4447249">(</span><span class="ident" id="4447250">b</span><span class="op" id="4447251">.</span><span class="ident" id="4447252">data</span><span class="op" id="4447256">[</span><span class="builtinfunc" id="4447257">len</span><span class="op" id="4447260">(</span><span class="ident" id="4447261">b</span><span class="op" id="4447262">.</span><span class="ident" id="4447263">data</span><span class="op" id="4447267">)</span><span class="op" id="4447268">:</span><span class="builtinfunc" id="4447269">cap</span><span class="op" id="4447272">(</span><span class="ident" id="4447273">b</span><span class="op" id="4447274">.</span><span class="ident" id="4447275">data</span><span class="op" id="4447279">)</span><span class="op" id="4447280">]</span><span class="op" id="4447281">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4447285">b</span><span class="op" id="4447286">.</span><span class="ident" id="4447287">data</span>&nbsp;<span class="op" id="4447292">=</span>&nbsp;<span class="ident" id="4447294">b</span><span class="op" id="4447295">.</span><span class="ident" id="4447296">data</span><span class="op" id="4447300">[</span><span class="num" id="4447301">0</span>&nbsp;<span class="op" id="4447303">:</span>&nbsp;<span class="builtinfunc" id="4447305">len</span><span class="op" id="4447308">(</span><span class="ident" id="4447309">b</span><span class="op" id="4447310">.</span><span class="ident" id="4447311">data</span><span class="op" id="4447315">)</span><span class="op" id="4447316">+</span><span class="ident" id="4447317">m</span><span class="op" id="4447318">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4447322">if</span>&nbsp;<span class="builtinfunc" id="4447325">len</span><span class="op" id="4447328">(</span><span class="ident" id="4447329">b</span><span class="op" id="4447330">.</span><span class="ident" id="4447331">data</span><span class="op" id="4447335">)</span>&nbsp;<span class="op" id="4447337">&gt;=</span>&nbsp;<span class="ident" id="4447340">n</span>&nbsp;<span class="op" id="4447342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4447347">//&nbsp;TODO(bradfitz,agl):&nbsp;slightly&nbsp;suspicious</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4447393">//&nbsp;that&nbsp;we&#39;re&nbsp;throwing&nbsp;away&nbsp;r.Read&#39;s&nbsp;err&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4447443">break</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4447451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4447455">if</span>&nbsp;<span class="ident" id="4447458">err</span>&nbsp;<span class="op" id="4447462">!=</span>&nbsp;<span class="ident" id="4447465">nil</span>&nbsp;<span class="op" id="4447469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4447474">return</span>&nbsp;<span class="ident" id="4447481">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4447487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4447490">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4447493">return</span>&nbsp;<span class="ident" id="4447500">nil</span><br>
<span class="lineno"></span><span class="op" id="4447504">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4447507">func</span>&nbsp;<span class="op" id="4447512">(</span><span class="ident" id="4447513">b</span>&nbsp;<span class="op" id="4447515">*</span><span class="ident" id="4447516">block</span><span class="op" id="4447521">)</span>&nbsp;<span class="ident" id="4447523">Read</span><span class="op" id="4447527">(</span><span class="ident" id="4447528">p</span>&nbsp;<span class="op" id="4447530">[</span><span class="op" id="4447531">]</span><span class="builtintype" id="4447532">byte</span><span class="op" id="4447536">)</span>&nbsp;<span class="op" id="4447538">(</span><span class="ident" id="4447539">n</span>&nbsp;<span class="builtintype" id="4447541">int</span><span class="op" id="4447544">,</span>&nbsp;<span class="ident" id="4447546">err</span>&nbsp;<span class="builtintype" id="4447550">error</span><span class="op" id="4447555">)</span>&nbsp;<span class="op" id="4447557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4447560">n</span>&nbsp;<span class="op" id="4447562">=</span>&nbsp;<span class="builtinfunc" id="4447564">copy</span><span class="op" id="4447568">(</span><span class="ident" id="4447569">p</span><span class="op" id="4447570">,</span>&nbsp;<span class="ident" id="4447572">b</span><span class="op" id="4447573">.</span><span class="ident" id="4447574">data</span><span class="op" id="4447578">[</span><span class="ident" id="4447579">b</span><span class="op" id="4447580">.</span><span class="ident" id="4447581">off</span><span class="op" id="4447584">:</span><span class="op" id="4447585">]</span><span class="op" id="4447586">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4447589">b</span><span class="op" id="4447590">.</span><span class="ident" id="4447591">off</span>&nbsp;<span class="op" id="4447595">+=</span>&nbsp;<span class="ident" id="4447598">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4447601">return</span><br>
<span class="lineno"></span><span class="op" id="4447608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4447611">//&nbsp;newBlock&nbsp;allocates&nbsp;a&nbsp;new&nbsp;block,&nbsp;from&nbsp;hc&#39;s&nbsp;free&nbsp;list&nbsp;if&nbsp;possible.</span><br>
<span class="lineno">475</span><span class="keyword" id="4447679">func</span>&nbsp;<span class="op" id="4447684">(</span><span class="ident" id="4447685">hc</span>&nbsp;<span class="op" id="4447688">*</span><span class="ident" id="4447689">halfConn</span><span class="op" id="4447697">)</span>&nbsp;<span class="ident" id="4447699">newBlock</span><span class="op" id="4447707">(</span><span class="op" id="4447708">)</span>&nbsp;<span class="op" id="4447710">*</span><span class="ident" id="4447711">block</span>&nbsp;<span class="op" id="4447717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4447720">b</span>&nbsp;<span class="op" id="4447722">:=</span>&nbsp;<span class="ident" id="4447725">hc</span><span class="op" id="4447727">.</span><span class="ident" id="4447728">bfree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4447735">if</span>&nbsp;<span class="ident" id="4447738">b</span>&nbsp;<span class="op" id="4447740">==</span>&nbsp;<span class="ident" id="4447743">nil</span>&nbsp;<span class="op" id="4447747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4447751">return</span>&nbsp;<span class="builtinfunc" id="4447758">new</span><span class="op" id="4447761">(</span><span class="ident" id="4447762">block</span><span class="op" id="4447767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4447770">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4447773">hc</span><span class="op" id="4447775">.</span><span class="ident" id="4447776">bfree</span>&nbsp;<span class="op" id="4447782">=</span>&nbsp;<span class="ident" id="4447784">b</span><span class="op" id="4447785">.</span><span class="ident" id="4447786">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4447792">b</span><span class="op" id="4447793">.</span><span class="ident" id="4447794">link</span>&nbsp;<span class="op" id="4447799">=</span>&nbsp;<span class="ident" id="4447801">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4447806">b</span><span class="op" id="4447807">.</span><span class="ident" id="4447808">resize</span><span class="op" id="4447814">(</span><span class="num" id="4447815">0</span><span class="op" id="4447816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4447819">return</span>&nbsp;<span class="ident" id="4447826">b</span><br>
<span class="lineno"></span><span class="op" id="4447828">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="comment" id="4447831">//&nbsp;freeBlock&nbsp;returns&nbsp;a&nbsp;block&nbsp;to&nbsp;hc&#39;s&nbsp;free&nbsp;list.</span><br>
<span class="lineno"></span><span class="comment" id="4447879">//&nbsp;The&nbsp;protocol&nbsp;is&nbsp;such&nbsp;that&nbsp;each&nbsp;side&nbsp;only&nbsp;has&nbsp;a&nbsp;block&nbsp;or&nbsp;two&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="4447945">//&nbsp;its&nbsp;free&nbsp;list&nbsp;at&nbsp;a&nbsp;time,&nbsp;so&nbsp;there&#39;s&nbsp;no&nbsp;need&nbsp;to&nbsp;worry&nbsp;about</span><br>
<span class="lineno"></span><span class="comment" id="4448007">//&nbsp;trimming&nbsp;the&nbsp;list,&nbsp;etc.</span><br>
<span class="lineno">490</span><span class="keyword" id="4448034">func</span>&nbsp;<span class="op" id="4448039">(</span><span class="ident" id="4448040">hc</span>&nbsp;<span class="op" id="4448043">*</span><span class="ident" id="4448044">halfConn</span><span class="op" id="4448052">)</span>&nbsp;<span class="ident" id="4448054">freeBlock</span><span class="op" id="4448063">(</span><span class="ident" id="4448064">b</span>&nbsp;<span class="op" id="4448066">*</span><span class="ident" id="4448067">block</span><span class="op" id="4448072">)</span>&nbsp;<span class="op" id="4448074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4448077">b</span><span class="op" id="4448078">.</span><span class="ident" id="4448079">link</span>&nbsp;<span class="op" id="4448084">=</span>&nbsp;<span class="ident" id="4448086">hc</span><span class="op" id="4448088">.</span><span class="ident" id="4448089">bfree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4448096">hc</span><span class="op" id="4448098">.</span><span class="ident" id="4448099">bfree</span>&nbsp;<span class="op" id="4448105">=</span>&nbsp;<span class="ident" id="4448107">b</span><br>
<span class="lineno"></span><span class="op" id="4448109">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="4448112">//&nbsp;splitBlock&nbsp;splits&nbsp;a&nbsp;block&nbsp;after&nbsp;the&nbsp;first&nbsp;n&nbsp;bytes,</span><br>
<span class="lineno"></span><span class="comment" id="4448166">//&nbsp;returning&nbsp;a&nbsp;block&nbsp;with&nbsp;those&nbsp;n&nbsp;bytes&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4448212">//&nbsp;block&nbsp;with&nbsp;the&nbsp;remainder.&nbsp;&nbsp;the&nbsp;latter&nbsp;may&nbsp;be&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword" id="4448265">func</span>&nbsp;<span class="op" id="4448270">(</span><span class="ident" id="4448271">hc</span>&nbsp;<span class="op" id="4448274">*</span><span class="ident" id="4448275">halfConn</span><span class="op" id="4448283">)</span>&nbsp;<span class="ident" id="4448285">splitBlock</span><span class="op" id="4448295">(</span><span class="ident" id="4448296">b</span>&nbsp;<span class="op" id="4448298">*</span><span class="ident" id="4448299">block</span><span class="op" id="4448304">,</span>&nbsp;<span class="ident" id="4448306">n</span>&nbsp;<span class="builtintype" id="4448308">int</span><span class="op" id="4448311">)</span>&nbsp;<span class="op" id="4448313">(</span><span class="op" id="4448314">*</span><span class="ident" id="4448315">block</span><span class="op" id="4448320">,</span>&nbsp;<span class="op" id="4448322">*</span><span class="ident" id="4448323">block</span><span class="op" id="4448328">)</span>&nbsp;<span class="op" id="4448330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4448333">if</span>&nbsp;<span class="builtinfunc" id="4448336">len</span><span class="op" id="4448339">(</span><span class="ident" id="4448340">b</span><span class="op" id="4448341">.</span><span class="ident" id="4448342">data</span><span class="op" id="4448346">)</span>&nbsp;<span class="op" id="4448348">&lt;=</span>&nbsp;<span class="ident" id="4448351">n</span>&nbsp;<span class="op" id="4448353">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4448357">return</span>&nbsp;<span class="ident" id="4448364">b</span><span class="op" id="4448365">,</span>&nbsp;<span class="ident" id="4448367">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4448372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4448375">bb</span>&nbsp;<span class="op" id="4448378">:=</span>&nbsp;<span class="ident" id="4448381">hc</span><span class="op" id="4448383">.</span><span class="ident" id="4448384">newBlock</span><span class="op" id="4448392">(</span><span class="op" id="4448393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4448396">bb</span><span class="op" id="4448398">.</span><span class="ident" id="4448399">resize</span><span class="op" id="4448405">(</span><span class="builtinfunc" id="4448406">len</span><span class="op" id="4448409">(</span><span class="ident" id="4448410">b</span><span class="op" id="4448411">.</span><span class="ident" id="4448412">data</span><span class="op" id="4448416">)</span>&nbsp;<span class="op" id="4448418">-</span>&nbsp;<span class="ident" id="4448420">n</span><span class="op" id="4448421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4448424">copy</span><span class="op" id="4448428">(</span><span class="ident" id="4448429">bb</span><span class="op" id="4448431">.</span><span class="ident" id="4448432">data</span><span class="op" id="4448436">,</span>&nbsp;<span class="ident" id="4448438">b</span><span class="op" id="4448439">.</span><span class="ident" id="4448440">data</span><span class="op" id="4448444">[</span><span class="ident" id="4448445">n</span><span class="op" id="4448446">:</span><span class="op" id="4448447">]</span><span class="op" id="4448448">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4448451">b</span><span class="op" id="4448452">.</span><span class="ident" id="4448453">data</span>&nbsp;<span class="op" id="4448458">=</span>&nbsp;<span class="ident" id="4448460">b</span><span class="op" id="4448461">.</span><span class="ident" id="4448462">data</span><span class="op" id="4448466">[</span><span class="num" id="4448467">0</span><span class="op" id="4448468">:</span><span class="ident" id="4448469">n</span><span class="op" id="4448470">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4448473">return</span>&nbsp;<span class="ident" id="4448480">b</span><span class="op" id="4448481">,</span>&nbsp;<span class="ident" id="4448483">bb</span><br>
<span class="lineno"></span><span class="op" id="4448486">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4448489">//&nbsp;readRecord&nbsp;reads&nbsp;the&nbsp;next&nbsp;TLS&nbsp;record&nbsp;from&nbsp;the&nbsp;connection</span><br>
<span class="lineno">510</span><span class="comment" id="4448549">//&nbsp;and&nbsp;updates&nbsp;the&nbsp;record&nbsp;layer&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="4448588">//&nbsp;c.in.Mutex&nbsp;&lt;=&nbsp;L;&nbsp;c.input&nbsp;==&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword" id="4448624">func</span>&nbsp;<span class="op" id="4448629">(</span><span class="ident" id="4448630">c</span>&nbsp;<span class="op" id="4448632">*</span><span class="ident" id="4448633">Conn</span><span class="op" id="4448637">)</span>&nbsp;<span class="ident" id="4448639">readRecord</span><span class="op" id="4448649">(</span><span class="ident" id="4448650">want</span>&nbsp;<span class="ident" id="4448655">recordType</span><span class="op" id="4448665">)</span>&nbsp;<span class="builtintype" id="4448667">error</span>&nbsp;<span class="op" id="4448673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4448676">//&nbsp;Caller&nbsp;must&nbsp;be&nbsp;in&nbsp;sync&nbsp;with&nbsp;connection:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4448720">//&nbsp;handshake&nbsp;data&nbsp;if&nbsp;handshake&nbsp;not&nbsp;yet&nbsp;completed,</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4448771">//&nbsp;else&nbsp;application&nbsp;data.&nbsp;&nbsp;(We&nbsp;don&#39;t&nbsp;support&nbsp;renegotiation.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4448833">switch</span>&nbsp;<span class="ident" id="4448840">want</span>&nbsp;<span class="op" id="4448845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4448848">default</span><span class="op" id="4448855">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4448859">c</span><span class="op" id="4448860">.</span><span class="ident" id="4448861">sendAlert</span><span class="op" id="4448870">(</span><span class="ident" id="4448871">alertInternalError</span><span class="op" id="4448889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4448893">return</span>&nbsp;<span class="ident" id="4448900">c</span><span class="op" id="4448901">.</span><span class="ident" id="4448902">in</span><span class="op" id="4448904">.</span><span class="ident" id="4448905">setErrorLocked</span><span class="op" id="4448919">(</span><span class="ident" id="4448920">errors</span><span class="op" id="4448926">.</span><span class="ident" id="4448927">New</span><span class="op" id="4448930">(</span><span class="string" id="4448931">&#34;tls:&nbsp;unknown&nbsp;record&nbsp;type&nbsp;requested&#34;</span><span class="op" id="4448967">)</span><span class="op" id="4448968">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4448971">case</span>&nbsp;<span class="ident" id="4448976">recordTypeHandshake</span><span class="op" id="4448995">,</span>&nbsp;<span class="ident" id="4448997">recordTypeChangeCipherSpec</span><span class="op" id="4449023">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4449027">if</span>&nbsp;<span class="ident" id="4449030">c</span><span class="op" id="4449031">.</span><span class="ident" id="4449032">handshakeComplete</span>&nbsp;<span class="op" id="4449050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4449055">c</span><span class="op" id="4449056">.</span><span class="ident" id="4449057">sendAlert</span><span class="op" id="4449066">(</span><span class="ident" id="4449067">alertInternalError</span><span class="op" id="4449085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4449090">return</span>&nbsp;<span class="ident" id="4449097">c</span><span class="op" id="4449098">.</span><span class="ident" id="4449099">in</span><span class="op" id="4449101">.</span><span class="ident" id="4449102">setErrorLocked</span><span class="op" id="4449116">(</span><span class="ident" id="4449117">errors</span><span class="op" id="4449123">.</span><span class="ident" id="4449124">New</span><span class="op" id="4449127">(</span><span class="string" id="4449128">&#34;tls:&nbsp;handshake&nbsp;or&nbsp;ChangeCipherSpec&nbsp;requested&nbsp;after&nbsp;handshake&nbsp;complete&#34;</span><span class="op" id="4449199">)</span><span class="op" id="4449200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4449204">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4449207">case</span>&nbsp;<span class="ident" id="4449212">recordTypeApplicationData</span><span class="op" id="4449237">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4449241">if</span>&nbsp;<span class="op" id="4449244">!</span><span class="ident" id="4449245">c</span><span class="op" id="4449246">.</span><span class="ident" id="4449247">handshakeComplete</span>&nbsp;<span class="op" id="4449265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4449270">c</span><span class="op" id="4449271">.</span><span class="ident" id="4449272">sendAlert</span><span class="op" id="4449281">(</span><span class="ident" id="4449282">alertInternalError</span><span class="op" id="4449300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4449305">return</span>&nbsp;<span class="ident" id="4449312">c</span><span class="op" id="4449313">.</span><span class="ident" id="4449314">in</span><span class="op" id="4449316">.</span><span class="ident" id="4449317">setErrorLocked</span><span class="op" id="4449331">(</span><span class="ident" id="4449332">errors</span><span class="op" id="4449338">.</span><span class="ident" id="4449339">New</span><span class="op" id="4449342">(</span><span class="string" id="4449343">&#34;tls:&nbsp;application&nbsp;data&nbsp;record&nbsp;requested&nbsp;before&nbsp;handshake&nbsp;complete&#34;</span><span class="op" id="4449409">)</span><span class="op" id="4449410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4449414">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4449417">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="4449420">Again</span><span class="op" id="4449425">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4449428">if</span>&nbsp;<span class="ident" id="4449431">c</span><span class="op" id="4449432">.</span><span class="ident" id="4449433">rawInput</span>&nbsp;<span class="op" id="4449442">==</span>&nbsp;<span class="ident" id="4449445">nil</span>&nbsp;<span class="op" id="4449449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4449453">c</span><span class="op" id="4449454">.</span><span class="ident" id="4449455">rawInput</span>&nbsp;<span class="op" id="4449464">=</span>&nbsp;<span class="ident" id="4449466">c</span><span class="op" id="4449467">.</span><span class="ident" id="4449468">in</span><span class="op" id="4449470">.</span><span class="ident" id="4449471">newBlock</span><span class="op" id="4449479">(</span><span class="op" id="4449480">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4449483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4449486">b</span>&nbsp;<span class="op" id="4449488">:=</span>&nbsp;<span class="ident" id="4449491">c</span><span class="op" id="4449492">.</span><span class="ident" id="4449493">rawInput</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4449504">//&nbsp;Read&nbsp;header,&nbsp;payload.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4449530">if</span>&nbsp;<span class="ident" id="4449533">err</span>&nbsp;<span class="op" id="4449537">:=</span>&nbsp;<span class="ident" id="4449540">b</span><span class="op" id="4449541">.</span><span class="ident" id="4449542">readFromUntil</span><span class="op" id="4449555">(</span><span class="ident" id="4449556">c</span><span class="op" id="4449557">.</span><span class="ident" id="4449558">conn</span><span class="op" id="4449562">,</span>&nbsp;<span class="ident" id="4449564">recordHeaderLen</span><span class="op" id="4449579">)</span><span class="op" id="4449580">;</span>&nbsp;<span class="ident" id="4449582">err</span>&nbsp;<span class="op" id="4449586">!=</span>&nbsp;<span class="ident" id="4449589">nil</span>&nbsp;<span class="op" id="4449593">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4449597">//&nbsp;RFC&nbsp;suggests&nbsp;that&nbsp;EOF&nbsp;without&nbsp;an&nbsp;alertCloseNotify&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4449655">//&nbsp;an&nbsp;error,&nbsp;but&nbsp;popular&nbsp;web&nbsp;sites&nbsp;seem&nbsp;to&nbsp;do&nbsp;this,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4449709">//&nbsp;so&nbsp;we&nbsp;can&#39;t&nbsp;make&nbsp;it&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4449744">//&nbsp;if&nbsp;err&nbsp;==&nbsp;io.EOF&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4449768">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;=&nbsp;io.ErrUnexpectedEOF</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4449800">//&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4449807">if</span>&nbsp;<span class="ident" id="4449810">e</span><span class="op" id="4449811">,</span>&nbsp;<span class="ident" id="4449813">ok</span>&nbsp;<span class="op" id="4449816">:=</span>&nbsp;<span class="ident" id="4449819">err</span><span class="op" id="4449822">.</span><span class="op" id="4449823">(</span><span class="ident" id="4449824">net</span><span class="op" id="4449827">.</span><span class="ident" id="4449828">Error</span><span class="op" id="4449833">)</span><span class="op" id="4449834">;</span>&nbsp;<span class="op" id="4449836">!</span><span class="ident" id="4449837">ok</span>&nbsp;<span class="op" id="4449840">||</span>&nbsp;<span class="op" id="4449843">!</span><span class="ident" id="4449844">e</span><span class="op" id="4449845">.</span><span class="ident" id="4449846">Temporary</span><span class="op" id="4449855">(</span><span class="op" id="4449856">)</span>&nbsp;<span class="op" id="4449858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4449863">c</span><span class="op" id="4449864">.</span><span class="ident" id="4449865">in</span><span class="op" id="4449867">.</span><span class="ident" id="4449868">setErrorLocked</span><span class="op" id="4449882">(</span><span class="ident" id="4449883">err</span><span class="op" id="4449886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4449890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4449894">return</span>&nbsp;<span class="ident" id="4449901">err</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4449906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4449909">typ</span>&nbsp;<span class="op" id="4449913">:=</span>&nbsp;<span class="ident" id="4449916">recordType</span><span class="op" id="4449926">(</span><span class="ident" id="4449927">b</span><span class="op" id="4449928">.</span><span class="ident" id="4449929">data</span><span class="op" id="4449933">[</span><span class="num" id="4449934">0</span><span class="op" id="4449935">]</span><span class="op" id="4449936">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4449940">//&nbsp;No&nbsp;valid&nbsp;TLS&nbsp;record&nbsp;has&nbsp;a&nbsp;type&nbsp;of&nbsp;0x80,&nbsp;however&nbsp;SSLv2&nbsp;handshakes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4450009">//&nbsp;start&nbsp;with&nbsp;a&nbsp;uint16&nbsp;length&nbsp;where&nbsp;the&nbsp;MSB&nbsp;is&nbsp;set&nbsp;and&nbsp;the&nbsp;first&nbsp;record</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4450082">//&nbsp;is&nbsp;always&nbsp;&lt;&nbsp;256&nbsp;bytes&nbsp;long.&nbsp;Therefore&nbsp;typ&nbsp;==&nbsp;0x80&nbsp;strongly&nbsp;suggests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4450154">//&nbsp;an&nbsp;SSLv2&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4450175">if</span>&nbsp;<span class="ident" id="4450178">want</span>&nbsp;<span class="op" id="4450183">==</span>&nbsp;<span class="ident" id="4450186">recordTypeHandshake</span>&nbsp;<span class="op" id="4450206">&amp;&amp;</span>&nbsp;<span class="ident" id="4450209">typ</span>&nbsp;<span class="op" id="4450213">==</span>&nbsp;<span class="num" id="4450216">0x80</span>&nbsp;<span class="op" id="4450221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4450225">c</span><span class="op" id="4450226">.</span><span class="ident" id="4450227">sendAlert</span><span class="op" id="4450236">(</span><span class="ident" id="4450237">alertProtocolVersion</span><span class="op" id="4450257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4450261">return</span>&nbsp;<span class="ident" id="4450268">c</span><span class="op" id="4450269">.</span><span class="ident" id="4450270">in</span><span class="op" id="4450272">.</span><span class="ident" id="4450273">setErrorLocked</span><span class="op" id="4450287">(</span><span class="ident" id="4450288">errors</span><span class="op" id="4450294">.</span><span class="ident" id="4450295">New</span><span class="op" id="4450298">(</span><span class="string" id="4450299">&#34;tls:&nbsp;unsupported&nbsp;SSLv2&nbsp;handshake&nbsp;received&#34;</span><span class="op" id="4450342">)</span><span class="op" id="4450343">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4450346">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4450350">vers</span>&nbsp;<span class="op" id="4450355">:=</span>&nbsp;<span class="builtintype" id="4450358">uint16</span><span class="op" id="4450364">(</span><span class="ident" id="4450365">b</span><span class="op" id="4450366">.</span><span class="ident" id="4450367">data</span><span class="op" id="4450371">[</span><span class="num" id="4450372">1</span><span class="op" id="4450373">]</span><span class="op" id="4450374">)</span><span class="op" id="4450375">&lt;&lt;</span><span class="num" id="4450377">8</span>&nbsp;<span class="op" id="4450379">|</span>&nbsp;<span class="builtintype" id="4450381">uint16</span><span class="op" id="4450387">(</span><span class="ident" id="4450388">b</span><span class="op" id="4450389">.</span><span class="ident" id="4450390">data</span><span class="op" id="4450394">[</span><span class="num" id="4450395">2</span><span class="op" id="4450396">]</span><span class="op" id="4450397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4450400">n</span>&nbsp;<span class="op" id="4450402">:=</span>&nbsp;<span class="builtintype" id="4450405">int</span><span class="op" id="4450408">(</span><span class="ident" id="4450409">b</span><span class="op" id="4450410">.</span><span class="ident" id="4450411">data</span><span class="op" id="4450415">[</span><span class="num" id="4450416">3</span><span class="op" id="4450417">]</span><span class="op" id="4450418">)</span><span class="op" id="4450419">&lt;&lt;</span><span class="num" id="4450421">8</span>&nbsp;<span class="op" id="4450423">|</span>&nbsp;<span class="builtintype" id="4450425">int</span><span class="op" id="4450428">(</span><span class="ident" id="4450429">b</span><span class="op" id="4450430">.</span><span class="ident" id="4450431">data</span><span class="op" id="4450435">[</span><span class="num" id="4450436">4</span><span class="op" id="4450437">]</span><span class="op" id="4450438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4450441">if</span>&nbsp;<span class="ident" id="4450444">c</span><span class="op" id="4450445">.</span><span class="ident" id="4450446">haveVers</span>&nbsp;<span class="op" id="4450455">&amp;&amp;</span>&nbsp;<span class="ident" id="4450458">vers</span>&nbsp;<span class="op" id="4450463">!=</span>&nbsp;<span class="ident" id="4450466">c</span><span class="op" id="4450467">.</span><span class="ident" id="4450468">vers</span>&nbsp;<span class="op" id="4450473">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4450477">c</span><span class="op" id="4450478">.</span><span class="ident" id="4450479">sendAlert</span><span class="op" id="4450488">(</span><span class="ident" id="4450489">alertProtocolVersion</span><span class="op" id="4450509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4450513">return</span>&nbsp;<span class="ident" id="4450520">c</span><span class="op" id="4450521">.</span><span class="ident" id="4450522">in</span><span class="op" id="4450524">.</span><span class="ident" id="4450525">setErrorLocked</span><span class="op" id="4450539">(</span><span class="ident" id="4450540">fmt</span><span class="op" id="4450543">.</span><span class="ident" id="4450544">Errorf</span><span class="op" id="4450550">(</span><span class="string" id="4450551">&#34;tls:&nbsp;received&nbsp;record&nbsp;with&nbsp;version&nbsp;%x&nbsp;when&nbsp;expecting&nbsp;version&nbsp;%x&#34;</span><span class="op" id="4450615">,</span>&nbsp;<span class="ident" id="4450617">vers</span><span class="op" id="4450621">,</span>&nbsp;<span class="ident" id="4450623">c</span><span class="op" id="4450624">.</span><span class="ident" id="4450625">vers</span><span class="op" id="4450629">)</span><span class="op" id="4450630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4450633">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4450636">if</span>&nbsp;<span class="ident" id="4450639">n</span>&nbsp;<span class="op" id="4450641">&gt;</span>&nbsp;<span class="ident" id="4450643">maxCiphertext</span>&nbsp;<span class="op" id="4450657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4450661">c</span><span class="op" id="4450662">.</span><span class="ident" id="4450663">sendAlert</span><span class="op" id="4450672">(</span><span class="ident" id="4450673">alertRecordOverflow</span><span class="op" id="4450692">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4450696">return</span>&nbsp;<span class="ident" id="4450703">c</span><span class="op" id="4450704">.</span><span class="ident" id="4450705">in</span><span class="op" id="4450707">.</span><span class="ident" id="4450708">setErrorLocked</span><span class="op" id="4450722">(</span><span class="ident" id="4450723">fmt</span><span class="op" id="4450726">.</span><span class="ident" id="4450727">Errorf</span><span class="op" id="4450733">(</span><span class="string" id="4450734">&#34;tls:&nbsp;oversized&nbsp;record&nbsp;received&nbsp;with&nbsp;length&nbsp;%d&#34;</span><span class="op" id="4450781">,</span>&nbsp;<span class="ident" id="4450783">n</span><span class="op" id="4450784">)</span><span class="op" id="4450785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4450788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4450791">if</span>&nbsp;<span class="op" id="4450794">!</span><span class="ident" id="4450795">c</span><span class="op" id="4450796">.</span><span class="ident" id="4450797">haveVers</span>&nbsp;<span class="op" id="4450806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4450810">//&nbsp;First&nbsp;message,&nbsp;be&nbsp;extra&nbsp;suspicious:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4450851">//&nbsp;this&nbsp;might&nbsp;not&nbsp;be&nbsp;a&nbsp;TLS&nbsp;client.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4450888">//&nbsp;Bail&nbsp;out&nbsp;before&nbsp;reading&nbsp;a&nbsp;full&nbsp;&#39;body&#39;,&nbsp;if&nbsp;possible.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4450945">//&nbsp;The&nbsp;current&nbsp;max&nbsp;version&nbsp;is&nbsp;3.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4450982">//&nbsp;If&nbsp;the&nbsp;version&nbsp;is&nbsp;&gt;=&nbsp;16.0,&nbsp;it&#39;s&nbsp;probably&nbsp;not&nbsp;real.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4451038">//&nbsp;Similarly,&nbsp;a&nbsp;clientHello&nbsp;message&nbsp;encodes&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4451087">//&nbsp;well&nbsp;under&nbsp;a&nbsp;kilobyte.&nbsp;&nbsp;If&nbsp;the&nbsp;length&nbsp;is&nbsp;&gt;=&nbsp;12&nbsp;kB,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4451143">//&nbsp;it&#39;s&nbsp;probably&nbsp;not&nbsp;real.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4451172">if</span>&nbsp;<span class="op" id="4451175">(</span><span class="ident" id="4451176">typ</span>&nbsp;<span class="op" id="4451180">!=</span>&nbsp;<span class="ident" id="4451183">recordTypeAlert</span>&nbsp;<span class="op" id="4451199">&amp;&amp;</span>&nbsp;<span class="ident" id="4451202">typ</span>&nbsp;<span class="op" id="4451206">!=</span>&nbsp;<span class="ident" id="4451209">want</span><span class="op" id="4451213">)</span>&nbsp;<span class="op" id="4451215">||</span>&nbsp;<span class="ident" id="4451218">vers</span>&nbsp;<span class="op" id="4451223">&gt;=</span>&nbsp;<span class="num" id="4451226">0x1000</span>&nbsp;<span class="op" id="4451233">||</span>&nbsp;<span class="ident" id="4451236">n</span>&nbsp;<span class="op" id="4451238">&gt;=</span>&nbsp;<span class="num" id="4451241">0x3000</span>&nbsp;<span class="op" id="4451248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4451253">c</span><span class="op" id="4451254">.</span><span class="ident" id="4451255">sendAlert</span><span class="op" id="4451264">(</span><span class="ident" id="4451265">alertUnexpectedMessage</span><span class="op" id="4451287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4451292">return</span>&nbsp;<span class="ident" id="4451299">c</span><span class="op" id="4451300">.</span><span class="ident" id="4451301">in</span><span class="op" id="4451303">.</span><span class="ident" id="4451304">setErrorLocked</span><span class="op" id="4451318">(</span><span class="ident" id="4451319">fmt</span><span class="op" id="4451322">.</span><span class="ident" id="4451323">Errorf</span><span class="op" id="4451329">(</span><span class="string" id="4451330">&#34;tls:&nbsp;first&nbsp;record&nbsp;does&nbsp;not&nbsp;look&nbsp;like&nbsp;a&nbsp;TLS&nbsp;handshake&#34;</span><span class="op" id="4451384">)</span><span class="op" id="4451385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4451389">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4451392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4451395">if</span>&nbsp;<span class="ident" id="4451398">err</span>&nbsp;<span class="op" id="4451402">:=</span>&nbsp;<span class="ident" id="4451405">b</span><span class="op" id="4451406">.</span><span class="ident" id="4451407">readFromUntil</span><span class="op" id="4451420">(</span><span class="ident" id="4451421">c</span><span class="op" id="4451422">.</span><span class="ident" id="4451423">conn</span><span class="op" id="4451427">,</span>&nbsp;<span class="ident" id="4451429">recordHeaderLen</span><span class="op" id="4451444">+</span><span class="ident" id="4451445">n</span><span class="op" id="4451446">)</span><span class="op" id="4451447">;</span>&nbsp;<span class="ident" id="4451449">err</span>&nbsp;<span class="op" id="4451453">!=</span>&nbsp;<span class="ident" id="4451456">nil</span>&nbsp;<span class="op" id="4451460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4451464">if</span>&nbsp;<span class="ident" id="4451467">err</span>&nbsp;<span class="op" id="4451471">==</span>&nbsp;<span class="ident" id="4451474">io</span><span class="op" id="4451476">.</span><span class="ident" id="4451477">EOF</span>&nbsp;<span class="op" id="4451481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4451486">err</span>&nbsp;<span class="op" id="4451490">=</span>&nbsp;<span class="ident" id="4451492">io</span><span class="op" id="4451494">.</span><span class="ident" id="4451495">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4451514">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4451518">if</span>&nbsp;<span class="ident" id="4451521">e</span><span class="op" id="4451522">,</span>&nbsp;<span class="ident" id="4451524">ok</span>&nbsp;<span class="op" id="4451527">:=</span>&nbsp;<span class="ident" id="4451530">err</span><span class="op" id="4451533">.</span><span class="op" id="4451534">(</span><span class="ident" id="4451535">net</span><span class="op" id="4451538">.</span><span class="ident" id="4451539">Error</span><span class="op" id="4451544">)</span><span class="op" id="4451545">;</span>&nbsp;<span class="op" id="4451547">!</span><span class="ident" id="4451548">ok</span>&nbsp;<span class="op" id="4451551">||</span>&nbsp;<span class="op" id="4451554">!</span><span class="ident" id="4451555">e</span><span class="op" id="4451556">.</span><span class="ident" id="4451557">Temporary</span><span class="op" id="4451566">(</span><span class="op" id="4451567">)</span>&nbsp;<span class="op" id="4451569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4451574">c</span><span class="op" id="4451575">.</span><span class="ident" id="4451576">in</span><span class="op" id="4451578">.</span><span class="ident" id="4451579">setErrorLocked</span><span class="op" id="4451593">(</span><span class="ident" id="4451594">err</span><span class="op" id="4451597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4451601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4451605">return</span>&nbsp;<span class="ident" id="4451612">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4451617">}</span><br>
<span class="lineno">595</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4451621">//&nbsp;Process&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4451642">b</span><span class="op" id="4451643">,</span>&nbsp;<span class="ident" id="4451645">c</span><span class="op" id="4451646">.</span><span class="ident" id="4451647">rawInput</span>&nbsp;<span class="op" id="4451656">=</span>&nbsp;<span class="ident" id="4451658">c</span><span class="op" id="4451659">.</span><span class="ident" id="4451660">in</span><span class="op" id="4451662">.</span><span class="ident" id="4451663">splitBlock</span><span class="op" id="4451673">(</span><span class="ident" id="4451674">b</span><span class="op" id="4451675">,</span>&nbsp;<span class="ident" id="4451677">recordHeaderLen</span><span class="op" id="4451692">+</span><span class="ident" id="4451693">n</span><span class="op" id="4451694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4451697">ok</span><span class="op" id="4451699">,</span>&nbsp;<span class="ident" id="4451701">off</span><span class="op" id="4451704">,</span>&nbsp;<span class="ident" id="4451706">err</span>&nbsp;<span class="op" id="4451710">:=</span>&nbsp;<span class="ident" id="4451713">c</span><span class="op" id="4451714">.</span><span class="ident" id="4451715">in</span><span class="op" id="4451717">.</span><span class="ident" id="4451718">decrypt</span><span class="op" id="4451725">(</span><span class="ident" id="4451726">b</span><span class="op" id="4451727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4451730">if</span>&nbsp;<span class="op" id="4451733">!</span><span class="ident" id="4451734">ok</span>&nbsp;<span class="op" id="4451737">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4451741">c</span><span class="op" id="4451742">.</span><span class="ident" id="4451743">in</span><span class="op" id="4451745">.</span><span class="ident" id="4451746">setErrorLocked</span><span class="op" id="4451760">(</span><span class="ident" id="4451761">c</span><span class="op" id="4451762">.</span><span class="ident" id="4451763">sendAlert</span><span class="op" id="4451772">(</span><span class="ident" id="4451773">err</span><span class="op" id="4451776">)</span><span class="op" id="4451777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4451780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4451783">b</span><span class="op" id="4451784">.</span><span class="ident" id="4451785">off</span>&nbsp;<span class="op" id="4451789">=</span>&nbsp;<span class="ident" id="4451791">off</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4451796">data</span>&nbsp;<span class="op" id="4451801">:=</span>&nbsp;<span class="ident" id="4451804">b</span><span class="op" id="4451805">.</span><span class="ident" id="4451806">data</span><span class="op" id="4451810">[</span><span class="ident" id="4451811">b</span><span class="op" id="4451812">.</span><span class="ident" id="4451813">off</span><span class="op" id="4451816">:</span><span class="op" id="4451817">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4451820">if</span>&nbsp;<span class="builtinfunc" id="4451823">len</span><span class="op" id="4451826">(</span><span class="ident" id="4451827">data</span><span class="op" id="4451831">)</span>&nbsp;<span class="op" id="4451833">&gt;</span>&nbsp;<span class="ident" id="4451835">maxPlaintext</span>&nbsp;<span class="op" id="4451848">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4451852">err</span>&nbsp;<span class="op" id="4451856">:=</span>&nbsp;<span class="ident" id="4451859">c</span><span class="op" id="4451860">.</span><span class="ident" id="4451861">sendAlert</span><span class="op" id="4451870">(</span><span class="ident" id="4451871">alertRecordOverflow</span><span class="op" id="4451890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4451894">c</span><span class="op" id="4451895">.</span><span class="ident" id="4451896">in</span><span class="op" id="4451898">.</span><span class="ident" id="4451899">freeBlock</span><span class="op" id="4451908">(</span><span class="ident" id="4451909">b</span><span class="op" id="4451910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4451914">return</span>&nbsp;<span class="ident" id="4451921">c</span><span class="op" id="4451922">.</span><span class="ident" id="4451923">in</span><span class="op" id="4451925">.</span><span class="ident" id="4451926">setErrorLocked</span><span class="op" id="4451940">(</span><span class="ident" id="4451941">err</span><span class="op" id="4451944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4451947">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4451951">switch</span>&nbsp;<span class="ident" id="4451958">typ</span>&nbsp;<span class="op" id="4451962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4451965">default</span><span class="op" id="4451972">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4451976">c</span><span class="op" id="4451977">.</span><span class="ident" id="4451978">in</span><span class="op" id="4451980">.</span><span class="ident" id="4451981">setErrorLocked</span><span class="op" id="4451995">(</span><span class="ident" id="4451996">c</span><span class="op" id="4451997">.</span><span class="ident" id="4451998">sendAlert</span><span class="op" id="4452007">(</span><span class="ident" id="4452008">alertUnexpectedMessage</span><span class="op" id="4452030">)</span><span class="op" id="4452031">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4452035">case</span>&nbsp;<span class="ident" id="4452040">recordTypeAlert</span><span class="op" id="4452055">:</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4452059">if</span>&nbsp;<span class="builtinfunc" id="4452062">len</span><span class="op" id="4452065">(</span><span class="ident" id="4452066">data</span><span class="op" id="4452070">)</span>&nbsp;<span class="op" id="4452072">!=</span>&nbsp;<span class="num" id="4452075">2</span>&nbsp;<span class="op" id="4452077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4452082">c</span><span class="op" id="4452083">.</span><span class="ident" id="4452084">in</span><span class="op" id="4452086">.</span><span class="ident" id="4452087">setErrorLocked</span><span class="op" id="4452101">(</span><span class="ident" id="4452102">c</span><span class="op" id="4452103">.</span><span class="ident" id="4452104">sendAlert</span><span class="op" id="4452113">(</span><span class="ident" id="4452114">alertUnexpectedMessage</span><span class="op" id="4452136">)</span><span class="op" id="4452137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4452142">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4452150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4452154">if</span>&nbsp;<span class="ident" id="4452157">alert</span><span class="op" id="4452162">(</span><span class="ident" id="4452163">data</span><span class="op" id="4452167">[</span><span class="num" id="4452168">1</span><span class="op" id="4452169">]</span><span class="op" id="4452170">)</span>&nbsp;<span class="op" id="4452172">==</span>&nbsp;<span class="ident" id="4452175">alertCloseNotify</span>&nbsp;<span class="op" id="4452192">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4452197">c</span><span class="op" id="4452198">.</span><span class="ident" id="4452199">in</span><span class="op" id="4452201">.</span><span class="ident" id="4452202">setErrorLocked</span><span class="op" id="4452216">(</span><span class="ident" id="4452217">io</span><span class="op" id="4452219">.</span><span class="ident" id="4452220">EOF</span><span class="op" id="4452223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4452228">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4452236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4452240">switch</span>&nbsp;<span class="ident" id="4452247">data</span><span class="op" id="4452251">[</span><span class="num" id="4452252">0</span><span class="op" id="4452253">]</span>&nbsp;<span class="op" id="4452255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4452259">case</span>&nbsp;<span class="ident" id="4452264">alertLevelWarning</span><span class="op" id="4452281">:</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4452286">//&nbsp;drop&nbsp;on&nbsp;the&nbsp;floor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4452310">c</span><span class="op" id="4452311">.</span><span class="ident" id="4452312">in</span><span class="op" id="4452314">.</span><span class="ident" id="4452315">freeBlock</span><span class="op" id="4452324">(</span><span class="ident" id="4452325">b</span><span class="op" id="4452326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4452331">goto</span>&nbsp;<span class="ident" id="4452336">Again</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4452344">case</span>&nbsp;<span class="ident" id="4452349">alertLevelError</span><span class="op" id="4452364">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4452369">c</span><span class="op" id="4452370">.</span><span class="ident" id="4452371">in</span><span class="op" id="4452373">.</span><span class="ident" id="4452374">setErrorLocked</span><span class="op" id="4452388">(</span><span class="op" id="4452389">&amp;</span><span class="ident" id="4452390">net</span><span class="op" id="4452393">.</span><span class="ident" id="4452394">OpError</span><span class="op" id="4452401">{</span><span class="ident" id="4452402">Op</span><span class="op" id="4452404">:</span>&nbsp;<span class="string" id="4452406">&#34;remote&nbsp;error&#34;</span><span class="op" id="4452420">,</span>&nbsp;<span class="ident" id="4452422">Err</span><span class="op" id="4452425">:</span>&nbsp;<span class="ident" id="4452427">alert</span><span class="op" id="4452432">(</span><span class="ident" id="4452433">data</span><span class="op" id="4452437">[</span><span class="num" id="4452438">1</span><span class="op" id="4452439">]</span><span class="op" id="4452440">)</span><span class="op" id="4452441">}</span><span class="op" id="4452442">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4452446">default</span><span class="op" id="4452453">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4452458">c</span><span class="op" id="4452459">.</span><span class="ident" id="4452460">in</span><span class="op" id="4452462">.</span><span class="ident" id="4452463">setErrorLocked</span><span class="op" id="4452477">(</span><span class="ident" id="4452478">c</span><span class="op" id="4452479">.</span><span class="ident" id="4452480">sendAlert</span><span class="op" id="4452489">(</span><span class="ident" id="4452490">alertUnexpectedMessage</span><span class="op" id="4452512">)</span><span class="op" id="4452513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4452517">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4452521">case</span>&nbsp;<span class="ident" id="4452526">recordTypeChangeCipherSpec</span><span class="op" id="4452552">:</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4452556">if</span>&nbsp;<span class="ident" id="4452559">typ</span>&nbsp;<span class="op" id="4452563">!=</span>&nbsp;<span class="ident" id="4452566">want</span>&nbsp;<span class="op" id="4452571">||</span>&nbsp;<span class="builtinfunc" id="4452574">len</span><span class="op" id="4452577">(</span><span class="ident" id="4452578">data</span><span class="op" id="4452582">)</span>&nbsp;<span class="op" id="4452584">!=</span>&nbsp;<span class="num" id="4452587">1</span>&nbsp;<span class="op" id="4452589">||</span>&nbsp;<span class="ident" id="4452592">data</span><span class="op" id="4452596">[</span><span class="num" id="4452597">0</span><span class="op" id="4452598">]</span>&nbsp;<span class="op" id="4452600">!=</span>&nbsp;<span class="num" id="4452603">1</span>&nbsp;<span class="op" id="4452605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4452610">c</span><span class="op" id="4452611">.</span><span class="ident" id="4452612">in</span><span class="op" id="4452614">.</span><span class="ident" id="4452615">setErrorLocked</span><span class="op" id="4452629">(</span><span class="ident" id="4452630">c</span><span class="op" id="4452631">.</span><span class="ident" id="4452632">sendAlert</span><span class="op" id="4452641">(</span><span class="ident" id="4452642">alertUnexpectedMessage</span><span class="op" id="4452664">)</span><span class="op" id="4452665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4452670">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4452678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4452682">err</span>&nbsp;<span class="op" id="4452686">:=</span>&nbsp;<span class="ident" id="4452689">c</span><span class="op" id="4452690">.</span><span class="ident" id="4452691">in</span><span class="op" id="4452693">.</span><span class="ident" id="4452694">changeCipherSpec</span><span class="op" id="4452710">(</span><span class="op" id="4452711">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4452715">if</span>&nbsp;<span class="ident" id="4452718">err</span>&nbsp;<span class="op" id="4452722">!=</span>&nbsp;<span class="ident" id="4452725">nil</span>&nbsp;<span class="op" id="4452729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4452734">c</span><span class="op" id="4452735">.</span><span class="ident" id="4452736">in</span><span class="op" id="4452738">.</span><span class="ident" id="4452739">setErrorLocked</span><span class="op" id="4452753">(</span><span class="ident" id="4452754">c</span><span class="op" id="4452755">.</span><span class="ident" id="4452756">sendAlert</span><span class="op" id="4452765">(</span><span class="ident" id="4452766">err</span><span class="op" id="4452769">.</span><span class="op" id="4452770">(</span><span class="ident" id="4452771">alert</span><span class="op" id="4452776">)</span><span class="op" id="4452777">)</span><span class="op" id="4452778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4452782">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4452786">case</span>&nbsp;<span class="ident" id="4452791">recordTypeApplicationData</span><span class="op" id="4452816">:</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4452820">if</span>&nbsp;<span class="ident" id="4452823">typ</span>&nbsp;<span class="op" id="4452827">!=</span>&nbsp;<span class="ident" id="4452830">want</span>&nbsp;<span class="op" id="4452835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4452840">c</span><span class="op" id="4452841">.</span><span class="ident" id="4452842">in</span><span class="op" id="4452844">.</span><span class="ident" id="4452845">setErrorLocked</span><span class="op" id="4452859">(</span><span class="ident" id="4452860">c</span><span class="op" id="4452861">.</span><span class="ident" id="4452862">sendAlert</span><span class="op" id="4452871">(</span><span class="ident" id="4452872">alertUnexpectedMessage</span><span class="op" id="4452894">)</span><span class="op" id="4452895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4452900">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4452908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4452912">c</span><span class="op" id="4452913">.</span><span class="ident" id="4452914">input</span>&nbsp;<span class="op" id="4452920">=</span>&nbsp;<span class="ident" id="4452922">b</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4452926">b</span>&nbsp;<span class="op" id="4452928">=</span>&nbsp;<span class="ident" id="4452930">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4452936">case</span>&nbsp;<span class="ident" id="4452941">recordTypeHandshake</span><span class="op" id="4452960">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4452964">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;at&nbsp;least&nbsp;pick&nbsp;off&nbsp;connection&nbsp;close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4453023">if</span>&nbsp;<span class="ident" id="4453026">typ</span>&nbsp;<span class="op" id="4453030">!=</span>&nbsp;<span class="ident" id="4453033">want</span>&nbsp;<span class="op" id="4453038">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4453043">return</span>&nbsp;<span class="ident" id="4453050">c</span><span class="op" id="4453051">.</span><span class="ident" id="4453052">in</span><span class="op" id="4453054">.</span><span class="ident" id="4453055">setErrorLocked</span><span class="op" id="4453069">(</span><span class="ident" id="4453070">c</span><span class="op" id="4453071">.</span><span class="ident" id="4453072">sendAlert</span><span class="op" id="4453081">(</span><span class="ident" id="4453082">alertNoRenegotiation</span><span class="op" id="4453102">)</span><span class="op" id="4453103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4453107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4453111">c</span><span class="op" id="4453112">.</span><span class="ident" id="4453113">hand</span><span class="op" id="4453117">.</span><span class="ident" id="4453118">Write</span><span class="op" id="4453123">(</span><span class="ident" id="4453124">data</span><span class="op" id="4453128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4453131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4453135">if</span>&nbsp;<span class="ident" id="4453138">b</span>&nbsp;<span class="op" id="4453140">!=</span>&nbsp;<span class="ident" id="4453143">nil</span>&nbsp;<span class="op" id="4453147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4453151">c</span><span class="op" id="4453152">.</span><span class="ident" id="4453153">in</span><span class="op" id="4453155">.</span><span class="ident" id="4453156">freeBlock</span><span class="op" id="4453165">(</span><span class="ident" id="4453166">b</span><span class="op" id="4453167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4453170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4453173">return</span>&nbsp;<span class="ident" id="4453180">c</span><span class="op" id="4453181">.</span><span class="ident" id="4453182">in</span><span class="op" id="4453184">.</span><span class="ident" id="4453185">err</span><br>
<span class="lineno"></span><span class="op" id="4453189">}</span><br>
<span class="lineno">665</span><br>
<span class="lineno"></span><span class="comment" id="4453192">//&nbsp;sendAlert&nbsp;sends&nbsp;a&nbsp;TLS&nbsp;alert&nbsp;message.</span><br>
<span class="lineno"></span><span class="comment" id="4453232">//&nbsp;c.out.Mutex&nbsp;&lt;=&nbsp;L.</span><br>
<span class="lineno"></span><span class="keyword" id="4453253">func</span>&nbsp;<span class="op" id="4453258">(</span><span class="ident" id="4453259">c</span>&nbsp;<span class="op" id="4453261">*</span><span class="ident" id="4453262">Conn</span><span class="op" id="4453266">)</span>&nbsp;<span class="ident" id="4453268">sendAlertLocked</span><span class="op" id="4453283">(</span><span class="ident" id="4453284">err</span>&nbsp;<span class="ident" id="4453288">alert</span><span class="op" id="4453293">)</span>&nbsp;<span class="builtintype" id="4453295">error</span>&nbsp;<span class="op" id="4453301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4453304">switch</span>&nbsp;<span class="ident" id="4453311">err</span>&nbsp;<span class="op" id="4453315">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4453318">case</span>&nbsp;<span class="ident" id="4453323">alertNoRenegotiation</span><span class="op" id="4453343">,</span>&nbsp;<span class="ident" id="4453345">alertCloseNotify</span><span class="op" id="4453361">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4453365">c</span><span class="op" id="4453366">.</span><span class="ident" id="4453367">tmp</span><span class="op" id="4453370">[</span><span class="num" id="4453371">0</span><span class="op" id="4453372">]</span>&nbsp;<span class="op" id="4453374">=</span>&nbsp;<span class="ident" id="4453376">alertLevelWarning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4453395">default</span><span class="op" id="4453402">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4453406">c</span><span class="op" id="4453407">.</span><span class="ident" id="4453408">tmp</span><span class="op" id="4453411">[</span><span class="num" id="4453412">0</span><span class="op" id="4453413">]</span>&nbsp;<span class="op" id="4453415">=</span>&nbsp;<span class="ident" id="4453417">alertLevelError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4453434">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4453437">c</span><span class="op" id="4453438">.</span><span class="ident" id="4453439">tmp</span><span class="op" id="4453442">[</span><span class="num" id="4453443">1</span><span class="op" id="4453444">]</span>&nbsp;<span class="op" id="4453446">=</span>&nbsp;<span class="builtintype" id="4453448">byte</span><span class="op" id="4453452">(</span><span class="ident" id="4453453">err</span><span class="op" id="4453456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4453459">c</span><span class="op" id="4453460">.</span><span class="ident" id="4453461">writeRecord</span><span class="op" id="4453472">(</span><span class="ident" id="4453473">recordTypeAlert</span><span class="op" id="4453488">,</span>&nbsp;<span class="ident" id="4453490">c</span><span class="op" id="4453491">.</span><span class="ident" id="4453492">tmp</span><span class="op" id="4453495">[</span><span class="num" id="4453496">0</span><span class="op" id="4453497">:</span><span class="num" id="4453498">2</span><span class="op" id="4453499">]</span><span class="op" id="4453500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4453503">//&nbsp;closeNotify&nbsp;is&nbsp;a&nbsp;special&nbsp;case&nbsp;in&nbsp;that&nbsp;it&nbsp;isn&#39;t&nbsp;an&nbsp;error:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4453564">if</span>&nbsp;<span class="ident" id="4453567">err</span>&nbsp;<span class="op" id="4453571">!=</span>&nbsp;<span class="ident" id="4453574">alertCloseNotify</span>&nbsp;<span class="op" id="4453591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4453595">return</span>&nbsp;<span class="ident" id="4453602">c</span><span class="op" id="4453603">.</span><span class="ident" id="4453604">out</span><span class="op" id="4453607">.</span><span class="ident" id="4453608">setErrorLocked</span><span class="op" id="4453622">(</span><span class="op" id="4453623">&amp;</span><span class="ident" id="4453624">net</span><span class="op" id="4453627">.</span><span class="ident" id="4453628">OpError</span><span class="op" id="4453635">{</span><span class="ident" id="4453636">Op</span><span class="op" id="4453638">:</span>&nbsp;<span class="string" id="4453640">&#34;local&nbsp;error&#34;</span><span class="op" id="4453653">,</span>&nbsp;<span class="ident" id="4453655">Err</span><span class="op" id="4453658">:</span>&nbsp;<span class="ident" id="4453660">err</span><span class="op" id="4453663">}</span><span class="op" id="4453664">)</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4453667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4453670">return</span>&nbsp;<span class="ident" id="4453677">nil</span><br>
<span class="lineno"></span><span class="op" id="4453681">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4453684">//&nbsp;sendAlert&nbsp;sends&nbsp;a&nbsp;TLS&nbsp;alert&nbsp;message.</span><br>
<span class="lineno">685</span><span class="comment" id="4453724">//&nbsp;L&nbsp;&lt;&nbsp;c.out.Mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="4453744">func</span>&nbsp;<span class="op" id="4453749">(</span><span class="ident" id="4453750">c</span>&nbsp;<span class="op" id="4453752">*</span><span class="ident" id="4453753">Conn</span><span class="op" id="4453757">)</span>&nbsp;<span class="ident" id="4453759">sendAlert</span><span class="op" id="4453768">(</span><span class="ident" id="4453769">err</span>&nbsp;<span class="ident" id="4453773">alert</span><span class="op" id="4453778">)</span>&nbsp;<span class="builtintype" id="4453780">error</span>&nbsp;<span class="op" id="4453786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4453789">c</span><span class="op" id="4453790">.</span><span class="ident" id="4453791">out</span><span class="op" id="4453794">.</span><span class="ident" id="4453795">Lock</span><span class="op" id="4453799">(</span><span class="op" id="4453800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4453803">defer</span>&nbsp;<span class="ident" id="4453809">c</span><span class="op" id="4453810">.</span><span class="ident" id="4453811">out</span><span class="op" id="4453814">.</span><span class="ident" id="4453815">Unlock</span><span class="op" id="4453821">(</span><span class="op" id="4453822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4453825">return</span>&nbsp;<span class="ident" id="4453832">c</span><span class="op" id="4453833">.</span><span class="ident" id="4453834">sendAlertLocked</span><span class="op" id="4453849">(</span><span class="ident" id="4453850">err</span><span class="op" id="4453853">)</span><br>
<span class="lineno">690</span><span class="op" id="4453855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4453858">//&nbsp;writeRecord&nbsp;writes&nbsp;a&nbsp;TLS&nbsp;record&nbsp;with&nbsp;the&nbsp;given&nbsp;type&nbsp;and&nbsp;payload</span><br>
<span class="lineno"></span><span class="comment" id="4453925">//&nbsp;to&nbsp;the&nbsp;connection&nbsp;and&nbsp;updates&nbsp;the&nbsp;record&nbsp;layer&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="4453982">//&nbsp;c.out.Mutex&nbsp;&lt;=&nbsp;L.</span><br>
<span class="lineno">695</span><span class="keyword" id="4454003">func</span>&nbsp;<span class="op" id="4454008">(</span><span class="ident" id="4454009">c</span>&nbsp;<span class="op" id="4454011">*</span><span class="ident" id="4454012">Conn</span><span class="op" id="4454016">)</span>&nbsp;<span class="ident" id="4454018">writeRecord</span><span class="op" id="4454029">(</span><span class="ident" id="4454030">typ</span>&nbsp;<span class="ident" id="4454034">recordType</span><span class="op" id="4454044">,</span>&nbsp;<span class="ident" id="4454046">data</span>&nbsp;<span class="op" id="4454051">[</span><span class="op" id="4454052">]</span><span class="builtintype" id="4454053">byte</span><span class="op" id="4454057">)</span>&nbsp;<span class="op" id="4454059">(</span><span class="ident" id="4454060">n</span>&nbsp;<span class="builtintype" id="4454062">int</span><span class="op" id="4454065">,</span>&nbsp;<span class="ident" id="4454067">err</span>&nbsp;<span class="builtintype" id="4454071">error</span><span class="op" id="4454076">)</span>&nbsp;<span class="op" id="4454078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4454081">b</span>&nbsp;<span class="op" id="4454083">:=</span>&nbsp;<span class="ident" id="4454086">c</span><span class="op" id="4454087">.</span><span class="ident" id="4454088">out</span><span class="op" id="4454091">.</span><span class="ident" id="4454092">newBlock</span><span class="op" id="4454100">(</span><span class="op" id="4454101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4454104">for</span>&nbsp;<span class="builtinfunc" id="4454108">len</span><span class="op" id="4454111">(</span><span class="ident" id="4454112">data</span><span class="op" id="4454116">)</span>&nbsp;<span class="op" id="4454118">&gt;</span>&nbsp;<span class="num" id="4454120">0</span>&nbsp;<span class="op" id="4454122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4454126">m</span>&nbsp;<span class="op" id="4454128">:=</span>&nbsp;<span class="builtinfunc" id="4454131">len</span><span class="op" id="4454134">(</span><span class="ident" id="4454135">data</span><span class="op" id="4454139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4454143">if</span>&nbsp;<span class="ident" id="4454146">m</span>&nbsp;<span class="op" id="4454148">&gt;</span>&nbsp;<span class="ident" id="4454150">maxPlaintext</span>&nbsp;<span class="op" id="4454163">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4454168">m</span>&nbsp;<span class="op" id="4454170">=</span>&nbsp;<span class="ident" id="4454172">maxPlaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4454187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4454191">explicitIVLen</span>&nbsp;<span class="op" id="4454205">:=</span>&nbsp;<span class="num" id="4454208">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4454212">explicitIVIsSeq</span>&nbsp;<span class="op" id="4454228">:=</span>&nbsp;<span class="builtintype" id="4454231">false</span><br>
<span class="lineno"></span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4454240">var</span>&nbsp;<span class="ident" id="4454244">cbc</span>&nbsp;<span class="ident" id="4454248">cbcMode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4454258">if</span>&nbsp;<span class="ident" id="4454261">c</span><span class="op" id="4454262">.</span><span class="ident" id="4454263">out</span><span class="op" id="4454266">.</span><span class="ident" id="4454267">version</span>&nbsp;<span class="op" id="4454275">&gt;=</span>&nbsp;<span class="ident" id="4454278">VersionTLS11</span>&nbsp;<span class="op" id="4454291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4454296">var</span>&nbsp;<span class="ident" id="4454300">ok</span>&nbsp;<span class="builtintype" id="4454303">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4454311">if</span>&nbsp;<span class="ident" id="4454314">cbc</span><span class="op" id="4454317">,</span>&nbsp;<span class="ident" id="4454319">ok</span>&nbsp;<span class="op" id="4454322">=</span>&nbsp;<span class="ident" id="4454324">c</span><span class="op" id="4454325">.</span><span class="ident" id="4454326">out</span><span class="op" id="4454329">.</span><span class="ident" id="4454330">cipher</span><span class="op" id="4454336">.</span><span class="op" id="4454337">(</span><span class="ident" id="4454338">cbcMode</span><span class="op" id="4454345">)</span><span class="op" id="4454346">;</span>&nbsp;<span class="ident" id="4454348">ok</span>&nbsp;<span class="op" id="4454351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4454357">explicitIVLen</span>&nbsp;<span class="op" id="4454371">=</span>&nbsp;<span class="ident" id="4454373">cbc</span><span class="op" id="4454376">.</span><span class="ident" id="4454377">BlockSize</span><span class="op" id="4454386">(</span><span class="op" id="4454387">)</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4454392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4454396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4454400">if</span>&nbsp;<span class="ident" id="4454403">explicitIVLen</span>&nbsp;<span class="op" id="4454417">==</span>&nbsp;<span class="num" id="4454420">0</span>&nbsp;<span class="op" id="4454422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4454427">if</span>&nbsp;<span class="ident" id="4454430">_</span><span class="op" id="4454431">,</span>&nbsp;<span class="ident" id="4454433">ok</span>&nbsp;<span class="op" id="4454436">:=</span>&nbsp;<span class="ident" id="4454439">c</span><span class="op" id="4454440">.</span><span class="ident" id="4454441">out</span><span class="op" id="4454444">.</span><span class="ident" id="4454445">cipher</span><span class="op" id="4454451">.</span><span class="op" id="4454452">(</span><span class="ident" id="4454453">cipher</span><span class="op" id="4454459">.</span><span class="ident" id="4454460">AEAD</span><span class="op" id="4454464">)</span><span class="op" id="4454465">;</span>&nbsp;<span class="ident" id="4454467">ok</span>&nbsp;<span class="op" id="4454470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4454476">explicitIVLen</span>&nbsp;<span class="op" id="4454490">=</span>&nbsp;<span class="num" id="4454492">8</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4454498">//&nbsp;The&nbsp;AES-GCM&nbsp;construction&nbsp;in&nbsp;TLS&nbsp;has&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4454544">//&nbsp;explicit&nbsp;nonce&nbsp;so&nbsp;that&nbsp;the&nbsp;nonce&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4454591">//&nbsp;random.&nbsp;However,&nbsp;the&nbsp;nonce&nbsp;is&nbsp;only&nbsp;8&nbsp;bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4454641">//&nbsp;which&nbsp;is&nbsp;too&nbsp;small&nbsp;for&nbsp;a&nbsp;secure,&nbsp;random</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4454688">//&nbsp;nonce.&nbsp;Therefore&nbsp;we&nbsp;use&nbsp;the&nbsp;sequence&nbsp;number</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4454739">//&nbsp;as&nbsp;the&nbsp;nonce.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4454760">explicitIVIsSeq</span>&nbsp;<span class="op" id="4454776">=</span>&nbsp;<span class="builtintype" id="4454778">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4454786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4454790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4454794">b</span><span class="op" id="4454795">.</span><span class="ident" id="4454796">resize</span><span class="op" id="4454802">(</span><span class="ident" id="4454803">recordHeaderLen</span>&nbsp;<span class="op" id="4454819">+</span>&nbsp;<span class="ident" id="4454821">explicitIVLen</span>&nbsp;<span class="op" id="4454835">+</span>&nbsp;<span class="ident" id="4454837">m</span><span class="op" id="4454838">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4454842">b</span><span class="op" id="4454843">.</span><span class="ident" id="4454844">data</span><span class="op" id="4454848">[</span><span class="num" id="4454849">0</span><span class="op" id="4454850">]</span>&nbsp;<span class="op" id="4454852">=</span>&nbsp;<span class="builtintype" id="4454854">byte</span><span class="op" id="4454858">(</span><span class="ident" id="4454859">typ</span><span class="op" id="4454862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4454866">vers</span>&nbsp;<span class="op" id="4454871">:=</span>&nbsp;<span class="ident" id="4454874">c</span><span class="op" id="4454875">.</span><span class="ident" id="4454876">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4454883">if</span>&nbsp;<span class="ident" id="4454886">vers</span>&nbsp;<span class="op" id="4454891">==</span>&nbsp;<span class="num" id="4454894">0</span>&nbsp;<span class="op" id="4454896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4454901">//&nbsp;Some&nbsp;TLS&nbsp;servers&nbsp;fail&nbsp;if&nbsp;the&nbsp;record&nbsp;version&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4454954">//&nbsp;greater&nbsp;than&nbsp;TLS&nbsp;1.0&nbsp;for&nbsp;the&nbsp;initial&nbsp;ClientHello.</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4455010">vers</span>&nbsp;<span class="op" id="4455015">=</span>&nbsp;<span class="ident" id="4455017">VersionTLS10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4455032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4455036">b</span><span class="op" id="4455037">.</span><span class="ident" id="4455038">data</span><span class="op" id="4455042">[</span><span class="num" id="4455043">1</span><span class="op" id="4455044">]</span>&nbsp;<span class="op" id="4455046">=</span>&nbsp;<span class="builtintype" id="4455048">byte</span><span class="op" id="4455052">(</span><span class="ident" id="4455053">vers</span>&nbsp;<span class="op" id="4455058">&gt;&gt;</span>&nbsp;<span class="num" id="4455061">8</span><span class="op" id="4455062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4455066">b</span><span class="op" id="4455067">.</span><span class="ident" id="4455068">data</span><span class="op" id="4455072">[</span><span class="num" id="4455073">2</span><span class="op" id="4455074">]</span>&nbsp;<span class="op" id="4455076">=</span>&nbsp;<span class="builtintype" id="4455078">byte</span><span class="op" id="4455082">(</span><span class="ident" id="4455083">vers</span><span class="op" id="4455087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4455091">b</span><span class="op" id="4455092">.</span><span class="ident" id="4455093">data</span><span class="op" id="4455097">[</span><span class="num" id="4455098">3</span><span class="op" id="4455099">]</span>&nbsp;<span class="op" id="4455101">=</span>&nbsp;<span class="builtintype" id="4455103">byte</span><span class="op" id="4455107">(</span><span class="ident" id="4455108">m</span>&nbsp;<span class="op" id="4455110">&gt;&gt;</span>&nbsp;<span class="num" id="4455113">8</span><span class="op" id="4455114">)</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4455118">b</span><span class="op" id="4455119">.</span><span class="ident" id="4455120">data</span><span class="op" id="4455124">[</span><span class="num" id="4455125">4</span><span class="op" id="4455126">]</span>&nbsp;<span class="op" id="4455128">=</span>&nbsp;<span class="builtintype" id="4455130">byte</span><span class="op" id="4455134">(</span><span class="ident" id="4455135">m</span><span class="op" id="4455136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4455140">if</span>&nbsp;<span class="ident" id="4455143">explicitIVLen</span>&nbsp;<span class="op" id="4455157">&gt;</span>&nbsp;<span class="num" id="4455159">0</span>&nbsp;<span class="op" id="4455161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4455166">explicitIV</span>&nbsp;<span class="op" id="4455177">:=</span>&nbsp;<span class="ident" id="4455180">b</span><span class="op" id="4455181">.</span><span class="ident" id="4455182">data</span><span class="op" id="4455186">[</span><span class="ident" id="4455187">recordHeaderLen</span>&nbsp;<span class="op" id="4455203">:</span>&nbsp;<span class="ident" id="4455205">recordHeaderLen</span><span class="op" id="4455220">+</span><span class="ident" id="4455221">explicitIVLen</span><span class="op" id="4455234">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4455239">if</span>&nbsp;<span class="ident" id="4455242">explicitIVIsSeq</span>&nbsp;<span class="op" id="4455258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4455264">copy</span><span class="op" id="4455268">(</span><span class="ident" id="4455269">explicitIV</span><span class="op" id="4455279">,</span>&nbsp;<span class="ident" id="4455281">c</span><span class="op" id="4455282">.</span><span class="ident" id="4455283">out</span><span class="op" id="4455286">.</span><span class="ident" id="4455287">seq</span><span class="op" id="4455290">[</span><span class="op" id="4455291">:</span><span class="op" id="4455292">]</span><span class="op" id="4455293">)</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4455298">}</span>&nbsp;<span class="keyword" id="4455300">else</span>&nbsp;<span class="op" id="4455305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4455311">if</span>&nbsp;<span class="ident" id="4455314">_</span><span class="op" id="4455315">,</span>&nbsp;<span class="ident" id="4455317">err</span>&nbsp;<span class="op" id="4455321">=</span>&nbsp;<span class="ident" id="4455323">io</span><span class="op" id="4455325">.</span><span class="ident" id="4455326">ReadFull</span><span class="op" id="4455334">(</span><span class="ident" id="4455335">c</span><span class="op" id="4455336">.</span><span class="ident" id="4455337">config</span><span class="op" id="4455343">.</span><span class="ident" id="4455344">rand</span><span class="op" id="4455348">(</span><span class="op" id="4455349">)</span><span class="op" id="4455350">,</span>&nbsp;<span class="ident" id="4455352">explicitIV</span><span class="op" id="4455362">)</span><span class="op" id="4455363">;</span>&nbsp;<span class="ident" id="4455365">err</span>&nbsp;<span class="op" id="4455369">!=</span>&nbsp;<span class="ident" id="4455372">nil</span>&nbsp;<span class="op" id="4455376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4455383">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4455393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4455398">}</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4455402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4455406">copy</span><span class="op" id="4455410">(</span><span class="ident" id="4455411">b</span><span class="op" id="4455412">.</span><span class="ident" id="4455413">data</span><span class="op" id="4455417">[</span><span class="ident" id="4455418">recordHeaderLen</span><span class="op" id="4455433">+</span><span class="ident" id="4455434">explicitIVLen</span><span class="op" id="4455447">:</span><span class="op" id="4455448">]</span><span class="op" id="4455449">,</span>&nbsp;<span class="ident" id="4455451">data</span><span class="op" id="4455455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4455459">c</span><span class="op" id="4455460">.</span><span class="ident" id="4455461">out</span><span class="op" id="4455464">.</span><span class="ident" id="4455465">encrypt</span><span class="op" id="4455472">(</span><span class="ident" id="4455473">b</span><span class="op" id="4455474">,</span>&nbsp;<span class="ident" id="4455476">explicitIVLen</span><span class="op" id="4455489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4455493">_</span><span class="op" id="4455494">,</span>&nbsp;<span class="ident" id="4455496">err</span>&nbsp;<span class="op" id="4455500">=</span>&nbsp;<span class="ident" id="4455502">c</span><span class="op" id="4455503">.</span><span class="ident" id="4455504">conn</span><span class="op" id="4455508">.</span><span class="ident" id="4455509">Write</span><span class="op" id="4455514">(</span><span class="ident" id="4455515">b</span><span class="op" id="4455516">.</span><span class="ident" id="4455517">data</span><span class="op" id="4455521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4455525">if</span>&nbsp;<span class="ident" id="4455528">err</span>&nbsp;<span class="op" id="4455532">!=</span>&nbsp;<span class="ident" id="4455535">nil</span>&nbsp;<span class="op" id="4455539">{</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4455544">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4455552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4455556">n</span>&nbsp;<span class="op" id="4455558">+=</span>&nbsp;<span class="ident" id="4455561">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4455565">data</span>&nbsp;<span class="op" id="4455570">=</span>&nbsp;<span class="ident" id="4455572">data</span><span class="op" id="4455576">[</span><span class="ident" id="4455577">m</span><span class="op" id="4455578">:</span><span class="op" id="4455579">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4455582">}</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4455585">c</span><span class="op" id="4455586">.</span><span class="ident" id="4455587">out</span><span class="op" id="4455590">.</span><span class="ident" id="4455591">freeBlock</span><span class="op" id="4455600">(</span><span class="ident" id="4455601">b</span><span class="op" id="4455602">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4455606">if</span>&nbsp;<span class="ident" id="4455609">typ</span>&nbsp;<span class="op" id="4455613">==</span>&nbsp;<span class="ident" id="4455616">recordTypeChangeCipherSpec</span>&nbsp;<span class="op" id="4455643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4455647">err</span>&nbsp;<span class="op" id="4455651">=</span>&nbsp;<span class="ident" id="4455653">c</span><span class="op" id="4455654">.</span><span class="ident" id="4455655">out</span><span class="op" id="4455658">.</span><span class="ident" id="4455659">changeCipherSpec</span><span class="op" id="4455675">(</span><span class="op" id="4455676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4455680">if</span>&nbsp;<span class="ident" id="4455683">err</span>&nbsp;<span class="op" id="4455687">!=</span>&nbsp;<span class="ident" id="4455690">nil</span>&nbsp;<span class="op" id="4455694">{</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4455699">//&nbsp;Cannot&nbsp;call&nbsp;sendAlert&nbsp;directly,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4455737">//&nbsp;because&nbsp;we&nbsp;already&nbsp;hold&nbsp;c.out.Mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4455780">c</span><span class="op" id="4455781">.</span><span class="ident" id="4455782">tmp</span><span class="op" id="4455785">[</span><span class="num" id="4455786">0</span><span class="op" id="4455787">]</span>&nbsp;<span class="op" id="4455789">=</span>&nbsp;<span class="ident" id="4455791">alertLevelError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4455810">c</span><span class="op" id="4455811">.</span><span class="ident" id="4455812">tmp</span><span class="op" id="4455815">[</span><span class="num" id="4455816">1</span><span class="op" id="4455817">]</span>&nbsp;<span class="op" id="4455819">=</span>&nbsp;<span class="builtintype" id="4455821">byte</span><span class="op" id="4455825">(</span><span class="ident" id="4455826">err</span><span class="op" id="4455829">.</span><span class="op" id="4455830">(</span><span class="ident" id="4455831">alert</span><span class="op" id="4455836">)</span><span class="op" id="4455837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4455842">c</span><span class="op" id="4455843">.</span><span class="ident" id="4455844">writeRecord</span><span class="op" id="4455855">(</span><span class="ident" id="4455856">recordTypeAlert</span><span class="op" id="4455871">,</span>&nbsp;<span class="ident" id="4455873">c</span><span class="op" id="4455874">.</span><span class="ident" id="4455875">tmp</span><span class="op" id="4455878">[</span><span class="num" id="4455879">0</span><span class="op" id="4455880">:</span><span class="num" id="4455881">2</span><span class="op" id="4455882">]</span><span class="op" id="4455883">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4455888">return</span>&nbsp;<span class="ident" id="4455895">n</span><span class="op" id="4455896">,</span>&nbsp;<span class="ident" id="4455898">c</span><span class="op" id="4455899">.</span><span class="ident" id="4455900">out</span><span class="op" id="4455903">.</span><span class="ident" id="4455904">setErrorLocked</span><span class="op" id="4455918">(</span><span class="op" id="4455919">&amp;</span><span class="ident" id="4455920">net</span><span class="op" id="4455923">.</span><span class="ident" id="4455924">OpError</span><span class="op" id="4455931">{</span><span class="ident" id="4455932">Op</span><span class="op" id="4455934">:</span>&nbsp;<span class="string" id="4455936">&#34;local&nbsp;error&#34;</span><span class="op" id="4455949">,</span>&nbsp;<span class="ident" id="4455951">Err</span><span class="op" id="4455954">:</span>&nbsp;<span class="ident" id="4455956">err</span><span class="op" id="4455959">}</span><span class="op" id="4455960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4455964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4455967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4455970">return</span><br>
<span class="lineno"></span><span class="op" id="4455977">}</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span><span class="comment" id="4455980">//&nbsp;readHandshake&nbsp;reads&nbsp;the&nbsp;next&nbsp;handshake&nbsp;message&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="4456035">//&nbsp;the&nbsp;record&nbsp;layer.</span><br>
<span class="lineno"></span><span class="comment" id="4456056">//&nbsp;c.in.Mutex&nbsp;&lt;&nbsp;L;&nbsp;c.out.Mutex&nbsp;&lt;&nbsp;L.</span><br>
<span class="lineno"></span><span class="keyword" id="4456092">func</span>&nbsp;<span class="op" id="4456097">(</span><span class="ident" id="4456098">c</span>&nbsp;<span class="op" id="4456100">*</span><span class="ident" id="4456101">Conn</span><span class="op" id="4456105">)</span>&nbsp;<span class="ident" id="4456107">readHandshake</span><span class="op" id="4456120">(</span><span class="op" id="4456121">)</span>&nbsp;<span class="op" id="4456123">(</span><span class="keyword" id="4456124">interface</span><span class="op" id="4456133">{</span><span class="op" id="4456134">}</span><span class="op" id="4456135">,</span>&nbsp;<span class="builtintype" id="4456137">error</span><span class="op" id="4456142">)</span>&nbsp;<span class="op" id="4456144">{</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4456147">for</span>&nbsp;<span class="ident" id="4456151">c</span><span class="op" id="4456152">.</span><span class="ident" id="4456153">hand</span><span class="op" id="4456157">.</span><span class="ident" id="4456158">Len</span><span class="op" id="4456161">(</span><span class="op" id="4456162">)</span>&nbsp;<span class="op" id="4456164">&lt;</span>&nbsp;<span class="num" id="4456166">4</span>&nbsp;<span class="op" id="4456168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4456172">if</span>&nbsp;<span class="ident" id="4456175">err</span>&nbsp;<span class="op" id="4456179">:=</span>&nbsp;<span class="ident" id="4456182">c</span><span class="op" id="4456183">.</span><span class="ident" id="4456184">in</span><span class="op" id="4456186">.</span><span class="ident" id="4456187">err</span><span class="op" id="4456190">;</span>&nbsp;<span class="ident" id="4456192">err</span>&nbsp;<span class="op" id="4456196">!=</span>&nbsp;<span class="ident" id="4456199">nil</span>&nbsp;<span class="op" id="4456203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4456208">return</span>&nbsp;<span class="ident" id="4456215">nil</span><span class="op" id="4456218">,</span>&nbsp;<span class="ident" id="4456220">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4456226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4456230">if</span>&nbsp;<span class="ident" id="4456233">err</span>&nbsp;<span class="op" id="4456237">:=</span>&nbsp;<span class="ident" id="4456240">c</span><span class="op" id="4456241">.</span><span class="ident" id="4456242">readRecord</span><span class="op" id="4456252">(</span><span class="ident" id="4456253">recordTypeHandshake</span><span class="op" id="4456272">)</span><span class="op" id="4456273">;</span>&nbsp;<span class="ident" id="4456275">err</span>&nbsp;<span class="op" id="4456279">!=</span>&nbsp;<span class="ident" id="4456282">nil</span>&nbsp;<span class="op" id="4456286">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4456291">return</span>&nbsp;<span class="ident" id="4456298">nil</span><span class="op" id="4456301">,</span>&nbsp;<span class="ident" id="4456303">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4456309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4456312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4456316">data</span>&nbsp;<span class="op" id="4456321">:=</span>&nbsp;<span class="ident" id="4456324">c</span><span class="op" id="4456325">.</span><span class="ident" id="4456326">hand</span><span class="op" id="4456330">.</span><span class="ident" id="4456331">Bytes</span><span class="op" id="4456336">(</span><span class="op" id="4456337">)</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4456340">n</span>&nbsp;<span class="op" id="4456342">:=</span>&nbsp;<span class="builtintype" id="4456345">int</span><span class="op" id="4456348">(</span><span class="ident" id="4456349">data</span><span class="op" id="4456353">[</span><span class="num" id="4456354">1</span><span class="op" id="4456355">]</span><span class="op" id="4456356">)</span><span class="op" id="4456357">&lt;&lt;</span><span class="num" id="4456359">16</span>&nbsp;<span class="op" id="4456362">|</span>&nbsp;<span class="builtintype" id="4456364">int</span><span class="op" id="4456367">(</span><span class="ident" id="4456368">data</span><span class="op" id="4456372">[</span><span class="num" id="4456373">2</span><span class="op" id="4456374">]</span><span class="op" id="4456375">)</span><span class="op" id="4456376">&lt;&lt;</span><span class="num" id="4456378">8</span>&nbsp;<span class="op" id="4456380">|</span>&nbsp;<span class="builtintype" id="4456382">int</span><span class="op" id="4456385">(</span><span class="ident" id="4456386">data</span><span class="op" id="4456390">[</span><span class="num" id="4456391">3</span><span class="op" id="4456392">]</span><span class="op" id="4456393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4456396">if</span>&nbsp;<span class="ident" id="4456399">n</span>&nbsp;<span class="op" id="4456401">&gt;</span>&nbsp;<span class="ident" id="4456403">maxHandshake</span>&nbsp;<span class="op" id="4456416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4456420">return</span>&nbsp;<span class="ident" id="4456427">nil</span><span class="op" id="4456430">,</span>&nbsp;<span class="ident" id="4456432">c</span><span class="op" id="4456433">.</span><span class="ident" id="4456434">in</span><span class="op" id="4456436">.</span><span class="ident" id="4456437">setErrorLocked</span><span class="op" id="4456451">(</span><span class="ident" id="4456452">c</span><span class="op" id="4456453">.</span><span class="ident" id="4456454">sendAlert</span><span class="op" id="4456463">(</span><span class="ident" id="4456464">alertInternalError</span><span class="op" id="4456482">)</span><span class="op" id="4456483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4456486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4456489">for</span>&nbsp;<span class="ident" id="4456493">c</span><span class="op" id="4456494">.</span><span class="ident" id="4456495">hand</span><span class="op" id="4456499">.</span><span class="ident" id="4456500">Len</span><span class="op" id="4456503">(</span><span class="op" id="4456504">)</span>&nbsp;<span class="op" id="4456506">&lt;</span>&nbsp;<span class="num" id="4456508">4</span><span class="op" id="4456509">+</span><span class="ident" id="4456510">n</span>&nbsp;<span class="op" id="4456512">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4456516">if</span>&nbsp;<span class="ident" id="4456519">err</span>&nbsp;<span class="op" id="4456523">:=</span>&nbsp;<span class="ident" id="4456526">c</span><span class="op" id="4456527">.</span><span class="ident" id="4456528">in</span><span class="op" id="4456530">.</span><span class="ident" id="4456531">err</span><span class="op" id="4456534">;</span>&nbsp;<span class="ident" id="4456536">err</span>&nbsp;<span class="op" id="4456540">!=</span>&nbsp;<span class="ident" id="4456543">nil</span>&nbsp;<span class="op" id="4456547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4456552">return</span>&nbsp;<span class="ident" id="4456559">nil</span><span class="op" id="4456562">,</span>&nbsp;<span class="ident" id="4456564">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4456570">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4456574">if</span>&nbsp;<span class="ident" id="4456577">err</span>&nbsp;<span class="op" id="4456581">:=</span>&nbsp;<span class="ident" id="4456584">c</span><span class="op" id="4456585">.</span><span class="ident" id="4456586">readRecord</span><span class="op" id="4456596">(</span><span class="ident" id="4456597">recordTypeHandshake</span><span class="op" id="4456616">)</span><span class="op" id="4456617">;</span>&nbsp;<span class="ident" id="4456619">err</span>&nbsp;<span class="op" id="4456623">!=</span>&nbsp;<span class="ident" id="4456626">nil</span>&nbsp;<span class="op" id="4456630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4456635">return</span>&nbsp;<span class="ident" id="4456642">nil</span><span class="op" id="4456645">,</span>&nbsp;<span class="ident" id="4456647">err</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4456653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4456656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4456659">data</span>&nbsp;<span class="op" id="4456664">=</span>&nbsp;<span class="ident" id="4456666">c</span><span class="op" id="4456667">.</span><span class="ident" id="4456668">hand</span><span class="op" id="4456672">.</span><span class="ident" id="4456673">Next</span><span class="op" id="4456677">(</span><span class="num" id="4456678">4</span>&nbsp;<span class="op" id="4456680">+</span>&nbsp;<span class="ident" id="4456682">n</span><span class="op" id="4456683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4456686">var</span>&nbsp;<span class="ident" id="4456690">m</span>&nbsp;<span class="ident" id="4456692">handshakeMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4456710">switch</span>&nbsp;<span class="ident" id="4456717">data</span><span class="op" id="4456721">[</span><span class="num" id="4456722">0</span><span class="op" id="4456723">]</span>&nbsp;<span class="op" id="4456725">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4456728">case</span>&nbsp;<span class="ident" id="4456733">typeClientHello</span><span class="op" id="4456748">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4456752">m</span>&nbsp;<span class="op" id="4456754">=</span>&nbsp;<span class="builtinfunc" id="4456756">new</span><span class="op" id="4456759">(</span><span class="ident" id="4456760">clientHelloMsg</span><span class="op" id="4456774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4456777">case</span>&nbsp;<span class="ident" id="4456782">typeServerHello</span><span class="op" id="4456797">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4456801">m</span>&nbsp;<span class="op" id="4456803">=</span>&nbsp;<span class="builtinfunc" id="4456805">new</span><span class="op" id="4456808">(</span><span class="ident" id="4456809">serverHelloMsg</span><span class="op" id="4456823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4456826">case</span>&nbsp;<span class="ident" id="4456831">typeNewSessionTicket</span><span class="op" id="4456851">:</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4456855">m</span>&nbsp;<span class="op" id="4456857">=</span>&nbsp;<span class="builtinfunc" id="4456859">new</span><span class="op" id="4456862">(</span><span class="ident" id="4456863">newSessionTicketMsg</span><span class="op" id="4456882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4456885">case</span>&nbsp;<span class="ident" id="4456890">typeCertificate</span><span class="op" id="4456905">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4456909">m</span>&nbsp;<span class="op" id="4456911">=</span>&nbsp;<span class="builtinfunc" id="4456913">new</span><span class="op" id="4456916">(</span><span class="ident" id="4456917">certificateMsg</span><span class="op" id="4456931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4456934">case</span>&nbsp;<span class="ident" id="4456939">typeCertificateRequest</span><span class="op" id="4456961">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4456965">m</span>&nbsp;<span class="op" id="4456967">=</span>&nbsp;<span class="op" id="4456969">&amp;</span><span class="ident" id="4456970">certificateRequestMsg</span><span class="op" id="4456991">{</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4456996">hasSignatureAndHash</span><span class="op" id="4457015">:</span>&nbsp;<span class="ident" id="4457017">c</span><span class="op" id="4457018">.</span><span class="ident" id="4457019">vers</span>&nbsp;<span class="op" id="4457024">&gt;=</span>&nbsp;<span class="ident" id="4457027">VersionTLS12</span><span class="op" id="4457039">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4457043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4457046">case</span>&nbsp;<span class="ident" id="4457051">typeCertificateStatus</span><span class="op" id="4457072">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4457076">m</span>&nbsp;<span class="op" id="4457078">=</span>&nbsp;<span class="builtinfunc" id="4457080">new</span><span class="op" id="4457083">(</span><span class="ident" id="4457084">certificateStatusMsg</span><span class="op" id="4457104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4457107">case</span>&nbsp;<span class="ident" id="4457112">typeServerKeyExchange</span><span class="op" id="4457133">:</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4457137">m</span>&nbsp;<span class="op" id="4457139">=</span>&nbsp;<span class="builtinfunc" id="4457141">new</span><span class="op" id="4457144">(</span><span class="ident" id="4457145">serverKeyExchangeMsg</span><span class="op" id="4457165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4457168">case</span>&nbsp;<span class="ident" id="4457173">typeServerHelloDone</span><span class="op" id="4457192">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4457196">m</span>&nbsp;<span class="op" id="4457198">=</span>&nbsp;<span class="builtinfunc" id="4457200">new</span><span class="op" id="4457203">(</span><span class="ident" id="4457204">serverHelloDoneMsg</span><span class="op" id="4457222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4457225">case</span>&nbsp;<span class="ident" id="4457230">typeClientKeyExchange</span><span class="op" id="4457251">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4457255">m</span>&nbsp;<span class="op" id="4457257">=</span>&nbsp;<span class="builtinfunc" id="4457259">new</span><span class="op" id="4457262">(</span><span class="ident" id="4457263">clientKeyExchangeMsg</span><span class="op" id="4457283">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4457286">case</span>&nbsp;<span class="ident" id="4457291">typeCertificateVerify</span><span class="op" id="4457312">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4457316">m</span>&nbsp;<span class="op" id="4457318">=</span>&nbsp;<span class="op" id="4457320">&amp;</span><span class="ident" id="4457321">certificateVerifyMsg</span><span class="op" id="4457341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4457346">hasSignatureAndHash</span><span class="op" id="4457365">:</span>&nbsp;<span class="ident" id="4457367">c</span><span class="op" id="4457368">.</span><span class="ident" id="4457369">vers</span>&nbsp;<span class="op" id="4457374">&gt;=</span>&nbsp;<span class="ident" id="4457377">VersionTLS12</span><span class="op" id="4457389">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4457393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4457396">case</span>&nbsp;<span class="ident" id="4457401">typeNextProtocol</span><span class="op" id="4457417">:</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4457421">m</span>&nbsp;<span class="op" id="4457423">=</span>&nbsp;<span class="builtinfunc" id="4457425">new</span><span class="op" id="4457428">(</span><span class="ident" id="4457429">nextProtoMsg</span><span class="op" id="4457441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4457444">case</span>&nbsp;<span class="ident" id="4457449">typeFinished</span><span class="op" id="4457461">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4457465">m</span>&nbsp;<span class="op" id="4457467">=</span>&nbsp;<span class="builtinfunc" id="4457469">new</span><span class="op" id="4457472">(</span><span class="ident" id="4457473">finishedMsg</span><span class="op" id="4457484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4457487">default</span><span class="op" id="4457494">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4457498">return</span>&nbsp;<span class="ident" id="4457505">nil</span><span class="op" id="4457508">,</span>&nbsp;<span class="ident" id="4457510">c</span><span class="op" id="4457511">.</span><span class="ident" id="4457512">in</span><span class="op" id="4457514">.</span><span class="ident" id="4457515">setErrorLocked</span><span class="op" id="4457529">(</span><span class="ident" id="4457530">c</span><span class="op" id="4457531">.</span><span class="ident" id="4457532">sendAlert</span><span class="op" id="4457541">(</span><span class="ident" id="4457542">alertUnexpectedMessage</span><span class="op" id="4457564">)</span><span class="op" id="4457565">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4457568">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4457572">//&nbsp;The&nbsp;handshake&nbsp;message&nbsp;unmarshallers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4457612">//&nbsp;expect&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;keep&nbsp;references&nbsp;to&nbsp;data,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4457662">//&nbsp;so&nbsp;pass&nbsp;in&nbsp;a&nbsp;fresh&nbsp;copy&nbsp;that&nbsp;won&#39;t&nbsp;be&nbsp;overwritten.</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4457717">data</span>&nbsp;<span class="op" id="4457722">=</span>&nbsp;<span class="builtinfunc" id="4457724">append</span><span class="op" id="4457730">(</span><span class="op" id="4457731">[</span><span class="op" id="4457732">]</span><span class="builtintype" id="4457733">byte</span><span class="op" id="4457737">(</span><span class="ident" id="4457738">nil</span><span class="op" id="4457741">)</span><span class="op" id="4457742">,</span>&nbsp;<span class="ident" id="4457744">data</span><span class="op" id="4457748">...</span><span class="op" id="4457751">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4457755">if</span>&nbsp;<span class="op" id="4457758">!</span><span class="ident" id="4457759">m</span><span class="op" id="4457760">.</span><span class="ident" id="4457761">unmarshal</span><span class="op" id="4457770">(</span><span class="ident" id="4457771">data</span><span class="op" id="4457775">)</span>&nbsp;<span class="op" id="4457777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4457781">return</span>&nbsp;<span class="ident" id="4457788">nil</span><span class="op" id="4457791">,</span>&nbsp;<span class="ident" id="4457793">c</span><span class="op" id="4457794">.</span><span class="ident" id="4457795">in</span><span class="op" id="4457797">.</span><span class="ident" id="4457798">setErrorLocked</span><span class="op" id="4457812">(</span><span class="ident" id="4457813">c</span><span class="op" id="4457814">.</span><span class="ident" id="4457815">sendAlert</span><span class="op" id="4457824">(</span><span class="ident" id="4457825">alertUnexpectedMessage</span><span class="op" id="4457847">)</span><span class="op" id="4457848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4457851">}</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4457854">return</span>&nbsp;<span class="ident" id="4457861">m</span><span class="op" id="4457862">,</span>&nbsp;<span class="ident" id="4457864">nil</span><br>
<span class="lineno"></span><span class="op" id="4457868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4457871">//&nbsp;Write&nbsp;writes&nbsp;data&nbsp;to&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4457911">func</span>&nbsp;<span class="op" id="4457916">(</span><span class="ident" id="4457917">c</span>&nbsp;<span class="op" id="4457919">*</span><span class="ident" id="4457920">Conn</span><span class="op" id="4457924">)</span>&nbsp;<span class="ident" id="4457926">Write</span><span class="op" id="4457931">(</span><span class="ident" id="4457932">b</span>&nbsp;<span class="op" id="4457934">[</span><span class="op" id="4457935">]</span><span class="builtintype" id="4457936">byte</span><span class="op" id="4457940">)</span>&nbsp;<span class="op" id="4457942">(</span><span class="builtintype" id="4457943">int</span><span class="op" id="4457946">,</span>&nbsp;<span class="builtintype" id="4457948">error</span><span class="op" id="4457953">)</span>&nbsp;<span class="op" id="4457955">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4457958">if</span>&nbsp;<span class="ident" id="4457961">err</span>&nbsp;<span class="op" id="4457965">:=</span>&nbsp;<span class="ident" id="4457968">c</span><span class="op" id="4457969">.</span><span class="ident" id="4457970">Handshake</span><span class="op" id="4457979">(</span><span class="op" id="4457980">)</span><span class="op" id="4457981">;</span>&nbsp;<span class="ident" id="4457983">err</span>&nbsp;<span class="op" id="4457987">!=</span>&nbsp;<span class="ident" id="4457990">nil</span>&nbsp;<span class="op" id="4457994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4457998">return</span>&nbsp;<span class="num" id="4458005">0</span><span class="op" id="4458006">,</span>&nbsp;<span class="ident" id="4458008">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4458013">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4458017">c</span><span class="op" id="4458018">.</span><span class="ident" id="4458019">out</span><span class="op" id="4458022">.</span><span class="ident" id="4458023">Lock</span><span class="op" id="4458027">(</span><span class="op" id="4458028">)</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4458031">defer</span>&nbsp;<span class="ident" id="4458037">c</span><span class="op" id="4458038">.</span><span class="ident" id="4458039">out</span><span class="op" id="4458042">.</span><span class="ident" id="4458043">Unlock</span><span class="op" id="4458049">(</span><span class="op" id="4458050">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4458054">if</span>&nbsp;<span class="ident" id="4458057">err</span>&nbsp;<span class="op" id="4458061">:=</span>&nbsp;<span class="ident" id="4458064">c</span><span class="op" id="4458065">.</span><span class="ident" id="4458066">out</span><span class="op" id="4458069">.</span><span class="ident" id="4458070">err</span><span class="op" id="4458073">;</span>&nbsp;<span class="ident" id="4458075">err</span>&nbsp;<span class="op" id="4458079">!=</span>&nbsp;<span class="ident" id="4458082">nil</span>&nbsp;<span class="op" id="4458086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4458090">return</span>&nbsp;<span class="num" id="4458097">0</span><span class="op" id="4458098">,</span>&nbsp;<span class="ident" id="4458100">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4458105">}</span><br>
<span class="lineno">855</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4458109">if</span>&nbsp;<span class="op" id="4458112">!</span><span class="ident" id="4458113">c</span><span class="op" id="4458114">.</span><span class="ident" id="4458115">handshakeComplete</span>&nbsp;<span class="op" id="4458133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4458137">return</span>&nbsp;<span class="num" id="4458144">0</span><span class="op" id="4458145">,</span>&nbsp;<span class="ident" id="4458147">alertInternalError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4458167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4458171">//&nbsp;SSL&nbsp;3.0&nbsp;and&nbsp;TLS&nbsp;1.0&nbsp;are&nbsp;susceptible&nbsp;to&nbsp;a&nbsp;chosen-plaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4458233">//&nbsp;attack&nbsp;when&nbsp;using&nbsp;block&nbsp;mode&nbsp;ciphers&nbsp;due&nbsp;to&nbsp;predictable&nbsp;IVs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4458298">//&nbsp;This&nbsp;can&nbsp;be&nbsp;prevented&nbsp;by&nbsp;splitting&nbsp;each&nbsp;Application&nbsp;Data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4458359">//&nbsp;record&nbsp;into&nbsp;two&nbsp;records,&nbsp;effectively&nbsp;randomizing&nbsp;the&nbsp;IV.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4458420">//</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4458424">//&nbsp;http://www.openssl.org/~bodo/tls-cbc.txt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4458469">//&nbsp;https://bugzilla.mozilla.org/show_bug.cgi?id=665814</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4458525">//&nbsp;http://www.imperialviolet.org/2012/01/15/beastfollowup.html</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4458590">var</span>&nbsp;<span class="ident" id="4458594">m</span>&nbsp;<span class="builtintype" id="4458596">int</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4458601">if</span>&nbsp;<span class="builtinfunc" id="4458604">len</span><span class="op" id="4458607">(</span><span class="ident" id="4458608">b</span><span class="op" id="4458609">)</span>&nbsp;<span class="op" id="4458611">&gt;</span>&nbsp;<span class="num" id="4458613">1</span>&nbsp;<span class="op" id="4458615">&amp;&amp;</span>&nbsp;<span class="ident" id="4458618">c</span><span class="op" id="4458619">.</span><span class="ident" id="4458620">vers</span>&nbsp;<span class="op" id="4458625">&lt;=</span>&nbsp;<span class="ident" id="4458628">VersionTLS10</span>&nbsp;<span class="op" id="4458641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4458645">if</span>&nbsp;<span class="ident" id="4458648">_</span><span class="op" id="4458649">,</span>&nbsp;<span class="ident" id="4458651">ok</span>&nbsp;<span class="op" id="4458654">:=</span>&nbsp;<span class="ident" id="4458657">c</span><span class="op" id="4458658">.</span><span class="ident" id="4458659">out</span><span class="op" id="4458662">.</span><span class="ident" id="4458663">cipher</span><span class="op" id="4458669">.</span><span class="op" id="4458670">(</span><span class="ident" id="4458671">cipher</span><span class="op" id="4458677">.</span><span class="ident" id="4458678">BlockMode</span><span class="op" id="4458687">)</span><span class="op" id="4458688">;</span>&nbsp;<span class="ident" id="4458690">ok</span>&nbsp;<span class="op" id="4458693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4458698">n</span><span class="op" id="4458699">,</span>&nbsp;<span class="ident" id="4458701">err</span>&nbsp;<span class="op" id="4458705">:=</span>&nbsp;<span class="ident" id="4458708">c</span><span class="op" id="4458709">.</span><span class="ident" id="4458710">writeRecord</span><span class="op" id="4458721">(</span><span class="ident" id="4458722">recordTypeApplicationData</span><span class="op" id="4458747">,</span>&nbsp;<span class="ident" id="4458749">b</span><span class="op" id="4458750">[</span><span class="op" id="4458751">:</span><span class="num" id="4458752">1</span><span class="op" id="4458753">]</span><span class="op" id="4458754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4458759">if</span>&nbsp;<span class="ident" id="4458762">err</span>&nbsp;<span class="op" id="4458766">!=</span>&nbsp;<span class="ident" id="4458769">nil</span>&nbsp;<span class="op" id="4458773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4458779">return</span>&nbsp;<span class="ident" id="4458786">n</span><span class="op" id="4458787">,</span>&nbsp;<span class="ident" id="4458789">c</span><span class="op" id="4458790">.</span><span class="ident" id="4458791">out</span><span class="op" id="4458794">.</span><span class="ident" id="4458795">setErrorLocked</span><span class="op" id="4458809">(</span><span class="ident" id="4458810">err</span><span class="op" id="4458813">)</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4458818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4458823">m</span><span class="op" id="4458824">,</span>&nbsp;<span class="ident" id="4458826">b</span>&nbsp;<span class="op" id="4458828">=</span>&nbsp;<span class="num" id="4458830">1</span><span class="op" id="4458831">,</span>&nbsp;<span class="ident" id="4458833">b</span><span class="op" id="4458834">[</span><span class="num" id="4458835">1</span><span class="op" id="4458836">:</span><span class="op" id="4458837">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4458841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4458844">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4458848">n</span><span class="op" id="4458849">,</span>&nbsp;<span class="ident" id="4458851">err</span>&nbsp;<span class="op" id="4458855">:=</span>&nbsp;<span class="ident" id="4458858">c</span><span class="op" id="4458859">.</span><span class="ident" id="4458860">writeRecord</span><span class="op" id="4458871">(</span><span class="ident" id="4458872">recordTypeApplicationData</span><span class="op" id="4458897">,</span>&nbsp;<span class="ident" id="4458899">b</span><span class="op" id="4458900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4458903">return</span>&nbsp;<span class="ident" id="4458910">n</span>&nbsp;<span class="op" id="4458912">+</span>&nbsp;<span class="ident" id="4458914">m</span><span class="op" id="4458915">,</span>&nbsp;<span class="ident" id="4458917">c</span><span class="op" id="4458918">.</span><span class="ident" id="4458919">out</span><span class="op" id="4458922">.</span><span class="ident" id="4458923">setErrorLocked</span><span class="op" id="4458937">(</span><span class="ident" id="4458938">err</span><span class="op" id="4458941">)</span><br>
<span class="lineno"></span><span class="op" id="4458943">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4458946">//&nbsp;Read&nbsp;can&nbsp;be&nbsp;made&nbsp;to&nbsp;time&nbsp;out&nbsp;and&nbsp;return&nbsp;a&nbsp;net.Error&nbsp;with&nbsp;Timeout()&nbsp;==&nbsp;true</span><br>
<span class="lineno">885</span><span class="comment" id="4459024">//&nbsp;after&nbsp;a&nbsp;fixed&nbsp;time&nbsp;limit;&nbsp;see&nbsp;SetDeadline&nbsp;and&nbsp;SetReadDeadline.</span><br>
<span class="lineno"></span><span class="keyword" id="4459090">func</span>&nbsp;<span class="op" id="4459095">(</span><span class="ident" id="4459096">c</span>&nbsp;<span class="op" id="4459098">*</span><span class="ident" id="4459099">Conn</span><span class="op" id="4459103">)</span>&nbsp;<span class="ident" id="4459105">Read</span><span class="op" id="4459109">(</span><span class="ident" id="4459110">b</span>&nbsp;<span class="op" id="4459112">[</span><span class="op" id="4459113">]</span><span class="builtintype" id="4459114">byte</span><span class="op" id="4459118">)</span>&nbsp;<span class="op" id="4459120">(</span><span class="ident" id="4459121">n</span>&nbsp;<span class="builtintype" id="4459123">int</span><span class="op" id="4459126">,</span>&nbsp;<span class="ident" id="4459128">err</span>&nbsp;<span class="builtintype" id="4459132">error</span><span class="op" id="4459137">)</span>&nbsp;<span class="op" id="4459139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4459142">if</span>&nbsp;<span class="ident" id="4459145">err</span>&nbsp;<span class="op" id="4459149">=</span>&nbsp;<span class="ident" id="4459151">c</span><span class="op" id="4459152">.</span><span class="ident" id="4459153">Handshake</span><span class="op" id="4459162">(</span><span class="op" id="4459163">)</span><span class="op" id="4459164">;</span>&nbsp;<span class="ident" id="4459166">err</span>&nbsp;<span class="op" id="4459170">!=</span>&nbsp;<span class="ident" id="4459173">nil</span>&nbsp;<span class="op" id="4459177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4459181">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4459189">}</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4459192">if</span>&nbsp;<span class="builtinfunc" id="4459195">len</span><span class="op" id="4459198">(</span><span class="ident" id="4459199">b</span><span class="op" id="4459200">)</span>&nbsp;<span class="op" id="4459202">==</span>&nbsp;<span class="num" id="4459205">0</span>&nbsp;<span class="op" id="4459207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4459211">//&nbsp;Put&nbsp;this&nbsp;after&nbsp;Handshake,&nbsp;in&nbsp;case&nbsp;people&nbsp;were&nbsp;calling</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4459270">//&nbsp;Read(nil)&nbsp;for&nbsp;the&nbsp;side&nbsp;effect&nbsp;of&nbsp;the&nbsp;Handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4459323">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4459331">}</span><br>
<span class="lineno">895</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4459335">c</span><span class="op" id="4459336">.</span><span class="ident" id="4459337">in</span><span class="op" id="4459339">.</span><span class="ident" id="4459340">Lock</span><span class="op" id="4459344">(</span><span class="op" id="4459345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4459348">defer</span>&nbsp;<span class="ident" id="4459354">c</span><span class="op" id="4459355">.</span><span class="ident" id="4459356">in</span><span class="op" id="4459358">.</span><span class="ident" id="4459359">Unlock</span><span class="op" id="4459365">(</span><span class="op" id="4459366">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4459370">//&nbsp;Some&nbsp;OpenSSL&nbsp;servers&nbsp;send&nbsp;empty&nbsp;records&nbsp;in&nbsp;order&nbsp;to&nbsp;randomize&nbsp;the</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4459440">//&nbsp;CBC&nbsp;IV.&nbsp;So&nbsp;this&nbsp;loop&nbsp;ignores&nbsp;a&nbsp;limited&nbsp;number&nbsp;of&nbsp;empty&nbsp;records.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4459508">const</span>&nbsp;<span class="ident" id="4459514">maxConsecutiveEmptyRecords</span>&nbsp;<span class="op" id="4459541">=</span>&nbsp;<span class="num" id="4459543">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4459548">for</span>&nbsp;<span class="ident" id="4459552">emptyRecordCount</span>&nbsp;<span class="op" id="4459569">:=</span>&nbsp;<span class="num" id="4459572">0</span><span class="op" id="4459573">;</span>&nbsp;<span class="ident" id="4459575">emptyRecordCount</span>&nbsp;<span class="op" id="4459592">&lt;=</span>&nbsp;<span class="ident" id="4459595">maxConsecutiveEmptyRecords</span><span class="op" id="4459621">;</span>&nbsp;<span class="ident" id="4459623">emptyRecordCount</span><span class="op" id="4459639">++</span>&nbsp;<span class="op" id="4459642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4459646">for</span>&nbsp;<span class="ident" id="4459650">c</span><span class="op" id="4459651">.</span><span class="ident" id="4459652">input</span>&nbsp;<span class="op" id="4459658">==</span>&nbsp;<span class="ident" id="4459661">nil</span>&nbsp;<span class="op" id="4459665">&amp;&amp;</span>&nbsp;<span class="ident" id="4459668">c</span><span class="op" id="4459669">.</span><span class="ident" id="4459670">in</span><span class="op" id="4459672">.</span><span class="ident" id="4459673">err</span>&nbsp;<span class="op" id="4459677">==</span>&nbsp;<span class="ident" id="4459680">nil</span>&nbsp;<span class="op" id="4459684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4459689">if</span>&nbsp;<span class="ident" id="4459692">err</span>&nbsp;<span class="op" id="4459696">:=</span>&nbsp;<span class="ident" id="4459699">c</span><span class="op" id="4459700">.</span><span class="ident" id="4459701">readRecord</span><span class="op" id="4459711">(</span><span class="ident" id="4459712">recordTypeApplicationData</span><span class="op" id="4459737">)</span><span class="op" id="4459738">;</span>&nbsp;<span class="ident" id="4459740">err</span>&nbsp;<span class="op" id="4459744">!=</span>&nbsp;<span class="ident" id="4459747">nil</span>&nbsp;<span class="op" id="4459751">{</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4459757">//&nbsp;Soft&nbsp;error,&nbsp;like&nbsp;EAGAIN</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4459788">return</span>&nbsp;<span class="num" id="4459795">0</span><span class="op" id="4459796">,</span>&nbsp;<span class="ident" id="4459798">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4459805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4459809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4459813">if</span>&nbsp;<span class="ident" id="4459816">err</span>&nbsp;<span class="op" id="4459820">:=</span>&nbsp;<span class="ident" id="4459823">c</span><span class="op" id="4459824">.</span><span class="ident" id="4459825">in</span><span class="op" id="4459827">.</span><span class="ident" id="4459828">err</span><span class="op" id="4459831">;</span>&nbsp;<span class="ident" id="4459833">err</span>&nbsp;<span class="op" id="4459837">!=</span>&nbsp;<span class="ident" id="4459840">nil</span>&nbsp;<span class="op" id="4459844">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4459849">return</span>&nbsp;<span class="num" id="4459856">0</span><span class="op" id="4459857">,</span>&nbsp;<span class="ident" id="4459859">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4459865">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4459870">n</span><span class="op" id="4459871">,</span>&nbsp;<span class="ident" id="4459873">err</span>&nbsp;<span class="op" id="4459877">=</span>&nbsp;<span class="ident" id="4459879">c</span><span class="op" id="4459880">.</span><span class="ident" id="4459881">input</span><span class="op" id="4459886">.</span><span class="ident" id="4459887">Read</span><span class="op" id="4459891">(</span><span class="ident" id="4459892">b</span><span class="op" id="4459893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4459897">if</span>&nbsp;<span class="ident" id="4459900">c</span><span class="op" id="4459901">.</span><span class="ident" id="4459902">input</span><span class="op" id="4459907">.</span><span class="ident" id="4459908">off</span>&nbsp;<span class="op" id="4459912">&gt;=</span>&nbsp;<span class="builtinfunc" id="4459915">len</span><span class="op" id="4459918">(</span><span class="ident" id="4459919">c</span><span class="op" id="4459920">.</span><span class="ident" id="4459921">input</span><span class="op" id="4459926">.</span><span class="ident" id="4459927">data</span><span class="op" id="4459931">)</span>&nbsp;<span class="op" id="4459933">{</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4459938">c</span><span class="op" id="4459939">.</span><span class="ident" id="4459940">in</span><span class="op" id="4459942">.</span><span class="ident" id="4459943">freeBlock</span><span class="op" id="4459952">(</span><span class="ident" id="4459953">c</span><span class="op" id="4459954">.</span><span class="ident" id="4459955">input</span><span class="op" id="4459960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4459965">c</span><span class="op" id="4459966">.</span><span class="ident" id="4459967">input</span>&nbsp;<span class="op" id="4459973">=</span>&nbsp;<span class="ident" id="4459975">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4459981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4459986">//&nbsp;If&nbsp;a&nbsp;close-notify&nbsp;alert&nbsp;is&nbsp;waiting,&nbsp;read&nbsp;it&nbsp;so&nbsp;that</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4460043">//&nbsp;we&nbsp;can&nbsp;return&nbsp;(n,&nbsp;EOF)&nbsp;instead&nbsp;of&nbsp;(n,&nbsp;nil),&nbsp;to&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4460102">//&nbsp;to&nbsp;the&nbsp;HTTP&nbsp;response&nbsp;reading&nbsp;goroutine&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4460155">//&nbsp;connection&nbsp;is&nbsp;now&nbsp;closed.&nbsp;This&nbsp;eliminates&nbsp;a&nbsp;race</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4460209">//&nbsp;where&nbsp;the&nbsp;HTTP&nbsp;response&nbsp;reading&nbsp;goroutine&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4460262">//&nbsp;otherwise&nbsp;not&nbsp;observe&nbsp;the&nbsp;EOF&nbsp;until&nbsp;its&nbsp;next&nbsp;read,</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4460318">//&nbsp;by&nbsp;which&nbsp;time&nbsp;a&nbsp;client&nbsp;goroutine&nbsp;might&nbsp;have&nbsp;already</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4460375">//&nbsp;tried&nbsp;to&nbsp;reuse&nbsp;the&nbsp;HTTP&nbsp;connection&nbsp;for&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4460425">//&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4460439">//&nbsp;See&nbsp;https://codereview.appspot.com/76400046</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4460488">//&nbsp;and&nbsp;http://golang.org/issue/3514</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4460526">if</span>&nbsp;<span class="ident" id="4460529">ri</span>&nbsp;<span class="op" id="4460532">:=</span>&nbsp;<span class="ident" id="4460535">c</span><span class="op" id="4460536">.</span><span class="ident" id="4460537">rawInput</span><span class="op" id="4460545">;</span>&nbsp;<span class="ident" id="4460547">ri</span>&nbsp;<span class="op" id="4460550">!=</span>&nbsp;<span class="ident" id="4460553">nil</span>&nbsp;<span class="op" id="4460557">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4460563">n</span>&nbsp;<span class="op" id="4460565">!=</span>&nbsp;<span class="num" id="4460568">0</span>&nbsp;<span class="op" id="4460570">&amp;&amp;</span>&nbsp;<span class="ident" id="4460573">err</span>&nbsp;<span class="op" id="4460577">==</span>&nbsp;<span class="ident" id="4460580">nil</span>&nbsp;<span class="op" id="4460584">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4460590">c</span><span class="op" id="4460591">.</span><span class="ident" id="4460592">input</span>&nbsp;<span class="op" id="4460598">==</span>&nbsp;<span class="ident" id="4460601">nil</span>&nbsp;<span class="op" id="4460605">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4460608">len</span><span class="op" id="4460611">(</span><span class="ident" id="4460612">ri</span><span class="op" id="4460614">.</span><span class="ident" id="4460615">data</span><span class="op" id="4460619">)</span>&nbsp;<span class="op" id="4460621">&gt;</span>&nbsp;<span class="num" id="4460623">0</span>&nbsp;<span class="op" id="4460625">&amp;&amp;</span>&nbsp;<span class="ident" id="4460628">recordType</span><span class="op" id="4460638">(</span><span class="ident" id="4460639">ri</span><span class="op" id="4460641">.</span><span class="ident" id="4460642">data</span><span class="op" id="4460646">[</span><span class="num" id="4460647">0</span><span class="op" id="4460648">]</span><span class="op" id="4460649">)</span>&nbsp;<span class="op" id="4460651">==</span>&nbsp;<span class="ident" id="4460654">recordTypeAlert</span>&nbsp;<span class="op" id="4460670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4460675">if</span>&nbsp;<span class="ident" id="4460678">recErr</span>&nbsp;<span class="op" id="4460685">:=</span>&nbsp;<span class="ident" id="4460688">c</span><span class="op" id="4460689">.</span><span class="ident" id="4460690">readRecord</span><span class="op" id="4460700">(</span><span class="ident" id="4460701">recordTypeApplicationData</span><span class="op" id="4460726">)</span><span class="op" id="4460727">;</span>&nbsp;<span class="ident" id="4460729">recErr</span>&nbsp;<span class="op" id="4460736">!=</span>&nbsp;<span class="ident" id="4460739">nil</span>&nbsp;<span class="op" id="4460743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4460749">err</span>&nbsp;<span class="op" id="4460753">=</span>&nbsp;<span class="ident" id="4460755">recErr</span>&nbsp;<span class="comment" id="4460762">//&nbsp;will&nbsp;be&nbsp;io.EOF&nbsp;on&nbsp;closeNotify</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4460798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4460802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4460807">if</span>&nbsp;<span class="ident" id="4460810">n</span>&nbsp;<span class="op" id="4460812">!=</span>&nbsp;<span class="num" id="4460815">0</span>&nbsp;<span class="op" id="4460817">||</span>&nbsp;<span class="ident" id="4460820">err</span>&nbsp;<span class="op" id="4460824">!=</span>&nbsp;<span class="ident" id="4460827">nil</span>&nbsp;<span class="op" id="4460831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4460836">return</span>&nbsp;<span class="ident" id="4460843">n</span><span class="op" id="4460844">,</span>&nbsp;<span class="ident" id="4460846">err</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4460852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4460855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4460859">return</span>&nbsp;<span class="num" id="4460866">0</span><span class="op" id="4460867">,</span>&nbsp;<span class="ident" id="4460869">io</span><span class="op" id="4460871">.</span><span class="ident" id="4460872">ErrNoProgress</span><br>
<span class="lineno"></span><span class="op" id="4460886">}</span><br>
<span class="lineno">945</span><br>
<span class="lineno"></span><span class="comment" id="4460889">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4460921">func</span>&nbsp;<span class="op" id="4460926">(</span><span class="ident" id="4460927">c</span>&nbsp;<span class="op" id="4460929">*</span><span class="ident" id="4460930">Conn</span><span class="op" id="4460934">)</span>&nbsp;<span class="ident" id="4460936">Close</span><span class="op" id="4460941">(</span><span class="op" id="4460942">)</span>&nbsp;<span class="builtintype" id="4460944">error</span>&nbsp;<span class="op" id="4460950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4460953">var</span>&nbsp;<span class="ident" id="4460957">alertErr</span>&nbsp;<span class="builtintype" id="4460966">error</span><br>
<span class="lineno"></span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4460974">c</span><span class="op" id="4460975">.</span><span class="ident" id="4460976">handshakeMutex</span><span class="op" id="4460990">.</span><span class="ident" id="4460991">Lock</span><span class="op" id="4460995">(</span><span class="op" id="4460996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4460999">defer</span>&nbsp;<span class="ident" id="4461005">c</span><span class="op" id="4461006">.</span><span class="ident" id="4461007">handshakeMutex</span><span class="op" id="4461021">.</span><span class="ident" id="4461022">Unlock</span><span class="op" id="4461028">(</span><span class="op" id="4461029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4461032">if</span>&nbsp;<span class="ident" id="4461035">c</span><span class="op" id="4461036">.</span><span class="ident" id="4461037">handshakeComplete</span>&nbsp;<span class="op" id="4461055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4461059">alertErr</span>&nbsp;<span class="op" id="4461068">=</span>&nbsp;<span class="ident" id="4461070">c</span><span class="op" id="4461071">.</span><span class="ident" id="4461072">sendAlert</span><span class="op" id="4461081">(</span><span class="ident" id="4461082">alertCloseNotify</span><span class="op" id="4461098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4461101">}</span><br>
<span class="lineno">955</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4461105">if</span>&nbsp;<span class="ident" id="4461108">err</span>&nbsp;<span class="op" id="4461112">:=</span>&nbsp;<span class="ident" id="4461115">c</span><span class="op" id="4461116">.</span><span class="ident" id="4461117">conn</span><span class="op" id="4461121">.</span><span class="ident" id="4461122">Close</span><span class="op" id="4461127">(</span><span class="op" id="4461128">)</span><span class="op" id="4461129">;</span>&nbsp;<span class="ident" id="4461131">err</span>&nbsp;<span class="op" id="4461135">!=</span>&nbsp;<span class="ident" id="4461138">nil</span>&nbsp;<span class="op" id="4461142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4461146">return</span>&nbsp;<span class="ident" id="4461153">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4461158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4461161">return</span>&nbsp;<span class="ident" id="4461168">alertErr</span><br>
<span class="lineno">960</span><span class="op" id="4461177">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4461180">//&nbsp;Handshake&nbsp;runs&nbsp;the&nbsp;client&nbsp;or&nbsp;server&nbsp;handshake</span><br>
<span class="lineno"></span><span class="comment" id="4461229">//&nbsp;protocol&nbsp;if&nbsp;it&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;run.</span><br>
<span class="lineno"></span><span class="comment" id="4461269">//&nbsp;Most&nbsp;uses&nbsp;of&nbsp;this&nbsp;package&nbsp;need&nbsp;not&nbsp;call&nbsp;Handshake</span><br>
<span class="lineno">965</span><span class="comment" id="4461322">//&nbsp;explicitly:&nbsp;the&nbsp;first&nbsp;Read&nbsp;or&nbsp;Write&nbsp;will&nbsp;call&nbsp;it&nbsp;automatically.</span><br>
<span class="lineno"></span><span class="keyword" id="4461389">func</span>&nbsp;<span class="op" id="4461394">(</span><span class="ident" id="4461395">c</span>&nbsp;<span class="op" id="4461397">*</span><span class="ident" id="4461398">Conn</span><span class="op" id="4461402">)</span>&nbsp;<span class="ident" id="4461404">Handshake</span><span class="op" id="4461413">(</span><span class="op" id="4461414">)</span>&nbsp;<span class="builtintype" id="4461416">error</span>&nbsp;<span class="op" id="4461422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4461425">c</span><span class="op" id="4461426">.</span><span class="ident" id="4461427">handshakeMutex</span><span class="op" id="4461441">.</span><span class="ident" id="4461442">Lock</span><span class="op" id="4461446">(</span><span class="op" id="4461447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4461450">defer</span>&nbsp;<span class="ident" id="4461456">c</span><span class="op" id="4461457">.</span><span class="ident" id="4461458">handshakeMutex</span><span class="op" id="4461472">.</span><span class="ident" id="4461473">Unlock</span><span class="op" id="4461479">(</span><span class="op" id="4461480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4461483">if</span>&nbsp;<span class="ident" id="4461486">err</span>&nbsp;<span class="op" id="4461490">:=</span>&nbsp;<span class="ident" id="4461493">c</span><span class="op" id="4461494">.</span><span class="ident" id="4461495">handshakeErr</span><span class="op" id="4461507">;</span>&nbsp;<span class="ident" id="4461509">err</span>&nbsp;<span class="op" id="4461513">!=</span>&nbsp;<span class="ident" id="4461516">nil</span>&nbsp;<span class="op" id="4461520">{</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4461524">return</span>&nbsp;<span class="ident" id="4461531">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4461536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4461539">if</span>&nbsp;<span class="ident" id="4461542">c</span><span class="op" id="4461543">.</span><span class="ident" id="4461544">handshakeComplete</span>&nbsp;<span class="op" id="4461562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4461566">return</span>&nbsp;<span class="ident" id="4461573">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4461578">}</span><br>
<span class="lineno">975</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4461582">if</span>&nbsp;<span class="ident" id="4461585">c</span><span class="op" id="4461586">.</span><span class="ident" id="4461587">isClient</span>&nbsp;<span class="op" id="4461596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4461600">c</span><span class="op" id="4461601">.</span><span class="ident" id="4461602">handshakeErr</span>&nbsp;<span class="op" id="4461615">=</span>&nbsp;<span class="ident" id="4461617">c</span><span class="op" id="4461618">.</span><span class="ident" id="4461619">clientHandshake</span><span class="op" id="4461634">(</span><span class="op" id="4461635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4461638">}</span>&nbsp;<span class="keyword" id="4461640">else</span>&nbsp;<span class="op" id="4461645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4461649">c</span><span class="op" id="4461650">.</span><span class="ident" id="4461651">handshakeErr</span>&nbsp;<span class="op" id="4461664">=</span>&nbsp;<span class="ident" id="4461666">c</span><span class="op" id="4461667">.</span><span class="ident" id="4461668">serverHandshake</span><span class="op" id="4461683">(</span><span class="op" id="4461684">)</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4461687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4461690">return</span>&nbsp;<span class="ident" id="4461697">c</span><span class="op" id="4461698">.</span><span class="ident" id="4461699">handshakeErr</span><br>
<span class="lineno"></span><span class="op" id="4461712">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4461715">//&nbsp;ConnectionState&nbsp;returns&nbsp;basic&nbsp;TLS&nbsp;details&nbsp;about&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">985</span><span class="keyword" id="4461782">func</span>&nbsp;<span class="op" id="4461787">(</span><span class="ident" id="4461788">c</span>&nbsp;<span class="op" id="4461790">*</span><span class="ident" id="4461791">Conn</span><span class="op" id="4461795">)</span>&nbsp;<span class="ident" id="4461797">ConnectionState</span><span class="op" id="4461812">(</span><span class="op" id="4461813">)</span>&nbsp;<span class="ident" id="4461815">ConnectionState</span>&nbsp;<span class="op" id="4461831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4461834">c</span><span class="op" id="4461835">.</span><span class="ident" id="4461836">handshakeMutex</span><span class="op" id="4461850">.</span><span class="ident" id="4461851">Lock</span><span class="op" id="4461855">(</span><span class="op" id="4461856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4461859">defer</span>&nbsp;<span class="ident" id="4461865">c</span><span class="op" id="4461866">.</span><span class="ident" id="4461867">handshakeMutex</span><span class="op" id="4461881">.</span><span class="ident" id="4461882">Unlock</span><span class="op" id="4461888">(</span><span class="op" id="4461889">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4461893">var</span>&nbsp;<span class="ident" id="4461897">state</span>&nbsp;<span class="ident" id="4461903">ConnectionState</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4461920">state</span><span class="op" id="4461925">.</span><span class="ident" id="4461926">HandshakeComplete</span>&nbsp;<span class="op" id="4461944">=</span>&nbsp;<span class="ident" id="4461946">c</span><span class="op" id="4461947">.</span><span class="ident" id="4461948">handshakeComplete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4461967">if</span>&nbsp;<span class="ident" id="4461970">c</span><span class="op" id="4461971">.</span><span class="ident" id="4461972">handshakeComplete</span>&nbsp;<span class="op" id="4461990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4461994">state</span><span class="op" id="4461999">.</span><span class="ident" id="4462000">Version</span>&nbsp;<span class="op" id="4462008">=</span>&nbsp;<span class="ident" id="4462010">c</span><span class="op" id="4462011">.</span><span class="ident" id="4462012">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4462019">state</span><span class="op" id="4462024">.</span><span class="ident" id="4462025">NegotiatedProtocol</span>&nbsp;<span class="op" id="4462044">=</span>&nbsp;<span class="ident" id="4462046">c</span><span class="op" id="4462047">.</span><span class="ident" id="4462048">clientProtocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4462065">state</span><span class="op" id="4462070">.</span><span class="ident" id="4462071">DidResume</span>&nbsp;<span class="op" id="4462081">=</span>&nbsp;<span class="ident" id="4462083">c</span><span class="op" id="4462084">.</span><span class="ident" id="4462085">didResume</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4462097">state</span><span class="op" id="4462102">.</span><span class="ident" id="4462103">NegotiatedProtocolIsMutual</span>&nbsp;<span class="op" id="4462130">=</span>&nbsp;<span class="op" id="4462132">!</span><span class="ident" id="4462133">c</span><span class="op" id="4462134">.</span><span class="ident" id="4462135">clientProtocolFallback</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4462160">state</span><span class="op" id="4462165">.</span><span class="ident" id="4462166">CipherSuite</span>&nbsp;<span class="op" id="4462178">=</span>&nbsp;<span class="ident" id="4462180">c</span><span class="op" id="4462181">.</span><span class="ident" id="4462182">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4462196">state</span><span class="op" id="4462201">.</span><span class="ident" id="4462202">PeerCertificates</span>&nbsp;<span class="op" id="4462219">=</span>&nbsp;<span class="ident" id="4462221">c</span><span class="op" id="4462222">.</span><span class="ident" id="4462223">peerCertificates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4462242">state</span><span class="op" id="4462247">.</span><span class="ident" id="4462248">VerifiedChains</span>&nbsp;<span class="op" id="4462263">=</span>&nbsp;<span class="ident" id="4462265">c</span><span class="op" id="4462266">.</span><span class="ident" id="4462267">verifiedChains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4462284">state</span><span class="op" id="4462289">.</span><span class="ident" id="4462290">ServerName</span>&nbsp;<span class="op" id="4462301">=</span>&nbsp;<span class="ident" id="4462303">c</span><span class="op" id="4462304">.</span><span class="ident" id="4462305">serverName</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4462318">if</span>&nbsp;<span class="op" id="4462321">!</span><span class="ident" id="4462322">c</span><span class="op" id="4462323">.</span><span class="ident" id="4462324">didResume</span>&nbsp;<span class="op" id="4462334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4462339">state</span><span class="op" id="4462344">.</span><span class="ident" id="4462345">TLSUnique</span>&nbsp;<span class="op" id="4462355">=</span>&nbsp;<span class="ident" id="4462357">c</span><span class="op" id="4462358">.</span><span class="ident" id="4462359">firstFinished</span><span class="op" id="4462372">[</span><span class="op" id="4462373">:</span><span class="op" id="4462374">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4462378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4462381">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4462385">return</span>&nbsp;<span class="ident" id="4462392">state</span><br>
<span class="lineno"></span><span class="op" id="4462398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4462401">//&nbsp;OCSPResponse&nbsp;returns&nbsp;the&nbsp;stapled&nbsp;OCSP&nbsp;response&nbsp;from&nbsp;the&nbsp;TLS&nbsp;server,&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="4462475">//&nbsp;any.&nbsp;(Only&nbsp;valid&nbsp;for&nbsp;client&nbsp;connections.)</span><br>
<span class="lineno">1010</span><span class="keyword" id="4462520">func</span>&nbsp;<span class="op" id="4462525">(</span><span class="ident" id="4462526">c</span>&nbsp;<span class="op" id="4462528">*</span><span class="ident" id="4462529">Conn</span><span class="op" id="4462533">)</span>&nbsp;<span class="ident" id="4462535">OCSPResponse</span><span class="op" id="4462547">(</span><span class="op" id="4462548">)</span>&nbsp;<span class="op" id="4462550">[</span><span class="op" id="4462551">]</span><span class="builtintype" id="4462552">byte</span>&nbsp;<span class="op" id="4462557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4462560">c</span><span class="op" id="4462561">.</span><span class="ident" id="4462562">handshakeMutex</span><span class="op" id="4462576">.</span><span class="ident" id="4462577">Lock</span><span class="op" id="4462581">(</span><span class="op" id="4462582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4462585">defer</span>&nbsp;<span class="ident" id="4462591">c</span><span class="op" id="4462592">.</span><span class="ident" id="4462593">handshakeMutex</span><span class="op" id="4462607">.</span><span class="ident" id="4462608">Unlock</span><span class="op" id="4462614">(</span><span class="op" id="4462615">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4462619">return</span>&nbsp;<span class="ident" id="4462626">c</span><span class="op" id="4462627">.</span><span class="ident" id="4462628">ocspResponse</span><br>
<span class="lineno">1015</span><span class="op" id="4462641">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4462644">//&nbsp;VerifyHostname&nbsp;checks&nbsp;that&nbsp;the&nbsp;peer&nbsp;certificate&nbsp;chain&nbsp;is&nbsp;valid&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="4462714">//&nbsp;connecting&nbsp;to&nbsp;host.&nbsp;&nbsp;If&nbsp;so,&nbsp;it&nbsp;returns&nbsp;nil;&nbsp;if&nbsp;not,&nbsp;it&nbsp;returns&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="4462789">//&nbsp;describing&nbsp;the&nbsp;problem.</span><br>
<span class="lineno">1020</span><span class="keyword" id="4462816">func</span>&nbsp;<span class="op" id="4462821">(</span><span class="ident" id="4462822">c</span>&nbsp;<span class="op" id="4462824">*</span><span class="ident" id="4462825">Conn</span><span class="op" id="4462829">)</span>&nbsp;<span class="ident" id="4462831">VerifyHostname</span><span class="op" id="4462845">(</span><span class="ident" id="4462846">host</span>&nbsp;<span class="builtintype" id="4462851">string</span><span class="op" id="4462857">)</span>&nbsp;<span class="builtintype" id="4462859">error</span>&nbsp;<span class="op" id="4462865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4462868">c</span><span class="op" id="4462869">.</span><span class="ident" id="4462870">handshakeMutex</span><span class="op" id="4462884">.</span><span class="ident" id="4462885">Lock</span><span class="op" id="4462889">(</span><span class="op" id="4462890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4462893">defer</span>&nbsp;<span class="ident" id="4462899">c</span><span class="op" id="4462900">.</span><span class="ident" id="4462901">handshakeMutex</span><span class="op" id="4462915">.</span><span class="ident" id="4462916">Unlock</span><span class="op" id="4462922">(</span><span class="op" id="4462923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4462926">if</span>&nbsp;<span class="op" id="4462929">!</span><span class="ident" id="4462930">c</span><span class="op" id="4462931">.</span><span class="ident" id="4462932">isClient</span>&nbsp;<span class="op" id="4462941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4462945">return</span>&nbsp;<span class="ident" id="4462952">errors</span><span class="op" id="4462958">.</span><span class="ident" id="4462959">New</span><span class="op" id="4462962">(</span><span class="string" id="4462963">&#34;tls:&nbsp;VerifyHostname&nbsp;called&nbsp;on&nbsp;TLS&nbsp;server&nbsp;connection&#34;</span><span class="op" id="4463016">)</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4463019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4463022">if</span>&nbsp;<span class="op" id="4463025">!</span><span class="ident" id="4463026">c</span><span class="op" id="4463027">.</span><span class="ident" id="4463028">handshakeComplete</span>&nbsp;<span class="op" id="4463046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4463050">return</span>&nbsp;<span class="ident" id="4463057">errors</span><span class="op" id="4463063">.</span><span class="ident" id="4463064">New</span><span class="op" id="4463067">(</span><span class="string" id="4463068">&#34;tls:&nbsp;handshake&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;performed&#34;</span><span class="op" id="4463111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4463114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4463117">return</span>&nbsp;<span class="ident" id="4463124">c</span><span class="op" id="4463125">.</span><span class="ident" id="4463126">peerCertificates</span><span class="op" id="4463142">[</span><span class="num" id="4463143">0</span><span class="op" id="4463144">]</span><span class="op" id="4463145">.</span><span class="ident" id="4463146">VerifyHostname</span><span class="op" id="4463160">(</span><span class="ident" id="4463161">host</span><span class="op" id="4463165">)</span><br>
<span class="lineno">1030</span><span class="op" id="4463167">}</span>
</div>
</body>
</html>
