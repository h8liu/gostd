<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html" class="current">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3103515">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3103570">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3103624">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3103675">//&nbsp;HTTP&nbsp;client&nbsp;implementation.&nbsp;See&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><span class="comment" id="3103720">//</span><br>
<span class="lineno"></span><span class="comment" id="3103723">//&nbsp;This&nbsp;is&nbsp;the&nbsp;low-level&nbsp;Transport&nbsp;implementation&nbsp;of&nbsp;RoundTripper.</span><br>
<span class="lineno"></span><span class="comment" id="3103790">//&nbsp;The&nbsp;high-level&nbsp;interface&nbsp;is&nbsp;in&nbsp;client.go.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="3103836">package</span>&nbsp;<span class="ident" id="3103844">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3103850">import</span>&nbsp;<span class="op" id="3103857">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3103860">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3103869">&#34;compress/gzip&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3103886">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3103900">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3103910">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3103917">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3103923">&#34;log&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3103930">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3103937">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3103948">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3103954">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3103965">&#34;sync&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3103973">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3103980">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3103983">//&nbsp;DefaultTransport&nbsp;is&nbsp;the&nbsp;default&nbsp;implementation&nbsp;of&nbsp;Transport&nbsp;and&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3104053">//&nbsp;used&nbsp;by&nbsp;DefaultClient.&nbsp;It&nbsp;establishes&nbsp;network&nbsp;connections&nbsp;as&nbsp;needed</span><br>
<span class="lineno">30</span><span class="comment" id="3104124">//&nbsp;and&nbsp;caches&nbsp;them&nbsp;for&nbsp;reuse&nbsp;by&nbsp;subsequent&nbsp;calls.&nbsp;It&nbsp;uses&nbsp;HTTP&nbsp;proxies</span><br>
<span class="lineno"></span><span class="comment" id="3104195">//&nbsp;as&nbsp;directed&nbsp;by&nbsp;the&nbsp;$HTTP_PROXY&nbsp;and&nbsp;$NO_PROXY&nbsp;(or&nbsp;$http_proxy&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3104263">//&nbsp;$no_proxy)&nbsp;environment&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="3104300">var</span>&nbsp;<span class="ident" id="3104304">DefaultTransport</span>&nbsp;<span class="ident" id="3104321">RoundTripper</span>&nbsp;<span class="op" id="3104334">=</span>&nbsp;<span class="op" id="3104336">&amp;</span><span class="ident" id="3104337">Transport</span><span class="op" id="3104346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3104349">Proxy</span><span class="op" id="3104354">:</span>&nbsp;<span class="ident" id="3104356">ProxyFromEnvironment</span><span class="op" id="3104376">,</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3104379">Dial</span><span class="op" id="3104383">:</span>&nbsp;<span class="op" id="3104385">(</span><span class="op" id="3104386">&amp;</span><span class="ident" id="3104387">net</span><span class="op" id="3104390">.</span><span class="ident" id="3104391">Dialer</span><span class="op" id="3104397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3104401">Timeout</span><span class="op" id="3104408">:</span>&nbsp;&nbsp;&nbsp;<span class="num" id="3104412">30</span>&nbsp;<span class="op" id="3104415">*</span>&nbsp;<span class="ident" id="3104417">time</span><span class="op" id="3104421">.</span><span class="ident" id="3104422">Second</span><span class="op" id="3104428">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3104432">KeepAlive</span><span class="op" id="3104441">:</span>&nbsp;<span class="num" id="3104443">30</span>&nbsp;<span class="op" id="3104446">*</span>&nbsp;<span class="ident" id="3104448">time</span><span class="op" id="3104452">.</span><span class="ident" id="3104453">Second</span><span class="op" id="3104459">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3104462">}</span><span class="op" id="3104463">)</span><span class="op" id="3104464">.</span><span class="ident" id="3104465">Dial</span><span class="op" id="3104469">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3104472">TLSHandshakeTimeout</span><span class="op" id="3104491">:</span>&nbsp;<span class="num" id="3104493">10</span>&nbsp;<span class="op" id="3104496">*</span>&nbsp;<span class="ident" id="3104498">time</span><span class="op" id="3104502">.</span><span class="ident" id="3104503">Second</span><span class="op" id="3104509">,</span><br>
<span class="lineno">40</span><span class="op" id="3104511">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3104514">//&nbsp;DefaultMaxIdleConnsPerHost&nbsp;is&nbsp;the&nbsp;default&nbsp;value&nbsp;of&nbsp;Transport&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3104580">//&nbsp;MaxIdleConnsPerHost.</span><br>
<span class="lineno"></span><span class="keyword" id="3104604">const</span>&nbsp;<span class="ident" id="3104610">DefaultMaxIdleConnsPerHost</span>&nbsp;<span class="op" id="3104637">=</span>&nbsp;<span class="num" id="3104639">2</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="3104642">//&nbsp;Transport&nbsp;is&nbsp;an&nbsp;implementation&nbsp;of&nbsp;RoundTripper&nbsp;that&nbsp;supports&nbsp;HTTP,</span><br>
<span class="lineno"></span><span class="comment" id="3104712">//&nbsp;HTTPS,&nbsp;and&nbsp;HTTP&nbsp;proxies&nbsp;(for&nbsp;either&nbsp;HTTP&nbsp;or&nbsp;HTTPS&nbsp;with&nbsp;CONNECT).</span><br>
<span class="lineno"></span><span class="comment" id="3104780">//&nbsp;Transport&nbsp;can&nbsp;also&nbsp;cache&nbsp;connections&nbsp;for&nbsp;future&nbsp;re-use.</span><br>
<span class="lineno"></span><span class="keyword" id="3104839">type</span>&nbsp;<span class="ident" id="3104844">Transport</span>&nbsp;<span class="keyword" id="3104854">struct</span>&nbsp;<span class="op" id="3104861">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3104864">idleMu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3104875">sync</span><span class="op" id="3104879">.</span><span class="ident" id="3104880">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3104887">wantIdle</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3104898">bool</span>&nbsp;<span class="comment" id="3104903">//&nbsp;user&nbsp;has&nbsp;requested&nbsp;to&nbsp;close&nbsp;all&nbsp;idle&nbsp;conns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3104950">idleConn</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="3104961">map</span><span class="op" id="3104964">[</span><span class="ident" id="3104965">connectMethodKey</span><span class="op" id="3104981">]</span><span class="op" id="3104982">[</span><span class="op" id="3104983">]</span><span class="op" id="3104984">*</span><span class="ident" id="3104985">persistConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3104998">idleConnCh</span>&nbsp;<span class="keyword" id="3105009">map</span><span class="op" id="3105012">[</span><span class="ident" id="3105013">connectMethodKey</span><span class="op" id="3105029">]</span><span class="keyword" id="3105030">chan</span>&nbsp;<span class="op" id="3105035">*</span><span class="ident" id="3105036">persistConn</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3105050">reqMu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3105062">sync</span><span class="op" id="3105066">.</span><span class="ident" id="3105067">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3105074">reqCanceler</span>&nbsp;<span class="keyword" id="3105086">map</span><span class="op" id="3105089">[</span><span class="op" id="3105090">*</span><span class="ident" id="3105091">Request</span><span class="op" id="3105098">]</span><span class="keyword" id="3105099">func</span><span class="op" id="3105103">(</span><span class="op" id="3105104">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3105108">altMu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3105117">sync</span><span class="op" id="3105121">.</span><span class="ident" id="3105122">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3105131">altProto</span>&nbsp;<span class="keyword" id="3105140">map</span><span class="op" id="3105143">[</span><span class="builtintype" id="3105144">string</span><span class="op" id="3105150">]</span><span class="ident" id="3105151">RoundTripper</span>&nbsp;<span class="comment" id="3105164">//&nbsp;nil&nbsp;or&nbsp;map&nbsp;of&nbsp;URI&nbsp;scheme&nbsp;=&gt;&nbsp;RoundTripper</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3105210">//&nbsp;Proxy&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;return&nbsp;a&nbsp;proxy&nbsp;for&nbsp;a&nbsp;given</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3105271">//&nbsp;Request.&nbsp;If&nbsp;the&nbsp;function&nbsp;returns&nbsp;a&nbsp;non-nil&nbsp;error,&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3105329">//&nbsp;request&nbsp;is&nbsp;aborted&nbsp;with&nbsp;the&nbsp;provided&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3105377">//&nbsp;If&nbsp;Proxy&nbsp;is&nbsp;nil&nbsp;or&nbsp;returns&nbsp;a&nbsp;nil&nbsp;*URL,&nbsp;no&nbsp;proxy&nbsp;is&nbsp;used.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3105438">Proxy</span>&nbsp;<span class="keyword" id="3105444">func</span><span class="op" id="3105448">(</span><span class="op" id="3105449">*</span><span class="ident" id="3105450">Request</span><span class="op" id="3105457">)</span>&nbsp;<span class="op" id="3105459">(</span><span class="op" id="3105460">*</span><span class="ident" id="3105461">url</span><span class="op" id="3105464">.</span><span class="ident" id="3105465">URL</span><span class="op" id="3105468">,</span>&nbsp;<span class="builtintype" id="3105470">error</span><span class="op" id="3105475">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3105479">//&nbsp;Dial&nbsp;specifies&nbsp;the&nbsp;dial&nbsp;function&nbsp;for&nbsp;creating&nbsp;unencrypted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3105541">//&nbsp;TCP&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3105562">//&nbsp;If&nbsp;Dial&nbsp;is&nbsp;nil,&nbsp;net.Dial&nbsp;is&nbsp;used.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3105600">Dial</span>&nbsp;<span class="keyword" id="3105605">func</span><span class="op" id="3105609">(</span><span class="ident" id="3105610">network</span><span class="op" id="3105617">,</span>&nbsp;<span class="ident" id="3105619">addr</span>&nbsp;<span class="builtintype" id="3105624">string</span><span class="op" id="3105630">)</span>&nbsp;<span class="op" id="3105632">(</span><span class="ident" id="3105633">net</span><span class="op" id="3105636">.</span><span class="ident" id="3105637">Conn</span><span class="op" id="3105641">,</span>&nbsp;<span class="builtintype" id="3105643">error</span><span class="op" id="3105648">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3105652">//&nbsp;DialTLS&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;dial&nbsp;function&nbsp;for&nbsp;creating</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3105713">//&nbsp;TLS&nbsp;connections&nbsp;for&nbsp;non-proxied&nbsp;HTTPS&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3105765">//</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3105769">//&nbsp;If&nbsp;DialTLS&nbsp;is&nbsp;nil,&nbsp;Dial&nbsp;and&nbsp;TLSClientConfig&nbsp;are&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3105827">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3105831">//&nbsp;If&nbsp;DialTLS&nbsp;is&nbsp;set,&nbsp;the&nbsp;Dial&nbsp;hook&nbsp;is&nbsp;not&nbsp;used&nbsp;for&nbsp;HTTPS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3105890">//&nbsp;requests&nbsp;and&nbsp;the&nbsp;TLSClientConfig&nbsp;and&nbsp;TLSHandshakeTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3105951">//&nbsp;are&nbsp;ignored.&nbsp;The&nbsp;returned&nbsp;net.Conn&nbsp;is&nbsp;assumed&nbsp;to&nbsp;already&nbsp;be</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3106015">//&nbsp;past&nbsp;the&nbsp;TLS&nbsp;handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3106043">DialTLS</span>&nbsp;<span class="keyword" id="3106051">func</span><span class="op" id="3106055">(</span><span class="ident" id="3106056">network</span><span class="op" id="3106063">,</span>&nbsp;<span class="ident" id="3106065">addr</span>&nbsp;<span class="builtintype" id="3106070">string</span><span class="op" id="3106076">)</span>&nbsp;<span class="op" id="3106078">(</span><span class="ident" id="3106079">net</span><span class="op" id="3106082">.</span><span class="ident" id="3106083">Conn</span><span class="op" id="3106087">,</span>&nbsp;<span class="builtintype" id="3106089">error</span><span class="op" id="3106094">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3106098">//&nbsp;TLSClientConfig&nbsp;specifies&nbsp;the&nbsp;TLS&nbsp;configuration&nbsp;to&nbsp;use&nbsp;with</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3106162">//&nbsp;tls.Client.&nbsp;If&nbsp;nil,&nbsp;the&nbsp;default&nbsp;configuration&nbsp;is&nbsp;used.</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3106221">TLSClientConfig</span>&nbsp;<span class="op" id="3106237">*</span><span class="ident" id="3106238">tls</span><span class="op" id="3106241">.</span><span class="ident" id="3106242">Config</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3106251">//&nbsp;TLSHandshakeTimeout&nbsp;specifies&nbsp;the&nbsp;maximum&nbsp;amount&nbsp;of&nbsp;time&nbsp;waiting&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3106323">//&nbsp;wait&nbsp;for&nbsp;a&nbsp;TLS&nbsp;handshake.&nbsp;Zero&nbsp;means&nbsp;no&nbsp;timeout.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3106376">TLSHandshakeTimeout</span>&nbsp;<span class="ident" id="3106396">time</span><span class="op" id="3106400">.</span><span class="ident" id="3106401">Duration</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3106412">//&nbsp;DisableKeepAlives,&nbsp;if&nbsp;true,&nbsp;prevents&nbsp;re-use&nbsp;of&nbsp;TCP&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3106479">//&nbsp;between&nbsp;different&nbsp;HTTP&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3106516">DisableKeepAlives</span>&nbsp;<span class="builtintype" id="3106534">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3106541">//&nbsp;DisableCompression,&nbsp;if&nbsp;true,&nbsp;prevents&nbsp;the&nbsp;Transport&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3106602">//&nbsp;requesting&nbsp;compression&nbsp;with&nbsp;an&nbsp;&#34;Accept-Encoding:&nbsp;gzip&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3106661">//&nbsp;request&nbsp;header&nbsp;when&nbsp;the&nbsp;Request&nbsp;contains&nbsp;no&nbsp;existing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3106718">//&nbsp;Accept-Encoding&nbsp;value.&nbsp;If&nbsp;the&nbsp;Transport&nbsp;requests&nbsp;gzip&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3106779">//&nbsp;its&nbsp;own&nbsp;and&nbsp;gets&nbsp;a&nbsp;gzipped&nbsp;response,&nbsp;it&#39;s&nbsp;transparently</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3106839">//&nbsp;decoded&nbsp;in&nbsp;the&nbsp;Response.Body.&nbsp;However,&nbsp;if&nbsp;the&nbsp;user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3106894">//&nbsp;explicitly&nbsp;requested&nbsp;gzip&nbsp;it&nbsp;is&nbsp;not&nbsp;automatically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3106948">//&nbsp;uncompressed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3106966">DisableCompression</span>&nbsp;<span class="builtintype" id="3106985">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3106992">//&nbsp;MaxIdleConnsPerHost,&nbsp;if&nbsp;non-zero,&nbsp;controls&nbsp;the&nbsp;maximum&nbsp;idle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3107056">//&nbsp;(keep-alive)&nbsp;to&nbsp;keep&nbsp;per-host.&nbsp;&nbsp;If&nbsp;zero,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3107101">//&nbsp;DefaultMaxIdleConnsPerHost&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3107141">MaxIdleConnsPerHost</span>&nbsp;<span class="builtintype" id="3107161">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3107167">//&nbsp;ResponseHeaderTimeout,&nbsp;if&nbsp;non-zero,&nbsp;specifies&nbsp;the&nbsp;amount&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3107231">//&nbsp;time&nbsp;to&nbsp;wait&nbsp;for&nbsp;a&nbsp;server&#39;s&nbsp;response&nbsp;headers&nbsp;after&nbsp;fully</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3107292">//&nbsp;writing&nbsp;the&nbsp;request&nbsp;(including&nbsp;its&nbsp;body,&nbsp;if&nbsp;any).&nbsp;This</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3107351">//&nbsp;time&nbsp;does&nbsp;not&nbsp;include&nbsp;the&nbsp;time&nbsp;to&nbsp;read&nbsp;the&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3107413">ResponseHeaderTimeout</span>&nbsp;<span class="ident" id="3107435">time</span><span class="op" id="3107439">.</span><span class="ident" id="3107440">Duration</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3107451">//&nbsp;TODO:&nbsp;tunable&nbsp;on&nbsp;global&nbsp;max&nbsp;cached&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3107502">//&nbsp;TODO:&nbsp;tunable&nbsp;on&nbsp;timeout&nbsp;on&nbsp;cached&nbsp;connections</span><br>
<span class="lineno"></span><span class="op" id="3107552">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="3107555">//&nbsp;ProxyFromEnvironment&nbsp;returns&nbsp;the&nbsp;URL&nbsp;of&nbsp;the&nbsp;proxy&nbsp;to&nbsp;use&nbsp;for&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3107621">//&nbsp;given&nbsp;request,&nbsp;as&nbsp;indicated&nbsp;by&nbsp;the&nbsp;environment&nbsp;variables</span><br>
<span class="lineno"></span><span class="comment" id="3107681">//&nbsp;HTTP_PROXY,&nbsp;HTTPS_PROXY&nbsp;and&nbsp;NO_PROXY&nbsp;(or&nbsp;the&nbsp;lowercase&nbsp;versions</span><br>
<span class="lineno"></span><span class="comment" id="3107748">//&nbsp;thereof).&nbsp;HTTPS_PROXY&nbsp;takes&nbsp;precedence&nbsp;over&nbsp;HTTP_PROXY&nbsp;for&nbsp;https</span><br>
<span class="lineno"></span><span class="comment" id="3107816">//&nbsp;requests.</span><br>
<span class="lineno">125</span><span class="comment" id="3107829">//</span><br>
<span class="lineno"></span><span class="comment" id="3107832">//&nbsp;The&nbsp;environment&nbsp;values&nbsp;may&nbsp;be&nbsp;either&nbsp;a&nbsp;complete&nbsp;URL&nbsp;or&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3107892">//&nbsp;&#34;host[:port]&#34;,&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;&#34;http&#34;&nbsp;scheme&nbsp;is&nbsp;assumed.</span><br>
<span class="lineno"></span><span class="comment" id="3107954">//&nbsp;An&nbsp;error&nbsp;is&nbsp;returned&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;a&nbsp;different&nbsp;form.</span><br>
<span class="lineno"></span><span class="comment" id="3108012">//</span><br>
<span class="lineno">130</span><span class="comment" id="3108015">//&nbsp;A&nbsp;nil&nbsp;URL&nbsp;and&nbsp;nil&nbsp;error&nbsp;are&nbsp;returned&nbsp;if&nbsp;no&nbsp;proxy&nbsp;is&nbsp;defined&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3108085">//&nbsp;environment,&nbsp;or&nbsp;a&nbsp;proxy&nbsp;should&nbsp;not&nbsp;be&nbsp;used&nbsp;for&nbsp;the&nbsp;given&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="3108154">//&nbsp;as&nbsp;defined&nbsp;by&nbsp;NO_PROXY.</span><br>
<span class="lineno"></span><span class="comment" id="3108181">//</span><br>
<span class="lineno"></span><span class="comment" id="3108184">//&nbsp;As&nbsp;a&nbsp;special&nbsp;case,&nbsp;if&nbsp;req.URL.Host&nbsp;is&nbsp;&#34;localhost&#34;&nbsp;(with&nbsp;or&nbsp;without</span><br>
<span class="lineno">135</span><span class="comment" id="3108254">//&nbsp;a&nbsp;port&nbsp;number),&nbsp;then&nbsp;a&nbsp;nil&nbsp;URL&nbsp;and&nbsp;nil&nbsp;error&nbsp;will&nbsp;be&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="3108320">func</span>&nbsp;<span class="ident" id="3108325">ProxyFromEnvironment</span><span class="op" id="3108345">(</span><span class="ident" id="3108346">req</span>&nbsp;<span class="op" id="3108350">*</span><span class="ident" id="3108351">Request</span><span class="op" id="3108358">)</span>&nbsp;<span class="op" id="3108360">(</span><span class="op" id="3108361">*</span><span class="ident" id="3108362">url</span><span class="op" id="3108365">.</span><span class="ident" id="3108366">URL</span><span class="op" id="3108369">,</span>&nbsp;<span class="builtintype" id="3108371">error</span><span class="op" id="3108376">)</span>&nbsp;<span class="op" id="3108378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3108381">var</span>&nbsp;<span class="ident" id="3108385">proxy</span>&nbsp;<span class="builtintype" id="3108391">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3108399">if</span>&nbsp;<span class="ident" id="3108402">req</span><span class="op" id="3108405">.</span><span class="ident" id="3108406">URL</span><span class="op" id="3108409">.</span><span class="ident" id="3108410">Scheme</span>&nbsp;<span class="op" id="3108417">==</span>&nbsp;<span class="string" id="3108420">&#34;https&#34;</span>&nbsp;<span class="op" id="3108428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3108432">proxy</span>&nbsp;<span class="op" id="3108438">=</span>&nbsp;<span class="ident" id="3108440">httpsProxyEnv</span><span class="op" id="3108453">.</span><span class="ident" id="3108454">Get</span><span class="op" id="3108457">(</span><span class="op" id="3108458">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3108461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3108464">if</span>&nbsp;<span class="ident" id="3108467">proxy</span>&nbsp;<span class="op" id="3108473">==</span>&nbsp;<span class="string" id="3108476">&#34;&#34;</span>&nbsp;<span class="op" id="3108479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3108483">proxy</span>&nbsp;<span class="op" id="3108489">=</span>&nbsp;<span class="ident" id="3108491">httpProxyEnv</span><span class="op" id="3108503">.</span><span class="ident" id="3108504">Get</span><span class="op" id="3108507">(</span><span class="op" id="3108508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3108511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3108514">if</span>&nbsp;<span class="ident" id="3108517">proxy</span>&nbsp;<span class="op" id="3108523">==</span>&nbsp;<span class="string" id="3108526">&#34;&#34;</span>&nbsp;<span class="op" id="3108529">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3108533">return</span>&nbsp;<span class="builtintype" id="3108540">nil</span><span class="op" id="3108543">,</span>&nbsp;<span class="builtintype" id="3108545">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3108550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3108553">if</span>&nbsp;<span class="op" id="3108556">!</span><span class="ident" id="3108557">useProxy</span><span class="op" id="3108565">(</span><span class="ident" id="3108566">canonicalAddr</span><span class="op" id="3108579">(</span><span class="ident" id="3108580">req</span><span class="op" id="3108583">.</span><span class="ident" id="3108584">URL</span><span class="op" id="3108587">)</span><span class="op" id="3108588">)</span>&nbsp;<span class="op" id="3108590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3108594">return</span>&nbsp;<span class="builtintype" id="3108601">nil</span><span class="op" id="3108604">,</span>&nbsp;<span class="builtintype" id="3108606">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3108611">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3108614">proxyURL</span><span class="op" id="3108622">,</span>&nbsp;<span class="ident" id="3108624">err</span>&nbsp;<span class="op" id="3108628">:=</span>&nbsp;<span class="ident" id="3108631">url</span><span class="op" id="3108634">.</span><span class="ident" id="3108635">Parse</span><span class="op" id="3108640">(</span><span class="ident" id="3108641">proxy</span><span class="op" id="3108646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3108649">if</span>&nbsp;<span class="ident" id="3108652">err</span>&nbsp;<span class="op" id="3108656">!=</span>&nbsp;<span class="builtintype" id="3108659">nil</span>&nbsp;<span class="op" id="3108663">||</span>&nbsp;<span class="op" id="3108666">!</span><span class="ident" id="3108667">strings</span><span class="op" id="3108674">.</span><span class="ident" id="3108675">HasPrefix</span><span class="op" id="3108684">(</span><span class="ident" id="3108685">proxyURL</span><span class="op" id="3108693">.</span><span class="ident" id="3108694">Scheme</span><span class="op" id="3108700">,</span>&nbsp;<span class="string" id="3108702">&#34;http&#34;</span><span class="op" id="3108708">)</span>&nbsp;<span class="op" id="3108710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3108714">//&nbsp;proxy&nbsp;was&nbsp;bogus.&nbsp;Try&nbsp;prepending&nbsp;&#34;http://&#34;&nbsp;to&nbsp;it&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3108771">//&nbsp;see&nbsp;if&nbsp;that&nbsp;parses&nbsp;correctly.&nbsp;If&nbsp;not,&nbsp;we&nbsp;fall</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3108822">//&nbsp;through&nbsp;and&nbsp;complain&nbsp;about&nbsp;the&nbsp;original&nbsp;one.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3108872">if</span>&nbsp;<span class="ident" id="3108875">proxyURL</span><span class="op" id="3108883">,</span>&nbsp;<span class="ident" id="3108885">err</span>&nbsp;<span class="op" id="3108889">:=</span>&nbsp;<span class="ident" id="3108892">url</span><span class="op" id="3108895">.</span><span class="ident" id="3108896">Parse</span><span class="op" id="3108901">(</span><span class="string" id="3108902">&#34;http://&#34;</span>&nbsp;<span class="op" id="3108912">+</span>&nbsp;<span class="ident" id="3108914">proxy</span><span class="op" id="3108919">)</span><span class="op" id="3108920">;</span>&nbsp;<span class="ident" id="3108922">err</span>&nbsp;<span class="op" id="3108926">==</span>&nbsp;<span class="builtintype" id="3108929">nil</span>&nbsp;<span class="op" id="3108933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3108938">return</span>&nbsp;<span class="ident" id="3108945">proxyURL</span><span class="op" id="3108953">,</span>&nbsp;<span class="builtintype" id="3108955">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3108961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3108964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3108967">if</span>&nbsp;<span class="ident" id="3108970">err</span>&nbsp;<span class="op" id="3108974">!=</span>&nbsp;<span class="builtintype" id="3108977">nil</span>&nbsp;<span class="op" id="3108981">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3108985">return</span>&nbsp;<span class="builtintype" id="3108992">nil</span><span class="op" id="3108995">,</span>&nbsp;<span class="ident" id="3108997">fmt</span><span class="op" id="3109000">.</span><span class="ident" id="3109001">Errorf</span><span class="op" id="3109007">(</span><span class="string" id="3109008">&#34;invalid&nbsp;proxy&nbsp;address&nbsp;%q:&nbsp;%v&#34;</span><span class="op" id="3109038">,</span>&nbsp;<span class="ident" id="3109040">proxy</span><span class="op" id="3109045">,</span>&nbsp;<span class="ident" id="3109047">err</span><span class="op" id="3109050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3109053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3109056">return</span>&nbsp;<span class="ident" id="3109063">proxyURL</span><span class="op" id="3109071">,</span>&nbsp;<span class="builtintype" id="3109073">nil</span><br>
<span class="lineno"></span><span class="op" id="3109077">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="3109080">//&nbsp;ProxyURL&nbsp;returns&nbsp;a&nbsp;proxy&nbsp;function&nbsp;(for&nbsp;use&nbsp;in&nbsp;a&nbsp;Transport)</span><br>
<span class="lineno"></span><span class="comment" id="3109142">//&nbsp;that&nbsp;always&nbsp;returns&nbsp;the&nbsp;same&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="3109179">func</span>&nbsp;<span class="ident" id="3109184">ProxyURL</span><span class="op" id="3109192">(</span><span class="ident" id="3109193">fixedURL</span>&nbsp;<span class="op" id="3109202">*</span><span class="ident" id="3109203">url</span><span class="op" id="3109206">.</span><span class="ident" id="3109207">URL</span><span class="op" id="3109210">)</span>&nbsp;<span class="keyword" id="3109212">func</span><span class="op" id="3109216">(</span><span class="op" id="3109217">*</span><span class="ident" id="3109218">Request</span><span class="op" id="3109225">)</span>&nbsp;<span class="op" id="3109227">(</span><span class="op" id="3109228">*</span><span class="ident" id="3109229">url</span><span class="op" id="3109232">.</span><span class="ident" id="3109233">URL</span><span class="op" id="3109236">,</span>&nbsp;<span class="builtintype" id="3109238">error</span><span class="op" id="3109243">)</span>&nbsp;<span class="op" id="3109245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3109248">return</span>&nbsp;<span class="keyword" id="3109255">func</span><span class="op" id="3109259">(</span><span class="op" id="3109260">*</span><span class="ident" id="3109261">Request</span><span class="op" id="3109268">)</span>&nbsp;<span class="op" id="3109270">(</span><span class="op" id="3109271">*</span><span class="ident" id="3109272">url</span><span class="op" id="3109275">.</span><span class="ident" id="3109276">URL</span><span class="op" id="3109279">,</span>&nbsp;<span class="builtintype" id="3109281">error</span><span class="op" id="3109286">)</span>&nbsp;<span class="op" id="3109288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3109292">return</span>&nbsp;<span class="ident" id="3109299">fixedURL</span><span class="op" id="3109307">,</span>&nbsp;<span class="builtintype" id="3109309">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3109314">}</span><br>
<span class="lineno"></span><span class="op" id="3109316">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3109319">//&nbsp;transportRequest&nbsp;is&nbsp;a&nbsp;wrapper&nbsp;around&nbsp;a&nbsp;*Request&nbsp;that&nbsp;adds</span><br>
<span class="lineno"></span><span class="comment" id="3109380">//&nbsp;optional&nbsp;extra&nbsp;headers&nbsp;to&nbsp;write.</span><br>
<span class="lineno">175</span><span class="keyword" id="3109416">type</span>&nbsp;<span class="ident" id="3109421">transportRequest</span>&nbsp;<span class="keyword" id="3109438">struct</span>&nbsp;<span class="op" id="3109445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3109448">*</span><span class="ident" id="3109449">Request</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3109464">//&nbsp;original&nbsp;request,&nbsp;not&nbsp;to&nbsp;be&nbsp;mutated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3109504">extra</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3109513">Header</span>&nbsp;<span class="comment" id="3109520">//&nbsp;extra&nbsp;headers&nbsp;to&nbsp;write,&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span><span class="op" id="3109554">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="3109557">func</span>&nbsp;<span class="op" id="3109562">(</span><span class="ident" id="3109563">tr</span>&nbsp;<span class="op" id="3109566">*</span><span class="ident" id="3109567">transportRequest</span><span class="op" id="3109583">)</span>&nbsp;<span class="ident" id="3109585">extraHeaders</span><span class="op" id="3109597">(</span><span class="op" id="3109598">)</span>&nbsp;<span class="ident" id="3109600">Header</span>&nbsp;<span class="op" id="3109607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3109610">if</span>&nbsp;<span class="ident" id="3109613">tr</span><span class="op" id="3109615">.</span><span class="ident" id="3109616">extra</span>&nbsp;<span class="op" id="3109622">==</span>&nbsp;<span class="builtintype" id="3109625">nil</span>&nbsp;<span class="op" id="3109629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3109633">tr</span><span class="op" id="3109635">.</span><span class="ident" id="3109636">extra</span>&nbsp;<span class="op" id="3109642">=</span>&nbsp;<span class="builtinfunc" id="3109644">make</span><span class="op" id="3109648">(</span><span class="ident" id="3109649">Header</span><span class="op" id="3109655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3109658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3109661">return</span>&nbsp;<span class="ident" id="3109668">tr</span><span class="op" id="3109670">.</span><span class="ident" id="3109671">extra</span><br>
<span class="lineno">185</span><span class="op" id="3109677">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3109680">//&nbsp;RoundTrip&nbsp;implements&nbsp;the&nbsp;RoundTripper&nbsp;interface.</span><br>
<span class="lineno"></span><span class="comment" id="3109732">//</span><br>
<span class="lineno"></span><span class="comment" id="3109735">//&nbsp;For&nbsp;higher-level&nbsp;HTTP&nbsp;client&nbsp;support&nbsp;(such&nbsp;as&nbsp;handling&nbsp;of&nbsp;cookies</span><br>
<span class="lineno">190</span><span class="comment" id="3109804">//&nbsp;and&nbsp;redirects),&nbsp;see&nbsp;Get,&nbsp;Post,&nbsp;and&nbsp;the&nbsp;Client&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="3109859">func</span>&nbsp;<span class="op" id="3109864">(</span><span class="ident" id="3109865">t</span>&nbsp;<span class="op" id="3109867">*</span><span class="ident" id="3109868">Transport</span><span class="op" id="3109877">)</span>&nbsp;<span class="ident" id="3109879">RoundTrip</span><span class="op" id="3109888">(</span><span class="ident" id="3109889">req</span>&nbsp;<span class="op" id="3109893">*</span><span class="ident" id="3109894">Request</span><span class="op" id="3109901">)</span>&nbsp;<span class="op" id="3109903">(</span><span class="ident" id="3109904">resp</span>&nbsp;<span class="op" id="3109909">*</span><span class="ident" id="3109910">Response</span><span class="op" id="3109918">,</span>&nbsp;<span class="ident" id="3109920">err</span>&nbsp;<span class="builtintype" id="3109924">error</span><span class="op" id="3109929">)</span>&nbsp;<span class="op" id="3109931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3109934">if</span>&nbsp;<span class="ident" id="3109937">req</span><span class="op" id="3109940">.</span><span class="ident" id="3109941">URL</span>&nbsp;<span class="op" id="3109945">==</span>&nbsp;<span class="builtintype" id="3109948">nil</span>&nbsp;<span class="op" id="3109952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3109956">req</span><span class="op" id="3109959">.</span><span class="ident" id="3109960">closeBody</span><span class="op" id="3109969">(</span><span class="op" id="3109970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3109974">return</span>&nbsp;<span class="builtintype" id="3109981">nil</span><span class="op" id="3109984">,</span>&nbsp;<span class="ident" id="3109986">errors</span><span class="op" id="3109992">.</span><span class="ident" id="3109993">New</span><span class="op" id="3109996">(</span><span class="string" id="3109997">&#34;http:&nbsp;nil&nbsp;Request.URL&#34;</span><span class="op" id="3110020">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3110023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3110026">if</span>&nbsp;<span class="ident" id="3110029">req</span><span class="op" id="3110032">.</span><span class="ident" id="3110033">Header</span>&nbsp;<span class="op" id="3110040">==</span>&nbsp;<span class="builtintype" id="3110043">nil</span>&nbsp;<span class="op" id="3110047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3110051">req</span><span class="op" id="3110054">.</span><span class="ident" id="3110055">closeBody</span><span class="op" id="3110064">(</span><span class="op" id="3110065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3110069">return</span>&nbsp;<span class="builtintype" id="3110076">nil</span><span class="op" id="3110079">,</span>&nbsp;<span class="ident" id="3110081">errors</span><span class="op" id="3110087">.</span><span class="ident" id="3110088">New</span><span class="op" id="3110091">(</span><span class="string" id="3110092">&#34;http:&nbsp;nil&nbsp;Request.Header&#34;</span><span class="op" id="3110118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3110121">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3110124">if</span>&nbsp;<span class="ident" id="3110127">req</span><span class="op" id="3110130">.</span><span class="ident" id="3110131">URL</span><span class="op" id="3110134">.</span><span class="ident" id="3110135">Scheme</span>&nbsp;<span class="op" id="3110142">!=</span>&nbsp;<span class="string" id="3110145">&#34;http&#34;</span>&nbsp;<span class="op" id="3110152">&amp;&amp;</span>&nbsp;<span class="ident" id="3110155">req</span><span class="op" id="3110158">.</span><span class="ident" id="3110159">URL</span><span class="op" id="3110162">.</span><span class="ident" id="3110163">Scheme</span>&nbsp;<span class="op" id="3110170">!=</span>&nbsp;<span class="string" id="3110173">&#34;https&#34;</span>&nbsp;<span class="op" id="3110181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3110185">t</span><span class="op" id="3110186">.</span><span class="ident" id="3110187">altMu</span><span class="op" id="3110192">.</span><span class="ident" id="3110193">RLock</span><span class="op" id="3110198">(</span><span class="op" id="3110199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3110203">var</span>&nbsp;<span class="ident" id="3110207">rt</span>&nbsp;<span class="ident" id="3110210">RoundTripper</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3110225">if</span>&nbsp;<span class="ident" id="3110228">t</span><span class="op" id="3110229">.</span><span class="ident" id="3110230">altProto</span>&nbsp;<span class="op" id="3110239">!=</span>&nbsp;<span class="builtintype" id="3110242">nil</span>&nbsp;<span class="op" id="3110246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3110251">rt</span>&nbsp;<span class="op" id="3110254">=</span>&nbsp;<span class="ident" id="3110256">t</span><span class="op" id="3110257">.</span><span class="ident" id="3110258">altProto</span><span class="op" id="3110266">[</span><span class="ident" id="3110267">req</span><span class="op" id="3110270">.</span><span class="ident" id="3110271">URL</span><span class="op" id="3110274">.</span><span class="ident" id="3110275">Scheme</span><span class="op" id="3110281">]</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3110285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3110289">t</span><span class="op" id="3110290">.</span><span class="ident" id="3110291">altMu</span><span class="op" id="3110296">.</span><span class="ident" id="3110297">RUnlock</span><span class="op" id="3110304">(</span><span class="op" id="3110305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3110309">if</span>&nbsp;<span class="ident" id="3110312">rt</span>&nbsp;<span class="op" id="3110315">==</span>&nbsp;<span class="builtintype" id="3110318">nil</span>&nbsp;<span class="op" id="3110322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3110327">req</span><span class="op" id="3110330">.</span><span class="ident" id="3110331">closeBody</span><span class="op" id="3110340">(</span><span class="op" id="3110341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3110346">return</span>&nbsp;<span class="builtintype" id="3110353">nil</span><span class="op" id="3110356">,</span>&nbsp;<span class="op" id="3110358">&amp;</span><span class="ident" id="3110359">badStringError</span><span class="op" id="3110373">{</span><span class="string" id="3110374">&#34;unsupported&nbsp;protocol&nbsp;scheme&#34;</span><span class="op" id="3110403">,</span>&nbsp;<span class="ident" id="3110405">req</span><span class="op" id="3110408">.</span><span class="ident" id="3110409">URL</span><span class="op" id="3110412">.</span><span class="ident" id="3110413">Scheme</span><span class="op" id="3110419">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3110423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3110427">return</span>&nbsp;<span class="ident" id="3110434">rt</span><span class="op" id="3110436">.</span><span class="ident" id="3110437">RoundTrip</span><span class="op" id="3110446">(</span><span class="ident" id="3110447">req</span><span class="op" id="3110450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3110453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3110456">if</span>&nbsp;<span class="ident" id="3110459">req</span><span class="op" id="3110462">.</span><span class="ident" id="3110463">URL</span><span class="op" id="3110466">.</span><span class="ident" id="3110467">Host</span>&nbsp;<span class="op" id="3110472">==</span>&nbsp;<span class="string" id="3110475">&#34;&#34;</span>&nbsp;<span class="op" id="3110478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3110482">req</span><span class="op" id="3110485">.</span><span class="ident" id="3110486">closeBody</span><span class="op" id="3110495">(</span><span class="op" id="3110496">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3110500">return</span>&nbsp;<span class="builtintype" id="3110507">nil</span><span class="op" id="3110510">,</span>&nbsp;<span class="ident" id="3110512">errors</span><span class="op" id="3110518">.</span><span class="ident" id="3110519">New</span><span class="op" id="3110522">(</span><span class="string" id="3110523">&#34;http:&nbsp;no&nbsp;Host&nbsp;in&nbsp;request&nbsp;URL&#34;</span><span class="op" id="3110553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3110556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3110559">treq</span>&nbsp;<span class="op" id="3110564">:=</span>&nbsp;<span class="op" id="3110567">&amp;</span><span class="ident" id="3110568">transportRequest</span><span class="op" id="3110584">{</span><span class="ident" id="3110585">Request</span><span class="op" id="3110592">:</span>&nbsp;<span class="ident" id="3110594">req</span><span class="op" id="3110597">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3110600">cm</span><span class="op" id="3110602">,</span>&nbsp;<span class="ident" id="3110604">err</span>&nbsp;<span class="op" id="3110608">:=</span>&nbsp;<span class="ident" id="3110611">t</span><span class="op" id="3110612">.</span><span class="ident" id="3110613">connectMethodForRequest</span><span class="op" id="3110636">(</span><span class="ident" id="3110637">treq</span><span class="op" id="3110641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3110644">if</span>&nbsp;<span class="ident" id="3110647">err</span>&nbsp;<span class="op" id="3110651">!=</span>&nbsp;<span class="builtintype" id="3110654">nil</span>&nbsp;<span class="op" id="3110658">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3110662">req</span><span class="op" id="3110665">.</span><span class="ident" id="3110666">closeBody</span><span class="op" id="3110675">(</span><span class="op" id="3110676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3110680">return</span>&nbsp;<span class="builtintype" id="3110687">nil</span><span class="op" id="3110690">,</span>&nbsp;<span class="ident" id="3110692">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3110697">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3110701">//&nbsp;Get&nbsp;the&nbsp;cached&nbsp;or&nbsp;newly-created&nbsp;connection&nbsp;to&nbsp;either&nbsp;the</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3110762">//&nbsp;host&nbsp;(for&nbsp;http&nbsp;or&nbsp;https),&nbsp;the&nbsp;http&nbsp;proxy,&nbsp;or&nbsp;the&nbsp;http&nbsp;proxy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3110826">//&nbsp;pre-CONNECTed&nbsp;to&nbsp;https&nbsp;server.&nbsp;&nbsp;In&nbsp;any&nbsp;case,&nbsp;we&#39;ll&nbsp;be&nbsp;ready</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3110890">//&nbsp;to&nbsp;send&nbsp;it&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3110915">pconn</span><span class="op" id="3110920">,</span>&nbsp;<span class="ident" id="3110922">err</span>&nbsp;<span class="op" id="3110926">:=</span>&nbsp;<span class="ident" id="3110929">t</span><span class="op" id="3110930">.</span><span class="ident" id="3110931">getConn</span><span class="op" id="3110938">(</span><span class="ident" id="3110939">req</span><span class="op" id="3110942">,</span>&nbsp;<span class="ident" id="3110944">cm</span><span class="op" id="3110946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3110949">if</span>&nbsp;<span class="ident" id="3110952">err</span>&nbsp;<span class="op" id="3110956">!=</span>&nbsp;<span class="builtintype" id="3110959">nil</span>&nbsp;<span class="op" id="3110963">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3110967">t</span><span class="op" id="3110968">.</span><span class="ident" id="3110969">setReqCanceler</span><span class="op" id="3110983">(</span><span class="ident" id="3110984">req</span><span class="op" id="3110987">,</span>&nbsp;<span class="builtintype" id="3110989">nil</span><span class="op" id="3110992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3110996">req</span><span class="op" id="3110999">.</span><span class="ident" id="3111000">closeBody</span><span class="op" id="3111009">(</span><span class="op" id="3111010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3111014">return</span>&nbsp;<span class="builtintype" id="3111021">nil</span><span class="op" id="3111024">,</span>&nbsp;<span class="ident" id="3111026">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3111031">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3111035">return</span>&nbsp;<span class="ident" id="3111042">pconn</span><span class="op" id="3111047">.</span><span class="ident" id="3111048">roundTrip</span><span class="op" id="3111057">(</span><span class="ident" id="3111058">treq</span><span class="op" id="3111062">)</span><br>
<span class="lineno"></span><span class="op" id="3111064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3111067">//&nbsp;RegisterProtocol&nbsp;registers&nbsp;a&nbsp;new&nbsp;protocol&nbsp;with&nbsp;scheme.</span><br>
<span class="lineno"></span><span class="comment" id="3111125">//&nbsp;The&nbsp;Transport&nbsp;will&nbsp;pass&nbsp;requests&nbsp;using&nbsp;the&nbsp;given&nbsp;scheme&nbsp;to&nbsp;rt.</span><br>
<span class="lineno">240</span><span class="comment" id="3111191">//&nbsp;It&nbsp;is&nbsp;rt&#39;s&nbsp;responsibility&nbsp;to&nbsp;simulate&nbsp;HTTP&nbsp;request&nbsp;semantics.</span><br>
<span class="lineno"></span><span class="comment" id="3111256">//</span><br>
<span class="lineno"></span><span class="comment" id="3111259">//&nbsp;RegisterProtocol&nbsp;can&nbsp;be&nbsp;used&nbsp;by&nbsp;other&nbsp;packages&nbsp;to&nbsp;provide</span><br>
<span class="lineno"></span><span class="comment" id="3111320">//&nbsp;implementations&nbsp;of&nbsp;protocol&nbsp;schemes&nbsp;like&nbsp;&#34;ftp&#34;&nbsp;or&nbsp;&#34;file&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="3111381">func</span>&nbsp;<span class="op" id="3111386">(</span><span class="ident" id="3111387">t</span>&nbsp;<span class="op" id="3111389">*</span><span class="ident" id="3111390">Transport</span><span class="op" id="3111399">)</span>&nbsp;<span class="ident" id="3111401">RegisterProtocol</span><span class="op" id="3111417">(</span><span class="ident" id="3111418">scheme</span>&nbsp;<span class="builtintype" id="3111425">string</span><span class="op" id="3111431">,</span>&nbsp;<span class="ident" id="3111433">rt</span>&nbsp;<span class="ident" id="3111436">RoundTripper</span><span class="op" id="3111448">)</span>&nbsp;<span class="op" id="3111450">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3111453">if</span>&nbsp;<span class="ident" id="3111456">scheme</span>&nbsp;<span class="op" id="3111463">==</span>&nbsp;<span class="string" id="3111466">&#34;http&#34;</span>&nbsp;<span class="op" id="3111473">||</span>&nbsp;<span class="ident" id="3111476">scheme</span>&nbsp;<span class="op" id="3111483">==</span>&nbsp;<span class="string" id="3111486">&#34;https&#34;</span>&nbsp;<span class="op" id="3111494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3111498">panic</span><span class="op" id="3111503">(</span><span class="string" id="3111504">&#34;protocol&nbsp;&#34;</span>&nbsp;<span class="op" id="3111516">+</span>&nbsp;<span class="ident" id="3111518">scheme</span>&nbsp;<span class="op" id="3111525">+</span>&nbsp;<span class="string" id="3111527">&#34;&nbsp;already&nbsp;registered&#34;</span><span class="op" id="3111548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3111551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3111554">t</span><span class="op" id="3111555">.</span><span class="ident" id="3111556">altMu</span><span class="op" id="3111561">.</span><span class="ident" id="3111562">Lock</span><span class="op" id="3111566">(</span><span class="op" id="3111567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3111570">defer</span>&nbsp;<span class="ident" id="3111576">t</span><span class="op" id="3111577">.</span><span class="ident" id="3111578">altMu</span><span class="op" id="3111583">.</span><span class="ident" id="3111584">Unlock</span><span class="op" id="3111590">(</span><span class="op" id="3111591">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3111594">if</span>&nbsp;<span class="ident" id="3111597">t</span><span class="op" id="3111598">.</span><span class="ident" id="3111599">altProto</span>&nbsp;<span class="op" id="3111608">==</span>&nbsp;<span class="builtintype" id="3111611">nil</span>&nbsp;<span class="op" id="3111615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3111619">t</span><span class="op" id="3111620">.</span><span class="ident" id="3111621">altProto</span>&nbsp;<span class="op" id="3111630">=</span>&nbsp;<span class="builtinfunc" id="3111632">make</span><span class="op" id="3111636">(</span><span class="keyword" id="3111637">map</span><span class="op" id="3111640">[</span><span class="builtintype" id="3111641">string</span><span class="op" id="3111647">]</span><span class="ident" id="3111648">RoundTripper</span><span class="op" id="3111660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3111663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3111666">if</span>&nbsp;<span class="ident" id="3111669">_</span><span class="op" id="3111670">,</span>&nbsp;<span class="ident" id="3111672">exists</span>&nbsp;<span class="op" id="3111679">:=</span>&nbsp;<span class="ident" id="3111682">t</span><span class="op" id="3111683">.</span><span class="ident" id="3111684">altProto</span><span class="op" id="3111692">[</span><span class="ident" id="3111693">scheme</span><span class="op" id="3111699">]</span><span class="op" id="3111700">;</span>&nbsp;<span class="ident" id="3111702">exists</span>&nbsp;<span class="op" id="3111709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3111713">panic</span><span class="op" id="3111718">(</span><span class="string" id="3111719">&#34;protocol&nbsp;&#34;</span>&nbsp;<span class="op" id="3111731">+</span>&nbsp;<span class="ident" id="3111733">scheme</span>&nbsp;<span class="op" id="3111740">+</span>&nbsp;<span class="string" id="3111742">&#34;&nbsp;already&nbsp;registered&#34;</span><span class="op" id="3111763">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3111766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3111769">t</span><span class="op" id="3111770">.</span><span class="ident" id="3111771">altProto</span><span class="op" id="3111779">[</span><span class="ident" id="3111780">scheme</span><span class="op" id="3111786">]</span>&nbsp;<span class="op" id="3111788">=</span>&nbsp;<span class="ident" id="3111790">rt</span><br>
<span class="lineno"></span><span class="op" id="3111793">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3111796">//&nbsp;CloseIdleConnections&nbsp;closes&nbsp;any&nbsp;connections&nbsp;which&nbsp;were&nbsp;previously</span><br>
<span class="lineno">260</span><span class="comment" id="3111865">//&nbsp;connected&nbsp;from&nbsp;previous&nbsp;requests&nbsp;but&nbsp;are&nbsp;now&nbsp;sitting&nbsp;idle&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3111929">//&nbsp;a&nbsp;&#34;keep-alive&#34;&nbsp;state.&nbsp;It&nbsp;does&nbsp;not&nbsp;interrupt&nbsp;any&nbsp;connections&nbsp;currently</span><br>
<span class="lineno"></span><span class="comment" id="3112002">//&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="3112013">func</span>&nbsp;<span class="op" id="3112018">(</span><span class="ident" id="3112019">t</span>&nbsp;<span class="op" id="3112021">*</span><span class="ident" id="3112022">Transport</span><span class="op" id="3112031">)</span>&nbsp;<span class="ident" id="3112033">CloseIdleConnections</span><span class="op" id="3112053">(</span><span class="op" id="3112054">)</span>&nbsp;<span class="op" id="3112056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112059">t</span><span class="op" id="3112060">.</span><span class="ident" id="3112061">idleMu</span><span class="op" id="3112067">.</span><span class="ident" id="3112068">Lock</span><span class="op" id="3112072">(</span><span class="op" id="3112073">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112076">m</span>&nbsp;<span class="op" id="3112078">:=</span>&nbsp;<span class="ident" id="3112081">t</span><span class="op" id="3112082">.</span><span class="ident" id="3112083">idleConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112093">t</span><span class="op" id="3112094">.</span><span class="ident" id="3112095">idleConn</span>&nbsp;<span class="op" id="3112104">=</span>&nbsp;<span class="builtintype" id="3112106">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112111">t</span><span class="op" id="3112112">.</span><span class="ident" id="3112113">idleConnCh</span>&nbsp;<span class="op" id="3112124">=</span>&nbsp;<span class="builtintype" id="3112126">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112131">t</span><span class="op" id="3112132">.</span><span class="ident" id="3112133">wantIdle</span>&nbsp;<span class="op" id="3112142">=</span>&nbsp;<span class="builtintype" id="3112144">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112150">t</span><span class="op" id="3112151">.</span><span class="ident" id="3112152">idleMu</span><span class="op" id="3112158">.</span><span class="ident" id="3112159">Unlock</span><span class="op" id="3112165">(</span><span class="op" id="3112166">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3112169">for</span>&nbsp;<span class="ident" id="3112173">_</span><span class="op" id="3112174">,</span>&nbsp;<span class="ident" id="3112176">conns</span>&nbsp;<span class="op" id="3112182">:=</span>&nbsp;<span class="keyword" id="3112185">range</span>&nbsp;<span class="ident" id="3112191">m</span>&nbsp;<span class="op" id="3112193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3112197">for</span>&nbsp;<span class="ident" id="3112201">_</span><span class="op" id="3112202">,</span>&nbsp;<span class="ident" id="3112204">pconn</span>&nbsp;<span class="op" id="3112210">:=</span>&nbsp;<span class="keyword" id="3112213">range</span>&nbsp;<span class="ident" id="3112219">conns</span>&nbsp;<span class="op" id="3112225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112230">pconn</span><span class="op" id="3112235">.</span><span class="builtinfunc" id="3112236">close</span><span class="op" id="3112241">(</span><span class="op" id="3112242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3112246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3112249">}</span><br>
<span class="lineno">275</span><span class="op" id="3112251">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3112254">//&nbsp;CancelRequest&nbsp;cancels&nbsp;an&nbsp;in-flight&nbsp;request&nbsp;by&nbsp;closing&nbsp;its</span><br>
<span class="lineno"></span><span class="comment" id="3112315">//&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3112330">func</span>&nbsp;<span class="op" id="3112335">(</span><span class="ident" id="3112336">t</span>&nbsp;<span class="op" id="3112338">*</span><span class="ident" id="3112339">Transport</span><span class="op" id="3112348">)</span>&nbsp;<span class="ident" id="3112350">CancelRequest</span><span class="op" id="3112363">(</span><span class="ident" id="3112364">req</span>&nbsp;<span class="op" id="3112368">*</span><span class="ident" id="3112369">Request</span><span class="op" id="3112376">)</span>&nbsp;<span class="op" id="3112378">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112381">t</span><span class="op" id="3112382">.</span><span class="ident" id="3112383">reqMu</span><span class="op" id="3112388">.</span><span class="ident" id="3112389">Lock</span><span class="op" id="3112393">(</span><span class="op" id="3112394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112397">cancel</span>&nbsp;<span class="op" id="3112404">:=</span>&nbsp;<span class="ident" id="3112407">t</span><span class="op" id="3112408">.</span><span class="ident" id="3112409">reqCanceler</span><span class="op" id="3112420">[</span><span class="ident" id="3112421">req</span><span class="op" id="3112424">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112427">t</span><span class="op" id="3112428">.</span><span class="ident" id="3112429">reqMu</span><span class="op" id="3112434">.</span><span class="ident" id="3112435">Unlock</span><span class="op" id="3112441">(</span><span class="op" id="3112442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3112445">if</span>&nbsp;<span class="ident" id="3112448">cancel</span>&nbsp;<span class="op" id="3112455">!=</span>&nbsp;<span class="builtintype" id="3112458">nil</span>&nbsp;<span class="op" id="3112462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112466">cancel</span><span class="op" id="3112472">(</span><span class="op" id="3112473">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3112476">}</span><br>
<span class="lineno"></span><span class="op" id="3112478">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3112481">//</span><br>
<span class="lineno"></span><span class="comment" id="3112484">//&nbsp;Private&nbsp;implementation&nbsp;past&nbsp;this&nbsp;point.</span><br>
<span class="lineno">290</span><span class="comment" id="3112527">//</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3112531">var</span>&nbsp;<span class="op" id="3112535">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112538">httpProxyEnv</span>&nbsp;<span class="op" id="3112551">=</span>&nbsp;<span class="op" id="3112553">&amp;</span><span class="ident" id="3112554">envOnce</span><span class="op" id="3112561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112565">names</span><span class="op" id="3112570">:</span>&nbsp;<span class="op" id="3112572">[</span><span class="op" id="3112573">]</span><span class="builtintype" id="3112574">string</span><span class="op" id="3112580">{</span><span class="string" id="3112581">&#34;HTTP_PROXY&#34;</span><span class="op" id="3112593">,</span>&nbsp;<span class="string" id="3112595">&#34;http_proxy&#34;</span><span class="op" id="3112607">}</span><span class="op" id="3112608">,</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3112611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112614">httpsProxyEnv</span>&nbsp;<span class="op" id="3112628">=</span>&nbsp;<span class="op" id="3112630">&amp;</span><span class="ident" id="3112631">envOnce</span><span class="op" id="3112638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112642">names</span><span class="op" id="3112647">:</span>&nbsp;<span class="op" id="3112649">[</span><span class="op" id="3112650">]</span><span class="builtintype" id="3112651">string</span><span class="op" id="3112657">{</span><span class="string" id="3112658">&#34;HTTPS_PROXY&#34;</span><span class="op" id="3112671">,</span>&nbsp;<span class="string" id="3112673">&#34;https_proxy&#34;</span><span class="op" id="3112686">}</span><span class="op" id="3112687">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3112690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112693">noProxyEnv</span>&nbsp;<span class="op" id="3112704">=</span>&nbsp;<span class="op" id="3112706">&amp;</span><span class="ident" id="3112707">envOnce</span><span class="op" id="3112714">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112718">names</span><span class="op" id="3112723">:</span>&nbsp;<span class="op" id="3112725">[</span><span class="op" id="3112726">]</span><span class="builtintype" id="3112727">string</span><span class="op" id="3112733">{</span><span class="string" id="3112734">&#34;NO_PROXY&#34;</span><span class="op" id="3112744">,</span>&nbsp;<span class="string" id="3112746">&#34;no_proxy&#34;</span><span class="op" id="3112756">}</span><span class="op" id="3112757">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3112760">}</span><br>
<span class="lineno"></span><span class="op" id="3112762">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3112765">//&nbsp;envOnce&nbsp;looks&nbsp;up&nbsp;an&nbsp;environment&nbsp;variable&nbsp;(optionally&nbsp;by&nbsp;multiple</span><br>
<span class="lineno">305</span><span class="comment" id="3112833">//&nbsp;names)&nbsp;once.&nbsp;It&nbsp;mitigates&nbsp;expensive&nbsp;lookups&nbsp;on&nbsp;some&nbsp;platforms</span><br>
<span class="lineno"></span><span class="comment" id="3112898">//&nbsp;(e.g.&nbsp;Windows).</span><br>
<span class="lineno"></span><span class="keyword" id="3112917">type</span>&nbsp;<span class="ident" id="3112922">envOnce</span>&nbsp;<span class="keyword" id="3112930">struct</span>&nbsp;<span class="op" id="3112937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112940">names</span>&nbsp;<span class="op" id="3112946">[</span><span class="op" id="3112947">]</span><span class="builtintype" id="3112948">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112956">once</span>&nbsp;&nbsp;<span class="ident" id="3112962">sync</span><span class="op" id="3112966">.</span><span class="ident" id="3112967">Once</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112973">val</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3112979">string</span><br>
<span class="lineno"></span><span class="op" id="3112986">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3112989">func</span>&nbsp;<span class="op" id="3112994">(</span><span class="ident" id="3112995">e</span>&nbsp;<span class="op" id="3112997">*</span><span class="ident" id="3112998">envOnce</span><span class="op" id="3113005">)</span>&nbsp;<span class="ident" id="3113007">Get</span><span class="op" id="3113010">(</span><span class="op" id="3113011">)</span>&nbsp;<span class="builtintype" id="3113013">string</span>&nbsp;<span class="op" id="3113020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3113023">e</span><span class="op" id="3113024">.</span><span class="ident" id="3113025">once</span><span class="op" id="3113029">.</span><span class="ident" id="3113030">Do</span><span class="op" id="3113032">(</span><span class="ident" id="3113033">e</span><span class="op" id="3113034">.</span><span class="ident" id="3113035">init</span><span class="op" id="3113039">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3113042">return</span>&nbsp;<span class="ident" id="3113049">e</span><span class="op" id="3113050">.</span><span class="ident" id="3113051">val</span><br>
<span class="lineno"></span><span class="op" id="3113055">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3113058">func</span>&nbsp;<span class="op" id="3113063">(</span><span class="ident" id="3113064">e</span>&nbsp;<span class="op" id="3113066">*</span><span class="ident" id="3113067">envOnce</span><span class="op" id="3113074">)</span>&nbsp;<span class="ident" id="3113076">init</span><span class="op" id="3113080">(</span><span class="op" id="3113081">)</span>&nbsp;<span class="op" id="3113083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3113086">for</span>&nbsp;<span class="ident" id="3113090">_</span><span class="op" id="3113091">,</span>&nbsp;<span class="ident" id="3113093">n</span>&nbsp;<span class="op" id="3113095">:=</span>&nbsp;<span class="keyword" id="3113098">range</span>&nbsp;<span class="ident" id="3113104">e</span><span class="op" id="3113105">.</span><span class="ident" id="3113106">names</span>&nbsp;<span class="op" id="3113112">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3113116">e</span><span class="op" id="3113117">.</span><span class="ident" id="3113118">val</span>&nbsp;<span class="op" id="3113122">=</span>&nbsp;<span class="ident" id="3113124">os</span><span class="op" id="3113126">.</span><span class="ident" id="3113127">Getenv</span><span class="op" id="3113133">(</span><span class="ident" id="3113134">n</span><span class="op" id="3113135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3113139">if</span>&nbsp;<span class="ident" id="3113142">e</span><span class="op" id="3113143">.</span><span class="ident" id="3113144">val</span>&nbsp;<span class="op" id="3113148">!=</span>&nbsp;<span class="string" id="3113151">&#34;&#34;</span>&nbsp;<span class="op" id="3113154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3113159">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3113168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3113171">}</span><br>
<span class="lineno">325</span><span class="op" id="3113173">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3113176">//&nbsp;reset&nbsp;is&nbsp;used&nbsp;by&nbsp;tests</span><br>
<span class="lineno"></span><span class="keyword" id="3113202">func</span>&nbsp;<span class="op" id="3113207">(</span><span class="ident" id="3113208">e</span>&nbsp;<span class="op" id="3113210">*</span><span class="ident" id="3113211">envOnce</span><span class="op" id="3113218">)</span>&nbsp;<span class="ident" id="3113220">reset</span><span class="op" id="3113225">(</span><span class="op" id="3113226">)</span>&nbsp;<span class="op" id="3113228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3113231">e</span><span class="op" id="3113232">.</span><span class="ident" id="3113233">once</span>&nbsp;<span class="op" id="3113238">=</span>&nbsp;<span class="ident" id="3113240">sync</span><span class="op" id="3113244">.</span><span class="ident" id="3113245">Once</span><span class="op" id="3113249">{</span><span class="op" id="3113250">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3113253">e</span><span class="op" id="3113254">.</span><span class="ident" id="3113255">val</span>&nbsp;<span class="op" id="3113259">=</span>&nbsp;<span class="string" id="3113261">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="3113264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3113267">func</span>&nbsp;<span class="op" id="3113272">(</span><span class="ident" id="3113273">t</span>&nbsp;<span class="op" id="3113275">*</span><span class="ident" id="3113276">Transport</span><span class="op" id="3113285">)</span>&nbsp;<span class="ident" id="3113287">connectMethodForRequest</span><span class="op" id="3113310">(</span><span class="ident" id="3113311">treq</span>&nbsp;<span class="op" id="3113316">*</span><span class="ident" id="3113317">transportRequest</span><span class="op" id="3113333">)</span>&nbsp;<span class="op" id="3113335">(</span><span class="ident" id="3113336">cm</span>&nbsp;<span class="ident" id="3113339">connectMethod</span><span class="op" id="3113352">,</span>&nbsp;<span class="ident" id="3113354">err</span>&nbsp;<span class="builtintype" id="3113358">error</span><span class="op" id="3113363">)</span>&nbsp;<span class="op" id="3113365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3113368">cm</span><span class="op" id="3113370">.</span><span class="ident" id="3113371">targetScheme</span>&nbsp;<span class="op" id="3113384">=</span>&nbsp;<span class="ident" id="3113386">treq</span><span class="op" id="3113390">.</span><span class="ident" id="3113391">URL</span><span class="op" id="3113394">.</span><span class="ident" id="3113395">Scheme</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3113403">cm</span><span class="op" id="3113405">.</span><span class="ident" id="3113406">targetAddr</span>&nbsp;<span class="op" id="3113417">=</span>&nbsp;<span class="ident" id="3113419">canonicalAddr</span><span class="op" id="3113432">(</span><span class="ident" id="3113433">treq</span><span class="op" id="3113437">.</span><span class="ident" id="3113438">URL</span><span class="op" id="3113441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3113444">if</span>&nbsp;<span class="ident" id="3113447">t</span><span class="op" id="3113448">.</span><span class="ident" id="3113449">Proxy</span>&nbsp;<span class="op" id="3113455">!=</span>&nbsp;<span class="builtintype" id="3113458">nil</span>&nbsp;<span class="op" id="3113462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3113466">cm</span><span class="op" id="3113468">.</span><span class="ident" id="3113469">proxyURL</span><span class="op" id="3113477">,</span>&nbsp;<span class="ident" id="3113479">err</span>&nbsp;<span class="op" id="3113483">=</span>&nbsp;<span class="ident" id="3113485">t</span><span class="op" id="3113486">.</span><span class="ident" id="3113487">Proxy</span><span class="op" id="3113492">(</span><span class="ident" id="3113493">treq</span><span class="op" id="3113497">.</span><span class="ident" id="3113498">Request</span><span class="op" id="3113505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3113508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3113511">return</span>&nbsp;<span class="ident" id="3113518">cm</span><span class="op" id="3113520">,</span>&nbsp;<span class="ident" id="3113522">err</span><br>
<span class="lineno">340</span><span class="op" id="3113526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3113529">//&nbsp;proxyAuth&nbsp;returns&nbsp;the&nbsp;Proxy-Authorization&nbsp;header&nbsp;to&nbsp;set</span><br>
<span class="lineno"></span><span class="comment" id="3113588">//&nbsp;on&nbsp;requests,&nbsp;if&nbsp;applicable.</span><br>
<span class="lineno"></span><span class="keyword" id="3113619">func</span>&nbsp;<span class="op" id="3113624">(</span><span class="ident" id="3113625">cm</span>&nbsp;<span class="op" id="3113628">*</span><span class="ident" id="3113629">connectMethod</span><span class="op" id="3113642">)</span>&nbsp;<span class="ident" id="3113644">proxyAuth</span><span class="op" id="3113653">(</span><span class="op" id="3113654">)</span>&nbsp;<span class="builtintype" id="3113656">string</span>&nbsp;<span class="op" id="3113663">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3113666">if</span>&nbsp;<span class="ident" id="3113669">cm</span><span class="op" id="3113671">.</span><span class="ident" id="3113672">proxyURL</span>&nbsp;<span class="op" id="3113681">==</span>&nbsp;<span class="builtintype" id="3113684">nil</span>&nbsp;<span class="op" id="3113688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3113692">return</span>&nbsp;<span class="string" id="3113699">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3113703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3113706">if</span>&nbsp;<span class="ident" id="3113709">u</span>&nbsp;<span class="op" id="3113711">:=</span>&nbsp;<span class="ident" id="3113714">cm</span><span class="op" id="3113716">.</span><span class="ident" id="3113717">proxyURL</span><span class="op" id="3113725">.</span><span class="ident" id="3113726">User</span><span class="op" id="3113730">;</span>&nbsp;<span class="ident" id="3113732">u</span>&nbsp;<span class="op" id="3113734">!=</span>&nbsp;<span class="builtintype" id="3113737">nil</span>&nbsp;<span class="op" id="3113741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3113745">username</span>&nbsp;<span class="op" id="3113754">:=</span>&nbsp;<span class="ident" id="3113757">u</span><span class="op" id="3113758">.</span><span class="ident" id="3113759">Username</span><span class="op" id="3113767">(</span><span class="op" id="3113768">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3113772">password</span><span class="op" id="3113780">,</span>&nbsp;<span class="ident" id="3113782">_</span>&nbsp;<span class="op" id="3113784">:=</span>&nbsp;<span class="ident" id="3113787">u</span><span class="op" id="3113788">.</span><span class="ident" id="3113789">Password</span><span class="op" id="3113797">(</span><span class="op" id="3113798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3113802">return</span>&nbsp;<span class="string" id="3113809">&#34;Basic&nbsp;&#34;</span>&nbsp;<span class="op" id="3113818">+</span>&nbsp;<span class="ident" id="3113820">basicAuth</span><span class="op" id="3113829">(</span><span class="ident" id="3113830">username</span><span class="op" id="3113838">,</span>&nbsp;<span class="ident" id="3113840">password</span><span class="op" id="3113848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3113851">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3113854">return</span>&nbsp;<span class="string" id="3113861">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="3113864">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span><span class="comment" id="3113867">//&nbsp;putIdleConn&nbsp;adds&nbsp;pconn&nbsp;to&nbsp;the&nbsp;list&nbsp;of&nbsp;idle&nbsp;persistent&nbsp;connections&nbsp;awaiting</span><br>
<span class="lineno"></span><span class="comment" id="3113945">//&nbsp;a&nbsp;new&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="3113963">//&nbsp;If&nbsp;pconn&nbsp;is&nbsp;no&nbsp;longer&nbsp;needed&nbsp;or&nbsp;not&nbsp;in&nbsp;a&nbsp;good&nbsp;state,&nbsp;putIdleConn</span><br>
<span class="lineno"></span><span class="comment" id="3114031">//&nbsp;returns&nbsp;false.</span><br>
<span class="lineno">360</span><span class="keyword" id="3114049">func</span>&nbsp;<span class="op" id="3114054">(</span><span class="ident" id="3114055">t</span>&nbsp;<span class="op" id="3114057">*</span><span class="ident" id="3114058">Transport</span><span class="op" id="3114067">)</span>&nbsp;<span class="ident" id="3114069">putIdleConn</span><span class="op" id="3114080">(</span><span class="ident" id="3114081">pconn</span>&nbsp;<span class="op" id="3114087">*</span><span class="ident" id="3114088">persistConn</span><span class="op" id="3114099">)</span>&nbsp;<span class="builtintype" id="3114101">bool</span>&nbsp;<span class="op" id="3114106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114109">if</span>&nbsp;<span class="ident" id="3114112">t</span><span class="op" id="3114113">.</span><span class="ident" id="3114114">DisableKeepAlives</span>&nbsp;<span class="op" id="3114132">||</span>&nbsp;<span class="ident" id="3114135">t</span><span class="op" id="3114136">.</span><span class="ident" id="3114137">MaxIdleConnsPerHost</span>&nbsp;<span class="op" id="3114157">&lt;</span>&nbsp;<span class="num" id="3114159">0</span>&nbsp;<span class="op" id="3114161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3114165">pconn</span><span class="op" id="3114170">.</span><span class="builtinfunc" id="3114171">close</span><span class="op" id="3114176">(</span><span class="op" id="3114177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114181">return</span>&nbsp;<span class="builtintype" id="3114188">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3114195">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114198">if</span>&nbsp;<span class="ident" id="3114201">pconn</span><span class="op" id="3114206">.</span><span class="ident" id="3114207">isBroken</span><span class="op" id="3114215">(</span><span class="op" id="3114216">)</span>&nbsp;<span class="op" id="3114218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114222">return</span>&nbsp;<span class="builtintype" id="3114229">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3114236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3114239">key</span>&nbsp;<span class="op" id="3114243">:=</span>&nbsp;<span class="ident" id="3114246">pconn</span><span class="op" id="3114251">.</span><span class="ident" id="3114252">cacheKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3114262">max</span>&nbsp;<span class="op" id="3114266">:=</span>&nbsp;<span class="ident" id="3114269">t</span><span class="op" id="3114270">.</span><span class="ident" id="3114271">MaxIdleConnsPerHost</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114292">if</span>&nbsp;<span class="ident" id="3114295">max</span>&nbsp;<span class="op" id="3114299">==</span>&nbsp;<span class="num" id="3114302">0</span>&nbsp;<span class="op" id="3114304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3114308">max</span>&nbsp;<span class="op" id="3114312">=</span>&nbsp;<span class="ident" id="3114314">DefaultMaxIdleConnsPerHost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3114342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3114345">t</span><span class="op" id="3114346">.</span><span class="ident" id="3114347">idleMu</span><span class="op" id="3114353">.</span><span class="ident" id="3114354">Lock</span><span class="op" id="3114358">(</span><span class="op" id="3114359">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3114363">waitingDialer</span>&nbsp;<span class="op" id="3114377">:=</span>&nbsp;<span class="ident" id="3114380">t</span><span class="op" id="3114381">.</span><span class="ident" id="3114382">idleConnCh</span><span class="op" id="3114392">[</span><span class="ident" id="3114393">key</span><span class="op" id="3114396">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114399">select</span>&nbsp;<span class="op" id="3114406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114409">case</span>&nbsp;<span class="ident" id="3114414">waitingDialer</span>&nbsp;<span class="op" id="3114428">&lt;-</span>&nbsp;<span class="ident" id="3114431">pconn</span><span class="op" id="3114436">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3114440">//&nbsp;We&#39;re&nbsp;done&nbsp;with&nbsp;this&nbsp;pconn&nbsp;and&nbsp;somebody&nbsp;else&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3114493">//&nbsp;currently&nbsp;waiting&nbsp;for&nbsp;a&nbsp;conn&nbsp;of&nbsp;this&nbsp;type&nbsp;(they&#39;re</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3114549">//&nbsp;actively&nbsp;dialing,&nbsp;but&nbsp;this&nbsp;conn&nbsp;is&nbsp;ready</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3114595">//&nbsp;first).&nbsp;Chrome&nbsp;calls&nbsp;this&nbsp;socket&nbsp;late&nbsp;binding.&nbsp;&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3114652">//&nbsp;https://insouciant.org/tech/connection-management-in-chromium/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3114720">t</span><span class="op" id="3114721">.</span><span class="ident" id="3114722">idleMu</span><span class="op" id="3114728">.</span><span class="ident" id="3114729">Unlock</span><span class="op" id="3114735">(</span><span class="op" id="3114736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114740">return</span>&nbsp;<span class="builtintype" id="3114747">true</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114753">default</span><span class="op" id="3114760">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114764">if</span>&nbsp;<span class="ident" id="3114767">waitingDialer</span>&nbsp;<span class="op" id="3114781">!=</span>&nbsp;<span class="builtintype" id="3114784">nil</span>&nbsp;<span class="op" id="3114788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3114793">//&nbsp;They&nbsp;had&nbsp;populated&nbsp;this,&nbsp;but&nbsp;their&nbsp;dial&nbsp;won</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3114843">//&nbsp;first,&nbsp;so&nbsp;we&nbsp;can&nbsp;clean&nbsp;up&nbsp;this&nbsp;map&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3114891">delete</span><span class="op" id="3114897">(</span><span class="ident" id="3114898">t</span><span class="op" id="3114899">.</span><span class="ident" id="3114900">idleConnCh</span><span class="op" id="3114910">,</span>&nbsp;<span class="ident" id="3114912">key</span><span class="op" id="3114915">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3114919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3114922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114925">if</span>&nbsp;<span class="ident" id="3114928">t</span><span class="op" id="3114929">.</span><span class="ident" id="3114930">wantIdle</span>&nbsp;<span class="op" id="3114939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3114943">t</span><span class="op" id="3114944">.</span><span class="ident" id="3114945">idleMu</span><span class="op" id="3114951">.</span><span class="ident" id="3114952">Unlock</span><span class="op" id="3114958">(</span><span class="op" id="3114959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3114963">pconn</span><span class="op" id="3114968">.</span><span class="builtinfunc" id="3114969">close</span><span class="op" id="3114974">(</span><span class="op" id="3114975">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114979">return</span>&nbsp;<span class="builtintype" id="3114986">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3114993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114996">if</span>&nbsp;<span class="ident" id="3114999">t</span><span class="op" id="3115000">.</span><span class="ident" id="3115001">idleConn</span>&nbsp;<span class="op" id="3115010">==</span>&nbsp;<span class="builtintype" id="3115013">nil</span>&nbsp;<span class="op" id="3115017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3115021">t</span><span class="op" id="3115022">.</span><span class="ident" id="3115023">idleConn</span>&nbsp;<span class="op" id="3115032">=</span>&nbsp;<span class="builtinfunc" id="3115034">make</span><span class="op" id="3115038">(</span><span class="keyword" id="3115039">map</span><span class="op" id="3115042">[</span><span class="ident" id="3115043">connectMethodKey</span><span class="op" id="3115059">]</span><span class="op" id="3115060">[</span><span class="op" id="3115061">]</span><span class="op" id="3115062">*</span><span class="ident" id="3115063">persistConn</span><span class="op" id="3115074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3115077">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3115080">if</span>&nbsp;<span class="builtinfunc" id="3115083">len</span><span class="op" id="3115086">(</span><span class="ident" id="3115087">t</span><span class="op" id="3115088">.</span><span class="ident" id="3115089">idleConn</span><span class="op" id="3115097">[</span><span class="ident" id="3115098">key</span><span class="op" id="3115101">]</span><span class="op" id="3115102">)</span>&nbsp;<span class="op" id="3115104">&gt;=</span>&nbsp;<span class="ident" id="3115107">max</span>&nbsp;<span class="op" id="3115111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3115115">t</span><span class="op" id="3115116">.</span><span class="ident" id="3115117">idleMu</span><span class="op" id="3115123">.</span><span class="ident" id="3115124">Unlock</span><span class="op" id="3115130">(</span><span class="op" id="3115131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3115135">pconn</span><span class="op" id="3115140">.</span><span class="builtinfunc" id="3115141">close</span><span class="op" id="3115146">(</span><span class="op" id="3115147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3115151">return</span>&nbsp;<span class="builtintype" id="3115158">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3115165">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3115168">for</span>&nbsp;<span class="ident" id="3115172">_</span><span class="op" id="3115173">,</span>&nbsp;<span class="ident" id="3115175">exist</span>&nbsp;<span class="op" id="3115181">:=</span>&nbsp;<span class="keyword" id="3115184">range</span>&nbsp;<span class="ident" id="3115190">t</span><span class="op" id="3115191">.</span><span class="ident" id="3115192">idleConn</span><span class="op" id="3115200">[</span><span class="ident" id="3115201">key</span><span class="op" id="3115204">]</span>&nbsp;<span class="op" id="3115206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3115210">if</span>&nbsp;<span class="ident" id="3115213">exist</span>&nbsp;<span class="op" id="3115219">==</span>&nbsp;<span class="ident" id="3115222">pconn</span>&nbsp;<span class="op" id="3115228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3115233">log</span><span class="op" id="3115236">.</span><span class="ident" id="3115237">Fatalf</span><span class="op" id="3115243">(</span><span class="string" id="3115244">&#34;dup&nbsp;idle&nbsp;pconn&nbsp;%p&nbsp;in&nbsp;freelist&#34;</span><span class="op" id="3115275">,</span>&nbsp;<span class="ident" id="3115277">pconn</span><span class="op" id="3115282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3115286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3115289">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3115292">t</span><span class="op" id="3115293">.</span><span class="ident" id="3115294">idleConn</span><span class="op" id="3115302">[</span><span class="ident" id="3115303">key</span><span class="op" id="3115306">]</span>&nbsp;<span class="op" id="3115308">=</span>&nbsp;<span class="builtinfunc" id="3115310">append</span><span class="op" id="3115316">(</span><span class="ident" id="3115317">t</span><span class="op" id="3115318">.</span><span class="ident" id="3115319">idleConn</span><span class="op" id="3115327">[</span><span class="ident" id="3115328">key</span><span class="op" id="3115331">]</span><span class="op" id="3115332">,</span>&nbsp;<span class="ident" id="3115334">pconn</span><span class="op" id="3115339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3115342">t</span><span class="op" id="3115343">.</span><span class="ident" id="3115344">idleMu</span><span class="op" id="3115350">.</span><span class="ident" id="3115351">Unlock</span><span class="op" id="3115357">(</span><span class="op" id="3115358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3115361">return</span>&nbsp;<span class="builtintype" id="3115368">true</span><br>
<span class="lineno"></span><span class="op" id="3115373">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="3115376">//&nbsp;getIdleConnCh&nbsp;returns&nbsp;a&nbsp;channel&nbsp;to&nbsp;receive&nbsp;and&nbsp;return&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="3115438">//&nbsp;persistent&nbsp;connection&nbsp;for&nbsp;the&nbsp;given&nbsp;connectMethod.</span><br>
<span class="lineno"></span><span class="comment" id="3115492">//&nbsp;It&nbsp;may&nbsp;return&nbsp;nil,&nbsp;if&nbsp;persistent&nbsp;connections&nbsp;are&nbsp;not&nbsp;being&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3115560">func</span>&nbsp;<span class="op" id="3115565">(</span><span class="ident" id="3115566">t</span>&nbsp;<span class="op" id="3115568">*</span><span class="ident" id="3115569">Transport</span><span class="op" id="3115578">)</span>&nbsp;<span class="ident" id="3115580">getIdleConnCh</span><span class="op" id="3115593">(</span><span class="ident" id="3115594">cm</span>&nbsp;<span class="ident" id="3115597">connectMethod</span><span class="op" id="3115610">)</span>&nbsp;<span class="keyword" id="3115612">chan</span>&nbsp;<span class="op" id="3115617">*</span><span class="ident" id="3115618">persistConn</span>&nbsp;<span class="op" id="3115630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3115633">if</span>&nbsp;<span class="ident" id="3115636">t</span><span class="op" id="3115637">.</span><span class="ident" id="3115638">DisableKeepAlives</span>&nbsp;<span class="op" id="3115656">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3115660">return</span>&nbsp;<span class="builtintype" id="3115667">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3115672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3115675">key</span>&nbsp;<span class="op" id="3115679">:=</span>&nbsp;<span class="ident" id="3115682">cm</span><span class="op" id="3115684">.</span><span class="ident" id="3115685">key</span><span class="op" id="3115688">(</span><span class="op" id="3115689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3115692">t</span><span class="op" id="3115693">.</span><span class="ident" id="3115694">idleMu</span><span class="op" id="3115700">.</span><span class="ident" id="3115701">Lock</span><span class="op" id="3115705">(</span><span class="op" id="3115706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3115709">defer</span>&nbsp;<span class="ident" id="3115715">t</span><span class="op" id="3115716">.</span><span class="ident" id="3115717">idleMu</span><span class="op" id="3115723">.</span><span class="ident" id="3115724">Unlock</span><span class="op" id="3115730">(</span><span class="op" id="3115731">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3115734">t</span><span class="op" id="3115735">.</span><span class="ident" id="3115736">wantIdle</span>&nbsp;<span class="op" id="3115745">=</span>&nbsp;<span class="builtintype" id="3115747">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3115754">if</span>&nbsp;<span class="ident" id="3115757">t</span><span class="op" id="3115758">.</span><span class="ident" id="3115759">idleConnCh</span>&nbsp;<span class="op" id="3115770">==</span>&nbsp;<span class="builtintype" id="3115773">nil</span>&nbsp;<span class="op" id="3115777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3115781">t</span><span class="op" id="3115782">.</span><span class="ident" id="3115783">idleConnCh</span>&nbsp;<span class="op" id="3115794">=</span>&nbsp;<span class="builtinfunc" id="3115796">make</span><span class="op" id="3115800">(</span><span class="keyword" id="3115801">map</span><span class="op" id="3115804">[</span><span class="ident" id="3115805">connectMethodKey</span><span class="op" id="3115821">]</span><span class="keyword" id="3115822">chan</span>&nbsp;<span class="op" id="3115827">*</span><span class="ident" id="3115828">persistConn</span><span class="op" id="3115839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3115842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3115845">ch</span><span class="op" id="3115847">,</span>&nbsp;<span class="ident" id="3115849">ok</span>&nbsp;<span class="op" id="3115852">:=</span>&nbsp;<span class="ident" id="3115855">t</span><span class="op" id="3115856">.</span><span class="ident" id="3115857">idleConnCh</span><span class="op" id="3115867">[</span><span class="ident" id="3115868">key</span><span class="op" id="3115871">]</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3115874">if</span>&nbsp;<span class="op" id="3115877">!</span><span class="ident" id="3115878">ok</span>&nbsp;<span class="op" id="3115881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3115885">ch</span>&nbsp;<span class="op" id="3115888">=</span>&nbsp;<span class="builtinfunc" id="3115890">make</span><span class="op" id="3115894">(</span><span class="keyword" id="3115895">chan</span>&nbsp;<span class="op" id="3115900">*</span><span class="ident" id="3115901">persistConn</span><span class="op" id="3115912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3115916">t</span><span class="op" id="3115917">.</span><span class="ident" id="3115918">idleConnCh</span><span class="op" id="3115928">[</span><span class="ident" id="3115929">key</span><span class="op" id="3115932">]</span>&nbsp;<span class="op" id="3115934">=</span>&nbsp;<span class="ident" id="3115936">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3115940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3115943">return</span>&nbsp;<span class="ident" id="3115950">ch</span><br>
<span class="lineno">435</span><span class="op" id="3115953">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3115956">func</span>&nbsp;<span class="op" id="3115961">(</span><span class="ident" id="3115962">t</span>&nbsp;<span class="op" id="3115964">*</span><span class="ident" id="3115965">Transport</span><span class="op" id="3115974">)</span>&nbsp;<span class="ident" id="3115976">getIdleConn</span><span class="op" id="3115987">(</span><span class="ident" id="3115988">cm</span>&nbsp;<span class="ident" id="3115991">connectMethod</span><span class="op" id="3116004">)</span>&nbsp;<span class="op" id="3116006">(</span><span class="ident" id="3116007">pconn</span>&nbsp;<span class="op" id="3116013">*</span><span class="ident" id="3116014">persistConn</span><span class="op" id="3116025">)</span>&nbsp;<span class="op" id="3116027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3116030">key</span>&nbsp;<span class="op" id="3116034">:=</span>&nbsp;<span class="ident" id="3116037">cm</span><span class="op" id="3116039">.</span><span class="ident" id="3116040">key</span><span class="op" id="3116043">(</span><span class="op" id="3116044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3116047">t</span><span class="op" id="3116048">.</span><span class="ident" id="3116049">idleMu</span><span class="op" id="3116055">.</span><span class="ident" id="3116056">Lock</span><span class="op" id="3116060">(</span><span class="op" id="3116061">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3116064">defer</span>&nbsp;<span class="ident" id="3116070">t</span><span class="op" id="3116071">.</span><span class="ident" id="3116072">idleMu</span><span class="op" id="3116078">.</span><span class="ident" id="3116079">Unlock</span><span class="op" id="3116085">(</span><span class="op" id="3116086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3116089">if</span>&nbsp;<span class="ident" id="3116092">t</span><span class="op" id="3116093">.</span><span class="ident" id="3116094">idleConn</span>&nbsp;<span class="op" id="3116103">==</span>&nbsp;<span class="builtintype" id="3116106">nil</span>&nbsp;<span class="op" id="3116110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3116114">return</span>&nbsp;<span class="builtintype" id="3116121">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3116126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3116129">for</span>&nbsp;<span class="op" id="3116133">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3116137">pconns</span><span class="op" id="3116143">,</span>&nbsp;<span class="ident" id="3116145">ok</span>&nbsp;<span class="op" id="3116148">:=</span>&nbsp;<span class="ident" id="3116151">t</span><span class="op" id="3116152">.</span><span class="ident" id="3116153">idleConn</span><span class="op" id="3116161">[</span><span class="ident" id="3116162">key</span><span class="op" id="3116165">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3116169">if</span>&nbsp;<span class="op" id="3116172">!</span><span class="ident" id="3116173">ok</span>&nbsp;<span class="op" id="3116176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3116181">return</span>&nbsp;<span class="builtintype" id="3116188">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3116194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3116198">if</span>&nbsp;<span class="builtinfunc" id="3116201">len</span><span class="op" id="3116204">(</span><span class="ident" id="3116205">pconns</span><span class="op" id="3116211">)</span>&nbsp;<span class="op" id="3116213">==</span>&nbsp;<span class="num" id="3116216">1</span>&nbsp;<span class="op" id="3116218">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3116223">pconn</span>&nbsp;<span class="op" id="3116229">=</span>&nbsp;<span class="ident" id="3116231">pconns</span><span class="op" id="3116237">[</span><span class="num" id="3116238">0</span><span class="op" id="3116239">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3116244">delete</span><span class="op" id="3116250">(</span><span class="ident" id="3116251">t</span><span class="op" id="3116252">.</span><span class="ident" id="3116253">idleConn</span><span class="op" id="3116261">,</span>&nbsp;<span class="ident" id="3116263">key</span><span class="op" id="3116266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3116270">}</span>&nbsp;<span class="keyword" id="3116272">else</span>&nbsp;<span class="op" id="3116277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3116282">//&nbsp;2&nbsp;or&nbsp;more&nbsp;cached&nbsp;connections;&nbsp;pop&nbsp;last</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3116327">//&nbsp;TODO:&nbsp;queue?</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3116346">pconn</span>&nbsp;<span class="op" id="3116352">=</span>&nbsp;<span class="ident" id="3116354">pconns</span><span class="op" id="3116360">[</span><span class="builtinfunc" id="3116361">len</span><span class="op" id="3116364">(</span><span class="ident" id="3116365">pconns</span><span class="op" id="3116371">)</span><span class="op" id="3116372">-</span><span class="num" id="3116373">1</span><span class="op" id="3116374">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3116379">t</span><span class="op" id="3116380">.</span><span class="ident" id="3116381">idleConn</span><span class="op" id="3116389">[</span><span class="ident" id="3116390">key</span><span class="op" id="3116393">]</span>&nbsp;<span class="op" id="3116395">=</span>&nbsp;<span class="ident" id="3116397">pconns</span><span class="op" id="3116403">[</span><span class="op" id="3116404">:</span><span class="builtinfunc" id="3116405">len</span><span class="op" id="3116408">(</span><span class="ident" id="3116409">pconns</span><span class="op" id="3116415">)</span><span class="op" id="3116416">-</span><span class="num" id="3116417">1</span><span class="op" id="3116418">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3116422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3116426">if</span>&nbsp;<span class="op" id="3116429">!</span><span class="ident" id="3116430">pconn</span><span class="op" id="3116435">.</span><span class="ident" id="3116436">isBroken</span><span class="op" id="3116444">(</span><span class="op" id="3116445">)</span>&nbsp;<span class="op" id="3116447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3116452">return</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3116461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3116464">}</span><br>
<span class="lineno"></span><span class="op" id="3116466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3116469">func</span>&nbsp;<span class="op" id="3116474">(</span><span class="ident" id="3116475">t</span>&nbsp;<span class="op" id="3116477">*</span><span class="ident" id="3116478">Transport</span><span class="op" id="3116487">)</span>&nbsp;<span class="ident" id="3116489">setReqCanceler</span><span class="op" id="3116503">(</span><span class="ident" id="3116504">r</span>&nbsp;<span class="op" id="3116506">*</span><span class="ident" id="3116507">Request</span><span class="op" id="3116514">,</span>&nbsp;<span class="ident" id="3116516">fn</span>&nbsp;<span class="keyword" id="3116519">func</span><span class="op" id="3116523">(</span><span class="op" id="3116524">)</span><span class="op" id="3116525">)</span>&nbsp;<span class="op" id="3116527">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3116530">t</span><span class="op" id="3116531">.</span><span class="ident" id="3116532">reqMu</span><span class="op" id="3116537">.</span><span class="ident" id="3116538">Lock</span><span class="op" id="3116542">(</span><span class="op" id="3116543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3116546">defer</span>&nbsp;<span class="ident" id="3116552">t</span><span class="op" id="3116553">.</span><span class="ident" id="3116554">reqMu</span><span class="op" id="3116559">.</span><span class="ident" id="3116560">Unlock</span><span class="op" id="3116566">(</span><span class="op" id="3116567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3116570">if</span>&nbsp;<span class="ident" id="3116573">t</span><span class="op" id="3116574">.</span><span class="ident" id="3116575">reqCanceler</span>&nbsp;<span class="op" id="3116587">==</span>&nbsp;<span class="builtintype" id="3116590">nil</span>&nbsp;<span class="op" id="3116594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3116598">t</span><span class="op" id="3116599">.</span><span class="ident" id="3116600">reqCanceler</span>&nbsp;<span class="op" id="3116612">=</span>&nbsp;<span class="builtinfunc" id="3116614">make</span><span class="op" id="3116618">(</span><span class="keyword" id="3116619">map</span><span class="op" id="3116622">[</span><span class="op" id="3116623">*</span><span class="ident" id="3116624">Request</span><span class="op" id="3116631">]</span><span class="keyword" id="3116632">func</span><span class="op" id="3116636">(</span><span class="op" id="3116637">)</span><span class="op" id="3116638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3116641">}</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3116644">if</span>&nbsp;<span class="ident" id="3116647">fn</span>&nbsp;<span class="op" id="3116650">!=</span>&nbsp;<span class="builtintype" id="3116653">nil</span>&nbsp;<span class="op" id="3116657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3116661">t</span><span class="op" id="3116662">.</span><span class="ident" id="3116663">reqCanceler</span><span class="op" id="3116674">[</span><span class="ident" id="3116675">r</span><span class="op" id="3116676">]</span>&nbsp;<span class="op" id="3116678">=</span>&nbsp;<span class="ident" id="3116680">fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3116684">}</span>&nbsp;<span class="keyword" id="3116686">else</span>&nbsp;<span class="op" id="3116691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3116695">delete</span><span class="op" id="3116701">(</span><span class="ident" id="3116702">t</span><span class="op" id="3116703">.</span><span class="ident" id="3116704">reqCanceler</span><span class="op" id="3116715">,</span>&nbsp;<span class="ident" id="3116717">r</span><span class="op" id="3116718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3116721">}</span><br>
<span class="lineno">475</span><span class="op" id="3116723">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3116726">func</span>&nbsp;<span class="op" id="3116731">(</span><span class="ident" id="3116732">t</span>&nbsp;<span class="op" id="3116734">*</span><span class="ident" id="3116735">Transport</span><span class="op" id="3116744">)</span>&nbsp;<span class="ident" id="3116746">dial</span><span class="op" id="3116750">(</span><span class="ident" id="3116751">network</span><span class="op" id="3116758">,</span>&nbsp;<span class="ident" id="3116760">addr</span>&nbsp;<span class="builtintype" id="3116765">string</span><span class="op" id="3116771">)</span>&nbsp;<span class="op" id="3116773">(</span><span class="ident" id="3116774">c</span>&nbsp;<span class="ident" id="3116776">net</span><span class="op" id="3116779">.</span><span class="ident" id="3116780">Conn</span><span class="op" id="3116784">,</span>&nbsp;<span class="ident" id="3116786">err</span>&nbsp;<span class="builtintype" id="3116790">error</span><span class="op" id="3116795">)</span>&nbsp;<span class="op" id="3116797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3116800">if</span>&nbsp;<span class="ident" id="3116803">t</span><span class="op" id="3116804">.</span><span class="ident" id="3116805">Dial</span>&nbsp;<span class="op" id="3116810">!=</span>&nbsp;<span class="builtintype" id="3116813">nil</span>&nbsp;<span class="op" id="3116817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3116821">return</span>&nbsp;<span class="ident" id="3116828">t</span><span class="op" id="3116829">.</span><span class="ident" id="3116830">Dial</span><span class="op" id="3116834">(</span><span class="ident" id="3116835">network</span><span class="op" id="3116842">,</span>&nbsp;<span class="ident" id="3116844">addr</span><span class="op" id="3116848">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3116851">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3116854">return</span>&nbsp;<span class="ident" id="3116861">net</span><span class="op" id="3116864">.</span><span class="ident" id="3116865">Dial</span><span class="op" id="3116869">(</span><span class="ident" id="3116870">network</span><span class="op" id="3116877">,</span>&nbsp;<span class="ident" id="3116879">addr</span><span class="op" id="3116883">)</span><br>
<span class="lineno"></span><span class="op" id="3116885">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3116888">//&nbsp;Testing&nbsp;hooks:</span><br>
<span class="lineno">485</span><span class="keyword" id="3116906">var</span>&nbsp;<span class="ident" id="3116910">prePendingDial</span><span class="op" id="3116924">,</span>&nbsp;<span class="ident" id="3116926">postPendingDial</span>&nbsp;<span class="keyword" id="3116942">func</span><span class="op" id="3116946">(</span><span class="op" id="3116947">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3116950">//&nbsp;getConn&nbsp;dials&nbsp;and&nbsp;creates&nbsp;a&nbsp;new&nbsp;persistConn&nbsp;to&nbsp;the&nbsp;target&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="3117014">//&nbsp;specified&nbsp;in&nbsp;the&nbsp;connectMethod.&nbsp;&nbsp;This&nbsp;includes&nbsp;doing&nbsp;a&nbsp;proxy&nbsp;CONNECT</span><br>
<span class="lineno"></span><span class="comment" id="3117086">//&nbsp;and/or&nbsp;setting&nbsp;up&nbsp;TLS.&nbsp;&nbsp;If&nbsp;this&nbsp;doesn&#39;t&nbsp;return&nbsp;an&nbsp;error,&nbsp;the&nbsp;persistConn</span><br>
<span class="lineno">490</span><span class="comment" id="3117162">//&nbsp;is&nbsp;ready&nbsp;to&nbsp;write&nbsp;requests&nbsp;to.</span><br>
<span class="lineno"></span><span class="keyword" id="3117196">func</span>&nbsp;<span class="op" id="3117201">(</span><span class="ident" id="3117202">t</span>&nbsp;<span class="op" id="3117204">*</span><span class="ident" id="3117205">Transport</span><span class="op" id="3117214">)</span>&nbsp;<span class="ident" id="3117216">getConn</span><span class="op" id="3117223">(</span><span class="ident" id="3117224">req</span>&nbsp;<span class="op" id="3117228">*</span><span class="ident" id="3117229">Request</span><span class="op" id="3117236">,</span>&nbsp;<span class="ident" id="3117238">cm</span>&nbsp;<span class="ident" id="3117241">connectMethod</span><span class="op" id="3117254">)</span>&nbsp;<span class="op" id="3117256">(</span><span class="op" id="3117257">*</span><span class="ident" id="3117258">persistConn</span><span class="op" id="3117269">,</span>&nbsp;<span class="builtintype" id="3117271">error</span><span class="op" id="3117276">)</span>&nbsp;<span class="op" id="3117278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3117281">if</span>&nbsp;<span class="ident" id="3117284">pc</span>&nbsp;<span class="op" id="3117287">:=</span>&nbsp;<span class="ident" id="3117290">t</span><span class="op" id="3117291">.</span><span class="ident" id="3117292">getIdleConn</span><span class="op" id="3117303">(</span><span class="ident" id="3117304">cm</span><span class="op" id="3117306">)</span><span class="op" id="3117307">;</span>&nbsp;<span class="ident" id="3117309">pc</span>&nbsp;<span class="op" id="3117312">!=</span>&nbsp;<span class="builtintype" id="3117315">nil</span>&nbsp;<span class="op" id="3117319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3117323">return</span>&nbsp;<span class="ident" id="3117330">pc</span><span class="op" id="3117332">,</span>&nbsp;<span class="builtintype" id="3117334">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3117339">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3117343">type</span>&nbsp;<span class="ident" id="3117348">dialRes</span>&nbsp;<span class="keyword" id="3117356">struct</span>&nbsp;<span class="op" id="3117363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3117367">pc</span>&nbsp;&nbsp;<span class="op" id="3117371">*</span><span class="ident" id="3117372">persistConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3117386">err</span>&nbsp;<span class="builtintype" id="3117390">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3117397">}</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3117400">dialc</span>&nbsp;<span class="op" id="3117406">:=</span>&nbsp;<span class="builtinfunc" id="3117409">make</span><span class="op" id="3117413">(</span><span class="keyword" id="3117414">chan</span>&nbsp;<span class="ident" id="3117419">dialRes</span><span class="op" id="3117426">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3117430">handlePendingDial</span>&nbsp;<span class="op" id="3117448">:=</span>&nbsp;<span class="keyword" id="3117451">func</span><span class="op" id="3117455">(</span><span class="op" id="3117456">)</span>&nbsp;<span class="op" id="3117458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3117462">if</span>&nbsp;<span class="ident" id="3117465">prePendingDial</span>&nbsp;<span class="op" id="3117480">!=</span>&nbsp;<span class="builtintype" id="3117483">nil</span>&nbsp;<span class="op" id="3117487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3117492">prePendingDial</span><span class="op" id="3117506">(</span><span class="op" id="3117507">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3117511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3117515">go</span>&nbsp;<span class="keyword" id="3117518">func</span><span class="op" id="3117522">(</span><span class="op" id="3117523">)</span>&nbsp;<span class="op" id="3117525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3117530">if</span>&nbsp;<span class="ident" id="3117533">v</span>&nbsp;<span class="op" id="3117535">:=</span>&nbsp;<span class="op" id="3117538">&lt;-</span><span class="ident" id="3117540">dialc</span><span class="op" id="3117545">;</span>&nbsp;<span class="ident" id="3117547">v</span><span class="op" id="3117548">.</span><span class="ident" id="3117549">err</span>&nbsp;<span class="op" id="3117553">==</span>&nbsp;<span class="builtintype" id="3117556">nil</span>&nbsp;<span class="op" id="3117560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3117566">t</span><span class="op" id="3117567">.</span><span class="ident" id="3117568">putIdleConn</span><span class="op" id="3117579">(</span><span class="ident" id="3117580">v</span><span class="op" id="3117581">.</span><span class="ident" id="3117582">pc</span><span class="op" id="3117584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3117589">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3117594">if</span>&nbsp;<span class="ident" id="3117597">postPendingDial</span>&nbsp;<span class="op" id="3117613">!=</span>&nbsp;<span class="builtintype" id="3117616">nil</span>&nbsp;<span class="op" id="3117620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3117626">postPendingDial</span><span class="op" id="3117641">(</span><span class="op" id="3117642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3117647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3117651">}</span><span class="op" id="3117652">(</span><span class="op" id="3117653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3117656">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3117660">cancelc</span>&nbsp;<span class="op" id="3117668">:=</span>&nbsp;<span class="builtinfunc" id="3117671">make</span><span class="op" id="3117675">(</span><span class="keyword" id="3117676">chan</span>&nbsp;<span class="keyword" id="3117681">struct</span><span class="op" id="3117687">{</span><span class="op" id="3117688">}</span><span class="op" id="3117689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3117692">t</span><span class="op" id="3117693">.</span><span class="ident" id="3117694">setReqCanceler</span><span class="op" id="3117708">(</span><span class="ident" id="3117709">req</span><span class="op" id="3117712">,</span>&nbsp;<span class="keyword" id="3117714">func</span><span class="op" id="3117718">(</span><span class="op" id="3117719">)</span>&nbsp;<span class="op" id="3117721">{</span>&nbsp;<span class="builtinfunc" id="3117723">close</span><span class="op" id="3117728">(</span><span class="ident" id="3117729">cancelc</span><span class="op" id="3117736">)</span>&nbsp;<span class="op" id="3117738">}</span><span class="op" id="3117739">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3117743">go</span>&nbsp;<span class="keyword" id="3117746">func</span><span class="op" id="3117750">(</span><span class="op" id="3117751">)</span>&nbsp;<span class="op" id="3117753">{</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3117757">pc</span><span class="op" id="3117759">,</span>&nbsp;<span class="ident" id="3117761">err</span>&nbsp;<span class="op" id="3117765">:=</span>&nbsp;<span class="ident" id="3117768">t</span><span class="op" id="3117769">.</span><span class="ident" id="3117770">dialConn</span><span class="op" id="3117778">(</span><span class="ident" id="3117779">cm</span><span class="op" id="3117781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3117785">dialc</span>&nbsp;<span class="op" id="3117791">&lt;-</span>&nbsp;<span class="ident" id="3117794">dialRes</span><span class="op" id="3117801">{</span><span class="ident" id="3117802">pc</span><span class="op" id="3117804">,</span>&nbsp;<span class="ident" id="3117806">err</span><span class="op" id="3117809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3117812">}</span><span class="op" id="3117813">(</span><span class="op" id="3117814">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3117818">idleConnCh</span>&nbsp;<span class="op" id="3117829">:=</span>&nbsp;<span class="ident" id="3117832">t</span><span class="op" id="3117833">.</span><span class="ident" id="3117834">getIdleConnCh</span><span class="op" id="3117847">(</span><span class="ident" id="3117848">cm</span><span class="op" id="3117850">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3117853">select</span>&nbsp;<span class="op" id="3117860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3117863">case</span>&nbsp;<span class="ident" id="3117868">v</span>&nbsp;<span class="op" id="3117870">:=</span>&nbsp;<span class="op" id="3117873">&lt;-</span><span class="ident" id="3117875">dialc</span><span class="op" id="3117880">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3117884">//&nbsp;Our&nbsp;dial&nbsp;finished.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3117908">return</span>&nbsp;<span class="ident" id="3117915">v</span><span class="op" id="3117916">.</span><span class="ident" id="3117917">pc</span><span class="op" id="3117919">,</span>&nbsp;<span class="ident" id="3117921">v</span><span class="op" id="3117922">.</span><span class="ident" id="3117923">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3117928">case</span>&nbsp;<span class="ident" id="3117933">pc</span>&nbsp;<span class="op" id="3117936">:=</span>&nbsp;<span class="op" id="3117939">&lt;-</span><span class="ident" id="3117941">idleConnCh</span><span class="op" id="3117951">:</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3117955">//&nbsp;Another&nbsp;request&nbsp;finished&nbsp;first&nbsp;and&nbsp;its&nbsp;net.Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3118008">//&nbsp;became&nbsp;available&nbsp;before&nbsp;our&nbsp;dial.&nbsp;Or&nbsp;somebody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3118059">//&nbsp;else&#39;s&nbsp;dial&nbsp;that&nbsp;they&nbsp;didn&#39;t&nbsp;use.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3118098">//&nbsp;But&nbsp;our&nbsp;dial&nbsp;is&nbsp;still&nbsp;going,&nbsp;so&nbsp;give&nbsp;it&nbsp;away</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3118148">//&nbsp;when&nbsp;it&nbsp;finishes:</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3118171">handlePendingDial</span><span class="op" id="3118188">(</span><span class="op" id="3118189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118193">return</span>&nbsp;<span class="ident" id="3118200">pc</span><span class="op" id="3118202">,</span>&nbsp;<span class="builtintype" id="3118204">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118209">case</span>&nbsp;<span class="op" id="3118214">&lt;-</span><span class="ident" id="3118216">cancelc</span><span class="op" id="3118223">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3118227">handlePendingDial</span><span class="op" id="3118244">(</span><span class="op" id="3118245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118249">return</span>&nbsp;<span class="builtintype" id="3118256">nil</span><span class="op" id="3118259">,</span>&nbsp;<span class="ident" id="3118261">errors</span><span class="op" id="3118267">.</span><span class="ident" id="3118268">New</span><span class="op" id="3118271">(</span><span class="string" id="3118272">&#34;net/http:&nbsp;request&nbsp;canceled&nbsp;while&nbsp;waiting&nbsp;for&nbsp;connection&#34;</span><span class="op" id="3118329">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3118332">}</span><br>
<span class="lineno"></span><span class="op" id="3118334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3118337">func</span>&nbsp;<span class="op" id="3118342">(</span><span class="ident" id="3118343">t</span>&nbsp;<span class="op" id="3118345">*</span><span class="ident" id="3118346">Transport</span><span class="op" id="3118355">)</span>&nbsp;<span class="ident" id="3118357">dialConn</span><span class="op" id="3118365">(</span><span class="ident" id="3118366">cm</span>&nbsp;<span class="ident" id="3118369">connectMethod</span><span class="op" id="3118382">)</span>&nbsp;<span class="op" id="3118384">(</span><span class="op" id="3118385">*</span><span class="ident" id="3118386">persistConn</span><span class="op" id="3118397">,</span>&nbsp;<span class="builtintype" id="3118399">error</span><span class="op" id="3118404">)</span>&nbsp;<span class="op" id="3118406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3118409">pconn</span>&nbsp;<span class="op" id="3118415">:=</span>&nbsp;<span class="op" id="3118418">&amp;</span><span class="ident" id="3118419">persistConn</span><span class="op" id="3118430">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3118434">t</span><span class="op" id="3118435">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3118446">t</span><span class="op" id="3118447">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3118451">cacheKey</span><span class="op" id="3118459">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3118463">cm</span><span class="op" id="3118465">.</span><span class="ident" id="3118466">key</span><span class="op" id="3118469">(</span><span class="op" id="3118470">)</span><span class="op" id="3118471">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3118475">reqch</span><span class="op" id="3118480">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3118487">make</span><span class="op" id="3118491">(</span><span class="keyword" id="3118492">chan</span>&nbsp;<span class="ident" id="3118497">requestAndChan</span><span class="op" id="3118511">,</span>&nbsp;<span class="num" id="3118513">1</span><span class="op" id="3118514">)</span><span class="op" id="3118515">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3118519">writech</span><span class="op" id="3118526">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3118531">make</span><span class="op" id="3118535">(</span><span class="keyword" id="3118536">chan</span>&nbsp;<span class="ident" id="3118541">writeRequest</span><span class="op" id="3118553">,</span>&nbsp;<span class="num" id="3118555">1</span><span class="op" id="3118556">)</span><span class="op" id="3118557">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3118561">closech</span><span class="op" id="3118568">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3118573">make</span><span class="op" id="3118577">(</span><span class="keyword" id="3118578">chan</span>&nbsp;<span class="keyword" id="3118583">struct</span><span class="op" id="3118589">{</span><span class="op" id="3118590">}</span><span class="op" id="3118591">)</span><span class="op" id="3118592">,</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3118596">writeErrCh</span><span class="op" id="3118606">:</span>&nbsp;<span class="builtinfunc" id="3118608">make</span><span class="op" id="3118612">(</span><span class="keyword" id="3118613">chan</span>&nbsp;<span class="builtintype" id="3118618">error</span><span class="op" id="3118623">,</span>&nbsp;<span class="num" id="3118625">1</span><span class="op" id="3118626">)</span><span class="op" id="3118627">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3118630">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3118633">tlsDial</span>&nbsp;<span class="op" id="3118641">:=</span>&nbsp;<span class="ident" id="3118644">t</span><span class="op" id="3118645">.</span><span class="ident" id="3118646">DialTLS</span>&nbsp;<span class="op" id="3118654">!=</span>&nbsp;<span class="builtintype" id="3118657">nil</span>&nbsp;<span class="op" id="3118661">&amp;&amp;</span>&nbsp;<span class="ident" id="3118664">cm</span><span class="op" id="3118666">.</span><span class="ident" id="3118667">targetScheme</span>&nbsp;<span class="op" id="3118680">==</span>&nbsp;<span class="string" id="3118683">&#34;https&#34;</span>&nbsp;<span class="op" id="3118691">&amp;&amp;</span>&nbsp;<span class="ident" id="3118694">cm</span><span class="op" id="3118696">.</span><span class="ident" id="3118697">proxyURL</span>&nbsp;<span class="op" id="3118706">==</span>&nbsp;<span class="builtintype" id="3118709">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118714">if</span>&nbsp;<span class="ident" id="3118717">tlsDial</span>&nbsp;<span class="op" id="3118725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118729">var</span>&nbsp;<span class="ident" id="3118733">err</span>&nbsp;<span class="builtintype" id="3118737">error</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3118745">pconn</span><span class="op" id="3118750">.</span><span class="ident" id="3118751">conn</span><span class="op" id="3118755">,</span>&nbsp;<span class="ident" id="3118757">err</span>&nbsp;<span class="op" id="3118761">=</span>&nbsp;<span class="ident" id="3118763">t</span><span class="op" id="3118764">.</span><span class="ident" id="3118765">DialTLS</span><span class="op" id="3118772">(</span><span class="string" id="3118773">&#34;tcp&#34;</span><span class="op" id="3118778">,</span>&nbsp;<span class="ident" id="3118780">cm</span><span class="op" id="3118782">.</span><span class="ident" id="3118783">addr</span><span class="op" id="3118787">(</span><span class="op" id="3118788">)</span><span class="op" id="3118789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118793">if</span>&nbsp;<span class="ident" id="3118796">err</span>&nbsp;<span class="op" id="3118800">!=</span>&nbsp;<span class="builtintype" id="3118803">nil</span>&nbsp;<span class="op" id="3118807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118812">return</span>&nbsp;<span class="builtintype" id="3118819">nil</span><span class="op" id="3118822">,</span>&nbsp;<span class="ident" id="3118824">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3118830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118834">if</span>&nbsp;<span class="ident" id="3118837">tc</span><span class="op" id="3118839">,</span>&nbsp;<span class="ident" id="3118841">ok</span>&nbsp;<span class="op" id="3118844">:=</span>&nbsp;<span class="ident" id="3118847">pconn</span><span class="op" id="3118852">.</span><span class="ident" id="3118853">conn</span><span class="op" id="3118857">.</span><span class="op" id="3118858">(</span><span class="op" id="3118859">*</span><span class="ident" id="3118860">tls</span><span class="op" id="3118863">.</span><span class="ident" id="3118864">Conn</span><span class="op" id="3118868">)</span><span class="op" id="3118869">;</span>&nbsp;<span class="ident" id="3118871">ok</span>&nbsp;<span class="op" id="3118874">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3118879">cs</span>&nbsp;<span class="op" id="3118882">:=</span>&nbsp;<span class="ident" id="3118885">tc</span><span class="op" id="3118887">.</span><span class="ident" id="3118888">ConnectionState</span><span class="op" id="3118903">(</span><span class="op" id="3118904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3118909">pconn</span><span class="op" id="3118914">.</span><span class="ident" id="3118915">tlsState</span>&nbsp;<span class="op" id="3118924">=</span>&nbsp;<span class="op" id="3118926">&amp;</span><span class="ident" id="3118927">cs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3118932">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3118935">}</span>&nbsp;<span class="keyword" id="3118937">else</span>&nbsp;<span class="op" id="3118942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3118946">conn</span><span class="op" id="3118950">,</span>&nbsp;<span class="ident" id="3118952">err</span>&nbsp;<span class="op" id="3118956">:=</span>&nbsp;<span class="ident" id="3118959">t</span><span class="op" id="3118960">.</span><span class="ident" id="3118961">dial</span><span class="op" id="3118965">(</span><span class="string" id="3118966">&#34;tcp&#34;</span><span class="op" id="3118971">,</span>&nbsp;<span class="ident" id="3118973">cm</span><span class="op" id="3118975">.</span><span class="ident" id="3118976">addr</span><span class="op" id="3118980">(</span><span class="op" id="3118981">)</span><span class="op" id="3118982">)</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118986">if</span>&nbsp;<span class="ident" id="3118989">err</span>&nbsp;<span class="op" id="3118993">!=</span>&nbsp;<span class="builtintype" id="3118996">nil</span>&nbsp;<span class="op" id="3119000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3119005">if</span>&nbsp;<span class="ident" id="3119008">cm</span><span class="op" id="3119010">.</span><span class="ident" id="3119011">proxyURL</span>&nbsp;<span class="op" id="3119020">!=</span>&nbsp;<span class="builtintype" id="3119023">nil</span>&nbsp;<span class="op" id="3119027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119033">err</span>&nbsp;<span class="op" id="3119037">=</span>&nbsp;<span class="ident" id="3119039">fmt</span><span class="op" id="3119042">.</span><span class="ident" id="3119043">Errorf</span><span class="op" id="3119049">(</span><span class="string" id="3119050">&#34;http:&nbsp;error&nbsp;connecting&nbsp;to&nbsp;proxy&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="3119090">,</span>&nbsp;<span class="ident" id="3119092">cm</span><span class="op" id="3119094">.</span><span class="ident" id="3119095">proxyURL</span><span class="op" id="3119103">,</span>&nbsp;<span class="ident" id="3119105">err</span><span class="op" id="3119108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3119113">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3119118">return</span>&nbsp;<span class="builtintype" id="3119125">nil</span><span class="op" id="3119128">,</span>&nbsp;<span class="ident" id="3119130">err</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3119136">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119140">pconn</span><span class="op" id="3119145">.</span><span class="ident" id="3119146">conn</span>&nbsp;<span class="op" id="3119151">=</span>&nbsp;<span class="ident" id="3119153">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3119159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3119163">//&nbsp;Proxy&nbsp;setup.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3119180">switch</span>&nbsp;<span class="op" id="3119187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3119190">case</span>&nbsp;<span class="ident" id="3119195">cm</span><span class="op" id="3119197">.</span><span class="ident" id="3119198">proxyURL</span>&nbsp;<span class="op" id="3119207">==</span>&nbsp;<span class="builtintype" id="3119210">nil</span><span class="op" id="3119213">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3119217">//&nbsp;Do&nbsp;nothing.&nbsp;Not&nbsp;using&nbsp;a&nbsp;proxy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3119252">case</span>&nbsp;<span class="ident" id="3119257">cm</span><span class="op" id="3119259">.</span><span class="ident" id="3119260">targetScheme</span>&nbsp;<span class="op" id="3119273">==</span>&nbsp;<span class="string" id="3119276">&#34;http&#34;</span><span class="op" id="3119282">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119286">pconn</span><span class="op" id="3119291">.</span><span class="ident" id="3119292">isProxy</span>&nbsp;<span class="op" id="3119300">=</span>&nbsp;<span class="builtintype" id="3119302">true</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3119309">if</span>&nbsp;<span class="ident" id="3119312">pa</span>&nbsp;<span class="op" id="3119315">:=</span>&nbsp;<span class="ident" id="3119318">cm</span><span class="op" id="3119320">.</span><span class="ident" id="3119321">proxyAuth</span><span class="op" id="3119330">(</span><span class="op" id="3119331">)</span><span class="op" id="3119332">;</span>&nbsp;<span class="ident" id="3119334">pa</span>&nbsp;<span class="op" id="3119337">!=</span>&nbsp;<span class="string" id="3119340">&#34;&#34;</span>&nbsp;<span class="op" id="3119343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119348">pconn</span><span class="op" id="3119353">.</span><span class="ident" id="3119354">mutateHeaderFunc</span>&nbsp;<span class="op" id="3119371">=</span>&nbsp;<span class="keyword" id="3119373">func</span><span class="op" id="3119377">(</span><span class="ident" id="3119378">h</span>&nbsp;<span class="ident" id="3119380">Header</span><span class="op" id="3119386">)</span>&nbsp;<span class="op" id="3119388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119394">h</span><span class="op" id="3119395">.</span><span class="ident" id="3119396">Set</span><span class="op" id="3119399">(</span><span class="string" id="3119400">&#34;Proxy-Authorization&#34;</span><span class="op" id="3119421">,</span>&nbsp;<span class="ident" id="3119423">pa</span><span class="op" id="3119425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3119430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3119434">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3119437">case</span>&nbsp;<span class="ident" id="3119442">cm</span><span class="op" id="3119444">.</span><span class="ident" id="3119445">targetScheme</span>&nbsp;<span class="op" id="3119458">==</span>&nbsp;<span class="string" id="3119461">&#34;https&#34;</span><span class="op" id="3119468">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119472">conn</span>&nbsp;<span class="op" id="3119477">:=</span>&nbsp;<span class="ident" id="3119480">pconn</span><span class="op" id="3119485">.</span><span class="ident" id="3119486">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119493">connectReq</span>&nbsp;<span class="op" id="3119504">:=</span>&nbsp;<span class="op" id="3119507">&amp;</span><span class="ident" id="3119508">Request</span><span class="op" id="3119515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119520">Method</span><span class="op" id="3119526">:</span>&nbsp;<span class="string" id="3119528">&#34;CONNECT&#34;</span><span class="op" id="3119537">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119542">URL</span><span class="op" id="3119545">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3119550">&amp;</span><span class="ident" id="3119551">url</span><span class="op" id="3119554">.</span><span class="ident" id="3119555">URL</span><span class="op" id="3119558">{</span><span class="ident" id="3119559">Opaque</span><span class="op" id="3119565">:</span>&nbsp;<span class="ident" id="3119567">cm</span><span class="op" id="3119569">.</span><span class="ident" id="3119570">targetAddr</span><span class="op" id="3119580">}</span><span class="op" id="3119581">,</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119586">Host</span><span class="op" id="3119590">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3119594">cm</span><span class="op" id="3119596">.</span><span class="ident" id="3119597">targetAddr</span><span class="op" id="3119607">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119612">Header</span><span class="op" id="3119618">:</span>&nbsp;<span class="builtinfunc" id="3119620">make</span><span class="op" id="3119624">(</span><span class="ident" id="3119625">Header</span><span class="op" id="3119631">)</span><span class="op" id="3119632">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3119636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3119640">if</span>&nbsp;<span class="ident" id="3119643">pa</span>&nbsp;<span class="op" id="3119646">:=</span>&nbsp;<span class="ident" id="3119649">cm</span><span class="op" id="3119651">.</span><span class="ident" id="3119652">proxyAuth</span><span class="op" id="3119661">(</span><span class="op" id="3119662">)</span><span class="op" id="3119663">;</span>&nbsp;<span class="ident" id="3119665">pa</span>&nbsp;<span class="op" id="3119668">!=</span>&nbsp;<span class="string" id="3119671">&#34;&#34;</span>&nbsp;<span class="op" id="3119674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119679">connectReq</span><span class="op" id="3119689">.</span><span class="ident" id="3119690">Header</span><span class="op" id="3119696">.</span><span class="ident" id="3119697">Set</span><span class="op" id="3119700">(</span><span class="string" id="3119701">&#34;Proxy-Authorization&#34;</span><span class="op" id="3119722">,</span>&nbsp;<span class="ident" id="3119724">pa</span><span class="op" id="3119726">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3119730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119734">connectReq</span><span class="op" id="3119744">.</span><span class="ident" id="3119745">Write</span><span class="op" id="3119750">(</span><span class="ident" id="3119751">conn</span><span class="op" id="3119755">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3119760">//&nbsp;Read&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3119780">//&nbsp;Okay&nbsp;to&nbsp;use&nbsp;and&nbsp;discard&nbsp;buffered&nbsp;reader&nbsp;here,&nbsp;because</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3119839">//&nbsp;TLS&nbsp;server&nbsp;will&nbsp;not&nbsp;speak&nbsp;until&nbsp;spoken&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119887">br</span>&nbsp;<span class="op" id="3119890">:=</span>&nbsp;<span class="ident" id="3119893">bufio</span><span class="op" id="3119898">.</span><span class="ident" id="3119899">NewReader</span><span class="op" id="3119908">(</span><span class="ident" id="3119909">conn</span><span class="op" id="3119913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119917">resp</span><span class="op" id="3119921">,</span>&nbsp;<span class="ident" id="3119923">err</span>&nbsp;<span class="op" id="3119927">:=</span>&nbsp;<span class="ident" id="3119930">ReadResponse</span><span class="op" id="3119942">(</span><span class="ident" id="3119943">br</span><span class="op" id="3119945">,</span>&nbsp;<span class="ident" id="3119947">connectReq</span><span class="op" id="3119957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3119961">if</span>&nbsp;<span class="ident" id="3119964">err</span>&nbsp;<span class="op" id="3119968">!=</span>&nbsp;<span class="builtintype" id="3119971">nil</span>&nbsp;<span class="op" id="3119975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119980">conn</span><span class="op" id="3119984">.</span><span class="ident" id="3119985">Close</span><span class="op" id="3119990">(</span><span class="op" id="3119991">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3119996">return</span>&nbsp;<span class="builtintype" id="3120003">nil</span><span class="op" id="3120006">,</span>&nbsp;<span class="ident" id="3120008">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3120014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3120018">if</span>&nbsp;<span class="ident" id="3120021">resp</span><span class="op" id="3120025">.</span><span class="ident" id="3120026">StatusCode</span>&nbsp;<span class="op" id="3120037">!=</span>&nbsp;<span class="num" id="3120040">200</span>&nbsp;<span class="op" id="3120044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3120049">f</span>&nbsp;<span class="op" id="3120051">:=</span>&nbsp;<span class="ident" id="3120054">strings</span><span class="op" id="3120061">.</span><span class="ident" id="3120062">SplitN</span><span class="op" id="3120068">(</span><span class="ident" id="3120069">resp</span><span class="op" id="3120073">.</span><span class="ident" id="3120074">Status</span><span class="op" id="3120080">,</span>&nbsp;<span class="string" id="3120082">&#34;&nbsp;&#34;</span><span class="op" id="3120085">,</span>&nbsp;<span class="num" id="3120087">2</span><span class="op" id="3120088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3120093">conn</span><span class="op" id="3120097">.</span><span class="ident" id="3120098">Close</span><span class="op" id="3120103">(</span><span class="op" id="3120104">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3120109">return</span>&nbsp;<span class="builtintype" id="3120116">nil</span><span class="op" id="3120119">,</span>&nbsp;<span class="ident" id="3120121">errors</span><span class="op" id="3120127">.</span><span class="ident" id="3120128">New</span><span class="op" id="3120131">(</span><span class="ident" id="3120132">f</span><span class="op" id="3120133">[</span><span class="num" id="3120134">1</span><span class="op" id="3120135">]</span><span class="op" id="3120136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3120140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3120143">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3120147">if</span>&nbsp;<span class="ident" id="3120150">cm</span><span class="op" id="3120152">.</span><span class="ident" id="3120153">targetScheme</span>&nbsp;<span class="op" id="3120166">==</span>&nbsp;<span class="string" id="3120169">&#34;https&#34;</span>&nbsp;<span class="op" id="3120177">&amp;&amp;</span>&nbsp;<span class="op" id="3120180">!</span><span class="ident" id="3120181">tlsDial</span>&nbsp;<span class="op" id="3120189">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3120193">//&nbsp;Initiate&nbsp;TLS&nbsp;and&nbsp;check&nbsp;remote&nbsp;host&nbsp;name&nbsp;against&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3120259">cfg</span>&nbsp;<span class="op" id="3120263">:=</span>&nbsp;<span class="ident" id="3120266">t</span><span class="op" id="3120267">.</span><span class="ident" id="3120268">TLSClientConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3120286">if</span>&nbsp;<span class="ident" id="3120289">cfg</span>&nbsp;<span class="op" id="3120293">==</span>&nbsp;<span class="builtintype" id="3120296">nil</span>&nbsp;<span class="op" id="3120300">||</span>&nbsp;<span class="ident" id="3120303">cfg</span><span class="op" id="3120306">.</span><span class="ident" id="3120307">ServerName</span>&nbsp;<span class="op" id="3120318">==</span>&nbsp;<span class="string" id="3120321">&#34;&#34;</span>&nbsp;<span class="op" id="3120324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3120329">host</span>&nbsp;<span class="op" id="3120334">:=</span>&nbsp;<span class="ident" id="3120337">cm</span><span class="op" id="3120339">.</span><span class="ident" id="3120340">tlsHost</span><span class="op" id="3120347">(</span><span class="op" id="3120348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3120353">if</span>&nbsp;<span class="ident" id="3120356">cfg</span>&nbsp;<span class="op" id="3120360">==</span>&nbsp;<span class="builtintype" id="3120363">nil</span>&nbsp;<span class="op" id="3120367">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3120373">cfg</span>&nbsp;<span class="op" id="3120377">=</span>&nbsp;<span class="op" id="3120379">&amp;</span><span class="ident" id="3120380">tls</span><span class="op" id="3120383">.</span><span class="ident" id="3120384">Config</span><span class="op" id="3120390">{</span><span class="ident" id="3120391">ServerName</span><span class="op" id="3120401">:</span>&nbsp;<span class="ident" id="3120403">host</span><span class="op" id="3120407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3120412">}</span>&nbsp;<span class="keyword" id="3120414">else</span>&nbsp;<span class="op" id="3120419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3120425">clone</span>&nbsp;<span class="op" id="3120431">:=</span>&nbsp;<span class="op" id="3120434">*</span><span class="ident" id="3120435">cfg</span>&nbsp;<span class="comment" id="3120439">//&nbsp;shallow&nbsp;clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3120460">clone</span><span class="op" id="3120465">.</span><span class="ident" id="3120466">ServerName</span>&nbsp;<span class="op" id="3120477">=</span>&nbsp;<span class="ident" id="3120479">host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3120488">cfg</span>&nbsp;<span class="op" id="3120492">=</span>&nbsp;<span class="op" id="3120494">&amp;</span><span class="ident" id="3120495">clone</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3120504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3120508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3120512">plainConn</span>&nbsp;<span class="op" id="3120522">:=</span>&nbsp;<span class="ident" id="3120525">pconn</span><span class="op" id="3120530">.</span><span class="ident" id="3120531">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3120538">tlsConn</span>&nbsp;<span class="op" id="3120546">:=</span>&nbsp;<span class="ident" id="3120549">tls</span><span class="op" id="3120552">.</span><span class="ident" id="3120553">Client</span><span class="op" id="3120559">(</span><span class="ident" id="3120560">plainConn</span><span class="op" id="3120569">,</span>&nbsp;<span class="ident" id="3120571">cfg</span><span class="op" id="3120574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3120578">errc</span>&nbsp;<span class="op" id="3120583">:=</span>&nbsp;<span class="builtinfunc" id="3120586">make</span><span class="op" id="3120590">(</span><span class="keyword" id="3120591">chan</span>&nbsp;<span class="builtintype" id="3120596">error</span><span class="op" id="3120601">,</span>&nbsp;<span class="num" id="3120603">2</span><span class="op" id="3120604">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3120608">var</span>&nbsp;<span class="ident" id="3120612">timer</span>&nbsp;<span class="op" id="3120618">*</span><span class="ident" id="3120619">time</span><span class="op" id="3120623">.</span><span class="ident" id="3120624">Timer</span>&nbsp;<span class="comment" id="3120630">//&nbsp;for&nbsp;canceling&nbsp;TLS&nbsp;handshake</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3120663">if</span>&nbsp;<span class="ident" id="3120666">d</span>&nbsp;<span class="op" id="3120668">:=</span>&nbsp;<span class="ident" id="3120671">t</span><span class="op" id="3120672">.</span><span class="ident" id="3120673">TLSHandshakeTimeout</span><span class="op" id="3120692">;</span>&nbsp;<span class="ident" id="3120694">d</span>&nbsp;<span class="op" id="3120696">!=</span>&nbsp;<span class="num" id="3120699">0</span>&nbsp;<span class="op" id="3120701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3120706">timer</span>&nbsp;<span class="op" id="3120712">=</span>&nbsp;<span class="ident" id="3120714">time</span><span class="op" id="3120718">.</span><span class="ident" id="3120719">AfterFunc</span><span class="op" id="3120728">(</span><span class="ident" id="3120729">d</span><span class="op" id="3120730">,</span>&nbsp;<span class="keyword" id="3120732">func</span><span class="op" id="3120736">(</span><span class="op" id="3120737">)</span>&nbsp;<span class="op" id="3120739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3120745">errc</span>&nbsp;<span class="op" id="3120750">&lt;-</span>&nbsp;<span class="ident" id="3120753">tlsHandshakeTimeoutError</span><span class="op" id="3120777">{</span><span class="op" id="3120778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3120783">}</span><span class="op" id="3120784">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3120788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3120792">go</span>&nbsp;<span class="keyword" id="3120795">func</span><span class="op" id="3120799">(</span><span class="op" id="3120800">)</span>&nbsp;<span class="op" id="3120802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3120807">err</span>&nbsp;<span class="op" id="3120811">:=</span>&nbsp;<span class="ident" id="3120814">tlsConn</span><span class="op" id="3120821">.</span><span class="ident" id="3120822">Handshake</span><span class="op" id="3120831">(</span><span class="op" id="3120832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3120837">if</span>&nbsp;<span class="ident" id="3120840">timer</span>&nbsp;<span class="op" id="3120846">!=</span>&nbsp;<span class="builtintype" id="3120849">nil</span>&nbsp;<span class="op" id="3120853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3120859">timer</span><span class="op" id="3120864">.</span><span class="ident" id="3120865">Stop</span><span class="op" id="3120869">(</span><span class="op" id="3120870">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3120875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3120880">errc</span>&nbsp;<span class="op" id="3120885">&lt;-</span>&nbsp;<span class="ident" id="3120888">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3120894">}</span><span class="op" id="3120895">(</span><span class="op" id="3120896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3120900">if</span>&nbsp;<span class="ident" id="3120903">err</span>&nbsp;<span class="op" id="3120907">:=</span>&nbsp;<span class="op" id="3120910">&lt;-</span><span class="ident" id="3120912">errc</span><span class="op" id="3120916">;</span>&nbsp;<span class="ident" id="3120918">err</span>&nbsp;<span class="op" id="3120922">!=</span>&nbsp;<span class="builtintype" id="3120925">nil</span>&nbsp;<span class="op" id="3120929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3120934">plainConn</span><span class="op" id="3120943">.</span><span class="ident" id="3120944">Close</span><span class="op" id="3120949">(</span><span class="op" id="3120950">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3120955">return</span>&nbsp;<span class="builtintype" id="3120962">nil</span><span class="op" id="3120965">,</span>&nbsp;<span class="ident" id="3120967">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3120973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3120977">if</span>&nbsp;<span class="op" id="3120980">!</span><span class="ident" id="3120981">cfg</span><span class="op" id="3120984">.</span><span class="ident" id="3120985">InsecureSkipVerify</span>&nbsp;<span class="op" id="3121004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3121009">if</span>&nbsp;<span class="ident" id="3121012">err</span>&nbsp;<span class="op" id="3121016">:=</span>&nbsp;<span class="ident" id="3121019">tlsConn</span><span class="op" id="3121026">.</span><span class="ident" id="3121027">VerifyHostname</span><span class="op" id="3121041">(</span><span class="ident" id="3121042">cfg</span><span class="op" id="3121045">.</span><span class="ident" id="3121046">ServerName</span><span class="op" id="3121056">)</span><span class="op" id="3121057">;</span>&nbsp;<span class="ident" id="3121059">err</span>&nbsp;<span class="op" id="3121063">!=</span>&nbsp;<span class="builtintype" id="3121066">nil</span>&nbsp;<span class="op" id="3121070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3121076">plainConn</span><span class="op" id="3121085">.</span><span class="ident" id="3121086">Close</span><span class="op" id="3121091">(</span><span class="op" id="3121092">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3121098">return</span>&nbsp;<span class="builtintype" id="3121105">nil</span><span class="op" id="3121108">,</span>&nbsp;<span class="ident" id="3121110">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3121117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3121121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3121125">cs</span>&nbsp;<span class="op" id="3121128">:=</span>&nbsp;<span class="ident" id="3121131">tlsConn</span><span class="op" id="3121138">.</span><span class="ident" id="3121139">ConnectionState</span><span class="op" id="3121154">(</span><span class="op" id="3121155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3121159">pconn</span><span class="op" id="3121164">.</span><span class="ident" id="3121165">tlsState</span>&nbsp;<span class="op" id="3121174">=</span>&nbsp;<span class="op" id="3121176">&amp;</span><span class="ident" id="3121177">cs</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3121182">pconn</span><span class="op" id="3121187">.</span><span class="ident" id="3121188">conn</span>&nbsp;<span class="op" id="3121193">=</span>&nbsp;<span class="ident" id="3121195">tlsConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3121204">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3121208">pconn</span><span class="op" id="3121213">.</span><span class="ident" id="3121214">br</span>&nbsp;<span class="op" id="3121217">=</span>&nbsp;<span class="ident" id="3121219">bufio</span><span class="op" id="3121224">.</span><span class="ident" id="3121225">NewReader</span><span class="op" id="3121234">(</span><span class="ident" id="3121235">noteEOFReader</span><span class="op" id="3121248">{</span><span class="ident" id="3121249">pconn</span><span class="op" id="3121254">.</span><span class="ident" id="3121255">conn</span><span class="op" id="3121259">,</span>&nbsp;<span class="op" id="3121261">&amp;</span><span class="ident" id="3121262">pconn</span><span class="op" id="3121267">.</span><span class="ident" id="3121268">sawEOF</span><span class="op" id="3121274">}</span><span class="op" id="3121275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3121278">pconn</span><span class="op" id="3121283">.</span><span class="ident" id="3121284">bw</span>&nbsp;<span class="op" id="3121287">=</span>&nbsp;<span class="ident" id="3121289">bufio</span><span class="op" id="3121294">.</span><span class="ident" id="3121295">NewWriter</span><span class="op" id="3121304">(</span><span class="ident" id="3121305">pconn</span><span class="op" id="3121310">.</span><span class="ident" id="3121311">conn</span><span class="op" id="3121315">)</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3121318">go</span>&nbsp;<span class="ident" id="3121321">pconn</span><span class="op" id="3121326">.</span><span class="ident" id="3121327">readLoop</span><span class="op" id="3121335">(</span><span class="op" id="3121336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3121339">go</span>&nbsp;<span class="ident" id="3121342">pconn</span><span class="op" id="3121347">.</span><span class="ident" id="3121348">writeLoop</span><span class="op" id="3121357">(</span><span class="op" id="3121358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3121361">return</span>&nbsp;<span class="ident" id="3121368">pconn</span><span class="op" id="3121373">,</span>&nbsp;<span class="builtintype" id="3121375">nil</span><br>
<span class="lineno"></span><span class="op" id="3121379">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span><span class="comment" id="3121382">//&nbsp;useProxy&nbsp;returns&nbsp;true&nbsp;if&nbsp;requests&nbsp;to&nbsp;addr&nbsp;should&nbsp;use&nbsp;a&nbsp;proxy,</span><br>
<span class="lineno"></span><span class="comment" id="3121447">//&nbsp;according&nbsp;to&nbsp;the&nbsp;NO_PROXY&nbsp;or&nbsp;no_proxy&nbsp;environment&nbsp;variable.</span><br>
<span class="lineno"></span><span class="comment" id="3121510">//&nbsp;addr&nbsp;is&nbsp;always&nbsp;a&nbsp;canonicalAddr&nbsp;with&nbsp;a&nbsp;host&nbsp;and&nbsp;port.</span><br>
<span class="lineno"></span><span class="keyword" id="3121566">func</span>&nbsp;<span class="ident" id="3121571">useProxy</span><span class="op" id="3121579">(</span><span class="ident" id="3121580">addr</span>&nbsp;<span class="builtintype" id="3121585">string</span><span class="op" id="3121591">)</span>&nbsp;<span class="builtintype" id="3121593">bool</span>&nbsp;<span class="op" id="3121598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3121601">if</span>&nbsp;<span class="builtinfunc" id="3121604">len</span><span class="op" id="3121607">(</span><span class="ident" id="3121608">addr</span><span class="op" id="3121612">)</span>&nbsp;<span class="op" id="3121614">==</span>&nbsp;<span class="num" id="3121617">0</span>&nbsp;<span class="op" id="3121619">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3121623">return</span>&nbsp;<span class="builtintype" id="3121630">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3121636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3121639">host</span><span class="op" id="3121643">,</span>&nbsp;<span class="ident" id="3121645">_</span><span class="op" id="3121646">,</span>&nbsp;<span class="ident" id="3121648">err</span>&nbsp;<span class="op" id="3121652">:=</span>&nbsp;<span class="ident" id="3121655">net</span><span class="op" id="3121658">.</span><span class="ident" id="3121659">SplitHostPort</span><span class="op" id="3121672">(</span><span class="ident" id="3121673">addr</span><span class="op" id="3121677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3121680">if</span>&nbsp;<span class="ident" id="3121683">err</span>&nbsp;<span class="op" id="3121687">!=</span>&nbsp;<span class="builtintype" id="3121690">nil</span>&nbsp;<span class="op" id="3121694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3121698">return</span>&nbsp;<span class="builtintype" id="3121705">false</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3121712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3121715">if</span>&nbsp;<span class="ident" id="3121718">host</span>&nbsp;<span class="op" id="3121723">==</span>&nbsp;<span class="string" id="3121726">&#34;localhost&#34;</span>&nbsp;<span class="op" id="3121738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3121742">return</span>&nbsp;<span class="builtintype" id="3121749">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3121756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3121759">if</span>&nbsp;<span class="ident" id="3121762">ip</span>&nbsp;<span class="op" id="3121765">:=</span>&nbsp;<span class="ident" id="3121768">net</span><span class="op" id="3121771">.</span><span class="ident" id="3121772">ParseIP</span><span class="op" id="3121779">(</span><span class="ident" id="3121780">host</span><span class="op" id="3121784">)</span><span class="op" id="3121785">;</span>&nbsp;<span class="ident" id="3121787">ip</span>&nbsp;<span class="op" id="3121790">!=</span>&nbsp;<span class="builtintype" id="3121793">nil</span>&nbsp;<span class="op" id="3121797">{</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3121801">if</span>&nbsp;<span class="ident" id="3121804">ip</span><span class="op" id="3121806">.</span><span class="ident" id="3121807">IsLoopback</span><span class="op" id="3121817">(</span><span class="op" id="3121818">)</span>&nbsp;<span class="op" id="3121820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3121825">return</span>&nbsp;<span class="builtintype" id="3121832">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3121840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3121843">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3121847">no_proxy</span>&nbsp;<span class="op" id="3121856">:=</span>&nbsp;<span class="ident" id="3121859">noProxyEnv</span><span class="op" id="3121869">.</span><span class="ident" id="3121870">Get</span><span class="op" id="3121873">(</span><span class="op" id="3121874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3121877">if</span>&nbsp;<span class="ident" id="3121880">no_proxy</span>&nbsp;<span class="op" id="3121889">==</span>&nbsp;<span class="string" id="3121892">&#34;*&#34;</span>&nbsp;<span class="op" id="3121896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3121900">return</span>&nbsp;<span class="builtintype" id="3121907">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3121914">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3121918">addr</span>&nbsp;<span class="op" id="3121923">=</span>&nbsp;<span class="ident" id="3121925">strings</span><span class="op" id="3121932">.</span><span class="ident" id="3121933">ToLower</span><span class="op" id="3121940">(</span><span class="ident" id="3121941">strings</span><span class="op" id="3121948">.</span><span class="ident" id="3121949">TrimSpace</span><span class="op" id="3121958">(</span><span class="ident" id="3121959">addr</span><span class="op" id="3121963">)</span><span class="op" id="3121964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3121967">if</span>&nbsp;<span class="ident" id="3121970">hasPort</span><span class="op" id="3121977">(</span><span class="ident" id="3121978">addr</span><span class="op" id="3121982">)</span>&nbsp;<span class="op" id="3121984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3121988">addr</span>&nbsp;<span class="op" id="3121993">=</span>&nbsp;<span class="ident" id="3121995">addr</span><span class="op" id="3121999">[</span><span class="op" id="3122000">:</span><span class="ident" id="3122001">strings</span><span class="op" id="3122008">.</span><span class="ident" id="3122009">LastIndex</span><span class="op" id="3122018">(</span><span class="ident" id="3122019">addr</span><span class="op" id="3122023">,</span>&nbsp;<span class="string" id="3122025">&#34;:&#34;</span><span class="op" id="3122028">)</span><span class="op" id="3122029">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3122032">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3122036">for</span>&nbsp;<span class="ident" id="3122040">_</span><span class="op" id="3122041">,</span>&nbsp;<span class="ident" id="3122043">p</span>&nbsp;<span class="op" id="3122045">:=</span>&nbsp;<span class="keyword" id="3122048">range</span>&nbsp;<span class="ident" id="3122054">strings</span><span class="op" id="3122061">.</span><span class="ident" id="3122062">Split</span><span class="op" id="3122067">(</span><span class="ident" id="3122068">no_proxy</span><span class="op" id="3122076">,</span>&nbsp;<span class="string" id="3122078">&#34;,&#34;</span><span class="op" id="3122081">)</span>&nbsp;<span class="op" id="3122083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3122087">p</span>&nbsp;<span class="op" id="3122089">=</span>&nbsp;<span class="ident" id="3122091">strings</span><span class="op" id="3122098">.</span><span class="ident" id="3122099">ToLower</span><span class="op" id="3122106">(</span><span class="ident" id="3122107">strings</span><span class="op" id="3122114">.</span><span class="ident" id="3122115">TrimSpace</span><span class="op" id="3122124">(</span><span class="ident" id="3122125">p</span><span class="op" id="3122126">)</span><span class="op" id="3122127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3122131">if</span>&nbsp;<span class="builtinfunc" id="3122134">len</span><span class="op" id="3122137">(</span><span class="ident" id="3122138">p</span><span class="op" id="3122139">)</span>&nbsp;<span class="op" id="3122141">==</span>&nbsp;<span class="num" id="3122144">0</span>&nbsp;<span class="op" id="3122146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3122151">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3122162">}</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3122166">if</span>&nbsp;<span class="ident" id="3122169">hasPort</span><span class="op" id="3122176">(</span><span class="ident" id="3122177">p</span><span class="op" id="3122178">)</span>&nbsp;<span class="op" id="3122180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3122185">p</span>&nbsp;<span class="op" id="3122187">=</span>&nbsp;<span class="ident" id="3122189">p</span><span class="op" id="3122190">[</span><span class="op" id="3122191">:</span><span class="ident" id="3122192">strings</span><span class="op" id="3122199">.</span><span class="ident" id="3122200">LastIndex</span><span class="op" id="3122209">(</span><span class="ident" id="3122210">p</span><span class="op" id="3122211">,</span>&nbsp;<span class="string" id="3122213">&#34;:&#34;</span><span class="op" id="3122216">)</span><span class="op" id="3122217">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3122221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3122225">if</span>&nbsp;<span class="ident" id="3122228">addr</span>&nbsp;<span class="op" id="3122233">==</span>&nbsp;<span class="ident" id="3122236">p</span>&nbsp;<span class="op" id="3122238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3122243">return</span>&nbsp;<span class="builtintype" id="3122250">false</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3122258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3122262">if</span>&nbsp;<span class="ident" id="3122265">p</span><span class="op" id="3122266">[</span><span class="num" id="3122267">0</span><span class="op" id="3122268">]</span>&nbsp;<span class="op" id="3122270">==</span>&nbsp;<span class="string" id="3122273">&#39;.&#39;</span>&nbsp;<span class="op" id="3122277">&amp;&amp;</span>&nbsp;<span class="op" id="3122280">(</span><span class="ident" id="3122281">strings</span><span class="op" id="3122288">.</span><span class="ident" id="3122289">HasSuffix</span><span class="op" id="3122298">(</span><span class="ident" id="3122299">addr</span><span class="op" id="3122303">,</span>&nbsp;<span class="ident" id="3122305">p</span><span class="op" id="3122306">)</span>&nbsp;<span class="op" id="3122308">||</span>&nbsp;<span class="ident" id="3122311">addr</span>&nbsp;<span class="op" id="3122316">==</span>&nbsp;<span class="ident" id="3122319">p</span><span class="op" id="3122320">[</span><span class="num" id="3122321">1</span><span class="op" id="3122322">:</span><span class="op" id="3122323">]</span><span class="op" id="3122324">)</span>&nbsp;<span class="op" id="3122326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3122331">//&nbsp;no_proxy&nbsp;&#34;.foo.com&#34;&nbsp;matches&nbsp;&#34;bar.foo.com&#34;&nbsp;or&nbsp;&#34;foo.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3122392">return</span>&nbsp;<span class="builtintype" id="3122399">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3122407">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3122411">if</span>&nbsp;<span class="ident" id="3122414">p</span><span class="op" id="3122415">[</span><span class="num" id="3122416">0</span><span class="op" id="3122417">]</span>&nbsp;<span class="op" id="3122419">!=</span>&nbsp;<span class="string" id="3122422">&#39;.&#39;</span>&nbsp;<span class="op" id="3122426">&amp;&amp;</span>&nbsp;<span class="ident" id="3122429">strings</span><span class="op" id="3122436">.</span><span class="ident" id="3122437">HasSuffix</span><span class="op" id="3122446">(</span><span class="ident" id="3122447">addr</span><span class="op" id="3122451">,</span>&nbsp;<span class="ident" id="3122453">p</span><span class="op" id="3122454">)</span>&nbsp;<span class="op" id="3122456">&amp;&amp;</span>&nbsp;<span class="ident" id="3122459">addr</span><span class="op" id="3122463">[</span><span class="builtinfunc" id="3122464">len</span><span class="op" id="3122467">(</span><span class="ident" id="3122468">addr</span><span class="op" id="3122472">)</span><span class="op" id="3122473">-</span><span class="builtinfunc" id="3122474">len</span><span class="op" id="3122477">(</span><span class="ident" id="3122478">p</span><span class="op" id="3122479">)</span><span class="op" id="3122480">-</span><span class="num" id="3122481">1</span><span class="op" id="3122482">]</span>&nbsp;<span class="op" id="3122484">==</span>&nbsp;<span class="string" id="3122487">&#39;.&#39;</span>&nbsp;<span class="op" id="3122491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3122496">//&nbsp;no_proxy&nbsp;&#34;foo.com&#34;&nbsp;matches&nbsp;&#34;bar.foo.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3122543">return</span>&nbsp;<span class="builtintype" id="3122550">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3122558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3122561">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3122564">return</span>&nbsp;<span class="builtintype" id="3122571">true</span><br>
<span class="lineno"></span><span class="op" id="3122576">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3122579">//&nbsp;connectMethod&nbsp;is&nbsp;the&nbsp;map&nbsp;key&nbsp;(in&nbsp;its&nbsp;String&nbsp;form)&nbsp;for&nbsp;keeping&nbsp;persistent</span><br>
<span class="lineno"></span><span class="comment" id="3122655">//&nbsp;TCP&nbsp;connections&nbsp;alive&nbsp;for&nbsp;subsequent&nbsp;HTTP&nbsp;requests.</span><br>
<span class="lineno">720</span><span class="comment" id="3122710">//</span><br>
<span class="lineno"></span><span class="comment" id="3122713">//&nbsp;A&nbsp;connect&nbsp;method&nbsp;may&nbsp;be&nbsp;of&nbsp;the&nbsp;following&nbsp;types:</span><br>
<span class="lineno"></span><span class="comment" id="3122764">//</span><br>
<span class="lineno"></span><span class="comment" id="3122767">//&nbsp;Cache&nbsp;key&nbsp;form&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Description</span><br>
<span class="lineno"></span><span class="comment" id="3122812">//&nbsp;-----------------&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-------------------------</span><br>
<span class="lineno">725</span><span class="comment" id="3122871">//&nbsp;|http|foo.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http&nbsp;directly&nbsp;to&nbsp;server,&nbsp;no&nbsp;proxy</span><br>
<span class="lineno"></span><span class="comment" id="3122938">//&nbsp;|https|foo.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;https&nbsp;directly&nbsp;to&nbsp;server,&nbsp;no&nbsp;proxy</span><br>
<span class="lineno"></span><span class="comment" id="3123006">//&nbsp;http://proxy.com|https|foo.com&nbsp;&nbsp;http&nbsp;to&nbsp;proxy,&nbsp;then&nbsp;CONNECT&nbsp;to&nbsp;foo.com</span><br>
<span class="lineno"></span><span class="comment" id="3123080">//&nbsp;http://proxy.com|http&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http&nbsp;to&nbsp;proxy,&nbsp;http&nbsp;to&nbsp;anywhere&nbsp;after&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3123158">//</span><br>
<span class="lineno">730</span><span class="comment" id="3123161">//&nbsp;Note:&nbsp;no&nbsp;support&nbsp;to&nbsp;https&nbsp;to&nbsp;the&nbsp;proxy&nbsp;yet.</span><br>
<span class="lineno"></span><span class="comment" id="3123208">//</span><br>
<span class="lineno"></span><span class="keyword" id="3123211">type</span>&nbsp;<span class="ident" id="3123216">connectMethod</span>&nbsp;<span class="keyword" id="3123230">struct</span>&nbsp;<span class="op" id="3123237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3123240">proxyURL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3123253">*</span><span class="ident" id="3123254">url</span><span class="op" id="3123257">.</span><span class="ident" id="3123258">URL</span>&nbsp;<span class="comment" id="3123262">//&nbsp;nil&nbsp;for&nbsp;no&nbsp;proxy,&nbsp;else&nbsp;full&nbsp;proxy&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3123304">targetScheme</span>&nbsp;<span class="builtintype" id="3123317">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3123326">//&nbsp;&#34;http&#34;&nbsp;or&nbsp;&#34;https&#34;</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3123348">targetAddr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3123361">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3123370">//&nbsp;Not&nbsp;used&nbsp;if&nbsp;proxy&nbsp;+&nbsp;http&nbsp;targetScheme&nbsp;(4th&nbsp;example&nbsp;in&nbsp;table)</span><br>
<span class="lineno"></span><span class="op" id="3123434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3123437">func</span>&nbsp;<span class="op" id="3123442">(</span><span class="ident" id="3123443">cm</span>&nbsp;<span class="op" id="3123446">*</span><span class="ident" id="3123447">connectMethod</span><span class="op" id="3123460">)</span>&nbsp;<span class="ident" id="3123462">key</span><span class="op" id="3123465">(</span><span class="op" id="3123466">)</span>&nbsp;<span class="ident" id="3123468">connectMethodKey</span>&nbsp;<span class="op" id="3123485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3123488">proxyStr</span>&nbsp;<span class="op" id="3123497">:=</span>&nbsp;<span class="string" id="3123500">&#34;&#34;</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3123504">targetAddr</span>&nbsp;<span class="op" id="3123515">:=</span>&nbsp;<span class="ident" id="3123518">cm</span><span class="op" id="3123520">.</span><span class="ident" id="3123521">targetAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3123533">if</span>&nbsp;<span class="ident" id="3123536">cm</span><span class="op" id="3123538">.</span><span class="ident" id="3123539">proxyURL</span>&nbsp;<span class="op" id="3123548">!=</span>&nbsp;<span class="builtintype" id="3123551">nil</span>&nbsp;<span class="op" id="3123555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3123559">proxyStr</span>&nbsp;<span class="op" id="3123568">=</span>&nbsp;<span class="ident" id="3123570">cm</span><span class="op" id="3123572">.</span><span class="ident" id="3123573">proxyURL</span><span class="op" id="3123581">.</span><span class="ident" id="3123582">String</span><span class="op" id="3123588">(</span><span class="op" id="3123589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3123593">if</span>&nbsp;<span class="ident" id="3123596">cm</span><span class="op" id="3123598">.</span><span class="ident" id="3123599">targetScheme</span>&nbsp;<span class="op" id="3123612">==</span>&nbsp;<span class="string" id="3123615">&#34;http&#34;</span>&nbsp;<span class="op" id="3123622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3123627">targetAddr</span>&nbsp;<span class="op" id="3123638">=</span>&nbsp;<span class="string" id="3123640">&#34;&#34;</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3123645">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3123648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3123651">return</span>&nbsp;<span class="ident" id="3123658">connectMethodKey</span><span class="op" id="3123674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3123678">proxy</span><span class="op" id="3123683">:</span>&nbsp;&nbsp;<span class="ident" id="3123686">proxyStr</span><span class="op" id="3123694">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3123698">scheme</span><span class="op" id="3123704">:</span>&nbsp;<span class="ident" id="3123706">cm</span><span class="op" id="3123708">.</span><span class="ident" id="3123709">targetScheme</span><span class="op" id="3123721">,</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3123725">addr</span><span class="op" id="3123729">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3123733">targetAddr</span><span class="op" id="3123743">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3123746">}</span><br>
<span class="lineno"></span><span class="op" id="3123748">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3123751">//&nbsp;addr&nbsp;returns&nbsp;the&nbsp;first&nbsp;hop&nbsp;&#34;host:port&#34;&nbsp;to&nbsp;which&nbsp;we&nbsp;need&nbsp;to&nbsp;TCP&nbsp;connect.</span><br>
<span class="lineno">755</span><span class="keyword" id="3123826">func</span>&nbsp;<span class="op" id="3123831">(</span><span class="ident" id="3123832">cm</span>&nbsp;<span class="op" id="3123835">*</span><span class="ident" id="3123836">connectMethod</span><span class="op" id="3123849">)</span>&nbsp;<span class="ident" id="3123851">addr</span><span class="op" id="3123855">(</span><span class="op" id="3123856">)</span>&nbsp;<span class="builtintype" id="3123858">string</span>&nbsp;<span class="op" id="3123865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3123868">if</span>&nbsp;<span class="ident" id="3123871">cm</span><span class="op" id="3123873">.</span><span class="ident" id="3123874">proxyURL</span>&nbsp;<span class="op" id="3123883">!=</span>&nbsp;<span class="builtintype" id="3123886">nil</span>&nbsp;<span class="op" id="3123890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3123894">return</span>&nbsp;<span class="ident" id="3123901">canonicalAddr</span><span class="op" id="3123914">(</span><span class="ident" id="3123915">cm</span><span class="op" id="3123917">.</span><span class="ident" id="3123918">proxyURL</span><span class="op" id="3123926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3123929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3123932">return</span>&nbsp;<span class="ident" id="3123939">cm</span><span class="op" id="3123941">.</span><span class="ident" id="3123942">targetAddr</span><br>
<span class="lineno">760</span><span class="op" id="3123953">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3123956">//&nbsp;tlsHost&nbsp;returns&nbsp;the&nbsp;host&nbsp;name&nbsp;to&nbsp;match&nbsp;against&nbsp;the&nbsp;peer&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3124017">//&nbsp;TLS&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="3124037">func</span>&nbsp;<span class="op" id="3124042">(</span><span class="ident" id="3124043">cm</span>&nbsp;<span class="op" id="3124046">*</span><span class="ident" id="3124047">connectMethod</span><span class="op" id="3124060">)</span>&nbsp;<span class="ident" id="3124062">tlsHost</span><span class="op" id="3124069">(</span><span class="op" id="3124070">)</span>&nbsp;<span class="builtintype" id="3124072">string</span>&nbsp;<span class="op" id="3124079">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3124082">h</span>&nbsp;<span class="op" id="3124084">:=</span>&nbsp;<span class="ident" id="3124087">cm</span><span class="op" id="3124089">.</span><span class="ident" id="3124090">targetAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3124102">if</span>&nbsp;<span class="ident" id="3124105">hasPort</span><span class="op" id="3124112">(</span><span class="ident" id="3124113">h</span><span class="op" id="3124114">)</span>&nbsp;<span class="op" id="3124116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3124120">h</span>&nbsp;<span class="op" id="3124122">=</span>&nbsp;<span class="ident" id="3124124">h</span><span class="op" id="3124125">[</span><span class="op" id="3124126">:</span><span class="ident" id="3124127">strings</span><span class="op" id="3124134">.</span><span class="ident" id="3124135">LastIndex</span><span class="op" id="3124144">(</span><span class="ident" id="3124145">h</span><span class="op" id="3124146">,</span>&nbsp;<span class="string" id="3124148">&#34;:&#34;</span><span class="op" id="3124151">)</span><span class="op" id="3124152">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3124155">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3124158">return</span>&nbsp;<span class="ident" id="3124165">h</span><br>
<span class="lineno">770</span><span class="op" id="3124167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3124170">//&nbsp;connectMethodKey&nbsp;is&nbsp;the&nbsp;map&nbsp;key&nbsp;version&nbsp;of&nbsp;connectMethod,&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3124238">//&nbsp;stringified&nbsp;proxy&nbsp;URL&nbsp;(or&nbsp;the&nbsp;empty&nbsp;string)&nbsp;instead&nbsp;of&nbsp;a&nbsp;pointer&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3124309">//&nbsp;a&nbsp;URL.</span><br>
<span class="lineno">775</span><span class="keyword" id="3124319">type</span>&nbsp;<span class="ident" id="3124324">connectMethodKey</span>&nbsp;<span class="keyword" id="3124341">struct</span>&nbsp;<span class="op" id="3124348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3124351">proxy</span><span class="op" id="3124356">,</span>&nbsp;<span class="ident" id="3124358">scheme</span><span class="op" id="3124364">,</span>&nbsp;<span class="ident" id="3124366">addr</span>&nbsp;<span class="builtintype" id="3124371">string</span><br>
<span class="lineno"></span><span class="op" id="3124378">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3124381">func</span>&nbsp;<span class="op" id="3124386">(</span><span class="ident" id="3124387">k</span>&nbsp;<span class="ident" id="3124389">connectMethodKey</span><span class="op" id="3124405">)</span>&nbsp;<span class="ident" id="3124407">String</span><span class="op" id="3124413">(</span><span class="op" id="3124414">)</span>&nbsp;<span class="builtintype" id="3124416">string</span>&nbsp;<span class="op" id="3124423">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3124426">//&nbsp;Only&nbsp;used&nbsp;by&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3124450">return</span>&nbsp;<span class="ident" id="3124457">fmt</span><span class="op" id="3124460">.</span><span class="ident" id="3124461">Sprintf</span><span class="op" id="3124468">(</span><span class="string" id="3124469">&#34;%s|%s|%s&#34;</span><span class="op" id="3124479">,</span>&nbsp;<span class="ident" id="3124481">k</span><span class="op" id="3124482">.</span><span class="ident" id="3124483">proxy</span><span class="op" id="3124488">,</span>&nbsp;<span class="ident" id="3124490">k</span><span class="op" id="3124491">.</span><span class="ident" id="3124492">scheme</span><span class="op" id="3124498">,</span>&nbsp;<span class="ident" id="3124500">k</span><span class="op" id="3124501">.</span><span class="ident" id="3124502">addr</span><span class="op" id="3124506">)</span><br>
<span class="lineno"></span><span class="op" id="3124508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3124511">//&nbsp;persistConn&nbsp;wraps&nbsp;a&nbsp;connection,&nbsp;usually&nbsp;a&nbsp;persistent&nbsp;one</span><br>
<span class="lineno">785</span><span class="comment" id="3124571">//&nbsp;(but&nbsp;may&nbsp;be&nbsp;used&nbsp;for&nbsp;non-keep-alive&nbsp;requests&nbsp;as&nbsp;well)</span><br>
<span class="lineno"></span><span class="keyword" id="3124628">type</span>&nbsp;<span class="ident" id="3124633">persistConn</span>&nbsp;<span class="keyword" id="3124645">struct</span>&nbsp;<span class="op" id="3124652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3124655">t</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3124664">*</span><span class="ident" id="3124665">Transport</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3124676">cacheKey</span>&nbsp;<span class="ident" id="3124685">connectMethodKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3124703">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3124712">net</span><span class="op" id="3124715">.</span><span class="ident" id="3124716">Conn</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3124722">tlsState</span>&nbsp;<span class="op" id="3124731">*</span><span class="ident" id="3124732">tls</span><span class="op" id="3124735">.</span><span class="ident" id="3124736">ConnectionState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3124753">br</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3124762">*</span><span class="ident" id="3124763">bufio</span><span class="op" id="3124768">.</span><span class="ident" id="3124769">Reader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3124782">//&nbsp;from&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3124796">sawEOF</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3124805">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3124825">//&nbsp;whether&nbsp;we&#39;ve&nbsp;seen&nbsp;EOF&nbsp;from&nbsp;conn;&nbsp;owned&nbsp;by&nbsp;readLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3124881">bw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3124890">*</span><span class="ident" id="3124891">bufio</span><span class="op" id="3124896">.</span><span class="ident" id="3124897">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3124910">//&nbsp;to&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3124922">reqch</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3124931">chan</span>&nbsp;<span class="ident" id="3124936">requestAndChan</span>&nbsp;<span class="comment" id="3124951">//&nbsp;written&nbsp;by&nbsp;roundTrip;&nbsp;read&nbsp;by&nbsp;readLoop</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3124994">writech</span>&nbsp;&nbsp;<span class="keyword" id="3125003">chan</span>&nbsp;<span class="ident" id="3125008">writeRequest</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3125023">//&nbsp;written&nbsp;by&nbsp;roundTrip;&nbsp;read&nbsp;by&nbsp;writeLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3125067">closech</span>&nbsp;&nbsp;<span class="keyword" id="3125076">chan</span>&nbsp;<span class="keyword" id="3125081">struct</span><span class="op" id="3125087">{</span><span class="op" id="3125088">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125096">//&nbsp;closed&nbsp;when&nbsp;conn&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3125124">isProxy</span>&nbsp;&nbsp;<span class="builtintype" id="3125133">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125139">//&nbsp;writeErrCh&nbsp;passes&nbsp;the&nbsp;request&nbsp;write&nbsp;error&nbsp;(usually&nbsp;nil)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125199">//&nbsp;from&nbsp;the&nbsp;writeLoop&nbsp;goroutine&nbsp;to&nbsp;the&nbsp;readLoop&nbsp;which&nbsp;passes</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125261">//&nbsp;it&nbsp;off&nbsp;to&nbsp;the&nbsp;res.Body&nbsp;reader,&nbsp;which&nbsp;then&nbsp;uses&nbsp;it&nbsp;to&nbsp;decide</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125325">//&nbsp;whether&nbsp;or&nbsp;not&nbsp;a&nbsp;connection&nbsp;can&nbsp;be&nbsp;reused.&nbsp;Issue&nbsp;7569.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3125384">writeErrCh</span>&nbsp;<span class="keyword" id="3125395">chan</span>&nbsp;<span class="builtintype" id="3125400">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3125408">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3125429">sync</span><span class="op" id="3125433">.</span><span class="ident" id="3125434">Mutex</span>&nbsp;<span class="comment" id="3125440">//&nbsp;guards&nbsp;following&nbsp;fields</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3125468">numExpectedResponses</span>&nbsp;<span class="builtintype" id="3125489">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3125494">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3125515">bool</span>&nbsp;<span class="comment" id="3125520">//&nbsp;whether&nbsp;conn&nbsp;has&nbsp;been&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3125553">broken</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3125574">bool</span>&nbsp;<span class="comment" id="3125579">//&nbsp;an&nbsp;error&nbsp;has&nbsp;happened&nbsp;on&nbsp;this&nbsp;connection;&nbsp;marked&nbsp;broken&nbsp;so&nbsp;it&#39;s&nbsp;not&nbsp;reused.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125659">//&nbsp;mutateHeaderFunc&nbsp;is&nbsp;an&nbsp;optional&nbsp;func&nbsp;to&nbsp;modify&nbsp;extra</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125716">//&nbsp;headers&nbsp;on&nbsp;each&nbsp;outbound&nbsp;request&nbsp;before&nbsp;it&#39;s&nbsp;written.&nbsp;(the</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125779">//&nbsp;original&nbsp;Request&nbsp;given&nbsp;to&nbsp;RoundTrip&nbsp;is&nbsp;not&nbsp;modified)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3125836">mutateHeaderFunc</span>&nbsp;<span class="keyword" id="3125853">func</span><span class="op" id="3125857">(</span><span class="ident" id="3125858">Header</span><span class="op" id="3125864">)</span><br>
<span class="lineno"></span><span class="op" id="3125866">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3125869">//&nbsp;isBroken&nbsp;reports&nbsp;whether&nbsp;this&nbsp;connection&nbsp;is&nbsp;in&nbsp;a&nbsp;known&nbsp;broken&nbsp;state.</span><br>
<span class="lineno">815</span><span class="keyword" id="3125941">func</span>&nbsp;<span class="op" id="3125946">(</span><span class="ident" id="3125947">pc</span>&nbsp;<span class="op" id="3125950">*</span><span class="ident" id="3125951">persistConn</span><span class="op" id="3125962">)</span>&nbsp;<span class="ident" id="3125964">isBroken</span><span class="op" id="3125972">(</span><span class="op" id="3125973">)</span>&nbsp;<span class="builtintype" id="3125975">bool</span>&nbsp;<span class="op" id="3125980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3125983">pc</span><span class="op" id="3125985">.</span><span class="ident" id="3125986">lk</span><span class="op" id="3125988">.</span><span class="ident" id="3125989">Lock</span><span class="op" id="3125993">(</span><span class="op" id="3125994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3125997">b</span>&nbsp;<span class="op" id="3125999">:=</span>&nbsp;<span class="ident" id="3126002">pc</span><span class="op" id="3126004">.</span><span class="ident" id="3126005">broken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3126013">pc</span><span class="op" id="3126015">.</span><span class="ident" id="3126016">lk</span><span class="op" id="3126018">.</span><span class="ident" id="3126019">Unlock</span><span class="op" id="3126025">(</span><span class="op" id="3126026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3126029">return</span>&nbsp;<span class="ident" id="3126036">b</span><br>
<span class="lineno">820</span><span class="op" id="3126038">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3126041">func</span>&nbsp;<span class="op" id="3126046">(</span><span class="ident" id="3126047">pc</span>&nbsp;<span class="op" id="3126050">*</span><span class="ident" id="3126051">persistConn</span><span class="op" id="3126062">)</span>&nbsp;<span class="ident" id="3126064">cancelRequest</span><span class="op" id="3126077">(</span><span class="op" id="3126078">)</span>&nbsp;<span class="op" id="3126080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3126083">pc</span><span class="op" id="3126085">.</span><span class="ident" id="3126086">conn</span><span class="op" id="3126090">.</span><span class="ident" id="3126091">Close</span><span class="op" id="3126096">(</span><span class="op" id="3126097">)</span><br>
<span class="lineno"></span><span class="op" id="3126099">}</span><br>
<span class="lineno">825</span><br>
<span class="lineno"></span><span class="keyword" id="3126102">var</span>&nbsp;<span class="ident" id="3126106">remoteSideClosedFunc</span>&nbsp;<span class="keyword" id="3126127">func</span><span class="op" id="3126131">(</span><span class="builtintype" id="3126132">error</span><span class="op" id="3126137">)</span>&nbsp;<span class="builtintype" id="3126139">bool</span>&nbsp;<span class="comment" id="3126144">//&nbsp;or&nbsp;nil&nbsp;to&nbsp;use&nbsp;default</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3126170">func</span>&nbsp;<span class="ident" id="3126175">remoteSideClosed</span><span class="op" id="3126191">(</span><span class="ident" id="3126192">err</span>&nbsp;<span class="builtintype" id="3126196">error</span><span class="op" id="3126201">)</span>&nbsp;<span class="builtintype" id="3126203">bool</span>&nbsp;<span class="op" id="3126208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3126211">if</span>&nbsp;<span class="ident" id="3126214">err</span>&nbsp;<span class="op" id="3126218">==</span>&nbsp;<span class="ident" id="3126221">io</span><span class="op" id="3126223">.</span><span class="ident" id="3126224">EOF</span>&nbsp;<span class="op" id="3126228">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3126232">return</span>&nbsp;<span class="builtintype" id="3126239">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3126245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3126248">if</span>&nbsp;<span class="ident" id="3126251">remoteSideClosedFunc</span>&nbsp;<span class="op" id="3126272">!=</span>&nbsp;<span class="builtintype" id="3126275">nil</span>&nbsp;<span class="op" id="3126279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3126283">return</span>&nbsp;<span class="ident" id="3126290">remoteSideClosedFunc</span><span class="op" id="3126310">(</span><span class="ident" id="3126311">err</span><span class="op" id="3126314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3126317">}</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3126320">return</span>&nbsp;<span class="builtintype" id="3126327">false</span><br>
<span class="lineno"></span><span class="op" id="3126333">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3126336">func</span>&nbsp;<span class="op" id="3126341">(</span><span class="ident" id="3126342">pc</span>&nbsp;<span class="op" id="3126345">*</span><span class="ident" id="3126346">persistConn</span><span class="op" id="3126357">)</span>&nbsp;<span class="ident" id="3126359">readLoop</span><span class="op" id="3126367">(</span><span class="op" id="3126368">)</span>&nbsp;<span class="op" id="3126370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3126373">alive</span>&nbsp;<span class="op" id="3126379">:=</span>&nbsp;<span class="builtintype" id="3126382">true</span><br>
<span class="lineno">840</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3126389">for</span>&nbsp;<span class="ident" id="3126393">alive</span>&nbsp;<span class="op" id="3126399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3126403">pb</span><span class="op" id="3126405">,</span>&nbsp;<span class="ident" id="3126407">err</span>&nbsp;<span class="op" id="3126411">:=</span>&nbsp;<span class="ident" id="3126414">pc</span><span class="op" id="3126416">.</span><span class="ident" id="3126417">br</span><span class="op" id="3126419">.</span><span class="ident" id="3126420">Peek</span><span class="op" id="3126424">(</span><span class="num" id="3126425">1</span><span class="op" id="3126426">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3126431">pc</span><span class="op" id="3126433">.</span><span class="ident" id="3126434">lk</span><span class="op" id="3126436">.</span><span class="ident" id="3126437">Lock</span><span class="op" id="3126441">(</span><span class="op" id="3126442">)</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3126446">if</span>&nbsp;<span class="ident" id="3126449">pc</span><span class="op" id="3126451">.</span><span class="ident" id="3126452">numExpectedResponses</span>&nbsp;<span class="op" id="3126473">==</span>&nbsp;<span class="num" id="3126476">0</span>&nbsp;<span class="op" id="3126478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3126483">if</span>&nbsp;<span class="op" id="3126486">!</span><span class="ident" id="3126487">pc</span><span class="op" id="3126489">.</span><span class="ident" id="3126490">closed</span>&nbsp;<span class="op" id="3126497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3126503">pc</span><span class="op" id="3126505">.</span><span class="ident" id="3126506">closeLocked</span><span class="op" id="3126517">(</span><span class="op" id="3126518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3126524">if</span>&nbsp;<span class="builtinfunc" id="3126527">len</span><span class="op" id="3126530">(</span><span class="ident" id="3126531">pb</span><span class="op" id="3126533">)</span>&nbsp;<span class="op" id="3126535">&gt;</span>&nbsp;<span class="num" id="3126537">0</span>&nbsp;<span class="op" id="3126539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3126546">log</span><span class="op" id="3126549">.</span><span class="ident" id="3126550">Printf</span><span class="op" id="3126556">(</span><span class="string" id="3126557">&#34;Unsolicited&nbsp;response&nbsp;received&nbsp;on&nbsp;idle&nbsp;HTTP&nbsp;channel&nbsp;starting&nbsp;with&nbsp;%q;&nbsp;err=%v&#34;</span><span class="op" id="3126634">,</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3126642">string</span><span class="op" id="3126648">(</span><span class="ident" id="3126649">pb</span><span class="op" id="3126651">)</span><span class="op" id="3126652">,</span>&nbsp;<span class="ident" id="3126654">err</span><span class="op" id="3126657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3126663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3126668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3126673">pc</span><span class="op" id="3126675">.</span><span class="ident" id="3126676">lk</span><span class="op" id="3126678">.</span><span class="ident" id="3126679">Unlock</span><span class="op" id="3126685">(</span><span class="op" id="3126686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3126691">return</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3126700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3126704">pc</span><span class="op" id="3126706">.</span><span class="ident" id="3126707">lk</span><span class="op" id="3126709">.</span><span class="ident" id="3126710">Unlock</span><span class="op" id="3126716">(</span><span class="op" id="3126717">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3126722">rc</span>&nbsp;<span class="op" id="3126725">:=</span>&nbsp;<span class="op" id="3126728">&lt;-</span><span class="ident" id="3126730">pc</span><span class="op" id="3126732">.</span><span class="ident" id="3126733">reqch</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3126742">var</span>&nbsp;<span class="ident" id="3126746">resp</span>&nbsp;<span class="op" id="3126751">*</span><span class="ident" id="3126752">Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3126763">if</span>&nbsp;<span class="ident" id="3126766">err</span>&nbsp;<span class="op" id="3126770">==</span>&nbsp;<span class="builtintype" id="3126773">nil</span>&nbsp;<span class="op" id="3126777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3126782">resp</span><span class="op" id="3126786">,</span>&nbsp;<span class="ident" id="3126788">err</span>&nbsp;<span class="op" id="3126792">=</span>&nbsp;<span class="ident" id="3126794">ReadResponse</span><span class="op" id="3126806">(</span><span class="ident" id="3126807">pc</span><span class="op" id="3126809">.</span><span class="ident" id="3126810">br</span><span class="op" id="3126812">,</span>&nbsp;<span class="ident" id="3126814">rc</span><span class="op" id="3126816">.</span><span class="ident" id="3126817">req</span><span class="op" id="3126820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3126825">if</span>&nbsp;<span class="ident" id="3126828">err</span>&nbsp;<span class="op" id="3126832">==</span>&nbsp;<span class="builtintype" id="3126835">nil</span>&nbsp;<span class="op" id="3126839">&amp;&amp;</span>&nbsp;<span class="ident" id="3126842">resp</span><span class="op" id="3126846">.</span><span class="ident" id="3126847">StatusCode</span>&nbsp;<span class="op" id="3126858">==</span>&nbsp;<span class="num" id="3126861">100</span>&nbsp;<span class="op" id="3126865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3126871">//&nbsp;Skip&nbsp;any&nbsp;100-continue&nbsp;for&nbsp;now.</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3126909">//&nbsp;TODO(bradfitz):&nbsp;if&nbsp;rc.req&nbsp;had&nbsp;&#34;Expect:&nbsp;100-continue&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3126970">//&nbsp;actually&nbsp;block&nbsp;the&nbsp;request&nbsp;body&nbsp;write&nbsp;and&nbsp;signal&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3127030">//&nbsp;writeLoop&nbsp;now&nbsp;to&nbsp;begin&nbsp;sending&nbsp;it.&nbsp;(Issue&nbsp;2184)&nbsp;For&nbsp;now&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3127096">//&nbsp;eat&nbsp;it,&nbsp;since&nbsp;we&#39;re&nbsp;never&nbsp;expecting&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3127144">resp</span><span class="op" id="3127148">,</span>&nbsp;<span class="ident" id="3127150">err</span>&nbsp;<span class="op" id="3127154">=</span>&nbsp;<span class="ident" id="3127156">ReadResponse</span><span class="op" id="3127168">(</span><span class="ident" id="3127169">pc</span><span class="op" id="3127171">.</span><span class="ident" id="3127172">br</span><span class="op" id="3127174">,</span>&nbsp;<span class="ident" id="3127176">rc</span><span class="op" id="3127178">.</span><span class="ident" id="3127179">req</span><span class="op" id="3127182">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3127187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3127191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127196">if</span>&nbsp;<span class="ident" id="3127199">resp</span>&nbsp;<span class="op" id="3127204">!=</span>&nbsp;<span class="builtintype" id="3127207">nil</span>&nbsp;<span class="op" id="3127211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3127216">resp</span><span class="op" id="3127220">.</span><span class="ident" id="3127221">TLS</span>&nbsp;<span class="op" id="3127225">=</span>&nbsp;<span class="ident" id="3127227">pc</span><span class="op" id="3127229">.</span><span class="ident" id="3127230">tlsState</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3127241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3127246">hasBody</span>&nbsp;<span class="op" id="3127254">:=</span>&nbsp;<span class="ident" id="3127257">resp</span>&nbsp;<span class="op" id="3127262">!=</span>&nbsp;<span class="builtintype" id="3127265">nil</span>&nbsp;<span class="op" id="3127269">&amp;&amp;</span>&nbsp;<span class="ident" id="3127272">rc</span><span class="op" id="3127274">.</span><span class="ident" id="3127275">req</span><span class="op" id="3127278">.</span><span class="ident" id="3127279">Method</span>&nbsp;<span class="op" id="3127286">!=</span>&nbsp;<span class="string" id="3127289">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3127296">&amp;&amp;</span>&nbsp;<span class="ident" id="3127299">resp</span><span class="op" id="3127303">.</span><span class="ident" id="3127304">ContentLength</span>&nbsp;<span class="op" id="3127318">!=</span>&nbsp;<span class="num" id="3127321">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127326">if</span>&nbsp;<span class="ident" id="3127329">err</span>&nbsp;<span class="op" id="3127333">!=</span>&nbsp;<span class="builtintype" id="3127336">nil</span>&nbsp;<span class="op" id="3127340">{</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3127345">pc</span><span class="op" id="3127347">.</span><span class="builtinfunc" id="3127348">close</span><span class="op" id="3127353">(</span><span class="op" id="3127354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3127358">}</span>&nbsp;<span class="keyword" id="3127360">else</span>&nbsp;<span class="op" id="3127365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127370">if</span>&nbsp;<span class="ident" id="3127373">rc</span><span class="op" id="3127375">.</span><span class="ident" id="3127376">addedGzip</span>&nbsp;<span class="op" id="3127386">&amp;&amp;</span>&nbsp;<span class="ident" id="3127389">hasBody</span>&nbsp;<span class="op" id="3127397">&amp;&amp;</span>&nbsp;<span class="ident" id="3127400">resp</span><span class="op" id="3127404">.</span><span class="ident" id="3127405">Header</span><span class="op" id="3127411">.</span><span class="ident" id="3127412">Get</span><span class="op" id="3127415">(</span><span class="string" id="3127416">&#34;Content-Encoding&#34;</span><span class="op" id="3127434">)</span>&nbsp;<span class="op" id="3127436">==</span>&nbsp;<span class="string" id="3127439">&#34;gzip&#34;</span>&nbsp;<span class="op" id="3127446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3127452">resp</span><span class="op" id="3127456">.</span><span class="ident" id="3127457">Header</span><span class="op" id="3127463">.</span><span class="ident" id="3127464">Del</span><span class="op" id="3127467">(</span><span class="string" id="3127468">&#34;Content-Encoding&#34;</span><span class="op" id="3127486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3127492">resp</span><span class="op" id="3127496">.</span><span class="ident" id="3127497">Header</span><span class="op" id="3127503">.</span><span class="ident" id="3127504">Del</span><span class="op" id="3127507">(</span><span class="string" id="3127508">&#34;Content-Length&#34;</span><span class="op" id="3127524">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3127530">resp</span><span class="op" id="3127534">.</span><span class="ident" id="3127535">ContentLength</span>&nbsp;<span class="op" id="3127549">=</span>&nbsp;<span class="op" id="3127551">-</span><span class="num" id="3127552">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3127558">resp</span><span class="op" id="3127562">.</span><span class="ident" id="3127563">Body</span>&nbsp;<span class="op" id="3127568">=</span>&nbsp;<span class="op" id="3127570">&amp;</span><span class="ident" id="3127571">gzipReader</span><span class="op" id="3127581">{</span><span class="ident" id="3127582">body</span><span class="op" id="3127586">:</span>&nbsp;<span class="ident" id="3127588">resp</span><span class="op" id="3127592">.</span><span class="ident" id="3127593">Body</span><span class="op" id="3127597">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3127602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3127607">resp</span><span class="op" id="3127611">.</span><span class="ident" id="3127612">Body</span>&nbsp;<span class="op" id="3127617">=</span>&nbsp;<span class="op" id="3127619">&amp;</span><span class="ident" id="3127620">bodyEOFSignal</span><span class="op" id="3127633">{</span><span class="ident" id="3127634">body</span><span class="op" id="3127638">:</span>&nbsp;<span class="ident" id="3127640">resp</span><span class="op" id="3127644">.</span><span class="ident" id="3127645">Body</span><span class="op" id="3127649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3127653">}</span><br>
<span class="lineno">890</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127658">if</span>&nbsp;<span class="ident" id="3127661">err</span>&nbsp;<span class="op" id="3127665">!=</span>&nbsp;<span class="builtintype" id="3127668">nil</span>&nbsp;<span class="op" id="3127672">||</span>&nbsp;<span class="ident" id="3127675">resp</span><span class="op" id="3127679">.</span><span class="ident" id="3127680">Close</span>&nbsp;<span class="op" id="3127686">||</span>&nbsp;<span class="ident" id="3127689">rc</span><span class="op" id="3127691">.</span><span class="ident" id="3127692">req</span><span class="op" id="3127695">.</span><span class="ident" id="3127696">Close</span>&nbsp;<span class="op" id="3127702">||</span>&nbsp;<span class="ident" id="3127705">resp</span><span class="op" id="3127709">.</span><span class="ident" id="3127710">StatusCode</span>&nbsp;<span class="op" id="3127721">&lt;=</span>&nbsp;<span class="num" id="3127724">199</span>&nbsp;<span class="op" id="3127728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3127733">//&nbsp;Don&#39;t&nbsp;do&nbsp;keep-alive&nbsp;on&nbsp;error&nbsp;if&nbsp;either&nbsp;party&nbsp;requested&nbsp;a&nbsp;close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3127802">//&nbsp;or&nbsp;we&nbsp;get&nbsp;an&nbsp;unexpected&nbsp;informational&nbsp;(1xx)&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3127862">//&nbsp;StatusCode&nbsp;100&nbsp;is&nbsp;already&nbsp;handled&nbsp;above.</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3127909">alive</span>&nbsp;<span class="op" id="3127915">=</span>&nbsp;<span class="builtintype" id="3127917">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3127925">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127930">var</span>&nbsp;<span class="ident" id="3127934">waitForBodyRead</span>&nbsp;<span class="keyword" id="3127950">chan</span>&nbsp;<span class="builtintype" id="3127955">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127962">if</span>&nbsp;<span class="ident" id="3127965">hasBody</span>&nbsp;<span class="op" id="3127973">{</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3127978">waitForBodyRead</span>&nbsp;<span class="op" id="3127994">=</span>&nbsp;<span class="builtinfunc" id="3127996">make</span><span class="op" id="3128000">(</span><span class="keyword" id="3128001">chan</span>&nbsp;<span class="builtintype" id="3128006">bool</span><span class="op" id="3128010">,</span>&nbsp;<span class="num" id="3128012">2</span><span class="op" id="3128013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128018">resp</span><span class="op" id="3128022">.</span><span class="ident" id="3128023">Body</span><span class="op" id="3128027">.</span><span class="op" id="3128028">(</span><span class="op" id="3128029">*</span><span class="ident" id="3128030">bodyEOFSignal</span><span class="op" id="3128043">)</span><span class="op" id="3128044">.</span><span class="ident" id="3128045">earlyCloseFn</span>&nbsp;<span class="op" id="3128058">=</span>&nbsp;<span class="keyword" id="3128060">func</span><span class="op" id="3128064">(</span><span class="op" id="3128065">)</span>&nbsp;<span class="builtintype" id="3128067">error</span>&nbsp;<span class="op" id="3128073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3128079">//&nbsp;Sending&nbsp;false&nbsp;here&nbsp;sets&nbsp;alive&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3128119">//&nbsp;false&nbsp;and&nbsp;closes&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3128158">//&nbsp;below.</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128172">waitForBodyRead</span>&nbsp;<span class="op" id="3128188">&lt;-</span>&nbsp;<span class="builtintype" id="3128191">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128201">return</span>&nbsp;<span class="builtintype" id="3128208">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3128215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128220">resp</span><span class="op" id="3128224">.</span><span class="ident" id="3128225">Body</span><span class="op" id="3128229">.</span><span class="op" id="3128230">(</span><span class="op" id="3128231">*</span><span class="ident" id="3128232">bodyEOFSignal</span><span class="op" id="3128245">)</span><span class="op" id="3128246">.</span><span class="ident" id="3128247">fn</span>&nbsp;<span class="op" id="3128250">=</span>&nbsp;<span class="keyword" id="3128252">func</span><span class="op" id="3128256">(</span><span class="ident" id="3128257">err</span>&nbsp;<span class="builtintype" id="3128261">error</span><span class="op" id="3128266">)</span>&nbsp;<span class="op" id="3128268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128274">waitForBodyRead</span>&nbsp;<span class="op" id="3128290">&lt;-</span>&nbsp;<span class="ident" id="3128293">alive</span>&nbsp;<span class="op" id="3128299">&amp;&amp;</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128307">err</span>&nbsp;<span class="op" id="3128311">==</span>&nbsp;<span class="builtintype" id="3128314">nil</span>&nbsp;<span class="op" id="3128318">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3128326">!</span><span class="ident" id="3128327">pc</span><span class="op" id="3128329">.</span><span class="ident" id="3128330">sawEOF</span>&nbsp;<span class="op" id="3128337">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128345">pc</span><span class="op" id="3128347">.</span><span class="ident" id="3128348">wroteRequest</span><span class="op" id="3128360">(</span><span class="op" id="3128361">)</span>&nbsp;<span class="op" id="3128363">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128371">pc</span><span class="op" id="3128373">.</span><span class="ident" id="3128374">t</span><span class="op" id="3128375">.</span><span class="ident" id="3128376">putIdleConn</span><span class="op" id="3128387">(</span><span class="ident" id="3128388">pc</span><span class="op" id="3128390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3128395">}</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3128399">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128404">if</span>&nbsp;<span class="ident" id="3128407">alive</span>&nbsp;<span class="op" id="3128413">&amp;&amp;</span>&nbsp;<span class="op" id="3128416">!</span><span class="ident" id="3128417">hasBody</span>&nbsp;<span class="op" id="3128425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128430">alive</span>&nbsp;<span class="op" id="3128436">=</span>&nbsp;<span class="op" id="3128438">!</span><span class="ident" id="3128439">pc</span><span class="op" id="3128441">.</span><span class="ident" id="3128442">sawEOF</span>&nbsp;<span class="op" id="3128449">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128456">pc</span><span class="op" id="3128458">.</span><span class="ident" id="3128459">wroteRequest</span><span class="op" id="3128471">(</span><span class="op" id="3128472">)</span>&nbsp;<span class="op" id="3128474">&amp;&amp;</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128481">pc</span><span class="op" id="3128483">.</span><span class="ident" id="3128484">t</span><span class="op" id="3128485">.</span><span class="ident" id="3128486">putIdleConn</span><span class="op" id="3128497">(</span><span class="ident" id="3128498">pc</span><span class="op" id="3128500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3128504">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128509">rc</span><span class="op" id="3128511">.</span><span class="ident" id="3128512">ch</span>&nbsp;<span class="op" id="3128515">&lt;-</span>&nbsp;<span class="ident" id="3128518">responseAndError</span><span class="op" id="3128534">{</span><span class="ident" id="3128535">resp</span><span class="op" id="3128539">,</span>&nbsp;<span class="ident" id="3128541">err</span><span class="op" id="3128544">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3128549">//&nbsp;Wait&nbsp;for&nbsp;the&nbsp;just-returned&nbsp;response&nbsp;body&nbsp;to&nbsp;be&nbsp;fully&nbsp;consumed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3128616">//&nbsp;before&nbsp;we&nbsp;race&nbsp;and&nbsp;peek&nbsp;on&nbsp;the&nbsp;underlying&nbsp;bufio&nbsp;reader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128677">if</span>&nbsp;<span class="ident" id="3128680">waitForBodyRead</span>&nbsp;<span class="op" id="3128696">!=</span>&nbsp;<span class="builtintype" id="3128699">nil</span>&nbsp;<span class="op" id="3128703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128708">select</span>&nbsp;<span class="op" id="3128715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128720">case</span>&nbsp;<span class="ident" id="3128725">alive</span>&nbsp;<span class="op" id="3128731">=</span>&nbsp;<span class="op" id="3128733">&lt;-</span><span class="ident" id="3128735">waitForBodyRead</span><span class="op" id="3128750">:</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128755">case</span>&nbsp;<span class="op" id="3128760">&lt;-</span><span class="ident" id="3128762">pc</span><span class="op" id="3128764">.</span><span class="ident" id="3128765">closech</span><span class="op" id="3128772">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128778">alive</span>&nbsp;<span class="op" id="3128784">=</span>&nbsp;<span class="builtintype" id="3128786">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3128795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3128799">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128804">pc</span><span class="op" id="3128806">.</span><span class="ident" id="3128807">t</span><span class="op" id="3128808">.</span><span class="ident" id="3128809">setReqCanceler</span><span class="op" id="3128823">(</span><span class="ident" id="3128824">rc</span><span class="op" id="3128826">.</span><span class="ident" id="3128827">req</span><span class="op" id="3128830">,</span>&nbsp;<span class="builtintype" id="3128832">nil</span><span class="op" id="3128835">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128840">if</span>&nbsp;<span class="op" id="3128843">!</span><span class="ident" id="3128844">alive</span>&nbsp;<span class="op" id="3128850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128855">pc</span><span class="op" id="3128857">.</span><span class="builtinfunc" id="3128858">close</span><span class="op" id="3128863">(</span><span class="op" id="3128864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3128868">}</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3128871">}</span><br>
<span class="lineno"></span><span class="op" id="3128873">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3128876">func</span>&nbsp;<span class="op" id="3128881">(</span><span class="ident" id="3128882">pc</span>&nbsp;<span class="op" id="3128885">*</span><span class="ident" id="3128886">persistConn</span><span class="op" id="3128897">)</span>&nbsp;<span class="ident" id="3128899">writeLoop</span><span class="op" id="3128908">(</span><span class="op" id="3128909">)</span>&nbsp;<span class="op" id="3128911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128914">for</span>&nbsp;<span class="op" id="3128918">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128922">select</span>&nbsp;<span class="op" id="3128929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128933">case</span>&nbsp;<span class="ident" id="3128938">wr</span>&nbsp;<span class="op" id="3128941">:=</span>&nbsp;<span class="op" id="3128944">&lt;-</span><span class="ident" id="3128946">pc</span><span class="op" id="3128948">.</span><span class="ident" id="3128949">writech</span><span class="op" id="3128956">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128961">if</span>&nbsp;<span class="ident" id="3128964">pc</span><span class="op" id="3128966">.</span><span class="ident" id="3128967">isBroken</span><span class="op" id="3128975">(</span><span class="op" id="3128976">)</span>&nbsp;<span class="op" id="3128978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128984">wr</span><span class="op" id="3128986">.</span><span class="ident" id="3128987">ch</span>&nbsp;<span class="op" id="3128990">&lt;-</span>&nbsp;<span class="ident" id="3128993">errors</span><span class="op" id="3128999">.</span><span class="ident" id="3129000">New</span><span class="op" id="3129003">(</span><span class="string" id="3129004">&#34;http:&nbsp;can&#39;t&nbsp;write&nbsp;HTTP&nbsp;request&nbsp;on&nbsp;broken&nbsp;connection&#34;</span><span class="op" id="3129057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3129063">continue</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3129075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3129080">err</span>&nbsp;<span class="op" id="3129084">:=</span>&nbsp;<span class="ident" id="3129087">wr</span><span class="op" id="3129089">.</span><span class="ident" id="3129090">req</span><span class="op" id="3129093">.</span><span class="ident" id="3129094">Request</span><span class="op" id="3129101">.</span><span class="ident" id="3129102">write</span><span class="op" id="3129107">(</span><span class="ident" id="3129108">pc</span><span class="op" id="3129110">.</span><span class="ident" id="3129111">bw</span><span class="op" id="3129113">,</span>&nbsp;<span class="ident" id="3129115">pc</span><span class="op" id="3129117">.</span><span class="ident" id="3129118">isProxy</span><span class="op" id="3129125">,</span>&nbsp;<span class="ident" id="3129127">wr</span><span class="op" id="3129129">.</span><span class="ident" id="3129130">req</span><span class="op" id="3129133">.</span><span class="ident" id="3129134">extra</span><span class="op" id="3129139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3129144">if</span>&nbsp;<span class="ident" id="3129147">err</span>&nbsp;<span class="op" id="3129151">==</span>&nbsp;<span class="builtintype" id="3129154">nil</span>&nbsp;<span class="op" id="3129158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3129164">err</span>&nbsp;<span class="op" id="3129168">=</span>&nbsp;<span class="ident" id="3129170">pc</span><span class="op" id="3129172">.</span><span class="ident" id="3129173">bw</span><span class="op" id="3129175">.</span><span class="ident" id="3129176">Flush</span><span class="op" id="3129181">(</span><span class="op" id="3129182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3129187">}</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3129192">if</span>&nbsp;<span class="ident" id="3129195">err</span>&nbsp;<span class="op" id="3129199">!=</span>&nbsp;<span class="builtintype" id="3129202">nil</span>&nbsp;<span class="op" id="3129206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3129212">pc</span><span class="op" id="3129214">.</span><span class="ident" id="3129215">markBroken</span><span class="op" id="3129225">(</span><span class="op" id="3129226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3129232">wr</span><span class="op" id="3129234">.</span><span class="ident" id="3129235">req</span><span class="op" id="3129238">.</span><span class="ident" id="3129239">Request</span><span class="op" id="3129246">.</span><span class="ident" id="3129247">closeBody</span><span class="op" id="3129256">(</span><span class="op" id="3129257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3129262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3129267">pc</span><span class="op" id="3129269">.</span><span class="ident" id="3129270">writeErrCh</span>&nbsp;<span class="op" id="3129281">&lt;-</span>&nbsp;<span class="ident" id="3129284">err</span>&nbsp;<span class="comment" id="3129288">//&nbsp;to&nbsp;the&nbsp;body&nbsp;reader,&nbsp;which&nbsp;might&nbsp;recycle&nbsp;us</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3129337">wr</span><span class="op" id="3129339">.</span><span class="ident" id="3129340">ch</span>&nbsp;<span class="op" id="3129343">&lt;-</span>&nbsp;<span class="ident" id="3129346">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3129358">//&nbsp;to&nbsp;the&nbsp;roundTrip&nbsp;function</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3129389">case</span>&nbsp;<span class="op" id="3129394">&lt;-</span><span class="ident" id="3129396">pc</span><span class="op" id="3129398">.</span><span class="ident" id="3129399">closech</span><span class="op" id="3129406">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3129411">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3129420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3129423">}</span><br>
<span class="lineno">965</span><span class="op" id="3129425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3129428">//&nbsp;wroteRequest&nbsp;is&nbsp;a&nbsp;check&nbsp;before&nbsp;recycling&nbsp;a&nbsp;connection&nbsp;that&nbsp;the&nbsp;previous&nbsp;write</span><br>
<span class="lineno"></span><span class="comment" id="3129509">//&nbsp;(from&nbsp;writeLoop&nbsp;above)&nbsp;happened&nbsp;and&nbsp;was&nbsp;successful.</span><br>
<span class="lineno"></span><span class="keyword" id="3129564">func</span>&nbsp;<span class="op" id="3129569">(</span><span class="ident" id="3129570">pc</span>&nbsp;<span class="op" id="3129573">*</span><span class="ident" id="3129574">persistConn</span><span class="op" id="3129585">)</span>&nbsp;<span class="ident" id="3129587">wroteRequest</span><span class="op" id="3129599">(</span><span class="op" id="3129600">)</span>&nbsp;<span class="builtintype" id="3129602">bool</span>&nbsp;<span class="op" id="3129607">{</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3129610">select</span>&nbsp;<span class="op" id="3129617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3129620">case</span>&nbsp;<span class="ident" id="3129625">err</span>&nbsp;<span class="op" id="3129629">:=</span>&nbsp;<span class="op" id="3129632">&lt;-</span><span class="ident" id="3129634">pc</span><span class="op" id="3129636">.</span><span class="ident" id="3129637">writeErrCh</span><span class="op" id="3129647">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3129651">//&nbsp;Common&nbsp;case:&nbsp;the&nbsp;write&nbsp;happened&nbsp;well&nbsp;before&nbsp;the&nbsp;response,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3129717">//&nbsp;avoid&nbsp;creating&nbsp;a&nbsp;timer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3129746">return</span>&nbsp;<span class="ident" id="3129753">err</span>&nbsp;<span class="op" id="3129757">==</span>&nbsp;<span class="builtintype" id="3129760">nil</span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3129765">default</span><span class="op" id="3129772">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3129776">//&nbsp;Rare&nbsp;case:&nbsp;the&nbsp;request&nbsp;was&nbsp;written&nbsp;in&nbsp;writeLoop&nbsp;above&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3129839">//&nbsp;before&nbsp;it&nbsp;could&nbsp;send&nbsp;to&nbsp;pc.writeErrCh,&nbsp;the&nbsp;reader&nbsp;read&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3129902">//&nbsp;all,&nbsp;processed&nbsp;it,&nbsp;and&nbsp;called&nbsp;us&nbsp;here.&nbsp;In&nbsp;this&nbsp;case,&nbsp;give&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3129969">//&nbsp;write&nbsp;goroutine&nbsp;a&nbsp;bit&nbsp;of&nbsp;time&nbsp;to&nbsp;finish&nbsp;its&nbsp;send.</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3130024">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3130029">//&nbsp;Less&nbsp;rare&nbsp;case:&nbsp;We&nbsp;also&nbsp;get&nbsp;here&nbsp;in&nbsp;the&nbsp;legitimate&nbsp;case&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3130093">//&nbsp;Issue&nbsp;7569,&nbsp;where&nbsp;the&nbsp;writer&nbsp;is&nbsp;still&nbsp;writing&nbsp;(or&nbsp;stalled),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3130158">//&nbsp;but&nbsp;the&nbsp;server&nbsp;has&nbsp;already&nbsp;replied.&nbsp;In&nbsp;this&nbsp;case,&nbsp;we&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3130222">//&nbsp;want&nbsp;to&nbsp;wait&nbsp;too&nbsp;long,&nbsp;and&nbsp;we&nbsp;want&nbsp;to&nbsp;return&nbsp;false&nbsp;so&nbsp;this</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3130286">//&nbsp;connection&nbsp;isn&#39;t&nbsp;re-used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3130317">select</span>&nbsp;<span class="op" id="3130324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3130328">case</span>&nbsp;<span class="ident" id="3130333">err</span>&nbsp;<span class="op" id="3130337">:=</span>&nbsp;<span class="op" id="3130340">&lt;-</span><span class="ident" id="3130342">pc</span><span class="op" id="3130344">.</span><span class="ident" id="3130345">writeErrCh</span><span class="op" id="3130355">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3130360">return</span>&nbsp;<span class="ident" id="3130367">err</span>&nbsp;<span class="op" id="3130371">==</span>&nbsp;<span class="builtintype" id="3130374">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3130380">case</span>&nbsp;<span class="op" id="3130385">&lt;-</span><span class="ident" id="3130387">time</span><span class="op" id="3130391">.</span><span class="ident" id="3130392">After</span><span class="op" id="3130397">(</span><span class="num" id="3130398">50</span>&nbsp;<span class="op" id="3130401">*</span>&nbsp;<span class="ident" id="3130403">time</span><span class="op" id="3130407">.</span><span class="ident" id="3130408">Millisecond</span><span class="op" id="3130419">)</span><span class="op" id="3130420">:</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3130425">return</span>&nbsp;<span class="builtintype" id="3130432">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3130440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3130443">}</span><br>
<span class="lineno"></span><span class="op" id="3130445">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">995</span><span class="keyword" id="3130448">type</span>&nbsp;<span class="ident" id="3130453">responseAndError</span>&nbsp;<span class="keyword" id="3130470">struct</span>&nbsp;<span class="op" id="3130477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3130480">res</span>&nbsp;<span class="op" id="3130484">*</span><span class="ident" id="3130485">Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3130495">err</span>&nbsp;<span class="builtintype" id="3130499">error</span><br>
<span class="lineno"></span><span class="op" id="3130505">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1000</span><span class="keyword" id="3130508">type</span>&nbsp;<span class="ident" id="3130513">requestAndChan</span>&nbsp;<span class="keyword" id="3130528">struct</span>&nbsp;<span class="op" id="3130535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3130538">req</span>&nbsp;<span class="op" id="3130542">*</span><span class="ident" id="3130543">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3130552">ch</span>&nbsp;&nbsp;<span class="keyword" id="3130556">chan</span>&nbsp;<span class="ident" id="3130561">responseAndError</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3130580">//&nbsp;did&nbsp;the&nbsp;Transport&nbsp;(as&nbsp;opposed&nbsp;to&nbsp;the&nbsp;client&nbsp;code)&nbsp;add&nbsp;an</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3130641">//&nbsp;Accept-Encoding&nbsp;gzip&nbsp;header?&nbsp;only&nbsp;if&nbsp;it&nbsp;we&nbsp;set&nbsp;it&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3130698">//&nbsp;we&nbsp;transparently&nbsp;decode&nbsp;the&nbsp;gzip.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3130736">addedGzip</span>&nbsp;<span class="builtintype" id="3130746">bool</span><br>
<span class="lineno"></span><span class="op" id="3130751">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1010</span><span class="comment" id="3130754">//&nbsp;A&nbsp;writeRequest&nbsp;is&nbsp;sent&nbsp;by&nbsp;the&nbsp;readLoop&#39;s&nbsp;goroutine&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3130815">//&nbsp;writeLoop&#39;s&nbsp;goroutine&nbsp;to&nbsp;write&nbsp;a&nbsp;request&nbsp;while&nbsp;the&nbsp;read&nbsp;loop</span><br>
<span class="lineno"></span><span class="comment" id="3130879">//&nbsp;concurrently&nbsp;waits&nbsp;on&nbsp;both&nbsp;the&nbsp;write&nbsp;response&nbsp;and&nbsp;the&nbsp;server&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3130945">//&nbsp;reply.</span><br>
<span class="lineno"></span><span class="keyword" id="3130955">type</span>&nbsp;<span class="ident" id="3130960">writeRequest</span>&nbsp;<span class="keyword" id="3130973">struct</span>&nbsp;<span class="op" id="3130980">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3130983">req</span>&nbsp;<span class="op" id="3130987">*</span><span class="ident" id="3130988">transportRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3131006">ch</span>&nbsp;&nbsp;<span class="keyword" id="3131010">chan</span><span class="op" id="3131014">&lt;-</span>&nbsp;<span class="builtintype" id="3131017">error</span><br>
<span class="lineno"></span><span class="op" id="3131023">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3131026">type</span>&nbsp;<span class="ident" id="3131031">httpError</span>&nbsp;<span class="keyword" id="3131041">struct</span>&nbsp;<span class="op" id="3131048">{</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3131051">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3131059">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3131067">timeout</span>&nbsp;<span class="builtintype" id="3131075">bool</span><br>
<span class="lineno"></span><span class="op" id="3131080">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3131083">func</span>&nbsp;<span class="op" id="3131088">(</span><span class="ident" id="3131089">e</span>&nbsp;<span class="op" id="3131091">*</span><span class="ident" id="3131092">httpError</span><span class="op" id="3131101">)</span>&nbsp;<span class="ident" id="3131103">Error</span><span class="op" id="3131108">(</span><span class="op" id="3131109">)</span>&nbsp;<span class="builtintype" id="3131111">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3131120">{</span>&nbsp;<span class="keyword" id="3131122">return</span>&nbsp;<span class="ident" id="3131129">e</span><span class="op" id="3131130">.</span><span class="ident" id="3131131">err</span>&nbsp;<span class="op" id="3131135">}</span><br>
<span class="lineno">1025</span><span class="keyword" id="3131137">func</span>&nbsp;<span class="op" id="3131142">(</span><span class="ident" id="3131143">e</span>&nbsp;<span class="op" id="3131145">*</span><span class="ident" id="3131146">httpError</span><span class="op" id="3131155">)</span>&nbsp;<span class="ident" id="3131157">Timeout</span><span class="op" id="3131164">(</span><span class="op" id="3131165">)</span>&nbsp;<span class="builtintype" id="3131167">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3131174">{</span>&nbsp;<span class="keyword" id="3131176">return</span>&nbsp;<span class="ident" id="3131183">e</span><span class="op" id="3131184">.</span><span class="ident" id="3131185">timeout</span>&nbsp;<span class="op" id="3131193">}</span><br>
<span class="lineno"></span><span class="keyword" id="3131195">func</span>&nbsp;<span class="op" id="3131200">(</span><span class="ident" id="3131201">e</span>&nbsp;<span class="op" id="3131203">*</span><span class="ident" id="3131204">httpError</span><span class="op" id="3131213">)</span>&nbsp;<span class="ident" id="3131215">Temporary</span><span class="op" id="3131224">(</span><span class="op" id="3131225">)</span>&nbsp;<span class="builtintype" id="3131227">bool</span>&nbsp;<span class="op" id="3131232">{</span>&nbsp;<span class="keyword" id="3131234">return</span>&nbsp;<span class="builtintype" id="3131241">true</span>&nbsp;<span class="op" id="3131246">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3131249">var</span>&nbsp;<span class="ident" id="3131253">errTimeout</span>&nbsp;<span class="builtintype" id="3131264">error</span>&nbsp;<span class="op" id="3131270">=</span>&nbsp;<span class="op" id="3131272">&amp;</span><span class="ident" id="3131273">httpError</span><span class="op" id="3131282">{</span><span class="ident" id="3131283">err</span><span class="op" id="3131286">:</span>&nbsp;<span class="string" id="3131288">&#34;net/http:&nbsp;timeout&nbsp;awaiting&nbsp;response&nbsp;headers&#34;</span><span class="op" id="3131333">,</span>&nbsp;<span class="ident" id="3131335">timeout</span><span class="op" id="3131342">:</span>&nbsp;<span class="builtintype" id="3131344">true</span><span class="op" id="3131348">}</span><br>
<span class="lineno"></span><span class="keyword" id="3131350">var</span>&nbsp;<span class="ident" id="3131354">errClosed</span>&nbsp;<span class="builtintype" id="3131364">error</span>&nbsp;<span class="op" id="3131370">=</span>&nbsp;<span class="op" id="3131372">&amp;</span><span class="ident" id="3131373">httpError</span><span class="op" id="3131382">{</span><span class="ident" id="3131383">err</span><span class="op" id="3131386">:</span>&nbsp;<span class="string" id="3131388">&#34;net/http:&nbsp;transport&nbsp;closed&nbsp;before&nbsp;response&nbsp;was&nbsp;received&#34;</span><span class="op" id="3131445">}</span><br>
<span class="lineno">1030</span><br>
<span class="lineno"></span><span class="keyword" id="3131448">func</span>&nbsp;<span class="op" id="3131453">(</span><span class="ident" id="3131454">pc</span>&nbsp;<span class="op" id="3131457">*</span><span class="ident" id="3131458">persistConn</span><span class="op" id="3131469">)</span>&nbsp;<span class="ident" id="3131471">roundTrip</span><span class="op" id="3131480">(</span><span class="ident" id="3131481">req</span>&nbsp;<span class="op" id="3131485">*</span><span class="ident" id="3131486">transportRequest</span><span class="op" id="3131502">)</span>&nbsp;<span class="op" id="3131504">(</span><span class="ident" id="3131505">resp</span>&nbsp;<span class="op" id="3131510">*</span><span class="ident" id="3131511">Response</span><span class="op" id="3131519">,</span>&nbsp;<span class="ident" id="3131521">err</span>&nbsp;<span class="builtintype" id="3131525">error</span><span class="op" id="3131530">)</span>&nbsp;<span class="op" id="3131532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3131535">pc</span><span class="op" id="3131537">.</span><span class="ident" id="3131538">t</span><span class="op" id="3131539">.</span><span class="ident" id="3131540">setReqCanceler</span><span class="op" id="3131554">(</span><span class="ident" id="3131555">req</span><span class="op" id="3131558">.</span><span class="ident" id="3131559">Request</span><span class="op" id="3131566">,</span>&nbsp;<span class="ident" id="3131568">pc</span><span class="op" id="3131570">.</span><span class="ident" id="3131571">cancelRequest</span><span class="op" id="3131584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3131587">pc</span><span class="op" id="3131589">.</span><span class="ident" id="3131590">lk</span><span class="op" id="3131592">.</span><span class="ident" id="3131593">Lock</span><span class="op" id="3131597">(</span><span class="op" id="3131598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3131601">pc</span><span class="op" id="3131603">.</span><span class="ident" id="3131604">numExpectedResponses</span><span class="op" id="3131624">++</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3131628">headerFn</span>&nbsp;<span class="op" id="3131637">:=</span>&nbsp;<span class="ident" id="3131640">pc</span><span class="op" id="3131642">.</span><span class="ident" id="3131643">mutateHeaderFunc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3131661">pc</span><span class="op" id="3131663">.</span><span class="ident" id="3131664">lk</span><span class="op" id="3131666">.</span><span class="ident" id="3131667">Unlock</span><span class="op" id="3131673">(</span><span class="op" id="3131674">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3131678">if</span>&nbsp;<span class="ident" id="3131681">headerFn</span>&nbsp;<span class="op" id="3131690">!=</span>&nbsp;<span class="builtintype" id="3131693">nil</span>&nbsp;<span class="op" id="3131697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3131701">headerFn</span><span class="op" id="3131709">(</span><span class="ident" id="3131710">req</span><span class="op" id="3131713">.</span><span class="ident" id="3131714">extraHeaders</span><span class="op" id="3131726">(</span><span class="op" id="3131727">)</span><span class="op" id="3131728">)</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3131731">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3131735">//&nbsp;Ask&nbsp;for&nbsp;a&nbsp;compressed&nbsp;version&nbsp;if&nbsp;the&nbsp;caller&nbsp;didn&#39;t&nbsp;set&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3131799">//&nbsp;own&nbsp;value&nbsp;for&nbsp;Accept-Encoding.&nbsp;We&nbsp;only&nbsp;attempt&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3131853">//&nbsp;uncompress&nbsp;the&nbsp;gzip&nbsp;stream&nbsp;if&nbsp;we&nbsp;were&nbsp;the&nbsp;layer&nbsp;that</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3131910">//&nbsp;requested&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3131928">requestedGzip</span>&nbsp;<span class="op" id="3131942">:=</span>&nbsp;<span class="builtintype" id="3131945">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3131952">if</span>&nbsp;<span class="op" id="3131955">!</span><span class="ident" id="3131956">pc</span><span class="op" id="3131958">.</span><span class="ident" id="3131959">t</span><span class="op" id="3131960">.</span><span class="ident" id="3131961">DisableCompression</span>&nbsp;<span class="op" id="3131980">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3131985">req</span><span class="op" id="3131988">.</span><span class="ident" id="3131989">Header</span><span class="op" id="3131995">.</span><span class="ident" id="3131996">Get</span><span class="op" id="3131999">(</span><span class="string" id="3132000">&#34;Accept-Encoding&#34;</span><span class="op" id="3132017">)</span>&nbsp;<span class="op" id="3132019">==</span>&nbsp;<span class="string" id="3132022">&#34;&#34;</span>&nbsp;<span class="op" id="3132025">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3132030">req</span><span class="op" id="3132033">.</span><span class="ident" id="3132034">Header</span><span class="op" id="3132040">.</span><span class="ident" id="3132041">Get</span><span class="op" id="3132044">(</span><span class="string" id="3132045">&#34;Range&#34;</span><span class="op" id="3132052">)</span>&nbsp;<span class="op" id="3132054">==</span>&nbsp;<span class="string" id="3132057">&#34;&#34;</span>&nbsp;<span class="op" id="3132060">&amp;&amp;</span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3132065">req</span><span class="op" id="3132068">.</span><span class="ident" id="3132069">Method</span>&nbsp;<span class="op" id="3132076">!=</span>&nbsp;<span class="string" id="3132079">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3132086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3132090">//&nbsp;Request&nbsp;gzip&nbsp;only,&nbsp;not&nbsp;deflate.&nbsp;Deflate&nbsp;is&nbsp;ambiguous&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3132152">//&nbsp;not&nbsp;as&nbsp;universally&nbsp;supported&nbsp;anyway.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3132194">//&nbsp;See:&nbsp;http://www.gzip.org/zlib/zlib_faq.html#faq38</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3132249">//</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3132254">//&nbsp;Note&nbsp;that&nbsp;we&nbsp;don&#39;t&nbsp;request&nbsp;this&nbsp;for&nbsp;HEAD&nbsp;requests,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3132310">//&nbsp;due&nbsp;to&nbsp;a&nbsp;bug&nbsp;in&nbsp;nginx:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3132338">//&nbsp;&nbsp;&nbsp;http://trac.nginx.org/nginx/ticket/358</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3132384">//&nbsp;&nbsp;&nbsp;http://golang.org/issue/5522</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3132420">//</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3132425">//&nbsp;We&nbsp;don&#39;t&nbsp;request&nbsp;gzip&nbsp;if&nbsp;the&nbsp;request&nbsp;is&nbsp;for&nbsp;a&nbsp;range,&nbsp;since</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3132489">//&nbsp;auto-decoding&nbsp;a&nbsp;portion&nbsp;of&nbsp;a&nbsp;gzipped&nbsp;document&nbsp;will&nbsp;just&nbsp;fail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3132555">//&nbsp;anyway.&nbsp;See&nbsp;http://golang.org/issue/8923</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3132601">requestedGzip</span>&nbsp;<span class="op" id="3132615">=</span>&nbsp;<span class="builtintype" id="3132617">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3132624">req</span><span class="op" id="3132627">.</span><span class="ident" id="3132628">extraHeaders</span><span class="op" id="3132640">(</span><span class="op" id="3132641">)</span><span class="op" id="3132642">.</span><span class="ident" id="3132643">Set</span><span class="op" id="3132646">(</span><span class="string" id="3132647">&#34;Accept-Encoding&#34;</span><span class="op" id="3132664">,</span>&nbsp;<span class="string" id="3132666">&#34;gzip&#34;</span><span class="op" id="3132672">)</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3132675">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3132679">//&nbsp;Write&nbsp;the&nbsp;request&nbsp;concurrently&nbsp;with&nbsp;waiting&nbsp;for&nbsp;a&nbsp;response,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3132743">//&nbsp;in&nbsp;case&nbsp;the&nbsp;server&nbsp;decides&nbsp;to&nbsp;reply&nbsp;before&nbsp;reading&nbsp;our&nbsp;full</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3132807">//&nbsp;request&nbsp;body.</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3132825">writeErrCh</span>&nbsp;<span class="op" id="3132836">:=</span>&nbsp;<span class="builtinfunc" id="3132839">make</span><span class="op" id="3132843">(</span><span class="keyword" id="3132844">chan</span>&nbsp;<span class="builtintype" id="3132849">error</span><span class="op" id="3132854">,</span>&nbsp;<span class="num" id="3132856">1</span><span class="op" id="3132857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3132860">pc</span><span class="op" id="3132862">.</span><span class="ident" id="3132863">writech</span>&nbsp;<span class="op" id="3132871">&lt;-</span>&nbsp;<span class="ident" id="3132874">writeRequest</span><span class="op" id="3132886">{</span><span class="ident" id="3132887">req</span><span class="op" id="3132890">,</span>&nbsp;<span class="ident" id="3132892">writeErrCh</span><span class="op" id="3132902">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3132906">resc</span>&nbsp;<span class="op" id="3132911">:=</span>&nbsp;<span class="builtinfunc" id="3132914">make</span><span class="op" id="3132918">(</span><span class="keyword" id="3132919">chan</span>&nbsp;<span class="ident" id="3132924">responseAndError</span><span class="op" id="3132940">,</span>&nbsp;<span class="num" id="3132942">1</span><span class="op" id="3132943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3132946">pc</span><span class="op" id="3132948">.</span><span class="ident" id="3132949">reqch</span>&nbsp;<span class="op" id="3132955">&lt;-</span>&nbsp;<span class="ident" id="3132958">requestAndChan</span><span class="op" id="3132972">{</span><span class="ident" id="3132973">req</span><span class="op" id="3132976">.</span><span class="ident" id="3132977">Request</span><span class="op" id="3132984">,</span>&nbsp;<span class="ident" id="3132986">resc</span><span class="op" id="3132990">,</span>&nbsp;<span class="ident" id="3132992">requestedGzip</span><span class="op" id="3133005">}</span><br>
<span class="lineno">1075</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3133009">var</span>&nbsp;<span class="ident" id="3133013">re</span>&nbsp;<span class="ident" id="3133016">responseAndError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3133034">var</span>&nbsp;<span class="ident" id="3133038">pconnDeadCh</span>&nbsp;<span class="op" id="3133050">=</span>&nbsp;<span class="ident" id="3133052">pc</span><span class="op" id="3133054">.</span><span class="ident" id="3133055">closech</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3133064">var</span>&nbsp;<span class="ident" id="3133068">failTicker</span>&nbsp;<span class="op" id="3133079">&lt;-</span><span class="keyword" id="3133081">chan</span>&nbsp;<span class="ident" id="3133086">time</span><span class="op" id="3133090">.</span><span class="ident" id="3133091">Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3133097">var</span>&nbsp;<span class="ident" id="3133101">respHeaderTimer</span>&nbsp;<span class="op" id="3133117">&lt;-</span><span class="keyword" id="3133119">chan</span>&nbsp;<span class="ident" id="3133124">time</span><span class="op" id="3133128">.</span><span class="ident" id="3133129">Time</span><br>
<span class="lineno">1080</span><span class="ident" id="3133134">WaitResponse</span><span class="op" id="3133146">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3133149">for</span>&nbsp;<span class="op" id="3133153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3133157">select</span>&nbsp;<span class="op" id="3133164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3133168">case</span>&nbsp;<span class="ident" id="3133173">err</span>&nbsp;<span class="op" id="3133177">:=</span>&nbsp;<span class="op" id="3133180">&lt;-</span><span class="ident" id="3133182">writeErrCh</span><span class="op" id="3133192">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3133197">if</span>&nbsp;<span class="ident" id="3133200">err</span>&nbsp;<span class="op" id="3133204">!=</span>&nbsp;<span class="builtintype" id="3133207">nil</span>&nbsp;<span class="op" id="3133211">{</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3133217">re</span>&nbsp;<span class="op" id="3133220">=</span>&nbsp;<span class="ident" id="3133222">responseAndError</span><span class="op" id="3133238">{</span><span class="builtintype" id="3133239">nil</span><span class="op" id="3133242">,</span>&nbsp;<span class="ident" id="3133244">err</span><span class="op" id="3133247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3133253">pc</span><span class="op" id="3133255">.</span><span class="builtinfunc" id="3133256">close</span><span class="op" id="3133261">(</span><span class="op" id="3133262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3133268">break</span>&nbsp;<span class="ident" id="3133274">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3133290">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3133295">if</span>&nbsp;<span class="ident" id="3133298">d</span>&nbsp;<span class="op" id="3133300">:=</span>&nbsp;<span class="ident" id="3133303">pc</span><span class="op" id="3133305">.</span><span class="ident" id="3133306">t</span><span class="op" id="3133307">.</span><span class="ident" id="3133308">ResponseHeaderTimeout</span><span class="op" id="3133329">;</span>&nbsp;<span class="ident" id="3133331">d</span>&nbsp;<span class="op" id="3133333">&gt;</span>&nbsp;<span class="num" id="3133335">0</span>&nbsp;<span class="op" id="3133337">{</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3133343">respHeaderTimer</span>&nbsp;<span class="op" id="3133359">=</span>&nbsp;<span class="ident" id="3133361">time</span><span class="op" id="3133365">.</span><span class="ident" id="3133366">After</span><span class="op" id="3133371">(</span><span class="ident" id="3133372">d</span><span class="op" id="3133373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3133378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3133382">case</span>&nbsp;<span class="op" id="3133387">&lt;-</span><span class="ident" id="3133389">pconnDeadCh</span><span class="op" id="3133400">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3133405">//&nbsp;The&nbsp;persist&nbsp;connection&nbsp;is&nbsp;dead.&nbsp;This&nbsp;shouldn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3133458">//&nbsp;usually&nbsp;happen&nbsp;(only&nbsp;with&nbsp;Connection:&nbsp;close&nbsp;responses</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3133518">//&nbsp;with&nbsp;no&nbsp;response&nbsp;bodies),&nbsp;but&nbsp;if&nbsp;it&nbsp;does&nbsp;happen&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3133575">//&nbsp;means&nbsp;either&nbsp;a)&nbsp;the&nbsp;remote&nbsp;server&nbsp;hung&nbsp;up&nbsp;on&nbsp;us</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3133629">//&nbsp;prematurely,&nbsp;or&nbsp;b)&nbsp;the&nbsp;readLoop&nbsp;sent&nbsp;us&nbsp;a&nbsp;response&nbsp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3133688">//&nbsp;closed&nbsp;its&nbsp;closech&nbsp;at&nbsp;roughly&nbsp;the&nbsp;same&nbsp;time,&nbsp;and&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3133746">//&nbsp;selected&nbsp;this&nbsp;case&nbsp;first,&nbsp;in&nbsp;which&nbsp;case&nbsp;a&nbsp;response</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3133803">//&nbsp;might&nbsp;still&nbsp;be&nbsp;coming&nbsp;soon.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3133837">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3133843">//&nbsp;We&nbsp;can&#39;t&nbsp;avoid&nbsp;the&nbsp;select&nbsp;race&nbsp;in&nbsp;b)&nbsp;by&nbsp;using&nbsp;a&nbsp;unbuffered</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3133908">//&nbsp;resc&nbsp;channel&nbsp;instead,&nbsp;because&nbsp;then&nbsp;goroutines&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3133964">//&nbsp;leak&nbsp;if&nbsp;we&nbsp;exit&nbsp;due&nbsp;to&nbsp;other&nbsp;errors.</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3134007">pconnDeadCh</span>&nbsp;<span class="op" id="3134019">=</span>&nbsp;<span class="builtintype" id="3134021">nil</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3134055">//&nbsp;avoid&nbsp;spinning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3134076">failTicker</span>&nbsp;<span class="op" id="3134087">=</span>&nbsp;<span class="ident" id="3134089">time</span><span class="op" id="3134093">.</span><span class="ident" id="3134094">After</span><span class="op" id="3134099">(</span><span class="num" id="3134100">100</span>&nbsp;<span class="op" id="3134104">*</span>&nbsp;<span class="ident" id="3134106">time</span><span class="op" id="3134110">.</span><span class="ident" id="3134111">Millisecond</span><span class="op" id="3134122">)</span>&nbsp;<span class="comment" id="3134124">//&nbsp;arbitrary&nbsp;time&nbsp;to&nbsp;wait&nbsp;for&nbsp;resc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3134161">case</span>&nbsp;<span class="op" id="3134166">&lt;-</span><span class="ident" id="3134168">failTicker</span><span class="op" id="3134178">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3134183">re</span>&nbsp;<span class="op" id="3134186">=</span>&nbsp;<span class="ident" id="3134188">responseAndError</span><span class="op" id="3134204">{</span><span class="ident" id="3134205">err</span><span class="op" id="3134208">:</span>&nbsp;<span class="ident" id="3134210">errClosed</span><span class="op" id="3134219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3134224">break</span>&nbsp;<span class="ident" id="3134230">WaitResponse</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3134245">case</span>&nbsp;<span class="op" id="3134250">&lt;-</span><span class="ident" id="3134252">respHeaderTimer</span><span class="op" id="3134267">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3134272">pc</span><span class="op" id="3134274">.</span><span class="builtinfunc" id="3134275">close</span><span class="op" id="3134280">(</span><span class="op" id="3134281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3134286">re</span>&nbsp;<span class="op" id="3134289">=</span>&nbsp;<span class="ident" id="3134291">responseAndError</span><span class="op" id="3134307">{</span><span class="ident" id="3134308">err</span><span class="op" id="3134311">:</span>&nbsp;<span class="ident" id="3134313">errTimeout</span><span class="op" id="3134323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3134328">break</span>&nbsp;<span class="ident" id="3134334">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3134349">case</span>&nbsp;<span class="ident" id="3134354">re</span>&nbsp;<span class="op" id="3134357">=</span>&nbsp;<span class="op" id="3134359">&lt;-</span><span class="ident" id="3134361">resc</span><span class="op" id="3134365">:</span><br>
<span class="lineno">1115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3134370">break</span>&nbsp;<span class="ident" id="3134376">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3134391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3134394">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3134398">pc</span><span class="op" id="3134400">.</span><span class="ident" id="3134401">lk</span><span class="op" id="3134403">.</span><span class="ident" id="3134404">Lock</span><span class="op" id="3134408">(</span><span class="op" id="3134409">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3134412">pc</span><span class="op" id="3134414">.</span><span class="ident" id="3134415">numExpectedResponses</span><span class="op" id="3134435">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3134439">pc</span><span class="op" id="3134441">.</span><span class="ident" id="3134442">lk</span><span class="op" id="3134444">.</span><span class="ident" id="3134445">Unlock</span><span class="op" id="3134451">(</span><span class="op" id="3134452">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3134456">if</span>&nbsp;<span class="ident" id="3134459">re</span><span class="op" id="3134461">.</span><span class="ident" id="3134462">err</span>&nbsp;<span class="op" id="3134466">!=</span>&nbsp;<span class="builtintype" id="3134469">nil</span>&nbsp;<span class="op" id="3134473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3134477">pc</span><span class="op" id="3134479">.</span><span class="ident" id="3134480">t</span><span class="op" id="3134481">.</span><span class="ident" id="3134482">setReqCanceler</span><span class="op" id="3134496">(</span><span class="ident" id="3134497">req</span><span class="op" id="3134500">.</span><span class="ident" id="3134501">Request</span><span class="op" id="3134508">,</span>&nbsp;<span class="builtintype" id="3134510">nil</span><span class="op" id="3134513">)</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3134516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3134519">return</span>&nbsp;<span class="ident" id="3134526">re</span><span class="op" id="3134528">.</span><span class="ident" id="3134529">res</span><span class="op" id="3134532">,</span>&nbsp;<span class="ident" id="3134534">re</span><span class="op" id="3134536">.</span><span class="ident" id="3134537">err</span><br>
<span class="lineno"></span><span class="op" id="3134541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3134544">//&nbsp;markBroken&nbsp;marks&nbsp;a&nbsp;connection&nbsp;as&nbsp;broken&nbsp;(so&nbsp;it&#39;s&nbsp;not&nbsp;reused).</span><br>
<span class="lineno">1130</span><span class="comment" id="3134609">//&nbsp;It&nbsp;differs&nbsp;from&nbsp;close&nbsp;in&nbsp;that&nbsp;it&nbsp;doesn&#39;t&nbsp;close&nbsp;the&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="3134674">//&nbsp;connection&nbsp;for&nbsp;use&nbsp;when&nbsp;it&#39;s&nbsp;still&nbsp;being&nbsp;read.</span><br>
<span class="lineno"></span><span class="keyword" id="3134724">func</span>&nbsp;<span class="op" id="3134729">(</span><span class="ident" id="3134730">pc</span>&nbsp;<span class="op" id="3134733">*</span><span class="ident" id="3134734">persistConn</span><span class="op" id="3134745">)</span>&nbsp;<span class="ident" id="3134747">markBroken</span><span class="op" id="3134757">(</span><span class="op" id="3134758">)</span>&nbsp;<span class="op" id="3134760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3134763">pc</span><span class="op" id="3134765">.</span><span class="ident" id="3134766">lk</span><span class="op" id="3134768">.</span><span class="ident" id="3134769">Lock</span><span class="op" id="3134773">(</span><span class="op" id="3134774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3134777">defer</span>&nbsp;<span class="ident" id="3134783">pc</span><span class="op" id="3134785">.</span><span class="ident" id="3134786">lk</span><span class="op" id="3134788">.</span><span class="ident" id="3134789">Unlock</span><span class="op" id="3134795">(</span><span class="op" id="3134796">)</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3134799">pc</span><span class="op" id="3134801">.</span><span class="ident" id="3134802">broken</span>&nbsp;<span class="op" id="3134809">=</span>&nbsp;<span class="builtintype" id="3134811">true</span><br>
<span class="lineno"></span><span class="op" id="3134816">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3134819">func</span>&nbsp;<span class="op" id="3134824">(</span><span class="ident" id="3134825">pc</span>&nbsp;<span class="op" id="3134828">*</span><span class="ident" id="3134829">persistConn</span><span class="op" id="3134840">)</span>&nbsp;<span class="builtinfunc" id="3134842">close</span><span class="op" id="3134847">(</span><span class="op" id="3134848">)</span>&nbsp;<span class="op" id="3134850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3134853">pc</span><span class="op" id="3134855">.</span><span class="ident" id="3134856">lk</span><span class="op" id="3134858">.</span><span class="ident" id="3134859">Lock</span><span class="op" id="3134863">(</span><span class="op" id="3134864">)</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3134867">defer</span>&nbsp;<span class="ident" id="3134873">pc</span><span class="op" id="3134875">.</span><span class="ident" id="3134876">lk</span><span class="op" id="3134878">.</span><span class="ident" id="3134879">Unlock</span><span class="op" id="3134885">(</span><span class="op" id="3134886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3134889">pc</span><span class="op" id="3134891">.</span><span class="ident" id="3134892">closeLocked</span><span class="op" id="3134903">(</span><span class="op" id="3134904">)</span><br>
<span class="lineno"></span><span class="op" id="3134906">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3134909">func</span>&nbsp;<span class="op" id="3134914">(</span><span class="ident" id="3134915">pc</span>&nbsp;<span class="op" id="3134918">*</span><span class="ident" id="3134919">persistConn</span><span class="op" id="3134930">)</span>&nbsp;<span class="ident" id="3134932">closeLocked</span><span class="op" id="3134943">(</span><span class="op" id="3134944">)</span>&nbsp;<span class="op" id="3134946">{</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3134949">pc</span><span class="op" id="3134951">.</span><span class="ident" id="3134952">broken</span>&nbsp;<span class="op" id="3134959">=</span>&nbsp;<span class="builtintype" id="3134961">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3134967">if</span>&nbsp;<span class="op" id="3134970">!</span><span class="ident" id="3134971">pc</span><span class="op" id="3134973">.</span><span class="ident" id="3134974">closed</span>&nbsp;<span class="op" id="3134981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3134985">pc</span><span class="op" id="3134987">.</span><span class="ident" id="3134988">conn</span><span class="op" id="3134992">.</span><span class="ident" id="3134993">Close</span><span class="op" id="3134998">(</span><span class="op" id="3134999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3135003">pc</span><span class="op" id="3135005">.</span><span class="ident" id="3135006">closed</span>&nbsp;<span class="op" id="3135013">=</span>&nbsp;<span class="builtintype" id="3135015">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3135022">close</span><span class="op" id="3135027">(</span><span class="ident" id="3135028">pc</span><span class="op" id="3135030">.</span><span class="ident" id="3135031">closech</span><span class="op" id="3135038">)</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3135041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3135044">pc</span><span class="op" id="3135046">.</span><span class="ident" id="3135047">mutateHeaderFunc</span>&nbsp;<span class="op" id="3135064">=</span>&nbsp;<span class="builtintype" id="3135066">nil</span><br>
<span class="lineno"></span><span class="op" id="3135070">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3135073">var</span>&nbsp;<span class="ident" id="3135077">portMap</span>&nbsp;<span class="op" id="3135085">=</span>&nbsp;<span class="keyword" id="3135087">map</span><span class="op" id="3135090">[</span><span class="builtintype" id="3135091">string</span><span class="op" id="3135097">]</span><span class="builtintype" id="3135098">string</span><span class="op" id="3135104">{</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3135107">&#34;http&#34;</span><span class="op" id="3135113">:</span>&nbsp;&nbsp;<span class="string" id="3135116">&#34;80&#34;</span><span class="op" id="3135120">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3135123">&#34;https&#34;</span><span class="op" id="3135130">:</span>&nbsp;<span class="string" id="3135132">&#34;443&#34;</span><span class="op" id="3135137">,</span><br>
<span class="lineno"></span><span class="op" id="3135139">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3135142">//&nbsp;canonicalAddr&nbsp;returns&nbsp;url.Host&nbsp;but&nbsp;always&nbsp;with&nbsp;a&nbsp;&#34;:port&#34;&nbsp;suffix</span><br>
<span class="lineno">1160</span><span class="keyword" id="3135209">func</span>&nbsp;<span class="ident" id="3135214">canonicalAddr</span><span class="op" id="3135227">(</span><span class="ident" id="3135228">url</span>&nbsp;<span class="op" id="3135232">*</span><span class="ident" id="3135233">url</span><span class="op" id="3135236">.</span><span class="ident" id="3135237">URL</span><span class="op" id="3135240">)</span>&nbsp;<span class="builtintype" id="3135242">string</span>&nbsp;<span class="op" id="3135249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3135252">addr</span>&nbsp;<span class="op" id="3135257">:=</span>&nbsp;<span class="ident" id="3135260">url</span><span class="op" id="3135263">.</span><span class="ident" id="3135264">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3135270">if</span>&nbsp;<span class="op" id="3135273">!</span><span class="ident" id="3135274">hasPort</span><span class="op" id="3135281">(</span><span class="ident" id="3135282">addr</span><span class="op" id="3135286">)</span>&nbsp;<span class="op" id="3135288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3135292">return</span>&nbsp;<span class="ident" id="3135299">addr</span>&nbsp;<span class="op" id="3135304">+</span>&nbsp;<span class="string" id="3135306">&#34;:&#34;</span>&nbsp;<span class="op" id="3135310">+</span>&nbsp;<span class="ident" id="3135312">portMap</span><span class="op" id="3135319">[</span><span class="ident" id="3135320">url</span><span class="op" id="3135323">.</span><span class="ident" id="3135324">Scheme</span><span class="op" id="3135330">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3135333">}</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3135336">return</span>&nbsp;<span class="ident" id="3135343">addr</span><br>
<span class="lineno"></span><span class="op" id="3135348">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3135351">//&nbsp;bodyEOFSignal&nbsp;wraps&nbsp;a&nbsp;ReadCloser&nbsp;but&nbsp;runs&nbsp;fn&nbsp;(if&nbsp;non-nil)&nbsp;at&nbsp;most</span><br>
<span class="lineno"></span><span class="comment" id="3135420">//&nbsp;once,&nbsp;right&nbsp;before&nbsp;its&nbsp;final&nbsp;(error-producing)&nbsp;Read&nbsp;or&nbsp;Close&nbsp;call</span><br>
<span class="lineno">1170</span><span class="comment" id="3135489">//&nbsp;returns.&nbsp;If&nbsp;earlyCloseFn&nbsp;is&nbsp;non-nil&nbsp;and&nbsp;Close&nbsp;is&nbsp;called&nbsp;before</span><br>
<span class="lineno"></span><span class="comment" id="3135555">//&nbsp;io.EOF&nbsp;is&nbsp;seen,&nbsp;earlyCloseFn&nbsp;is&nbsp;called&nbsp;instead&nbsp;of&nbsp;fn,&nbsp;and&nbsp;its</span><br>
<span class="lineno"></span><span class="comment" id="3135620">//&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;return&nbsp;value&nbsp;from&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="3135668">type</span>&nbsp;<span class="ident" id="3135673">bodyEOFSignal</span>&nbsp;<span class="keyword" id="3135687">struct</span>&nbsp;<span class="op" id="3135694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3135697">body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3135710">io</span><span class="op" id="3135712">.</span><span class="ident" id="3135713">ReadCloser</span><br>
<span class="lineno">1175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3135725">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3135738">sync</span><span class="op" id="3135742">.</span><span class="ident" id="3135743">Mutex</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3135751">//&nbsp;guards&nbsp;following&nbsp;4&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3135781">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3135794">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3135807">//&nbsp;whether&nbsp;Close&nbsp;has&nbsp;been&nbsp;called</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3135841">rerr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3135854">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3135867">//&nbsp;sticky&nbsp;Read&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3135889">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3135902">func</span><span class="op" id="3135906">(</span><span class="builtintype" id="3135907">error</span><span class="op" id="3135912">)</span>&nbsp;&nbsp;<span class="comment" id="3135915">//&nbsp;error&nbsp;will&nbsp;be&nbsp;nil&nbsp;on&nbsp;Read&nbsp;io.EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3135952">earlyCloseFn</span>&nbsp;<span class="keyword" id="3135965">func</span><span class="op" id="3135969">(</span><span class="op" id="3135970">)</span>&nbsp;<span class="builtintype" id="3135972">error</span>&nbsp;<span class="comment" id="3135978">//&nbsp;optional&nbsp;alt&nbsp;Close&nbsp;func&nbsp;used&nbsp;if&nbsp;io.EOF&nbsp;not&nbsp;seen</span><br>
<span class="lineno">1180</span><span class="op" id="3136029">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3136032">func</span>&nbsp;<span class="op" id="3136037">(</span><span class="ident" id="3136038">es</span>&nbsp;<span class="op" id="3136041">*</span><span class="ident" id="3136042">bodyEOFSignal</span><span class="op" id="3136055">)</span>&nbsp;<span class="ident" id="3136057">Read</span><span class="op" id="3136061">(</span><span class="ident" id="3136062">p</span>&nbsp;<span class="op" id="3136064">[</span><span class="op" id="3136065">]</span><span class="builtintype" id="3136066">byte</span><span class="op" id="3136070">)</span>&nbsp;<span class="op" id="3136072">(</span><span class="ident" id="3136073">n</span>&nbsp;<span class="builtintype" id="3136075">int</span><span class="op" id="3136078">,</span>&nbsp;<span class="ident" id="3136080">err</span>&nbsp;<span class="builtintype" id="3136084">error</span><span class="op" id="3136089">)</span>&nbsp;<span class="op" id="3136091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3136094">es</span><span class="op" id="3136096">.</span><span class="ident" id="3136097">mu</span><span class="op" id="3136099">.</span><span class="ident" id="3136100">Lock</span><span class="op" id="3136104">(</span><span class="op" id="3136105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3136108">closed</span><span class="op" id="3136114">,</span>&nbsp;<span class="ident" id="3136116">rerr</span>&nbsp;<span class="op" id="3136121">:=</span>&nbsp;<span class="ident" id="3136124">es</span><span class="op" id="3136126">.</span><span class="ident" id="3136127">closed</span><span class="op" id="3136133">,</span>&nbsp;<span class="ident" id="3136135">es</span><span class="op" id="3136137">.</span><span class="ident" id="3136138">rerr</span><br>
<span class="lineno">1185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3136144">es</span><span class="op" id="3136146">.</span><span class="ident" id="3136147">mu</span><span class="op" id="3136149">.</span><span class="ident" id="3136150">Unlock</span><span class="op" id="3136156">(</span><span class="op" id="3136157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3136160">if</span>&nbsp;<span class="ident" id="3136163">closed</span>&nbsp;<span class="op" id="3136170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3136174">return</span>&nbsp;<span class="num" id="3136181">0</span><span class="op" id="3136182">,</span>&nbsp;<span class="ident" id="3136184">errors</span><span class="op" id="3136190">.</span><span class="ident" id="3136191">New</span><span class="op" id="3136194">(</span><span class="string" id="3136195">&#34;http:&nbsp;read&nbsp;on&nbsp;closed&nbsp;response&nbsp;body&#34;</span><span class="op" id="3136231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3136234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3136237">if</span>&nbsp;<span class="ident" id="3136240">rerr</span>&nbsp;<span class="op" id="3136245">!=</span>&nbsp;<span class="builtintype" id="3136248">nil</span>&nbsp;<span class="op" id="3136252">{</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3136256">return</span>&nbsp;<span class="num" id="3136263">0</span><span class="op" id="3136264">,</span>&nbsp;<span class="ident" id="3136266">rerr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3136272">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3136276">n</span><span class="op" id="3136277">,</span>&nbsp;<span class="ident" id="3136279">err</span>&nbsp;<span class="op" id="3136283">=</span>&nbsp;<span class="ident" id="3136285">es</span><span class="op" id="3136287">.</span><span class="ident" id="3136288">body</span><span class="op" id="3136292">.</span><span class="ident" id="3136293">Read</span><span class="op" id="3136297">(</span><span class="ident" id="3136298">p</span><span class="op" id="3136299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3136302">if</span>&nbsp;<span class="ident" id="3136305">err</span>&nbsp;<span class="op" id="3136309">!=</span>&nbsp;<span class="builtintype" id="3136312">nil</span>&nbsp;<span class="op" id="3136316">{</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3136320">es</span><span class="op" id="3136322">.</span><span class="ident" id="3136323">mu</span><span class="op" id="3136325">.</span><span class="ident" id="3136326">Lock</span><span class="op" id="3136330">(</span><span class="op" id="3136331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3136335">defer</span>&nbsp;<span class="ident" id="3136341">es</span><span class="op" id="3136343">.</span><span class="ident" id="3136344">mu</span><span class="op" id="3136346">.</span><span class="ident" id="3136347">Unlock</span><span class="op" id="3136353">(</span><span class="op" id="3136354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3136358">if</span>&nbsp;<span class="ident" id="3136361">es</span><span class="op" id="3136363">.</span><span class="ident" id="3136364">rerr</span>&nbsp;<span class="op" id="3136369">==</span>&nbsp;<span class="builtintype" id="3136372">nil</span>&nbsp;<span class="op" id="3136376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3136381">es</span><span class="op" id="3136383">.</span><span class="ident" id="3136384">rerr</span>&nbsp;<span class="op" id="3136389">=</span>&nbsp;<span class="ident" id="3136391">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3136397">}</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3136401">es</span><span class="op" id="3136403">.</span><span class="ident" id="3136404">condfn</span><span class="op" id="3136410">(</span><span class="ident" id="3136411">err</span><span class="op" id="3136414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3136417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3136420">return</span><br>
<span class="lineno"></span><span class="op" id="3136427">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1205</span><span class="keyword" id="3136430">func</span>&nbsp;<span class="op" id="3136435">(</span><span class="ident" id="3136436">es</span>&nbsp;<span class="op" id="3136439">*</span><span class="ident" id="3136440">bodyEOFSignal</span><span class="op" id="3136453">)</span>&nbsp;<span class="ident" id="3136455">Close</span><span class="op" id="3136460">(</span><span class="op" id="3136461">)</span>&nbsp;<span class="builtintype" id="3136463">error</span>&nbsp;<span class="op" id="3136469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3136472">es</span><span class="op" id="3136474">.</span><span class="ident" id="3136475">mu</span><span class="op" id="3136477">.</span><span class="ident" id="3136478">Lock</span><span class="op" id="3136482">(</span><span class="op" id="3136483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3136486">defer</span>&nbsp;<span class="ident" id="3136492">es</span><span class="op" id="3136494">.</span><span class="ident" id="3136495">mu</span><span class="op" id="3136497">.</span><span class="ident" id="3136498">Unlock</span><span class="op" id="3136504">(</span><span class="op" id="3136505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3136508">if</span>&nbsp;<span class="ident" id="3136511">es</span><span class="op" id="3136513">.</span><span class="ident" id="3136514">closed</span>&nbsp;<span class="op" id="3136521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3136525">return</span>&nbsp;<span class="builtintype" id="3136532">nil</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3136537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3136540">es</span><span class="op" id="3136542">.</span><span class="ident" id="3136543">closed</span>&nbsp;<span class="op" id="3136550">=</span>&nbsp;<span class="builtintype" id="3136552">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3136558">if</span>&nbsp;<span class="ident" id="3136561">es</span><span class="op" id="3136563">.</span><span class="ident" id="3136564">earlyCloseFn</span>&nbsp;<span class="op" id="3136577">!=</span>&nbsp;<span class="builtintype" id="3136580">nil</span>&nbsp;<span class="op" id="3136584">&amp;&amp;</span>&nbsp;<span class="ident" id="3136587">es</span><span class="op" id="3136589">.</span><span class="ident" id="3136590">rerr</span>&nbsp;<span class="op" id="3136595">!=</span>&nbsp;<span class="ident" id="3136598">io</span><span class="op" id="3136600">.</span><span class="ident" id="3136601">EOF</span>&nbsp;<span class="op" id="3136605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3136609">return</span>&nbsp;<span class="ident" id="3136616">es</span><span class="op" id="3136618">.</span><span class="ident" id="3136619">earlyCloseFn</span><span class="op" id="3136631">(</span><span class="op" id="3136632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3136635">}</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3136638">err</span>&nbsp;<span class="op" id="3136642">:=</span>&nbsp;<span class="ident" id="3136645">es</span><span class="op" id="3136647">.</span><span class="ident" id="3136648">body</span><span class="op" id="3136652">.</span><span class="ident" id="3136653">Close</span><span class="op" id="3136658">(</span><span class="op" id="3136659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3136662">es</span><span class="op" id="3136664">.</span><span class="ident" id="3136665">condfn</span><span class="op" id="3136671">(</span><span class="ident" id="3136672">err</span><span class="op" id="3136675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3136678">return</span>&nbsp;<span class="ident" id="3136685">err</span><br>
<span class="lineno"></span><span class="op" id="3136689">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1220</span><span class="comment" id="3136692">//&nbsp;caller&nbsp;must&nbsp;hold&nbsp;es.mu.</span><br>
<span class="lineno"></span><span class="keyword" id="3136719">func</span>&nbsp;<span class="op" id="3136724">(</span><span class="ident" id="3136725">es</span>&nbsp;<span class="op" id="3136728">*</span><span class="ident" id="3136729">bodyEOFSignal</span><span class="op" id="3136742">)</span>&nbsp;<span class="ident" id="3136744">condfn</span><span class="op" id="3136750">(</span><span class="ident" id="3136751">err</span>&nbsp;<span class="builtintype" id="3136755">error</span><span class="op" id="3136760">)</span>&nbsp;<span class="op" id="3136762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3136765">if</span>&nbsp;<span class="ident" id="3136768">es</span><span class="op" id="3136770">.</span><span class="ident" id="3136771">fn</span>&nbsp;<span class="op" id="3136774">==</span>&nbsp;<span class="builtintype" id="3136777">nil</span>&nbsp;<span class="op" id="3136781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3136785">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3136793">}</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3136796">if</span>&nbsp;<span class="ident" id="3136799">err</span>&nbsp;<span class="op" id="3136803">==</span>&nbsp;<span class="ident" id="3136806">io</span><span class="op" id="3136808">.</span><span class="ident" id="3136809">EOF</span>&nbsp;<span class="op" id="3136813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3136817">err</span>&nbsp;<span class="op" id="3136821">=</span>&nbsp;<span class="builtintype" id="3136823">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3136828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3136831">es</span><span class="op" id="3136833">.</span><span class="ident" id="3136834">fn</span><span class="op" id="3136836">(</span><span class="ident" id="3136837">err</span><span class="op" id="3136840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3136843">es</span><span class="op" id="3136845">.</span><span class="ident" id="3136846">fn</span>&nbsp;<span class="op" id="3136849">=</span>&nbsp;<span class="builtintype" id="3136851">nil</span><br>
<span class="lineno">1230</span><span class="op" id="3136855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3136858">//&nbsp;gzipReader&nbsp;wraps&nbsp;a&nbsp;response&nbsp;body&nbsp;so&nbsp;it&nbsp;can&nbsp;lazily</span><br>
<span class="lineno"></span><span class="comment" id="3136911">//&nbsp;call&nbsp;gzip.NewReader&nbsp;on&nbsp;the&nbsp;first&nbsp;call&nbsp;to&nbsp;Read</span><br>
<span class="lineno"></span><span class="keyword" id="3136960">type</span>&nbsp;<span class="ident" id="3136965">gzipReader</span>&nbsp;<span class="keyword" id="3136976">struct</span>&nbsp;<span class="op" id="3136983">{</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3136986">body</span>&nbsp;<span class="ident" id="3136991">io</span><span class="op" id="3136993">.</span><span class="ident" id="3136994">ReadCloser</span>&nbsp;<span class="comment" id="3137005">//&nbsp;underlying&nbsp;Response.Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3137034">zr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3137039">io</span><span class="op" id="3137041">.</span><span class="ident" id="3137042">Reader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3137053">//&nbsp;lazily-initialized&nbsp;gzip&nbsp;reader</span><br>
<span class="lineno"></span><span class="op" id="3137087">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3137090">func</span>&nbsp;<span class="op" id="3137095">(</span><span class="ident" id="3137096">gz</span>&nbsp;<span class="op" id="3137099">*</span><span class="ident" id="3137100">gzipReader</span><span class="op" id="3137110">)</span>&nbsp;<span class="ident" id="3137112">Read</span><span class="op" id="3137116">(</span><span class="ident" id="3137117">p</span>&nbsp;<span class="op" id="3137119">[</span><span class="op" id="3137120">]</span><span class="builtintype" id="3137121">byte</span><span class="op" id="3137125">)</span>&nbsp;<span class="op" id="3137127">(</span><span class="ident" id="3137128">n</span>&nbsp;<span class="builtintype" id="3137130">int</span><span class="op" id="3137133">,</span>&nbsp;<span class="ident" id="3137135">err</span>&nbsp;<span class="builtintype" id="3137139">error</span><span class="op" id="3137144">)</span>&nbsp;<span class="op" id="3137146">{</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3137149">if</span>&nbsp;<span class="ident" id="3137152">gz</span><span class="op" id="3137154">.</span><span class="ident" id="3137155">zr</span>&nbsp;<span class="op" id="3137158">==</span>&nbsp;<span class="builtintype" id="3137161">nil</span>&nbsp;<span class="op" id="3137165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3137169">gz</span><span class="op" id="3137171">.</span><span class="ident" id="3137172">zr</span><span class="op" id="3137174">,</span>&nbsp;<span class="ident" id="3137176">err</span>&nbsp;<span class="op" id="3137180">=</span>&nbsp;<span class="ident" id="3137182">gzip</span><span class="op" id="3137186">.</span><span class="ident" id="3137187">NewReader</span><span class="op" id="3137196">(</span><span class="ident" id="3137197">gz</span><span class="op" id="3137199">.</span><span class="ident" id="3137200">body</span><span class="op" id="3137204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3137208">if</span>&nbsp;<span class="ident" id="3137211">err</span>&nbsp;<span class="op" id="3137215">!=</span>&nbsp;<span class="builtintype" id="3137218">nil</span>&nbsp;<span class="op" id="3137222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3137227">return</span>&nbsp;<span class="num" id="3137234">0</span><span class="op" id="3137235">,</span>&nbsp;<span class="ident" id="3137237">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3137243">}</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3137246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3137249">return</span>&nbsp;<span class="ident" id="3137256">gz</span><span class="op" id="3137258">.</span><span class="ident" id="3137259">zr</span><span class="op" id="3137261">.</span><span class="ident" id="3137262">Read</span><span class="op" id="3137266">(</span><span class="ident" id="3137267">p</span><span class="op" id="3137268">)</span><br>
<span class="lineno"></span><span class="op" id="3137270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3137273">func</span>&nbsp;<span class="op" id="3137278">(</span><span class="ident" id="3137279">gz</span>&nbsp;<span class="op" id="3137282">*</span><span class="ident" id="3137283">gzipReader</span><span class="op" id="3137293">)</span>&nbsp;<span class="ident" id="3137295">Close</span><span class="op" id="3137300">(</span><span class="op" id="3137301">)</span>&nbsp;<span class="builtintype" id="3137303">error</span>&nbsp;<span class="op" id="3137309">{</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3137312">return</span>&nbsp;<span class="ident" id="3137319">gz</span><span class="op" id="3137321">.</span><span class="ident" id="3137322">body</span><span class="op" id="3137326">.</span><span class="ident" id="3137327">Close</span><span class="op" id="3137332">(</span><span class="op" id="3137333">)</span><br>
<span class="lineno"></span><span class="op" id="3137335">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3137338">type</span>&nbsp;<span class="ident" id="3137343">readerAndCloser</span>&nbsp;<span class="keyword" id="3137359">struct</span>&nbsp;<span class="op" id="3137366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3137369">io</span><span class="op" id="3137371">.</span><span class="ident" id="3137372">Reader</span><br>
<span class="lineno">1255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3137380">io</span><span class="op" id="3137382">.</span><span class="ident" id="3137383">Closer</span><br>
<span class="lineno"></span><span class="op" id="3137390">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3137393">type</span>&nbsp;<span class="ident" id="3137398">tlsHandshakeTimeoutError</span>&nbsp;<span class="keyword" id="3137423">struct</span><span class="op" id="3137429">{</span><span class="op" id="3137430">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1260</span><span class="keyword" id="3137433">func</span>&nbsp;<span class="op" id="3137438">(</span><span class="ident" id="3137439">tlsHandshakeTimeoutError</span><span class="op" id="3137463">)</span>&nbsp;<span class="ident" id="3137465">Timeout</span><span class="op" id="3137472">(</span><span class="op" id="3137473">)</span>&nbsp;<span class="builtintype" id="3137475">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3137482">{</span>&nbsp;<span class="keyword" id="3137484">return</span>&nbsp;<span class="builtintype" id="3137491">true</span>&nbsp;<span class="op" id="3137496">}</span><br>
<span class="lineno"></span><span class="keyword" id="3137498">func</span>&nbsp;<span class="op" id="3137503">(</span><span class="ident" id="3137504">tlsHandshakeTimeoutError</span><span class="op" id="3137528">)</span>&nbsp;<span class="ident" id="3137530">Temporary</span><span class="op" id="3137539">(</span><span class="op" id="3137540">)</span>&nbsp;<span class="builtintype" id="3137542">bool</span>&nbsp;<span class="op" id="3137547">{</span>&nbsp;<span class="keyword" id="3137549">return</span>&nbsp;<span class="builtintype" id="3137556">true</span>&nbsp;<span class="op" id="3137561">}</span><br>
<span class="lineno"></span><span class="keyword" id="3137563">func</span>&nbsp;<span class="op" id="3137568">(</span><span class="ident" id="3137569">tlsHandshakeTimeoutError</span><span class="op" id="3137593">)</span>&nbsp;<span class="ident" id="3137595">Error</span><span class="op" id="3137600">(</span><span class="op" id="3137601">)</span>&nbsp;<span class="builtintype" id="3137603">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3137612">{</span>&nbsp;<span class="keyword" id="3137614">return</span>&nbsp;<span class="string" id="3137621">&#34;net/http:&nbsp;TLS&nbsp;handshake&nbsp;timeout&#34;</span>&nbsp;<span class="op" id="3137655">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3137658">type</span>&nbsp;<span class="ident" id="3137663">noteEOFReader</span>&nbsp;<span class="keyword" id="3137677">struct</span>&nbsp;<span class="op" id="3137684">{</span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3137687">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3137694">io</span><span class="op" id="3137696">.</span><span class="ident" id="3137697">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3137705">sawEOF</span>&nbsp;<span class="op" id="3137712">*</span><span class="builtintype" id="3137713">bool</span><br>
<span class="lineno"></span><span class="op" id="3137718">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3137721">func</span>&nbsp;<span class="op" id="3137726">(</span><span class="ident" id="3137727">nr</span>&nbsp;<span class="ident" id="3137730">noteEOFReader</span><span class="op" id="3137743">)</span>&nbsp;<span class="ident" id="3137745">Read</span><span class="op" id="3137749">(</span><span class="ident" id="3137750">p</span>&nbsp;<span class="op" id="3137752">[</span><span class="op" id="3137753">]</span><span class="builtintype" id="3137754">byte</span><span class="op" id="3137758">)</span>&nbsp;<span class="op" id="3137760">(</span><span class="ident" id="3137761">n</span>&nbsp;<span class="builtintype" id="3137763">int</span><span class="op" id="3137766">,</span>&nbsp;<span class="ident" id="3137768">err</span>&nbsp;<span class="builtintype" id="3137772">error</span><span class="op" id="3137777">)</span>&nbsp;<span class="op" id="3137779">{</span><br>
<span class="lineno">1270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3137782">n</span><span class="op" id="3137783">,</span>&nbsp;<span class="ident" id="3137785">err</span>&nbsp;<span class="op" id="3137789">=</span>&nbsp;<span class="ident" id="3137791">nr</span><span class="op" id="3137793">.</span><span class="ident" id="3137794">r</span><span class="op" id="3137795">.</span><span class="ident" id="3137796">Read</span><span class="op" id="3137800">(</span><span class="ident" id="3137801">p</span><span class="op" id="3137802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3137805">if</span>&nbsp;<span class="ident" id="3137808">err</span>&nbsp;<span class="op" id="3137812">==</span>&nbsp;<span class="ident" id="3137815">io</span><span class="op" id="3137817">.</span><span class="ident" id="3137818">EOF</span>&nbsp;<span class="op" id="3137822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3137826">*</span><span class="ident" id="3137827">nr</span><span class="op" id="3137829">.</span><span class="ident" id="3137830">sawEOF</span>&nbsp;<span class="op" id="3137837">=</span>&nbsp;<span class="builtintype" id="3137839">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3137845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3137848">return</span><br>
<span class="lineno">1275</span><span class="op" id="3137855">}</span>
</div>
</body>
</html>
