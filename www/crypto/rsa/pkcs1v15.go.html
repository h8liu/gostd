<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="4170295">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4170350">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4170404">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4170455">package</span>&nbsp;<span class="ident" id="4170463">rsa</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4170468">import</span>&nbsp;<span class="op" id="4170475">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4170478">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4170488">&#34;crypto/subtle&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4170505">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4170515">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4170521">&#34;math/big&#34;</span><br>
<span class="lineno"></span><span class="op" id="4170532">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="4170535">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;encryption&nbsp;and&nbsp;decryption&nbsp;using&nbsp;PKCS#1&nbsp;v1.5&nbsp;padding.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4170613">//&nbsp;EncryptPKCS1v15&nbsp;encrypts&nbsp;the&nbsp;given&nbsp;message&nbsp;with&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="4170709">//&nbsp;The&nbsp;message&nbsp;must&nbsp;be&nbsp;no&nbsp;longer&nbsp;than&nbsp;the&nbsp;length&nbsp;of&nbsp;the&nbsp;public&nbsp;modulus&nbsp;minus&nbsp;11&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="4170796">//&nbsp;WARNING:&nbsp;use&nbsp;of&nbsp;this&nbsp;function&nbsp;to&nbsp;encrypt&nbsp;plaintexts&nbsp;other&nbsp;than&nbsp;session&nbsp;keys</span><br>
<span class="lineno">20</span><span class="comment" id="4170875">//&nbsp;is&nbsp;dangerous.&nbsp;Use&nbsp;RSA&nbsp;OAEP&nbsp;in&nbsp;new&nbsp;protocols.</span><br>
<span class="lineno"></span><span class="keyword" id="4170923">func</span>&nbsp;<span class="ident" id="4170928">EncryptPKCS1v15</span><span class="op" id="4170943">(</span><span class="ident" id="4170944">rand</span>&nbsp;<span class="ident" id="4170949">io</span><span class="op" id="4170951">.</span><span class="ident" id="4170952">Reader</span><span class="op" id="4170958">,</span>&nbsp;<span class="ident" id="4170960">pub</span>&nbsp;<span class="op" id="4170964">*</span><span class="ident" id="4170965">PublicKey</span><span class="op" id="4170974">,</span>&nbsp;<span class="ident" id="4170976">msg</span>&nbsp;<span class="op" id="4170980">[</span><span class="op" id="4170981">]</span><span class="builtintype" id="4170982">byte</span><span class="op" id="4170986">)</span>&nbsp;<span class="op" id="4170988">(</span><span class="ident" id="4170989">out</span>&nbsp;<span class="op" id="4170993">[</span><span class="op" id="4170994">]</span><span class="builtintype" id="4170995">byte</span><span class="op" id="4170999">,</span>&nbsp;<span class="ident" id="4171001">err</span>&nbsp;<span class="builtintype" id="4171005">error</span><span class="op" id="4171010">)</span>&nbsp;<span class="op" id="4171012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171015">if</span>&nbsp;<span class="ident" id="4171018">err</span>&nbsp;<span class="op" id="4171022">:=</span>&nbsp;<span class="ident" id="4171025">checkPub</span><span class="op" id="4171033">(</span><span class="ident" id="4171034">pub</span><span class="op" id="4171037">)</span><span class="op" id="4171038">;</span>&nbsp;<span class="ident" id="4171040">err</span>&nbsp;<span class="op" id="4171044">!=</span>&nbsp;<span class="ident" id="4171047">nil</span>&nbsp;<span class="op" id="4171051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171055">return</span>&nbsp;<span class="ident" id="4171062">nil</span><span class="op" id="4171065">,</span>&nbsp;<span class="ident" id="4171067">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4171072">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4171075">k</span>&nbsp;<span class="op" id="4171077">:=</span>&nbsp;<span class="op" id="4171080">(</span><span class="ident" id="4171081">pub</span><span class="op" id="4171084">.</span><span class="ident" id="4171085">N</span><span class="op" id="4171086">.</span><span class="ident" id="4171087">BitLen</span><span class="op" id="4171093">(</span><span class="op" id="4171094">)</span>&nbsp;<span class="op" id="4171096">+</span>&nbsp;<span class="num" id="4171098">7</span><span class="op" id="4171099">)</span>&nbsp;<span class="op" id="4171101">/</span>&nbsp;<span class="num" id="4171103">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171106">if</span>&nbsp;<span class="builtinfunc" id="4171109">len</span><span class="op" id="4171112">(</span><span class="ident" id="4171113">msg</span><span class="op" id="4171116">)</span>&nbsp;<span class="op" id="4171118">&gt;</span>&nbsp;<span class="ident" id="4171120">k</span><span class="op" id="4171121">-</span><span class="num" id="4171122">11</span>&nbsp;<span class="op" id="4171125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4171129">err</span>&nbsp;<span class="op" id="4171133">=</span>&nbsp;<span class="ident" id="4171135">ErrMessageTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171155">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4171163">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4171167">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x02&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;M</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4171208">em</span>&nbsp;<span class="op" id="4171211">:=</span>&nbsp;<span class="builtinfunc" id="4171214">make</span><span class="op" id="4171218">(</span><span class="op" id="4171219">[</span><span class="op" id="4171220">]</span><span class="builtintype" id="4171221">byte</span><span class="op" id="4171225">,</span>&nbsp;<span class="ident" id="4171227">k</span><span class="op" id="4171228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4171231">em</span><span class="op" id="4171233">[</span><span class="num" id="4171234">1</span><span class="op" id="4171235">]</span>&nbsp;<span class="op" id="4171237">=</span>&nbsp;<span class="num" id="4171239">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4171242">ps</span><span class="op" id="4171244">,</span>&nbsp;<span class="ident" id="4171246">mm</span>&nbsp;<span class="op" id="4171249">:=</span>&nbsp;<span class="ident" id="4171252">em</span><span class="op" id="4171254">[</span><span class="num" id="4171255">2</span><span class="op" id="4171256">:</span><span class="builtinfunc" id="4171257">len</span><span class="op" id="4171260">(</span><span class="ident" id="4171261">em</span><span class="op" id="4171263">)</span><span class="op" id="4171264">-</span><span class="builtinfunc" id="4171265">len</span><span class="op" id="4171268">(</span><span class="ident" id="4171269">msg</span><span class="op" id="4171272">)</span><span class="op" id="4171273">-</span><span class="num" id="4171274">1</span><span class="op" id="4171275">]</span><span class="op" id="4171276">,</span>&nbsp;<span class="ident" id="4171278">em</span><span class="op" id="4171280">[</span><span class="builtinfunc" id="4171281">len</span><span class="op" id="4171284">(</span><span class="ident" id="4171285">em</span><span class="op" id="4171287">)</span><span class="op" id="4171288">-</span><span class="builtinfunc" id="4171289">len</span><span class="op" id="4171292">(</span><span class="ident" id="4171293">msg</span><span class="op" id="4171296">)</span><span class="op" id="4171297">:</span><span class="op" id="4171298">]</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4171301">err</span>&nbsp;<span class="op" id="4171305">=</span>&nbsp;<span class="ident" id="4171307">nonZeroRandomBytes</span><span class="op" id="4171325">(</span><span class="ident" id="4171326">ps</span><span class="op" id="4171328">,</span>&nbsp;<span class="ident" id="4171330">rand</span><span class="op" id="4171334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171337">if</span>&nbsp;<span class="ident" id="4171340">err</span>&nbsp;<span class="op" id="4171344">!=</span>&nbsp;<span class="ident" id="4171347">nil</span>&nbsp;<span class="op" id="4171351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171355">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4171363">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4171366">em</span><span class="op" id="4171368">[</span><span class="builtinfunc" id="4171369">len</span><span class="op" id="4171372">(</span><span class="ident" id="4171373">em</span><span class="op" id="4171375">)</span><span class="op" id="4171376">-</span><span class="builtinfunc" id="4171377">len</span><span class="op" id="4171380">(</span><span class="ident" id="4171381">msg</span><span class="op" id="4171384">)</span><span class="op" id="4171385">-</span><span class="num" id="4171386">1</span><span class="op" id="4171387">]</span>&nbsp;<span class="op" id="4171389">=</span>&nbsp;<span class="num" id="4171391">0</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4171394">copy</span><span class="op" id="4171398">(</span><span class="ident" id="4171399">mm</span><span class="op" id="4171401">,</span>&nbsp;<span class="ident" id="4171403">msg</span><span class="op" id="4171406">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4171410">m</span>&nbsp;<span class="op" id="4171412">:=</span>&nbsp;<span class="builtinfunc" id="4171415">new</span><span class="op" id="4171418">(</span><span class="ident" id="4171419">big</span><span class="op" id="4171422">.</span><span class="ident" id="4171423">Int</span><span class="op" id="4171426">)</span><span class="op" id="4171427">.</span><span class="ident" id="4171428">SetBytes</span><span class="op" id="4171436">(</span><span class="ident" id="4171437">em</span><span class="op" id="4171439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4171442">c</span>&nbsp;<span class="op" id="4171444">:=</span>&nbsp;<span class="ident" id="4171447">encrypt</span><span class="op" id="4171454">(</span><span class="builtinfunc" id="4171455">new</span><span class="op" id="4171458">(</span><span class="ident" id="4171459">big</span><span class="op" id="4171462">.</span><span class="ident" id="4171463">Int</span><span class="op" id="4171466">)</span><span class="op" id="4171467">,</span>&nbsp;<span class="ident" id="4171469">pub</span><span class="op" id="4171472">,</span>&nbsp;<span class="ident" id="4171474">m</span><span class="op" id="4171475">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4171479">copyWithLeftPad</span><span class="op" id="4171494">(</span><span class="ident" id="4171495">em</span><span class="op" id="4171497">,</span>&nbsp;<span class="ident" id="4171499">c</span><span class="op" id="4171500">.</span><span class="ident" id="4171501">Bytes</span><span class="op" id="4171506">(</span><span class="op" id="4171507">)</span><span class="op" id="4171508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4171511">out</span>&nbsp;<span class="op" id="4171515">=</span>&nbsp;<span class="ident" id="4171517">em</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171521">return</span><br>
<span class="lineno"></span><span class="op" id="4171528">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="4171531">//&nbsp;DecryptPKCS1v15&nbsp;decrypts&nbsp;a&nbsp;plaintext&nbsp;using&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="4171622">//&nbsp;If&nbsp;rand&nbsp;!=&nbsp;nil,&nbsp;it&nbsp;uses&nbsp;RSA&nbsp;blinding&nbsp;to&nbsp;avoid&nbsp;timing&nbsp;side-channel&nbsp;attacks.</span><br>
<span class="lineno"></span><span class="keyword" id="4171700">func</span>&nbsp;<span class="ident" id="4171705">DecryptPKCS1v15</span><span class="op" id="4171720">(</span><span class="ident" id="4171721">rand</span>&nbsp;<span class="ident" id="4171726">io</span><span class="op" id="4171728">.</span><span class="ident" id="4171729">Reader</span><span class="op" id="4171735">,</span>&nbsp;<span class="ident" id="4171737">priv</span>&nbsp;<span class="op" id="4171742">*</span><span class="ident" id="4171743">PrivateKey</span><span class="op" id="4171753">,</span>&nbsp;<span class="ident" id="4171755">ciphertext</span>&nbsp;<span class="op" id="4171766">[</span><span class="op" id="4171767">]</span><span class="builtintype" id="4171768">byte</span><span class="op" id="4171772">)</span>&nbsp;<span class="op" id="4171774">(</span><span class="ident" id="4171775">out</span>&nbsp;<span class="op" id="4171779">[</span><span class="op" id="4171780">]</span><span class="builtintype" id="4171781">byte</span><span class="op" id="4171785">,</span>&nbsp;<span class="ident" id="4171787">err</span>&nbsp;<span class="builtintype" id="4171791">error</span><span class="op" id="4171796">)</span>&nbsp;<span class="op" id="4171798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171801">if</span>&nbsp;<span class="ident" id="4171804">err</span>&nbsp;<span class="op" id="4171808">:=</span>&nbsp;<span class="ident" id="4171811">checkPub</span><span class="op" id="4171819">(</span><span class="op" id="4171820">&amp;</span><span class="ident" id="4171821">priv</span><span class="op" id="4171825">.</span><span class="ident" id="4171826">PublicKey</span><span class="op" id="4171835">)</span><span class="op" id="4171836">;</span>&nbsp;<span class="ident" id="4171838">err</span>&nbsp;<span class="op" id="4171842">!=</span>&nbsp;<span class="ident" id="4171845">nil</span>&nbsp;<span class="op" id="4171849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171853">return</span>&nbsp;<span class="ident" id="4171860">nil</span><span class="op" id="4171863">,</span>&nbsp;<span class="ident" id="4171865">err</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4171870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4171873">valid</span><span class="op" id="4171878">,</span>&nbsp;<span class="ident" id="4171880">out</span><span class="op" id="4171883">,</span>&nbsp;<span class="ident" id="4171885">index</span><span class="op" id="4171890">,</span>&nbsp;<span class="ident" id="4171892">err</span>&nbsp;<span class="op" id="4171896">:=</span>&nbsp;<span class="ident" id="4171899">decryptPKCS1v15</span><span class="op" id="4171914">(</span><span class="ident" id="4171915">rand</span><span class="op" id="4171919">,</span>&nbsp;<span class="ident" id="4171921">priv</span><span class="op" id="4171925">,</span>&nbsp;<span class="ident" id="4171927">ciphertext</span><span class="op" id="4171937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171940">if</span>&nbsp;<span class="ident" id="4171943">err</span>&nbsp;<span class="op" id="4171947">!=</span>&nbsp;<span class="ident" id="4171950">nil</span>&nbsp;<span class="op" id="4171954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171958">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4171966">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171969">if</span>&nbsp;<span class="ident" id="4171972">valid</span>&nbsp;<span class="op" id="4171978">==</span>&nbsp;<span class="num" id="4171981">0</span>&nbsp;<span class="op" id="4171983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171987">return</span>&nbsp;<span class="ident" id="4171994">nil</span><span class="op" id="4171997">,</span>&nbsp;<span class="ident" id="4171999">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4172014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4172017">out</span>&nbsp;<span class="op" id="4172021">=</span>&nbsp;<span class="ident" id="4172023">out</span><span class="op" id="4172026">[</span><span class="ident" id="4172027">index</span><span class="op" id="4172032">:</span><span class="op" id="4172033">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4172036">return</span><br>
<span class="lineno">65</span><span class="op" id="4172043">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4172046">//&nbsp;DecryptPKCS1v15SessionKey&nbsp;decrypts&nbsp;a&nbsp;session&nbsp;key&nbsp;using&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="4172149">//&nbsp;If&nbsp;rand&nbsp;!=&nbsp;nil,&nbsp;it&nbsp;uses&nbsp;RSA&nbsp;blinding&nbsp;to&nbsp;avoid&nbsp;timing&nbsp;side-channel&nbsp;attacks.</span><br>
<span class="lineno"></span><span class="comment" id="4172227">//&nbsp;It&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;ciphertext&nbsp;is&nbsp;the&nbsp;wrong&nbsp;length&nbsp;or&nbsp;if&nbsp;the</span><br>
<span class="lineno">70</span><span class="comment" id="4172298">//&nbsp;ciphertext&nbsp;is&nbsp;greater&nbsp;than&nbsp;the&nbsp;public&nbsp;modulus.&nbsp;Otherwise,&nbsp;no&nbsp;error&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4172371">//&nbsp;returned.&nbsp;If&nbsp;the&nbsp;padding&nbsp;is&nbsp;valid,&nbsp;the&nbsp;resulting&nbsp;plaintext&nbsp;message&nbsp;is&nbsp;copied</span><br>
<span class="lineno"></span><span class="comment" id="4172451">//&nbsp;into&nbsp;key.&nbsp;Otherwise,&nbsp;key&nbsp;is&nbsp;unchanged.&nbsp;These&nbsp;alternatives&nbsp;occur&nbsp;in&nbsp;constant</span><br>
<span class="lineno"></span><span class="comment" id="4172530">//&nbsp;time.&nbsp;It&nbsp;is&nbsp;intended&nbsp;that&nbsp;the&nbsp;user&nbsp;of&nbsp;this&nbsp;function&nbsp;generate&nbsp;a&nbsp;random</span><br>
<span class="lineno"></span><span class="comment" id="4172603">//&nbsp;session&nbsp;key&nbsp;beforehand&nbsp;and&nbsp;continue&nbsp;the&nbsp;protocol&nbsp;with&nbsp;the&nbsp;resulting&nbsp;value.</span><br>
<span class="lineno">75</span><span class="comment" id="4172681">//&nbsp;This&nbsp;will&nbsp;remove&nbsp;any&nbsp;possibility&nbsp;that&nbsp;an&nbsp;attacker&nbsp;can&nbsp;learn&nbsp;any&nbsp;information</span><br>
<span class="lineno"></span><span class="comment" id="4172760">//&nbsp;about&nbsp;the&nbsp;plaintext.</span><br>
<span class="lineno"></span><span class="comment" id="4172784">//&nbsp;See&nbsp;``Chosen&nbsp;Ciphertext&nbsp;Attacks&nbsp;Against&nbsp;Protocols&nbsp;Based&nbsp;on&nbsp;the&nbsp;RSA</span><br>
<span class="lineno"></span><span class="comment" id="4172854">//&nbsp;Encryption&nbsp;Standard&nbsp;PKCS&nbsp;#1&#39;&#39;,&nbsp;Daniel&nbsp;Bleichenbacher,&nbsp;Advances&nbsp;in&nbsp;Cryptology</span><br>
<span class="lineno"></span><span class="comment" id="4172934">//&nbsp;(Crypto&nbsp;&#39;98).</span><br>
<span class="lineno">80</span><span class="keyword" id="4172951">func</span>&nbsp;<span class="ident" id="4172956">DecryptPKCS1v15SessionKey</span><span class="op" id="4172981">(</span><span class="ident" id="4172982">rand</span>&nbsp;<span class="ident" id="4172987">io</span><span class="op" id="4172989">.</span><span class="ident" id="4172990">Reader</span><span class="op" id="4172996">,</span>&nbsp;<span class="ident" id="4172998">priv</span>&nbsp;<span class="op" id="4173003">*</span><span class="ident" id="4173004">PrivateKey</span><span class="op" id="4173014">,</span>&nbsp;<span class="ident" id="4173016">ciphertext</span>&nbsp;<span class="op" id="4173027">[</span><span class="op" id="4173028">]</span><span class="builtintype" id="4173029">byte</span><span class="op" id="4173033">,</span>&nbsp;<span class="ident" id="4173035">key</span>&nbsp;<span class="op" id="4173039">[</span><span class="op" id="4173040">]</span><span class="builtintype" id="4173041">byte</span><span class="op" id="4173045">)</span>&nbsp;<span class="op" id="4173047">(</span><span class="ident" id="4173048">err</span>&nbsp;<span class="builtintype" id="4173052">error</span><span class="op" id="4173057">)</span>&nbsp;<span class="op" id="4173059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173062">if</span>&nbsp;<span class="ident" id="4173065">err</span>&nbsp;<span class="op" id="4173069">:=</span>&nbsp;<span class="ident" id="4173072">checkPub</span><span class="op" id="4173080">(</span><span class="op" id="4173081">&amp;</span><span class="ident" id="4173082">priv</span><span class="op" id="4173086">.</span><span class="ident" id="4173087">PublicKey</span><span class="op" id="4173096">)</span><span class="op" id="4173097">;</span>&nbsp;<span class="ident" id="4173099">err</span>&nbsp;<span class="op" id="4173103">!=</span>&nbsp;<span class="ident" id="4173106">nil</span>&nbsp;<span class="op" id="4173110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173114">return</span>&nbsp;<span class="ident" id="4173121">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4173126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4173129">k</span>&nbsp;<span class="op" id="4173131">:=</span>&nbsp;<span class="op" id="4173134">(</span><span class="ident" id="4173135">priv</span><span class="op" id="4173139">.</span><span class="ident" id="4173140">N</span><span class="op" id="4173141">.</span><span class="ident" id="4173142">BitLen</span><span class="op" id="4173148">(</span><span class="op" id="4173149">)</span>&nbsp;<span class="op" id="4173151">+</span>&nbsp;<span class="num" id="4173153">7</span><span class="op" id="4173154">)</span>&nbsp;<span class="op" id="4173156">/</span>&nbsp;<span class="num" id="4173158">8</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173161">if</span>&nbsp;<span class="ident" id="4173164">k</span><span class="op" id="4173165">-</span><span class="op" id="4173166">(</span><span class="builtinfunc" id="4173167">len</span><span class="op" id="4173170">(</span><span class="ident" id="4173171">key</span><span class="op" id="4173174">)</span><span class="op" id="4173175">+</span><span class="num" id="4173176">3</span><span class="op" id="4173177">+</span><span class="num" id="4173178">8</span><span class="op" id="4173179">)</span>&nbsp;<span class="op" id="4173181">&lt;</span>&nbsp;<span class="num" id="4173183">0</span>&nbsp;<span class="op" id="4173185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173189">return</span>&nbsp;<span class="ident" id="4173196">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4173211">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4173215">valid</span><span class="op" id="4173220">,</span>&nbsp;<span class="ident" id="4173222">em</span><span class="op" id="4173224">,</span>&nbsp;<span class="ident" id="4173226">index</span><span class="op" id="4173231">,</span>&nbsp;<span class="ident" id="4173233">err</span>&nbsp;<span class="op" id="4173237">:=</span>&nbsp;<span class="ident" id="4173240">decryptPKCS1v15</span><span class="op" id="4173255">(</span><span class="ident" id="4173256">rand</span><span class="op" id="4173260">,</span>&nbsp;<span class="ident" id="4173262">priv</span><span class="op" id="4173266">,</span>&nbsp;<span class="ident" id="4173268">ciphertext</span><span class="op" id="4173278">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173281">if</span>&nbsp;<span class="ident" id="4173284">err</span>&nbsp;<span class="op" id="4173288">!=</span>&nbsp;<span class="ident" id="4173291">nil</span>&nbsp;<span class="op" id="4173295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173299">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4173307">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173311">if</span>&nbsp;<span class="builtinfunc" id="4173314">len</span><span class="op" id="4173317">(</span><span class="ident" id="4173318">em</span><span class="op" id="4173320">)</span>&nbsp;<span class="op" id="4173322">!=</span>&nbsp;<span class="ident" id="4173325">k</span>&nbsp;<span class="op" id="4173327">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4173331">//&nbsp;This&nbsp;should&nbsp;be&nbsp;impossible&nbsp;because&nbsp;decryptPKCS1v15&nbsp;always</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4173393">//&nbsp;returns&nbsp;the&nbsp;full&nbsp;slice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173422">return</span>&nbsp;<span class="ident" id="4173429">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4173444">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4173448">valid</span>&nbsp;<span class="op" id="4173454">&amp;=</span>&nbsp;<span class="ident" id="4173457">subtle</span><span class="op" id="4173463">.</span><span class="ident" id="4173464">ConstantTimeEq</span><span class="op" id="4173478">(</span><span class="builtintype" id="4173479">int32</span><span class="op" id="4173484">(</span><span class="builtinfunc" id="4173485">len</span><span class="op" id="4173488">(</span><span class="ident" id="4173489">em</span><span class="op" id="4173491">)</span><span class="op" id="4173492">-</span><span class="ident" id="4173493">index</span><span class="op" id="4173498">)</span><span class="op" id="4173499">,</span>&nbsp;<span class="builtintype" id="4173501">int32</span><span class="op" id="4173506">(</span><span class="builtinfunc" id="4173507">len</span><span class="op" id="4173510">(</span><span class="ident" id="4173511">key</span><span class="op" id="4173514">)</span><span class="op" id="4173515">)</span><span class="op" id="4173516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4173519">subtle</span><span class="op" id="4173525">.</span><span class="ident" id="4173526">ConstantTimeCopy</span><span class="op" id="4173542">(</span><span class="ident" id="4173543">valid</span><span class="op" id="4173548">,</span>&nbsp;<span class="ident" id="4173550">key</span><span class="op" id="4173553">,</span>&nbsp;<span class="ident" id="4173555">em</span><span class="op" id="4173557">[</span><span class="builtinfunc" id="4173558">len</span><span class="op" id="4173561">(</span><span class="ident" id="4173562">em</span><span class="op" id="4173564">)</span><span class="op" id="4173565">-</span><span class="builtinfunc" id="4173566">len</span><span class="op" id="4173569">(</span><span class="ident" id="4173570">key</span><span class="op" id="4173573">)</span><span class="op" id="4173574">:</span><span class="op" id="4173575">]</span><span class="op" id="4173576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173579">return</span><br>
<span class="lineno"></span><span class="op" id="4173586">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="4173589">//&nbsp;decryptPKCS1v15&nbsp;decrypts&nbsp;ciphertext&nbsp;using&nbsp;priv&nbsp;and&nbsp;blinds&nbsp;the&nbsp;operation&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="4173667">//&nbsp;rand&nbsp;is&nbsp;not&nbsp;nil.&nbsp;It&nbsp;returns&nbsp;one&nbsp;or&nbsp;zero&nbsp;in&nbsp;valid&nbsp;that&nbsp;indicates&nbsp;whether&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4173746">//&nbsp;plaintext&nbsp;was&nbsp;correctly&nbsp;structured.&nbsp;In&nbsp;either&nbsp;case,&nbsp;the&nbsp;plaintext&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4173818">//&nbsp;returned&nbsp;in&nbsp;em&nbsp;so&nbsp;that&nbsp;it&nbsp;may&nbsp;be&nbsp;read&nbsp;independently&nbsp;of&nbsp;whether&nbsp;it&nbsp;was&nbsp;valid</span><br>
<span class="lineno"></span><span class="comment" id="4173897">//&nbsp;in&nbsp;order&nbsp;to&nbsp;maintain&nbsp;constant&nbsp;memory&nbsp;access&nbsp;patterns.&nbsp;If&nbsp;the&nbsp;plaintext&nbsp;was</span><br>
<span class="lineno">110</span><span class="comment" id="4173975">//&nbsp;valid&nbsp;then&nbsp;index&nbsp;contains&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;original&nbsp;message&nbsp;in&nbsp;em.</span><br>
<span class="lineno"></span><span class="keyword" id="4174045">func</span>&nbsp;<span class="ident" id="4174050">decryptPKCS1v15</span><span class="op" id="4174065">(</span><span class="ident" id="4174066">rand</span>&nbsp;<span class="ident" id="4174071">io</span><span class="op" id="4174073">.</span><span class="ident" id="4174074">Reader</span><span class="op" id="4174080">,</span>&nbsp;<span class="ident" id="4174082">priv</span>&nbsp;<span class="op" id="4174087">*</span><span class="ident" id="4174088">PrivateKey</span><span class="op" id="4174098">,</span>&nbsp;<span class="ident" id="4174100">ciphertext</span>&nbsp;<span class="op" id="4174111">[</span><span class="op" id="4174112">]</span><span class="builtintype" id="4174113">byte</span><span class="op" id="4174117">)</span>&nbsp;<span class="op" id="4174119">(</span><span class="ident" id="4174120">valid</span>&nbsp;<span class="builtintype" id="4174126">int</span><span class="op" id="4174129">,</span>&nbsp;<span class="ident" id="4174131">em</span>&nbsp;<span class="op" id="4174134">[</span><span class="op" id="4174135">]</span><span class="builtintype" id="4174136">byte</span><span class="op" id="4174140">,</span>&nbsp;<span class="ident" id="4174142">index</span>&nbsp;<span class="builtintype" id="4174148">int</span><span class="op" id="4174151">,</span>&nbsp;<span class="ident" id="4174153">err</span>&nbsp;<span class="builtintype" id="4174157">error</span><span class="op" id="4174162">)</span>&nbsp;<span class="op" id="4174164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174167">k</span>&nbsp;<span class="op" id="4174169">:=</span>&nbsp;<span class="op" id="4174172">(</span><span class="ident" id="4174173">priv</span><span class="op" id="4174177">.</span><span class="ident" id="4174178">N</span><span class="op" id="4174179">.</span><span class="ident" id="4174180">BitLen</span><span class="op" id="4174186">(</span><span class="op" id="4174187">)</span>&nbsp;<span class="op" id="4174189">+</span>&nbsp;<span class="num" id="4174191">7</span><span class="op" id="4174192">)</span>&nbsp;<span class="op" id="4174194">/</span>&nbsp;<span class="num" id="4174196">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174199">if</span>&nbsp;<span class="ident" id="4174202">k</span>&nbsp;<span class="op" id="4174204">&lt;</span>&nbsp;<span class="num" id="4174206">11</span>&nbsp;<span class="op" id="4174209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174213">err</span>&nbsp;<span class="op" id="4174217">=</span>&nbsp;<span class="ident" id="4174219">ErrDecryption</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174235">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4174243">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174247">c</span>&nbsp;<span class="op" id="4174249">:=</span>&nbsp;<span class="builtinfunc" id="4174252">new</span><span class="op" id="4174255">(</span><span class="ident" id="4174256">big</span><span class="op" id="4174259">.</span><span class="ident" id="4174260">Int</span><span class="op" id="4174263">)</span><span class="op" id="4174264">.</span><span class="ident" id="4174265">SetBytes</span><span class="op" id="4174273">(</span><span class="ident" id="4174274">ciphertext</span><span class="op" id="4174284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174287">m</span><span class="op" id="4174288">,</span>&nbsp;<span class="ident" id="4174290">err</span>&nbsp;<span class="op" id="4174294">:=</span>&nbsp;<span class="ident" id="4174297">decrypt</span><span class="op" id="4174304">(</span><span class="ident" id="4174305">rand</span><span class="op" id="4174309">,</span>&nbsp;<span class="ident" id="4174311">priv</span><span class="op" id="4174315">,</span>&nbsp;<span class="ident" id="4174317">c</span><span class="op" id="4174318">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174321">if</span>&nbsp;<span class="ident" id="4174324">err</span>&nbsp;<span class="op" id="4174328">!=</span>&nbsp;<span class="ident" id="4174331">nil</span>&nbsp;<span class="op" id="4174335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174339">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4174347">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174351">em</span>&nbsp;<span class="op" id="4174354">=</span>&nbsp;<span class="ident" id="4174356">leftPad</span><span class="op" id="4174363">(</span><span class="ident" id="4174364">m</span><span class="op" id="4174365">.</span><span class="ident" id="4174366">Bytes</span><span class="op" id="4174371">(</span><span class="op" id="4174372">)</span><span class="op" id="4174373">,</span>&nbsp;<span class="ident" id="4174375">k</span><span class="op" id="4174376">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174379">firstByteIsZero</span>&nbsp;<span class="op" id="4174395">:=</span>&nbsp;<span class="ident" id="4174398">subtle</span><span class="op" id="4174404">.</span><span class="ident" id="4174405">ConstantTimeByteEq</span><span class="op" id="4174423">(</span><span class="ident" id="4174424">em</span><span class="op" id="4174426">[</span><span class="num" id="4174427">0</span><span class="op" id="4174428">]</span><span class="op" id="4174429">,</span>&nbsp;<span class="num" id="4174431">0</span><span class="op" id="4174432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174435">secondByteIsTwo</span>&nbsp;<span class="op" id="4174451">:=</span>&nbsp;<span class="ident" id="4174454">subtle</span><span class="op" id="4174460">.</span><span class="ident" id="4174461">ConstantTimeByteEq</span><span class="op" id="4174479">(</span><span class="ident" id="4174480">em</span><span class="op" id="4174482">[</span><span class="num" id="4174483">1</span><span class="op" id="4174484">]</span><span class="op" id="4174485">,</span>&nbsp;<span class="num" id="4174487">2</span><span class="op" id="4174488">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4174492">//&nbsp;The&nbsp;remainder&nbsp;of&nbsp;the&nbsp;plaintext&nbsp;must&nbsp;be&nbsp;a&nbsp;string&nbsp;of&nbsp;non-zero&nbsp;random</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4174563">//&nbsp;octets,&nbsp;followed&nbsp;by&nbsp;a&nbsp;0,&nbsp;followed&nbsp;by&nbsp;the&nbsp;message.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4174617">//&nbsp;&nbsp;&nbsp;lookingForIndex:&nbsp;1&nbsp;iff&nbsp;we&nbsp;are&nbsp;still&nbsp;looking&nbsp;for&nbsp;the&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4174681">//&nbsp;&nbsp;&nbsp;index:&nbsp;the&nbsp;offset&nbsp;of&nbsp;the&nbsp;first&nbsp;zero&nbsp;byte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174729">lookingForIndex</span>&nbsp;<span class="op" id="4174745">:=</span>&nbsp;<span class="num" id="4174748">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174752">for</span>&nbsp;<span class="ident" id="4174756">i</span>&nbsp;<span class="op" id="4174758">:=</span>&nbsp;<span class="num" id="4174761">2</span><span class="op" id="4174762">;</span>&nbsp;<span class="ident" id="4174764">i</span>&nbsp;<span class="op" id="4174766">&lt;</span>&nbsp;<span class="builtinfunc" id="4174768">len</span><span class="op" id="4174771">(</span><span class="ident" id="4174772">em</span><span class="op" id="4174774">)</span><span class="op" id="4174775">;</span>&nbsp;<span class="ident" id="4174777">i</span><span class="op" id="4174778">++</span>&nbsp;<span class="op" id="4174781">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174785">equals0</span>&nbsp;<span class="op" id="4174793">:=</span>&nbsp;<span class="ident" id="4174796">subtle</span><span class="op" id="4174802">.</span><span class="ident" id="4174803">ConstantTimeByteEq</span><span class="op" id="4174821">(</span><span class="ident" id="4174822">em</span><span class="op" id="4174824">[</span><span class="ident" id="4174825">i</span><span class="op" id="4174826">]</span><span class="op" id="4174827">,</span>&nbsp;<span class="num" id="4174829">0</span><span class="op" id="4174830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174834">index</span>&nbsp;<span class="op" id="4174840">=</span>&nbsp;<span class="ident" id="4174842">subtle</span><span class="op" id="4174848">.</span><span class="ident" id="4174849">ConstantTimeSelect</span><span class="op" id="4174867">(</span><span class="ident" id="4174868">lookingForIndex</span><span class="op" id="4174883">&amp;</span><span class="ident" id="4174884">equals0</span><span class="op" id="4174891">,</span>&nbsp;<span class="ident" id="4174893">i</span><span class="op" id="4174894">,</span>&nbsp;<span class="ident" id="4174896">index</span><span class="op" id="4174901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174905">lookingForIndex</span>&nbsp;<span class="op" id="4174921">=</span>&nbsp;<span class="ident" id="4174923">subtle</span><span class="op" id="4174929">.</span><span class="ident" id="4174930">ConstantTimeSelect</span><span class="op" id="4174948">(</span><span class="ident" id="4174949">equals0</span><span class="op" id="4174956">,</span>&nbsp;<span class="num" id="4174958">0</span><span class="op" id="4174959">,</span>&nbsp;<span class="ident" id="4174961">lookingForIndex</span><span class="op" id="4174976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4174979">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4174983">//&nbsp;The&nbsp;PS&nbsp;padding&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;8&nbsp;bytes&nbsp;long,&nbsp;and&nbsp;it&nbsp;starts&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4175051">//&nbsp;bytes&nbsp;into&nbsp;em.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4175070">validPS</span>&nbsp;<span class="op" id="4175078">:=</span>&nbsp;<span class="ident" id="4175081">subtle</span><span class="op" id="4175087">.</span><span class="ident" id="4175088">ConstantTimeLessOrEq</span><span class="op" id="4175108">(</span><span class="num" id="4175109">2</span><span class="op" id="4175110">+</span><span class="num" id="4175111">8</span><span class="op" id="4175112">,</span>&nbsp;<span class="ident" id="4175114">index</span><span class="op" id="4175119">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4175123">valid</span>&nbsp;<span class="op" id="4175129">=</span>&nbsp;<span class="ident" id="4175131">firstByteIsZero</span>&nbsp;<span class="op" id="4175147">&amp;</span>&nbsp;<span class="ident" id="4175149">secondByteIsTwo</span>&nbsp;<span class="op" id="4175165">&amp;</span>&nbsp;<span class="op" id="4175167">(</span><span class="op" id="4175168">^</span><span class="ident" id="4175169">lookingForIndex</span>&nbsp;<span class="op" id="4175185">&amp;</span>&nbsp;<span class="num" id="4175187">1</span><span class="op" id="4175188">)</span>&nbsp;<span class="op" id="4175190">&amp;</span>&nbsp;<span class="ident" id="4175192">validPS</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4175201">index</span>&nbsp;<span class="op" id="4175207">=</span>&nbsp;<span class="ident" id="4175209">subtle</span><span class="op" id="4175215">.</span><span class="ident" id="4175216">ConstantTimeSelect</span><span class="op" id="4175234">(</span><span class="ident" id="4175235">valid</span><span class="op" id="4175240">,</span>&nbsp;<span class="ident" id="4175242">index</span><span class="op" id="4175247">+</span><span class="num" id="4175248">1</span><span class="op" id="4175249">,</span>&nbsp;<span class="num" id="4175251">0</span><span class="op" id="4175252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175255">return</span>&nbsp;<span class="ident" id="4175262">valid</span><span class="op" id="4175267">,</span>&nbsp;<span class="ident" id="4175269">em</span><span class="op" id="4175271">,</span>&nbsp;<span class="ident" id="4175273">index</span><span class="op" id="4175278">,</span>&nbsp;<span class="ident" id="4175280">nil</span><br>
<span class="lineno"></span><span class="op" id="4175284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4175287">//&nbsp;nonZeroRandomBytes&nbsp;fills&nbsp;the&nbsp;given&nbsp;slice&nbsp;with&nbsp;non-zero&nbsp;random&nbsp;octets.</span><br>
<span class="lineno">150</span><span class="keyword" id="4175360">func</span>&nbsp;<span class="ident" id="4175365">nonZeroRandomBytes</span><span class="op" id="4175383">(</span><span class="ident" id="4175384">s</span>&nbsp;<span class="op" id="4175386">[</span><span class="op" id="4175387">]</span><span class="builtintype" id="4175388">byte</span><span class="op" id="4175392">,</span>&nbsp;<span class="ident" id="4175394">rand</span>&nbsp;<span class="ident" id="4175399">io</span><span class="op" id="4175401">.</span><span class="ident" id="4175402">Reader</span><span class="op" id="4175408">)</span>&nbsp;<span class="op" id="4175410">(</span><span class="ident" id="4175411">err</span>&nbsp;<span class="builtintype" id="4175415">error</span><span class="op" id="4175420">)</span>&nbsp;<span class="op" id="4175422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4175425">_</span><span class="op" id="4175426">,</span>&nbsp;<span class="ident" id="4175428">err</span>&nbsp;<span class="op" id="4175432">=</span>&nbsp;<span class="ident" id="4175434">io</span><span class="op" id="4175436">.</span><span class="ident" id="4175437">ReadFull</span><span class="op" id="4175445">(</span><span class="ident" id="4175446">rand</span><span class="op" id="4175450">,</span>&nbsp;<span class="ident" id="4175452">s</span><span class="op" id="4175453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175456">if</span>&nbsp;<span class="ident" id="4175459">err</span>&nbsp;<span class="op" id="4175463">!=</span>&nbsp;<span class="ident" id="4175466">nil</span>&nbsp;<span class="op" id="4175470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175474">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4175482">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175486">for</span>&nbsp;<span class="ident" id="4175490">i</span>&nbsp;<span class="op" id="4175492">:=</span>&nbsp;<span class="num" id="4175495">0</span><span class="op" id="4175496">;</span>&nbsp;<span class="ident" id="4175498">i</span>&nbsp;<span class="op" id="4175500">&lt;</span>&nbsp;<span class="builtinfunc" id="4175502">len</span><span class="op" id="4175505">(</span><span class="ident" id="4175506">s</span><span class="op" id="4175507">)</span><span class="op" id="4175508">;</span>&nbsp;<span class="ident" id="4175510">i</span><span class="op" id="4175511">++</span>&nbsp;<span class="op" id="4175514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175518">for</span>&nbsp;<span class="ident" id="4175522">s</span><span class="op" id="4175523">[</span><span class="ident" id="4175524">i</span><span class="op" id="4175525">]</span>&nbsp;<span class="op" id="4175527">==</span>&nbsp;<span class="num" id="4175530">0</span>&nbsp;<span class="op" id="4175532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4175537">_</span><span class="op" id="4175538">,</span>&nbsp;<span class="ident" id="4175540">err</span>&nbsp;<span class="op" id="4175544">=</span>&nbsp;<span class="ident" id="4175546">io</span><span class="op" id="4175548">.</span><span class="ident" id="4175549">ReadFull</span><span class="op" id="4175557">(</span><span class="ident" id="4175558">rand</span><span class="op" id="4175562">,</span>&nbsp;<span class="ident" id="4175564">s</span><span class="op" id="4175565">[</span><span class="ident" id="4175566">i</span><span class="op" id="4175567">:</span><span class="ident" id="4175568">i</span><span class="op" id="4175569">+</span><span class="num" id="4175570">1</span><span class="op" id="4175571">]</span><span class="op" id="4175572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175577">if</span>&nbsp;<span class="ident" id="4175580">err</span>&nbsp;<span class="op" id="4175584">!=</span>&nbsp;<span class="ident" id="4175587">nil</span>&nbsp;<span class="op" id="4175591">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175597">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4175607">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4175612">//&nbsp;In&nbsp;tests,&nbsp;the&nbsp;PRNG&nbsp;may&nbsp;return&nbsp;all&nbsp;zeros&nbsp;so&nbsp;we&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4175667">//&nbsp;this&nbsp;to&nbsp;break&nbsp;the&nbsp;loop.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4175697">s</span><span class="op" id="4175698">[</span><span class="ident" id="4175699">i</span><span class="op" id="4175700">]</span>&nbsp;<span class="op" id="4175702">^=</span>&nbsp;<span class="num" id="4175705">0x42</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4175712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4175715">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175719">return</span><br>
<span class="lineno"></span><span class="op" id="4175726">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="comment" id="4175729">//&nbsp;These&nbsp;are&nbsp;ASN1&nbsp;DER&nbsp;structures:</span><br>
<span class="lineno"></span><span class="comment" id="4175763">//&nbsp;&nbsp;&nbsp;DigestInfo&nbsp;::=&nbsp;SEQUENCE&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="4175794">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;digestAlgorithm&nbsp;AlgorithmIdentifier,</span><br>
<span class="lineno"></span><span class="comment" id="4175838">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;digest&nbsp;OCTET&nbsp;STRING</span><br>
<span class="lineno">175</span><span class="comment" id="4175865">//&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="4175872">//&nbsp;For&nbsp;performance,&nbsp;we&nbsp;don&#39;t&nbsp;use&nbsp;the&nbsp;generic&nbsp;ASN1&nbsp;encoder.&nbsp;Rather,&nbsp;we</span><br>
<span class="lineno"></span><span class="comment" id="4175942">//&nbsp;precompute&nbsp;a&nbsp;prefix&nbsp;of&nbsp;the&nbsp;digest&nbsp;value&nbsp;that&nbsp;makes&nbsp;a&nbsp;valid&nbsp;ASN1&nbsp;DER&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="4176020">//&nbsp;with&nbsp;the&nbsp;correct&nbsp;contents.</span><br>
<span class="lineno"></span><span class="keyword" id="4176050">var</span>&nbsp;<span class="ident" id="4176054">hashPrefixes</span>&nbsp;<span class="op" id="4176067">=</span>&nbsp;<span class="keyword" id="4176069">map</span><span class="op" id="4176072">[</span><span class="ident" id="4176073">crypto</span><span class="op" id="4176079">.</span><span class="ident" id="4176080">Hash</span><span class="op" id="4176084">]</span><span class="op" id="4176085">[</span><span class="op" id="4176086">]</span><span class="builtintype" id="4176087">byte</span><span class="op" id="4176091">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4176094">crypto</span><span class="op" id="4176100">.</span><span class="ident" id="4176101">MD5</span><span class="op" id="4176104">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4176112">{</span><span class="num" id="4176113">0x30</span><span class="op" id="4176117">,</span>&nbsp;<span class="num" id="4176119">0x20</span><span class="op" id="4176123">,</span>&nbsp;<span class="num" id="4176125">0x30</span><span class="op" id="4176129">,</span>&nbsp;<span class="num" id="4176131">0x0c</span><span class="op" id="4176135">,</span>&nbsp;<span class="num" id="4176137">0x06</span><span class="op" id="4176141">,</span>&nbsp;<span class="num" id="4176143">0x08</span><span class="op" id="4176147">,</span>&nbsp;<span class="num" id="4176149">0x2a</span><span class="op" id="4176153">,</span>&nbsp;<span class="num" id="4176155">0x86</span><span class="op" id="4176159">,</span>&nbsp;<span class="num" id="4176161">0x48</span><span class="op" id="4176165">,</span>&nbsp;<span class="num" id="4176167">0x86</span><span class="op" id="4176171">,</span>&nbsp;<span class="num" id="4176173">0xf7</span><span class="op" id="4176177">,</span>&nbsp;<span class="num" id="4176179">0x0d</span><span class="op" id="4176183">,</span>&nbsp;<span class="num" id="4176185">0x02</span><span class="op" id="4176189">,</span>&nbsp;<span class="num" id="4176191">0x05</span><span class="op" id="4176195">,</span>&nbsp;<span class="num" id="4176197">0x05</span><span class="op" id="4176201">,</span>&nbsp;<span class="num" id="4176203">0x00</span><span class="op" id="4176207">,</span>&nbsp;<span class="num" id="4176209">0x04</span><span class="op" id="4176213">,</span>&nbsp;<span class="num" id="4176215">0x10</span><span class="op" id="4176219">}</span><span class="op" id="4176220">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4176223">crypto</span><span class="op" id="4176229">.</span><span class="ident" id="4176230">SHA1</span><span class="op" id="4176234">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4176241">{</span><span class="num" id="4176242">0x30</span><span class="op" id="4176246">,</span>&nbsp;<span class="num" id="4176248">0x21</span><span class="op" id="4176252">,</span>&nbsp;<span class="num" id="4176254">0x30</span><span class="op" id="4176258">,</span>&nbsp;<span class="num" id="4176260">0x09</span><span class="op" id="4176264">,</span>&nbsp;<span class="num" id="4176266">0x06</span><span class="op" id="4176270">,</span>&nbsp;<span class="num" id="4176272">0x05</span><span class="op" id="4176276">,</span>&nbsp;<span class="num" id="4176278">0x2b</span><span class="op" id="4176282">,</span>&nbsp;<span class="num" id="4176284">0x0e</span><span class="op" id="4176288">,</span>&nbsp;<span class="num" id="4176290">0x03</span><span class="op" id="4176294">,</span>&nbsp;<span class="num" id="4176296">0x02</span><span class="op" id="4176300">,</span>&nbsp;<span class="num" id="4176302">0x1a</span><span class="op" id="4176306">,</span>&nbsp;<span class="num" id="4176308">0x05</span><span class="op" id="4176312">,</span>&nbsp;<span class="num" id="4176314">0x00</span><span class="op" id="4176318">,</span>&nbsp;<span class="num" id="4176320">0x04</span><span class="op" id="4176324">,</span>&nbsp;<span class="num" id="4176326">0x14</span><span class="op" id="4176330">}</span><span class="op" id="4176331">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4176334">crypto</span><span class="op" id="4176340">.</span><span class="ident" id="4176341">SHA224</span><span class="op" id="4176347">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4176352">{</span><span class="num" id="4176353">0x30</span><span class="op" id="4176357">,</span>&nbsp;<span class="num" id="4176359">0x2d</span><span class="op" id="4176363">,</span>&nbsp;<span class="num" id="4176365">0x30</span><span class="op" id="4176369">,</span>&nbsp;<span class="num" id="4176371">0x0d</span><span class="op" id="4176375">,</span>&nbsp;<span class="num" id="4176377">0x06</span><span class="op" id="4176381">,</span>&nbsp;<span class="num" id="4176383">0x09</span><span class="op" id="4176387">,</span>&nbsp;<span class="num" id="4176389">0x60</span><span class="op" id="4176393">,</span>&nbsp;<span class="num" id="4176395">0x86</span><span class="op" id="4176399">,</span>&nbsp;<span class="num" id="4176401">0x48</span><span class="op" id="4176405">,</span>&nbsp;<span class="num" id="4176407">0x01</span><span class="op" id="4176411">,</span>&nbsp;<span class="num" id="4176413">0x65</span><span class="op" id="4176417">,</span>&nbsp;<span class="num" id="4176419">0x03</span><span class="op" id="4176423">,</span>&nbsp;<span class="num" id="4176425">0x04</span><span class="op" id="4176429">,</span>&nbsp;<span class="num" id="4176431">0x02</span><span class="op" id="4176435">,</span>&nbsp;<span class="num" id="4176437">0x04</span><span class="op" id="4176441">,</span>&nbsp;<span class="num" id="4176443">0x05</span><span class="op" id="4176447">,</span>&nbsp;<span class="num" id="4176449">0x00</span><span class="op" id="4176453">,</span>&nbsp;<span class="num" id="4176455">0x04</span><span class="op" id="4176459">,</span>&nbsp;<span class="num" id="4176461">0x1c</span><span class="op" id="4176465">}</span><span class="op" id="4176466">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4176469">crypto</span><span class="op" id="4176475">.</span><span class="ident" id="4176476">SHA256</span><span class="op" id="4176482">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4176487">{</span><span class="num" id="4176488">0x30</span><span class="op" id="4176492">,</span>&nbsp;<span class="num" id="4176494">0x31</span><span class="op" id="4176498">,</span>&nbsp;<span class="num" id="4176500">0x30</span><span class="op" id="4176504">,</span>&nbsp;<span class="num" id="4176506">0x0d</span><span class="op" id="4176510">,</span>&nbsp;<span class="num" id="4176512">0x06</span><span class="op" id="4176516">,</span>&nbsp;<span class="num" id="4176518">0x09</span><span class="op" id="4176522">,</span>&nbsp;<span class="num" id="4176524">0x60</span><span class="op" id="4176528">,</span>&nbsp;<span class="num" id="4176530">0x86</span><span class="op" id="4176534">,</span>&nbsp;<span class="num" id="4176536">0x48</span><span class="op" id="4176540">,</span>&nbsp;<span class="num" id="4176542">0x01</span><span class="op" id="4176546">,</span>&nbsp;<span class="num" id="4176548">0x65</span><span class="op" id="4176552">,</span>&nbsp;<span class="num" id="4176554">0x03</span><span class="op" id="4176558">,</span>&nbsp;<span class="num" id="4176560">0x04</span><span class="op" id="4176564">,</span>&nbsp;<span class="num" id="4176566">0x02</span><span class="op" id="4176570">,</span>&nbsp;<span class="num" id="4176572">0x01</span><span class="op" id="4176576">,</span>&nbsp;<span class="num" id="4176578">0x05</span><span class="op" id="4176582">,</span>&nbsp;<span class="num" id="4176584">0x00</span><span class="op" id="4176588">,</span>&nbsp;<span class="num" id="4176590">0x04</span><span class="op" id="4176594">,</span>&nbsp;<span class="num" id="4176596">0x20</span><span class="op" id="4176600">}</span><span class="op" id="4176601">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4176604">crypto</span><span class="op" id="4176610">.</span><span class="ident" id="4176611">SHA384</span><span class="op" id="4176617">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4176622">{</span><span class="num" id="4176623">0x30</span><span class="op" id="4176627">,</span>&nbsp;<span class="num" id="4176629">0x41</span><span class="op" id="4176633">,</span>&nbsp;<span class="num" id="4176635">0x30</span><span class="op" id="4176639">,</span>&nbsp;<span class="num" id="4176641">0x0d</span><span class="op" id="4176645">,</span>&nbsp;<span class="num" id="4176647">0x06</span><span class="op" id="4176651">,</span>&nbsp;<span class="num" id="4176653">0x09</span><span class="op" id="4176657">,</span>&nbsp;<span class="num" id="4176659">0x60</span><span class="op" id="4176663">,</span>&nbsp;<span class="num" id="4176665">0x86</span><span class="op" id="4176669">,</span>&nbsp;<span class="num" id="4176671">0x48</span><span class="op" id="4176675">,</span>&nbsp;<span class="num" id="4176677">0x01</span><span class="op" id="4176681">,</span>&nbsp;<span class="num" id="4176683">0x65</span><span class="op" id="4176687">,</span>&nbsp;<span class="num" id="4176689">0x03</span><span class="op" id="4176693">,</span>&nbsp;<span class="num" id="4176695">0x04</span><span class="op" id="4176699">,</span>&nbsp;<span class="num" id="4176701">0x02</span><span class="op" id="4176705">,</span>&nbsp;<span class="num" id="4176707">0x02</span><span class="op" id="4176711">,</span>&nbsp;<span class="num" id="4176713">0x05</span><span class="op" id="4176717">,</span>&nbsp;<span class="num" id="4176719">0x00</span><span class="op" id="4176723">,</span>&nbsp;<span class="num" id="4176725">0x04</span><span class="op" id="4176729">,</span>&nbsp;<span class="num" id="4176731">0x30</span><span class="op" id="4176735">}</span><span class="op" id="4176736">,</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4176739">crypto</span><span class="op" id="4176745">.</span><span class="ident" id="4176746">SHA512</span><span class="op" id="4176752">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4176757">{</span><span class="num" id="4176758">0x30</span><span class="op" id="4176762">,</span>&nbsp;<span class="num" id="4176764">0x51</span><span class="op" id="4176768">,</span>&nbsp;<span class="num" id="4176770">0x30</span><span class="op" id="4176774">,</span>&nbsp;<span class="num" id="4176776">0x0d</span><span class="op" id="4176780">,</span>&nbsp;<span class="num" id="4176782">0x06</span><span class="op" id="4176786">,</span>&nbsp;<span class="num" id="4176788">0x09</span><span class="op" id="4176792">,</span>&nbsp;<span class="num" id="4176794">0x60</span><span class="op" id="4176798">,</span>&nbsp;<span class="num" id="4176800">0x86</span><span class="op" id="4176804">,</span>&nbsp;<span class="num" id="4176806">0x48</span><span class="op" id="4176810">,</span>&nbsp;<span class="num" id="4176812">0x01</span><span class="op" id="4176816">,</span>&nbsp;<span class="num" id="4176818">0x65</span><span class="op" id="4176822">,</span>&nbsp;<span class="num" id="4176824">0x03</span><span class="op" id="4176828">,</span>&nbsp;<span class="num" id="4176830">0x04</span><span class="op" id="4176834">,</span>&nbsp;<span class="num" id="4176836">0x02</span><span class="op" id="4176840">,</span>&nbsp;<span class="num" id="4176842">0x03</span><span class="op" id="4176846">,</span>&nbsp;<span class="num" id="4176848">0x05</span><span class="op" id="4176852">,</span>&nbsp;<span class="num" id="4176854">0x00</span><span class="op" id="4176858">,</span>&nbsp;<span class="num" id="4176860">0x04</span><span class="op" id="4176864">,</span>&nbsp;<span class="num" id="4176866">0x40</span><span class="op" id="4176870">}</span><span class="op" id="4176871">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4176874">crypto</span><span class="op" id="4176880">.</span><span class="ident" id="4176881">MD5SHA1</span><span class="op" id="4176888">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4176892">{</span><span class="op" id="4176893">}</span><span class="op" id="4176894">,</span>&nbsp;<span class="comment" id="4176896">//&nbsp;A&nbsp;special&nbsp;TLS&nbsp;case&nbsp;which&nbsp;doesn&#39;t&nbsp;use&nbsp;an&nbsp;ASN1&nbsp;prefix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4176953">crypto</span><span class="op" id="4176959">.</span><span class="ident" id="4176960">RIPEMD160</span><span class="op" id="4176969">:</span>&nbsp;<span class="op" id="4176971">{</span><span class="num" id="4176972">0x30</span><span class="op" id="4176976">,</span>&nbsp;<span class="num" id="4176978">0x20</span><span class="op" id="4176982">,</span>&nbsp;<span class="num" id="4176984">0x30</span><span class="op" id="4176988">,</span>&nbsp;<span class="num" id="4176990">0x08</span><span class="op" id="4176994">,</span>&nbsp;<span class="num" id="4176996">0x06</span><span class="op" id="4177000">,</span>&nbsp;<span class="num" id="4177002">0x06</span><span class="op" id="4177006">,</span>&nbsp;<span class="num" id="4177008">0x28</span><span class="op" id="4177012">,</span>&nbsp;<span class="num" id="4177014">0xcf</span><span class="op" id="4177018">,</span>&nbsp;<span class="num" id="4177020">0x06</span><span class="op" id="4177024">,</span>&nbsp;<span class="num" id="4177026">0x03</span><span class="op" id="4177030">,</span>&nbsp;<span class="num" id="4177032">0x00</span><span class="op" id="4177036">,</span>&nbsp;<span class="num" id="4177038">0x31</span><span class="op" id="4177042">,</span>&nbsp;<span class="num" id="4177044">0x04</span><span class="op" id="4177048">,</span>&nbsp;<span class="num" id="4177050">0x14</span><span class="op" id="4177054">}</span><span class="op" id="4177055">,</span><br>
<span class="lineno"></span><span class="op" id="4177057">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span><span class="comment" id="4177060">//&nbsp;SignPKCS1v15&nbsp;calculates&nbsp;the&nbsp;signature&nbsp;of&nbsp;hashed&nbsp;using&nbsp;RSASSA-PKCS1-V1_5-SIGN&nbsp;from&nbsp;RSA&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="4177162">//&nbsp;Note&nbsp;that&nbsp;hashed&nbsp;must&nbsp;be&nbsp;the&nbsp;result&nbsp;of&nbsp;hashing&nbsp;the&nbsp;input&nbsp;message&nbsp;using&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4177240">//&nbsp;given&nbsp;hash&nbsp;function.&nbsp;If&nbsp;hash&nbsp;is&nbsp;zero,&nbsp;hashed&nbsp;is&nbsp;signed&nbsp;directly.&nbsp;This&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="4177319">//&nbsp;advisable&nbsp;except&nbsp;for&nbsp;interoperability.</span><br>
<span class="lineno"></span><span class="keyword" id="4177361">func</span>&nbsp;<span class="ident" id="4177366">SignPKCS1v15</span><span class="op" id="4177378">(</span><span class="ident" id="4177379">rand</span>&nbsp;<span class="ident" id="4177384">io</span><span class="op" id="4177386">.</span><span class="ident" id="4177387">Reader</span><span class="op" id="4177393">,</span>&nbsp;<span class="ident" id="4177395">priv</span>&nbsp;<span class="op" id="4177400">*</span><span class="ident" id="4177401">PrivateKey</span><span class="op" id="4177411">,</span>&nbsp;<span class="ident" id="4177413">hash</span>&nbsp;<span class="ident" id="4177418">crypto</span><span class="op" id="4177424">.</span><span class="ident" id="4177425">Hash</span><span class="op" id="4177429">,</span>&nbsp;<span class="ident" id="4177431">hashed</span>&nbsp;<span class="op" id="4177438">[</span><span class="op" id="4177439">]</span><span class="builtintype" id="4177440">byte</span><span class="op" id="4177444">)</span>&nbsp;<span class="op" id="4177446">(</span><span class="ident" id="4177447">s</span>&nbsp;<span class="op" id="4177449">[</span><span class="op" id="4177450">]</span><span class="builtintype" id="4177451">byte</span><span class="op" id="4177455">,</span>&nbsp;<span class="ident" id="4177457">err</span>&nbsp;<span class="builtintype" id="4177461">error</span><span class="op" id="4177466">)</span>&nbsp;<span class="op" id="4177468">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4177471">hashLen</span><span class="op" id="4177478">,</span>&nbsp;<span class="ident" id="4177480">prefix</span><span class="op" id="4177486">,</span>&nbsp;<span class="ident" id="4177488">err</span>&nbsp;<span class="op" id="4177492">:=</span>&nbsp;<span class="ident" id="4177495">pkcs1v15HashInfo</span><span class="op" id="4177511">(</span><span class="ident" id="4177512">hash</span><span class="op" id="4177516">,</span>&nbsp;<span class="builtinfunc" id="4177518">len</span><span class="op" id="4177521">(</span><span class="ident" id="4177522">hashed</span><span class="op" id="4177528">)</span><span class="op" id="4177529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4177532">if</span>&nbsp;<span class="ident" id="4177535">err</span>&nbsp;<span class="op" id="4177539">!=</span>&nbsp;<span class="ident" id="4177542">nil</span>&nbsp;<span class="op" id="4177546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4177550">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4177558">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4177562">tLen</span>&nbsp;<span class="op" id="4177567">:=</span>&nbsp;<span class="builtinfunc" id="4177570">len</span><span class="op" id="4177573">(</span><span class="ident" id="4177574">prefix</span><span class="op" id="4177580">)</span>&nbsp;<span class="op" id="4177582">+</span>&nbsp;<span class="ident" id="4177584">hashLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4177593">k</span>&nbsp;<span class="op" id="4177595">:=</span>&nbsp;<span class="op" id="4177598">(</span><span class="ident" id="4177599">priv</span><span class="op" id="4177603">.</span><span class="ident" id="4177604">N</span><span class="op" id="4177605">.</span><span class="ident" id="4177606">BitLen</span><span class="op" id="4177612">(</span><span class="op" id="4177613">)</span>&nbsp;<span class="op" id="4177615">+</span>&nbsp;<span class="num" id="4177617">7</span><span class="op" id="4177618">)</span>&nbsp;<span class="op" id="4177620">/</span>&nbsp;<span class="num" id="4177622">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4177625">if</span>&nbsp;<span class="ident" id="4177628">k</span>&nbsp;<span class="op" id="4177630">&lt;</span>&nbsp;<span class="ident" id="4177632">tLen</span><span class="op" id="4177636">+</span><span class="num" id="4177637">11</span>&nbsp;<span class="op" id="4177640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4177644">return</span>&nbsp;<span class="ident" id="4177651">nil</span><span class="op" id="4177654">,</span>&nbsp;<span class="ident" id="4177656">ErrMessageTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4177675">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4177679">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x01&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;T</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4177720">em</span>&nbsp;<span class="op" id="4177723">:=</span>&nbsp;<span class="builtinfunc" id="4177726">make</span><span class="op" id="4177730">(</span><span class="op" id="4177731">[</span><span class="op" id="4177732">]</span><span class="builtintype" id="4177733">byte</span><span class="op" id="4177737">,</span>&nbsp;<span class="ident" id="4177739">k</span><span class="op" id="4177740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4177743">em</span><span class="op" id="4177745">[</span><span class="num" id="4177746">1</span><span class="op" id="4177747">]</span>&nbsp;<span class="op" id="4177749">=</span>&nbsp;<span class="num" id="4177751">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4177754">for</span>&nbsp;<span class="ident" id="4177758">i</span>&nbsp;<span class="op" id="4177760">:=</span>&nbsp;<span class="num" id="4177763">2</span><span class="op" id="4177764">;</span>&nbsp;<span class="ident" id="4177766">i</span>&nbsp;<span class="op" id="4177768">&lt;</span>&nbsp;<span class="ident" id="4177770">k</span><span class="op" id="4177771">-</span><span class="ident" id="4177772">tLen</span><span class="op" id="4177776">-</span><span class="num" id="4177777">1</span><span class="op" id="4177778">;</span>&nbsp;<span class="ident" id="4177780">i</span><span class="op" id="4177781">++</span>&nbsp;<span class="op" id="4177784">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4177788">em</span><span class="op" id="4177790">[</span><span class="ident" id="4177791">i</span><span class="op" id="4177792">]</span>&nbsp;<span class="op" id="4177794">=</span>&nbsp;<span class="num" id="4177796">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4177802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4177805">copy</span><span class="op" id="4177809">(</span><span class="ident" id="4177810">em</span><span class="op" id="4177812">[</span><span class="ident" id="4177813">k</span><span class="op" id="4177814">-</span><span class="ident" id="4177815">tLen</span><span class="op" id="4177819">:</span><span class="ident" id="4177820">k</span><span class="op" id="4177821">-</span><span class="ident" id="4177822">hashLen</span><span class="op" id="4177829">]</span><span class="op" id="4177830">,</span>&nbsp;<span class="ident" id="4177832">prefix</span><span class="op" id="4177838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4177841">copy</span><span class="op" id="4177845">(</span><span class="ident" id="4177846">em</span><span class="op" id="4177848">[</span><span class="ident" id="4177849">k</span><span class="op" id="4177850">-</span><span class="ident" id="4177851">hashLen</span><span class="op" id="4177858">:</span><span class="ident" id="4177859">k</span><span class="op" id="4177860">]</span><span class="op" id="4177861">,</span>&nbsp;<span class="ident" id="4177863">hashed</span><span class="op" id="4177869">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4177873">m</span>&nbsp;<span class="op" id="4177875">:=</span>&nbsp;<span class="builtinfunc" id="4177878">new</span><span class="op" id="4177881">(</span><span class="ident" id="4177882">big</span><span class="op" id="4177885">.</span><span class="ident" id="4177886">Int</span><span class="op" id="4177889">)</span><span class="op" id="4177890">.</span><span class="ident" id="4177891">SetBytes</span><span class="op" id="4177899">(</span><span class="ident" id="4177900">em</span><span class="op" id="4177902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4177905">c</span><span class="op" id="4177906">,</span>&nbsp;<span class="ident" id="4177908">err</span>&nbsp;<span class="op" id="4177912">:=</span>&nbsp;<span class="ident" id="4177915">decrypt</span><span class="op" id="4177922">(</span><span class="ident" id="4177923">rand</span><span class="op" id="4177927">,</span>&nbsp;<span class="ident" id="4177929">priv</span><span class="op" id="4177933">,</span>&nbsp;<span class="ident" id="4177935">m</span><span class="op" id="4177936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4177939">if</span>&nbsp;<span class="ident" id="4177942">err</span>&nbsp;<span class="op" id="4177946">!=</span>&nbsp;<span class="ident" id="4177949">nil</span>&nbsp;<span class="op" id="4177953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4177957">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4177965">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4177969">copyWithLeftPad</span><span class="op" id="4177984">(</span><span class="ident" id="4177985">em</span><span class="op" id="4177987">,</span>&nbsp;<span class="ident" id="4177989">c</span><span class="op" id="4177990">.</span><span class="ident" id="4177991">Bytes</span><span class="op" id="4177996">(</span><span class="op" id="4177997">)</span><span class="op" id="4177998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4178001">s</span>&nbsp;<span class="op" id="4178003">=</span>&nbsp;<span class="ident" id="4178005">em</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4178009">return</span><br>
<span class="lineno"></span><span class="op" id="4178016">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="comment" id="4178019">//&nbsp;VerifyPKCS1v15&nbsp;verifies&nbsp;an&nbsp;RSA&nbsp;PKCS#1&nbsp;v1.5&nbsp;signature.</span><br>
<span class="lineno"></span><span class="comment" id="4178076">//&nbsp;hashed&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;hashing&nbsp;the&nbsp;input&nbsp;message&nbsp;using&nbsp;the&nbsp;given&nbsp;hash</span><br>
<span class="lineno"></span><span class="comment" id="4178150">//&nbsp;function&nbsp;and&nbsp;sig&nbsp;is&nbsp;the&nbsp;signature.&nbsp;A&nbsp;valid&nbsp;signature&nbsp;is&nbsp;indicated&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="4178222">//&nbsp;returning&nbsp;a&nbsp;nil&nbsp;error.&nbsp;If&nbsp;hash&nbsp;is&nbsp;zero&nbsp;then&nbsp;hashed&nbsp;is&nbsp;used&nbsp;directly.&nbsp;This</span><br>
<span class="lineno">230</span><span class="comment" id="4178299">//&nbsp;isn&#39;t&nbsp;advisable&nbsp;except&nbsp;for&nbsp;interoperability.</span><br>
<span class="lineno"></span><span class="keyword" id="4178347">func</span>&nbsp;<span class="ident" id="4178352">VerifyPKCS1v15</span><span class="op" id="4178366">(</span><span class="ident" id="4178367">pub</span>&nbsp;<span class="op" id="4178371">*</span><span class="ident" id="4178372">PublicKey</span><span class="op" id="4178381">,</span>&nbsp;<span class="ident" id="4178383">hash</span>&nbsp;<span class="ident" id="4178388">crypto</span><span class="op" id="4178394">.</span><span class="ident" id="4178395">Hash</span><span class="op" id="4178399">,</span>&nbsp;<span class="ident" id="4178401">hashed</span>&nbsp;<span class="op" id="4178408">[</span><span class="op" id="4178409">]</span><span class="builtintype" id="4178410">byte</span><span class="op" id="4178414">,</span>&nbsp;<span class="ident" id="4178416">sig</span>&nbsp;<span class="op" id="4178420">[</span><span class="op" id="4178421">]</span><span class="builtintype" id="4178422">byte</span><span class="op" id="4178426">)</span>&nbsp;<span class="op" id="4178428">(</span><span class="ident" id="4178429">err</span>&nbsp;<span class="builtintype" id="4178433">error</span><span class="op" id="4178438">)</span>&nbsp;<span class="op" id="4178440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4178443">hashLen</span><span class="op" id="4178450">,</span>&nbsp;<span class="ident" id="4178452">prefix</span><span class="op" id="4178458">,</span>&nbsp;<span class="ident" id="4178460">err</span>&nbsp;<span class="op" id="4178464">:=</span>&nbsp;<span class="ident" id="4178467">pkcs1v15HashInfo</span><span class="op" id="4178483">(</span><span class="ident" id="4178484">hash</span><span class="op" id="4178488">,</span>&nbsp;<span class="builtinfunc" id="4178490">len</span><span class="op" id="4178493">(</span><span class="ident" id="4178494">hashed</span><span class="op" id="4178500">)</span><span class="op" id="4178501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4178504">if</span>&nbsp;<span class="ident" id="4178507">err</span>&nbsp;<span class="op" id="4178511">!=</span>&nbsp;<span class="ident" id="4178514">nil</span>&nbsp;<span class="op" id="4178518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4178522">return</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4178530">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4178534">tLen</span>&nbsp;<span class="op" id="4178539">:=</span>&nbsp;<span class="builtinfunc" id="4178542">len</span><span class="op" id="4178545">(</span><span class="ident" id="4178546">prefix</span><span class="op" id="4178552">)</span>&nbsp;<span class="op" id="4178554">+</span>&nbsp;<span class="ident" id="4178556">hashLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4178565">k</span>&nbsp;<span class="op" id="4178567">:=</span>&nbsp;<span class="op" id="4178570">(</span><span class="ident" id="4178571">pub</span><span class="op" id="4178574">.</span><span class="ident" id="4178575">N</span><span class="op" id="4178576">.</span><span class="ident" id="4178577">BitLen</span><span class="op" id="4178583">(</span><span class="op" id="4178584">)</span>&nbsp;<span class="op" id="4178586">+</span>&nbsp;<span class="num" id="4178588">7</span><span class="op" id="4178589">)</span>&nbsp;<span class="op" id="4178591">/</span>&nbsp;<span class="num" id="4178593">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4178596">if</span>&nbsp;<span class="ident" id="4178599">k</span>&nbsp;<span class="op" id="4178601">&lt;</span>&nbsp;<span class="ident" id="4178603">tLen</span><span class="op" id="4178607">+</span><span class="num" id="4178608">11</span>&nbsp;<span class="op" id="4178611">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4178615">err</span>&nbsp;<span class="op" id="4178619">=</span>&nbsp;<span class="ident" id="4178621">ErrVerification</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4178639">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4178647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4178651">c</span>&nbsp;<span class="op" id="4178653">:=</span>&nbsp;<span class="builtinfunc" id="4178656">new</span><span class="op" id="4178659">(</span><span class="ident" id="4178660">big</span><span class="op" id="4178663">.</span><span class="ident" id="4178664">Int</span><span class="op" id="4178667">)</span><span class="op" id="4178668">.</span><span class="ident" id="4178669">SetBytes</span><span class="op" id="4178677">(</span><span class="ident" id="4178678">sig</span><span class="op" id="4178681">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4178684">m</span>&nbsp;<span class="op" id="4178686">:=</span>&nbsp;<span class="ident" id="4178689">encrypt</span><span class="op" id="4178696">(</span><span class="builtinfunc" id="4178697">new</span><span class="op" id="4178700">(</span><span class="ident" id="4178701">big</span><span class="op" id="4178704">.</span><span class="ident" id="4178705">Int</span><span class="op" id="4178708">)</span><span class="op" id="4178709">,</span>&nbsp;<span class="ident" id="4178711">pub</span><span class="op" id="4178714">,</span>&nbsp;<span class="ident" id="4178716">c</span><span class="op" id="4178717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4178720">em</span>&nbsp;<span class="op" id="4178723">:=</span>&nbsp;<span class="ident" id="4178726">leftPad</span><span class="op" id="4178733">(</span><span class="ident" id="4178734">m</span><span class="op" id="4178735">.</span><span class="ident" id="4178736">Bytes</span><span class="op" id="4178741">(</span><span class="op" id="4178742">)</span><span class="op" id="4178743">,</span>&nbsp;<span class="ident" id="4178745">k</span><span class="op" id="4178746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4178749">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x01&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;T</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4178791">ok</span>&nbsp;<span class="op" id="4178794">:=</span>&nbsp;<span class="ident" id="4178797">subtle</span><span class="op" id="4178803">.</span><span class="ident" id="4178804">ConstantTimeByteEq</span><span class="op" id="4178822">(</span><span class="ident" id="4178823">em</span><span class="op" id="4178825">[</span><span class="num" id="4178826">0</span><span class="op" id="4178827">]</span><span class="op" id="4178828">,</span>&nbsp;<span class="num" id="4178830">0</span><span class="op" id="4178831">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4178834">ok</span>&nbsp;<span class="op" id="4178837">&amp;=</span>&nbsp;<span class="ident" id="4178840">subtle</span><span class="op" id="4178846">.</span><span class="ident" id="4178847">ConstantTimeByteEq</span><span class="op" id="4178865">(</span><span class="ident" id="4178866">em</span><span class="op" id="4178868">[</span><span class="num" id="4178869">1</span><span class="op" id="4178870">]</span><span class="op" id="4178871">,</span>&nbsp;<span class="num" id="4178873">1</span><span class="op" id="4178874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4178877">ok</span>&nbsp;<span class="op" id="4178880">&amp;=</span>&nbsp;<span class="ident" id="4178883">subtle</span><span class="op" id="4178889">.</span><span class="ident" id="4178890">ConstantTimeCompare</span><span class="op" id="4178909">(</span><span class="ident" id="4178910">em</span><span class="op" id="4178912">[</span><span class="ident" id="4178913">k</span><span class="op" id="4178914">-</span><span class="ident" id="4178915">hashLen</span><span class="op" id="4178922">:</span><span class="ident" id="4178923">k</span><span class="op" id="4178924">]</span><span class="op" id="4178925">,</span>&nbsp;<span class="ident" id="4178927">hashed</span><span class="op" id="4178933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4178936">ok</span>&nbsp;<span class="op" id="4178939">&amp;=</span>&nbsp;<span class="ident" id="4178942">subtle</span><span class="op" id="4178948">.</span><span class="ident" id="4178949">ConstantTimeCompare</span><span class="op" id="4178968">(</span><span class="ident" id="4178969">em</span><span class="op" id="4178971">[</span><span class="ident" id="4178972">k</span><span class="op" id="4178973">-</span><span class="ident" id="4178974">tLen</span><span class="op" id="4178978">:</span><span class="ident" id="4178979">k</span><span class="op" id="4178980">-</span><span class="ident" id="4178981">hashLen</span><span class="op" id="4178988">]</span><span class="op" id="4178989">,</span>&nbsp;<span class="ident" id="4178991">prefix</span><span class="op" id="4178997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4179000">ok</span>&nbsp;<span class="op" id="4179003">&amp;=</span>&nbsp;<span class="ident" id="4179006">subtle</span><span class="op" id="4179012">.</span><span class="ident" id="4179013">ConstantTimeByteEq</span><span class="op" id="4179031">(</span><span class="ident" id="4179032">em</span><span class="op" id="4179034">[</span><span class="ident" id="4179035">k</span><span class="op" id="4179036">-</span><span class="ident" id="4179037">tLen</span><span class="op" id="4179041">-</span><span class="num" id="4179042">1</span><span class="op" id="4179043">]</span><span class="op" id="4179044">,</span>&nbsp;<span class="num" id="4179046">0</span><span class="op" id="4179047">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4179051">for</span>&nbsp;<span class="ident" id="4179055">i</span>&nbsp;<span class="op" id="4179057">:=</span>&nbsp;<span class="num" id="4179060">2</span><span class="op" id="4179061">;</span>&nbsp;<span class="ident" id="4179063">i</span>&nbsp;<span class="op" id="4179065">&lt;</span>&nbsp;<span class="ident" id="4179067">k</span><span class="op" id="4179068">-</span><span class="ident" id="4179069">tLen</span><span class="op" id="4179073">-</span><span class="num" id="4179074">1</span><span class="op" id="4179075">;</span>&nbsp;<span class="ident" id="4179077">i</span><span class="op" id="4179078">++</span>&nbsp;<span class="op" id="4179081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4179085">ok</span>&nbsp;<span class="op" id="4179088">&amp;=</span>&nbsp;<span class="ident" id="4179091">subtle</span><span class="op" id="4179097">.</span><span class="ident" id="4179098">ConstantTimeByteEq</span><span class="op" id="4179116">(</span><span class="ident" id="4179117">em</span><span class="op" id="4179119">[</span><span class="ident" id="4179120">i</span><span class="op" id="4179121">]</span><span class="op" id="4179122">,</span>&nbsp;<span class="num" id="4179124">0xff</span><span class="op" id="4179128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4179131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4179135">if</span>&nbsp;<span class="ident" id="4179138">ok</span>&nbsp;<span class="op" id="4179141">!=</span>&nbsp;<span class="num" id="4179144">1</span>&nbsp;<span class="op" id="4179146">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4179150">return</span>&nbsp;<span class="ident" id="4179157">ErrVerification</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4179174">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4179178">return</span>&nbsp;<span class="ident" id="4179185">nil</span><br>
<span class="lineno"></span><span class="op" id="4179189">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="4179192">func</span>&nbsp;<span class="ident" id="4179197">pkcs1v15HashInfo</span><span class="op" id="4179213">(</span><span class="ident" id="4179214">hash</span>&nbsp;<span class="ident" id="4179219">crypto</span><span class="op" id="4179225">.</span><span class="ident" id="4179226">Hash</span><span class="op" id="4179230">,</span>&nbsp;<span class="ident" id="4179232">inLen</span>&nbsp;<span class="builtintype" id="4179238">int</span><span class="op" id="4179241">)</span>&nbsp;<span class="op" id="4179243">(</span><span class="ident" id="4179244">hashLen</span>&nbsp;<span class="builtintype" id="4179252">int</span><span class="op" id="4179255">,</span>&nbsp;<span class="ident" id="4179257">prefix</span>&nbsp;<span class="op" id="4179264">[</span><span class="op" id="4179265">]</span><span class="builtintype" id="4179266">byte</span><span class="op" id="4179270">,</span>&nbsp;<span class="ident" id="4179272">err</span>&nbsp;<span class="builtintype" id="4179276">error</span><span class="op" id="4179281">)</span>&nbsp;<span class="op" id="4179283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4179286">//&nbsp;Special&nbsp;case:&nbsp;crypto.Hash(0)&nbsp;is&nbsp;used&nbsp;to&nbsp;indicate&nbsp;that&nbsp;the&nbsp;data&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4179356">//&nbsp;signed&nbsp;directly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4179377">if</span>&nbsp;<span class="ident" id="4179380">hash</span>&nbsp;<span class="op" id="4179385">==</span>&nbsp;<span class="num" id="4179388">0</span>&nbsp;<span class="op" id="4179390">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4179394">return</span>&nbsp;<span class="ident" id="4179401">inLen</span><span class="op" id="4179406">,</span>&nbsp;<span class="ident" id="4179408">nil</span><span class="op" id="4179411">,</span>&nbsp;<span class="ident" id="4179413">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4179418">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4179422">hashLen</span>&nbsp;<span class="op" id="4179430">=</span>&nbsp;<span class="ident" id="4179432">hash</span><span class="op" id="4179436">.</span><span class="ident" id="4179437">Size</span><span class="op" id="4179441">(</span><span class="op" id="4179442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4179445">if</span>&nbsp;<span class="ident" id="4179448">inLen</span>&nbsp;<span class="op" id="4179454">!=</span>&nbsp;<span class="ident" id="4179457">hashLen</span>&nbsp;<span class="op" id="4179465">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4179469">return</span>&nbsp;<span class="num" id="4179476">0</span><span class="op" id="4179477">,</span>&nbsp;<span class="ident" id="4179479">nil</span><span class="op" id="4179482">,</span>&nbsp;<span class="ident" id="4179484">errors</span><span class="op" id="4179490">.</span><span class="ident" id="4179491">New</span><span class="op" id="4179494">(</span><span class="string" id="4179495">&#34;crypto/rsa:&nbsp;input&nbsp;must&nbsp;be&nbsp;hashed&nbsp;message&#34;</span><span class="op" id="4179537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4179540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4179543">prefix</span><span class="op" id="4179549">,</span>&nbsp;<span class="ident" id="4179551">ok</span>&nbsp;<span class="op" id="4179554">:=</span>&nbsp;<span class="ident" id="4179557">hashPrefixes</span><span class="op" id="4179569">[</span><span class="ident" id="4179570">hash</span><span class="op" id="4179574">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4179577">if</span>&nbsp;<span class="op" id="4179580">!</span><span class="ident" id="4179581">ok</span>&nbsp;<span class="op" id="4179584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4179588">return</span>&nbsp;<span class="num" id="4179595">0</span><span class="op" id="4179596">,</span>&nbsp;<span class="ident" id="4179598">nil</span><span class="op" id="4179601">,</span>&nbsp;<span class="ident" id="4179603">errors</span><span class="op" id="4179609">.</span><span class="ident" id="4179610">New</span><span class="op" id="4179613">(</span><span class="string" id="4179614">&#34;crypto/rsa:&nbsp;unsupported&nbsp;hash&nbsp;function&#34;</span><span class="op" id="4179653">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4179656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4179659">return</span><br>
<span class="lineno"></span><span class="op" id="4179666">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4179669">//&nbsp;copyWithLeftPad&nbsp;copies&nbsp;src&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;dest,&nbsp;padding&nbsp;with&nbsp;zero&nbsp;bytes&nbsp;as</span><br>
<span class="lineno">285</span><span class="comment" id="4179746">//&nbsp;needed.</span><br>
<span class="lineno"></span><span class="keyword" id="4179757">func</span>&nbsp;<span class="ident" id="4179762">copyWithLeftPad</span><span class="op" id="4179777">(</span><span class="ident" id="4179778">dest</span><span class="op" id="4179782">,</span>&nbsp;<span class="ident" id="4179784">src</span>&nbsp;<span class="op" id="4179788">[</span><span class="op" id="4179789">]</span><span class="builtintype" id="4179790">byte</span><span class="op" id="4179794">)</span>&nbsp;<span class="op" id="4179796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4179799">numPaddingBytes</span>&nbsp;<span class="op" id="4179815">:=</span>&nbsp;<span class="builtinfunc" id="4179818">len</span><span class="op" id="4179821">(</span><span class="ident" id="4179822">dest</span><span class="op" id="4179826">)</span>&nbsp;<span class="op" id="4179828">-</span>&nbsp;<span class="builtinfunc" id="4179830">len</span><span class="op" id="4179833">(</span><span class="ident" id="4179834">src</span><span class="op" id="4179837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4179840">for</span>&nbsp;<span class="ident" id="4179844">i</span>&nbsp;<span class="op" id="4179846">:=</span>&nbsp;<span class="num" id="4179849">0</span><span class="op" id="4179850">;</span>&nbsp;<span class="ident" id="4179852">i</span>&nbsp;<span class="op" id="4179854">&lt;</span>&nbsp;<span class="ident" id="4179856">numPaddingBytes</span><span class="op" id="4179871">;</span>&nbsp;<span class="ident" id="4179873">i</span><span class="op" id="4179874">++</span>&nbsp;<span class="op" id="4179877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4179881">dest</span><span class="op" id="4179885">[</span><span class="ident" id="4179886">i</span><span class="op" id="4179887">]</span>&nbsp;<span class="op" id="4179889">=</span>&nbsp;<span class="num" id="4179891">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4179894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4179897">copy</span><span class="op" id="4179901">(</span><span class="ident" id="4179902">dest</span><span class="op" id="4179906">[</span><span class="ident" id="4179907">numPaddingBytes</span><span class="op" id="4179922">:</span><span class="op" id="4179923">]</span><span class="op" id="4179924">,</span>&nbsp;<span class="ident" id="4179926">src</span><span class="op" id="4179929">)</span><br>
<span class="lineno"></span><span class="op" id="4179931">}</span>
</div>
</body>
</html>
