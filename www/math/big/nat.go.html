<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment">//&nbsp;Package&nbsp;big&nbsp;implements&nbsp;multi-precision&nbsp;arithmetic&nbsp;(big&nbsp;numbers).</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;following&nbsp;numeric&nbsp;types&nbsp;are&nbsp;supported:</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;Int&nbsp;&nbsp;&nbsp;&nbspsigned&nbsp;integers</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;Rat&nbsp;&nbsp;&nbsp;&nbsprational&nbsp;numbers</span><br>
<span class="lineno">10</span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Methods&nbsp;are&nbsp;typically&nbsp;of&nbsp;the&nbsp;form:</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;(z&nbsp;*Int)&nbsp;Op(x,&nbsp;y&nbsp;*Int)&nbsp;*Int&nbsp;&nbsp;&nbsp;&nbsp(similar&nbsp;for&nbsp;*Rat)</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno">15</span><span class="comment">//&nbsp;and&nbsp;implement&nbsp;operations&nbsp;z&nbsp;=&nbsp;x&nbsp;Op&nbsp;y&nbsp;with&nbsp;the&nbsp;result&nbsp;as&nbsp;receiver;&nbsp;if&nbsp;it</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;is&nbsp;one&nbsp;of&nbsp;the&nbsp;operands&nbsp;it&nbsp;may&nbsp;be&nbsp;overwritten&nbsp;(and&nbsp;its&nbsp;memory&nbsp;reused).</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;To&nbsp;enable&nbsp;chaining&nbsp;of&nbsp;operations,&nbsp;the&nbsp;result&nbsp;is&nbsp;also&nbsp;returned.&nbsp;Methods</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;returning&nbsp;a&nbsp;result&nbsp;other&nbsp;than&nbsp;*Int&nbsp;or&nbsp;*Rat&nbsp;take&nbsp;one&nbsp;of&nbsp;the&nbsp;operands&nbsp;as</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;the&nbsp;receiver.</span><br>
<span class="lineno">20</span><span class="comment">//</span><br>
<span class="lineno"></span><span class="keyword">package</span>&nbsp;<span class="ident">big</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;operations&nbsp;on&nbsp;unsigned&nbsp;multi-precision&nbsp;integers.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;These&nbsp;are&nbsp;the&nbsp;building&nbsp;blocks&nbsp;for&nbsp;the&nbsp;operations&nbsp;on&nbsp;signed&nbsp;integers</span><br>
<span class="lineno">25</span><span class="comment">//&nbsp;and&nbsp;rationals.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;io&#34;</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;math&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;math/rand&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment">//&nbsp;An&nbsp;unsigned&nbsp;integer&nbsp;x&nbsp;of&nbsp;the&nbsp;form</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;x&nbsp;=&nbsp;x[n-1]*_B^(n-1)&nbsp;+&nbsp;x[n-2]*_B^(n-2)&nbsp;+&nbsp;...&nbsp;+&nbsp;x[1]*_B&nbsp;+&nbsp;x[0]</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;with&nbsp;0&nbsp;&lt;=&nbsp;x[i]&nbsp;&lt;&nbsp;_B&nbsp;and&nbsp;0&nbsp;&lt;=&nbsp;i&nbsp;&lt;&nbsp;n&nbsp;is&nbsp;stored&nbsp;in&nbsp;a&nbsp;slice&nbsp;of&nbsp;length&nbsp;n,</span><br>
<span class="lineno">40</span><span class="comment">//&nbsp;with&nbsp;the&nbsp;digits&nbsp;x[i]&nbsp;as&nbsp;the&nbsp;slice&nbsp;elements.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;A&nbsp;number&nbsp;is&nbsp;normalized&nbsp;if&nbsp;the&nbsp;slice&nbsp;contains&nbsp;no&nbsp;leading&nbsp;0&nbsp;digits.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;During&nbsp;arithmetic&nbsp;operations,&nbsp;denormalized&nbsp;values&nbsp;may&nbsp;occur&nbsp;but&nbsp;are</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;always&nbsp;normalized&nbsp;before&nbsp;returning&nbsp;the&nbsp;final&nbsp;result.&nbsp;The&nbsp;normalized</span><br>
<span class="lineno">45</span><span class="comment">//&nbsp;representation&nbsp;of&nbsp;0&nbsp;is&nbsp;the&nbsp;empty&nbsp;or&nbsp;nil&nbsp;slice&nbsp;(length&nbsp;=&nbsp;0).</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">nat</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">Word</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="op">(</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">natOne</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nat</span><span class="op">{</span><span class="num">1</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">natTwo</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nat</span><span class="op">{</span><span class="num">2</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">natTen</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nat</span><span class="op">{</span><span class="num">10</span><span class="op">}</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">clear</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">z</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">norm</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">nat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">z</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">z</span><span class="op">[</span><span class="ident">i</span><span class="op">-</span><span class="num">1</span><span class="op">]</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">--</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">i</span><span class="op">]</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="ident">n</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="ident">nat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="builtinfunc">cap</span><span class="op">(</span><span class="ident">z</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">n</span><span class="op">]</span>&nbsp;<span class="comment">//&nbsp;reuse&nbsp;z</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Choosing&nbsp;a&nbsp;good&nbsp;value&nbsp;for&nbsp;e&nbsp;has&nbsp;significant&nbsp;performance&nbsp;impact</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;because&nbsp;it&nbsp;increases&nbsp;the&nbsp;chance&nbsp;that&nbsp;a&nbsp;value&nbsp;can&nbsp;be&nbsp;reused.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">const</span>&nbsp;<span class="ident">e</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">4</span>&nbsp;<span class="comment">//&nbsp;extra&nbsp;capacity</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="ident">nat</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">+</span><span class="ident">e</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">setWord</span><span class="op">(</span><span class="ident">x</span>&nbsp;<span class="ident">Word</span><span class="op">)</span>&nbsp;<span class="ident">nat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">x</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">setUint64</span><span class="op">(</span><span class="ident">x</span>&nbsp;<span class="ident">uint64</span><span class="op">)</span>&nbsp;<span class="ident">nat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;single-digit&nbsp;values</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">w</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">Word</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">uint64</span><span class="op">(</span><span class="ident">w</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">setWord</span><span class="op">(</span><span class="ident">w</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;compute&nbsp;number&nbsp;of&nbsp;words&nbsp;n&nbsp;required&nbsp;to&nbsp;represent&nbsp;x</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">t</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">x</span><span class="op">;</span>&nbsp;<span class="ident">t</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">t</span>&nbsp;<span class="op">&gt;&gt;=</span>&nbsp;<span class="ident">_W</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;split&nbsp;x&nbsp;into&nbsp;n&nbsp;words</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="ident">n</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">z</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">Word</span><span class="op">(</span><span class="ident">x</span>&nbsp;<span class="op">&amp;</span>&nbsp;<span class="ident">_M</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x</span>&nbsp;<span class="op">&gt;&gt;=</span>&nbsp;<span class="ident">_W</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">set</span><span class="op">(</span><span class="ident">x</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">nat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">copy</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">add</span><span class="op">(</span><span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">nat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">y</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">n</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">add</span><span class="op">(</span><span class="ident">y</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;n&nbsp;==&nbsp;0&nbsp;because&nbsp;m&nbsp;&gt;=&nbsp;n;&nbsp;result&nbsp;is&nbsp;0</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;result&nbsp;is&nbsp;x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">set</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;m&nbsp;&gt;&nbsp;0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="ident">m</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">addVV</span><span class="op">(</span><span class="ident">z</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">n</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">addVW</span><span class="op">(</span><span class="ident">z</span><span class="op">[</span><span class="ident">n</span><span class="op">:</span><span class="ident">m</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">[</span><span class="ident">n</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">c</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">[</span><span class="ident">m</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">norm</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">140</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">sub</span><span class="op">(</span><span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">nat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">y</span><span class="op">)</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">n</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;underflow&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span><span class="op">:</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;n&nbsp;==&nbsp;0&nbsp;because&nbsp;m&nbsp;&gt;=&nbsp;n;&nbsp;result&nbsp;is&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;result&nbsp;is&nbsp;x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">set</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;m&nbsp;&gt;&nbsp;0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="ident">m</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">subVV</span><span class="op">(</span><span class="ident">z</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">n</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span><span class="op">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">subVW</span><span class="op">(</span><span class="ident">z</span><span class="op">[</span><span class="ident">n</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">[</span><span class="ident">n</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">c</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">c</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;underflow&#34;</span><span class="op">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">norm</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">x</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">cmp</span><span class="op">(</span><span class="ident">y</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">y</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">n</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">-</span><span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">n</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">x</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">y</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">x</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">y</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">-</span><span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">x</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">y</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno">195</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">mulAddWW</span><span class="op">(</span><span class="ident">x</span>&nbsp;<span class="ident">nat</span><span class="op">,</span>&nbsp;<span class="ident">y</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="ident">Word</span><span class="op">)</span>&nbsp;<span class="ident">nat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">setWord</span><span class="op">(</span><span class="ident">r</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;result&nbsp;is&nbsp;r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;m&nbsp;&gt;&nbsp;0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="ident">m</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">[</span><span class="ident">m</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">mulAddVWW</span><span class="op">(</span><span class="ident">z</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">m</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span><span class="op">,</span>&nbsp;<span class="ident">r</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">norm</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="comment">//&nbsp;basicMul&nbsp;multiplies&nbsp;x&nbsp;and&nbsp;y&nbsp;and&nbsp;leaves&nbsp;the&nbsp;result&nbsp;in&nbsp;z.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;(non-normalized)&nbsp;result&nbsp;is&nbsp;placed&nbsp;in&nbsp;z[0&nbsp;:&nbsp;len(x)&nbsp;+&nbsp;len(y)].</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">basicMul</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">[</span><span class="num">0</span>&nbsp;<span class="op">:</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><span class="op">+</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">y</span><span class="op">)</span><span class="op">]</span><span class="op">.</span><span class="ident">clear</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;initialize&nbsp;z</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">d</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">d</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">[</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><span class="op">+</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">addMulVVW</span><span class="op">(</span><span class="ident">z</span><span class="op">[</span><span class="ident">i</span><span class="op">:</span><span class="ident">i</span><span class="op">+</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">d</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Fast&nbsp;version&nbsp;of&nbsp;z[0:n+n&gt;&gt;1].add(z[0:n+n&gt;&gt;1],&nbsp;x[0:n])&nbsp;w/o&nbsp;bounds&nbsp;checks.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Factored&nbsp;out&nbsp;for&nbsp;readability&nbsp;-&nbsp;do&nbsp;not&nbsp;use&nbsp;outside&nbsp;karatsuba.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">karatsubaAdd</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="ident">nat</span><span class="op">,</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">c</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">addVV</span><span class="op">(</span><span class="ident">z</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">n</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">c</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">addVW</span><span class="op">(</span><span class="ident">z</span><span class="op">[</span><span class="ident">n</span><span class="op">:</span><span class="ident">n</span><span class="op">+</span><span class="ident">n</span><span class="op">&gt;&gt;</span><span class="num">1</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">z</span><span class="op">[</span><span class="ident">n</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">c</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Like&nbsp;karatsubaAdd,&nbsp;but&nbsp;does&nbsp;subtract.</span><br>
<span class="lineno">230</span><span class="keyword">func</span>&nbsp;<span class="ident">karatsubaSub</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="ident">nat</span><span class="op">,</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">c</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">subVV</span><span class="op">(</span><span class="ident">z</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">n</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">c</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">subVW</span><span class="op">(</span><span class="ident">z</span><span class="op">[</span><span class="ident">n</span><span class="op">:</span><span class="ident">n</span><span class="op">+</span><span class="ident">n</span><span class="op">&gt;&gt;</span><span class="num">1</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">z</span><span class="op">[</span><span class="ident">n</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">c</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Operands&nbsp;that&nbsp;are&nbsp;shorter&nbsp;than&nbsp;karatsubaThreshold&nbsp;are&nbsp;multiplied&nbsp;using</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&#34;grade&nbsp;school&#34;&nbsp;multiplication;&nbsp;for&nbsp;longer&nbsp;operands&nbsp;the&nbsp;Karatsuba&nbsp;algorithm</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">karatsubaThreshold</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">40</span>&nbsp;<span class="comment">//&nbsp;computed&nbsp;by&nbsp;calibrate.go</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;karatsuba&nbsp;multiplies&nbsp;x&nbsp;and&nbsp;y&nbsp;and&nbsp;leaves&nbsp;the&nbsp;result&nbsp;in&nbsp;z.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Both&nbsp;x&nbsp;and&nbsp;y&nbsp;must&nbsp;have&nbsp;the&nbsp;same&nbsp;length&nbsp;n&nbsp;and&nbsp;n&nbsp;must&nbsp;be&nbsp;a</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;power&nbsp;of&nbsp;2.&nbsp;The&nbsp;result&nbsp;vector&nbsp;z&nbsp;must&nbsp;have&nbsp;len(z)&nbsp;&gt;=&nbsp;6*n.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;(non-normalized)&nbsp;result&nbsp;is&nbsp;placed&nbsp;in&nbsp;z[0&nbsp;:&nbsp;2*n].</span><br>
<span class="lineno">245</span><span class="keyword">func</span>&nbsp;<span class="ident">karatsuba</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">y</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Switch&nbsp;to&nbsp;basic&nbsp;multiplication&nbsp;if&nbsp;numbers&nbsp;are&nbsp;odd&nbsp;or&nbsp;small.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;(n&nbsp;is&nbsp;always&nbsp;even&nbsp;if&nbsp;karatsubaThreshold&nbsp;is&nbsp;even,&nbsp;but&nbsp;be</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;conservative)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span><span class="op">&amp;</span><span class="num">1</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">karatsubaThreshold</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">2</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">basicMul</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;n&amp;1&nbsp;==&nbsp;0&nbsp;&amp;&amp;&nbsp;n&nbsp;&gt;=&nbsp;karatsubaThreshold&nbsp;&amp;&amp;&nbsp;n&nbsp;&gt;=&nbsp;2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Karatsuba&nbsp;multiplication&nbsp;is&nbsp;based&nbsp;on&nbsp;the&nbsp;observation&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;for&nbsp;two&nbsp;numbers&nbsp;x&nbsp;and&nbsp;y&nbsp;with:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;x&nbsp;=&nbsp;x1*b&nbsp;+&nbsp;x0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;y&nbsp;=&nbsp;y1*b&nbsp;+&nbsp;y0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;the&nbsp;product&nbsp;x*y&nbsp;can&nbsp;be&nbsp;obtained&nbsp;with&nbsp;3&nbsp;products&nbsp;z2,&nbsp;z1,&nbsp;z0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;instead&nbsp;of&nbsp;4:</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;x*y&nbsp;=&nbsp;x1*y1*b*b&nbsp;+&nbsp;(x1*y0&nbsp;+&nbsp;x0*y1)*b&nbsp;+&nbsp;x0*y0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&nbsp;&nbsp;&nbsp;z2*b*b&nbsp;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;z1*b&nbsp;+&nbsp;&nbsp;&nbsp;&nbsp;z0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;with:</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;xd&nbsp;=&nbsp;x1&nbsp;-&nbsp;x0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;yd&nbsp;=&nbsp;y0&nbsp;-&nbsp;y1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;z1&nbsp;=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xd*yd&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;z2&nbsp;+&nbsp;z0</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;(x1-x0)*(y0&nbsp;-&nbsp;y1)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;z2&nbsp;+&nbsp;z0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;x1*y0&nbsp;-&nbsp;x1*y1&nbsp;-&nbsp;x0*y0&nbsp;+&nbsp;x0*y1&nbsp;+&nbsp;z2&nbsp;+&nbsp;z0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;x1*y0&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;z2&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;z0&nbsp;+&nbsp;x0*y1&nbsp;+&nbsp;z2&nbsp;+&nbsp;z0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;x1*y0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;x0*y1</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;split&nbsp;x,&nbsp;y&nbsp;into&nbsp;&#34;digits&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n2</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="num">1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;n2&nbsp;&gt;=&nbsp;1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x1</span><span class="op">,</span>&nbsp;<span class="ident">x0</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">x</span><span class="op">[</span><span class="ident">n2</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">n2</span><span class="op">]</span>&nbsp;<span class="comment">//&nbsp;x&nbsp;=&nbsp;x1*b&nbsp;+&nbsp;y0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">y1</span><span class="op">,</span>&nbsp;<span class="ident">y0</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">y</span><span class="op">[</span><span class="ident">n2</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">y</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">n2</span><span class="op">]</span>&nbsp;<span class="comment">//&nbsp;y&nbsp;=&nbsp;y1*b&nbsp;+&nbsp;y0</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;z&nbsp;is&nbsp;used&nbsp;for&nbsp;the&nbsp;result&nbsp;and&nbsp;temporary&nbsp;storage:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;6*n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5*n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4*n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3*n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2*n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1*n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0*n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;z&nbsp;=&nbsp;[z2&nbsp;copy|z0&nbsp;copy|&nbsp;xd*yd&nbsp;|&nbsp;yd:xd&nbsp;|&nbsp;x1*y1&nbsp;|&nbsp;x0*y0&nbsp;]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;For&nbsp;each&nbsp;recursive&nbsp;call&nbsp;of&nbsp;karatsuba,&nbsp;an&nbsp;unused&nbsp;slice&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;z&nbsp;is&nbsp;passed&nbsp;in&nbsp;that&nbsp;has&nbsp;(at&nbsp;least)&nbsp;half&nbsp;the&nbsp;length&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;caller&#39;s&nbsp;z.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;compute&nbsp;z0&nbsp;and&nbsp;z2&nbsp;with&nbsp;the&nbsp;result&nbsp;&#34;in&nbsp;place&#34;&nbsp;in&nbsp;z</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">karatsuba</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">x0</span><span class="op">,</span>&nbsp;<span class="ident">y0</span><span class="op">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;z0&nbsp;=&nbsp;x0*y0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">karatsuba</span><span class="op">(</span><span class="ident">z</span><span class="op">[</span><span class="ident">n</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">x1</span><span class="op">,</span>&nbsp;<span class="ident">y1</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;z2&nbsp;=&nbsp;x1*y1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;compute&nbsp;xd&nbsp;(or&nbsp;the&nbsp;negative&nbsp;value&nbsp;if&nbsp;underflow&nbsp;occurs)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="comment">//&nbsp;sign&nbsp;of&nbsp;product&nbsp;xd*yd</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">xd</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">z</span><span class="op">[</span><span class="num">2</span><span class="op">*</span><span class="ident">n</span>&nbsp;<span class="op">:</span>&nbsp;<span class="num">2</span><span class="op">*</span><span class="ident">n</span><span class="op">+</span><span class="ident">n2</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">subVV</span><span class="op">(</span><span class="ident">xd</span><span class="op">,</span>&nbsp;<span class="ident">x1</span><span class="op">,</span>&nbsp;<span class="ident">x0</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span>&nbsp;<span class="comment">//&nbsp;x1-x0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">-</span><span class="ident">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">subVV</span><span class="op">(</span><span class="ident">xd</span><span class="op">,</span>&nbsp;<span class="ident">x0</span><span class="op">,</span>&nbsp;<span class="ident">x1</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;x0-x1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;compute&nbsp;yd&nbsp;(or&nbsp;the&nbsp;negative&nbsp;value&nbsp;if&nbsp;underflow&nbsp;occurs)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">yd</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">z</span><span class="op">[</span><span class="num">2</span><span class="op">*</span><span class="ident">n</span><span class="op">+</span><span class="ident">n2</span>&nbsp;<span class="op">:</span>&nbsp;<span class="num">3</span><span class="op">*</span><span class="ident">n</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">subVV</span><span class="op">(</span><span class="ident">yd</span><span class="op">,</span>&nbsp;<span class="ident">y0</span><span class="op">,</span>&nbsp;<span class="ident">y1</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span>&nbsp;<span class="comment">//&nbsp;y0-y1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">-</span><span class="ident">s</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">subVV</span><span class="op">(</span><span class="ident">yd</span><span class="op">,</span>&nbsp;<span class="ident">y1</span><span class="op">,</span>&nbsp;<span class="ident">y0</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;y1-y0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;p&nbsp;=&nbsp;(x1-x0)*(y0-y1)&nbsp;==&nbsp;x1*y0&nbsp;-&nbsp;x1*y1&nbsp;-&nbsp;x0*y0&nbsp;+&nbsp;x0*y1&nbsp;for&nbsp;s&nbsp;&gt;&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;p&nbsp;=&nbsp;(x0-x1)*(y0-y1)&nbsp;==&nbsp;x0*y0&nbsp;-&nbsp;x0*y1&nbsp;-&nbsp;x1*y0&nbsp;+&nbsp;x1*y1&nbsp;for&nbsp;s&nbsp;&lt;&nbsp;0</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">p</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">z</span><span class="op">[</span><span class="ident">n</span><span class="op">*</span><span class="num">3</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">karatsuba</span><span class="op">(</span><span class="ident">p</span><span class="op">,</span>&nbsp;<span class="ident">xd</span><span class="op">,</span>&nbsp;<span class="ident">yd</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;save&nbsp;original&nbsp;z2:z0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;(ok&nbsp;to&nbsp;use&nbsp;upper&nbsp;half&nbsp;of&nbsp;z&nbsp;since&nbsp;we&#39;re&nbsp;done&nbsp;recursing)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">z</span><span class="op">[</span><span class="ident">n</span><span class="op">*</span><span class="num">4</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">copy</span><span class="op">(</span><span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">z</span><span class="op">[</span><span class="op">:</span><span class="ident">n</span><span class="op">*</span><span class="num">2</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;add&nbsp;up&nbsp;all&nbsp;partial&nbsp;products</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;2*n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;z&nbsp;=&nbsp;[&nbsp;z2&nbsp;&nbsp;|&nbsp;z0&nbsp;&nbsp;]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;+&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;z0&nbsp;&nbsp;]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;+&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;z2&nbsp;&nbsp;]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;+&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;&nbsp;p&nbsp;&nbsp;]</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">karatsubaAdd</span><span class="op">(</span><span class="ident">z</span><span class="op">[</span><span class="ident">n2</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">karatsubaAdd</span><span class="op">(</span><span class="ident">z</span><span class="op">[</span><span class="ident">n2</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">r</span><span class="op">[</span><span class="ident">n</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">karatsubaAdd</span><span class="op">(</span><span class="ident">z</span><span class="op">[</span><span class="ident">n2</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">p</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">karatsubaSub</span><span class="op">(</span><span class="ident">z</span><span class="op">[</span><span class="ident">n2</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">p</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span><span class="comment">//&nbsp;alias&nbsp;returns&nbsp;true&nbsp;if&nbsp;x&nbsp;and&nbsp;y&nbsp;share&nbsp;the&nbsp;same&nbsp;base&nbsp;array.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">alias</span><span class="op">(</span><span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="builtinfunc">cap</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="builtinfunc">cap</span><span class="op">(</span><span class="ident">y</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="op">&amp;</span><span class="ident">x</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="builtinfunc">cap</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="builtinfunc">cap</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><span class="op">-</span><span class="num">1</span><span class="op">]</span>&nbsp;<span class="op">==</span>&nbsp;<span class="op">&amp;</span><span class="ident">y</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="builtinfunc">cap</span><span class="op">(</span><span class="ident">y</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="builtinfunc">cap</span><span class="op">(</span><span class="ident">y</span><span class="op">)</span><span class="op">-</span><span class="num">1</span><span class="op">]</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">345</span><span class="comment">//&nbsp;addAt&nbsp;implements&nbsp;z&nbsp;+=&nbsp;x&lt;&lt;(_W*i);&nbsp;z&nbsp;must&nbsp;be&nbsp;long&nbsp;enough.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;(we&nbsp;don&#39;t&nbsp;use&nbsp;nat.add&nbsp;because&nbsp;we&nbsp;need&nbsp;z&nbsp;to&nbsp;stay&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;slice,&nbsp;and&nbsp;we&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;normalize&nbsp;z&nbsp;after&nbsp;each&nbsp;addition)</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">addAt</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="ident">nat</span><span class="op">,</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">c</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">addVV</span><span class="op">(</span><span class="ident">z</span><span class="op">[</span><span class="ident">i</span><span class="op">:</span><span class="ident">i</span><span class="op">+</span><span class="ident">n</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">z</span><span class="op">[</span><span class="ident">i</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">c</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">j</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">z</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">addVW</span><span class="op">(</span><span class="ident">z</span><span class="op">[</span><span class="ident">j</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">z</span><span class="op">[</span><span class="ident">j</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">c</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">max</span><span class="op">(</span><span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">y</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;karatsubaLen&nbsp;computes&nbsp;an&nbsp;approximation&nbsp;to&nbsp;the&nbsp;maximum&nbsp;k&nbsp;&lt;=&nbsp;n&nbsp;such&nbsp;that</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;k&nbsp;=&nbsp;p&lt;&lt;i&nbsp;for&nbsp;a&nbsp;number&nbsp;p&nbsp;&lt;=&nbsp;karatsubaThreshold&nbsp;and&nbsp;an&nbsp;i&nbsp;&gt;=&nbsp;0.&nbsp;Thus,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;result&nbsp;is&nbsp;the&nbsp;largest&nbsp;number&nbsp;that&nbsp;can&nbsp;be&nbsp;divided&nbsp;repeatedly&nbsp;by&nbsp;2&nbsp;before</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;becoming&nbsp;about&nbsp;the&nbsp;value&nbsp;of&nbsp;karatsubaThreshold.</span><br>
<span class="lineno">370</span><span class="keyword">func</span>&nbsp;<span class="ident">karatsubaLen</span><span class="op">(</span><span class="ident">n</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">uint</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">karatsubaThreshold</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">&gt;&gt;=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">++</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="ident">i</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">mul</span><span class="op">(</span><span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">nat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">y</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">n</span><span class="op">:</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">mul</span><span class="op">(</span><span class="ident">y</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">1</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">mulAddWW</span><span class="op">(</span><span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;m&nbsp;&gt;=&nbsp;n&nbsp;&gt;&nbsp;1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;determine&nbsp;if&nbsp;z&nbsp;can&nbsp;be&nbsp;reused</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">alias</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">)</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">alias</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">y</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="comment">//&nbsp;z&nbsp;is&nbsp;an&nbsp;alias&nbsp;for&nbsp;x&nbsp;or&nbsp;y&nbsp;-&nbsp;cannot&nbsp;reuse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;use&nbsp;basic&nbsp;multiplication&nbsp;if&nbsp;the&nbsp;numbers&nbsp;are&nbsp;small</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">karatsubaThreshold</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="ident">m</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">n</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">basicMul</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">norm</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;m&nbsp;&gt;=&nbsp;n&nbsp;&amp;&amp;&nbsp;n&nbsp;&gt;=&nbsp;karatsubaThreshold&nbsp;&amp;&amp;&nbsp;n&nbsp;&gt;=&nbsp;2</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;determine&nbsp;Karatsuba&nbsp;length&nbsp;k&nbsp;such&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;x&nbsp;=&nbsp;xh*b&nbsp;+&nbsp;x0&nbsp;&nbsp;(0&nbsp;&lt;=&nbsp;x0&nbsp;&lt;&nbsp;b)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;y&nbsp;=&nbsp;yh*b&nbsp;+&nbsp;y0&nbsp;&nbsp;(0&nbsp;&lt;=&nbsp;y0&nbsp;&lt;&nbsp;b)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;b&nbsp;=&nbsp;1&lt;&lt;(_W*k)&nbsp;&nbsp;(&#34;base&#34;&nbsp;of&nbsp;digits&nbsp;xi,&nbsp;yi)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">k</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">karatsubaLen</span><span class="op">(</span><span class="ident">n</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;k&nbsp;&lt;=&nbsp;n</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;multiply&nbsp;x0&nbsp;and&nbsp;y0&nbsp;via&nbsp;Karatsuba</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x0</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">x</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">k</span><span class="op">]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;x0&nbsp;is&nbsp;not&nbsp;normalized</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">y0</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">y</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">k</span><span class="op">]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;y0&nbsp;is&nbsp;not&nbsp;normalized</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="ident">max</span><span class="op">(</span><span class="num">6</span><span class="op">*</span><span class="ident">k</span><span class="op">,</span>&nbsp;<span class="ident">m</span><span class="op">+</span><span class="ident">n</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;enough&nbsp;space&nbsp;for&nbsp;karatsuba&nbsp;of&nbsp;x0*y0&nbsp;and&nbsp;full&nbsp;result&nbsp;of&nbsp;x*y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">karatsuba</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">x0</span><span class="op">,</span>&nbsp;<span class="ident">y0</span><span class="op">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">[</span><span class="num">0</span>&nbsp;<span class="op">:</span>&nbsp;<span class="ident">m</span><span class="op">+</span><span class="ident">n</span><span class="op">]</span>&nbsp;&nbsp;<span class="comment">//&nbsp;z&nbsp;has&nbsp;final&nbsp;length&nbsp;but&nbsp;may&nbsp;be&nbsp;incomplete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">[</span><span class="num">2</span><span class="op">*</span><span class="ident">k</span><span class="op">:</span><span class="op">]</span><span class="op">.</span><span class="ident">clear</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;upper&nbsp;portion&nbsp;of&nbsp;z&nbsp;is&nbsp;garbage&nbsp;(and&nbsp;2*k&nbsp;&lt;=&nbsp;m+n&nbsp;since&nbsp;k&nbsp;&lt;=&nbsp;n&nbsp;&lt;=&nbsp;m)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;If&nbsp;xh&nbsp;!=&nbsp;0&nbsp;or&nbsp;yh&nbsp;!=&nbsp;0,&nbsp;add&nbsp;the&nbsp;missing&nbsp;terms&nbsp;to&nbsp;z.&nbsp;For</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;xh&nbsp;=&nbsp;xi*b^i&nbsp;+&nbsp;...&nbsp;+&nbsp;x2*b^2&nbsp;+&nbsp;x1*b&nbsp;(0&nbsp;&lt;=&nbsp;xi&nbsp;&lt;&nbsp;b)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;yh&nbsp;=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;y1*b&nbsp;(0&nbsp;&lt;=&nbsp;y1&nbsp;&lt;&nbsp;b)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;the&nbsp;missing&nbsp;terms&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;x0*y1*b&nbsp;and&nbsp;xi*y0*b^i,&nbsp;xi*y1*b^(i+1)&nbsp;for&nbsp;i&nbsp;&gt;&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;since&nbsp;all&nbsp;the&nbsp;yi&nbsp;for&nbsp;i&nbsp;&gt;&nbsp;1&nbsp;are&nbsp;0&nbsp;by&nbsp;choice&nbsp;of&nbsp;k:&nbsp;If&nbsp;any&nbsp;of&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;were&nbsp;&gt;&nbsp;0,&nbsp;then&nbsp;yh&nbsp;&gt;=&nbsp;b^2&nbsp;and&nbsp;thus&nbsp;y&nbsp;&gt;=&nbsp;b^2.&nbsp;Then&nbsp;k&#39;&nbsp;=&nbsp;k*2&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;be&nbsp;a&nbsp;larger&nbsp;valid&nbsp;threshold&nbsp;contradicting&nbsp;the&nbsp;assumption&nbsp;about&nbsp;k.</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">k</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">t</span>&nbsp;<span class="ident">nat</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;add&nbsp;x0*y1*b</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x0</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">x0</span><span class="op">.</span><span class="ident">norm</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">y1</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">y</span><span class="op">[</span><span class="ident">k</span><span class="op">:</span><span class="op">]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;y1&nbsp;is&nbsp;normalized&nbsp;because&nbsp;y&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">mul</span><span class="op">(</span><span class="ident">x0</span><span class="op">,</span>&nbsp;<span class="ident">y1</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;update&nbsp;t&nbsp;so&nbsp;we&nbsp;don&#39;t&nbsp;lose&nbsp;t&#39;s&nbsp;underlying&nbsp;array</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">addAt</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">k</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;add&nbsp;xi*y0&lt;&lt;i,&nbsp;xi*y1*b&lt;&lt;(i+k)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">y0</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">y0</span><span class="op">.</span><span class="ident">norm</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">k</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">k</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">xi</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">x</span><span class="op">[</span><span class="ident">i</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">xi</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">k</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">xi</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">xi</span><span class="op">[</span><span class="op">:</span><span class="ident">k</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">xi</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">xi</span><span class="op">.</span><span class="ident">norm</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">mul</span><span class="op">(</span><span class="ident">xi</span><span class="op">,</span>&nbsp;<span class="ident">y0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">addAt</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">i</span><span class="op">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">mul</span><span class="op">(</span><span class="ident">xi</span><span class="op">,</span>&nbsp;<span class="ident">y1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">addAt</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">i</span><span class="op">+</span><span class="ident">k</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">norm</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;mulRange&nbsp;computes&nbsp;the&nbsp;product&nbsp;of&nbsp;all&nbsp;the&nbsp;unsigned&nbsp;integers&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;range&nbsp;[a,&nbsp;b]&nbsp;inclusively.&nbsp;If&nbsp;a&nbsp;&gt;&nbsp;b&nbsp;(empty&nbsp;range),&nbsp;the&nbsp;result&nbsp;is&nbsp;1.</span><br>
<span class="lineno">465</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">mulRange</span><span class="op">(</span><span class="ident">a</span><span class="op">,</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="ident">uint64</span><span class="op">)</span>&nbsp;<span class="ident">nat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">a</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;cut&nbsp;long&nbsp;ranges&nbsp;short&nbsp;(optimization)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">setUint64</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">a</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">b</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">setUint64</span><span class="op">(</span><span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">a</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">b</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">setUint64</span><span class="op">(</span><span class="ident">a</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">a</span><span class="op">+</span><span class="num">1</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">b</span><span class="op">:</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">mul</span><span class="op">(</span><span class="ident">nat</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">.</span><span class="ident">setUint64</span><span class="op">(</span><span class="ident">a</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">nat</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">.</span><span class="ident">setUint64</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">(</span><span class="ident">a</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">b</span><span class="op">)</span>&nbsp;<span class="op">/</span>&nbsp;<span class="num">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">mul</span><span class="op">(</span><span class="ident">nat</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">.</span><span class="ident">mulRange</span><span class="op">(</span><span class="ident">a</span><span class="op">,</span>&nbsp;<span class="ident">m</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">nat</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">.</span><span class="ident">mulRange</span><span class="op">(</span><span class="ident">m</span><span class="op">+</span><span class="num">1</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;q&nbsp;=&nbsp;(x-r)/y,&nbsp;with&nbsp;0&nbsp;&lt;=&nbsp;r&nbsp;&lt;&nbsp;y</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">divW</span><span class="op">(</span><span class="ident">x</span>&nbsp;<span class="ident">nat</span><span class="op">,</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="ident">Word</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">q</span>&nbsp;<span class="ident">nat</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="ident">Word</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;division&nbsp;by&nbsp;zero&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">1</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">set</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;result&nbsp;is&nbsp;x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="num">0</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;result&nbsp;is&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;m&nbsp;&gt;&nbsp;0</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="ident">m</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">divWVW</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">norm</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">div</span><span class="op">(</span><span class="ident">z2</span><span class="op">,</span>&nbsp;<span class="ident">u</span><span class="op">,</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">q</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">v</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;division&nbsp;by&nbsp;zero&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">505</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">u</span><span class="op">.</span><span class="ident">cmp</span><span class="op">(</span><span class="ident">v</span><span class="op">)</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z2</span><span class="op">.</span><span class="ident">set</span><span class="op">(</span><span class="ident">u</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">v</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">r2</span>&nbsp;<span class="ident">Word</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span><span class="op">,</span>&nbsp;<span class="ident">r2</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">divW</span><span class="op">(</span><span class="ident">u</span><span class="op">,</span>&nbsp;<span class="ident">v</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z2</span><span class="op">.</span><span class="ident">setWord</span><span class="op">(</span><span class="ident">r2</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">divLarge</span><span class="op">(</span><span class="ident">z2</span><span class="op">,</span>&nbsp;<span class="ident">u</span><span class="op">,</span>&nbsp;<span class="ident">v</span><span class="op">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;q&nbsp;=&nbsp;(uIn-r)/v,&nbsp;with&nbsp;0&nbsp;&lt;=&nbsp;r&nbsp;&lt;&nbsp;y</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Uses&nbsp;z&nbsp;as&nbsp;storage&nbsp;for&nbsp;q,&nbsp;and&nbsp;u&nbsp;as&nbsp;storage&nbsp;for&nbsp;r&nbsp;if&nbsp;possible.</span><br>
<span class="lineno">525</span><span class="comment">//&nbsp;See&nbsp;Knuth,&nbsp;Volume&nbsp;2,&nbsp;section&nbsp;4.3.1,&nbsp;Algorithm&nbsp;D.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Preconditions:</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp;len(v)&nbsp;&gt;=&nbsp;2</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp;len(uIn)&nbsp;&gt;=&nbsp;len(v)</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">divLarge</span><span class="op">(</span><span class="ident">u</span><span class="op">,</span>&nbsp;<span class="ident">uIn</span><span class="op">,</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">q</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">v</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">uIn</span><span class="op">)</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">n</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;determine&nbsp;if&nbsp;z&nbsp;can&nbsp;be&nbsp;reused</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;TODO(gri)&nbsp;should&nbsp;find&nbsp;a&nbsp;better&nbsp;solution&nbsp;-&nbsp;this&nbsp;if&nbsp;statement</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;very&nbsp;costly&nbsp;(see&nbsp;e.g.&nbsp;time&nbsp;pidigits&nbsp;-s&nbsp;-n&nbsp;10000)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">alias</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">uIn</span><span class="op">)</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">alias</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">v</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="comment">//&nbsp;z&nbsp;is&nbsp;an&nbsp;alias&nbsp;for&nbsp;uIn&nbsp;or&nbsp;v&nbsp;-&nbsp;cannot&nbsp;reuse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="ident">m</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">qhatv</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="ident">nat</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">+</span><span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">alias</span><span class="op">(</span><span class="ident">u</span><span class="op">,</span>&nbsp;<span class="ident">uIn</span><span class="op">)</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">alias</span><span class="op">(</span><span class="ident">u</span><span class="op">,</span>&nbsp;<span class="ident">v</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">u</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="comment">//&nbsp;u&nbsp;is&nbsp;an&nbsp;alias&nbsp;for&nbsp;uIn&nbsp;or&nbsp;v&nbsp;-&nbsp;cannot&nbsp;reuse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">u</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">u</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">uIn</span><span class="op">)</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">u</span><span class="op">.</span><span class="ident">clear</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;D1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">shift</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">leadingZeros</span><span class="op">(</span><span class="ident">v</span><span class="op">[</span><span class="ident">n</span><span class="op">-</span><span class="num">1</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">shift</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;do&nbsp;not&nbsp;modify&nbsp;v,&nbsp;it&nbsp;may&nbsp;be&nbsp;used&nbsp;by&nbsp;another&nbsp;goroutine&nbsp;simultaneously</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v1</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="ident">nat</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">shlVU</span><span class="op">(</span><span class="ident">v1</span><span class="op">,</span>&nbsp;<span class="ident">v</span><span class="op">,</span>&nbsp;<span class="ident">shift</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">v1</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">u</span><span class="op">[</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">uIn</span><span class="op">)</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">shlVU</span><span class="op">(</span><span class="ident">u</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">uIn</span><span class="op">)</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">uIn</span><span class="op">,</span>&nbsp;<span class="ident">shift</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;D2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">m</span><span class="op">;</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">j</span><span class="op">--</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;D3.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">qhat</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">Word</span><span class="op">(</span><span class="ident">_M</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">u</span><span class="op">[</span><span class="ident">j</span><span class="op">+</span><span class="ident">n</span><span class="op">]</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">v</span><span class="op">[</span><span class="ident">n</span><span class="op">-</span><span class="num">1</span><span class="op">]</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">rhat</span>&nbsp;<span class="ident">Word</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">qhat</span><span class="op">,</span>&nbsp;<span class="ident">rhat</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">divWW</span><span class="op">(</span><span class="ident">u</span><span class="op">[</span><span class="ident">j</span><span class="op">+</span><span class="ident">n</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">u</span><span class="op">[</span><span class="ident">j</span><span class="op">+</span><span class="ident">n</span><span class="op">-</span><span class="num">1</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">v</span><span class="op">[</span><span class="ident">n</span><span class="op">-</span><span class="num">1</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;x1&nbsp;|&nbsp;x2&nbsp;=&nbsp;q̂v_{n-2}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x1</span><span class="op">,</span>&nbsp;<span class="ident">x2</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">mulWW</span><span class="op">(</span><span class="ident">qhat</span><span class="op">,</span>&nbsp;<span class="ident">v</span><span class="op">[</span><span class="ident">n</span><span class="op">-</span><span class="num">2</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;test&nbsp;if&nbsp;q̂v_{n-2}&nbsp;&gt;&nbsp;br̂&nbsp;+&nbsp;u_{j+n-2}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">greaterThan</span><span class="op">(</span><span class="ident">x1</span><span class="op">,</span>&nbsp;<span class="ident">x2</span><span class="op">,</span>&nbsp;<span class="ident">rhat</span><span class="op">,</span>&nbsp;<span class="ident">u</span><span class="op">[</span><span class="ident">j</span><span class="op">+</span><span class="ident">n</span><span class="op">-</span><span class="num">2</span><span class="op">]</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">qhat</span><span class="op">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">prevRhat</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">rhat</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rhat</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">v</span><span class="op">[</span><span class="ident">n</span><span class="op">-</span><span class="num">1</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;v[n-1]&nbsp;&gt;=&nbsp;0,&nbsp;so&nbsp;this&nbsp;tests&nbsp;for&nbsp;overflow.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">rhat</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">prevRhat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x1</span><span class="op">,</span>&nbsp;<span class="ident">x2</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">mulWW</span><span class="op">(</span><span class="ident">qhat</span><span class="op">,</span>&nbsp;<span class="ident">v</span><span class="op">[</span><span class="ident">n</span><span class="op">-</span><span class="num">2</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">580</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;D4.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">qhatv</span><span class="op">[</span><span class="ident">n</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">mulAddVWW</span><span class="op">(</span><span class="ident">qhatv</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">n</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">v</span><span class="op">,</span>&nbsp;<span class="ident">qhat</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">subVV</span><span class="op">(</span><span class="ident">u</span><span class="op">[</span><span class="ident">j</span><span class="op">:</span><span class="ident">j</span><span class="op">+</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">qhatv</span><span class="op">)</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">u</span><span class="op">[</span><span class="ident">j</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">qhatv</span><span class="op">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">c</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">addVV</span><span class="op">(</span><span class="ident">u</span><span class="op">[</span><span class="ident">j</span><span class="op">:</span><span class="ident">j</span><span class="op">+</span><span class="ident">n</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">u</span><span class="op">[</span><span class="ident">j</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">v</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">u</span><span class="op">[</span><span class="ident">j</span><span class="op">+</span><span class="ident">n</span><span class="op">]</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">qhat</span><span class="op">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">590</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span><span class="op">[</span><span class="ident">j</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">qhat</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">q</span><span class="op">.</span><span class="ident">norm</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">shrVU</span><span class="op">(</span><span class="ident">u</span><span class="op">,</span>&nbsp;<span class="ident">u</span><span class="op">,</span>&nbsp;<span class="ident">shift</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">u</span><span class="op">.</span><span class="ident">norm</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">q</span><span class="op">,</span>&nbsp;<span class="ident">r</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">600</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Length&nbsp;of&nbsp;x&nbsp;in&nbsp;bits.&nbsp;x&nbsp;must&nbsp;be&nbsp;normalized.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">x</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">bitLen</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">i</span><span class="op">*</span><span class="ident">_W</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">bitLen</span><span class="op">(</span><span class="ident">x</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;MaxBase&nbsp;is&nbsp;the&nbsp;largest&nbsp;number&nbsp;base&nbsp;accepted&nbsp;for&nbsp;string&nbsp;conversions.</span><br>
<span class="lineno">610</span><span class="keyword">const</span>&nbsp;<span class="ident">MaxBase</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#39;z&#39;</span>&nbsp;<span class="op">-</span>&nbsp;<span class="string">&#39;a&#39;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">10</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">1</span>&nbsp;<span class="comment">//&nbsp;=&nbsp;hexValue(&#39;z&#39;)&nbsp;+&nbsp;1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">hexValue</span><span class="op">(</span><span class="ident">ch</span>&nbsp;<span class="builtintype">rune</span><span class="op">)</span>&nbsp;<span class="ident">Word</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">MaxBase</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">1</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;illegal&nbsp;base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#39;0&#39;</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="ident">ch</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">ch</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="string">&#39;9&#39;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">ch</span>&nbsp;<span class="op">-</span>&nbsp;<span class="string">&#39;0&#39;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#39;a&#39;</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="ident">ch</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">ch</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="string">&#39;z&#39;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">ch</span>&nbsp;<span class="op">-</span>&nbsp;<span class="string">&#39;a&#39;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">10</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#39;A&#39;</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="ident">ch</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">ch</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="string">&#39;Z&#39;</span><span class="op">:</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">ch</span>&nbsp;<span class="op">-</span>&nbsp;<span class="string">&#39;A&#39;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">10</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">Word</span><span class="op">(</span><span class="ident">d</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">625</span><span class="comment">//&nbsp;scan&nbsp;sets&nbsp;z&nbsp;to&nbsp;the&nbsp;natural&nbsp;number&nbsp;corresponding&nbsp;to&nbsp;the&nbsp;longest&nbsp;possible&nbsp;prefix</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;read&nbsp;from&nbsp;r&nbsp;representing&nbsp;an&nbsp;unsigned&nbsp;integer&nbsp;in&nbsp;a&nbsp;given&nbsp;conversion&nbsp;base.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;It&nbsp;returns&nbsp;z,&nbsp;the&nbsp;actual&nbsp;conversion&nbsp;base&nbsp;used,&nbsp;and&nbsp;an&nbsp;error,&nbsp;if&nbsp;any.&nbsp;In&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;error&nbsp;case,&nbsp;the&nbsp;value&nbsp;of&nbsp;z&nbsp;is&nbsp;undefined.&nbsp;The&nbsp;syntax&nbsp;follows&nbsp;the&nbsp;syntax&nbsp;of</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;unsigned&nbsp;integer&nbsp;literals&nbsp;in&nbsp;Go.</span><br>
<span class="lineno">630</span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;base&nbsp;argument&nbsp;must&nbsp;be&nbsp;0&nbsp;or&nbsp;a&nbsp;value&nbsp;from&nbsp;2&nbsp;through&nbsp;MaxBase.&nbsp;If&nbsp;the&nbsp;base</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;is&nbsp;0,&nbsp;the&nbsp;string&nbsp;prefix&nbsp;determines&nbsp;the&nbsp;actual&nbsp;conversion&nbsp;base.&nbsp;A&nbsp;prefix&nbsp;of</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;``0x&#39;&#39;&nbsp;or&nbsp;``0X&#39;&#39;&nbsp;selects&nbsp;base&nbsp;16;&nbsp;the&nbsp;``0&#39;&#39;&nbsp;prefix&nbsp;selects&nbsp;base&nbsp;8,&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;``0b&#39;&#39;&nbsp;or&nbsp;``0B&#39;&#39;&nbsp;prefix&nbsp;selects&nbsp;base&nbsp;2.&nbsp;Otherwise&nbsp;the&nbsp;selected&nbsp;base&nbsp;is&nbsp;10.</span><br>
<span class="lineno">635</span><span class="comment">//</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">scan</span><span class="op">(</span><span class="ident">r</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">RuneScanner</span><span class="op">,</span>&nbsp;<span class="ident">base</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">nat</span><span class="op">,</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;reject&nbsp;illegal&nbsp;bases</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">base</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">base</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">MaxBase</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">base</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;illegal&nbsp;number&nbsp;base&#34;</span><span class="op">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;one&nbsp;char&nbsp;look-ahead</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ch</span><span class="op">,</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ReadRune</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;determine&nbsp;base&nbsp;if&nbsp;necessary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">Word</span><span class="op">(</span><span class="ident">base</span><span class="op">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">base</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ch</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#39;0&#39;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">ch</span><span class="op">,</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ReadRune</span><span class="op">(</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">nil</span><span class="op">:</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">ch</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#39;x&#39;</span><span class="op">,</span>&nbsp;<span class="string">&#39;X&#39;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#39;b&#39;</span><span class="op">,</span>&nbsp;<span class="string">&#39;B&#39;</span><span class="op">:</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">2</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">16</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ch</span><span class="op">,</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ReadRune</span><span class="op">(</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">EOF</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="num">10</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="num">10</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;convert&nbsp;string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;-&nbsp;group&nbsp;as&nbsp;many&nbsp;digits&nbsp;d&nbsp;as&nbsp;possible&nbsp;together&nbsp;into&nbsp;a&nbsp;&#34;super-digit&#34;&nbsp;dd&nbsp;with&nbsp;&#34;super-base&#34;&nbsp;bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;-&nbsp;only&nbsp;when&nbsp;bb&nbsp;does&nbsp;not&nbsp;fit&nbsp;into&nbsp;a&nbsp;word&nbsp;anymore,&nbsp;do&nbsp;a&nbsp;full&nbsp;number&nbsp;mulAddWW&nbsp;using&nbsp;bb&nbsp;and&nbsp;dd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bb</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">Word</span><span class="op">(</span><span class="num">1</span><span class="op">)</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dd</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">Word</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">max</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">_M</span>&nbsp;<span class="op">/</span>&nbsp;<span class="ident">b</span><span class="op">;</span>&nbsp;<span class="op">;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">hexValue</span><span class="op">(</span><span class="ident">ch</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">d</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">.</span><span class="ident">UnreadRune</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;ch&nbsp;does&nbsp;not&nbsp;belong&nbsp;to&nbsp;number&nbsp;anymore</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">bb</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="ident">max</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bb</span>&nbsp;<span class="op">*=</span>&nbsp;<span class="ident">b</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dd</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">dd</span><span class="op">*</span><span class="ident">b</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;bb&nbsp;*&nbsp;b&nbsp;would&nbsp;overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">mulAddWW</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">bb</span><span class="op">,</span>&nbsp;<span class="ident">dd</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bb</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">b</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dd</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ch</span><span class="op">,</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ReadRune</span><span class="op">(</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">EOF</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">705</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">bb</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">1</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;there&nbsp;was&nbsp;at&nbsp;least&nbsp;one&nbsp;mantissa&nbsp;digit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">mulAddWW</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">bb</span><span class="op">,</span>&nbsp;<span class="ident">dd</span><span class="op">)</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">base</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">8</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;there&nbsp;was&nbsp;only&nbsp;the&nbsp;octal&nbsp;prefix&nbsp;0&nbsp;(possibly&nbsp;followed&nbsp;by&nbsp;digits&nbsp;&gt;&nbsp;7);</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;return&nbsp;base&nbsp;10,&nbsp;not&nbsp;8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="num">10</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">base</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">8</span><span class="op">:</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;there&nbsp;was&nbsp;neither&nbsp;a&nbsp;mantissa&nbsp;digit&nbsp;nor&nbsp;the&nbsp;octal&nbsp;prefix&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;syntax&nbsp;error&nbsp;scanning&nbsp;number&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">norm</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno">720</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Character&nbsp;sets&nbsp;for&nbsp;string&nbsp;conversion.</span><br>
<span class="lineno"></span><span class="keyword">const</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lowercaseDigits</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#34;0123456789abcdefghijklmnopqrstuvwxyz&#34;</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">uppercaseDigits</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#34;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&#34;</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;decimalString&nbsp;returns&nbsp;a&nbsp;decimal&nbsp;representation&nbsp;of&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;It&nbsp;calls&nbsp;x.string&nbsp;with&nbsp;the&nbsp;charset&nbsp;&#34;0123456789&#34;.</span><br>
<span class="lineno">730</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">x</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">decimalString</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="builtintype">string</span><span class="op">(</span><span class="ident">lowercaseDigits</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="num">10</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;string&nbsp;converts&nbsp;x&nbsp;to&nbsp;a&nbsp;string&nbsp;using&nbsp;digits&nbsp;from&nbsp;a&nbsp;charset;&nbsp;a&nbsp;digit&nbsp;with</span><br>
<span class="lineno">735</span><span class="comment">//&nbsp;value&nbsp;d&nbsp;is&nbsp;represented&nbsp;by&nbsp;charset[d].&nbsp;The&nbsp;conversion&nbsp;base&nbsp;is&nbsp;determined</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;by&nbsp;len(charset),&nbsp;which&nbsp;must&nbsp;be&nbsp;&gt;=&nbsp;2&nbsp;and&nbsp;&lt;=&nbsp;256.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">x</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span><span class="op">(</span><span class="ident">charset</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">Word</span><span class="op">(</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">charset</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;special&nbsp;cases</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">2</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">MaxBase</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">256</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;illegal&nbsp;base&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span><span class="op">:</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="builtintype">string</span><span class="op">(</span><span class="ident">charset</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;allocate&nbsp;buffer&nbsp;for&nbsp;conversion</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="builtintype">float64</span><span class="op">(</span><span class="ident">x</span><span class="op">.</span><span class="ident">bitLen</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="ident">math</span><span class="op">.</span><span class="ident">Log2</span><span class="op">(</span><span class="builtintype">float64</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">1</span>&nbsp;<span class="comment">//&nbsp;off&nbsp;by&nbsp;one&nbsp;at&nbsp;most</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">i</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;convert&nbsp;power&nbsp;of&nbsp;two&nbsp;and&nbsp;non&nbsp;power&nbsp;of&nbsp;two&nbsp;bases&nbsp;separately</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">b</span><span class="op">&amp;</span><span class="op">-</span><span class="ident">b</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;shift&nbsp;is&nbsp;base-b&nbsp;digit&nbsp;size&nbsp;in&nbsp;bits</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">shift</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">trailingZeroBits</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;shift&nbsp;&gt;&nbsp;0&nbsp;because&nbsp;b&nbsp;&gt;=&nbsp;2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mask</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">Word</span><span class="op">(</span><span class="num">1</span><span class="op">)</span><span class="op">&lt;&lt;</span><span class="ident">shift</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">x</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nbits</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">uint</span><span class="op">(</span><span class="ident">_W</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;number&nbsp;of&nbsp;unprocessed&nbsp;bits&nbsp;in&nbsp;w</span><br>
<span class="lineno"></span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;convert&nbsp;less-significant&nbsp;words</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">k</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">1</span><span class="op">;</span>&nbsp;<span class="ident">k</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">k</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;convert&nbsp;full&nbsp;digits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">nbits</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="ident">shift</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">--</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">charset</span><span class="op">[</span><span class="ident">w</span><span class="op">&amp;</span><span class="ident">mask</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span>&nbsp;<span class="op">&gt;&gt;=</span>&nbsp;<span class="ident">shift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nbits</span>&nbsp;<span class="op">-=</span>&nbsp;<span class="ident">shift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;convert&nbsp;any&nbsp;partial&nbsp;leading&nbsp;digit&nbsp;and&nbsp;advance&nbsp;to&nbsp;next&nbsp;word</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">nbits</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;no&nbsp;partial&nbsp;digit&nbsp;remaining,&nbsp;just&nbsp;advance</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">x</span><span class="op">[</span><span class="ident">k</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nbits</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">_W</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;partial&nbsp;digit&nbsp;in&nbsp;current&nbsp;(k-1)&nbsp;and&nbsp;next&nbsp;(k)&nbsp;word</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span>&nbsp;<span class="op">|=</span>&nbsp;<span class="ident">x</span><span class="op">[</span><span class="ident">k</span><span class="op">]</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="ident">nbits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">charset</span><span class="op">[</span><span class="ident">w</span><span class="op">&amp;</span><span class="ident">mask</span><span class="op">]</span><br>
<span class="lineno">780</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;advance</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">x</span><span class="op">[</span><span class="ident">k</span><span class="op">]</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="op">(</span><span class="ident">shift</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">nbits</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nbits</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">_W</span>&nbsp;<span class="op">-</span>&nbsp;<span class="op">(</span><span class="ident">shift</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">nbits</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;convert&nbsp;digits&nbsp;of&nbsp;most-significant&nbsp;word&nbsp;(omit&nbsp;leading&nbsp;zeros)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">nbits</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">w</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">--</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">charset</span><span class="op">[</span><span class="ident">w</span><span class="op">&amp;</span><span class="ident">mask</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span>&nbsp;<span class="op">&gt;&gt;=</span>&nbsp;<span class="ident">shift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nbits</span>&nbsp;<span class="op">-=</span>&nbsp;<span class="ident">shift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;determine&nbsp;&#34;big&nbsp;base&#34;;&nbsp;i.e.,&nbsp;the&nbsp;largest&nbsp;possible&nbsp;value&nbsp;bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;that&nbsp;is&nbsp;a&nbsp;power&nbsp;of&nbsp;base&nbsp;b&nbsp;and&nbsp;still&nbsp;fits&nbsp;into&nbsp;a&nbsp;Word</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;(as&nbsp;in&nbsp;10^19&nbsp;for&nbsp;19&nbsp;decimal&nbsp;digits&nbsp;in&nbsp;a&nbsp;64bit&nbsp;Word)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bb</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;big&nbsp;base&nbsp;is&nbsp;b**ndigits</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ndigits</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="comment">//&nbsp;number&nbsp;of&nbsp;base&nbsp;b&nbsp;digits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">max</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">Word</span><span class="op">(</span><span class="ident">_M</span>&nbsp;<span class="op">/</span>&nbsp;<span class="ident">b</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">bb</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="ident">max</span><span class="op">;</span>&nbsp;<span class="ident">bb</span>&nbsp;<span class="op">*=</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ndigits</span><span class="op">++</span>&nbsp;<span class="comment">//&nbsp;maximize&nbsp;ndigits&nbsp;where&nbsp;bb&nbsp;=&nbsp;b**ndigits,&nbsp;bb&nbsp;&lt;=&nbsp;_M</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;construct&nbsp;table&nbsp;of&nbsp;successive&nbsp;squares&nbsp;of&nbsp;bb*leafSize&nbsp;to&nbsp;use&nbsp;in&nbsp;subdivisions</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;result&nbsp;(table&nbsp;!=&nbsp;nil)&nbsp;&lt;=&gt;&nbsp;(len(x)&nbsp;&gt;&nbsp;leafSize&nbsp;&gt;&nbsp;0)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">table</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">divisors</span><span class="op">(</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">ndigits</span><span class="op">,</span>&nbsp;<span class="ident">bb</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;preserve&nbsp;x,&nbsp;create&nbsp;local&nbsp;copy&nbsp;for&nbsp;use&nbsp;by&nbsp;convertWords</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">nat</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">.</span><span class="ident">set</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;convert&nbsp;q&nbsp;to&nbsp;string&nbsp;s&nbsp;in&nbsp;base&nbsp;b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span><span class="op">.</span><span class="ident">convertWords</span><span class="op">(</span><span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">charset</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">ndigits</span><span class="op">,</span>&nbsp;<span class="ident">bb</span><span class="op">,</span>&nbsp;<span class="ident">table</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;strip&nbsp;leading&nbsp;zeros</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;(x&nbsp;!=&nbsp;0;&nbsp;thus&nbsp;s&nbsp;must&nbsp;contain&nbsp;at&nbsp;least&nbsp;one&nbsp;non-zero&nbsp;digit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;and&nbsp;the&nbsp;loop&nbsp;will&nbsp;terminate)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">zero</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">charset</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">;</span>&nbsp;<span class="ident">s</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">zero</span><span class="op">;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="builtintype">string</span><span class="op">(</span><span class="ident">s</span><span class="op">[</span><span class="ident">i</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno">825</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Convert&nbsp;words&nbsp;of&nbsp;q&nbsp;to&nbsp;base&nbsp;b&nbsp;digits&nbsp;in&nbsp;s.&nbsp;If&nbsp;q&nbsp;is&nbsp;large,&nbsp;it&nbsp;is&nbsp;recursively&nbsp;&#34;split&nbsp;in&nbsp;half&#34;</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;by&nbsp;nat/nat&nbsp;division&nbsp;using&nbsp;tabulated&nbsp;divisors.&nbsp;Otherwise,&nbsp;it&nbsp;is&nbsp;converted&nbsp;iteratively&nbsp;using</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;repeated&nbsp;nat/Word&nbsp;division.</span><br>
<span class="lineno">830</span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;iterative&nbsp;method&nbsp;processes&nbsp;n&nbsp;Words&nbsp;by&nbsp;n&nbsp;divW()&nbsp;calls,&nbsp;each&nbsp;of&nbsp;which&nbsp;visits&nbsp;every&nbsp;Word&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;incrementally&nbsp;shortened&nbsp;q&nbsp;for&nbsp;a&nbsp;total&nbsp;of&nbsp;n&nbsp;+&nbsp;(n-1)&nbsp;+&nbsp;(n-2)&nbsp;...&nbsp;+&nbsp;2&nbsp;+&nbsp;1,&nbsp;or&nbsp;n(n+1)/2&nbsp;divW()&#39;s.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Recursive&nbsp;conversion&nbsp;divides&nbsp;q&nbsp;by&nbsp;its&nbsp;approximate&nbsp;square&nbsp;root,&nbsp;yielding&nbsp;two&nbsp;parts,&nbsp;each&nbsp;half</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;the&nbsp;size&nbsp;of&nbsp;q.&nbsp;Using&nbsp;the&nbsp;iterative&nbsp;method&nbsp;on&nbsp;both&nbsp;halves&nbsp;means&nbsp;2&nbsp;*&nbsp;(n/2)(n/2&nbsp;+&nbsp;1)/2&nbsp;divW()&#39;s</span><br>
<span class="lineno">835</span><span class="comment">//&nbsp;plus&nbsp;the&nbsp;expensive&nbsp;long&nbsp;div().&nbsp;Asymptotically,&nbsp;the&nbsp;ratio&nbsp;is&nbsp;favorable&nbsp;at&nbsp;1/2&nbsp;the&nbsp;divW()&#39;s,&nbsp;and</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;is&nbsp;made&nbsp;better&nbsp;by&nbsp;splitting&nbsp;the&nbsp;subblocks&nbsp;recursively.&nbsp;Best&nbsp;is&nbsp;to&nbsp;split&nbsp;blocks&nbsp;until&nbsp;one&nbsp;more</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;split&nbsp;would&nbsp;take&nbsp;longer&nbsp;(because&nbsp;of&nbsp;the&nbsp;nat/nat&nbsp;div())&nbsp;than&nbsp;the&nbsp;twice&nbsp;as&nbsp;many&nbsp;divW()&#39;s&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;iterative&nbsp;approach.&nbsp;This&nbsp;threshold&nbsp;is&nbsp;represented&nbsp;by&nbsp;leafSize.&nbsp;Benchmarking&nbsp;of&nbsp;leafSize&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;range&nbsp;2..64&nbsp;shows&nbsp;that&nbsp;values&nbsp;of&nbsp;8&nbsp;and&nbsp;16&nbsp;work&nbsp;well,&nbsp;with&nbsp;a&nbsp;4x&nbsp;speedup&nbsp;at&nbsp;medium&nbsp;lengths&nbsp;and</span><br>
<span class="lineno">840</span><span class="comment">//&nbsp;~30x&nbsp;for&nbsp;20000&nbsp;digits.&nbsp;Use&nbsp;nat_test.go&#39;s&nbsp;BenchmarkLeafSize&nbsp;tests&nbsp;to&nbsp;optimize&nbsp;leafSize&nbsp;for</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;specific&nbsp;hardware.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">q</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">convertWords</span><span class="op">(</span><span class="ident">s</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">charset</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="ident">Word</span><span class="op">,</span>&nbsp;<span class="ident">ndigits</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">bb</span>&nbsp;<span class="ident">Word</span><span class="op">,</span>&nbsp;<span class="ident">table</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">divisor</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;split&nbsp;larger&nbsp;blocks&nbsp;recursively</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">table</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;len(q)&nbsp;&gt;&nbsp;leafSize&nbsp;&gt;&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="ident">nat</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">index</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">table</span><span class="op">)</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">q</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">leafSize</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;find&nbsp;divisor&nbsp;close&nbsp;to&nbsp;sqrt(q)&nbsp;if&nbsp;possible,&nbsp;but&nbsp;in&nbsp;any&nbsp;case&nbsp;&lt;&nbsp;q</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">maxLength</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">q</span><span class="op">.</span><span class="ident">bitLen</span><span class="op">(</span><span class="op">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;~=&nbsp;log2&nbsp;q,&nbsp;or&nbsp;at&nbsp;of&nbsp;least&nbsp;largest&nbsp;possible&nbsp;q&nbsp;of&nbsp;this&nbsp;bit&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">minLength</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">maxLength</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="num">1</span>&nbsp;<span class="comment">//&nbsp;~=&nbsp;log2&nbsp;sqrt(q)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">index</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">table</span><span class="op">[</span><span class="ident">index</span><span class="op">-</span><span class="num">1</span><span class="op">]</span><span class="op">.</span><span class="ident">nbits</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">minLength</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">index</span><span class="op">--</span>&nbsp;<span class="comment">//&nbsp;desired</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">table</span><span class="op">[</span><span class="ident">index</span><span class="op">]</span><span class="op">.</span><span class="ident">nbits</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="ident">maxLength</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">table</span><span class="op">[</span><span class="ident">index</span><span class="op">]</span><span class="op">.</span><span class="ident">bbb</span><span class="op">.</span><span class="ident">cmp</span><span class="op">(</span><span class="ident">q</span><span class="op">)</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">index</span><span class="op">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">index</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;internal&nbsp;inconsistency&#34;</span><span class="op">)</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;split&nbsp;q&nbsp;into&nbsp;the&nbsp;two&nbsp;digit&nbsp;number&nbsp;(q&#39;*bbb&nbsp;+&nbsp;r)&nbsp;to&nbsp;form&nbsp;independent&nbsp;subblocks</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">q</span><span class="op">.</span><span class="ident">div</span><span class="op">(</span><span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">q</span><span class="op">,</span>&nbsp;<span class="ident">table</span><span class="op">[</span><span class="ident">index</span><span class="op">]</span><span class="op">.</span><span class="ident">bbb</span><span class="op">)</span><br>
<span class="lineno">865</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;convert&nbsp;subblocks&nbsp;and&nbsp;collect&nbsp;results&nbsp;in&nbsp;s[:h]&nbsp;and&nbsp;s[h:]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">h</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">s</span><span class="op">)</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">table</span><span class="op">[</span><span class="ident">index</span><span class="op">]</span><span class="op">.</span><span class="ident">ndigits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">.</span><span class="ident">convertWords</span><span class="op">(</span><span class="ident">s</span><span class="op">[</span><span class="ident">h</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">charset</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">ndigits</span><span class="op">,</span>&nbsp;<span class="ident">bb</span><span class="op">,</span>&nbsp;<span class="ident">table</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">index</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">s</span><span class="op">[</span><span class="op">:</span><span class="ident">h</span><span class="op">]</span>&nbsp;<span class="comment">//&nbsp;==&nbsp;q.convertWords(s,&nbsp;charset,&nbsp;b,&nbsp;ndigits,&nbsp;bb,&nbsp;table[0:index+1])</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;having&nbsp;split&nbsp;any&nbsp;large&nbsp;blocks&nbsp;now&nbsp;process&nbsp;the&nbsp;remaining&nbsp;(small)&nbsp;block&nbsp;iteratively</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">s</span><span class="op">)</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="ident">Word</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">10</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;hard-coding&nbsp;for&nbsp;10&nbsp;here&nbsp;speeds&nbsp;this&nbsp;up&nbsp;by&nbsp;1.25x&nbsp;(allows&nbsp;for&nbsp;/&nbsp;and&nbsp;%&nbsp;by&nbsp;constants)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">q</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;extract&nbsp;least&nbsp;significant,&nbsp;base&nbsp;bb&nbsp;&#34;digit&#34;</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">q</span><span class="op">.</span><span class="ident">divW</span><span class="op">(</span><span class="ident">q</span><span class="op">,</span>&nbsp;<span class="ident">bb</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">ndigits</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">j</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;avoid&nbsp;%&nbsp;computation&nbsp;since&nbsp;r%10&nbsp;==&nbsp;r&nbsp;-&nbsp;int(r/10)*10;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;this&nbsp;appears&nbsp;to&nbsp;be&nbsp;faster&nbsp;for&nbsp;BenchmarkString10000Base10</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;and&nbsp;smaller&nbsp;strings&nbsp;(but&nbsp;a&nbsp;bit&nbsp;slower&nbsp;for&nbsp;larger&nbsp;ones)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">/</span>&nbsp;<span class="num">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">charset</span><span class="op">[</span><span class="ident">r</span><span class="op">-</span><span class="ident">t</span><span class="op">&lt;&lt;</span><span class="num">3</span><span class="op">-</span><span class="ident">t</span><span class="op">-</span><span class="ident">t</span><span class="op">]</span>&nbsp;<span class="comment">//&nbsp;TODO(gri)&nbsp;replace&nbsp;w/&nbsp;t*10&nbsp;once&nbsp;compiler&nbsp;produces&nbsp;better&nbsp;code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">q</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;extract&nbsp;least&nbsp;significant,&nbsp;base&nbsp;bb&nbsp;&#34;digit&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">q</span><span class="op">.</span><span class="ident">divW</span><span class="op">(</span><span class="ident">q</span><span class="op">,</span>&nbsp;<span class="ident">bb</span><span class="op">)</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">ndigits</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">j</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">charset</span><span class="op">[</span><span class="ident">r</span><span class="op">%</span><span class="ident">b</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">/=</span>&nbsp;<span class="ident">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;prepend&nbsp;high-order&nbsp;zeroes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">zero</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">charset</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span>&nbsp;<span class="comment">//&nbsp;while&nbsp;need&nbsp;more&nbsp;leading&nbsp;zeroes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">910</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Split&nbsp;blocks&nbsp;greater&nbsp;than&nbsp;leafSize&nbsp;Words&nbsp;(or&nbsp;set&nbsp;to&nbsp;0&nbsp;to&nbsp;disable&nbsp;recursive&nbsp;conversion)</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Benchmark&nbsp;and&nbsp;configure&nbsp;leafSize&nbsp;using:&nbsp;go&nbsp;test&nbsp;-bench=&#34;Leaf&#34;</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;8&nbsp;and&nbsp;16&nbsp;effective&nbsp;on&nbsp;3.0&nbsp;GHz&nbsp;Xeon&nbsp;&#34;Clovertown&#34;&nbsp;CPU&nbsp;(128&nbsp;byte&nbsp;cache&nbsp;lines)</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;8&nbsp;and&nbsp;16&nbsp;effective&nbsp;on&nbsp;2.66&nbsp;GHz&nbsp;Core&nbsp;2&nbsp;Duo&nbsp;&#34;Penryn&#34;&nbsp;CPU</span><br>
<span class="lineno">915</span><span class="keyword">var</span>&nbsp;<span class="ident">leafSize</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">8</span>&nbsp;<span class="comment">//&nbsp;number&nbsp;of&nbsp;Word-size&nbsp;binary&nbsp;values&nbsp;treat&nbsp;as&nbsp;a&nbsp;monolithic&nbsp;block</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">divisor</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bbb</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">nat</span>&nbsp;<span class="comment">//&nbsp;divisor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nbits</span>&nbsp;&nbsp;&nbsp;<span class="builtintype">int</span>&nbsp;<span class="comment">//&nbsp;bit&nbsp;length&nbsp;of&nbsp;divisor&nbsp;(discounting&nbsp;leading&nbsp;zeroes)&nbsp;~=&nbsp;log2(bbb)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ndigits</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="comment">//&nbsp;digit&nbsp;length&nbsp;of&nbsp;divisor&nbsp;in&nbsp;terms&nbsp;of&nbsp;output&nbsp;base&nbsp;digits</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">cacheBase10</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sync</span><span class="op">.</span><span class="ident">Mutex</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">table</span>&nbsp;<span class="op">[</span><span class="num">64</span><span class="op">]</span><span class="ident">divisor</span>&nbsp;<span class="comment">//&nbsp;cached&nbsp;divisors&nbsp;for&nbsp;base&nbsp;10</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;expWW&nbsp;computes&nbsp;x**y</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">expWW</span><span class="op">(</span><span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="ident">Word</span><span class="op">)</span>&nbsp;<span class="ident">nat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">expNN</span><span class="op">(</span><span class="ident">nat</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">.</span><span class="ident">setWord</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">nat</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">.</span><span class="ident">setWord</span><span class="op">(</span><span class="ident">y</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;construct&nbsp;table&nbsp;of&nbsp;powers&nbsp;of&nbsp;bb*leafSize&nbsp;to&nbsp;use&nbsp;in&nbsp;subdivisions</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">divisors</span><span class="op">(</span><span class="ident">m</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="ident">Word</span><span class="op">,</span>&nbsp;<span class="ident">ndigits</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">bb</span>&nbsp;<span class="ident">Word</span><span class="op">)</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">divisor</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;only&nbsp;compute&nbsp;table&nbsp;when&nbsp;recursive&nbsp;conversion&nbsp;is&nbsp;enabled&nbsp;and&nbsp;x&nbsp;is&nbsp;large</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">leafSize</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="ident">leafSize</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;determine&nbsp;k&nbsp;where&nbsp;(bb**leafSize)**(2**k)&nbsp;&gt;=&nbsp;sqrt(x)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">k</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">words</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">leafSize</span><span class="op">;</span>&nbsp;<span class="ident">words</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">m</span><span class="op">&gt;&gt;</span><span class="num">1</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">k</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">cacheBase10</span><span class="op">.</span><span class="ident">table</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">words</span>&nbsp;<span class="op">&lt;&lt;=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">k</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">945</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;reuse&nbsp;and&nbsp;extend&nbsp;existing&nbsp;table&nbsp;of&nbsp;divisors&nbsp;or&nbsp;create&nbsp;new&nbsp;table&nbsp;as&nbsp;appropriate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">table</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">divisor</span>&nbsp;<span class="comment">//&nbsp;for&nbsp;b&nbsp;==&nbsp;10,&nbsp;table&nbsp;overlaps&nbsp;with&nbsp;cacheBase10.table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">10</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cacheBase10</span><span class="op">.</span><span class="ident">Lock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">table</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">cacheBase10</span><span class="op">.</span><span class="ident">table</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">k</span><span class="op">]</span>&nbsp;<span class="comment">//&nbsp;reuse&nbsp;old&nbsp;table&nbsp;for&nbsp;this&nbsp;conversion</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">table</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="ident">divisor</span><span class="op">,</span>&nbsp;<span class="ident">k</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;create&nbsp;new&nbsp;table&nbsp;for&nbsp;this&nbsp;conversion</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;extend&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">table</span><span class="op">[</span><span class="ident">k</span><span class="op">-</span><span class="num">1</span><span class="op">]</span><span class="op">.</span><span class="ident">ndigits</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;add&nbsp;new&nbsp;entries&nbsp;as&nbsp;needed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">larger</span>&nbsp;<span class="ident">nat</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">k</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">table</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">.</span><span class="ident">ndigits</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">table</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="ident">bbb</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nat</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">.</span><span class="ident">expWW</span><span class="op">(</span><span class="ident">bb</span><span class="op">,</span>&nbsp;<span class="ident">Word</span><span class="op">(</span><span class="ident">leafSize</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">table</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="ident">ndigits</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">ndigits</span>&nbsp;<span class="op">*</span>&nbsp;<span class="ident">leafSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">table</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">.</span><span class="ident">bbb</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nat</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">.</span><span class="ident">mul</span><span class="op">(</span><span class="ident">table</span><span class="op">[</span><span class="ident">i</span><span class="op">-</span><span class="num">1</span><span class="op">]</span><span class="op">.</span><span class="ident">bbb</span><span class="op">,</span>&nbsp;<span class="ident">table</span><span class="op">[</span><span class="ident">i</span><span class="op">-</span><span class="num">1</span><span class="op">]</span><span class="op">.</span><span class="ident">bbb</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">table</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">.</span><span class="ident">ndigits</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">2</span>&nbsp;<span class="op">*</span>&nbsp;<span class="ident">table</span><span class="op">[</span><span class="ident">i</span><span class="op">-</span><span class="num">1</span><span class="op">]</span><span class="op">.</span><span class="ident">ndigits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;optimization:&nbsp;exploit&nbsp;aggregated&nbsp;extra&nbsp;bits&nbsp;in&nbsp;macro&nbsp;blocks</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">larger</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nat</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">.</span><span class="ident">set</span><span class="op">(</span><span class="ident">table</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">.</span><span class="ident">bbb</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">mulAddVWW</span><span class="op">(</span><span class="ident">larger</span><span class="op">,</span>&nbsp;<span class="ident">larger</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">table</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">.</span><span class="ident">bbb</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">table</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">.</span><span class="ident">bbb</span><span class="op">.</span><span class="ident">set</span><span class="op">(</span><span class="ident">larger</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">table</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">.</span><span class="ident">ndigits</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">975</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">table</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">.</span><span class="ident">nbits</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">table</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">.</span><span class="ident">bbb</span><span class="op">.</span><span class="ident">bitLen</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">980</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">10</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cacheBase10</span><span class="op">.</span><span class="ident">Unlock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">table</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">const</span>&nbsp;<span class="ident">deBruijn32</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0x077CB531</span><br>
<span class="lineno"></span><br>
<span class="lineno">990</span><span class="keyword">var</span>&nbsp;<span class="ident">deBruijn32Lookup</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">28</span><span class="op">,</span>&nbsp;<span class="num">2</span><span class="op">,</span>&nbsp;<span class="num">29</span><span class="op">,</span>&nbsp;<span class="num">14</span><span class="op">,</span>&nbsp;<span class="num">24</span><span class="op">,</span>&nbsp;<span class="num">3</span><span class="op">,</span>&nbsp;<span class="num">30</span><span class="op">,</span>&nbsp;<span class="num">22</span><span class="op">,</span>&nbsp;<span class="num">20</span><span class="op">,</span>&nbsp;<span class="num">15</span><span class="op">,</span>&nbsp;<span class="num">25</span><span class="op">,</span>&nbsp;<span class="num">17</span><span class="op">,</span>&nbsp;<span class="num">4</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">31</span><span class="op">,</span>&nbsp;<span class="num">27</span><span class="op">,</span>&nbsp;<span class="num">13</span><span class="op">,</span>&nbsp;<span class="num">23</span><span class="op">,</span>&nbsp;<span class="num">21</span><span class="op">,</span>&nbsp;<span class="num">19</span><span class="op">,</span>&nbsp;<span class="num">16</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">26</span><span class="op">,</span>&nbsp;<span class="num">12</span><span class="op">,</span>&nbsp;<span class="num">18</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">11</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">,</span>&nbsp;<span class="num">10</span><span class="op">,</span>&nbsp;<span class="num">9</span><span class="op">,</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">995</span><span class="keyword">const</span>&nbsp;<span class="ident">deBruijn64</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0x03f79d71b4ca8b09</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">deBruijn64Lookup</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">56</span><span class="op">,</span>&nbsp;<span class="num">2</span><span class="op">,</span>&nbsp;<span class="num">57</span><span class="op">,</span>&nbsp;<span class="num">49</span><span class="op">,</span>&nbsp;<span class="num">28</span><span class="op">,</span>&nbsp;<span class="num">3</span><span class="op">,</span>&nbsp;<span class="num">61</span><span class="op">,</span>&nbsp;<span class="num">58</span><span class="op">,</span>&nbsp;<span class="num">42</span><span class="op">,</span>&nbsp;<span class="num">50</span><span class="op">,</span>&nbsp;<span class="num">38</span><span class="op">,</span>&nbsp;<span class="num">29</span><span class="op">,</span>&nbsp;<span class="num">17</span><span class="op">,</span>&nbsp;<span class="num">4</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">62</span><span class="op">,</span>&nbsp;<span class="num">47</span><span class="op">,</span>&nbsp;<span class="num">59</span><span class="op">,</span>&nbsp;<span class="num">36</span><span class="op">,</span>&nbsp;<span class="num">45</span><span class="op">,</span>&nbsp;<span class="num">43</span><span class="op">,</span>&nbsp;<span class="num">51</span><span class="op">,</span>&nbsp;<span class="num">22</span><span class="op">,</span>&nbsp;<span class="num">53</span><span class="op">,</span>&nbsp;<span class="num">39</span><span class="op">,</span>&nbsp;<span class="num">33</span><span class="op">,</span>&nbsp;<span class="num">30</span><span class="op">,</span>&nbsp;<span class="num">24</span><span class="op">,</span>&nbsp;<span class="num">18</span><span class="op">,</span>&nbsp;<span class="num">12</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">,</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">63</span><span class="op">,</span>&nbsp;<span class="num">55</span><span class="op">,</span>&nbsp;<span class="num">48</span><span class="op">,</span>&nbsp;<span class="num">27</span><span class="op">,</span>&nbsp;<span class="num">60</span><span class="op">,</span>&nbsp;<span class="num">41</span><span class="op">,</span>&nbsp;<span class="num">37</span><span class="op">,</span>&nbsp;<span class="num">16</span><span class="op">,</span>&nbsp;<span class="num">46</span><span class="op">,</span>&nbsp;<span class="num">35</span><span class="op">,</span>&nbsp;<span class="num">44</span><span class="op">,</span>&nbsp;<span class="num">21</span><span class="op">,</span>&nbsp;<span class="num">52</span><span class="op">,</span>&nbsp;<span class="num">32</span><span class="op">,</span>&nbsp;<span class="num">23</span><span class="op">,</span>&nbsp;<span class="num">11</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">54</span><span class="op">,</span>&nbsp;<span class="num">26</span><span class="op">,</span>&nbsp;<span class="num">40</span><span class="op">,</span>&nbsp;<span class="num">15</span><span class="op">,</span>&nbsp;<span class="num">34</span><span class="op">,</span>&nbsp;<span class="num">20</span><span class="op">,</span>&nbsp;<span class="num">31</span><span class="op">,</span>&nbsp;<span class="num">10</span><span class="op">,</span>&nbsp;<span class="num">25</span><span class="op">,</span>&nbsp;<span class="num">14</span><span class="op">,</span>&nbsp;<span class="num">19</span><span class="op">,</span>&nbsp;<span class="num">9</span><span class="op">,</span>&nbsp;<span class="num">13</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;trailingZeroBits&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;consecutive&nbsp;least&nbsp;significant&nbsp;zero</span><br>
<span class="lineno">1005</span><span class="comment">//&nbsp;bits&nbsp;of&nbsp;x.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">trailingZeroBits</span><span class="op">(</span><span class="ident">x</span>&nbsp;<span class="ident">Word</span><span class="op">)</span>&nbsp;<span class="builtintype">uint</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;x&nbsp;&amp;&nbsp;-x&nbsp;leaves&nbsp;only&nbsp;the&nbsp;right-most&nbsp;bit&nbsp;set&nbsp;in&nbsp;the&nbsp;word.&nbsp;Let&nbsp;k&nbsp;be&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;index&nbsp;of&nbsp;that&nbsp;bit.&nbsp;Since&nbsp;only&nbsp;a&nbsp;single&nbsp;bit&nbsp;is&nbsp;set,&nbsp;the&nbsp;value&nbsp;is&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;to&nbsp;the&nbsp;power&nbsp;of&nbsp;k.&nbsp;Multiplying&nbsp;by&nbsp;a&nbsp;power&nbsp;of&nbsp;two&nbsp;is&nbsp;equivalent&nbsp;to</span><br>
<span class="lineno">1010</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;left&nbsp;shifting,&nbsp;in&nbsp;this&nbsp;case&nbsp;by&nbsp;k&nbsp;bits.&nbsp;&nbsp;The&nbsp;de&nbsp;Bruijn&nbsp;constant&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;such&nbsp;that&nbsp;all&nbsp;six&nbsp;bit,&nbsp;consecutive&nbsp;substrings&nbsp;are&nbsp;distinct.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Therefore,&nbsp;if&nbsp;we&nbsp;have&nbsp;a&nbsp;left&nbsp;shifted&nbsp;version&nbsp;of&nbsp;this&nbsp;constant&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;find&nbsp;by&nbsp;how&nbsp;many&nbsp;bits&nbsp;it&nbsp;was&nbsp;shifted&nbsp;by&nbsp;looking&nbsp;at&nbsp;which&nbsp;six&nbsp;bit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;substring&nbsp;ended&nbsp;up&nbsp;at&nbsp;the&nbsp;top&nbsp;of&nbsp;the&nbsp;word.</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;(Knuth,&nbsp;volume&nbsp;4,&nbsp;section&nbsp;7.3.1)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">_W</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="num">32</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="builtintype">uint</span><span class="op">(</span><span class="ident">deBruijn32Lookup</span><span class="op">[</span><span class="op">(</span><span class="op">(</span><span class="ident">x</span><span class="op">&amp;</span><span class="op">-</span><span class="ident">x</span><span class="op">)</span><span class="op">*</span><span class="ident">deBruijn32</span><span class="op">)</span><span class="op">&gt;&gt;</span><span class="num">27</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="num">64</span><span class="op">:</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="builtintype">uint</span><span class="op">(</span><span class="ident">deBruijn64Lookup</span><span class="op">[</span><span class="op">(</span><span class="op">(</span><span class="ident">x</span><span class="op">&amp;</span><span class="op">-</span><span class="ident">x</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="ident">deBruijn64</span><span class="op">&amp;</span><span class="ident">_M</span><span class="op">)</span><span class="op">)</span><span class="op">&gt;&gt;</span><span class="num">58</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;unknown&nbsp;word&nbsp;size&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">1025</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;trailingZeroBits&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;consecutive&nbsp;least&nbsp;significant&nbsp;zero</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;bits&nbsp;of&nbsp;x.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">x</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">trailingZeroBits</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">uint</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="builtintype">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">x</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">++</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;x[i]&nbsp;!=&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">i</span><span class="op">*</span><span class="ident">_W</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">trailingZeroBits</span><span class="op">(</span><span class="ident">x</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1040</span><span class="comment">//&nbsp;z&nbsp;=&nbsp;x&nbsp;&lt;&lt;&nbsp;s</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">shl</span><span class="op">(</span><span class="ident">x</span>&nbsp;<span class="ident">nat</span><span class="op">,</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="builtintype">uint</span><span class="op">)</span>&nbsp;<span class="ident">nat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;m&nbsp;&gt;&nbsp;0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">+</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">s</span><span class="op">/</span><span class="ident">_W</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="ident">n</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">[</span><span class="ident">n</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">shlVU</span><span class="op">(</span><span class="ident">z</span><span class="op">[</span><span class="ident">n</span><span class="op">-</span><span class="ident">m</span><span class="op">:</span><span class="ident">n</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">s</span><span class="op">%</span><span class="ident">_W</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">[</span><span class="num">0</span>&nbsp;<span class="op">:</span>&nbsp;<span class="ident">n</span><span class="op">-</span><span class="ident">m</span><span class="op">]</span><span class="op">.</span><span class="ident">clear</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">norm</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">1055</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;z&nbsp;=&nbsp;x&nbsp;&gt;&gt;&nbsp;s</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">shr</span><span class="op">(</span><span class="ident">x</span>&nbsp;<span class="ident">nat</span><span class="op">,</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="builtintype">uint</span><span class="op">)</span>&nbsp;<span class="ident">nat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">-</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">s</span><span class="op">/</span><span class="ident">_W</span><span class="op">)</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;n&nbsp;&gt;&nbsp;0</span><br>
<span class="lineno"></span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="ident">n</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">shrVU</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">[</span><span class="ident">m</span><span class="op">-</span><span class="ident">n</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">s</span><span class="op">%</span><span class="ident">_W</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">norm</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">1070</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">setBit</span><span class="op">(</span><span class="ident">x</span>&nbsp;<span class="ident">nat</span><span class="op">,</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="builtintype">uint</span><span class="op">,</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="builtintype">uint</span><span class="op">)</span>&nbsp;<span class="ident">nat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">j</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">/</span>&nbsp;<span class="ident">_W</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">Word</span><span class="op">(</span><span class="num">1</span><span class="op">)</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">%</span>&nbsp;<span class="ident">_W</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="num">0</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="ident">n</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">copy</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;no&nbsp;need&nbsp;to&nbsp;grow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">[</span><span class="ident">j</span><span class="op">]</span>&nbsp;<span class="op">&amp;^=</span>&nbsp;<span class="ident">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">norm</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="num">1</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="ident">j</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">[</span><span class="ident">n</span><span class="op">:</span><span class="op">]</span><span class="op">.</span><span class="ident">clear</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="ident">n</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">copy</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">[</span><span class="ident">j</span><span class="op">]</span>&nbsp;<span class="op">|=</span>&nbsp;<span class="ident">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;no&nbsp;need&nbsp;to&nbsp;normalize</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;set&nbsp;bit&nbsp;is&nbsp;not&nbsp;0&nbsp;or&nbsp;1&#34;</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1100</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">bit</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="builtintype">uint</span><span class="op">)</span>&nbsp;<span class="builtintype">uint</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">j</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">/</span>&nbsp;<span class="ident">_W</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">z</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="builtintype">uint</span><span class="op">(</span><span class="ident">z</span><span class="op">[</span><span class="ident">j</span><span class="op">]</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">%</span>&nbsp;<span class="ident">_W</span><span class="op">)</span>&nbsp;<span class="op">&amp;</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">and</span><span class="op">(</span><span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">nat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">y</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;m&nbsp;&lt;=&nbsp;n</span><br>
<span class="lineno">1115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="ident">m</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">m</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">x</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">&amp;</span>&nbsp;<span class="ident">y</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">1120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">norm</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">andNot</span><span class="op">(</span><span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">nat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">y</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;m&nbsp;&gt;=&nbsp;n</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="ident">m</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">n</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">x</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">&amp;^</span>&nbsp;<span class="ident">y</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">copy</span><span class="op">(</span><span class="ident">z</span><span class="op">[</span><span class="ident">n</span><span class="op">:</span><span class="ident">m</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">[</span><span class="ident">n</span><span class="op">:</span><span class="ident">m</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">norm</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">1140</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">or</span><span class="op">(</span><span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">nat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">y</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">x</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">m</span><span class="op">,</span>&nbsp;<span class="ident">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;m&nbsp;&gt;=&nbsp;n</span><br>
<span class="lineno">1150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="ident">m</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">n</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">x</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">|</span>&nbsp;<span class="ident">y</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">copy</span><span class="op">(</span><span class="ident">z</span><span class="op">[</span><span class="ident">n</span><span class="op">:</span><span class="ident">m</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">s</span><span class="op">[</span><span class="ident">n</span><span class="op">:</span><span class="ident">m</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">norm</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1160</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">xor</span><span class="op">(</span><span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">nat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">y</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">m</span><span class="op">,</span>&nbsp;<span class="ident">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;m&nbsp;&gt;=&nbsp;n</span><br>
<span class="lineno"></span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="ident">m</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">n</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">x</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">^</span>&nbsp;<span class="ident">y</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">copy</span><span class="op">(</span><span class="ident">z</span><span class="op">[</span><span class="ident">n</span><span class="op">:</span><span class="ident">m</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">s</span><span class="op">[</span><span class="ident">n</span><span class="op">:</span><span class="ident">m</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">norm</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;greaterThan&nbsp;returns&nbsp;true&nbsp;iff&nbsp;(x1&lt;&lt;_W&nbsp;+&nbsp;x2)&nbsp;&gt;&nbsp;(y1&lt;&lt;_W&nbsp;+&nbsp;y2)</span><br>
<span class="lineno">1180</span><span class="keyword">func</span>&nbsp;<span class="ident">greaterThan</span><span class="op">(</span><span class="ident">x1</span><span class="op">,</span>&nbsp;<span class="ident">x2</span><span class="op">,</span>&nbsp;<span class="ident">y1</span><span class="op">,</span>&nbsp;<span class="ident">y2</span>&nbsp;<span class="ident">Word</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">x1</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">y1</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">x1</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">y1</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">x2</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">y2</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;modW&nbsp;returns&nbsp;x&nbsp;%&nbsp;d.</span><br>
<span class="lineno">1185</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">x</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">modW</span><span class="op">(</span><span class="ident">d</span>&nbsp;<span class="ident">Word</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="ident">Word</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;TODO(agl):&nbsp;we&nbsp;don&#39;t&nbsp;actually&nbsp;need&nbsp;to&nbsp;store&nbsp;the&nbsp;q&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">q</span>&nbsp;<span class="ident">nat</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">q</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">divWVW</span><span class="op">(</span><span class="ident">q</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">d</span><span class="op">)</span><br>
<span class="lineno">1190</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;random&nbsp;creates&nbsp;a&nbsp;random&nbsp;integer&nbsp;in&nbsp;[0..limit),&nbsp;using&nbsp;the&nbsp;space&nbsp;in&nbsp;z&nbsp;if</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;possible.&nbsp;n&nbsp;is&nbsp;the&nbsp;bit&nbsp;length&nbsp;of&nbsp;limit.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">random</span><span class="op">(</span><span class="ident">rand</span>&nbsp;<span class="op">*</span><span class="ident">rand</span><span class="op">.</span><span class="ident">Rand</span><span class="op">,</span>&nbsp;<span class="ident">limit</span>&nbsp;<span class="ident">nat</span><span class="op">,</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="ident">nat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">alias</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">limit</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="comment">//&nbsp;z&nbsp;is&nbsp;an&nbsp;alias&nbsp;for&nbsp;limit&nbsp;-&nbsp;cannot&nbsp;reuse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">limit</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bitLengthOfMSW</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">uint</span><span class="op">(</span><span class="ident">n</span>&nbsp;<span class="op">%</span>&nbsp;<span class="ident">_W</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">bitLengthOfMSW</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bitLengthOfMSW</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">_W</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mask</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">Word</span><span class="op">(</span><span class="op">(</span><span class="num">1</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="ident">bitLengthOfMSW</span><span class="op">)</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno">1205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">_W</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="num">32</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">z</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">Word</span><span class="op">(</span><span class="ident">rand</span><span class="op">.</span><span class="ident">Uint32</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="num">64</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">z</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">Word</span><span class="op">(</span><span class="ident">rand</span><span class="op">.</span><span class="ident">Uint32</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">|</span>&nbsp;<span class="ident">Word</span><span class="op">(</span><span class="ident">rand</span><span class="op">.</span><span class="ident">Uint32</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">&lt;&lt;</span><span class="num">32</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;unknown&nbsp;word&nbsp;size&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">[</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">limit</span><span class="op">)</span><span class="op">-</span><span class="num">1</span><span class="op">]</span>&nbsp;<span class="op">&amp;=</span>&nbsp;<span class="ident">mask</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">cmp</span><span class="op">(</span><span class="ident">limit</span><span class="op">)</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">norm</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;m&nbsp;!=&nbsp;0&nbsp;(i.e.,&nbsp;len(m)&nbsp;!=&nbsp;0),&nbsp;expNN&nbsp;sets&nbsp;z&nbsp;to&nbsp;x**y&nbsp;mod&nbsp;m;</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;otherwise&nbsp;it&nbsp;sets&nbsp;z&nbsp;to&nbsp;x**y.&nbsp;The&nbsp;result&nbsp;is&nbsp;the&nbsp;value&nbsp;of&nbsp;z.</span><br>
<span class="lineno">1230</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">expNN</span><span class="op">(</span><span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span><span class="op">,</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">nat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">alias</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">)</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">alias</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">y</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&nbsp;cannot&nbsp;allow&nbsp;in-place&nbsp;modification&nbsp;of&nbsp;x&nbsp;or&nbsp;y.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">1235</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;x**y&nbsp;mod&nbsp;1&nbsp;==&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">m</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">m</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">setWord</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;m&nbsp;==&nbsp;0&nbsp;||&nbsp;m&nbsp;&gt;&nbsp;1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;x**0&nbsp;==&nbsp;1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">y</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">setWord</span><span class="op">(</span><span class="num">1</span><span class="op">)</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;y&nbsp;&gt;&nbsp;0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">m</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&nbsp;likely&nbsp;end&nbsp;up&nbsp;being&nbsp;as&nbsp;long&nbsp;as&nbsp;the&nbsp;modulus.</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">m</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">set</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;If&nbsp;the&nbsp;base&nbsp;is&nbsp;non-trivial&nbsp;and&nbsp;the&nbsp;exponent&nbsp;is&nbsp;large,&nbsp;we&nbsp;use</span><br>
<span class="lineno">1255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;4-bit,&nbsp;windowed&nbsp;exponentiation.&nbsp;This&nbsp;involves&nbsp;precomputing&nbsp;14&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;(x^2...x^15)&nbsp;but&nbsp;then&nbsp;reduces&nbsp;the&nbsp;number&nbsp;of&nbsp;multiply-reduces&nbsp;by&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;third.&nbsp;Even&nbsp;for&nbsp;a&nbsp;32-bit&nbsp;exponent,&nbsp;this&nbsp;reduces&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">y</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">m</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">1260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">expNNWindowed</span><span class="op">(</span><span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span><span class="op">,</span>&nbsp;<span class="ident">m</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">y</span><span class="op">[</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">y</span><span class="op">)</span><span class="op">-</span><span class="num">1</span><span class="op">]</span>&nbsp;<span class="comment">//&nbsp;v&nbsp;&gt;&nbsp;0&nbsp;because&nbsp;y&nbsp;is&nbsp;normalized&nbsp;and&nbsp;y&nbsp;&gt;&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">shift</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">leadingZeros</span><span class="op">(</span><span class="ident">v</span><span class="op">)</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">1</span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span>&nbsp;<span class="op">&lt;&lt;=</span>&nbsp;<span class="ident">shift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">q</span>&nbsp;<span class="ident">nat</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">const</span>&nbsp;<span class="ident">mask</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="op">(</span><span class="ident">_W</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&nbsp;walk&nbsp;through&nbsp;the&nbsp;bits&nbsp;of&nbsp;the&nbsp;exponent&nbsp;one&nbsp;by&nbsp;one.&nbsp;Each&nbsp;time&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;see&nbsp;a&nbsp;bit,&nbsp;we&nbsp;square,&nbsp;thus&nbsp;doubling&nbsp;the&nbsp;power.&nbsp;If&nbsp;the&nbsp;bit&nbsp;is&nbsp;a&nbsp;one,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;we&nbsp;also&nbsp;multiply&nbsp;by&nbsp;x,&nbsp;thus&nbsp;adding&nbsp;one&nbsp;to&nbsp;the&nbsp;power.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">_W</span>&nbsp;<span class="op">-</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">shift</span><span class="op">)</span><br>
<span class="lineno">1275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;zz&nbsp;and&nbsp;r&nbsp;are&nbsp;used&nbsp;to&nbsp;avoid&nbsp;allocating&nbsp;in&nbsp;mul&nbsp;and&nbsp;div&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;otherwise&nbsp;the&nbsp;arguments&nbsp;would&nbsp;alias.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">zz</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="ident">nat</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">w</span><span class="op">;</span>&nbsp;<span class="ident">j</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">zz</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">zz</span><span class="op">.</span><span class="ident">mul</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">z</span><span class="op">)</span><br>
<span class="lineno">1280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">zz</span><span class="op">,</span>&nbsp;<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">zz</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">v</span><span class="op">&amp;</span><span class="ident">mask</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">zz</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">zz</span><span class="op">.</span><span class="ident">mul</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">zz</span><span class="op">,</span>&nbsp;<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">zz</span><br>
<span class="lineno">1285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">m</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">zz</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">zz</span><span class="op">.</span><span class="ident">div</span><span class="op">(</span><span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">m</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">zz</span><span class="op">,</span>&nbsp;<span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">q</span><span class="op">,</span>&nbsp;<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">q</span><span class="op">,</span>&nbsp;<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">zz</span><span class="op">,</span>&nbsp;<span class="ident">r</span><br>
<span class="lineno">1290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span>&nbsp;<span class="op">&lt;&lt;=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">y</span><span class="op">)</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">2</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">--</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">y</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">_W</span><span class="op">;</span>&nbsp;<span class="ident">j</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">zz</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">zz</span><span class="op">.</span><span class="ident">mul</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">z</span><span class="op">)</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">zz</span><span class="op">,</span>&nbsp;<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">zz</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">v</span><span class="op">&amp;</span><span class="ident">mask</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">zz</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">zz</span><span class="op">.</span><span class="ident">mul</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">zz</span><span class="op">,</span>&nbsp;<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">zz</span><br>
<span class="lineno">1305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">m</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">zz</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">zz</span><span class="op">.</span><span class="ident">div</span><span class="op">(</span><span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">m</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">zz</span><span class="op">,</span>&nbsp;<span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">q</span><span class="op">,</span>&nbsp;<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">q</span><span class="op">,</span>&nbsp;<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">zz</span><span class="op">,</span>&nbsp;<span class="ident">r</span><br>
<span class="lineno">1310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span>&nbsp;<span class="op">&lt;&lt;=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">1315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">norm</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;expNNWindowed&nbsp;calculates&nbsp;x**y&nbsp;mod&nbsp;m&nbsp;using&nbsp;a&nbsp;fixed,&nbsp;4-bit&nbsp;window.</span><br>
<span class="lineno">1320</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">expNNWindowed</span><span class="op">(</span><span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span><span class="op">,</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">nat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;zz&nbsp;and&nbsp;r&nbsp;are&nbsp;used&nbsp;to&nbsp;avoid&nbsp;allocating&nbsp;in&nbsp;mul&nbsp;and&nbsp;div&nbsp;as&nbsp;otherwise</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;the&nbsp;arguments&nbsp;would&nbsp;alias.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">zz</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="ident">nat</span><br>
<span class="lineno"></span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">const</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;powers[i]&nbsp;contains&nbsp;x^i.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">powers</span>&nbsp;<span class="op">[</span><span class="num">1</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="ident">n</span><span class="op">]</span><span class="ident">nat</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">powers</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">natOne</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">powers</span><span class="op">[</span><span class="num">1</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">x</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">2</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">1</span><span class="op">&lt;&lt;</span><span class="ident">n</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="num">2</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">p2</span><span class="op">,</span>&nbsp;<span class="ident">p</span><span class="op">,</span>&nbsp;<span class="ident">p1</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">powers</span><span class="op">[</span><span class="ident">i</span><span class="op">/</span><span class="num">2</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">powers</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">powers</span><span class="op">[</span><span class="ident">i</span><span class="op">+</span><span class="num">1</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">*</span><span class="ident">p</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">mul</span><span class="op">(</span><span class="op">*</span><span class="ident">p2</span><span class="op">,</span>&nbsp;<span class="op">*</span><span class="ident">p2</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">zz</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">zz</span><span class="op">.</span><span class="ident">div</span><span class="op">(</span><span class="ident">r</span><span class="op">,</span>&nbsp;<span class="op">*</span><span class="ident">p</span><span class="op">,</span>&nbsp;<span class="ident">m</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">*</span><span class="ident">p</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">r</span><span class="op">,</span>&nbsp;<span class="op">*</span><span class="ident">p</span><br>
<span class="lineno">1335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">*</span><span class="ident">p1</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">p1</span><span class="op">.</span><span class="ident">mul</span><span class="op">(</span><span class="op">*</span><span class="ident">p</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">zz</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">zz</span><span class="op">.</span><span class="ident">div</span><span class="op">(</span><span class="ident">r</span><span class="op">,</span>&nbsp;<span class="op">*</span><span class="ident">p1</span><span class="op">,</span>&nbsp;<span class="ident">m</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">*</span><span class="ident">p1</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">r</span><span class="op">,</span>&nbsp;<span class="op">*</span><span class="ident">p1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">setWord</span><span class="op">(</span><span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">y</span><span class="op">)</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">--</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">yi</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">y</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">_W</span><span class="op">;</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">y</span><span class="op">)</span><span class="op">-</span><span class="num">1</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Unrolled&nbsp;loop&nbsp;for&nbsp;significant&nbsp;performance</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;gain.&nbsp;&nbsp;Use&nbsp;go&nbsp;test&nbsp;-bench=&#34;.*&#34;&nbsp;in&nbsp;crypto/rsa</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;to&nbsp;check&nbsp;performance&nbsp;before&nbsp;making&nbsp;changes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">zz</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">zz</span><span class="op">.</span><span class="ident">mul</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">z</span><span class="op">)</span><br>
<span class="lineno">1350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">zz</span><span class="op">,</span>&nbsp;<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">zz</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">zz</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">zz</span><span class="op">.</span><span class="ident">div</span><span class="op">(</span><span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">m</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">z</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">zz</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">zz</span><span class="op">.</span><span class="ident">mul</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">z</span><span class="op">)</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">zz</span><span class="op">,</span>&nbsp;<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">zz</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">zz</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">zz</span><span class="op">.</span><span class="ident">div</span><span class="op">(</span><span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">m</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">z</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">zz</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">zz</span><span class="op">.</span><span class="ident">mul</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">z</span><span class="op">)</span><br>
<span class="lineno">1360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">zz</span><span class="op">,</span>&nbsp;<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">zz</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">zz</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">zz</span><span class="op">.</span><span class="ident">div</span><span class="op">(</span><span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">m</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">z</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">zz</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">zz</span><span class="op">.</span><span class="ident">mul</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">z</span><span class="op">)</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">zz</span><span class="op">,</span>&nbsp;<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">zz</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">zz</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">zz</span><span class="op">.</span><span class="ident">div</span><span class="op">(</span><span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">m</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">z</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">zz</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">zz</span><span class="op">.</span><span class="ident">mul</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">powers</span><span class="op">[</span><span class="ident">yi</span><span class="op">&gt;&gt;</span><span class="op">(</span><span class="ident">_W</span><span class="op">-</span><span class="ident">n</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">zz</span><span class="op">,</span>&nbsp;<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">zz</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">zz</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">zz</span><span class="op">.</span><span class="ident">div</span><span class="op">(</span><span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">m</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">z</span><br>
<span class="lineno"></span><br>
<span class="lineno">1375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">yi</span>&nbsp;<span class="op">&lt;&lt;=</span>&nbsp;<span class="ident">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">norm</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">1380</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;probablyPrime&nbsp;performs&nbsp;reps&nbsp;Miller-Rabin&nbsp;tests&nbsp;to&nbsp;check&nbsp;whether&nbsp;n&nbsp;is&nbsp;prime.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;it&nbsp;returns&nbsp;true,&nbsp;n&nbsp;is&nbsp;prime&nbsp;with&nbsp;probability&nbsp;1&nbsp;-&nbsp;1/4^reps.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;it&nbsp;returns&nbsp;false,&nbsp;n&nbsp;is&nbsp;not&nbsp;prime.</span><br>
<span class="lineno">1385</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">n</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">probablyPrime</span><span class="op">(</span><span class="ident">reps</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">n</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">n</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">2</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">%</span><span class="num">2</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">n</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&nbsp;have&nbsp;to&nbsp;exclude&nbsp;these&nbsp;cases&nbsp;because&nbsp;we&nbsp;reject&nbsp;all</span><br>
<span class="lineno">1400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;multiples&nbsp;of&nbsp;these&nbsp;numbers&nbsp;below.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">n</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="num">3</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">11</span><span class="op">,</span>&nbsp;<span class="num">13</span><span class="op">,</span>&nbsp;<span class="num">17</span><span class="op">,</span>&nbsp;<span class="num">19</span><span class="op">,</span>&nbsp;<span class="num">23</span><span class="op">,</span>&nbsp;<span class="num">29</span><span class="op">,</span>&nbsp;<span class="num">31</span><span class="op">,</span>&nbsp;<span class="num">37</span><span class="op">,</span>&nbsp;<span class="num">41</span><span class="op">,</span>&nbsp;<span class="num">43</span><span class="op">,</span>&nbsp;<span class="num">47</span><span class="op">,</span>&nbsp;<span class="num">53</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">1405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">const</span>&nbsp;<span class="ident">primesProduct32</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0xC0CFD797</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Π&nbsp;{p&nbsp;∈&nbsp;primes,&nbsp;2&nbsp;&lt;&nbsp;p&nbsp;&lt;=&nbsp;29}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">const</span>&nbsp;<span class="ident">primesProduct64</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0xE221F97C30E94E1D</span>&nbsp;<span class="comment">//&nbsp;Π&nbsp;{p&nbsp;∈&nbsp;primes,&nbsp;2&nbsp;&lt;&nbsp;p&nbsp;&lt;=&nbsp;53}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="ident">Word</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">_W</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="num">32</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">n</span><span class="op">.</span><span class="ident">modW</span><span class="op">(</span><span class="ident">primesProduct32</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="num">64</span><span class="op">:</span><br>
<span class="lineno">1415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">n</span><span class="op">.</span><span class="ident">modW</span><span class="op">(</span><span class="ident">primesProduct64</span>&nbsp;<span class="op">&amp;</span>&nbsp;<span class="ident">_M</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;Unknown&nbsp;word&nbsp;size&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">r</span><span class="op">%</span><span class="num">3</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">r</span><span class="op">%</span><span class="num">5</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">r</span><span class="op">%</span><span class="num">7</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">r</span><span class="op">%</span><span class="num">11</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">%</span><span class="num">13</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">r</span><span class="op">%</span><span class="num">17</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">r</span><span class="op">%</span><span class="num">19</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">r</span><span class="op">%</span><span class="num">23</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">r</span><span class="op">%</span><span class="num">29</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">_W</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">64</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="op">(</span><span class="ident">r</span><span class="op">%</span><span class="num">31</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">r</span><span class="op">%</span><span class="num">37</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">r</span><span class="op">%</span><span class="num">41</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">%</span><span class="num">43</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">r</span><span class="op">%</span><span class="num">47</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">r</span><span class="op">%</span><span class="num">53</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nm1</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">nat</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">.</span><span class="ident">sub</span><span class="op">(</span><span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">natOne</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;determine&nbsp;q,&nbsp;k&nbsp;such&nbsp;that&nbsp;nm1&nbsp;=&nbsp;q&nbsp;&lt;&lt;&nbsp;k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">k</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">nm1</span><span class="op">.</span><span class="ident">trailingZeroBits</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">nat</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">.</span><span class="ident">shr</span><span class="op">(</span><span class="ident">nm1</span><span class="op">,</span>&nbsp;<span class="ident">k</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nm3</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">nat</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">.</span><span class="ident">sub</span><span class="op">(</span><span class="ident">nm1</span><span class="op">,</span>&nbsp;<span class="ident">natTwo</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rand</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">rand</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="ident">rand</span><span class="op">.</span><span class="ident">NewSource</span><span class="op">(</span><span class="ident">int64</span><span class="op">(</span><span class="ident">n</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span><span class="op">,</span>&nbsp;<span class="ident">quotient</span>&nbsp;<span class="ident">nat</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nm3Len</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">nm3</span><span class="op">.</span><span class="ident">bitLen</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">1440</span><br>
<span class="lineno"></span><span class="ident">NextRandom</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">reps</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">random</span><span class="op">(</span><span class="ident">rand</span><span class="op">,</span>&nbsp;<span class="ident">nm3</span><span class="op">,</span>&nbsp;<span class="ident">nm3Len</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">add</span><span class="op">(</span><span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">natTwo</span><span class="op">)</span><br>
<span class="lineno">1445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">y</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">y</span><span class="op">.</span><span class="ident">expNN</span><span class="op">(</span><span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">q</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">y</span><span class="op">.</span><span class="ident">cmp</span><span class="op">(</span><span class="ident">natOne</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">y</span><span class="op">.</span><span class="ident">cmp</span><span class="op">(</span><span class="ident">nm1</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">uint</span><span class="op">(</span><span class="num">1</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">k</span><span class="op">;</span>&nbsp;<span class="ident">j</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">1450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">y</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">y</span><span class="op">.</span><span class="ident">mul</span><span class="op">(</span><span class="ident">y</span><span class="op">,</span>&nbsp;<span class="ident">y</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">quotient</span><span class="op">,</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">quotient</span><span class="op">.</span><span class="ident">div</span><span class="op">(</span><span class="ident">y</span><span class="op">,</span>&nbsp;<span class="ident">y</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">y</span><span class="op">.</span><span class="ident">cmp</span><span class="op">(</span><span class="ident">nm1</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span>&nbsp;<span class="ident">NextRandom</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">y</span><span class="op">.</span><span class="ident">cmp</span><span class="op">(</span><span class="ident">natOne</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1465</span><span class="comment">//&nbsp;bytes&nbsp;writes&nbsp;the&nbsp;value&nbsp;of&nbsp;z&nbsp;into&nbsp;buf&nbsp;using&nbsp;big-endian&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;len(buf)&nbsp;must&nbsp;be&nbsp;&gt;=&nbsp;len(z)*_S.&nbsp;The&nbsp;value&nbsp;of&nbsp;z&nbsp;is&nbsp;encoded&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;slice&nbsp;buf[i:].&nbsp;The&nbsp;number&nbsp;i&nbsp;of&nbsp;unused&nbsp;bytes&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;buf&nbsp;is&nbsp;returned&nbsp;as&nbsp;result.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">bytes</span><span class="op">(</span><span class="ident">buf</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">i</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">1470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">buf</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">d</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">z</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">_S</span><span class="op">;</span>&nbsp;<span class="ident">j</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">buf</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">byte</span><span class="op">(</span><span class="ident">d</span><span class="op">)</span><br>
<span class="lineno">1475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span>&nbsp;<span class="op">&gt;&gt;=</span>&nbsp;<span class="num">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">buf</span><span class="op">)</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">buf</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">1480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">1485</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;setBytes&nbsp;interprets&nbsp;buf&nbsp;as&nbsp;the&nbsp;bytes&nbsp;of&nbsp;a&nbsp;big-endian&nbsp;unsigned</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;integer,&nbsp;sets&nbsp;z&nbsp;to&nbsp;that&nbsp;value,&nbsp;and&nbsp;returns&nbsp;z.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">setBytes</span><span class="op">(</span><span class="ident">buf</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="ident">nat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="op">(</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">buf</span><span class="op">)</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">_S</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><span class="op">)</span>&nbsp;<span class="op">/</span>&nbsp;<span class="ident">_S</span><span class="op">)</span><br>
<span class="lineno">1490</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">k</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">uint</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">d</span>&nbsp;<span class="ident">Word</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">buf</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">--</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">1495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span>&nbsp;<span class="op">|=</span>&nbsp;<span class="ident">Word</span><span class="op">(</span><span class="ident">buf</span><span class="op">[</span><span class="ident">i</span><span class="op">-</span><span class="num">1</span><span class="op">]</span><span class="op">)</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="ident">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="num">8</span><span class="op">;</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">_S</span><span class="op">*</span><span class="num">8</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">[</span><span class="ident">k</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">k</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">k</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">z</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">[</span><span class="ident">k</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">d</span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">norm</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span>
</div>
</body>
</html>
