<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>go/format</h2>
<ul>
<li><a href="/gostd/go/format/format.go.html">format.go</a></li>
<li><a href="/gostd/go/format/format_test.go.html">format_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5954241">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5954296">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5954350">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5954401">//&nbsp;Package&nbsp;format&nbsp;implements&nbsp;standard&nbsp;formatting&nbsp;of&nbsp;Go&nbsp;source.</span><br>
<span class="lineno"></span><span class="keyword" id="5954464">package</span>&nbsp;<span class="ident" id="5954472">format</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5954480">import</span>&nbsp;<span class="op" id="5954487">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5954490">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5954499">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5954506">&#34;go/ast&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5954516">&#34;go/parser&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5954529">&#34;go/printer&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5954543">&#34;go/token&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5954555">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5954561">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="5954571">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5954574">var</span>&nbsp;<span class="ident" id="5954578">config</span>&nbsp;<span class="op" id="5954585">=</span>&nbsp;<span class="ident" id="5954587">printer</span><span class="op" id="5954594">.</span><span class="ident" id="5954595">Config</span><span class="op" id="5954601">{</span><span class="ident" id="5954602">Mode</span><span class="op" id="5954606">:</span>&nbsp;<span class="ident" id="5954608">printer</span><span class="op" id="5954615">.</span><span class="ident" id="5954616">UseSpaces</span>&nbsp;<span class="op" id="5954626">|</span>&nbsp;<span class="ident" id="5954628">printer</span><span class="op" id="5954635">.</span><span class="ident" id="5954636">TabIndent</span><span class="op" id="5954645">,</span>&nbsp;<span class="ident" id="5954647">Tabwidth</span><span class="op" id="5954655">:</span>&nbsp;<span class="num" id="5954657">8</span><span class="op" id="5954658">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="5954661">const</span>&nbsp;<span class="ident" id="5954667">parserMode</span>&nbsp;<span class="op" id="5954678">=</span>&nbsp;<span class="ident" id="5954680">parser</span><span class="op" id="5954686">.</span><span class="ident" id="5954687">ParseComments</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5954702">//&nbsp;Node&nbsp;formats&nbsp;node&nbsp;in&nbsp;canonical&nbsp;gofmt&nbsp;style&nbsp;and&nbsp;writes&nbsp;the&nbsp;result&nbsp;to&nbsp;dst.</span><br>
<span class="lineno"></span><span class="comment" id="5954778">//</span><br>
<span class="lineno">25</span><span class="comment" id="5954781">//&nbsp;The&nbsp;node&nbsp;type&nbsp;must&nbsp;be&nbsp;*ast.File,&nbsp;*printer.CommentedNode,&nbsp;[]ast.Decl,</span><br>
<span class="lineno"></span><span class="comment" id="5954853">//&nbsp;[]ast.Stmt,&nbsp;or&nbsp;assignment-compatible&nbsp;to&nbsp;ast.Expr,&nbsp;ast.Decl,&nbsp;ast.Spec,</span><br>
<span class="lineno"></span><span class="comment" id="5954926">//&nbsp;or&nbsp;ast.Stmt.&nbsp;Node&nbsp;does&nbsp;not&nbsp;modify&nbsp;node.&nbsp;Imports&nbsp;are&nbsp;not&nbsp;sorted&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="5954996">//&nbsp;nodes&nbsp;representing&nbsp;partial&nbsp;source&nbsp;files&nbsp;(i.e.,&nbsp;if&nbsp;the&nbsp;node&nbsp;is&nbsp;not&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="5955068">//&nbsp;*ast.File&nbsp;or&nbsp;a&nbsp;*printer.CommentedNode&nbsp;not&nbsp;wrapping&nbsp;an&nbsp;*ast.File).</span><br>
<span class="lineno">30</span><span class="comment" id="5955137">//</span><br>
<span class="lineno"></span><span class="comment" id="5955140">//&nbsp;The&nbsp;function&nbsp;may&nbsp;return&nbsp;early&nbsp;(before&nbsp;the&nbsp;entire&nbsp;result&nbsp;is&nbsp;written)</span><br>
<span class="lineno"></span><span class="comment" id="5955211">//&nbsp;and&nbsp;return&nbsp;a&nbsp;formatting&nbsp;error,&nbsp;for&nbsp;instance&nbsp;due&nbsp;to&nbsp;an&nbsp;incorrect&nbsp;AST.</span><br>
<span class="lineno"></span><span class="comment" id="5955283">//</span><br>
<span class="lineno"></span><span class="keyword" id="5955286">func</span>&nbsp;<span class="ident" id="5955291">Node</span><span class="op" id="5955295">(</span><span class="ident" id="5955296">dst</span>&nbsp;<span class="ident" id="5955300">io</span><span class="op" id="5955302">.</span><span class="ident" id="5955303">Writer</span><span class="op" id="5955309">,</span>&nbsp;<span class="ident" id="5955311">fset</span>&nbsp;<span class="op" id="5955316">*</span><span class="ident" id="5955317">token</span><span class="op" id="5955322">.</span><span class="ident" id="5955323">FileSet</span><span class="op" id="5955330">,</span>&nbsp;<span class="ident" id="5955332">node</span>&nbsp;<span class="keyword" id="5955337">interface</span><span class="op" id="5955346">{</span><span class="op" id="5955347">}</span><span class="op" id="5955348">)</span>&nbsp;<span class="builtintype" id="5955350">error</span>&nbsp;<span class="op" id="5955356">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5955359">//&nbsp;Determine&nbsp;if&nbsp;we&nbsp;have&nbsp;a&nbsp;complete&nbsp;source&nbsp;file&nbsp;(file&nbsp;!=&nbsp;nil).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5955422">var</span>&nbsp;<span class="ident" id="5955426">file</span>&nbsp;<span class="op" id="5955431">*</span><span class="ident" id="5955432">ast</span><span class="op" id="5955435">.</span><span class="ident" id="5955436">File</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5955442">var</span>&nbsp;<span class="ident" id="5955446">cnode</span>&nbsp;<span class="op" id="5955452">*</span><span class="ident" id="5955453">printer</span><span class="op" id="5955460">.</span><span class="ident" id="5955461">CommentedNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5955476">switch</span>&nbsp;<span class="ident" id="5955483">n</span>&nbsp;<span class="op" id="5955485">:=</span>&nbsp;<span class="ident" id="5955488">node</span><span class="op" id="5955492">.</span><span class="op" id="5955493">(</span><span class="keyword" id="5955494">type</span><span class="op" id="5955498">)</span>&nbsp;<span class="op" id="5955500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5955503">case</span>&nbsp;<span class="op" id="5955508">*</span><span class="ident" id="5955509">ast</span><span class="op" id="5955512">.</span><span class="ident" id="5955513">File</span><span class="op" id="5955517">:</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5955521">file</span>&nbsp;<span class="op" id="5955526">=</span>&nbsp;<span class="ident" id="5955528">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5955531">case</span>&nbsp;<span class="op" id="5955536">*</span><span class="ident" id="5955537">printer</span><span class="op" id="5955544">.</span><span class="ident" id="5955545">CommentedNode</span><span class="op" id="5955558">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5955562">if</span>&nbsp;<span class="ident" id="5955565">f</span><span class="op" id="5955566">,</span>&nbsp;<span class="ident" id="5955568">ok</span>&nbsp;<span class="op" id="5955571">:=</span>&nbsp;<span class="ident" id="5955574">n</span><span class="op" id="5955575">.</span><span class="ident" id="5955576">Node</span><span class="op" id="5955580">.</span><span class="op" id="5955581">(</span><span class="op" id="5955582">*</span><span class="ident" id="5955583">ast</span><span class="op" id="5955586">.</span><span class="ident" id="5955587">File</span><span class="op" id="5955591">)</span><span class="op" id="5955592">;</span>&nbsp;<span class="ident" id="5955594">ok</span>&nbsp;<span class="op" id="5955597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5955602">file</span>&nbsp;<span class="op" id="5955607">=</span>&nbsp;<span class="ident" id="5955609">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5955614">cnode</span>&nbsp;<span class="op" id="5955620">=</span>&nbsp;<span class="ident" id="5955622">n</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5955626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5955629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5955633">//&nbsp;Sort&nbsp;imports&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5955664">if</span>&nbsp;<span class="ident" id="5955667">file</span>&nbsp;<span class="op" id="5955672">!=</span>&nbsp;<span class="ident" id="5955675">nil</span>&nbsp;<span class="op" id="5955679">&amp;&amp;</span>&nbsp;<span class="ident" id="5955682">hasUnsortedImports</span><span class="op" id="5955700">(</span><span class="ident" id="5955701">file</span><span class="op" id="5955705">)</span>&nbsp;<span class="op" id="5955707">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5955711">//&nbsp;Make&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;AST&nbsp;because&nbsp;ast.SortImports&nbsp;is&nbsp;destructive.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5955779">//&nbsp;TODO(gri)&nbsp;Do&nbsp;this&nbsp;more&nbsp;efficiently.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5955820">var</span>&nbsp;<span class="ident" id="5955824">buf</span>&nbsp;<span class="ident" id="5955828">bytes</span><span class="op" id="5955833">.</span><span class="ident" id="5955834">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5955843">err</span>&nbsp;<span class="op" id="5955847">:=</span>&nbsp;<span class="ident" id="5955850">config</span><span class="op" id="5955856">.</span><span class="ident" id="5955857">Fprint</span><span class="op" id="5955863">(</span><span class="op" id="5955864">&amp;</span><span class="ident" id="5955865">buf</span><span class="op" id="5955868">,</span>&nbsp;<span class="ident" id="5955870">fset</span><span class="op" id="5955874">,</span>&nbsp;<span class="ident" id="5955876">file</span><span class="op" id="5955880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5955884">if</span>&nbsp;<span class="ident" id="5955887">err</span>&nbsp;<span class="op" id="5955891">!=</span>&nbsp;<span class="ident" id="5955894">nil</span>&nbsp;<span class="op" id="5955898">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5955903">return</span>&nbsp;<span class="ident" id="5955910">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5955916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5955920">file</span><span class="op" id="5955924">,</span>&nbsp;<span class="ident" id="5955926">err</span>&nbsp;<span class="op" id="5955930">=</span>&nbsp;<span class="ident" id="5955932">parser</span><span class="op" id="5955938">.</span><span class="ident" id="5955939">ParseFile</span><span class="op" id="5955948">(</span><span class="ident" id="5955949">fset</span><span class="op" id="5955953">,</span>&nbsp;<span class="string" id="5955955">&#34;&#34;</span><span class="op" id="5955957">,</span>&nbsp;<span class="ident" id="5955959">buf</span><span class="op" id="5955962">.</span><span class="ident" id="5955963">Bytes</span><span class="op" id="5955968">(</span><span class="op" id="5955969">)</span><span class="op" id="5955970">,</span>&nbsp;<span class="ident" id="5955972">parserMode</span><span class="op" id="5955982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5955986">if</span>&nbsp;<span class="ident" id="5955989">err</span>&nbsp;<span class="op" id="5955993">!=</span>&nbsp;<span class="ident" id="5955996">nil</span>&nbsp;<span class="op" id="5956000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5956005">//&nbsp;We&nbsp;should&nbsp;never&nbsp;get&nbsp;here.&nbsp;If&nbsp;we&nbsp;do,&nbsp;provide&nbsp;good&nbsp;diagnostic.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5956072">return</span>&nbsp;<span class="ident" id="5956079">fmt</span><span class="op" id="5956082">.</span><span class="ident" id="5956083">Errorf</span><span class="op" id="5956089">(</span><span class="string" id="5956090">&#34;format.Node&nbsp;internal&nbsp;error&nbsp;(%s)&#34;</span><span class="op" id="5956123">,</span>&nbsp;<span class="ident" id="5956125">err</span><span class="op" id="5956128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5956132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5956136">ast</span><span class="op" id="5956139">.</span><span class="ident" id="5956140">SortImports</span><span class="op" id="5956151">(</span><span class="ident" id="5956152">fset</span><span class="op" id="5956156">,</span>&nbsp;<span class="ident" id="5956158">file</span><span class="op" id="5956162">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5956167">//&nbsp;Use&nbsp;new&nbsp;file&nbsp;with&nbsp;sorted&nbsp;imports.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5956206">node</span>&nbsp;<span class="op" id="5956211">=</span>&nbsp;<span class="ident" id="5956213">file</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5956220">if</span>&nbsp;<span class="ident" id="5956223">cnode</span>&nbsp;<span class="op" id="5956229">!=</span>&nbsp;<span class="ident" id="5956232">nil</span>&nbsp;<span class="op" id="5956236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5956241">node</span>&nbsp;<span class="op" id="5956246">=</span>&nbsp;<span class="op" id="5956248">&amp;</span><span class="ident" id="5956249">printer</span><span class="op" id="5956256">.</span><span class="ident" id="5956257">CommentedNode</span><span class="op" id="5956270">{</span><span class="ident" id="5956271">Node</span><span class="op" id="5956275">:</span>&nbsp;<span class="ident" id="5956277">file</span><span class="op" id="5956281">,</span>&nbsp;<span class="ident" id="5956283">Comments</span><span class="op" id="5956291">:</span>&nbsp;<span class="ident" id="5956293">cnode</span><span class="op" id="5956298">.</span><span class="ident" id="5956299">Comments</span><span class="op" id="5956307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5956311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5956314">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5956318">return</span>&nbsp;<span class="ident" id="5956325">config</span><span class="op" id="5956331">.</span><span class="ident" id="5956332">Fprint</span><span class="op" id="5956338">(</span><span class="ident" id="5956339">dst</span><span class="op" id="5956342">,</span>&nbsp;<span class="ident" id="5956344">fset</span><span class="op" id="5956348">,</span>&nbsp;<span class="ident" id="5956350">node</span><span class="op" id="5956354">)</span><br>
<span class="lineno"></span><span class="op" id="5956356">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5956359">//&nbsp;Source&nbsp;formats&nbsp;src&nbsp;in&nbsp;canonical&nbsp;gofmt&nbsp;style&nbsp;and&nbsp;returns&nbsp;the&nbsp;result</span><br>
<span class="lineno">75</span><span class="comment" id="5956429">//&nbsp;or&nbsp;an&nbsp;(I/O&nbsp;or&nbsp;syntax)&nbsp;error.&nbsp;src&nbsp;is&nbsp;expected&nbsp;to&nbsp;be&nbsp;a&nbsp;syntactically</span><br>
<span class="lineno"></span><span class="comment" id="5956499">//&nbsp;correct&nbsp;Go&nbsp;source&nbsp;file,&nbsp;or&nbsp;a&nbsp;list&nbsp;of&nbsp;Go&nbsp;declarations&nbsp;or&nbsp;statements.</span><br>
<span class="lineno"></span><span class="comment" id="5956570">//</span><br>
<span class="lineno"></span><span class="comment" id="5956573">//&nbsp;If&nbsp;src&nbsp;is&nbsp;a&nbsp;partial&nbsp;source&nbsp;file,&nbsp;the&nbsp;leading&nbsp;and&nbsp;trailing&nbsp;space&nbsp;of&nbsp;src</span><br>
<span class="lineno"></span><span class="comment" id="5956647">//&nbsp;is&nbsp;applied&nbsp;to&nbsp;the&nbsp;result&nbsp;(such&nbsp;that&nbsp;it&nbsp;has&nbsp;the&nbsp;same&nbsp;leading&nbsp;and&nbsp;trailing</span><br>
<span class="lineno">80</span><span class="comment" id="5956723">//&nbsp;space&nbsp;as&nbsp;src),&nbsp;and&nbsp;the&nbsp;result&nbsp;is&nbsp;indented&nbsp;by&nbsp;the&nbsp;same&nbsp;amount&nbsp;as&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="5956800">//&nbsp;line&nbsp;of&nbsp;src&nbsp;containing&nbsp;code.&nbsp;Imports&nbsp;are&nbsp;not&nbsp;sorted&nbsp;for&nbsp;partial&nbsp;source&nbsp;files.</span><br>
<span class="lineno"></span><span class="comment" id="5956881">//</span><br>
<span class="lineno"></span><span class="keyword" id="5956884">func</span>&nbsp;<span class="ident" id="5956889">Source</span><span class="op" id="5956895">(</span><span class="ident" id="5956896">src</span>&nbsp;<span class="op" id="5956900">[</span><span class="op" id="5956901">]</span><span class="builtintype" id="5956902">byte</span><span class="op" id="5956906">)</span>&nbsp;<span class="op" id="5956908">(</span><span class="op" id="5956909">[</span><span class="op" id="5956910">]</span><span class="builtintype" id="5956911">byte</span><span class="op" id="5956915">,</span>&nbsp;<span class="builtintype" id="5956917">error</span><span class="op" id="5956922">)</span>&nbsp;<span class="op" id="5956924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5956927">fset</span>&nbsp;<span class="op" id="5956932">:=</span>&nbsp;<span class="ident" id="5956935">token</span><span class="op" id="5956940">.</span><span class="ident" id="5956941">NewFileSet</span><span class="op" id="5956951">(</span><span class="op" id="5956952">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5956955">file</span><span class="op" id="5956959">,</span>&nbsp;<span class="ident" id="5956961">sourceAdj</span><span class="op" id="5956970">,</span>&nbsp;<span class="ident" id="5956972">indentAdj</span><span class="op" id="5956981">,</span>&nbsp;<span class="ident" id="5956983">err</span>&nbsp;<span class="op" id="5956987">:=</span>&nbsp;<span class="ident" id="5956990">parse</span><span class="op" id="5956995">(</span><span class="ident" id="5956996">fset</span><span class="op" id="5957000">,</span>&nbsp;<span class="string" id="5957002">&#34;&#34;</span><span class="op" id="5957004">,</span>&nbsp;<span class="ident" id="5957006">src</span><span class="op" id="5957009">,</span>&nbsp;<span class="builtintype" id="5957011">true</span><span class="op" id="5957015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5957018">if</span>&nbsp;<span class="ident" id="5957021">err</span>&nbsp;<span class="op" id="5957025">!=</span>&nbsp;<span class="ident" id="5957028">nil</span>&nbsp;<span class="op" id="5957032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5957036">return</span>&nbsp;<span class="ident" id="5957043">nil</span><span class="op" id="5957046">,</span>&nbsp;<span class="ident" id="5957048">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5957053">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5957057">if</span>&nbsp;<span class="ident" id="5957060">sourceAdj</span>&nbsp;<span class="op" id="5957070">==</span>&nbsp;<span class="ident" id="5957073">nil</span>&nbsp;<span class="op" id="5957077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5957081">//&nbsp;Complete&nbsp;source&nbsp;file.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5957108">//&nbsp;TODO(gri)&nbsp;consider&nbsp;doing&nbsp;this&nbsp;always.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5957151">ast</span><span class="op" id="5957154">.</span><span class="ident" id="5957155">SortImports</span><span class="op" id="5957166">(</span><span class="ident" id="5957167">fset</span><span class="op" id="5957171">,</span>&nbsp;<span class="ident" id="5957173">file</span><span class="op" id="5957177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5957180">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5957184">return</span>&nbsp;<span class="ident" id="5957191">format</span><span class="op" id="5957197">(</span><span class="ident" id="5957198">fset</span><span class="op" id="5957202">,</span>&nbsp;<span class="ident" id="5957204">file</span><span class="op" id="5957208">,</span>&nbsp;<span class="ident" id="5957210">sourceAdj</span><span class="op" id="5957219">,</span>&nbsp;<span class="ident" id="5957221">indentAdj</span><span class="op" id="5957230">,</span>&nbsp;<span class="ident" id="5957232">src</span><span class="op" id="5957235">,</span>&nbsp;<span class="ident" id="5957237">config</span><span class="op" id="5957243">)</span><br>
<span class="lineno"></span><span class="op" id="5957245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5957248">func</span>&nbsp;<span class="ident" id="5957253">hasUnsortedImports</span><span class="op" id="5957271">(</span><span class="ident" id="5957272">file</span>&nbsp;<span class="op" id="5957277">*</span><span class="ident" id="5957278">ast</span><span class="op" id="5957281">.</span><span class="ident" id="5957282">File</span><span class="op" id="5957286">)</span>&nbsp;<span class="builtintype" id="5957288">bool</span>&nbsp;<span class="op" id="5957293">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5957296">for</span>&nbsp;<span class="ident" id="5957300">_</span><span class="op" id="5957301">,</span>&nbsp;<span class="ident" id="5957303">d</span>&nbsp;<span class="op" id="5957305">:=</span>&nbsp;<span class="keyword" id="5957308">range</span>&nbsp;<span class="ident" id="5957314">file</span><span class="op" id="5957318">.</span><span class="ident" id="5957319">Decls</span>&nbsp;<span class="op" id="5957325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5957329">d</span><span class="op" id="5957330">,</span>&nbsp;<span class="ident" id="5957332">ok</span>&nbsp;<span class="op" id="5957335">:=</span>&nbsp;<span class="ident" id="5957338">d</span><span class="op" id="5957339">.</span><span class="op" id="5957340">(</span><span class="op" id="5957341">*</span><span class="ident" id="5957342">ast</span><span class="op" id="5957345">.</span><span class="ident" id="5957346">GenDecl</span><span class="op" id="5957353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5957357">if</span>&nbsp;<span class="op" id="5957360">!</span><span class="ident" id="5957361">ok</span>&nbsp;<span class="op" id="5957364">||</span>&nbsp;<span class="ident" id="5957367">d</span><span class="op" id="5957368">.</span><span class="ident" id="5957369">Tok</span>&nbsp;<span class="op" id="5957373">!=</span>&nbsp;<span class="ident" id="5957376">token</span><span class="op" id="5957381">.</span><span class="ident" id="5957382">IMPORT</span>&nbsp;<span class="op" id="5957389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5957394">//&nbsp;Not&nbsp;an&nbsp;import&nbsp;declaration,&nbsp;so&nbsp;we&#39;re&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5957442">//&nbsp;Imports&nbsp;are&nbsp;always&nbsp;first.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5957474">return</span>&nbsp;<span class="builtintype" id="5957481">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5957489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5957493">if</span>&nbsp;<span class="ident" id="5957496">d</span><span class="op" id="5957497">.</span><span class="ident" id="5957498">Lparen</span><span class="op" id="5957504">.</span><span class="ident" id="5957505">IsValid</span><span class="op" id="5957512">(</span><span class="op" id="5957513">)</span>&nbsp;<span class="op" id="5957515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5957520">//&nbsp;For&nbsp;now&nbsp;assume&nbsp;all&nbsp;grouped&nbsp;imports&nbsp;are&nbsp;unsorted.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5957575">//&nbsp;TODO(gri)&nbsp;Should&nbsp;check&nbsp;if&nbsp;they&nbsp;are&nbsp;sorted&nbsp;already.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5957632">return</span>&nbsp;<span class="builtintype" id="5957639">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5957646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5957650">//&nbsp;Ungrouped&nbsp;imports&nbsp;are&nbsp;sorted&nbsp;by&nbsp;default.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5957695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5957698">return</span>&nbsp;<span class="builtintype" id="5957705">false</span><br>
<span class="lineno">115</span><span class="op" id="5957711">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5957714">//&nbsp;----------------------------------------------------------------------------</span><br>
<span class="lineno"></span><span class="comment" id="5957794">//&nbsp;Support&nbsp;functions</span><br>
<span class="lineno"></span><span class="comment" id="5957815">//</span><br>
<span class="lineno">120</span><span class="comment" id="5957818">//&nbsp;The&nbsp;functions&nbsp;parse,&nbsp;format,&nbsp;and&nbsp;isSpace&nbsp;below&nbsp;are&nbsp;identical&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5957889">//&nbsp;respective&nbsp;functions&nbsp;in&nbsp;cmd/gofmt/gofmt.go&nbsp;-&nbsp;keep&nbsp;them&nbsp;in&nbsp;sync!</span><br>
<span class="lineno"></span><span class="comment" id="5957956">//</span><br>
<span class="lineno"></span><span class="comment" id="5957959">//&nbsp;TODO(gri)&nbsp;Factor&nbsp;out&nbsp;this&nbsp;functionality,&nbsp;eventually.</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="comment" id="5958016">//&nbsp;parse&nbsp;parses&nbsp;src,&nbsp;which&nbsp;was&nbsp;read&nbsp;from&nbsp;the&nbsp;named&nbsp;file,</span><br>
<span class="lineno"></span><span class="comment" id="5958073">//&nbsp;as&nbsp;a&nbsp;Go&nbsp;source&nbsp;file,&nbsp;declaration,&nbsp;or&nbsp;statement&nbsp;list.</span><br>
<span class="lineno"></span><span class="keyword" id="5958129">func</span>&nbsp;<span class="ident" id="5958134">parse</span><span class="op" id="5958139">(</span><span class="ident" id="5958140">fset</span>&nbsp;<span class="op" id="5958145">*</span><span class="ident" id="5958146">token</span><span class="op" id="5958151">.</span><span class="ident" id="5958152">FileSet</span><span class="op" id="5958159">,</span>&nbsp;<span class="ident" id="5958161">filename</span>&nbsp;<span class="builtintype" id="5958170">string</span><span class="op" id="5958176">,</span>&nbsp;<span class="ident" id="5958178">src</span>&nbsp;<span class="op" id="5958182">[</span><span class="op" id="5958183">]</span><span class="builtintype" id="5958184">byte</span><span class="op" id="5958188">,</span>&nbsp;<span class="ident" id="5958190">fragmentOk</span>&nbsp;<span class="builtintype" id="5958201">bool</span><span class="op" id="5958205">)</span>&nbsp;<span class="op" id="5958207">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5958210">file</span>&nbsp;<span class="op" id="5958215">*</span><span class="ident" id="5958216">ast</span><span class="op" id="5958219">.</span><span class="ident" id="5958220">File</span><span class="op" id="5958224">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5958227">sourceAdj</span>&nbsp;<span class="keyword" id="5958237">func</span><span class="op" id="5958241">(</span><span class="ident" id="5958242">src</span>&nbsp;<span class="op" id="5958246">[</span><span class="op" id="5958247">]</span><span class="builtintype" id="5958248">byte</span><span class="op" id="5958252">,</span>&nbsp;<span class="ident" id="5958254">indent</span>&nbsp;<span class="builtintype" id="5958261">int</span><span class="op" id="5958264">)</span>&nbsp;<span class="op" id="5958266">[</span><span class="op" id="5958267">]</span><span class="builtintype" id="5958268">byte</span><span class="op" id="5958272">,</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5958275">indentAdj</span>&nbsp;<span class="builtintype" id="5958285">int</span><span class="op" id="5958288">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5958291">err</span>&nbsp;<span class="builtintype" id="5958295">error</span><span class="op" id="5958300">,</span><br>
<span class="lineno"></span><span class="op" id="5958302">)</span>&nbsp;<span class="op" id="5958304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5958307">//&nbsp;Try&nbsp;as&nbsp;whole&nbsp;source&nbsp;file.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5958337">file</span><span class="op" id="5958341">,</span>&nbsp;<span class="ident" id="5958343">err</span>&nbsp;<span class="op" id="5958347">=</span>&nbsp;<span class="ident" id="5958349">parser</span><span class="op" id="5958355">.</span><span class="ident" id="5958356">ParseFile</span><span class="op" id="5958365">(</span><span class="ident" id="5958366">fset</span><span class="op" id="5958370">,</span>&nbsp;<span class="ident" id="5958372">filename</span><span class="op" id="5958380">,</span>&nbsp;<span class="ident" id="5958382">src</span><span class="op" id="5958385">,</span>&nbsp;<span class="ident" id="5958387">parserMode</span><span class="op" id="5958397">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5958400">//&nbsp;If&nbsp;there&#39;s&nbsp;no&nbsp;error,&nbsp;return.&nbsp;&nbsp;If&nbsp;the&nbsp;error&nbsp;is&nbsp;that&nbsp;the&nbsp;source&nbsp;file&nbsp;didn&#39;t&nbsp;begin&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5958491">//&nbsp;package&nbsp;line&nbsp;and&nbsp;source&nbsp;fragments&nbsp;are&nbsp;ok,&nbsp;fall&nbsp;through&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5958553">//&nbsp;try&nbsp;as&nbsp;a&nbsp;source&nbsp;fragment.&nbsp;&nbsp;Stop&nbsp;and&nbsp;return&nbsp;on&nbsp;any&nbsp;other&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5958620">if</span>&nbsp;<span class="ident" id="5958623">err</span>&nbsp;<span class="op" id="5958627">==</span>&nbsp;<span class="ident" id="5958630">nil</span>&nbsp;<span class="op" id="5958634">||</span>&nbsp;<span class="op" id="5958637">!</span><span class="ident" id="5958638">fragmentOk</span>&nbsp;<span class="op" id="5958649">||</span>&nbsp;<span class="op" id="5958652">!</span><span class="ident" id="5958653">strings</span><span class="op" id="5958660">.</span><span class="ident" id="5958661">Contains</span><span class="op" id="5958669">(</span><span class="ident" id="5958670">err</span><span class="op" id="5958673">.</span><span class="ident" id="5958674">Error</span><span class="op" id="5958679">(</span><span class="op" id="5958680">)</span><span class="op" id="5958681">,</span>&nbsp;<span class="string" id="5958683">&#34;expected&nbsp;&#39;package&#39;&#34;</span><span class="op" id="5958703">)</span>&nbsp;<span class="op" id="5958705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5958709">return</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5958717">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5958721">//&nbsp;If&nbsp;this&nbsp;is&nbsp;a&nbsp;declaration&nbsp;list,&nbsp;make&nbsp;it&nbsp;a&nbsp;source&nbsp;file</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5958778">//&nbsp;by&nbsp;inserting&nbsp;a&nbsp;package&nbsp;clause.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5958813">//&nbsp;Insert&nbsp;using&nbsp;a&nbsp;;,&nbsp;not&nbsp;a&nbsp;newline,&nbsp;so&nbsp;that&nbsp;the&nbsp;line&nbsp;numbers</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5958875">//&nbsp;in&nbsp;psrc&nbsp;match&nbsp;the&nbsp;ones&nbsp;in&nbsp;src.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5958910">psrc</span>&nbsp;<span class="op" id="5958915">:=</span>&nbsp;<span class="builtinfunc" id="5958918">append</span><span class="op" id="5958924">(</span><span class="op" id="5958925">[</span><span class="op" id="5958926">]</span><span class="builtintype" id="5958927">byte</span><span class="op" id="5958931">(</span><span class="string" id="5958932">&#34;package&nbsp;p;&#34;</span><span class="op" id="5958944">)</span><span class="op" id="5958945">,</span>&nbsp;<span class="ident" id="5958947">src</span><span class="op" id="5958950">...</span><span class="op" id="5958953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5958956">file</span><span class="op" id="5958960">,</span>&nbsp;<span class="ident" id="5958962">err</span>&nbsp;<span class="op" id="5958966">=</span>&nbsp;<span class="ident" id="5958968">parser</span><span class="op" id="5958974">.</span><span class="ident" id="5958975">ParseFile</span><span class="op" id="5958984">(</span><span class="ident" id="5958985">fset</span><span class="op" id="5958989">,</span>&nbsp;<span class="ident" id="5958991">filename</span><span class="op" id="5958999">,</span>&nbsp;<span class="ident" id="5959001">psrc</span><span class="op" id="5959005">,</span>&nbsp;<span class="ident" id="5959007">parserMode</span><span class="op" id="5959017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5959020">if</span>&nbsp;<span class="ident" id="5959023">err</span>&nbsp;<span class="op" id="5959027">==</span>&nbsp;<span class="ident" id="5959030">nil</span>&nbsp;<span class="op" id="5959034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5959038">sourceAdj</span>&nbsp;<span class="op" id="5959048">=</span>&nbsp;<span class="keyword" id="5959050">func</span><span class="op" id="5959054">(</span><span class="ident" id="5959055">src</span>&nbsp;<span class="op" id="5959059">[</span><span class="op" id="5959060">]</span><span class="builtintype" id="5959061">byte</span><span class="op" id="5959065">,</span>&nbsp;<span class="ident" id="5959067">indent</span>&nbsp;<span class="builtintype" id="5959074">int</span><span class="op" id="5959077">)</span>&nbsp;<span class="op" id="5959079">[</span><span class="op" id="5959080">]</span><span class="builtintype" id="5959081">byte</span>&nbsp;<span class="op" id="5959086">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5959091">//&nbsp;Remove&nbsp;the&nbsp;package&nbsp;clause.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5959124">//&nbsp;Gofmt&nbsp;has&nbsp;turned&nbsp;the&nbsp;;&nbsp;into&nbsp;a&nbsp;\n.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5959164">src</span>&nbsp;<span class="op" id="5959168">=</span>&nbsp;<span class="ident" id="5959170">src</span><span class="op" id="5959173">[</span><span class="ident" id="5959174">indent</span><span class="op" id="5959180">+</span><span class="builtinfunc" id="5959181">len</span><span class="op" id="5959184">(</span><span class="string" id="5959185">&#34;package&nbsp;p\n&#34;</span><span class="op" id="5959198">)</span><span class="op" id="5959199">:</span><span class="op" id="5959200">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5959205">return</span>&nbsp;<span class="ident" id="5959212">bytes</span><span class="op" id="5959217">.</span><span class="ident" id="5959218">TrimSpace</span><span class="op" id="5959227">(</span><span class="ident" id="5959228">src</span><span class="op" id="5959231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5959235">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5959239">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5959247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5959250">//&nbsp;If&nbsp;the&nbsp;error&nbsp;is&nbsp;that&nbsp;the&nbsp;source&nbsp;file&nbsp;didn&#39;t&nbsp;begin&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5959311">//&nbsp;declaration,&nbsp;fall&nbsp;through&nbsp;to&nbsp;try&nbsp;as&nbsp;a&nbsp;statement&nbsp;list.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5959369">//&nbsp;Stop&nbsp;and&nbsp;return&nbsp;on&nbsp;any&nbsp;other&nbsp;error.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5959409">if</span>&nbsp;<span class="op" id="5959412">!</span><span class="ident" id="5959413">strings</span><span class="op" id="5959420">.</span><span class="ident" id="5959421">Contains</span><span class="op" id="5959429">(</span><span class="ident" id="5959430">err</span><span class="op" id="5959433">.</span><span class="ident" id="5959434">Error</span><span class="op" id="5959439">(</span><span class="op" id="5959440">)</span><span class="op" id="5959441">,</span>&nbsp;<span class="string" id="5959443">&#34;expected&nbsp;declaration&#34;</span><span class="op" id="5959465">)</span>&nbsp;<span class="op" id="5959467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5959471">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5959479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5959483">//&nbsp;If&nbsp;this&nbsp;is&nbsp;a&nbsp;statement&nbsp;list,&nbsp;make&nbsp;it&nbsp;a&nbsp;source&nbsp;file</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5959538">//&nbsp;by&nbsp;inserting&nbsp;a&nbsp;package&nbsp;clause&nbsp;and&nbsp;turning&nbsp;the&nbsp;list</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5959593">//&nbsp;into&nbsp;a&nbsp;function&nbsp;body.&nbsp;&nbsp;This&nbsp;handles&nbsp;expressions&nbsp;too.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5959650">//&nbsp;Insert&nbsp;using&nbsp;a&nbsp;;,&nbsp;not&nbsp;a&nbsp;newline,&nbsp;so&nbsp;that&nbsp;the&nbsp;line&nbsp;numbers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5959712">//&nbsp;in&nbsp;fsrc&nbsp;match&nbsp;the&nbsp;ones&nbsp;in&nbsp;src.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5959747">fsrc</span>&nbsp;<span class="op" id="5959752">:=</span>&nbsp;<span class="builtinfunc" id="5959755">append</span><span class="op" id="5959761">(</span><span class="builtinfunc" id="5959762">append</span><span class="op" id="5959768">(</span><span class="op" id="5959769">[</span><span class="op" id="5959770">]</span><span class="builtintype" id="5959771">byte</span><span class="op" id="5959775">(</span><span class="string" id="5959776">&#34;package&nbsp;p;&nbsp;func&nbsp;_()&nbsp;{&#34;</span><span class="op" id="5959799">)</span><span class="op" id="5959800">,</span>&nbsp;<span class="ident" id="5959802">src</span><span class="op" id="5959805">...</span><span class="op" id="5959808">)</span><span class="op" id="5959809">,</span>&nbsp;<span class="string" id="5959811">&#39;\n&#39;</span><span class="op" id="5959815">,</span>&nbsp;<span class="string" id="5959817">&#39;}&#39;</span><span class="op" id="5959820">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5959823">file</span><span class="op" id="5959827">,</span>&nbsp;<span class="ident" id="5959829">err</span>&nbsp;<span class="op" id="5959833">=</span>&nbsp;<span class="ident" id="5959835">parser</span><span class="op" id="5959841">.</span><span class="ident" id="5959842">ParseFile</span><span class="op" id="5959851">(</span><span class="ident" id="5959852">fset</span><span class="op" id="5959856">,</span>&nbsp;<span class="ident" id="5959858">filename</span><span class="op" id="5959866">,</span>&nbsp;<span class="ident" id="5959868">fsrc</span><span class="op" id="5959872">,</span>&nbsp;<span class="ident" id="5959874">parserMode</span><span class="op" id="5959884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5959887">if</span>&nbsp;<span class="ident" id="5959890">err</span>&nbsp;<span class="op" id="5959894">==</span>&nbsp;<span class="ident" id="5959897">nil</span>&nbsp;<span class="op" id="5959901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5959905">sourceAdj</span>&nbsp;<span class="op" id="5959915">=</span>&nbsp;<span class="keyword" id="5959917">func</span><span class="op" id="5959921">(</span><span class="ident" id="5959922">src</span>&nbsp;<span class="op" id="5959926">[</span><span class="op" id="5959927">]</span><span class="builtintype" id="5959928">byte</span><span class="op" id="5959932">,</span>&nbsp;<span class="ident" id="5959934">indent</span>&nbsp;<span class="builtintype" id="5959941">int</span><span class="op" id="5959944">)</span>&nbsp;<span class="op" id="5959946">[</span><span class="op" id="5959947">]</span><span class="builtintype" id="5959948">byte</span>&nbsp;<span class="op" id="5959953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5959958">//&nbsp;Cap&nbsp;adjusted&nbsp;indent&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5959993">if</span>&nbsp;<span class="ident" id="5959996">indent</span>&nbsp;<span class="op" id="5960003">&lt;</span>&nbsp;<span class="num" id="5960005">0</span>&nbsp;<span class="op" id="5960007">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5960013">indent</span>&nbsp;<span class="op" id="5960020">=</span>&nbsp;<span class="num" id="5960022">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5960027">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5960032">//&nbsp;Remove&nbsp;the&nbsp;wrapping.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5960059">//&nbsp;Gofmt&nbsp;has&nbsp;turned&nbsp;the&nbsp;;&nbsp;into&nbsp;a&nbsp;\n\n.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5960101">//&nbsp;There&nbsp;will&nbsp;be&nbsp;two&nbsp;non-blank&nbsp;lines&nbsp;with&nbsp;indent,&nbsp;hence&nbsp;2*indent.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5960170">src</span>&nbsp;<span class="op" id="5960174">=</span>&nbsp;<span class="ident" id="5960176">src</span><span class="op" id="5960179">[</span><span class="num" id="5960180">2</span><span class="op" id="5960181">*</span><span class="ident" id="5960182">indent</span><span class="op" id="5960188">+</span><span class="builtinfunc" id="5960189">len</span><span class="op" id="5960192">(</span><span class="string" id="5960193">&#34;package&nbsp;p\n\nfunc&nbsp;_()&nbsp;{&#34;</span><span class="op" id="5960218">)</span><span class="op" id="5960219">:</span><span class="op" id="5960220">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5960225">src</span>&nbsp;<span class="op" id="5960229">=</span>&nbsp;<span class="ident" id="5960231">src</span><span class="op" id="5960234">[</span><span class="op" id="5960235">:</span><span class="builtinfunc" id="5960236">len</span><span class="op" id="5960239">(</span><span class="ident" id="5960240">src</span><span class="op" id="5960243">)</span><span class="op" id="5960244">-</span><span class="op" id="5960245">(</span><span class="ident" id="5960246">indent</span><span class="op" id="5960252">+</span><span class="builtinfunc" id="5960253">len</span><span class="op" id="5960256">(</span><span class="string" id="5960257">&#34;\n}\n&#34;</span><span class="op" id="5960264">)</span><span class="op" id="5960265">)</span><span class="op" id="5960266">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5960271">return</span>&nbsp;<span class="ident" id="5960278">bytes</span><span class="op" id="5960283">.</span><span class="ident" id="5960284">TrimSpace</span><span class="op" id="5960293">(</span><span class="ident" id="5960294">src</span><span class="op" id="5960297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5960301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5960305">//&nbsp;Gofmt&nbsp;has&nbsp;also&nbsp;indented&nbsp;the&nbsp;function&nbsp;body&nbsp;one&nbsp;level.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5960363">//&nbsp;Adjust&nbsp;that&nbsp;with&nbsp;indentAdj.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5960396">indentAdj</span>&nbsp;<span class="op" id="5960406">=</span>&nbsp;<span class="op" id="5960408">-</span><span class="num" id="5960409">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5960412">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5960416">//&nbsp;Succeeded,&nbsp;or&nbsp;out&nbsp;of&nbsp;options.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5960450">return</span><br>
<span class="lineno"></span><span class="op" id="5960457">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5960460">//&nbsp;format&nbsp;formats&nbsp;the&nbsp;given&nbsp;package&nbsp;file&nbsp;originally&nbsp;obtained&nbsp;from&nbsp;src</span><br>
<span class="lineno"></span><span class="comment" id="5960530">//&nbsp;and&nbsp;adjusts&nbsp;the&nbsp;result&nbsp;based&nbsp;on&nbsp;the&nbsp;original&nbsp;source&nbsp;via&nbsp;sourceAdj</span><br>
<span class="lineno">195</span><span class="comment" id="5960599">//&nbsp;and&nbsp;indentAdj.</span><br>
<span class="lineno"></span><span class="keyword" id="5960617">func</span>&nbsp;<span class="ident" id="5960622">format</span><span class="op" id="5960628">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5960631">fset</span>&nbsp;<span class="op" id="5960636">*</span><span class="ident" id="5960637">token</span><span class="op" id="5960642">.</span><span class="ident" id="5960643">FileSet</span><span class="op" id="5960650">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5960653">file</span>&nbsp;<span class="op" id="5960658">*</span><span class="ident" id="5960659">ast</span><span class="op" id="5960662">.</span><span class="ident" id="5960663">File</span><span class="op" id="5960667">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5960670">sourceAdj</span>&nbsp;<span class="keyword" id="5960680">func</span><span class="op" id="5960684">(</span><span class="ident" id="5960685">src</span>&nbsp;<span class="op" id="5960689">[</span><span class="op" id="5960690">]</span><span class="builtintype" id="5960691">byte</span><span class="op" id="5960695">,</span>&nbsp;<span class="ident" id="5960697">indent</span>&nbsp;<span class="builtintype" id="5960704">int</span><span class="op" id="5960707">)</span>&nbsp;<span class="op" id="5960709">[</span><span class="op" id="5960710">]</span><span class="builtintype" id="5960711">byte</span><span class="op" id="5960715">,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5960718">indentAdj</span>&nbsp;<span class="builtintype" id="5960728">int</span><span class="op" id="5960731">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5960734">src</span>&nbsp;<span class="op" id="5960738">[</span><span class="op" id="5960739">]</span><span class="builtintype" id="5960740">byte</span><span class="op" id="5960744">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5960747">cfg</span>&nbsp;<span class="ident" id="5960751">printer</span><span class="op" id="5960758">.</span><span class="ident" id="5960759">Config</span><span class="op" id="5960765">,</span><br>
<span class="lineno"></span><span class="op" id="5960767">)</span>&nbsp;<span class="op" id="5960769">(</span><span class="op" id="5960770">[</span><span class="op" id="5960771">]</span><span class="builtintype" id="5960772">byte</span><span class="op" id="5960776">,</span>&nbsp;<span class="builtintype" id="5960778">error</span><span class="op" id="5960783">)</span>&nbsp;<span class="op" id="5960785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5960788">if</span>&nbsp;<span class="ident" id="5960791">sourceAdj</span>&nbsp;<span class="op" id="5960801">==</span>&nbsp;<span class="ident" id="5960804">nil</span>&nbsp;<span class="op" id="5960808">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5960812">//&nbsp;Complete&nbsp;source&nbsp;file.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5960839">var</span>&nbsp;<span class="ident" id="5960843">buf</span>&nbsp;<span class="ident" id="5960847">bytes</span><span class="op" id="5960852">.</span><span class="ident" id="5960853">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5960862">err</span>&nbsp;<span class="op" id="5960866">:=</span>&nbsp;<span class="ident" id="5960869">cfg</span><span class="op" id="5960872">.</span><span class="ident" id="5960873">Fprint</span><span class="op" id="5960879">(</span><span class="op" id="5960880">&amp;</span><span class="ident" id="5960881">buf</span><span class="op" id="5960884">,</span>&nbsp;<span class="ident" id="5960886">fset</span><span class="op" id="5960890">,</span>&nbsp;<span class="ident" id="5960892">file</span><span class="op" id="5960896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5960900">if</span>&nbsp;<span class="ident" id="5960903">err</span>&nbsp;<span class="op" id="5960907">!=</span>&nbsp;<span class="ident" id="5960910">nil</span>&nbsp;<span class="op" id="5960914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5960919">return</span>&nbsp;<span class="ident" id="5960926">nil</span><span class="op" id="5960929">,</span>&nbsp;<span class="ident" id="5960931">err</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5960937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5960941">return</span>&nbsp;<span class="ident" id="5960948">buf</span><span class="op" id="5960951">.</span><span class="ident" id="5960952">Bytes</span><span class="op" id="5960957">(</span><span class="op" id="5960958">)</span><span class="op" id="5960959">,</span>&nbsp;<span class="ident" id="5960961">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5960966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5960970">//&nbsp;Partial&nbsp;source&nbsp;file.</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5960995">//&nbsp;Determine&nbsp;and&nbsp;prepend&nbsp;leading&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5961036">i</span><span class="op" id="5961037">,</span>&nbsp;<span class="ident" id="5961039">j</span>&nbsp;<span class="op" id="5961041">:=</span>&nbsp;<span class="num" id="5961044">0</span><span class="op" id="5961045">,</span>&nbsp;<span class="num" id="5961047">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5961050">for</span>&nbsp;<span class="ident" id="5961054">j</span>&nbsp;<span class="op" id="5961056">&lt;</span>&nbsp;<span class="builtinfunc" id="5961058">len</span><span class="op" id="5961061">(</span><span class="ident" id="5961062">src</span><span class="op" id="5961065">)</span>&nbsp;<span class="op" id="5961067">&amp;&amp;</span>&nbsp;<span class="ident" id="5961070">isSpace</span><span class="op" id="5961077">(</span><span class="ident" id="5961078">src</span><span class="op" id="5961081">[</span><span class="ident" id="5961082">j</span><span class="op" id="5961083">]</span><span class="op" id="5961084">)</span>&nbsp;<span class="op" id="5961086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5961090">if</span>&nbsp;<span class="ident" id="5961093">src</span><span class="op" id="5961096">[</span><span class="ident" id="5961097">j</span><span class="op" id="5961098">]</span>&nbsp;<span class="op" id="5961100">==</span>&nbsp;<span class="string" id="5961103">&#39;\n&#39;</span>&nbsp;<span class="op" id="5961108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5961113">i</span>&nbsp;<span class="op" id="5961115">=</span>&nbsp;<span class="ident" id="5961117">j</span>&nbsp;<span class="op" id="5961119">+</span>&nbsp;<span class="num" id="5961121">1</span>&nbsp;<span class="comment" id="5961123">//&nbsp;byte&nbsp;offset&nbsp;of&nbsp;last&nbsp;line&nbsp;in&nbsp;leading&nbsp;space</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5961170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5961174">j</span><span class="op" id="5961175">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5961179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5961182">var</span>&nbsp;<span class="ident" id="5961186">res</span>&nbsp;<span class="op" id="5961190">[</span><span class="op" id="5961191">]</span><span class="builtintype" id="5961192">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5961198">res</span>&nbsp;<span class="op" id="5961202">=</span>&nbsp;<span class="builtinfunc" id="5961204">append</span><span class="op" id="5961210">(</span><span class="ident" id="5961211">res</span><span class="op" id="5961214">,</span>&nbsp;<span class="ident" id="5961216">src</span><span class="op" id="5961219">[</span><span class="op" id="5961220">:</span><span class="ident" id="5961221">i</span><span class="op" id="5961222">]</span><span class="op" id="5961223">...</span><span class="op" id="5961226">)</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5961230">//&nbsp;Determine&nbsp;and&nbsp;prepend&nbsp;indentation&nbsp;of&nbsp;first&nbsp;code&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5961288">//&nbsp;Spaces&nbsp;are&nbsp;ignored&nbsp;unless&nbsp;there&nbsp;are&nbsp;no&nbsp;tabs,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5961337">//&nbsp;in&nbsp;which&nbsp;case&nbsp;spaces&nbsp;count&nbsp;as&nbsp;one&nbsp;tab.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5961380">indent</span>&nbsp;<span class="op" id="5961387">:=</span>&nbsp;<span class="num" id="5961390">0</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5961393">hasSpace</span>&nbsp;<span class="op" id="5961402">:=</span>&nbsp;<span class="builtintype" id="5961405">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5961412">for</span>&nbsp;<span class="ident" id="5961416">_</span><span class="op" id="5961417">,</span>&nbsp;<span class="ident" id="5961419">b</span>&nbsp;<span class="op" id="5961421">:=</span>&nbsp;<span class="keyword" id="5961424">range</span>&nbsp;<span class="ident" id="5961430">src</span><span class="op" id="5961433">[</span><span class="ident" id="5961434">i</span><span class="op" id="5961435">:</span><span class="ident" id="5961436">j</span><span class="op" id="5961437">]</span>&nbsp;<span class="op" id="5961439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5961443">switch</span>&nbsp;<span class="ident" id="5961450">b</span>&nbsp;<span class="op" id="5961452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5961456">case</span>&nbsp;<span class="string" id="5961461">&#39;&nbsp;&#39;</span><span class="op" id="5961464">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5961469">hasSpace</span>&nbsp;<span class="op" id="5961478">=</span>&nbsp;<span class="builtintype" id="5961480">true</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5961487">case</span>&nbsp;<span class="string" id="5961492">&#39;\t&#39;</span><span class="op" id="5961496">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5961501">indent</span><span class="op" id="5961507">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5961512">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5961515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5961518">if</span>&nbsp;<span class="ident" id="5961521">indent</span>&nbsp;<span class="op" id="5961528">==</span>&nbsp;<span class="num" id="5961531">0</span>&nbsp;<span class="op" id="5961533">&amp;&amp;</span>&nbsp;<span class="ident" id="5961536">hasSpace</span>&nbsp;<span class="op" id="5961545">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5961549">indent</span>&nbsp;<span class="op" id="5961556">=</span>&nbsp;<span class="num" id="5961558">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5961561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5961564">for</span>&nbsp;<span class="ident" id="5961568">i</span>&nbsp;<span class="op" id="5961570">:=</span>&nbsp;<span class="num" id="5961573">0</span><span class="op" id="5961574">;</span>&nbsp;<span class="ident" id="5961576">i</span>&nbsp;<span class="op" id="5961578">&lt;</span>&nbsp;<span class="ident" id="5961580">indent</span><span class="op" id="5961586">;</span>&nbsp;<span class="ident" id="5961588">i</span><span class="op" id="5961589">++</span>&nbsp;<span class="op" id="5961592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5961596">res</span>&nbsp;<span class="op" id="5961600">=</span>&nbsp;<span class="builtinfunc" id="5961602">append</span><span class="op" id="5961608">(</span><span class="ident" id="5961609">res</span><span class="op" id="5961612">,</span>&nbsp;<span class="string" id="5961614">&#39;\t&#39;</span><span class="op" id="5961618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5961621">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5961625">//&nbsp;Format&nbsp;the&nbsp;source.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5961648">//&nbsp;Write&nbsp;it&nbsp;without&nbsp;any&nbsp;leading&nbsp;and&nbsp;trailing&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5961701">cfg</span><span class="op" id="5961704">.</span><span class="ident" id="5961705">Indent</span>&nbsp;<span class="op" id="5961712">=</span>&nbsp;<span class="ident" id="5961714">indent</span>&nbsp;<span class="op" id="5961721">+</span>&nbsp;<span class="ident" id="5961723">indentAdj</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5961734">var</span>&nbsp;<span class="ident" id="5961738">buf</span>&nbsp;<span class="ident" id="5961742">bytes</span><span class="op" id="5961747">.</span><span class="ident" id="5961748">Buffer</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5961756">err</span>&nbsp;<span class="op" id="5961760">:=</span>&nbsp;<span class="ident" id="5961763">cfg</span><span class="op" id="5961766">.</span><span class="ident" id="5961767">Fprint</span><span class="op" id="5961773">(</span><span class="op" id="5961774">&amp;</span><span class="ident" id="5961775">buf</span><span class="op" id="5961778">,</span>&nbsp;<span class="ident" id="5961780">fset</span><span class="op" id="5961784">,</span>&nbsp;<span class="ident" id="5961786">file</span><span class="op" id="5961790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5961793">if</span>&nbsp;<span class="ident" id="5961796">err</span>&nbsp;<span class="op" id="5961800">!=</span>&nbsp;<span class="ident" id="5961803">nil</span>&nbsp;<span class="op" id="5961807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5961811">return</span>&nbsp;<span class="ident" id="5961818">nil</span><span class="op" id="5961821">,</span>&nbsp;<span class="ident" id="5961823">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5961828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5961831">res</span>&nbsp;<span class="op" id="5961835">=</span>&nbsp;<span class="builtinfunc" id="5961837">append</span><span class="op" id="5961843">(</span><span class="ident" id="5961844">res</span><span class="op" id="5961847">,</span>&nbsp;<span class="ident" id="5961849">sourceAdj</span><span class="op" id="5961858">(</span><span class="ident" id="5961859">buf</span><span class="op" id="5961862">.</span><span class="ident" id="5961863">Bytes</span><span class="op" id="5961868">(</span><span class="op" id="5961869">)</span><span class="op" id="5961870">,</span>&nbsp;<span class="ident" id="5961872">cfg</span><span class="op" id="5961875">.</span><span class="ident" id="5961876">Indent</span><span class="op" id="5961882">)</span><span class="op" id="5961883">...</span><span class="op" id="5961886">)</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5961890">//&nbsp;Determine&nbsp;and&nbsp;append&nbsp;trailing&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5961931">i</span>&nbsp;<span class="op" id="5961933">=</span>&nbsp;<span class="builtinfunc" id="5961935">len</span><span class="op" id="5961938">(</span><span class="ident" id="5961939">src</span><span class="op" id="5961942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5961945">for</span>&nbsp;<span class="ident" id="5961949">i</span>&nbsp;<span class="op" id="5961951">&gt;</span>&nbsp;<span class="num" id="5961953">0</span>&nbsp;<span class="op" id="5961955">&amp;&amp;</span>&nbsp;<span class="ident" id="5961958">isSpace</span><span class="op" id="5961965">(</span><span class="ident" id="5961966">src</span><span class="op" id="5961969">[</span><span class="ident" id="5961970">i</span><span class="op" id="5961971">-</span><span class="num" id="5961972">1</span><span class="op" id="5961973">]</span><span class="op" id="5961974">)</span>&nbsp;<span class="op" id="5961976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5961980">i</span><span class="op" id="5961981">--</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5961985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5961988">return</span>&nbsp;<span class="builtinfunc" id="5961995">append</span><span class="op" id="5962001">(</span><span class="ident" id="5962002">res</span><span class="op" id="5962005">,</span>&nbsp;<span class="ident" id="5962007">src</span><span class="op" id="5962010">[</span><span class="ident" id="5962011">i</span><span class="op" id="5962012">:</span><span class="op" id="5962013">]</span><span class="op" id="5962014">...</span><span class="op" id="5962017">)</span><span class="op" id="5962018">,</span>&nbsp;<span class="ident" id="5962020">nil</span><br>
<span class="lineno"></span><span class="op" id="5962024">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5962027">func</span>&nbsp;<span class="ident" id="5962032">isSpace</span><span class="op" id="5962039">(</span><span class="ident" id="5962040">b</span>&nbsp;<span class="builtintype" id="5962042">byte</span><span class="op" id="5962046">)</span>&nbsp;<span class="builtintype" id="5962048">bool</span>&nbsp;<span class="op" id="5962053">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5962056">return</span>&nbsp;<span class="ident" id="5962063">b</span>&nbsp;<span class="op" id="5962065">==</span>&nbsp;<span class="string" id="5962068">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="5962072">||</span>&nbsp;<span class="ident" id="5962075">b</span>&nbsp;<span class="op" id="5962077">==</span>&nbsp;<span class="string" id="5962080">&#39;\t&#39;</span>&nbsp;<span class="op" id="5962085">||</span>&nbsp;<span class="ident" id="5962088">b</span>&nbsp;<span class="op" id="5962090">==</span>&nbsp;<span class="string" id="5962093">&#39;\n&#39;</span>&nbsp;<span class="op" id="5962098">||</span>&nbsp;<span class="ident" id="5962101">b</span>&nbsp;<span class="op" id="5962103">==</span>&nbsp;<span class="string" id="5962106">&#39;\r&#39;</span><br>
<span class="lineno"></span><span class="op" id="5962111">}</span>
</div>
</body>
</html>
