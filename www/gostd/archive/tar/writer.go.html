<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>archive/tar</h2>
<ul>
<li><a href="/gostd/archive/tar/common.go.html">common.go</a></li>
<li><a href="/gostd/archive/tar/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/archive/tar/reader.go.html">reader.go</a></li>
<li><a href="/gostd/archive/tar/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/archive/tar/stat_atim.go.html">stat_atim.go</a></li>
<li><a href="/gostd/archive/tar/stat_unix.go.html">stat_unix.go</a></li>
<li><a href="/gostd/archive/tar/tar_test.go.html">tar_test.go</a></li>
<li><a href="/gostd/archive/tar/writer.go.html">writer.go</a></li>
<li><a href="/gostd/archive/tar/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5929903">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5929958">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5930012">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5930063">package</span>&nbsp;<span class="ident" id="5930071">tar</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5930076">//&nbsp;TODO(dsymonds):</span><br>
<span class="lineno"></span><span class="comment" id="5930095">//&nbsp;-&nbsp;catch&nbsp;more&nbsp;errors&nbsp;(no&nbsp;first&nbsp;header,&nbsp;etc.)</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="5930143">import</span>&nbsp;<span class="op" id="5930150">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5930153">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5930162">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5930172">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5930179">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5930185">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5930191">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5930199">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5930210">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5930221">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="5930228">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5930231">var</span>&nbsp;<span class="op" id="5930235">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5930238">ErrWriteTooLong</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5930257">=</span>&nbsp;<span class="ident" id="5930259">errors</span><span class="op" id="5930265">.</span><span class="ident" id="5930266">New</span><span class="op" id="5930269">(</span><span class="string" id="5930270">&#34;archive/tar:&nbsp;write&nbsp;too&nbsp;long&#34;</span><span class="op" id="5930299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5930302">ErrFieldTooLong</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5930321">=</span>&nbsp;<span class="ident" id="5930323">errors</span><span class="op" id="5930329">.</span><span class="ident" id="5930330">New</span><span class="op" id="5930333">(</span><span class="string" id="5930334">&#34;archive/tar:&nbsp;header&nbsp;field&nbsp;too&nbsp;long&#34;</span><span class="op" id="5930370">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5930373">ErrWriteAfterClose</span>&nbsp;<span class="op" id="5930392">=</span>&nbsp;<span class="ident" id="5930394">errors</span><span class="op" id="5930400">.</span><span class="ident" id="5930401">New</span><span class="op" id="5930404">(</span><span class="string" id="5930405">&#34;archive/tar:&nbsp;write&nbsp;after&nbsp;close&#34;</span><span class="op" id="5930437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5930440">errNameTooLong</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5930459">=</span>&nbsp;<span class="ident" id="5930461">errors</span><span class="op" id="5930467">.</span><span class="ident" id="5930468">New</span><span class="op" id="5930471">(</span><span class="string" id="5930472">&#34;archive/tar:&nbsp;name&nbsp;too&nbsp;long&#34;</span><span class="op" id="5930500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5930503">errInvalidHeader</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5930522">=</span>&nbsp;<span class="ident" id="5930524">errors</span><span class="op" id="5930530">.</span><span class="ident" id="5930531">New</span><span class="op" id="5930534">(</span><span class="string" id="5930535">&#34;archive/tar:&nbsp;header&nbsp;field&nbsp;too&nbsp;long&nbsp;or&nbsp;contains&nbsp;invalid&nbsp;values&#34;</span><span class="op" id="5930598">)</span><br>
<span class="lineno"></span><span class="op" id="5930600">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="comment" id="5930603">//&nbsp;A&nbsp;Writer&nbsp;provides&nbsp;sequential&nbsp;writing&nbsp;of&nbsp;a&nbsp;tar&nbsp;archive&nbsp;in&nbsp;POSIX.1&nbsp;format.</span><br>
<span class="lineno"></span><span class="comment" id="5930679">//&nbsp;A&nbsp;tar&nbsp;archive&nbsp;consists&nbsp;of&nbsp;a&nbsp;sequence&nbsp;of&nbsp;files.</span><br>
<span class="lineno"></span><span class="comment" id="5930729">//&nbsp;Call&nbsp;WriteHeader&nbsp;to&nbsp;begin&nbsp;a&nbsp;new&nbsp;file,&nbsp;and&nbsp;then&nbsp;call&nbsp;Write&nbsp;to&nbsp;supply&nbsp;that&nbsp;file&#39;s&nbsp;data,</span><br>
<span class="lineno"></span><span class="comment" id="5930818">//&nbsp;writing&nbsp;at&nbsp;most&nbsp;hdr.Size&nbsp;bytes&nbsp;in&nbsp;total.</span><br>
<span class="lineno"></span><span class="keyword" id="5930862">type</span>&nbsp;<span class="ident" id="5930867">Writer</span>&nbsp;<span class="keyword" id="5930874">struct</span>&nbsp;<span class="op" id="5930881">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5930884">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5930895">io</span><span class="op" id="5930897">.</span><span class="ident" id="5930898">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5930906">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5930917">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5930924">nb</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5930935">int64</span>&nbsp;<span class="comment" id="5930941">//&nbsp;number&nbsp;of&nbsp;unwritten&nbsp;bytes&nbsp;for&nbsp;current&nbsp;file&nbsp;entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5930994">pad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5931005">int64</span>&nbsp;<span class="comment" id="5931011">//&nbsp;amount&nbsp;of&nbsp;padding&nbsp;to&nbsp;write&nbsp;after&nbsp;current&nbsp;file&nbsp;entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5931067">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5931078">bool</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5931084">usedBinary</span>&nbsp;<span class="builtintype" id="5931095">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5931111">//&nbsp;whether&nbsp;the&nbsp;binary&nbsp;numeric&nbsp;field&nbsp;extension&nbsp;was&nbsp;used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5931167">preferPax</span>&nbsp;&nbsp;<span class="builtintype" id="5931178">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5931194">//&nbsp;use&nbsp;pax&nbsp;header&nbsp;instead&nbsp;of&nbsp;binary&nbsp;numeric&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5931246">hdrBuff</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5931257">[</span><span class="ident" id="5931258">blockSize</span><span class="op" id="5931267">]</span><span class="builtintype" id="5931268">byte</span>&nbsp;<span class="comment" id="5931273">//&nbsp;buffer&nbsp;to&nbsp;use&nbsp;in&nbsp;writeHeader&nbsp;when&nbsp;writing&nbsp;a&nbsp;regular&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5931336">paxHdrBuff</span>&nbsp;<span class="op" id="5931347">[</span><span class="ident" id="5931348">blockSize</span><span class="op" id="5931357">]</span><span class="builtintype" id="5931358">byte</span>&nbsp;<span class="comment" id="5931363">//&nbsp;buffer&nbsp;to&nbsp;use&nbsp;in&nbsp;writeHeader&nbsp;when&nbsp;writing&nbsp;a&nbsp;pax&nbsp;header</span><br>
<span class="lineno"></span><span class="op" id="5931421">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="5931424">//&nbsp;NewWriter&nbsp;creates&nbsp;a&nbsp;new&nbsp;Writer&nbsp;writing&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="5931472">func</span>&nbsp;<span class="ident" id="5931477">NewWriter</span><span class="op" id="5931486">(</span><span class="ident" id="5931487">w</span>&nbsp;<span class="ident" id="5931489">io</span><span class="op" id="5931491">.</span><span class="ident" id="5931492">Writer</span><span class="op" id="5931498">)</span>&nbsp;<span class="op" id="5931500">*</span><span class="ident" id="5931501">Writer</span>&nbsp;<span class="op" id="5931508">{</span>&nbsp;<span class="keyword" id="5931510">return</span>&nbsp;<span class="op" id="5931517">&amp;</span><span class="ident" id="5931518">Writer</span><span class="op" id="5931524">{</span><span class="ident" id="5931525">w</span><span class="op" id="5931526">:</span>&nbsp;<span class="ident" id="5931528">w</span><span class="op" id="5931529">}</span>&nbsp;<span class="op" id="5931531">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5931534">//&nbsp;Flush&nbsp;finishes&nbsp;writing&nbsp;the&nbsp;current&nbsp;file&nbsp;(optional).</span><br>
<span class="lineno">50</span><span class="keyword" id="5931589">func</span>&nbsp;<span class="op" id="5931594">(</span><span class="ident" id="5931595">tw</span>&nbsp;<span class="op" id="5931598">*</span><span class="ident" id="5931599">Writer</span><span class="op" id="5931605">)</span>&nbsp;<span class="ident" id="5931607">Flush</span><span class="op" id="5931612">(</span><span class="op" id="5931613">)</span>&nbsp;<span class="builtintype" id="5931615">error</span>&nbsp;<span class="op" id="5931621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5931624">if</span>&nbsp;<span class="ident" id="5931627">tw</span><span class="op" id="5931629">.</span><span class="ident" id="5931630">nb</span>&nbsp;<span class="op" id="5931633">&gt;</span>&nbsp;<span class="num" id="5931635">0</span>&nbsp;<span class="op" id="5931637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5931641">tw</span><span class="op" id="5931643">.</span><span class="ident" id="5931644">err</span>&nbsp;<span class="op" id="5931648">=</span>&nbsp;<span class="ident" id="5931650">fmt</span><span class="op" id="5931653">.</span><span class="ident" id="5931654">Errorf</span><span class="op" id="5931660">(</span><span class="string" id="5931661">&#34;archive/tar:&nbsp;missed&nbsp;writing&nbsp;%d&nbsp;bytes&#34;</span><span class="op" id="5931699">,</span>&nbsp;<span class="ident" id="5931701">tw</span><span class="op" id="5931703">.</span><span class="ident" id="5931704">nb</span><span class="op" id="5931706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5931710">return</span>&nbsp;<span class="ident" id="5931717">tw</span><span class="op" id="5931719">.</span><span class="ident" id="5931720">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5931725">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5931729">n</span>&nbsp;<span class="op" id="5931731">:=</span>&nbsp;<span class="ident" id="5931734">tw</span><span class="op" id="5931736">.</span><span class="ident" id="5931737">nb</span>&nbsp;<span class="op" id="5931740">+</span>&nbsp;<span class="ident" id="5931742">tw</span><span class="op" id="5931744">.</span><span class="ident" id="5931745">pad</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5931750">for</span>&nbsp;<span class="ident" id="5931754">n</span>&nbsp;<span class="op" id="5931756">&gt;</span>&nbsp;<span class="num" id="5931758">0</span>&nbsp;<span class="op" id="5931760">&amp;&amp;</span>&nbsp;<span class="ident" id="5931763">tw</span><span class="op" id="5931765">.</span><span class="ident" id="5931766">err</span>&nbsp;<span class="op" id="5931770">==</span>&nbsp;<span class="ident" id="5931773">nil</span>&nbsp;<span class="op" id="5931777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5931781">nr</span>&nbsp;<span class="op" id="5931784">:=</span>&nbsp;<span class="ident" id="5931787">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5931791">if</span>&nbsp;<span class="ident" id="5931794">nr</span>&nbsp;<span class="op" id="5931797">&gt;</span>&nbsp;<span class="ident" id="5931799">blockSize</span>&nbsp;<span class="op" id="5931809">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5931814">nr</span>&nbsp;<span class="op" id="5931817">=</span>&nbsp;<span class="ident" id="5931819">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5931831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5931835">var</span>&nbsp;<span class="ident" id="5931839">nw</span>&nbsp;<span class="builtintype" id="5931842">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5931848">nw</span><span class="op" id="5931850">,</span>&nbsp;<span class="ident" id="5931852">tw</span><span class="op" id="5931854">.</span><span class="ident" id="5931855">err</span>&nbsp;<span class="op" id="5931859">=</span>&nbsp;<span class="ident" id="5931861">tw</span><span class="op" id="5931863">.</span><span class="ident" id="5931864">w</span><span class="op" id="5931865">.</span><span class="ident" id="5931866">Write</span><span class="op" id="5931871">(</span><span class="ident" id="5931872">zeroBlock</span><span class="op" id="5931881">[</span><span class="num" id="5931882">0</span><span class="op" id="5931883">:</span><span class="ident" id="5931884">nr</span><span class="op" id="5931886">]</span><span class="op" id="5931887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5931891">n</span>&nbsp;<span class="op" id="5931893">-=</span>&nbsp;<span class="ident" id="5931896">int64</span><span class="op" id="5931901">(</span><span class="ident" id="5931902">nw</span><span class="op" id="5931904">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5931907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5931910">tw</span><span class="op" id="5931912">.</span><span class="ident" id="5931913">nb</span>&nbsp;<span class="op" id="5931916">=</span>&nbsp;<span class="num" id="5931918">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5931921">tw</span><span class="op" id="5931923">.</span><span class="ident" id="5931924">pad</span>&nbsp;<span class="op" id="5931928">=</span>&nbsp;<span class="num" id="5931930">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5931933">return</span>&nbsp;<span class="ident" id="5931940">tw</span><span class="op" id="5931942">.</span><span class="ident" id="5931943">err</span><br>
<span class="lineno"></span><span class="op" id="5931947">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment" id="5931950">//&nbsp;Write&nbsp;s&nbsp;into&nbsp;b,&nbsp;terminating&nbsp;it&nbsp;with&nbsp;a&nbsp;NUL&nbsp;if&nbsp;there&nbsp;is&nbsp;room.</span><br>
<span class="lineno"></span><span class="comment" id="5932013">//&nbsp;If&nbsp;the&nbsp;value&nbsp;is&nbsp;too&nbsp;long&nbsp;for&nbsp;the&nbsp;field&nbsp;and&nbsp;allowPax&nbsp;is&nbsp;true&nbsp;add&nbsp;a&nbsp;paxheader&nbsp;record&nbsp;instead</span><br>
<span class="lineno"></span><span class="keyword" id="5932107">func</span>&nbsp;<span class="op" id="5932112">(</span><span class="ident" id="5932113">tw</span>&nbsp;<span class="op" id="5932116">*</span><span class="ident" id="5932117">Writer</span><span class="op" id="5932123">)</span>&nbsp;<span class="ident" id="5932125">cString</span><span class="op" id="5932132">(</span><span class="ident" id="5932133">b</span>&nbsp;<span class="op" id="5932135">[</span><span class="op" id="5932136">]</span><span class="builtintype" id="5932137">byte</span><span class="op" id="5932141">,</span>&nbsp;<span class="ident" id="5932143">s</span>&nbsp;<span class="builtintype" id="5932145">string</span><span class="op" id="5932151">,</span>&nbsp;<span class="ident" id="5932153">allowPax</span>&nbsp;<span class="builtintype" id="5932162">bool</span><span class="op" id="5932166">,</span>&nbsp;<span class="ident" id="5932168">paxKeyword</span>&nbsp;<span class="builtintype" id="5932179">string</span><span class="op" id="5932185">,</span>&nbsp;<span class="ident" id="5932187">paxHeaders</span>&nbsp;<span class="keyword" id="5932198">map</span><span class="op" id="5932201">[</span><span class="builtintype" id="5932202">string</span><span class="op" id="5932208">]</span><span class="builtintype" id="5932209">string</span><span class="op" id="5932215">)</span>&nbsp;<span class="op" id="5932217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5932220">needsPaxHeader</span>&nbsp;<span class="op" id="5932235">:=</span>&nbsp;<span class="ident" id="5932238">allowPax</span>&nbsp;<span class="op" id="5932247">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5932250">len</span><span class="op" id="5932253">(</span><span class="ident" id="5932254">s</span><span class="op" id="5932255">)</span>&nbsp;<span class="op" id="5932257">&gt;</span>&nbsp;<span class="builtinfunc" id="5932259">len</span><span class="op" id="5932262">(</span><span class="ident" id="5932263">b</span><span class="op" id="5932264">)</span>&nbsp;<span class="op" id="5932266">||</span>&nbsp;<span class="op" id="5932269">!</span><span class="ident" id="5932270">isASCII</span><span class="op" id="5932277">(</span><span class="ident" id="5932278">s</span><span class="op" id="5932279">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5932282">if</span>&nbsp;<span class="ident" id="5932285">needsPaxHeader</span>&nbsp;<span class="op" id="5932300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5932304">paxHeaders</span><span class="op" id="5932314">[</span><span class="ident" id="5932315">paxKeyword</span><span class="op" id="5932325">]</span>&nbsp;<span class="op" id="5932327">=</span>&nbsp;<span class="ident" id="5932329">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5932333">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5932341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5932344">if</span>&nbsp;<span class="builtinfunc" id="5932347">len</span><span class="op" id="5932350">(</span><span class="ident" id="5932351">s</span><span class="op" id="5932352">)</span>&nbsp;<span class="op" id="5932354">&gt;</span>&nbsp;<span class="builtinfunc" id="5932356">len</span><span class="op" id="5932359">(</span><span class="ident" id="5932360">b</span><span class="op" id="5932361">)</span>&nbsp;<span class="op" id="5932363">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5932367">if</span>&nbsp;<span class="ident" id="5932370">tw</span><span class="op" id="5932372">.</span><span class="ident" id="5932373">err</span>&nbsp;<span class="op" id="5932377">==</span>&nbsp;<span class="ident" id="5932380">nil</span>&nbsp;<span class="op" id="5932384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5932389">tw</span><span class="op" id="5932391">.</span><span class="ident" id="5932392">err</span>&nbsp;<span class="op" id="5932396">=</span>&nbsp;<span class="ident" id="5932398">ErrFieldTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5932416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5932420">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5932428">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5932431">ascii</span>&nbsp;<span class="op" id="5932437">:=</span>&nbsp;<span class="ident" id="5932440">toASCII</span><span class="op" id="5932447">(</span><span class="ident" id="5932448">s</span><span class="op" id="5932449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5932452">copy</span><span class="op" id="5932456">(</span><span class="ident" id="5932457">b</span><span class="op" id="5932458">,</span>&nbsp;<span class="ident" id="5932460">ascii</span><span class="op" id="5932465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5932468">if</span>&nbsp;<span class="builtinfunc" id="5932471">len</span><span class="op" id="5932474">(</span><span class="ident" id="5932475">ascii</span><span class="op" id="5932480">)</span>&nbsp;<span class="op" id="5932482">&lt;</span>&nbsp;<span class="builtinfunc" id="5932484">len</span><span class="op" id="5932487">(</span><span class="ident" id="5932488">b</span><span class="op" id="5932489">)</span>&nbsp;<span class="op" id="5932491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5932495">b</span><span class="op" id="5932496">[</span><span class="builtinfunc" id="5932497">len</span><span class="op" id="5932500">(</span><span class="ident" id="5932501">ascii</span><span class="op" id="5932506">)</span><span class="op" id="5932507">]</span>&nbsp;<span class="op" id="5932509">=</span>&nbsp;<span class="num" id="5932511">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5932514">}</span><br>
<span class="lineno">90</span><span class="op" id="5932516">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5932519">//&nbsp;Encode&nbsp;x&nbsp;as&nbsp;an&nbsp;octal&nbsp;ASCII&nbsp;string&nbsp;and&nbsp;write&nbsp;it&nbsp;into&nbsp;b&nbsp;with&nbsp;leading&nbsp;zeros.</span><br>
<span class="lineno"></span><span class="keyword" id="5932596">func</span>&nbsp;<span class="op" id="5932601">(</span><span class="ident" id="5932602">tw</span>&nbsp;<span class="op" id="5932605">*</span><span class="ident" id="5932606">Writer</span><span class="op" id="5932612">)</span>&nbsp;<span class="ident" id="5932614">octal</span><span class="op" id="5932619">(</span><span class="ident" id="5932620">b</span>&nbsp;<span class="op" id="5932622">[</span><span class="op" id="5932623">]</span><span class="builtintype" id="5932624">byte</span><span class="op" id="5932628">,</span>&nbsp;<span class="ident" id="5932630">x</span>&nbsp;<span class="ident" id="5932632">int64</span><span class="op" id="5932637">)</span>&nbsp;<span class="op" id="5932639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5932642">s</span>&nbsp;<span class="op" id="5932644">:=</span>&nbsp;<span class="ident" id="5932647">strconv</span><span class="op" id="5932654">.</span><span class="ident" id="5932655">FormatInt</span><span class="op" id="5932664">(</span><span class="ident" id="5932665">x</span><span class="op" id="5932666">,</span>&nbsp;<span class="num" id="5932668">8</span><span class="op" id="5932669">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5932672">//&nbsp;leading&nbsp;zeros,&nbsp;but&nbsp;leave&nbsp;room&nbsp;for&nbsp;a&nbsp;NUL.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5932717">for</span>&nbsp;<span class="builtinfunc" id="5932721">len</span><span class="op" id="5932724">(</span><span class="ident" id="5932725">s</span><span class="op" id="5932726">)</span><span class="op" id="5932727">+</span><span class="num" id="5932728">1</span>&nbsp;<span class="op" id="5932730">&lt;</span>&nbsp;<span class="builtinfunc" id="5932732">len</span><span class="op" id="5932735">(</span><span class="ident" id="5932736">b</span><span class="op" id="5932737">)</span>&nbsp;<span class="op" id="5932739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5932743">s</span>&nbsp;<span class="op" id="5932745">=</span>&nbsp;<span class="string" id="5932747">&#34;0&#34;</span>&nbsp;<span class="op" id="5932751">+</span>&nbsp;<span class="ident" id="5932753">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5932756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5932759">tw</span><span class="op" id="5932761">.</span><span class="ident" id="5932762">cString</span><span class="op" id="5932769">(</span><span class="ident" id="5932770">b</span><span class="op" id="5932771">,</span>&nbsp;<span class="ident" id="5932773">s</span><span class="op" id="5932774">,</span>&nbsp;<span class="builtintype" id="5932776">false</span><span class="op" id="5932781">,</span>&nbsp;<span class="ident" id="5932783">paxNone</span><span class="op" id="5932790">,</span>&nbsp;<span class="ident" id="5932792">nil</span><span class="op" id="5932795">)</span><br>
<span class="lineno">100</span><span class="op" id="5932797">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5932800">//&nbsp;Write&nbsp;x&nbsp;into&nbsp;b,&nbsp;either&nbsp;as&nbsp;octal&nbsp;or&nbsp;as&nbsp;binary&nbsp;(GNUtar/star&nbsp;extension).</span><br>
<span class="lineno"></span><span class="comment" id="5932873">//&nbsp;If&nbsp;the&nbsp;value&nbsp;is&nbsp;too&nbsp;long&nbsp;for&nbsp;the&nbsp;field&nbsp;and&nbsp;writingPax&nbsp;is&nbsp;enabled&nbsp;both&nbsp;for&nbsp;the&nbsp;field&nbsp;and&nbsp;the&nbsp;add&nbsp;a&nbsp;paxheader&nbsp;record&nbsp;instead</span><br>
<span class="lineno"></span><span class="keyword" id="5932999">func</span>&nbsp;<span class="op" id="5933004">(</span><span class="ident" id="5933005">tw</span>&nbsp;<span class="op" id="5933008">*</span><span class="ident" id="5933009">Writer</span><span class="op" id="5933015">)</span>&nbsp;<span class="ident" id="5933017">numeric</span><span class="op" id="5933024">(</span><span class="ident" id="5933025">b</span>&nbsp;<span class="op" id="5933027">[</span><span class="op" id="5933028">]</span><span class="builtintype" id="5933029">byte</span><span class="op" id="5933033">,</span>&nbsp;<span class="ident" id="5933035">x</span>&nbsp;<span class="ident" id="5933037">int64</span><span class="op" id="5933042">,</span>&nbsp;<span class="ident" id="5933044">allowPax</span>&nbsp;<span class="builtintype" id="5933053">bool</span><span class="op" id="5933057">,</span>&nbsp;<span class="ident" id="5933059">paxKeyword</span>&nbsp;<span class="builtintype" id="5933070">string</span><span class="op" id="5933076">,</span>&nbsp;<span class="ident" id="5933078">paxHeaders</span>&nbsp;<span class="keyword" id="5933089">map</span><span class="op" id="5933092">[</span><span class="builtintype" id="5933093">string</span><span class="op" id="5933099">]</span><span class="builtintype" id="5933100">string</span><span class="op" id="5933106">)</span>&nbsp;<span class="op" id="5933108">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5933111">//&nbsp;Try&nbsp;octal&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5933132">s</span>&nbsp;<span class="op" id="5933134">:=</span>&nbsp;<span class="ident" id="5933137">strconv</span><span class="op" id="5933144">.</span><span class="ident" id="5933145">FormatInt</span><span class="op" id="5933154">(</span><span class="ident" id="5933155">x</span><span class="op" id="5933156">,</span>&nbsp;<span class="num" id="5933158">8</span><span class="op" id="5933159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5933162">if</span>&nbsp;<span class="builtinfunc" id="5933165">len</span><span class="op" id="5933168">(</span><span class="ident" id="5933169">s</span><span class="op" id="5933170">)</span>&nbsp;<span class="op" id="5933172">&lt;</span>&nbsp;<span class="builtinfunc" id="5933174">len</span><span class="op" id="5933177">(</span><span class="ident" id="5933178">b</span><span class="op" id="5933179">)</span>&nbsp;<span class="op" id="5933181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5933185">tw</span><span class="op" id="5933187">.</span><span class="ident" id="5933188">octal</span><span class="op" id="5933193">(</span><span class="ident" id="5933194">b</span><span class="op" id="5933195">,</span>&nbsp;<span class="ident" id="5933197">x</span><span class="op" id="5933198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5933202">return</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5933210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5933214">//&nbsp;If&nbsp;it&nbsp;is&nbsp;too&nbsp;long&nbsp;for&nbsp;octal,&nbsp;and&nbsp;pax&nbsp;is&nbsp;preferred,&nbsp;use&nbsp;a&nbsp;pax&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5933286">if</span>&nbsp;<span class="ident" id="5933289">allowPax</span>&nbsp;<span class="op" id="5933298">&amp;&amp;</span>&nbsp;<span class="ident" id="5933301">tw</span><span class="op" id="5933303">.</span><span class="ident" id="5933304">preferPax</span>&nbsp;<span class="op" id="5933314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5933318">tw</span><span class="op" id="5933320">.</span><span class="ident" id="5933321">octal</span><span class="op" id="5933326">(</span><span class="ident" id="5933327">b</span><span class="op" id="5933328">,</span>&nbsp;<span class="num" id="5933330">0</span><span class="op" id="5933331">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5933335">s</span>&nbsp;<span class="op" id="5933337">:=</span>&nbsp;<span class="ident" id="5933340">strconv</span><span class="op" id="5933347">.</span><span class="ident" id="5933348">FormatInt</span><span class="op" id="5933357">(</span><span class="ident" id="5933358">x</span><span class="op" id="5933359">,</span>&nbsp;<span class="num" id="5933361">10</span><span class="op" id="5933363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5933367">paxHeaders</span><span class="op" id="5933377">[</span><span class="ident" id="5933378">paxKeyword</span><span class="op" id="5933388">]</span>&nbsp;<span class="op" id="5933390">=</span>&nbsp;<span class="ident" id="5933392">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5933396">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5933404">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5933408">//&nbsp;Too&nbsp;big:&nbsp;use&nbsp;binary&nbsp;(big-endian).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5933446">tw</span><span class="op" id="5933448">.</span><span class="ident" id="5933449">usedBinary</span>&nbsp;<span class="op" id="5933460">=</span>&nbsp;<span class="builtintype" id="5933462">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5933468">for</span>&nbsp;<span class="ident" id="5933472">i</span>&nbsp;<span class="op" id="5933474">:=</span>&nbsp;<span class="builtinfunc" id="5933477">len</span><span class="op" id="5933480">(</span><span class="ident" id="5933481">b</span><span class="op" id="5933482">)</span>&nbsp;<span class="op" id="5933484">-</span>&nbsp;<span class="num" id="5933486">1</span><span class="op" id="5933487">;</span>&nbsp;<span class="ident" id="5933489">x</span>&nbsp;<span class="op" id="5933491">&gt;</span>&nbsp;<span class="num" id="5933493">0</span>&nbsp;<span class="op" id="5933495">&amp;&amp;</span>&nbsp;<span class="ident" id="5933498">i</span>&nbsp;<span class="op" id="5933500">&gt;=</span>&nbsp;<span class="num" id="5933503">0</span><span class="op" id="5933504">;</span>&nbsp;<span class="ident" id="5933506">i</span><span class="op" id="5933507">--</span>&nbsp;<span class="op" id="5933510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5933514">b</span><span class="op" id="5933515">[</span><span class="ident" id="5933516">i</span><span class="op" id="5933517">]</span>&nbsp;<span class="op" id="5933519">=</span>&nbsp;<span class="builtintype" id="5933521">byte</span><span class="op" id="5933525">(</span><span class="ident" id="5933526">x</span><span class="op" id="5933527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5933531">x</span>&nbsp;<span class="op" id="5933533">&gt;&gt;=</span>&nbsp;<span class="num" id="5933537">8</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5933540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5933543">b</span><span class="op" id="5933544">[</span><span class="num" id="5933545">0</span><span class="op" id="5933546">]</span>&nbsp;<span class="op" id="5933548">|=</span>&nbsp;<span class="num" id="5933551">0x80</span>&nbsp;<span class="comment" id="5933556">//&nbsp;highest&nbsp;bit&nbsp;indicates&nbsp;binary&nbsp;format</span><br>
<span class="lineno"></span><span class="op" id="5933595">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5933598">var</span>&nbsp;<span class="op" id="5933602">(</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5933605">minTime</span>&nbsp;<span class="op" id="5933613">=</span>&nbsp;<span class="ident" id="5933615">time</span><span class="op" id="5933619">.</span><span class="ident" id="5933620">Unix</span><span class="op" id="5933624">(</span><span class="num" id="5933625">0</span><span class="op" id="5933626">,</span>&nbsp;<span class="num" id="5933628">0</span><span class="op" id="5933629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5933632">//&nbsp;There&nbsp;is&nbsp;room&nbsp;for&nbsp;11&nbsp;octal&nbsp;digits&nbsp;(33&nbsp;bits)&nbsp;of&nbsp;mtime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5933690">maxTime</span>&nbsp;<span class="op" id="5933698">=</span>&nbsp;<span class="ident" id="5933700">minTime</span><span class="op" id="5933707">.</span><span class="ident" id="5933708">Add</span><span class="op" id="5933711">(</span><span class="op" id="5933712">(</span><span class="num" id="5933713">1</span><span class="op" id="5933714">&lt;&lt;</span><span class="num" id="5933716">33</span>&nbsp;<span class="op" id="5933719">-</span>&nbsp;<span class="num" id="5933721">1</span><span class="op" id="5933722">)</span>&nbsp;<span class="op" id="5933724">*</span>&nbsp;<span class="ident" id="5933726">time</span><span class="op" id="5933730">.</span><span class="ident" id="5933731">Second</span><span class="op" id="5933737">)</span><br>
<span class="lineno"></span><span class="op" id="5933739">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="comment" id="5933742">//&nbsp;WriteHeader&nbsp;writes&nbsp;hdr&nbsp;and&nbsp;prepares&nbsp;to&nbsp;accept&nbsp;the&nbsp;file&#39;s&nbsp;contents.</span><br>
<span class="lineno"></span><span class="comment" id="5933812">//&nbsp;WriteHeader&nbsp;calls&nbsp;Flush&nbsp;if&nbsp;it&nbsp;is&nbsp;not&nbsp;the&nbsp;first&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="5933870">//&nbsp;Calling&nbsp;after&nbsp;a&nbsp;Close&nbsp;will&nbsp;return&nbsp;ErrWriteAfterClose.</span><br>
<span class="lineno"></span><span class="keyword" id="5933927">func</span>&nbsp;<span class="op" id="5933932">(</span><span class="ident" id="5933933">tw</span>&nbsp;<span class="op" id="5933936">*</span><span class="ident" id="5933937">Writer</span><span class="op" id="5933943">)</span>&nbsp;<span class="ident" id="5933945">WriteHeader</span><span class="op" id="5933956">(</span><span class="ident" id="5933957">hdr</span>&nbsp;<span class="op" id="5933961">*</span><span class="ident" id="5933962">Header</span><span class="op" id="5933968">)</span>&nbsp;<span class="builtintype" id="5933970">error</span>&nbsp;<span class="op" id="5933976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5933979">return</span>&nbsp;<span class="ident" id="5933986">tw</span><span class="op" id="5933988">.</span><span class="ident" id="5933989">writeHeader</span><span class="op" id="5934000">(</span><span class="ident" id="5934001">hdr</span><span class="op" id="5934004">,</span>&nbsp;<span class="builtintype" id="5934006">true</span><span class="op" id="5934010">)</span><br>
<span class="lineno">140</span><span class="op" id="5934012">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5934015">//&nbsp;WriteHeader&nbsp;writes&nbsp;hdr&nbsp;and&nbsp;prepares&nbsp;to&nbsp;accept&nbsp;the&nbsp;file&#39;s&nbsp;contents.</span><br>
<span class="lineno"></span><span class="comment" id="5934085">//&nbsp;WriteHeader&nbsp;calls&nbsp;Flush&nbsp;if&nbsp;it&nbsp;is&nbsp;not&nbsp;the&nbsp;first&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="5934143">//&nbsp;Calling&nbsp;after&nbsp;a&nbsp;Close&nbsp;will&nbsp;return&nbsp;ErrWriteAfterClose.</span><br>
<span class="lineno">145</span><span class="comment" id="5934200">//&nbsp;As&nbsp;this&nbsp;method&nbsp;is&nbsp;called&nbsp;internally&nbsp;by&nbsp;writePax&nbsp;header&nbsp;to&nbsp;allow&nbsp;it&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5934273">//&nbsp;suppress&nbsp;writing&nbsp;the&nbsp;pax&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="5934309">func</span>&nbsp;<span class="op" id="5934314">(</span><span class="ident" id="5934315">tw</span>&nbsp;<span class="op" id="5934318">*</span><span class="ident" id="5934319">Writer</span><span class="op" id="5934325">)</span>&nbsp;<span class="ident" id="5934327">writeHeader</span><span class="op" id="5934338">(</span><span class="ident" id="5934339">hdr</span>&nbsp;<span class="op" id="5934343">*</span><span class="ident" id="5934344">Header</span><span class="op" id="5934350">,</span>&nbsp;<span class="ident" id="5934352">allowPax</span>&nbsp;<span class="builtintype" id="5934361">bool</span><span class="op" id="5934365">)</span>&nbsp;<span class="builtintype" id="5934367">error</span>&nbsp;<span class="op" id="5934373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5934376">if</span>&nbsp;<span class="ident" id="5934379">tw</span><span class="op" id="5934381">.</span><span class="ident" id="5934382">closed</span>&nbsp;<span class="op" id="5934389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5934393">return</span>&nbsp;<span class="ident" id="5934400">ErrWriteAfterClose</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5934420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5934423">if</span>&nbsp;<span class="ident" id="5934426">tw</span><span class="op" id="5934428">.</span><span class="ident" id="5934429">err</span>&nbsp;<span class="op" id="5934433">==</span>&nbsp;<span class="ident" id="5934436">nil</span>&nbsp;<span class="op" id="5934440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5934444">tw</span><span class="op" id="5934446">.</span><span class="ident" id="5934447">Flush</span><span class="op" id="5934452">(</span><span class="op" id="5934453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5934456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5934459">if</span>&nbsp;<span class="ident" id="5934462">tw</span><span class="op" id="5934464">.</span><span class="ident" id="5934465">err</span>&nbsp;<span class="op" id="5934469">!=</span>&nbsp;<span class="ident" id="5934472">nil</span>&nbsp;<span class="op" id="5934476">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5934480">return</span>&nbsp;<span class="ident" id="5934487">tw</span><span class="op" id="5934489">.</span><span class="ident" id="5934490">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5934495">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5934499">//&nbsp;a&nbsp;map&nbsp;to&nbsp;hold&nbsp;pax&nbsp;header&nbsp;records,&nbsp;if&nbsp;any&nbsp;are&nbsp;needed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5934555">paxHeaders</span>&nbsp;<span class="op" id="5934566">:=</span>&nbsp;<span class="builtinfunc" id="5934569">make</span><span class="op" id="5934573">(</span><span class="keyword" id="5934574">map</span><span class="op" id="5934577">[</span><span class="builtintype" id="5934578">string</span><span class="op" id="5934584">]</span><span class="builtintype" id="5934585">string</span><span class="op" id="5934591">)</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5934595">//&nbsp;TODO(shanemhansen):&nbsp;we&nbsp;might&nbsp;want&nbsp;to&nbsp;use&nbsp;PAX&nbsp;headers&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5934656">//&nbsp;subsecond&nbsp;time&nbsp;resolution,&nbsp;but&nbsp;for&nbsp;now&nbsp;let&#39;s&nbsp;just&nbsp;capture</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5934718">//&nbsp;too&nbsp;long&nbsp;fields&nbsp;or&nbsp;non&nbsp;ascii&nbsp;characters</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5934763">var</span>&nbsp;<span class="ident" id="5934767">header</span>&nbsp;<span class="op" id="5934774">[</span><span class="op" id="5934775">]</span><span class="builtintype" id="5934776">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5934783">//&nbsp;We&nbsp;need&nbsp;to&nbsp;select&nbsp;which&nbsp;scratch&nbsp;buffer&nbsp;to&nbsp;use&nbsp;carefully,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5934844">//&nbsp;since&nbsp;this&nbsp;method&nbsp;is&nbsp;called&nbsp;recursively&nbsp;to&nbsp;write&nbsp;PAX&nbsp;headers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5934910">//&nbsp;If&nbsp;allowPax&nbsp;is&nbsp;true,&nbsp;this&nbsp;is&nbsp;the&nbsp;non-recursive&nbsp;call,&nbsp;and&nbsp;we&nbsp;will&nbsp;use&nbsp;hdrBuff.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5934992">//&nbsp;If&nbsp;allowPax&nbsp;is&nbsp;false,&nbsp;we&nbsp;are&nbsp;being&nbsp;called&nbsp;by&nbsp;writePAXHeader,&nbsp;and&nbsp;hdrBuff&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5935072">//&nbsp;already&nbsp;being&nbsp;used&nbsp;by&nbsp;the&nbsp;non-recursive&nbsp;call,&nbsp;so&nbsp;we&nbsp;must&nbsp;use&nbsp;paxHdrBuff.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5935149">header</span>&nbsp;<span class="op" id="5935156">=</span>&nbsp;<span class="ident" id="5935158">tw</span><span class="op" id="5935160">.</span><span class="ident" id="5935161">hdrBuff</span><span class="op" id="5935168">[</span><span class="op" id="5935169">:</span><span class="op" id="5935170">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5935173">if</span>&nbsp;<span class="op" id="5935176">!</span><span class="ident" id="5935177">allowPax</span>&nbsp;<span class="op" id="5935186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5935190">header</span>&nbsp;<span class="op" id="5935197">=</span>&nbsp;<span class="ident" id="5935199">tw</span><span class="op" id="5935201">.</span><span class="ident" id="5935202">paxHdrBuff</span><span class="op" id="5935212">[</span><span class="op" id="5935213">:</span><span class="op" id="5935214">]</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5935217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5935220">copy</span><span class="op" id="5935224">(</span><span class="ident" id="5935225">header</span><span class="op" id="5935231">,</span>&nbsp;<span class="ident" id="5935233">zeroBlock</span><span class="op" id="5935242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5935245">s</span>&nbsp;<span class="op" id="5935247">:=</span>&nbsp;<span class="ident" id="5935250">slicer</span><span class="op" id="5935256">(</span><span class="ident" id="5935257">header</span><span class="op" id="5935263">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5935267">//&nbsp;keep&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;filename&nbsp;to&nbsp;allow&nbsp;to&nbsp;overwrite&nbsp;it&nbsp;later&nbsp;if&nbsp;we&nbsp;detect&nbsp;that&nbsp;we&nbsp;can&nbsp;use&nbsp;ustar&nbsp;longnames&nbsp;instead&nbsp;of&nbsp;pax</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5935395">pathHeaderBytes</span>&nbsp;<span class="op" id="5935411">:=</span>&nbsp;<span class="ident" id="5935414">s</span><span class="op" id="5935415">.</span><span class="ident" id="5935416">next</span><span class="op" id="5935420">(</span><span class="ident" id="5935421">fileNameSize</span><span class="op" id="5935433">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5935437">tw</span><span class="op" id="5935439">.</span><span class="ident" id="5935440">cString</span><span class="op" id="5935447">(</span><span class="ident" id="5935448">pathHeaderBytes</span><span class="op" id="5935463">,</span>&nbsp;<span class="ident" id="5935465">hdr</span><span class="op" id="5935468">.</span><span class="ident" id="5935469">Name</span><span class="op" id="5935473">,</span>&nbsp;<span class="builtintype" id="5935475">true</span><span class="op" id="5935479">,</span>&nbsp;<span class="ident" id="5935481">paxPath</span><span class="op" id="5935488">,</span>&nbsp;<span class="ident" id="5935490">paxHeaders</span><span class="op" id="5935500">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5935504">//&nbsp;Handle&nbsp;out&nbsp;of&nbsp;range&nbsp;ModTime&nbsp;carefully.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5935547">var</span>&nbsp;<span class="ident" id="5935551">modTime</span>&nbsp;<span class="ident" id="5935559">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5935566">if</span>&nbsp;<span class="op" id="5935569">!</span><span class="ident" id="5935570">hdr</span><span class="op" id="5935573">.</span><span class="ident" id="5935574">ModTime</span><span class="op" id="5935581">.</span><span class="ident" id="5935582">Before</span><span class="op" id="5935588">(</span><span class="ident" id="5935589">minTime</span><span class="op" id="5935596">)</span>&nbsp;<span class="op" id="5935598">&amp;&amp;</span>&nbsp;<span class="op" id="5935601">!</span><span class="ident" id="5935602">hdr</span><span class="op" id="5935605">.</span><span class="ident" id="5935606">ModTime</span><span class="op" id="5935613">.</span><span class="ident" id="5935614">After</span><span class="op" id="5935619">(</span><span class="ident" id="5935620">maxTime</span><span class="op" id="5935627">)</span>&nbsp;<span class="op" id="5935629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5935633">modTime</span>&nbsp;<span class="op" id="5935641">=</span>&nbsp;<span class="ident" id="5935643">hdr</span><span class="op" id="5935646">.</span><span class="ident" id="5935647">ModTime</span><span class="op" id="5935654">.</span><span class="ident" id="5935655">Unix</span><span class="op" id="5935659">(</span><span class="op" id="5935660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5935663">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5935667">tw</span><span class="op" id="5935669">.</span><span class="ident" id="5935670">octal</span><span class="op" id="5935675">(</span><span class="ident" id="5935676">s</span><span class="op" id="5935677">.</span><span class="ident" id="5935678">next</span><span class="op" id="5935682">(</span><span class="num" id="5935683">8</span><span class="op" id="5935684">)</span><span class="op" id="5935685">,</span>&nbsp;<span class="ident" id="5935687">hdr</span><span class="op" id="5935690">.</span><span class="ident" id="5935691">Mode</span><span class="op" id="5935695">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5935731">//&nbsp;100:108</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5935743">tw</span><span class="op" id="5935745">.</span><span class="ident" id="5935746">numeric</span><span class="op" id="5935753">(</span><span class="ident" id="5935754">s</span><span class="op" id="5935755">.</span><span class="ident" id="5935756">next</span><span class="op" id="5935760">(</span><span class="num" id="5935761">8</span><span class="op" id="5935762">)</span><span class="op" id="5935763">,</span>&nbsp;<span class="ident" id="5935765">int64</span><span class="op" id="5935770">(</span><span class="ident" id="5935771">hdr</span><span class="op" id="5935774">.</span><span class="ident" id="5935775">Uid</span><span class="op" id="5935778">)</span><span class="op" id="5935779">,</span>&nbsp;<span class="builtintype" id="5935781">true</span><span class="op" id="5935785">,</span>&nbsp;<span class="ident" id="5935787">paxUid</span><span class="op" id="5935793">,</span>&nbsp;<span class="ident" id="5935795">paxHeaders</span><span class="op" id="5935805">)</span>&nbsp;<span class="comment" id="5935807">//&nbsp;108:116</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5935819">tw</span><span class="op" id="5935821">.</span><span class="ident" id="5935822">numeric</span><span class="op" id="5935829">(</span><span class="ident" id="5935830">s</span><span class="op" id="5935831">.</span><span class="ident" id="5935832">next</span><span class="op" id="5935836">(</span><span class="num" id="5935837">8</span><span class="op" id="5935838">)</span><span class="op" id="5935839">,</span>&nbsp;<span class="ident" id="5935841">int64</span><span class="op" id="5935846">(</span><span class="ident" id="5935847">hdr</span><span class="op" id="5935850">.</span><span class="ident" id="5935851">Gid</span><span class="op" id="5935854">)</span><span class="op" id="5935855">,</span>&nbsp;<span class="builtintype" id="5935857">true</span><span class="op" id="5935861">,</span>&nbsp;<span class="ident" id="5935863">paxGid</span><span class="op" id="5935869">,</span>&nbsp;<span class="ident" id="5935871">paxHeaders</span><span class="op" id="5935881">)</span>&nbsp;<span class="comment" id="5935883">//&nbsp;116:124</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5935895">tw</span><span class="op" id="5935897">.</span><span class="ident" id="5935898">numeric</span><span class="op" id="5935905">(</span><span class="ident" id="5935906">s</span><span class="op" id="5935907">.</span><span class="ident" id="5935908">next</span><span class="op" id="5935912">(</span><span class="num" id="5935913">12</span><span class="op" id="5935915">)</span><span class="op" id="5935916">,</span>&nbsp;<span class="ident" id="5935918">hdr</span><span class="op" id="5935921">.</span><span class="ident" id="5935922">Size</span><span class="op" id="5935926">,</span>&nbsp;<span class="builtintype" id="5935928">true</span><span class="op" id="5935932">,</span>&nbsp;<span class="ident" id="5935934">paxSize</span><span class="op" id="5935941">,</span>&nbsp;<span class="ident" id="5935943">paxHeaders</span><span class="op" id="5935953">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5935959">//&nbsp;124:136</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5935971">tw</span><span class="op" id="5935973">.</span><span class="ident" id="5935974">numeric</span><span class="op" id="5935981">(</span><span class="ident" id="5935982">s</span><span class="op" id="5935983">.</span><span class="ident" id="5935984">next</span><span class="op" id="5935988">(</span><span class="num" id="5935989">12</span><span class="op" id="5935991">)</span><span class="op" id="5935992">,</span>&nbsp;<span class="ident" id="5935994">modTime</span><span class="op" id="5936001">,</span>&nbsp;<span class="builtintype" id="5936003">false</span><span class="op" id="5936008">,</span>&nbsp;<span class="ident" id="5936010">paxNone</span><span class="op" id="5936017">,</span>&nbsp;<span class="ident" id="5936019">nil</span><span class="op" id="5936022">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5936035">//&nbsp;136:148&nbsp;---&nbsp;consider&nbsp;using&nbsp;pax&nbsp;for&nbsp;finer&nbsp;granularity</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5936092">s</span><span class="op" id="5936093">.</span><span class="ident" id="5936094">next</span><span class="op" id="5936098">(</span><span class="num" id="5936099">8</span><span class="op" id="5936100">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5936156">//&nbsp;chksum&nbsp;(148:156)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5936177">s</span><span class="op" id="5936178">.</span><span class="ident" id="5936179">next</span><span class="op" id="5936183">(</span><span class="num" id="5936184">1</span><span class="op" id="5936185">)</span><span class="op" id="5936186">[</span><span class="num" id="5936187">0</span><span class="op" id="5936188">]</span>&nbsp;<span class="op" id="5936190">=</span>&nbsp;<span class="ident" id="5936192">hdr</span><span class="op" id="5936195">.</span><span class="ident" id="5936196">Typeflag</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5936241">//&nbsp;156:157</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5936254">tw</span><span class="op" id="5936256">.</span><span class="ident" id="5936257">cString</span><span class="op" id="5936264">(</span><span class="ident" id="5936265">s</span><span class="op" id="5936266">.</span><span class="ident" id="5936267">next</span><span class="op" id="5936271">(</span><span class="num" id="5936272">100</span><span class="op" id="5936275">)</span><span class="op" id="5936276">,</span>&nbsp;<span class="ident" id="5936278">hdr</span><span class="op" id="5936281">.</span><span class="ident" id="5936282">Linkname</span><span class="op" id="5936290">,</span>&nbsp;<span class="builtintype" id="5936292">true</span><span class="op" id="5936296">,</span>&nbsp;<span class="ident" id="5936298">paxLinkpath</span><span class="op" id="5936309">,</span>&nbsp;<span class="ident" id="5936311">paxHeaders</span><span class="op" id="5936321">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5936325">copy</span><span class="op" id="5936329">(</span><span class="ident" id="5936330">s</span><span class="op" id="5936331">.</span><span class="ident" id="5936332">next</span><span class="op" id="5936336">(</span><span class="num" id="5936337">8</span><span class="op" id="5936338">)</span><span class="op" id="5936339">,</span>&nbsp;<span class="op" id="5936341">[</span><span class="op" id="5936342">]</span><span class="builtintype" id="5936343">byte</span><span class="op" id="5936347">(</span><span class="string" id="5936348">&#34;ustar\x0000&#34;</span><span class="op" id="5936361">)</span><span class="op" id="5936362">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5936387">//&nbsp;257:265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5936399">tw</span><span class="op" id="5936401">.</span><span class="ident" id="5936402">cString</span><span class="op" id="5936409">(</span><span class="ident" id="5936410">s</span><span class="op" id="5936411">.</span><span class="ident" id="5936412">next</span><span class="op" id="5936416">(</span><span class="num" id="5936417">32</span><span class="op" id="5936419">)</span><span class="op" id="5936420">,</span>&nbsp;<span class="ident" id="5936422">hdr</span><span class="op" id="5936425">.</span><span class="ident" id="5936426">Uname</span><span class="op" id="5936431">,</span>&nbsp;<span class="builtintype" id="5936433">true</span><span class="op" id="5936437">,</span>&nbsp;<span class="ident" id="5936439">paxUname</span><span class="op" id="5936447">,</span>&nbsp;<span class="ident" id="5936449">paxHeaders</span><span class="op" id="5936459">)</span>&nbsp;<span class="comment" id="5936461">//&nbsp;265:297</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5936473">tw</span><span class="op" id="5936475">.</span><span class="ident" id="5936476">cString</span><span class="op" id="5936483">(</span><span class="ident" id="5936484">s</span><span class="op" id="5936485">.</span><span class="ident" id="5936486">next</span><span class="op" id="5936490">(</span><span class="num" id="5936491">32</span><span class="op" id="5936493">)</span><span class="op" id="5936494">,</span>&nbsp;<span class="ident" id="5936496">hdr</span><span class="op" id="5936499">.</span><span class="ident" id="5936500">Gname</span><span class="op" id="5936505">,</span>&nbsp;<span class="builtintype" id="5936507">true</span><span class="op" id="5936511">,</span>&nbsp;<span class="ident" id="5936513">paxGname</span><span class="op" id="5936521">,</span>&nbsp;<span class="ident" id="5936523">paxHeaders</span><span class="op" id="5936533">)</span>&nbsp;<span class="comment" id="5936535">//&nbsp;297:329</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5936547">tw</span><span class="op" id="5936549">.</span><span class="ident" id="5936550">numeric</span><span class="op" id="5936557">(</span><span class="ident" id="5936558">s</span><span class="op" id="5936559">.</span><span class="ident" id="5936560">next</span><span class="op" id="5936564">(</span><span class="num" id="5936565">8</span><span class="op" id="5936566">)</span><span class="op" id="5936567">,</span>&nbsp;<span class="ident" id="5936569">hdr</span><span class="op" id="5936572">.</span><span class="ident" id="5936573">Devmajor</span><span class="op" id="5936581">,</span>&nbsp;<span class="builtintype" id="5936583">false</span><span class="op" id="5936588">,</span>&nbsp;<span class="ident" id="5936590">paxNone</span><span class="op" id="5936597">,</span>&nbsp;<span class="ident" id="5936599">nil</span><span class="op" id="5936602">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5936609">//&nbsp;329:337</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5936621">tw</span><span class="op" id="5936623">.</span><span class="ident" id="5936624">numeric</span><span class="op" id="5936631">(</span><span class="ident" id="5936632">s</span><span class="op" id="5936633">.</span><span class="ident" id="5936634">next</span><span class="op" id="5936638">(</span><span class="num" id="5936639">8</span><span class="op" id="5936640">)</span><span class="op" id="5936641">,</span>&nbsp;<span class="ident" id="5936643">hdr</span><span class="op" id="5936646">.</span><span class="ident" id="5936647">Devminor</span><span class="op" id="5936655">,</span>&nbsp;<span class="builtintype" id="5936657">false</span><span class="op" id="5936662">,</span>&nbsp;<span class="ident" id="5936664">paxNone</span><span class="op" id="5936671">,</span>&nbsp;<span class="ident" id="5936673">nil</span><span class="op" id="5936676">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5936683">//&nbsp;337:345</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5936696">//&nbsp;keep&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;prefix&nbsp;to&nbsp;allow&nbsp;to&nbsp;overwrite&nbsp;it&nbsp;later&nbsp;if&nbsp;we&nbsp;detect&nbsp;that&nbsp;we&nbsp;can&nbsp;use&nbsp;ustar&nbsp;longnames&nbsp;instead&nbsp;of&nbsp;pax</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5936822">prefixHeaderBytes</span>&nbsp;<span class="op" id="5936840">:=</span>&nbsp;<span class="ident" id="5936843">s</span><span class="op" id="5936844">.</span><span class="ident" id="5936845">next</span><span class="op" id="5936849">(</span><span class="num" id="5936850">155</span><span class="op" id="5936853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5936856">tw</span><span class="op" id="5936858">.</span><span class="ident" id="5936859">cString</span><span class="op" id="5936866">(</span><span class="ident" id="5936867">prefixHeaderBytes</span><span class="op" id="5936884">,</span>&nbsp;<span class="string" id="5936886">&#34;&#34;</span><span class="op" id="5936888">,</span>&nbsp;<span class="builtintype" id="5936890">false</span><span class="op" id="5936895">,</span>&nbsp;<span class="ident" id="5936897">paxNone</span><span class="op" id="5936904">,</span>&nbsp;<span class="ident" id="5936906">nil</span><span class="op" id="5936909">)</span>&nbsp;<span class="comment" id="5936911">//&nbsp;345:500&nbsp;&nbsp;prefix</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5936932">//&nbsp;Use&nbsp;the&nbsp;GNU&nbsp;magic&nbsp;instead&nbsp;of&nbsp;POSIX&nbsp;magic&nbsp;if&nbsp;we&nbsp;used&nbsp;any&nbsp;GNU&nbsp;extensions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5937008">if</span>&nbsp;<span class="ident" id="5937011">tw</span><span class="op" id="5937013">.</span><span class="ident" id="5937014">usedBinary</span>&nbsp;<span class="op" id="5937025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5937029">copy</span><span class="op" id="5937033">(</span><span class="ident" id="5937034">header</span><span class="op" id="5937040">[</span><span class="num" id="5937041">257</span><span class="op" id="5937044">:</span><span class="num" id="5937045">265</span><span class="op" id="5937048">]</span><span class="op" id="5937049">,</span>&nbsp;<span class="op" id="5937051">[</span><span class="op" id="5937052">]</span><span class="builtintype" id="5937053">byte</span><span class="op" id="5937057">(</span><span class="string" id="5937058">&#34;ustar&nbsp;&nbsp;\x00&#34;</span><span class="op" id="5937071">)</span><span class="op" id="5937072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5937075">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5937079">_</span><span class="op" id="5937080">,</span>&nbsp;<span class="ident" id="5937082">paxPathUsed</span>&nbsp;<span class="op" id="5937094">:=</span>&nbsp;<span class="ident" id="5937097">paxHeaders</span><span class="op" id="5937107">[</span><span class="ident" id="5937108">paxPath</span><span class="op" id="5937115">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5937118">//&nbsp;try&nbsp;to&nbsp;use&nbsp;a&nbsp;ustar&nbsp;header&nbsp;when&nbsp;only&nbsp;the&nbsp;name&nbsp;is&nbsp;too&nbsp;long</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5937179">if</span>&nbsp;<span class="op" id="5937182">!</span><span class="ident" id="5937183">tw</span><span class="op" id="5937185">.</span><span class="ident" id="5937186">preferPax</span>&nbsp;<span class="op" id="5937196">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5937199">len</span><span class="op" id="5937202">(</span><span class="ident" id="5937203">paxHeaders</span><span class="op" id="5937213">)</span>&nbsp;<span class="op" id="5937215">==</span>&nbsp;<span class="num" id="5937218">1</span>&nbsp;<span class="op" id="5937220">&amp;&amp;</span>&nbsp;<span class="ident" id="5937223">paxPathUsed</span>&nbsp;<span class="op" id="5937235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5937239">suffix</span>&nbsp;<span class="op" id="5937246">:=</span>&nbsp;<span class="ident" id="5937249">hdr</span><span class="op" id="5937252">.</span><span class="ident" id="5937253">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5937260">prefix</span>&nbsp;<span class="op" id="5937267">:=</span>&nbsp;<span class="string" id="5937270">&#34;&#34;</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5937275">if</span>&nbsp;<span class="builtinfunc" id="5937278">len</span><span class="op" id="5937281">(</span><span class="ident" id="5937282">hdr</span><span class="op" id="5937285">.</span><span class="ident" id="5937286">Name</span><span class="op" id="5937290">)</span>&nbsp;<span class="op" id="5937292">&gt;</span>&nbsp;<span class="ident" id="5937294">fileNameSize</span>&nbsp;<span class="op" id="5937307">&amp;&amp;</span>&nbsp;<span class="ident" id="5937310">isASCII</span><span class="op" id="5937317">(</span><span class="ident" id="5937318">hdr</span><span class="op" id="5937321">.</span><span class="ident" id="5937322">Name</span><span class="op" id="5937326">)</span>&nbsp;<span class="op" id="5937328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5937333">var</span>&nbsp;<span class="ident" id="5937337">err</span>&nbsp;<span class="builtintype" id="5937341">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5937350">prefix</span><span class="op" id="5937356">,</span>&nbsp;<span class="ident" id="5937358">suffix</span><span class="op" id="5937364">,</span>&nbsp;<span class="ident" id="5937366">err</span>&nbsp;<span class="op" id="5937370">=</span>&nbsp;<span class="ident" id="5937372">tw</span><span class="op" id="5937374">.</span><span class="ident" id="5937375">splitUSTARLongName</span><span class="op" id="5937393">(</span><span class="ident" id="5937394">hdr</span><span class="op" id="5937397">.</span><span class="ident" id="5937398">Name</span><span class="op" id="5937402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5937407">if</span>&nbsp;<span class="ident" id="5937410">err</span>&nbsp;<span class="op" id="5937414">==</span>&nbsp;<span class="ident" id="5937417">nil</span>&nbsp;<span class="op" id="5937421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5937427">//&nbsp;ok&nbsp;we&nbsp;can&nbsp;use&nbsp;a&nbsp;ustar&nbsp;long&nbsp;name&nbsp;instead&nbsp;of&nbsp;pax,&nbsp;now&nbsp;correct&nbsp;the&nbsp;fields</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5937506">//&nbsp;remove&nbsp;the&nbsp;path&nbsp;field&nbsp;from&nbsp;the&nbsp;pax&nbsp;header.&nbsp;this&nbsp;will&nbsp;suppress&nbsp;the&nbsp;pax&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5937590">delete</span><span class="op" id="5937596">(</span><span class="ident" id="5937597">paxHeaders</span><span class="op" id="5937607">,</span>&nbsp;<span class="ident" id="5937609">paxPath</span><span class="op" id="5937616">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5937623">//&nbsp;update&nbsp;the&nbsp;path&nbsp;fields</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5937653">tw</span><span class="op" id="5937655">.</span><span class="ident" id="5937656">cString</span><span class="op" id="5937663">(</span><span class="ident" id="5937664">pathHeaderBytes</span><span class="op" id="5937679">,</span>&nbsp;<span class="ident" id="5937681">suffix</span><span class="op" id="5937687">,</span>&nbsp;<span class="builtintype" id="5937689">false</span><span class="op" id="5937694">,</span>&nbsp;<span class="ident" id="5937696">paxNone</span><span class="op" id="5937703">,</span>&nbsp;<span class="ident" id="5937705">nil</span><span class="op" id="5937708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5937714">tw</span><span class="op" id="5937716">.</span><span class="ident" id="5937717">cString</span><span class="op" id="5937724">(</span><span class="ident" id="5937725">prefixHeaderBytes</span><span class="op" id="5937742">,</span>&nbsp;<span class="ident" id="5937744">prefix</span><span class="op" id="5937750">,</span>&nbsp;<span class="builtintype" id="5937752">false</span><span class="op" id="5937757">,</span>&nbsp;<span class="ident" id="5937759">paxNone</span><span class="op" id="5937766">,</span>&nbsp;<span class="ident" id="5937768">nil</span><span class="op" id="5937771">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5937778">//&nbsp;Use&nbsp;the&nbsp;ustar&nbsp;magic&nbsp;if&nbsp;we&nbsp;used&nbsp;ustar&nbsp;long&nbsp;names.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5937834">if</span>&nbsp;<span class="builtinfunc" id="5937837">len</span><span class="op" id="5937840">(</span><span class="ident" id="5937841">prefix</span><span class="op" id="5937847">)</span>&nbsp;<span class="op" id="5937849">&gt;</span>&nbsp;<span class="num" id="5937851">0</span>&nbsp;<span class="op" id="5937853">&amp;&amp;</span>&nbsp;<span class="op" id="5937856">!</span><span class="ident" id="5937857">tw</span><span class="op" id="5937859">.</span><span class="ident" id="5937860">usedBinary</span>&nbsp;<span class="op" id="5937871">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5937878">copy</span><span class="op" id="5937882">(</span><span class="ident" id="5937883">header</span><span class="op" id="5937889">[</span><span class="num" id="5937890">257</span><span class="op" id="5937893">:</span><span class="num" id="5937894">265</span><span class="op" id="5937897">]</span><span class="op" id="5937898">,</span>&nbsp;<span class="op" id="5937900">[</span><span class="op" id="5937901">]</span><span class="builtintype" id="5937902">byte</span><span class="op" id="5937906">(</span><span class="string" id="5937907">&#34;ustar\x00&#34;</span><span class="op" id="5937918">)</span><span class="op" id="5937919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5937925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5937930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5937934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5937937">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5937941">//&nbsp;The&nbsp;chksum&nbsp;field&nbsp;is&nbsp;terminated&nbsp;by&nbsp;a&nbsp;NUL&nbsp;and&nbsp;a&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5937998">//&nbsp;This&nbsp;is&nbsp;different&nbsp;from&nbsp;the&nbsp;other&nbsp;octal&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5938049">chksum</span><span class="op" id="5938055">,</span>&nbsp;<span class="ident" id="5938057">_</span>&nbsp;<span class="op" id="5938059">:=</span>&nbsp;<span class="ident" id="5938062">checksum</span><span class="op" id="5938070">(</span><span class="ident" id="5938071">header</span><span class="op" id="5938077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5938080">tw</span><span class="op" id="5938082">.</span><span class="ident" id="5938083">octal</span><span class="op" id="5938088">(</span><span class="ident" id="5938089">header</span><span class="op" id="5938095">[</span><span class="num" id="5938096">148</span><span class="op" id="5938099">:</span><span class="num" id="5938100">155</span><span class="op" id="5938103">]</span><span class="op" id="5938104">,</span>&nbsp;<span class="ident" id="5938106">chksum</span><span class="op" id="5938112">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5938115">header</span><span class="op" id="5938121">[</span><span class="num" id="5938122">155</span><span class="op" id="5938125">]</span>&nbsp;<span class="op" id="5938127">=</span>&nbsp;<span class="string" id="5938129">&#39;&nbsp;&#39;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5938135">if</span>&nbsp;<span class="ident" id="5938138">tw</span><span class="op" id="5938140">.</span><span class="ident" id="5938141">err</span>&nbsp;<span class="op" id="5938145">!=</span>&nbsp;<span class="ident" id="5938148">nil</span>&nbsp;<span class="op" id="5938152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5938156">//&nbsp;problem&nbsp;with&nbsp;header;&nbsp;probably&nbsp;integer&nbsp;too&nbsp;big&nbsp;for&nbsp;a&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5938220">return</span>&nbsp;<span class="ident" id="5938227">tw</span><span class="op" id="5938229">.</span><span class="ident" id="5938230">err</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5938235">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5938239">if</span>&nbsp;<span class="ident" id="5938242">allowPax</span>&nbsp;<span class="op" id="5938251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5938255">for</span>&nbsp;<span class="ident" id="5938259">k</span><span class="op" id="5938260">,</span>&nbsp;<span class="ident" id="5938262">v</span>&nbsp;<span class="op" id="5938264">:=</span>&nbsp;<span class="keyword" id="5938267">range</span>&nbsp;<span class="ident" id="5938273">hdr</span><span class="op" id="5938276">.</span><span class="ident" id="5938277">Xattrs</span>&nbsp;<span class="op" id="5938284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5938289">paxHeaders</span><span class="op" id="5938299">[</span><span class="ident" id="5938300">paxXattr</span><span class="op" id="5938308">+</span><span class="ident" id="5938309">k</span><span class="op" id="5938310">]</span>&nbsp;<span class="op" id="5938312">=</span>&nbsp;<span class="ident" id="5938314">v</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5938318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5938321">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5938325">if</span>&nbsp;<span class="builtinfunc" id="5938328">len</span><span class="op" id="5938331">(</span><span class="ident" id="5938332">paxHeaders</span><span class="op" id="5938342">)</span>&nbsp;<span class="op" id="5938344">&gt;</span>&nbsp;<span class="num" id="5938346">0</span>&nbsp;<span class="op" id="5938348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5938352">if</span>&nbsp;<span class="op" id="5938355">!</span><span class="ident" id="5938356">allowPax</span>&nbsp;<span class="op" id="5938365">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5938370">return</span>&nbsp;<span class="ident" id="5938377">errInvalidHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5938396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5938400">if</span>&nbsp;<span class="ident" id="5938403">err</span>&nbsp;<span class="op" id="5938407">:=</span>&nbsp;<span class="ident" id="5938410">tw</span><span class="op" id="5938412">.</span><span class="ident" id="5938413">writePAXHeader</span><span class="op" id="5938427">(</span><span class="ident" id="5938428">hdr</span><span class="op" id="5938431">,</span>&nbsp;<span class="ident" id="5938433">paxHeaders</span><span class="op" id="5938443">)</span><span class="op" id="5938444">;</span>&nbsp;<span class="ident" id="5938446">err</span>&nbsp;<span class="op" id="5938450">!=</span>&nbsp;<span class="ident" id="5938453">nil</span>&nbsp;<span class="op" id="5938457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5938462">return</span>&nbsp;<span class="ident" id="5938469">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5938475">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5938478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5938481">tw</span><span class="op" id="5938483">.</span><span class="ident" id="5938484">nb</span>&nbsp;<span class="op" id="5938487">=</span>&nbsp;<span class="ident" id="5938489">int64</span><span class="op" id="5938494">(</span><span class="ident" id="5938495">hdr</span><span class="op" id="5938498">.</span><span class="ident" id="5938499">Size</span><span class="op" id="5938503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5938506">tw</span><span class="op" id="5938508">.</span><span class="ident" id="5938509">pad</span>&nbsp;<span class="op" id="5938513">=</span>&nbsp;<span class="op" id="5938515">(</span><span class="ident" id="5938516">blockSize</span>&nbsp;<span class="op" id="5938526">-</span>&nbsp;<span class="op" id="5938528">(</span><span class="ident" id="5938529">tw</span><span class="op" id="5938531">.</span><span class="ident" id="5938532">nb</span>&nbsp;<span class="op" id="5938535">%</span>&nbsp;<span class="ident" id="5938537">blockSize</span><span class="op" id="5938546">)</span><span class="op" id="5938547">)</span>&nbsp;<span class="op" id="5938549">%</span>&nbsp;<span class="ident" id="5938551">blockSize</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5938563">_</span><span class="op" id="5938564">,</span>&nbsp;<span class="ident" id="5938566">tw</span><span class="op" id="5938568">.</span><span class="ident" id="5938569">err</span>&nbsp;<span class="op" id="5938573">=</span>&nbsp;<span class="ident" id="5938575">tw</span><span class="op" id="5938577">.</span><span class="ident" id="5938578">w</span><span class="op" id="5938579">.</span><span class="ident" id="5938580">Write</span><span class="op" id="5938585">(</span><span class="ident" id="5938586">header</span><span class="op" id="5938592">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5938595">return</span>&nbsp;<span class="ident" id="5938602">tw</span><span class="op" id="5938604">.</span><span class="ident" id="5938605">err</span><br>
<span class="lineno"></span><span class="op" id="5938609">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5938612">//&nbsp;writeUSTARLongName&nbsp;splits&nbsp;a&nbsp;USTAR&nbsp;long&nbsp;name&nbsp;hdr.Name.</span><br>
<span class="lineno"></span><span class="comment" id="5938669">//&nbsp;name&nbsp;must&nbsp;be&nbsp;&lt;&nbsp;256&nbsp;characters.&nbsp;errNameTooLong&nbsp;is&nbsp;returned</span><br>
<span class="lineno">275</span><span class="comment" id="5938730">//&nbsp;if&nbsp;hdr.Name&nbsp;can&#39;t&nbsp;be&nbsp;split.&nbsp;The&nbsp;splitting&nbsp;heuristic</span><br>
<span class="lineno"></span><span class="comment" id="5938785">//&nbsp;is&nbsp;compatible&nbsp;with&nbsp;gnu&nbsp;tar.</span><br>
<span class="lineno"></span><span class="keyword" id="5938816">func</span>&nbsp;<span class="op" id="5938821">(</span><span class="ident" id="5938822">tw</span>&nbsp;<span class="op" id="5938825">*</span><span class="ident" id="5938826">Writer</span><span class="op" id="5938832">)</span>&nbsp;<span class="ident" id="5938834">splitUSTARLongName</span><span class="op" id="5938852">(</span><span class="ident" id="5938853">name</span>&nbsp;<span class="builtintype" id="5938858">string</span><span class="op" id="5938864">)</span>&nbsp;<span class="op" id="5938866">(</span><span class="ident" id="5938867">prefix</span><span class="op" id="5938873">,</span>&nbsp;<span class="ident" id="5938875">suffix</span>&nbsp;<span class="builtintype" id="5938882">string</span><span class="op" id="5938888">,</span>&nbsp;<span class="ident" id="5938890">err</span>&nbsp;<span class="builtintype" id="5938894">error</span><span class="op" id="5938899">)</span>&nbsp;<span class="op" id="5938901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5938904">length</span>&nbsp;<span class="op" id="5938911">:=</span>&nbsp;<span class="builtinfunc" id="5938914">len</span><span class="op" id="5938917">(</span><span class="ident" id="5938918">name</span><span class="op" id="5938922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5938925">if</span>&nbsp;<span class="ident" id="5938928">length</span>&nbsp;<span class="op" id="5938935">&gt;</span>&nbsp;<span class="ident" id="5938937">fileNamePrefixSize</span><span class="op" id="5938955">+</span><span class="num" id="5938956">1</span>&nbsp;<span class="op" id="5938958">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5938962">length</span>&nbsp;<span class="op" id="5938969">=</span>&nbsp;<span class="ident" id="5938971">fileNamePrefixSize</span>&nbsp;<span class="op" id="5938990">+</span>&nbsp;<span class="num" id="5938992">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5938995">}</span>&nbsp;<span class="keyword" id="5938997">else</span>&nbsp;<span class="keyword" id="5939002">if</span>&nbsp;<span class="ident" id="5939005">name</span><span class="op" id="5939009">[</span><span class="ident" id="5939010">length</span><span class="op" id="5939016">-</span><span class="num" id="5939017">1</span><span class="op" id="5939018">]</span>&nbsp;<span class="op" id="5939020">==</span>&nbsp;<span class="string" id="5939023">&#39;/&#39;</span>&nbsp;<span class="op" id="5939027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5939031">length</span><span class="op" id="5939037">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5939041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5939044">i</span>&nbsp;<span class="op" id="5939046">:=</span>&nbsp;<span class="ident" id="5939049">strings</span><span class="op" id="5939056">.</span><span class="ident" id="5939057">LastIndex</span><span class="op" id="5939066">(</span><span class="ident" id="5939067">name</span><span class="op" id="5939071">[</span><span class="op" id="5939072">:</span><span class="ident" id="5939073">length</span><span class="op" id="5939079">]</span><span class="op" id="5939080">,</span>&nbsp;<span class="string" id="5939082">&#34;/&#34;</span><span class="op" id="5939085">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5939088">//&nbsp;nlen&nbsp;contains&nbsp;the&nbsp;resulting&nbsp;length&nbsp;in&nbsp;the&nbsp;name&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5939146">//&nbsp;plen&nbsp;contains&nbsp;the&nbsp;resulting&nbsp;length&nbsp;in&nbsp;the&nbsp;prefix&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5939206">nlen</span>&nbsp;<span class="op" id="5939211">:=</span>&nbsp;<span class="builtinfunc" id="5939214">len</span><span class="op" id="5939217">(</span><span class="ident" id="5939218">name</span><span class="op" id="5939222">)</span>&nbsp;<span class="op" id="5939224">-</span>&nbsp;<span class="ident" id="5939226">i</span>&nbsp;<span class="op" id="5939228">-</span>&nbsp;<span class="num" id="5939230">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5939233">plen</span>&nbsp;<span class="op" id="5939238">:=</span>&nbsp;<span class="ident" id="5939241">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5939244">if</span>&nbsp;<span class="ident" id="5939247">i</span>&nbsp;<span class="op" id="5939249">&lt;=</span>&nbsp;<span class="num" id="5939252">0</span>&nbsp;<span class="op" id="5939254">||</span>&nbsp;<span class="ident" id="5939257">nlen</span>&nbsp;<span class="op" id="5939262">&gt;</span>&nbsp;<span class="ident" id="5939264">fileNameSize</span>&nbsp;<span class="op" id="5939277">||</span>&nbsp;<span class="ident" id="5939280">nlen</span>&nbsp;<span class="op" id="5939285">==</span>&nbsp;<span class="num" id="5939288">0</span>&nbsp;<span class="op" id="5939290">||</span>&nbsp;<span class="ident" id="5939293">plen</span>&nbsp;<span class="op" id="5939298">&gt;</span>&nbsp;<span class="ident" id="5939300">fileNamePrefixSize</span>&nbsp;<span class="op" id="5939319">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5939323">err</span>&nbsp;<span class="op" id="5939327">=</span>&nbsp;<span class="ident" id="5939329">errNameTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5939346">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5939354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5939357">prefix</span><span class="op" id="5939363">,</span>&nbsp;<span class="ident" id="5939365">suffix</span>&nbsp;<span class="op" id="5939372">=</span>&nbsp;<span class="ident" id="5939374">name</span><span class="op" id="5939378">[</span><span class="op" id="5939379">:</span><span class="ident" id="5939380">i</span><span class="op" id="5939381">]</span><span class="op" id="5939382">,</span>&nbsp;<span class="ident" id="5939384">name</span><span class="op" id="5939388">[</span><span class="ident" id="5939389">i</span><span class="op" id="5939390">+</span><span class="num" id="5939391">1</span><span class="op" id="5939392">:</span><span class="op" id="5939393">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5939396">return</span><br>
<span class="lineno">295</span><span class="op" id="5939403">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5939406">//&nbsp;writePaxHeader&nbsp;writes&nbsp;an&nbsp;extended&nbsp;pax&nbsp;header&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5939461">//&nbsp;archive.</span><br>
<span class="lineno"></span><span class="keyword" id="5939473">func</span>&nbsp;<span class="op" id="5939478">(</span><span class="ident" id="5939479">tw</span>&nbsp;<span class="op" id="5939482">*</span><span class="ident" id="5939483">Writer</span><span class="op" id="5939489">)</span>&nbsp;<span class="ident" id="5939491">writePAXHeader</span><span class="op" id="5939505">(</span><span class="ident" id="5939506">hdr</span>&nbsp;<span class="op" id="5939510">*</span><span class="ident" id="5939511">Header</span><span class="op" id="5939517">,</span>&nbsp;<span class="ident" id="5939519">paxHeaders</span>&nbsp;<span class="keyword" id="5939530">map</span><span class="op" id="5939533">[</span><span class="builtintype" id="5939534">string</span><span class="op" id="5939540">]</span><span class="builtintype" id="5939541">string</span><span class="op" id="5939547">)</span>&nbsp;<span class="builtintype" id="5939549">error</span>&nbsp;<span class="op" id="5939555">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5939558">//&nbsp;Prepare&nbsp;extended&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5939586">ext</span>&nbsp;<span class="op" id="5939590">:=</span>&nbsp;<span class="builtinfunc" id="5939593">new</span><span class="op" id="5939596">(</span><span class="ident" id="5939597">Header</span><span class="op" id="5939603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5939606">ext</span><span class="op" id="5939609">.</span><span class="ident" id="5939610">Typeflag</span>&nbsp;<span class="op" id="5939619">=</span>&nbsp;<span class="ident" id="5939621">TypeXHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5939634">//&nbsp;Setting&nbsp;ModTime&nbsp;is&nbsp;required&nbsp;for&nbsp;reader&nbsp;parsing&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5939688">//&nbsp;succeed,&nbsp;and&nbsp;seems&nbsp;harmless&nbsp;enough.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5939728">ext</span><span class="op" id="5939731">.</span><span class="ident" id="5939732">ModTime</span>&nbsp;<span class="op" id="5939740">=</span>&nbsp;<span class="ident" id="5939742">hdr</span><span class="op" id="5939745">.</span><span class="ident" id="5939746">ModTime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5939755">//&nbsp;The&nbsp;spec&nbsp;asks&nbsp;that&nbsp;we&nbsp;namespace&nbsp;our&nbsp;pseudo&nbsp;files</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5939808">//&nbsp;with&nbsp;the&nbsp;current&nbsp;pid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5939834">pid</span>&nbsp;<span class="op" id="5939838">:=</span>&nbsp;<span class="ident" id="5939841">os</span><span class="op" id="5939843">.</span><span class="ident" id="5939844">Getpid</span><span class="op" id="5939850">(</span><span class="op" id="5939851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5939854">dir</span><span class="op" id="5939857">,</span>&nbsp;<span class="ident" id="5939859">file</span>&nbsp;<span class="op" id="5939864">:=</span>&nbsp;<span class="ident" id="5939867">path</span><span class="op" id="5939871">.</span><span class="ident" id="5939872">Split</span><span class="op" id="5939877">(</span><span class="ident" id="5939878">hdr</span><span class="op" id="5939881">.</span><span class="ident" id="5939882">Name</span><span class="op" id="5939886">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5939889">fullName</span>&nbsp;<span class="op" id="5939898">:=</span>&nbsp;<span class="ident" id="5939901">path</span><span class="op" id="5939905">.</span><span class="ident" id="5939906">Join</span><span class="op" id="5939910">(</span><span class="ident" id="5939911">dir</span><span class="op" id="5939914">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5939918">fmt</span><span class="op" id="5939921">.</span><span class="ident" id="5939922">Sprintf</span><span class="op" id="5939929">(</span><span class="string" id="5939930">&#34;PaxHeaders.%d&#34;</span><span class="op" id="5939945">,</span>&nbsp;<span class="ident" id="5939947">pid</span><span class="op" id="5939950">)</span><span class="op" id="5939951">,</span>&nbsp;<span class="ident" id="5939953">file</span><span class="op" id="5939957">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5939961">ascii</span>&nbsp;<span class="op" id="5939967">:=</span>&nbsp;<span class="ident" id="5939970">toASCII</span><span class="op" id="5939977">(</span><span class="ident" id="5939978">fullName</span><span class="op" id="5939986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5939989">if</span>&nbsp;<span class="builtinfunc" id="5939992">len</span><span class="op" id="5939995">(</span><span class="ident" id="5939996">ascii</span><span class="op" id="5940001">)</span>&nbsp;<span class="op" id="5940003">&gt;</span>&nbsp;<span class="num" id="5940005">100</span>&nbsp;<span class="op" id="5940009">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5940013">ascii</span>&nbsp;<span class="op" id="5940019">=</span>&nbsp;<span class="ident" id="5940021">ascii</span><span class="op" id="5940026">[</span><span class="op" id="5940027">:</span><span class="num" id="5940028">100</span><span class="op" id="5940031">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5940034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5940037">ext</span><span class="op" id="5940040">.</span><span class="ident" id="5940041">Name</span>&nbsp;<span class="op" id="5940046">=</span>&nbsp;<span class="ident" id="5940048">ascii</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5940055">//&nbsp;Construct&nbsp;the&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5940078">var</span>&nbsp;<span class="ident" id="5940082">buf</span>&nbsp;<span class="ident" id="5940086">bytes</span><span class="op" id="5940091">.</span><span class="ident" id="5940092">Buffer</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5940101">for</span>&nbsp;<span class="ident" id="5940105">k</span><span class="op" id="5940106">,</span>&nbsp;<span class="ident" id="5940108">v</span>&nbsp;<span class="op" id="5940110">:=</span>&nbsp;<span class="keyword" id="5940113">range</span>&nbsp;<span class="ident" id="5940119">paxHeaders</span>&nbsp;<span class="op" id="5940130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5940134">fmt</span><span class="op" id="5940137">.</span><span class="ident" id="5940138">Fprint</span><span class="op" id="5940144">(</span><span class="op" id="5940145">&amp;</span><span class="ident" id="5940146">buf</span><span class="op" id="5940149">,</span>&nbsp;<span class="ident" id="5940151">paxHeader</span><span class="op" id="5940160">(</span><span class="ident" id="5940161">k</span><span class="op" id="5940162">+</span><span class="string" id="5940163">&#34;=&#34;</span><span class="op" id="5940166">+</span><span class="ident" id="5940167">v</span><span class="op" id="5940168">)</span><span class="op" id="5940169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5940172">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5940176">ext</span><span class="op" id="5940179">.</span><span class="ident" id="5940180">Size</span>&nbsp;<span class="op" id="5940185">=</span>&nbsp;<span class="ident" id="5940187">int64</span><span class="op" id="5940192">(</span><span class="builtinfunc" id="5940193">len</span><span class="op" id="5940196">(</span><span class="ident" id="5940197">buf</span><span class="op" id="5940200">.</span><span class="ident" id="5940201">Bytes</span><span class="op" id="5940206">(</span><span class="op" id="5940207">)</span><span class="op" id="5940208">)</span><span class="op" id="5940209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5940212">if</span>&nbsp;<span class="ident" id="5940215">err</span>&nbsp;<span class="op" id="5940219">:=</span>&nbsp;<span class="ident" id="5940222">tw</span><span class="op" id="5940224">.</span><span class="ident" id="5940225">writeHeader</span><span class="op" id="5940236">(</span><span class="ident" id="5940237">ext</span><span class="op" id="5940240">,</span>&nbsp;<span class="builtintype" id="5940242">false</span><span class="op" id="5940247">)</span><span class="op" id="5940248">;</span>&nbsp;<span class="ident" id="5940250">err</span>&nbsp;<span class="op" id="5940254">!=</span>&nbsp;<span class="ident" id="5940257">nil</span>&nbsp;<span class="op" id="5940261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5940265">return</span>&nbsp;<span class="ident" id="5940272">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5940277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5940280">if</span>&nbsp;<span class="ident" id="5940283">_</span><span class="op" id="5940284">,</span>&nbsp;<span class="ident" id="5940286">err</span>&nbsp;<span class="op" id="5940290">:=</span>&nbsp;<span class="ident" id="5940293">tw</span><span class="op" id="5940295">.</span><span class="ident" id="5940296">Write</span><span class="op" id="5940301">(</span><span class="ident" id="5940302">buf</span><span class="op" id="5940305">.</span><span class="ident" id="5940306">Bytes</span><span class="op" id="5940311">(</span><span class="op" id="5940312">)</span><span class="op" id="5940313">)</span><span class="op" id="5940314">;</span>&nbsp;<span class="ident" id="5940316">err</span>&nbsp;<span class="op" id="5940320">!=</span>&nbsp;<span class="ident" id="5940323">nil</span>&nbsp;<span class="op" id="5940327">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5940331">return</span>&nbsp;<span class="ident" id="5940338">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5940343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5940346">if</span>&nbsp;<span class="ident" id="5940349">err</span>&nbsp;<span class="op" id="5940353">:=</span>&nbsp;<span class="ident" id="5940356">tw</span><span class="op" id="5940358">.</span><span class="ident" id="5940359">Flush</span><span class="op" id="5940364">(</span><span class="op" id="5940365">)</span><span class="op" id="5940366">;</span>&nbsp;<span class="ident" id="5940368">err</span>&nbsp;<span class="op" id="5940372">!=</span>&nbsp;<span class="ident" id="5940375">nil</span>&nbsp;<span class="op" id="5940379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5940383">return</span>&nbsp;<span class="ident" id="5940390">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5940395">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5940398">return</span>&nbsp;<span class="ident" id="5940405">nil</span><br>
<span class="lineno"></span><span class="op" id="5940409">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5940412">//&nbsp;paxHeader&nbsp;formats&nbsp;a&nbsp;single&nbsp;pax&nbsp;record,&nbsp;prefixing&nbsp;it&nbsp;with&nbsp;the&nbsp;appropriate&nbsp;length</span><br>
<span class="lineno"></span><span class="keyword" id="5940495">func</span>&nbsp;<span class="ident" id="5940500">paxHeader</span><span class="op" id="5940509">(</span><span class="ident" id="5940510">msg</span>&nbsp;<span class="builtintype" id="5940514">string</span><span class="op" id="5940520">)</span>&nbsp;<span class="builtintype" id="5940522">string</span>&nbsp;<span class="op" id="5940529">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5940532">const</span>&nbsp;<span class="ident" id="5940538">padding</span>&nbsp;<span class="op" id="5940546">=</span>&nbsp;<span class="num" id="5940548">2</span>&nbsp;<span class="comment" id="5940550">//&nbsp;Extra&nbsp;padding&nbsp;for&nbsp;space&nbsp;and&nbsp;newline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5940590">size</span>&nbsp;<span class="op" id="5940595">:=</span>&nbsp;<span class="builtinfunc" id="5940598">len</span><span class="op" id="5940601">(</span><span class="ident" id="5940602">msg</span><span class="op" id="5940605">)</span>&nbsp;<span class="op" id="5940607">+</span>&nbsp;<span class="ident" id="5940609">padding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5940618">size</span>&nbsp;<span class="op" id="5940623">+=</span>&nbsp;<span class="builtinfunc" id="5940626">len</span><span class="op" id="5940629">(</span><span class="ident" id="5940630">strconv</span><span class="op" id="5940637">.</span><span class="ident" id="5940638">Itoa</span><span class="op" id="5940642">(</span><span class="ident" id="5940643">size</span><span class="op" id="5940647">)</span><span class="op" id="5940648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5940651">record</span>&nbsp;<span class="op" id="5940658">:=</span>&nbsp;<span class="ident" id="5940661">fmt</span><span class="op" id="5940664">.</span><span class="ident" id="5940665">Sprintf</span><span class="op" id="5940672">(</span><span class="string" id="5940673">&#34;%d&nbsp;%s\n&#34;</span><span class="op" id="5940682">,</span>&nbsp;<span class="ident" id="5940684">size</span><span class="op" id="5940688">,</span>&nbsp;<span class="ident" id="5940690">msg</span><span class="op" id="5940693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5940696">if</span>&nbsp;<span class="builtinfunc" id="5940699">len</span><span class="op" id="5940702">(</span><span class="ident" id="5940703">record</span><span class="op" id="5940709">)</span>&nbsp;<span class="op" id="5940711">!=</span>&nbsp;<span class="ident" id="5940714">size</span>&nbsp;<span class="op" id="5940719">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5940723">//&nbsp;Final&nbsp;adjustment&nbsp;if&nbsp;adding&nbsp;size&nbsp;increased</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5940770">//&nbsp;the&nbsp;number&nbsp;of&nbsp;digits&nbsp;in&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5940804">size</span>&nbsp;<span class="op" id="5940809">=</span>&nbsp;<span class="builtinfunc" id="5940811">len</span><span class="op" id="5940814">(</span><span class="ident" id="5940815">record</span><span class="op" id="5940821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5940825">record</span>&nbsp;<span class="op" id="5940832">=</span>&nbsp;<span class="ident" id="5940834">fmt</span><span class="op" id="5940837">.</span><span class="ident" id="5940838">Sprintf</span><span class="op" id="5940845">(</span><span class="string" id="5940846">&#34;%d&nbsp;%s\n&#34;</span><span class="op" id="5940855">,</span>&nbsp;<span class="ident" id="5940857">size</span><span class="op" id="5940861">,</span>&nbsp;<span class="ident" id="5940863">msg</span><span class="op" id="5940866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5940869">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5940872">return</span>&nbsp;<span class="ident" id="5940879">record</span><br>
<span class="lineno"></span><span class="op" id="5940886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5940889">//&nbsp;Write&nbsp;writes&nbsp;to&nbsp;the&nbsp;current&nbsp;entry&nbsp;in&nbsp;the&nbsp;tar&nbsp;archive.</span><br>
<span class="lineno"></span><span class="comment" id="5940946">//&nbsp;Write&nbsp;returns&nbsp;the&nbsp;error&nbsp;ErrWriteTooLong&nbsp;if&nbsp;more&nbsp;than</span><br>
<span class="lineno">355</span><span class="comment" id="5941002">//&nbsp;hdr.Size&nbsp;bytes&nbsp;are&nbsp;written&nbsp;after&nbsp;WriteHeader.</span><br>
<span class="lineno"></span><span class="keyword" id="5941051">func</span>&nbsp;<span class="op" id="5941056">(</span><span class="ident" id="5941057">tw</span>&nbsp;<span class="op" id="5941060">*</span><span class="ident" id="5941061">Writer</span><span class="op" id="5941067">)</span>&nbsp;<span class="ident" id="5941069">Write</span><span class="op" id="5941074">(</span><span class="ident" id="5941075">b</span>&nbsp;<span class="op" id="5941077">[</span><span class="op" id="5941078">]</span><span class="builtintype" id="5941079">byte</span><span class="op" id="5941083">)</span>&nbsp;<span class="op" id="5941085">(</span><span class="ident" id="5941086">n</span>&nbsp;<span class="builtintype" id="5941088">int</span><span class="op" id="5941091">,</span>&nbsp;<span class="ident" id="5941093">err</span>&nbsp;<span class="builtintype" id="5941097">error</span><span class="op" id="5941102">)</span>&nbsp;<span class="op" id="5941104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5941107">if</span>&nbsp;<span class="ident" id="5941110">tw</span><span class="op" id="5941112">.</span><span class="ident" id="5941113">closed</span>&nbsp;<span class="op" id="5941120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5941124">err</span>&nbsp;<span class="op" id="5941128">=</span>&nbsp;<span class="ident" id="5941130">ErrWriteTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5941148">return</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5941156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5941159">overwrite</span>&nbsp;<span class="op" id="5941169">:=</span>&nbsp;<span class="builtintype" id="5941172">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5941179">if</span>&nbsp;<span class="ident" id="5941182">int64</span><span class="op" id="5941187">(</span><span class="builtinfunc" id="5941188">len</span><span class="op" id="5941191">(</span><span class="ident" id="5941192">b</span><span class="op" id="5941193">)</span><span class="op" id="5941194">)</span>&nbsp;<span class="op" id="5941196">&gt;</span>&nbsp;<span class="ident" id="5941198">tw</span><span class="op" id="5941200">.</span><span class="ident" id="5941201">nb</span>&nbsp;<span class="op" id="5941204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5941208">b</span>&nbsp;<span class="op" id="5941210">=</span>&nbsp;<span class="ident" id="5941212">b</span><span class="op" id="5941213">[</span><span class="num" id="5941214">0</span><span class="op" id="5941215">:</span><span class="ident" id="5941216">tw</span><span class="op" id="5941218">.</span><span class="ident" id="5941219">nb</span><span class="op" id="5941221">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5941225">overwrite</span>&nbsp;<span class="op" id="5941235">=</span>&nbsp;<span class="builtintype" id="5941237">true</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5941243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5941246">n</span><span class="op" id="5941247">,</span>&nbsp;<span class="ident" id="5941249">err</span>&nbsp;<span class="op" id="5941253">=</span>&nbsp;<span class="ident" id="5941255">tw</span><span class="op" id="5941257">.</span><span class="ident" id="5941258">w</span><span class="op" id="5941259">.</span><span class="ident" id="5941260">Write</span><span class="op" id="5941265">(</span><span class="ident" id="5941266">b</span><span class="op" id="5941267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5941270">tw</span><span class="op" id="5941272">.</span><span class="ident" id="5941273">nb</span>&nbsp;<span class="op" id="5941276">-=</span>&nbsp;<span class="ident" id="5941279">int64</span><span class="op" id="5941284">(</span><span class="ident" id="5941285">n</span><span class="op" id="5941286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5941289">if</span>&nbsp;<span class="ident" id="5941292">err</span>&nbsp;<span class="op" id="5941296">==</span>&nbsp;<span class="ident" id="5941299">nil</span>&nbsp;<span class="op" id="5941303">&amp;&amp;</span>&nbsp;<span class="ident" id="5941306">overwrite</span>&nbsp;<span class="op" id="5941316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5941320">err</span>&nbsp;<span class="op" id="5941324">=</span>&nbsp;<span class="ident" id="5941326">ErrWriteTooLong</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5941344">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5941352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5941355">tw</span><span class="op" id="5941357">.</span><span class="ident" id="5941358">err</span>&nbsp;<span class="op" id="5941362">=</span>&nbsp;<span class="ident" id="5941364">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5941369">return</span><br>
<span class="lineno"></span><span class="op" id="5941376">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="comment" id="5941379">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;tar&nbsp;archive,&nbsp;flushing&nbsp;any&nbsp;unwritten</span><br>
<span class="lineno"></span><span class="comment" id="5941435">//&nbsp;data&nbsp;to&nbsp;the&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5941469">func</span>&nbsp;<span class="op" id="5941474">(</span><span class="ident" id="5941475">tw</span>&nbsp;<span class="op" id="5941478">*</span><span class="ident" id="5941479">Writer</span><span class="op" id="5941485">)</span>&nbsp;<span class="ident" id="5941487">Close</span><span class="op" id="5941492">(</span><span class="op" id="5941493">)</span>&nbsp;<span class="builtintype" id="5941495">error</span>&nbsp;<span class="op" id="5941501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5941504">if</span>&nbsp;<span class="ident" id="5941507">tw</span><span class="op" id="5941509">.</span><span class="ident" id="5941510">err</span>&nbsp;<span class="op" id="5941514">!=</span>&nbsp;<span class="ident" id="5941517">nil</span>&nbsp;<span class="op" id="5941521">||</span>&nbsp;<span class="ident" id="5941524">tw</span><span class="op" id="5941526">.</span><span class="ident" id="5941527">closed</span>&nbsp;<span class="op" id="5941534">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5941538">return</span>&nbsp;<span class="ident" id="5941545">tw</span><span class="op" id="5941547">.</span><span class="ident" id="5941548">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5941553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5941556">tw</span><span class="op" id="5941558">.</span><span class="ident" id="5941559">Flush</span><span class="op" id="5941564">(</span><span class="op" id="5941565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5941568">tw</span><span class="op" id="5941570">.</span><span class="ident" id="5941571">closed</span>&nbsp;<span class="op" id="5941578">=</span>&nbsp;<span class="builtintype" id="5941580">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5941586">if</span>&nbsp;<span class="ident" id="5941589">tw</span><span class="op" id="5941591">.</span><span class="ident" id="5941592">err</span>&nbsp;<span class="op" id="5941596">!=</span>&nbsp;<span class="ident" id="5941599">nil</span>&nbsp;<span class="op" id="5941603">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5941607">return</span>&nbsp;<span class="ident" id="5941614">tw</span><span class="op" id="5941616">.</span><span class="ident" id="5941617">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5941622">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5941626">//&nbsp;trailer:&nbsp;two&nbsp;zero&nbsp;blocks</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5941655">for</span>&nbsp;<span class="ident" id="5941659">i</span>&nbsp;<span class="op" id="5941661">:=</span>&nbsp;<span class="num" id="5941664">0</span><span class="op" id="5941665">;</span>&nbsp;<span class="ident" id="5941667">i</span>&nbsp;<span class="op" id="5941669">&lt;</span>&nbsp;<span class="num" id="5941671">2</span><span class="op" id="5941672">;</span>&nbsp;<span class="ident" id="5941674">i</span><span class="op" id="5941675">++</span>&nbsp;<span class="op" id="5941678">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5941682">_</span><span class="op" id="5941683">,</span>&nbsp;<span class="ident" id="5941685">tw</span><span class="op" id="5941687">.</span><span class="ident" id="5941688">err</span>&nbsp;<span class="op" id="5941692">=</span>&nbsp;<span class="ident" id="5941694">tw</span><span class="op" id="5941696">.</span><span class="ident" id="5941697">w</span><span class="op" id="5941698">.</span><span class="ident" id="5941699">Write</span><span class="op" id="5941704">(</span><span class="ident" id="5941705">zeroBlock</span><span class="op" id="5941714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5941718">if</span>&nbsp;<span class="ident" id="5941721">tw</span><span class="op" id="5941723">.</span><span class="ident" id="5941724">err</span>&nbsp;<span class="op" id="5941728">!=</span>&nbsp;<span class="ident" id="5941731">nil</span>&nbsp;<span class="op" id="5941735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5941740">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5941748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5941751">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5941754">return</span>&nbsp;<span class="ident" id="5941761">tw</span><span class="op" id="5941763">.</span><span class="ident" id="5941764">err</span><br>
<span class="lineno"></span><span class="op" id="5941768">}</span>
</div>
</body>
</html>
