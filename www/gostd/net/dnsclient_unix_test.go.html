<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6576308">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6576363">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6576417">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6576468">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6576533">package</span>&nbsp;<span class="ident" id="6576541">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6576546">import</span>&nbsp;<span class="op" id="6576553">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6576556">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6576562">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6576575">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6576581">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6576589">&#34;reflect&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6576600">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6576611">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6576618">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6576621">var</span>&nbsp;<span class="ident" id="6576625">dnsTransportFallbackTests</span>&nbsp;<span class="op" id="6576651">=</span>&nbsp;<span class="op" id="6576653">[</span><span class="op" id="6576654">]</span><span class="keyword" id="6576655">struct</span>&nbsp;<span class="op" id="6576662">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6576665">server</span>&nbsp;&nbsp;<span class="builtintype" id="6576673">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6576681">name</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6576689">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6576697">qtype</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6576705">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6576713">timeout</span>&nbsp;<span class="builtintype" id="6576721">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6576726">rcode</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6576734">int</span><br>
<span class="lineno">25</span><span class="op" id="6576738">}</span><span class="op" id="6576739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6576742">//&nbsp;Querying&nbsp;&#34;com.&#34;&nbsp;with&nbsp;qtype=255&nbsp;usually&nbsp;makes&nbsp;an&nbsp;answer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6576801">//&nbsp;which&nbsp;requires&nbsp;more&nbsp;than&nbsp;512&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6576841">{</span><span class="string" id="6576842">&#34;8.8.8.8:53&#34;</span><span class="op" id="6576854">,</span>&nbsp;<span class="string" id="6576856">&#34;com.&#34;</span><span class="op" id="6576862">,</span>&nbsp;<span class="ident" id="6576864">dnsTypeALL</span><span class="op" id="6576874">,</span>&nbsp;<span class="num" id="6576876">2</span><span class="op" id="6576877">,</span>&nbsp;<span class="ident" id="6576879">dnsRcodeSuccess</span><span class="op" id="6576894">}</span><span class="op" id="6576895">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6576898">{</span><span class="string" id="6576899">&#34;8.8.4.4:53&#34;</span><span class="op" id="6576911">,</span>&nbsp;<span class="string" id="6576913">&#34;com.&#34;</span><span class="op" id="6576919">,</span>&nbsp;<span class="ident" id="6576921">dnsTypeALL</span><span class="op" id="6576931">,</span>&nbsp;<span class="num" id="6576933">4</span><span class="op" id="6576934">,</span>&nbsp;<span class="ident" id="6576936">dnsRcodeSuccess</span><span class="op" id="6576951">}</span><span class="op" id="6576952">,</span><br>
<span class="lineno">30</span><span class="op" id="6576954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6576957">func</span>&nbsp;<span class="ident" id="6576962">TestDNSTransportFallback</span><span class="op" id="6576986">(</span><span class="ident" id="6576987">t</span>&nbsp;<span class="op" id="6576989">*</span><span class="ident" id="6576990">testing</span><span class="op" id="6576997">.</span><span class="ident" id="6576998">T</span><span class="op" id="6576999">)</span>&nbsp;<span class="op" id="6577001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6577004">if</span>&nbsp;<span class="ident" id="6577007">testing</span><span class="op" id="6577014">.</span><span class="ident" id="6577015">Short</span><span class="op" id="6577020">(</span><span class="op" id="6577021">)</span>&nbsp;<span class="op" id="6577023">||</span>&nbsp;<span class="op" id="6577026">!</span><span class="op" id="6577027">*</span><span class="ident" id="6577028">testExternal</span>&nbsp;<span class="op" id="6577041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6577045">t</span><span class="op" id="6577046">.</span><span class="ident" id="6577047">Skip</span><span class="op" id="6577051">(</span><span class="string" id="6577052">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="6577093">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6577096">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6577100">for</span>&nbsp;<span class="ident" id="6577104">_</span><span class="op" id="6577105">,</span>&nbsp;<span class="ident" id="6577107">tt</span>&nbsp;<span class="op" id="6577110">:=</span>&nbsp;<span class="keyword" id="6577113">range</span>&nbsp;<span class="ident" id="6577119">dnsTransportFallbackTests</span>&nbsp;<span class="op" id="6577145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6577149">timeout</span>&nbsp;<span class="op" id="6577157">:=</span>&nbsp;<span class="ident" id="6577160">time</span><span class="op" id="6577164">.</span><span class="ident" id="6577165">Duration</span><span class="op" id="6577173">(</span><span class="ident" id="6577174">tt</span><span class="op" id="6577176">.</span><span class="ident" id="6577177">timeout</span><span class="op" id="6577184">)</span>&nbsp;<span class="op" id="6577186">*</span>&nbsp;<span class="ident" id="6577188">time</span><span class="op" id="6577192">.</span><span class="ident" id="6577193">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6577202">msg</span><span class="op" id="6577205">,</span>&nbsp;<span class="ident" id="6577207">err</span>&nbsp;<span class="op" id="6577211">:=</span>&nbsp;<span class="ident" id="6577214">exchange</span><span class="op" id="6577222">(</span><span class="ident" id="6577223">tt</span><span class="op" id="6577225">.</span><span class="ident" id="6577226">server</span><span class="op" id="6577232">,</span>&nbsp;<span class="ident" id="6577234">tt</span><span class="op" id="6577236">.</span><span class="ident" id="6577237">name</span><span class="op" id="6577241">,</span>&nbsp;<span class="ident" id="6577243">tt</span><span class="op" id="6577245">.</span><span class="ident" id="6577246">qtype</span><span class="op" id="6577251">,</span>&nbsp;<span class="ident" id="6577253">timeout</span><span class="op" id="6577260">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6577264">if</span>&nbsp;<span class="ident" id="6577267">err</span>&nbsp;<span class="op" id="6577271">!=</span>&nbsp;<span class="ident" id="6577274">nil</span>&nbsp;<span class="op" id="6577278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6577283">t</span><span class="op" id="6577284">.</span><span class="ident" id="6577285">Error</span><span class="op" id="6577290">(</span><span class="ident" id="6577291">err</span><span class="op" id="6577294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6577299">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6577310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6577314">switch</span>&nbsp;<span class="ident" id="6577321">msg</span><span class="op" id="6577324">.</span><span class="ident" id="6577325">rcode</span>&nbsp;<span class="op" id="6577331">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6577335">case</span>&nbsp;<span class="ident" id="6577340">tt</span><span class="op" id="6577342">.</span><span class="ident" id="6577343">rcode</span><span class="op" id="6577348">,</span>&nbsp;<span class="ident" id="6577350">dnsRcodeServerFailure</span><span class="op" id="6577371">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6577375">default</span><span class="op" id="6577382">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6577387">t</span><span class="op" id="6577388">.</span><span class="ident" id="6577389">Errorf</span><span class="op" id="6577395">(</span><span class="string" id="6577396">&#34;got&nbsp;%v&nbsp;from&nbsp;%v;&nbsp;want&nbsp;%v&#34;</span><span class="op" id="6577421">,</span>&nbsp;<span class="ident" id="6577423">msg</span><span class="op" id="6577426">.</span><span class="ident" id="6577427">rcode</span><span class="op" id="6577432">,</span>&nbsp;<span class="ident" id="6577434">tt</span><span class="op" id="6577436">.</span><span class="ident" id="6577437">server</span><span class="op" id="6577443">,</span>&nbsp;<span class="ident" id="6577445">tt</span><span class="op" id="6577447">.</span><span class="ident" id="6577448">rcode</span><span class="op" id="6577453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6577458">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6577469">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6577472">}</span><br>
<span class="lineno"></span><span class="op" id="6577474">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6577477">//&nbsp;See&nbsp;RFC&nbsp;6761&nbsp;for&nbsp;further&nbsp;information&nbsp;about&nbsp;the&nbsp;reserved,&nbsp;pseudo</span><br>
<span class="lineno"></span><span class="comment" id="6577544">//&nbsp;domain&nbsp;names.</span><br>
<span class="lineno">55</span><span class="keyword" id="6577561">var</span>&nbsp;<span class="ident" id="6577565">specialDomainNameTests</span>&nbsp;<span class="op" id="6577588">=</span>&nbsp;<span class="op" id="6577590">[</span><span class="op" id="6577591">]</span><span class="keyword" id="6577592">struct</span>&nbsp;<span class="op" id="6577599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6577602">name</span>&nbsp;&nbsp;<span class="builtintype" id="6577608">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6577616">qtype</span>&nbsp;<span class="builtintype" id="6577622">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6577630">rcode</span>&nbsp;<span class="builtintype" id="6577636">int</span><br>
<span class="lineno"></span><span class="op" id="6577640">}</span><span class="op" id="6577641">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6577644">//&nbsp;Name&nbsp;resoltion&nbsp;APIs&nbsp;and&nbsp;libraries&nbsp;should&nbsp;not&nbsp;recongnize&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6577708">//&nbsp;followings&nbsp;as&nbsp;special.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6577735">{</span><span class="string" id="6577736">&#34;1.0.168.192.in-addr.arpa.&#34;</span><span class="op" id="6577763">,</span>&nbsp;<span class="ident" id="6577765">dnsTypePTR</span><span class="op" id="6577775">,</span>&nbsp;<span class="ident" id="6577777">dnsRcodeNameError</span><span class="op" id="6577794">}</span><span class="op" id="6577795">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6577798">{</span><span class="string" id="6577799">&#34;test.&#34;</span><span class="op" id="6577806">,</span>&nbsp;<span class="ident" id="6577808">dnsTypeALL</span><span class="op" id="6577818">,</span>&nbsp;<span class="ident" id="6577820">dnsRcodeNameError</span><span class="op" id="6577837">}</span><span class="op" id="6577838">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6577841">{</span><span class="string" id="6577842">&#34;example.com.&#34;</span><span class="op" id="6577856">,</span>&nbsp;<span class="ident" id="6577858">dnsTypeALL</span><span class="op" id="6577868">,</span>&nbsp;<span class="ident" id="6577870">dnsRcodeSuccess</span><span class="op" id="6577885">}</span><span class="op" id="6577886">,</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6577890">//&nbsp;Name&nbsp;resoltion&nbsp;APIs&nbsp;and&nbsp;libraries&nbsp;should&nbsp;recongnize&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6577950">//&nbsp;followings&nbsp;as&nbsp;special&nbsp;and&nbsp;should&nbsp;not&nbsp;send&nbsp;any&nbsp;queries.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6578009">//&nbsp;Though,&nbsp;we&nbsp;test&nbsp;those&nbsp;names&nbsp;here&nbsp;for&nbsp;verifying&nbsp;nagative</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6578069">//&nbsp;answers&nbsp;at&nbsp;DNS&nbsp;query-response&nbsp;interaction&nbsp;level.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6578122">{</span><span class="string" id="6578123">&#34;localhost.&#34;</span><span class="op" id="6578135">,</span>&nbsp;<span class="ident" id="6578137">dnsTypeALL</span><span class="op" id="6578147">,</span>&nbsp;<span class="ident" id="6578149">dnsRcodeNameError</span><span class="op" id="6578166">}</span><span class="op" id="6578167">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6578170">{</span><span class="string" id="6578171">&#34;invalid.&#34;</span><span class="op" id="6578181">,</span>&nbsp;<span class="ident" id="6578183">dnsTypeALL</span><span class="op" id="6578193">,</span>&nbsp;<span class="ident" id="6578195">dnsRcodeNameError</span><span class="op" id="6578212">}</span><span class="op" id="6578213">,</span><br>
<span class="lineno"></span><span class="op" id="6578215">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6578218">func</span>&nbsp;<span class="ident" id="6578223">TestSpecialDomainName</span><span class="op" id="6578244">(</span><span class="ident" id="6578245">t</span>&nbsp;<span class="op" id="6578247">*</span><span class="ident" id="6578248">testing</span><span class="op" id="6578255">.</span><span class="ident" id="6578256">T</span><span class="op" id="6578257">)</span>&nbsp;<span class="op" id="6578259">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6578262">if</span>&nbsp;<span class="ident" id="6578265">testing</span><span class="op" id="6578272">.</span><span class="ident" id="6578273">Short</span><span class="op" id="6578278">(</span><span class="op" id="6578279">)</span>&nbsp;<span class="op" id="6578281">||</span>&nbsp;<span class="op" id="6578284">!</span><span class="op" id="6578285">*</span><span class="ident" id="6578286">testExternal</span>&nbsp;<span class="op" id="6578299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6578303">t</span><span class="op" id="6578304">.</span><span class="ident" id="6578305">Skip</span><span class="op" id="6578309">(</span><span class="string" id="6578310">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="6578351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6578354">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6578358">server</span>&nbsp;<span class="op" id="6578365">:=</span>&nbsp;<span class="string" id="6578368">&#34;8.8.8.8:53&#34;</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6578382">for</span>&nbsp;<span class="ident" id="6578386">_</span><span class="op" id="6578387">,</span>&nbsp;<span class="ident" id="6578389">tt</span>&nbsp;<span class="op" id="6578392">:=</span>&nbsp;<span class="keyword" id="6578395">range</span>&nbsp;<span class="ident" id="6578401">specialDomainNameTests</span>&nbsp;<span class="op" id="6578424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6578428">msg</span><span class="op" id="6578431">,</span>&nbsp;<span class="ident" id="6578433">err</span>&nbsp;<span class="op" id="6578437">:=</span>&nbsp;<span class="ident" id="6578440">exchange</span><span class="op" id="6578448">(</span><span class="ident" id="6578449">server</span><span class="op" id="6578455">,</span>&nbsp;<span class="ident" id="6578457">tt</span><span class="op" id="6578459">.</span><span class="ident" id="6578460">name</span><span class="op" id="6578464">,</span>&nbsp;<span class="ident" id="6578466">tt</span><span class="op" id="6578468">.</span><span class="ident" id="6578469">qtype</span><span class="op" id="6578474">,</span>&nbsp;<span class="num" id="6578476">0</span><span class="op" id="6578477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6578481">if</span>&nbsp;<span class="ident" id="6578484">err</span>&nbsp;<span class="op" id="6578488">!=</span>&nbsp;<span class="ident" id="6578491">nil</span>&nbsp;<span class="op" id="6578495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6578500">t</span><span class="op" id="6578501">.</span><span class="ident" id="6578502">Error</span><span class="op" id="6578507">(</span><span class="ident" id="6578508">err</span><span class="op" id="6578511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6578516">continue</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6578527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6578531">switch</span>&nbsp;<span class="ident" id="6578538">msg</span><span class="op" id="6578541">.</span><span class="ident" id="6578542">rcode</span>&nbsp;<span class="op" id="6578548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6578552">case</span>&nbsp;<span class="ident" id="6578557">tt</span><span class="op" id="6578559">.</span><span class="ident" id="6578560">rcode</span><span class="op" id="6578565">,</span>&nbsp;<span class="ident" id="6578567">dnsRcodeServerFailure</span><span class="op" id="6578588">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6578592">default</span><span class="op" id="6578599">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6578604">t</span><span class="op" id="6578605">.</span><span class="ident" id="6578606">Errorf</span><span class="op" id="6578612">(</span><span class="string" id="6578613">&#34;got&nbsp;%v&nbsp;from&nbsp;%v;&nbsp;want&nbsp;%v&#34;</span><span class="op" id="6578638">,</span>&nbsp;<span class="ident" id="6578640">msg</span><span class="op" id="6578643">.</span><span class="ident" id="6578644">rcode</span><span class="op" id="6578649">,</span>&nbsp;<span class="ident" id="6578651">server</span><span class="op" id="6578657">,</span>&nbsp;<span class="ident" id="6578659">tt</span><span class="op" id="6578661">.</span><span class="ident" id="6578662">rcode</span><span class="op" id="6578667">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6578672">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6578683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6578686">}</span><br>
<span class="lineno"></span><span class="op" id="6578688">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="6578691">type</span>&nbsp;<span class="ident" id="6578696">resolvConfTest</span>&nbsp;<span class="keyword" id="6578711">struct</span>&nbsp;<span class="op" id="6578718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6578721">*</span><span class="ident" id="6578722">testing</span><span class="op" id="6578729">.</span><span class="ident" id="6578730">T</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6578733">dir</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6578741">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6578749">path</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6578757">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6578765">started</span>&nbsp;<span class="builtintype" id="6578773">bool</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6578779">quitc</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="6578787">chan</span>&nbsp;<span class="keyword" id="6578792">chan</span>&nbsp;<span class="keyword" id="6578797">struct</span><span class="op" id="6578803">{</span><span class="op" id="6578804">}</span><br>
<span class="lineno"></span><span class="op" id="6578806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6578809">func</span>&nbsp;<span class="ident" id="6578814">newResolvConfTest</span><span class="op" id="6578831">(</span><span class="ident" id="6578832">t</span>&nbsp;<span class="op" id="6578834">*</span><span class="ident" id="6578835">testing</span><span class="op" id="6578842">.</span><span class="ident" id="6578843">T</span><span class="op" id="6578844">)</span>&nbsp;<span class="op" id="6578846">*</span><span class="ident" id="6578847">resolvConfTest</span>&nbsp;<span class="op" id="6578862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6578865">dir</span><span class="op" id="6578868">,</span>&nbsp;<span class="ident" id="6578870">err</span>&nbsp;<span class="op" id="6578874">:=</span>&nbsp;<span class="ident" id="6578877">ioutil</span><span class="op" id="6578883">.</span><span class="ident" id="6578884">TempDir</span><span class="op" id="6578891">(</span><span class="string" id="6578892">&#34;&#34;</span><span class="op" id="6578894">,</span>&nbsp;<span class="string" id="6578896">&#34;resolvConfTest&#34;</span><span class="op" id="6578912">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6578915">if</span>&nbsp;<span class="ident" id="6578918">err</span>&nbsp;<span class="op" id="6578922">!=</span>&nbsp;<span class="ident" id="6578925">nil</span>&nbsp;<span class="op" id="6578929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6578933">t</span><span class="op" id="6578934">.</span><span class="ident" id="6578935">Fatalf</span><span class="op" id="6578941">(</span><span class="string" id="6578942">&#34;could&nbsp;not&nbsp;create&nbsp;temp&nbsp;dir:&nbsp;%v&#34;</span><span class="op" id="6578973">,</span>&nbsp;<span class="ident" id="6578975">err</span><span class="op" id="6578978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6578981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6578985">//&nbsp;Disable&nbsp;the&nbsp;default&nbsp;loadConfig</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6579020">onceLoadConfig</span><span class="op" id="6579034">.</span><span class="ident" id="6579035">Do</span><span class="op" id="6579037">(</span><span class="keyword" id="6579038">func</span><span class="op" id="6579042">(</span><span class="op" id="6579043">)</span>&nbsp;<span class="op" id="6579045">{</span><span class="op" id="6579046">}</span><span class="op" id="6579047">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6579051">r</span>&nbsp;<span class="op" id="6579053">:=</span>&nbsp;<span class="op" id="6579056">&amp;</span><span class="ident" id="6579057">resolvConfTest</span><span class="op" id="6579071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6579075">T</span><span class="op" id="6579076">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6579082">t</span><span class="op" id="6579083">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6579087">dir</span><span class="op" id="6579090">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6579094">dir</span><span class="op" id="6579097">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6579101">path</span><span class="op" id="6579105">:</span>&nbsp;&nbsp;<span class="ident" id="6579108">path</span><span class="op" id="6579112">.</span><span class="ident" id="6579113">Join</span><span class="op" id="6579117">(</span><span class="ident" id="6579118">dir</span><span class="op" id="6579121">,</span>&nbsp;<span class="string" id="6579123">&#34;resolv.conf&#34;</span><span class="op" id="6579136">)</span><span class="op" id="6579137">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6579141">quitc</span><span class="op" id="6579146">:</span>&nbsp;<span class="builtinfunc" id="6579148">make</span><span class="op" id="6579152">(</span><span class="keyword" id="6579153">chan</span>&nbsp;<span class="keyword" id="6579158">chan</span>&nbsp;<span class="keyword" id="6579163">struct</span><span class="op" id="6579169">{</span><span class="op" id="6579170">}</span><span class="op" id="6579171">)</span><span class="op" id="6579172">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6579175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6579179">return</span>&nbsp;<span class="ident" id="6579186">r</span><br>
<span class="lineno">120</span><span class="op" id="6579188">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6579191">func</span>&nbsp;<span class="op" id="6579196">(</span><span class="ident" id="6579197">r</span>&nbsp;<span class="op" id="6579199">*</span><span class="ident" id="6579200">resolvConfTest</span><span class="op" id="6579214">)</span>&nbsp;<span class="ident" id="6579216">Start</span><span class="op" id="6579221">(</span><span class="op" id="6579222">)</span>&nbsp;<span class="op" id="6579224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6579227">loadConfig</span><span class="op" id="6579237">(</span><span class="ident" id="6579238">r</span><span class="op" id="6579239">.</span><span class="ident" id="6579240">path</span><span class="op" id="6579244">,</span>&nbsp;<span class="num" id="6579246">100</span><span class="op" id="6579249">*</span><span class="ident" id="6579250">time</span><span class="op" id="6579254">.</span><span class="ident" id="6579255">Millisecond</span><span class="op" id="6579266">,</span>&nbsp;<span class="ident" id="6579268">r</span><span class="op" id="6579269">.</span><span class="ident" id="6579270">quitc</span><span class="op" id="6579275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6579278">r</span><span class="op" id="6579279">.</span><span class="ident" id="6579280">started</span>&nbsp;<span class="op" id="6579288">=</span>&nbsp;<span class="builtintype" id="6579290">true</span><br>
<span class="lineno">125</span><span class="op" id="6579295">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6579298">func</span>&nbsp;<span class="op" id="6579303">(</span><span class="ident" id="6579304">r</span>&nbsp;<span class="op" id="6579306">*</span><span class="ident" id="6579307">resolvConfTest</span><span class="op" id="6579321">)</span>&nbsp;<span class="ident" id="6579323">SetConf</span><span class="op" id="6579330">(</span><span class="ident" id="6579331">s</span>&nbsp;<span class="builtintype" id="6579333">string</span><span class="op" id="6579339">)</span>&nbsp;<span class="op" id="6579341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6579344">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;file&nbsp;mtime&nbsp;will&nbsp;be&nbsp;different&nbsp;once&nbsp;we&#39;re&nbsp;done&nbsp;here,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6579413">//&nbsp;even&nbsp;on&nbsp;systems&nbsp;with&nbsp;coarse&nbsp;(1s)&nbsp;mtime&nbsp;resolution.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6579468">time</span><span class="op" id="6579472">.</span><span class="ident" id="6579473">Sleep</span><span class="op" id="6579478">(</span><span class="ident" id="6579479">time</span><span class="op" id="6579483">.</span><span class="ident" id="6579484">Second</span><span class="op" id="6579490">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6579494">f</span><span class="op" id="6579495">,</span>&nbsp;<span class="ident" id="6579497">err</span>&nbsp;<span class="op" id="6579501">:=</span>&nbsp;<span class="ident" id="6579504">os</span><span class="op" id="6579506">.</span><span class="ident" id="6579507">OpenFile</span><span class="op" id="6579515">(</span><span class="ident" id="6579516">r</span><span class="op" id="6579517">.</span><span class="ident" id="6579518">path</span><span class="op" id="6579522">,</span>&nbsp;<span class="ident" id="6579524">os</span><span class="op" id="6579526">.</span><span class="ident" id="6579527">O_CREATE</span><span class="op" id="6579535">|</span><span class="ident" id="6579536">os</span><span class="op" id="6579538">.</span><span class="ident" id="6579539">O_TRUNC</span><span class="op" id="6579546">|</span><span class="ident" id="6579547">os</span><span class="op" id="6579549">.</span><span class="ident" id="6579550">O_WRONLY</span><span class="op" id="6579558">,</span>&nbsp;<span class="num" id="6579560">0600</span><span class="op" id="6579564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6579567">if</span>&nbsp;<span class="ident" id="6579570">err</span>&nbsp;<span class="op" id="6579574">!=</span>&nbsp;<span class="ident" id="6579577">nil</span>&nbsp;<span class="op" id="6579581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6579585">r</span><span class="op" id="6579586">.</span><span class="ident" id="6579587">Fatalf</span><span class="op" id="6579593">(</span><span class="string" id="6579594">&#34;failed&nbsp;to&nbsp;create&nbsp;temp&nbsp;file&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="6579629">,</span>&nbsp;<span class="ident" id="6579631">r</span><span class="op" id="6579632">.</span><span class="ident" id="6579633">path</span><span class="op" id="6579637">,</span>&nbsp;<span class="ident" id="6579639">err</span><span class="op" id="6579642">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6579645">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6579648">if</span>&nbsp;<span class="ident" id="6579651">_</span><span class="op" id="6579652">,</span>&nbsp;<span class="ident" id="6579654">err</span>&nbsp;<span class="op" id="6579658">:=</span>&nbsp;<span class="ident" id="6579661">io</span><span class="op" id="6579663">.</span><span class="ident" id="6579664">WriteString</span><span class="op" id="6579675">(</span><span class="ident" id="6579676">f</span><span class="op" id="6579677">,</span>&nbsp;<span class="ident" id="6579679">s</span><span class="op" id="6579680">)</span><span class="op" id="6579681">;</span>&nbsp;<span class="ident" id="6579683">err</span>&nbsp;<span class="op" id="6579687">!=</span>&nbsp;<span class="ident" id="6579690">nil</span>&nbsp;<span class="op" id="6579694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6579698">f</span><span class="op" id="6579699">.</span><span class="ident" id="6579700">Close</span><span class="op" id="6579705">(</span><span class="op" id="6579706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6579710">r</span><span class="op" id="6579711">.</span><span class="ident" id="6579712">Fatalf</span><span class="op" id="6579718">(</span><span class="string" id="6579719">&#34;failed&nbsp;to&nbsp;write&nbsp;temp&nbsp;file:&nbsp;%v&#34;</span><span class="op" id="6579750">,</span>&nbsp;<span class="ident" id="6579752">err</span><span class="op" id="6579755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6579758">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6579761">f</span><span class="op" id="6579762">.</span><span class="ident" id="6579763">Close</span><span class="op" id="6579768">(</span><span class="op" id="6579769">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6579773">if</span>&nbsp;<span class="ident" id="6579776">r</span><span class="op" id="6579777">.</span><span class="ident" id="6579778">started</span>&nbsp;<span class="op" id="6579786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6579790">cfg</span><span class="op" id="6579793">.</span><span class="ident" id="6579794">ch</span>&nbsp;<span class="op" id="6579797">&lt;-</span>&nbsp;<span class="keyword" id="6579800">struct</span><span class="op" id="6579806">{</span><span class="op" id="6579807">}</span><span class="op" id="6579808">{</span><span class="op" id="6579809">}</span>&nbsp;<span class="comment" id="6579811">//&nbsp;fill&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6579828">cfg</span><span class="op" id="6579831">.</span><span class="ident" id="6579832">ch</span>&nbsp;<span class="op" id="6579835">&lt;-</span>&nbsp;<span class="keyword" id="6579838">struct</span><span class="op" id="6579844">{</span><span class="op" id="6579845">}</span><span class="op" id="6579846">{</span><span class="op" id="6579847">}</span>&nbsp;<span class="comment" id="6579849">//&nbsp;wait&nbsp;for&nbsp;reload&nbsp;to&nbsp;begin</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6579879">cfg</span><span class="op" id="6579882">.</span><span class="ident" id="6579883">ch</span>&nbsp;<span class="op" id="6579886">&lt;-</span>&nbsp;<span class="keyword" id="6579889">struct</span><span class="op" id="6579895">{</span><span class="op" id="6579896">}</span><span class="op" id="6579897">{</span><span class="op" id="6579898">}</span>&nbsp;<span class="comment" id="6579900">//&nbsp;wait&nbsp;for&nbsp;reload&nbsp;to&nbsp;complete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6579932">}</span><br>
<span class="lineno"></span><span class="op" id="6579934">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6579937">func</span>&nbsp;<span class="op" id="6579942">(</span><span class="ident" id="6579943">r</span>&nbsp;<span class="op" id="6579945">*</span><span class="ident" id="6579946">resolvConfTest</span><span class="op" id="6579960">)</span>&nbsp;<span class="ident" id="6579962">WantServers</span><span class="op" id="6579973">(</span><span class="ident" id="6579974">want</span>&nbsp;<span class="op" id="6579979">[</span><span class="op" id="6579980">]</span><span class="builtintype" id="6579981">string</span><span class="op" id="6579987">)</span>&nbsp;<span class="op" id="6579989">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6579992">cfg</span><span class="op" id="6579995">.</span><span class="ident" id="6579996">mu</span><span class="op" id="6579998">.</span><span class="ident" id="6579999">RLock</span><span class="op" id="6580004">(</span><span class="op" id="6580005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6580008">defer</span>&nbsp;<span class="ident" id="6580014">cfg</span><span class="op" id="6580017">.</span><span class="ident" id="6580018">mu</span><span class="op" id="6580020">.</span><span class="ident" id="6580021">RUnlock</span><span class="op" id="6580028">(</span><span class="op" id="6580029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6580032">if</span>&nbsp;<span class="ident" id="6580035">got</span>&nbsp;<span class="op" id="6580039">:=</span>&nbsp;<span class="ident" id="6580042">cfg</span><span class="op" id="6580045">.</span><span class="ident" id="6580046">dnsConfig</span><span class="op" id="6580055">.</span><span class="ident" id="6580056">servers</span><span class="op" id="6580063">;</span>&nbsp;<span class="op" id="6580065">!</span><span class="ident" id="6580066">reflect</span><span class="op" id="6580073">.</span><span class="ident" id="6580074">DeepEqual</span><span class="op" id="6580083">(</span><span class="ident" id="6580084">got</span><span class="op" id="6580087">,</span>&nbsp;<span class="ident" id="6580089">want</span><span class="op" id="6580093">)</span>&nbsp;<span class="op" id="6580095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6580099">r</span><span class="op" id="6580100">.</span><span class="ident" id="6580101">Fatalf</span><span class="op" id="6580107">(</span><span class="string" id="6580108">&#34;Unexpected&nbsp;dns&nbsp;server&nbsp;loaded,&nbsp;got&nbsp;%v&nbsp;want&nbsp;%v&#34;</span><span class="op" id="6580154">,</span>&nbsp;<span class="ident" id="6580156">got</span><span class="op" id="6580159">,</span>&nbsp;<span class="ident" id="6580161">want</span><span class="op" id="6580165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6580168">}</span><br>
<span class="lineno">155</span><span class="op" id="6580170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6580173">func</span>&nbsp;<span class="op" id="6580178">(</span><span class="ident" id="6580179">r</span>&nbsp;<span class="op" id="6580181">*</span><span class="ident" id="6580182">resolvConfTest</span><span class="op" id="6580196">)</span>&nbsp;<span class="ident" id="6580198">Close</span><span class="op" id="6580203">(</span><span class="op" id="6580204">)</span>&nbsp;<span class="op" id="6580206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6580209">resp</span>&nbsp;<span class="op" id="6580214">:=</span>&nbsp;<span class="builtinfunc" id="6580217">make</span><span class="op" id="6580221">(</span><span class="keyword" id="6580222">chan</span>&nbsp;<span class="keyword" id="6580227">struct</span><span class="op" id="6580233">{</span><span class="op" id="6580234">}</span><span class="op" id="6580235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6580238">r</span><span class="op" id="6580239">.</span><span class="ident" id="6580240">quitc</span>&nbsp;<span class="op" id="6580246">&lt;-</span>&nbsp;<span class="ident" id="6580249">resp</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6580255">&lt;-</span><span class="ident" id="6580257">resp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6580263">if</span>&nbsp;<span class="ident" id="6580266">err</span>&nbsp;<span class="op" id="6580270">:=</span>&nbsp;<span class="ident" id="6580273">os</span><span class="op" id="6580275">.</span><span class="ident" id="6580276">RemoveAll</span><span class="op" id="6580285">(</span><span class="ident" id="6580286">r</span><span class="op" id="6580287">.</span><span class="ident" id="6580288">dir</span><span class="op" id="6580291">)</span><span class="op" id="6580292">;</span>&nbsp;<span class="ident" id="6580294">err</span>&nbsp;<span class="op" id="6580298">!=</span>&nbsp;<span class="ident" id="6580301">nil</span>&nbsp;<span class="op" id="6580305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6580309">r</span><span class="op" id="6580310">.</span><span class="ident" id="6580311">Logf</span><span class="op" id="6580315">(</span><span class="string" id="6580316">&#34;failed&nbsp;to&nbsp;remove&nbsp;temp&nbsp;dir&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="6580350">,</span>&nbsp;<span class="ident" id="6580352">r</span><span class="op" id="6580353">.</span><span class="ident" id="6580354">dir</span><span class="op" id="6580357">,</span>&nbsp;<span class="ident" id="6580359">err</span><span class="op" id="6580362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6580365">}</span><br>
<span class="lineno"></span><span class="op" id="6580367">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="6580370">func</span>&nbsp;<span class="ident" id="6580375">TestReloadResolvConfFail</span><span class="op" id="6580399">(</span><span class="ident" id="6580400">t</span>&nbsp;<span class="op" id="6580402">*</span><span class="ident" id="6580403">testing</span><span class="op" id="6580410">.</span><span class="ident" id="6580411">T</span><span class="op" id="6580412">)</span>&nbsp;<span class="op" id="6580414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6580417">if</span>&nbsp;<span class="ident" id="6580420">testing</span><span class="op" id="6580427">.</span><span class="ident" id="6580428">Short</span><span class="op" id="6580433">(</span><span class="op" id="6580434">)</span>&nbsp;<span class="op" id="6580436">||</span>&nbsp;<span class="op" id="6580439">!</span><span class="op" id="6580440">*</span><span class="ident" id="6580441">testExternal</span>&nbsp;<span class="op" id="6580454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6580458">t</span><span class="op" id="6580459">.</span><span class="ident" id="6580460">Skip</span><span class="op" id="6580464">(</span><span class="string" id="6580465">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="6580506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6580509">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6580513">r</span>&nbsp;<span class="op" id="6580515">:=</span>&nbsp;<span class="ident" id="6580518">newResolvConfTest</span><span class="op" id="6580535">(</span><span class="ident" id="6580536">t</span><span class="op" id="6580537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6580540">defer</span>&nbsp;<span class="ident" id="6580546">r</span><span class="op" id="6580547">.</span><span class="ident" id="6580548">Close</span><span class="op" id="6580553">(</span><span class="op" id="6580554">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6580558">//&nbsp;resolv.conf.tmp&nbsp;does&nbsp;not&nbsp;exist&nbsp;yet</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6580597">r</span><span class="op" id="6580598">.</span><span class="ident" id="6580599">Start</span><span class="op" id="6580604">(</span><span class="op" id="6580605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6580608">if</span>&nbsp;<span class="ident" id="6580611">_</span><span class="op" id="6580612">,</span>&nbsp;<span class="ident" id="6580614">err</span>&nbsp;<span class="op" id="6580618">:=</span>&nbsp;<span class="ident" id="6580621">goLookupIP</span><span class="op" id="6580631">(</span><span class="string" id="6580632">&#34;golang.org&#34;</span><span class="op" id="6580644">)</span><span class="op" id="6580645">;</span>&nbsp;<span class="ident" id="6580647">err</span>&nbsp;<span class="op" id="6580651">==</span>&nbsp;<span class="ident" id="6580654">nil</span>&nbsp;<span class="op" id="6580658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6580662">t</span><span class="op" id="6580663">.</span><span class="ident" id="6580664">Fatal</span><span class="op" id="6580669">(</span><span class="string" id="6580670">&#34;goLookupIP(missing)&nbsp;succeeded&#34;</span><span class="op" id="6580701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6580704">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6580708">r</span><span class="op" id="6580709">.</span><span class="ident" id="6580710">SetConf</span><span class="op" id="6580717">(</span><span class="string" id="6580718">&#34;nameserver&nbsp;8.8.8.8&#34;</span><span class="op" id="6580738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6580741">if</span>&nbsp;<span class="ident" id="6580744">_</span><span class="op" id="6580745">,</span>&nbsp;<span class="ident" id="6580747">err</span>&nbsp;<span class="op" id="6580751">:=</span>&nbsp;<span class="ident" id="6580754">goLookupIP</span><span class="op" id="6580764">(</span><span class="string" id="6580765">&#34;golang.org&#34;</span><span class="op" id="6580777">)</span><span class="op" id="6580778">;</span>&nbsp;<span class="ident" id="6580780">err</span>&nbsp;<span class="op" id="6580784">!=</span>&nbsp;<span class="ident" id="6580787">nil</span>&nbsp;<span class="op" id="6580791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6580795">t</span><span class="op" id="6580796">.</span><span class="ident" id="6580797">Fatalf</span><span class="op" id="6580803">(</span><span class="string" id="6580804">&#34;goLookupIP(missing;&nbsp;good)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6580842">,</span>&nbsp;<span class="ident" id="6580844">err</span><span class="op" id="6580847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6580850">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6580854">//&nbsp;Using&nbsp;a&nbsp;bad&nbsp;resolv.conf&nbsp;while&nbsp;we&nbsp;had&nbsp;a&nbsp;good</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6580902">//&nbsp;one&nbsp;before&nbsp;should&nbsp;not&nbsp;update&nbsp;the&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6580946">r</span><span class="op" id="6580947">.</span><span class="ident" id="6580948">SetConf</span><span class="op" id="6580955">(</span><span class="string" id="6580956">&#34;&#34;</span><span class="op" id="6580958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6580961">if</span>&nbsp;<span class="ident" id="6580964">_</span><span class="op" id="6580965">,</span>&nbsp;<span class="ident" id="6580967">err</span>&nbsp;<span class="op" id="6580971">:=</span>&nbsp;<span class="ident" id="6580974">goLookupIP</span><span class="op" id="6580984">(</span><span class="string" id="6580985">&#34;golang.org&#34;</span><span class="op" id="6580997">)</span><span class="op" id="6580998">;</span>&nbsp;<span class="ident" id="6581000">err</span>&nbsp;<span class="op" id="6581004">!=</span>&nbsp;<span class="ident" id="6581007">nil</span>&nbsp;<span class="op" id="6581011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6581015">t</span><span class="op" id="6581016">.</span><span class="ident" id="6581017">Fatalf</span><span class="op" id="6581023">(</span><span class="string" id="6581024">&#34;goLookupIP(missing;&nbsp;good;&nbsp;bad)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6581067">,</span>&nbsp;<span class="ident" id="6581069">err</span><span class="op" id="6581072">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6581075">}</span><br>
<span class="lineno"></span><span class="op" id="6581077">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6581080">func</span>&nbsp;<span class="ident" id="6581085">TestReloadResolvConfChange</span><span class="op" id="6581111">(</span><span class="ident" id="6581112">t</span>&nbsp;<span class="op" id="6581114">*</span><span class="ident" id="6581115">testing</span><span class="op" id="6581122">.</span><span class="ident" id="6581123">T</span><span class="op" id="6581124">)</span>&nbsp;<span class="op" id="6581126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6581129">if</span>&nbsp;<span class="ident" id="6581132">testing</span><span class="op" id="6581139">.</span><span class="ident" id="6581140">Short</span><span class="op" id="6581145">(</span><span class="op" id="6581146">)</span>&nbsp;<span class="op" id="6581148">||</span>&nbsp;<span class="op" id="6581151">!</span><span class="op" id="6581152">*</span><span class="ident" id="6581153">testExternal</span>&nbsp;<span class="op" id="6581166">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6581170">t</span><span class="op" id="6581171">.</span><span class="ident" id="6581172">Skip</span><span class="op" id="6581176">(</span><span class="string" id="6581177">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="6581218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6581221">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6581225">r</span>&nbsp;<span class="op" id="6581227">:=</span>&nbsp;<span class="ident" id="6581230">newResolvConfTest</span><span class="op" id="6581247">(</span><span class="ident" id="6581248">t</span><span class="op" id="6581249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6581252">defer</span>&nbsp;<span class="ident" id="6581258">r</span><span class="op" id="6581259">.</span><span class="ident" id="6581260">Close</span><span class="op" id="6581265">(</span><span class="op" id="6581266">)</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6581270">r</span><span class="op" id="6581271">.</span><span class="ident" id="6581272">SetConf</span><span class="op" id="6581279">(</span><span class="string" id="6581280">&#34;nameserver&nbsp;8.8.8.8&#34;</span><span class="op" id="6581300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6581303">r</span><span class="op" id="6581304">.</span><span class="ident" id="6581305">Start</span><span class="op" id="6581310">(</span><span class="op" id="6581311">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6581315">if</span>&nbsp;<span class="ident" id="6581318">_</span><span class="op" id="6581319">,</span>&nbsp;<span class="ident" id="6581321">err</span>&nbsp;<span class="op" id="6581325">:=</span>&nbsp;<span class="ident" id="6581328">goLookupIP</span><span class="op" id="6581338">(</span><span class="string" id="6581339">&#34;golang.org&#34;</span><span class="op" id="6581351">)</span><span class="op" id="6581352">;</span>&nbsp;<span class="ident" id="6581354">err</span>&nbsp;<span class="op" id="6581358">!=</span>&nbsp;<span class="ident" id="6581361">nil</span>&nbsp;<span class="op" id="6581365">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6581369">t</span><span class="op" id="6581370">.</span><span class="ident" id="6581371">Fatalf</span><span class="op" id="6581377">(</span><span class="string" id="6581378">&#34;goLookupIP(good)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6581407">,</span>&nbsp;<span class="ident" id="6581409">err</span><span class="op" id="6581412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6581415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6581418">r</span><span class="op" id="6581419">.</span><span class="ident" id="6581420">WantServers</span><span class="op" id="6581431">(</span><span class="op" id="6581432">[</span><span class="op" id="6581433">]</span><span class="builtintype" id="6581434">string</span><span class="op" id="6581440">{</span><span class="string" id="6581441">&#34;8.8.8.8&#34;</span><span class="op" id="6581450">}</span><span class="op" id="6581451">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6581455">//&nbsp;Using&nbsp;a&nbsp;bad&nbsp;resolv.conf&nbsp;when&nbsp;we&nbsp;had&nbsp;a&nbsp;good&nbsp;one</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6581506">//&nbsp;before&nbsp;should&nbsp;not&nbsp;update&nbsp;the&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6581546">r</span><span class="op" id="6581547">.</span><span class="ident" id="6581548">SetConf</span><span class="op" id="6581555">(</span><span class="string" id="6581556">&#34;&#34;</span><span class="op" id="6581558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6581561">if</span>&nbsp;<span class="ident" id="6581564">_</span><span class="op" id="6581565">,</span>&nbsp;<span class="ident" id="6581567">err</span>&nbsp;<span class="op" id="6581571">:=</span>&nbsp;<span class="ident" id="6581574">goLookupIP</span><span class="op" id="6581584">(</span><span class="string" id="6581585">&#34;golang.org&#34;</span><span class="op" id="6581597">)</span><span class="op" id="6581598">;</span>&nbsp;<span class="ident" id="6581600">err</span>&nbsp;<span class="op" id="6581604">!=</span>&nbsp;<span class="ident" id="6581607">nil</span>&nbsp;<span class="op" id="6581611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6581615">t</span><span class="op" id="6581616">.</span><span class="ident" id="6581617">Fatalf</span><span class="op" id="6581623">(</span><span class="string" id="6581624">&#34;goLookupIP(good;&nbsp;bad)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6581658">,</span>&nbsp;<span class="ident" id="6581660">err</span><span class="op" id="6581663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6581666">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6581670">//&nbsp;A&nbsp;new&nbsp;good&nbsp;config&nbsp;should&nbsp;get&nbsp;picked&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6581713">r</span><span class="op" id="6581714">.</span><span class="ident" id="6581715">SetConf</span><span class="op" id="6581722">(</span><span class="string" id="6581723">&#34;nameserver&nbsp;8.8.4.4&#34;</span><span class="op" id="6581743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6581746">r</span><span class="op" id="6581747">.</span><span class="ident" id="6581748">WantServers</span><span class="op" id="6581759">(</span><span class="op" id="6581760">[</span><span class="op" id="6581761">]</span><span class="builtintype" id="6581762">string</span><span class="op" id="6581768">{</span><span class="string" id="6581769">&#34;8.8.4.4&#34;</span><span class="op" id="6581778">}</span><span class="op" id="6581779">)</span><br>
<span class="lineno"></span><span class="op" id="6581781">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="keyword" id="6581784">func</span>&nbsp;<span class="ident" id="6581789">BenchmarkGoLookupIP</span><span class="op" id="6581808">(</span><span class="ident" id="6581809">b</span>&nbsp;<span class="op" id="6581811">*</span><span class="ident" id="6581812">testing</span><span class="op" id="6581819">.</span><span class="ident" id="6581820">B</span><span class="op" id="6581821">)</span>&nbsp;<span class="op" id="6581823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6581826">for</span>&nbsp;<span class="ident" id="6581830">i</span>&nbsp;<span class="op" id="6581832">:=</span>&nbsp;<span class="num" id="6581835">0</span><span class="op" id="6581836">;</span>&nbsp;<span class="ident" id="6581838">i</span>&nbsp;<span class="op" id="6581840">&lt;</span>&nbsp;<span class="ident" id="6581842">b</span><span class="op" id="6581843">.</span><span class="ident" id="6581844">N</span><span class="op" id="6581845">;</span>&nbsp;<span class="ident" id="6581847">i</span><span class="op" id="6581848">++</span>&nbsp;<span class="op" id="6581851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6581855">goLookupIP</span><span class="op" id="6581865">(</span><span class="string" id="6581866">&#34;www.example.com&#34;</span><span class="op" id="6581883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6581886">}</span><br>
<span class="lineno">225</span><span class="op" id="6581888">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6581891">func</span>&nbsp;<span class="ident" id="6581896">BenchmarkGoLookupIPNoSuchHost</span><span class="op" id="6581925">(</span><span class="ident" id="6581926">b</span>&nbsp;<span class="op" id="6581928">*</span><span class="ident" id="6581929">testing</span><span class="op" id="6581936">.</span><span class="ident" id="6581937">B</span><span class="op" id="6581938">)</span>&nbsp;<span class="op" id="6581940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6581943">for</span>&nbsp;<span class="ident" id="6581947">i</span>&nbsp;<span class="op" id="6581949">:=</span>&nbsp;<span class="num" id="6581952">0</span><span class="op" id="6581953">;</span>&nbsp;<span class="ident" id="6581955">i</span>&nbsp;<span class="op" id="6581957">&lt;</span>&nbsp;<span class="ident" id="6581959">b</span><span class="op" id="6581960">.</span><span class="ident" id="6581961">N</span><span class="op" id="6581962">;</span>&nbsp;<span class="ident" id="6581964">i</span><span class="op" id="6581965">++</span>&nbsp;<span class="op" id="6581968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6581972">goLookupIP</span><span class="op" id="6581982">(</span><span class="string" id="6581983">&#34;some.nonexistent&#34;</span><span class="op" id="6582001">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6582004">}</span><br>
<span class="lineno"></span><span class="op" id="6582006">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6582009">func</span>&nbsp;<span class="ident" id="6582014">BenchmarkGoLookupIPWithBrokenNameServer</span><span class="op" id="6582053">(</span><span class="ident" id="6582054">b</span>&nbsp;<span class="op" id="6582056">*</span><span class="ident" id="6582057">testing</span><span class="op" id="6582064">.</span><span class="ident" id="6582065">B</span><span class="op" id="6582066">)</span>&nbsp;<span class="op" id="6582068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6582071">onceLoadConfig</span><span class="op" id="6582085">.</span><span class="ident" id="6582086">Do</span><span class="op" id="6582088">(</span><span class="ident" id="6582089">loadDefaultConfig</span><span class="op" id="6582106">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6582109">if</span>&nbsp;<span class="ident" id="6582112">cfg</span><span class="op" id="6582115">.</span><span class="ident" id="6582116">dnserr</span>&nbsp;<span class="op" id="6582123">!=</span>&nbsp;<span class="ident" id="6582126">nil</span>&nbsp;<span class="op" id="6582130">||</span>&nbsp;<span class="ident" id="6582133">cfg</span><span class="op" id="6582136">.</span><span class="ident" id="6582137">dnsConfig</span>&nbsp;<span class="op" id="6582147">==</span>&nbsp;<span class="ident" id="6582150">nil</span>&nbsp;<span class="op" id="6582154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6582158">b</span><span class="op" id="6582159">.</span><span class="ident" id="6582160">Fatalf</span><span class="op" id="6582166">(</span><span class="string" id="6582167">&#34;loadConfig&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6582190">,</span>&nbsp;<span class="ident" id="6582192">cfg</span><span class="op" id="6582195">.</span><span class="ident" id="6582196">dnserr</span><span class="op" id="6582202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6582205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6582208">//&nbsp;This&nbsp;looks&nbsp;ugly&nbsp;but&nbsp;it&#39;s&nbsp;safe&nbsp;as&nbsp;long&nbsp;as&nbsp;benchmarks&nbsp;are&nbsp;run</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6582272">//&nbsp;sequentially&nbsp;in&nbsp;package&nbsp;testing.</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6582309">orig</span>&nbsp;<span class="op" id="6582314">:=</span>&nbsp;<span class="ident" id="6582317">cfg</span><span class="op" id="6582320">.</span><span class="ident" id="6582321">dnsConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6582332">cfg</span><span class="op" id="6582335">.</span><span class="ident" id="6582336">dnsConfig</span><span class="op" id="6582345">.</span><span class="ident" id="6582346">servers</span>&nbsp;<span class="op" id="6582354">=</span>&nbsp;<span class="builtinfunc" id="6582356">append</span><span class="op" id="6582362">(</span><span class="op" id="6582363">[</span><span class="op" id="6582364">]</span><span class="builtintype" id="6582365">string</span><span class="op" id="6582371">{</span><span class="string" id="6582372">&#34;203.0.113.254&#34;</span><span class="op" id="6582387">}</span><span class="op" id="6582388">,</span>&nbsp;<span class="ident" id="6582390">cfg</span><span class="op" id="6582393">.</span><span class="ident" id="6582394">dnsConfig</span><span class="op" id="6582403">.</span><span class="ident" id="6582404">servers</span><span class="op" id="6582411">...</span><span class="op" id="6582414">)</span>&nbsp;<span class="comment" id="6582416">//&nbsp;use&nbsp;TEST-NET-3&nbsp;block,&nbsp;see&nbsp;RFC&nbsp;5737</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6582455">for</span>&nbsp;<span class="ident" id="6582459">i</span>&nbsp;<span class="op" id="6582461">:=</span>&nbsp;<span class="num" id="6582464">0</span><span class="op" id="6582465">;</span>&nbsp;<span class="ident" id="6582467">i</span>&nbsp;<span class="op" id="6582469">&lt;</span>&nbsp;<span class="ident" id="6582471">b</span><span class="op" id="6582472">.</span><span class="ident" id="6582473">N</span><span class="op" id="6582474">;</span>&nbsp;<span class="ident" id="6582476">i</span><span class="op" id="6582477">++</span>&nbsp;<span class="op" id="6582480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6582484">goLookupIP</span><span class="op" id="6582494">(</span><span class="string" id="6582495">&#34;www.example.com&#34;</span><span class="op" id="6582512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6582515">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6582518">cfg</span><span class="op" id="6582521">.</span><span class="ident" id="6582522">dnsConfig</span>&nbsp;<span class="op" id="6582532">=</span>&nbsp;<span class="ident" id="6582534">orig</span><br>
<span class="lineno"></span><span class="op" id="6582539">}</span>
</div>
</body>
</html>
