<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword">package</span>&nbsp;<span class="ident">textproto</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">canonicalHeaderKeyTest</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">in</span><span class="op">,</span>&nbsp;<span class="ident">out</span>&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword">var</span>&nbsp;<span class="ident">canonicalHeaderKeyTests</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">canonicalHeaderKeyTest</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="string">&#34;a-b-c&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;A-B-C&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="string">&#34;a-1-c&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;A-1-C&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="string">&#34;User-Agent&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;User-Agent&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="string">&#34;uSER-aGENT&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;User-Agent&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="string">&#34;user-agent&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;User-Agent&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="string">&#34;USER-AGENT&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;User-Agent&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="string">&#34;üser-agenT&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;üser-Agent&#34;</span><span class="op">}</span><span class="op">,</span>&nbsp;<span class="comment">//&nbsp;non-ASCII&nbsp;unchanged</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;This&nbsp;caused&nbsp;a&nbsp;panic&nbsp;due&nbsp;to&nbsp;mishandling&nbsp;of&nbsp;a&nbsp;space:</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="string">&#34;C&nbsp;Ontent-Transfer-Encoding&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;C-Ontent-Transfer-Encoding&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="string">&#34;foo&nbsp;bar&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;Foo-Bar&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">TestCanonicalMIMEHeaderKey</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">tt</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">canonicalHeaderKeyTests</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">CanonicalMIMEHeaderKey</span><span class="op">(</span><span class="ident">tt</span><span class="op">.</span><span class="ident">in</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">out</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Errorf</span><span class="op">(</span><span class="string">&#34;CanonicalMIMEHeaderKey(%q)&nbsp;=&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">in</span><span class="op">,</span>&nbsp;<span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">out</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">40</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">reader</span><span class="op">(</span><span class="ident">s</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Reader</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">NewReader</span><span class="op">(</span><span class="ident">bufio</span><span class="op">.</span><span class="ident">NewReader</span><span class="op">(</span><span class="ident">strings</span><span class="op">.</span><span class="ident">NewReader</span><span class="op">(</span><span class="ident">s</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">TestReadLine</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">reader</span><span class="op">(</span><span class="string">&#34;line1\nline2\n&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ReadLine</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="string">&#34;line1&#34;</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Line&nbsp;1:&nbsp;%s,&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ReadLine</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="string">&#34;line2&#34;</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Line&nbsp;2:&nbsp;%s,&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ReadLine</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="string">&#34;&#34;</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">EOF</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;EOF:&nbsp;%s,&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">60</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">TestReadContinuedLine</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">reader</span><span class="op">(</span><span class="string">&#34;line1\nline\n&nbsp;2\nline3\n&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ReadContinuedLine</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="string">&#34;line1&#34;</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Line&nbsp;1:&nbsp;%s,&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ReadContinuedLine</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="string">&#34;line&nbsp;2&#34;</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Line&nbsp;2:&nbsp;%s,&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ReadContinuedLine</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="string">&#34;line3&#34;</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Line&nbsp;3:&nbsp;%s,&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ReadContinuedLine</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="string">&#34;&#34;</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">EOF</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;EOF:&nbsp;%s,&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">80</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">TestReadCodeLine</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">reader</span><span class="op">(</span><span class="string">&#34;123&nbsp;hi\n234&nbsp;bye\n345&nbsp;no&nbsp;way\n&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">code</span><span class="op">,</span>&nbsp;<span class="ident">msg</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ReadCodeLine</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">code</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">123</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">msg</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="string">&#34;hi&#34;</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Line&nbsp;1:&nbsp;%d,&nbsp;%s,&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">code</span><span class="op">,</span>&nbsp;<span class="ident">msg</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">code</span><span class="op">,</span>&nbsp;<span class="ident">msg</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ReadCodeLine</span><span class="op">(</span><span class="num">23</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">code</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">234</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">msg</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="string">&#34;bye&#34;</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Line&nbsp;2:&nbsp;%d,&nbsp;%s,&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">code</span><span class="op">,</span>&nbsp;<span class="ident">msg</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">code</span><span class="op">,</span>&nbsp;<span class="ident">msg</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ReadCodeLine</span><span class="op">(</span><span class="num">346</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">code</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">345</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">msg</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="string">&#34;no&nbsp;way&#34;</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Line&nbsp;3:&nbsp;%d,&nbsp;%s,&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">code</span><span class="op">,</span>&nbsp;<span class="ident">msg</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">e</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">err</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">Error</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">e</span><span class="op">.</span><span class="ident">Code</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">code</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">e</span><span class="op">.</span><span class="ident">Msg</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">msg</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Line&nbsp;3:&nbsp;wrong&nbsp;error&nbsp;%v\n&#34;</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">code</span><span class="op">,</span>&nbsp;<span class="ident">msg</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ReadCodeLine</span><span class="op">(</span><span class="num">1</span><span class="op">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">code</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">msg</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="string">&#34;&#34;</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">EOF</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;EOF:&nbsp;%d,&nbsp;%s,&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">code</span><span class="op">,</span>&nbsp;<span class="ident">msg</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword">func</span>&nbsp;<span class="ident">TestReadDotLines</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">reader</span><span class="op">(</span><span class="string">&#34;dotlines\r\n.foo\r\n..bar\n...baz\nquux\r\n\r\n.\r\nanother\n&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ReadDotLines</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">want</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">string</span><span class="op">{</span><span class="string">&#34;dotlines&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;foo&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;.bar&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;..baz&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;quux&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">DeepEqual</span><span class="op">(</span><span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">want</span><span class="op">)</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;ReadDotLines:&nbsp;%v,&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ReadDotLines</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">want</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">string</span><span class="op">{</span><span class="string">&#34;another&#34;</span><span class="op">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">DeepEqual</span><span class="op">(</span><span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">want</span><span class="op">)</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">ErrUnexpectedEOF</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;ReadDotLines2:&nbsp;%v,&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword">func</span>&nbsp;<span class="ident">TestReadDotBytes</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">reader</span><span class="op">(</span><span class="string">&#34;dotlines\r\n.foo\r\n..bar\n...baz\nquux\r\n\r\n.\r\nanot.her\r\n&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ReadDotBytes</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">want</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">(</span><span class="string">&#34;dotlines\nfoo\n.bar\n..baz\nquux\n\n&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">DeepEqual</span><span class="op">(</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">want</span><span class="op">)</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;ReadDotBytes:&nbsp;%q,&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ReadDotBytes</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">want</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">(</span><span class="string">&#34;anot.her\n&#34;</span><span class="op">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">DeepEqual</span><span class="op">(</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">want</span><span class="op">)</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">ErrUnexpectedEOF</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;ReadDotBytes2:&nbsp;%q,&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword">func</span>&nbsp;<span class="ident">TestReadMIMEHeader</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">reader</span><span class="op">(</span><span class="string">&#34;my-key:&nbsp;Value&nbsp;1&nbsp;&nbsp;\r\nLong-key:&nbsp;Even&nbsp;\n&nbsp;Longer&nbsp;Value\r\nmy-Key:&nbsp;Value&nbsp;2\r\n\n&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ReadMIMEHeader</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">want</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">MIMEHeader</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;My-Key&#34;</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;<span class="op">{</span><span class="string">&#34;Value&nbsp;1&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;Value&nbsp;2&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;Long-Key&#34;</span><span class="op">:</span>&nbsp;<span class="op">{</span><span class="string">&#34;Even&nbsp;Longer&nbsp;Value&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">DeepEqual</span><span class="op">(</span><span class="ident">m</span><span class="op">,</span>&nbsp;<span class="ident">want</span><span class="op">)</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;ReadMIMEHeader:&nbsp;%v,&nbsp;%v;&nbsp;want&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">m</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">,</span>&nbsp;<span class="ident">want</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">145</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">TestReadMIMEHeaderSingle</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">reader</span><span class="op">(</span><span class="string">&#34;Foo:&nbsp;bar\n\n&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ReadMIMEHeader</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">want</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">MIMEHeader</span><span class="op">{</span><span class="string">&#34;Foo&#34;</span><span class="op">:</span>&nbsp;<span class="op">{</span><span class="string">&#34;bar&#34;</span><span class="op">}</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">DeepEqual</span><span class="op">(</span><span class="ident">m</span><span class="op">,</span>&nbsp;<span class="ident">want</span><span class="op">)</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;ReadMIMEHeader:&nbsp;%v,&nbsp;%v;&nbsp;want&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">m</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">,</span>&nbsp;<span class="ident">want</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">TestLargeReadMIMEHeader</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">data</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="num">16</span><span class="op">*</span><span class="num">1024</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">data</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">data</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#39;x&#39;</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sdata</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">string</span><span class="op">(</span><span class="ident">data</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">reader</span><span class="op">(</span><span class="string">&#34;Cookie:&nbsp;&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">sdata</span>&nbsp;<span class="op">+</span>&nbsp;<span class="string">&#34;\r\n\n&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ReadMIMEHeader</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;ReadMIMEHeader:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cookie</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">m</span><span class="op">.</span><span class="ident">Get</span><span class="op">(</span><span class="string">&#34;Cookie&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">cookie</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">sdata</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;ReadMIMEHeader:&nbsp;%v&nbsp;bytes,&nbsp;want&nbsp;%v&nbsp;bytes&#34;</span><span class="op">,</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">cookie</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">sdata</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Test&nbsp;that&nbsp;we&nbsp;read&nbsp;slightly-bogus&nbsp;MIME&nbsp;headers&nbsp;seen&nbsp;in&nbsp;the&nbsp;wild,</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;with&nbsp;spaces&nbsp;before&nbsp;colons,&nbsp;and&nbsp;spaces&nbsp;in&nbsp;keys.</span><br>
<span class="lineno">175</span><span class="keyword">func</span>&nbsp;<span class="ident">TestReadMIMEHeaderNonCompliant</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Invalid&nbsp;HTTP&nbsp;response&nbsp;header&nbsp;as&nbsp;sent&nbsp;by&nbsp;an&nbsp;Axis&nbsp;security</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;camera:&nbsp;(this&nbsp;is&nbsp;handled&nbsp;by&nbsp;IE,&nbsp;Firefox,&nbsp;Chrome,&nbsp;curl,&nbsp;etc.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">reader</span><span class="op">(</span><span class="string">&#34;Foo:&nbsp;bar\r\n&#34;</span>&nbsp;<span class="op">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;Content-Language:&nbsp;en\r\n&#34;</span>&nbsp;<span class="op">+</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;SID&nbsp;:&nbsp;0\r\n&#34;</span>&nbsp;<span class="op">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;Audio&nbsp;Mode&nbsp;:&nbsp;None\r\n&#34;</span>&nbsp;<span class="op">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;Privilege&nbsp;:&nbsp;127\r\n\r\n&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ReadMIMEHeader</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">want</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">MIMEHeader</span><span class="op">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;Foo&#34;</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">{</span><span class="string">&#34;bar&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;Content-Language&#34;</span><span class="op">:</span>&nbsp;<span class="op">{</span><span class="string">&#34;en&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;Sid&#34;</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">{</span><span class="string">&#34;0&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;Audio-Mode&#34;</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">{</span><span class="string">&#34;None&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;Privilege&#34;</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">{</span><span class="string">&#34;127&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">DeepEqual</span><span class="op">(</span><span class="ident">m</span><span class="op">,</span>&nbsp;<span class="ident">want</span><span class="op">)</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;ReadMIMEHeader&nbsp;=\n%v,&nbsp;%v;&nbsp;want:\n%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">m</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">,</span>&nbsp;<span class="ident">want</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">readResponseTest</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">in</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">inCode</span>&nbsp;&nbsp;&nbsp;<span class="builtintype">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">wantCode</span>&nbsp;<span class="builtintype">int</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">wantMsg</span>&nbsp;&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">readResponseTests</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">readResponseTest</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="string">&#34;230-Anonymous&nbsp;access&nbsp;granted,&nbsp;restrictions&nbsp;apply\n&#34;</span>&nbsp;<span class="op">+</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;Read&nbsp;the&nbsp;file&nbsp;README.txt,\n&#34;</span>&nbsp;<span class="op">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;230&nbsp;&nbsp;please&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">23</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">230</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;Anonymous&nbsp;access&nbsp;granted,&nbsp;restrictions&nbsp;apply\nRead&nbsp;the&nbsp;file&nbsp;README.txt,\n&nbsp;please&#34;</span><span class="op">,</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="string">&#34;230&nbsp;Anonymous&nbsp;access&nbsp;granted,&nbsp;restrictions&nbsp;apply\n&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">23</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">230</span><span class="op">,</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;Anonymous&nbsp;access&nbsp;granted,&nbsp;restrictions&nbsp;apply&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="string">&#34;400-A\n400-B\n400&nbsp;C&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">4</span><span class="op">,</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">400</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;A\nB\nC&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="string">&#34;400-A\r\n400-B\r\n400&nbsp;C\r\n&#34;</span><span class="op">,</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">4</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">400</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;A\nB\nC&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;See&nbsp;http://www.ietf.org/rfc/rfc959.txt&nbsp;page&nbsp;36.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">TestRFC959Lines</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">tt</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">readResponseTests</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">reader</span><span class="op">(</span><span class="ident">tt</span><span class="op">.</span><span class="ident">in</span>&nbsp;<span class="op">+</span>&nbsp;<span class="string">&#34;\nFOLLOWING&nbsp;DATA&#34;</span><span class="op">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">code</span><span class="op">,</span>&nbsp;<span class="ident">msg</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ReadResponse</span><span class="op">(</span><span class="ident">tt</span><span class="op">.</span><span class="ident">inCode</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Errorf</span><span class="op">(</span><span class="string">&#34;#%d:&nbsp;ReadResponse:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">code</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">wantCode</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Errorf</span><span class="op">(</span><span class="string">&#34;#%d:&nbsp;code=%d,&nbsp;want&nbsp;%d&#34;</span><span class="op">,</span>&nbsp;<span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">code</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">wantCode</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">msg</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">wantMsg</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Errorf</span><span class="op">(</span><span class="string">&#34;#%d:&nbsp;msg=%q,&nbsp;want&nbsp;%q&#34;</span><span class="op">,</span>&nbsp;<span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">msg</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">wantMsg</span><span class="op">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">TestCommonHeaders</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">h</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">commonHeader</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">h</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">CanonicalMIMEHeaderKey</span><span class="op">(</span><span class="ident">h</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Errorf</span><span class="op">(</span><span class="string">&#34;Non-canonical&nbsp;header&nbsp;%q&nbsp;in&nbsp;commonHeader&#34;</span><span class="op">,</span>&nbsp;<span class="ident">h</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">(</span><span class="string">&#34;content-Length&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">want</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="string">&#34;Content-Length&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">testing</span><span class="op">.</span><span class="ident">AllocsPerRun</span><span class="op">(</span><span class="num">200</span><span class="op">,</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">canonicalMIMEHeaderKey</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">want</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;canonicalMIMEHeaderKey(%q)&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">want</span><span class="op">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Errorf</span><span class="op">(</span><span class="string">&#34;canonicalMIMEHeaderKey&nbsp;allocs&nbsp;=&nbsp;%v;&nbsp;want&nbsp;0&#34;</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">265</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">clientHeaders</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">strings</span><span class="op">.</span><span class="ident">Replace</span><span class="op">(</span><span class="string">`Host:&nbsp;golang.org<br>
<span class="lineno"></span>Connection:&nbsp;keep-alive<br>
<span class="lineno"></span>Cache-Control:&nbsp;max-age=0<br>
<span class="lineno">270</span>Accept:&nbsp;application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5<br>
<span class="lineno"></span>User-Agent:&nbsp;Mozilla/5.0&nbsp;(X11;&nbsp;U;&nbsp;Linux&nbsp;x86_64;&nbsp;en-US)&nbsp;AppleWebKit/534.3&nbsp;(KHTML,&nbsp;like&nbsp;Gecko)&nbsp;Chrome/6.0.472.63&nbsp;Safari/534.3<br>
<span class="lineno"></span>Accept-Encoding:&nbsp;gzip,deflate,sdch<br>
<span class="lineno"></span>Accept-Language:&nbsp;en-US,en;q=0.8,fr-CH;q=0.6<br>
<span class="lineno"></span>Accept-Charset:&nbsp;ISO-8859-1,utf-8;q=0.7,*;q=0.3<br>
<span class="lineno">275</span>COOKIE:&nbsp;__utma=000000000.0000000000.0000000000.0000000000.0000000000.00;&nbsp;__utmb=000000000.0.00.0000000000;&nbsp;__utmc=000000000;&nbsp;__utmz=000000000.0000000000.00.0.utmcsr=code.google.com|utmccn=(referral)|utmcmd=referral|utmcct=/p/go/issues/detail<br>
<span class="lineno"></span>Non-Interned:&nbsp;test<br>
<span class="lineno"></span><br>
<span class="lineno"></span>`</span><span class="op">,</span>&nbsp;<span class="string">&#34;\n&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;\r\n&#34;</span><span class="op">,</span>&nbsp;<span class="op">-</span><span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="keyword">var</span>&nbsp;<span class="ident">serverHeaders</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">strings</span><span class="op">.</span><span class="ident">Replace</span><span class="op">(</span><span class="string">`Content-Type:&nbsp;text/html;&nbsp;charset=utf-8<br>
<span class="lineno"></span>Content-Encoding:&nbsp;gzip<br>
<span class="lineno"></span>Date:&nbsp;Thu,&nbsp;27&nbsp;Sep&nbsp;2012&nbsp;09:03:33&nbsp;GMT<br>
<span class="lineno"></span>Server:&nbsp;Google&nbsp;Frontend<br>
<span class="lineno"></span>Cache-Control:&nbsp;private<br>
<span class="lineno">285</span>Content-Length:&nbsp;2298<br>
<span class="lineno"></span>VIA:&nbsp;1.1&nbsp;proxy.example.com:80&nbsp;(XXX/n.n.n-nnn)<br>
<span class="lineno"></span>Connection:&nbsp;Close<br>
<span class="lineno"></span>Non-Interned:&nbsp;test<br>
<span class="lineno"></span><br>
<span class="lineno">290</span>`</span><span class="op">,</span>&nbsp;<span class="string">&#34;\n&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;\r\n&#34;</span><span class="op">,</span>&nbsp;<span class="op">-</span><span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">BenchmarkReadMIMEHeader</span><span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">B</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">ReportAllocs</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">buf</span>&nbsp;<span class="ident">bytes</span><span class="op">.</span><span class="ident">Buffer</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">br</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">bufio</span><span class="op">.</span><span class="ident">NewReader</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">buf</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">NewReader</span><span class="op">(</span><span class="ident">br</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">N</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">want</span>&nbsp;<span class="builtintype">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">find</span>&nbsp;<span class="builtintype">string</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">&amp;</span>&nbsp;<span class="num">1</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">buf</span><span class="op">.</span><span class="ident">WriteString</span><span class="op">(</span><span class="ident">clientHeaders</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">want</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">find</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#34;Cookie&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">buf</span><span class="op">.</span><span class="ident">WriteString</span><span class="op">(</span><span class="ident">serverHeaders</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">want</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">find</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#34;Via&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">h</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ReadMIMEHeader</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">Fatal</span><span class="op">(</span><span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">h</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">want</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;wrong&nbsp;number&nbsp;of&nbsp;headers:&nbsp;got&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op">,</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">h</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">want</span><span class="op">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">h</span><span class="op">[</span><span class="ident">find</span><span class="op">]</span><span class="op">;</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;did&nbsp;not&nbsp;find&nbsp;key&nbsp;%s&#34;</span><span class="op">,</span>&nbsp;<span class="ident">find</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">320</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">BenchmarkUncommon</span><span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">B</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">ReportAllocs</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">buf</span>&nbsp;<span class="ident">bytes</span><span class="op">.</span><span class="ident">Buffer</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">br</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">bufio</span><span class="op">.</span><span class="ident">NewReader</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">buf</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">NewReader</span><span class="op">(</span><span class="ident">br</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">N</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">buf</span><span class="op">.</span><span class="ident">WriteString</span><span class="op">(</span><span class="string">&#34;uncommon-header-for-benchmark:&nbsp;foo\r\n\r\n&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">h</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ReadMIMEHeader</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">Fatal</span><span class="op">(</span><span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">h</span><span class="op">[</span><span class="string">&#34;Uncommon-Header-For-Benchmark&#34;</span><span class="op">]</span><span class="op">;</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">Fatal</span><span class="op">(</span><span class="string">&#34;Missing&nbsp;result&nbsp;header.&#34;</span><span class="op">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span>
</div>
</body>
</html>
