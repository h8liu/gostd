<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/internal</h2>
<ul>
<li><a href="/gostd/net/http/internal/chunked.go.html" class="current">chunked.go</a></li>
<li><a href="/gostd/net/http/internal/chunked_test.go.html">chunked_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4188377">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4188432">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4188486">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4188537">//&nbsp;The&nbsp;wire&nbsp;protocol&nbsp;for&nbsp;HTTP&#39;s&nbsp;&#34;chunked&#34;&nbsp;Transfer-Encoding.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4188599">//&nbsp;Package&nbsp;internal&nbsp;contains&nbsp;HTTP&nbsp;internals&nbsp;shared&nbsp;by&nbsp;net/http&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4188666">//&nbsp;net/http/httputil.</span><br>
<span class="lineno"></span><span class="keyword" id="4188688">package</span>&nbsp;<span class="ident" id="4188696">internal</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="4188706">import</span>&nbsp;<span class="op" id="4188713">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4188716">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4188725">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4188734">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4188744">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4188751">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="4188756">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4188759">const</span>&nbsp;<span class="ident" id="4188765">maxLineLength</span>&nbsp;<span class="op" id="4188779">=</span>&nbsp;<span class="num" id="4188781">4096</span>&nbsp;<span class="comment" id="4188786">//&nbsp;assumed&nbsp;&lt;=&nbsp;bufio.defaultBufSize</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="4188822">var</span>&nbsp;<span class="ident" id="4188826">ErrLineTooLong</span>&nbsp;<span class="op" id="4188841">=</span>&nbsp;<span class="ident" id="4188843">errors</span><span class="op" id="4188849">.</span><span class="ident" id="4188850">New</span><span class="op" id="4188853">(</span><span class="string" id="4188854">&#34;header&nbsp;line&nbsp;too&nbsp;long&#34;</span><span class="op" id="4188876">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4188879">//&nbsp;NewChunkedReader&nbsp;returns&nbsp;a&nbsp;new&nbsp;chunkedReader&nbsp;that&nbsp;translates&nbsp;the&nbsp;data&nbsp;read&nbsp;from&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="4188964">//&nbsp;out&nbsp;of&nbsp;HTTP&nbsp;&#34;chunked&#34;&nbsp;format&nbsp;before&nbsp;returning&nbsp;it.</span><br>
<span class="lineno">25</span><span class="comment" id="4189017">//&nbsp;The&nbsp;chunkedReader&nbsp;returns&nbsp;io.EOF&nbsp;when&nbsp;the&nbsp;final&nbsp;0-length&nbsp;chunk&nbsp;is&nbsp;read.</span><br>
<span class="lineno"></span><span class="comment" id="4189092">//</span><br>
<span class="lineno"></span><span class="comment" id="4189095">//&nbsp;NewChunkedReader&nbsp;is&nbsp;not&nbsp;needed&nbsp;by&nbsp;normal&nbsp;applications.&nbsp;The&nbsp;http&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="4189170">//&nbsp;automatically&nbsp;decodes&nbsp;chunking&nbsp;when&nbsp;reading&nbsp;response&nbsp;bodies.</span><br>
<span class="lineno"></span><span class="keyword" id="4189234">func</span>&nbsp;<span class="ident" id="4189239">NewChunkedReader</span><span class="op" id="4189255">(</span><span class="ident" id="4189256">r</span>&nbsp;<span class="ident" id="4189258">io</span><span class="op" id="4189260">.</span><span class="ident" id="4189261">Reader</span><span class="op" id="4189267">)</span>&nbsp;<span class="ident" id="4189269">io</span><span class="op" id="4189271">.</span><span class="ident" id="4189272">Reader</span>&nbsp;<span class="op" id="4189279">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4189282">br</span><span class="op" id="4189284">,</span>&nbsp;<span class="ident" id="4189286">ok</span>&nbsp;<span class="op" id="4189289">:=</span>&nbsp;<span class="ident" id="4189292">r</span><span class="op" id="4189293">.</span><span class="op" id="4189294">(</span><span class="op" id="4189295">*</span><span class="ident" id="4189296">bufio</span><span class="op" id="4189301">.</span><span class="ident" id="4189302">Reader</span><span class="op" id="4189308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4189311">if</span>&nbsp;<span class="op" id="4189314">!</span><span class="ident" id="4189315">ok</span>&nbsp;<span class="op" id="4189318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4189322">br</span>&nbsp;<span class="op" id="4189325">=</span>&nbsp;<span class="ident" id="4189327">bufio</span><span class="op" id="4189332">.</span><span class="ident" id="4189333">NewReader</span><span class="op" id="4189342">(</span><span class="ident" id="4189343">r</span><span class="op" id="4189344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4189347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4189350">return</span>&nbsp;<span class="op" id="4189357">&amp;</span><span class="ident" id="4189358">chunkedReader</span><span class="op" id="4189371">{</span><span class="ident" id="4189372">r</span><span class="op" id="4189373">:</span>&nbsp;<span class="ident" id="4189375">br</span><span class="op" id="4189377">}</span><br>
<span class="lineno">35</span><span class="op" id="4189379">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4189382">type</span>&nbsp;<span class="ident" id="4189387">chunkedReader</span>&nbsp;<span class="keyword" id="4189401">struct</span>&nbsp;<span class="op" id="4189408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4189411">r</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4189415">*</span><span class="ident" id="4189416">bufio</span><span class="op" id="4189421">.</span><span class="ident" id="4189422">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4189430">n</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4189434">uint64</span>&nbsp;<span class="comment" id="4189441">//&nbsp;unread&nbsp;bytes&nbsp;in&nbsp;chunk</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4189467">err</span>&nbsp;<span class="builtintype" id="4189471">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4189478">buf</span>&nbsp;<span class="op" id="4189482">[</span><span class="num" id="4189483">2</span><span class="op" id="4189484">]</span><span class="builtintype" id="4189485">byte</span><br>
<span class="lineno"></span><span class="op" id="4189490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4189493">func</span>&nbsp;<span class="op" id="4189498">(</span><span class="ident" id="4189499">cr</span>&nbsp;<span class="op" id="4189502">*</span><span class="ident" id="4189503">chunkedReader</span><span class="op" id="4189516">)</span>&nbsp;<span class="ident" id="4189518">beginChunk</span><span class="op" id="4189528">(</span><span class="op" id="4189529">)</span>&nbsp;<span class="op" id="4189531">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4189534">//&nbsp;chunk-size&nbsp;CRLF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4189554">var</span>&nbsp;<span class="ident" id="4189558">line</span>&nbsp;<span class="op" id="4189563">[</span><span class="op" id="4189564">]</span><span class="builtintype" id="4189565">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4189571">line</span><span class="op" id="4189575">,</span>&nbsp;<span class="ident" id="4189577">cr</span><span class="op" id="4189579">.</span><span class="ident" id="4189580">err</span>&nbsp;<span class="op" id="4189584">=</span>&nbsp;<span class="ident" id="4189586">readLine</span><span class="op" id="4189594">(</span><span class="ident" id="4189595">cr</span><span class="op" id="4189597">.</span><span class="ident" id="4189598">r</span><span class="op" id="4189599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4189602">if</span>&nbsp;<span class="ident" id="4189605">cr</span><span class="op" id="4189607">.</span><span class="ident" id="4189608">err</span>&nbsp;<span class="op" id="4189612">!=</span>&nbsp;<span class="builtintype" id="4189615">nil</span>&nbsp;<span class="op" id="4189619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4189623">return</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4189631">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4189634">cr</span><span class="op" id="4189636">.</span><span class="ident" id="4189637">n</span><span class="op" id="4189638">,</span>&nbsp;<span class="ident" id="4189640">cr</span><span class="op" id="4189642">.</span><span class="ident" id="4189643">err</span>&nbsp;<span class="op" id="4189647">=</span>&nbsp;<span class="ident" id="4189649">parseHexUint</span><span class="op" id="4189661">(</span><span class="ident" id="4189662">line</span><span class="op" id="4189666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4189669">if</span>&nbsp;<span class="ident" id="4189672">cr</span><span class="op" id="4189674">.</span><span class="ident" id="4189675">err</span>&nbsp;<span class="op" id="4189679">!=</span>&nbsp;<span class="builtintype" id="4189682">nil</span>&nbsp;<span class="op" id="4189686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4189690">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4189698">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4189701">if</span>&nbsp;<span class="ident" id="4189704">cr</span><span class="op" id="4189706">.</span><span class="ident" id="4189707">n</span>&nbsp;<span class="op" id="4189709">==</span>&nbsp;<span class="num" id="4189712">0</span>&nbsp;<span class="op" id="4189714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4189718">cr</span><span class="op" id="4189720">.</span><span class="ident" id="4189721">err</span>&nbsp;<span class="op" id="4189725">=</span>&nbsp;<span class="ident" id="4189727">io</span><span class="op" id="4189729">.</span><span class="ident" id="4189730">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4189735">}</span><br>
<span class="lineno"></span><span class="op" id="4189737">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="4189740">func</span>&nbsp;<span class="op" id="4189745">(</span><span class="ident" id="4189746">cr</span>&nbsp;<span class="op" id="4189749">*</span><span class="ident" id="4189750">chunkedReader</span><span class="op" id="4189763">)</span>&nbsp;<span class="ident" id="4189765">chunkHeaderAvailable</span><span class="op" id="4189785">(</span><span class="op" id="4189786">)</span>&nbsp;<span class="builtintype" id="4189788">bool</span>&nbsp;<span class="op" id="4189793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4189796">n</span>&nbsp;<span class="op" id="4189798">:=</span>&nbsp;<span class="ident" id="4189801">cr</span><span class="op" id="4189803">.</span><span class="ident" id="4189804">r</span><span class="op" id="4189805">.</span><span class="ident" id="4189806">Buffered</span><span class="op" id="4189814">(</span><span class="op" id="4189815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4189818">if</span>&nbsp;<span class="ident" id="4189821">n</span>&nbsp;<span class="op" id="4189823">&gt;</span>&nbsp;<span class="num" id="4189825">0</span>&nbsp;<span class="op" id="4189827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4189831">peek</span><span class="op" id="4189835">,</span>&nbsp;<span class="ident" id="4189837">_</span>&nbsp;<span class="op" id="4189839">:=</span>&nbsp;<span class="ident" id="4189842">cr</span><span class="op" id="4189844">.</span><span class="ident" id="4189845">r</span><span class="op" id="4189846">.</span><span class="ident" id="4189847">Peek</span><span class="op" id="4189851">(</span><span class="ident" id="4189852">n</span><span class="op" id="4189853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4189857">return</span>&nbsp;<span class="ident" id="4189864">bytes</span><span class="op" id="4189869">.</span><span class="ident" id="4189870">IndexByte</span><span class="op" id="4189879">(</span><span class="ident" id="4189880">peek</span><span class="op" id="4189884">,</span>&nbsp;<span class="string" id="4189886">&#39;\n&#39;</span><span class="op" id="4189890">)</span>&nbsp;<span class="op" id="4189892">&gt;=</span>&nbsp;<span class="num" id="4189895">0</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4189898">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4189901">return</span>&nbsp;<span class="builtintype" id="4189908">false</span><br>
<span class="lineno"></span><span class="op" id="4189914">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4189917">func</span>&nbsp;<span class="op" id="4189922">(</span><span class="ident" id="4189923">cr</span>&nbsp;<span class="op" id="4189926">*</span><span class="ident" id="4189927">chunkedReader</span><span class="op" id="4189940">)</span>&nbsp;<span class="ident" id="4189942">Read</span><span class="op" id="4189946">(</span><span class="ident" id="4189947">b</span>&nbsp;<span class="op" id="4189949">[</span><span class="op" id="4189950">]</span><span class="builtintype" id="4189951">uint8</span><span class="op" id="4189956">)</span>&nbsp;<span class="op" id="4189958">(</span><span class="ident" id="4189959">n</span>&nbsp;<span class="builtintype" id="4189961">int</span><span class="op" id="4189964">,</span>&nbsp;<span class="ident" id="4189966">err</span>&nbsp;<span class="builtintype" id="4189970">error</span><span class="op" id="4189975">)</span>&nbsp;<span class="op" id="4189977">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4189980">for</span>&nbsp;<span class="ident" id="4189984">cr</span><span class="op" id="4189986">.</span><span class="ident" id="4189987">err</span>&nbsp;<span class="op" id="4189991">==</span>&nbsp;<span class="builtintype" id="4189994">nil</span>&nbsp;<span class="op" id="4189998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4190002">if</span>&nbsp;<span class="ident" id="4190005">cr</span><span class="op" id="4190007">.</span><span class="ident" id="4190008">n</span>&nbsp;<span class="op" id="4190010">==</span>&nbsp;<span class="num" id="4190013">0</span>&nbsp;<span class="op" id="4190015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4190020">if</span>&nbsp;<span class="ident" id="4190023">n</span>&nbsp;<span class="op" id="4190025">&gt;</span>&nbsp;<span class="num" id="4190027">0</span>&nbsp;<span class="op" id="4190029">&amp;&amp;</span>&nbsp;<span class="op" id="4190032">!</span><span class="ident" id="4190033">cr</span><span class="op" id="4190035">.</span><span class="ident" id="4190036">chunkHeaderAvailable</span><span class="op" id="4190056">(</span><span class="op" id="4190057">)</span>&nbsp;<span class="op" id="4190059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4190065">//&nbsp;We&#39;ve&nbsp;read&nbsp;enough.&nbsp;Don&#39;t&nbsp;potentially&nbsp;block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4190115">//&nbsp;reading&nbsp;a&nbsp;new&nbsp;chunk&nbsp;header.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4190150">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4190159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4190164">cr</span><span class="op" id="4190166">.</span><span class="ident" id="4190167">beginChunk</span><span class="op" id="4190177">(</span><span class="op" id="4190178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4190183">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4190194">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4190198">if</span>&nbsp;<span class="builtinfunc" id="4190201">len</span><span class="op" id="4190204">(</span><span class="ident" id="4190205">b</span><span class="op" id="4190206">)</span>&nbsp;<span class="op" id="4190208">==</span>&nbsp;<span class="num" id="4190211">0</span>&nbsp;<span class="op" id="4190213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4190218">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4190226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4190230">rbuf</span>&nbsp;<span class="op" id="4190235">:=</span>&nbsp;<span class="ident" id="4190238">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4190242">if</span>&nbsp;<span class="ident" id="4190245">uint64</span><span class="op" id="4190251">(</span><span class="builtinfunc" id="4190252">len</span><span class="op" id="4190255">(</span><span class="ident" id="4190256">rbuf</span><span class="op" id="4190260">)</span><span class="op" id="4190261">)</span>&nbsp;<span class="op" id="4190263">&gt;</span>&nbsp;<span class="ident" id="4190265">cr</span><span class="op" id="4190267">.</span><span class="ident" id="4190268">n</span>&nbsp;<span class="op" id="4190270">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4190275">rbuf</span>&nbsp;<span class="op" id="4190280">=</span>&nbsp;<span class="ident" id="4190282">rbuf</span><span class="op" id="4190286">[</span><span class="op" id="4190287">:</span><span class="ident" id="4190288">cr</span><span class="op" id="4190290">.</span><span class="ident" id="4190291">n</span><span class="op" id="4190292">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4190296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4190300">var</span>&nbsp;<span class="ident" id="4190304">n0</span>&nbsp;<span class="builtintype" id="4190307">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4190313">n0</span><span class="op" id="4190315">,</span>&nbsp;<span class="ident" id="4190317">cr</span><span class="op" id="4190319">.</span><span class="ident" id="4190320">err</span>&nbsp;<span class="op" id="4190324">=</span>&nbsp;<span class="ident" id="4190326">cr</span><span class="op" id="4190328">.</span><span class="ident" id="4190329">r</span><span class="op" id="4190330">.</span><span class="ident" id="4190331">Read</span><span class="op" id="4190335">(</span><span class="ident" id="4190336">rbuf</span><span class="op" id="4190340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4190344">n</span>&nbsp;<span class="op" id="4190346">+=</span>&nbsp;<span class="ident" id="4190349">n0</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4190354">b</span>&nbsp;<span class="op" id="4190356">=</span>&nbsp;<span class="ident" id="4190358">b</span><span class="op" id="4190359">[</span><span class="ident" id="4190360">n0</span><span class="op" id="4190362">:</span><span class="op" id="4190363">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4190367">cr</span><span class="op" id="4190369">.</span><span class="ident" id="4190370">n</span>&nbsp;<span class="op" id="4190372">-=</span>&nbsp;<span class="ident" id="4190375">uint64</span><span class="op" id="4190381">(</span><span class="ident" id="4190382">n0</span><span class="op" id="4190384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4190388">//&nbsp;If&nbsp;we&#39;re&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;a&nbsp;chunk,&nbsp;read&nbsp;the&nbsp;next&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4190443">//&nbsp;bytes&nbsp;to&nbsp;verify&nbsp;they&nbsp;are&nbsp;&#34;\r\n&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4190481">if</span>&nbsp;<span class="ident" id="4190484">cr</span><span class="op" id="4190486">.</span><span class="ident" id="4190487">n</span>&nbsp;<span class="op" id="4190489">==</span>&nbsp;<span class="num" id="4190492">0</span>&nbsp;<span class="op" id="4190494">&amp;&amp;</span>&nbsp;<span class="ident" id="4190497">cr</span><span class="op" id="4190499">.</span><span class="ident" id="4190500">err</span>&nbsp;<span class="op" id="4190504">==</span>&nbsp;<span class="builtintype" id="4190507">nil</span>&nbsp;<span class="op" id="4190511">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4190516">if</span>&nbsp;<span class="ident" id="4190519">_</span><span class="op" id="4190520">,</span>&nbsp;<span class="ident" id="4190522">cr</span><span class="op" id="4190524">.</span><span class="ident" id="4190525">err</span>&nbsp;<span class="op" id="4190529">=</span>&nbsp;<span class="ident" id="4190531">io</span><span class="op" id="4190533">.</span><span class="ident" id="4190534">ReadFull</span><span class="op" id="4190542">(</span><span class="ident" id="4190543">cr</span><span class="op" id="4190545">.</span><span class="ident" id="4190546">r</span><span class="op" id="4190547">,</span>&nbsp;<span class="ident" id="4190549">cr</span><span class="op" id="4190551">.</span><span class="ident" id="4190552">buf</span><span class="op" id="4190555">[</span><span class="op" id="4190556">:</span><span class="num" id="4190557">2</span><span class="op" id="4190558">]</span><span class="op" id="4190559">)</span><span class="op" id="4190560">;</span>&nbsp;<span class="ident" id="4190562">cr</span><span class="op" id="4190564">.</span><span class="ident" id="4190565">err</span>&nbsp;<span class="op" id="4190569">==</span>&nbsp;<span class="builtintype" id="4190572">nil</span>&nbsp;<span class="op" id="4190576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4190582">if</span>&nbsp;<span class="ident" id="4190585">cr</span><span class="op" id="4190587">.</span><span class="ident" id="4190588">buf</span><span class="op" id="4190591">[</span><span class="num" id="4190592">0</span><span class="op" id="4190593">]</span>&nbsp;<span class="op" id="4190595">!=</span>&nbsp;<span class="string" id="4190598">&#39;\r&#39;</span>&nbsp;<span class="op" id="4190603">||</span>&nbsp;<span class="ident" id="4190606">cr</span><span class="op" id="4190608">.</span><span class="ident" id="4190609">buf</span><span class="op" id="4190612">[</span><span class="num" id="4190613">1</span><span class="op" id="4190614">]</span>&nbsp;<span class="op" id="4190616">!=</span>&nbsp;<span class="string" id="4190619">&#39;\n&#39;</span>&nbsp;<span class="op" id="4190624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4190631">cr</span><span class="op" id="4190633">.</span><span class="ident" id="4190634">err</span>&nbsp;<span class="op" id="4190638">=</span>&nbsp;<span class="ident" id="4190640">errors</span><span class="op" id="4190646">.</span><span class="ident" id="4190647">New</span><span class="op" id="4190650">(</span><span class="string" id="4190651">&#34;malformed&nbsp;chunked&nbsp;encoding&#34;</span><span class="op" id="4190679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4190685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4190690">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4190694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4190697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4190700">return</span>&nbsp;<span class="ident" id="4190707">n</span><span class="op" id="4190708">,</span>&nbsp;<span class="ident" id="4190710">cr</span><span class="op" id="4190712">.</span><span class="ident" id="4190713">err</span><br>
<span class="lineno"></span><span class="op" id="4190717">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="4190720">//&nbsp;Read&nbsp;a&nbsp;line&nbsp;of&nbsp;bytes&nbsp;(up&nbsp;to&nbsp;\n)&nbsp;from&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="4190763">//&nbsp;Give&nbsp;up&nbsp;if&nbsp;the&nbsp;line&nbsp;exceeds&nbsp;maxLineLength.</span><br>
<span class="lineno"></span><span class="comment" id="4190809">//&nbsp;The&nbsp;returned&nbsp;bytes&nbsp;are&nbsp;a&nbsp;pointer&nbsp;into&nbsp;storage&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="4190861">//&nbsp;the&nbsp;bufio,&nbsp;so&nbsp;they&nbsp;are&nbsp;only&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;bufio&nbsp;read.</span><br>
<span class="lineno"></span><span class="keyword" id="4190925">func</span>&nbsp;<span class="ident" id="4190930">readLine</span><span class="op" id="4190938">(</span><span class="ident" id="4190939">b</span>&nbsp;<span class="op" id="4190941">*</span><span class="ident" id="4190942">bufio</span><span class="op" id="4190947">.</span><span class="ident" id="4190948">Reader</span><span class="op" id="4190954">)</span>&nbsp;<span class="op" id="4190956">(</span><span class="ident" id="4190957">p</span>&nbsp;<span class="op" id="4190959">[</span><span class="op" id="4190960">]</span><span class="builtintype" id="4190961">byte</span><span class="op" id="4190965">,</span>&nbsp;<span class="ident" id="4190967">err</span>&nbsp;<span class="builtintype" id="4190971">error</span><span class="op" id="4190976">)</span>&nbsp;<span class="op" id="4190978">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4190981">if</span>&nbsp;<span class="ident" id="4190984">p</span><span class="op" id="4190985">,</span>&nbsp;<span class="ident" id="4190987">err</span>&nbsp;<span class="op" id="4190991">=</span>&nbsp;<span class="ident" id="4190993">b</span><span class="op" id="4190994">.</span><span class="ident" id="4190995">ReadSlice</span><span class="op" id="4191004">(</span><span class="string" id="4191005">&#39;\n&#39;</span><span class="op" id="4191009">)</span><span class="op" id="4191010">;</span>&nbsp;<span class="ident" id="4191012">err</span>&nbsp;<span class="op" id="4191016">!=</span>&nbsp;<span class="builtintype" id="4191019">nil</span>&nbsp;<span class="op" id="4191023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4191027">//&nbsp;We&nbsp;always&nbsp;know&nbsp;when&nbsp;EOF&nbsp;is&nbsp;coming.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4191067">//&nbsp;If&nbsp;the&nbsp;caller&nbsp;asked&nbsp;for&nbsp;a&nbsp;line,&nbsp;there&nbsp;should&nbsp;be&nbsp;a&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4191128">if</span>&nbsp;<span class="ident" id="4191131">err</span>&nbsp;<span class="op" id="4191135">==</span>&nbsp;<span class="ident" id="4191138">io</span><span class="op" id="4191140">.</span><span class="ident" id="4191141">EOF</span>&nbsp;<span class="op" id="4191145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4191150">err</span>&nbsp;<span class="op" id="4191154">=</span>&nbsp;<span class="ident" id="4191156">io</span><span class="op" id="4191158">.</span><span class="ident" id="4191159">ErrUnexpectedEOF</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4191178">}</span>&nbsp;<span class="keyword" id="4191180">else</span>&nbsp;<span class="keyword" id="4191185">if</span>&nbsp;<span class="ident" id="4191188">err</span>&nbsp;<span class="op" id="4191192">==</span>&nbsp;<span class="ident" id="4191195">bufio</span><span class="op" id="4191200">.</span><span class="ident" id="4191201">ErrBufferFull</span>&nbsp;<span class="op" id="4191215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4191220">err</span>&nbsp;<span class="op" id="4191224">=</span>&nbsp;<span class="ident" id="4191226">ErrLineTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4191243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4191247">return</span>&nbsp;<span class="builtintype" id="4191254">nil</span><span class="op" id="4191257">,</span>&nbsp;<span class="ident" id="4191259">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4191264">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4191267">if</span>&nbsp;<span class="builtinfunc" id="4191270">len</span><span class="op" id="4191273">(</span><span class="ident" id="4191274">p</span><span class="op" id="4191275">)</span>&nbsp;<span class="op" id="4191277">&gt;=</span>&nbsp;<span class="ident" id="4191280">maxLineLength</span>&nbsp;<span class="op" id="4191294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4191298">return</span>&nbsp;<span class="builtintype" id="4191305">nil</span><span class="op" id="4191308">,</span>&nbsp;<span class="ident" id="4191310">ErrLineTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4191326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4191329">return</span>&nbsp;<span class="ident" id="4191336">trimTrailingWhitespace</span><span class="op" id="4191358">(</span><span class="ident" id="4191359">p</span><span class="op" id="4191360">)</span><span class="op" id="4191361">,</span>&nbsp;<span class="builtintype" id="4191363">nil</span><br>
<span class="lineno"></span><span class="op" id="4191367">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="4191370">func</span>&nbsp;<span class="ident" id="4191375">trimTrailingWhitespace</span><span class="op" id="4191397">(</span><span class="ident" id="4191398">b</span>&nbsp;<span class="op" id="4191400">[</span><span class="op" id="4191401">]</span><span class="builtintype" id="4191402">byte</span><span class="op" id="4191406">)</span>&nbsp;<span class="op" id="4191408">[</span><span class="op" id="4191409">]</span><span class="builtintype" id="4191410">byte</span>&nbsp;<span class="op" id="4191415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4191418">for</span>&nbsp;<span class="builtinfunc" id="4191422">len</span><span class="op" id="4191425">(</span><span class="ident" id="4191426">b</span><span class="op" id="4191427">)</span>&nbsp;<span class="op" id="4191429">&gt;</span>&nbsp;<span class="num" id="4191431">0</span>&nbsp;<span class="op" id="4191433">&amp;&amp;</span>&nbsp;<span class="ident" id="4191436">isASCIISpace</span><span class="op" id="4191448">(</span><span class="ident" id="4191449">b</span><span class="op" id="4191450">[</span><span class="builtinfunc" id="4191451">len</span><span class="op" id="4191454">(</span><span class="ident" id="4191455">b</span><span class="op" id="4191456">)</span><span class="op" id="4191457">-</span><span class="num" id="4191458">1</span><span class="op" id="4191459">]</span><span class="op" id="4191460">)</span>&nbsp;<span class="op" id="4191462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4191466">b</span>&nbsp;<span class="op" id="4191468">=</span>&nbsp;<span class="ident" id="4191470">b</span><span class="op" id="4191471">[</span><span class="op" id="4191472">:</span><span class="builtinfunc" id="4191473">len</span><span class="op" id="4191476">(</span><span class="ident" id="4191477">b</span><span class="op" id="4191478">)</span><span class="op" id="4191479">-</span><span class="num" id="4191480">1</span><span class="op" id="4191481">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4191484">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4191487">return</span>&nbsp;<span class="ident" id="4191494">b</span><br>
<span class="lineno"></span><span class="op" id="4191496">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4191499">func</span>&nbsp;<span class="ident" id="4191504">isASCIISpace</span><span class="op" id="4191516">(</span><span class="ident" id="4191517">b</span>&nbsp;<span class="builtintype" id="4191519">byte</span><span class="op" id="4191523">)</span>&nbsp;<span class="builtintype" id="4191525">bool</span>&nbsp;<span class="op" id="4191530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4191533">return</span>&nbsp;<span class="ident" id="4191540">b</span>&nbsp;<span class="op" id="4191542">==</span>&nbsp;<span class="string" id="4191545">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="4191549">||</span>&nbsp;<span class="ident" id="4191552">b</span>&nbsp;<span class="op" id="4191554">==</span>&nbsp;<span class="string" id="4191557">&#39;\t&#39;</span>&nbsp;<span class="op" id="4191562">||</span>&nbsp;<span class="ident" id="4191565">b</span>&nbsp;<span class="op" id="4191567">==</span>&nbsp;<span class="string" id="4191570">&#39;\n&#39;</span>&nbsp;<span class="op" id="4191575">||</span>&nbsp;<span class="ident" id="4191578">b</span>&nbsp;<span class="op" id="4191580">==</span>&nbsp;<span class="string" id="4191583">&#39;\r&#39;</span><br>
<span class="lineno">135</span><span class="op" id="4191588">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4191591">//&nbsp;NewChunkedWriter&nbsp;returns&nbsp;a&nbsp;new&nbsp;chunkedWriter&nbsp;that&nbsp;translates&nbsp;writes&nbsp;into&nbsp;HTTP</span><br>
<span class="lineno"></span><span class="comment" id="4191672">//&nbsp;&#34;chunked&#34;&nbsp;format&nbsp;before&nbsp;writing&nbsp;them&nbsp;to&nbsp;w.&nbsp;Closing&nbsp;the&nbsp;returned&nbsp;chunkedWriter</span><br>
<span class="lineno"></span><span class="comment" id="4191753">//&nbsp;sends&nbsp;the&nbsp;final&nbsp;0-length&nbsp;chunk&nbsp;that&nbsp;marks&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;stream.</span><br>
<span class="lineno">140</span><span class="comment" id="4191821">//</span><br>
<span class="lineno"></span><span class="comment" id="4191824">//&nbsp;NewChunkedWriter&nbsp;is&nbsp;not&nbsp;needed&nbsp;by&nbsp;normal&nbsp;applications.&nbsp;The&nbsp;http</span><br>
<span class="lineno"></span><span class="comment" id="4191891">//&nbsp;package&nbsp;adds&nbsp;chunking&nbsp;automatically&nbsp;if&nbsp;handlers&nbsp;don&#39;t&nbsp;set&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4191954">//&nbsp;Content-Length&nbsp;header.&nbsp;Using&nbsp;newChunkedWriter&nbsp;inside&nbsp;a&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="4192020">//&nbsp;would&nbsp;result&nbsp;in&nbsp;double&nbsp;chunking&nbsp;or&nbsp;chunking&nbsp;with&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno">145</span><span class="comment" id="4192089">//&nbsp;length,&nbsp;both&nbsp;of&nbsp;which&nbsp;are&nbsp;wrong.</span><br>
<span class="lineno"></span><span class="keyword" id="4192125">func</span>&nbsp;<span class="ident" id="4192130">NewChunkedWriter</span><span class="op" id="4192146">(</span><span class="ident" id="4192147">w</span>&nbsp;<span class="ident" id="4192149">io</span><span class="op" id="4192151">.</span><span class="ident" id="4192152">Writer</span><span class="op" id="4192158">)</span>&nbsp;<span class="ident" id="4192160">io</span><span class="op" id="4192162">.</span><span class="ident" id="4192163">WriteCloser</span>&nbsp;<span class="op" id="4192175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4192178">return</span>&nbsp;<span class="op" id="4192185">&amp;</span><span class="ident" id="4192186">chunkedWriter</span><span class="op" id="4192199">{</span><span class="ident" id="4192200">w</span><span class="op" id="4192201">}</span><br>
<span class="lineno"></span><span class="op" id="4192203">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="4192206">//&nbsp;Writing&nbsp;to&nbsp;chunkedWriter&nbsp;translates&nbsp;to&nbsp;writing&nbsp;in&nbsp;HTTP&nbsp;chunked&nbsp;Transfer</span><br>
<span class="lineno"></span><span class="comment" id="4192281">//&nbsp;Encoding&nbsp;wire&nbsp;format&nbsp;to&nbsp;the&nbsp;underlying&nbsp;Wire&nbsp;chunkedWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="4192343">type</span>&nbsp;<span class="ident" id="4192348">chunkedWriter</span>&nbsp;<span class="keyword" id="4192362">struct</span>&nbsp;<span class="op" id="4192369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192372">Wire</span>&nbsp;<span class="ident" id="4192377">io</span><span class="op" id="4192379">.</span><span class="ident" id="4192380">Writer</span><br>
<span class="lineno"></span><span class="op" id="4192387">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="4192390">//&nbsp;Write&nbsp;the&nbsp;contents&nbsp;of&nbsp;data&nbsp;as&nbsp;one&nbsp;chunk&nbsp;to&nbsp;Wire.</span><br>
<span class="lineno"></span><span class="comment" id="4192442">//&nbsp;NOTE:&nbsp;Note&nbsp;that&nbsp;the&nbsp;corresponding&nbsp;chunk-writing&nbsp;procedure&nbsp;in&nbsp;Conn.Write&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="4192521">//&nbsp;a&nbsp;bug&nbsp;since&nbsp;it&nbsp;does&nbsp;not&nbsp;check&nbsp;for&nbsp;success&nbsp;of&nbsp;io.WriteString</span><br>
<span class="lineno"></span><span class="keyword" id="4192584">func</span>&nbsp;<span class="op" id="4192589">(</span><span class="ident" id="4192590">cw</span>&nbsp;<span class="op" id="4192593">*</span><span class="ident" id="4192594">chunkedWriter</span><span class="op" id="4192607">)</span>&nbsp;<span class="ident" id="4192609">Write</span><span class="op" id="4192614">(</span><span class="ident" id="4192615">data</span>&nbsp;<span class="op" id="4192620">[</span><span class="op" id="4192621">]</span><span class="builtintype" id="4192622">byte</span><span class="op" id="4192626">)</span>&nbsp;<span class="op" id="4192628">(</span><span class="ident" id="4192629">n</span>&nbsp;<span class="builtintype" id="4192631">int</span><span class="op" id="4192634">,</span>&nbsp;<span class="ident" id="4192636">err</span>&nbsp;<span class="builtintype" id="4192640">error</span><span class="op" id="4192645">)</span>&nbsp;<span class="op" id="4192647">{</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4192651">//&nbsp;Don&#39;t&nbsp;send&nbsp;0-length&nbsp;data.&nbsp;It&nbsp;looks&nbsp;like&nbsp;EOF&nbsp;for&nbsp;chunked&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4192721">if</span>&nbsp;<span class="builtinfunc" id="4192724">len</span><span class="op" id="4192727">(</span><span class="ident" id="4192728">data</span><span class="op" id="4192732">)</span>&nbsp;<span class="op" id="4192734">==</span>&nbsp;<span class="num" id="4192737">0</span>&nbsp;<span class="op" id="4192739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4192743">return</span>&nbsp;<span class="num" id="4192750">0</span><span class="op" id="4192751">,</span>&nbsp;<span class="builtintype" id="4192753">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4192758">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4192762">if</span>&nbsp;<span class="ident" id="4192765">_</span><span class="op" id="4192766">,</span>&nbsp;<span class="ident" id="4192768">err</span>&nbsp;<span class="op" id="4192772">=</span>&nbsp;<span class="ident" id="4192774">fmt</span><span class="op" id="4192777">.</span><span class="ident" id="4192778">Fprintf</span><span class="op" id="4192785">(</span><span class="ident" id="4192786">cw</span><span class="op" id="4192788">.</span><span class="ident" id="4192789">Wire</span><span class="op" id="4192793">,</span>&nbsp;<span class="string" id="4192795">&#34;%x\r\n&#34;</span><span class="op" id="4192803">,</span>&nbsp;<span class="builtinfunc" id="4192805">len</span><span class="op" id="4192808">(</span><span class="ident" id="4192809">data</span><span class="op" id="4192813">)</span><span class="op" id="4192814">)</span><span class="op" id="4192815">;</span>&nbsp;<span class="ident" id="4192817">err</span>&nbsp;<span class="op" id="4192821">!=</span>&nbsp;<span class="builtintype" id="4192824">nil</span>&nbsp;<span class="op" id="4192828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4192832">return</span>&nbsp;<span class="num" id="4192839">0</span><span class="op" id="4192840">,</span>&nbsp;<span class="ident" id="4192842">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4192847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4192850">if</span>&nbsp;<span class="ident" id="4192853">n</span><span class="op" id="4192854">,</span>&nbsp;<span class="ident" id="4192856">err</span>&nbsp;<span class="op" id="4192860">=</span>&nbsp;<span class="ident" id="4192862">cw</span><span class="op" id="4192864">.</span><span class="ident" id="4192865">Wire</span><span class="op" id="4192869">.</span><span class="ident" id="4192870">Write</span><span class="op" id="4192875">(</span><span class="ident" id="4192876">data</span><span class="op" id="4192880">)</span><span class="op" id="4192881">;</span>&nbsp;<span class="ident" id="4192883">err</span>&nbsp;<span class="op" id="4192887">!=</span>&nbsp;<span class="builtintype" id="4192890">nil</span>&nbsp;<span class="op" id="4192894">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4192898">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4192906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4192909">if</span>&nbsp;<span class="ident" id="4192912">n</span>&nbsp;<span class="op" id="4192914">!=</span>&nbsp;<span class="builtinfunc" id="4192917">len</span><span class="op" id="4192920">(</span><span class="ident" id="4192921">data</span><span class="op" id="4192925">)</span>&nbsp;<span class="op" id="4192927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192931">err</span>&nbsp;<span class="op" id="4192935">=</span>&nbsp;<span class="ident" id="4192937">io</span><span class="op" id="4192939">.</span><span class="ident" id="4192940">ErrShortWrite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4192956">return</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4192964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192967">_</span><span class="op" id="4192968">,</span>&nbsp;<span class="ident" id="4192970">err</span>&nbsp;<span class="op" id="4192974">=</span>&nbsp;<span class="ident" id="4192976">io</span><span class="op" id="4192978">.</span><span class="ident" id="4192979">WriteString</span><span class="op" id="4192990">(</span><span class="ident" id="4192991">cw</span><span class="op" id="4192993">.</span><span class="ident" id="4192994">Wire</span><span class="op" id="4192998">,</span>&nbsp;<span class="string" id="4193000">&#34;\r\n&#34;</span><span class="op" id="4193006">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4193010">return</span><br>
<span class="lineno"></span><span class="op" id="4193017">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="keyword" id="4193020">func</span>&nbsp;<span class="op" id="4193025">(</span><span class="ident" id="4193026">cw</span>&nbsp;<span class="op" id="4193029">*</span><span class="ident" id="4193030">chunkedWriter</span><span class="op" id="4193043">)</span>&nbsp;<span class="ident" id="4193045">Close</span><span class="op" id="4193050">(</span><span class="op" id="4193051">)</span>&nbsp;<span class="builtintype" id="4193053">error</span>&nbsp;<span class="op" id="4193059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4193062">_</span><span class="op" id="4193063">,</span>&nbsp;<span class="ident" id="4193065">err</span>&nbsp;<span class="op" id="4193069">:=</span>&nbsp;<span class="ident" id="4193072">io</span><span class="op" id="4193074">.</span><span class="ident" id="4193075">WriteString</span><span class="op" id="4193086">(</span><span class="ident" id="4193087">cw</span><span class="op" id="4193089">.</span><span class="ident" id="4193090">Wire</span><span class="op" id="4193094">,</span>&nbsp;<span class="string" id="4193096">&#34;0\r\n&#34;</span><span class="op" id="4193103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4193106">return</span>&nbsp;<span class="ident" id="4193113">err</span><br>
<span class="lineno"></span><span class="op" id="4193117">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="keyword" id="4193120">func</span>&nbsp;<span class="ident" id="4193125">parseHexUint</span><span class="op" id="4193137">(</span><span class="ident" id="4193138">v</span>&nbsp;<span class="op" id="4193140">[</span><span class="op" id="4193141">]</span><span class="builtintype" id="4193142">byte</span><span class="op" id="4193146">)</span>&nbsp;<span class="op" id="4193148">(</span><span class="ident" id="4193149">n</span>&nbsp;<span class="ident" id="4193151">uint64</span><span class="op" id="4193157">,</span>&nbsp;<span class="ident" id="4193159">err</span>&nbsp;<span class="builtintype" id="4193163">error</span><span class="op" id="4193168">)</span>&nbsp;<span class="op" id="4193170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4193173">for</span>&nbsp;<span class="ident" id="4193177">_</span><span class="op" id="4193178">,</span>&nbsp;<span class="ident" id="4193180">b</span>&nbsp;<span class="op" id="4193182">:=</span>&nbsp;<span class="keyword" id="4193185">range</span>&nbsp;<span class="ident" id="4193191">v</span>&nbsp;<span class="op" id="4193193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4193197">n</span>&nbsp;<span class="op" id="4193199">&lt;&lt;=</span>&nbsp;<span class="num" id="4193203">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4193207">switch</span>&nbsp;<span class="op" id="4193214">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4193218">case</span>&nbsp;<span class="string" id="4193223">&#39;0&#39;</span>&nbsp;<span class="op" id="4193227">&lt;=</span>&nbsp;<span class="ident" id="4193230">b</span>&nbsp;<span class="op" id="4193232">&amp;&amp;</span>&nbsp;<span class="ident" id="4193235">b</span>&nbsp;<span class="op" id="4193237">&lt;=</span>&nbsp;<span class="string" id="4193240">&#39;9&#39;</span><span class="op" id="4193243">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4193248">b</span>&nbsp;<span class="op" id="4193250">=</span>&nbsp;<span class="ident" id="4193252">b</span>&nbsp;<span class="op" id="4193254">-</span>&nbsp;<span class="string" id="4193256">&#39;0&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4193262">case</span>&nbsp;<span class="string" id="4193267">&#39;a&#39;</span>&nbsp;<span class="op" id="4193271">&lt;=</span>&nbsp;<span class="ident" id="4193274">b</span>&nbsp;<span class="op" id="4193276">&amp;&amp;</span>&nbsp;<span class="ident" id="4193279">b</span>&nbsp;<span class="op" id="4193281">&lt;=</span>&nbsp;<span class="string" id="4193284">&#39;f&#39;</span><span class="op" id="4193287">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4193292">b</span>&nbsp;<span class="op" id="4193294">=</span>&nbsp;<span class="ident" id="4193296">b</span>&nbsp;<span class="op" id="4193298">-</span>&nbsp;<span class="string" id="4193300">&#39;a&#39;</span>&nbsp;<span class="op" id="4193304">+</span>&nbsp;<span class="num" id="4193306">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4193311">case</span>&nbsp;<span class="string" id="4193316">&#39;A&#39;</span>&nbsp;<span class="op" id="4193320">&lt;=</span>&nbsp;<span class="ident" id="4193323">b</span>&nbsp;<span class="op" id="4193325">&amp;&amp;</span>&nbsp;<span class="ident" id="4193328">b</span>&nbsp;<span class="op" id="4193330">&lt;=</span>&nbsp;<span class="string" id="4193333">&#39;F&#39;</span><span class="op" id="4193336">:</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4193341">b</span>&nbsp;<span class="op" id="4193343">=</span>&nbsp;<span class="ident" id="4193345">b</span>&nbsp;<span class="op" id="4193347">-</span>&nbsp;<span class="string" id="4193349">&#39;A&#39;</span>&nbsp;<span class="op" id="4193353">+</span>&nbsp;<span class="num" id="4193355">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4193360">default</span><span class="op" id="4193367">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4193372">return</span>&nbsp;<span class="num" id="4193379">0</span><span class="op" id="4193380">,</span>&nbsp;<span class="ident" id="4193382">errors</span><span class="op" id="4193388">.</span><span class="ident" id="4193389">New</span><span class="op" id="4193392">(</span><span class="string" id="4193393">&#34;invalid&nbsp;byte&nbsp;in&nbsp;chunk&nbsp;length&#34;</span><span class="op" id="4193423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4193427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4193431">n</span>&nbsp;<span class="op" id="4193433">|=</span>&nbsp;<span class="ident" id="4193436">uint64</span><span class="op" id="4193442">(</span><span class="ident" id="4193443">b</span><span class="op" id="4193444">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4193447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4193450">return</span><br>
<span class="lineno"></span><span class="op" id="4193457">}</span>
</div>
</body>
</html>
