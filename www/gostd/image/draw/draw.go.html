<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/draw</h2>
<ul>
<li><a href="/gostd/image/draw/bench_test.go.html">bench_test.go</a></li>
<li><a href="/gostd/image/draw/clip_test.go.html">clip_test.go</a></li>
<li><a href="/gostd/image/draw/draw.go.html" class="current">draw.go</a></li>
<li><a href="/gostd/image/draw/draw_test.go.html">draw_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5171021">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5171077">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5171131">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5171182">//&nbsp;Package&nbsp;draw&nbsp;provides&nbsp;image&nbsp;composition&nbsp;functions.</span><br>
<span class="lineno"></span><span class="comment" id="5171236">//</span><br>
<span class="lineno"></span><span class="comment" id="5171239">//&nbsp;See&nbsp;&#34;The&nbsp;Go&nbsp;image/draw&nbsp;package&#34;&nbsp;for&nbsp;an&nbsp;introduction&nbsp;to&nbsp;this&nbsp;package:</span><br>
<span class="lineno"></span><span class="comment" id="5171311">//&nbsp;http://golang.org/doc/articles/image_draw.html</span><br>
<span class="lineno"></span><span class="keyword" id="5171361">package</span>&nbsp;<span class="ident" id="5171369">draw</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="5171375">import</span>&nbsp;<span class="op" id="5171382">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5171385">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5171394">&#34;image/color&#34;</span><br>
<span class="lineno"></span><span class="op" id="5171408">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="5171411">//&nbsp;m&nbsp;is&nbsp;the&nbsp;maximum&nbsp;color&nbsp;value&nbsp;returned&nbsp;by&nbsp;image.Color.RGBA.</span><br>
<span class="lineno"></span><span class="keyword" id="5171473">const</span>&nbsp;<span class="ident" id="5171479">m</span>&nbsp;<span class="op" id="5171481">=</span>&nbsp;<span class="num" id="5171483">1</span><span class="op" id="5171484">&lt;&lt;</span><span class="num" id="5171486">16</span>&nbsp;<span class="op" id="5171489">-</span>&nbsp;<span class="num" id="5171491">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5171494">//&nbsp;Image&nbsp;is&nbsp;an&nbsp;image.Image&nbsp;with&nbsp;a&nbsp;Set&nbsp;method&nbsp;to&nbsp;change&nbsp;a&nbsp;single&nbsp;pixel.</span><br>
<span class="lineno">20</span><span class="keyword" id="5171565">type</span>&nbsp;<span class="ident" id="5171570">Image</span>&nbsp;<span class="keyword" id="5171576">interface</span>&nbsp;<span class="op" id="5171586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5171589">image</span><span class="op" id="5171594">.</span><span class="ident" id="5171595">Image</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5171602">Set</span><span class="op" id="5171605">(</span><span class="ident" id="5171606">x</span><span class="op" id="5171607">,</span>&nbsp;<span class="ident" id="5171609">y</span>&nbsp;<span class="builtintype" id="5171611">int</span><span class="op" id="5171614">,</span>&nbsp;<span class="ident" id="5171616">c</span>&nbsp;<span class="ident" id="5171618">color</span><span class="op" id="5171623">.</span><span class="ident" id="5171624">Color</span><span class="op" id="5171629">)</span><br>
<span class="lineno"></span><span class="op" id="5171631">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="5171634">//&nbsp;Quantizer&nbsp;produces&nbsp;a&nbsp;palette&nbsp;for&nbsp;an&nbsp;image.</span><br>
<span class="lineno"></span><span class="keyword" id="5171680">type</span>&nbsp;<span class="ident" id="5171685">Quantizer</span>&nbsp;<span class="keyword" id="5171695">interface</span>&nbsp;<span class="op" id="5171705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5171708">//&nbsp;Quantize&nbsp;appends&nbsp;up&nbsp;to&nbsp;cap(p)&nbsp;-&nbsp;len(p)&nbsp;colors&nbsp;to&nbsp;p&nbsp;and&nbsp;returns&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5171779">//&nbsp;updated&nbsp;palette&nbsp;suitable&nbsp;for&nbsp;converting&nbsp;m&nbsp;to&nbsp;a&nbsp;paletted&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5171846">Quantize</span><span class="op" id="5171854">(</span><span class="ident" id="5171855">p</span>&nbsp;<span class="ident" id="5171857">color</span><span class="op" id="5171862">.</span><span class="ident" id="5171863">Palette</span><span class="op" id="5171870">,</span>&nbsp;<span class="ident" id="5171872">m</span>&nbsp;<span class="ident" id="5171874">image</span><span class="op" id="5171879">.</span><span class="ident" id="5171880">Image</span><span class="op" id="5171885">)</span>&nbsp;<span class="ident" id="5171887">color</span><span class="op" id="5171892">.</span><span class="ident" id="5171893">Palette</span><br>
<span class="lineno">30</span><span class="op" id="5171901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5171904">//&nbsp;Op&nbsp;is&nbsp;a&nbsp;Porter-Duff&nbsp;compositing&nbsp;operator.</span><br>
<span class="lineno"></span><span class="keyword" id="5171949">type</span>&nbsp;<span class="ident" id="5171954">Op</span>&nbsp;<span class="builtintype" id="5171957">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="5171962">const</span>&nbsp;<span class="op" id="5171968">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5171971">//&nbsp;Over&nbsp;specifies&nbsp;``(src&nbsp;in&nbsp;mask)&nbsp;over&nbsp;dst&#39;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5172018">Over</span>&nbsp;<span class="ident" id="5172023">Op</span>&nbsp;<span class="op" id="5172026">=</span>&nbsp;<span class="ident" id="5172028">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5172034">//&nbsp;Src&nbsp;specifies&nbsp;``src&nbsp;in&nbsp;mask&#39;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5172069">Src</span><br>
<span class="lineno">40</span><span class="op" id="5172073">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5172076">//&nbsp;Draw&nbsp;implements&nbsp;the&nbsp;Drawer&nbsp;interface&nbsp;by&nbsp;calling&nbsp;the&nbsp;Draw&nbsp;function&nbsp;with&nbsp;this</span><br>
<span class="lineno"></span><span class="comment" id="5172155">//&nbsp;Op.</span><br>
<span class="lineno"></span><span class="keyword" id="5172162">func</span>&nbsp;<span class="op" id="5172167">(</span><span class="ident" id="5172168">op</span>&nbsp;<span class="ident" id="5172171">Op</span><span class="op" id="5172173">)</span>&nbsp;<span class="ident" id="5172175">Draw</span><span class="op" id="5172179">(</span><span class="ident" id="5172180">dst</span>&nbsp;<span class="ident" id="5172184">Image</span><span class="op" id="5172189">,</span>&nbsp;<span class="ident" id="5172191">r</span>&nbsp;<span class="ident" id="5172193">image</span><span class="op" id="5172198">.</span><span class="ident" id="5172199">Rectangle</span><span class="op" id="5172208">,</span>&nbsp;<span class="ident" id="5172210">src</span>&nbsp;<span class="ident" id="5172214">image</span><span class="op" id="5172219">.</span><span class="ident" id="5172220">Image</span><span class="op" id="5172225">,</span>&nbsp;<span class="ident" id="5172227">sp</span>&nbsp;<span class="ident" id="5172230">image</span><span class="op" id="5172235">.</span><span class="ident" id="5172236">Point</span><span class="op" id="5172241">)</span>&nbsp;<span class="op" id="5172243">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5172246">DrawMask</span><span class="op" id="5172254">(</span><span class="ident" id="5172255">dst</span><span class="op" id="5172258">,</span>&nbsp;<span class="ident" id="5172260">r</span><span class="op" id="5172261">,</span>&nbsp;<span class="ident" id="5172263">src</span><span class="op" id="5172266">,</span>&nbsp;<span class="ident" id="5172268">sp</span><span class="op" id="5172270">,</span>&nbsp;<span class="builtintype" id="5172272">nil</span><span class="op" id="5172275">,</span>&nbsp;<span class="ident" id="5172277">image</span><span class="op" id="5172282">.</span><span class="ident" id="5172283">Point</span><span class="op" id="5172288">{</span><span class="op" id="5172289">}</span><span class="op" id="5172290">,</span>&nbsp;<span class="ident" id="5172292">op</span><span class="op" id="5172294">)</span><br>
<span class="lineno"></span><span class="op" id="5172296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5172299">//&nbsp;Drawer&nbsp;contains&nbsp;the&nbsp;Draw&nbsp;method.</span><br>
<span class="lineno"></span><span class="keyword" id="5172335">type</span>&nbsp;<span class="ident" id="5172340">Drawer</span>&nbsp;<span class="keyword" id="5172347">interface</span>&nbsp;<span class="op" id="5172357">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5172360">//&nbsp;Draw&nbsp;aligns&nbsp;r.Min&nbsp;in&nbsp;dst&nbsp;with&nbsp;sp&nbsp;in&nbsp;src&nbsp;and&nbsp;then&nbsp;replaces&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5172426">//&nbsp;rectangle&nbsp;r&nbsp;in&nbsp;dst&nbsp;with&nbsp;the&nbsp;result&nbsp;of&nbsp;drawing&nbsp;src&nbsp;on&nbsp;dst.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5172488">Draw</span><span class="op" id="5172492">(</span><span class="ident" id="5172493">dst</span>&nbsp;<span class="ident" id="5172497">Image</span><span class="op" id="5172502">,</span>&nbsp;<span class="ident" id="5172504">r</span>&nbsp;<span class="ident" id="5172506">image</span><span class="op" id="5172511">.</span><span class="ident" id="5172512">Rectangle</span><span class="op" id="5172521">,</span>&nbsp;<span class="ident" id="5172523">src</span>&nbsp;<span class="ident" id="5172527">image</span><span class="op" id="5172532">.</span><span class="ident" id="5172533">Image</span><span class="op" id="5172538">,</span>&nbsp;<span class="ident" id="5172540">sp</span>&nbsp;<span class="ident" id="5172543">image</span><span class="op" id="5172548">.</span><span class="ident" id="5172549">Point</span><span class="op" id="5172554">)</span><br>
<span class="lineno"></span><span class="op" id="5172556">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="5172559">//&nbsp;FloydSteinberg&nbsp;is&nbsp;a&nbsp;Drawer&nbsp;that&nbsp;is&nbsp;the&nbsp;Src&nbsp;Op&nbsp;with&nbsp;Floyd-Steinberg&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="5172635">//&nbsp;diffusion.</span><br>
<span class="lineno"></span><span class="keyword" id="5172649">var</span>&nbsp;<span class="ident" id="5172653">FloydSteinberg</span>&nbsp;<span class="ident" id="5172668">Drawer</span>&nbsp;<span class="op" id="5172675">=</span>&nbsp;<span class="ident" id="5172677">floydSteinberg</span><span class="op" id="5172691">{</span><span class="op" id="5172692">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5172695">type</span>&nbsp;<span class="ident" id="5172700">floydSteinberg</span>&nbsp;<span class="keyword" id="5172715">struct</span><span class="op" id="5172721">{</span><span class="op" id="5172722">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="5172725">func</span>&nbsp;<span class="op" id="5172730">(</span><span class="ident" id="5172731">floydSteinberg</span><span class="op" id="5172745">)</span>&nbsp;<span class="ident" id="5172747">Draw</span><span class="op" id="5172751">(</span><span class="ident" id="5172752">dst</span>&nbsp;<span class="ident" id="5172756">Image</span><span class="op" id="5172761">,</span>&nbsp;<span class="ident" id="5172763">r</span>&nbsp;<span class="ident" id="5172765">image</span><span class="op" id="5172770">.</span><span class="ident" id="5172771">Rectangle</span><span class="op" id="5172780">,</span>&nbsp;<span class="ident" id="5172782">src</span>&nbsp;<span class="ident" id="5172786">image</span><span class="op" id="5172791">.</span><span class="ident" id="5172792">Image</span><span class="op" id="5172797">,</span>&nbsp;<span class="ident" id="5172799">sp</span>&nbsp;<span class="ident" id="5172802">image</span><span class="op" id="5172807">.</span><span class="ident" id="5172808">Point</span><span class="op" id="5172813">)</span>&nbsp;<span class="op" id="5172815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5172818">clip</span><span class="op" id="5172822">(</span><span class="ident" id="5172823">dst</span><span class="op" id="5172826">,</span>&nbsp;<span class="op" id="5172828">&amp;</span><span class="ident" id="5172829">r</span><span class="op" id="5172830">,</span>&nbsp;<span class="ident" id="5172832">src</span><span class="op" id="5172835">,</span>&nbsp;<span class="op" id="5172837">&amp;</span><span class="ident" id="5172838">sp</span><span class="op" id="5172840">,</span>&nbsp;<span class="builtintype" id="5172842">nil</span><span class="op" id="5172845">,</span>&nbsp;<span class="builtintype" id="5172847">nil</span><span class="op" id="5172850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5172853">if</span>&nbsp;<span class="ident" id="5172856">r</span><span class="op" id="5172857">.</span><span class="ident" id="5172858">Empty</span><span class="op" id="5172863">(</span><span class="op" id="5172864">)</span>&nbsp;<span class="op" id="5172866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5172870">return</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5172878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5172881">drawPaletted</span><span class="op" id="5172893">(</span><span class="ident" id="5172894">dst</span><span class="op" id="5172897">,</span>&nbsp;<span class="ident" id="5172899">r</span><span class="op" id="5172900">,</span>&nbsp;<span class="ident" id="5172902">src</span><span class="op" id="5172905">,</span>&nbsp;<span class="ident" id="5172907">sp</span><span class="op" id="5172909">,</span>&nbsp;<span class="builtintype" id="5172911">true</span><span class="op" id="5172915">)</span><br>
<span class="lineno"></span><span class="op" id="5172917">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5172920">//&nbsp;clip&nbsp;clips&nbsp;r&nbsp;against&nbsp;each&nbsp;image&#39;s&nbsp;bounds&nbsp;(after&nbsp;translating&nbsp;into&nbsp;the</span><br>
<span class="lineno">70</span><span class="comment" id="5172992">//&nbsp;destination&nbsp;image&#39;s&nbsp;co-ordinate&nbsp;space)&nbsp;and&nbsp;shifts&nbsp;the&nbsp;points&nbsp;sp&nbsp;and&nbsp;mp&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="5173069">//&nbsp;the&nbsp;same&nbsp;amount&nbsp;as&nbsp;the&nbsp;change&nbsp;in&nbsp;r.Min.</span><br>
<span class="lineno"></span><span class="keyword" id="5173112">func</span>&nbsp;<span class="ident" id="5173117">clip</span><span class="op" id="5173121">(</span><span class="ident" id="5173122">dst</span>&nbsp;<span class="ident" id="5173126">Image</span><span class="op" id="5173131">,</span>&nbsp;<span class="ident" id="5173133">r</span>&nbsp;<span class="op" id="5173135">*</span><span class="ident" id="5173136">image</span><span class="op" id="5173141">.</span><span class="ident" id="5173142">Rectangle</span><span class="op" id="5173151">,</span>&nbsp;<span class="ident" id="5173153">src</span>&nbsp;<span class="ident" id="5173157">image</span><span class="op" id="5173162">.</span><span class="ident" id="5173163">Image</span><span class="op" id="5173168">,</span>&nbsp;<span class="ident" id="5173170">sp</span>&nbsp;<span class="op" id="5173173">*</span><span class="ident" id="5173174">image</span><span class="op" id="5173179">.</span><span class="ident" id="5173180">Point</span><span class="op" id="5173185">,</span>&nbsp;<span class="ident" id="5173187">mask</span>&nbsp;<span class="ident" id="5173192">image</span><span class="op" id="5173197">.</span><span class="ident" id="5173198">Image</span><span class="op" id="5173203">,</span>&nbsp;<span class="ident" id="5173205">mp</span>&nbsp;<span class="op" id="5173208">*</span><span class="ident" id="5173209">image</span><span class="op" id="5173214">.</span><span class="ident" id="5173215">Point</span><span class="op" id="5173220">)</span>&nbsp;<span class="op" id="5173222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5173225">orig</span>&nbsp;<span class="op" id="5173230">:=</span>&nbsp;<span class="ident" id="5173233">r</span><span class="op" id="5173234">.</span><span class="ident" id="5173235">Min</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5173240">*</span><span class="ident" id="5173241">r</span>&nbsp;<span class="op" id="5173243">=</span>&nbsp;<span class="ident" id="5173245">r</span><span class="op" id="5173246">.</span><span class="ident" id="5173247">Intersect</span><span class="op" id="5173256">(</span><span class="ident" id="5173257">dst</span><span class="op" id="5173260">.</span><span class="ident" id="5173261">Bounds</span><span class="op" id="5173267">(</span><span class="op" id="5173268">)</span><span class="op" id="5173269">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5173272">*</span><span class="ident" id="5173273">r</span>&nbsp;<span class="op" id="5173275">=</span>&nbsp;<span class="ident" id="5173277">r</span><span class="op" id="5173278">.</span><span class="ident" id="5173279">Intersect</span><span class="op" id="5173288">(</span><span class="ident" id="5173289">src</span><span class="op" id="5173292">.</span><span class="ident" id="5173293">Bounds</span><span class="op" id="5173299">(</span><span class="op" id="5173300">)</span><span class="op" id="5173301">.</span><span class="ident" id="5173302">Add</span><span class="op" id="5173305">(</span><span class="ident" id="5173306">orig</span><span class="op" id="5173310">.</span><span class="ident" id="5173311">Sub</span><span class="op" id="5173314">(</span><span class="op" id="5173315">*</span><span class="ident" id="5173316">sp</span><span class="op" id="5173318">)</span><span class="op" id="5173319">)</span><span class="op" id="5173320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5173323">if</span>&nbsp;<span class="ident" id="5173326">mask</span>&nbsp;<span class="op" id="5173331">!=</span>&nbsp;<span class="builtintype" id="5173334">nil</span>&nbsp;<span class="op" id="5173338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5173342">*</span><span class="ident" id="5173343">r</span>&nbsp;<span class="op" id="5173345">=</span>&nbsp;<span class="ident" id="5173347">r</span><span class="op" id="5173348">.</span><span class="ident" id="5173349">Intersect</span><span class="op" id="5173358">(</span><span class="ident" id="5173359">mask</span><span class="op" id="5173363">.</span><span class="ident" id="5173364">Bounds</span><span class="op" id="5173370">(</span><span class="op" id="5173371">)</span><span class="op" id="5173372">.</span><span class="ident" id="5173373">Add</span><span class="op" id="5173376">(</span><span class="ident" id="5173377">orig</span><span class="op" id="5173381">.</span><span class="ident" id="5173382">Sub</span><span class="op" id="5173385">(</span><span class="op" id="5173386">*</span><span class="ident" id="5173387">mp</span><span class="op" id="5173389">)</span><span class="op" id="5173390">)</span><span class="op" id="5173391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5173394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5173397">dx</span>&nbsp;<span class="op" id="5173400">:=</span>&nbsp;<span class="ident" id="5173403">r</span><span class="op" id="5173404">.</span><span class="ident" id="5173405">Min</span><span class="op" id="5173408">.</span><span class="ident" id="5173409">X</span>&nbsp;<span class="op" id="5173411">-</span>&nbsp;<span class="ident" id="5173413">orig</span><span class="op" id="5173417">.</span><span class="ident" id="5173418">X</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5173421">dy</span>&nbsp;<span class="op" id="5173424">:=</span>&nbsp;<span class="ident" id="5173427">r</span><span class="op" id="5173428">.</span><span class="ident" id="5173429">Min</span><span class="op" id="5173432">.</span><span class="ident" id="5173433">Y</span>&nbsp;<span class="op" id="5173435">-</span>&nbsp;<span class="ident" id="5173437">orig</span><span class="op" id="5173441">.</span><span class="ident" id="5173442">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5173445">if</span>&nbsp;<span class="ident" id="5173448">dx</span>&nbsp;<span class="op" id="5173451">==</span>&nbsp;<span class="num" id="5173454">0</span>&nbsp;<span class="op" id="5173456">&amp;&amp;</span>&nbsp;<span class="ident" id="5173459">dy</span>&nbsp;<span class="op" id="5173462">==</span>&nbsp;<span class="num" id="5173465">0</span>&nbsp;<span class="op" id="5173467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5173471">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5173479">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5173482">(</span><span class="op" id="5173483">*</span><span class="ident" id="5173484">sp</span><span class="op" id="5173486">)</span><span class="op" id="5173487">.</span><span class="ident" id="5173488">X</span>&nbsp;<span class="op" id="5173490">+=</span>&nbsp;<span class="ident" id="5173493">dx</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5173497">(</span><span class="op" id="5173498">*</span><span class="ident" id="5173499">sp</span><span class="op" id="5173501">)</span><span class="op" id="5173502">.</span><span class="ident" id="5173503">Y</span>&nbsp;<span class="op" id="5173505">+=</span>&nbsp;<span class="ident" id="5173508">dy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5173512">(</span><span class="op" id="5173513">*</span><span class="ident" id="5173514">mp</span><span class="op" id="5173516">)</span><span class="op" id="5173517">.</span><span class="ident" id="5173518">X</span>&nbsp;<span class="op" id="5173520">+=</span>&nbsp;<span class="ident" id="5173523">dx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5173527">(</span><span class="op" id="5173528">*</span><span class="ident" id="5173529">mp</span><span class="op" id="5173531">)</span><span class="op" id="5173532">.</span><span class="ident" id="5173533">Y</span>&nbsp;<span class="op" id="5173535">+=</span>&nbsp;<span class="ident" id="5173538">dy</span><br>
<span class="lineno"></span><span class="op" id="5173541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="5173544">func</span>&nbsp;<span class="ident" id="5173549">processBackward</span><span class="op" id="5173564">(</span><span class="ident" id="5173565">dst</span>&nbsp;<span class="ident" id="5173569">Image</span><span class="op" id="5173574">,</span>&nbsp;<span class="ident" id="5173576">r</span>&nbsp;<span class="ident" id="5173578">image</span><span class="op" id="5173583">.</span><span class="ident" id="5173584">Rectangle</span><span class="op" id="5173593">,</span>&nbsp;<span class="ident" id="5173595">src</span>&nbsp;<span class="ident" id="5173599">image</span><span class="op" id="5173604">.</span><span class="ident" id="5173605">Image</span><span class="op" id="5173610">,</span>&nbsp;<span class="ident" id="5173612">sp</span>&nbsp;<span class="ident" id="5173615">image</span><span class="op" id="5173620">.</span><span class="ident" id="5173621">Point</span><span class="op" id="5173626">)</span>&nbsp;<span class="builtintype" id="5173628">bool</span>&nbsp;<span class="op" id="5173633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5173636">return</span>&nbsp;<span class="ident" id="5173643">image</span><span class="op" id="5173648">.</span><span class="ident" id="5173649">Image</span><span class="op" id="5173654">(</span><span class="ident" id="5173655">dst</span><span class="op" id="5173658">)</span>&nbsp;<span class="op" id="5173660">==</span>&nbsp;<span class="ident" id="5173663">src</span>&nbsp;<span class="op" id="5173667">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5173672">r</span><span class="op" id="5173673">.</span><span class="ident" id="5173674">Overlaps</span><span class="op" id="5173682">(</span><span class="ident" id="5173683">r</span><span class="op" id="5173684">.</span><span class="ident" id="5173685">Add</span><span class="op" id="5173688">(</span><span class="ident" id="5173689">sp</span><span class="op" id="5173691">.</span><span class="ident" id="5173692">Sub</span><span class="op" id="5173695">(</span><span class="ident" id="5173696">r</span><span class="op" id="5173697">.</span><span class="ident" id="5173698">Min</span><span class="op" id="5173701">)</span><span class="op" id="5173702">)</span><span class="op" id="5173703">)</span>&nbsp;<span class="op" id="5173705">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5173710">(</span><span class="ident" id="5173711">sp</span><span class="op" id="5173713">.</span><span class="ident" id="5173714">Y</span>&nbsp;<span class="op" id="5173716">&lt;</span>&nbsp;<span class="ident" id="5173718">r</span><span class="op" id="5173719">.</span><span class="ident" id="5173720">Min</span><span class="op" id="5173723">.</span><span class="ident" id="5173724">Y</span>&nbsp;<span class="op" id="5173726">||</span>&nbsp;<span class="op" id="5173729">(</span><span class="ident" id="5173730">sp</span><span class="op" id="5173732">.</span><span class="ident" id="5173733">Y</span>&nbsp;<span class="op" id="5173735">==</span>&nbsp;<span class="ident" id="5173738">r</span><span class="op" id="5173739">.</span><span class="ident" id="5173740">Min</span><span class="op" id="5173743">.</span><span class="ident" id="5173744">Y</span>&nbsp;<span class="op" id="5173746">&amp;&amp;</span>&nbsp;<span class="ident" id="5173749">sp</span><span class="op" id="5173751">.</span><span class="ident" id="5173752">X</span>&nbsp;<span class="op" id="5173754">&lt;</span>&nbsp;<span class="ident" id="5173756">r</span><span class="op" id="5173757">.</span><span class="ident" id="5173758">Min</span><span class="op" id="5173761">.</span><span class="ident" id="5173762">X</span><span class="op" id="5173763">)</span><span class="op" id="5173764">)</span><br>
<span class="lineno"></span><span class="op" id="5173766">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="5173769">//&nbsp;Draw&nbsp;calls&nbsp;DrawMask&nbsp;with&nbsp;a&nbsp;nil&nbsp;mask.</span><br>
<span class="lineno"></span><span class="keyword" id="5173809">func</span>&nbsp;<span class="ident" id="5173814">Draw</span><span class="op" id="5173818">(</span><span class="ident" id="5173819">dst</span>&nbsp;<span class="ident" id="5173823">Image</span><span class="op" id="5173828">,</span>&nbsp;<span class="ident" id="5173830">r</span>&nbsp;<span class="ident" id="5173832">image</span><span class="op" id="5173837">.</span><span class="ident" id="5173838">Rectangle</span><span class="op" id="5173847">,</span>&nbsp;<span class="ident" id="5173849">src</span>&nbsp;<span class="ident" id="5173853">image</span><span class="op" id="5173858">.</span><span class="ident" id="5173859">Image</span><span class="op" id="5173864">,</span>&nbsp;<span class="ident" id="5173866">sp</span>&nbsp;<span class="ident" id="5173869">image</span><span class="op" id="5173874">.</span><span class="ident" id="5173875">Point</span><span class="op" id="5173880">,</span>&nbsp;<span class="ident" id="5173882">op</span>&nbsp;<span class="ident" id="5173885">Op</span><span class="op" id="5173887">)</span>&nbsp;<span class="op" id="5173889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5173892">DrawMask</span><span class="op" id="5173900">(</span><span class="ident" id="5173901">dst</span><span class="op" id="5173904">,</span>&nbsp;<span class="ident" id="5173906">r</span><span class="op" id="5173907">,</span>&nbsp;<span class="ident" id="5173909">src</span><span class="op" id="5173912">,</span>&nbsp;<span class="ident" id="5173914">sp</span><span class="op" id="5173916">,</span>&nbsp;<span class="builtintype" id="5173918">nil</span><span class="op" id="5173921">,</span>&nbsp;<span class="ident" id="5173923">image</span><span class="op" id="5173928">.</span><span class="ident" id="5173929">Point</span><span class="op" id="5173934">{</span><span class="op" id="5173935">}</span><span class="op" id="5173936">,</span>&nbsp;<span class="ident" id="5173938">op</span><span class="op" id="5173940">)</span><br>
<span class="lineno"></span><span class="op" id="5173942">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="5173945">//&nbsp;DrawMask&nbsp;aligns&nbsp;r.Min&nbsp;in&nbsp;dst&nbsp;with&nbsp;sp&nbsp;in&nbsp;src&nbsp;and&nbsp;mp&nbsp;in&nbsp;mask&nbsp;and&nbsp;then&nbsp;replaces&nbsp;the&nbsp;rectangle&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="5174041">//&nbsp;in&nbsp;dst&nbsp;with&nbsp;the&nbsp;result&nbsp;of&nbsp;a&nbsp;Porter-Duff&nbsp;composition.&nbsp;A&nbsp;nil&nbsp;mask&nbsp;is&nbsp;treated&nbsp;as&nbsp;opaque.</span><br>
<span class="lineno"></span><span class="keyword" id="5174130">func</span>&nbsp;<span class="ident" id="5174135">DrawMask</span><span class="op" id="5174143">(</span><span class="ident" id="5174144">dst</span>&nbsp;<span class="ident" id="5174148">Image</span><span class="op" id="5174153">,</span>&nbsp;<span class="ident" id="5174155">r</span>&nbsp;<span class="ident" id="5174157">image</span><span class="op" id="5174162">.</span><span class="ident" id="5174163">Rectangle</span><span class="op" id="5174172">,</span>&nbsp;<span class="ident" id="5174174">src</span>&nbsp;<span class="ident" id="5174178">image</span><span class="op" id="5174183">.</span><span class="ident" id="5174184">Image</span><span class="op" id="5174189">,</span>&nbsp;<span class="ident" id="5174191">sp</span>&nbsp;<span class="ident" id="5174194">image</span><span class="op" id="5174199">.</span><span class="ident" id="5174200">Point</span><span class="op" id="5174205">,</span>&nbsp;<span class="ident" id="5174207">mask</span>&nbsp;<span class="ident" id="5174212">image</span><span class="op" id="5174217">.</span><span class="ident" id="5174218">Image</span><span class="op" id="5174223">,</span>&nbsp;<span class="ident" id="5174225">mp</span>&nbsp;<span class="ident" id="5174228">image</span><span class="op" id="5174233">.</span><span class="ident" id="5174234">Point</span><span class="op" id="5174239">,</span>&nbsp;<span class="ident" id="5174241">op</span>&nbsp;<span class="ident" id="5174244">Op</span><span class="op" id="5174246">)</span>&nbsp;<span class="op" id="5174248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5174251">clip</span><span class="op" id="5174255">(</span><span class="ident" id="5174256">dst</span><span class="op" id="5174259">,</span>&nbsp;<span class="op" id="5174261">&amp;</span><span class="ident" id="5174262">r</span><span class="op" id="5174263">,</span>&nbsp;<span class="ident" id="5174265">src</span><span class="op" id="5174268">,</span>&nbsp;<span class="op" id="5174270">&amp;</span><span class="ident" id="5174271">sp</span><span class="op" id="5174273">,</span>&nbsp;<span class="ident" id="5174275">mask</span><span class="op" id="5174279">,</span>&nbsp;<span class="op" id="5174281">&amp;</span><span class="ident" id="5174282">mp</span><span class="op" id="5174284">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5174287">if</span>&nbsp;<span class="ident" id="5174290">r</span><span class="op" id="5174291">.</span><span class="ident" id="5174292">Empty</span><span class="op" id="5174297">(</span><span class="op" id="5174298">)</span>&nbsp;<span class="op" id="5174300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5174304">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5174312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5174316">//&nbsp;Fast&nbsp;paths&nbsp;for&nbsp;special&nbsp;cases.&nbsp;If&nbsp;none&nbsp;of&nbsp;them&nbsp;apply,&nbsp;then&nbsp;we&nbsp;fall&nbsp;back&nbsp;to&nbsp;a&nbsp;general&nbsp;but&nbsp;slow&nbsp;implementation.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5174429">switch</span>&nbsp;<span class="ident" id="5174436">dst0</span>&nbsp;<span class="op" id="5174441">:=</span>&nbsp;<span class="ident" id="5174444">dst</span><span class="op" id="5174447">.</span><span class="op" id="5174448">(</span><span class="keyword" id="5174449">type</span><span class="op" id="5174453">)</span>&nbsp;<span class="op" id="5174455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5174458">case</span>&nbsp;<span class="op" id="5174463">*</span><span class="ident" id="5174464">image</span><span class="op" id="5174469">.</span><span class="ident" id="5174470">RGBA</span><span class="op" id="5174474">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5174478">if</span>&nbsp;<span class="ident" id="5174481">op</span>&nbsp;<span class="op" id="5174484">==</span>&nbsp;<span class="ident" id="5174487">Over</span>&nbsp;<span class="op" id="5174492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5174497">if</span>&nbsp;<span class="ident" id="5174500">mask</span>&nbsp;<span class="op" id="5174505">==</span>&nbsp;<span class="builtintype" id="5174508">nil</span>&nbsp;<span class="op" id="5174512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5174518">switch</span>&nbsp;<span class="ident" id="5174525">src0</span>&nbsp;<span class="op" id="5174530">:=</span>&nbsp;<span class="ident" id="5174533">src</span><span class="op" id="5174536">.</span><span class="op" id="5174537">(</span><span class="keyword" id="5174538">type</span><span class="op" id="5174542">)</span>&nbsp;<span class="op" id="5174544">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5174550">case</span>&nbsp;<span class="op" id="5174555">*</span><span class="ident" id="5174556">image</span><span class="op" id="5174561">.</span><span class="ident" id="5174562">Uniform</span><span class="op" id="5174569">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5174576">drawFillOver</span><span class="op" id="5174588">(</span><span class="ident" id="5174589">dst0</span><span class="op" id="5174593">,</span>&nbsp;<span class="ident" id="5174595">r</span><span class="op" id="5174596">,</span>&nbsp;<span class="ident" id="5174598">src0</span><span class="op" id="5174602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5174609">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5174620">case</span>&nbsp;<span class="op" id="5174625">*</span><span class="ident" id="5174626">image</span><span class="op" id="5174631">.</span><span class="ident" id="5174632">RGBA</span><span class="op" id="5174636">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5174643">drawCopyOver</span><span class="op" id="5174655">(</span><span class="ident" id="5174656">dst0</span><span class="op" id="5174660">,</span>&nbsp;<span class="ident" id="5174662">r</span><span class="op" id="5174663">,</span>&nbsp;<span class="ident" id="5174665">src0</span><span class="op" id="5174669">,</span>&nbsp;<span class="ident" id="5174671">sp</span><span class="op" id="5174673">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5174680">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5174691">case</span>&nbsp;<span class="op" id="5174696">*</span><span class="ident" id="5174697">image</span><span class="op" id="5174702">.</span><span class="ident" id="5174703">NRGBA</span><span class="op" id="5174708">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5174715">drawNRGBAOver</span><span class="op" id="5174728">(</span><span class="ident" id="5174729">dst0</span><span class="op" id="5174733">,</span>&nbsp;<span class="ident" id="5174735">r</span><span class="op" id="5174736">,</span>&nbsp;<span class="ident" id="5174738">src0</span><span class="op" id="5174742">,</span>&nbsp;<span class="ident" id="5174744">sp</span><span class="op" id="5174746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5174753">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5174764">case</span>&nbsp;<span class="op" id="5174769">*</span><span class="ident" id="5174770">image</span><span class="op" id="5174775">.</span><span class="ident" id="5174776">YCbCr</span><span class="op" id="5174781">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5174788">if</span>&nbsp;<span class="ident" id="5174791">drawYCbCr</span><span class="op" id="5174800">(</span><span class="ident" id="5174801">dst0</span><span class="op" id="5174805">,</span>&nbsp;<span class="ident" id="5174807">r</span><span class="op" id="5174808">,</span>&nbsp;<span class="ident" id="5174810">src0</span><span class="op" id="5174814">,</span>&nbsp;<span class="ident" id="5174816">sp</span><span class="op" id="5174818">)</span>&nbsp;<span class="op" id="5174820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5174828">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5174840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5174846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5174851">}</span>&nbsp;<span class="keyword" id="5174853">else</span>&nbsp;<span class="keyword" id="5174858">if</span>&nbsp;<span class="ident" id="5174861">mask0</span><span class="op" id="5174866">,</span>&nbsp;<span class="ident" id="5174868">ok</span>&nbsp;<span class="op" id="5174871">:=</span>&nbsp;<span class="ident" id="5174874">mask</span><span class="op" id="5174878">.</span><span class="op" id="5174879">(</span><span class="op" id="5174880">*</span><span class="ident" id="5174881">image</span><span class="op" id="5174886">.</span><span class="ident" id="5174887">Alpha</span><span class="op" id="5174892">)</span><span class="op" id="5174893">;</span>&nbsp;<span class="ident" id="5174895">ok</span>&nbsp;<span class="op" id="5174898">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5174904">switch</span>&nbsp;<span class="ident" id="5174911">src0</span>&nbsp;<span class="op" id="5174916">:=</span>&nbsp;<span class="ident" id="5174919">src</span><span class="op" id="5174922">.</span><span class="op" id="5174923">(</span><span class="keyword" id="5174924">type</span><span class="op" id="5174928">)</span>&nbsp;<span class="op" id="5174930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5174936">case</span>&nbsp;<span class="op" id="5174941">*</span><span class="ident" id="5174942">image</span><span class="op" id="5174947">.</span><span class="ident" id="5174948">Uniform</span><span class="op" id="5174955">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5174962">drawGlyphOver</span><span class="op" id="5174975">(</span><span class="ident" id="5174976">dst0</span><span class="op" id="5174980">,</span>&nbsp;<span class="ident" id="5174982">r</span><span class="op" id="5174983">,</span>&nbsp;<span class="ident" id="5174985">src0</span><span class="op" id="5174989">,</span>&nbsp;<span class="ident" id="5174991">mask0</span><span class="op" id="5174996">,</span>&nbsp;<span class="ident" id="5174998">mp</span><span class="op" id="5175000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5175007">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5175018">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5175023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5175027">}</span>&nbsp;<span class="keyword" id="5175029">else</span>&nbsp;<span class="op" id="5175034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5175039">if</span>&nbsp;<span class="ident" id="5175042">mask</span>&nbsp;<span class="op" id="5175047">==</span>&nbsp;<span class="builtintype" id="5175050">nil</span>&nbsp;<span class="op" id="5175054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5175060">switch</span>&nbsp;<span class="ident" id="5175067">src0</span>&nbsp;<span class="op" id="5175072">:=</span>&nbsp;<span class="ident" id="5175075">src</span><span class="op" id="5175078">.</span><span class="op" id="5175079">(</span><span class="keyword" id="5175080">type</span><span class="op" id="5175084">)</span>&nbsp;<span class="op" id="5175086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5175092">case</span>&nbsp;<span class="op" id="5175097">*</span><span class="ident" id="5175098">image</span><span class="op" id="5175103">.</span><span class="ident" id="5175104">Uniform</span><span class="op" id="5175111">:</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5175118">drawFillSrc</span><span class="op" id="5175129">(</span><span class="ident" id="5175130">dst0</span><span class="op" id="5175134">,</span>&nbsp;<span class="ident" id="5175136">r</span><span class="op" id="5175137">,</span>&nbsp;<span class="ident" id="5175139">src0</span><span class="op" id="5175143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5175150">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5175161">case</span>&nbsp;<span class="op" id="5175166">*</span><span class="ident" id="5175167">image</span><span class="op" id="5175172">.</span><span class="ident" id="5175173">RGBA</span><span class="op" id="5175177">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5175184">drawCopySrc</span><span class="op" id="5175195">(</span><span class="ident" id="5175196">dst0</span><span class="op" id="5175200">,</span>&nbsp;<span class="ident" id="5175202">r</span><span class="op" id="5175203">,</span>&nbsp;<span class="ident" id="5175205">src0</span><span class="op" id="5175209">,</span>&nbsp;<span class="ident" id="5175211">sp</span><span class="op" id="5175213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5175220">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5175231">case</span>&nbsp;<span class="op" id="5175236">*</span><span class="ident" id="5175237">image</span><span class="op" id="5175242">.</span><span class="ident" id="5175243">NRGBA</span><span class="op" id="5175248">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5175255">drawNRGBASrc</span><span class="op" id="5175267">(</span><span class="ident" id="5175268">dst0</span><span class="op" id="5175272">,</span>&nbsp;<span class="ident" id="5175274">r</span><span class="op" id="5175275">,</span>&nbsp;<span class="ident" id="5175277">src0</span><span class="op" id="5175281">,</span>&nbsp;<span class="ident" id="5175283">sp</span><span class="op" id="5175285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5175292">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5175303">case</span>&nbsp;<span class="op" id="5175308">*</span><span class="ident" id="5175309">image</span><span class="op" id="5175314">.</span><span class="ident" id="5175315">YCbCr</span><span class="op" id="5175320">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5175327">if</span>&nbsp;<span class="ident" id="5175330">drawYCbCr</span><span class="op" id="5175339">(</span><span class="ident" id="5175340">dst0</span><span class="op" id="5175344">,</span>&nbsp;<span class="ident" id="5175346">r</span><span class="op" id="5175347">,</span>&nbsp;<span class="ident" id="5175349">src0</span><span class="op" id="5175353">,</span>&nbsp;<span class="ident" id="5175355">sp</span><span class="op" id="5175357">)</span>&nbsp;<span class="op" id="5175359">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5175367">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5175379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5175385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5175390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5175394">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5175398">drawRGBA</span><span class="op" id="5175406">(</span><span class="ident" id="5175407">dst0</span><span class="op" id="5175411">,</span>&nbsp;<span class="ident" id="5175413">r</span><span class="op" id="5175414">,</span>&nbsp;<span class="ident" id="5175416">src</span><span class="op" id="5175419">,</span>&nbsp;<span class="ident" id="5175421">sp</span><span class="op" id="5175423">,</span>&nbsp;<span class="ident" id="5175425">mask</span><span class="op" id="5175429">,</span>&nbsp;<span class="ident" id="5175431">mp</span><span class="op" id="5175433">,</span>&nbsp;<span class="ident" id="5175435">op</span><span class="op" id="5175437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5175441">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5175449">case</span>&nbsp;<span class="op" id="5175454">*</span><span class="ident" id="5175455">image</span><span class="op" id="5175460">.</span><span class="ident" id="5175461">Paletted</span><span class="op" id="5175469">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5175473">if</span>&nbsp;<span class="ident" id="5175476">op</span>&nbsp;<span class="op" id="5175479">==</span>&nbsp;<span class="ident" id="5175482">Src</span>&nbsp;<span class="op" id="5175486">&amp;&amp;</span>&nbsp;<span class="ident" id="5175489">mask</span>&nbsp;<span class="op" id="5175494">==</span>&nbsp;<span class="builtintype" id="5175497">nil</span>&nbsp;<span class="op" id="5175501">&amp;&amp;</span>&nbsp;<span class="op" id="5175504">!</span><span class="ident" id="5175505">processBackward</span><span class="op" id="5175520">(</span><span class="ident" id="5175521">dst</span><span class="op" id="5175524">,</span>&nbsp;<span class="ident" id="5175526">r</span><span class="op" id="5175527">,</span>&nbsp;<span class="ident" id="5175529">src</span><span class="op" id="5175532">,</span>&nbsp;<span class="ident" id="5175534">sp</span><span class="op" id="5175536">)</span>&nbsp;<span class="op" id="5175538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5175543">drawPaletted</span><span class="op" id="5175555">(</span><span class="ident" id="5175556">dst0</span><span class="op" id="5175560">,</span>&nbsp;<span class="ident" id="5175562">r</span><span class="op" id="5175563">,</span>&nbsp;<span class="ident" id="5175565">src</span><span class="op" id="5175568">,</span>&nbsp;<span class="ident" id="5175570">sp</span><span class="op" id="5175572">,</span>&nbsp;<span class="builtintype" id="5175574">false</span><span class="op" id="5175579">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5175583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5175586">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5175590">x0</span><span class="op" id="5175592">,</span>&nbsp;<span class="ident" id="5175594">x1</span><span class="op" id="5175596">,</span>&nbsp;<span class="ident" id="5175598">dx</span>&nbsp;<span class="op" id="5175601">:=</span>&nbsp;<span class="ident" id="5175604">r</span><span class="op" id="5175605">.</span><span class="ident" id="5175606">Min</span><span class="op" id="5175609">.</span><span class="ident" id="5175610">X</span><span class="op" id="5175611">,</span>&nbsp;<span class="ident" id="5175613">r</span><span class="op" id="5175614">.</span><span class="ident" id="5175615">Max</span><span class="op" id="5175618">.</span><span class="ident" id="5175619">X</span><span class="op" id="5175620">,</span>&nbsp;<span class="num" id="5175622">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5175625">y0</span><span class="op" id="5175627">,</span>&nbsp;<span class="ident" id="5175629">y1</span><span class="op" id="5175631">,</span>&nbsp;<span class="ident" id="5175633">dy</span>&nbsp;<span class="op" id="5175636">:=</span>&nbsp;<span class="ident" id="5175639">r</span><span class="op" id="5175640">.</span><span class="ident" id="5175641">Min</span><span class="op" id="5175644">.</span><span class="ident" id="5175645">Y</span><span class="op" id="5175646">,</span>&nbsp;<span class="ident" id="5175648">r</span><span class="op" id="5175649">.</span><span class="ident" id="5175650">Max</span><span class="op" id="5175653">.</span><span class="ident" id="5175654">Y</span><span class="op" id="5175655">,</span>&nbsp;<span class="num" id="5175657">1</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5175660">if</span>&nbsp;<span class="ident" id="5175663">processBackward</span><span class="op" id="5175678">(</span><span class="ident" id="5175679">dst</span><span class="op" id="5175682">,</span>&nbsp;<span class="ident" id="5175684">r</span><span class="op" id="5175685">,</span>&nbsp;<span class="ident" id="5175687">src</span><span class="op" id="5175690">,</span>&nbsp;<span class="ident" id="5175692">sp</span><span class="op" id="5175694">)</span>&nbsp;<span class="op" id="5175696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5175700">x0</span><span class="op" id="5175702">,</span>&nbsp;<span class="ident" id="5175704">x1</span><span class="op" id="5175706">,</span>&nbsp;<span class="ident" id="5175708">dx</span>&nbsp;<span class="op" id="5175711">=</span>&nbsp;<span class="ident" id="5175713">x1</span><span class="op" id="5175715">-</span><span class="num" id="5175716">1</span><span class="op" id="5175717">,</span>&nbsp;<span class="ident" id="5175719">x0</span><span class="op" id="5175721">-</span><span class="num" id="5175722">1</span><span class="op" id="5175723">,</span>&nbsp;<span class="op" id="5175725">-</span><span class="num" id="5175726">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5175730">y0</span><span class="op" id="5175732">,</span>&nbsp;<span class="ident" id="5175734">y1</span><span class="op" id="5175736">,</span>&nbsp;<span class="ident" id="5175738">dy</span>&nbsp;<span class="op" id="5175741">=</span>&nbsp;<span class="ident" id="5175743">y1</span><span class="op" id="5175745">-</span><span class="num" id="5175746">1</span><span class="op" id="5175747">,</span>&nbsp;<span class="ident" id="5175749">y0</span><span class="op" id="5175751">-</span><span class="num" id="5175752">1</span><span class="op" id="5175753">,</span>&nbsp;<span class="op" id="5175755">-</span><span class="num" id="5175756">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5175759">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5175763">var</span>&nbsp;<span class="ident" id="5175767">out</span>&nbsp;<span class="ident" id="5175771">color</span><span class="op" id="5175776">.</span><span class="ident" id="5175777">RGBA64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5175785">sy</span>&nbsp;<span class="op" id="5175788">:=</span>&nbsp;<span class="ident" id="5175791">sp</span><span class="op" id="5175793">.</span><span class="ident" id="5175794">Y</span>&nbsp;<span class="op" id="5175796">+</span>&nbsp;<span class="ident" id="5175798">y0</span>&nbsp;<span class="op" id="5175801">-</span>&nbsp;<span class="ident" id="5175803">r</span><span class="op" id="5175804">.</span><span class="ident" id="5175805">Min</span><span class="op" id="5175808">.</span><span class="ident" id="5175809">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5175812">my</span>&nbsp;<span class="op" id="5175815">:=</span>&nbsp;<span class="ident" id="5175818">mp</span><span class="op" id="5175820">.</span><span class="ident" id="5175821">Y</span>&nbsp;<span class="op" id="5175823">+</span>&nbsp;<span class="ident" id="5175825">y0</span>&nbsp;<span class="op" id="5175828">-</span>&nbsp;<span class="ident" id="5175830">r</span><span class="op" id="5175831">.</span><span class="ident" id="5175832">Min</span><span class="op" id="5175835">.</span><span class="ident" id="5175836">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5175839">for</span>&nbsp;<span class="ident" id="5175843">y</span>&nbsp;<span class="op" id="5175845">:=</span>&nbsp;<span class="ident" id="5175848">y0</span><span class="op" id="5175850">;</span>&nbsp;<span class="ident" id="5175852">y</span>&nbsp;<span class="op" id="5175854">!=</span>&nbsp;<span class="ident" id="5175857">y1</span><span class="op" id="5175859">;</span>&nbsp;<span class="ident" id="5175861">y</span><span class="op" id="5175862">,</span>&nbsp;<span class="ident" id="5175864">sy</span><span class="op" id="5175866">,</span>&nbsp;<span class="ident" id="5175868">my</span>&nbsp;<span class="op" id="5175871">=</span>&nbsp;<span class="ident" id="5175873">y</span><span class="op" id="5175874">+</span><span class="ident" id="5175875">dy</span><span class="op" id="5175877">,</span>&nbsp;<span class="ident" id="5175879">sy</span><span class="op" id="5175881">+</span><span class="ident" id="5175882">dy</span><span class="op" id="5175884">,</span>&nbsp;<span class="ident" id="5175886">my</span><span class="op" id="5175888">+</span><span class="ident" id="5175889">dy</span>&nbsp;<span class="op" id="5175892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5175896">sx</span>&nbsp;<span class="op" id="5175899">:=</span>&nbsp;<span class="ident" id="5175902">sp</span><span class="op" id="5175904">.</span><span class="ident" id="5175905">X</span>&nbsp;<span class="op" id="5175907">+</span>&nbsp;<span class="ident" id="5175909">x0</span>&nbsp;<span class="op" id="5175912">-</span>&nbsp;<span class="ident" id="5175914">r</span><span class="op" id="5175915">.</span><span class="ident" id="5175916">Min</span><span class="op" id="5175919">.</span><span class="ident" id="5175920">X</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5175924">mx</span>&nbsp;<span class="op" id="5175927">:=</span>&nbsp;<span class="ident" id="5175930">mp</span><span class="op" id="5175932">.</span><span class="ident" id="5175933">X</span>&nbsp;<span class="op" id="5175935">+</span>&nbsp;<span class="ident" id="5175937">x0</span>&nbsp;<span class="op" id="5175940">-</span>&nbsp;<span class="ident" id="5175942">r</span><span class="op" id="5175943">.</span><span class="ident" id="5175944">Min</span><span class="op" id="5175947">.</span><span class="ident" id="5175948">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5175952">for</span>&nbsp;<span class="ident" id="5175956">x</span>&nbsp;<span class="op" id="5175958">:=</span>&nbsp;<span class="ident" id="5175961">x0</span><span class="op" id="5175963">;</span>&nbsp;<span class="ident" id="5175965">x</span>&nbsp;<span class="op" id="5175967">!=</span>&nbsp;<span class="ident" id="5175970">x1</span><span class="op" id="5175972">;</span>&nbsp;<span class="ident" id="5175974">x</span><span class="op" id="5175975">,</span>&nbsp;<span class="ident" id="5175977">sx</span><span class="op" id="5175979">,</span>&nbsp;<span class="ident" id="5175981">mx</span>&nbsp;<span class="op" id="5175984">=</span>&nbsp;<span class="ident" id="5175986">x</span><span class="op" id="5175987">+</span><span class="ident" id="5175988">dx</span><span class="op" id="5175990">,</span>&nbsp;<span class="ident" id="5175992">sx</span><span class="op" id="5175994">+</span><span class="ident" id="5175995">dx</span><span class="op" id="5175997">,</span>&nbsp;<span class="ident" id="5175999">mx</span><span class="op" id="5176001">+</span><span class="ident" id="5176002">dx</span>&nbsp;<span class="op" id="5176005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5176010">ma</span>&nbsp;<span class="op" id="5176013">:=</span>&nbsp;<span class="builtintype" id="5176016">uint32</span><span class="op" id="5176022">(</span><span class="ident" id="5176023">m</span><span class="op" id="5176024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5176029">if</span>&nbsp;<span class="ident" id="5176032">mask</span>&nbsp;<span class="op" id="5176037">!=</span>&nbsp;<span class="builtintype" id="5176040">nil</span>&nbsp;<span class="op" id="5176044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5176050">_</span><span class="op" id="5176051">,</span>&nbsp;<span class="ident" id="5176053">_</span><span class="op" id="5176054">,</span>&nbsp;<span class="ident" id="5176056">_</span><span class="op" id="5176057">,</span>&nbsp;<span class="ident" id="5176059">ma</span>&nbsp;<span class="op" id="5176062">=</span>&nbsp;<span class="ident" id="5176064">mask</span><span class="op" id="5176068">.</span><span class="ident" id="5176069">At</span><span class="op" id="5176071">(</span><span class="ident" id="5176072">mx</span><span class="op" id="5176074">,</span>&nbsp;<span class="ident" id="5176076">my</span><span class="op" id="5176078">)</span><span class="op" id="5176079">.</span><span class="ident" id="5176080">RGBA</span><span class="op" id="5176084">(</span><span class="op" id="5176085">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5176090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5176095">switch</span>&nbsp;<span class="op" id="5176102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5176107">case</span>&nbsp;<span class="ident" id="5176112">ma</span>&nbsp;<span class="op" id="5176115">==</span>&nbsp;<span class="num" id="5176118">0</span><span class="op" id="5176119">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5176125">if</span>&nbsp;<span class="ident" id="5176128">op</span>&nbsp;<span class="op" id="5176131">==</span>&nbsp;<span class="ident" id="5176134">Over</span>&nbsp;<span class="op" id="5176139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5176146">//&nbsp;No-op.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5176160">}</span>&nbsp;<span class="keyword" id="5176162">else</span>&nbsp;<span class="op" id="5176167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5176174">dst</span><span class="op" id="5176177">.</span><span class="ident" id="5176178">Set</span><span class="op" id="5176181">(</span><span class="ident" id="5176182">x</span><span class="op" id="5176183">,</span>&nbsp;<span class="ident" id="5176185">y</span><span class="op" id="5176186">,</span>&nbsp;<span class="ident" id="5176188">color</span><span class="op" id="5176193">.</span><span class="ident" id="5176194">Transparent</span><span class="op" id="5176205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5176211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5176216">case</span>&nbsp;<span class="ident" id="5176221">ma</span>&nbsp;<span class="op" id="5176224">==</span>&nbsp;<span class="ident" id="5176227">m</span>&nbsp;<span class="op" id="5176229">&amp;&amp;</span>&nbsp;<span class="ident" id="5176232">op</span>&nbsp;<span class="op" id="5176235">==</span>&nbsp;<span class="ident" id="5176238">Src</span><span class="op" id="5176241">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5176247">dst</span><span class="op" id="5176250">.</span><span class="ident" id="5176251">Set</span><span class="op" id="5176254">(</span><span class="ident" id="5176255">x</span><span class="op" id="5176256">,</span>&nbsp;<span class="ident" id="5176258">y</span><span class="op" id="5176259">,</span>&nbsp;<span class="ident" id="5176261">src</span><span class="op" id="5176264">.</span><span class="ident" id="5176265">At</span><span class="op" id="5176267">(</span><span class="ident" id="5176268">sx</span><span class="op" id="5176270">,</span>&nbsp;<span class="ident" id="5176272">sy</span><span class="op" id="5176274">)</span><span class="op" id="5176275">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5176280">default</span><span class="op" id="5176287">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5176293">sr</span><span class="op" id="5176295">,</span>&nbsp;<span class="ident" id="5176297">sg</span><span class="op" id="5176299">,</span>&nbsp;<span class="ident" id="5176301">sb</span><span class="op" id="5176303">,</span>&nbsp;<span class="ident" id="5176305">sa</span>&nbsp;<span class="op" id="5176308">:=</span>&nbsp;<span class="ident" id="5176311">src</span><span class="op" id="5176314">.</span><span class="ident" id="5176315">At</span><span class="op" id="5176317">(</span><span class="ident" id="5176318">sx</span><span class="op" id="5176320">,</span>&nbsp;<span class="ident" id="5176322">sy</span><span class="op" id="5176324">)</span><span class="op" id="5176325">.</span><span class="ident" id="5176326">RGBA</span><span class="op" id="5176330">(</span><span class="op" id="5176331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5176337">if</span>&nbsp;<span class="ident" id="5176340">op</span>&nbsp;<span class="op" id="5176343">==</span>&nbsp;<span class="ident" id="5176346">Over</span>&nbsp;<span class="op" id="5176351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5176358">dr</span><span class="op" id="5176360">,</span>&nbsp;<span class="ident" id="5176362">dg</span><span class="op" id="5176364">,</span>&nbsp;<span class="ident" id="5176366">db</span><span class="op" id="5176368">,</span>&nbsp;<span class="ident" id="5176370">da</span>&nbsp;<span class="op" id="5176373">:=</span>&nbsp;<span class="ident" id="5176376">dst</span><span class="op" id="5176379">.</span><span class="ident" id="5176380">At</span><span class="op" id="5176382">(</span><span class="ident" id="5176383">x</span><span class="op" id="5176384">,</span>&nbsp;<span class="ident" id="5176386">y</span><span class="op" id="5176387">)</span><span class="op" id="5176388">.</span><span class="ident" id="5176389">RGBA</span><span class="op" id="5176393">(</span><span class="op" id="5176394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5176401">a</span>&nbsp;<span class="op" id="5176403">:=</span>&nbsp;<span class="ident" id="5176406">m</span>&nbsp;<span class="op" id="5176408">-</span>&nbsp;<span class="op" id="5176410">(</span><span class="ident" id="5176411">sa</span>&nbsp;<span class="op" id="5176414">*</span>&nbsp;<span class="ident" id="5176416">ma</span>&nbsp;<span class="op" id="5176419">/</span>&nbsp;<span class="ident" id="5176421">m</span><span class="op" id="5176422">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5176429">out</span><span class="op" id="5176432">.</span><span class="ident" id="5176433">R</span>&nbsp;<span class="op" id="5176435">=</span>&nbsp;<span class="builtintype" id="5176437">uint16</span><span class="op" id="5176443">(</span><span class="op" id="5176444">(</span><span class="ident" id="5176445">dr</span><span class="op" id="5176447">*</span><span class="ident" id="5176448">a</span>&nbsp;<span class="op" id="5176450">+</span>&nbsp;<span class="ident" id="5176452">sr</span><span class="op" id="5176454">*</span><span class="ident" id="5176455">ma</span><span class="op" id="5176457">)</span>&nbsp;<span class="op" id="5176459">/</span>&nbsp;<span class="ident" id="5176461">m</span><span class="op" id="5176462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5176469">out</span><span class="op" id="5176472">.</span><span class="ident" id="5176473">G</span>&nbsp;<span class="op" id="5176475">=</span>&nbsp;<span class="builtintype" id="5176477">uint16</span><span class="op" id="5176483">(</span><span class="op" id="5176484">(</span><span class="ident" id="5176485">dg</span><span class="op" id="5176487">*</span><span class="ident" id="5176488">a</span>&nbsp;<span class="op" id="5176490">+</span>&nbsp;<span class="ident" id="5176492">sg</span><span class="op" id="5176494">*</span><span class="ident" id="5176495">ma</span><span class="op" id="5176497">)</span>&nbsp;<span class="op" id="5176499">/</span>&nbsp;<span class="ident" id="5176501">m</span><span class="op" id="5176502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5176509">out</span><span class="op" id="5176512">.</span><span class="ident" id="5176513">B</span>&nbsp;<span class="op" id="5176515">=</span>&nbsp;<span class="builtintype" id="5176517">uint16</span><span class="op" id="5176523">(</span><span class="op" id="5176524">(</span><span class="ident" id="5176525">db</span><span class="op" id="5176527">*</span><span class="ident" id="5176528">a</span>&nbsp;<span class="op" id="5176530">+</span>&nbsp;<span class="ident" id="5176532">sb</span><span class="op" id="5176534">*</span><span class="ident" id="5176535">ma</span><span class="op" id="5176537">)</span>&nbsp;<span class="op" id="5176539">/</span>&nbsp;<span class="ident" id="5176541">m</span><span class="op" id="5176542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5176549">out</span><span class="op" id="5176552">.</span><span class="ident" id="5176553">A</span>&nbsp;<span class="op" id="5176555">=</span>&nbsp;<span class="builtintype" id="5176557">uint16</span><span class="op" id="5176563">(</span><span class="op" id="5176564">(</span><span class="ident" id="5176565">da</span><span class="op" id="5176567">*</span><span class="ident" id="5176568">a</span>&nbsp;<span class="op" id="5176570">+</span>&nbsp;<span class="ident" id="5176572">sa</span><span class="op" id="5176574">*</span><span class="ident" id="5176575">ma</span><span class="op" id="5176577">)</span>&nbsp;<span class="op" id="5176579">/</span>&nbsp;<span class="ident" id="5176581">m</span><span class="op" id="5176582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5176588">}</span>&nbsp;<span class="keyword" id="5176590">else</span>&nbsp;<span class="op" id="5176595">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5176602">out</span><span class="op" id="5176605">.</span><span class="ident" id="5176606">R</span>&nbsp;<span class="op" id="5176608">=</span>&nbsp;<span class="builtintype" id="5176610">uint16</span><span class="op" id="5176616">(</span><span class="ident" id="5176617">sr</span>&nbsp;<span class="op" id="5176620">*</span>&nbsp;<span class="ident" id="5176622">ma</span>&nbsp;<span class="op" id="5176625">/</span>&nbsp;<span class="ident" id="5176627">m</span><span class="op" id="5176628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5176635">out</span><span class="op" id="5176638">.</span><span class="ident" id="5176639">G</span>&nbsp;<span class="op" id="5176641">=</span>&nbsp;<span class="builtintype" id="5176643">uint16</span><span class="op" id="5176649">(</span><span class="ident" id="5176650">sg</span>&nbsp;<span class="op" id="5176653">*</span>&nbsp;<span class="ident" id="5176655">ma</span>&nbsp;<span class="op" id="5176658">/</span>&nbsp;<span class="ident" id="5176660">m</span><span class="op" id="5176661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5176668">out</span><span class="op" id="5176671">.</span><span class="ident" id="5176672">B</span>&nbsp;<span class="op" id="5176674">=</span>&nbsp;<span class="builtintype" id="5176676">uint16</span><span class="op" id="5176682">(</span><span class="ident" id="5176683">sb</span>&nbsp;<span class="op" id="5176686">*</span>&nbsp;<span class="ident" id="5176688">ma</span>&nbsp;<span class="op" id="5176691">/</span>&nbsp;<span class="ident" id="5176693">m</span><span class="op" id="5176694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5176701">out</span><span class="op" id="5176704">.</span><span class="ident" id="5176705">A</span>&nbsp;<span class="op" id="5176707">=</span>&nbsp;<span class="builtintype" id="5176709">uint16</span><span class="op" id="5176715">(</span><span class="ident" id="5176716">sa</span>&nbsp;<span class="op" id="5176719">*</span>&nbsp;<span class="ident" id="5176721">ma</span>&nbsp;<span class="op" id="5176724">/</span>&nbsp;<span class="ident" id="5176726">m</span><span class="op" id="5176727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5176733">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5176739">//&nbsp;The&nbsp;third&nbsp;argument&nbsp;is&nbsp;&amp;out&nbsp;instead&nbsp;of&nbsp;out&nbsp;(and&nbsp;out&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5176800">//&nbsp;declared&nbsp;outside&nbsp;of&nbsp;the&nbsp;inner&nbsp;loop)&nbsp;to&nbsp;avoid&nbsp;the&nbsp;implicit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5176865">//&nbsp;conversion&nbsp;to&nbsp;color.Color&nbsp;here&nbsp;allocating&nbsp;memory&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5176928">//&nbsp;inner&nbsp;loop&nbsp;if&nbsp;sizeof(color.RGBA64)&nbsp;&gt;&nbsp;sizeof(uintptr).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5176989">dst</span><span class="op" id="5176992">.</span><span class="ident" id="5176993">Set</span><span class="op" id="5176996">(</span><span class="ident" id="5176997">x</span><span class="op" id="5176998">,</span>&nbsp;<span class="ident" id="5177000">y</span><span class="op" id="5177001">,</span>&nbsp;<span class="op" id="5177003">&amp;</span><span class="ident" id="5177004">out</span><span class="op" id="5177007">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5177012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5177016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5177019">}</span><br>
<span class="lineno"></span><span class="op" id="5177021">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span><span class="keyword" id="5177024">func</span>&nbsp;<span class="ident" id="5177029">drawFillOver</span><span class="op" id="5177041">(</span><span class="ident" id="5177042">dst</span>&nbsp;<span class="op" id="5177046">*</span><span class="ident" id="5177047">image</span><span class="op" id="5177052">.</span><span class="ident" id="5177053">RGBA</span><span class="op" id="5177057">,</span>&nbsp;<span class="ident" id="5177059">r</span>&nbsp;<span class="ident" id="5177061">image</span><span class="op" id="5177066">.</span><span class="ident" id="5177067">Rectangle</span><span class="op" id="5177076">,</span>&nbsp;<span class="ident" id="5177078">src</span>&nbsp;<span class="op" id="5177082">*</span><span class="ident" id="5177083">image</span><span class="op" id="5177088">.</span><span class="ident" id="5177089">Uniform</span><span class="op" id="5177096">)</span>&nbsp;<span class="op" id="5177098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5177101">sr</span><span class="op" id="5177103">,</span>&nbsp;<span class="ident" id="5177105">sg</span><span class="op" id="5177107">,</span>&nbsp;<span class="ident" id="5177109">sb</span><span class="op" id="5177111">,</span>&nbsp;<span class="ident" id="5177113">sa</span>&nbsp;<span class="op" id="5177116">:=</span>&nbsp;<span class="ident" id="5177119">src</span><span class="op" id="5177122">.</span><span class="ident" id="5177123">RGBA</span><span class="op" id="5177127">(</span><span class="op" id="5177128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5177131">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5177189">a</span>&nbsp;<span class="op" id="5177191">:=</span>&nbsp;<span class="op" id="5177194">(</span><span class="ident" id="5177195">m</span>&nbsp;<span class="op" id="5177197">-</span>&nbsp;<span class="ident" id="5177199">sa</span><span class="op" id="5177201">)</span>&nbsp;<span class="op" id="5177203">*</span>&nbsp;<span class="num" id="5177205">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5177212">i0</span>&nbsp;<span class="op" id="5177215">:=</span>&nbsp;<span class="ident" id="5177218">dst</span><span class="op" id="5177221">.</span><span class="ident" id="5177222">PixOffset</span><span class="op" id="5177231">(</span><span class="ident" id="5177232">r</span><span class="op" id="5177233">.</span><span class="ident" id="5177234">Min</span><span class="op" id="5177237">.</span><span class="ident" id="5177238">X</span><span class="op" id="5177239">,</span>&nbsp;<span class="ident" id="5177241">r</span><span class="op" id="5177242">.</span><span class="ident" id="5177243">Min</span><span class="op" id="5177246">.</span><span class="ident" id="5177247">Y</span><span class="op" id="5177248">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5177251">i1</span>&nbsp;<span class="op" id="5177254">:=</span>&nbsp;<span class="ident" id="5177257">i0</span>&nbsp;<span class="op" id="5177260">+</span>&nbsp;<span class="ident" id="5177262">r</span><span class="op" id="5177263">.</span><span class="ident" id="5177264">Dx</span><span class="op" id="5177266">(</span><span class="op" id="5177267">)</span><span class="op" id="5177268">*</span><span class="num" id="5177269">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5177272">for</span>&nbsp;<span class="ident" id="5177276">y</span>&nbsp;<span class="op" id="5177278">:=</span>&nbsp;<span class="ident" id="5177281">r</span><span class="op" id="5177282">.</span><span class="ident" id="5177283">Min</span><span class="op" id="5177286">.</span><span class="ident" id="5177287">Y</span><span class="op" id="5177288">;</span>&nbsp;<span class="ident" id="5177290">y</span>&nbsp;<span class="op" id="5177292">!=</span>&nbsp;<span class="ident" id="5177295">r</span><span class="op" id="5177296">.</span><span class="ident" id="5177297">Max</span><span class="op" id="5177300">.</span><span class="ident" id="5177301">Y</span><span class="op" id="5177302">;</span>&nbsp;<span class="ident" id="5177304">y</span><span class="op" id="5177305">++</span>&nbsp;<span class="op" id="5177308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5177312">for</span>&nbsp;<span class="ident" id="5177316">i</span>&nbsp;<span class="op" id="5177318">:=</span>&nbsp;<span class="ident" id="5177321">i0</span><span class="op" id="5177323">;</span>&nbsp;<span class="ident" id="5177325">i</span>&nbsp;<span class="op" id="5177327">&lt;</span>&nbsp;<span class="ident" id="5177329">i1</span><span class="op" id="5177331">;</span>&nbsp;<span class="ident" id="5177333">i</span>&nbsp;<span class="op" id="5177335">+=</span>&nbsp;<span class="num" id="5177338">4</span>&nbsp;<span class="op" id="5177340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5177345">dr</span>&nbsp;<span class="op" id="5177348">:=</span>&nbsp;<span class="builtintype" id="5177351">uint32</span><span class="op" id="5177357">(</span><span class="ident" id="5177358">dst</span><span class="op" id="5177361">.</span><span class="ident" id="5177362">Pix</span><span class="op" id="5177365">[</span><span class="ident" id="5177366">i</span><span class="op" id="5177367">+</span><span class="num" id="5177368">0</span><span class="op" id="5177369">]</span><span class="op" id="5177370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5177375">dg</span>&nbsp;<span class="op" id="5177378">:=</span>&nbsp;<span class="builtintype" id="5177381">uint32</span><span class="op" id="5177387">(</span><span class="ident" id="5177388">dst</span><span class="op" id="5177391">.</span><span class="ident" id="5177392">Pix</span><span class="op" id="5177395">[</span><span class="ident" id="5177396">i</span><span class="op" id="5177397">+</span><span class="num" id="5177398">1</span><span class="op" id="5177399">]</span><span class="op" id="5177400">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5177405">db</span>&nbsp;<span class="op" id="5177408">:=</span>&nbsp;<span class="builtintype" id="5177411">uint32</span><span class="op" id="5177417">(</span><span class="ident" id="5177418">dst</span><span class="op" id="5177421">.</span><span class="ident" id="5177422">Pix</span><span class="op" id="5177425">[</span><span class="ident" id="5177426">i</span><span class="op" id="5177427">+</span><span class="num" id="5177428">2</span><span class="op" id="5177429">]</span><span class="op" id="5177430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5177435">da</span>&nbsp;<span class="op" id="5177438">:=</span>&nbsp;<span class="builtintype" id="5177441">uint32</span><span class="op" id="5177447">(</span><span class="ident" id="5177448">dst</span><span class="op" id="5177451">.</span><span class="ident" id="5177452">Pix</span><span class="op" id="5177455">[</span><span class="ident" id="5177456">i</span><span class="op" id="5177457">+</span><span class="num" id="5177458">3</span><span class="op" id="5177459">]</span><span class="op" id="5177460">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5177466">dst</span><span class="op" id="5177469">.</span><span class="ident" id="5177470">Pix</span><span class="op" id="5177473">[</span><span class="ident" id="5177474">i</span><span class="op" id="5177475">+</span><span class="num" id="5177476">0</span><span class="op" id="5177477">]</span>&nbsp;<span class="op" id="5177479">=</span>&nbsp;<span class="builtintype" id="5177481">uint8</span><span class="op" id="5177486">(</span><span class="op" id="5177487">(</span><span class="ident" id="5177488">dr</span><span class="op" id="5177490">*</span><span class="ident" id="5177491">a</span><span class="op" id="5177492">/</span><span class="ident" id="5177493">m</span>&nbsp;<span class="op" id="5177495">+</span>&nbsp;<span class="ident" id="5177497">sr</span><span class="op" id="5177499">)</span>&nbsp;<span class="op" id="5177501">&gt;&gt;</span>&nbsp;<span class="num" id="5177504">8</span><span class="op" id="5177505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5177510">dst</span><span class="op" id="5177513">.</span><span class="ident" id="5177514">Pix</span><span class="op" id="5177517">[</span><span class="ident" id="5177518">i</span><span class="op" id="5177519">+</span><span class="num" id="5177520">1</span><span class="op" id="5177521">]</span>&nbsp;<span class="op" id="5177523">=</span>&nbsp;<span class="builtintype" id="5177525">uint8</span><span class="op" id="5177530">(</span><span class="op" id="5177531">(</span><span class="ident" id="5177532">dg</span><span class="op" id="5177534">*</span><span class="ident" id="5177535">a</span><span class="op" id="5177536">/</span><span class="ident" id="5177537">m</span>&nbsp;<span class="op" id="5177539">+</span>&nbsp;<span class="ident" id="5177541">sg</span><span class="op" id="5177543">)</span>&nbsp;<span class="op" id="5177545">&gt;&gt;</span>&nbsp;<span class="num" id="5177548">8</span><span class="op" id="5177549">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5177554">dst</span><span class="op" id="5177557">.</span><span class="ident" id="5177558">Pix</span><span class="op" id="5177561">[</span><span class="ident" id="5177562">i</span><span class="op" id="5177563">+</span><span class="num" id="5177564">2</span><span class="op" id="5177565">]</span>&nbsp;<span class="op" id="5177567">=</span>&nbsp;<span class="builtintype" id="5177569">uint8</span><span class="op" id="5177574">(</span><span class="op" id="5177575">(</span><span class="ident" id="5177576">db</span><span class="op" id="5177578">*</span><span class="ident" id="5177579">a</span><span class="op" id="5177580">/</span><span class="ident" id="5177581">m</span>&nbsp;<span class="op" id="5177583">+</span>&nbsp;<span class="ident" id="5177585">sb</span><span class="op" id="5177587">)</span>&nbsp;<span class="op" id="5177589">&gt;&gt;</span>&nbsp;<span class="num" id="5177592">8</span><span class="op" id="5177593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5177598">dst</span><span class="op" id="5177601">.</span><span class="ident" id="5177602">Pix</span><span class="op" id="5177605">[</span><span class="ident" id="5177606">i</span><span class="op" id="5177607">+</span><span class="num" id="5177608">3</span><span class="op" id="5177609">]</span>&nbsp;<span class="op" id="5177611">=</span>&nbsp;<span class="builtintype" id="5177613">uint8</span><span class="op" id="5177618">(</span><span class="op" id="5177619">(</span><span class="ident" id="5177620">da</span><span class="op" id="5177622">*</span><span class="ident" id="5177623">a</span><span class="op" id="5177624">/</span><span class="ident" id="5177625">m</span>&nbsp;<span class="op" id="5177627">+</span>&nbsp;<span class="ident" id="5177629">sa</span><span class="op" id="5177631">)</span>&nbsp;<span class="op" id="5177633">&gt;&gt;</span>&nbsp;<span class="num" id="5177636">8</span><span class="op" id="5177637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5177641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5177645">i0</span>&nbsp;<span class="op" id="5177648">+=</span>&nbsp;<span class="ident" id="5177651">dst</span><span class="op" id="5177654">.</span><span class="ident" id="5177655">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5177664">i1</span>&nbsp;<span class="op" id="5177667">+=</span>&nbsp;<span class="ident" id="5177670">dst</span><span class="op" id="5177673">.</span><span class="ident" id="5177674">Stride</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5177682">}</span><br>
<span class="lineno"></span><span class="op" id="5177684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5177687">func</span>&nbsp;<span class="ident" id="5177692">drawFillSrc</span><span class="op" id="5177703">(</span><span class="ident" id="5177704">dst</span>&nbsp;<span class="op" id="5177708">*</span><span class="ident" id="5177709">image</span><span class="op" id="5177714">.</span><span class="ident" id="5177715">RGBA</span><span class="op" id="5177719">,</span>&nbsp;<span class="ident" id="5177721">r</span>&nbsp;<span class="ident" id="5177723">image</span><span class="op" id="5177728">.</span><span class="ident" id="5177729">Rectangle</span><span class="op" id="5177738">,</span>&nbsp;<span class="ident" id="5177740">src</span>&nbsp;<span class="op" id="5177744">*</span><span class="ident" id="5177745">image</span><span class="op" id="5177750">.</span><span class="ident" id="5177751">Uniform</span><span class="op" id="5177758">)</span>&nbsp;<span class="op" id="5177760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5177763">sr</span><span class="op" id="5177765">,</span>&nbsp;<span class="ident" id="5177767">sg</span><span class="op" id="5177769">,</span>&nbsp;<span class="ident" id="5177771">sb</span><span class="op" id="5177773">,</span>&nbsp;<span class="ident" id="5177775">sa</span>&nbsp;<span class="op" id="5177778">:=</span>&nbsp;<span class="ident" id="5177781">src</span><span class="op" id="5177784">.</span><span class="ident" id="5177785">RGBA</span><span class="op" id="5177789">(</span><span class="op" id="5177790">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5177793">//&nbsp;The&nbsp;built-in&nbsp;copy&nbsp;function&nbsp;is&nbsp;faster&nbsp;than&nbsp;a&nbsp;straightforward&nbsp;for&nbsp;loop&nbsp;to&nbsp;fill&nbsp;the&nbsp;destination&nbsp;with</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5177895">//&nbsp;the&nbsp;color,&nbsp;but&nbsp;copy&nbsp;requires&nbsp;a&nbsp;slice&nbsp;source.&nbsp;We&nbsp;therefore&nbsp;use&nbsp;a&nbsp;for&nbsp;loop&nbsp;to&nbsp;fill&nbsp;the&nbsp;first&nbsp;row,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5177999">//&nbsp;then&nbsp;use&nbsp;the&nbsp;first&nbsp;row&nbsp;as&nbsp;the&nbsp;slice&nbsp;source&nbsp;for&nbsp;the&nbsp;remaining&nbsp;rows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5178070">i0</span>&nbsp;<span class="op" id="5178073">:=</span>&nbsp;<span class="ident" id="5178076">dst</span><span class="op" id="5178079">.</span><span class="ident" id="5178080">PixOffset</span><span class="op" id="5178089">(</span><span class="ident" id="5178090">r</span><span class="op" id="5178091">.</span><span class="ident" id="5178092">Min</span><span class="op" id="5178095">.</span><span class="ident" id="5178096">X</span><span class="op" id="5178097">,</span>&nbsp;<span class="ident" id="5178099">r</span><span class="op" id="5178100">.</span><span class="ident" id="5178101">Min</span><span class="op" id="5178104">.</span><span class="ident" id="5178105">Y</span><span class="op" id="5178106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5178109">i1</span>&nbsp;<span class="op" id="5178112">:=</span>&nbsp;<span class="ident" id="5178115">i0</span>&nbsp;<span class="op" id="5178118">+</span>&nbsp;<span class="ident" id="5178120">r</span><span class="op" id="5178121">.</span><span class="ident" id="5178122">Dx</span><span class="op" id="5178124">(</span><span class="op" id="5178125">)</span><span class="op" id="5178126">*</span><span class="num" id="5178127">4</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5178130">for</span>&nbsp;<span class="ident" id="5178134">i</span>&nbsp;<span class="op" id="5178136">:=</span>&nbsp;<span class="ident" id="5178139">i0</span><span class="op" id="5178141">;</span>&nbsp;<span class="ident" id="5178143">i</span>&nbsp;<span class="op" id="5178145">&lt;</span>&nbsp;<span class="ident" id="5178147">i1</span><span class="op" id="5178149">;</span>&nbsp;<span class="ident" id="5178151">i</span>&nbsp;<span class="op" id="5178153">+=</span>&nbsp;<span class="num" id="5178156">4</span>&nbsp;<span class="op" id="5178158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5178162">dst</span><span class="op" id="5178165">.</span><span class="ident" id="5178166">Pix</span><span class="op" id="5178169">[</span><span class="ident" id="5178170">i</span><span class="op" id="5178171">+</span><span class="num" id="5178172">0</span><span class="op" id="5178173">]</span>&nbsp;<span class="op" id="5178175">=</span>&nbsp;<span class="builtintype" id="5178177">uint8</span><span class="op" id="5178182">(</span><span class="ident" id="5178183">sr</span>&nbsp;<span class="op" id="5178186">&gt;&gt;</span>&nbsp;<span class="num" id="5178189">8</span><span class="op" id="5178190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5178194">dst</span><span class="op" id="5178197">.</span><span class="ident" id="5178198">Pix</span><span class="op" id="5178201">[</span><span class="ident" id="5178202">i</span><span class="op" id="5178203">+</span><span class="num" id="5178204">1</span><span class="op" id="5178205">]</span>&nbsp;<span class="op" id="5178207">=</span>&nbsp;<span class="builtintype" id="5178209">uint8</span><span class="op" id="5178214">(</span><span class="ident" id="5178215">sg</span>&nbsp;<span class="op" id="5178218">&gt;&gt;</span>&nbsp;<span class="num" id="5178221">8</span><span class="op" id="5178222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5178226">dst</span><span class="op" id="5178229">.</span><span class="ident" id="5178230">Pix</span><span class="op" id="5178233">[</span><span class="ident" id="5178234">i</span><span class="op" id="5178235">+</span><span class="num" id="5178236">2</span><span class="op" id="5178237">]</span>&nbsp;<span class="op" id="5178239">=</span>&nbsp;<span class="builtintype" id="5178241">uint8</span><span class="op" id="5178246">(</span><span class="ident" id="5178247">sb</span>&nbsp;<span class="op" id="5178250">&gt;&gt;</span>&nbsp;<span class="num" id="5178253">8</span><span class="op" id="5178254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5178258">dst</span><span class="op" id="5178261">.</span><span class="ident" id="5178262">Pix</span><span class="op" id="5178265">[</span><span class="ident" id="5178266">i</span><span class="op" id="5178267">+</span><span class="num" id="5178268">3</span><span class="op" id="5178269">]</span>&nbsp;<span class="op" id="5178271">=</span>&nbsp;<span class="builtintype" id="5178273">uint8</span><span class="op" id="5178278">(</span><span class="ident" id="5178279">sa</span>&nbsp;<span class="op" id="5178282">&gt;&gt;</span>&nbsp;<span class="num" id="5178285">8</span><span class="op" id="5178286">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5178289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5178292">firstRow</span>&nbsp;<span class="op" id="5178301">:=</span>&nbsp;<span class="ident" id="5178304">dst</span><span class="op" id="5178307">.</span><span class="ident" id="5178308">Pix</span><span class="op" id="5178311">[</span><span class="ident" id="5178312">i0</span><span class="op" id="5178314">:</span><span class="ident" id="5178315">i1</span><span class="op" id="5178317">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5178320">for</span>&nbsp;<span class="ident" id="5178324">y</span>&nbsp;<span class="op" id="5178326">:=</span>&nbsp;<span class="ident" id="5178329">r</span><span class="op" id="5178330">.</span><span class="ident" id="5178331">Min</span><span class="op" id="5178334">.</span><span class="ident" id="5178335">Y</span>&nbsp;<span class="op" id="5178337">+</span>&nbsp;<span class="num" id="5178339">1</span><span class="op" id="5178340">;</span>&nbsp;<span class="ident" id="5178342">y</span>&nbsp;<span class="op" id="5178344">&lt;</span>&nbsp;<span class="ident" id="5178346">r</span><span class="op" id="5178347">.</span><span class="ident" id="5178348">Max</span><span class="op" id="5178351">.</span><span class="ident" id="5178352">Y</span><span class="op" id="5178353">;</span>&nbsp;<span class="ident" id="5178355">y</span><span class="op" id="5178356">++</span>&nbsp;<span class="op" id="5178359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5178363">i0</span>&nbsp;<span class="op" id="5178366">+=</span>&nbsp;<span class="ident" id="5178369">dst</span><span class="op" id="5178372">.</span><span class="ident" id="5178373">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5178382">i1</span>&nbsp;<span class="op" id="5178385">+=</span>&nbsp;<span class="ident" id="5178388">dst</span><span class="op" id="5178391">.</span><span class="ident" id="5178392">Stride</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5178401">copy</span><span class="op" id="5178405">(</span><span class="ident" id="5178406">dst</span><span class="op" id="5178409">.</span><span class="ident" id="5178410">Pix</span><span class="op" id="5178413">[</span><span class="ident" id="5178414">i0</span><span class="op" id="5178416">:</span><span class="ident" id="5178417">i1</span><span class="op" id="5178419">]</span><span class="op" id="5178420">,</span>&nbsp;<span class="ident" id="5178422">firstRow</span><span class="op" id="5178430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5178433">}</span><br>
<span class="lineno"></span><span class="op" id="5178435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5178438">func</span>&nbsp;<span class="ident" id="5178443">drawCopyOver</span><span class="op" id="5178455">(</span><span class="ident" id="5178456">dst</span>&nbsp;<span class="op" id="5178460">*</span><span class="ident" id="5178461">image</span><span class="op" id="5178466">.</span><span class="ident" id="5178467">RGBA</span><span class="op" id="5178471">,</span>&nbsp;<span class="ident" id="5178473">r</span>&nbsp;<span class="ident" id="5178475">image</span><span class="op" id="5178480">.</span><span class="ident" id="5178481">Rectangle</span><span class="op" id="5178490">,</span>&nbsp;<span class="ident" id="5178492">src</span>&nbsp;<span class="op" id="5178496">*</span><span class="ident" id="5178497">image</span><span class="op" id="5178502">.</span><span class="ident" id="5178503">RGBA</span><span class="op" id="5178507">,</span>&nbsp;<span class="ident" id="5178509">sp</span>&nbsp;<span class="ident" id="5178512">image</span><span class="op" id="5178517">.</span><span class="ident" id="5178518">Point</span><span class="op" id="5178523">)</span>&nbsp;<span class="op" id="5178525">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5178528">dx</span><span class="op" id="5178530">,</span>&nbsp;<span class="ident" id="5178532">dy</span>&nbsp;<span class="op" id="5178535">:=</span>&nbsp;<span class="ident" id="5178538">r</span><span class="op" id="5178539">.</span><span class="ident" id="5178540">Dx</span><span class="op" id="5178542">(</span><span class="op" id="5178543">)</span><span class="op" id="5178544">,</span>&nbsp;<span class="ident" id="5178546">r</span><span class="op" id="5178547">.</span><span class="ident" id="5178548">Dy</span><span class="op" id="5178550">(</span><span class="op" id="5178551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5178554">d0</span>&nbsp;<span class="op" id="5178557">:=</span>&nbsp;<span class="ident" id="5178560">dst</span><span class="op" id="5178563">.</span><span class="ident" id="5178564">PixOffset</span><span class="op" id="5178573">(</span><span class="ident" id="5178574">r</span><span class="op" id="5178575">.</span><span class="ident" id="5178576">Min</span><span class="op" id="5178579">.</span><span class="ident" id="5178580">X</span><span class="op" id="5178581">,</span>&nbsp;<span class="ident" id="5178583">r</span><span class="op" id="5178584">.</span><span class="ident" id="5178585">Min</span><span class="op" id="5178588">.</span><span class="ident" id="5178589">Y</span><span class="op" id="5178590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5178593">s0</span>&nbsp;<span class="op" id="5178596">:=</span>&nbsp;<span class="ident" id="5178599">src</span><span class="op" id="5178602">.</span><span class="ident" id="5178603">PixOffset</span><span class="op" id="5178612">(</span><span class="ident" id="5178613">sp</span><span class="op" id="5178615">.</span><span class="ident" id="5178616">X</span><span class="op" id="5178617">,</span>&nbsp;<span class="ident" id="5178619">sp</span><span class="op" id="5178621">.</span><span class="ident" id="5178622">Y</span><span class="op" id="5178623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5178626">var</span>&nbsp;<span class="op" id="5178630">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5178634">ddelta</span><span class="op" id="5178640">,</span>&nbsp;<span class="ident" id="5178642">sdelta</span>&nbsp;<span class="builtintype" id="5178649">int</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5178655">i0</span><span class="op" id="5178657">,</span>&nbsp;<span class="ident" id="5178659">i1</span><span class="op" id="5178661">,</span>&nbsp;<span class="ident" id="5178663">idelta</span>&nbsp;<span class="builtintype" id="5178670">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5178675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5178678">if</span>&nbsp;<span class="ident" id="5178681">r</span><span class="op" id="5178682">.</span><span class="ident" id="5178683">Min</span><span class="op" id="5178686">.</span><span class="ident" id="5178687">Y</span>&nbsp;<span class="op" id="5178689">&lt;</span>&nbsp;<span class="ident" id="5178691">sp</span><span class="op" id="5178693">.</span><span class="ident" id="5178694">Y</span>&nbsp;<span class="op" id="5178696">||</span>&nbsp;<span class="ident" id="5178699">r</span><span class="op" id="5178700">.</span><span class="ident" id="5178701">Min</span><span class="op" id="5178704">.</span><span class="ident" id="5178705">Y</span>&nbsp;<span class="op" id="5178707">==</span>&nbsp;<span class="ident" id="5178710">sp</span><span class="op" id="5178712">.</span><span class="ident" id="5178713">Y</span>&nbsp;<span class="op" id="5178715">&amp;&amp;</span>&nbsp;<span class="ident" id="5178718">r</span><span class="op" id="5178719">.</span><span class="ident" id="5178720">Min</span><span class="op" id="5178723">.</span><span class="ident" id="5178724">X</span>&nbsp;<span class="op" id="5178726">&lt;=</span>&nbsp;<span class="ident" id="5178729">sp</span><span class="op" id="5178731">.</span><span class="ident" id="5178732">X</span>&nbsp;<span class="op" id="5178734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5178738">ddelta</span>&nbsp;<span class="op" id="5178745">=</span>&nbsp;<span class="ident" id="5178747">dst</span><span class="op" id="5178750">.</span><span class="ident" id="5178751">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5178760">sdelta</span>&nbsp;<span class="op" id="5178767">=</span>&nbsp;<span class="ident" id="5178769">src</span><span class="op" id="5178772">.</span><span class="ident" id="5178773">Stride</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5178782">i0</span><span class="op" id="5178784">,</span>&nbsp;<span class="ident" id="5178786">i1</span><span class="op" id="5178788">,</span>&nbsp;<span class="ident" id="5178790">idelta</span>&nbsp;<span class="op" id="5178797">=</span>&nbsp;<span class="num" id="5178799">0</span><span class="op" id="5178800">,</span>&nbsp;<span class="ident" id="5178802">dx</span><span class="op" id="5178804">*</span><span class="num" id="5178805">4</span><span class="op" id="5178806">,</span>&nbsp;<span class="op" id="5178808">+</span><span class="num" id="5178809">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5178812">}</span>&nbsp;<span class="keyword" id="5178814">else</span>&nbsp;<span class="op" id="5178819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5178823">//&nbsp;If&nbsp;the&nbsp;source&nbsp;start&nbsp;point&nbsp;is&nbsp;higher&nbsp;than&nbsp;the&nbsp;destination&nbsp;start&nbsp;point,&nbsp;or&nbsp;equal&nbsp;height&nbsp;but&nbsp;to&nbsp;the&nbsp;left,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5178931">//&nbsp;then&nbsp;we&nbsp;compose&nbsp;the&nbsp;rows&nbsp;in&nbsp;right-to-left,&nbsp;bottom-up&nbsp;order&nbsp;instead&nbsp;of&nbsp;left-to-right,&nbsp;top-down.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5179031">d0</span>&nbsp;<span class="op" id="5179034">+=</span>&nbsp;<span class="op" id="5179037">(</span><span class="ident" id="5179038">dy</span>&nbsp;<span class="op" id="5179041">-</span>&nbsp;<span class="num" id="5179043">1</span><span class="op" id="5179044">)</span>&nbsp;<span class="op" id="5179046">*</span>&nbsp;<span class="ident" id="5179048">dst</span><span class="op" id="5179051">.</span><span class="ident" id="5179052">Stride</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5179061">s0</span>&nbsp;<span class="op" id="5179064">+=</span>&nbsp;<span class="op" id="5179067">(</span><span class="ident" id="5179068">dy</span>&nbsp;<span class="op" id="5179071">-</span>&nbsp;<span class="num" id="5179073">1</span><span class="op" id="5179074">)</span>&nbsp;<span class="op" id="5179076">*</span>&nbsp;<span class="ident" id="5179078">src</span><span class="op" id="5179081">.</span><span class="ident" id="5179082">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5179091">ddelta</span>&nbsp;<span class="op" id="5179098">=</span>&nbsp;<span class="op" id="5179100">-</span><span class="ident" id="5179101">dst</span><span class="op" id="5179104">.</span><span class="ident" id="5179105">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5179114">sdelta</span>&nbsp;<span class="op" id="5179121">=</span>&nbsp;<span class="op" id="5179123">-</span><span class="ident" id="5179124">src</span><span class="op" id="5179127">.</span><span class="ident" id="5179128">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5179137">i0</span><span class="op" id="5179139">,</span>&nbsp;<span class="ident" id="5179141">i1</span><span class="op" id="5179143">,</span>&nbsp;<span class="ident" id="5179145">idelta</span>&nbsp;<span class="op" id="5179152">=</span>&nbsp;<span class="op" id="5179154">(</span><span class="ident" id="5179155">dx</span><span class="op" id="5179157">-</span><span class="num" id="5179158">1</span><span class="op" id="5179159">)</span><span class="op" id="5179160">*</span><span class="num" id="5179161">4</span><span class="op" id="5179162">,</span>&nbsp;<span class="op" id="5179164">-</span><span class="num" id="5179165">4</span><span class="op" id="5179166">,</span>&nbsp;<span class="op" id="5179168">-</span><span class="num" id="5179169">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5179172">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5179175">for</span>&nbsp;<span class="op" id="5179179">;</span>&nbsp;<span class="ident" id="5179181">dy</span>&nbsp;<span class="op" id="5179184">&gt;</span>&nbsp;<span class="num" id="5179186">0</span><span class="op" id="5179187">;</span>&nbsp;<span class="ident" id="5179189">dy</span><span class="op" id="5179191">--</span>&nbsp;<span class="op" id="5179194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5179198">dpix</span>&nbsp;<span class="op" id="5179203">:=</span>&nbsp;<span class="ident" id="5179206">dst</span><span class="op" id="5179209">.</span><span class="ident" id="5179210">Pix</span><span class="op" id="5179213">[</span><span class="ident" id="5179214">d0</span><span class="op" id="5179216">:</span><span class="op" id="5179217">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5179221">spix</span>&nbsp;<span class="op" id="5179226">:=</span>&nbsp;<span class="ident" id="5179229">src</span><span class="op" id="5179232">.</span><span class="ident" id="5179233">Pix</span><span class="op" id="5179236">[</span><span class="ident" id="5179237">s0</span><span class="op" id="5179239">:</span><span class="op" id="5179240">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5179244">for</span>&nbsp;<span class="ident" id="5179248">i</span>&nbsp;<span class="op" id="5179250">:=</span>&nbsp;<span class="ident" id="5179253">i0</span><span class="op" id="5179255">;</span>&nbsp;<span class="ident" id="5179257">i</span>&nbsp;<span class="op" id="5179259">!=</span>&nbsp;<span class="ident" id="5179262">i1</span><span class="op" id="5179264">;</span>&nbsp;<span class="ident" id="5179266">i</span>&nbsp;<span class="op" id="5179268">+=</span>&nbsp;<span class="ident" id="5179271">idelta</span>&nbsp;<span class="op" id="5179278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5179283">sr</span>&nbsp;<span class="op" id="5179286">:=</span>&nbsp;<span class="builtintype" id="5179289">uint32</span><span class="op" id="5179295">(</span><span class="ident" id="5179296">spix</span><span class="op" id="5179300">[</span><span class="ident" id="5179301">i</span><span class="op" id="5179302">+</span><span class="num" id="5179303">0</span><span class="op" id="5179304">]</span><span class="op" id="5179305">)</span>&nbsp;<span class="op" id="5179307">*</span>&nbsp;<span class="num" id="5179309">0x101</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5179318">sg</span>&nbsp;<span class="op" id="5179321">:=</span>&nbsp;<span class="builtintype" id="5179324">uint32</span><span class="op" id="5179330">(</span><span class="ident" id="5179331">spix</span><span class="op" id="5179335">[</span><span class="ident" id="5179336">i</span><span class="op" id="5179337">+</span><span class="num" id="5179338">1</span><span class="op" id="5179339">]</span><span class="op" id="5179340">)</span>&nbsp;<span class="op" id="5179342">*</span>&nbsp;<span class="num" id="5179344">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5179353">sb</span>&nbsp;<span class="op" id="5179356">:=</span>&nbsp;<span class="builtintype" id="5179359">uint32</span><span class="op" id="5179365">(</span><span class="ident" id="5179366">spix</span><span class="op" id="5179370">[</span><span class="ident" id="5179371">i</span><span class="op" id="5179372">+</span><span class="num" id="5179373">2</span><span class="op" id="5179374">]</span><span class="op" id="5179375">)</span>&nbsp;<span class="op" id="5179377">*</span>&nbsp;<span class="num" id="5179379">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5179388">sa</span>&nbsp;<span class="op" id="5179391">:=</span>&nbsp;<span class="builtintype" id="5179394">uint32</span><span class="op" id="5179400">(</span><span class="ident" id="5179401">spix</span><span class="op" id="5179405">[</span><span class="ident" id="5179406">i</span><span class="op" id="5179407">+</span><span class="num" id="5179408">3</span><span class="op" id="5179409">]</span><span class="op" id="5179410">)</span>&nbsp;<span class="op" id="5179412">*</span>&nbsp;<span class="num" id="5179414">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5179424">dr</span>&nbsp;<span class="op" id="5179427">:=</span>&nbsp;<span class="builtintype" id="5179430">uint32</span><span class="op" id="5179436">(</span><span class="ident" id="5179437">dpix</span><span class="op" id="5179441">[</span><span class="ident" id="5179442">i</span><span class="op" id="5179443">+</span><span class="num" id="5179444">0</span><span class="op" id="5179445">]</span><span class="op" id="5179446">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5179451">dg</span>&nbsp;<span class="op" id="5179454">:=</span>&nbsp;<span class="builtintype" id="5179457">uint32</span><span class="op" id="5179463">(</span><span class="ident" id="5179464">dpix</span><span class="op" id="5179468">[</span><span class="ident" id="5179469">i</span><span class="op" id="5179470">+</span><span class="num" id="5179471">1</span><span class="op" id="5179472">]</span><span class="op" id="5179473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5179478">db</span>&nbsp;<span class="op" id="5179481">:=</span>&nbsp;<span class="builtintype" id="5179484">uint32</span><span class="op" id="5179490">(</span><span class="ident" id="5179491">dpix</span><span class="op" id="5179495">[</span><span class="ident" id="5179496">i</span><span class="op" id="5179497">+</span><span class="num" id="5179498">2</span><span class="op" id="5179499">]</span><span class="op" id="5179500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5179505">da</span>&nbsp;<span class="op" id="5179508">:=</span>&nbsp;<span class="builtintype" id="5179511">uint32</span><span class="op" id="5179517">(</span><span class="ident" id="5179518">dpix</span><span class="op" id="5179522">[</span><span class="ident" id="5179523">i</span><span class="op" id="5179524">+</span><span class="num" id="5179525">3</span><span class="op" id="5179526">]</span><span class="op" id="5179527">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5179533">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5179593">a</span>&nbsp;<span class="op" id="5179595">:=</span>&nbsp;<span class="op" id="5179598">(</span><span class="ident" id="5179599">m</span>&nbsp;<span class="op" id="5179601">-</span>&nbsp;<span class="ident" id="5179603">sa</span><span class="op" id="5179605">)</span>&nbsp;<span class="op" id="5179607">*</span>&nbsp;<span class="num" id="5179609">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5179619">dpix</span><span class="op" id="5179623">[</span><span class="ident" id="5179624">i</span><span class="op" id="5179625">+</span><span class="num" id="5179626">0</span><span class="op" id="5179627">]</span>&nbsp;<span class="op" id="5179629">=</span>&nbsp;<span class="builtintype" id="5179631">uint8</span><span class="op" id="5179636">(</span><span class="op" id="5179637">(</span><span class="ident" id="5179638">dr</span><span class="op" id="5179640">*</span><span class="ident" id="5179641">a</span><span class="op" id="5179642">/</span><span class="ident" id="5179643">m</span>&nbsp;<span class="op" id="5179645">+</span>&nbsp;<span class="ident" id="5179647">sr</span><span class="op" id="5179649">)</span>&nbsp;<span class="op" id="5179651">&gt;&gt;</span>&nbsp;<span class="num" id="5179654">8</span><span class="op" id="5179655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5179660">dpix</span><span class="op" id="5179664">[</span><span class="ident" id="5179665">i</span><span class="op" id="5179666">+</span><span class="num" id="5179667">1</span><span class="op" id="5179668">]</span>&nbsp;<span class="op" id="5179670">=</span>&nbsp;<span class="builtintype" id="5179672">uint8</span><span class="op" id="5179677">(</span><span class="op" id="5179678">(</span><span class="ident" id="5179679">dg</span><span class="op" id="5179681">*</span><span class="ident" id="5179682">a</span><span class="op" id="5179683">/</span><span class="ident" id="5179684">m</span>&nbsp;<span class="op" id="5179686">+</span>&nbsp;<span class="ident" id="5179688">sg</span><span class="op" id="5179690">)</span>&nbsp;<span class="op" id="5179692">&gt;&gt;</span>&nbsp;<span class="num" id="5179695">8</span><span class="op" id="5179696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5179701">dpix</span><span class="op" id="5179705">[</span><span class="ident" id="5179706">i</span><span class="op" id="5179707">+</span><span class="num" id="5179708">2</span><span class="op" id="5179709">]</span>&nbsp;<span class="op" id="5179711">=</span>&nbsp;<span class="builtintype" id="5179713">uint8</span><span class="op" id="5179718">(</span><span class="op" id="5179719">(</span><span class="ident" id="5179720">db</span><span class="op" id="5179722">*</span><span class="ident" id="5179723">a</span><span class="op" id="5179724">/</span><span class="ident" id="5179725">m</span>&nbsp;<span class="op" id="5179727">+</span>&nbsp;<span class="ident" id="5179729">sb</span><span class="op" id="5179731">)</span>&nbsp;<span class="op" id="5179733">&gt;&gt;</span>&nbsp;<span class="num" id="5179736">8</span><span class="op" id="5179737">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5179742">dpix</span><span class="op" id="5179746">[</span><span class="ident" id="5179747">i</span><span class="op" id="5179748">+</span><span class="num" id="5179749">3</span><span class="op" id="5179750">]</span>&nbsp;<span class="op" id="5179752">=</span>&nbsp;<span class="builtintype" id="5179754">uint8</span><span class="op" id="5179759">(</span><span class="op" id="5179760">(</span><span class="ident" id="5179761">da</span><span class="op" id="5179763">*</span><span class="ident" id="5179764">a</span><span class="op" id="5179765">/</span><span class="ident" id="5179766">m</span>&nbsp;<span class="op" id="5179768">+</span>&nbsp;<span class="ident" id="5179770">sa</span><span class="op" id="5179772">)</span>&nbsp;<span class="op" id="5179774">&gt;&gt;</span>&nbsp;<span class="num" id="5179777">8</span><span class="op" id="5179778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5179782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5179786">d0</span>&nbsp;<span class="op" id="5179789">+=</span>&nbsp;<span class="ident" id="5179792">ddelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5179801">s0</span>&nbsp;<span class="op" id="5179804">+=</span>&nbsp;<span class="ident" id="5179807">sdelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5179815">}</span><br>
<span class="lineno">305</span><span class="op" id="5179817">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5179820">func</span>&nbsp;<span class="ident" id="5179825">drawCopySrc</span><span class="op" id="5179836">(</span><span class="ident" id="5179837">dst</span>&nbsp;<span class="op" id="5179841">*</span><span class="ident" id="5179842">image</span><span class="op" id="5179847">.</span><span class="ident" id="5179848">RGBA</span><span class="op" id="5179852">,</span>&nbsp;<span class="ident" id="5179854">r</span>&nbsp;<span class="ident" id="5179856">image</span><span class="op" id="5179861">.</span><span class="ident" id="5179862">Rectangle</span><span class="op" id="5179871">,</span>&nbsp;<span class="ident" id="5179873">src</span>&nbsp;<span class="op" id="5179877">*</span><span class="ident" id="5179878">image</span><span class="op" id="5179883">.</span><span class="ident" id="5179884">RGBA</span><span class="op" id="5179888">,</span>&nbsp;<span class="ident" id="5179890">sp</span>&nbsp;<span class="ident" id="5179893">image</span><span class="op" id="5179898">.</span><span class="ident" id="5179899">Point</span><span class="op" id="5179904">)</span>&nbsp;<span class="op" id="5179906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5179909">n</span><span class="op" id="5179910">,</span>&nbsp;<span class="ident" id="5179912">dy</span>&nbsp;<span class="op" id="5179915">:=</span>&nbsp;<span class="num" id="5179918">4</span><span class="op" id="5179919">*</span><span class="ident" id="5179920">r</span><span class="op" id="5179921">.</span><span class="ident" id="5179922">Dx</span><span class="op" id="5179924">(</span><span class="op" id="5179925">)</span><span class="op" id="5179926">,</span>&nbsp;<span class="ident" id="5179928">r</span><span class="op" id="5179929">.</span><span class="ident" id="5179930">Dy</span><span class="op" id="5179932">(</span><span class="op" id="5179933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5179936">d0</span>&nbsp;<span class="op" id="5179939">:=</span>&nbsp;<span class="ident" id="5179942">dst</span><span class="op" id="5179945">.</span><span class="ident" id="5179946">PixOffset</span><span class="op" id="5179955">(</span><span class="ident" id="5179956">r</span><span class="op" id="5179957">.</span><span class="ident" id="5179958">Min</span><span class="op" id="5179961">.</span><span class="ident" id="5179962">X</span><span class="op" id="5179963">,</span>&nbsp;<span class="ident" id="5179965">r</span><span class="op" id="5179966">.</span><span class="ident" id="5179967">Min</span><span class="op" id="5179970">.</span><span class="ident" id="5179971">Y</span><span class="op" id="5179972">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5179975">s0</span>&nbsp;<span class="op" id="5179978">:=</span>&nbsp;<span class="ident" id="5179981">src</span><span class="op" id="5179984">.</span><span class="ident" id="5179985">PixOffset</span><span class="op" id="5179994">(</span><span class="ident" id="5179995">sp</span><span class="op" id="5179997">.</span><span class="ident" id="5179998">X</span><span class="op" id="5179999">,</span>&nbsp;<span class="ident" id="5180001">sp</span><span class="op" id="5180003">.</span><span class="ident" id="5180004">Y</span><span class="op" id="5180005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5180008">var</span>&nbsp;<span class="ident" id="5180012">ddelta</span><span class="op" id="5180018">,</span>&nbsp;<span class="ident" id="5180020">sdelta</span>&nbsp;<span class="builtintype" id="5180027">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5180032">if</span>&nbsp;<span class="ident" id="5180035">r</span><span class="op" id="5180036">.</span><span class="ident" id="5180037">Min</span><span class="op" id="5180040">.</span><span class="ident" id="5180041">Y</span>&nbsp;<span class="op" id="5180043">&lt;=</span>&nbsp;<span class="ident" id="5180046">sp</span><span class="op" id="5180048">.</span><span class="ident" id="5180049">Y</span>&nbsp;<span class="op" id="5180051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5180055">ddelta</span>&nbsp;<span class="op" id="5180062">=</span>&nbsp;<span class="ident" id="5180064">dst</span><span class="op" id="5180067">.</span><span class="ident" id="5180068">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5180077">sdelta</span>&nbsp;<span class="op" id="5180084">=</span>&nbsp;<span class="ident" id="5180086">src</span><span class="op" id="5180089">.</span><span class="ident" id="5180090">Stride</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5180098">}</span>&nbsp;<span class="keyword" id="5180100">else</span>&nbsp;<span class="op" id="5180105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5180109">//&nbsp;If&nbsp;the&nbsp;source&nbsp;start&nbsp;point&nbsp;is&nbsp;higher&nbsp;than&nbsp;the&nbsp;destination&nbsp;start&nbsp;point,&nbsp;then&nbsp;we&nbsp;compose&nbsp;the&nbsp;rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5180209">//&nbsp;in&nbsp;bottom-up&nbsp;order&nbsp;instead&nbsp;of&nbsp;top-down.&nbsp;Unlike&nbsp;the&nbsp;drawCopyOver&nbsp;function,&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5180305">//&nbsp;check&nbsp;the&nbsp;x&nbsp;co-ordinates&nbsp;because&nbsp;the&nbsp;built-in&nbsp;copy&nbsp;function&nbsp;can&nbsp;handle&nbsp;overlapping&nbsp;slices.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5180401">d0</span>&nbsp;<span class="op" id="5180404">+=</span>&nbsp;<span class="op" id="5180407">(</span><span class="ident" id="5180408">dy</span>&nbsp;<span class="op" id="5180411">-</span>&nbsp;<span class="num" id="5180413">1</span><span class="op" id="5180414">)</span>&nbsp;<span class="op" id="5180416">*</span>&nbsp;<span class="ident" id="5180418">dst</span><span class="op" id="5180421">.</span><span class="ident" id="5180422">Stride</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5180431">s0</span>&nbsp;<span class="op" id="5180434">+=</span>&nbsp;<span class="op" id="5180437">(</span><span class="ident" id="5180438">dy</span>&nbsp;<span class="op" id="5180441">-</span>&nbsp;<span class="num" id="5180443">1</span><span class="op" id="5180444">)</span>&nbsp;<span class="op" id="5180446">*</span>&nbsp;<span class="ident" id="5180448">src</span><span class="op" id="5180451">.</span><span class="ident" id="5180452">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5180461">ddelta</span>&nbsp;<span class="op" id="5180468">=</span>&nbsp;<span class="op" id="5180470">-</span><span class="ident" id="5180471">dst</span><span class="op" id="5180474">.</span><span class="ident" id="5180475">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5180484">sdelta</span>&nbsp;<span class="op" id="5180491">=</span>&nbsp;<span class="op" id="5180493">-</span><span class="ident" id="5180494">src</span><span class="op" id="5180497">.</span><span class="ident" id="5180498">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5180506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5180509">for</span>&nbsp;<span class="op" id="5180513">;</span>&nbsp;<span class="ident" id="5180515">dy</span>&nbsp;<span class="op" id="5180518">&gt;</span>&nbsp;<span class="num" id="5180520">0</span><span class="op" id="5180521">;</span>&nbsp;<span class="ident" id="5180523">dy</span><span class="op" id="5180525">--</span>&nbsp;<span class="op" id="5180528">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5180532">copy</span><span class="op" id="5180536">(</span><span class="ident" id="5180537">dst</span><span class="op" id="5180540">.</span><span class="ident" id="5180541">Pix</span><span class="op" id="5180544">[</span><span class="ident" id="5180545">d0</span><span class="op" id="5180547">:</span><span class="ident" id="5180548">d0</span><span class="op" id="5180550">+</span><span class="ident" id="5180551">n</span><span class="op" id="5180552">]</span><span class="op" id="5180553">,</span>&nbsp;<span class="ident" id="5180555">src</span><span class="op" id="5180558">.</span><span class="ident" id="5180559">Pix</span><span class="op" id="5180562">[</span><span class="ident" id="5180563">s0</span><span class="op" id="5180565">:</span><span class="ident" id="5180566">s0</span><span class="op" id="5180568">+</span><span class="ident" id="5180569">n</span><span class="op" id="5180570">]</span><span class="op" id="5180571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5180575">d0</span>&nbsp;<span class="op" id="5180578">+=</span>&nbsp;<span class="ident" id="5180581">ddelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5180590">s0</span>&nbsp;<span class="op" id="5180593">+=</span>&nbsp;<span class="ident" id="5180596">sdelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5180604">}</span><br>
<span class="lineno"></span><span class="op" id="5180606">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span><span class="keyword" id="5180609">func</span>&nbsp;<span class="ident" id="5180614">drawNRGBAOver</span><span class="op" id="5180627">(</span><span class="ident" id="5180628">dst</span>&nbsp;<span class="op" id="5180632">*</span><span class="ident" id="5180633">image</span><span class="op" id="5180638">.</span><span class="ident" id="5180639">RGBA</span><span class="op" id="5180643">,</span>&nbsp;<span class="ident" id="5180645">r</span>&nbsp;<span class="ident" id="5180647">image</span><span class="op" id="5180652">.</span><span class="ident" id="5180653">Rectangle</span><span class="op" id="5180662">,</span>&nbsp;<span class="ident" id="5180664">src</span>&nbsp;<span class="op" id="5180668">*</span><span class="ident" id="5180669">image</span><span class="op" id="5180674">.</span><span class="ident" id="5180675">NRGBA</span><span class="op" id="5180680">,</span>&nbsp;<span class="ident" id="5180682">sp</span>&nbsp;<span class="ident" id="5180685">image</span><span class="op" id="5180690">.</span><span class="ident" id="5180691">Point</span><span class="op" id="5180696">)</span>&nbsp;<span class="op" id="5180698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5180701">i0</span>&nbsp;<span class="op" id="5180704">:=</span>&nbsp;<span class="op" id="5180707">(</span><span class="ident" id="5180708">r</span><span class="op" id="5180709">.</span><span class="ident" id="5180710">Min</span><span class="op" id="5180713">.</span><span class="ident" id="5180714">X</span>&nbsp;<span class="op" id="5180716">-</span>&nbsp;<span class="ident" id="5180718">dst</span><span class="op" id="5180721">.</span><span class="ident" id="5180722">Rect</span><span class="op" id="5180726">.</span><span class="ident" id="5180727">Min</span><span class="op" id="5180730">.</span><span class="ident" id="5180731">X</span><span class="op" id="5180732">)</span>&nbsp;<span class="op" id="5180734">*</span>&nbsp;<span class="num" id="5180736">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5180739">i1</span>&nbsp;<span class="op" id="5180742">:=</span>&nbsp;<span class="op" id="5180745">(</span><span class="ident" id="5180746">r</span><span class="op" id="5180747">.</span><span class="ident" id="5180748">Max</span><span class="op" id="5180751">.</span><span class="ident" id="5180752">X</span>&nbsp;<span class="op" id="5180754">-</span>&nbsp;<span class="ident" id="5180756">dst</span><span class="op" id="5180759">.</span><span class="ident" id="5180760">Rect</span><span class="op" id="5180764">.</span><span class="ident" id="5180765">Min</span><span class="op" id="5180768">.</span><span class="ident" id="5180769">X</span><span class="op" id="5180770">)</span>&nbsp;<span class="op" id="5180772">*</span>&nbsp;<span class="num" id="5180774">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5180777">si0</span>&nbsp;<span class="op" id="5180781">:=</span>&nbsp;<span class="op" id="5180784">(</span><span class="ident" id="5180785">sp</span><span class="op" id="5180787">.</span><span class="ident" id="5180788">X</span>&nbsp;<span class="op" id="5180790">-</span>&nbsp;<span class="ident" id="5180792">src</span><span class="op" id="5180795">.</span><span class="ident" id="5180796">Rect</span><span class="op" id="5180800">.</span><span class="ident" id="5180801">Min</span><span class="op" id="5180804">.</span><span class="ident" id="5180805">X</span><span class="op" id="5180806">)</span>&nbsp;<span class="op" id="5180808">*</span>&nbsp;<span class="num" id="5180810">4</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5180813">yMax</span>&nbsp;<span class="op" id="5180818">:=</span>&nbsp;<span class="ident" id="5180821">r</span><span class="op" id="5180822">.</span><span class="ident" id="5180823">Max</span><span class="op" id="5180826">.</span><span class="ident" id="5180827">Y</span>&nbsp;<span class="op" id="5180829">-</span>&nbsp;<span class="ident" id="5180831">dst</span><span class="op" id="5180834">.</span><span class="ident" id="5180835">Rect</span><span class="op" id="5180839">.</span><span class="ident" id="5180840">Min</span><span class="op" id="5180843">.</span><span class="ident" id="5180844">Y</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5180848">y</span>&nbsp;<span class="op" id="5180850">:=</span>&nbsp;<span class="ident" id="5180853">r</span><span class="op" id="5180854">.</span><span class="ident" id="5180855">Min</span><span class="op" id="5180858">.</span><span class="ident" id="5180859">Y</span>&nbsp;<span class="op" id="5180861">-</span>&nbsp;<span class="ident" id="5180863">dst</span><span class="op" id="5180866">.</span><span class="ident" id="5180867">Rect</span><span class="op" id="5180871">.</span><span class="ident" id="5180872">Min</span><span class="op" id="5180875">.</span><span class="ident" id="5180876">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5180879">sy</span>&nbsp;<span class="op" id="5180882">:=</span>&nbsp;<span class="ident" id="5180885">sp</span><span class="op" id="5180887">.</span><span class="ident" id="5180888">Y</span>&nbsp;<span class="op" id="5180890">-</span>&nbsp;<span class="ident" id="5180892">src</span><span class="op" id="5180895">.</span><span class="ident" id="5180896">Rect</span><span class="op" id="5180900">.</span><span class="ident" id="5180901">Min</span><span class="op" id="5180904">.</span><span class="ident" id="5180905">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5180908">for</span>&nbsp;<span class="op" id="5180912">;</span>&nbsp;<span class="ident" id="5180914">y</span>&nbsp;<span class="op" id="5180916">!=</span>&nbsp;<span class="ident" id="5180919">yMax</span><span class="op" id="5180923">;</span>&nbsp;<span class="ident" id="5180925">y</span><span class="op" id="5180926">,</span>&nbsp;<span class="ident" id="5180928">sy</span>&nbsp;<span class="op" id="5180931">=</span>&nbsp;<span class="ident" id="5180933">y</span><span class="op" id="5180934">+</span><span class="num" id="5180935">1</span><span class="op" id="5180936">,</span>&nbsp;<span class="ident" id="5180938">sy</span><span class="op" id="5180940">+</span><span class="num" id="5180941">1</span>&nbsp;<span class="op" id="5180943">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5180947">dpix</span>&nbsp;<span class="op" id="5180952">:=</span>&nbsp;<span class="ident" id="5180955">dst</span><span class="op" id="5180958">.</span><span class="ident" id="5180959">Pix</span><span class="op" id="5180962">[</span><span class="ident" id="5180963">y</span><span class="op" id="5180964">*</span><span class="ident" id="5180965">dst</span><span class="op" id="5180968">.</span><span class="ident" id="5180969">Stride</span><span class="op" id="5180975">:</span><span class="op" id="5180976">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5180980">spix</span>&nbsp;<span class="op" id="5180985">:=</span>&nbsp;<span class="ident" id="5180988">src</span><span class="op" id="5180991">.</span><span class="ident" id="5180992">Pix</span><span class="op" id="5180995">[</span><span class="ident" id="5180996">sy</span><span class="op" id="5180998">*</span><span class="ident" id="5180999">src</span><span class="op" id="5181002">.</span><span class="ident" id="5181003">Stride</span><span class="op" id="5181009">:</span><span class="op" id="5181010">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5181015">for</span>&nbsp;<span class="ident" id="5181019">i</span><span class="op" id="5181020">,</span>&nbsp;<span class="ident" id="5181022">si</span>&nbsp;<span class="op" id="5181025">:=</span>&nbsp;<span class="ident" id="5181028">i0</span><span class="op" id="5181030">,</span>&nbsp;<span class="ident" id="5181032">si0</span><span class="op" id="5181035">;</span>&nbsp;<span class="ident" id="5181037">i</span>&nbsp;<span class="op" id="5181039">&lt;</span>&nbsp;<span class="ident" id="5181041">i1</span><span class="op" id="5181043">;</span>&nbsp;<span class="ident" id="5181045">i</span><span class="op" id="5181046">,</span>&nbsp;<span class="ident" id="5181048">si</span>&nbsp;<span class="op" id="5181051">=</span>&nbsp;<span class="ident" id="5181053">i</span><span class="op" id="5181054">+</span><span class="num" id="5181055">4</span><span class="op" id="5181056">,</span>&nbsp;<span class="ident" id="5181058">si</span><span class="op" id="5181060">+</span><span class="num" id="5181061">4</span>&nbsp;<span class="op" id="5181063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5181068">//&nbsp;Convert&nbsp;from&nbsp;non-premultiplied&nbsp;color&nbsp;to&nbsp;pre-multiplied&nbsp;color.</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5181136">sa</span>&nbsp;<span class="op" id="5181139">:=</span>&nbsp;<span class="builtintype" id="5181142">uint32</span><span class="op" id="5181148">(</span><span class="ident" id="5181149">spix</span><span class="op" id="5181153">[</span><span class="ident" id="5181154">si</span><span class="op" id="5181156">+</span><span class="num" id="5181157">3</span><span class="op" id="5181158">]</span><span class="op" id="5181159">)</span>&nbsp;<span class="op" id="5181161">*</span>&nbsp;<span class="num" id="5181163">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5181172">sr</span>&nbsp;<span class="op" id="5181175">:=</span>&nbsp;<span class="builtintype" id="5181178">uint32</span><span class="op" id="5181184">(</span><span class="ident" id="5181185">spix</span><span class="op" id="5181189">[</span><span class="ident" id="5181190">si</span><span class="op" id="5181192">+</span><span class="num" id="5181193">0</span><span class="op" id="5181194">]</span><span class="op" id="5181195">)</span>&nbsp;<span class="op" id="5181197">*</span>&nbsp;<span class="ident" id="5181199">sa</span>&nbsp;<span class="op" id="5181202">/</span>&nbsp;<span class="num" id="5181204">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5181212">sg</span>&nbsp;<span class="op" id="5181215">:=</span>&nbsp;<span class="builtintype" id="5181218">uint32</span><span class="op" id="5181224">(</span><span class="ident" id="5181225">spix</span><span class="op" id="5181229">[</span><span class="ident" id="5181230">si</span><span class="op" id="5181232">+</span><span class="num" id="5181233">1</span><span class="op" id="5181234">]</span><span class="op" id="5181235">)</span>&nbsp;<span class="op" id="5181237">*</span>&nbsp;<span class="ident" id="5181239">sa</span>&nbsp;<span class="op" id="5181242">/</span>&nbsp;<span class="num" id="5181244">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5181252">sb</span>&nbsp;<span class="op" id="5181255">:=</span>&nbsp;<span class="builtintype" id="5181258">uint32</span><span class="op" id="5181264">(</span><span class="ident" id="5181265">spix</span><span class="op" id="5181269">[</span><span class="ident" id="5181270">si</span><span class="op" id="5181272">+</span><span class="num" id="5181273">2</span><span class="op" id="5181274">]</span><span class="op" id="5181275">)</span>&nbsp;<span class="op" id="5181277">*</span>&nbsp;<span class="ident" id="5181279">sa</span>&nbsp;<span class="op" id="5181282">/</span>&nbsp;<span class="num" id="5181284">0xff</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5181293">dr</span>&nbsp;<span class="op" id="5181296">:=</span>&nbsp;<span class="builtintype" id="5181299">uint32</span><span class="op" id="5181305">(</span><span class="ident" id="5181306">dpix</span><span class="op" id="5181310">[</span><span class="ident" id="5181311">i</span><span class="op" id="5181312">+</span><span class="num" id="5181313">0</span><span class="op" id="5181314">]</span><span class="op" id="5181315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5181320">dg</span>&nbsp;<span class="op" id="5181323">:=</span>&nbsp;<span class="builtintype" id="5181326">uint32</span><span class="op" id="5181332">(</span><span class="ident" id="5181333">dpix</span><span class="op" id="5181337">[</span><span class="ident" id="5181338">i</span><span class="op" id="5181339">+</span><span class="num" id="5181340">1</span><span class="op" id="5181341">]</span><span class="op" id="5181342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5181347">db</span>&nbsp;<span class="op" id="5181350">:=</span>&nbsp;<span class="builtintype" id="5181353">uint32</span><span class="op" id="5181359">(</span><span class="ident" id="5181360">dpix</span><span class="op" id="5181364">[</span><span class="ident" id="5181365">i</span><span class="op" id="5181366">+</span><span class="num" id="5181367">2</span><span class="op" id="5181368">]</span><span class="op" id="5181369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5181374">da</span>&nbsp;<span class="op" id="5181377">:=</span>&nbsp;<span class="builtintype" id="5181380">uint32</span><span class="op" id="5181386">(</span><span class="ident" id="5181387">dpix</span><span class="op" id="5181391">[</span><span class="ident" id="5181392">i</span><span class="op" id="5181393">+</span><span class="num" id="5181394">3</span><span class="op" id="5181395">]</span><span class="op" id="5181396">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5181402">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5181462">a</span>&nbsp;<span class="op" id="5181464">:=</span>&nbsp;<span class="op" id="5181467">(</span><span class="ident" id="5181468">m</span>&nbsp;<span class="op" id="5181470">-</span>&nbsp;<span class="ident" id="5181472">sa</span><span class="op" id="5181474">)</span>&nbsp;<span class="op" id="5181476">*</span>&nbsp;<span class="num" id="5181478">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5181488">dpix</span><span class="op" id="5181492">[</span><span class="ident" id="5181493">i</span><span class="op" id="5181494">+</span><span class="num" id="5181495">0</span><span class="op" id="5181496">]</span>&nbsp;<span class="op" id="5181498">=</span>&nbsp;<span class="builtintype" id="5181500">uint8</span><span class="op" id="5181505">(</span><span class="op" id="5181506">(</span><span class="ident" id="5181507">dr</span><span class="op" id="5181509">*</span><span class="ident" id="5181510">a</span><span class="op" id="5181511">/</span><span class="ident" id="5181512">m</span>&nbsp;<span class="op" id="5181514">+</span>&nbsp;<span class="ident" id="5181516">sr</span><span class="op" id="5181518">)</span>&nbsp;<span class="op" id="5181520">&gt;&gt;</span>&nbsp;<span class="num" id="5181523">8</span><span class="op" id="5181524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5181529">dpix</span><span class="op" id="5181533">[</span><span class="ident" id="5181534">i</span><span class="op" id="5181535">+</span><span class="num" id="5181536">1</span><span class="op" id="5181537">]</span>&nbsp;<span class="op" id="5181539">=</span>&nbsp;<span class="builtintype" id="5181541">uint8</span><span class="op" id="5181546">(</span><span class="op" id="5181547">(</span><span class="ident" id="5181548">dg</span><span class="op" id="5181550">*</span><span class="ident" id="5181551">a</span><span class="op" id="5181552">/</span><span class="ident" id="5181553">m</span>&nbsp;<span class="op" id="5181555">+</span>&nbsp;<span class="ident" id="5181557">sg</span><span class="op" id="5181559">)</span>&nbsp;<span class="op" id="5181561">&gt;&gt;</span>&nbsp;<span class="num" id="5181564">8</span><span class="op" id="5181565">)</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5181570">dpix</span><span class="op" id="5181574">[</span><span class="ident" id="5181575">i</span><span class="op" id="5181576">+</span><span class="num" id="5181577">2</span><span class="op" id="5181578">]</span>&nbsp;<span class="op" id="5181580">=</span>&nbsp;<span class="builtintype" id="5181582">uint8</span><span class="op" id="5181587">(</span><span class="op" id="5181588">(</span><span class="ident" id="5181589">db</span><span class="op" id="5181591">*</span><span class="ident" id="5181592">a</span><span class="op" id="5181593">/</span><span class="ident" id="5181594">m</span>&nbsp;<span class="op" id="5181596">+</span>&nbsp;<span class="ident" id="5181598">sb</span><span class="op" id="5181600">)</span>&nbsp;<span class="op" id="5181602">&gt;&gt;</span>&nbsp;<span class="num" id="5181605">8</span><span class="op" id="5181606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5181611">dpix</span><span class="op" id="5181615">[</span><span class="ident" id="5181616">i</span><span class="op" id="5181617">+</span><span class="num" id="5181618">3</span><span class="op" id="5181619">]</span>&nbsp;<span class="op" id="5181621">=</span>&nbsp;<span class="builtintype" id="5181623">uint8</span><span class="op" id="5181628">(</span><span class="op" id="5181629">(</span><span class="ident" id="5181630">da</span><span class="op" id="5181632">*</span><span class="ident" id="5181633">a</span><span class="op" id="5181634">/</span><span class="ident" id="5181635">m</span>&nbsp;<span class="op" id="5181637">+</span>&nbsp;<span class="ident" id="5181639">sa</span><span class="op" id="5181641">)</span>&nbsp;<span class="op" id="5181643">&gt;&gt;</span>&nbsp;<span class="num" id="5181646">8</span><span class="op" id="5181647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5181651">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5181654">}</span><br>
<span class="lineno"></span><span class="op" id="5181656">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span><span class="keyword" id="5181659">func</span>&nbsp;<span class="ident" id="5181664">drawNRGBASrc</span><span class="op" id="5181676">(</span><span class="ident" id="5181677">dst</span>&nbsp;<span class="op" id="5181681">*</span><span class="ident" id="5181682">image</span><span class="op" id="5181687">.</span><span class="ident" id="5181688">RGBA</span><span class="op" id="5181692">,</span>&nbsp;<span class="ident" id="5181694">r</span>&nbsp;<span class="ident" id="5181696">image</span><span class="op" id="5181701">.</span><span class="ident" id="5181702">Rectangle</span><span class="op" id="5181711">,</span>&nbsp;<span class="ident" id="5181713">src</span>&nbsp;<span class="op" id="5181717">*</span><span class="ident" id="5181718">image</span><span class="op" id="5181723">.</span><span class="ident" id="5181724">NRGBA</span><span class="op" id="5181729">,</span>&nbsp;<span class="ident" id="5181731">sp</span>&nbsp;<span class="ident" id="5181734">image</span><span class="op" id="5181739">.</span><span class="ident" id="5181740">Point</span><span class="op" id="5181745">)</span>&nbsp;<span class="op" id="5181747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5181750">i0</span>&nbsp;<span class="op" id="5181753">:=</span>&nbsp;<span class="op" id="5181756">(</span><span class="ident" id="5181757">r</span><span class="op" id="5181758">.</span><span class="ident" id="5181759">Min</span><span class="op" id="5181762">.</span><span class="ident" id="5181763">X</span>&nbsp;<span class="op" id="5181765">-</span>&nbsp;<span class="ident" id="5181767">dst</span><span class="op" id="5181770">.</span><span class="ident" id="5181771">Rect</span><span class="op" id="5181775">.</span><span class="ident" id="5181776">Min</span><span class="op" id="5181779">.</span><span class="ident" id="5181780">X</span><span class="op" id="5181781">)</span>&nbsp;<span class="op" id="5181783">*</span>&nbsp;<span class="num" id="5181785">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5181788">i1</span>&nbsp;<span class="op" id="5181791">:=</span>&nbsp;<span class="op" id="5181794">(</span><span class="ident" id="5181795">r</span><span class="op" id="5181796">.</span><span class="ident" id="5181797">Max</span><span class="op" id="5181800">.</span><span class="ident" id="5181801">X</span>&nbsp;<span class="op" id="5181803">-</span>&nbsp;<span class="ident" id="5181805">dst</span><span class="op" id="5181808">.</span><span class="ident" id="5181809">Rect</span><span class="op" id="5181813">.</span><span class="ident" id="5181814">Min</span><span class="op" id="5181817">.</span><span class="ident" id="5181818">X</span><span class="op" id="5181819">)</span>&nbsp;<span class="op" id="5181821">*</span>&nbsp;<span class="num" id="5181823">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5181826">si0</span>&nbsp;<span class="op" id="5181830">:=</span>&nbsp;<span class="op" id="5181833">(</span><span class="ident" id="5181834">sp</span><span class="op" id="5181836">.</span><span class="ident" id="5181837">X</span>&nbsp;<span class="op" id="5181839">-</span>&nbsp;<span class="ident" id="5181841">src</span><span class="op" id="5181844">.</span><span class="ident" id="5181845">Rect</span><span class="op" id="5181849">.</span><span class="ident" id="5181850">Min</span><span class="op" id="5181853">.</span><span class="ident" id="5181854">X</span><span class="op" id="5181855">)</span>&nbsp;<span class="op" id="5181857">*</span>&nbsp;<span class="num" id="5181859">4</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5181862">yMax</span>&nbsp;<span class="op" id="5181867">:=</span>&nbsp;<span class="ident" id="5181870">r</span><span class="op" id="5181871">.</span><span class="ident" id="5181872">Max</span><span class="op" id="5181875">.</span><span class="ident" id="5181876">Y</span>&nbsp;<span class="op" id="5181878">-</span>&nbsp;<span class="ident" id="5181880">dst</span><span class="op" id="5181883">.</span><span class="ident" id="5181884">Rect</span><span class="op" id="5181888">.</span><span class="ident" id="5181889">Min</span><span class="op" id="5181892">.</span><span class="ident" id="5181893">Y</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5181897">y</span>&nbsp;<span class="op" id="5181899">:=</span>&nbsp;<span class="ident" id="5181902">r</span><span class="op" id="5181903">.</span><span class="ident" id="5181904">Min</span><span class="op" id="5181907">.</span><span class="ident" id="5181908">Y</span>&nbsp;<span class="op" id="5181910">-</span>&nbsp;<span class="ident" id="5181912">dst</span><span class="op" id="5181915">.</span><span class="ident" id="5181916">Rect</span><span class="op" id="5181920">.</span><span class="ident" id="5181921">Min</span><span class="op" id="5181924">.</span><span class="ident" id="5181925">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5181928">sy</span>&nbsp;<span class="op" id="5181931">:=</span>&nbsp;<span class="ident" id="5181934">sp</span><span class="op" id="5181936">.</span><span class="ident" id="5181937">Y</span>&nbsp;<span class="op" id="5181939">-</span>&nbsp;<span class="ident" id="5181941">src</span><span class="op" id="5181944">.</span><span class="ident" id="5181945">Rect</span><span class="op" id="5181949">.</span><span class="ident" id="5181950">Min</span><span class="op" id="5181953">.</span><span class="ident" id="5181954">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5181957">for</span>&nbsp;<span class="op" id="5181961">;</span>&nbsp;<span class="ident" id="5181963">y</span>&nbsp;<span class="op" id="5181965">!=</span>&nbsp;<span class="ident" id="5181968">yMax</span><span class="op" id="5181972">;</span>&nbsp;<span class="ident" id="5181974">y</span><span class="op" id="5181975">,</span>&nbsp;<span class="ident" id="5181977">sy</span>&nbsp;<span class="op" id="5181980">=</span>&nbsp;<span class="ident" id="5181982">y</span><span class="op" id="5181983">+</span><span class="num" id="5181984">1</span><span class="op" id="5181985">,</span>&nbsp;<span class="ident" id="5181987">sy</span><span class="op" id="5181989">+</span><span class="num" id="5181990">1</span>&nbsp;<span class="op" id="5181992">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5181996">dpix</span>&nbsp;<span class="op" id="5182001">:=</span>&nbsp;<span class="ident" id="5182004">dst</span><span class="op" id="5182007">.</span><span class="ident" id="5182008">Pix</span><span class="op" id="5182011">[</span><span class="ident" id="5182012">y</span><span class="op" id="5182013">*</span><span class="ident" id="5182014">dst</span><span class="op" id="5182017">.</span><span class="ident" id="5182018">Stride</span><span class="op" id="5182024">:</span><span class="op" id="5182025">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5182029">spix</span>&nbsp;<span class="op" id="5182034">:=</span>&nbsp;<span class="ident" id="5182037">src</span><span class="op" id="5182040">.</span><span class="ident" id="5182041">Pix</span><span class="op" id="5182044">[</span><span class="ident" id="5182045">sy</span><span class="op" id="5182047">*</span><span class="ident" id="5182048">src</span><span class="op" id="5182051">.</span><span class="ident" id="5182052">Stride</span><span class="op" id="5182058">:</span><span class="op" id="5182059">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5182064">for</span>&nbsp;<span class="ident" id="5182068">i</span><span class="op" id="5182069">,</span>&nbsp;<span class="ident" id="5182071">si</span>&nbsp;<span class="op" id="5182074">:=</span>&nbsp;<span class="ident" id="5182077">i0</span><span class="op" id="5182079">,</span>&nbsp;<span class="ident" id="5182081">si0</span><span class="op" id="5182084">;</span>&nbsp;<span class="ident" id="5182086">i</span>&nbsp;<span class="op" id="5182088">&lt;</span>&nbsp;<span class="ident" id="5182090">i1</span><span class="op" id="5182092">;</span>&nbsp;<span class="ident" id="5182094">i</span><span class="op" id="5182095">,</span>&nbsp;<span class="ident" id="5182097">si</span>&nbsp;<span class="op" id="5182100">=</span>&nbsp;<span class="ident" id="5182102">i</span><span class="op" id="5182103">+</span><span class="num" id="5182104">4</span><span class="op" id="5182105">,</span>&nbsp;<span class="ident" id="5182107">si</span><span class="op" id="5182109">+</span><span class="num" id="5182110">4</span>&nbsp;<span class="op" id="5182112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5182117">//&nbsp;Convert&nbsp;from&nbsp;non-premultiplied&nbsp;color&nbsp;to&nbsp;pre-multiplied&nbsp;color.</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5182185">sa</span>&nbsp;<span class="op" id="5182188">:=</span>&nbsp;<span class="builtintype" id="5182191">uint32</span><span class="op" id="5182197">(</span><span class="ident" id="5182198">spix</span><span class="op" id="5182202">[</span><span class="ident" id="5182203">si</span><span class="op" id="5182205">+</span><span class="num" id="5182206">3</span><span class="op" id="5182207">]</span><span class="op" id="5182208">)</span>&nbsp;<span class="op" id="5182210">*</span>&nbsp;<span class="num" id="5182212">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5182221">sr</span>&nbsp;<span class="op" id="5182224">:=</span>&nbsp;<span class="builtintype" id="5182227">uint32</span><span class="op" id="5182233">(</span><span class="ident" id="5182234">spix</span><span class="op" id="5182238">[</span><span class="ident" id="5182239">si</span><span class="op" id="5182241">+</span><span class="num" id="5182242">0</span><span class="op" id="5182243">]</span><span class="op" id="5182244">)</span>&nbsp;<span class="op" id="5182246">*</span>&nbsp;<span class="ident" id="5182248">sa</span>&nbsp;<span class="op" id="5182251">/</span>&nbsp;<span class="num" id="5182253">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5182261">sg</span>&nbsp;<span class="op" id="5182264">:=</span>&nbsp;<span class="builtintype" id="5182267">uint32</span><span class="op" id="5182273">(</span><span class="ident" id="5182274">spix</span><span class="op" id="5182278">[</span><span class="ident" id="5182279">si</span><span class="op" id="5182281">+</span><span class="num" id="5182282">1</span><span class="op" id="5182283">]</span><span class="op" id="5182284">)</span>&nbsp;<span class="op" id="5182286">*</span>&nbsp;<span class="ident" id="5182288">sa</span>&nbsp;<span class="op" id="5182291">/</span>&nbsp;<span class="num" id="5182293">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5182301">sb</span>&nbsp;<span class="op" id="5182304">:=</span>&nbsp;<span class="builtintype" id="5182307">uint32</span><span class="op" id="5182313">(</span><span class="ident" id="5182314">spix</span><span class="op" id="5182318">[</span><span class="ident" id="5182319">si</span><span class="op" id="5182321">+</span><span class="num" id="5182322">2</span><span class="op" id="5182323">]</span><span class="op" id="5182324">)</span>&nbsp;<span class="op" id="5182326">*</span>&nbsp;<span class="ident" id="5182328">sa</span>&nbsp;<span class="op" id="5182331">/</span>&nbsp;<span class="num" id="5182333">0xff</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5182342">dpix</span><span class="op" id="5182346">[</span><span class="ident" id="5182347">i</span><span class="op" id="5182348">+</span><span class="num" id="5182349">0</span><span class="op" id="5182350">]</span>&nbsp;<span class="op" id="5182352">=</span>&nbsp;<span class="builtintype" id="5182354">uint8</span><span class="op" id="5182359">(</span><span class="ident" id="5182360">sr</span>&nbsp;<span class="op" id="5182363">&gt;&gt;</span>&nbsp;<span class="num" id="5182366">8</span><span class="op" id="5182367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5182372">dpix</span><span class="op" id="5182376">[</span><span class="ident" id="5182377">i</span><span class="op" id="5182378">+</span><span class="num" id="5182379">1</span><span class="op" id="5182380">]</span>&nbsp;<span class="op" id="5182382">=</span>&nbsp;<span class="builtintype" id="5182384">uint8</span><span class="op" id="5182389">(</span><span class="ident" id="5182390">sg</span>&nbsp;<span class="op" id="5182393">&gt;&gt;</span>&nbsp;<span class="num" id="5182396">8</span><span class="op" id="5182397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5182402">dpix</span><span class="op" id="5182406">[</span><span class="ident" id="5182407">i</span><span class="op" id="5182408">+</span><span class="num" id="5182409">2</span><span class="op" id="5182410">]</span>&nbsp;<span class="op" id="5182412">=</span>&nbsp;<span class="builtintype" id="5182414">uint8</span><span class="op" id="5182419">(</span><span class="ident" id="5182420">sb</span>&nbsp;<span class="op" id="5182423">&gt;&gt;</span>&nbsp;<span class="num" id="5182426">8</span><span class="op" id="5182427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5182432">dpix</span><span class="op" id="5182436">[</span><span class="ident" id="5182437">i</span><span class="op" id="5182438">+</span><span class="num" id="5182439">3</span><span class="op" id="5182440">]</span>&nbsp;<span class="op" id="5182442">=</span>&nbsp;<span class="builtintype" id="5182444">uint8</span><span class="op" id="5182449">(</span><span class="ident" id="5182450">sa</span>&nbsp;<span class="op" id="5182453">&gt;&gt;</span>&nbsp;<span class="num" id="5182456">8</span><span class="op" id="5182457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5182461">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5182464">}</span><br>
<span class="lineno"></span><span class="op" id="5182466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5182469">func</span>&nbsp;<span class="ident" id="5182474">drawYCbCr</span><span class="op" id="5182483">(</span><span class="ident" id="5182484">dst</span>&nbsp;<span class="op" id="5182488">*</span><span class="ident" id="5182489">image</span><span class="op" id="5182494">.</span><span class="ident" id="5182495">RGBA</span><span class="op" id="5182499">,</span>&nbsp;<span class="ident" id="5182501">r</span>&nbsp;<span class="ident" id="5182503">image</span><span class="op" id="5182508">.</span><span class="ident" id="5182509">Rectangle</span><span class="op" id="5182518">,</span>&nbsp;<span class="ident" id="5182520">src</span>&nbsp;<span class="op" id="5182524">*</span><span class="ident" id="5182525">image</span><span class="op" id="5182530">.</span><span class="ident" id="5182531">YCbCr</span><span class="op" id="5182536">,</span>&nbsp;<span class="ident" id="5182538">sp</span>&nbsp;<span class="ident" id="5182541">image</span><span class="op" id="5182546">.</span><span class="ident" id="5182547">Point</span><span class="op" id="5182552">)</span>&nbsp;<span class="op" id="5182554">(</span><span class="ident" id="5182555">ok</span>&nbsp;<span class="builtintype" id="5182558">bool</span><span class="op" id="5182562">)</span>&nbsp;<span class="op" id="5182564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5182567">//&nbsp;An&nbsp;image.YCbCr&nbsp;is&nbsp;always&nbsp;fully&nbsp;opaque,&nbsp;and&nbsp;so&nbsp;if&nbsp;the&nbsp;mask&nbsp;is&nbsp;implicitly&nbsp;nil</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5182647">//&nbsp;(i.e.&nbsp;fully&nbsp;opaque)&nbsp;then&nbsp;the&nbsp;op&nbsp;is&nbsp;effectively&nbsp;always&nbsp;Src.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5182710">x0</span>&nbsp;<span class="op" id="5182713">:=</span>&nbsp;<span class="op" id="5182716">(</span><span class="ident" id="5182717">r</span><span class="op" id="5182718">.</span><span class="ident" id="5182719">Min</span><span class="op" id="5182722">.</span><span class="ident" id="5182723">X</span>&nbsp;<span class="op" id="5182725">-</span>&nbsp;<span class="ident" id="5182727">dst</span><span class="op" id="5182730">.</span><span class="ident" id="5182731">Rect</span><span class="op" id="5182735">.</span><span class="ident" id="5182736">Min</span><span class="op" id="5182739">.</span><span class="ident" id="5182740">X</span><span class="op" id="5182741">)</span>&nbsp;<span class="op" id="5182743">*</span>&nbsp;<span class="num" id="5182745">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5182748">x1</span>&nbsp;<span class="op" id="5182751">:=</span>&nbsp;<span class="op" id="5182754">(</span><span class="ident" id="5182755">r</span><span class="op" id="5182756">.</span><span class="ident" id="5182757">Max</span><span class="op" id="5182760">.</span><span class="ident" id="5182761">X</span>&nbsp;<span class="op" id="5182763">-</span>&nbsp;<span class="ident" id="5182765">dst</span><span class="op" id="5182768">.</span><span class="ident" id="5182769">Rect</span><span class="op" id="5182773">.</span><span class="ident" id="5182774">Min</span><span class="op" id="5182777">.</span><span class="ident" id="5182778">X</span><span class="op" id="5182779">)</span>&nbsp;<span class="op" id="5182781">*</span>&nbsp;<span class="num" id="5182783">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5182786">y0</span>&nbsp;<span class="op" id="5182789">:=</span>&nbsp;<span class="ident" id="5182792">r</span><span class="op" id="5182793">.</span><span class="ident" id="5182794">Min</span><span class="op" id="5182797">.</span><span class="ident" id="5182798">Y</span>&nbsp;<span class="op" id="5182800">-</span>&nbsp;<span class="ident" id="5182802">dst</span><span class="op" id="5182805">.</span><span class="ident" id="5182806">Rect</span><span class="op" id="5182810">.</span><span class="ident" id="5182811">Min</span><span class="op" id="5182814">.</span><span class="ident" id="5182815">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5182818">y1</span>&nbsp;<span class="op" id="5182821">:=</span>&nbsp;<span class="ident" id="5182824">r</span><span class="op" id="5182825">.</span><span class="ident" id="5182826">Max</span><span class="op" id="5182829">.</span><span class="ident" id="5182830">Y</span>&nbsp;<span class="op" id="5182832">-</span>&nbsp;<span class="ident" id="5182834">dst</span><span class="op" id="5182837">.</span><span class="ident" id="5182838">Rect</span><span class="op" id="5182842">.</span><span class="ident" id="5182843">Min</span><span class="op" id="5182846">.</span><span class="ident" id="5182847">Y</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5182850">switch</span>&nbsp;<span class="ident" id="5182857">src</span><span class="op" id="5182860">.</span><span class="ident" id="5182861">SubsampleRatio</span>&nbsp;<span class="op" id="5182876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5182879">case</span>&nbsp;<span class="ident" id="5182884">image</span><span class="op" id="5182889">.</span><span class="ident" id="5182890">YCbCrSubsampleRatio444</span><span class="op" id="5182912">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5182916">for</span>&nbsp;<span class="ident" id="5182920">y</span><span class="op" id="5182921">,</span>&nbsp;<span class="ident" id="5182923">sy</span>&nbsp;<span class="op" id="5182926">:=</span>&nbsp;<span class="ident" id="5182929">y0</span><span class="op" id="5182931">,</span>&nbsp;<span class="ident" id="5182933">sp</span><span class="op" id="5182935">.</span><span class="ident" id="5182936">Y</span><span class="op" id="5182937">;</span>&nbsp;<span class="ident" id="5182939">y</span>&nbsp;<span class="op" id="5182941">!=</span>&nbsp;<span class="ident" id="5182944">y1</span><span class="op" id="5182946">;</span>&nbsp;<span class="ident" id="5182948">y</span><span class="op" id="5182949">,</span>&nbsp;<span class="ident" id="5182951">sy</span>&nbsp;<span class="op" id="5182954">=</span>&nbsp;<span class="ident" id="5182956">y</span><span class="op" id="5182957">+</span><span class="num" id="5182958">1</span><span class="op" id="5182959">,</span>&nbsp;<span class="ident" id="5182961">sy</span><span class="op" id="5182963">+</span><span class="num" id="5182964">1</span>&nbsp;<span class="op" id="5182966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5182971">dpix</span>&nbsp;<span class="op" id="5182976">:=</span>&nbsp;<span class="ident" id="5182979">dst</span><span class="op" id="5182982">.</span><span class="ident" id="5182983">Pix</span><span class="op" id="5182986">[</span><span class="ident" id="5182987">y</span><span class="op" id="5182988">*</span><span class="ident" id="5182989">dst</span><span class="op" id="5182992">.</span><span class="ident" id="5182993">Stride</span><span class="op" id="5182999">:</span><span class="op" id="5183000">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5183005">yi</span>&nbsp;<span class="op" id="5183008">:=</span>&nbsp;<span class="op" id="5183011">(</span><span class="ident" id="5183012">sy</span><span class="op" id="5183014">-</span><span class="ident" id="5183015">src</span><span class="op" id="5183018">.</span><span class="ident" id="5183019">Rect</span><span class="op" id="5183023">.</span><span class="ident" id="5183024">Min</span><span class="op" id="5183027">.</span><span class="ident" id="5183028">Y</span><span class="op" id="5183029">)</span><span class="op" id="5183030">*</span><span class="ident" id="5183031">src</span><span class="op" id="5183034">.</span><span class="ident" id="5183035">YStride</span>&nbsp;<span class="op" id="5183043">+</span>&nbsp;<span class="op" id="5183045">(</span><span class="ident" id="5183046">sp</span><span class="op" id="5183048">.</span><span class="ident" id="5183049">X</span>&nbsp;<span class="op" id="5183051">-</span>&nbsp;<span class="ident" id="5183053">src</span><span class="op" id="5183056">.</span><span class="ident" id="5183057">Rect</span><span class="op" id="5183061">.</span><span class="ident" id="5183062">Min</span><span class="op" id="5183065">.</span><span class="ident" id="5183066">X</span><span class="op" id="5183067">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5183072">ci</span>&nbsp;<span class="op" id="5183075">:=</span>&nbsp;<span class="op" id="5183078">(</span><span class="ident" id="5183079">sy</span><span class="op" id="5183081">-</span><span class="ident" id="5183082">src</span><span class="op" id="5183085">.</span><span class="ident" id="5183086">Rect</span><span class="op" id="5183090">.</span><span class="ident" id="5183091">Min</span><span class="op" id="5183094">.</span><span class="ident" id="5183095">Y</span><span class="op" id="5183096">)</span><span class="op" id="5183097">*</span><span class="ident" id="5183098">src</span><span class="op" id="5183101">.</span><span class="ident" id="5183102">CStride</span>&nbsp;<span class="op" id="5183110">+</span>&nbsp;<span class="op" id="5183112">(</span><span class="ident" id="5183113">sp</span><span class="op" id="5183115">.</span><span class="ident" id="5183116">X</span>&nbsp;<span class="op" id="5183118">-</span>&nbsp;<span class="ident" id="5183120">src</span><span class="op" id="5183123">.</span><span class="ident" id="5183124">Rect</span><span class="op" id="5183128">.</span><span class="ident" id="5183129">Min</span><span class="op" id="5183132">.</span><span class="ident" id="5183133">X</span><span class="op" id="5183134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5183139">for</span>&nbsp;<span class="ident" id="5183143">x</span>&nbsp;<span class="op" id="5183145">:=</span>&nbsp;<span class="ident" id="5183148">x0</span><span class="op" id="5183150">;</span>&nbsp;<span class="ident" id="5183152">x</span>&nbsp;<span class="op" id="5183154">!=</span>&nbsp;<span class="ident" id="5183157">x1</span><span class="op" id="5183159">;</span>&nbsp;<span class="ident" id="5183161">x</span><span class="op" id="5183162">,</span>&nbsp;<span class="ident" id="5183164">yi</span><span class="op" id="5183166">,</span>&nbsp;<span class="ident" id="5183168">ci</span>&nbsp;<span class="op" id="5183171">=</span>&nbsp;<span class="ident" id="5183173">x</span><span class="op" id="5183174">+</span><span class="num" id="5183175">4</span><span class="op" id="5183176">,</span>&nbsp;<span class="ident" id="5183178">yi</span><span class="op" id="5183180">+</span><span class="num" id="5183181">1</span><span class="op" id="5183182">,</span>&nbsp;<span class="ident" id="5183184">ci</span><span class="op" id="5183186">+</span><span class="num" id="5183187">1</span>&nbsp;<span class="op" id="5183189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5183195">rr</span><span class="op" id="5183197">,</span>&nbsp;<span class="ident" id="5183199">gg</span><span class="op" id="5183201">,</span>&nbsp;<span class="ident" id="5183203">bb</span>&nbsp;<span class="op" id="5183206">:=</span>&nbsp;<span class="ident" id="5183209">color</span><span class="op" id="5183214">.</span><span class="ident" id="5183215">YCbCrToRGB</span><span class="op" id="5183225">(</span><span class="ident" id="5183226">src</span><span class="op" id="5183229">.</span><span class="ident" id="5183230">Y</span><span class="op" id="5183231">[</span><span class="ident" id="5183232">yi</span><span class="op" id="5183234">]</span><span class="op" id="5183235">,</span>&nbsp;<span class="ident" id="5183237">src</span><span class="op" id="5183240">.</span><span class="ident" id="5183241">Cb</span><span class="op" id="5183243">[</span><span class="ident" id="5183244">ci</span><span class="op" id="5183246">]</span><span class="op" id="5183247">,</span>&nbsp;<span class="ident" id="5183249">src</span><span class="op" id="5183252">.</span><span class="ident" id="5183253">Cr</span><span class="op" id="5183255">[</span><span class="ident" id="5183256">ci</span><span class="op" id="5183258">]</span><span class="op" id="5183259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5183265">dpix</span><span class="op" id="5183269">[</span><span class="ident" id="5183270">x</span><span class="op" id="5183271">+</span><span class="num" id="5183272">0</span><span class="op" id="5183273">]</span>&nbsp;<span class="op" id="5183275">=</span>&nbsp;<span class="ident" id="5183277">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5183284">dpix</span><span class="op" id="5183288">[</span><span class="ident" id="5183289">x</span><span class="op" id="5183290">+</span><span class="num" id="5183291">1</span><span class="op" id="5183292">]</span>&nbsp;<span class="op" id="5183294">=</span>&nbsp;<span class="ident" id="5183296">gg</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5183303">dpix</span><span class="op" id="5183307">[</span><span class="ident" id="5183308">x</span><span class="op" id="5183309">+</span><span class="num" id="5183310">2</span><span class="op" id="5183311">]</span>&nbsp;<span class="op" id="5183313">=</span>&nbsp;<span class="ident" id="5183315">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5183322">dpix</span><span class="op" id="5183326">[</span><span class="ident" id="5183327">x</span><span class="op" id="5183328">+</span><span class="num" id="5183329">3</span><span class="op" id="5183330">]</span>&nbsp;<span class="op" id="5183332">=</span>&nbsp;<span class="num" id="5183334">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5183341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5183345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5183348">case</span>&nbsp;<span class="ident" id="5183353">image</span><span class="op" id="5183358">.</span><span class="ident" id="5183359">YCbCrSubsampleRatio422</span><span class="op" id="5183381">:</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5183385">for</span>&nbsp;<span class="ident" id="5183389">y</span><span class="op" id="5183390">,</span>&nbsp;<span class="ident" id="5183392">sy</span>&nbsp;<span class="op" id="5183395">:=</span>&nbsp;<span class="ident" id="5183398">y0</span><span class="op" id="5183400">,</span>&nbsp;<span class="ident" id="5183402">sp</span><span class="op" id="5183404">.</span><span class="ident" id="5183405">Y</span><span class="op" id="5183406">;</span>&nbsp;<span class="ident" id="5183408">y</span>&nbsp;<span class="op" id="5183410">!=</span>&nbsp;<span class="ident" id="5183413">y1</span><span class="op" id="5183415">;</span>&nbsp;<span class="ident" id="5183417">y</span><span class="op" id="5183418">,</span>&nbsp;<span class="ident" id="5183420">sy</span>&nbsp;<span class="op" id="5183423">=</span>&nbsp;<span class="ident" id="5183425">y</span><span class="op" id="5183426">+</span><span class="num" id="5183427">1</span><span class="op" id="5183428">,</span>&nbsp;<span class="ident" id="5183430">sy</span><span class="op" id="5183432">+</span><span class="num" id="5183433">1</span>&nbsp;<span class="op" id="5183435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5183440">dpix</span>&nbsp;<span class="op" id="5183445">:=</span>&nbsp;<span class="ident" id="5183448">dst</span><span class="op" id="5183451">.</span><span class="ident" id="5183452">Pix</span><span class="op" id="5183455">[</span><span class="ident" id="5183456">y</span><span class="op" id="5183457">*</span><span class="ident" id="5183458">dst</span><span class="op" id="5183461">.</span><span class="ident" id="5183462">Stride</span><span class="op" id="5183468">:</span><span class="op" id="5183469">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5183474">yi</span>&nbsp;<span class="op" id="5183477">:=</span>&nbsp;<span class="op" id="5183480">(</span><span class="ident" id="5183481">sy</span><span class="op" id="5183483">-</span><span class="ident" id="5183484">src</span><span class="op" id="5183487">.</span><span class="ident" id="5183488">Rect</span><span class="op" id="5183492">.</span><span class="ident" id="5183493">Min</span><span class="op" id="5183496">.</span><span class="ident" id="5183497">Y</span><span class="op" id="5183498">)</span><span class="op" id="5183499">*</span><span class="ident" id="5183500">src</span><span class="op" id="5183503">.</span><span class="ident" id="5183504">YStride</span>&nbsp;<span class="op" id="5183512">+</span>&nbsp;<span class="op" id="5183514">(</span><span class="ident" id="5183515">sp</span><span class="op" id="5183517">.</span><span class="ident" id="5183518">X</span>&nbsp;<span class="op" id="5183520">-</span>&nbsp;<span class="ident" id="5183522">src</span><span class="op" id="5183525">.</span><span class="ident" id="5183526">Rect</span><span class="op" id="5183530">.</span><span class="ident" id="5183531">Min</span><span class="op" id="5183534">.</span><span class="ident" id="5183535">X</span><span class="op" id="5183536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5183541">ciBase</span>&nbsp;<span class="op" id="5183548">:=</span>&nbsp;<span class="op" id="5183551">(</span><span class="ident" id="5183552">sy</span><span class="op" id="5183554">-</span><span class="ident" id="5183555">src</span><span class="op" id="5183558">.</span><span class="ident" id="5183559">Rect</span><span class="op" id="5183563">.</span><span class="ident" id="5183564">Min</span><span class="op" id="5183567">.</span><span class="ident" id="5183568">Y</span><span class="op" id="5183569">)</span><span class="op" id="5183570">*</span><span class="ident" id="5183571">src</span><span class="op" id="5183574">.</span><span class="ident" id="5183575">CStride</span>&nbsp;<span class="op" id="5183583">-</span>&nbsp;<span class="ident" id="5183585">src</span><span class="op" id="5183588">.</span><span class="ident" id="5183589">Rect</span><span class="op" id="5183593">.</span><span class="ident" id="5183594">Min</span><span class="op" id="5183597">.</span><span class="ident" id="5183598">X</span><span class="op" id="5183599">/</span><span class="num" id="5183600">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5183605">for</span>&nbsp;<span class="ident" id="5183609">x</span><span class="op" id="5183610">,</span>&nbsp;<span class="ident" id="5183612">sx</span>&nbsp;<span class="op" id="5183615">:=</span>&nbsp;<span class="ident" id="5183618">x0</span><span class="op" id="5183620">,</span>&nbsp;<span class="ident" id="5183622">sp</span><span class="op" id="5183624">.</span><span class="ident" id="5183625">X</span><span class="op" id="5183626">;</span>&nbsp;<span class="ident" id="5183628">x</span>&nbsp;<span class="op" id="5183630">!=</span>&nbsp;<span class="ident" id="5183633">x1</span><span class="op" id="5183635">;</span>&nbsp;<span class="ident" id="5183637">x</span><span class="op" id="5183638">,</span>&nbsp;<span class="ident" id="5183640">sx</span><span class="op" id="5183642">,</span>&nbsp;<span class="ident" id="5183644">yi</span>&nbsp;<span class="op" id="5183647">=</span>&nbsp;<span class="ident" id="5183649">x</span><span class="op" id="5183650">+</span><span class="num" id="5183651">4</span><span class="op" id="5183652">,</span>&nbsp;<span class="ident" id="5183654">sx</span><span class="op" id="5183656">+</span><span class="num" id="5183657">1</span><span class="op" id="5183658">,</span>&nbsp;<span class="ident" id="5183660">yi</span><span class="op" id="5183662">+</span><span class="num" id="5183663">1</span>&nbsp;<span class="op" id="5183665">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5183671">ci</span>&nbsp;<span class="op" id="5183674">:=</span>&nbsp;<span class="ident" id="5183677">ciBase</span>&nbsp;<span class="op" id="5183684">+</span>&nbsp;<span class="ident" id="5183686">sx</span><span class="op" id="5183688">/</span><span class="num" id="5183689">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5183695">rr</span><span class="op" id="5183697">,</span>&nbsp;<span class="ident" id="5183699">gg</span><span class="op" id="5183701">,</span>&nbsp;<span class="ident" id="5183703">bb</span>&nbsp;<span class="op" id="5183706">:=</span>&nbsp;<span class="ident" id="5183709">color</span><span class="op" id="5183714">.</span><span class="ident" id="5183715">YCbCrToRGB</span><span class="op" id="5183725">(</span><span class="ident" id="5183726">src</span><span class="op" id="5183729">.</span><span class="ident" id="5183730">Y</span><span class="op" id="5183731">[</span><span class="ident" id="5183732">yi</span><span class="op" id="5183734">]</span><span class="op" id="5183735">,</span>&nbsp;<span class="ident" id="5183737">src</span><span class="op" id="5183740">.</span><span class="ident" id="5183741">Cb</span><span class="op" id="5183743">[</span><span class="ident" id="5183744">ci</span><span class="op" id="5183746">]</span><span class="op" id="5183747">,</span>&nbsp;<span class="ident" id="5183749">src</span><span class="op" id="5183752">.</span><span class="ident" id="5183753">Cr</span><span class="op" id="5183755">[</span><span class="ident" id="5183756">ci</span><span class="op" id="5183758">]</span><span class="op" id="5183759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5183765">dpix</span><span class="op" id="5183769">[</span><span class="ident" id="5183770">x</span><span class="op" id="5183771">+</span><span class="num" id="5183772">0</span><span class="op" id="5183773">]</span>&nbsp;<span class="op" id="5183775">=</span>&nbsp;<span class="ident" id="5183777">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5183784">dpix</span><span class="op" id="5183788">[</span><span class="ident" id="5183789">x</span><span class="op" id="5183790">+</span><span class="num" id="5183791">1</span><span class="op" id="5183792">]</span>&nbsp;<span class="op" id="5183794">=</span>&nbsp;<span class="ident" id="5183796">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5183803">dpix</span><span class="op" id="5183807">[</span><span class="ident" id="5183808">x</span><span class="op" id="5183809">+</span><span class="num" id="5183810">2</span><span class="op" id="5183811">]</span>&nbsp;<span class="op" id="5183813">=</span>&nbsp;<span class="ident" id="5183815">bb</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5183822">dpix</span><span class="op" id="5183826">[</span><span class="ident" id="5183827">x</span><span class="op" id="5183828">+</span><span class="num" id="5183829">3</span><span class="op" id="5183830">]</span>&nbsp;<span class="op" id="5183832">=</span>&nbsp;<span class="num" id="5183834">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5183841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5183845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5183848">case</span>&nbsp;<span class="ident" id="5183853">image</span><span class="op" id="5183858">.</span><span class="ident" id="5183859">YCbCrSubsampleRatio420</span><span class="op" id="5183881">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5183885">for</span>&nbsp;<span class="ident" id="5183889">y</span><span class="op" id="5183890">,</span>&nbsp;<span class="ident" id="5183892">sy</span>&nbsp;<span class="op" id="5183895">:=</span>&nbsp;<span class="ident" id="5183898">y0</span><span class="op" id="5183900">,</span>&nbsp;<span class="ident" id="5183902">sp</span><span class="op" id="5183904">.</span><span class="ident" id="5183905">Y</span><span class="op" id="5183906">;</span>&nbsp;<span class="ident" id="5183908">y</span>&nbsp;<span class="op" id="5183910">!=</span>&nbsp;<span class="ident" id="5183913">y1</span><span class="op" id="5183915">;</span>&nbsp;<span class="ident" id="5183917">y</span><span class="op" id="5183918">,</span>&nbsp;<span class="ident" id="5183920">sy</span>&nbsp;<span class="op" id="5183923">=</span>&nbsp;<span class="ident" id="5183925">y</span><span class="op" id="5183926">+</span><span class="num" id="5183927">1</span><span class="op" id="5183928">,</span>&nbsp;<span class="ident" id="5183930">sy</span><span class="op" id="5183932">+</span><span class="num" id="5183933">1</span>&nbsp;<span class="op" id="5183935">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5183940">dpix</span>&nbsp;<span class="op" id="5183945">:=</span>&nbsp;<span class="ident" id="5183948">dst</span><span class="op" id="5183951">.</span><span class="ident" id="5183952">Pix</span><span class="op" id="5183955">[</span><span class="ident" id="5183956">y</span><span class="op" id="5183957">*</span><span class="ident" id="5183958">dst</span><span class="op" id="5183961">.</span><span class="ident" id="5183962">Stride</span><span class="op" id="5183968">:</span><span class="op" id="5183969">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5183974">yi</span>&nbsp;<span class="op" id="5183977">:=</span>&nbsp;<span class="op" id="5183980">(</span><span class="ident" id="5183981">sy</span><span class="op" id="5183983">-</span><span class="ident" id="5183984">src</span><span class="op" id="5183987">.</span><span class="ident" id="5183988">Rect</span><span class="op" id="5183992">.</span><span class="ident" id="5183993">Min</span><span class="op" id="5183996">.</span><span class="ident" id="5183997">Y</span><span class="op" id="5183998">)</span><span class="op" id="5183999">*</span><span class="ident" id="5184000">src</span><span class="op" id="5184003">.</span><span class="ident" id="5184004">YStride</span>&nbsp;<span class="op" id="5184012">+</span>&nbsp;<span class="op" id="5184014">(</span><span class="ident" id="5184015">sp</span><span class="op" id="5184017">.</span><span class="ident" id="5184018">X</span>&nbsp;<span class="op" id="5184020">-</span>&nbsp;<span class="ident" id="5184022">src</span><span class="op" id="5184025">.</span><span class="ident" id="5184026">Rect</span><span class="op" id="5184030">.</span><span class="ident" id="5184031">Min</span><span class="op" id="5184034">.</span><span class="ident" id="5184035">X</span><span class="op" id="5184036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5184041">ciBase</span>&nbsp;<span class="op" id="5184048">:=</span>&nbsp;<span class="op" id="5184051">(</span><span class="ident" id="5184052">sy</span><span class="op" id="5184054">/</span><span class="num" id="5184055">2</span><span class="op" id="5184056">-</span><span class="ident" id="5184057">src</span><span class="op" id="5184060">.</span><span class="ident" id="5184061">Rect</span><span class="op" id="5184065">.</span><span class="ident" id="5184066">Min</span><span class="op" id="5184069">.</span><span class="ident" id="5184070">Y</span><span class="op" id="5184071">/</span><span class="num" id="5184072">2</span><span class="op" id="5184073">)</span><span class="op" id="5184074">*</span><span class="ident" id="5184075">src</span><span class="op" id="5184078">.</span><span class="ident" id="5184079">CStride</span>&nbsp;<span class="op" id="5184087">-</span>&nbsp;<span class="ident" id="5184089">src</span><span class="op" id="5184092">.</span><span class="ident" id="5184093">Rect</span><span class="op" id="5184097">.</span><span class="ident" id="5184098">Min</span><span class="op" id="5184101">.</span><span class="ident" id="5184102">X</span><span class="op" id="5184103">/</span><span class="num" id="5184104">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5184109">for</span>&nbsp;<span class="ident" id="5184113">x</span><span class="op" id="5184114">,</span>&nbsp;<span class="ident" id="5184116">sx</span>&nbsp;<span class="op" id="5184119">:=</span>&nbsp;<span class="ident" id="5184122">x0</span><span class="op" id="5184124">,</span>&nbsp;<span class="ident" id="5184126">sp</span><span class="op" id="5184128">.</span><span class="ident" id="5184129">X</span><span class="op" id="5184130">;</span>&nbsp;<span class="ident" id="5184132">x</span>&nbsp;<span class="op" id="5184134">!=</span>&nbsp;<span class="ident" id="5184137">x1</span><span class="op" id="5184139">;</span>&nbsp;<span class="ident" id="5184141">x</span><span class="op" id="5184142">,</span>&nbsp;<span class="ident" id="5184144">sx</span><span class="op" id="5184146">,</span>&nbsp;<span class="ident" id="5184148">yi</span>&nbsp;<span class="op" id="5184151">=</span>&nbsp;<span class="ident" id="5184153">x</span><span class="op" id="5184154">+</span><span class="num" id="5184155">4</span><span class="op" id="5184156">,</span>&nbsp;<span class="ident" id="5184158">sx</span><span class="op" id="5184160">+</span><span class="num" id="5184161">1</span><span class="op" id="5184162">,</span>&nbsp;<span class="ident" id="5184164">yi</span><span class="op" id="5184166">+</span><span class="num" id="5184167">1</span>&nbsp;<span class="op" id="5184169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5184175">ci</span>&nbsp;<span class="op" id="5184178">:=</span>&nbsp;<span class="ident" id="5184181">ciBase</span>&nbsp;<span class="op" id="5184188">+</span>&nbsp;<span class="ident" id="5184190">sx</span><span class="op" id="5184192">/</span><span class="num" id="5184193">2</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5184199">rr</span><span class="op" id="5184201">,</span>&nbsp;<span class="ident" id="5184203">gg</span><span class="op" id="5184205">,</span>&nbsp;<span class="ident" id="5184207">bb</span>&nbsp;<span class="op" id="5184210">:=</span>&nbsp;<span class="ident" id="5184213">color</span><span class="op" id="5184218">.</span><span class="ident" id="5184219">YCbCrToRGB</span><span class="op" id="5184229">(</span><span class="ident" id="5184230">src</span><span class="op" id="5184233">.</span><span class="ident" id="5184234">Y</span><span class="op" id="5184235">[</span><span class="ident" id="5184236">yi</span><span class="op" id="5184238">]</span><span class="op" id="5184239">,</span>&nbsp;<span class="ident" id="5184241">src</span><span class="op" id="5184244">.</span><span class="ident" id="5184245">Cb</span><span class="op" id="5184247">[</span><span class="ident" id="5184248">ci</span><span class="op" id="5184250">]</span><span class="op" id="5184251">,</span>&nbsp;<span class="ident" id="5184253">src</span><span class="op" id="5184256">.</span><span class="ident" id="5184257">Cr</span><span class="op" id="5184259">[</span><span class="ident" id="5184260">ci</span><span class="op" id="5184262">]</span><span class="op" id="5184263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5184269">dpix</span><span class="op" id="5184273">[</span><span class="ident" id="5184274">x</span><span class="op" id="5184275">+</span><span class="num" id="5184276">0</span><span class="op" id="5184277">]</span>&nbsp;<span class="op" id="5184279">=</span>&nbsp;<span class="ident" id="5184281">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5184288">dpix</span><span class="op" id="5184292">[</span><span class="ident" id="5184293">x</span><span class="op" id="5184294">+</span><span class="num" id="5184295">1</span><span class="op" id="5184296">]</span>&nbsp;<span class="op" id="5184298">=</span>&nbsp;<span class="ident" id="5184300">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5184307">dpix</span><span class="op" id="5184311">[</span><span class="ident" id="5184312">x</span><span class="op" id="5184313">+</span><span class="num" id="5184314">2</span><span class="op" id="5184315">]</span>&nbsp;<span class="op" id="5184317">=</span>&nbsp;<span class="ident" id="5184319">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5184326">dpix</span><span class="op" id="5184330">[</span><span class="ident" id="5184331">x</span><span class="op" id="5184332">+</span><span class="num" id="5184333">3</span><span class="op" id="5184334">]</span>&nbsp;<span class="op" id="5184336">=</span>&nbsp;<span class="num" id="5184338">255</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5184345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5184349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5184352">case</span>&nbsp;<span class="ident" id="5184357">image</span><span class="op" id="5184362">.</span><span class="ident" id="5184363">YCbCrSubsampleRatio440</span><span class="op" id="5184385">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5184389">for</span>&nbsp;<span class="ident" id="5184393">y</span><span class="op" id="5184394">,</span>&nbsp;<span class="ident" id="5184396">sy</span>&nbsp;<span class="op" id="5184399">:=</span>&nbsp;<span class="ident" id="5184402">y0</span><span class="op" id="5184404">,</span>&nbsp;<span class="ident" id="5184406">sp</span><span class="op" id="5184408">.</span><span class="ident" id="5184409">Y</span><span class="op" id="5184410">;</span>&nbsp;<span class="ident" id="5184412">y</span>&nbsp;<span class="op" id="5184414">!=</span>&nbsp;<span class="ident" id="5184417">y1</span><span class="op" id="5184419">;</span>&nbsp;<span class="ident" id="5184421">y</span><span class="op" id="5184422">,</span>&nbsp;<span class="ident" id="5184424">sy</span>&nbsp;<span class="op" id="5184427">=</span>&nbsp;<span class="ident" id="5184429">y</span><span class="op" id="5184430">+</span><span class="num" id="5184431">1</span><span class="op" id="5184432">,</span>&nbsp;<span class="ident" id="5184434">sy</span><span class="op" id="5184436">+</span><span class="num" id="5184437">1</span>&nbsp;<span class="op" id="5184439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5184444">dpix</span>&nbsp;<span class="op" id="5184449">:=</span>&nbsp;<span class="ident" id="5184452">dst</span><span class="op" id="5184455">.</span><span class="ident" id="5184456">Pix</span><span class="op" id="5184459">[</span><span class="ident" id="5184460">y</span><span class="op" id="5184461">*</span><span class="ident" id="5184462">dst</span><span class="op" id="5184465">.</span><span class="ident" id="5184466">Stride</span><span class="op" id="5184472">:</span><span class="op" id="5184473">]</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5184478">yi</span>&nbsp;<span class="op" id="5184481">:=</span>&nbsp;<span class="op" id="5184484">(</span><span class="ident" id="5184485">sy</span><span class="op" id="5184487">-</span><span class="ident" id="5184488">src</span><span class="op" id="5184491">.</span><span class="ident" id="5184492">Rect</span><span class="op" id="5184496">.</span><span class="ident" id="5184497">Min</span><span class="op" id="5184500">.</span><span class="ident" id="5184501">Y</span><span class="op" id="5184502">)</span><span class="op" id="5184503">*</span><span class="ident" id="5184504">src</span><span class="op" id="5184507">.</span><span class="ident" id="5184508">YStride</span>&nbsp;<span class="op" id="5184516">+</span>&nbsp;<span class="op" id="5184518">(</span><span class="ident" id="5184519">sp</span><span class="op" id="5184521">.</span><span class="ident" id="5184522">X</span>&nbsp;<span class="op" id="5184524">-</span>&nbsp;<span class="ident" id="5184526">src</span><span class="op" id="5184529">.</span><span class="ident" id="5184530">Rect</span><span class="op" id="5184534">.</span><span class="ident" id="5184535">Min</span><span class="op" id="5184538">.</span><span class="ident" id="5184539">X</span><span class="op" id="5184540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5184545">ci</span>&nbsp;<span class="op" id="5184548">:=</span>&nbsp;<span class="op" id="5184551">(</span><span class="ident" id="5184552">sy</span><span class="op" id="5184554">/</span><span class="num" id="5184555">2</span><span class="op" id="5184556">-</span><span class="ident" id="5184557">src</span><span class="op" id="5184560">.</span><span class="ident" id="5184561">Rect</span><span class="op" id="5184565">.</span><span class="ident" id="5184566">Min</span><span class="op" id="5184569">.</span><span class="ident" id="5184570">Y</span><span class="op" id="5184571">/</span><span class="num" id="5184572">2</span><span class="op" id="5184573">)</span><span class="op" id="5184574">*</span><span class="ident" id="5184575">src</span><span class="op" id="5184578">.</span><span class="ident" id="5184579">CStride</span>&nbsp;<span class="op" id="5184587">+</span>&nbsp;<span class="op" id="5184589">(</span><span class="ident" id="5184590">sp</span><span class="op" id="5184592">.</span><span class="ident" id="5184593">X</span>&nbsp;<span class="op" id="5184595">-</span>&nbsp;<span class="ident" id="5184597">src</span><span class="op" id="5184600">.</span><span class="ident" id="5184601">Rect</span><span class="op" id="5184605">.</span><span class="ident" id="5184606">Min</span><span class="op" id="5184609">.</span><span class="ident" id="5184610">X</span><span class="op" id="5184611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5184616">for</span>&nbsp;<span class="ident" id="5184620">x</span>&nbsp;<span class="op" id="5184622">:=</span>&nbsp;<span class="ident" id="5184625">x0</span><span class="op" id="5184627">;</span>&nbsp;<span class="ident" id="5184629">x</span>&nbsp;<span class="op" id="5184631">!=</span>&nbsp;<span class="ident" id="5184634">x1</span><span class="op" id="5184636">;</span>&nbsp;<span class="ident" id="5184638">x</span><span class="op" id="5184639">,</span>&nbsp;<span class="ident" id="5184641">yi</span><span class="op" id="5184643">,</span>&nbsp;<span class="ident" id="5184645">ci</span>&nbsp;<span class="op" id="5184648">=</span>&nbsp;<span class="ident" id="5184650">x</span><span class="op" id="5184651">+</span><span class="num" id="5184652">4</span><span class="op" id="5184653">,</span>&nbsp;<span class="ident" id="5184655">yi</span><span class="op" id="5184657">+</span><span class="num" id="5184658">1</span><span class="op" id="5184659">,</span>&nbsp;<span class="ident" id="5184661">ci</span><span class="op" id="5184663">+</span><span class="num" id="5184664">1</span>&nbsp;<span class="op" id="5184666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5184672">rr</span><span class="op" id="5184674">,</span>&nbsp;<span class="ident" id="5184676">gg</span><span class="op" id="5184678">,</span>&nbsp;<span class="ident" id="5184680">bb</span>&nbsp;<span class="op" id="5184683">:=</span>&nbsp;<span class="ident" id="5184686">color</span><span class="op" id="5184691">.</span><span class="ident" id="5184692">YCbCrToRGB</span><span class="op" id="5184702">(</span><span class="ident" id="5184703">src</span><span class="op" id="5184706">.</span><span class="ident" id="5184707">Y</span><span class="op" id="5184708">[</span><span class="ident" id="5184709">yi</span><span class="op" id="5184711">]</span><span class="op" id="5184712">,</span>&nbsp;<span class="ident" id="5184714">src</span><span class="op" id="5184717">.</span><span class="ident" id="5184718">Cb</span><span class="op" id="5184720">[</span><span class="ident" id="5184721">ci</span><span class="op" id="5184723">]</span><span class="op" id="5184724">,</span>&nbsp;<span class="ident" id="5184726">src</span><span class="op" id="5184729">.</span><span class="ident" id="5184730">Cr</span><span class="op" id="5184732">[</span><span class="ident" id="5184733">ci</span><span class="op" id="5184735">]</span><span class="op" id="5184736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5184742">dpix</span><span class="op" id="5184746">[</span><span class="ident" id="5184747">x</span><span class="op" id="5184748">+</span><span class="num" id="5184749">0</span><span class="op" id="5184750">]</span>&nbsp;<span class="op" id="5184752">=</span>&nbsp;<span class="ident" id="5184754">rr</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5184761">dpix</span><span class="op" id="5184765">[</span><span class="ident" id="5184766">x</span><span class="op" id="5184767">+</span><span class="num" id="5184768">1</span><span class="op" id="5184769">]</span>&nbsp;<span class="op" id="5184771">=</span>&nbsp;<span class="ident" id="5184773">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5184780">dpix</span><span class="op" id="5184784">[</span><span class="ident" id="5184785">x</span><span class="op" id="5184786">+</span><span class="num" id="5184787">2</span><span class="op" id="5184788">]</span>&nbsp;<span class="op" id="5184790">=</span>&nbsp;<span class="ident" id="5184792">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5184799">dpix</span><span class="op" id="5184803">[</span><span class="ident" id="5184804">x</span><span class="op" id="5184805">+</span><span class="num" id="5184806">3</span><span class="op" id="5184807">]</span>&nbsp;<span class="op" id="5184809">=</span>&nbsp;<span class="num" id="5184811">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5184818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5184822">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5184825">default</span><span class="op" id="5184832">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5184836">return</span>&nbsp;<span class="builtintype" id="5184843">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5184850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5184853">return</span>&nbsp;<span class="builtintype" id="5184860">true</span><br>
<span class="lineno"></span><span class="op" id="5184865">}</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span><span class="keyword" id="5184868">func</span>&nbsp;<span class="ident" id="5184873">drawGlyphOver</span><span class="op" id="5184886">(</span><span class="ident" id="5184887">dst</span>&nbsp;<span class="op" id="5184891">*</span><span class="ident" id="5184892">image</span><span class="op" id="5184897">.</span><span class="ident" id="5184898">RGBA</span><span class="op" id="5184902">,</span>&nbsp;<span class="ident" id="5184904">r</span>&nbsp;<span class="ident" id="5184906">image</span><span class="op" id="5184911">.</span><span class="ident" id="5184912">Rectangle</span><span class="op" id="5184921">,</span>&nbsp;<span class="ident" id="5184923">src</span>&nbsp;<span class="op" id="5184927">*</span><span class="ident" id="5184928">image</span><span class="op" id="5184933">.</span><span class="ident" id="5184934">Uniform</span><span class="op" id="5184941">,</span>&nbsp;<span class="ident" id="5184943">mask</span>&nbsp;<span class="op" id="5184948">*</span><span class="ident" id="5184949">image</span><span class="op" id="5184954">.</span><span class="ident" id="5184955">Alpha</span><span class="op" id="5184960">,</span>&nbsp;<span class="ident" id="5184962">mp</span>&nbsp;<span class="ident" id="5184965">image</span><span class="op" id="5184970">.</span><span class="ident" id="5184971">Point</span><span class="op" id="5184976">)</span>&nbsp;<span class="op" id="5184978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5184981">i0</span>&nbsp;<span class="op" id="5184984">:=</span>&nbsp;<span class="ident" id="5184987">dst</span><span class="op" id="5184990">.</span><span class="ident" id="5184991">PixOffset</span><span class="op" id="5185000">(</span><span class="ident" id="5185001">r</span><span class="op" id="5185002">.</span><span class="ident" id="5185003">Min</span><span class="op" id="5185006">.</span><span class="ident" id="5185007">X</span><span class="op" id="5185008">,</span>&nbsp;<span class="ident" id="5185010">r</span><span class="op" id="5185011">.</span><span class="ident" id="5185012">Min</span><span class="op" id="5185015">.</span><span class="ident" id="5185016">Y</span><span class="op" id="5185017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5185020">i1</span>&nbsp;<span class="op" id="5185023">:=</span>&nbsp;<span class="ident" id="5185026">i0</span>&nbsp;<span class="op" id="5185029">+</span>&nbsp;<span class="ident" id="5185031">r</span><span class="op" id="5185032">.</span><span class="ident" id="5185033">Dx</span><span class="op" id="5185035">(</span><span class="op" id="5185036">)</span><span class="op" id="5185037">*</span><span class="num" id="5185038">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5185041">mi0</span>&nbsp;<span class="op" id="5185045">:=</span>&nbsp;<span class="ident" id="5185048">mask</span><span class="op" id="5185052">.</span><span class="ident" id="5185053">PixOffset</span><span class="op" id="5185062">(</span><span class="ident" id="5185063">mp</span><span class="op" id="5185065">.</span><span class="ident" id="5185066">X</span><span class="op" id="5185067">,</span>&nbsp;<span class="ident" id="5185069">mp</span><span class="op" id="5185071">.</span><span class="ident" id="5185072">Y</span><span class="op" id="5185073">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5185076">sr</span><span class="op" id="5185078">,</span>&nbsp;<span class="ident" id="5185080">sg</span><span class="op" id="5185082">,</span>&nbsp;<span class="ident" id="5185084">sb</span><span class="op" id="5185086">,</span>&nbsp;<span class="ident" id="5185088">sa</span>&nbsp;<span class="op" id="5185091">:=</span>&nbsp;<span class="ident" id="5185094">src</span><span class="op" id="5185097">.</span><span class="ident" id="5185098">RGBA</span><span class="op" id="5185102">(</span><span class="op" id="5185103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5185106">for</span>&nbsp;<span class="ident" id="5185110">y</span><span class="op" id="5185111">,</span>&nbsp;<span class="ident" id="5185113">my</span>&nbsp;<span class="op" id="5185116">:=</span>&nbsp;<span class="ident" id="5185119">r</span><span class="op" id="5185120">.</span><span class="ident" id="5185121">Min</span><span class="op" id="5185124">.</span><span class="ident" id="5185125">Y</span><span class="op" id="5185126">,</span>&nbsp;<span class="ident" id="5185128">mp</span><span class="op" id="5185130">.</span><span class="ident" id="5185131">Y</span><span class="op" id="5185132">;</span>&nbsp;<span class="ident" id="5185134">y</span>&nbsp;<span class="op" id="5185136">!=</span>&nbsp;<span class="ident" id="5185139">r</span><span class="op" id="5185140">.</span><span class="ident" id="5185141">Max</span><span class="op" id="5185144">.</span><span class="ident" id="5185145">Y</span><span class="op" id="5185146">;</span>&nbsp;<span class="ident" id="5185148">y</span><span class="op" id="5185149">,</span>&nbsp;<span class="ident" id="5185151">my</span>&nbsp;<span class="op" id="5185154">=</span>&nbsp;<span class="ident" id="5185156">y</span><span class="op" id="5185157">+</span><span class="num" id="5185158">1</span><span class="op" id="5185159">,</span>&nbsp;<span class="ident" id="5185161">my</span><span class="op" id="5185163">+</span><span class="num" id="5185164">1</span>&nbsp;<span class="op" id="5185166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5185170">for</span>&nbsp;<span class="ident" id="5185174">i</span><span class="op" id="5185175">,</span>&nbsp;<span class="ident" id="5185177">mi</span>&nbsp;<span class="op" id="5185180">:=</span>&nbsp;<span class="ident" id="5185183">i0</span><span class="op" id="5185185">,</span>&nbsp;<span class="ident" id="5185187">mi0</span><span class="op" id="5185190">;</span>&nbsp;<span class="ident" id="5185192">i</span>&nbsp;<span class="op" id="5185194">&lt;</span>&nbsp;<span class="ident" id="5185196">i1</span><span class="op" id="5185198">;</span>&nbsp;<span class="ident" id="5185200">i</span><span class="op" id="5185201">,</span>&nbsp;<span class="ident" id="5185203">mi</span>&nbsp;<span class="op" id="5185206">=</span>&nbsp;<span class="ident" id="5185208">i</span><span class="op" id="5185209">+</span><span class="num" id="5185210">4</span><span class="op" id="5185211">,</span>&nbsp;<span class="ident" id="5185213">mi</span><span class="op" id="5185215">+</span><span class="num" id="5185216">1</span>&nbsp;<span class="op" id="5185218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5185223">ma</span>&nbsp;<span class="op" id="5185226">:=</span>&nbsp;<span class="builtintype" id="5185229">uint32</span><span class="op" id="5185235">(</span><span class="ident" id="5185236">mask</span><span class="op" id="5185240">.</span><span class="ident" id="5185241">Pix</span><span class="op" id="5185244">[</span><span class="ident" id="5185245">mi</span><span class="op" id="5185247">]</span><span class="op" id="5185248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5185253">if</span>&nbsp;<span class="ident" id="5185256">ma</span>&nbsp;<span class="op" id="5185259">==</span>&nbsp;<span class="num" id="5185262">0</span>&nbsp;<span class="op" id="5185264">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5185270">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5185282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5185287">ma</span>&nbsp;<span class="op" id="5185290">|=</span>&nbsp;<span class="ident" id="5185293">ma</span>&nbsp;<span class="op" id="5185296">&lt;&lt;</span>&nbsp;<span class="num" id="5185299">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5185305">dr</span>&nbsp;<span class="op" id="5185308">:=</span>&nbsp;<span class="builtintype" id="5185311">uint32</span><span class="op" id="5185317">(</span><span class="ident" id="5185318">dst</span><span class="op" id="5185321">.</span><span class="ident" id="5185322">Pix</span><span class="op" id="5185325">[</span><span class="ident" id="5185326">i</span><span class="op" id="5185327">+</span><span class="num" id="5185328">0</span><span class="op" id="5185329">]</span><span class="op" id="5185330">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5185335">dg</span>&nbsp;<span class="op" id="5185338">:=</span>&nbsp;<span class="builtintype" id="5185341">uint32</span><span class="op" id="5185347">(</span><span class="ident" id="5185348">dst</span><span class="op" id="5185351">.</span><span class="ident" id="5185352">Pix</span><span class="op" id="5185355">[</span><span class="ident" id="5185356">i</span><span class="op" id="5185357">+</span><span class="num" id="5185358">1</span><span class="op" id="5185359">]</span><span class="op" id="5185360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5185365">db</span>&nbsp;<span class="op" id="5185368">:=</span>&nbsp;<span class="builtintype" id="5185371">uint32</span><span class="op" id="5185377">(</span><span class="ident" id="5185378">dst</span><span class="op" id="5185381">.</span><span class="ident" id="5185382">Pix</span><span class="op" id="5185385">[</span><span class="ident" id="5185386">i</span><span class="op" id="5185387">+</span><span class="num" id="5185388">2</span><span class="op" id="5185389">]</span><span class="op" id="5185390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5185395">da</span>&nbsp;<span class="op" id="5185398">:=</span>&nbsp;<span class="builtintype" id="5185401">uint32</span><span class="op" id="5185407">(</span><span class="ident" id="5185408">dst</span><span class="op" id="5185411">.</span><span class="ident" id="5185412">Pix</span><span class="op" id="5185415">[</span><span class="ident" id="5185416">i</span><span class="op" id="5185417">+</span><span class="num" id="5185418">3</span><span class="op" id="5185419">]</span><span class="op" id="5185420">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5185426">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5185486">a</span>&nbsp;<span class="op" id="5185488">:=</span>&nbsp;<span class="op" id="5185491">(</span><span class="ident" id="5185492">m</span>&nbsp;<span class="op" id="5185494">-</span>&nbsp;<span class="op" id="5185496">(</span><span class="ident" id="5185497">sa</span>&nbsp;<span class="op" id="5185500">*</span>&nbsp;<span class="ident" id="5185502">ma</span>&nbsp;<span class="op" id="5185505">/</span>&nbsp;<span class="ident" id="5185507">m</span><span class="op" id="5185508">)</span><span class="op" id="5185509">)</span>&nbsp;<span class="op" id="5185511">*</span>&nbsp;<span class="num" id="5185513">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5185523">dst</span><span class="op" id="5185526">.</span><span class="ident" id="5185527">Pix</span><span class="op" id="5185530">[</span><span class="ident" id="5185531">i</span><span class="op" id="5185532">+</span><span class="num" id="5185533">0</span><span class="op" id="5185534">]</span>&nbsp;<span class="op" id="5185536">=</span>&nbsp;<span class="builtintype" id="5185538">uint8</span><span class="op" id="5185543">(</span><span class="op" id="5185544">(</span><span class="ident" id="5185545">dr</span><span class="op" id="5185547">*</span><span class="ident" id="5185548">a</span>&nbsp;<span class="op" id="5185550">+</span>&nbsp;<span class="ident" id="5185552">sr</span><span class="op" id="5185554">*</span><span class="ident" id="5185555">ma</span><span class="op" id="5185557">)</span>&nbsp;<span class="op" id="5185559">/</span>&nbsp;<span class="ident" id="5185561">m</span>&nbsp;<span class="op" id="5185563">&gt;&gt;</span>&nbsp;<span class="num" id="5185566">8</span><span class="op" id="5185567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5185572">dst</span><span class="op" id="5185575">.</span><span class="ident" id="5185576">Pix</span><span class="op" id="5185579">[</span><span class="ident" id="5185580">i</span><span class="op" id="5185581">+</span><span class="num" id="5185582">1</span><span class="op" id="5185583">]</span>&nbsp;<span class="op" id="5185585">=</span>&nbsp;<span class="builtintype" id="5185587">uint8</span><span class="op" id="5185592">(</span><span class="op" id="5185593">(</span><span class="ident" id="5185594">dg</span><span class="op" id="5185596">*</span><span class="ident" id="5185597">a</span>&nbsp;<span class="op" id="5185599">+</span>&nbsp;<span class="ident" id="5185601">sg</span><span class="op" id="5185603">*</span><span class="ident" id="5185604">ma</span><span class="op" id="5185606">)</span>&nbsp;<span class="op" id="5185608">/</span>&nbsp;<span class="ident" id="5185610">m</span>&nbsp;<span class="op" id="5185612">&gt;&gt;</span>&nbsp;<span class="num" id="5185615">8</span><span class="op" id="5185616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5185621">dst</span><span class="op" id="5185624">.</span><span class="ident" id="5185625">Pix</span><span class="op" id="5185628">[</span><span class="ident" id="5185629">i</span><span class="op" id="5185630">+</span><span class="num" id="5185631">2</span><span class="op" id="5185632">]</span>&nbsp;<span class="op" id="5185634">=</span>&nbsp;<span class="builtintype" id="5185636">uint8</span><span class="op" id="5185641">(</span><span class="op" id="5185642">(</span><span class="ident" id="5185643">db</span><span class="op" id="5185645">*</span><span class="ident" id="5185646">a</span>&nbsp;<span class="op" id="5185648">+</span>&nbsp;<span class="ident" id="5185650">sb</span><span class="op" id="5185652">*</span><span class="ident" id="5185653">ma</span><span class="op" id="5185655">)</span>&nbsp;<span class="op" id="5185657">/</span>&nbsp;<span class="ident" id="5185659">m</span>&nbsp;<span class="op" id="5185661">&gt;&gt;</span>&nbsp;<span class="num" id="5185664">8</span><span class="op" id="5185665">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5185670">dst</span><span class="op" id="5185673">.</span><span class="ident" id="5185674">Pix</span><span class="op" id="5185677">[</span><span class="ident" id="5185678">i</span><span class="op" id="5185679">+</span><span class="num" id="5185680">3</span><span class="op" id="5185681">]</span>&nbsp;<span class="op" id="5185683">=</span>&nbsp;<span class="builtintype" id="5185685">uint8</span><span class="op" id="5185690">(</span><span class="op" id="5185691">(</span><span class="ident" id="5185692">da</span><span class="op" id="5185694">*</span><span class="ident" id="5185695">a</span>&nbsp;<span class="op" id="5185697">+</span>&nbsp;<span class="ident" id="5185699">sa</span><span class="op" id="5185701">*</span><span class="ident" id="5185702">ma</span><span class="op" id="5185704">)</span>&nbsp;<span class="op" id="5185706">/</span>&nbsp;<span class="ident" id="5185708">m</span>&nbsp;<span class="op" id="5185710">&gt;&gt;</span>&nbsp;<span class="num" id="5185713">8</span><span class="op" id="5185714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5185718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5185722">i0</span>&nbsp;<span class="op" id="5185725">+=</span>&nbsp;<span class="ident" id="5185728">dst</span><span class="op" id="5185731">.</span><span class="ident" id="5185732">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5185741">i1</span>&nbsp;<span class="op" id="5185744">+=</span>&nbsp;<span class="ident" id="5185747">dst</span><span class="op" id="5185750">.</span><span class="ident" id="5185751">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5185760">mi0</span>&nbsp;<span class="op" id="5185764">+=</span>&nbsp;<span class="ident" id="5185767">mask</span><span class="op" id="5185771">.</span><span class="ident" id="5185772">Stride</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5185780">}</span><br>
<span class="lineno"></span><span class="op" id="5185782">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5185785">func</span>&nbsp;<span class="ident" id="5185790">drawRGBA</span><span class="op" id="5185798">(</span><span class="ident" id="5185799">dst</span>&nbsp;<span class="op" id="5185803">*</span><span class="ident" id="5185804">image</span><span class="op" id="5185809">.</span><span class="ident" id="5185810">RGBA</span><span class="op" id="5185814">,</span>&nbsp;<span class="ident" id="5185816">r</span>&nbsp;<span class="ident" id="5185818">image</span><span class="op" id="5185823">.</span><span class="ident" id="5185824">Rectangle</span><span class="op" id="5185833">,</span>&nbsp;<span class="ident" id="5185835">src</span>&nbsp;<span class="ident" id="5185839">image</span><span class="op" id="5185844">.</span><span class="ident" id="5185845">Image</span><span class="op" id="5185850">,</span>&nbsp;<span class="ident" id="5185852">sp</span>&nbsp;<span class="ident" id="5185855">image</span><span class="op" id="5185860">.</span><span class="ident" id="5185861">Point</span><span class="op" id="5185866">,</span>&nbsp;<span class="ident" id="5185868">mask</span>&nbsp;<span class="ident" id="5185873">image</span><span class="op" id="5185878">.</span><span class="ident" id="5185879">Image</span><span class="op" id="5185884">,</span>&nbsp;<span class="ident" id="5185886">mp</span>&nbsp;<span class="ident" id="5185889">image</span><span class="op" id="5185894">.</span><span class="ident" id="5185895">Point</span><span class="op" id="5185900">,</span>&nbsp;<span class="ident" id="5185902">op</span>&nbsp;<span class="ident" id="5185905">Op</span><span class="op" id="5185907">)</span>&nbsp;<span class="op" id="5185909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5185912">x0</span><span class="op" id="5185914">,</span>&nbsp;<span class="ident" id="5185916">x1</span><span class="op" id="5185918">,</span>&nbsp;<span class="ident" id="5185920">dx</span>&nbsp;<span class="op" id="5185923">:=</span>&nbsp;<span class="ident" id="5185926">r</span><span class="op" id="5185927">.</span><span class="ident" id="5185928">Min</span><span class="op" id="5185931">.</span><span class="ident" id="5185932">X</span><span class="op" id="5185933">,</span>&nbsp;<span class="ident" id="5185935">r</span><span class="op" id="5185936">.</span><span class="ident" id="5185937">Max</span><span class="op" id="5185940">.</span><span class="ident" id="5185941">X</span><span class="op" id="5185942">,</span>&nbsp;<span class="num" id="5185944">1</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5185947">y0</span><span class="op" id="5185949">,</span>&nbsp;<span class="ident" id="5185951">y1</span><span class="op" id="5185953">,</span>&nbsp;<span class="ident" id="5185955">dy</span>&nbsp;<span class="op" id="5185958">:=</span>&nbsp;<span class="ident" id="5185961">r</span><span class="op" id="5185962">.</span><span class="ident" id="5185963">Min</span><span class="op" id="5185966">.</span><span class="ident" id="5185967">Y</span><span class="op" id="5185968">,</span>&nbsp;<span class="ident" id="5185970">r</span><span class="op" id="5185971">.</span><span class="ident" id="5185972">Max</span><span class="op" id="5185975">.</span><span class="ident" id="5185976">Y</span><span class="op" id="5185977">,</span>&nbsp;<span class="num" id="5185979">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5185982">if</span>&nbsp;<span class="ident" id="5185985">image</span><span class="op" id="5185990">.</span><span class="ident" id="5185991">Image</span><span class="op" id="5185996">(</span><span class="ident" id="5185997">dst</span><span class="op" id="5186000">)</span>&nbsp;<span class="op" id="5186002">==</span>&nbsp;<span class="ident" id="5186005">src</span>&nbsp;<span class="op" id="5186009">&amp;&amp;</span>&nbsp;<span class="ident" id="5186012">r</span><span class="op" id="5186013">.</span><span class="ident" id="5186014">Overlaps</span><span class="op" id="5186022">(</span><span class="ident" id="5186023">r</span><span class="op" id="5186024">.</span><span class="ident" id="5186025">Add</span><span class="op" id="5186028">(</span><span class="ident" id="5186029">sp</span><span class="op" id="5186031">.</span><span class="ident" id="5186032">Sub</span><span class="op" id="5186035">(</span><span class="ident" id="5186036">r</span><span class="op" id="5186037">.</span><span class="ident" id="5186038">Min</span><span class="op" id="5186041">)</span><span class="op" id="5186042">)</span><span class="op" id="5186043">)</span>&nbsp;<span class="op" id="5186045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5186049">if</span>&nbsp;<span class="ident" id="5186052">sp</span><span class="op" id="5186054">.</span><span class="ident" id="5186055">Y</span>&nbsp;<span class="op" id="5186057">&lt;</span>&nbsp;<span class="ident" id="5186059">r</span><span class="op" id="5186060">.</span><span class="ident" id="5186061">Min</span><span class="op" id="5186064">.</span><span class="ident" id="5186065">Y</span>&nbsp;<span class="op" id="5186067">||</span>&nbsp;<span class="ident" id="5186070">sp</span><span class="op" id="5186072">.</span><span class="ident" id="5186073">Y</span>&nbsp;<span class="op" id="5186075">==</span>&nbsp;<span class="ident" id="5186078">r</span><span class="op" id="5186079">.</span><span class="ident" id="5186080">Min</span><span class="op" id="5186083">.</span><span class="ident" id="5186084">Y</span>&nbsp;<span class="op" id="5186086">&amp;&amp;</span>&nbsp;<span class="ident" id="5186089">sp</span><span class="op" id="5186091">.</span><span class="ident" id="5186092">X</span>&nbsp;<span class="op" id="5186094">&lt;</span>&nbsp;<span class="ident" id="5186096">r</span><span class="op" id="5186097">.</span><span class="ident" id="5186098">Min</span><span class="op" id="5186101">.</span><span class="ident" id="5186102">X</span>&nbsp;<span class="op" id="5186104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5186109">x0</span><span class="op" id="5186111">,</span>&nbsp;<span class="ident" id="5186113">x1</span><span class="op" id="5186115">,</span>&nbsp;<span class="ident" id="5186117">dx</span>&nbsp;<span class="op" id="5186120">=</span>&nbsp;<span class="ident" id="5186122">x1</span><span class="op" id="5186124">-</span><span class="num" id="5186125">1</span><span class="op" id="5186126">,</span>&nbsp;<span class="ident" id="5186128">x0</span><span class="op" id="5186130">-</span><span class="num" id="5186131">1</span><span class="op" id="5186132">,</span>&nbsp;<span class="op" id="5186134">-</span><span class="num" id="5186135">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5186140">y0</span><span class="op" id="5186142">,</span>&nbsp;<span class="ident" id="5186144">y1</span><span class="op" id="5186146">,</span>&nbsp;<span class="ident" id="5186148">dy</span>&nbsp;<span class="op" id="5186151">=</span>&nbsp;<span class="ident" id="5186153">y1</span><span class="op" id="5186155">-</span><span class="num" id="5186156">1</span><span class="op" id="5186157">,</span>&nbsp;<span class="ident" id="5186159">y0</span><span class="op" id="5186161">-</span><span class="num" id="5186162">1</span><span class="op" id="5186163">,</span>&nbsp;<span class="op" id="5186165">-</span><span class="num" id="5186166">1</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5186170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5186173">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5186177">sy</span>&nbsp;<span class="op" id="5186180">:=</span>&nbsp;<span class="ident" id="5186183">sp</span><span class="op" id="5186185">.</span><span class="ident" id="5186186">Y</span>&nbsp;<span class="op" id="5186188">+</span>&nbsp;<span class="ident" id="5186190">y0</span>&nbsp;<span class="op" id="5186193">-</span>&nbsp;<span class="ident" id="5186195">r</span><span class="op" id="5186196">.</span><span class="ident" id="5186197">Min</span><span class="op" id="5186200">.</span><span class="ident" id="5186201">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5186204">my</span>&nbsp;<span class="op" id="5186207">:=</span>&nbsp;<span class="ident" id="5186210">mp</span><span class="op" id="5186212">.</span><span class="ident" id="5186213">Y</span>&nbsp;<span class="op" id="5186215">+</span>&nbsp;<span class="ident" id="5186217">y0</span>&nbsp;<span class="op" id="5186220">-</span>&nbsp;<span class="ident" id="5186222">r</span><span class="op" id="5186223">.</span><span class="ident" id="5186224">Min</span><span class="op" id="5186227">.</span><span class="ident" id="5186228">Y</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5186231">sx0</span>&nbsp;<span class="op" id="5186235">:=</span>&nbsp;<span class="ident" id="5186238">sp</span><span class="op" id="5186240">.</span><span class="ident" id="5186241">X</span>&nbsp;<span class="op" id="5186243">+</span>&nbsp;<span class="ident" id="5186245">x0</span>&nbsp;<span class="op" id="5186248">-</span>&nbsp;<span class="ident" id="5186250">r</span><span class="op" id="5186251">.</span><span class="ident" id="5186252">Min</span><span class="op" id="5186255">.</span><span class="ident" id="5186256">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5186259">mx0</span>&nbsp;<span class="op" id="5186263">:=</span>&nbsp;<span class="ident" id="5186266">mp</span><span class="op" id="5186268">.</span><span class="ident" id="5186269">X</span>&nbsp;<span class="op" id="5186271">+</span>&nbsp;<span class="ident" id="5186273">x0</span>&nbsp;<span class="op" id="5186276">-</span>&nbsp;<span class="ident" id="5186278">r</span><span class="op" id="5186279">.</span><span class="ident" id="5186280">Min</span><span class="op" id="5186283">.</span><span class="ident" id="5186284">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5186287">sx1</span>&nbsp;<span class="op" id="5186291">:=</span>&nbsp;<span class="ident" id="5186294">sx0</span>&nbsp;<span class="op" id="5186298">+</span>&nbsp;<span class="op" id="5186300">(</span><span class="ident" id="5186301">x1</span>&nbsp;<span class="op" id="5186304">-</span>&nbsp;<span class="ident" id="5186306">x0</span><span class="op" id="5186308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5186311">i0</span>&nbsp;<span class="op" id="5186314">:=</span>&nbsp;<span class="ident" id="5186317">dst</span><span class="op" id="5186320">.</span><span class="ident" id="5186321">PixOffset</span><span class="op" id="5186330">(</span><span class="ident" id="5186331">x0</span><span class="op" id="5186333">,</span>&nbsp;<span class="ident" id="5186335">y0</span><span class="op" id="5186337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5186340">di</span>&nbsp;<span class="op" id="5186343">:=</span>&nbsp;<span class="ident" id="5186346">dx</span>&nbsp;<span class="op" id="5186349">*</span>&nbsp;<span class="num" id="5186351">4</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5186354">for</span>&nbsp;<span class="ident" id="5186358">y</span>&nbsp;<span class="op" id="5186360">:=</span>&nbsp;<span class="ident" id="5186363">y0</span><span class="op" id="5186365">;</span>&nbsp;<span class="ident" id="5186367">y</span>&nbsp;<span class="op" id="5186369">!=</span>&nbsp;<span class="ident" id="5186372">y1</span><span class="op" id="5186374">;</span>&nbsp;<span class="ident" id="5186376">y</span><span class="op" id="5186377">,</span>&nbsp;<span class="ident" id="5186379">sy</span><span class="op" id="5186381">,</span>&nbsp;<span class="ident" id="5186383">my</span>&nbsp;<span class="op" id="5186386">=</span>&nbsp;<span class="ident" id="5186388">y</span><span class="op" id="5186389">+</span><span class="ident" id="5186390">dy</span><span class="op" id="5186392">,</span>&nbsp;<span class="ident" id="5186394">sy</span><span class="op" id="5186396">+</span><span class="ident" id="5186397">dy</span><span class="op" id="5186399">,</span>&nbsp;<span class="ident" id="5186401">my</span><span class="op" id="5186403">+</span><span class="ident" id="5186404">dy</span>&nbsp;<span class="op" id="5186407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5186411">for</span>&nbsp;<span class="ident" id="5186415">i</span><span class="op" id="5186416">,</span>&nbsp;<span class="ident" id="5186418">sx</span><span class="op" id="5186420">,</span>&nbsp;<span class="ident" id="5186422">mx</span>&nbsp;<span class="op" id="5186425">:=</span>&nbsp;<span class="ident" id="5186428">i0</span><span class="op" id="5186430">,</span>&nbsp;<span class="ident" id="5186432">sx0</span><span class="op" id="5186435">,</span>&nbsp;<span class="ident" id="5186437">mx0</span><span class="op" id="5186440">;</span>&nbsp;<span class="ident" id="5186442">sx</span>&nbsp;<span class="op" id="5186445">!=</span>&nbsp;<span class="ident" id="5186448">sx1</span><span class="op" id="5186451">;</span>&nbsp;<span class="ident" id="5186453">i</span><span class="op" id="5186454">,</span>&nbsp;<span class="ident" id="5186456">sx</span><span class="op" id="5186458">,</span>&nbsp;<span class="ident" id="5186460">mx</span>&nbsp;<span class="op" id="5186463">=</span>&nbsp;<span class="ident" id="5186465">i</span><span class="op" id="5186466">+</span><span class="ident" id="5186467">di</span><span class="op" id="5186469">,</span>&nbsp;<span class="ident" id="5186471">sx</span><span class="op" id="5186473">+</span><span class="ident" id="5186474">dx</span><span class="op" id="5186476">,</span>&nbsp;<span class="ident" id="5186478">mx</span><span class="op" id="5186480">+</span><span class="ident" id="5186481">dx</span>&nbsp;<span class="op" id="5186484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5186489">ma</span>&nbsp;<span class="op" id="5186492">:=</span>&nbsp;<span class="builtintype" id="5186495">uint32</span><span class="op" id="5186501">(</span><span class="ident" id="5186502">m</span><span class="op" id="5186503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5186508">if</span>&nbsp;<span class="ident" id="5186511">mask</span>&nbsp;<span class="op" id="5186516">!=</span>&nbsp;<span class="builtintype" id="5186519">nil</span>&nbsp;<span class="op" id="5186523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5186529">_</span><span class="op" id="5186530">,</span>&nbsp;<span class="ident" id="5186532">_</span><span class="op" id="5186533">,</span>&nbsp;<span class="ident" id="5186535">_</span><span class="op" id="5186536">,</span>&nbsp;<span class="ident" id="5186538">ma</span>&nbsp;<span class="op" id="5186541">=</span>&nbsp;<span class="ident" id="5186543">mask</span><span class="op" id="5186547">.</span><span class="ident" id="5186548">At</span><span class="op" id="5186550">(</span><span class="ident" id="5186551">mx</span><span class="op" id="5186553">,</span>&nbsp;<span class="ident" id="5186555">my</span><span class="op" id="5186557">)</span><span class="op" id="5186558">.</span><span class="ident" id="5186559">RGBA</span><span class="op" id="5186563">(</span><span class="op" id="5186564">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5186569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5186574">sr</span><span class="op" id="5186576">,</span>&nbsp;<span class="ident" id="5186578">sg</span><span class="op" id="5186580">,</span>&nbsp;<span class="ident" id="5186582">sb</span><span class="op" id="5186584">,</span>&nbsp;<span class="ident" id="5186586">sa</span>&nbsp;<span class="op" id="5186589">:=</span>&nbsp;<span class="ident" id="5186592">src</span><span class="op" id="5186595">.</span><span class="ident" id="5186596">At</span><span class="op" id="5186598">(</span><span class="ident" id="5186599">sx</span><span class="op" id="5186601">,</span>&nbsp;<span class="ident" id="5186603">sy</span><span class="op" id="5186605">)</span><span class="op" id="5186606">.</span><span class="ident" id="5186607">RGBA</span><span class="op" id="5186611">(</span><span class="op" id="5186612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5186617">if</span>&nbsp;<span class="ident" id="5186620">op</span>&nbsp;<span class="op" id="5186623">==</span>&nbsp;<span class="ident" id="5186626">Over</span>&nbsp;<span class="op" id="5186631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5186637">dr</span>&nbsp;<span class="op" id="5186640">:=</span>&nbsp;<span class="builtintype" id="5186643">uint32</span><span class="op" id="5186649">(</span><span class="ident" id="5186650">dst</span><span class="op" id="5186653">.</span><span class="ident" id="5186654">Pix</span><span class="op" id="5186657">[</span><span class="ident" id="5186658">i</span><span class="op" id="5186659">+</span><span class="num" id="5186660">0</span><span class="op" id="5186661">]</span><span class="op" id="5186662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5186668">dg</span>&nbsp;<span class="op" id="5186671">:=</span>&nbsp;<span class="builtintype" id="5186674">uint32</span><span class="op" id="5186680">(</span><span class="ident" id="5186681">dst</span><span class="op" id="5186684">.</span><span class="ident" id="5186685">Pix</span><span class="op" id="5186688">[</span><span class="ident" id="5186689">i</span><span class="op" id="5186690">+</span><span class="num" id="5186691">1</span><span class="op" id="5186692">]</span><span class="op" id="5186693">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5186699">db</span>&nbsp;<span class="op" id="5186702">:=</span>&nbsp;<span class="builtintype" id="5186705">uint32</span><span class="op" id="5186711">(</span><span class="ident" id="5186712">dst</span><span class="op" id="5186715">.</span><span class="ident" id="5186716">Pix</span><span class="op" id="5186719">[</span><span class="ident" id="5186720">i</span><span class="op" id="5186721">+</span><span class="num" id="5186722">2</span><span class="op" id="5186723">]</span><span class="op" id="5186724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5186730">da</span>&nbsp;<span class="op" id="5186733">:=</span>&nbsp;<span class="builtintype" id="5186736">uint32</span><span class="op" id="5186742">(</span><span class="ident" id="5186743">dst</span><span class="op" id="5186746">.</span><span class="ident" id="5186747">Pix</span><span class="op" id="5186750">[</span><span class="ident" id="5186751">i</span><span class="op" id="5186752">+</span><span class="num" id="5186753">3</span><span class="op" id="5186754">]</span><span class="op" id="5186755">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5186762">//&nbsp;dr,&nbsp;dg,&nbsp;db&nbsp;and&nbsp;da&nbsp;are&nbsp;all&nbsp;8-bit&nbsp;color&nbsp;at&nbsp;the&nbsp;moment,&nbsp;ranging&nbsp;in&nbsp;[0,255].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5186842">//&nbsp;We&nbsp;work&nbsp;in&nbsp;16-bit&nbsp;color,&nbsp;and&nbsp;so&nbsp;would&nbsp;normally&nbsp;do:</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5186900">//&nbsp;dr&nbsp;|=&nbsp;dr&nbsp;&lt;&lt;&nbsp;8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5186921">//&nbsp;and&nbsp;similarly&nbsp;for&nbsp;dg,&nbsp;db&nbsp;and&nbsp;da,&nbsp;but&nbsp;instead&nbsp;we&nbsp;multiply&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5186987">//&nbsp;(which&nbsp;is&nbsp;a&nbsp;16-bit&nbsp;color,&nbsp;ranging&nbsp;in&nbsp;[0,65535])&nbsp;by&nbsp;0x101.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5187052">//&nbsp;This&nbsp;yields&nbsp;the&nbsp;same&nbsp;result,&nbsp;but&nbsp;is&nbsp;fewer&nbsp;arithmetic&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5187124">a</span>&nbsp;<span class="op" id="5187126">:=</span>&nbsp;<span class="op" id="5187129">(</span><span class="ident" id="5187130">m</span>&nbsp;<span class="op" id="5187132">-</span>&nbsp;<span class="op" id="5187134">(</span><span class="ident" id="5187135">sa</span>&nbsp;<span class="op" id="5187138">*</span>&nbsp;<span class="ident" id="5187140">ma</span>&nbsp;<span class="op" id="5187143">/</span>&nbsp;<span class="ident" id="5187145">m</span><span class="op" id="5187146">)</span><span class="op" id="5187147">)</span>&nbsp;<span class="op" id="5187149">*</span>&nbsp;<span class="num" id="5187151">0x101</span><br>
<span class="lineno">530</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5187162">dst</span><span class="op" id="5187165">.</span><span class="ident" id="5187166">Pix</span><span class="op" id="5187169">[</span><span class="ident" id="5187170">i</span><span class="op" id="5187171">+</span><span class="num" id="5187172">0</span><span class="op" id="5187173">]</span>&nbsp;<span class="op" id="5187175">=</span>&nbsp;<span class="builtintype" id="5187177">uint8</span><span class="op" id="5187182">(</span><span class="op" id="5187183">(</span><span class="ident" id="5187184">dr</span><span class="op" id="5187186">*</span><span class="ident" id="5187187">a</span>&nbsp;<span class="op" id="5187189">+</span>&nbsp;<span class="ident" id="5187191">sr</span><span class="op" id="5187193">*</span><span class="ident" id="5187194">ma</span><span class="op" id="5187196">)</span>&nbsp;<span class="op" id="5187198">/</span>&nbsp;<span class="ident" id="5187200">m</span>&nbsp;<span class="op" id="5187202">&gt;&gt;</span>&nbsp;<span class="num" id="5187205">8</span><span class="op" id="5187206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5187212">dst</span><span class="op" id="5187215">.</span><span class="ident" id="5187216">Pix</span><span class="op" id="5187219">[</span><span class="ident" id="5187220">i</span><span class="op" id="5187221">+</span><span class="num" id="5187222">1</span><span class="op" id="5187223">]</span>&nbsp;<span class="op" id="5187225">=</span>&nbsp;<span class="builtintype" id="5187227">uint8</span><span class="op" id="5187232">(</span><span class="op" id="5187233">(</span><span class="ident" id="5187234">dg</span><span class="op" id="5187236">*</span><span class="ident" id="5187237">a</span>&nbsp;<span class="op" id="5187239">+</span>&nbsp;<span class="ident" id="5187241">sg</span><span class="op" id="5187243">*</span><span class="ident" id="5187244">ma</span><span class="op" id="5187246">)</span>&nbsp;<span class="op" id="5187248">/</span>&nbsp;<span class="ident" id="5187250">m</span>&nbsp;<span class="op" id="5187252">&gt;&gt;</span>&nbsp;<span class="num" id="5187255">8</span><span class="op" id="5187256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5187262">dst</span><span class="op" id="5187265">.</span><span class="ident" id="5187266">Pix</span><span class="op" id="5187269">[</span><span class="ident" id="5187270">i</span><span class="op" id="5187271">+</span><span class="num" id="5187272">2</span><span class="op" id="5187273">]</span>&nbsp;<span class="op" id="5187275">=</span>&nbsp;<span class="builtintype" id="5187277">uint8</span><span class="op" id="5187282">(</span><span class="op" id="5187283">(</span><span class="ident" id="5187284">db</span><span class="op" id="5187286">*</span><span class="ident" id="5187287">a</span>&nbsp;<span class="op" id="5187289">+</span>&nbsp;<span class="ident" id="5187291">sb</span><span class="op" id="5187293">*</span><span class="ident" id="5187294">ma</span><span class="op" id="5187296">)</span>&nbsp;<span class="op" id="5187298">/</span>&nbsp;<span class="ident" id="5187300">m</span>&nbsp;<span class="op" id="5187302">&gt;&gt;</span>&nbsp;<span class="num" id="5187305">8</span><span class="op" id="5187306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5187312">dst</span><span class="op" id="5187315">.</span><span class="ident" id="5187316">Pix</span><span class="op" id="5187319">[</span><span class="ident" id="5187320">i</span><span class="op" id="5187321">+</span><span class="num" id="5187322">3</span><span class="op" id="5187323">]</span>&nbsp;<span class="op" id="5187325">=</span>&nbsp;<span class="builtintype" id="5187327">uint8</span><span class="op" id="5187332">(</span><span class="op" id="5187333">(</span><span class="ident" id="5187334">da</span><span class="op" id="5187336">*</span><span class="ident" id="5187337">a</span>&nbsp;<span class="op" id="5187339">+</span>&nbsp;<span class="ident" id="5187341">sa</span><span class="op" id="5187343">*</span><span class="ident" id="5187344">ma</span><span class="op" id="5187346">)</span>&nbsp;<span class="op" id="5187348">/</span>&nbsp;<span class="ident" id="5187350">m</span>&nbsp;<span class="op" id="5187352">&gt;&gt;</span>&nbsp;<span class="num" id="5187355">8</span><span class="op" id="5187356">)</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5187362">}</span>&nbsp;<span class="keyword" id="5187364">else</span>&nbsp;<span class="op" id="5187369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5187375">dst</span><span class="op" id="5187378">.</span><span class="ident" id="5187379">Pix</span><span class="op" id="5187382">[</span><span class="ident" id="5187383">i</span><span class="op" id="5187384">+</span><span class="num" id="5187385">0</span><span class="op" id="5187386">]</span>&nbsp;<span class="op" id="5187388">=</span>&nbsp;<span class="builtintype" id="5187390">uint8</span><span class="op" id="5187395">(</span><span class="ident" id="5187396">sr</span>&nbsp;<span class="op" id="5187399">*</span>&nbsp;<span class="ident" id="5187401">ma</span>&nbsp;<span class="op" id="5187404">/</span>&nbsp;<span class="ident" id="5187406">m</span>&nbsp;<span class="op" id="5187408">&gt;&gt;</span>&nbsp;<span class="num" id="5187411">8</span><span class="op" id="5187412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5187418">dst</span><span class="op" id="5187421">.</span><span class="ident" id="5187422">Pix</span><span class="op" id="5187425">[</span><span class="ident" id="5187426">i</span><span class="op" id="5187427">+</span><span class="num" id="5187428">1</span><span class="op" id="5187429">]</span>&nbsp;<span class="op" id="5187431">=</span>&nbsp;<span class="builtintype" id="5187433">uint8</span><span class="op" id="5187438">(</span><span class="ident" id="5187439">sg</span>&nbsp;<span class="op" id="5187442">*</span>&nbsp;<span class="ident" id="5187444">ma</span>&nbsp;<span class="op" id="5187447">/</span>&nbsp;<span class="ident" id="5187449">m</span>&nbsp;<span class="op" id="5187451">&gt;&gt;</span>&nbsp;<span class="num" id="5187454">8</span><span class="op" id="5187455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5187461">dst</span><span class="op" id="5187464">.</span><span class="ident" id="5187465">Pix</span><span class="op" id="5187468">[</span><span class="ident" id="5187469">i</span><span class="op" id="5187470">+</span><span class="num" id="5187471">2</span><span class="op" id="5187472">]</span>&nbsp;<span class="op" id="5187474">=</span>&nbsp;<span class="builtintype" id="5187476">uint8</span><span class="op" id="5187481">(</span><span class="ident" id="5187482">sb</span>&nbsp;<span class="op" id="5187485">*</span>&nbsp;<span class="ident" id="5187487">ma</span>&nbsp;<span class="op" id="5187490">/</span>&nbsp;<span class="ident" id="5187492">m</span>&nbsp;<span class="op" id="5187494">&gt;&gt;</span>&nbsp;<span class="num" id="5187497">8</span><span class="op" id="5187498">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5187504">dst</span><span class="op" id="5187507">.</span><span class="ident" id="5187508">Pix</span><span class="op" id="5187511">[</span><span class="ident" id="5187512">i</span><span class="op" id="5187513">+</span><span class="num" id="5187514">3</span><span class="op" id="5187515">]</span>&nbsp;<span class="op" id="5187517">=</span>&nbsp;<span class="builtintype" id="5187519">uint8</span><span class="op" id="5187524">(</span><span class="ident" id="5187525">sa</span>&nbsp;<span class="op" id="5187528">*</span>&nbsp;<span class="ident" id="5187530">ma</span>&nbsp;<span class="op" id="5187533">/</span>&nbsp;<span class="ident" id="5187535">m</span>&nbsp;<span class="op" id="5187537">&gt;&gt;</span>&nbsp;<span class="num" id="5187540">8</span><span class="op" id="5187541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5187546">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5187550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5187554">i0</span>&nbsp;<span class="op" id="5187557">+=</span>&nbsp;<span class="ident" id="5187560">dy</span>&nbsp;<span class="op" id="5187563">*</span>&nbsp;<span class="ident" id="5187565">dst</span><span class="op" id="5187568">.</span><span class="ident" id="5187569">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5187577">}</span><br>
<span class="lineno">545</span><span class="op" id="5187579">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5187582">//&nbsp;clamp&nbsp;clamps&nbsp;i&nbsp;to&nbsp;the&nbsp;interval&nbsp;[0,&nbsp;0xffff].</span><br>
<span class="lineno"></span><span class="keyword" id="5187629">func</span>&nbsp;<span class="ident" id="5187634">clamp</span><span class="op" id="5187639">(</span><span class="ident" id="5187640">i</span>&nbsp;<span class="builtintype" id="5187642">int32</span><span class="op" id="5187647">)</span>&nbsp;<span class="builtintype" id="5187649">int32</span>&nbsp;<span class="op" id="5187655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5187658">if</span>&nbsp;<span class="ident" id="5187661">i</span>&nbsp;<span class="op" id="5187663">&lt;</span>&nbsp;<span class="num" id="5187665">0</span>&nbsp;<span class="op" id="5187667">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5187671">return</span>&nbsp;<span class="num" id="5187678">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5187681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5187684">if</span>&nbsp;<span class="ident" id="5187687">i</span>&nbsp;<span class="op" id="5187689">&gt;</span>&nbsp;<span class="num" id="5187691">0xffff</span>&nbsp;<span class="op" id="5187698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5187702">return</span>&nbsp;<span class="num" id="5187709">0xffff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5187717">}</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5187720">return</span>&nbsp;<span class="ident" id="5187727">i</span><br>
<span class="lineno"></span><span class="op" id="5187729">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5187732">func</span>&nbsp;<span class="ident" id="5187737">drawPaletted</span><span class="op" id="5187749">(</span><span class="ident" id="5187750">dst</span>&nbsp;<span class="ident" id="5187754">Image</span><span class="op" id="5187759">,</span>&nbsp;<span class="ident" id="5187761">r</span>&nbsp;<span class="ident" id="5187763">image</span><span class="op" id="5187768">.</span><span class="ident" id="5187769">Rectangle</span><span class="op" id="5187778">,</span>&nbsp;<span class="ident" id="5187780">src</span>&nbsp;<span class="ident" id="5187784">image</span><span class="op" id="5187789">.</span><span class="ident" id="5187790">Image</span><span class="op" id="5187795">,</span>&nbsp;<span class="ident" id="5187797">sp</span>&nbsp;<span class="ident" id="5187800">image</span><span class="op" id="5187805">.</span><span class="ident" id="5187806">Point</span><span class="op" id="5187811">,</span>&nbsp;<span class="ident" id="5187813">floydSteinberg</span>&nbsp;<span class="builtintype" id="5187828">bool</span><span class="op" id="5187832">)</span>&nbsp;<span class="op" id="5187834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5187837">//&nbsp;TODO(nigeltao):&nbsp;handle&nbsp;the&nbsp;case&nbsp;where&nbsp;the&nbsp;dst&nbsp;and&nbsp;src&nbsp;overlap.</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5187904">//&nbsp;Does&nbsp;it&nbsp;even&nbsp;make&nbsp;sense&nbsp;to&nbsp;try&nbsp;and&nbsp;do&nbsp;Floyd-Steinberg&nbsp;whilst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5187969">//&nbsp;walking&nbsp;the&nbsp;image&nbsp;backward&nbsp;(right-to-left&nbsp;bottom-to-top)?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5188032">//&nbsp;If&nbsp;dst&nbsp;is&nbsp;an&nbsp;*image.Paletted,&nbsp;we&nbsp;have&nbsp;a&nbsp;fast&nbsp;path&nbsp;for&nbsp;dst.Set&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5188102">//&nbsp;dst.At.&nbsp;The&nbsp;dst.Set&nbsp;equivalent&nbsp;is&nbsp;a&nbsp;batch&nbsp;version&nbsp;of&nbsp;the&nbsp;algorithm</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5188173">//&nbsp;used&nbsp;by&nbsp;color.Palette&#39;s&nbsp;Index&nbsp;method&nbsp;in&nbsp;image/color/color.go,&nbsp;plus</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5188244">//&nbsp;optional&nbsp;Floyd-Steinberg&nbsp;error&nbsp;diffusion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5188290">palette</span><span class="op" id="5188297">,</span>&nbsp;<span class="ident" id="5188299">pix</span><span class="op" id="5188302">,</span>&nbsp;<span class="ident" id="5188304">stride</span>&nbsp;<span class="op" id="5188311">:=</span>&nbsp;<span class="op" id="5188314">[</span><span class="op" id="5188315">]</span><span class="op" id="5188316">[</span><span class="num" id="5188317">3</span><span class="op" id="5188318">]</span><span class="builtintype" id="5188319">int32</span><span class="op" id="5188324">(</span><span class="builtintype" id="5188325">nil</span><span class="op" id="5188328">)</span><span class="op" id="5188329">,</span>&nbsp;<span class="op" id="5188331">[</span><span class="op" id="5188332">]</span><span class="builtintype" id="5188333">byte</span><span class="op" id="5188337">(</span><span class="builtintype" id="5188338">nil</span><span class="op" id="5188341">)</span><span class="op" id="5188342">,</span>&nbsp;<span class="num" id="5188344">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5188347">if</span>&nbsp;<span class="ident" id="5188350">p</span><span class="op" id="5188351">,</span>&nbsp;<span class="ident" id="5188353">ok</span>&nbsp;<span class="op" id="5188356">:=</span>&nbsp;<span class="ident" id="5188359">dst</span><span class="op" id="5188362">.</span><span class="op" id="5188363">(</span><span class="op" id="5188364">*</span><span class="ident" id="5188365">image</span><span class="op" id="5188370">.</span><span class="ident" id="5188371">Paletted</span><span class="op" id="5188379">)</span><span class="op" id="5188380">;</span>&nbsp;<span class="ident" id="5188382">ok</span>&nbsp;<span class="op" id="5188385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5188389">palette</span>&nbsp;<span class="op" id="5188397">=</span>&nbsp;<span class="builtinfunc" id="5188399">make</span><span class="op" id="5188403">(</span><span class="op" id="5188404">[</span><span class="op" id="5188405">]</span><span class="op" id="5188406">[</span><span class="num" id="5188407">3</span><span class="op" id="5188408">]</span><span class="builtintype" id="5188409">int32</span><span class="op" id="5188414">,</span>&nbsp;<span class="builtinfunc" id="5188416">len</span><span class="op" id="5188419">(</span><span class="ident" id="5188420">p</span><span class="op" id="5188421">.</span><span class="ident" id="5188422">Palette</span><span class="op" id="5188429">)</span><span class="op" id="5188430">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5188434">for</span>&nbsp;<span class="ident" id="5188438">i</span><span class="op" id="5188439">,</span>&nbsp;<span class="ident" id="5188441">col</span>&nbsp;<span class="op" id="5188445">:=</span>&nbsp;<span class="keyword" id="5188448">range</span>&nbsp;<span class="ident" id="5188454">p</span><span class="op" id="5188455">.</span><span class="ident" id="5188456">Palette</span>&nbsp;<span class="op" id="5188464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5188469">r</span><span class="op" id="5188470">,</span>&nbsp;<span class="ident" id="5188472">g</span><span class="op" id="5188473">,</span>&nbsp;<span class="ident" id="5188475">b</span><span class="op" id="5188476">,</span>&nbsp;<span class="ident" id="5188478">_</span>&nbsp;<span class="op" id="5188480">:=</span>&nbsp;<span class="ident" id="5188483">col</span><span class="op" id="5188486">.</span><span class="ident" id="5188487">RGBA</span><span class="op" id="5188491">(</span><span class="op" id="5188492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5188497">palette</span><span class="op" id="5188504">[</span><span class="ident" id="5188505">i</span><span class="op" id="5188506">]</span><span class="op" id="5188507">[</span><span class="num" id="5188508">0</span><span class="op" id="5188509">]</span>&nbsp;<span class="op" id="5188511">=</span>&nbsp;<span class="builtintype" id="5188513">int32</span><span class="op" id="5188518">(</span><span class="ident" id="5188519">r</span><span class="op" id="5188520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5188525">palette</span><span class="op" id="5188532">[</span><span class="ident" id="5188533">i</span><span class="op" id="5188534">]</span><span class="op" id="5188535">[</span><span class="num" id="5188536">1</span><span class="op" id="5188537">]</span>&nbsp;<span class="op" id="5188539">=</span>&nbsp;<span class="builtintype" id="5188541">int32</span><span class="op" id="5188546">(</span><span class="ident" id="5188547">g</span><span class="op" id="5188548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5188553">palette</span><span class="op" id="5188560">[</span><span class="ident" id="5188561">i</span><span class="op" id="5188562">]</span><span class="op" id="5188563">[</span><span class="num" id="5188564">2</span><span class="op" id="5188565">]</span>&nbsp;<span class="op" id="5188567">=</span>&nbsp;<span class="builtintype" id="5188569">int32</span><span class="op" id="5188574">(</span><span class="ident" id="5188575">b</span><span class="op" id="5188576">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5188580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5188584">pix</span><span class="op" id="5188587">,</span>&nbsp;<span class="ident" id="5188589">stride</span>&nbsp;<span class="op" id="5188596">=</span>&nbsp;<span class="ident" id="5188598">p</span><span class="op" id="5188599">.</span><span class="ident" id="5188600">Pix</span><span class="op" id="5188603">[</span><span class="ident" id="5188604">p</span><span class="op" id="5188605">.</span><span class="ident" id="5188606">PixOffset</span><span class="op" id="5188615">(</span><span class="ident" id="5188616">r</span><span class="op" id="5188617">.</span><span class="ident" id="5188618">Min</span><span class="op" id="5188621">.</span><span class="ident" id="5188622">X</span><span class="op" id="5188623">,</span>&nbsp;<span class="ident" id="5188625">r</span><span class="op" id="5188626">.</span><span class="ident" id="5188627">Min</span><span class="op" id="5188630">.</span><span class="ident" id="5188631">Y</span><span class="op" id="5188632">)</span><span class="op" id="5188633">:</span><span class="op" id="5188634">]</span><span class="op" id="5188635">,</span>&nbsp;<span class="ident" id="5188637">p</span><span class="op" id="5188638">.</span><span class="ident" id="5188639">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5188647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5188651">//&nbsp;quantErrorCurr&nbsp;and&nbsp;quantErrorNext&nbsp;are&nbsp;the&nbsp;Floyd-Steinberg&nbsp;quantization</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5188726">//&nbsp;errors&nbsp;that&nbsp;have&nbsp;been&nbsp;propagated&nbsp;to&nbsp;the&nbsp;pixels&nbsp;in&nbsp;the&nbsp;current&nbsp;and&nbsp;next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5188801">//&nbsp;rows.&nbsp;The&nbsp;+2&nbsp;simplifies&nbsp;calculation&nbsp;near&nbsp;the&nbsp;edges.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5188857">var</span>&nbsp;<span class="ident" id="5188861">quantErrorCurr</span><span class="op" id="5188875">,</span>&nbsp;<span class="ident" id="5188877">quantErrorNext</span>&nbsp;<span class="op" id="5188892">[</span><span class="op" id="5188893">]</span><span class="op" id="5188894">[</span><span class="num" id="5188895">3</span><span class="op" id="5188896">]</span><span class="builtintype" id="5188897">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5188904">if</span>&nbsp;<span class="ident" id="5188907">floydSteinberg</span>&nbsp;<span class="op" id="5188922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5188926">quantErrorCurr</span>&nbsp;<span class="op" id="5188941">=</span>&nbsp;<span class="builtinfunc" id="5188943">make</span><span class="op" id="5188947">(</span><span class="op" id="5188948">[</span><span class="op" id="5188949">]</span><span class="op" id="5188950">[</span><span class="num" id="5188951">3</span><span class="op" id="5188952">]</span><span class="builtintype" id="5188953">int32</span><span class="op" id="5188958">,</span>&nbsp;<span class="ident" id="5188960">r</span><span class="op" id="5188961">.</span><span class="ident" id="5188962">Dx</span><span class="op" id="5188964">(</span><span class="op" id="5188965">)</span><span class="op" id="5188966">+</span><span class="num" id="5188967">2</span><span class="op" id="5188968">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5188972">quantErrorNext</span>&nbsp;<span class="op" id="5188987">=</span>&nbsp;<span class="builtinfunc" id="5188989">make</span><span class="op" id="5188993">(</span><span class="op" id="5188994">[</span><span class="op" id="5188995">]</span><span class="op" id="5188996">[</span><span class="num" id="5188997">3</span><span class="op" id="5188998">]</span><span class="builtintype" id="5188999">int32</span><span class="op" id="5189004">,</span>&nbsp;<span class="ident" id="5189006">r</span><span class="op" id="5189007">.</span><span class="ident" id="5189008">Dx</span><span class="op" id="5189010">(</span><span class="op" id="5189011">)</span><span class="op" id="5189012">+</span><span class="num" id="5189013">2</span><span class="op" id="5189014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5189017">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5189021">//&nbsp;Loop&nbsp;over&nbsp;each&nbsp;source&nbsp;pixel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5189054">out</span>&nbsp;<span class="op" id="5189058">:=</span>&nbsp;<span class="ident" id="5189061">color</span><span class="op" id="5189066">.</span><span class="ident" id="5189067">RGBA64</span><span class="op" id="5189073">{</span><span class="ident" id="5189074">A</span><span class="op" id="5189075">:</span>&nbsp;<span class="num" id="5189077">0xffff</span><span class="op" id="5189083">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5189086">for</span>&nbsp;<span class="ident" id="5189090">y</span>&nbsp;<span class="op" id="5189092">:=</span>&nbsp;<span class="num" id="5189095">0</span><span class="op" id="5189096">;</span>&nbsp;<span class="ident" id="5189098">y</span>&nbsp;<span class="op" id="5189100">!=</span>&nbsp;<span class="ident" id="5189103">r</span><span class="op" id="5189104">.</span><span class="ident" id="5189105">Dy</span><span class="op" id="5189107">(</span><span class="op" id="5189108">)</span><span class="op" id="5189109">;</span>&nbsp;<span class="ident" id="5189111">y</span><span class="op" id="5189112">++</span>&nbsp;<span class="op" id="5189115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5189119">for</span>&nbsp;<span class="ident" id="5189123">x</span>&nbsp;<span class="op" id="5189125">:=</span>&nbsp;<span class="num" id="5189128">0</span><span class="op" id="5189129">;</span>&nbsp;<span class="ident" id="5189131">x</span>&nbsp;<span class="op" id="5189133">!=</span>&nbsp;<span class="ident" id="5189136">r</span><span class="op" id="5189137">.</span><span class="ident" id="5189138">Dx</span><span class="op" id="5189140">(</span><span class="op" id="5189141">)</span><span class="op" id="5189142">;</span>&nbsp;<span class="ident" id="5189144">x</span><span class="op" id="5189145">++</span>&nbsp;<span class="op" id="5189148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5189153">//&nbsp;er,&nbsp;eg&nbsp;and&nbsp;eb&nbsp;are&nbsp;the&nbsp;pixel&#39;s&nbsp;R,G,B&nbsp;values&nbsp;plus&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5189211">//&nbsp;optional&nbsp;Floyd-Steinberg&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5189249">sr</span><span class="op" id="5189251">,</span>&nbsp;<span class="ident" id="5189253">sg</span><span class="op" id="5189255">,</span>&nbsp;<span class="ident" id="5189257">sb</span><span class="op" id="5189259">,</span>&nbsp;<span class="ident" id="5189261">_</span>&nbsp;<span class="op" id="5189263">:=</span>&nbsp;<span class="ident" id="5189266">src</span><span class="op" id="5189269">.</span><span class="ident" id="5189270">At</span><span class="op" id="5189272">(</span><span class="ident" id="5189273">sp</span><span class="op" id="5189275">.</span><span class="ident" id="5189276">X</span><span class="op" id="5189277">+</span><span class="ident" id="5189278">x</span><span class="op" id="5189279">,</span>&nbsp;<span class="ident" id="5189281">sp</span><span class="op" id="5189283">.</span><span class="ident" id="5189284">Y</span><span class="op" id="5189285">+</span><span class="ident" id="5189286">y</span><span class="op" id="5189287">)</span><span class="op" id="5189288">.</span><span class="ident" id="5189289">RGBA</span><span class="op" id="5189293">(</span><span class="op" id="5189294">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5189299">er</span><span class="op" id="5189301">,</span>&nbsp;<span class="ident" id="5189303">eg</span><span class="op" id="5189305">,</span>&nbsp;<span class="ident" id="5189307">eb</span>&nbsp;<span class="op" id="5189310">:=</span>&nbsp;<span class="builtintype" id="5189313">int32</span><span class="op" id="5189318">(</span><span class="ident" id="5189319">sr</span><span class="op" id="5189321">)</span><span class="op" id="5189322">,</span>&nbsp;<span class="builtintype" id="5189324">int32</span><span class="op" id="5189329">(</span><span class="ident" id="5189330">sg</span><span class="op" id="5189332">)</span><span class="op" id="5189333">,</span>&nbsp;<span class="builtintype" id="5189335">int32</span><span class="op" id="5189340">(</span><span class="ident" id="5189341">sb</span><span class="op" id="5189343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5189348">if</span>&nbsp;<span class="ident" id="5189351">floydSteinberg</span>&nbsp;<span class="op" id="5189366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5189372">er</span>&nbsp;<span class="op" id="5189375">=</span>&nbsp;<span class="ident" id="5189377">clamp</span><span class="op" id="5189382">(</span><span class="ident" id="5189383">er</span>&nbsp;<span class="op" id="5189386">+</span>&nbsp;<span class="ident" id="5189388">quantErrorCurr</span><span class="op" id="5189402">[</span><span class="ident" id="5189403">x</span><span class="op" id="5189404">+</span><span class="num" id="5189405">1</span><span class="op" id="5189406">]</span><span class="op" id="5189407">[</span><span class="num" id="5189408">0</span><span class="op" id="5189409">]</span><span class="op" id="5189410">/</span><span class="num" id="5189411">16</span><span class="op" id="5189413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5189419">eg</span>&nbsp;<span class="op" id="5189422">=</span>&nbsp;<span class="ident" id="5189424">clamp</span><span class="op" id="5189429">(</span><span class="ident" id="5189430">eg</span>&nbsp;<span class="op" id="5189433">+</span>&nbsp;<span class="ident" id="5189435">quantErrorCurr</span><span class="op" id="5189449">[</span><span class="ident" id="5189450">x</span><span class="op" id="5189451">+</span><span class="num" id="5189452">1</span><span class="op" id="5189453">]</span><span class="op" id="5189454">[</span><span class="num" id="5189455">1</span><span class="op" id="5189456">]</span><span class="op" id="5189457">/</span><span class="num" id="5189458">16</span><span class="op" id="5189460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5189466">eb</span>&nbsp;<span class="op" id="5189469">=</span>&nbsp;<span class="ident" id="5189471">clamp</span><span class="op" id="5189476">(</span><span class="ident" id="5189477">eb</span>&nbsp;<span class="op" id="5189480">+</span>&nbsp;<span class="ident" id="5189482">quantErrorCurr</span><span class="op" id="5189496">[</span><span class="ident" id="5189497">x</span><span class="op" id="5189498">+</span><span class="num" id="5189499">1</span><span class="op" id="5189500">]</span><span class="op" id="5189501">[</span><span class="num" id="5189502">2</span><span class="op" id="5189503">]</span><span class="op" id="5189504">/</span><span class="num" id="5189505">16</span><span class="op" id="5189507">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5189512">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5189518">if</span>&nbsp;<span class="ident" id="5189521">palette</span>&nbsp;<span class="op" id="5189529">!=</span>&nbsp;<span class="builtintype" id="5189532">nil</span>&nbsp;<span class="op" id="5189536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5189542">//&nbsp;Find&nbsp;the&nbsp;closest&nbsp;palette&nbsp;color&nbsp;in&nbsp;Euclidean&nbsp;R,G,B&nbsp;space:&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5189610">//&nbsp;one&nbsp;that&nbsp;minimizes&nbsp;sum-squared-difference.&nbsp;We&nbsp;shift&nbsp;by&nbsp;1&nbsp;bit</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5189678">//&nbsp;to&nbsp;avoid&nbsp;potential&nbsp;uint32&nbsp;overflow&nbsp;in&nbsp;sum-squared-difference.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5189747">//&nbsp;TODO(nigeltao):&nbsp;consider&nbsp;smarter&nbsp;algorithms.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5189799">bestIndex</span><span class="op" id="5189808">,</span>&nbsp;<span class="ident" id="5189810">bestSSD</span>&nbsp;<span class="op" id="5189818">:=</span>&nbsp;<span class="num" id="5189821">0</span><span class="op" id="5189822">,</span>&nbsp;<span class="builtintype" id="5189824">uint32</span><span class="op" id="5189830">(</span><span class="num" id="5189831">1</span><span class="op" id="5189832">&lt;&lt;</span><span class="num" id="5189834">32</span><span class="op" id="5189836">-</span><span class="num" id="5189837">1</span><span class="op" id="5189838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5189844">for</span>&nbsp;<span class="ident" id="5189848">index</span><span class="op" id="5189853">,</span>&nbsp;<span class="ident" id="5189855">p</span>&nbsp;<span class="op" id="5189857">:=</span>&nbsp;<span class="keyword" id="5189860">range</span>&nbsp;<span class="ident" id="5189866">palette</span>&nbsp;<span class="op" id="5189874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5189881">delta</span>&nbsp;<span class="op" id="5189887">:=</span>&nbsp;<span class="op" id="5189890">(</span><span class="ident" id="5189891">er</span>&nbsp;<span class="op" id="5189894">-</span>&nbsp;<span class="ident" id="5189896">p</span><span class="op" id="5189897">[</span><span class="num" id="5189898">0</span><span class="op" id="5189899">]</span><span class="op" id="5189900">)</span>&nbsp;<span class="op" id="5189902">&gt;&gt;</span>&nbsp;<span class="num" id="5189905">1</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5189912">ssd</span>&nbsp;<span class="op" id="5189916">:=</span>&nbsp;<span class="builtintype" id="5189919">uint32</span><span class="op" id="5189925">(</span><span class="ident" id="5189926">delta</span>&nbsp;<span class="op" id="5189932">*</span>&nbsp;<span class="ident" id="5189934">delta</span><span class="op" id="5189939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5189946">delta</span>&nbsp;<span class="op" id="5189952">=</span>&nbsp;<span class="op" id="5189954">(</span><span class="ident" id="5189955">eg</span>&nbsp;<span class="op" id="5189958">-</span>&nbsp;<span class="ident" id="5189960">p</span><span class="op" id="5189961">[</span><span class="num" id="5189962">1</span><span class="op" id="5189963">]</span><span class="op" id="5189964">)</span>&nbsp;<span class="op" id="5189966">&gt;&gt;</span>&nbsp;<span class="num" id="5189969">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5189976">ssd</span>&nbsp;<span class="op" id="5189980">+=</span>&nbsp;<span class="builtintype" id="5189983">uint32</span><span class="op" id="5189989">(</span><span class="ident" id="5189990">delta</span>&nbsp;<span class="op" id="5189996">*</span>&nbsp;<span class="ident" id="5189998">delta</span><span class="op" id="5190003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5190010">delta</span>&nbsp;<span class="op" id="5190016">=</span>&nbsp;<span class="op" id="5190018">(</span><span class="ident" id="5190019">eb</span>&nbsp;<span class="op" id="5190022">-</span>&nbsp;<span class="ident" id="5190024">p</span><span class="op" id="5190025">[</span><span class="num" id="5190026">2</span><span class="op" id="5190027">]</span><span class="op" id="5190028">)</span>&nbsp;<span class="op" id="5190030">&gt;&gt;</span>&nbsp;<span class="num" id="5190033">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5190040">ssd</span>&nbsp;<span class="op" id="5190044">+=</span>&nbsp;<span class="builtintype" id="5190047">uint32</span><span class="op" id="5190053">(</span><span class="ident" id="5190054">delta</span>&nbsp;<span class="op" id="5190060">*</span>&nbsp;<span class="ident" id="5190062">delta</span><span class="op" id="5190067">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5190074">if</span>&nbsp;<span class="ident" id="5190077">ssd</span>&nbsp;<span class="op" id="5190081">&lt;</span>&nbsp;<span class="ident" id="5190083">bestSSD</span>&nbsp;<span class="op" id="5190091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5190099">bestIndex</span><span class="op" id="5190108">,</span>&nbsp;<span class="ident" id="5190110">bestSSD</span>&nbsp;<span class="op" id="5190118">=</span>&nbsp;<span class="ident" id="5190120">index</span><span class="op" id="5190125">,</span>&nbsp;<span class="ident" id="5190127">ssd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5190137">if</span>&nbsp;<span class="ident" id="5190140">ssd</span>&nbsp;<span class="op" id="5190144">==</span>&nbsp;<span class="num" id="5190147">0</span>&nbsp;<span class="op" id="5190149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5190158">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5190170">}</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5190177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5190183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5190189">pix</span><span class="op" id="5190192">[</span><span class="ident" id="5190193">y</span><span class="op" id="5190194">*</span><span class="ident" id="5190195">stride</span><span class="op" id="5190201">+</span><span class="ident" id="5190202">x</span><span class="op" id="5190203">]</span>&nbsp;<span class="op" id="5190205">=</span>&nbsp;<span class="builtintype" id="5190207">byte</span><span class="op" id="5190211">(</span><span class="ident" id="5190212">bestIndex</span><span class="op" id="5190221">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5190228">if</span>&nbsp;<span class="op" id="5190231">!</span><span class="ident" id="5190232">floydSteinberg</span>&nbsp;<span class="op" id="5190247">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5190254">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5190267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5190273">er</span>&nbsp;<span class="op" id="5190276">-=</span>&nbsp;<span class="builtintype" id="5190279">int32</span><span class="op" id="5190284">(</span><span class="ident" id="5190285">palette</span><span class="op" id="5190292">[</span><span class="ident" id="5190293">bestIndex</span><span class="op" id="5190302">]</span><span class="op" id="5190303">[</span><span class="num" id="5190304">0</span><span class="op" id="5190305">]</span><span class="op" id="5190306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5190312">eg</span>&nbsp;<span class="op" id="5190315">-=</span>&nbsp;<span class="builtintype" id="5190318">int32</span><span class="op" id="5190323">(</span><span class="ident" id="5190324">palette</span><span class="op" id="5190331">[</span><span class="ident" id="5190332">bestIndex</span><span class="op" id="5190341">]</span><span class="op" id="5190342">[</span><span class="num" id="5190343">1</span><span class="op" id="5190344">]</span><span class="op" id="5190345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5190351">eb</span>&nbsp;<span class="op" id="5190354">-=</span>&nbsp;<span class="builtintype" id="5190357">int32</span><span class="op" id="5190362">(</span><span class="ident" id="5190363">palette</span><span class="op" id="5190370">[</span><span class="ident" id="5190371">bestIndex</span><span class="op" id="5190380">]</span><span class="op" id="5190381">[</span><span class="num" id="5190382">2</span><span class="op" id="5190383">]</span><span class="op" id="5190384">)</span><br>
<span class="lineno">630</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5190390">}</span>&nbsp;<span class="keyword" id="5190392">else</span>&nbsp;<span class="op" id="5190397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5190403">out</span><span class="op" id="5190406">.</span><span class="ident" id="5190407">R</span>&nbsp;<span class="op" id="5190409">=</span>&nbsp;<span class="builtintype" id="5190411">uint16</span><span class="op" id="5190417">(</span><span class="ident" id="5190418">er</span><span class="op" id="5190420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5190426">out</span><span class="op" id="5190429">.</span><span class="ident" id="5190430">G</span>&nbsp;<span class="op" id="5190432">=</span>&nbsp;<span class="builtintype" id="5190434">uint16</span><span class="op" id="5190440">(</span><span class="ident" id="5190441">eg</span><span class="op" id="5190443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5190449">out</span><span class="op" id="5190452">.</span><span class="ident" id="5190453">B</span>&nbsp;<span class="op" id="5190455">=</span>&nbsp;<span class="builtintype" id="5190457">uint16</span><span class="op" id="5190463">(</span><span class="ident" id="5190464">eb</span><span class="op" id="5190466">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5190472">//&nbsp;The&nbsp;third&nbsp;argument&nbsp;is&nbsp;&amp;out&nbsp;instead&nbsp;of&nbsp;out&nbsp;(and&nbsp;out&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5190533">//&nbsp;declared&nbsp;outside&nbsp;of&nbsp;the&nbsp;inner&nbsp;loop)&nbsp;to&nbsp;avoid&nbsp;the&nbsp;implicit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5190598">//&nbsp;conversion&nbsp;to&nbsp;color.Color&nbsp;here&nbsp;allocating&nbsp;memory&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5190661">//&nbsp;inner&nbsp;loop&nbsp;if&nbsp;sizeof(color.RGBA64)&nbsp;&gt;&nbsp;sizeof(uintptr).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5190722">dst</span><span class="op" id="5190725">.</span><span class="ident" id="5190726">Set</span><span class="op" id="5190729">(</span><span class="ident" id="5190730">r</span><span class="op" id="5190731">.</span><span class="ident" id="5190732">Min</span><span class="op" id="5190735">.</span><span class="ident" id="5190736">X</span><span class="op" id="5190737">+</span><span class="ident" id="5190738">x</span><span class="op" id="5190739">,</span>&nbsp;<span class="ident" id="5190741">r</span><span class="op" id="5190742">.</span><span class="ident" id="5190743">Min</span><span class="op" id="5190746">.</span><span class="ident" id="5190747">Y</span><span class="op" id="5190748">+</span><span class="ident" id="5190749">y</span><span class="op" id="5190750">,</span>&nbsp;<span class="op" id="5190752">&amp;</span><span class="ident" id="5190753">out</span><span class="op" id="5190756">)</span><br>
<span class="lineno">640</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5190763">if</span>&nbsp;<span class="op" id="5190766">!</span><span class="ident" id="5190767">floydSteinberg</span>&nbsp;<span class="op" id="5190782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5190789">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5190802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5190808">sr</span><span class="op" id="5190810">,</span>&nbsp;<span class="ident" id="5190812">sg</span><span class="op" id="5190814">,</span>&nbsp;<span class="ident" id="5190816">sb</span><span class="op" id="5190818">,</span>&nbsp;<span class="ident" id="5190820">_</span>&nbsp;<span class="op" id="5190822">=</span>&nbsp;<span class="ident" id="5190824">dst</span><span class="op" id="5190827">.</span><span class="ident" id="5190828">At</span><span class="op" id="5190830">(</span><span class="ident" id="5190831">r</span><span class="op" id="5190832">.</span><span class="ident" id="5190833">Min</span><span class="op" id="5190836">.</span><span class="ident" id="5190837">X</span><span class="op" id="5190838">+</span><span class="ident" id="5190839">x</span><span class="op" id="5190840">,</span>&nbsp;<span class="ident" id="5190842">r</span><span class="op" id="5190843">.</span><span class="ident" id="5190844">Min</span><span class="op" id="5190847">.</span><span class="ident" id="5190848">Y</span><span class="op" id="5190849">+</span><span class="ident" id="5190850">y</span><span class="op" id="5190851">)</span><span class="op" id="5190852">.</span><span class="ident" id="5190853">RGBA</span><span class="op" id="5190857">(</span><span class="op" id="5190858">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5190864">er</span>&nbsp;<span class="op" id="5190867">-=</span>&nbsp;<span class="builtintype" id="5190870">int32</span><span class="op" id="5190875">(</span><span class="ident" id="5190876">sr</span><span class="op" id="5190878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5190884">eg</span>&nbsp;<span class="op" id="5190887">-=</span>&nbsp;<span class="builtintype" id="5190890">int32</span><span class="op" id="5190895">(</span><span class="ident" id="5190896">sg</span><span class="op" id="5190898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5190904">eb</span>&nbsp;<span class="op" id="5190907">-=</span>&nbsp;<span class="builtintype" id="5190910">int32</span><span class="op" id="5190915">(</span><span class="ident" id="5190916">sb</span><span class="op" id="5190918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5190923">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5190929">//&nbsp;Propagate&nbsp;the&nbsp;Floyd-Steinberg&nbsp;quantization&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5190985">quantErrorNext</span><span class="op" id="5190999">[</span><span class="ident" id="5191000">x</span><span class="op" id="5191001">+</span><span class="num" id="5191002">0</span><span class="op" id="5191003">]</span><span class="op" id="5191004">[</span><span class="num" id="5191005">0</span><span class="op" id="5191006">]</span>&nbsp;<span class="op" id="5191008">+=</span>&nbsp;<span class="ident" id="5191011">er</span>&nbsp;<span class="op" id="5191014">*</span>&nbsp;<span class="num" id="5191016">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5191021">quantErrorNext</span><span class="op" id="5191035">[</span><span class="ident" id="5191036">x</span><span class="op" id="5191037">+</span><span class="num" id="5191038">0</span><span class="op" id="5191039">]</span><span class="op" id="5191040">[</span><span class="num" id="5191041">1</span><span class="op" id="5191042">]</span>&nbsp;<span class="op" id="5191044">+=</span>&nbsp;<span class="ident" id="5191047">eg</span>&nbsp;<span class="op" id="5191050">*</span>&nbsp;<span class="num" id="5191052">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5191057">quantErrorNext</span><span class="op" id="5191071">[</span><span class="ident" id="5191072">x</span><span class="op" id="5191073">+</span><span class="num" id="5191074">0</span><span class="op" id="5191075">]</span><span class="op" id="5191076">[</span><span class="num" id="5191077">2</span><span class="op" id="5191078">]</span>&nbsp;<span class="op" id="5191080">+=</span>&nbsp;<span class="ident" id="5191083">eb</span>&nbsp;<span class="op" id="5191086">*</span>&nbsp;<span class="num" id="5191088">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5191093">quantErrorNext</span><span class="op" id="5191107">[</span><span class="ident" id="5191108">x</span><span class="op" id="5191109">+</span><span class="num" id="5191110">1</span><span class="op" id="5191111">]</span><span class="op" id="5191112">[</span><span class="num" id="5191113">0</span><span class="op" id="5191114">]</span>&nbsp;<span class="op" id="5191116">+=</span>&nbsp;<span class="ident" id="5191119">er</span>&nbsp;<span class="op" id="5191122">*</span>&nbsp;<span class="num" id="5191124">5</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5191129">quantErrorNext</span><span class="op" id="5191143">[</span><span class="ident" id="5191144">x</span><span class="op" id="5191145">+</span><span class="num" id="5191146">1</span><span class="op" id="5191147">]</span><span class="op" id="5191148">[</span><span class="num" id="5191149">1</span><span class="op" id="5191150">]</span>&nbsp;<span class="op" id="5191152">+=</span>&nbsp;<span class="ident" id="5191155">eg</span>&nbsp;<span class="op" id="5191158">*</span>&nbsp;<span class="num" id="5191160">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5191165">quantErrorNext</span><span class="op" id="5191179">[</span><span class="ident" id="5191180">x</span><span class="op" id="5191181">+</span><span class="num" id="5191182">1</span><span class="op" id="5191183">]</span><span class="op" id="5191184">[</span><span class="num" id="5191185">2</span><span class="op" id="5191186">]</span>&nbsp;<span class="op" id="5191188">+=</span>&nbsp;<span class="ident" id="5191191">eb</span>&nbsp;<span class="op" id="5191194">*</span>&nbsp;<span class="num" id="5191196">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5191201">quantErrorNext</span><span class="op" id="5191215">[</span><span class="ident" id="5191216">x</span><span class="op" id="5191217">+</span><span class="num" id="5191218">2</span><span class="op" id="5191219">]</span><span class="op" id="5191220">[</span><span class="num" id="5191221">0</span><span class="op" id="5191222">]</span>&nbsp;<span class="op" id="5191224">+=</span>&nbsp;<span class="ident" id="5191227">er</span>&nbsp;<span class="op" id="5191230">*</span>&nbsp;<span class="num" id="5191232">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5191237">quantErrorNext</span><span class="op" id="5191251">[</span><span class="ident" id="5191252">x</span><span class="op" id="5191253">+</span><span class="num" id="5191254">2</span><span class="op" id="5191255">]</span><span class="op" id="5191256">[</span><span class="num" id="5191257">1</span><span class="op" id="5191258">]</span>&nbsp;<span class="op" id="5191260">+=</span>&nbsp;<span class="ident" id="5191263">eg</span>&nbsp;<span class="op" id="5191266">*</span>&nbsp;<span class="num" id="5191268">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5191273">quantErrorNext</span><span class="op" id="5191287">[</span><span class="ident" id="5191288">x</span><span class="op" id="5191289">+</span><span class="num" id="5191290">2</span><span class="op" id="5191291">]</span><span class="op" id="5191292">[</span><span class="num" id="5191293">2</span><span class="op" id="5191294">]</span>&nbsp;<span class="op" id="5191296">+=</span>&nbsp;<span class="ident" id="5191299">eb</span>&nbsp;<span class="op" id="5191302">*</span>&nbsp;<span class="num" id="5191304">1</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5191309">quantErrorCurr</span><span class="op" id="5191323">[</span><span class="ident" id="5191324">x</span><span class="op" id="5191325">+</span><span class="num" id="5191326">2</span><span class="op" id="5191327">]</span><span class="op" id="5191328">[</span><span class="num" id="5191329">0</span><span class="op" id="5191330">]</span>&nbsp;<span class="op" id="5191332">+=</span>&nbsp;<span class="ident" id="5191335">er</span>&nbsp;<span class="op" id="5191338">*</span>&nbsp;<span class="num" id="5191340">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5191345">quantErrorCurr</span><span class="op" id="5191359">[</span><span class="ident" id="5191360">x</span><span class="op" id="5191361">+</span><span class="num" id="5191362">2</span><span class="op" id="5191363">]</span><span class="op" id="5191364">[</span><span class="num" id="5191365">1</span><span class="op" id="5191366">]</span>&nbsp;<span class="op" id="5191368">+=</span>&nbsp;<span class="ident" id="5191371">eg</span>&nbsp;<span class="op" id="5191374">*</span>&nbsp;<span class="num" id="5191376">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5191381">quantErrorCurr</span><span class="op" id="5191395">[</span><span class="ident" id="5191396">x</span><span class="op" id="5191397">+</span><span class="num" id="5191398">2</span><span class="op" id="5191399">]</span><span class="op" id="5191400">[</span><span class="num" id="5191401">2</span><span class="op" id="5191402">]</span>&nbsp;<span class="op" id="5191404">+=</span>&nbsp;<span class="ident" id="5191407">eb</span>&nbsp;<span class="op" id="5191410">*</span>&nbsp;<span class="num" id="5191412">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5191416">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5191421">//&nbsp;Recycle&nbsp;the&nbsp;quantization&nbsp;error&nbsp;buffers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5191466">if</span>&nbsp;<span class="ident" id="5191469">floydSteinberg</span>&nbsp;<span class="op" id="5191484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5191489">quantErrorCurr</span><span class="op" id="5191503">,</span>&nbsp;<span class="ident" id="5191505">quantErrorNext</span>&nbsp;<span class="op" id="5191520">=</span>&nbsp;<span class="ident" id="5191522">quantErrorNext</span><span class="op" id="5191536">,</span>&nbsp;<span class="ident" id="5191538">quantErrorCurr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5191556">for</span>&nbsp;<span class="ident" id="5191560">i</span>&nbsp;<span class="op" id="5191562">:=</span>&nbsp;<span class="keyword" id="5191565">range</span>&nbsp;<span class="ident" id="5191571">quantErrorNext</span>&nbsp;<span class="op" id="5191586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5191592">quantErrorNext</span><span class="op" id="5191606">[</span><span class="ident" id="5191607">i</span><span class="op" id="5191608">]</span>&nbsp;<span class="op" id="5191610">=</span>&nbsp;<span class="op" id="5191612">[</span><span class="num" id="5191613">3</span><span class="op" id="5191614">]</span><span class="builtintype" id="5191615">int32</span><span class="op" id="5191620">{</span><span class="op" id="5191621">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5191626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5191630">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5191633">}</span><br>
<span class="lineno"></span><span class="op" id="5191635">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
