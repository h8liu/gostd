<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/jpeg</h2>
<ul>
<li><a href="/gostd/image/jpeg/dct_test.go.html">dct_test.go</a></li>
<li><a href="/gostd/image/jpeg/fdct.go.html">fdct.go</a></li>
<li><a href="/gostd/image/jpeg/huffman.go.html" class="current">huffman.go</a></li>
<li><a href="/gostd/image/jpeg/idct.go.html">idct.go</a></li>
<li><a href="/gostd/image/jpeg/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/jpeg/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/jpeg/scan.go.html">scan.go</a></li>
<li><a href="/gostd/image/jpeg/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/jpeg/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1723523">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1723578">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1723632">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1723683">package</span>&nbsp;<span class="ident" id="1723691">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1723697">import</span>&nbsp;<span class="op" id="1723704">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1723707">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="1723712">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="1723715">//&nbsp;maxCodeLength&nbsp;is&nbsp;the&nbsp;maximum&nbsp;(inclusive)&nbsp;number&nbsp;of&nbsp;bits&nbsp;in&nbsp;a&nbsp;Huffman&nbsp;code.</span><br>
<span class="lineno"></span><span class="keyword" id="1723793">const</span>&nbsp;<span class="ident" id="1723799">maxCodeLength</span>&nbsp;<span class="op" id="1723813">=</span>&nbsp;<span class="num" id="1723815">16</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1723819">//&nbsp;maxNCodes&nbsp;is&nbsp;the&nbsp;maximum&nbsp;(inclusive)&nbsp;number&nbsp;of&nbsp;codes&nbsp;in&nbsp;a&nbsp;Huffman&nbsp;tree.</span><br>
<span class="lineno">15</span><span class="keyword" id="1723894">const</span>&nbsp;<span class="ident" id="1723900">maxNCodes</span>&nbsp;<span class="op" id="1723910">=</span>&nbsp;<span class="num" id="1723912">256</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1723917">//&nbsp;lutSize&nbsp;is&nbsp;the&nbsp;log-2&nbsp;size&nbsp;of&nbsp;the&nbsp;Huffman&nbsp;decoder&#39;s&nbsp;look-up&nbsp;table.</span><br>
<span class="lineno"></span><span class="keyword" id="1723986">const</span>&nbsp;<span class="ident" id="1723992">lutSize</span>&nbsp;<span class="op" id="1724000">=</span>&nbsp;<span class="num" id="1724002">8</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="1724005">//&nbsp;huffman&nbsp;is&nbsp;a&nbsp;Huffman&nbsp;decoder,&nbsp;specified&nbsp;in&nbsp;section&nbsp;C.</span><br>
<span class="lineno"></span><span class="keyword" id="1724062">type</span>&nbsp;<span class="ident" id="1724067">huffman</span>&nbsp;<span class="keyword" id="1724075">struct</span>&nbsp;<span class="op" id="1724082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1724085">//&nbsp;length&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;codes&nbsp;in&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1724132">nCodes</span>&nbsp;<span class="builtintype" id="1724139">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1724146">//&nbsp;lut&nbsp;is&nbsp;the&nbsp;look-up&nbsp;table&nbsp;for&nbsp;the&nbsp;next&nbsp;lutSize&nbsp;bits&nbsp;in&nbsp;the&nbsp;bit-stream.</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1724220">//&nbsp;The&nbsp;high&nbsp;8&nbsp;bits&nbsp;of&nbsp;the&nbsp;uint16&nbsp;are&nbsp;the&nbsp;encoded&nbsp;value.&nbsp;The&nbsp;low&nbsp;8&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1724292">//&nbsp;are&nbsp;1&nbsp;plus&nbsp;the&nbsp;code&nbsp;length,&nbsp;or&nbsp;0&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;too&nbsp;large&nbsp;to&nbsp;fit&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1724365">//&nbsp;lutSize&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1724383">lut</span>&nbsp;<span class="op" id="1724387">[</span><span class="num" id="1724388">1</span>&nbsp;<span class="op" id="1724390">&lt;&lt;</span>&nbsp;<span class="ident" id="1724393">lutSize</span><span class="op" id="1724400">]</span><span class="builtintype" id="1724401">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1724409">//&nbsp;vals&nbsp;are&nbsp;the&nbsp;decoded&nbsp;values,&nbsp;sorted&nbsp;by&nbsp;their&nbsp;encoding.</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1724468">vals</span>&nbsp;<span class="op" id="1724473">[</span><span class="ident" id="1724474">maxNCodes</span><span class="op" id="1724483">]</span><span class="builtintype" id="1724484">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1724491">//&nbsp;minCodes[i]&nbsp;is&nbsp;the&nbsp;minimum&nbsp;code&nbsp;of&nbsp;length&nbsp;i,&nbsp;or&nbsp;-1&nbsp;if&nbsp;there&nbsp;are&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1724562">//&nbsp;codes&nbsp;of&nbsp;that&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1724588">minCodes</span>&nbsp;<span class="op" id="1724597">[</span><span class="ident" id="1724598">maxCodeLength</span><span class="op" id="1724611">]</span><span class="builtintype" id="1724612">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1724619">//&nbsp;maxCodes[i]&nbsp;is&nbsp;the&nbsp;maximum&nbsp;code&nbsp;of&nbsp;length&nbsp;i,&nbsp;or&nbsp;-1&nbsp;if&nbsp;there&nbsp;are&nbsp;no</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1724690">//&nbsp;codes&nbsp;of&nbsp;that&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1724716">maxCodes</span>&nbsp;<span class="op" id="1724725">[</span><span class="ident" id="1724726">maxCodeLength</span><span class="op" id="1724739">]</span><span class="builtintype" id="1724740">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1724747">//&nbsp;valsIndices[i]&nbsp;is&nbsp;the&nbsp;index&nbsp;into&nbsp;vals&nbsp;of&nbsp;minCodes[i].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1724805">valsIndices</span>&nbsp;<span class="op" id="1724817">[</span><span class="ident" id="1724818">maxCodeLength</span><span class="op" id="1724831">]</span><span class="builtintype" id="1724832">int32</span><br>
<span class="lineno"></span><span class="op" id="1724838">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="1724841">//&nbsp;errShortHuffmanData&nbsp;means&nbsp;that&nbsp;an&nbsp;unexpected&nbsp;EOF&nbsp;occurred&nbsp;while&nbsp;decoding</span><br>
<span class="lineno"></span><span class="comment" id="1724917">//&nbsp;Huffman&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="1724934">var</span>&nbsp;<span class="ident" id="1724938">errShortHuffmanData</span>&nbsp;<span class="op" id="1724958">=</span>&nbsp;<span class="ident" id="1724960">FormatError</span><span class="op" id="1724971">(</span><span class="string" id="1724972">&#34;short&nbsp;Huffman&nbsp;data&#34;</span><span class="op" id="1724992">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="1724995">//&nbsp;ensureNBits&nbsp;reads&nbsp;bytes&nbsp;from&nbsp;the&nbsp;byte&nbsp;buffer&nbsp;to&nbsp;ensure&nbsp;that&nbsp;d.bits.n&nbsp;is&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="1725073">//&nbsp;least&nbsp;n.&nbsp;For&nbsp;best&nbsp;performance&nbsp;(avoiding&nbsp;function&nbsp;calls&nbsp;inside&nbsp;hot&nbsp;loops),</span><br>
<span class="lineno"></span><span class="comment" id="1725150">//&nbsp;the&nbsp;caller&nbsp;is&nbsp;the&nbsp;one&nbsp;responsible&nbsp;for&nbsp;first&nbsp;checking&nbsp;that&nbsp;d.bits.n&nbsp;&lt;&nbsp;n.</span><br>
<span class="lineno"></span><span class="keyword" id="1725225">func</span>&nbsp;<span class="op" id="1725230">(</span><span class="ident" id="1725231">d</span>&nbsp;<span class="op" id="1725233">*</span><span class="ident" id="1725234">decoder</span><span class="op" id="1725241">)</span>&nbsp;<span class="ident" id="1725243">ensureNBits</span><span class="op" id="1725254">(</span><span class="ident" id="1725255">n</span>&nbsp;<span class="builtintype" id="1725257">int32</span><span class="op" id="1725262">)</span>&nbsp;<span class="builtintype" id="1725264">error</span>&nbsp;<span class="op" id="1725270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1725273">for</span>&nbsp;<span class="op" id="1725277">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1725281">c</span><span class="op" id="1725282">,</span>&nbsp;<span class="ident" id="1725284">err</span>&nbsp;<span class="op" id="1725288">:=</span>&nbsp;<span class="ident" id="1725291">d</span><span class="op" id="1725292">.</span><span class="ident" id="1725293">readByteStuffedByte</span><span class="op" id="1725312">(</span><span class="op" id="1725313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1725317">if</span>&nbsp;<span class="ident" id="1725320">err</span>&nbsp;<span class="op" id="1725324">!=</span>&nbsp;<span class="builtintype" id="1725327">nil</span>&nbsp;<span class="op" id="1725331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1725336">if</span>&nbsp;<span class="ident" id="1725339">err</span>&nbsp;<span class="op" id="1725343">==</span>&nbsp;<span class="ident" id="1725346">io</span><span class="op" id="1725348">.</span><span class="ident" id="1725349">EOF</span>&nbsp;<span class="op" id="1725353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1725359">return</span>&nbsp;<span class="ident" id="1725366">errShortHuffmanData</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1725389">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1725394">return</span>&nbsp;<span class="ident" id="1725401">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1725407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1725411">d</span><span class="op" id="1725412">.</span><span class="ident" id="1725413">bits</span><span class="op" id="1725417">.</span><span class="ident" id="1725418">a</span>&nbsp;<span class="op" id="1725420">=</span>&nbsp;<span class="ident" id="1725422">d</span><span class="op" id="1725423">.</span><span class="ident" id="1725424">bits</span><span class="op" id="1725428">.</span><span class="ident" id="1725429">a</span><span class="op" id="1725430">&lt;&lt;</span><span class="num" id="1725432">8</span>&nbsp;<span class="op" id="1725434">|</span>&nbsp;<span class="builtintype" id="1725436">uint32</span><span class="op" id="1725442">(</span><span class="ident" id="1725443">c</span><span class="op" id="1725444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1725448">d</span><span class="op" id="1725449">.</span><span class="ident" id="1725450">bits</span><span class="op" id="1725454">.</span><span class="ident" id="1725455">n</span>&nbsp;<span class="op" id="1725457">+=</span>&nbsp;<span class="num" id="1725460">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1725464">if</span>&nbsp;<span class="ident" id="1725467">d</span><span class="op" id="1725468">.</span><span class="ident" id="1725469">bits</span><span class="op" id="1725473">.</span><span class="ident" id="1725474">m</span>&nbsp;<span class="op" id="1725476">==</span>&nbsp;<span class="num" id="1725479">0</span>&nbsp;<span class="op" id="1725481">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1725486">d</span><span class="op" id="1725487">.</span><span class="ident" id="1725488">bits</span><span class="op" id="1725492">.</span><span class="ident" id="1725493">m</span>&nbsp;<span class="op" id="1725495">=</span>&nbsp;<span class="num" id="1725497">1</span>&nbsp;<span class="op" id="1725499">&lt;&lt;</span>&nbsp;<span class="num" id="1725502">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1725506">}</span>&nbsp;<span class="keyword" id="1725508">else</span>&nbsp;<span class="op" id="1725513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1725518">d</span><span class="op" id="1725519">.</span><span class="ident" id="1725520">bits</span><span class="op" id="1725524">.</span><span class="ident" id="1725525">m</span>&nbsp;<span class="op" id="1725527">&lt;&lt;=</span>&nbsp;<span class="num" id="1725531">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1725535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1725539">if</span>&nbsp;<span class="ident" id="1725542">d</span><span class="op" id="1725543">.</span><span class="ident" id="1725544">bits</span><span class="op" id="1725548">.</span><span class="ident" id="1725549">n</span>&nbsp;<span class="op" id="1725551">&gt;=</span>&nbsp;<span class="ident" id="1725554">n</span>&nbsp;<span class="op" id="1725556">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1725561">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1725569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1725572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1725575">return</span>&nbsp;<span class="builtintype" id="1725582">nil</span><br>
<span class="lineno"></span><span class="op" id="1725586">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment" id="1725589">//&nbsp;receiveExtend&nbsp;is&nbsp;the&nbsp;composition&nbsp;of&nbsp;RECEIVE&nbsp;and&nbsp;EXTEND,&nbsp;specified&nbsp;in&nbsp;section</span><br>
<span class="lineno"></span><span class="comment" id="1725669">//&nbsp;F.2.2.1.</span><br>
<span class="lineno"></span><span class="keyword" id="1725681">func</span>&nbsp;<span class="op" id="1725686">(</span><span class="ident" id="1725687">d</span>&nbsp;<span class="op" id="1725689">*</span><span class="ident" id="1725690">decoder</span><span class="op" id="1725697">)</span>&nbsp;<span class="ident" id="1725699">receiveExtend</span><span class="op" id="1725712">(</span><span class="ident" id="1725713">t</span>&nbsp;<span class="builtintype" id="1725715">uint8</span><span class="op" id="1725720">)</span>&nbsp;<span class="op" id="1725722">(</span><span class="builtintype" id="1725723">int32</span><span class="op" id="1725728">,</span>&nbsp;<span class="builtintype" id="1725730">error</span><span class="op" id="1725735">)</span>&nbsp;<span class="op" id="1725737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1725740">if</span>&nbsp;<span class="ident" id="1725743">d</span><span class="op" id="1725744">.</span><span class="ident" id="1725745">bits</span><span class="op" id="1725749">.</span><span class="ident" id="1725750">n</span>&nbsp;<span class="op" id="1725752">&lt;</span>&nbsp;<span class="builtintype" id="1725754">int32</span><span class="op" id="1725759">(</span><span class="ident" id="1725760">t</span><span class="op" id="1725761">)</span>&nbsp;<span class="op" id="1725763">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1725767">if</span>&nbsp;<span class="ident" id="1725770">err</span>&nbsp;<span class="op" id="1725774">:=</span>&nbsp;<span class="ident" id="1725777">d</span><span class="op" id="1725778">.</span><span class="ident" id="1725779">ensureNBits</span><span class="op" id="1725790">(</span><span class="builtintype" id="1725791">int32</span><span class="op" id="1725796">(</span><span class="ident" id="1725797">t</span><span class="op" id="1725798">)</span><span class="op" id="1725799">)</span><span class="op" id="1725800">;</span>&nbsp;<span class="ident" id="1725802">err</span>&nbsp;<span class="op" id="1725806">!=</span>&nbsp;<span class="builtintype" id="1725809">nil</span>&nbsp;<span class="op" id="1725813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1725818">return</span>&nbsp;<span class="num" id="1725825">0</span><span class="op" id="1725826">,</span>&nbsp;<span class="ident" id="1725828">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1725834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1725837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1725840">d</span><span class="op" id="1725841">.</span><span class="ident" id="1725842">bits</span><span class="op" id="1725846">.</span><span class="ident" id="1725847">n</span>&nbsp;<span class="op" id="1725849">-=</span>&nbsp;<span class="builtintype" id="1725852">int32</span><span class="op" id="1725857">(</span><span class="ident" id="1725858">t</span><span class="op" id="1725859">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1725862">d</span><span class="op" id="1725863">.</span><span class="ident" id="1725864">bits</span><span class="op" id="1725868">.</span><span class="ident" id="1725869">m</span>&nbsp;<span class="op" id="1725871">&gt;&gt;=</span>&nbsp;<span class="ident" id="1725875">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1725878">s</span>&nbsp;<span class="op" id="1725880">:=</span>&nbsp;<span class="builtintype" id="1725883">int32</span><span class="op" id="1725888">(</span><span class="num" id="1725889">1</span><span class="op" id="1725890">)</span>&nbsp;<span class="op" id="1725892">&lt;&lt;</span>&nbsp;<span class="ident" id="1725895">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1725898">x</span>&nbsp;<span class="op" id="1725900">:=</span>&nbsp;<span class="builtintype" id="1725903">int32</span><span class="op" id="1725908">(</span><span class="ident" id="1725909">d</span><span class="op" id="1725910">.</span><span class="ident" id="1725911">bits</span><span class="op" id="1725915">.</span><span class="ident" id="1725916">a</span><span class="op" id="1725917">&gt;&gt;</span><span class="builtintype" id="1725919">uint8</span><span class="op" id="1725924">(</span><span class="ident" id="1725925">d</span><span class="op" id="1725926">.</span><span class="ident" id="1725927">bits</span><span class="op" id="1725931">.</span><span class="ident" id="1725932">n</span><span class="op" id="1725933">)</span><span class="op" id="1725934">)</span>&nbsp;<span class="op" id="1725936">&amp;</span>&nbsp;<span class="op" id="1725938">(</span><span class="ident" id="1725939">s</span>&nbsp;<span class="op" id="1725941">-</span>&nbsp;<span class="num" id="1725943">1</span><span class="op" id="1725944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1725947">if</span>&nbsp;<span class="ident" id="1725950">x</span>&nbsp;<span class="op" id="1725952">&lt;</span>&nbsp;<span class="ident" id="1725954">s</span><span class="op" id="1725955">&gt;&gt;</span><span class="num" id="1725957">1</span>&nbsp;<span class="op" id="1725959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1725963">x</span>&nbsp;<span class="op" id="1725965">+=</span>&nbsp;<span class="op" id="1725968">(</span><span class="op" id="1725969">(</span><span class="op" id="1725970">-</span><span class="num" id="1725971">1</span><span class="op" id="1725972">)</span>&nbsp;<span class="op" id="1725974">&lt;&lt;</span>&nbsp;<span class="ident" id="1725977">t</span><span class="op" id="1725978">)</span>&nbsp;<span class="op" id="1725980">+</span>&nbsp;<span class="num" id="1725982">1</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1725985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1725988">return</span>&nbsp;<span class="ident" id="1725995">x</span><span class="op" id="1725996">,</span>&nbsp;<span class="builtintype" id="1725998">nil</span><br>
<span class="lineno"></span><span class="op" id="1726002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1726005">//&nbsp;processDHT&nbsp;processes&nbsp;a&nbsp;Define&nbsp;Huffman&nbsp;Table&nbsp;marker,&nbsp;and&nbsp;initializes&nbsp;a&nbsp;huffman</span><br>
<span class="lineno">90</span><span class="comment" id="1726086">//&nbsp;struct&nbsp;from&nbsp;its&nbsp;contents.&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.4.2.</span><br>
<span class="lineno"></span><span class="keyword" id="1726145">func</span>&nbsp;<span class="op" id="1726150">(</span><span class="ident" id="1726151">d</span>&nbsp;<span class="op" id="1726153">*</span><span class="ident" id="1726154">decoder</span><span class="op" id="1726161">)</span>&nbsp;<span class="ident" id="1726163">processDHT</span><span class="op" id="1726173">(</span><span class="ident" id="1726174">n</span>&nbsp;<span class="builtintype" id="1726176">int</span><span class="op" id="1726179">)</span>&nbsp;<span class="builtintype" id="1726181">error</span>&nbsp;<span class="op" id="1726187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1726190">for</span>&nbsp;<span class="ident" id="1726194">n</span>&nbsp;<span class="op" id="1726196">&gt;</span>&nbsp;<span class="num" id="1726198">0</span>&nbsp;<span class="op" id="1726200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1726204">if</span>&nbsp;<span class="ident" id="1726207">n</span>&nbsp;<span class="op" id="1726209">&lt;</span>&nbsp;<span class="num" id="1726211">17</span>&nbsp;<span class="op" id="1726214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1726219">return</span>&nbsp;<span class="ident" id="1726226">FormatError</span><span class="op" id="1726237">(</span><span class="string" id="1726238">&#34;DHT&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="1726260">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1726264">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1726268">if</span>&nbsp;<span class="ident" id="1726271">err</span>&nbsp;<span class="op" id="1726275">:=</span>&nbsp;<span class="ident" id="1726278">d</span><span class="op" id="1726279">.</span><span class="ident" id="1726280">readFull</span><span class="op" id="1726288">(</span><span class="ident" id="1726289">d</span><span class="op" id="1726290">.</span><span class="ident" id="1726291">tmp</span><span class="op" id="1726294">[</span><span class="op" id="1726295">:</span><span class="num" id="1726296">17</span><span class="op" id="1726298">]</span><span class="op" id="1726299">)</span><span class="op" id="1726300">;</span>&nbsp;<span class="ident" id="1726302">err</span>&nbsp;<span class="op" id="1726306">!=</span>&nbsp;<span class="builtintype" id="1726309">nil</span>&nbsp;<span class="op" id="1726313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1726318">return</span>&nbsp;<span class="ident" id="1726325">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1726331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1726335">tc</span>&nbsp;<span class="op" id="1726338">:=</span>&nbsp;<span class="ident" id="1726341">d</span><span class="op" id="1726342">.</span><span class="ident" id="1726343">tmp</span><span class="op" id="1726346">[</span><span class="num" id="1726347">0</span><span class="op" id="1726348">]</span>&nbsp;<span class="op" id="1726350">&gt;&gt;</span>&nbsp;<span class="num" id="1726353">4</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1726357">if</span>&nbsp;<span class="ident" id="1726360">tc</span>&nbsp;<span class="op" id="1726363">&gt;</span>&nbsp;<span class="ident" id="1726365">maxTc</span>&nbsp;<span class="op" id="1726371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1726376">return</span>&nbsp;<span class="ident" id="1726383">FormatError</span><span class="op" id="1726394">(</span><span class="string" id="1726395">&#34;bad&nbsp;Tc&nbsp;value&#34;</span><span class="op" id="1726409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1726413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1726417">th</span>&nbsp;<span class="op" id="1726420">:=</span>&nbsp;<span class="ident" id="1726423">d</span><span class="op" id="1726424">.</span><span class="ident" id="1726425">tmp</span><span class="op" id="1726428">[</span><span class="num" id="1726429">0</span><span class="op" id="1726430">]</span>&nbsp;<span class="op" id="1726432">&amp;</span>&nbsp;<span class="num" id="1726434">0x0f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1726441">if</span>&nbsp;<span class="ident" id="1726444">th</span>&nbsp;<span class="op" id="1726447">&gt;</span>&nbsp;<span class="ident" id="1726449">maxTh</span>&nbsp;<span class="op" id="1726455">||</span>&nbsp;<span class="op" id="1726458">!</span><span class="ident" id="1726459">d</span><span class="op" id="1726460">.</span><span class="ident" id="1726461">progressive</span>&nbsp;<span class="op" id="1726473">&amp;&amp;</span>&nbsp;<span class="ident" id="1726476">th</span>&nbsp;<span class="op" id="1726479">&gt;</span>&nbsp;<span class="num" id="1726481">1</span>&nbsp;<span class="op" id="1726483">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1726488">return</span>&nbsp;<span class="ident" id="1726495">FormatError</span><span class="op" id="1726506">(</span><span class="string" id="1726507">&#34;bad&nbsp;Th&nbsp;value&#34;</span><span class="op" id="1726521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1726525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1726529">h</span>&nbsp;<span class="op" id="1726531">:=</span>&nbsp;<span class="op" id="1726534">&amp;</span><span class="ident" id="1726535">d</span><span class="op" id="1726536">.</span><span class="ident" id="1726537">huff</span><span class="op" id="1726541">[</span><span class="ident" id="1726542">tc</span><span class="op" id="1726544">]</span><span class="op" id="1726545">[</span><span class="ident" id="1726546">th</span><span class="op" id="1726548">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1726553">//&nbsp;Read&nbsp;nCodes&nbsp;and&nbsp;h.vals&nbsp;(and&nbsp;derive&nbsp;h.nCodes).</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1726604">//&nbsp;nCodes[i]&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;codes&nbsp;with&nbsp;code&nbsp;length&nbsp;i.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1726662">//&nbsp;h.nCodes&nbsp;is&nbsp;the&nbsp;total&nbsp;number&nbsp;of&nbsp;codes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1726706">h</span><span class="op" id="1726707">.</span><span class="ident" id="1726708">nCodes</span>&nbsp;<span class="op" id="1726715">=</span>&nbsp;<span class="num" id="1726717">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1726721">var</span>&nbsp;<span class="ident" id="1726725">nCodes</span>&nbsp;<span class="op" id="1726732">[</span><span class="ident" id="1726733">maxCodeLength</span><span class="op" id="1726746">]</span><span class="builtintype" id="1726747">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1726755">for</span>&nbsp;<span class="ident" id="1726759">i</span>&nbsp;<span class="op" id="1726761">:=</span>&nbsp;<span class="keyword" id="1726764">range</span>&nbsp;<span class="ident" id="1726770">nCodes</span>&nbsp;<span class="op" id="1726777">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1726782">nCodes</span><span class="op" id="1726788">[</span><span class="ident" id="1726789">i</span><span class="op" id="1726790">]</span>&nbsp;<span class="op" id="1726792">=</span>&nbsp;<span class="builtintype" id="1726794">int32</span><span class="op" id="1726799">(</span><span class="ident" id="1726800">d</span><span class="op" id="1726801">.</span><span class="ident" id="1726802">tmp</span><span class="op" id="1726805">[</span><span class="ident" id="1726806">i</span><span class="op" id="1726807">+</span><span class="num" id="1726808">1</span><span class="op" id="1726809">]</span><span class="op" id="1726810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1726815">h</span><span class="op" id="1726816">.</span><span class="ident" id="1726817">nCodes</span>&nbsp;<span class="op" id="1726824">+=</span>&nbsp;<span class="ident" id="1726827">nCodes</span><span class="op" id="1726833">[</span><span class="ident" id="1726834">i</span><span class="op" id="1726835">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1726839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1726843">if</span>&nbsp;<span class="ident" id="1726846">h</span><span class="op" id="1726847">.</span><span class="ident" id="1726848">nCodes</span>&nbsp;<span class="op" id="1726855">==</span>&nbsp;<span class="num" id="1726858">0</span>&nbsp;<span class="op" id="1726860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1726865">return</span>&nbsp;<span class="ident" id="1726872">FormatError</span><span class="op" id="1726883">(</span><span class="string" id="1726884">&#34;Huffman&nbsp;table&nbsp;has&nbsp;zero&nbsp;length&#34;</span><span class="op" id="1726915">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1726919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1726923">if</span>&nbsp;<span class="ident" id="1726926">h</span><span class="op" id="1726927">.</span><span class="ident" id="1726928">nCodes</span>&nbsp;<span class="op" id="1726935">&gt;</span>&nbsp;<span class="ident" id="1726937">maxNCodes</span>&nbsp;<span class="op" id="1726947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1726952">return</span>&nbsp;<span class="ident" id="1726959">FormatError</span><span class="op" id="1726970">(</span><span class="string" id="1726971">&#34;Huffman&nbsp;table&nbsp;has&nbsp;excessive&nbsp;length&#34;</span><span class="op" id="1727007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1727011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727015">n</span>&nbsp;<span class="op" id="1727017">-=</span>&nbsp;<span class="builtintype" id="1727020">int</span><span class="op" id="1727023">(</span><span class="ident" id="1727024">h</span><span class="op" id="1727025">.</span><span class="ident" id="1727026">nCodes</span><span class="op" id="1727032">)</span>&nbsp;<span class="op" id="1727034">+</span>&nbsp;<span class="num" id="1727036">17</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1727041">if</span>&nbsp;<span class="ident" id="1727044">n</span>&nbsp;<span class="op" id="1727046">&lt;</span>&nbsp;<span class="num" id="1727048">0</span>&nbsp;<span class="op" id="1727050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1727055">return</span>&nbsp;<span class="ident" id="1727062">FormatError</span><span class="op" id="1727073">(</span><span class="string" id="1727074">&#34;DHT&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="1727096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1727100">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1727104">if</span>&nbsp;<span class="ident" id="1727107">err</span>&nbsp;<span class="op" id="1727111">:=</span>&nbsp;<span class="ident" id="1727114">d</span><span class="op" id="1727115">.</span><span class="ident" id="1727116">readFull</span><span class="op" id="1727124">(</span><span class="ident" id="1727125">h</span><span class="op" id="1727126">.</span><span class="ident" id="1727127">vals</span><span class="op" id="1727131">[</span><span class="op" id="1727132">:</span><span class="ident" id="1727133">h</span><span class="op" id="1727134">.</span><span class="ident" id="1727135">nCodes</span><span class="op" id="1727141">]</span><span class="op" id="1727142">)</span><span class="op" id="1727143">;</span>&nbsp;<span class="ident" id="1727145">err</span>&nbsp;<span class="op" id="1727149">!=</span>&nbsp;<span class="builtintype" id="1727152">nil</span>&nbsp;<span class="op" id="1727156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1727161">return</span>&nbsp;<span class="ident" id="1727168">err</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1727174">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1727179">//&nbsp;Derive&nbsp;the&nbsp;look-up&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1727210">for</span>&nbsp;<span class="ident" id="1727214">i</span>&nbsp;<span class="op" id="1727216">:=</span>&nbsp;<span class="keyword" id="1727219">range</span>&nbsp;<span class="ident" id="1727225">h</span><span class="op" id="1727226">.</span><span class="ident" id="1727227">lut</span>&nbsp;<span class="op" id="1727231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727236">h</span><span class="op" id="1727237">.</span><span class="ident" id="1727238">lut</span><span class="op" id="1727241">[</span><span class="ident" id="1727242">i</span><span class="op" id="1727243">]</span>&nbsp;<span class="op" id="1727245">=</span>&nbsp;<span class="num" id="1727247">0</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1727251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1727255">var</span>&nbsp;<span class="ident" id="1727259">x</span><span class="op" id="1727260">,</span>&nbsp;<span class="ident" id="1727262">code</span>&nbsp;<span class="builtintype" id="1727267">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1727276">for</span>&nbsp;<span class="ident" id="1727280">i</span>&nbsp;<span class="op" id="1727282">:=</span>&nbsp;<span class="builtintype" id="1727285">uint32</span><span class="op" id="1727291">(</span><span class="num" id="1727292">0</span><span class="op" id="1727293">)</span><span class="op" id="1727294">;</span>&nbsp;<span class="ident" id="1727296">i</span>&nbsp;<span class="op" id="1727298">&lt;</span>&nbsp;<span class="ident" id="1727300">lutSize</span><span class="op" id="1727307">;</span>&nbsp;<span class="ident" id="1727309">i</span><span class="op" id="1727310">++</span>&nbsp;<span class="op" id="1727313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727318">code</span>&nbsp;<span class="op" id="1727323">&lt;&lt;=</span>&nbsp;<span class="num" id="1727327">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1727332">for</span>&nbsp;<span class="ident" id="1727336">j</span>&nbsp;<span class="op" id="1727338">:=</span>&nbsp;<span class="builtintype" id="1727341">int32</span><span class="op" id="1727346">(</span><span class="num" id="1727347">0</span><span class="op" id="1727348">)</span><span class="op" id="1727349">;</span>&nbsp;<span class="ident" id="1727351">j</span>&nbsp;<span class="op" id="1727353">&lt;</span>&nbsp;<span class="ident" id="1727355">nCodes</span><span class="op" id="1727361">[</span><span class="ident" id="1727362">i</span><span class="op" id="1727363">]</span><span class="op" id="1727364">;</span>&nbsp;<span class="ident" id="1727366">j</span><span class="op" id="1727367">++</span>&nbsp;<span class="op" id="1727370">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1727376">//&nbsp;The&nbsp;codeLength&nbsp;is&nbsp;1+i,&nbsp;so&nbsp;shift&nbsp;code&nbsp;by&nbsp;8-(1+i)&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1727434">//&nbsp;calculate&nbsp;the&nbsp;high&nbsp;bits&nbsp;for&nbsp;every&nbsp;8-bit&nbsp;sequence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1727490">//&nbsp;whose&nbsp;codeLength&#39;s&nbsp;high&nbsp;bits&nbsp;matches&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1727540">//&nbsp;The&nbsp;high&nbsp;8&nbsp;bits&nbsp;of&nbsp;lutValue&nbsp;are&nbsp;the&nbsp;encoded&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1727598">//&nbsp;The&nbsp;low&nbsp;8&nbsp;bits&nbsp;are&nbsp;1&nbsp;plus&nbsp;the&nbsp;codeLength.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727647">base</span>&nbsp;<span class="op" id="1727652">:=</span>&nbsp;<span class="builtintype" id="1727655">uint8</span><span class="op" id="1727660">(</span><span class="ident" id="1727661">code</span>&nbsp;<span class="op" id="1727666">&lt;&lt;</span>&nbsp;<span class="op" id="1727669">(</span><span class="num" id="1727670">7</span>&nbsp;<span class="op" id="1727672">-</span>&nbsp;<span class="ident" id="1727674">i</span><span class="op" id="1727675">)</span><span class="op" id="1727676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727682">lutValue</span>&nbsp;<span class="op" id="1727691">:=</span>&nbsp;<span class="builtintype" id="1727694">uint16</span><span class="op" id="1727700">(</span><span class="ident" id="1727701">h</span><span class="op" id="1727702">.</span><span class="ident" id="1727703">vals</span><span class="op" id="1727707">[</span><span class="ident" id="1727708">x</span><span class="op" id="1727709">]</span><span class="op" id="1727710">)</span><span class="op" id="1727711">&lt;&lt;</span><span class="num" id="1727713">8</span>&nbsp;<span class="op" id="1727715">|</span>&nbsp;<span class="builtintype" id="1727717">uint16</span><span class="op" id="1727723">(</span><span class="num" id="1727724">2</span><span class="op" id="1727725">+</span><span class="ident" id="1727726">i</span><span class="op" id="1727727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1727733">for</span>&nbsp;<span class="ident" id="1727737">k</span>&nbsp;<span class="op" id="1727739">:=</span>&nbsp;<span class="builtintype" id="1727742">uint8</span><span class="op" id="1727747">(</span><span class="num" id="1727748">0</span><span class="op" id="1727749">)</span><span class="op" id="1727750">;</span>&nbsp;<span class="ident" id="1727752">k</span>&nbsp;<span class="op" id="1727754">&lt;</span>&nbsp;<span class="num" id="1727756">1</span><span class="op" id="1727757">&lt;&lt;</span><span class="op" id="1727759">(</span><span class="num" id="1727760">7</span><span class="op" id="1727761">-</span><span class="ident" id="1727762">i</span><span class="op" id="1727763">)</span><span class="op" id="1727764">;</span>&nbsp;<span class="ident" id="1727766">k</span><span class="op" id="1727767">++</span>&nbsp;<span class="op" id="1727770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727777">h</span><span class="op" id="1727778">.</span><span class="ident" id="1727779">lut</span><span class="op" id="1727782">[</span><span class="ident" id="1727783">base</span><span class="op" id="1727787">|</span><span class="ident" id="1727788">k</span><span class="op" id="1727789">]</span>&nbsp;<span class="op" id="1727791">=</span>&nbsp;<span class="ident" id="1727793">lutValue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1727806">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727812">code</span><span class="op" id="1727816">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727823">x</span><span class="op" id="1727824">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1727830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1727834">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1727839">//&nbsp;Derive&nbsp;minCodes,&nbsp;maxCodes,&nbsp;and&nbsp;valsIndices.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1727888">var</span>&nbsp;<span class="ident" id="1727892">c</span><span class="op" id="1727893">,</span>&nbsp;<span class="ident" id="1727895">index</span>&nbsp;<span class="builtintype" id="1727901">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1727909">for</span>&nbsp;<span class="ident" id="1727913">i</span><span class="op" id="1727914">,</span>&nbsp;<span class="ident" id="1727916">n</span>&nbsp;<span class="op" id="1727918">:=</span>&nbsp;<span class="keyword" id="1727921">range</span>&nbsp;<span class="ident" id="1727927">nCodes</span>&nbsp;<span class="op" id="1727934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1727939">if</span>&nbsp;<span class="ident" id="1727942">n</span>&nbsp;<span class="op" id="1727944">==</span>&nbsp;<span class="num" id="1727947">0</span>&nbsp;<span class="op" id="1727949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727955">h</span><span class="op" id="1727956">.</span><span class="ident" id="1727957">minCodes</span><span class="op" id="1727965">[</span><span class="ident" id="1727966">i</span><span class="op" id="1727967">]</span>&nbsp;<span class="op" id="1727969">=</span>&nbsp;<span class="op" id="1727971">-</span><span class="num" id="1727972">1</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727978">h</span><span class="op" id="1727979">.</span><span class="ident" id="1727980">maxCodes</span><span class="op" id="1727988">[</span><span class="ident" id="1727989">i</span><span class="op" id="1727990">]</span>&nbsp;<span class="op" id="1727992">=</span>&nbsp;<span class="op" id="1727994">-</span><span class="num" id="1727995">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1728001">h</span><span class="op" id="1728002">.</span><span class="ident" id="1728003">valsIndices</span><span class="op" id="1728014">[</span><span class="ident" id="1728015">i</span><span class="op" id="1728016">]</span>&nbsp;<span class="op" id="1728018">=</span>&nbsp;<span class="op" id="1728020">-</span><span class="num" id="1728021">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1728026">}</span>&nbsp;<span class="keyword" id="1728028">else</span>&nbsp;<span class="op" id="1728033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1728039">h</span><span class="op" id="1728040">.</span><span class="ident" id="1728041">minCodes</span><span class="op" id="1728049">[</span><span class="ident" id="1728050">i</span><span class="op" id="1728051">]</span>&nbsp;<span class="op" id="1728053">=</span>&nbsp;<span class="ident" id="1728055">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1728061">h</span><span class="op" id="1728062">.</span><span class="ident" id="1728063">maxCodes</span><span class="op" id="1728071">[</span><span class="ident" id="1728072">i</span><span class="op" id="1728073">]</span>&nbsp;<span class="op" id="1728075">=</span>&nbsp;<span class="ident" id="1728077">c</span>&nbsp;<span class="op" id="1728079">+</span>&nbsp;<span class="ident" id="1728081">n</span>&nbsp;<span class="op" id="1728083">-</span>&nbsp;<span class="num" id="1728085">1</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1728091">h</span><span class="op" id="1728092">.</span><span class="ident" id="1728093">valsIndices</span><span class="op" id="1728104">[</span><span class="ident" id="1728105">i</span><span class="op" id="1728106">]</span>&nbsp;<span class="op" id="1728108">=</span>&nbsp;<span class="ident" id="1728110">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1728120">c</span>&nbsp;<span class="op" id="1728122">+=</span>&nbsp;<span class="ident" id="1728125">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1728131">index</span>&nbsp;<span class="op" id="1728137">+=</span>&nbsp;<span class="ident" id="1728140">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1728145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1728150">c</span>&nbsp;<span class="op" id="1728152">&lt;&lt;=</span>&nbsp;<span class="num" id="1728156">1</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1728160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1728163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1728166">return</span>&nbsp;<span class="builtintype" id="1728173">nil</span><br>
<span class="lineno"></span><span class="op" id="1728177">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="comment" id="1728180">//&nbsp;decodeHuffman&nbsp;returns&nbsp;the&nbsp;next&nbsp;Huffman-coded&nbsp;value&nbsp;from&nbsp;the&nbsp;bit-stream,</span><br>
<span class="lineno"></span><span class="comment" id="1728255">//&nbsp;decoded&nbsp;according&nbsp;to&nbsp;h.</span><br>
<span class="lineno"></span><span class="keyword" id="1728282">func</span>&nbsp;<span class="op" id="1728287">(</span><span class="ident" id="1728288">d</span>&nbsp;<span class="op" id="1728290">*</span><span class="ident" id="1728291">decoder</span><span class="op" id="1728298">)</span>&nbsp;<span class="ident" id="1728300">decodeHuffman</span><span class="op" id="1728313">(</span><span class="ident" id="1728314">h</span>&nbsp;<span class="op" id="1728316">*</span><span class="ident" id="1728317">huffman</span><span class="op" id="1728324">)</span>&nbsp;<span class="op" id="1728326">(</span><span class="builtintype" id="1728327">uint8</span><span class="op" id="1728332">,</span>&nbsp;<span class="builtintype" id="1728334">error</span><span class="op" id="1728339">)</span>&nbsp;<span class="op" id="1728341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1728344">if</span>&nbsp;<span class="ident" id="1728347">h</span><span class="op" id="1728348">.</span><span class="ident" id="1728349">nCodes</span>&nbsp;<span class="op" id="1728356">==</span>&nbsp;<span class="num" id="1728359">0</span>&nbsp;<span class="op" id="1728361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1728365">return</span>&nbsp;<span class="num" id="1728372">0</span><span class="op" id="1728373">,</span>&nbsp;<span class="ident" id="1728375">FormatError</span><span class="op" id="1728386">(</span><span class="string" id="1728387">&#34;uninitialized&nbsp;Huffman&nbsp;table&#34;</span><span class="op" id="1728416">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1728419">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1728423">if</span>&nbsp;<span class="ident" id="1728426">d</span><span class="op" id="1728427">.</span><span class="ident" id="1728428">bits</span><span class="op" id="1728432">.</span><span class="ident" id="1728433">n</span>&nbsp;<span class="op" id="1728435">&lt;</span>&nbsp;<span class="num" id="1728437">8</span>&nbsp;<span class="op" id="1728439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1728443">if</span>&nbsp;<span class="ident" id="1728446">err</span>&nbsp;<span class="op" id="1728450">:=</span>&nbsp;<span class="ident" id="1728453">d</span><span class="op" id="1728454">.</span><span class="ident" id="1728455">ensureNBits</span><span class="op" id="1728466">(</span><span class="num" id="1728467">8</span><span class="op" id="1728468">)</span><span class="op" id="1728469">;</span>&nbsp;<span class="ident" id="1728471">err</span>&nbsp;<span class="op" id="1728475">!=</span>&nbsp;<span class="builtintype" id="1728478">nil</span>&nbsp;<span class="op" id="1728482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1728487">if</span>&nbsp;<span class="ident" id="1728490">err</span>&nbsp;<span class="op" id="1728494">!=</span>&nbsp;<span class="ident" id="1728497">errMissingFF00</span>&nbsp;<span class="op" id="1728512">&amp;&amp;</span>&nbsp;<span class="ident" id="1728515">err</span>&nbsp;<span class="op" id="1728519">!=</span>&nbsp;<span class="ident" id="1728522">errShortHuffmanData</span>&nbsp;<span class="op" id="1728542">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1728548">return</span>&nbsp;<span class="num" id="1728555">0</span><span class="op" id="1728556">,</span>&nbsp;<span class="ident" id="1728558">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1728565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1728570">//&nbsp;There&nbsp;are&nbsp;no&nbsp;more&nbsp;bytes&nbsp;of&nbsp;data&nbsp;in&nbsp;this&nbsp;segment,&nbsp;but&nbsp;we&nbsp;may&nbsp;still</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1728642">//&nbsp;be&nbsp;able&nbsp;to&nbsp;read&nbsp;the&nbsp;next&nbsp;symbol&nbsp;out&nbsp;of&nbsp;the&nbsp;previously&nbsp;read&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1728713">//&nbsp;First,&nbsp;undo&nbsp;the&nbsp;readByte&nbsp;that&nbsp;the&nbsp;ensureNBits&nbsp;call&nbsp;made.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1728776">d</span><span class="op" id="1728777">.</span><span class="ident" id="1728778">unreadByteStuffedByte</span><span class="op" id="1728799">(</span><span class="op" id="1728800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1728805">goto</span>&nbsp;<span class="ident" id="1728810">slowPath</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1728821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1728824">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1728827">if</span>&nbsp;<span class="ident" id="1728830">v</span>&nbsp;<span class="op" id="1728832">:=</span>&nbsp;<span class="ident" id="1728835">h</span><span class="op" id="1728836">.</span><span class="ident" id="1728837">lut</span><span class="op" id="1728840">[</span><span class="op" id="1728841">(</span><span class="ident" id="1728842">d</span><span class="op" id="1728843">.</span><span class="ident" id="1728844">bits</span><span class="op" id="1728848">.</span><span class="ident" id="1728849">a</span><span class="op" id="1728850">&gt;&gt;</span><span class="builtintype" id="1728852">uint32</span><span class="op" id="1728858">(</span><span class="ident" id="1728859">d</span><span class="op" id="1728860">.</span><span class="ident" id="1728861">bits</span><span class="op" id="1728865">.</span><span class="ident" id="1728866">n</span><span class="op" id="1728867">-</span><span class="ident" id="1728868">lutSize</span><span class="op" id="1728875">)</span><span class="op" id="1728876">)</span><span class="op" id="1728877">&amp;</span><span class="num" id="1728878">0xff</span><span class="op" id="1728882">]</span><span class="op" id="1728883">;</span>&nbsp;<span class="ident" id="1728885">v</span>&nbsp;<span class="op" id="1728887">!=</span>&nbsp;<span class="num" id="1728890">0</span>&nbsp;<span class="op" id="1728892">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1728896">n</span>&nbsp;<span class="op" id="1728898">:=</span>&nbsp;<span class="op" id="1728901">(</span><span class="ident" id="1728902">v</span>&nbsp;<span class="op" id="1728904">&amp;</span>&nbsp;<span class="num" id="1728906">0xff</span><span class="op" id="1728910">)</span>&nbsp;<span class="op" id="1728912">-</span>&nbsp;<span class="num" id="1728914">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1728918">d</span><span class="op" id="1728919">.</span><span class="ident" id="1728920">bits</span><span class="op" id="1728924">.</span><span class="ident" id="1728925">n</span>&nbsp;<span class="op" id="1728927">-=</span>&nbsp;<span class="builtintype" id="1728930">int32</span><span class="op" id="1728935">(</span><span class="ident" id="1728936">n</span><span class="op" id="1728937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1728941">d</span><span class="op" id="1728942">.</span><span class="ident" id="1728943">bits</span><span class="op" id="1728947">.</span><span class="ident" id="1728948">m</span>&nbsp;<span class="op" id="1728950">&gt;&gt;=</span>&nbsp;<span class="ident" id="1728954">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1728958">return</span>&nbsp;<span class="builtintype" id="1728965">uint8</span><span class="op" id="1728970">(</span><span class="ident" id="1728971">v</span>&nbsp;<span class="op" id="1728973">&gt;&gt;</span>&nbsp;<span class="num" id="1728976">8</span><span class="op" id="1728977">)</span><span class="op" id="1728978">,</span>&nbsp;<span class="builtintype" id="1728980">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1728985">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="ident" id="1728988">slowPath</span><span class="op" id="1728996">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1728999">for</span>&nbsp;<span class="ident" id="1729003">i</span><span class="op" id="1729004">,</span>&nbsp;<span class="ident" id="1729006">code</span>&nbsp;<span class="op" id="1729011">:=</span>&nbsp;<span class="num" id="1729014">0</span><span class="op" id="1729015">,</span>&nbsp;<span class="builtintype" id="1729017">int32</span><span class="op" id="1729022">(</span><span class="num" id="1729023">0</span><span class="op" id="1729024">)</span><span class="op" id="1729025">;</span>&nbsp;<span class="ident" id="1729027">i</span>&nbsp;<span class="op" id="1729029">&lt;</span>&nbsp;<span class="ident" id="1729031">maxCodeLength</span><span class="op" id="1729044">;</span>&nbsp;<span class="ident" id="1729046">i</span><span class="op" id="1729047">++</span>&nbsp;<span class="op" id="1729050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1729054">if</span>&nbsp;<span class="ident" id="1729057">d</span><span class="op" id="1729058">.</span><span class="ident" id="1729059">bits</span><span class="op" id="1729063">.</span><span class="ident" id="1729064">n</span>&nbsp;<span class="op" id="1729066">==</span>&nbsp;<span class="num" id="1729069">0</span>&nbsp;<span class="op" id="1729071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1729076">if</span>&nbsp;<span class="ident" id="1729079">err</span>&nbsp;<span class="op" id="1729083">:=</span>&nbsp;<span class="ident" id="1729086">d</span><span class="op" id="1729087">.</span><span class="ident" id="1729088">ensureNBits</span><span class="op" id="1729099">(</span><span class="num" id="1729100">1</span><span class="op" id="1729101">)</span><span class="op" id="1729102">;</span>&nbsp;<span class="ident" id="1729104">err</span>&nbsp;<span class="op" id="1729108">!=</span>&nbsp;<span class="builtintype" id="1729111">nil</span>&nbsp;<span class="op" id="1729115">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1729121">return</span>&nbsp;<span class="num" id="1729128">0</span><span class="op" id="1729129">,</span>&nbsp;<span class="ident" id="1729131">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1729138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1729142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1729146">if</span>&nbsp;<span class="ident" id="1729149">d</span><span class="op" id="1729150">.</span><span class="ident" id="1729151">bits</span><span class="op" id="1729155">.</span><span class="ident" id="1729156">a</span><span class="op" id="1729157">&amp;</span><span class="ident" id="1729158">d</span><span class="op" id="1729159">.</span><span class="ident" id="1729160">bits</span><span class="op" id="1729164">.</span><span class="ident" id="1729165">m</span>&nbsp;<span class="op" id="1729167">!=</span>&nbsp;<span class="num" id="1729170">0</span>&nbsp;<span class="op" id="1729172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1729177">code</span>&nbsp;<span class="op" id="1729182">|=</span>&nbsp;<span class="num" id="1729185">1</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1729189">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1729193">d</span><span class="op" id="1729194">.</span><span class="ident" id="1729195">bits</span><span class="op" id="1729199">.</span><span class="ident" id="1729200">n</span><span class="op" id="1729201">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1729206">d</span><span class="op" id="1729207">.</span><span class="ident" id="1729208">bits</span><span class="op" id="1729212">.</span><span class="ident" id="1729213">m</span>&nbsp;<span class="op" id="1729215">&gt;&gt;=</span>&nbsp;<span class="num" id="1729219">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1729223">if</span>&nbsp;<span class="ident" id="1729226">code</span>&nbsp;<span class="op" id="1729231">&lt;=</span>&nbsp;<span class="ident" id="1729234">h</span><span class="op" id="1729235">.</span><span class="ident" id="1729236">maxCodes</span><span class="op" id="1729244">[</span><span class="ident" id="1729245">i</span><span class="op" id="1729246">]</span>&nbsp;<span class="op" id="1729248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1729253">return</span>&nbsp;<span class="ident" id="1729260">h</span><span class="op" id="1729261">.</span><span class="ident" id="1729262">vals</span><span class="op" id="1729266">[</span><span class="ident" id="1729267">h</span><span class="op" id="1729268">.</span><span class="ident" id="1729269">valsIndices</span><span class="op" id="1729280">[</span><span class="ident" id="1729281">i</span><span class="op" id="1729282">]</span><span class="op" id="1729283">+</span><span class="ident" id="1729284">code</span><span class="op" id="1729288">-</span><span class="ident" id="1729289">h</span><span class="op" id="1729290">.</span><span class="ident" id="1729291">minCodes</span><span class="op" id="1729299">[</span><span class="ident" id="1729300">i</span><span class="op" id="1729301">]</span><span class="op" id="1729302">]</span><span class="op" id="1729303">,</span>&nbsp;<span class="builtintype" id="1729305">nil</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1729311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1729315">code</span>&nbsp;<span class="op" id="1729320">&lt;&lt;=</span>&nbsp;<span class="num" id="1729324">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1729327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1729330">return</span>&nbsp;<span class="num" id="1729337">0</span><span class="op" id="1729338">,</span>&nbsp;<span class="ident" id="1729340">FormatError</span><span class="op" id="1729351">(</span><span class="string" id="1729352">&#34;bad&nbsp;Huffman&nbsp;code&#34;</span><span class="op" id="1729370">)</span><br>
<span class="lineno"></span><span class="op" id="1729372">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="keyword" id="1729375">func</span>&nbsp;<span class="op" id="1729380">(</span><span class="ident" id="1729381">d</span>&nbsp;<span class="op" id="1729383">*</span><span class="ident" id="1729384">decoder</span><span class="op" id="1729391">)</span>&nbsp;<span class="ident" id="1729393">decodeBit</span><span class="op" id="1729402">(</span><span class="op" id="1729403">)</span>&nbsp;<span class="op" id="1729405">(</span><span class="builtintype" id="1729406">bool</span><span class="op" id="1729410">,</span>&nbsp;<span class="builtintype" id="1729412">error</span><span class="op" id="1729417">)</span>&nbsp;<span class="op" id="1729419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1729422">if</span>&nbsp;<span class="ident" id="1729425">d</span><span class="op" id="1729426">.</span><span class="ident" id="1729427">bits</span><span class="op" id="1729431">.</span><span class="ident" id="1729432">n</span>&nbsp;<span class="op" id="1729434">==</span>&nbsp;<span class="num" id="1729437">0</span>&nbsp;<span class="op" id="1729439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1729443">if</span>&nbsp;<span class="ident" id="1729446">err</span>&nbsp;<span class="op" id="1729450">:=</span>&nbsp;<span class="ident" id="1729453">d</span><span class="op" id="1729454">.</span><span class="ident" id="1729455">ensureNBits</span><span class="op" id="1729466">(</span><span class="num" id="1729467">1</span><span class="op" id="1729468">)</span><span class="op" id="1729469">;</span>&nbsp;<span class="ident" id="1729471">err</span>&nbsp;<span class="op" id="1729475">!=</span>&nbsp;<span class="builtintype" id="1729478">nil</span>&nbsp;<span class="op" id="1729482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1729487">return</span>&nbsp;<span class="builtintype" id="1729494">false</span><span class="op" id="1729499">,</span>&nbsp;<span class="ident" id="1729501">err</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1729507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1729510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1729513">ret</span>&nbsp;<span class="op" id="1729517">:=</span>&nbsp;<span class="ident" id="1729520">d</span><span class="op" id="1729521">.</span><span class="ident" id="1729522">bits</span><span class="op" id="1729526">.</span><span class="ident" id="1729527">a</span><span class="op" id="1729528">&amp;</span><span class="ident" id="1729529">d</span><span class="op" id="1729530">.</span><span class="ident" id="1729531">bits</span><span class="op" id="1729535">.</span><span class="ident" id="1729536">m</span>&nbsp;<span class="op" id="1729538">!=</span>&nbsp;<span class="num" id="1729541">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1729544">d</span><span class="op" id="1729545">.</span><span class="ident" id="1729546">bits</span><span class="op" id="1729550">.</span><span class="ident" id="1729551">n</span><span class="op" id="1729552">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1729556">d</span><span class="op" id="1729557">.</span><span class="ident" id="1729558">bits</span><span class="op" id="1729562">.</span><span class="ident" id="1729563">m</span>&nbsp;<span class="op" id="1729565">&gt;&gt;=</span>&nbsp;<span class="num" id="1729569">1</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1729572">return</span>&nbsp;<span class="ident" id="1729579">ret</span><span class="op" id="1729582">,</span>&nbsp;<span class="builtintype" id="1729584">nil</span><br>
<span class="lineno"></span><span class="op" id="1729588">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1729591">func</span>&nbsp;<span class="op" id="1729596">(</span><span class="ident" id="1729597">d</span>&nbsp;<span class="op" id="1729599">*</span><span class="ident" id="1729600">decoder</span><span class="op" id="1729607">)</span>&nbsp;<span class="ident" id="1729609">decodeBits</span><span class="op" id="1729619">(</span><span class="ident" id="1729620">n</span>&nbsp;<span class="builtintype" id="1729622">int32</span><span class="op" id="1729627">)</span>&nbsp;<span class="op" id="1729629">(</span><span class="builtintype" id="1729630">uint32</span><span class="op" id="1729636">,</span>&nbsp;<span class="builtintype" id="1729638">error</span><span class="op" id="1729643">)</span>&nbsp;<span class="op" id="1729645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1729648">if</span>&nbsp;<span class="ident" id="1729651">d</span><span class="op" id="1729652">.</span><span class="ident" id="1729653">bits</span><span class="op" id="1729657">.</span><span class="ident" id="1729658">n</span>&nbsp;<span class="op" id="1729660">&lt;</span>&nbsp;<span class="ident" id="1729662">n</span>&nbsp;<span class="op" id="1729664">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1729668">if</span>&nbsp;<span class="ident" id="1729671">err</span>&nbsp;<span class="op" id="1729675">:=</span>&nbsp;<span class="ident" id="1729678">d</span><span class="op" id="1729679">.</span><span class="ident" id="1729680">ensureNBits</span><span class="op" id="1729691">(</span><span class="ident" id="1729692">n</span><span class="op" id="1729693">)</span><span class="op" id="1729694">;</span>&nbsp;<span class="ident" id="1729696">err</span>&nbsp;<span class="op" id="1729700">!=</span>&nbsp;<span class="builtintype" id="1729703">nil</span>&nbsp;<span class="op" id="1729707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1729712">return</span>&nbsp;<span class="num" id="1729719">0</span><span class="op" id="1729720">,</span>&nbsp;<span class="ident" id="1729722">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1729728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1729731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1729734">ret</span>&nbsp;<span class="op" id="1729738">:=</span>&nbsp;<span class="ident" id="1729741">d</span><span class="op" id="1729742">.</span><span class="ident" id="1729743">bits</span><span class="op" id="1729747">.</span><span class="ident" id="1729748">a</span>&nbsp;<span class="op" id="1729750">&gt;&gt;</span>&nbsp;<span class="builtintype" id="1729753">uint32</span><span class="op" id="1729759">(</span><span class="ident" id="1729760">d</span><span class="op" id="1729761">.</span><span class="ident" id="1729762">bits</span><span class="op" id="1729766">.</span><span class="ident" id="1729767">n</span><span class="op" id="1729768">-</span><span class="ident" id="1729769">n</span><span class="op" id="1729770">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1729773">ret</span>&nbsp;<span class="op" id="1729777">&amp;=</span>&nbsp;<span class="op" id="1729780">(</span><span class="num" id="1729781">1</span>&nbsp;<span class="op" id="1729783">&lt;&lt;</span>&nbsp;<span class="builtintype" id="1729786">uint32</span><span class="op" id="1729792">(</span><span class="ident" id="1729793">n</span><span class="op" id="1729794">)</span><span class="op" id="1729795">)</span>&nbsp;<span class="op" id="1729797">-</span>&nbsp;<span class="num" id="1729799">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1729802">d</span><span class="op" id="1729803">.</span><span class="ident" id="1729804">bits</span><span class="op" id="1729808">.</span><span class="ident" id="1729809">n</span>&nbsp;<span class="op" id="1729811">-=</span>&nbsp;<span class="ident" id="1729814">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1729817">d</span><span class="op" id="1729818">.</span><span class="ident" id="1729819">bits</span><span class="op" id="1729823">.</span><span class="ident" id="1729824">m</span>&nbsp;<span class="op" id="1729826">&gt;&gt;=</span>&nbsp;<span class="builtintype" id="1729830">uint32</span><span class="op" id="1729836">(</span><span class="ident" id="1729837">n</span><span class="op" id="1729838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1729841">return</span>&nbsp;<span class="ident" id="1729848">ret</span><span class="op" id="1729851">,</span>&nbsp;<span class="builtintype" id="1729853">nil</span><br>
<span class="lineno"></span><span class="op" id="1729857">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
