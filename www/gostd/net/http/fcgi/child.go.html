<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/fcgi</h2>
<ul>
<li><a href="/gostd/net/http/fcgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi.go.html">fcgi.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi_test.go.html">fcgi_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6275639">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6275694">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6275748">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6275799">package</span>&nbsp;<span class="ident" id="6275807">fcgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6275813">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;FastCGI&nbsp;from&nbsp;the&nbsp;perspective&nbsp;of&nbsp;a&nbsp;child&nbsp;process.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6275887">import</span>&nbsp;<span class="op" id="6275894">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6275897">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6275907">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6275914">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6275920">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6275933">&#34;net&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6275940">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6275952">&#34;net/http/cgi&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6275968">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6275974">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6275985">&#34;sync&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6275993">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6276000">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6276003">//&nbsp;request&nbsp;holds&nbsp;the&nbsp;state&nbsp;for&nbsp;an&nbsp;in-progress&nbsp;request.&nbsp;As&nbsp;soon&nbsp;as&nbsp;it&#39;s&nbsp;complete,</span><br>
<span class="lineno"></span><span class="comment" id="6276084">//&nbsp;it&#39;s&nbsp;converted&nbsp;to&nbsp;an&nbsp;http.Request.</span><br>
<span class="lineno">25</span><span class="keyword" id="6276122">type</span>&nbsp;<span class="ident" id="6276127">request</span>&nbsp;<span class="keyword" id="6276135">struct</span>&nbsp;<span class="op" id="6276142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276145">pw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6276155">*</span><span class="ident" id="6276156">io</span><span class="op" id="6276158">.</span><span class="ident" id="6276159">PipeWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276171">reqId</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6276181">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276189">params</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6276199">map</span><span class="op" id="6276202">[</span><span class="builtintype" id="6276203">string</span><span class="op" id="6276209">]</span><span class="builtintype" id="6276210">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276218">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6276228">[</span><span class="num" id="6276229">1024</span><span class="op" id="6276233">]</span><span class="builtintype" id="6276234">byte</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276240">rawParams</span>&nbsp;<span class="op" id="6276250">[</span><span class="op" id="6276251">]</span><span class="builtintype" id="6276252">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276258">keepConn</span>&nbsp;&nbsp;<span class="builtintype" id="6276268">bool</span><br>
<span class="lineno"></span><span class="op" id="6276273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6276276">func</span>&nbsp;<span class="ident" id="6276281">newRequest</span><span class="op" id="6276291">(</span><span class="ident" id="6276292">reqId</span>&nbsp;<span class="builtintype" id="6276298">uint16</span><span class="op" id="6276304">,</span>&nbsp;<span class="ident" id="6276306">flags</span>&nbsp;<span class="builtintype" id="6276312">uint8</span><span class="op" id="6276317">)</span>&nbsp;<span class="op" id="6276319">*</span><span class="ident" id="6276320">request</span>&nbsp;<span class="op" id="6276328">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276331">r</span>&nbsp;<span class="op" id="6276333">:=</span>&nbsp;<span class="op" id="6276336">&amp;</span><span class="ident" id="6276337">request</span><span class="op" id="6276344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276348">reqId</span><span class="op" id="6276353">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6276358">reqId</span><span class="op" id="6276363">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276367">params</span><span class="op" id="6276373">:</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="6276377">map</span><span class="op" id="6276380">[</span><span class="builtintype" id="6276381">string</span><span class="op" id="6276387">]</span><span class="builtintype" id="6276388">string</span><span class="op" id="6276394">{</span><span class="op" id="6276395">}</span><span class="op" id="6276396">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276400">keepConn</span><span class="op" id="6276408">:</span>&nbsp;<span class="ident" id="6276410">flags</span><span class="op" id="6276415">&amp;</span><span class="ident" id="6276416">flagKeepConn</span>&nbsp;<span class="op" id="6276429">!=</span>&nbsp;<span class="num" id="6276432">0</span><span class="op" id="6276433">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6276436">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276439">r</span><span class="op" id="6276440">.</span><span class="ident" id="6276441">rawParams</span>&nbsp;<span class="op" id="6276451">=</span>&nbsp;<span class="ident" id="6276453">r</span><span class="op" id="6276454">.</span><span class="ident" id="6276455">buf</span><span class="op" id="6276458">[</span><span class="op" id="6276459">:</span><span class="num" id="6276460">0</span><span class="op" id="6276461">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6276464">return</span>&nbsp;<span class="ident" id="6276471">r</span><br>
<span class="lineno"></span><span class="op" id="6276473">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6276476">//&nbsp;parseParams&nbsp;reads&nbsp;an&nbsp;encoded&nbsp;[]byte&nbsp;into&nbsp;Params.</span><br>
<span class="lineno">45</span><span class="keyword" id="6276528">func</span>&nbsp;<span class="op" id="6276533">(</span><span class="ident" id="6276534">r</span>&nbsp;<span class="op" id="6276536">*</span><span class="ident" id="6276537">request</span><span class="op" id="6276544">)</span>&nbsp;<span class="ident" id="6276546">parseParams</span><span class="op" id="6276557">(</span><span class="op" id="6276558">)</span>&nbsp;<span class="op" id="6276560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276563">text</span>&nbsp;<span class="op" id="6276568">:=</span>&nbsp;<span class="ident" id="6276571">r</span><span class="op" id="6276572">.</span><span class="ident" id="6276573">rawParams</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276584">r</span><span class="op" id="6276585">.</span><span class="ident" id="6276586">rawParams</span>&nbsp;<span class="op" id="6276596">=</span>&nbsp;<span class="ident" id="6276598">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6276603">for</span>&nbsp;<span class="builtinfunc" id="6276607">len</span><span class="op" id="6276610">(</span><span class="ident" id="6276611">text</span><span class="op" id="6276615">)</span>&nbsp;<span class="op" id="6276617">&gt;</span>&nbsp;<span class="num" id="6276619">0</span>&nbsp;<span class="op" id="6276621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276625">keyLen</span><span class="op" id="6276631">,</span>&nbsp;<span class="ident" id="6276633">n</span>&nbsp;<span class="op" id="6276635">:=</span>&nbsp;<span class="ident" id="6276638">readSize</span><span class="op" id="6276646">(</span><span class="ident" id="6276647">text</span><span class="op" id="6276651">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6276655">if</span>&nbsp;<span class="ident" id="6276658">n</span>&nbsp;<span class="op" id="6276660">==</span>&nbsp;<span class="num" id="6276663">0</span>&nbsp;<span class="op" id="6276665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6276670">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6276679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276683">text</span>&nbsp;<span class="op" id="6276688">=</span>&nbsp;<span class="ident" id="6276690">text</span><span class="op" id="6276694">[</span><span class="ident" id="6276695">n</span><span class="op" id="6276696">:</span><span class="op" id="6276697">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276701">valLen</span><span class="op" id="6276707">,</span>&nbsp;<span class="ident" id="6276709">n</span>&nbsp;<span class="op" id="6276711">:=</span>&nbsp;<span class="ident" id="6276714">readSize</span><span class="op" id="6276722">(</span><span class="ident" id="6276723">text</span><span class="op" id="6276727">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6276731">if</span>&nbsp;<span class="ident" id="6276734">n</span>&nbsp;<span class="op" id="6276736">==</span>&nbsp;<span class="num" id="6276739">0</span>&nbsp;<span class="op" id="6276741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6276746">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6276755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276759">text</span>&nbsp;<span class="op" id="6276764">=</span>&nbsp;<span class="ident" id="6276766">text</span><span class="op" id="6276770">[</span><span class="ident" id="6276771">n</span><span class="op" id="6276772">:</span><span class="op" id="6276773">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276777">key</span>&nbsp;<span class="op" id="6276781">:=</span>&nbsp;<span class="ident" id="6276784">readString</span><span class="op" id="6276794">(</span><span class="ident" id="6276795">text</span><span class="op" id="6276799">,</span>&nbsp;<span class="ident" id="6276801">keyLen</span><span class="op" id="6276807">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276811">text</span>&nbsp;<span class="op" id="6276816">=</span>&nbsp;<span class="ident" id="6276818">text</span><span class="op" id="6276822">[</span><span class="ident" id="6276823">keyLen</span><span class="op" id="6276829">:</span><span class="op" id="6276830">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276834">val</span>&nbsp;<span class="op" id="6276838">:=</span>&nbsp;<span class="ident" id="6276841">readString</span><span class="op" id="6276851">(</span><span class="ident" id="6276852">text</span><span class="op" id="6276856">,</span>&nbsp;<span class="ident" id="6276858">valLen</span><span class="op" id="6276864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276868">text</span>&nbsp;<span class="op" id="6276873">=</span>&nbsp;<span class="ident" id="6276875">text</span><span class="op" id="6276879">[</span><span class="ident" id="6276880">valLen</span><span class="op" id="6276886">:</span><span class="op" id="6276887">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276891">r</span><span class="op" id="6276892">.</span><span class="ident" id="6276893">params</span><span class="op" id="6276899">[</span><span class="ident" id="6276900">key</span><span class="op" id="6276903">]</span>&nbsp;<span class="op" id="6276905">=</span>&nbsp;<span class="ident" id="6276907">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6276912">}</span><br>
<span class="lineno">65</span><span class="op" id="6276914">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6276917">//&nbsp;response&nbsp;implements&nbsp;http.ResponseWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="6276961">type</span>&nbsp;<span class="ident" id="6276966">response</span>&nbsp;<span class="keyword" id="6276975">struct</span>&nbsp;<span class="op" id="6276982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276985">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6276997">*</span><span class="ident" id="6276998">request</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277007">header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6277019">http</span><span class="op" id="6277023">.</span><span class="ident" id="6277024">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277032">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6277044">*</span><span class="ident" id="6277045">bufWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277056">wroteHeader</span>&nbsp;<span class="builtintype" id="6277068">bool</span><br>
<span class="lineno"></span><span class="op" id="6277073">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="keyword" id="6277076">func</span>&nbsp;<span class="ident" id="6277081">newResponse</span><span class="op" id="6277092">(</span><span class="ident" id="6277093">c</span>&nbsp;<span class="op" id="6277095">*</span><span class="ident" id="6277096">child</span><span class="op" id="6277101">,</span>&nbsp;<span class="ident" id="6277103">req</span>&nbsp;<span class="op" id="6277107">*</span><span class="ident" id="6277108">request</span><span class="op" id="6277115">)</span>&nbsp;<span class="op" id="6277117">*</span><span class="ident" id="6277118">response</span>&nbsp;<span class="op" id="6277127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6277130">return</span>&nbsp;<span class="op" id="6277137">&amp;</span><span class="ident" id="6277138">response</span><span class="op" id="6277146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277150">req</span><span class="op" id="6277153">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6277158">req</span><span class="op" id="6277161">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277165">header</span><span class="op" id="6277171">:</span>&nbsp;<span class="ident" id="6277173">http</span><span class="op" id="6277177">.</span><span class="ident" id="6277178">Header</span><span class="op" id="6277184">{</span><span class="op" id="6277185">}</span><span class="op" id="6277186">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277190">w</span><span class="op" id="6277191">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6277198">newWriter</span><span class="op" id="6277207">(</span><span class="ident" id="6277208">c</span><span class="op" id="6277209">.</span><span class="ident" id="6277210">conn</span><span class="op" id="6277214">,</span>&nbsp;<span class="ident" id="6277216">typeStdout</span><span class="op" id="6277226">,</span>&nbsp;<span class="ident" id="6277228">req</span><span class="op" id="6277231">.</span><span class="ident" id="6277232">reqId</span><span class="op" id="6277237">)</span><span class="op" id="6277238">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6277241">}</span><br>
<span class="lineno"></span><span class="op" id="6277243">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6277246">func</span>&nbsp;<span class="op" id="6277251">(</span><span class="ident" id="6277252">r</span>&nbsp;<span class="op" id="6277254">*</span><span class="ident" id="6277255">response</span><span class="op" id="6277263">)</span>&nbsp;<span class="ident" id="6277265">Header</span><span class="op" id="6277271">(</span><span class="op" id="6277272">)</span>&nbsp;<span class="ident" id="6277274">http</span><span class="op" id="6277278">.</span><span class="ident" id="6277279">Header</span>&nbsp;<span class="op" id="6277286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6277289">return</span>&nbsp;<span class="ident" id="6277296">r</span><span class="op" id="6277297">.</span><span class="ident" id="6277298">header</span><br>
<span class="lineno">85</span><span class="op" id="6277305">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6277308">func</span>&nbsp;<span class="op" id="6277313">(</span><span class="ident" id="6277314">r</span>&nbsp;<span class="op" id="6277316">*</span><span class="ident" id="6277317">response</span><span class="op" id="6277325">)</span>&nbsp;<span class="ident" id="6277327">Write</span><span class="op" id="6277332">(</span><span class="ident" id="6277333">data</span>&nbsp;<span class="op" id="6277338">[</span><span class="op" id="6277339">]</span><span class="builtintype" id="6277340">byte</span><span class="op" id="6277344">)</span>&nbsp;<span class="op" id="6277346">(</span><span class="builtintype" id="6277347">int</span><span class="op" id="6277350">,</span>&nbsp;<span class="builtintype" id="6277352">error</span><span class="op" id="6277357">)</span>&nbsp;<span class="op" id="6277359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6277362">if</span>&nbsp;<span class="op" id="6277365">!</span><span class="ident" id="6277366">r</span><span class="op" id="6277367">.</span><span class="ident" id="6277368">wroteHeader</span>&nbsp;<span class="op" id="6277380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277384">r</span><span class="op" id="6277385">.</span><span class="ident" id="6277386">WriteHeader</span><span class="op" id="6277397">(</span><span class="ident" id="6277398">http</span><span class="op" id="6277402">.</span><span class="ident" id="6277403">StatusOK</span><span class="op" id="6277411">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6277414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6277417">return</span>&nbsp;<span class="ident" id="6277424">r</span><span class="op" id="6277425">.</span><span class="ident" id="6277426">w</span><span class="op" id="6277427">.</span><span class="ident" id="6277428">Write</span><span class="op" id="6277433">(</span><span class="ident" id="6277434">data</span><span class="op" id="6277438">)</span><br>
<span class="lineno"></span><span class="op" id="6277440">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6277443">func</span>&nbsp;<span class="op" id="6277448">(</span><span class="ident" id="6277449">r</span>&nbsp;<span class="op" id="6277451">*</span><span class="ident" id="6277452">response</span><span class="op" id="6277460">)</span>&nbsp;<span class="ident" id="6277462">WriteHeader</span><span class="op" id="6277473">(</span><span class="ident" id="6277474">code</span>&nbsp;<span class="builtintype" id="6277479">int</span><span class="op" id="6277482">)</span>&nbsp;<span class="op" id="6277484">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6277487">if</span>&nbsp;<span class="ident" id="6277490">r</span><span class="op" id="6277491">.</span><span class="ident" id="6277492">wroteHeader</span>&nbsp;<span class="op" id="6277504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6277508">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6277516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277519">r</span><span class="op" id="6277520">.</span><span class="ident" id="6277521">wroteHeader</span>&nbsp;<span class="op" id="6277533">=</span>&nbsp;<span class="builtintype" id="6277535">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6277541">if</span>&nbsp;<span class="ident" id="6277544">code</span>&nbsp;<span class="op" id="6277549">==</span>&nbsp;<span class="ident" id="6277552">http</span><span class="op" id="6277556">.</span><span class="ident" id="6277557">StatusNotModified</span>&nbsp;<span class="op" id="6277575">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6277579">//&nbsp;Must&nbsp;not&nbsp;have&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277604">r</span><span class="op" id="6277605">.</span><span class="ident" id="6277606">header</span><span class="op" id="6277612">.</span><span class="ident" id="6277613">Del</span><span class="op" id="6277616">(</span><span class="string" id="6277617">&#34;Content-Type&#34;</span><span class="op" id="6277631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277635">r</span><span class="op" id="6277636">.</span><span class="ident" id="6277637">header</span><span class="op" id="6277643">.</span><span class="ident" id="6277644">Del</span><span class="op" id="6277647">(</span><span class="string" id="6277648">&#34;Content-Length&#34;</span><span class="op" id="6277664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277668">r</span><span class="op" id="6277669">.</span><span class="ident" id="6277670">header</span><span class="op" id="6277676">.</span><span class="ident" id="6277677">Del</span><span class="op" id="6277680">(</span><span class="string" id="6277681">&#34;Transfer-Encoding&#34;</span><span class="op" id="6277700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6277703">}</span>&nbsp;<span class="keyword" id="6277705">else</span>&nbsp;<span class="keyword" id="6277710">if</span>&nbsp;<span class="ident" id="6277713">r</span><span class="op" id="6277714">.</span><span class="ident" id="6277715">header</span><span class="op" id="6277721">.</span><span class="ident" id="6277722">Get</span><span class="op" id="6277725">(</span><span class="string" id="6277726">&#34;Content-Type&#34;</span><span class="op" id="6277740">)</span>&nbsp;<span class="op" id="6277742">==</span>&nbsp;<span class="string" id="6277745">&#34;&#34;</span>&nbsp;<span class="op" id="6277748">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277752">r</span><span class="op" id="6277753">.</span><span class="ident" id="6277754">header</span><span class="op" id="6277760">.</span><span class="ident" id="6277761">Set</span><span class="op" id="6277764">(</span><span class="string" id="6277765">&#34;Content-Type&#34;</span><span class="op" id="6277779">,</span>&nbsp;<span class="string" id="6277781">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="6277807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6277810">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6277814">if</span>&nbsp;<span class="ident" id="6277817">r</span><span class="op" id="6277818">.</span><span class="ident" id="6277819">header</span><span class="op" id="6277825">.</span><span class="ident" id="6277826">Get</span><span class="op" id="6277829">(</span><span class="string" id="6277830">&#34;Date&#34;</span><span class="op" id="6277836">)</span>&nbsp;<span class="op" id="6277838">==</span>&nbsp;<span class="string" id="6277841">&#34;&#34;</span>&nbsp;<span class="op" id="6277844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277848">r</span><span class="op" id="6277849">.</span><span class="ident" id="6277850">header</span><span class="op" id="6277856">.</span><span class="ident" id="6277857">Set</span><span class="op" id="6277860">(</span><span class="string" id="6277861">&#34;Date&#34;</span><span class="op" id="6277867">,</span>&nbsp;<span class="ident" id="6277869">time</span><span class="op" id="6277873">.</span><span class="ident" id="6277874">Now</span><span class="op" id="6277877">(</span><span class="op" id="6277878">)</span><span class="op" id="6277879">.</span><span class="ident" id="6277880">UTC</span><span class="op" id="6277883">(</span><span class="op" id="6277884">)</span><span class="op" id="6277885">.</span><span class="ident" id="6277886">Format</span><span class="op" id="6277892">(</span><span class="ident" id="6277893">http</span><span class="op" id="6277897">.</span><span class="ident" id="6277898">TimeFormat</span><span class="op" id="6277908">)</span><span class="op" id="6277909">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6277912">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277916">fmt</span><span class="op" id="6277919">.</span><span class="ident" id="6277920">Fprintf</span><span class="op" id="6277927">(</span><span class="ident" id="6277928">r</span><span class="op" id="6277929">.</span><span class="ident" id="6277930">w</span><span class="op" id="6277931">,</span>&nbsp;<span class="string" id="6277933">&#34;Status:&nbsp;%d&nbsp;%s\r\n&#34;</span><span class="op" id="6277952">,</span>&nbsp;<span class="ident" id="6277954">code</span><span class="op" id="6277958">,</span>&nbsp;<span class="ident" id="6277960">http</span><span class="op" id="6277964">.</span><span class="ident" id="6277965">StatusText</span><span class="op" id="6277975">(</span><span class="ident" id="6277976">code</span><span class="op" id="6277980">)</span><span class="op" id="6277981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277984">r</span><span class="op" id="6277985">.</span><span class="ident" id="6277986">header</span><span class="op" id="6277992">.</span><span class="ident" id="6277993">Write</span><span class="op" id="6277998">(</span><span class="ident" id="6277999">r</span><span class="op" id="6278000">.</span><span class="ident" id="6278001">w</span><span class="op" id="6278002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278005">r</span><span class="op" id="6278006">.</span><span class="ident" id="6278007">w</span><span class="op" id="6278008">.</span><span class="ident" id="6278009">WriteString</span><span class="op" id="6278020">(</span><span class="string" id="6278021">&#34;\r\n&#34;</span><span class="op" id="6278027">)</span><br>
<span class="lineno">115</span><span class="op" id="6278029">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6278032">func</span>&nbsp;<span class="op" id="6278037">(</span><span class="ident" id="6278038">r</span>&nbsp;<span class="op" id="6278040">*</span><span class="ident" id="6278041">response</span><span class="op" id="6278049">)</span>&nbsp;<span class="ident" id="6278051">Flush</span><span class="op" id="6278056">(</span><span class="op" id="6278057">)</span>&nbsp;<span class="op" id="6278059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6278062">if</span>&nbsp;<span class="op" id="6278065">!</span><span class="ident" id="6278066">r</span><span class="op" id="6278067">.</span><span class="ident" id="6278068">wroteHeader</span>&nbsp;<span class="op" id="6278080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278084">r</span><span class="op" id="6278085">.</span><span class="ident" id="6278086">WriteHeader</span><span class="op" id="6278097">(</span><span class="ident" id="6278098">http</span><span class="op" id="6278102">.</span><span class="ident" id="6278103">StatusOK</span><span class="op" id="6278111">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6278114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278117">r</span><span class="op" id="6278118">.</span><span class="ident" id="6278119">w</span><span class="op" id="6278120">.</span><span class="ident" id="6278121">Flush</span><span class="op" id="6278126">(</span><span class="op" id="6278127">)</span><br>
<span class="lineno"></span><span class="op" id="6278129">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6278132">func</span>&nbsp;<span class="op" id="6278137">(</span><span class="ident" id="6278138">r</span>&nbsp;<span class="op" id="6278140">*</span><span class="ident" id="6278141">response</span><span class="op" id="6278149">)</span>&nbsp;<span class="ident" id="6278151">Close</span><span class="op" id="6278156">(</span><span class="op" id="6278157">)</span>&nbsp;<span class="builtintype" id="6278159">error</span>&nbsp;<span class="op" id="6278165">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278168">r</span><span class="op" id="6278169">.</span><span class="ident" id="6278170">Flush</span><span class="op" id="6278175">(</span><span class="op" id="6278176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6278179">return</span>&nbsp;<span class="ident" id="6278186">r</span><span class="op" id="6278187">.</span><span class="ident" id="6278188">w</span><span class="op" id="6278189">.</span><span class="ident" id="6278190">Close</span><span class="op" id="6278195">(</span><span class="op" id="6278196">)</span><br>
<span class="lineno"></span><span class="op" id="6278198">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6278201">type</span>&nbsp;<span class="ident" id="6278206">child</span>&nbsp;<span class="keyword" id="6278212">struct</span>&nbsp;<span class="op" id="6278219">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278222">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6278230">*</span><span class="ident" id="6278231">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278237">handler</span>&nbsp;<span class="ident" id="6278245">http</span><span class="op" id="6278249">.</span><span class="ident" id="6278250">Handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278260">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6278269">sync</span><span class="op" id="6278273">.</span><span class="ident" id="6278274">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6278289">//&nbsp;protects&nbsp;requests:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278312">requests</span>&nbsp;<span class="keyword" id="6278321">map</span><span class="op" id="6278324">[</span><span class="builtintype" id="6278325">uint16</span><span class="op" id="6278331">]</span><span class="op" id="6278332">*</span><span class="ident" id="6278333">request</span>&nbsp;<span class="comment" id="6278341">//&nbsp;keyed&nbsp;by&nbsp;request&nbsp;ID</span><br>
<span class="lineno">135</span><span class="op" id="6278364">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6278367">func</span>&nbsp;<span class="ident" id="6278372">newChild</span><span class="op" id="6278380">(</span><span class="ident" id="6278381">rwc</span>&nbsp;<span class="ident" id="6278385">io</span><span class="op" id="6278387">.</span><span class="ident" id="6278388">ReadWriteCloser</span><span class="op" id="6278403">,</span>&nbsp;<span class="ident" id="6278405">handler</span>&nbsp;<span class="ident" id="6278413">http</span><span class="op" id="6278417">.</span><span class="ident" id="6278418">Handler</span><span class="op" id="6278425">)</span>&nbsp;<span class="op" id="6278427">*</span><span class="ident" id="6278428">child</span>&nbsp;<span class="op" id="6278434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6278437">return</span>&nbsp;<span class="op" id="6278444">&amp;</span><span class="ident" id="6278445">child</span><span class="op" id="6278450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278454">conn</span><span class="op" id="6278458">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6278464">newConn</span><span class="op" id="6278471">(</span><span class="ident" id="6278472">rwc</span><span class="op" id="6278475">)</span><span class="op" id="6278476">,</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278480">handler</span><span class="op" id="6278487">:</span>&nbsp;&nbsp;<span class="ident" id="6278490">handler</span><span class="op" id="6278497">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278501">requests</span><span class="op" id="6278509">:</span>&nbsp;<span class="builtinfunc" id="6278511">make</span><span class="op" id="6278515">(</span><span class="keyword" id="6278516">map</span><span class="op" id="6278519">[</span><span class="builtintype" id="6278520">uint16</span><span class="op" id="6278526">]</span><span class="op" id="6278527">*</span><span class="ident" id="6278528">request</span><span class="op" id="6278535">)</span><span class="op" id="6278536">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6278539">}</span><br>
<span class="lineno"></span><span class="op" id="6278541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="6278544">func</span>&nbsp;<span class="op" id="6278549">(</span><span class="ident" id="6278550">c</span>&nbsp;<span class="op" id="6278552">*</span><span class="ident" id="6278553">child</span><span class="op" id="6278558">)</span>&nbsp;<span class="ident" id="6278560">serve</span><span class="op" id="6278565">(</span><span class="op" id="6278566">)</span>&nbsp;<span class="op" id="6278568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6278571">defer</span>&nbsp;<span class="ident" id="6278577">c</span><span class="op" id="6278578">.</span><span class="ident" id="6278579">conn</span><span class="op" id="6278583">.</span><span class="ident" id="6278584">Close</span><span class="op" id="6278589">(</span><span class="op" id="6278590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6278593">var</span>&nbsp;<span class="ident" id="6278597">rec</span>&nbsp;<span class="ident" id="6278601">record</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6278609">for</span>&nbsp;<span class="op" id="6278613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6278617">if</span>&nbsp;<span class="ident" id="6278620">err</span>&nbsp;<span class="op" id="6278624">:=</span>&nbsp;<span class="ident" id="6278627">rec</span><span class="op" id="6278630">.</span><span class="ident" id="6278631">read</span><span class="op" id="6278635">(</span><span class="ident" id="6278636">c</span><span class="op" id="6278637">.</span><span class="ident" id="6278638">conn</span><span class="op" id="6278642">.</span><span class="ident" id="6278643">rwc</span><span class="op" id="6278646">)</span><span class="op" id="6278647">;</span>&nbsp;<span class="ident" id="6278649">err</span>&nbsp;<span class="op" id="6278653">!=</span>&nbsp;<span class="ident" id="6278656">nil</span>&nbsp;<span class="op" id="6278660">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6278665">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6278674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6278678">if</span>&nbsp;<span class="ident" id="6278681">err</span>&nbsp;<span class="op" id="6278685">:=</span>&nbsp;<span class="ident" id="6278688">c</span><span class="op" id="6278689">.</span><span class="ident" id="6278690">handleRecord</span><span class="op" id="6278702">(</span><span class="op" id="6278703">&amp;</span><span class="ident" id="6278704">rec</span><span class="op" id="6278707">)</span><span class="op" id="6278708">;</span>&nbsp;<span class="ident" id="6278710">err</span>&nbsp;<span class="op" id="6278714">!=</span>&nbsp;<span class="ident" id="6278717">nil</span>&nbsp;<span class="op" id="6278721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6278726">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6278735">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6278738">}</span><br>
<span class="lineno"></span><span class="op" id="6278740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6278743">var</span>&nbsp;<span class="ident" id="6278747">errCloseConn</span>&nbsp;<span class="op" id="6278760">=</span>&nbsp;<span class="ident" id="6278762">errors</span><span class="op" id="6278768">.</span><span class="ident" id="6278769">New</span><span class="op" id="6278772">(</span><span class="string" id="6278773">&#34;fcgi:&nbsp;connection&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="6278808">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="keyword" id="6278811">var</span>&nbsp;<span class="ident" id="6278815">emptyBody</span>&nbsp;<span class="op" id="6278825">=</span>&nbsp;<span class="ident" id="6278827">ioutil</span><span class="op" id="6278833">.</span><span class="ident" id="6278834">NopCloser</span><span class="op" id="6278843">(</span><span class="ident" id="6278844">strings</span><span class="op" id="6278851">.</span><span class="ident" id="6278852">NewReader</span><span class="op" id="6278861">(</span><span class="string" id="6278862">&#34;&#34;</span><span class="op" id="6278864">)</span><span class="op" id="6278865">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6278868">func</span>&nbsp;<span class="op" id="6278873">(</span><span class="ident" id="6278874">c</span>&nbsp;<span class="op" id="6278876">*</span><span class="ident" id="6278877">child</span><span class="op" id="6278882">)</span>&nbsp;<span class="ident" id="6278884">handleRecord</span><span class="op" id="6278896">(</span><span class="ident" id="6278897">rec</span>&nbsp;<span class="op" id="6278901">*</span><span class="ident" id="6278902">record</span><span class="op" id="6278908">)</span>&nbsp;<span class="builtintype" id="6278910">error</span>&nbsp;<span class="op" id="6278916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278919">c</span><span class="op" id="6278920">.</span><span class="ident" id="6278921">mu</span><span class="op" id="6278923">.</span><span class="ident" id="6278924">Lock</span><span class="op" id="6278928">(</span><span class="op" id="6278929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278932">req</span><span class="op" id="6278935">,</span>&nbsp;<span class="ident" id="6278937">ok</span>&nbsp;<span class="op" id="6278940">:=</span>&nbsp;<span class="ident" id="6278943">c</span><span class="op" id="6278944">.</span><span class="ident" id="6278945">requests</span><span class="op" id="6278953">[</span><span class="ident" id="6278954">rec</span><span class="op" id="6278957">.</span><span class="ident" id="6278958">h</span><span class="op" id="6278959">.</span><span class="ident" id="6278960">Id</span><span class="op" id="6278962">]</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278965">c</span><span class="op" id="6278966">.</span><span class="ident" id="6278967">mu</span><span class="op" id="6278969">.</span><span class="ident" id="6278970">Unlock</span><span class="op" id="6278976">(</span><span class="op" id="6278977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6278980">if</span>&nbsp;<span class="op" id="6278983">!</span><span class="ident" id="6278984">ok</span>&nbsp;<span class="op" id="6278987">&amp;&amp;</span>&nbsp;<span class="ident" id="6278990">rec</span><span class="op" id="6278993">.</span><span class="ident" id="6278994">h</span><span class="op" id="6278995">.</span><span class="ident" id="6278996">Type</span>&nbsp;<span class="op" id="6279001">!=</span>&nbsp;<span class="ident" id="6279004">typeBeginRequest</span>&nbsp;<span class="op" id="6279021">&amp;&amp;</span>&nbsp;<span class="ident" id="6279024">rec</span><span class="op" id="6279027">.</span><span class="ident" id="6279028">h</span><span class="op" id="6279029">.</span><span class="ident" id="6279030">Type</span>&nbsp;<span class="op" id="6279035">!=</span>&nbsp;<span class="ident" id="6279038">typeGetValues</span>&nbsp;<span class="op" id="6279052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6279056">//&nbsp;The&nbsp;spec&nbsp;says&nbsp;to&nbsp;ignore&nbsp;unknown&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6279106">return</span>&nbsp;<span class="ident" id="6279113">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6279118">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6279122">switch</span>&nbsp;<span class="ident" id="6279129">rec</span><span class="op" id="6279132">.</span><span class="ident" id="6279133">h</span><span class="op" id="6279134">.</span><span class="ident" id="6279135">Type</span>&nbsp;<span class="op" id="6279140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6279143">case</span>&nbsp;<span class="ident" id="6279148">typeBeginRequest</span><span class="op" id="6279164">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6279168">if</span>&nbsp;<span class="ident" id="6279171">req</span>&nbsp;<span class="op" id="6279175">!=</span>&nbsp;<span class="ident" id="6279178">nil</span>&nbsp;<span class="op" id="6279182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6279187">//&nbsp;The&nbsp;server&nbsp;is&nbsp;trying&nbsp;to&nbsp;begin&nbsp;a&nbsp;request&nbsp;with&nbsp;the&nbsp;same&nbsp;ID</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6279250">//&nbsp;as&nbsp;an&nbsp;in-progress&nbsp;request.&nbsp;This&nbsp;is&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6279301">return</span>&nbsp;<span class="ident" id="6279308">errors</span><span class="op" id="6279314">.</span><span class="ident" id="6279315">New</span><span class="op" id="6279318">(</span><span class="string" id="6279319">&#34;fcgi:&nbsp;received&nbsp;ID&nbsp;that&nbsp;is&nbsp;already&nbsp;in-flight&#34;</span><span class="op" id="6279364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6279368">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6279373">var</span>&nbsp;<span class="ident" id="6279377">br</span>&nbsp;<span class="ident" id="6279380">beginRequest</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6279395">if</span>&nbsp;<span class="ident" id="6279398">err</span>&nbsp;<span class="op" id="6279402">:=</span>&nbsp;<span class="ident" id="6279405">br</span><span class="op" id="6279407">.</span><span class="ident" id="6279408">read</span><span class="op" id="6279412">(</span><span class="ident" id="6279413">rec</span><span class="op" id="6279416">.</span><span class="ident" id="6279417">content</span><span class="op" id="6279424">(</span><span class="op" id="6279425">)</span><span class="op" id="6279426">)</span><span class="op" id="6279427">;</span>&nbsp;<span class="ident" id="6279429">err</span>&nbsp;<span class="op" id="6279433">!=</span>&nbsp;<span class="ident" id="6279436">nil</span>&nbsp;<span class="op" id="6279440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6279445">return</span>&nbsp;<span class="ident" id="6279452">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6279458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6279462">if</span>&nbsp;<span class="ident" id="6279465">br</span><span class="op" id="6279467">.</span><span class="ident" id="6279468">role</span>&nbsp;<span class="op" id="6279473">!=</span>&nbsp;<span class="ident" id="6279476">roleResponder</span>&nbsp;<span class="op" id="6279490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6279495">c</span><span class="op" id="6279496">.</span><span class="ident" id="6279497">conn</span><span class="op" id="6279501">.</span><span class="ident" id="6279502">writeEndRequest</span><span class="op" id="6279517">(</span><span class="ident" id="6279518">rec</span><span class="op" id="6279521">.</span><span class="ident" id="6279522">h</span><span class="op" id="6279523">.</span><span class="ident" id="6279524">Id</span><span class="op" id="6279526">,</span>&nbsp;<span class="num" id="6279528">0</span><span class="op" id="6279529">,</span>&nbsp;<span class="ident" id="6279531">statusUnknownRole</span><span class="op" id="6279548">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6279553">return</span>&nbsp;<span class="ident" id="6279560">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6279566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6279570">req</span>&nbsp;<span class="op" id="6279574">=</span>&nbsp;<span class="ident" id="6279576">newRequest</span><span class="op" id="6279586">(</span><span class="ident" id="6279587">rec</span><span class="op" id="6279590">.</span><span class="ident" id="6279591">h</span><span class="op" id="6279592">.</span><span class="ident" id="6279593">Id</span><span class="op" id="6279595">,</span>&nbsp;<span class="ident" id="6279597">br</span><span class="op" id="6279599">.</span><span class="ident" id="6279600">flags</span><span class="op" id="6279605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6279609">c</span><span class="op" id="6279610">.</span><span class="ident" id="6279611">mu</span><span class="op" id="6279613">.</span><span class="ident" id="6279614">Lock</span><span class="op" id="6279618">(</span><span class="op" id="6279619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6279623">c</span><span class="op" id="6279624">.</span><span class="ident" id="6279625">requests</span><span class="op" id="6279633">[</span><span class="ident" id="6279634">rec</span><span class="op" id="6279637">.</span><span class="ident" id="6279638">h</span><span class="op" id="6279639">.</span><span class="ident" id="6279640">Id</span><span class="op" id="6279642">]</span>&nbsp;<span class="op" id="6279644">=</span>&nbsp;<span class="ident" id="6279646">req</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6279652">c</span><span class="op" id="6279653">.</span><span class="ident" id="6279654">mu</span><span class="op" id="6279656">.</span><span class="ident" id="6279657">Unlock</span><span class="op" id="6279663">(</span><span class="op" id="6279664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6279668">return</span>&nbsp;<span class="ident" id="6279675">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6279680">case</span>&nbsp;<span class="ident" id="6279685">typeParams</span><span class="op" id="6279695">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6279699">//&nbsp;NOTE(eds):&nbsp;Technically&nbsp;a&nbsp;key-value&nbsp;pair&nbsp;can&nbsp;straddle&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6279770">//&nbsp;between&nbsp;two&nbsp;packets.&nbsp;We&nbsp;buffer&nbsp;until&nbsp;we&#39;ve&nbsp;received&nbsp;all&nbsp;parameters.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6279843">if</span>&nbsp;<span class="builtinfunc" id="6279846">len</span><span class="op" id="6279849">(</span><span class="ident" id="6279850">rec</span><span class="op" id="6279853">.</span><span class="ident" id="6279854">content</span><span class="op" id="6279861">(</span><span class="op" id="6279862">)</span><span class="op" id="6279863">)</span>&nbsp;<span class="op" id="6279865">&gt;</span>&nbsp;<span class="num" id="6279867">0</span>&nbsp;<span class="op" id="6279869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6279874">req</span><span class="op" id="6279877">.</span><span class="ident" id="6279878">rawParams</span>&nbsp;<span class="op" id="6279888">=</span>&nbsp;<span class="builtinfunc" id="6279890">append</span><span class="op" id="6279896">(</span><span class="ident" id="6279897">req</span><span class="op" id="6279900">.</span><span class="ident" id="6279901">rawParams</span><span class="op" id="6279910">,</span>&nbsp;<span class="ident" id="6279912">rec</span><span class="op" id="6279915">.</span><span class="ident" id="6279916">content</span><span class="op" id="6279923">(</span><span class="op" id="6279924">)</span><span class="op" id="6279925">...</span><span class="op" id="6279928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6279933">return</span>&nbsp;<span class="ident" id="6279940">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6279946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6279950">req</span><span class="op" id="6279953">.</span><span class="ident" id="6279954">parseParams</span><span class="op" id="6279965">(</span><span class="op" id="6279966">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6279970">return</span>&nbsp;<span class="ident" id="6279977">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6279982">case</span>&nbsp;<span class="ident" id="6279987">typeStdin</span><span class="op" id="6279996">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6280000">content</span>&nbsp;<span class="op" id="6280008">:=</span>&nbsp;<span class="ident" id="6280011">rec</span><span class="op" id="6280014">.</span><span class="ident" id="6280015">content</span><span class="op" id="6280022">(</span><span class="op" id="6280023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6280027">if</span>&nbsp;<span class="ident" id="6280030">req</span><span class="op" id="6280033">.</span><span class="ident" id="6280034">pw</span>&nbsp;<span class="op" id="6280037">==</span>&nbsp;<span class="ident" id="6280040">nil</span>&nbsp;<span class="op" id="6280044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6280049">var</span>&nbsp;<span class="ident" id="6280053">body</span>&nbsp;<span class="ident" id="6280058">io</span><span class="op" id="6280060">.</span><span class="ident" id="6280061">ReadCloser</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6280075">if</span>&nbsp;<span class="builtinfunc" id="6280078">len</span><span class="op" id="6280081">(</span><span class="ident" id="6280082">content</span><span class="op" id="6280089">)</span>&nbsp;<span class="op" id="6280091">&gt;</span>&nbsp;<span class="num" id="6280093">0</span>&nbsp;<span class="op" id="6280095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6280101">//&nbsp;body&nbsp;could&nbsp;be&nbsp;an&nbsp;io.LimitReader,&nbsp;but&nbsp;it&nbsp;shouldn&#39;t&nbsp;matter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6280165">//&nbsp;as&nbsp;long&nbsp;as&nbsp;both&nbsp;sides&nbsp;are&nbsp;behaving.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6280208">body</span><span class="op" id="6280212">,</span>&nbsp;<span class="ident" id="6280214">req</span><span class="op" id="6280217">.</span><span class="ident" id="6280218">pw</span>&nbsp;<span class="op" id="6280221">=</span>&nbsp;<span class="ident" id="6280223">io</span><span class="op" id="6280225">.</span><span class="ident" id="6280226">Pipe</span><span class="op" id="6280230">(</span><span class="op" id="6280231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6280236">}</span>&nbsp;<span class="keyword" id="6280238">else</span>&nbsp;<span class="op" id="6280243">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6280249">body</span>&nbsp;<span class="op" id="6280254">=</span>&nbsp;<span class="ident" id="6280256">emptyBody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6280269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6280274">go</span>&nbsp;<span class="ident" id="6280277">c</span><span class="op" id="6280278">.</span><span class="ident" id="6280279">serveRequest</span><span class="op" id="6280291">(</span><span class="ident" id="6280292">req</span><span class="op" id="6280295">,</span>&nbsp;<span class="ident" id="6280297">body</span><span class="op" id="6280301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6280305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6280309">if</span>&nbsp;<span class="builtinfunc" id="6280312">len</span><span class="op" id="6280315">(</span><span class="ident" id="6280316">content</span><span class="op" id="6280323">)</span>&nbsp;<span class="op" id="6280325">&gt;</span>&nbsp;<span class="num" id="6280327">0</span>&nbsp;<span class="op" id="6280329">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6280334">//&nbsp;TODO(eds):&nbsp;This&nbsp;blocks&nbsp;until&nbsp;the&nbsp;handler&nbsp;reads&nbsp;from&nbsp;the&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6280402">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;takes&nbsp;a&nbsp;long&nbsp;time,&nbsp;it&nbsp;might&nbsp;be&nbsp;a&nbsp;problem.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6280465">req</span><span class="op" id="6280468">.</span><span class="ident" id="6280469">pw</span><span class="op" id="6280471">.</span><span class="ident" id="6280472">Write</span><span class="op" id="6280477">(</span><span class="ident" id="6280478">content</span><span class="op" id="6280485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6280489">}</span>&nbsp;<span class="keyword" id="6280491">else</span>&nbsp;<span class="keyword" id="6280496">if</span>&nbsp;<span class="ident" id="6280499">req</span><span class="op" id="6280502">.</span><span class="ident" id="6280503">pw</span>&nbsp;<span class="op" id="6280506">!=</span>&nbsp;<span class="ident" id="6280509">nil</span>&nbsp;<span class="op" id="6280513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6280518">req</span><span class="op" id="6280521">.</span><span class="ident" id="6280522">pw</span><span class="op" id="6280524">.</span><span class="ident" id="6280525">Close</span><span class="op" id="6280530">(</span><span class="op" id="6280531">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6280535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6280539">return</span>&nbsp;<span class="ident" id="6280546">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6280551">case</span>&nbsp;<span class="ident" id="6280556">typeGetValues</span><span class="op" id="6280569">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6280573">values</span>&nbsp;<span class="op" id="6280580">:=</span>&nbsp;<span class="keyword" id="6280583">map</span><span class="op" id="6280586">[</span><span class="builtintype" id="6280587">string</span><span class="op" id="6280593">]</span><span class="builtintype" id="6280594">string</span><span class="op" id="6280600">{</span><span class="string" id="6280601">&#34;FCGI_MPXS_CONNS&#34;</span><span class="op" id="6280618">:</span>&nbsp;<span class="string" id="6280620">&#34;1&#34;</span><span class="op" id="6280623">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6280627">c</span><span class="op" id="6280628">.</span><span class="ident" id="6280629">conn</span><span class="op" id="6280633">.</span><span class="ident" id="6280634">writePairs</span><span class="op" id="6280644">(</span><span class="ident" id="6280645">typeGetValuesResult</span><span class="op" id="6280664">,</span>&nbsp;<span class="num" id="6280666">0</span><span class="op" id="6280667">,</span>&nbsp;<span class="ident" id="6280669">values</span><span class="op" id="6280675">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6280679">return</span>&nbsp;<span class="ident" id="6280686">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6280691">case</span>&nbsp;<span class="ident" id="6280696">typeData</span><span class="op" id="6280704">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6280708">//&nbsp;If&nbsp;the&nbsp;filter&nbsp;role&nbsp;is&nbsp;implemented,&nbsp;read&nbsp;the&nbsp;data&nbsp;stream&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6280775">return</span>&nbsp;<span class="ident" id="6280782">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6280787">case</span>&nbsp;<span class="ident" id="6280792">typeAbortRequest</span><span class="op" id="6280808">:</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6280812">println</span><span class="op" id="6280819">(</span><span class="string" id="6280820">&#34;abort&#34;</span><span class="op" id="6280827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6280831">c</span><span class="op" id="6280832">.</span><span class="ident" id="6280833">mu</span><span class="op" id="6280835">.</span><span class="ident" id="6280836">Lock</span><span class="op" id="6280840">(</span><span class="op" id="6280841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6280845">delete</span><span class="op" id="6280851">(</span><span class="ident" id="6280852">c</span><span class="op" id="6280853">.</span><span class="ident" id="6280854">requests</span><span class="op" id="6280862">,</span>&nbsp;<span class="ident" id="6280864">rec</span><span class="op" id="6280867">.</span><span class="ident" id="6280868">h</span><span class="op" id="6280869">.</span><span class="ident" id="6280870">Id</span><span class="op" id="6280872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6280876">c</span><span class="op" id="6280877">.</span><span class="ident" id="6280878">mu</span><span class="op" id="6280880">.</span><span class="ident" id="6280881">Unlock</span><span class="op" id="6280887">(</span><span class="op" id="6280888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6280892">c</span><span class="op" id="6280893">.</span><span class="ident" id="6280894">conn</span><span class="op" id="6280898">.</span><span class="ident" id="6280899">writeEndRequest</span><span class="op" id="6280914">(</span><span class="ident" id="6280915">rec</span><span class="op" id="6280918">.</span><span class="ident" id="6280919">h</span><span class="op" id="6280920">.</span><span class="ident" id="6280921">Id</span><span class="op" id="6280923">,</span>&nbsp;<span class="num" id="6280925">0</span><span class="op" id="6280926">,</span>&nbsp;<span class="ident" id="6280928">statusRequestComplete</span><span class="op" id="6280949">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6280953">if</span>&nbsp;<span class="op" id="6280956">!</span><span class="ident" id="6280957">req</span><span class="op" id="6280960">.</span><span class="ident" id="6280961">keepConn</span>&nbsp;<span class="op" id="6280970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6280975">//&nbsp;connection&nbsp;will&nbsp;close&nbsp;upon&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6281015">return</span>&nbsp;<span class="ident" id="6281022">errCloseConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6281037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6281041">return</span>&nbsp;<span class="ident" id="6281048">nil</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6281053">default</span><span class="op" id="6281060">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281064">b</span>&nbsp;<span class="op" id="6281066">:=</span>&nbsp;<span class="builtinfunc" id="6281069">make</span><span class="op" id="6281073">(</span><span class="op" id="6281074">[</span><span class="op" id="6281075">]</span><span class="builtintype" id="6281076">byte</span><span class="op" id="6281080">,</span>&nbsp;<span class="num" id="6281082">8</span><span class="op" id="6281083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281087">b</span><span class="op" id="6281088">[</span><span class="num" id="6281089">0</span><span class="op" id="6281090">]</span>&nbsp;<span class="op" id="6281092">=</span>&nbsp;<span class="builtintype" id="6281094">byte</span><span class="op" id="6281098">(</span><span class="ident" id="6281099">rec</span><span class="op" id="6281102">.</span><span class="ident" id="6281103">h</span><span class="op" id="6281104">.</span><span class="ident" id="6281105">Type</span><span class="op" id="6281109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281113">c</span><span class="op" id="6281114">.</span><span class="ident" id="6281115">conn</span><span class="op" id="6281119">.</span><span class="ident" id="6281120">writeRecord</span><span class="op" id="6281131">(</span><span class="ident" id="6281132">typeUnknownType</span><span class="op" id="6281147">,</span>&nbsp;<span class="num" id="6281149">0</span><span class="op" id="6281150">,</span>&nbsp;<span class="ident" id="6281152">b</span><span class="op" id="6281153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6281157">return</span>&nbsp;<span class="ident" id="6281164">nil</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6281169">}</span><br>
<span class="lineno"></span><span class="op" id="6281171">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6281174">func</span>&nbsp;<span class="op" id="6281179">(</span><span class="ident" id="6281180">c</span>&nbsp;<span class="op" id="6281182">*</span><span class="ident" id="6281183">child</span><span class="op" id="6281188">)</span>&nbsp;<span class="ident" id="6281190">serveRequest</span><span class="op" id="6281202">(</span><span class="ident" id="6281203">req</span>&nbsp;<span class="op" id="6281207">*</span><span class="ident" id="6281208">request</span><span class="op" id="6281215">,</span>&nbsp;<span class="ident" id="6281217">body</span>&nbsp;<span class="ident" id="6281222">io</span><span class="op" id="6281224">.</span><span class="ident" id="6281225">ReadCloser</span><span class="op" id="6281235">)</span>&nbsp;<span class="op" id="6281237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281240">r</span>&nbsp;<span class="op" id="6281242">:=</span>&nbsp;<span class="ident" id="6281245">newResponse</span><span class="op" id="6281256">(</span><span class="ident" id="6281257">c</span><span class="op" id="6281258">,</span>&nbsp;<span class="ident" id="6281260">req</span><span class="op" id="6281263">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281266">httpReq</span><span class="op" id="6281273">,</span>&nbsp;<span class="ident" id="6281275">err</span>&nbsp;<span class="op" id="6281279">:=</span>&nbsp;<span class="ident" id="6281282">cgi</span><span class="op" id="6281285">.</span><span class="ident" id="6281286">RequestFromMap</span><span class="op" id="6281300">(</span><span class="ident" id="6281301">req</span><span class="op" id="6281304">.</span><span class="ident" id="6281305">params</span><span class="op" id="6281311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6281314">if</span>&nbsp;<span class="ident" id="6281317">err</span>&nbsp;<span class="op" id="6281321">!=</span>&nbsp;<span class="ident" id="6281324">nil</span>&nbsp;<span class="op" id="6281328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6281332">//&nbsp;there&nbsp;was&nbsp;an&nbsp;error&nbsp;reading&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281376">r</span><span class="op" id="6281377">.</span><span class="ident" id="6281378">WriteHeader</span><span class="op" id="6281389">(</span><span class="ident" id="6281390">http</span><span class="op" id="6281394">.</span><span class="ident" id="6281395">StatusInternalServerError</span><span class="op" id="6281420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281424">c</span><span class="op" id="6281425">.</span><span class="ident" id="6281426">conn</span><span class="op" id="6281430">.</span><span class="ident" id="6281431">writeRecord</span><span class="op" id="6281442">(</span><span class="ident" id="6281443">typeStderr</span><span class="op" id="6281453">,</span>&nbsp;<span class="ident" id="6281455">req</span><span class="op" id="6281458">.</span><span class="ident" id="6281459">reqId</span><span class="op" id="6281464">,</span>&nbsp;<span class="op" id="6281466">[</span><span class="op" id="6281467">]</span><span class="builtintype" id="6281468">byte</span><span class="op" id="6281472">(</span><span class="ident" id="6281473">err</span><span class="op" id="6281476">.</span><span class="ident" id="6281477">Error</span><span class="op" id="6281482">(</span><span class="op" id="6281483">)</span><span class="op" id="6281484">)</span><span class="op" id="6281485">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6281488">}</span>&nbsp;<span class="keyword" id="6281490">else</span>&nbsp;<span class="op" id="6281495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281499">httpReq</span><span class="op" id="6281506">.</span><span class="ident" id="6281507">Body</span>&nbsp;<span class="op" id="6281512">=</span>&nbsp;<span class="ident" id="6281514">body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281521">c</span><span class="op" id="6281522">.</span><span class="ident" id="6281523">handler</span><span class="op" id="6281530">.</span><span class="ident" id="6281531">ServeHTTP</span><span class="op" id="6281540">(</span><span class="ident" id="6281541">r</span><span class="op" id="6281542">,</span>&nbsp;<span class="ident" id="6281544">httpReq</span><span class="op" id="6281551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6281554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281557">r</span><span class="op" id="6281558">.</span><span class="ident" id="6281559">Close</span><span class="op" id="6281564">(</span><span class="op" id="6281565">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281568">c</span><span class="op" id="6281569">.</span><span class="ident" id="6281570">mu</span><span class="op" id="6281572">.</span><span class="ident" id="6281573">Lock</span><span class="op" id="6281577">(</span><span class="op" id="6281578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6281581">delete</span><span class="op" id="6281587">(</span><span class="ident" id="6281588">c</span><span class="op" id="6281589">.</span><span class="ident" id="6281590">requests</span><span class="op" id="6281598">,</span>&nbsp;<span class="ident" id="6281600">req</span><span class="op" id="6281603">.</span><span class="ident" id="6281604">reqId</span><span class="op" id="6281609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281612">c</span><span class="op" id="6281613">.</span><span class="ident" id="6281614">mu</span><span class="op" id="6281616">.</span><span class="ident" id="6281617">Unlock</span><span class="op" id="6281623">(</span><span class="op" id="6281624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281627">c</span><span class="op" id="6281628">.</span><span class="ident" id="6281629">conn</span><span class="op" id="6281633">.</span><span class="ident" id="6281634">writeEndRequest</span><span class="op" id="6281649">(</span><span class="ident" id="6281650">req</span><span class="op" id="6281653">.</span><span class="ident" id="6281654">reqId</span><span class="op" id="6281659">,</span>&nbsp;<span class="num" id="6281661">0</span><span class="op" id="6281662">,</span>&nbsp;<span class="ident" id="6281664">statusRequestComplete</span><span class="op" id="6281685">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6281689">//&nbsp;Consume&nbsp;the&nbsp;entire&nbsp;body,&nbsp;so&nbsp;the&nbsp;host&nbsp;isn&#39;t&nbsp;still&nbsp;writing&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6281753">//&nbsp;us&nbsp;when&nbsp;we&nbsp;close&nbsp;the&nbsp;socket&nbsp;below&nbsp;in&nbsp;the&nbsp;!keepConn&nbsp;case,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6281814">//&nbsp;otherwise&nbsp;we&#39;d&nbsp;send&nbsp;a&nbsp;RST.&nbsp;(golang.org/issue/4183)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6281869">//&nbsp;TODO(bradfitz):&nbsp;also&nbsp;bound&nbsp;this&nbsp;copy&nbsp;in&nbsp;time.&nbsp;Or&nbsp;send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6281927">//&nbsp;some&nbsp;sort&nbsp;of&nbsp;abort&nbsp;request&nbsp;to&nbsp;the&nbsp;host,&nbsp;so&nbsp;the&nbsp;host</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6281983">//&nbsp;can&nbsp;properly&nbsp;cut&nbsp;off&nbsp;the&nbsp;client&nbsp;sending&nbsp;all&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6282041">//&nbsp;For&nbsp;now&nbsp;just&nbsp;bound&nbsp;it&nbsp;a&nbsp;little&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6282080">io</span><span class="op" id="6282082">.</span><span class="ident" id="6282083">CopyN</span><span class="op" id="6282088">(</span><span class="ident" id="6282089">ioutil</span><span class="op" id="6282095">.</span><span class="ident" id="6282096">Discard</span><span class="op" id="6282103">,</span>&nbsp;<span class="ident" id="6282105">body</span><span class="op" id="6282109">,</span>&nbsp;<span class="num" id="6282111">100</span><span class="op" id="6282114">&lt;&lt;</span><span class="num" id="6282116">20</span><span class="op" id="6282118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6282121">body</span><span class="op" id="6282125">.</span><span class="ident" id="6282126">Close</span><span class="op" id="6282131">(</span><span class="op" id="6282132">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282136">if</span>&nbsp;<span class="op" id="6282139">!</span><span class="ident" id="6282140">req</span><span class="op" id="6282143">.</span><span class="ident" id="6282144">keepConn</span>&nbsp;<span class="op" id="6282153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6282157">c</span><span class="op" id="6282158">.</span><span class="ident" id="6282159">conn</span><span class="op" id="6282163">.</span><span class="ident" id="6282164">Close</span><span class="op" id="6282169">(</span><span class="op" id="6282170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6282173">}</span><br>
<span class="lineno"></span><span class="op" id="6282175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="6282178">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;FastCGI&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;l,&nbsp;creating&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="6282258">//&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;The&nbsp;goroutine&nbsp;reads&nbsp;requests&nbsp;and&nbsp;then&nbsp;calls&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="6282333">//&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="comment" id="6282354">//&nbsp;If&nbsp;l&nbsp;is&nbsp;nil,&nbsp;Serve&nbsp;accepts&nbsp;connections&nbsp;from&nbsp;os.Stdin.</span><br>
<span class="lineno"></span><span class="comment" id="6282411">//&nbsp;If&nbsp;handler&nbsp;is&nbsp;nil,&nbsp;http.DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno">285</span><span class="keyword" id="6282463">func</span>&nbsp;<span class="ident" id="6282468">Serve</span><span class="op" id="6282473">(</span><span class="ident" id="6282474">l</span>&nbsp;<span class="ident" id="6282476">net</span><span class="op" id="6282479">.</span><span class="ident" id="6282480">Listener</span><span class="op" id="6282488">,</span>&nbsp;<span class="ident" id="6282490">handler</span>&nbsp;<span class="ident" id="6282498">http</span><span class="op" id="6282502">.</span><span class="ident" id="6282503">Handler</span><span class="op" id="6282510">)</span>&nbsp;<span class="builtintype" id="6282512">error</span>&nbsp;<span class="op" id="6282518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282521">if</span>&nbsp;<span class="ident" id="6282524">l</span>&nbsp;<span class="op" id="6282526">==</span>&nbsp;<span class="ident" id="6282529">nil</span>&nbsp;<span class="op" id="6282533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282537">var</span>&nbsp;<span class="ident" id="6282541">err</span>&nbsp;<span class="builtintype" id="6282545">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6282553">l</span><span class="op" id="6282554">,</span>&nbsp;<span class="ident" id="6282556">err</span>&nbsp;<span class="op" id="6282560">=</span>&nbsp;<span class="ident" id="6282562">net</span><span class="op" id="6282565">.</span><span class="ident" id="6282566">FileListener</span><span class="op" id="6282578">(</span><span class="ident" id="6282579">os</span><span class="op" id="6282581">.</span><span class="ident" id="6282582">Stdin</span><span class="op" id="6282587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282591">if</span>&nbsp;<span class="ident" id="6282594">err</span>&nbsp;<span class="op" id="6282598">!=</span>&nbsp;<span class="ident" id="6282601">nil</span>&nbsp;<span class="op" id="6282605">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282610">return</span>&nbsp;<span class="ident" id="6282617">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6282623">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282627">defer</span>&nbsp;<span class="ident" id="6282633">l</span><span class="op" id="6282634">.</span><span class="ident" id="6282635">Close</span><span class="op" id="6282640">(</span><span class="op" id="6282641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6282644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282647">if</span>&nbsp;<span class="ident" id="6282650">handler</span>&nbsp;<span class="op" id="6282658">==</span>&nbsp;<span class="ident" id="6282661">nil</span>&nbsp;<span class="op" id="6282665">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6282669">handler</span>&nbsp;<span class="op" id="6282677">=</span>&nbsp;<span class="ident" id="6282679">http</span><span class="op" id="6282683">.</span><span class="ident" id="6282684">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6282701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282704">for</span>&nbsp;<span class="op" id="6282708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6282712">rw</span><span class="op" id="6282714">,</span>&nbsp;<span class="ident" id="6282716">err</span>&nbsp;<span class="op" id="6282720">:=</span>&nbsp;<span class="ident" id="6282723">l</span><span class="op" id="6282724">.</span><span class="ident" id="6282725">Accept</span><span class="op" id="6282731">(</span><span class="op" id="6282732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282736">if</span>&nbsp;<span class="ident" id="6282739">err</span>&nbsp;<span class="op" id="6282743">!=</span>&nbsp;<span class="ident" id="6282746">nil</span>&nbsp;<span class="op" id="6282750">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282755">return</span>&nbsp;<span class="ident" id="6282762">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6282768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6282772">c</span>&nbsp;<span class="op" id="6282774">:=</span>&nbsp;<span class="ident" id="6282777">newChild</span><span class="op" id="6282785">(</span><span class="ident" id="6282786">rw</span><span class="op" id="6282788">,</span>&nbsp;<span class="ident" id="6282790">handler</span><span class="op" id="6282797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282801">go</span>&nbsp;<span class="ident" id="6282804">c</span><span class="op" id="6282805">.</span><span class="ident" id="6282806">serve</span><span class="op" id="6282811">(</span><span class="op" id="6282812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6282815">}</span><br>
<span class="lineno">305</span><span class="op" id="6282817">}</span>
</div>
</body>
</html>
