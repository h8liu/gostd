<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/jpeg</h2>
<ul>
<li><a href="/gostd/image/jpeg/dct_test.go.html">dct_test.go</a></li>
<li><a href="/gostd/image/jpeg/fdct.go.html">fdct.go</a></li>
<li><a href="/gostd/image/jpeg/huffman.go.html">huffman.go</a></li>
<li><a href="/gostd/image/jpeg/idct.go.html">idct.go</a></li>
<li><a href="/gostd/image/jpeg/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/jpeg/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/jpeg/scan.go.html">scan.go</a></li>
<li><a href="/gostd/image/jpeg/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/jpeg/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5898386">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5898441">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5898495">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5898546">//&nbsp;Package&nbsp;jpeg&nbsp;implements&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;decoder&nbsp;and&nbsp;encoder.</span><br>
<span class="lineno"></span><span class="comment" id="5898607">//</span><br>
<span class="lineno"></span><span class="comment" id="5898610">//&nbsp;JPEG&nbsp;is&nbsp;defined&nbsp;in&nbsp;ITU-T&nbsp;T.81:&nbsp;http://www.w3.org/Graphics/JPEG/itu-t81.pdf.</span><br>
<span class="lineno"></span><span class="keyword" id="5898689">package</span>&nbsp;<span class="ident" id="5898697">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="5898703">import</span>&nbsp;<span class="op" id="5898710">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5898713">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5898722">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5898737">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="5898742">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="5898745">//&nbsp;TODO(nigeltao):&nbsp;fix&nbsp;up&nbsp;the&nbsp;doc&nbsp;comment&nbsp;style&nbsp;so&nbsp;that&nbsp;sentences&nbsp;start&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="5898822">//&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;type&nbsp;or&nbsp;function&nbsp;that&nbsp;they&nbsp;annotate.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5898879">//&nbsp;A&nbsp;FormatError&nbsp;reports&nbsp;that&nbsp;the&nbsp;input&nbsp;is&nbsp;not&nbsp;a&nbsp;valid&nbsp;JPEG.</span><br>
<span class="lineno">20</span><span class="keyword" id="5898940">type</span>&nbsp;<span class="ident" id="5898945">FormatError</span>&nbsp;<span class="builtintype" id="5898957">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5898965">func</span>&nbsp;<span class="op" id="5898970">(</span><span class="ident" id="5898971">e</span>&nbsp;<span class="ident" id="5898973">FormatError</span><span class="op" id="5898984">)</span>&nbsp;<span class="ident" id="5898986">Error</span><span class="op" id="5898991">(</span><span class="op" id="5898992">)</span>&nbsp;<span class="builtintype" id="5898994">string</span>&nbsp;<span class="op" id="5899001">{</span>&nbsp;<span class="keyword" id="5899003">return</span>&nbsp;<span class="string" id="5899010">&#34;invalid&nbsp;JPEG&nbsp;format:&nbsp;&#34;</span>&nbsp;<span class="op" id="5899034">+</span>&nbsp;<span class="builtintype" id="5899036">string</span><span class="op" id="5899042">(</span><span class="ident" id="5899043">e</span><span class="op" id="5899044">)</span>&nbsp;<span class="op" id="5899046">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5899049">//&nbsp;An&nbsp;UnsupportedError&nbsp;reports&nbsp;that&nbsp;the&nbsp;input&nbsp;uses&nbsp;a&nbsp;valid&nbsp;but&nbsp;unimplemented&nbsp;JPEG&nbsp;feature.</span><br>
<span class="lineno">25</span><span class="keyword" id="5899140">type</span>&nbsp;<span class="ident" id="5899145">UnsupportedError</span>&nbsp;<span class="builtintype" id="5899162">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5899170">func</span>&nbsp;<span class="op" id="5899175">(</span><span class="ident" id="5899176">e</span>&nbsp;<span class="ident" id="5899178">UnsupportedError</span><span class="op" id="5899194">)</span>&nbsp;<span class="ident" id="5899196">Error</span><span class="op" id="5899201">(</span><span class="op" id="5899202">)</span>&nbsp;<span class="builtintype" id="5899204">string</span>&nbsp;<span class="op" id="5899211">{</span>&nbsp;<span class="keyword" id="5899213">return</span>&nbsp;<span class="string" id="5899220">&#34;unsupported&nbsp;JPEG&nbsp;feature:&nbsp;&#34;</span>&nbsp;<span class="op" id="5899249">+</span>&nbsp;<span class="builtintype" id="5899251">string</span><span class="op" id="5899257">(</span><span class="ident" id="5899258">e</span><span class="op" id="5899259">)</span>&nbsp;<span class="op" id="5899261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5899264">//&nbsp;Component&nbsp;specification,&nbsp;specified&nbsp;in&nbsp;section&nbsp;B.2.2.</span><br>
<span class="lineno">30</span><span class="keyword" id="5899320">type</span>&nbsp;<span class="ident" id="5899325">component</span>&nbsp;<span class="keyword" id="5899335">struct</span>&nbsp;<span class="op" id="5899342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899345">h</span>&nbsp;&nbsp;<span class="builtintype" id="5899348">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5899354">//&nbsp;Horizontal&nbsp;sampling&nbsp;factor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899386">v</span>&nbsp;&nbsp;<span class="builtintype" id="5899389">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5899395">//&nbsp;Vertical&nbsp;sampling&nbsp;factor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899425">c</span>&nbsp;&nbsp;<span class="builtintype" id="5899428">uint8</span>&nbsp;<span class="comment" id="5899434">//&nbsp;Component&nbsp;identifier.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899460">tq</span>&nbsp;<span class="builtintype" id="5899463">uint8</span>&nbsp;<span class="comment" id="5899469">//&nbsp;Quantization&nbsp;table&nbsp;destination&nbsp;selector.</span><br>
<span class="lineno">35</span><span class="op" id="5899513">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5899516">const</span>&nbsp;<span class="op" id="5899522">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899525">dcTable</span>&nbsp;<span class="op" id="5899533">=</span>&nbsp;<span class="num" id="5899535">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899538">acTable</span>&nbsp;<span class="op" id="5899546">=</span>&nbsp;<span class="num" id="5899548">1</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899551">maxTc</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5899559">=</span>&nbsp;<span class="num" id="5899561">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899564">maxTh</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5899572">=</span>&nbsp;<span class="num" id="5899574">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899577">maxTq</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5899585">=</span>&nbsp;<span class="num" id="5899587">3</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5899591">//&nbsp;A&nbsp;grayscale&nbsp;JPEG&nbsp;image&nbsp;has&nbsp;only&nbsp;a&nbsp;Y&nbsp;component.</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899642">nGrayComponent</span>&nbsp;<span class="op" id="5899657">=</span>&nbsp;<span class="num" id="5899659">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5899662">//&nbsp;A&nbsp;color&nbsp;JPEG&nbsp;image&nbsp;has&nbsp;Y,&nbsp;Cb&nbsp;and&nbsp;Cr&nbsp;components.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899714">nColorComponent</span>&nbsp;<span class="op" id="5899730">=</span>&nbsp;<span class="num" id="5899732">3</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5899736">//&nbsp;We&nbsp;only&nbsp;support&nbsp;4:4:4,&nbsp;4:4:0,&nbsp;4:2:2&nbsp;and&nbsp;4:2:0&nbsp;downsampling,&nbsp;and&nbsp;therefore&nbsp;the</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5899818">//&nbsp;number&nbsp;of&nbsp;luma&nbsp;samples&nbsp;per&nbsp;chroma&nbsp;sample&nbsp;is&nbsp;at&nbsp;most&nbsp;2&nbsp;in&nbsp;the&nbsp;horizontal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5899894">//&nbsp;and&nbsp;2&nbsp;in&nbsp;the&nbsp;vertical&nbsp;direction.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899931">maxH</span>&nbsp;<span class="op" id="5899936">=</span>&nbsp;<span class="num" id="5899938">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899941">maxV</span>&nbsp;<span class="op" id="5899946">=</span>&nbsp;<span class="num" id="5899948">2</span><br>
<span class="lineno"></span><span class="op" id="5899950">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="5899953">const</span>&nbsp;<span class="op" id="5899959">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899962">soiMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5899974">=</span>&nbsp;<span class="num" id="5899976">0xd8</span>&nbsp;<span class="comment" id="5899981">//&nbsp;Start&nbsp;Of&nbsp;Image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5900001">eoiMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5900013">=</span>&nbsp;<span class="num" id="5900015">0xd9</span>&nbsp;<span class="comment" id="5900020">//&nbsp;End&nbsp;Of&nbsp;Image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5900038">sof0Marker</span>&nbsp;&nbsp;<span class="op" id="5900050">=</span>&nbsp;<span class="num" id="5900052">0xc0</span>&nbsp;<span class="comment" id="5900057">//&nbsp;Start&nbsp;Of&nbsp;Frame&nbsp;(Baseline).</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5900088">sof2Marker</span>&nbsp;&nbsp;<span class="op" id="5900100">=</span>&nbsp;<span class="num" id="5900102">0xc2</span>&nbsp;<span class="comment" id="5900107">//&nbsp;Start&nbsp;Of&nbsp;Frame&nbsp;(Progressive).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5900141">dhtMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5900153">=</span>&nbsp;<span class="num" id="5900155">0xc4</span>&nbsp;<span class="comment" id="5900160">//&nbsp;Define&nbsp;Huffman&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5900186">dqtMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5900198">=</span>&nbsp;<span class="num" id="5900200">0xdb</span>&nbsp;<span class="comment" id="5900205">//&nbsp;Define&nbsp;Quantization&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5900236">sosMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5900248">=</span>&nbsp;<span class="num" id="5900250">0xda</span>&nbsp;<span class="comment" id="5900255">//&nbsp;Start&nbsp;Of&nbsp;Scan.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5900274">driMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5900286">=</span>&nbsp;<span class="num" id="5900288">0xdd</span>&nbsp;<span class="comment" id="5900293">//&nbsp;Define&nbsp;Restart&nbsp;Interval.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5900322">rst0Marker</span>&nbsp;&nbsp;<span class="op" id="5900334">=</span>&nbsp;<span class="num" id="5900336">0xd0</span>&nbsp;<span class="comment" id="5900341">//&nbsp;ReSTart&nbsp;(0).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5900358">rst7Marker</span>&nbsp;&nbsp;<span class="op" id="5900370">=</span>&nbsp;<span class="num" id="5900372">0xd7</span>&nbsp;<span class="comment" id="5900377">//&nbsp;ReSTart&nbsp;(7).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5900394">app0Marker</span>&nbsp;&nbsp;<span class="op" id="5900406">=</span>&nbsp;<span class="num" id="5900408">0xe0</span>&nbsp;<span class="comment" id="5900413">//&nbsp;APPlication&nbsp;specific&nbsp;(0).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5900443">app15Marker</span>&nbsp;<span class="op" id="5900455">=</span>&nbsp;<span class="num" id="5900457">0xef</span>&nbsp;<span class="comment" id="5900462">//&nbsp;APPlication&nbsp;specific&nbsp;(15).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5900493">comMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5900505">=</span>&nbsp;<span class="num" id="5900507">0xfe</span>&nbsp;<span class="comment" id="5900512">//&nbsp;COMment.</span><br>
<span class="lineno">70</span><span class="op" id="5900524">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5900527">//&nbsp;unzig&nbsp;maps&nbsp;from&nbsp;the&nbsp;zig-zag&nbsp;ordering&nbsp;to&nbsp;the&nbsp;natural&nbsp;ordering.&nbsp;For&nbsp;example,</span><br>
<span class="lineno"></span><span class="comment" id="5900605">//&nbsp;unzig[3]&nbsp;is&nbsp;the&nbsp;column&nbsp;and&nbsp;row&nbsp;of&nbsp;the&nbsp;fourth&nbsp;element&nbsp;in&nbsp;zig-zag&nbsp;order.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="5900683">//&nbsp;value&nbsp;is&nbsp;16,&nbsp;which&nbsp;means&nbsp;first&nbsp;column&nbsp;(16%8&nbsp;==&nbsp;0)&nbsp;and&nbsp;third&nbsp;row&nbsp;(16/8&nbsp;==&nbsp;2).</span><br>
<span class="lineno">75</span><span class="keyword" id="5900763">var</span>&nbsp;<span class="ident" id="5900767">unzig</span>&nbsp;<span class="op" id="5900773">=</span>&nbsp;<span class="op" id="5900775">[</span><span class="ident" id="5900776">blockSize</span><span class="op" id="5900785">]</span><span class="builtintype" id="5900786">int</span><span class="op" id="5900789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5900792">0</span><span class="op" id="5900793">,</span>&nbsp;<span class="num" id="5900795">1</span><span class="op" id="5900796">,</span>&nbsp;<span class="num" id="5900798">8</span><span class="op" id="5900799">,</span>&nbsp;<span class="num" id="5900801">16</span><span class="op" id="5900803">,</span>&nbsp;<span class="num" id="5900805">9</span><span class="op" id="5900806">,</span>&nbsp;<span class="num" id="5900808">2</span><span class="op" id="5900809">,</span>&nbsp;<span class="num" id="5900811">3</span><span class="op" id="5900812">,</span>&nbsp;<span class="num" id="5900814">10</span><span class="op" id="5900816">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5900819">17</span><span class="op" id="5900821">,</span>&nbsp;<span class="num" id="5900823">24</span><span class="op" id="5900825">,</span>&nbsp;<span class="num" id="5900827">32</span><span class="op" id="5900829">,</span>&nbsp;<span class="num" id="5900831">25</span><span class="op" id="5900833">,</span>&nbsp;<span class="num" id="5900835">18</span><span class="op" id="5900837">,</span>&nbsp;<span class="num" id="5900839">11</span><span class="op" id="5900841">,</span>&nbsp;<span class="num" id="5900843">4</span><span class="op" id="5900844">,</span>&nbsp;<span class="num" id="5900846">5</span><span class="op" id="5900847">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5900850">12</span><span class="op" id="5900852">,</span>&nbsp;<span class="num" id="5900854">19</span><span class="op" id="5900856">,</span>&nbsp;<span class="num" id="5900858">26</span><span class="op" id="5900860">,</span>&nbsp;<span class="num" id="5900862">33</span><span class="op" id="5900864">,</span>&nbsp;<span class="num" id="5900866">40</span><span class="op" id="5900868">,</span>&nbsp;<span class="num" id="5900870">48</span><span class="op" id="5900872">,</span>&nbsp;<span class="num" id="5900874">41</span><span class="op" id="5900876">,</span>&nbsp;<span class="num" id="5900878">34</span><span class="op" id="5900880">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5900883">27</span><span class="op" id="5900885">,</span>&nbsp;<span class="num" id="5900887">20</span><span class="op" id="5900889">,</span>&nbsp;<span class="num" id="5900891">13</span><span class="op" id="5900893">,</span>&nbsp;<span class="num" id="5900895">6</span><span class="op" id="5900896">,</span>&nbsp;<span class="num" id="5900898">7</span><span class="op" id="5900899">,</span>&nbsp;<span class="num" id="5900901">14</span><span class="op" id="5900903">,</span>&nbsp;<span class="num" id="5900905">21</span><span class="op" id="5900907">,</span>&nbsp;<span class="num" id="5900909">28</span><span class="op" id="5900911">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5900914">35</span><span class="op" id="5900916">,</span>&nbsp;<span class="num" id="5900918">42</span><span class="op" id="5900920">,</span>&nbsp;<span class="num" id="5900922">49</span><span class="op" id="5900924">,</span>&nbsp;<span class="num" id="5900926">56</span><span class="op" id="5900928">,</span>&nbsp;<span class="num" id="5900930">57</span><span class="op" id="5900932">,</span>&nbsp;<span class="num" id="5900934">50</span><span class="op" id="5900936">,</span>&nbsp;<span class="num" id="5900938">43</span><span class="op" id="5900940">,</span>&nbsp;<span class="num" id="5900942">36</span><span class="op" id="5900944">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5900947">29</span><span class="op" id="5900949">,</span>&nbsp;<span class="num" id="5900951">22</span><span class="op" id="5900953">,</span>&nbsp;<span class="num" id="5900955">15</span><span class="op" id="5900957">,</span>&nbsp;<span class="num" id="5900959">23</span><span class="op" id="5900961">,</span>&nbsp;<span class="num" id="5900963">30</span><span class="op" id="5900965">,</span>&nbsp;<span class="num" id="5900967">37</span><span class="op" id="5900969">,</span>&nbsp;<span class="num" id="5900971">44</span><span class="op" id="5900973">,</span>&nbsp;<span class="num" id="5900975">51</span><span class="op" id="5900977">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5900980">58</span><span class="op" id="5900982">,</span>&nbsp;<span class="num" id="5900984">59</span><span class="op" id="5900986">,</span>&nbsp;<span class="num" id="5900988">52</span><span class="op" id="5900990">,</span>&nbsp;<span class="num" id="5900992">45</span><span class="op" id="5900994">,</span>&nbsp;<span class="num" id="5900996">38</span><span class="op" id="5900998">,</span>&nbsp;<span class="num" id="5901000">31</span><span class="op" id="5901002">,</span>&nbsp;<span class="num" id="5901004">39</span><span class="op" id="5901006">,</span>&nbsp;<span class="num" id="5901008">46</span><span class="op" id="5901010">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5901013">53</span><span class="op" id="5901015">,</span>&nbsp;<span class="num" id="5901017">60</span><span class="op" id="5901019">,</span>&nbsp;<span class="num" id="5901021">61</span><span class="op" id="5901023">,</span>&nbsp;<span class="num" id="5901025">54</span><span class="op" id="5901027">,</span>&nbsp;<span class="num" id="5901029">47</span><span class="op" id="5901031">,</span>&nbsp;<span class="num" id="5901033">55</span><span class="op" id="5901035">,</span>&nbsp;<span class="num" id="5901037">62</span><span class="op" id="5901039">,</span>&nbsp;<span class="num" id="5901041">63</span><span class="op" id="5901043">,</span><br>
<span class="lineno"></span><span class="op" id="5901045">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment" id="5901048">//&nbsp;Reader&nbsp;is&nbsp;deprecated.</span><br>
<span class="lineno"></span><span class="keyword" id="5901073">type</span>&nbsp;<span class="ident" id="5901078">Reader</span>&nbsp;<span class="keyword" id="5901085">interface</span>&nbsp;<span class="op" id="5901095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5901098">io</span><span class="op" id="5901100">.</span><span class="ident" id="5901101">ByteReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5901113">io</span><span class="op" id="5901115">.</span><span class="ident" id="5901116">Reader</span><br>
<span class="lineno">90</span><span class="op" id="5901123">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5901126">//&nbsp;bits&nbsp;holds&nbsp;the&nbsp;unprocessed&nbsp;bits&nbsp;that&nbsp;have&nbsp;been&nbsp;taken&nbsp;from&nbsp;the&nbsp;byte-stream.</span><br>
<span class="lineno"></span><span class="comment" id="5901204">//&nbsp;The&nbsp;n&nbsp;least&nbsp;significant&nbsp;bits&nbsp;of&nbsp;a&nbsp;form&nbsp;the&nbsp;unread&nbsp;bits,&nbsp;to&nbsp;be&nbsp;read&nbsp;in&nbsp;MSB&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5901284">//&nbsp;LSB&nbsp;order.</span><br>
<span class="lineno">95</span><span class="keyword" id="5901298">type</span>&nbsp;<span class="ident" id="5901303">bits</span>&nbsp;<span class="keyword" id="5901308">struct</span>&nbsp;<span class="op" id="5901315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5901318">a</span>&nbsp;<span class="builtintype" id="5901320">uint32</span>&nbsp;<span class="comment" id="5901327">//&nbsp;accumulator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5901344">m</span>&nbsp;<span class="builtintype" id="5901346">uint32</span>&nbsp;<span class="comment" id="5901353">//&nbsp;mask.&nbsp;m==1&lt;&lt;(n-1)&nbsp;when&nbsp;n&gt;0,&nbsp;with&nbsp;m==0&nbsp;when&nbsp;n==0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5901406">n</span>&nbsp;<span class="builtintype" id="5901408">int32</span>&nbsp;&nbsp;<span class="comment" id="5901415">//&nbsp;the&nbsp;number&nbsp;of&nbsp;unread&nbsp;bits&nbsp;in&nbsp;a.</span><br>
<span class="lineno"></span><span class="op" id="5901450">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="5901453">type</span>&nbsp;<span class="ident" id="5901458">decoder</span>&nbsp;<span class="keyword" id="5901466">struct</span>&nbsp;<span class="op" id="5901473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5901476">r</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5901481">io</span><span class="op" id="5901483">.</span><span class="ident" id="5901484">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5901492">bits</span>&nbsp;<span class="ident" id="5901497">bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5901503">//&nbsp;bytes&nbsp;is&nbsp;a&nbsp;byte&nbsp;buffer,&nbsp;similar&nbsp;to&nbsp;a&nbsp;bufio.Reader,&nbsp;except&nbsp;that&nbsp;it</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5901573">//&nbsp;has&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;unread&nbsp;more&nbsp;than&nbsp;1&nbsp;byte,&nbsp;due&nbsp;to&nbsp;byte&nbsp;stuffing.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5901642">//&nbsp;Byte&nbsp;stuffing&nbsp;is&nbsp;specified&nbsp;in&nbsp;section&nbsp;F.1.2.3.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5901693">bytes</span>&nbsp;<span class="keyword" id="5901699">struct</span>&nbsp;<span class="op" id="5901706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5901710">//&nbsp;buf[i:j]&nbsp;are&nbsp;the&nbsp;buffered&nbsp;bytes&nbsp;read&nbsp;from&nbsp;the&nbsp;underlying</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5901772">//&nbsp;io.Reader&nbsp;that&nbsp;haven&#39;t&nbsp;yet&nbsp;been&nbsp;passed&nbsp;further&nbsp;on.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5901828">buf</span>&nbsp;&nbsp;<span class="op" id="5901833">[</span><span class="num" id="5901834">4096</span><span class="op" id="5901838">]</span><span class="builtintype" id="5901839">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5901846">i</span><span class="op" id="5901847">,</span>&nbsp;<span class="ident" id="5901849">j</span>&nbsp;<span class="builtintype" id="5901851">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5901857">//&nbsp;nUnreadable&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;to&nbsp;back&nbsp;up&nbsp;i&nbsp;after</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5901916">//&nbsp;overshooting.&nbsp;It&nbsp;can&nbsp;be&nbsp;0,&nbsp;1&nbsp;or&nbsp;2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5901956">nUnreadable</span>&nbsp;<span class="builtintype" id="5901968">int</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5901973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5901976">width</span><span class="op" id="5901981">,</span>&nbsp;<span class="ident" id="5901983">height</span>&nbsp;<span class="builtintype" id="5901990">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5901995">img1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5902009">*</span><span class="ident" id="5902010">image</span><span class="op" id="5902015">.</span><span class="ident" id="5902016">Gray</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5902022">img3</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5902036">*</span><span class="ident" id="5902037">image</span><span class="op" id="5902042">.</span><span class="ident" id="5902043">YCbCr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5902050">ri</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5902064">int</span>&nbsp;<span class="comment" id="5902068">//&nbsp;Restart&nbsp;Interval.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5902090">nComp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5902104">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5902109">progressive</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5902123">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5902129">eobRun</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5902143">uint16</span>&nbsp;<span class="comment" id="5902150">//&nbsp;End-of-Band&nbsp;run,&nbsp;specified&nbsp;in&nbsp;section&nbsp;G.1.2.2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5902201">comp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5902215">[</span><span class="ident" id="5902216">nColorComponent</span><span class="op" id="5902231">]</span><span class="ident" id="5902232">component</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5902243">progCoeffs</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5902257">[</span><span class="ident" id="5902258">nColorComponent</span><span class="op" id="5902273">]</span><span class="op" id="5902274">[</span><span class="op" id="5902275">]</span><span class="ident" id="5902276">block</span>&nbsp;<span class="comment" id="5902282">//&nbsp;Saved&nbsp;state&nbsp;between&nbsp;progressive-mode&nbsp;scans.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5902330">huff</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5902344">[</span><span class="ident" id="5902345">maxTc</span>&nbsp;<span class="op" id="5902351">+</span>&nbsp;<span class="num" id="5902353">1</span><span class="op" id="5902354">]</span><span class="op" id="5902355">[</span><span class="ident" id="5902356">maxTh</span>&nbsp;<span class="op" id="5902362">+</span>&nbsp;<span class="num" id="5902364">1</span><span class="op" id="5902365">]</span><span class="ident" id="5902366">huffman</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5902375">quant</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5902389">[</span><span class="ident" id="5902390">maxTq</span>&nbsp;<span class="op" id="5902396">+</span>&nbsp;<span class="num" id="5902398">1</span><span class="op" id="5902399">]</span><span class="ident" id="5902400">block</span>&nbsp;<span class="comment" id="5902406">//&nbsp;Quantization&nbsp;tables,&nbsp;in&nbsp;zig-zag&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5902449">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5902463">[</span><span class="ident" id="5902464">blockSize</span>&nbsp;<span class="op" id="5902474">+</span>&nbsp;<span class="num" id="5902476">1</span><span class="op" id="5902477">]</span><span class="builtintype" id="5902478">byte</span><br>
<span class="lineno"></span><span class="op" id="5902483">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="comment" id="5902486">//&nbsp;fill&nbsp;fills&nbsp;up&nbsp;the&nbsp;d.bytes.buf&nbsp;buffer&nbsp;from&nbsp;the&nbsp;underlying&nbsp;io.Reader.&nbsp;It</span><br>
<span class="lineno"></span><span class="comment" id="5902560">//&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;when&nbsp;there&nbsp;are&nbsp;no&nbsp;unread&nbsp;bytes&nbsp;in&nbsp;d.bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="5902628">func</span>&nbsp;<span class="op" id="5902633">(</span><span class="ident" id="5902634">d</span>&nbsp;<span class="op" id="5902636">*</span><span class="ident" id="5902637">decoder</span><span class="op" id="5902644">)</span>&nbsp;<span class="ident" id="5902646">fill</span><span class="op" id="5902650">(</span><span class="op" id="5902651">)</span>&nbsp;<span class="builtintype" id="5902653">error</span>&nbsp;<span class="op" id="5902659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5902662">if</span>&nbsp;<span class="ident" id="5902665">d</span><span class="op" id="5902666">.</span><span class="ident" id="5902667">bytes</span><span class="op" id="5902672">.</span><span class="ident" id="5902673">i</span>&nbsp;<span class="op" id="5902675">!=</span>&nbsp;<span class="ident" id="5902678">d</span><span class="op" id="5902679">.</span><span class="ident" id="5902680">bytes</span><span class="op" id="5902685">.</span><span class="ident" id="5902686">j</span>&nbsp;<span class="op" id="5902688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5902692">panic</span><span class="op" id="5902697">(</span><span class="string" id="5902698">&#34;jpeg:&nbsp;fill&nbsp;called&nbsp;when&nbsp;unread&nbsp;bytes&nbsp;exist&#34;</span><span class="op" id="5902741">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5902744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5902747">//&nbsp;Move&nbsp;the&nbsp;last&nbsp;2&nbsp;bytes&nbsp;to&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;buffer,&nbsp;in&nbsp;case&nbsp;we&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5902817">//&nbsp;to&nbsp;call&nbsp;unreadByteStuffedByte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5902852">if</span>&nbsp;<span class="ident" id="5902855">d</span><span class="op" id="5902856">.</span><span class="ident" id="5902857">bytes</span><span class="op" id="5902862">.</span><span class="ident" id="5902863">j</span>&nbsp;<span class="op" id="5902865">&gt;</span>&nbsp;<span class="num" id="5902867">2</span>&nbsp;<span class="op" id="5902869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5902873">d</span><span class="op" id="5902874">.</span><span class="ident" id="5902875">bytes</span><span class="op" id="5902880">.</span><span class="ident" id="5902881">buf</span><span class="op" id="5902884">[</span><span class="num" id="5902885">0</span><span class="op" id="5902886">]</span>&nbsp;<span class="op" id="5902888">=</span>&nbsp;<span class="ident" id="5902890">d</span><span class="op" id="5902891">.</span><span class="ident" id="5902892">bytes</span><span class="op" id="5902897">.</span><span class="ident" id="5902898">buf</span><span class="op" id="5902901">[</span><span class="ident" id="5902902">d</span><span class="op" id="5902903">.</span><span class="ident" id="5902904">bytes</span><span class="op" id="5902909">.</span><span class="ident" id="5902910">j</span><span class="op" id="5902911">-</span><span class="num" id="5902912">2</span><span class="op" id="5902913">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5902917">d</span><span class="op" id="5902918">.</span><span class="ident" id="5902919">bytes</span><span class="op" id="5902924">.</span><span class="ident" id="5902925">buf</span><span class="op" id="5902928">[</span><span class="num" id="5902929">1</span><span class="op" id="5902930">]</span>&nbsp;<span class="op" id="5902932">=</span>&nbsp;<span class="ident" id="5902934">d</span><span class="op" id="5902935">.</span><span class="ident" id="5902936">bytes</span><span class="op" id="5902941">.</span><span class="ident" id="5902942">buf</span><span class="op" id="5902945">[</span><span class="ident" id="5902946">d</span><span class="op" id="5902947">.</span><span class="ident" id="5902948">bytes</span><span class="op" id="5902953">.</span><span class="ident" id="5902954">j</span><span class="op" id="5902955">-</span><span class="num" id="5902956">1</span><span class="op" id="5902957">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5902961">d</span><span class="op" id="5902962">.</span><span class="ident" id="5902963">bytes</span><span class="op" id="5902968">.</span><span class="ident" id="5902969">i</span><span class="op" id="5902970">,</span>&nbsp;<span class="ident" id="5902972">d</span><span class="op" id="5902973">.</span><span class="ident" id="5902974">bytes</span><span class="op" id="5902979">.</span><span class="ident" id="5902980">j</span>&nbsp;<span class="op" id="5902982">=</span>&nbsp;<span class="num" id="5902984">2</span><span class="op" id="5902985">,</span>&nbsp;<span class="num" id="5902987">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5902990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5902993">//&nbsp;Fill&nbsp;in&nbsp;the&nbsp;rest&nbsp;of&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5903029">n</span><span class="op" id="5903030">,</span>&nbsp;<span class="ident" id="5903032">err</span>&nbsp;<span class="op" id="5903036">:=</span>&nbsp;<span class="ident" id="5903039">d</span><span class="op" id="5903040">.</span><span class="ident" id="5903041">r</span><span class="op" id="5903042">.</span><span class="ident" id="5903043">Read</span><span class="op" id="5903047">(</span><span class="ident" id="5903048">d</span><span class="op" id="5903049">.</span><span class="ident" id="5903050">bytes</span><span class="op" id="5903055">.</span><span class="ident" id="5903056">buf</span><span class="op" id="5903059">[</span><span class="ident" id="5903060">d</span><span class="op" id="5903061">.</span><span class="ident" id="5903062">bytes</span><span class="op" id="5903067">.</span><span class="ident" id="5903068">j</span><span class="op" id="5903069">:</span><span class="op" id="5903070">]</span><span class="op" id="5903071">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5903074">d</span><span class="op" id="5903075">.</span><span class="ident" id="5903076">bytes</span><span class="op" id="5903081">.</span><span class="ident" id="5903082">j</span>&nbsp;<span class="op" id="5903084">+=</span>&nbsp;<span class="ident" id="5903087">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5903090">if</span>&nbsp;<span class="ident" id="5903093">n</span>&nbsp;<span class="op" id="5903095">&gt;</span>&nbsp;<span class="num" id="5903097">0</span>&nbsp;<span class="op" id="5903099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5903103">err</span>&nbsp;<span class="op" id="5903107">=</span>&nbsp;<span class="ident" id="5903109">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5903114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5903117">return</span>&nbsp;<span class="ident" id="5903124">err</span><br>
<span class="lineno">150</span><span class="op" id="5903128">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5903131">//&nbsp;unreadByteStuffedByte&nbsp;undoes&nbsp;the&nbsp;most&nbsp;recent&nbsp;readByteStuffedByte&nbsp;call,</span><br>
<span class="lineno"></span><span class="comment" id="5903205">//&nbsp;giving&nbsp;a&nbsp;byte&nbsp;of&nbsp;data&nbsp;back&nbsp;from&nbsp;d.bits&nbsp;to&nbsp;d.bytes.&nbsp;The&nbsp;Huffman&nbsp;look-up&nbsp;table</span><br>
<span class="lineno"></span><span class="comment" id="5903285">//&nbsp;requires&nbsp;at&nbsp;least&nbsp;8&nbsp;bits&nbsp;for&nbsp;look-up,&nbsp;which&nbsp;means&nbsp;that&nbsp;Huffman&nbsp;decoding&nbsp;can</span><br>
<span class="lineno">155</span><span class="comment" id="5903364">//&nbsp;sometimes&nbsp;overshoot&nbsp;and&nbsp;read&nbsp;one&nbsp;or&nbsp;two&nbsp;too&nbsp;many&nbsp;bytes.&nbsp;Two-byte&nbsp;overshoot</span><br>
<span class="lineno"></span><span class="comment" id="5903442">//&nbsp;can&nbsp;happen&nbsp;when&nbsp;expecting&nbsp;to&nbsp;read&nbsp;a&nbsp;0xff&nbsp;0x00&nbsp;byte-stuffed&nbsp;byte.</span><br>
<span class="lineno"></span><span class="keyword" id="5903510">func</span>&nbsp;<span class="op" id="5903515">(</span><span class="ident" id="5903516">d</span>&nbsp;<span class="op" id="5903518">*</span><span class="ident" id="5903519">decoder</span><span class="op" id="5903526">)</span>&nbsp;<span class="ident" id="5903528">unreadByteStuffedByte</span><span class="op" id="5903549">(</span><span class="op" id="5903550">)</span>&nbsp;<span class="op" id="5903552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5903555">if</span>&nbsp;<span class="ident" id="5903558">d</span><span class="op" id="5903559">.</span><span class="ident" id="5903560">bytes</span><span class="op" id="5903565">.</span><span class="ident" id="5903566">nUnreadable</span>&nbsp;<span class="op" id="5903578">==</span>&nbsp;<span class="num" id="5903581">0</span>&nbsp;<span class="op" id="5903583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5903587">panic</span><span class="op" id="5903592">(</span><span class="string" id="5903593">&#34;jpeg:&nbsp;unreadByteStuffedByte&nbsp;call&nbsp;cannot&nbsp;be&nbsp;fulfilled&#34;</span><span class="op" id="5903647">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5903650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5903653">d</span><span class="op" id="5903654">.</span><span class="ident" id="5903655">bytes</span><span class="op" id="5903660">.</span><span class="ident" id="5903661">i</span>&nbsp;<span class="op" id="5903663">-=</span>&nbsp;<span class="ident" id="5903666">d</span><span class="op" id="5903667">.</span><span class="ident" id="5903668">bytes</span><span class="op" id="5903673">.</span><span class="ident" id="5903674">nUnreadable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5903687">d</span><span class="op" id="5903688">.</span><span class="ident" id="5903689">bytes</span><span class="op" id="5903694">.</span><span class="ident" id="5903695">nUnreadable</span>&nbsp;<span class="op" id="5903707">=</span>&nbsp;<span class="num" id="5903709">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5903712">if</span>&nbsp;<span class="ident" id="5903715">d</span><span class="op" id="5903716">.</span><span class="ident" id="5903717">bits</span><span class="op" id="5903721">.</span><span class="ident" id="5903722">n</span>&nbsp;<span class="op" id="5903724">&gt;=</span>&nbsp;<span class="num" id="5903727">8</span>&nbsp;<span class="op" id="5903729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5903733">d</span><span class="op" id="5903734">.</span><span class="ident" id="5903735">bits</span><span class="op" id="5903739">.</span><span class="ident" id="5903740">a</span>&nbsp;<span class="op" id="5903742">&gt;&gt;=</span>&nbsp;<span class="num" id="5903746">8</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5903750">d</span><span class="op" id="5903751">.</span><span class="ident" id="5903752">bits</span><span class="op" id="5903756">.</span><span class="ident" id="5903757">n</span>&nbsp;<span class="op" id="5903759">-=</span>&nbsp;<span class="num" id="5903762">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5903766">d</span><span class="op" id="5903767">.</span><span class="ident" id="5903768">bits</span><span class="op" id="5903772">.</span><span class="ident" id="5903773">m</span>&nbsp;<span class="op" id="5903775">&gt;&gt;=</span>&nbsp;<span class="num" id="5903779">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5903782">}</span><br>
<span class="lineno"></span><span class="op" id="5903784">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="comment" id="5903787">//&nbsp;readByte&nbsp;returns&nbsp;the&nbsp;next&nbsp;byte,&nbsp;whether&nbsp;buffered&nbsp;or&nbsp;not&nbsp;buffered.&nbsp;It&nbsp;does</span><br>
<span class="lineno"></span><span class="comment" id="5903864">//&nbsp;not&nbsp;care&nbsp;about&nbsp;byte&nbsp;stuffing.</span><br>
<span class="lineno"></span><span class="keyword" id="5903897">func</span>&nbsp;<span class="op" id="5903902">(</span><span class="ident" id="5903903">d</span>&nbsp;<span class="op" id="5903905">*</span><span class="ident" id="5903906">decoder</span><span class="op" id="5903913">)</span>&nbsp;<span class="ident" id="5903915">readByte</span><span class="op" id="5903923">(</span><span class="op" id="5903924">)</span>&nbsp;<span class="op" id="5903926">(</span><span class="ident" id="5903927">x</span>&nbsp;<span class="builtintype" id="5903929">byte</span><span class="op" id="5903933">,</span>&nbsp;<span class="ident" id="5903935">err</span>&nbsp;<span class="builtintype" id="5903939">error</span><span class="op" id="5903944">)</span>&nbsp;<span class="op" id="5903946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5903949">for</span>&nbsp;<span class="ident" id="5903953">d</span><span class="op" id="5903954">.</span><span class="ident" id="5903955">bytes</span><span class="op" id="5903960">.</span><span class="ident" id="5903961">i</span>&nbsp;<span class="op" id="5903963">==</span>&nbsp;<span class="ident" id="5903966">d</span><span class="op" id="5903967">.</span><span class="ident" id="5903968">bytes</span><span class="op" id="5903973">.</span><span class="ident" id="5903974">j</span>&nbsp;<span class="op" id="5903976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5903980">if</span>&nbsp;<span class="ident" id="5903983">err</span>&nbsp;<span class="op" id="5903987">=</span>&nbsp;<span class="ident" id="5903989">d</span><span class="op" id="5903990">.</span><span class="ident" id="5903991">fill</span><span class="op" id="5903995">(</span><span class="op" id="5903996">)</span><span class="op" id="5903997">;</span>&nbsp;<span class="ident" id="5903999">err</span>&nbsp;<span class="op" id="5904003">!=</span>&nbsp;<span class="ident" id="5904006">nil</span>&nbsp;<span class="op" id="5904010">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904015">return</span>&nbsp;<span class="num" id="5904022">0</span><span class="op" id="5904023">,</span>&nbsp;<span class="ident" id="5904025">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5904031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5904034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5904037">x</span>&nbsp;<span class="op" id="5904039">=</span>&nbsp;<span class="ident" id="5904041">d</span><span class="op" id="5904042">.</span><span class="ident" id="5904043">bytes</span><span class="op" id="5904048">.</span><span class="ident" id="5904049">buf</span><span class="op" id="5904052">[</span><span class="ident" id="5904053">d</span><span class="op" id="5904054">.</span><span class="ident" id="5904055">bytes</span><span class="op" id="5904060">.</span><span class="ident" id="5904061">i</span><span class="op" id="5904062">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5904065">d</span><span class="op" id="5904066">.</span><span class="ident" id="5904067">bytes</span><span class="op" id="5904072">.</span><span class="ident" id="5904073">i</span><span class="op" id="5904074">++</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5904078">d</span><span class="op" id="5904079">.</span><span class="ident" id="5904080">bytes</span><span class="op" id="5904085">.</span><span class="ident" id="5904086">nUnreadable</span>&nbsp;<span class="op" id="5904098">=</span>&nbsp;<span class="num" id="5904100">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904103">return</span>&nbsp;<span class="ident" id="5904110">x</span><span class="op" id="5904111">,</span>&nbsp;<span class="ident" id="5904113">nil</span><br>
<span class="lineno"></span><span class="op" id="5904117">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5904120">//&nbsp;errMissingFF00&nbsp;means&nbsp;that&nbsp;readByteStuffedByte&nbsp;encountered&nbsp;an&nbsp;0xff&nbsp;byte&nbsp;(a</span><br>
<span class="lineno">185</span><span class="comment" id="5904197">//&nbsp;marker&nbsp;byte)&nbsp;that&nbsp;wasn&#39;t&nbsp;the&nbsp;expected&nbsp;byte-stuffed&nbsp;sequence&nbsp;0xff,&nbsp;0x00.</span><br>
<span class="lineno"></span><span class="keyword" id="5904272">var</span>&nbsp;<span class="ident" id="5904276">errMissingFF00</span>&nbsp;<span class="op" id="5904291">=</span>&nbsp;<span class="ident" id="5904293">FormatError</span><span class="op" id="5904304">(</span><span class="string" id="5904305">&#34;missing&nbsp;0xff00&nbsp;sequence&#34;</span><span class="op" id="5904330">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5904333">//&nbsp;readByteStuffedByte&nbsp;is&nbsp;like&nbsp;readByte&nbsp;but&nbsp;is&nbsp;for&nbsp;byte-stuffed&nbsp;Huffman&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5904411">func</span>&nbsp;<span class="op" id="5904416">(</span><span class="ident" id="5904417">d</span>&nbsp;<span class="op" id="5904419">*</span><span class="ident" id="5904420">decoder</span><span class="op" id="5904427">)</span>&nbsp;<span class="ident" id="5904429">readByteStuffedByte</span><span class="op" id="5904448">(</span><span class="op" id="5904449">)</span>&nbsp;<span class="op" id="5904451">(</span><span class="ident" id="5904452">x</span>&nbsp;<span class="builtintype" id="5904454">byte</span><span class="op" id="5904458">,</span>&nbsp;<span class="ident" id="5904460">err</span>&nbsp;<span class="builtintype" id="5904464">error</span><span class="op" id="5904469">)</span>&nbsp;<span class="op" id="5904471">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5904474">//&nbsp;Take&nbsp;the&nbsp;fast&nbsp;path&nbsp;if&nbsp;d.bytes.buf&nbsp;contains&nbsp;at&nbsp;least&nbsp;two&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904541">if</span>&nbsp;<span class="ident" id="5904544">d</span><span class="op" id="5904545">.</span><span class="ident" id="5904546">bytes</span><span class="op" id="5904551">.</span><span class="ident" id="5904552">i</span><span class="op" id="5904553">+</span><span class="num" id="5904554">2</span>&nbsp;<span class="op" id="5904556">&lt;=</span>&nbsp;<span class="ident" id="5904559">d</span><span class="op" id="5904560">.</span><span class="ident" id="5904561">bytes</span><span class="op" id="5904566">.</span><span class="ident" id="5904567">j</span>&nbsp;<span class="op" id="5904569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5904573">x</span>&nbsp;<span class="op" id="5904575">=</span>&nbsp;<span class="ident" id="5904577">d</span><span class="op" id="5904578">.</span><span class="ident" id="5904579">bytes</span><span class="op" id="5904584">.</span><span class="ident" id="5904585">buf</span><span class="op" id="5904588">[</span><span class="ident" id="5904589">d</span><span class="op" id="5904590">.</span><span class="ident" id="5904591">bytes</span><span class="op" id="5904596">.</span><span class="ident" id="5904597">i</span><span class="op" id="5904598">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5904602">d</span><span class="op" id="5904603">.</span><span class="ident" id="5904604">bytes</span><span class="op" id="5904609">.</span><span class="ident" id="5904610">i</span><span class="op" id="5904611">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5904616">d</span><span class="op" id="5904617">.</span><span class="ident" id="5904618">bytes</span><span class="op" id="5904623">.</span><span class="ident" id="5904624">nUnreadable</span>&nbsp;<span class="op" id="5904636">=</span>&nbsp;<span class="num" id="5904638">1</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904642">if</span>&nbsp;<span class="ident" id="5904645">x</span>&nbsp;<span class="op" id="5904647">!=</span>&nbsp;<span class="num" id="5904650">0xff</span>&nbsp;<span class="op" id="5904655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904660">return</span>&nbsp;<span class="ident" id="5904667">x</span><span class="op" id="5904668">,</span>&nbsp;<span class="ident" id="5904670">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5904676">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904680">if</span>&nbsp;<span class="ident" id="5904683">d</span><span class="op" id="5904684">.</span><span class="ident" id="5904685">bytes</span><span class="op" id="5904690">.</span><span class="ident" id="5904691">buf</span><span class="op" id="5904694">[</span><span class="ident" id="5904695">d</span><span class="op" id="5904696">.</span><span class="ident" id="5904697">bytes</span><span class="op" id="5904702">.</span><span class="ident" id="5904703">i</span><span class="op" id="5904704">]</span>&nbsp;<span class="op" id="5904706">!=</span>&nbsp;<span class="num" id="5904709">0x00</span>&nbsp;<span class="op" id="5904714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904719">return</span>&nbsp;<span class="num" id="5904726">0</span><span class="op" id="5904727">,</span>&nbsp;<span class="ident" id="5904729">errMissingFF00</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5904746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5904750">d</span><span class="op" id="5904751">.</span><span class="ident" id="5904752">bytes</span><span class="op" id="5904757">.</span><span class="ident" id="5904758">i</span><span class="op" id="5904759">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5904764">d</span><span class="op" id="5904765">.</span><span class="ident" id="5904766">bytes</span><span class="op" id="5904771">.</span><span class="ident" id="5904772">nUnreadable</span>&nbsp;<span class="op" id="5904784">=</span>&nbsp;<span class="num" id="5904786">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904790">return</span>&nbsp;<span class="num" id="5904797">0xff</span><span class="op" id="5904801">,</span>&nbsp;<span class="ident" id="5904803">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5904808">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5904812">x</span><span class="op" id="5904813">,</span>&nbsp;<span class="ident" id="5904815">err</span>&nbsp;<span class="op" id="5904819">=</span>&nbsp;<span class="ident" id="5904821">d</span><span class="op" id="5904822">.</span><span class="ident" id="5904823">readByte</span><span class="op" id="5904831">(</span><span class="op" id="5904832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904835">if</span>&nbsp;<span class="ident" id="5904838">err</span>&nbsp;<span class="op" id="5904842">!=</span>&nbsp;<span class="ident" id="5904845">nil</span>&nbsp;<span class="op" id="5904849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904853">return</span>&nbsp;<span class="num" id="5904860">0</span><span class="op" id="5904861">,</span>&nbsp;<span class="ident" id="5904863">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5904868">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904871">if</span>&nbsp;<span class="ident" id="5904874">x</span>&nbsp;<span class="op" id="5904876">!=</span>&nbsp;<span class="num" id="5904879">0xff</span>&nbsp;<span class="op" id="5904884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5904888">d</span><span class="op" id="5904889">.</span><span class="ident" id="5904890">bytes</span><span class="op" id="5904895">.</span><span class="ident" id="5904896">nUnreadable</span>&nbsp;<span class="op" id="5904908">=</span>&nbsp;<span class="num" id="5904910">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904914">return</span>&nbsp;<span class="ident" id="5904921">x</span><span class="op" id="5904922">,</span>&nbsp;<span class="ident" id="5904924">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5904929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5904933">x</span><span class="op" id="5904934">,</span>&nbsp;<span class="ident" id="5904936">err</span>&nbsp;<span class="op" id="5904940">=</span>&nbsp;<span class="ident" id="5904942">d</span><span class="op" id="5904943">.</span><span class="ident" id="5904944">readByte</span><span class="op" id="5904952">(</span><span class="op" id="5904953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904956">if</span>&nbsp;<span class="ident" id="5904959">err</span>&nbsp;<span class="op" id="5904963">!=</span>&nbsp;<span class="ident" id="5904966">nil</span>&nbsp;<span class="op" id="5904970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5904974">d</span><span class="op" id="5904975">.</span><span class="ident" id="5904976">bytes</span><span class="op" id="5904981">.</span><span class="ident" id="5904982">nUnreadable</span>&nbsp;<span class="op" id="5904994">=</span>&nbsp;<span class="num" id="5904996">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905000">return</span>&nbsp;<span class="num" id="5905007">0</span><span class="op" id="5905008">,</span>&nbsp;<span class="ident" id="5905010">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5905015">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905018">d</span><span class="op" id="5905019">.</span><span class="ident" id="5905020">bytes</span><span class="op" id="5905025">.</span><span class="ident" id="5905026">nUnreadable</span>&nbsp;<span class="op" id="5905038">=</span>&nbsp;<span class="num" id="5905040">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905043">if</span>&nbsp;<span class="ident" id="5905046">x</span>&nbsp;<span class="op" id="5905048">!=</span>&nbsp;<span class="num" id="5905051">0x00</span>&nbsp;<span class="op" id="5905056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905060">return</span>&nbsp;<span class="num" id="5905067">0</span><span class="op" id="5905068">,</span>&nbsp;<span class="ident" id="5905070">errMissingFF00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5905086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905089">return</span>&nbsp;<span class="num" id="5905096">0xff</span><span class="op" id="5905100">,</span>&nbsp;<span class="ident" id="5905102">nil</span><br>
<span class="lineno">225</span><span class="op" id="5905106">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5905109">//&nbsp;readFull&nbsp;reads&nbsp;exactly&nbsp;len(p)&nbsp;bytes&nbsp;into&nbsp;p.&nbsp;It&nbsp;does&nbsp;not&nbsp;care&nbsp;about&nbsp;byte</span><br>
<span class="lineno"></span><span class="comment" id="5905184">//&nbsp;stuffing.</span><br>
<span class="lineno"></span><span class="keyword" id="5905197">func</span>&nbsp;<span class="op" id="5905202">(</span><span class="ident" id="5905203">d</span>&nbsp;<span class="op" id="5905205">*</span><span class="ident" id="5905206">decoder</span><span class="op" id="5905213">)</span>&nbsp;<span class="ident" id="5905215">readFull</span><span class="op" id="5905223">(</span><span class="ident" id="5905224">p</span>&nbsp;<span class="op" id="5905226">[</span><span class="op" id="5905227">]</span><span class="builtintype" id="5905228">byte</span><span class="op" id="5905232">)</span>&nbsp;<span class="builtintype" id="5905234">error</span>&nbsp;<span class="op" id="5905240">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5905243">//&nbsp;Unread&nbsp;the&nbsp;overshot&nbsp;bytes,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905282">if</span>&nbsp;<span class="ident" id="5905285">d</span><span class="op" id="5905286">.</span><span class="ident" id="5905287">bytes</span><span class="op" id="5905292">.</span><span class="ident" id="5905293">nUnreadable</span>&nbsp;<span class="op" id="5905305">!=</span>&nbsp;<span class="num" id="5905308">0</span>&nbsp;<span class="op" id="5905310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905314">if</span>&nbsp;<span class="ident" id="5905317">d</span><span class="op" id="5905318">.</span><span class="ident" id="5905319">bits</span><span class="op" id="5905323">.</span><span class="ident" id="5905324">n</span>&nbsp;<span class="op" id="5905326">&gt;=</span>&nbsp;<span class="num" id="5905329">8</span>&nbsp;<span class="op" id="5905331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905336">d</span><span class="op" id="5905337">.</span><span class="ident" id="5905338">unreadByteStuffedByte</span><span class="op" id="5905359">(</span><span class="op" id="5905360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5905364">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905368">d</span><span class="op" id="5905369">.</span><span class="ident" id="5905370">bytes</span><span class="op" id="5905375">.</span><span class="ident" id="5905376">nUnreadable</span>&nbsp;<span class="op" id="5905388">=</span>&nbsp;<span class="num" id="5905390">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5905393">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905397">for</span>&nbsp;<span class="op" id="5905401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905405">n</span>&nbsp;<span class="op" id="5905407">:=</span>&nbsp;<span class="builtinfunc" id="5905410">copy</span><span class="op" id="5905414">(</span><span class="ident" id="5905415">p</span><span class="op" id="5905416">,</span>&nbsp;<span class="ident" id="5905418">d</span><span class="op" id="5905419">.</span><span class="ident" id="5905420">bytes</span><span class="op" id="5905425">.</span><span class="ident" id="5905426">buf</span><span class="op" id="5905429">[</span><span class="ident" id="5905430">d</span><span class="op" id="5905431">.</span><span class="ident" id="5905432">bytes</span><span class="op" id="5905437">.</span><span class="ident" id="5905438">i</span><span class="op" id="5905439">:</span><span class="ident" id="5905440">d</span><span class="op" id="5905441">.</span><span class="ident" id="5905442">bytes</span><span class="op" id="5905447">.</span><span class="ident" id="5905448">j</span><span class="op" id="5905449">]</span><span class="op" id="5905450">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905454">p</span>&nbsp;<span class="op" id="5905456">=</span>&nbsp;<span class="ident" id="5905458">p</span><span class="op" id="5905459">[</span><span class="ident" id="5905460">n</span><span class="op" id="5905461">:</span><span class="op" id="5905462">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905466">d</span><span class="op" id="5905467">.</span><span class="ident" id="5905468">bytes</span><span class="op" id="5905473">.</span><span class="ident" id="5905474">i</span>&nbsp;<span class="op" id="5905476">+=</span>&nbsp;<span class="ident" id="5905479">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905483">if</span>&nbsp;<span class="builtinfunc" id="5905486">len</span><span class="op" id="5905489">(</span><span class="ident" id="5905490">p</span><span class="op" id="5905491">)</span>&nbsp;<span class="op" id="5905493">==</span>&nbsp;<span class="num" id="5905496">0</span>&nbsp;<span class="op" id="5905498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905503">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5905511">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905515">if</span>&nbsp;<span class="ident" id="5905518">err</span>&nbsp;<span class="op" id="5905522">:=</span>&nbsp;<span class="ident" id="5905525">d</span><span class="op" id="5905526">.</span><span class="ident" id="5905527">fill</span><span class="op" id="5905531">(</span><span class="op" id="5905532">)</span><span class="op" id="5905533">;</span>&nbsp;<span class="ident" id="5905535">err</span>&nbsp;<span class="op" id="5905539">!=</span>&nbsp;<span class="ident" id="5905542">nil</span>&nbsp;<span class="op" id="5905546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905551">if</span>&nbsp;<span class="ident" id="5905554">err</span>&nbsp;<span class="op" id="5905558">==</span>&nbsp;<span class="ident" id="5905561">io</span><span class="op" id="5905563">.</span><span class="ident" id="5905564">EOF</span>&nbsp;<span class="op" id="5905568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905574">err</span>&nbsp;<span class="op" id="5905578">=</span>&nbsp;<span class="ident" id="5905580">io</span><span class="op" id="5905582">.</span><span class="ident" id="5905583">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5905603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905608">return</span>&nbsp;<span class="ident" id="5905615">err</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5905621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5905624">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905627">return</span>&nbsp;<span class="ident" id="5905634">nil</span><br>
<span class="lineno"></span><span class="op" id="5905638">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="comment" id="5905641">//&nbsp;ignore&nbsp;ignores&nbsp;the&nbsp;next&nbsp;n&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="5905677">func</span>&nbsp;<span class="op" id="5905682">(</span><span class="ident" id="5905683">d</span>&nbsp;<span class="op" id="5905685">*</span><span class="ident" id="5905686">decoder</span><span class="op" id="5905693">)</span>&nbsp;<span class="ident" id="5905695">ignore</span><span class="op" id="5905701">(</span><span class="ident" id="5905702">n</span>&nbsp;<span class="builtintype" id="5905704">int</span><span class="op" id="5905707">)</span>&nbsp;<span class="builtintype" id="5905709">error</span>&nbsp;<span class="op" id="5905715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5905718">//&nbsp;Unread&nbsp;the&nbsp;overshot&nbsp;bytes,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905757">if</span>&nbsp;<span class="ident" id="5905760">d</span><span class="op" id="5905761">.</span><span class="ident" id="5905762">bytes</span><span class="op" id="5905767">.</span><span class="ident" id="5905768">nUnreadable</span>&nbsp;<span class="op" id="5905780">!=</span>&nbsp;<span class="num" id="5905783">0</span>&nbsp;<span class="op" id="5905785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905789">if</span>&nbsp;<span class="ident" id="5905792">d</span><span class="op" id="5905793">.</span><span class="ident" id="5905794">bits</span><span class="op" id="5905798">.</span><span class="ident" id="5905799">n</span>&nbsp;<span class="op" id="5905801">&gt;=</span>&nbsp;<span class="num" id="5905804">8</span>&nbsp;<span class="op" id="5905806">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905811">d</span><span class="op" id="5905812">.</span><span class="ident" id="5905813">unreadByteStuffedByte</span><span class="op" id="5905834">(</span><span class="op" id="5905835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5905839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905843">d</span><span class="op" id="5905844">.</span><span class="ident" id="5905845">bytes</span><span class="op" id="5905850">.</span><span class="ident" id="5905851">nUnreadable</span>&nbsp;<span class="op" id="5905863">=</span>&nbsp;<span class="num" id="5905865">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5905868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905872">for</span>&nbsp;<span class="op" id="5905876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905880">m</span>&nbsp;<span class="op" id="5905882">:=</span>&nbsp;<span class="ident" id="5905885">d</span><span class="op" id="5905886">.</span><span class="ident" id="5905887">bytes</span><span class="op" id="5905892">.</span><span class="ident" id="5905893">j</span>&nbsp;<span class="op" id="5905895">-</span>&nbsp;<span class="ident" id="5905897">d</span><span class="op" id="5905898">.</span><span class="ident" id="5905899">bytes</span><span class="op" id="5905904">.</span><span class="ident" id="5905905">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905909">if</span>&nbsp;<span class="ident" id="5905912">m</span>&nbsp;<span class="op" id="5905914">&gt;</span>&nbsp;<span class="ident" id="5905916">n</span>&nbsp;<span class="op" id="5905918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905923">m</span>&nbsp;<span class="op" id="5905925">=</span>&nbsp;<span class="ident" id="5905927">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5905931">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905935">d</span><span class="op" id="5905936">.</span><span class="ident" id="5905937">bytes</span><span class="op" id="5905942">.</span><span class="ident" id="5905943">i</span>&nbsp;<span class="op" id="5905945">+=</span>&nbsp;<span class="ident" id="5905948">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905952">n</span>&nbsp;<span class="op" id="5905954">-=</span>&nbsp;<span class="ident" id="5905957">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905961">if</span>&nbsp;<span class="ident" id="5905964">n</span>&nbsp;<span class="op" id="5905966">==</span>&nbsp;<span class="num" id="5905969">0</span>&nbsp;<span class="op" id="5905971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905976">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5905984">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905988">if</span>&nbsp;<span class="ident" id="5905991">err</span>&nbsp;<span class="op" id="5905995">:=</span>&nbsp;<span class="ident" id="5905998">d</span><span class="op" id="5905999">.</span><span class="ident" id="5906000">fill</span><span class="op" id="5906004">(</span><span class="op" id="5906005">)</span><span class="op" id="5906006">;</span>&nbsp;<span class="ident" id="5906008">err</span>&nbsp;<span class="op" id="5906012">!=</span>&nbsp;<span class="ident" id="5906015">nil</span>&nbsp;<span class="op" id="5906019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5906024">if</span>&nbsp;<span class="ident" id="5906027">err</span>&nbsp;<span class="op" id="5906031">==</span>&nbsp;<span class="ident" id="5906034">io</span><span class="op" id="5906036">.</span><span class="ident" id="5906037">EOF</span>&nbsp;<span class="op" id="5906041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5906047">err</span>&nbsp;<span class="op" id="5906051">=</span>&nbsp;<span class="ident" id="5906053">io</span><span class="op" id="5906055">.</span><span class="ident" id="5906056">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5906076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5906081">return</span>&nbsp;<span class="ident" id="5906088">err</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5906094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5906097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5906100">return</span>&nbsp;<span class="ident" id="5906107">nil</span><br>
<span class="lineno"></span><span class="op" id="5906111">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="comment" id="5906114">//&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.2.</span><br>
<span class="lineno"></span><span class="keyword" id="5906145">func</span>&nbsp;<span class="op" id="5906150">(</span><span class="ident" id="5906151">d</span>&nbsp;<span class="op" id="5906153">*</span><span class="ident" id="5906154">decoder</span><span class="op" id="5906161">)</span>&nbsp;<span class="ident" id="5906163">processSOF</span><span class="op" id="5906173">(</span><span class="ident" id="5906174">n</span>&nbsp;<span class="builtintype" id="5906176">int</span><span class="op" id="5906179">)</span>&nbsp;<span class="builtintype" id="5906181">error</span>&nbsp;<span class="op" id="5906187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5906190">switch</span>&nbsp;<span class="ident" id="5906197">n</span>&nbsp;<span class="op" id="5906199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5906202">case</span>&nbsp;<span class="num" id="5906207">6</span>&nbsp;<span class="op" id="5906209">+</span>&nbsp;<span class="num" id="5906211">3</span><span class="op" id="5906212">*</span><span class="ident" id="5906213">nGrayComponent</span><span class="op" id="5906227">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5906231">d</span><span class="op" id="5906232">.</span><span class="ident" id="5906233">nComp</span>&nbsp;<span class="op" id="5906239">=</span>&nbsp;<span class="ident" id="5906241">nGrayComponent</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5906257">case</span>&nbsp;<span class="num" id="5906262">6</span>&nbsp;<span class="op" id="5906264">+</span>&nbsp;<span class="num" id="5906266">3</span><span class="op" id="5906267">*</span><span class="ident" id="5906268">nColorComponent</span><span class="op" id="5906283">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5906287">d</span><span class="op" id="5906288">.</span><span class="ident" id="5906289">nComp</span>&nbsp;<span class="op" id="5906295">=</span>&nbsp;<span class="ident" id="5906297">nColorComponent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5906314">default</span><span class="op" id="5906321">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5906325">return</span>&nbsp;<span class="ident" id="5906332">UnsupportedError</span><span class="op" id="5906348">(</span><span class="string" id="5906349">&#34;SOF&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="5906371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5906374">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5906377">if</span>&nbsp;<span class="ident" id="5906380">err</span>&nbsp;<span class="op" id="5906384">:=</span>&nbsp;<span class="ident" id="5906387">d</span><span class="op" id="5906388">.</span><span class="ident" id="5906389">readFull</span><span class="op" id="5906397">(</span><span class="ident" id="5906398">d</span><span class="op" id="5906399">.</span><span class="ident" id="5906400">tmp</span><span class="op" id="5906403">[</span><span class="op" id="5906404">:</span><span class="ident" id="5906405">n</span><span class="op" id="5906406">]</span><span class="op" id="5906407">)</span><span class="op" id="5906408">;</span>&nbsp;<span class="ident" id="5906410">err</span>&nbsp;<span class="op" id="5906414">!=</span>&nbsp;<span class="ident" id="5906417">nil</span>&nbsp;<span class="op" id="5906421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5906425">return</span>&nbsp;<span class="ident" id="5906432">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5906437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5906440">//&nbsp;We&nbsp;only&nbsp;support&nbsp;8-bit&nbsp;precision.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5906477">if</span>&nbsp;<span class="ident" id="5906480">d</span><span class="op" id="5906481">.</span><span class="ident" id="5906482">tmp</span><span class="op" id="5906485">[</span><span class="num" id="5906486">0</span><span class="op" id="5906487">]</span>&nbsp;<span class="op" id="5906489">!=</span>&nbsp;<span class="num" id="5906492">8</span>&nbsp;<span class="op" id="5906494">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5906498">return</span>&nbsp;<span class="ident" id="5906505">UnsupportedError</span><span class="op" id="5906521">(</span><span class="string" id="5906522">&#34;precision&#34;</span><span class="op" id="5906533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5906536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5906539">d</span><span class="op" id="5906540">.</span><span class="ident" id="5906541">height</span>&nbsp;<span class="op" id="5906548">=</span>&nbsp;<span class="builtintype" id="5906550">int</span><span class="op" id="5906553">(</span><span class="ident" id="5906554">d</span><span class="op" id="5906555">.</span><span class="ident" id="5906556">tmp</span><span class="op" id="5906559">[</span><span class="num" id="5906560">1</span><span class="op" id="5906561">]</span><span class="op" id="5906562">)</span><span class="op" id="5906563">&lt;&lt;</span><span class="num" id="5906565">8</span>&nbsp;<span class="op" id="5906567">+</span>&nbsp;<span class="builtintype" id="5906569">int</span><span class="op" id="5906572">(</span><span class="ident" id="5906573">d</span><span class="op" id="5906574">.</span><span class="ident" id="5906575">tmp</span><span class="op" id="5906578">[</span><span class="num" id="5906579">2</span><span class="op" id="5906580">]</span><span class="op" id="5906581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5906584">d</span><span class="op" id="5906585">.</span><span class="ident" id="5906586">width</span>&nbsp;<span class="op" id="5906592">=</span>&nbsp;<span class="builtintype" id="5906594">int</span><span class="op" id="5906597">(</span><span class="ident" id="5906598">d</span><span class="op" id="5906599">.</span><span class="ident" id="5906600">tmp</span><span class="op" id="5906603">[</span><span class="num" id="5906604">3</span><span class="op" id="5906605">]</span><span class="op" id="5906606">)</span><span class="op" id="5906607">&lt;&lt;</span><span class="num" id="5906609">8</span>&nbsp;<span class="op" id="5906611">+</span>&nbsp;<span class="builtintype" id="5906613">int</span><span class="op" id="5906616">(</span><span class="ident" id="5906617">d</span><span class="op" id="5906618">.</span><span class="ident" id="5906619">tmp</span><span class="op" id="5906622">[</span><span class="num" id="5906623">4</span><span class="op" id="5906624">]</span><span class="op" id="5906625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5906628">if</span>&nbsp;<span class="builtintype" id="5906631">int</span><span class="op" id="5906634">(</span><span class="ident" id="5906635">d</span><span class="op" id="5906636">.</span><span class="ident" id="5906637">tmp</span><span class="op" id="5906640">[</span><span class="num" id="5906641">5</span><span class="op" id="5906642">]</span><span class="op" id="5906643">)</span>&nbsp;<span class="op" id="5906645">!=</span>&nbsp;<span class="ident" id="5906648">d</span><span class="op" id="5906649">.</span><span class="ident" id="5906650">nComp</span>&nbsp;<span class="op" id="5906656">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5906660">return</span>&nbsp;<span class="ident" id="5906667">UnsupportedError</span><span class="op" id="5906683">(</span><span class="string" id="5906684">&#34;SOF&nbsp;has&nbsp;wrong&nbsp;number&nbsp;of&nbsp;image&nbsp;components&#34;</span><span class="op" id="5906726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5906729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5906732">for</span>&nbsp;<span class="ident" id="5906736">i</span>&nbsp;<span class="op" id="5906738">:=</span>&nbsp;<span class="num" id="5906741">0</span><span class="op" id="5906742">;</span>&nbsp;<span class="ident" id="5906744">i</span>&nbsp;<span class="op" id="5906746">&lt;</span>&nbsp;<span class="ident" id="5906748">d</span><span class="op" id="5906749">.</span><span class="ident" id="5906750">nComp</span><span class="op" id="5906755">;</span>&nbsp;<span class="ident" id="5906757">i</span><span class="op" id="5906758">++</span>&nbsp;<span class="op" id="5906761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5906765">d</span><span class="op" id="5906766">.</span><span class="ident" id="5906767">comp</span><span class="op" id="5906771">[</span><span class="ident" id="5906772">i</span><span class="op" id="5906773">]</span><span class="op" id="5906774">.</span><span class="ident" id="5906775">c</span>&nbsp;<span class="op" id="5906777">=</span>&nbsp;<span class="ident" id="5906779">d</span><span class="op" id="5906780">.</span><span class="ident" id="5906781">tmp</span><span class="op" id="5906784">[</span><span class="num" id="5906785">6</span><span class="op" id="5906786">+</span><span class="num" id="5906787">3</span><span class="op" id="5906788">*</span><span class="ident" id="5906789">i</span><span class="op" id="5906790">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5906794">d</span><span class="op" id="5906795">.</span><span class="ident" id="5906796">comp</span><span class="op" id="5906800">[</span><span class="ident" id="5906801">i</span><span class="op" id="5906802">]</span><span class="op" id="5906803">.</span><span class="ident" id="5906804">tq</span>&nbsp;<span class="op" id="5906807">=</span>&nbsp;<span class="ident" id="5906809">d</span><span class="op" id="5906810">.</span><span class="ident" id="5906811">tmp</span><span class="op" id="5906814">[</span><span class="num" id="5906815">8</span><span class="op" id="5906816">+</span><span class="num" id="5906817">3</span><span class="op" id="5906818">*</span><span class="ident" id="5906819">i</span><span class="op" id="5906820">]</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5906824">if</span>&nbsp;<span class="ident" id="5906827">d</span><span class="op" id="5906828">.</span><span class="ident" id="5906829">nComp</span>&nbsp;<span class="op" id="5906835">==</span>&nbsp;<span class="ident" id="5906838">nGrayComponent</span>&nbsp;<span class="op" id="5906853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5906858">//&nbsp;If&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;has&nbsp;only&nbsp;one&nbsp;component,&nbsp;section&nbsp;A.2&nbsp;says&nbsp;&#34;this&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5906932">//&nbsp;is&nbsp;non-interleaved&nbsp;by&nbsp;definition&#34;&nbsp;and&nbsp;section&nbsp;A.2.2&nbsp;says&nbsp;&#34;[in&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5907005">//&nbsp;case...]&nbsp;the&nbsp;order&nbsp;of&nbsp;data&nbsp;units&nbsp;within&nbsp;a&nbsp;scan&nbsp;shall&nbsp;be&nbsp;left-to-right</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5907081">//&nbsp;and&nbsp;top-to-bottom...&nbsp;regardless&nbsp;of&nbsp;the&nbsp;values&nbsp;of&nbsp;H_1&nbsp;and&nbsp;V_1&#34;.&nbsp;Section</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5907158">//&nbsp;4.8.2&nbsp;also&nbsp;says&nbsp;&#34;[for&nbsp;non-interleaved&nbsp;data],&nbsp;the&nbsp;MCU&nbsp;is&nbsp;defined&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5907234">//&nbsp;one&nbsp;data&nbsp;unit&#34;.&nbsp;Similarly,&nbsp;section&nbsp;A.1.1&nbsp;explains&nbsp;that&nbsp;it&nbsp;is&nbsp;the&nbsp;ratio</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5907311">//&nbsp;of&nbsp;H_i&nbsp;to&nbsp;max_j(H_j)&nbsp;that&nbsp;matters,&nbsp;and&nbsp;similarly&nbsp;for&nbsp;V.&nbsp;For&nbsp;grayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5907387">//&nbsp;images,&nbsp;H_1&nbsp;is&nbsp;the&nbsp;maximum&nbsp;H_j&nbsp;for&nbsp;all&nbsp;components&nbsp;j,&nbsp;so&nbsp;that&nbsp;ratio&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5907463">//&nbsp;always&nbsp;1.&nbsp;The&nbsp;component&#39;s&nbsp;(h,&nbsp;v)&nbsp;is&nbsp;effectively&nbsp;always&nbsp;(1,&nbsp;1):&nbsp;even&nbsp;if</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5907540">//&nbsp;the&nbsp;nominal&nbsp;(h,&nbsp;v)&nbsp;is&nbsp;(2,&nbsp;1),&nbsp;a&nbsp;20x5&nbsp;image&nbsp;is&nbsp;encoded&nbsp;in&nbsp;three&nbsp;8x8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5907613">//&nbsp;MCUs,&nbsp;not&nbsp;two&nbsp;16x8&nbsp;MCUs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5907644">d</span><span class="op" id="5907645">.</span><span class="ident" id="5907646">comp</span><span class="op" id="5907650">[</span><span class="ident" id="5907651">i</span><span class="op" id="5907652">]</span><span class="op" id="5907653">.</span><span class="ident" id="5907654">h</span>&nbsp;<span class="op" id="5907656">=</span>&nbsp;<span class="num" id="5907658">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5907663">d</span><span class="op" id="5907664">.</span><span class="ident" id="5907665">comp</span><span class="op" id="5907669">[</span><span class="ident" id="5907670">i</span><span class="op" id="5907671">]</span><span class="op" id="5907672">.</span><span class="ident" id="5907673">v</span>&nbsp;<span class="op" id="5907675">=</span>&nbsp;<span class="num" id="5907677">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5907682">continue</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5907693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5907697">hv</span>&nbsp;<span class="op" id="5907700">:=</span>&nbsp;<span class="ident" id="5907703">d</span><span class="op" id="5907704">.</span><span class="ident" id="5907705">tmp</span><span class="op" id="5907708">[</span><span class="num" id="5907709">7</span><span class="op" id="5907710">+</span><span class="num" id="5907711">3</span><span class="op" id="5907712">*</span><span class="ident" id="5907713">i</span><span class="op" id="5907714">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5907718">d</span><span class="op" id="5907719">.</span><span class="ident" id="5907720">comp</span><span class="op" id="5907724">[</span><span class="ident" id="5907725">i</span><span class="op" id="5907726">]</span><span class="op" id="5907727">.</span><span class="ident" id="5907728">h</span>&nbsp;<span class="op" id="5907730">=</span>&nbsp;<span class="builtintype" id="5907732">int</span><span class="op" id="5907735">(</span><span class="ident" id="5907736">hv</span>&nbsp;<span class="op" id="5907739">&gt;&gt;</span>&nbsp;<span class="num" id="5907742">4</span><span class="op" id="5907743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5907747">d</span><span class="op" id="5907748">.</span><span class="ident" id="5907749">comp</span><span class="op" id="5907753">[</span><span class="ident" id="5907754">i</span><span class="op" id="5907755">]</span><span class="op" id="5907756">.</span><span class="ident" id="5907757">v</span>&nbsp;<span class="op" id="5907759">=</span>&nbsp;<span class="builtintype" id="5907761">int</span><span class="op" id="5907764">(</span><span class="ident" id="5907765">hv</span>&nbsp;<span class="op" id="5907768">&amp;</span>&nbsp;<span class="num" id="5907770">0x0f</span><span class="op" id="5907774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5907778">//&nbsp;For&nbsp;color&nbsp;images,&nbsp;we&nbsp;only&nbsp;support&nbsp;4:4:4,&nbsp;4:4:0,&nbsp;4:2:2&nbsp;or&nbsp;4:2:0&nbsp;chroma</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5907853">//&nbsp;downsampling&nbsp;ratios.&nbsp;This&nbsp;implies&nbsp;that&nbsp;the&nbsp;(h,&nbsp;v)&nbsp;values&nbsp;for&nbsp;the&nbsp;Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5907925">//&nbsp;component&nbsp;are&nbsp;either&nbsp;(1,&nbsp;1),&nbsp;(1,&nbsp;2),&nbsp;(2,&nbsp;1)&nbsp;or&nbsp;(2,&nbsp;2),&nbsp;and&nbsp;the&nbsp;(h,&nbsp;v)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5908000">//&nbsp;values&nbsp;for&nbsp;the&nbsp;Cr&nbsp;and&nbsp;Cb&nbsp;components&nbsp;must&nbsp;be&nbsp;(1,&nbsp;1).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5908057">if</span>&nbsp;<span class="ident" id="5908060">i</span>&nbsp;<span class="op" id="5908062">==</span>&nbsp;<span class="num" id="5908065">0</span>&nbsp;<span class="op" id="5908067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5908072">if</span>&nbsp;<span class="ident" id="5908075">hv</span>&nbsp;<span class="op" id="5908078">!=</span>&nbsp;<span class="num" id="5908081">0x11</span>&nbsp;<span class="op" id="5908086">&amp;&amp;</span>&nbsp;<span class="ident" id="5908089">hv</span>&nbsp;<span class="op" id="5908092">!=</span>&nbsp;<span class="num" id="5908095">0x21</span>&nbsp;<span class="op" id="5908100">&amp;&amp;</span>&nbsp;<span class="ident" id="5908103">hv</span>&nbsp;<span class="op" id="5908106">!=</span>&nbsp;<span class="num" id="5908109">0x22</span>&nbsp;<span class="op" id="5908114">&amp;&amp;</span>&nbsp;<span class="ident" id="5908117">hv</span>&nbsp;<span class="op" id="5908120">!=</span>&nbsp;<span class="num" id="5908123">0x12</span>&nbsp;<span class="op" id="5908128">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5908134">return</span>&nbsp;<span class="ident" id="5908141">UnsupportedError</span><span class="op" id="5908157">(</span><span class="string" id="5908158">&#34;luma/chroma&nbsp;downsample&nbsp;ratio&#34;</span><span class="op" id="5908188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5908193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5908197">}</span>&nbsp;<span class="keyword" id="5908199">else</span>&nbsp;<span class="keyword" id="5908204">if</span>&nbsp;<span class="ident" id="5908207">hv</span>&nbsp;<span class="op" id="5908210">!=</span>&nbsp;<span class="num" id="5908213">0x11</span>&nbsp;<span class="op" id="5908218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5908223">return</span>&nbsp;<span class="ident" id="5908230">UnsupportedError</span><span class="op" id="5908246">(</span><span class="string" id="5908247">&#34;luma/chroma&nbsp;downsample&nbsp;ratio&#34;</span><span class="op" id="5908277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5908281">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5908284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5908287">return</span>&nbsp;<span class="ident" id="5908294">nil</span><br>
<span class="lineno"></span><span class="op" id="5908298">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5908301">//&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.4.1.</span><br>
<span class="lineno">345</span><span class="keyword" id="5908334">func</span>&nbsp;<span class="op" id="5908339">(</span><span class="ident" id="5908340">d</span>&nbsp;<span class="op" id="5908342">*</span><span class="ident" id="5908343">decoder</span><span class="op" id="5908350">)</span>&nbsp;<span class="ident" id="5908352">processDQT</span><span class="op" id="5908362">(</span><span class="ident" id="5908363">n</span>&nbsp;<span class="builtintype" id="5908365">int</span><span class="op" id="5908368">)</span>&nbsp;<span class="builtintype" id="5908370">error</span>&nbsp;<span class="op" id="5908376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5908379">const</span>&nbsp;<span class="ident" id="5908385">qtLength</span>&nbsp;<span class="op" id="5908394">=</span>&nbsp;<span class="num" id="5908396">1</span>&nbsp;<span class="op" id="5908398">+</span>&nbsp;<span class="ident" id="5908400">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5908411">for</span>&nbsp;<span class="op" id="5908415">;</span>&nbsp;<span class="ident" id="5908417">n</span>&nbsp;<span class="op" id="5908419">&gt;=</span>&nbsp;<span class="ident" id="5908422">qtLength</span><span class="op" id="5908430">;</span>&nbsp;<span class="ident" id="5908432">n</span>&nbsp;<span class="op" id="5908434">-=</span>&nbsp;<span class="ident" id="5908437">qtLength</span>&nbsp;<span class="op" id="5908446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5908450">if</span>&nbsp;<span class="ident" id="5908453">err</span>&nbsp;<span class="op" id="5908457">:=</span>&nbsp;<span class="ident" id="5908460">d</span><span class="op" id="5908461">.</span><span class="ident" id="5908462">readFull</span><span class="op" id="5908470">(</span><span class="ident" id="5908471">d</span><span class="op" id="5908472">.</span><span class="ident" id="5908473">tmp</span><span class="op" id="5908476">[</span><span class="op" id="5908477">:</span><span class="ident" id="5908478">qtLength</span><span class="op" id="5908486">]</span><span class="op" id="5908487">)</span><span class="op" id="5908488">;</span>&nbsp;<span class="ident" id="5908490">err</span>&nbsp;<span class="op" id="5908494">!=</span>&nbsp;<span class="ident" id="5908497">nil</span>&nbsp;<span class="op" id="5908501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5908506">return</span>&nbsp;<span class="ident" id="5908513">err</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5908519">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5908523">pq</span>&nbsp;<span class="op" id="5908526">:=</span>&nbsp;<span class="ident" id="5908529">d</span><span class="op" id="5908530">.</span><span class="ident" id="5908531">tmp</span><span class="op" id="5908534">[</span><span class="num" id="5908535">0</span><span class="op" id="5908536">]</span>&nbsp;<span class="op" id="5908538">&gt;&gt;</span>&nbsp;<span class="num" id="5908541">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5908545">if</span>&nbsp;<span class="ident" id="5908548">pq</span>&nbsp;<span class="op" id="5908551">!=</span>&nbsp;<span class="num" id="5908554">0</span>&nbsp;<span class="op" id="5908556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5908561">return</span>&nbsp;<span class="ident" id="5908568">UnsupportedError</span><span class="op" id="5908584">(</span><span class="string" id="5908585">&#34;bad&nbsp;Pq&nbsp;value&#34;</span><span class="op" id="5908599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5908603">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5908607">tq</span>&nbsp;<span class="op" id="5908610">:=</span>&nbsp;<span class="ident" id="5908613">d</span><span class="op" id="5908614">.</span><span class="ident" id="5908615">tmp</span><span class="op" id="5908618">[</span><span class="num" id="5908619">0</span><span class="op" id="5908620">]</span>&nbsp;<span class="op" id="5908622">&amp;</span>&nbsp;<span class="num" id="5908624">0x0f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5908631">if</span>&nbsp;<span class="ident" id="5908634">tq</span>&nbsp;<span class="op" id="5908637">&gt;</span>&nbsp;<span class="ident" id="5908639">maxTq</span>&nbsp;<span class="op" id="5908645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5908650">return</span>&nbsp;<span class="ident" id="5908657">FormatError</span><span class="op" id="5908668">(</span><span class="string" id="5908669">&#34;bad&nbsp;Tq&nbsp;value&#34;</span><span class="op" id="5908683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5908687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5908691">for</span>&nbsp;<span class="ident" id="5908695">i</span>&nbsp;<span class="op" id="5908697">:=</span>&nbsp;<span class="keyword" id="5908700">range</span>&nbsp;<span class="ident" id="5908706">d</span><span class="op" id="5908707">.</span><span class="ident" id="5908708">quant</span><span class="op" id="5908713">[</span><span class="ident" id="5908714">tq</span><span class="op" id="5908716">]</span>&nbsp;<span class="op" id="5908718">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5908723">d</span><span class="op" id="5908724">.</span><span class="ident" id="5908725">quant</span><span class="op" id="5908730">[</span><span class="ident" id="5908731">tq</span><span class="op" id="5908733">]</span><span class="op" id="5908734">[</span><span class="ident" id="5908735">i</span><span class="op" id="5908736">]</span>&nbsp;<span class="op" id="5908738">=</span>&nbsp;<span class="builtintype" id="5908740">int32</span><span class="op" id="5908745">(</span><span class="ident" id="5908746">d</span><span class="op" id="5908747">.</span><span class="ident" id="5908748">tmp</span><span class="op" id="5908751">[</span><span class="ident" id="5908752">i</span><span class="op" id="5908753">+</span><span class="num" id="5908754">1</span><span class="op" id="5908755">]</span><span class="op" id="5908756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5908760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5908763">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5908766">if</span>&nbsp;<span class="ident" id="5908769">n</span>&nbsp;<span class="op" id="5908771">!=</span>&nbsp;<span class="num" id="5908774">0</span>&nbsp;<span class="op" id="5908776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5908780">return</span>&nbsp;<span class="ident" id="5908787">FormatError</span><span class="op" id="5908798">(</span><span class="string" id="5908799">&#34;DQT&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="5908821">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5908824">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5908827">return</span>&nbsp;<span class="ident" id="5908834">nil</span><br>
<span class="lineno"></span><span class="op" id="5908838">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5908841">//&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.4.4.</span><br>
<span class="lineno">370</span><span class="keyword" id="5908874">func</span>&nbsp;<span class="op" id="5908879">(</span><span class="ident" id="5908880">d</span>&nbsp;<span class="op" id="5908882">*</span><span class="ident" id="5908883">decoder</span><span class="op" id="5908890">)</span>&nbsp;<span class="ident" id="5908892">processDRI</span><span class="op" id="5908902">(</span><span class="ident" id="5908903">n</span>&nbsp;<span class="builtintype" id="5908905">int</span><span class="op" id="5908908">)</span>&nbsp;<span class="builtintype" id="5908910">error</span>&nbsp;<span class="op" id="5908916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5908919">if</span>&nbsp;<span class="ident" id="5908922">n</span>&nbsp;<span class="op" id="5908924">!=</span>&nbsp;<span class="num" id="5908927">2</span>&nbsp;<span class="op" id="5908929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5908933">return</span>&nbsp;<span class="ident" id="5908940">FormatError</span><span class="op" id="5908951">(</span><span class="string" id="5908952">&#34;DRI&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="5908974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5908977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5908980">if</span>&nbsp;<span class="ident" id="5908983">err</span>&nbsp;<span class="op" id="5908987">:=</span>&nbsp;<span class="ident" id="5908990">d</span><span class="op" id="5908991">.</span><span class="ident" id="5908992">readFull</span><span class="op" id="5909000">(</span><span class="ident" id="5909001">d</span><span class="op" id="5909002">.</span><span class="ident" id="5909003">tmp</span><span class="op" id="5909006">[</span><span class="op" id="5909007">:</span><span class="num" id="5909008">2</span><span class="op" id="5909009">]</span><span class="op" id="5909010">)</span><span class="op" id="5909011">;</span>&nbsp;<span class="ident" id="5909013">err</span>&nbsp;<span class="op" id="5909017">!=</span>&nbsp;<span class="ident" id="5909020">nil</span>&nbsp;<span class="op" id="5909024">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5909028">return</span>&nbsp;<span class="ident" id="5909035">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5909040">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5909043">d</span><span class="op" id="5909044">.</span><span class="ident" id="5909045">ri</span>&nbsp;<span class="op" id="5909048">=</span>&nbsp;<span class="builtintype" id="5909050">int</span><span class="op" id="5909053">(</span><span class="ident" id="5909054">d</span><span class="op" id="5909055">.</span><span class="ident" id="5909056">tmp</span><span class="op" id="5909059">[</span><span class="num" id="5909060">0</span><span class="op" id="5909061">]</span><span class="op" id="5909062">)</span><span class="op" id="5909063">&lt;&lt;</span><span class="num" id="5909065">8</span>&nbsp;<span class="op" id="5909067">+</span>&nbsp;<span class="builtintype" id="5909069">int</span><span class="op" id="5909072">(</span><span class="ident" id="5909073">d</span><span class="op" id="5909074">.</span><span class="ident" id="5909075">tmp</span><span class="op" id="5909078">[</span><span class="num" id="5909079">1</span><span class="op" id="5909080">]</span><span class="op" id="5909081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5909084">return</span>&nbsp;<span class="ident" id="5909091">nil</span><br>
<span class="lineno"></span><span class="op" id="5909095">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span><span class="comment" id="5909098">//&nbsp;decode&nbsp;reads&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;from&nbsp;r&nbsp;and&nbsp;returns&nbsp;it&nbsp;as&nbsp;an&nbsp;image.Image.</span><br>
<span class="lineno"></span><span class="keyword" id="5909168">func</span>&nbsp;<span class="op" id="5909173">(</span><span class="ident" id="5909174">d</span>&nbsp;<span class="op" id="5909176">*</span><span class="ident" id="5909177">decoder</span><span class="op" id="5909184">)</span>&nbsp;<span class="ident" id="5909186">decode</span><span class="op" id="5909192">(</span><span class="ident" id="5909193">r</span>&nbsp;<span class="ident" id="5909195">io</span><span class="op" id="5909197">.</span><span class="ident" id="5909198">Reader</span><span class="op" id="5909204">,</span>&nbsp;<span class="ident" id="5909206">configOnly</span>&nbsp;<span class="builtintype" id="5909217">bool</span><span class="op" id="5909221">)</span>&nbsp;<span class="op" id="5909223">(</span><span class="ident" id="5909224">image</span><span class="op" id="5909229">.</span><span class="ident" id="5909230">Image</span><span class="op" id="5909235">,</span>&nbsp;<span class="builtintype" id="5909237">error</span><span class="op" id="5909242">)</span>&nbsp;<span class="op" id="5909244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5909247">d</span><span class="op" id="5909248">.</span><span class="ident" id="5909249">r</span>&nbsp;<span class="op" id="5909251">=</span>&nbsp;<span class="ident" id="5909253">r</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5909257">//&nbsp;Check&nbsp;for&nbsp;the&nbsp;Start&nbsp;Of&nbsp;Image&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5909298">if</span>&nbsp;<span class="ident" id="5909301">err</span>&nbsp;<span class="op" id="5909305">:=</span>&nbsp;<span class="ident" id="5909308">d</span><span class="op" id="5909309">.</span><span class="ident" id="5909310">readFull</span><span class="op" id="5909318">(</span><span class="ident" id="5909319">d</span><span class="op" id="5909320">.</span><span class="ident" id="5909321">tmp</span><span class="op" id="5909324">[</span><span class="op" id="5909325">:</span><span class="num" id="5909326">2</span><span class="op" id="5909327">]</span><span class="op" id="5909328">)</span><span class="op" id="5909329">;</span>&nbsp;<span class="ident" id="5909331">err</span>&nbsp;<span class="op" id="5909335">!=</span>&nbsp;<span class="ident" id="5909338">nil</span>&nbsp;<span class="op" id="5909342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5909346">return</span>&nbsp;<span class="ident" id="5909353">nil</span><span class="op" id="5909356">,</span>&nbsp;<span class="ident" id="5909358">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5909363">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5909366">if</span>&nbsp;<span class="ident" id="5909369">d</span><span class="op" id="5909370">.</span><span class="ident" id="5909371">tmp</span><span class="op" id="5909374">[</span><span class="num" id="5909375">0</span><span class="op" id="5909376">]</span>&nbsp;<span class="op" id="5909378">!=</span>&nbsp;<span class="num" id="5909381">0xff</span>&nbsp;<span class="op" id="5909386">||</span>&nbsp;<span class="ident" id="5909389">d</span><span class="op" id="5909390">.</span><span class="ident" id="5909391">tmp</span><span class="op" id="5909394">[</span><span class="num" id="5909395">1</span><span class="op" id="5909396">]</span>&nbsp;<span class="op" id="5909398">!=</span>&nbsp;<span class="ident" id="5909401">soiMarker</span>&nbsp;<span class="op" id="5909411">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5909415">return</span>&nbsp;<span class="ident" id="5909422">nil</span><span class="op" id="5909425">,</span>&nbsp;<span class="ident" id="5909427">FormatError</span><span class="op" id="5909438">(</span><span class="string" id="5909439">&#34;missing&nbsp;SOI&nbsp;marker&#34;</span><span class="op" id="5909459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5909462">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5909466">//&nbsp;Process&nbsp;the&nbsp;remaining&nbsp;segments&nbsp;until&nbsp;the&nbsp;End&nbsp;Of&nbsp;Image&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5909532">for</span>&nbsp;<span class="op" id="5909536">{</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5909540">err</span>&nbsp;<span class="op" id="5909544">:=</span>&nbsp;<span class="ident" id="5909547">d</span><span class="op" id="5909548">.</span><span class="ident" id="5909549">readFull</span><span class="op" id="5909557">(</span><span class="ident" id="5909558">d</span><span class="op" id="5909559">.</span><span class="ident" id="5909560">tmp</span><span class="op" id="5909563">[</span><span class="op" id="5909564">:</span><span class="num" id="5909565">2</span><span class="op" id="5909566">]</span><span class="op" id="5909567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5909571">if</span>&nbsp;<span class="ident" id="5909574">err</span>&nbsp;<span class="op" id="5909578">!=</span>&nbsp;<span class="ident" id="5909581">nil</span>&nbsp;<span class="op" id="5909585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5909590">return</span>&nbsp;<span class="ident" id="5909597">nil</span><span class="op" id="5909600">,</span>&nbsp;<span class="ident" id="5909602">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5909608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5909612">for</span>&nbsp;<span class="ident" id="5909616">d</span><span class="op" id="5909617">.</span><span class="ident" id="5909618">tmp</span><span class="op" id="5909621">[</span><span class="num" id="5909622">0</span><span class="op" id="5909623">]</span>&nbsp;<span class="op" id="5909625">!=</span>&nbsp;<span class="num" id="5909628">0xff</span>&nbsp;<span class="op" id="5909633">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5909638">//&nbsp;Strictly&nbsp;speaking,&nbsp;this&nbsp;is&nbsp;a&nbsp;format&nbsp;error.&nbsp;However,&nbsp;libjpeg&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5909707">//&nbsp;liberal&nbsp;in&nbsp;what&nbsp;it&nbsp;accepts.&nbsp;As&nbsp;of&nbsp;version&nbsp;9,&nbsp;next_marker&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5909773">//&nbsp;jdmarker.c&nbsp;treats&nbsp;this&nbsp;as&nbsp;a&nbsp;warning&nbsp;(JWRN_EXTRANEOUS_DATA)&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5909842">//&nbsp;continues&nbsp;to&nbsp;decode&nbsp;the&nbsp;stream.&nbsp;Even&nbsp;before&nbsp;next_marker&nbsp;sees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5909909">//&nbsp;extraneous&nbsp;data,&nbsp;jpeg_fill_bit_buffer&nbsp;in&nbsp;jdhuff.c&nbsp;reads&nbsp;as&nbsp;many</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5909979">//&nbsp;bytes&nbsp;as&nbsp;it&nbsp;can,&nbsp;possibly&nbsp;past&nbsp;the&nbsp;end&nbsp;of&nbsp;a&nbsp;scan&#39;s&nbsp;data.&nbsp;It</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5910045">//&nbsp;effectively&nbsp;puts&nbsp;back&nbsp;any&nbsp;markers&nbsp;that&nbsp;it&nbsp;overscanned&nbsp;(e.g.&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5910114">//&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker),&nbsp;but&nbsp;it&nbsp;does&nbsp;not&nbsp;put&nbsp;back&nbsp;non-marker&nbsp;data,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5910186">//&nbsp;and&nbsp;thus&nbsp;it&nbsp;can&nbsp;silently&nbsp;ignore&nbsp;a&nbsp;small&nbsp;number&nbsp;of&nbsp;extraneous</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5910253">//&nbsp;non-marker&nbsp;bytes&nbsp;before&nbsp;next_marker&nbsp;has&nbsp;a&nbsp;chance&nbsp;to&nbsp;see&nbsp;them&nbsp;(and</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5910325">//&nbsp;print&nbsp;a&nbsp;warning).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5910349">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5910355">//&nbsp;We&nbsp;are&nbsp;therefore&nbsp;also&nbsp;liberal&nbsp;in&nbsp;what&nbsp;we&nbsp;accept.&nbsp;Extraneous&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5910426">//&nbsp;is&nbsp;silently&nbsp;ignored.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5910453">//</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5910459">//&nbsp;This&nbsp;is&nbsp;similar&nbsp;to,&nbsp;but&nbsp;not&nbsp;exactly&nbsp;the&nbsp;same&nbsp;as,&nbsp;the&nbsp;restart</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5910526">//&nbsp;mechanism&nbsp;within&nbsp;a&nbsp;scan&nbsp;(the&nbsp;RST[0-7]&nbsp;markers).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5910580">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5910586">//&nbsp;Note&nbsp;that&nbsp;extraneous&nbsp;0xff&nbsp;bytes&nbsp;in&nbsp;e.g.&nbsp;SOS&nbsp;data&nbsp;are&nbsp;escaped&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5910656">//&nbsp;&#34;\xff\x00&#34;,&nbsp;and&nbsp;so&nbsp;are&nbsp;detected&nbsp;a&nbsp;little&nbsp;further&nbsp;down&nbsp;below.</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5910723">d</span><span class="op" id="5910724">.</span><span class="ident" id="5910725">tmp</span><span class="op" id="5910728">[</span><span class="num" id="5910729">0</span><span class="op" id="5910730">]</span>&nbsp;<span class="op" id="5910732">=</span>&nbsp;<span class="ident" id="5910734">d</span><span class="op" id="5910735">.</span><span class="ident" id="5910736">tmp</span><span class="op" id="5910739">[</span><span class="num" id="5910740">1</span><span class="op" id="5910741">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5910746">d</span><span class="op" id="5910747">.</span><span class="ident" id="5910748">tmp</span><span class="op" id="5910751">[</span><span class="num" id="5910752">1</span><span class="op" id="5910753">]</span><span class="op" id="5910754">,</span>&nbsp;<span class="ident" id="5910756">err</span>&nbsp;<span class="op" id="5910760">=</span>&nbsp;<span class="ident" id="5910762">d</span><span class="op" id="5910763">.</span><span class="ident" id="5910764">readByte</span><span class="op" id="5910772">(</span><span class="op" id="5910773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5910778">if</span>&nbsp;<span class="ident" id="5910781">err</span>&nbsp;<span class="op" id="5910785">!=</span>&nbsp;<span class="ident" id="5910788">nil</span>&nbsp;<span class="op" id="5910792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5910798">return</span>&nbsp;<span class="ident" id="5910805">nil</span><span class="op" id="5910808">,</span>&nbsp;<span class="ident" id="5910810">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5910817">}</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5910821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5910825">marker</span>&nbsp;<span class="op" id="5910832">:=</span>&nbsp;<span class="ident" id="5910835">d</span><span class="op" id="5910836">.</span><span class="ident" id="5910837">tmp</span><span class="op" id="5910840">[</span><span class="num" id="5910841">1</span><span class="op" id="5910842">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5910846">if</span>&nbsp;<span class="ident" id="5910849">marker</span>&nbsp;<span class="op" id="5910856">==</span>&nbsp;<span class="num" id="5910859">0</span>&nbsp;<span class="op" id="5910861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5910866">//&nbsp;Treat&nbsp;&#34;\xff\x00&#34;&nbsp;as&nbsp;extraneous&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5910909">continue</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5910920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5910924">for</span>&nbsp;<span class="ident" id="5910928">marker</span>&nbsp;<span class="op" id="5910935">==</span>&nbsp;<span class="num" id="5910938">0xff</span>&nbsp;<span class="op" id="5910943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5910948">//&nbsp;Section&nbsp;B.1.1.2&nbsp;says,&nbsp;&#34;Any&nbsp;marker&nbsp;may&nbsp;optionally&nbsp;be&nbsp;preceded&nbsp;by&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5911022">//&nbsp;number&nbsp;of&nbsp;fill&nbsp;bytes,&nbsp;which&nbsp;are&nbsp;bytes&nbsp;assigned&nbsp;code&nbsp;X&#39;FF&#39;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5911088">marker</span><span class="op" id="5911094">,</span>&nbsp;<span class="ident" id="5911096">err</span>&nbsp;<span class="op" id="5911100">=</span>&nbsp;<span class="ident" id="5911102">d</span><span class="op" id="5911103">.</span><span class="ident" id="5911104">readByte</span><span class="op" id="5911112">(</span><span class="op" id="5911113">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5911118">if</span>&nbsp;<span class="ident" id="5911121">err</span>&nbsp;<span class="op" id="5911125">!=</span>&nbsp;<span class="ident" id="5911128">nil</span>&nbsp;<span class="op" id="5911132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5911138">return</span>&nbsp;<span class="ident" id="5911145">nil</span><span class="op" id="5911148">,</span>&nbsp;<span class="ident" id="5911150">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5911157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5911161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5911165">if</span>&nbsp;<span class="ident" id="5911168">marker</span>&nbsp;<span class="op" id="5911175">==</span>&nbsp;<span class="ident" id="5911178">eoiMarker</span>&nbsp;<span class="op" id="5911188">{</span>&nbsp;<span class="comment" id="5911190">//&nbsp;End&nbsp;Of&nbsp;Image.</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5911210">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5911218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5911222">if</span>&nbsp;<span class="ident" id="5911225">rst0Marker</span>&nbsp;<span class="op" id="5911236">&lt;=</span>&nbsp;<span class="ident" id="5911239">marker</span>&nbsp;<span class="op" id="5911246">&amp;&amp;</span>&nbsp;<span class="ident" id="5911249">marker</span>&nbsp;<span class="op" id="5911256">&lt;=</span>&nbsp;<span class="ident" id="5911259">rst7Marker</span>&nbsp;<span class="op" id="5911270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5911275">//&nbsp;Figures&nbsp;B.2&nbsp;and&nbsp;B.16&nbsp;of&nbsp;the&nbsp;specification&nbsp;suggest&nbsp;that&nbsp;restart&nbsp;markers&nbsp;should</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5911359">//&nbsp;only&nbsp;occur&nbsp;between&nbsp;Entropy&nbsp;Coded&nbsp;Segments&nbsp;and&nbsp;not&nbsp;after&nbsp;the&nbsp;final&nbsp;ECS.</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5911436">//&nbsp;However,&nbsp;some&nbsp;encoders&nbsp;may&nbsp;generate&nbsp;incorrect&nbsp;JPEGs&nbsp;with&nbsp;a&nbsp;final&nbsp;restart</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5911515">//&nbsp;marker.&nbsp;That&nbsp;restart&nbsp;marker&nbsp;will&nbsp;be&nbsp;seen&nbsp;here&nbsp;instead&nbsp;of&nbsp;inside&nbsp;the&nbsp;processSOS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5911600">//&nbsp;method,&nbsp;and&nbsp;is&nbsp;ignored&nbsp;as&nbsp;a&nbsp;harmless&nbsp;error.&nbsp;Restart&nbsp;markers&nbsp;have&nbsp;no&nbsp;extra&nbsp;data,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5911686">//&nbsp;so&nbsp;we&nbsp;check&nbsp;for&nbsp;this&nbsp;before&nbsp;we&nbsp;read&nbsp;the&nbsp;16-bit&nbsp;length&nbsp;of&nbsp;the&nbsp;segment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5911762">continue</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5911773">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5911778">//&nbsp;Read&nbsp;the&nbsp;16-bit&nbsp;length&nbsp;of&nbsp;the&nbsp;segment.&nbsp;The&nbsp;value&nbsp;includes&nbsp;the&nbsp;2&nbsp;bytes&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5911861">//&nbsp;length&nbsp;itself,&nbsp;so&nbsp;we&nbsp;subtract&nbsp;2&nbsp;to&nbsp;get&nbsp;the&nbsp;number&nbsp;of&nbsp;remaining&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5911936">if</span>&nbsp;<span class="ident" id="5911939">err</span>&nbsp;<span class="op" id="5911943">=</span>&nbsp;<span class="ident" id="5911945">d</span><span class="op" id="5911946">.</span><span class="ident" id="5911947">readFull</span><span class="op" id="5911955">(</span><span class="ident" id="5911956">d</span><span class="op" id="5911957">.</span><span class="ident" id="5911958">tmp</span><span class="op" id="5911961">[</span><span class="op" id="5911962">:</span><span class="num" id="5911963">2</span><span class="op" id="5911964">]</span><span class="op" id="5911965">)</span><span class="op" id="5911966">;</span>&nbsp;<span class="ident" id="5911968">err</span>&nbsp;<span class="op" id="5911972">!=</span>&nbsp;<span class="ident" id="5911975">nil</span>&nbsp;<span class="op" id="5911979">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5911984">return</span>&nbsp;<span class="ident" id="5911991">nil</span><span class="op" id="5911994">,</span>&nbsp;<span class="ident" id="5911996">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5912002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5912006">n</span>&nbsp;<span class="op" id="5912008">:=</span>&nbsp;<span class="builtintype" id="5912011">int</span><span class="op" id="5912014">(</span><span class="ident" id="5912015">d</span><span class="op" id="5912016">.</span><span class="ident" id="5912017">tmp</span><span class="op" id="5912020">[</span><span class="num" id="5912021">0</span><span class="op" id="5912022">]</span><span class="op" id="5912023">)</span><span class="op" id="5912024">&lt;&lt;</span><span class="num" id="5912026">8</span>&nbsp;<span class="op" id="5912028">+</span>&nbsp;<span class="builtintype" id="5912030">int</span><span class="op" id="5912033">(</span><span class="ident" id="5912034">d</span><span class="op" id="5912035">.</span><span class="ident" id="5912036">tmp</span><span class="op" id="5912039">[</span><span class="num" id="5912040">1</span><span class="op" id="5912041">]</span><span class="op" id="5912042">)</span>&nbsp;<span class="op" id="5912044">-</span>&nbsp;<span class="num" id="5912046">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5912050">if</span>&nbsp;<span class="ident" id="5912053">n</span>&nbsp;<span class="op" id="5912055">&lt;</span>&nbsp;<span class="num" id="5912057">0</span>&nbsp;<span class="op" id="5912059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5912064">return</span>&nbsp;<span class="ident" id="5912071">nil</span><span class="op" id="5912074">,</span>&nbsp;<span class="ident" id="5912076">FormatError</span><span class="op" id="5912087">(</span><span class="string" id="5912088">&#34;short&nbsp;segment&nbsp;length&#34;</span><span class="op" id="5912110">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5912114">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5912119">switch</span>&nbsp;<span class="op" id="5912126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5912130">case</span>&nbsp;<span class="ident" id="5912135">marker</span>&nbsp;<span class="op" id="5912142">==</span>&nbsp;<span class="ident" id="5912145">sof0Marker</span>&nbsp;<span class="op" id="5912156">||</span>&nbsp;<span class="ident" id="5912159">marker</span>&nbsp;<span class="op" id="5912166">==</span>&nbsp;<span class="ident" id="5912169">sof2Marker</span><span class="op" id="5912179">:</span>&nbsp;<span class="comment" id="5912181">//&nbsp;Start&nbsp;Of&nbsp;Frame.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5912203">d</span><span class="op" id="5912204">.</span><span class="ident" id="5912205">progressive</span>&nbsp;<span class="op" id="5912217">=</span>&nbsp;<span class="ident" id="5912219">marker</span>&nbsp;<span class="op" id="5912226">==</span>&nbsp;<span class="ident" id="5912229">sof2Marker</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5912243">err</span>&nbsp;<span class="op" id="5912247">=</span>&nbsp;<span class="ident" id="5912249">d</span><span class="op" id="5912250">.</span><span class="ident" id="5912251">processSOF</span><span class="op" id="5912261">(</span><span class="ident" id="5912262">n</span><span class="op" id="5912263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5912268">if</span>&nbsp;<span class="ident" id="5912271">configOnly</span>&nbsp;<span class="op" id="5912282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5912288">return</span>&nbsp;<span class="ident" id="5912295">nil</span><span class="op" id="5912298">,</span>&nbsp;<span class="ident" id="5912300">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5912307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5912311">case</span>&nbsp;<span class="ident" id="5912316">marker</span>&nbsp;<span class="op" id="5912323">==</span>&nbsp;<span class="ident" id="5912326">dhtMarker</span><span class="op" id="5912335">:</span>&nbsp;<span class="comment" id="5912337">//&nbsp;Define&nbsp;Huffman&nbsp;Table.</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5912365">err</span>&nbsp;<span class="op" id="5912369">=</span>&nbsp;<span class="ident" id="5912371">d</span><span class="op" id="5912372">.</span><span class="ident" id="5912373">processDHT</span><span class="op" id="5912383">(</span><span class="ident" id="5912384">n</span><span class="op" id="5912385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5912389">case</span>&nbsp;<span class="ident" id="5912394">marker</span>&nbsp;<span class="op" id="5912401">==</span>&nbsp;<span class="ident" id="5912404">dqtMarker</span><span class="op" id="5912413">:</span>&nbsp;<span class="comment" id="5912415">//&nbsp;Define&nbsp;Quantization&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5912448">err</span>&nbsp;<span class="op" id="5912452">=</span>&nbsp;<span class="ident" id="5912454">d</span><span class="op" id="5912455">.</span><span class="ident" id="5912456">processDQT</span><span class="op" id="5912466">(</span><span class="ident" id="5912467">n</span><span class="op" id="5912468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5912472">case</span>&nbsp;<span class="ident" id="5912477">marker</span>&nbsp;<span class="op" id="5912484">==</span>&nbsp;<span class="ident" id="5912487">sosMarker</span><span class="op" id="5912496">:</span>&nbsp;<span class="comment" id="5912498">//&nbsp;Start&nbsp;Of&nbsp;Scan.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5912519">err</span>&nbsp;<span class="op" id="5912523">=</span>&nbsp;<span class="ident" id="5912525">d</span><span class="op" id="5912526">.</span><span class="ident" id="5912527">processSOS</span><span class="op" id="5912537">(</span><span class="ident" id="5912538">n</span><span class="op" id="5912539">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5912543">case</span>&nbsp;<span class="ident" id="5912548">marker</span>&nbsp;<span class="op" id="5912555">==</span>&nbsp;<span class="ident" id="5912558">driMarker</span><span class="op" id="5912567">:</span>&nbsp;<span class="comment" id="5912569">//&nbsp;Define&nbsp;Restart&nbsp;Interval.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5912600">err</span>&nbsp;<span class="op" id="5912604">=</span>&nbsp;<span class="ident" id="5912606">d</span><span class="op" id="5912607">.</span><span class="ident" id="5912608">processDRI</span><span class="op" id="5912618">(</span><span class="ident" id="5912619">n</span><span class="op" id="5912620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5912624">case</span>&nbsp;<span class="ident" id="5912629">app0Marker</span>&nbsp;<span class="op" id="5912640">&lt;=</span>&nbsp;<span class="ident" id="5912643">marker</span>&nbsp;<span class="op" id="5912650">&amp;&amp;</span>&nbsp;<span class="ident" id="5912653">marker</span>&nbsp;<span class="op" id="5912660">&lt;=</span>&nbsp;<span class="ident" id="5912663">app15Marker</span>&nbsp;<span class="op" id="5912675">||</span>&nbsp;<span class="ident" id="5912678">marker</span>&nbsp;<span class="op" id="5912685">==</span>&nbsp;<span class="ident" id="5912688">comMarker</span><span class="op" id="5912697">:</span>&nbsp;<span class="comment" id="5912699">//&nbsp;APPlication&nbsp;specific,&nbsp;or&nbsp;COMment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5912739">err</span>&nbsp;<span class="op" id="5912743">=</span>&nbsp;<span class="ident" id="5912745">d</span><span class="op" id="5912746">.</span><span class="ident" id="5912747">ignore</span><span class="op" id="5912753">(</span><span class="ident" id="5912754">n</span><span class="op" id="5912755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5912759">default</span><span class="op" id="5912766">:</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5912771">err</span>&nbsp;<span class="op" id="5912775">=</span>&nbsp;<span class="ident" id="5912777">UnsupportedError</span><span class="op" id="5912793">(</span><span class="string" id="5912794">&#34;unknown&nbsp;marker&#34;</span><span class="op" id="5912810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5912814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5912818">if</span>&nbsp;<span class="ident" id="5912821">err</span>&nbsp;<span class="op" id="5912825">!=</span>&nbsp;<span class="ident" id="5912828">nil</span>&nbsp;<span class="op" id="5912832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5912837">return</span>&nbsp;<span class="ident" id="5912844">nil</span><span class="op" id="5912847">,</span>&nbsp;<span class="ident" id="5912849">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5912855">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5912858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5912861">if</span>&nbsp;<span class="ident" id="5912864">d</span><span class="op" id="5912865">.</span><span class="ident" id="5912866">img1</span>&nbsp;<span class="op" id="5912871">!=</span>&nbsp;<span class="ident" id="5912874">nil</span>&nbsp;<span class="op" id="5912878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5912882">return</span>&nbsp;<span class="ident" id="5912889">d</span><span class="op" id="5912890">.</span><span class="ident" id="5912891">img1</span><span class="op" id="5912895">,</span>&nbsp;<span class="ident" id="5912897">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5912902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5912905">if</span>&nbsp;<span class="ident" id="5912908">d</span><span class="op" id="5912909">.</span><span class="ident" id="5912910">img3</span>&nbsp;<span class="op" id="5912915">!=</span>&nbsp;<span class="ident" id="5912918">nil</span>&nbsp;<span class="op" id="5912922">{</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5912926">return</span>&nbsp;<span class="ident" id="5912933">d</span><span class="op" id="5912934">.</span><span class="ident" id="5912935">img3</span><span class="op" id="5912939">,</span>&nbsp;<span class="ident" id="5912941">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5912946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5912949">return</span>&nbsp;<span class="ident" id="5912956">nil</span><span class="op" id="5912959">,</span>&nbsp;<span class="ident" id="5912961">FormatError</span><span class="op" id="5912972">(</span><span class="string" id="5912973">&#34;missing&nbsp;SOS&nbsp;marker&#34;</span><span class="op" id="5912993">)</span><br>
<span class="lineno"></span><span class="op" id="5912995">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="5912998">//&nbsp;Decode&nbsp;reads&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;from&nbsp;r&nbsp;and&nbsp;returns&nbsp;it&nbsp;as&nbsp;an&nbsp;image.Image.</span><br>
<span class="lineno"></span><span class="keyword" id="5913068">func</span>&nbsp;<span class="ident" id="5913073">Decode</span><span class="op" id="5913079">(</span><span class="ident" id="5913080">r</span>&nbsp;<span class="ident" id="5913082">io</span><span class="op" id="5913084">.</span><span class="ident" id="5913085">Reader</span><span class="op" id="5913091">)</span>&nbsp;<span class="op" id="5913093">(</span><span class="ident" id="5913094">image</span><span class="op" id="5913099">.</span><span class="ident" id="5913100">Image</span><span class="op" id="5913105">,</span>&nbsp;<span class="builtintype" id="5913107">error</span><span class="op" id="5913112">)</span>&nbsp;<span class="op" id="5913114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5913117">var</span>&nbsp;<span class="ident" id="5913121">d</span>&nbsp;<span class="ident" id="5913123">decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5913132">return</span>&nbsp;<span class="ident" id="5913139">d</span><span class="op" id="5913140">.</span><span class="ident" id="5913141">decode</span><span class="op" id="5913147">(</span><span class="ident" id="5913148">r</span><span class="op" id="5913149">,</span>&nbsp;<span class="builtintype" id="5913151">false</span><span class="op" id="5913156">)</span><br>
<span class="lineno"></span><span class="op" id="5913158">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="comment" id="5913161">//&nbsp;DecodeConfig&nbsp;returns&nbsp;the&nbsp;color&nbsp;model&nbsp;and&nbsp;dimensions&nbsp;of&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="5913240">//&nbsp;decoding&nbsp;the&nbsp;entire&nbsp;image.</span><br>
<span class="lineno"></span><span class="keyword" id="5913270">func</span>&nbsp;<span class="ident" id="5913275">DecodeConfig</span><span class="op" id="5913287">(</span><span class="ident" id="5913288">r</span>&nbsp;<span class="ident" id="5913290">io</span><span class="op" id="5913292">.</span><span class="ident" id="5913293">Reader</span><span class="op" id="5913299">)</span>&nbsp;<span class="op" id="5913301">(</span><span class="ident" id="5913302">image</span><span class="op" id="5913307">.</span><span class="ident" id="5913308">Config</span><span class="op" id="5913314">,</span>&nbsp;<span class="builtintype" id="5913316">error</span><span class="op" id="5913321">)</span>&nbsp;<span class="op" id="5913323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5913326">var</span>&nbsp;<span class="ident" id="5913330">d</span>&nbsp;<span class="ident" id="5913332">decoder</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5913341">if</span>&nbsp;<span class="ident" id="5913344">_</span><span class="op" id="5913345">,</span>&nbsp;<span class="ident" id="5913347">err</span>&nbsp;<span class="op" id="5913351">:=</span>&nbsp;<span class="ident" id="5913354">d</span><span class="op" id="5913355">.</span><span class="ident" id="5913356">decode</span><span class="op" id="5913362">(</span><span class="ident" id="5913363">r</span><span class="op" id="5913364">,</span>&nbsp;<span class="builtintype" id="5913366">true</span><span class="op" id="5913370">)</span><span class="op" id="5913371">;</span>&nbsp;<span class="ident" id="5913373">err</span>&nbsp;<span class="op" id="5913377">!=</span>&nbsp;<span class="ident" id="5913380">nil</span>&nbsp;<span class="op" id="5913384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5913388">return</span>&nbsp;<span class="ident" id="5913395">image</span><span class="op" id="5913400">.</span><span class="ident" id="5913401">Config</span><span class="op" id="5913407">{</span><span class="op" id="5913408">}</span><span class="op" id="5913409">,</span>&nbsp;<span class="ident" id="5913411">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5913416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5913419">switch</span>&nbsp;<span class="ident" id="5913426">d</span><span class="op" id="5913427">.</span><span class="ident" id="5913428">nComp</span>&nbsp;<span class="op" id="5913434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5913437">case</span>&nbsp;<span class="ident" id="5913442">nGrayComponent</span><span class="op" id="5913456">:</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5913460">return</span>&nbsp;<span class="ident" id="5913467">image</span><span class="op" id="5913472">.</span><span class="ident" id="5913473">Config</span><span class="op" id="5913479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5913484">ColorModel</span><span class="op" id="5913494">:</span>&nbsp;<span class="ident" id="5913496">color</span><span class="op" id="5913501">.</span><span class="ident" id="5913502">GrayModel</span><span class="op" id="5913511">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5913516">Width</span><span class="op" id="5913521">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5913528">d</span><span class="op" id="5913529">.</span><span class="ident" id="5913530">width</span><span class="op" id="5913535">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5913540">Height</span><span class="op" id="5913546">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5913552">d</span><span class="op" id="5913553">.</span><span class="ident" id="5913554">height</span><span class="op" id="5913560">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5913564">}</span><span class="op" id="5913565">,</span>&nbsp;<span class="ident" id="5913567">nil</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5913572">case</span>&nbsp;<span class="ident" id="5913577">nColorComponent</span><span class="op" id="5913592">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5913596">return</span>&nbsp;<span class="ident" id="5913603">image</span><span class="op" id="5913608">.</span><span class="ident" id="5913609">Config</span><span class="op" id="5913615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5913620">ColorModel</span><span class="op" id="5913630">:</span>&nbsp;<span class="ident" id="5913632">color</span><span class="op" id="5913637">.</span><span class="ident" id="5913638">YCbCrModel</span><span class="op" id="5913648">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5913653">Width</span><span class="op" id="5913658">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5913665">d</span><span class="op" id="5913666">.</span><span class="ident" id="5913667">width</span><span class="op" id="5913672">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5913677">Height</span><span class="op" id="5913683">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5913689">d</span><span class="op" id="5913690">.</span><span class="ident" id="5913691">height</span><span class="op" id="5913697">,</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5913701">}</span><span class="op" id="5913702">,</span>&nbsp;<span class="ident" id="5913704">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5913709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5913712">return</span>&nbsp;<span class="ident" id="5913719">image</span><span class="op" id="5913724">.</span><span class="ident" id="5913725">Config</span><span class="op" id="5913731">{</span><span class="op" id="5913732">}</span><span class="op" id="5913733">,</span>&nbsp;<span class="ident" id="5913735">FormatError</span><span class="op" id="5913746">(</span><span class="string" id="5913747">&#34;missing&nbsp;SOF&nbsp;marker&#34;</span><span class="op" id="5913767">)</span><br>
<span class="lineno"></span><span class="op" id="5913769">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">525</span><span class="keyword" id="5913772">func</span>&nbsp;<span class="ident" id="5913777">init</span><span class="op" id="5913781">(</span><span class="op" id="5913782">)</span>&nbsp;<span class="op" id="5913784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5913787">image</span><span class="op" id="5913792">.</span><span class="ident" id="5913793">RegisterFormat</span><span class="op" id="5913807">(</span><span class="string" id="5913808">&#34;jpeg&#34;</span><span class="op" id="5913814">,</span>&nbsp;<span class="string" id="5913816">&#34;\xff\xd8&#34;</span><span class="op" id="5913826">,</span>&nbsp;<span class="ident" id="5913828">Decode</span><span class="op" id="5913834">,</span>&nbsp;<span class="ident" id="5913836">DecodeConfig</span><span class="op" id="5913848">)</span><br>
<span class="lineno"></span><span class="op" id="5913850">}</span>
</div>
</body>
</html>
