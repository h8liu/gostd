<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html" class="current">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1584094">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1584149">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1584203">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1584254">//&nbsp;+build&nbsp;dragonfly&nbsp;freebsd&nbsp;linux</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1584289">package</span>&nbsp;<span class="ident" id="1584297">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1584306">import</span>&nbsp;<span class="string" id="1584313">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="1584323">//&nbsp;This&nbsp;implementation&nbsp;depends&nbsp;on&nbsp;OS-specific&nbsp;implementations&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1584388">//</span><br>
<span class="lineno"></span><span class="comment" id="1584391">//&nbsp;&nbsp;&nbsp;&nbsp;runtime路futexsleep(uint32&nbsp;*addr,&nbsp;uint32&nbsp;val,&nbsp;int64&nbsp;ns)</span><br>
<span class="lineno"></span><span class="comment" id="1584450">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Atomically,</span><br>
<span class="lineno">15</span><span class="comment" id="1584466">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(*addr&nbsp;==&nbsp;val)&nbsp;sleep</span><br>
<span class="lineno"></span><span class="comment" id="1584494">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Might&nbsp;be&nbsp;woken&nbsp;up&nbsp;spuriously;&nbsp;that&#39;s&nbsp;allowed.</span><br>
<span class="lineno"></span><span class="comment" id="1584544">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Don&#39;t&nbsp;sleep&nbsp;longer&nbsp;than&nbsp;ns;&nbsp;ns&nbsp;&lt;&nbsp;0&nbsp;means&nbsp;forever.</span><br>
<span class="lineno"></span><span class="comment" id="1584598">//</span><br>
<span class="lineno"></span><span class="comment" id="1584601">//&nbsp;&nbsp;&nbsp;&nbsp;runtime路futexwakeup(uint32&nbsp;*addr,&nbsp;uint32&nbsp;cnt)</span><br>
<span class="lineno">20</span><span class="comment" id="1584651">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;any&nbsp;procs&nbsp;are&nbsp;sleeping&nbsp;on&nbsp;addr,&nbsp;wake&nbsp;up&nbsp;at&nbsp;most&nbsp;cnt.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1584712">const</span>&nbsp;<span class="op" id="1584718">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1584721">mutex_unlocked</span>&nbsp;<span class="op" id="1584736">=</span>&nbsp;<span class="num" id="1584738">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1584741">mutex_locked</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1584756">=</span>&nbsp;<span class="num" id="1584758">1</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1584761">mutex_sleeping</span>&nbsp;<span class="op" id="1584776">=</span>&nbsp;<span class="num" id="1584778">2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1584782">active_spin</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1584798">=</span>&nbsp;<span class="num" id="1584800">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1584803">active_spin_cnt</span>&nbsp;<span class="op" id="1584819">=</span>&nbsp;<span class="num" id="1584821">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1584825">passive_spin</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1584841">=</span>&nbsp;<span class="num" id="1584843">1</span><br>
<span class="lineno">30</span><span class="op" id="1584845">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1584848">//&nbsp;Possible&nbsp;lock&nbsp;states&nbsp;are&nbsp;mutex_unlocked,&nbsp;mutex_locked&nbsp;and&nbsp;mutex_sleeping.</span><br>
<span class="lineno"></span><span class="comment" id="1584925">//&nbsp;mutex_sleeping&nbsp;means&nbsp;that&nbsp;there&nbsp;is&nbsp;presumably&nbsp;at&nbsp;least&nbsp;one&nbsp;sleeping&nbsp;thread.</span><br>
<span class="lineno"></span><span class="comment" id="1585004">//&nbsp;Note&nbsp;that&nbsp;there&nbsp;can&nbsp;be&nbsp;spinning&nbsp;threads&nbsp;during&nbsp;all&nbsp;states&nbsp;-&nbsp;they&nbsp;do&nbsp;not</span><br>
<span class="lineno">35</span><span class="comment" id="1585079">//&nbsp;affect&nbsp;mutex&#39;s&nbsp;state.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1585105">func</span>&nbsp;<span class="ident" id="1585110">futexsleep</span><span class="op" id="1585120">(</span><span class="ident" id="1585121">addr</span>&nbsp;<span class="op" id="1585126">*</span><span class="builtintype" id="1585127">uint32</span><span class="op" id="1585133">,</span>&nbsp;<span class="ident" id="1585135">val</span>&nbsp;<span class="builtintype" id="1585139">uint32</span><span class="op" id="1585145">,</span>&nbsp;<span class="ident" id="1585147">ns</span>&nbsp;<span class="builtintype" id="1585150">int64</span><span class="op" id="1585155">)</span><br>
<span class="lineno"></span><span class="keyword" id="1585157">func</span>&nbsp;<span class="ident" id="1585162">futexwakeup</span><span class="op" id="1585173">(</span><span class="ident" id="1585174">addr</span>&nbsp;<span class="op" id="1585179">*</span><span class="builtintype" id="1585180">uint32</span><span class="op" id="1585186">,</span>&nbsp;<span class="ident" id="1585188">cnt</span>&nbsp;<span class="builtintype" id="1585192">uint32</span><span class="op" id="1585198">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="1585201">//&nbsp;We&nbsp;use&nbsp;the&nbsp;uintptr&nbsp;mutex.key&nbsp;and&nbsp;note.key&nbsp;as&nbsp;a&nbsp;uint32.</span><br>
<span class="lineno"></span><span class="keyword" id="1585259">func</span>&nbsp;<span class="ident" id="1585264">key32</span><span class="op" id="1585269">(</span><span class="ident" id="1585270">p</span>&nbsp;<span class="op" id="1585272">*</span><span class="builtintype" id="1585273">uintptr</span><span class="op" id="1585280">)</span>&nbsp;<span class="op" id="1585282">*</span><span class="builtintype" id="1585283">uint32</span>&nbsp;<span class="op" id="1585290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1585293">return</span>&nbsp;<span class="op" id="1585300">(</span><span class="op" id="1585301">*</span><span class="builtintype" id="1585302">uint32</span><span class="op" id="1585308">)</span><span class="op" id="1585309">(</span><span class="ident" id="1585310"><a href="/gostd/runtime/lock_futex.go.html#1584313">unsafe</a></span><span class="op" id="1585316">.</span><span class="ident" id="1585317">Pointer</span><span class="op" id="1585324">(</span><span class="ident" id="1585325"><a href="/gostd/runtime/lock_futex.go.html#1585270">p</a></span><span class="op" id="1585326">)</span><span class="op" id="1585327">)</span><br>
<span class="lineno"></span><span class="op" id="1585329">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="1585332">func</span>&nbsp;<span class="ident" id="1585337">lock</span><span class="op" id="1585341">(</span><span class="ident" id="1585342">l</span>&nbsp;<span class="op" id="1585344">*</span><span class="ident" id="1585345"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786208">mutex</a></span><span class="op" id="1585350">)</span>&nbsp;<span class="op" id="1585352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585355">gp</span>&nbsp;<span class="op" id="1585358">:=</span>&nbsp;<span class="ident" id="1585361"><a href="/gostd/runtime/stubs.go.html#1738919">getg</a></span><span class="op" id="1585365">(</span><span class="op" id="1585366">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1585370">if</span>&nbsp;<span class="ident" id="1585373"><a href="/gostd/runtime/lock_futex.go.html#1585355">gp</a></span><span class="op" id="1585375">.</span><span class="ident" id="1585376"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1787643">m</a></span><span class="op" id="1585377">.</span><span class="ident" id="1585378"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1788007">locks</a></span>&nbsp;<span class="op" id="1585384">&lt;</span>&nbsp;<span class="num" id="1585386">0</span>&nbsp;<span class="op" id="1585388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585392"><a href="/gostd/runtime/panic.go.html#1664327">gothrow</a></span><span class="op" id="1585399">(</span><span class="string" id="1585400">&#34;runtime路lock:&nbsp;lock&nbsp;count&#34;</span><span class="op" id="1585427">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1585430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585433"><a href="/gostd/runtime/lock_futex.go.html#1585355">gp</a></span><span class="op" id="1585435">.</span><span class="ident" id="1585436"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1787643">m</a></span><span class="op" id="1585437">.</span><span class="ident" id="1585438"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1788007">locks</a></span><span class="op" id="1585443">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1585448">//&nbsp;Speculative&nbsp;grab&nbsp;for&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585479">v</span>&nbsp;<span class="op" id="1585481">:=</span>&nbsp;<span class="ident" id="1585484"><a href="/gostd/runtime/atomic.go.html#1481066">xchg</a></span><span class="op" id="1585488">(</span><span class="ident" id="1585489"><a href="/gostd/runtime/lock_futex.go.html#1585264">key32</a></span><span class="op" id="1585494">(</span><span class="op" id="1585495">&amp;</span><span class="ident" id="1585496"><a href="/gostd/runtime/lock_futex.go.html#1585342">l</a></span><span class="op" id="1585497">.</span><span class="ident" id="1585498"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786224">key</a></span><span class="op" id="1585501">)</span><span class="op" id="1585502">,</span>&nbsp;<span class="ident" id="1585504"><a href="/gostd/runtime/lock_futex.go.html#1584741">mutex_locked</a></span><span class="op" id="1585516">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1585519">if</span>&nbsp;<span class="ident" id="1585522"><a href="/gostd/runtime/lock_futex.go.html#1585479">v</a></span>&nbsp;<span class="op" id="1585524">==</span>&nbsp;<span class="ident" id="1585527"><a href="/gostd/runtime/lock_futex.go.html#1584721">mutex_unlocked</a></span>&nbsp;<span class="op" id="1585542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1585546">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1585554">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1585558">//&nbsp;wait&nbsp;is&nbsp;either&nbsp;MUTEX_LOCKED&nbsp;or&nbsp;MUTEX_SLEEPING</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1585608">//&nbsp;depending&nbsp;on&nbsp;whether&nbsp;there&nbsp;is&nbsp;a&nbsp;thread&nbsp;sleeping</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1585660">//&nbsp;on&nbsp;this&nbsp;mutex.&nbsp;&nbsp;If&nbsp;we&nbsp;ever&nbsp;change&nbsp;l-&gt;key&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1585710">//&nbsp;MUTEX_SLEEPING&nbsp;to&nbsp;some&nbsp;other&nbsp;value,&nbsp;we&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1585761">//&nbsp;careful&nbsp;to&nbsp;change&nbsp;it&nbsp;back&nbsp;to&nbsp;MUTEX_SLEEPING&nbsp;before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1585816">//&nbsp;returning,&nbsp;to&nbsp;ensure&nbsp;that&nbsp;the&nbsp;sleeping&nbsp;thread&nbsp;gets</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1585871">//&nbsp;its&nbsp;wakeup&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585892">wait</span>&nbsp;<span class="op" id="1585897">:=</span>&nbsp;<span class="ident" id="1585900"><a href="/gostd/runtime/lock_futex.go.html#1585479">v</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1585904">//&nbsp;On&nbsp;uniprocessors,&nbsp;no&nbsp;point&nbsp;spinning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1585945">//&nbsp;On&nbsp;multiprocessors,&nbsp;spin&nbsp;for&nbsp;ACTIVE_SPIN&nbsp;attempts.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586000">spin</span>&nbsp;<span class="op" id="1586005">:=</span>&nbsp;<span class="num" id="1586008">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1586011">if</span>&nbsp;<span class="ident" id="1586014"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1791350">ncpu</a></span>&nbsp;<span class="op" id="1586019">&gt;</span>&nbsp;<span class="num" id="1586021">1</span>&nbsp;<span class="op" id="1586023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586027"><a href="/gostd/runtime/lock_futex.go.html#1586000">spin</a></span>&nbsp;<span class="op" id="1586032">=</span>&nbsp;<span class="ident" id="1586034"><a href="/gostd/runtime/lock_futex.go.html#1584782">active_spin</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1586047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1586050">for</span>&nbsp;<span class="op" id="1586054">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1586058">//&nbsp;Try&nbsp;for&nbsp;lock,&nbsp;spinning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1586087">for</span>&nbsp;<span class="ident" id="1586091">i</span>&nbsp;<span class="op" id="1586093">:=</span>&nbsp;<span class="num" id="1586096">0</span><span class="op" id="1586097">;</span>&nbsp;<span class="ident" id="1586099"><a href="/gostd/runtime/lock_futex.go.html#1586091">i</a></span>&nbsp;<span class="op" id="1586101">&lt;</span>&nbsp;<span class="ident" id="1586103"><a href="/gostd/runtime/lock_futex.go.html#1586000">spin</a></span><span class="op" id="1586107">;</span>&nbsp;<span class="ident" id="1586109"><a href="/gostd/runtime/lock_futex.go.html#1586091">i</a></span><span class="op" id="1586110">++</span>&nbsp;<span class="op" id="1586113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1586118">for</span>&nbsp;<span class="ident" id="1586122"><a href="/gostd/runtime/lock_futex.go.html#1585342">l</a></span><span class="op" id="1586123">.</span><span class="ident" id="1586124"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786224">key</a></span>&nbsp;<span class="op" id="1586128">==</span>&nbsp;<span class="ident" id="1586131"><a href="/gostd/runtime/lock_futex.go.html#1584721">mutex_unlocked</a></span>&nbsp;<span class="op" id="1586146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1586152">if</span>&nbsp;<span class="ident" id="1586155"><a href="/gostd/runtime/stubs.go.html#1744744">cas</a></span><span class="op" id="1586158">(</span><span class="ident" id="1586159"><a href="/gostd/runtime/lock_futex.go.html#1585264">key32</a></span><span class="op" id="1586164">(</span><span class="op" id="1586165">&amp;</span><span class="ident" id="1586166"><a href="/gostd/runtime/lock_futex.go.html#1585342">l</a></span><span class="op" id="1586167">.</span><span class="ident" id="1586168"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786224">key</a></span><span class="op" id="1586171">)</span><span class="op" id="1586172">,</span>&nbsp;<span class="ident" id="1586174"><a href="/gostd/runtime/lock_futex.go.html#1584721">mutex_unlocked</a></span><span class="op" id="1586188">,</span>&nbsp;<span class="ident" id="1586190"><a href="/gostd/runtime/lock_futex.go.html#1585892">wait</a></span><span class="op" id="1586194">)</span>&nbsp;<span class="op" id="1586196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1586203">return</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1586214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1586219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586224"><a href="/gostd/runtime/stubs.go.html#1744445">procyield</a></span><span class="op" id="1586233">(</span><span class="ident" id="1586234"><a href="/gostd/runtime/lock_futex.go.html#1584803">active_spin_cnt</a></span><span class="op" id="1586249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1586253">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1586258">//&nbsp;Try&nbsp;for&nbsp;lock,&nbsp;rescheduling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1586291">for</span>&nbsp;<span class="ident" id="1586295">i</span>&nbsp;<span class="op" id="1586297">:=</span>&nbsp;<span class="num" id="1586300">0</span><span class="op" id="1586301">;</span>&nbsp;<span class="ident" id="1586303"><a href="/gostd/runtime/lock_futex.go.html#1586295">i</a></span>&nbsp;<span class="op" id="1586305">&lt;</span>&nbsp;<span class="ident" id="1586307"><a href="/gostd/runtime/lock_futex.go.html#1584825">passive_spin</a></span><span class="op" id="1586319">;</span>&nbsp;<span class="ident" id="1586321"><a href="/gostd/runtime/lock_futex.go.html#1586295">i</a></span><span class="op" id="1586322">++</span>&nbsp;<span class="op" id="1586325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1586330">for</span>&nbsp;<span class="ident" id="1586334"><a href="/gostd/runtime/lock_futex.go.html#1585342">l</a></span><span class="op" id="1586335">.</span><span class="ident" id="1586336"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786224">key</a></span>&nbsp;<span class="op" id="1586340">==</span>&nbsp;<span class="ident" id="1586343"><a href="/gostd/runtime/lock_futex.go.html#1584721">mutex_unlocked</a></span>&nbsp;<span class="op" id="1586358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1586364">if</span>&nbsp;<span class="ident" id="1586367"><a href="/gostd/runtime/stubs.go.html#1744744">cas</a></span><span class="op" id="1586370">(</span><span class="ident" id="1586371"><a href="/gostd/runtime/lock_futex.go.html#1585264">key32</a></span><span class="op" id="1586376">(</span><span class="op" id="1586377">&amp;</span><span class="ident" id="1586378"><a href="/gostd/runtime/lock_futex.go.html#1585342">l</a></span><span class="op" id="1586379">.</span><span class="ident" id="1586380"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786224">key</a></span><span class="op" id="1586383">)</span><span class="op" id="1586384">,</span>&nbsp;<span class="ident" id="1586386"><a href="/gostd/runtime/lock_futex.go.html#1584721">mutex_unlocked</a></span><span class="op" id="1586400">,</span>&nbsp;<span class="ident" id="1586402"><a href="/gostd/runtime/lock_futex.go.html#1585892">wait</a></span><span class="op" id="1586406">)</span>&nbsp;<span class="op" id="1586408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1586415">return</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1586426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1586431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586436"><a href="/gostd/runtime/stubs.go.html#1744430">osyield</a></span><span class="op" id="1586443">(</span><span class="op" id="1586444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1586448">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1586453">//&nbsp;Sleep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586465"><a href="/gostd/runtime/lock_futex.go.html#1585479">v</a></span>&nbsp;<span class="op" id="1586467">=</span>&nbsp;<span class="ident" id="1586469"><a href="/gostd/runtime/atomic.go.html#1481066">xchg</a></span><span class="op" id="1586473">(</span><span class="ident" id="1586474"><a href="/gostd/runtime/lock_futex.go.html#1585264">key32</a></span><span class="op" id="1586479">(</span><span class="op" id="1586480">&amp;</span><span class="ident" id="1586481"><a href="/gostd/runtime/lock_futex.go.html#1585342">l</a></span><span class="op" id="1586482">.</span><span class="ident" id="1586483"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786224">key</a></span><span class="op" id="1586486">)</span><span class="op" id="1586487">,</span>&nbsp;<span class="ident" id="1586489"><a href="/gostd/runtime/lock_futex.go.html#1584761">mutex_sleeping</a></span><span class="op" id="1586503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1586507">if</span>&nbsp;<span class="ident" id="1586510"><a href="/gostd/runtime/lock_futex.go.html#1585479">v</a></span>&nbsp;<span class="op" id="1586512">==</span>&nbsp;<span class="ident" id="1586515"><a href="/gostd/runtime/lock_futex.go.html#1584721">mutex_unlocked</a></span>&nbsp;<span class="op" id="1586530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1586535">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1586544">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586548"><a href="/gostd/runtime/lock_futex.go.html#1585892">wait</a></span>&nbsp;<span class="op" id="1586553">=</span>&nbsp;<span class="ident" id="1586555"><a href="/gostd/runtime/lock_futex.go.html#1584761">mutex_sleeping</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586572"><a href="/gostd/runtime/lock_futex.go.html#1585110">futexsleep</a></span><span class="op" id="1586582">(</span><span class="ident" id="1586583"><a href="/gostd/runtime/lock_futex.go.html#1585264">key32</a></span><span class="op" id="1586588">(</span><span class="op" id="1586589">&amp;</span><span class="ident" id="1586590"><a href="/gostd/runtime/lock_futex.go.html#1585342">l</a></span><span class="op" id="1586591">.</span><span class="ident" id="1586592"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786224">key</a></span><span class="op" id="1586595">)</span><span class="op" id="1586596">,</span>&nbsp;<span class="ident" id="1586598"><a href="/gostd/runtime/lock_futex.go.html#1584761">mutex_sleeping</a></span><span class="op" id="1586612">,</span>&nbsp;<span class="op" id="1586614">-</span><span class="num" id="1586615">1</span><span class="op" id="1586616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1586619">}</span><br>
<span class="lineno"></span><span class="op" id="1586621">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="1586624">func</span>&nbsp;<span class="ident" id="1586629">unlock</span><span class="op" id="1586635">(</span><span class="ident" id="1586636">l</span>&nbsp;<span class="op" id="1586638">*</span><span class="ident" id="1586639"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786208">mutex</a></span><span class="op" id="1586644">)</span>&nbsp;<span class="op" id="1586646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586649">v</span>&nbsp;<span class="op" id="1586651">:=</span>&nbsp;<span class="ident" id="1586654"><a href="/gostd/runtime/atomic.go.html#1481066">xchg</a></span><span class="op" id="1586658">(</span><span class="ident" id="1586659"><a href="/gostd/runtime/lock_futex.go.html#1585264">key32</a></span><span class="op" id="1586664">(</span><span class="op" id="1586665">&amp;</span><span class="ident" id="1586666"><a href="/gostd/runtime/lock_futex.go.html#1586636">l</a></span><span class="op" id="1586667">.</span><span class="ident" id="1586668"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786224">key</a></span><span class="op" id="1586671">)</span><span class="op" id="1586672">,</span>&nbsp;<span class="ident" id="1586674"><a href="/gostd/runtime/lock_futex.go.html#1584721">mutex_unlocked</a></span><span class="op" id="1586688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1586691">if</span>&nbsp;<span class="ident" id="1586694"><a href="/gostd/runtime/lock_futex.go.html#1586649">v</a></span>&nbsp;<span class="op" id="1586696">==</span>&nbsp;<span class="ident" id="1586699"><a href="/gostd/runtime/lock_futex.go.html#1584721">mutex_unlocked</a></span>&nbsp;<span class="op" id="1586714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586718"><a href="/gostd/runtime/panic.go.html#1664327">gothrow</a></span><span class="op" id="1586725">(</span><span class="string" id="1586726">&#34;unlock&nbsp;of&nbsp;unlocked&nbsp;lock&#34;</span><span class="op" id="1586751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1586754">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1586757">if</span>&nbsp;<span class="ident" id="1586760"><a href="/gostd/runtime/lock_futex.go.html#1586649">v</a></span>&nbsp;<span class="op" id="1586762">==</span>&nbsp;<span class="ident" id="1586765"><a href="/gostd/runtime/lock_futex.go.html#1584761">mutex_sleeping</a></span>&nbsp;<span class="op" id="1586780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586784"><a href="/gostd/runtime/lock_futex.go.html#1585162">futexwakeup</a></span><span class="op" id="1586795">(</span><span class="ident" id="1586796"><a href="/gostd/runtime/lock_futex.go.html#1585264">key32</a></span><span class="op" id="1586801">(</span><span class="op" id="1586802">&amp;</span><span class="ident" id="1586803"><a href="/gostd/runtime/lock_futex.go.html#1586636">l</a></span><span class="op" id="1586804">.</span><span class="ident" id="1586805"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786224">key</a></span><span class="op" id="1586808">)</span><span class="op" id="1586809">,</span>&nbsp;<span class="num" id="1586811">1</span><span class="op" id="1586812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1586815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586819">gp</span>&nbsp;<span class="op" id="1586822">:=</span>&nbsp;<span class="ident" id="1586825"><a href="/gostd/runtime/stubs.go.html#1738919">getg</a></span><span class="op" id="1586829">(</span><span class="op" id="1586830">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586833"><a href="/gostd/runtime/lock_futex.go.html#1586819">gp</a></span><span class="op" id="1586835">.</span><span class="ident" id="1586836"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1787643">m</a></span><span class="op" id="1586837">.</span><span class="ident" id="1586838"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1788007">locks</a></span><span class="op" id="1586843">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1586847">if</span>&nbsp;<span class="ident" id="1586850"><a href="/gostd/runtime/lock_futex.go.html#1586819">gp</a></span><span class="op" id="1586852">.</span><span class="ident" id="1586853"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1787643">m</a></span><span class="op" id="1586854">.</span><span class="ident" id="1586855"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1788007">locks</a></span>&nbsp;<span class="op" id="1586861">&lt;</span>&nbsp;<span class="num" id="1586863">0</span>&nbsp;<span class="op" id="1586865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586869"><a href="/gostd/runtime/panic.go.html#1664327">gothrow</a></span><span class="op" id="1586876">(</span><span class="string" id="1586877">&#34;runtime路unlock:&nbsp;lock&nbsp;count&#34;</span><span class="op" id="1586906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1586909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1586912">if</span>&nbsp;<span class="ident" id="1586915"><a href="/gostd/runtime/lock_futex.go.html#1586819">gp</a></span><span class="op" id="1586917">.</span><span class="ident" id="1586918"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1787643">m</a></span><span class="op" id="1586919">.</span><span class="ident" id="1586920"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1788007">locks</a></span>&nbsp;<span class="op" id="1586926">==</span>&nbsp;<span class="num" id="1586929">0</span>&nbsp;<span class="op" id="1586931">&amp;&amp;</span>&nbsp;<span class="ident" id="1586934"><a href="/gostd/runtime/lock_futex.go.html#1586819">gp</a></span><span class="op" id="1586936">.</span><span class="ident" id="1586937"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1787541">preempt</a></span>&nbsp;<span class="op" id="1586945">{</span>&nbsp;<span class="comment" id="1586947">//&nbsp;restore&nbsp;the&nbsp;preemption&nbsp;request&nbsp;in&nbsp;case&nbsp;we&#39;ve&nbsp;cleared&nbsp;it&nbsp;in&nbsp;newstack</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587020"><a href="/gostd/runtime/lock_futex.go.html#1586819">gp</a></span><span class="op" id="1587022">.</span><span class="ident" id="1587023"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1787296">stackguard0</a></span>&nbsp;<span class="op" id="1587035">=</span>&nbsp;<span class="ident" id="1587037"><a href="/gostd/runtime/stack.go.html#1731924">stackPreempt</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1587051">}</span><br>
<span class="lineno"></span><span class="op" id="1587053">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1587056">//&nbsp;One-time&nbsp;notifications.</span><br>
<span class="lineno">125</span><span class="keyword" id="1587083">func</span>&nbsp;<span class="ident" id="1587088">noteclear</span><span class="op" id="1587097">(</span><span class="ident" id="1587098">n</span>&nbsp;<span class="op" id="1587100">*</span><span class="ident" id="1587101"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786244">note</a></span><span class="op" id="1587105">)</span>&nbsp;<span class="op" id="1587107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587110"><a href="/gostd/runtime/lock_futex.go.html#1587098">n</a></span><span class="op" id="1587111">.</span><span class="ident" id="1587112"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786259">key</a></span>&nbsp;<span class="op" id="1587116">=</span>&nbsp;<span class="num" id="1587118">0</span><br>
<span class="lineno"></span><span class="op" id="1587120">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1587123">func</span>&nbsp;<span class="ident" id="1587128">notewakeup</span><span class="op" id="1587138">(</span><span class="ident" id="1587139">n</span>&nbsp;<span class="op" id="1587141">*</span><span class="ident" id="1587142"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786244">note</a></span><span class="op" id="1587146">)</span>&nbsp;<span class="op" id="1587148">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587151">old</span>&nbsp;<span class="op" id="1587155">:=</span>&nbsp;<span class="ident" id="1587158"><a href="/gostd/runtime/atomic.go.html#1481066">xchg</a></span><span class="op" id="1587162">(</span><span class="ident" id="1587163"><a href="/gostd/runtime/lock_futex.go.html#1585264">key32</a></span><span class="op" id="1587168">(</span><span class="op" id="1587169">&amp;</span><span class="ident" id="1587170"><a href="/gostd/runtime/lock_futex.go.html#1587139">n</a></span><span class="op" id="1587171">.</span><span class="ident" id="1587172"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786259">key</a></span><span class="op" id="1587175">)</span><span class="op" id="1587176">,</span>&nbsp;<span class="num" id="1587178">1</span><span class="op" id="1587179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1587182">if</span>&nbsp;<span class="ident" id="1587185"><a href="/gostd/runtime/lock_futex.go.html#1587151">old</a></span>&nbsp;<span class="op" id="1587189">!=</span>&nbsp;<span class="num" id="1587192">0</span>&nbsp;<span class="op" id="1587194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1587198">print</span><span class="op" id="1587203">(</span><span class="string" id="1587204">&#34;notewakeup&nbsp;-&nbsp;double&nbsp;wakeup&nbsp;(&#34;</span><span class="op" id="1587234">,</span>&nbsp;<span class="ident" id="1587236"><a href="/gostd/runtime/lock_futex.go.html#1587151">old</a></span><span class="op" id="1587239">,</span>&nbsp;<span class="string" id="1587241">&#34;)\n&#34;</span><span class="op" id="1587246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587250"><a href="/gostd/runtime/panic.go.html#1664327">gothrow</a></span><span class="op" id="1587257">(</span><span class="string" id="1587258">&#34;notewakeup&nbsp;-&nbsp;double&nbsp;wakeup&#34;</span><span class="op" id="1587286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1587289">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587292"><a href="/gostd/runtime/lock_futex.go.html#1585162">futexwakeup</a></span><span class="op" id="1587303">(</span><span class="ident" id="1587304"><a href="/gostd/runtime/lock_futex.go.html#1585264">key32</a></span><span class="op" id="1587309">(</span><span class="op" id="1587310">&amp;</span><span class="ident" id="1587311"><a href="/gostd/runtime/lock_futex.go.html#1587139">n</a></span><span class="op" id="1587312">.</span><span class="ident" id="1587313"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786259">key</a></span><span class="op" id="1587316">)</span><span class="op" id="1587317">,</span>&nbsp;<span class="num" id="1587319">1</span><span class="op" id="1587320">)</span><br>
<span class="lineno"></span><span class="op" id="1587322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1587325">func</span>&nbsp;<span class="ident" id="1587330">notesleep</span><span class="op" id="1587339">(</span><span class="ident" id="1587340">n</span>&nbsp;<span class="op" id="1587342">*</span><span class="ident" id="1587343"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786244">note</a></span><span class="op" id="1587347">)</span>&nbsp;<span class="op" id="1587349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587352">gp</span>&nbsp;<span class="op" id="1587355">:=</span>&nbsp;<span class="ident" id="1587358"><a href="/gostd/runtime/stubs.go.html#1738919">getg</a></span><span class="op" id="1587362">(</span><span class="op" id="1587363">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1587366">if</span>&nbsp;<span class="ident" id="1587369"><a href="/gostd/runtime/lock_futex.go.html#1587352">gp</a></span>&nbsp;<span class="op" id="1587372">!=</span>&nbsp;<span class="ident" id="1587375"><a href="/gostd/runtime/lock_futex.go.html#1587352">gp</a></span><span class="op" id="1587377">.</span><span class="ident" id="1587378"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1787643">m</a></span><span class="op" id="1587379">.</span><span class="ident" id="1587380"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1787822">g0</a></span>&nbsp;<span class="op" id="1587383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587387"><a href="/gostd/runtime/panic.go.html#1664327">gothrow</a></span><span class="op" id="1587394">(</span><span class="string" id="1587395">&#34;notesleep&nbsp;not&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1587416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1587419">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1587422">for</span>&nbsp;<span class="ident" id="1587426"><a href="/gostd/runtime/atomic.go.html#1481330">atomicload</a></span><span class="op" id="1587436">(</span><span class="ident" id="1587437"><a href="/gostd/runtime/lock_futex.go.html#1585264">key32</a></span><span class="op" id="1587442">(</span><span class="op" id="1587443">&amp;</span><span class="ident" id="1587444"><a href="/gostd/runtime/lock_futex.go.html#1587340">n</a></span><span class="op" id="1587445">.</span><span class="ident" id="1587446"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786259">key</a></span><span class="op" id="1587449">)</span><span class="op" id="1587450">)</span>&nbsp;<span class="op" id="1587452">==</span>&nbsp;<span class="num" id="1587455">0</span>&nbsp;<span class="op" id="1587457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587461"><a href="/gostd/runtime/lock_futex.go.html#1587352">gp</a></span><span class="op" id="1587463">.</span><span class="ident" id="1587464"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1787643">m</a></span><span class="op" id="1587465">.</span><span class="ident" id="1587466"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1788096">blocked</a></span>&nbsp;<span class="op" id="1587474">=</span>&nbsp;<span class="builtintype" id="1587476">true</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587483"><a href="/gostd/runtime/lock_futex.go.html#1585110">futexsleep</a></span><span class="op" id="1587493">(</span><span class="ident" id="1587494"><a href="/gostd/runtime/lock_futex.go.html#1585264">key32</a></span><span class="op" id="1587499">(</span><span class="op" id="1587500">&amp;</span><span class="ident" id="1587501"><a href="/gostd/runtime/lock_futex.go.html#1587340">n</a></span><span class="op" id="1587502">.</span><span class="ident" id="1587503"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786259">key</a></span><span class="op" id="1587506">)</span><span class="op" id="1587507">,</span>&nbsp;<span class="num" id="1587509">0</span><span class="op" id="1587510">,</span>&nbsp;<span class="op" id="1587512">-</span><span class="num" id="1587513">1</span><span class="op" id="1587514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587518"><a href="/gostd/runtime/lock_futex.go.html#1587352">gp</a></span><span class="op" id="1587520">.</span><span class="ident" id="1587521"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1787643">m</a></span><span class="op" id="1587522">.</span><span class="ident" id="1587523"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1788096">blocked</a></span>&nbsp;<span class="op" id="1587531">=</span>&nbsp;<span class="builtintype" id="1587533">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1587540">}</span><br>
<span class="lineno"></span><span class="op" id="1587542">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="1587545">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1587558">func</span>&nbsp;<span class="ident" id="1587563">notetsleep_internal</span><span class="op" id="1587582">(</span><span class="ident" id="1587583">n</span>&nbsp;<span class="op" id="1587585">*</span><span class="ident" id="1587586"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786244">note</a></span><span class="op" id="1587590">,</span>&nbsp;<span class="ident" id="1587592">ns</span>&nbsp;<span class="builtintype" id="1587595">int64</span><span class="op" id="1587600">)</span>&nbsp;<span class="builtintype" id="1587602">bool</span>&nbsp;<span class="op" id="1587607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587610">gp</span>&nbsp;<span class="op" id="1587613">:=</span>&nbsp;<span class="ident" id="1587616"><a href="/gostd/runtime/stubs.go.html#1738919">getg</a></span><span class="op" id="1587620">(</span><span class="op" id="1587621">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1587625">if</span>&nbsp;<span class="ident" id="1587628"><a href="/gostd/runtime/lock_futex.go.html#1587592">ns</a></span>&nbsp;<span class="op" id="1587631">&lt;</span>&nbsp;<span class="num" id="1587633">0</span>&nbsp;<span class="op" id="1587635">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1587639">for</span>&nbsp;<span class="ident" id="1587643"><a href="/gostd/runtime/atomic.go.html#1481330">atomicload</a></span><span class="op" id="1587653">(</span><span class="ident" id="1587654"><a href="/gostd/runtime/lock_futex.go.html#1585264">key32</a></span><span class="op" id="1587659">(</span><span class="op" id="1587660">&amp;</span><span class="ident" id="1587661"><a href="/gostd/runtime/lock_futex.go.html#1587583">n</a></span><span class="op" id="1587662">.</span><span class="ident" id="1587663"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786259">key</a></span><span class="op" id="1587666">)</span><span class="op" id="1587667">)</span>&nbsp;<span class="op" id="1587669">==</span>&nbsp;<span class="num" id="1587672">0</span>&nbsp;<span class="op" id="1587674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587679"><a href="/gostd/runtime/lock_futex.go.html#1587610">gp</a></span><span class="op" id="1587681">.</span><span class="ident" id="1587682"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1787643">m</a></span><span class="op" id="1587683">.</span><span class="ident" id="1587684"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1788096">blocked</a></span>&nbsp;<span class="op" id="1587692">=</span>&nbsp;<span class="builtintype" id="1587694">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587702"><a href="/gostd/runtime/lock_futex.go.html#1585110">futexsleep</a></span><span class="op" id="1587712">(</span><span class="ident" id="1587713"><a href="/gostd/runtime/lock_futex.go.html#1585264">key32</a></span><span class="op" id="1587718">(</span><span class="op" id="1587719">&amp;</span><span class="ident" id="1587720"><a href="/gostd/runtime/lock_futex.go.html#1587583">n</a></span><span class="op" id="1587721">.</span><span class="ident" id="1587722"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786259">key</a></span><span class="op" id="1587725">)</span><span class="op" id="1587726">,</span>&nbsp;<span class="num" id="1587728">0</span><span class="op" id="1587729">,</span>&nbsp;<span class="op" id="1587731">-</span><span class="num" id="1587732">1</span><span class="op" id="1587733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587738"><a href="/gostd/runtime/lock_futex.go.html#1587610">gp</a></span><span class="op" id="1587740">.</span><span class="ident" id="1587741"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1787643">m</a></span><span class="op" id="1587742">.</span><span class="ident" id="1587743"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1788096">blocked</a></span>&nbsp;<span class="op" id="1587751">=</span>&nbsp;<span class="builtintype" id="1587753">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1587761">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1587765">return</span>&nbsp;<span class="builtintype" id="1587772">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1587778">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1587782">if</span>&nbsp;<span class="ident" id="1587785"><a href="/gostd/runtime/atomic.go.html#1481330">atomicload</a></span><span class="op" id="1587795">(</span><span class="ident" id="1587796"><a href="/gostd/runtime/lock_futex.go.html#1585264">key32</a></span><span class="op" id="1587801">(</span><span class="op" id="1587802">&amp;</span><span class="ident" id="1587803"><a href="/gostd/runtime/lock_futex.go.html#1587583">n</a></span><span class="op" id="1587804">.</span><span class="ident" id="1587805"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786259">key</a></span><span class="op" id="1587808">)</span><span class="op" id="1587809">)</span>&nbsp;<span class="op" id="1587811">!=</span>&nbsp;<span class="num" id="1587814">0</span>&nbsp;<span class="op" id="1587816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1587820">return</span>&nbsp;<span class="builtintype" id="1587827">true</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1587833">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587837">deadline</span>&nbsp;<span class="op" id="1587846">:=</span>&nbsp;<span class="ident" id="1587849"><a href="/gostd/runtime/stubs.go.html#1743936">nanotime</a></span><span class="op" id="1587857">(</span><span class="op" id="1587858">)</span>&nbsp;<span class="op" id="1587860">+</span>&nbsp;<span class="ident" id="1587862"><a href="/gostd/runtime/lock_futex.go.html#1587592">ns</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1587866">for</span>&nbsp;<span class="op" id="1587870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587874"><a href="/gostd/runtime/lock_futex.go.html#1587610">gp</a></span><span class="op" id="1587876">.</span><span class="ident" id="1587877"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1787643">m</a></span><span class="op" id="1587878">.</span><span class="ident" id="1587879"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1788096">blocked</a></span>&nbsp;<span class="op" id="1587887">=</span>&nbsp;<span class="builtintype" id="1587889">true</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587896"><a href="/gostd/runtime/lock_futex.go.html#1585110">futexsleep</a></span><span class="op" id="1587906">(</span><span class="ident" id="1587907"><a href="/gostd/runtime/lock_futex.go.html#1585264">key32</a></span><span class="op" id="1587912">(</span><span class="op" id="1587913">&amp;</span><span class="ident" id="1587914"><a href="/gostd/runtime/lock_futex.go.html#1587583">n</a></span><span class="op" id="1587915">.</span><span class="ident" id="1587916"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786259">key</a></span><span class="op" id="1587919">)</span><span class="op" id="1587920">,</span>&nbsp;<span class="num" id="1587922">0</span><span class="op" id="1587923">,</span>&nbsp;<span class="ident" id="1587925"><a href="/gostd/runtime/lock_futex.go.html#1587592">ns</a></span><span class="op" id="1587927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587931"><a href="/gostd/runtime/lock_futex.go.html#1587610">gp</a></span><span class="op" id="1587933">.</span><span class="ident" id="1587934"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1787643">m</a></span><span class="op" id="1587935">.</span><span class="ident" id="1587936"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1788096">blocked</a></span>&nbsp;<span class="op" id="1587944">=</span>&nbsp;<span class="builtintype" id="1587946">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1587954">if</span>&nbsp;<span class="ident" id="1587957"><a href="/gostd/runtime/atomic.go.html#1481330">atomicload</a></span><span class="op" id="1587967">(</span><span class="ident" id="1587968"><a href="/gostd/runtime/lock_futex.go.html#1585264">key32</a></span><span class="op" id="1587973">(</span><span class="op" id="1587974">&amp;</span><span class="ident" id="1587975"><a href="/gostd/runtime/lock_futex.go.html#1587583">n</a></span><span class="op" id="1587976">.</span><span class="ident" id="1587977"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786259">key</a></span><span class="op" id="1587980">)</span><span class="op" id="1587981">)</span>&nbsp;<span class="op" id="1587983">!=</span>&nbsp;<span class="num" id="1587986">0</span>&nbsp;<span class="op" id="1587988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1587993">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1588001">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588005">now</span>&nbsp;<span class="op" id="1588009">:=</span>&nbsp;<span class="ident" id="1588012"><a href="/gostd/runtime/stubs.go.html#1743936">nanotime</a></span><span class="op" id="1588020">(</span><span class="op" id="1588021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1588025">if</span>&nbsp;<span class="ident" id="1588028"><a href="/gostd/runtime/lock_futex.go.html#1588005">now</a></span>&nbsp;<span class="op" id="1588032">&gt;=</span>&nbsp;<span class="ident" id="1588035"><a href="/gostd/runtime/lock_futex.go.html#1587837">deadline</a></span>&nbsp;<span class="op" id="1588044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1588049">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1588057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588061"><a href="/gostd/runtime/lock_futex.go.html#1587592">ns</a></span>&nbsp;<span class="op" id="1588064">=</span>&nbsp;<span class="ident" id="1588066"><a href="/gostd/runtime/lock_futex.go.html#1587837">deadline</a></span>&nbsp;<span class="op" id="1588075">-</span>&nbsp;<span class="ident" id="1588077"><a href="/gostd/runtime/lock_futex.go.html#1588005">now</a></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1588082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1588085">return</span>&nbsp;<span class="ident" id="1588092"><a href="/gostd/runtime/atomic.go.html#1481330">atomicload</a></span><span class="op" id="1588102">(</span><span class="ident" id="1588103"><a href="/gostd/runtime/lock_futex.go.html#1585264">key32</a></span><span class="op" id="1588108">(</span><span class="op" id="1588109">&amp;</span><span class="ident" id="1588110"><a href="/gostd/runtime/lock_futex.go.html#1587583">n</a></span><span class="op" id="1588111">.</span><span class="ident" id="1588112"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786259">key</a></span><span class="op" id="1588115">)</span><span class="op" id="1588116">)</span>&nbsp;<span class="op" id="1588118">!=</span>&nbsp;<span class="num" id="1588121">0</span><br>
<span class="lineno"></span><span class="op" id="1588123">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1588126">func</span>&nbsp;<span class="ident" id="1588131">notetsleep</span><span class="op" id="1588141">(</span><span class="ident" id="1588142">n</span>&nbsp;<span class="op" id="1588144">*</span><span class="ident" id="1588145"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786244">note</a></span><span class="op" id="1588149">,</span>&nbsp;<span class="ident" id="1588151">ns</span>&nbsp;<span class="builtintype" id="1588154">int64</span><span class="op" id="1588159">)</span>&nbsp;<span class="builtintype" id="1588161">bool</span>&nbsp;<span class="op" id="1588166">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588169">gp</span>&nbsp;<span class="op" id="1588172">:=</span>&nbsp;<span class="ident" id="1588175"><a href="/gostd/runtime/stubs.go.html#1738919">getg</a></span><span class="op" id="1588179">(</span><span class="op" id="1588180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1588183">if</span>&nbsp;<span class="ident" id="1588186"><a href="/gostd/runtime/lock_futex.go.html#1588169">gp</a></span>&nbsp;<span class="op" id="1588189">!=</span>&nbsp;<span class="ident" id="1588192"><a href="/gostd/runtime/lock_futex.go.html#1588169">gp</a></span><span class="op" id="1588194">.</span><span class="ident" id="1588195"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1787643">m</a></span><span class="op" id="1588196">.</span><span class="ident" id="1588197"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1787822">g0</a></span>&nbsp;<span class="op" id="1588200">&amp;&amp;</span>&nbsp;<span class="ident" id="1588203"><a href="/gostd/runtime/lock_futex.go.html#1588169">gp</a></span><span class="op" id="1588205">.</span><span class="ident" id="1588206"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1787643">m</a></span><span class="op" id="1588207">.</span><span class="ident" id="1588208"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1787994">gcing</a></span>&nbsp;<span class="op" id="1588214">==</span>&nbsp;<span class="num" id="1588217">0</span>&nbsp;<span class="op" id="1588219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588223"><a href="/gostd/runtime/panic.go.html#1664327">gothrow</a></span><span class="op" id="1588230">(</span><span class="string" id="1588231">&#34;notetsleep&nbsp;not&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1588253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1588256">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1588260">return</span>&nbsp;<span class="ident" id="1588267"><a href="/gostd/runtime/lock_futex.go.html#1587563">notetsleep_internal</a></span><span class="op" id="1588286">(</span><span class="ident" id="1588287"><a href="/gostd/runtime/lock_futex.go.html#1588142">n</a></span><span class="op" id="1588288">,</span>&nbsp;<span class="ident" id="1588290"><a href="/gostd/runtime/lock_futex.go.html#1588151">ns</a></span><span class="op" id="1588292">)</span><br>
<span class="lineno"></span><span class="op" id="1588294">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1588297">//&nbsp;same&nbsp;as&nbsp;runtime路notetsleep,&nbsp;but&nbsp;called&nbsp;on&nbsp;user&nbsp;g&nbsp;(not&nbsp;g0)</span><br>
<span class="lineno"></span><span class="comment" id="1588359">//&nbsp;calls&nbsp;only&nbsp;nosplit&nbsp;functions&nbsp;between&nbsp;entersyscallblock/exitsyscall</span><br>
<span class="lineno">195</span><span class="keyword" id="1588429">func</span>&nbsp;<span class="ident" id="1588434">notetsleepg</span><span class="op" id="1588445">(</span><span class="ident" id="1588446">n</span>&nbsp;<span class="op" id="1588448">*</span><span class="ident" id="1588449"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786244">note</a></span><span class="op" id="1588453">,</span>&nbsp;<span class="ident" id="1588455">ns</span>&nbsp;<span class="builtintype" id="1588458">int64</span><span class="op" id="1588463">)</span>&nbsp;<span class="builtintype" id="1588465">bool</span>&nbsp;<span class="op" id="1588470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588473">gp</span>&nbsp;<span class="op" id="1588476">:=</span>&nbsp;<span class="ident" id="1588479"><a href="/gostd/runtime/stubs.go.html#1738919">getg</a></span><span class="op" id="1588483">(</span><span class="op" id="1588484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1588487">if</span>&nbsp;<span class="ident" id="1588490"><a href="/gostd/runtime/lock_futex.go.html#1588473">gp</a></span>&nbsp;<span class="op" id="1588493">==</span>&nbsp;<span class="ident" id="1588496"><a href="/gostd/runtime/lock_futex.go.html#1588473">gp</a></span><span class="op" id="1588498">.</span><span class="ident" id="1588499"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1787643">m</a></span><span class="op" id="1588500">.</span><span class="ident" id="1588501"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1787822">g0</a></span>&nbsp;<span class="op" id="1588504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588508"><a href="/gostd/runtime/panic.go.html#1664327">gothrow</a></span><span class="op" id="1588515">(</span><span class="string" id="1588516">&#34;notetsleepg&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1588535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1588538">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588542"><a href="/gostd/runtime/stubs.go.html#1743490">entersyscallblock</a></span><span class="op" id="1588559">(</span><span class="op" id="1588560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588563">ok</span>&nbsp;<span class="op" id="1588566">:=</span>&nbsp;<span class="ident" id="1588569"><a href="/gostd/runtime/lock_futex.go.html#1587563">notetsleep_internal</a></span><span class="op" id="1588588">(</span><span class="ident" id="1588589"><a href="/gostd/runtime/lock_futex.go.html#1588446">n</a></span><span class="op" id="1588590">,</span>&nbsp;<span class="ident" id="1588592"><a href="/gostd/runtime/lock_futex.go.html#1588455">ns</a></span><span class="op" id="1588594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588597"><a href="/gostd/runtime/stubs.go.html#1743515">exitsyscall</a></span><span class="op" id="1588608">(</span><span class="op" id="1588609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1588612">return</span>&nbsp;<span class="ident" id="1588619"><a href="/gostd/runtime/lock_futex.go.html#1588563">ok</a></span><br>
<span class="lineno">205</span><span class="op" id="1588622">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
