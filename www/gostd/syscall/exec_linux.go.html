<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>syscall</h2>
<ul>
<li><a href="/gostd/syscall/creds_test.go.html">creds_test.go</a></li>
<li><a href="/gostd/syscall/env_unix.go.html">env_unix.go</a></li>
<li><a href="/gostd/syscall/exec_linux.go.html">exec_linux.go</a></li>
<li><a href="/gostd/syscall/exec_unix.go.html">exec_unix.go</a></li>
<li><a href="/gostd/syscall/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/syscall/flock.go.html">flock.go</a></li>
<li><a href="/gostd/syscall/lsf_linux.go.html">lsf_linux.go</a></li>
<li><a href="/gostd/syscall/mmap_unix_test.go.html">mmap_unix_test.go</a></li>
<li><a href="/gostd/syscall/netlink_linux.go.html">netlink_linux.go</a></li>
<li><a href="/gostd/syscall/race0.go.html">race0.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_linux.go.html">sockcmsg_linux.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_unix.go.html">sockcmsg_unix.go</a></li>
<li><a href="/gostd/syscall/str.go.html">str.go</a></li>
<li><a href="/gostd/syscall/syscall.go.html">syscall.go</a></li>
<li><a href="/gostd/syscall/syscall_linux.go.html">syscall_linux.go</a></li>
<li><a href="/gostd/syscall/syscall_linux_amd64.go.html">syscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/syscall_test.go.html">syscall_test.go</a></li>
<li><a href="/gostd/syscall/syscall_unix.go.html">syscall_unix.go</a></li>
<li><a href="/gostd/syscall/syscall_unix_test.go.html">syscall_unix_test.go</a></li>
<li><a href="/gostd/syscall/zerrors_linux_amd64.go.html">zerrors_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsyscall_linux_amd64.go.html">zsyscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsysnum_linux_amd64.go.html">zsysnum_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/ztypes_linux_amd64.go.html">ztypes_linux_amd64.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2362555">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2362610">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2362664">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2362715">//&nbsp;+build&nbsp;linux</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2362732">package</span>&nbsp;<span class="ident" id="2362740">syscall</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2362749">import</span>&nbsp;<span class="op" id="2362756">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2362759">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="2362768">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2362771">//&nbsp;SysProcIDMap&nbsp;holds&nbsp;Container&nbsp;ID&nbsp;to&nbsp;Host&nbsp;ID&nbsp;mappings&nbsp;used&nbsp;for&nbsp;User&nbsp;Namespaces&nbsp;in&nbsp;Linux.</span><br>
<span class="lineno"></span><span class="comment" id="2362861">//&nbsp;See&nbsp;user_namespaces(7).</span><br>
<span class="lineno">15</span><span class="keyword" id="2362888">type</span>&nbsp;<span class="ident" id="2362893">SysProcIDMap</span>&nbsp;<span class="keyword" id="2362906">struct</span>&nbsp;<span class="op" id="2362913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2362916">ContainerID</span>&nbsp;<span class="builtintype" id="2362928">int</span>&nbsp;<span class="comment" id="2362932">//&nbsp;Container&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2362950">HostID</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2362962">int</span>&nbsp;<span class="comment" id="2362966">//&nbsp;Host&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2362979">Size</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2362991">int</span>&nbsp;<span class="comment" id="2362995">//&nbsp;Size.</span><br>
<span class="lineno"></span><span class="op" id="2363004">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="2363007">type</span>&nbsp;<span class="ident" id="2363012">SysProcAttr</span>&nbsp;<span class="keyword" id="2363024">struct</span>&nbsp;<span class="op" id="2363031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2363034">Chroot</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2363046">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2363061">//&nbsp;Chroot.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2363073">Credential</span>&nbsp;&nbsp;<span class="op" id="2363085">*</span><span class="ident" id="2363086">Credential</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2363100">//&nbsp;Credential.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2363116">Ptrace</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2363128">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2363143">//&nbsp;Enable&nbsp;tracing.</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2363163">Setsid</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2363175">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2363190">//&nbsp;Create&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2363210">Setpgid</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2363222">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2363237">//&nbsp;Set&nbsp;process&nbsp;group&nbsp;ID&nbsp;to&nbsp;new&nbsp;pid&nbsp;(SYSV&nbsp;setpgrp)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2363288">Setctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2363300">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2363315">//&nbsp;Set&nbsp;controlling&nbsp;terminal&nbsp;to&nbsp;fd&nbsp;Ctty&nbsp;(only&nbsp;meaningful&nbsp;if&nbsp;Setsid&nbsp;is&nbsp;set)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2363390">Noctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2363402">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2363417">//&nbsp;Detach&nbsp;fd&nbsp;0&nbsp;from&nbsp;controlling&nbsp;terminal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2363459">Ctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2363471">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2363486">//&nbsp;Controlling&nbsp;TTY&nbsp;fd&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2363522">Pdeathsig</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2363534">Signal</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2363549">//&nbsp;Signal&nbsp;that&nbsp;the&nbsp;process&nbsp;will&nbsp;get&nbsp;when&nbsp;its&nbsp;parent&nbsp;dies&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2363620">Cloneflags</span>&nbsp;&nbsp;<span class="builtintype" id="2363632">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2363647">//&nbsp;Flags&nbsp;for&nbsp;clone&nbsp;calls&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2363686">UidMappings</span>&nbsp;<span class="op" id="2363698">[</span><span class="op" id="2363699">]</span><span class="ident" id="2363700">SysProcIDMap</span>&nbsp;<span class="comment" id="2363713">//&nbsp;User&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2363755">GidMappings</span>&nbsp;<span class="op" id="2363767">[</span><span class="op" id="2363768">]</span><span class="ident" id="2363769">SysProcIDMap</span>&nbsp;<span class="comment" id="2363782">//&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces.</span><br>
<span class="lineno"></span><span class="op" id="2363824">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="2363827">//&nbsp;Implemented&nbsp;in&nbsp;runtime&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="2363862">func</span>&nbsp;<span class="ident" id="2363867">runtime_BeforeFork</span><span class="op" id="2363885">(</span><span class="op" id="2363886">)</span><br>
<span class="lineno"></span><span class="keyword" id="2363888">func</span>&nbsp;<span class="ident" id="2363893">runtime_AfterFork</span><span class="op" id="2363910">(</span><span class="op" id="2363911">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="2363914">//&nbsp;Fork,&nbsp;dup&nbsp;fd&nbsp;onto&nbsp;0..len(fd),&nbsp;and&nbsp;exec(argv0,&nbsp;argvv,&nbsp;envv)&nbsp;in&nbsp;child.</span><br>
<span class="lineno"></span><span class="comment" id="2363986">//&nbsp;If&nbsp;a&nbsp;dup&nbsp;or&nbsp;exec&nbsp;fails,&nbsp;write&nbsp;the&nbsp;errno&nbsp;error&nbsp;to&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="comment" id="2364044">//&nbsp;(Pipe&nbsp;is&nbsp;close-on-exec&nbsp;so&nbsp;if&nbsp;exec&nbsp;succeeds,&nbsp;it&nbsp;will&nbsp;be&nbsp;closed.)</span><br>
<span class="lineno"></span><span class="comment" id="2364111">//&nbsp;In&nbsp;the&nbsp;child,&nbsp;this&nbsp;function&nbsp;must&nbsp;not&nbsp;acquire&nbsp;any&nbsp;locks,&nbsp;because</span><br>
<span class="lineno"></span><span class="comment" id="2364178">//&nbsp;they&nbsp;might&nbsp;have&nbsp;been&nbsp;locked&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;the&nbsp;fork.&nbsp;&nbsp;This&nbsp;means</span><br>
<span class="lineno">45</span><span class="comment" id="2364246">//&nbsp;no&nbsp;rescheduling,&nbsp;no&nbsp;malloc&nbsp;calls,&nbsp;and&nbsp;no&nbsp;new&nbsp;stack&nbsp;segments.</span><br>
<span class="lineno"></span><span class="comment" id="2364310">//&nbsp;For&nbsp;the&nbsp;same&nbsp;reason&nbsp;compiler&nbsp;does&nbsp;not&nbsp;race&nbsp;instrument&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="2364371">//&nbsp;The&nbsp;calls&nbsp;to&nbsp;RawSyscall&nbsp;are&nbsp;okay&nbsp;because&nbsp;they&nbsp;are&nbsp;assembly</span><br>
<span class="lineno"></span><span class="comment" id="2364433">//&nbsp;functions&nbsp;that&nbsp;do&nbsp;not&nbsp;grow&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="2364474">func</span>&nbsp;<span class="ident" id="2364479">forkAndExecInChild</span><span class="op" id="2364497">(</span><span class="ident" id="2364498">argv0</span>&nbsp;<span class="op" id="2364504">*</span><span class="builtintype" id="2364505">byte</span><span class="op" id="2364509">,</span>&nbsp;<span class="ident" id="2364511">argv</span><span class="op" id="2364515">,</span>&nbsp;<span class="ident" id="2364517">envv</span>&nbsp;<span class="op" id="2364522">[</span><span class="op" id="2364523">]</span><span class="op" id="2364524">*</span><span class="builtintype" id="2364525">byte</span><span class="op" id="2364529">,</span>&nbsp;<span class="ident" id="2364531">chroot</span><span class="op" id="2364537">,</span>&nbsp;<span class="ident" id="2364539">dir</span>&nbsp;<span class="op" id="2364543">*</span><span class="builtintype" id="2364544">byte</span><span class="op" id="2364548">,</span>&nbsp;<span class="ident" id="2364550">attr</span>&nbsp;<span class="op" id="2364555">*</span><span class="ident" id="2364556">ProcAttr</span><span class="op" id="2364564">,</span>&nbsp;<span class="ident" id="2364566">sys</span>&nbsp;<span class="op" id="2364570">*</span><span class="ident" id="2364571">SysProcAttr</span><span class="op" id="2364582">,</span>&nbsp;<span class="ident" id="2364584">pipe</span>&nbsp;<span class="builtintype" id="2364589">int</span><span class="op" id="2364592">)</span>&nbsp;<span class="op" id="2364594">(</span><span class="ident" id="2364595">pid</span>&nbsp;<span class="builtintype" id="2364599">int</span><span class="op" id="2364602">,</span>&nbsp;<span class="ident" id="2364604">err</span>&nbsp;<span class="ident" id="2364608">Errno</span><span class="op" id="2364613">)</span>&nbsp;<span class="op" id="2364615">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2364618">//&nbsp;Declare&nbsp;all&nbsp;variables&nbsp;at&nbsp;top&nbsp;in&nbsp;case&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2364663">//&nbsp;declarations&nbsp;require&nbsp;heap&nbsp;allocation&nbsp;(e.g.,&nbsp;err1).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2364718">var</span>&nbsp;<span class="op" id="2364722">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2364726">r1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2364733">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2364743">err1</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2364750">Errno</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2364758">err2</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2364765">Errno</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2364773">nextfd</span>&nbsp;<span class="builtintype" id="2364780">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2364786">i</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2364793">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2364799">p</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2364806">[</span><span class="num" id="2364807">2</span><span class="op" id="2364808">]</span><span class="builtintype" id="2364809">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2364814">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2364818">//&nbsp;Guard&nbsp;against&nbsp;side&nbsp;effects&nbsp;of&nbsp;shuffling&nbsp;fds&nbsp;below.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2364873">//&nbsp;Make&nbsp;sure&nbsp;that&nbsp;nextfd&nbsp;is&nbsp;beyond&nbsp;any&nbsp;currently&nbsp;open&nbsp;files&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2364937">//&nbsp;that&nbsp;we&nbsp;can&#39;t&nbsp;run&nbsp;the&nbsp;risk&nbsp;of&nbsp;overwriting&nbsp;any&nbsp;of&nbsp;them.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2364996">fd</span>&nbsp;<span class="op" id="2364999">:=</span>&nbsp;<span class="builtinfunc" id="2365002">make</span><span class="op" id="2365006">(</span><span class="op" id="2365007">[</span><span class="op" id="2365008">]</span><span class="builtintype" id="2365009">int</span><span class="op" id="2365012">,</span>&nbsp;<span class="builtinfunc" id="2365014">len</span><span class="op" id="2365017">(</span><span class="ident" id="2365018">attr</span><span class="op" id="2365022">.</span><span class="ident" id="2365023">Files</span><span class="op" id="2365028">)</span><span class="op" id="2365029">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2365032">nextfd</span>&nbsp;<span class="op" id="2365039">=</span>&nbsp;<span class="builtinfunc" id="2365041">len</span><span class="op" id="2365044">(</span><span class="ident" id="2365045">attr</span><span class="op" id="2365049">.</span><span class="ident" id="2365050">Files</span><span class="op" id="2365055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2365058">for</span>&nbsp;<span class="ident" id="2365062">i</span><span class="op" id="2365063">,</span>&nbsp;<span class="ident" id="2365065">ufd</span>&nbsp;<span class="op" id="2365069">:=</span>&nbsp;<span class="keyword" id="2365072">range</span>&nbsp;<span class="ident" id="2365078">attr</span><span class="op" id="2365082">.</span><span class="ident" id="2365083">Files</span>&nbsp;<span class="op" id="2365089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2365093">if</span>&nbsp;<span class="ident" id="2365096">nextfd</span>&nbsp;<span class="op" id="2365103">&lt;</span>&nbsp;<span class="builtintype" id="2365105">int</span><span class="op" id="2365108">(</span><span class="ident" id="2365109">ufd</span><span class="op" id="2365112">)</span>&nbsp;<span class="op" id="2365114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2365119">nextfd</span>&nbsp;<span class="op" id="2365126">=</span>&nbsp;<span class="builtintype" id="2365128">int</span><span class="op" id="2365131">(</span><span class="ident" id="2365132">ufd</span><span class="op" id="2365135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2365139">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2365143">fd</span><span class="op" id="2365145">[</span><span class="ident" id="2365146">i</span><span class="op" id="2365147">]</span>&nbsp;<span class="op" id="2365149">=</span>&nbsp;<span class="builtintype" id="2365151">int</span><span class="op" id="2365154">(</span><span class="ident" id="2365155">ufd</span><span class="op" id="2365158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2365161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2365164">nextfd</span><span class="op" id="2365170">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2365175">//&nbsp;Allocate&nbsp;another&nbsp;pipe&nbsp;for&nbsp;parent&nbsp;to&nbsp;child&nbsp;communication&nbsp;for</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2365239">//&nbsp;synchronizing&nbsp;writing&nbsp;of&nbsp;User&nbsp;ID/Group&nbsp;ID&nbsp;mappings.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2365295">if</span>&nbsp;<span class="ident" id="2365298">sys</span><span class="op" id="2365301">.</span><span class="ident" id="2365302">UidMappings</span>&nbsp;<span class="op" id="2365314">!=</span>&nbsp;<span class="ident" id="2365317">nil</span>&nbsp;<span class="op" id="2365321">||</span>&nbsp;<span class="ident" id="2365324">sys</span><span class="op" id="2365327">.</span><span class="ident" id="2365328">GidMappings</span>&nbsp;<span class="op" id="2365340">!=</span>&nbsp;<span class="ident" id="2365343">nil</span>&nbsp;<span class="op" id="2365347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2365351">if</span>&nbsp;<span class="ident" id="2365354">err</span>&nbsp;<span class="op" id="2365358">:=</span>&nbsp;<span class="ident" id="2365361">forkExecPipe</span><span class="op" id="2365373">(</span><span class="ident" id="2365374">p</span><span class="op" id="2365375">[</span><span class="op" id="2365376">:</span><span class="op" id="2365377">]</span><span class="op" id="2365378">)</span><span class="op" id="2365379">;</span>&nbsp;<span class="ident" id="2365381">err</span>&nbsp;<span class="op" id="2365385">!=</span>&nbsp;<span class="ident" id="2365388">nil</span>&nbsp;<span class="op" id="2365392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2365397">return</span>&nbsp;<span class="num" id="2365404">0</span><span class="op" id="2365405">,</span>&nbsp;<span class="ident" id="2365407">err</span><span class="op" id="2365410">.</span><span class="op" id="2365411">(</span><span class="ident" id="2365412">Errno</span><span class="op" id="2365417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2365421">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2365424">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2365428">//&nbsp;About&nbsp;to&nbsp;call&nbsp;fork.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2365452">//&nbsp;No&nbsp;more&nbsp;allocation&nbsp;or&nbsp;calls&nbsp;of&nbsp;non-assembly&nbsp;functions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2365511">runtime_BeforeFork</span><span class="op" id="2365529">(</span><span class="op" id="2365530">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2365533">r1</span><span class="op" id="2365535">,</span>&nbsp;<span class="ident" id="2365537">_</span><span class="op" id="2365538">,</span>&nbsp;<span class="ident" id="2365540">err1</span>&nbsp;<span class="op" id="2365545">=</span>&nbsp;<span class="ident" id="2365547">RawSyscall6</span><span class="op" id="2365558">(</span><span class="ident" id="2365559">SYS_CLONE</span><span class="op" id="2365568">,</span>&nbsp;<span class="builtintype" id="2365570">uintptr</span><span class="op" id="2365577">(</span><span class="ident" id="2365578">SIGCHLD</span><span class="op" id="2365585">)</span><span class="op" id="2365586">|</span><span class="ident" id="2365587">sys</span><span class="op" id="2365590">.</span><span class="ident" id="2365591">Cloneflags</span><span class="op" id="2365601">,</span>&nbsp;<span class="num" id="2365603">0</span><span class="op" id="2365604">,</span>&nbsp;<span class="num" id="2365606">0</span><span class="op" id="2365607">,</span>&nbsp;<span class="num" id="2365609">0</span><span class="op" id="2365610">,</span>&nbsp;<span class="num" id="2365612">0</span><span class="op" id="2365613">,</span>&nbsp;<span class="num" id="2365615">0</span><span class="op" id="2365616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2365619">if</span>&nbsp;<span class="ident" id="2365622">err1</span>&nbsp;<span class="op" id="2365627">!=</span>&nbsp;<span class="num" id="2365630">0</span>&nbsp;<span class="op" id="2365632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2365636">runtime_AfterFork</span><span class="op" id="2365653">(</span><span class="op" id="2365654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2365658">return</span>&nbsp;<span class="num" id="2365665">0</span><span class="op" id="2365666">,</span>&nbsp;<span class="ident" id="2365668">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2365674">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2365678">if</span>&nbsp;<span class="ident" id="2365681">r1</span>&nbsp;<span class="op" id="2365684">!=</span>&nbsp;<span class="num" id="2365687">0</span>&nbsp;<span class="op" id="2365689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2365693">//&nbsp;parent;&nbsp;return&nbsp;PID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2365717">runtime_AfterFork</span><span class="op" id="2365734">(</span><span class="op" id="2365735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2365739">pid</span>&nbsp;<span class="op" id="2365743">=</span>&nbsp;<span class="builtintype" id="2365745">int</span><span class="op" id="2365748">(</span><span class="ident" id="2365749">r1</span><span class="op" id="2365751">)</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2365756">if</span>&nbsp;<span class="ident" id="2365759">sys</span><span class="op" id="2365762">.</span><span class="ident" id="2365763">UidMappings</span>&nbsp;<span class="op" id="2365775">!=</span>&nbsp;<span class="ident" id="2365778">nil</span>&nbsp;<span class="op" id="2365782">||</span>&nbsp;<span class="ident" id="2365785">sys</span><span class="op" id="2365788">.</span><span class="ident" id="2365789">GidMappings</span>&nbsp;<span class="op" id="2365801">!=</span>&nbsp;<span class="ident" id="2365804">nil</span>&nbsp;<span class="op" id="2365808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2365813">Close</span><span class="op" id="2365818">(</span><span class="ident" id="2365819">p</span><span class="op" id="2365820">[</span><span class="num" id="2365821">0</span><span class="op" id="2365822">]</span><span class="op" id="2365823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2365828">err</span>&nbsp;<span class="op" id="2365832">:=</span>&nbsp;<span class="ident" id="2365835">writeUidGidMappings</span><span class="op" id="2365854">(</span><span class="ident" id="2365855">pid</span><span class="op" id="2365858">,</span>&nbsp;<span class="ident" id="2365860">sys</span><span class="op" id="2365863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2365868">if</span>&nbsp;<span class="ident" id="2365871">err</span>&nbsp;<span class="op" id="2365875">!=</span>&nbsp;<span class="ident" id="2365878">nil</span>&nbsp;<span class="op" id="2365882">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2365888">err2</span>&nbsp;<span class="op" id="2365893">=</span>&nbsp;<span class="ident" id="2365895">err</span><span class="op" id="2365898">.</span><span class="op" id="2365899">(</span><span class="ident" id="2365900">Errno</span><span class="op" id="2365905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2365910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2365915">RawSyscall</span><span class="op" id="2365925">(</span><span class="ident" id="2365926">SYS_WRITE</span><span class="op" id="2365935">,</span>&nbsp;<span class="builtintype" id="2365937">uintptr</span><span class="op" id="2365944">(</span><span class="ident" id="2365945">p</span><span class="op" id="2365946">[</span><span class="num" id="2365947">1</span><span class="op" id="2365948">]</span><span class="op" id="2365949">)</span><span class="op" id="2365950">,</span>&nbsp;<span class="builtintype" id="2365952">uintptr</span><span class="op" id="2365959">(</span><span class="ident" id="2365960">unsafe</span><span class="op" id="2365966">.</span><span class="ident" id="2365967">Pointer</span><span class="op" id="2365974">(</span><span class="op" id="2365975">&amp;</span><span class="ident" id="2365976">err2</span><span class="op" id="2365980">)</span><span class="op" id="2365981">)</span><span class="op" id="2365982">,</span>&nbsp;<span class="ident" id="2365984">unsafe</span><span class="op" id="2365990">.</span><span class="ident" id="2365991">Sizeof</span><span class="op" id="2365997">(</span><span class="ident" id="2365998">err2</span><span class="op" id="2366002">)</span><span class="op" id="2366003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2366008">Close</span><span class="op" id="2366013">(</span><span class="ident" id="2366014">p</span><span class="op" id="2366015">[</span><span class="num" id="2366016">1</span><span class="op" id="2366017">]</span><span class="op" id="2366018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2366022">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2366027">return</span>&nbsp;<span class="ident" id="2366034">pid</span><span class="op" id="2366037">,</span>&nbsp;<span class="num" id="2366039">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2366042">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2366046">//&nbsp;Fork&nbsp;succeeded,&nbsp;now&nbsp;in&nbsp;child.</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2366081">//&nbsp;Wait&nbsp;for&nbsp;User&nbsp;ID/Group&nbsp;ID&nbsp;mappings&nbsp;to&nbsp;be&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2366135">if</span>&nbsp;<span class="ident" id="2366138">sys</span><span class="op" id="2366141">.</span><span class="ident" id="2366142">UidMappings</span>&nbsp;<span class="op" id="2366154">!=</span>&nbsp;<span class="ident" id="2366157">nil</span>&nbsp;<span class="op" id="2366161">||</span>&nbsp;<span class="ident" id="2366164">sys</span><span class="op" id="2366167">.</span><span class="ident" id="2366168">GidMappings</span>&nbsp;<span class="op" id="2366180">!=</span>&nbsp;<span class="ident" id="2366183">nil</span>&nbsp;<span class="op" id="2366187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2366191">if</span>&nbsp;<span class="ident" id="2366194">_</span><span class="op" id="2366195">,</span>&nbsp;<span class="ident" id="2366197">_</span><span class="op" id="2366198">,</span>&nbsp;<span class="ident" id="2366200">err1</span>&nbsp;<span class="op" id="2366205">=</span>&nbsp;<span class="ident" id="2366207">RawSyscall</span><span class="op" id="2366217">(</span><span class="ident" id="2366218">SYS_CLOSE</span><span class="op" id="2366227">,</span>&nbsp;<span class="builtintype" id="2366229">uintptr</span><span class="op" id="2366236">(</span><span class="ident" id="2366237">p</span><span class="op" id="2366238">[</span><span class="num" id="2366239">1</span><span class="op" id="2366240">]</span><span class="op" id="2366241">)</span><span class="op" id="2366242">,</span>&nbsp;<span class="num" id="2366244">0</span><span class="op" id="2366245">,</span>&nbsp;<span class="num" id="2366247">0</span><span class="op" id="2366248">)</span><span class="op" id="2366249">;</span>&nbsp;<span class="ident" id="2366251">err1</span>&nbsp;<span class="op" id="2366256">!=</span>&nbsp;<span class="num" id="2366259">0</span>&nbsp;<span class="op" id="2366261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2366266">goto</span>&nbsp;<span class="ident" id="2366271">childerror</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2366284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2366288">r1</span><span class="op" id="2366290">,</span>&nbsp;<span class="ident" id="2366292">_</span><span class="op" id="2366293">,</span>&nbsp;<span class="ident" id="2366295">err1</span>&nbsp;<span class="op" id="2366300">=</span>&nbsp;<span class="ident" id="2366302">RawSyscall</span><span class="op" id="2366312">(</span><span class="ident" id="2366313">SYS_READ</span><span class="op" id="2366321">,</span>&nbsp;<span class="builtintype" id="2366323">uintptr</span><span class="op" id="2366330">(</span><span class="ident" id="2366331">p</span><span class="op" id="2366332">[</span><span class="num" id="2366333">0</span><span class="op" id="2366334">]</span><span class="op" id="2366335">)</span><span class="op" id="2366336">,</span>&nbsp;<span class="builtintype" id="2366338">uintptr</span><span class="op" id="2366345">(</span><span class="ident" id="2366346">unsafe</span><span class="op" id="2366352">.</span><span class="ident" id="2366353">Pointer</span><span class="op" id="2366360">(</span><span class="op" id="2366361">&amp;</span><span class="ident" id="2366362">err2</span><span class="op" id="2366366">)</span><span class="op" id="2366367">)</span><span class="op" id="2366368">,</span>&nbsp;<span class="ident" id="2366370">unsafe</span><span class="op" id="2366376">.</span><span class="ident" id="2366377">Sizeof</span><span class="op" id="2366383">(</span><span class="ident" id="2366384">err2</span><span class="op" id="2366388">)</span><span class="op" id="2366389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2366393">if</span>&nbsp;<span class="ident" id="2366396">err1</span>&nbsp;<span class="op" id="2366401">!=</span>&nbsp;<span class="num" id="2366404">0</span>&nbsp;<span class="op" id="2366406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2366411">goto</span>&nbsp;<span class="ident" id="2366416">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2366429">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2366433">if</span>&nbsp;<span class="ident" id="2366436">r1</span>&nbsp;<span class="op" id="2366439">!=</span>&nbsp;<span class="ident" id="2366442">unsafe</span><span class="op" id="2366448">.</span><span class="ident" id="2366449">Sizeof</span><span class="op" id="2366455">(</span><span class="ident" id="2366456">err2</span><span class="op" id="2366460">)</span>&nbsp;<span class="op" id="2366462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2366467">err1</span>&nbsp;<span class="op" id="2366472">=</span>&nbsp;<span class="ident" id="2366474">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2366484">goto</span>&nbsp;<span class="ident" id="2366489">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2366502">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2366506">if</span>&nbsp;<span class="ident" id="2366509">err2</span>&nbsp;<span class="op" id="2366514">!=</span>&nbsp;<span class="num" id="2366517">0</span>&nbsp;<span class="op" id="2366519">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2366524">err1</span>&nbsp;<span class="op" id="2366529">=</span>&nbsp;<span class="ident" id="2366531">err2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2366539">goto</span>&nbsp;<span class="ident" id="2366544">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2366557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2366560">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2366564">//&nbsp;Parent&nbsp;death&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2366588">if</span>&nbsp;<span class="ident" id="2366591">sys</span><span class="op" id="2366594">.</span><span class="ident" id="2366595">Pdeathsig</span>&nbsp;<span class="op" id="2366605">!=</span>&nbsp;<span class="num" id="2366608">0</span>&nbsp;<span class="op" id="2366610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2366614">_</span><span class="op" id="2366615">,</span>&nbsp;<span class="ident" id="2366617">_</span><span class="op" id="2366618">,</span>&nbsp;<span class="ident" id="2366620">err1</span>&nbsp;<span class="op" id="2366625">=</span>&nbsp;<span class="ident" id="2366627">RawSyscall6</span><span class="op" id="2366638">(</span><span class="ident" id="2366639">SYS_PRCTL</span><span class="op" id="2366648">,</span>&nbsp;<span class="ident" id="2366650">PR_SET_PDEATHSIG</span><span class="op" id="2366666">,</span>&nbsp;<span class="builtintype" id="2366668">uintptr</span><span class="op" id="2366675">(</span><span class="ident" id="2366676">sys</span><span class="op" id="2366679">.</span><span class="ident" id="2366680">Pdeathsig</span><span class="op" id="2366689">)</span><span class="op" id="2366690">,</span>&nbsp;<span class="num" id="2366692">0</span><span class="op" id="2366693">,</span>&nbsp;<span class="num" id="2366695">0</span><span class="op" id="2366696">,</span>&nbsp;<span class="num" id="2366698">0</span><span class="op" id="2366699">,</span>&nbsp;<span class="num" id="2366701">0</span><span class="op" id="2366702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2366706">if</span>&nbsp;<span class="ident" id="2366709">err1</span>&nbsp;<span class="op" id="2366714">!=</span>&nbsp;<span class="num" id="2366717">0</span>&nbsp;<span class="op" id="2366719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2366724">goto</span>&nbsp;<span class="ident" id="2366729">childerror</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2366742">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2366747">//&nbsp;Signal&nbsp;self&nbsp;if&nbsp;parent&nbsp;is&nbsp;already&nbsp;dead.&nbsp;This&nbsp;might&nbsp;cause&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2366810">//&nbsp;duplicate&nbsp;signal&nbsp;in&nbsp;rare&nbsp;cases,&nbsp;but&nbsp;it&nbsp;won&#39;t&nbsp;matter&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2366872">//&nbsp;using&nbsp;SIGKILL.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2366892">r1</span><span class="op" id="2366894">,</span>&nbsp;<span class="ident" id="2366896">_</span><span class="op" id="2366897">,</span>&nbsp;<span class="ident" id="2366899">_</span>&nbsp;<span class="op" id="2366901">=</span>&nbsp;<span class="ident" id="2366903">RawSyscall</span><span class="op" id="2366913">(</span><span class="ident" id="2366914">SYS_GETPPID</span><span class="op" id="2366925">,</span>&nbsp;<span class="num" id="2366927">0</span><span class="op" id="2366928">,</span>&nbsp;<span class="num" id="2366930">0</span><span class="op" id="2366931">,</span>&nbsp;<span class="num" id="2366933">0</span><span class="op" id="2366934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2366938">if</span>&nbsp;<span class="ident" id="2366941">r1</span>&nbsp;<span class="op" id="2366944">==</span>&nbsp;<span class="num" id="2366947">1</span>&nbsp;<span class="op" id="2366949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2366954">pid</span><span class="op" id="2366957">,</span>&nbsp;<span class="ident" id="2366959">_</span><span class="op" id="2366960">,</span>&nbsp;<span class="ident" id="2366962">_</span>&nbsp;<span class="op" id="2366964">:=</span>&nbsp;<span class="ident" id="2366967">RawSyscall</span><span class="op" id="2366977">(</span><span class="ident" id="2366978">SYS_GETPID</span><span class="op" id="2366988">,</span>&nbsp;<span class="num" id="2366990">0</span><span class="op" id="2366991">,</span>&nbsp;<span class="num" id="2366993">0</span><span class="op" id="2366994">,</span>&nbsp;<span class="num" id="2366996">0</span><span class="op" id="2366997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2367002">_</span><span class="op" id="2367003">,</span>&nbsp;<span class="ident" id="2367005">_</span><span class="op" id="2367006">,</span>&nbsp;<span class="ident" id="2367008">err1</span>&nbsp;<span class="op" id="2367013">:=</span>&nbsp;<span class="ident" id="2367016">RawSyscall</span><span class="op" id="2367026">(</span><span class="ident" id="2367027">SYS_KILL</span><span class="op" id="2367035">,</span>&nbsp;<span class="ident" id="2367037">pid</span><span class="op" id="2367040">,</span>&nbsp;<span class="builtintype" id="2367042">uintptr</span><span class="op" id="2367049">(</span><span class="ident" id="2367050">sys</span><span class="op" id="2367053">.</span><span class="ident" id="2367054">Pdeathsig</span><span class="op" id="2367063">)</span><span class="op" id="2367064">,</span>&nbsp;<span class="num" id="2367066">0</span><span class="op" id="2367067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2367072">if</span>&nbsp;<span class="ident" id="2367075">err1</span>&nbsp;<span class="op" id="2367080">!=</span>&nbsp;<span class="num" id="2367083">0</span>&nbsp;<span class="op" id="2367085">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2367091">goto</span>&nbsp;<span class="ident" id="2367096">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2367110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2367114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2367117">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2367121">//&nbsp;Enable&nbsp;tracing&nbsp;if&nbsp;requested.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2367154">if</span>&nbsp;<span class="ident" id="2367157">sys</span><span class="op" id="2367160">.</span><span class="ident" id="2367161">Ptrace</span>&nbsp;<span class="op" id="2367168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2367172">_</span><span class="op" id="2367173">,</span>&nbsp;<span class="ident" id="2367175">_</span><span class="op" id="2367176">,</span>&nbsp;<span class="ident" id="2367178">err1</span>&nbsp;<span class="op" id="2367183">=</span>&nbsp;<span class="ident" id="2367185">RawSyscall</span><span class="op" id="2367195">(</span><span class="ident" id="2367196">SYS_PTRACE</span><span class="op" id="2367206">,</span>&nbsp;<span class="builtintype" id="2367208">uintptr</span><span class="op" id="2367215">(</span><span class="ident" id="2367216">PTRACE_TRACEME</span><span class="op" id="2367230">)</span><span class="op" id="2367231">,</span>&nbsp;<span class="num" id="2367233">0</span><span class="op" id="2367234">,</span>&nbsp;<span class="num" id="2367236">0</span><span class="op" id="2367237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2367241">if</span>&nbsp;<span class="ident" id="2367244">err1</span>&nbsp;<span class="op" id="2367249">!=</span>&nbsp;<span class="num" id="2367252">0</span>&nbsp;<span class="op" id="2367254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2367259">goto</span>&nbsp;<span class="ident" id="2367264">childerror</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2367277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2367280">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2367284">//&nbsp;Session&nbsp;ID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2367299">if</span>&nbsp;<span class="ident" id="2367302">sys</span><span class="op" id="2367305">.</span><span class="ident" id="2367306">Setsid</span>&nbsp;<span class="op" id="2367313">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2367317">_</span><span class="op" id="2367318">,</span>&nbsp;<span class="ident" id="2367320">_</span><span class="op" id="2367321">,</span>&nbsp;<span class="ident" id="2367323">err1</span>&nbsp;<span class="op" id="2367328">=</span>&nbsp;<span class="ident" id="2367330">RawSyscall</span><span class="op" id="2367340">(</span><span class="ident" id="2367341">SYS_SETSID</span><span class="op" id="2367351">,</span>&nbsp;<span class="num" id="2367353">0</span><span class="op" id="2367354">,</span>&nbsp;<span class="num" id="2367356">0</span><span class="op" id="2367357">,</span>&nbsp;<span class="num" id="2367359">0</span><span class="op" id="2367360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2367364">if</span>&nbsp;<span class="ident" id="2367367">err1</span>&nbsp;<span class="op" id="2367372">!=</span>&nbsp;<span class="num" id="2367375">0</span>&nbsp;<span class="op" id="2367377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2367382">goto</span>&nbsp;<span class="ident" id="2367387">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2367400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2367403">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2367407">//&nbsp;Set&nbsp;process&nbsp;group</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2367429">if</span>&nbsp;<span class="ident" id="2367432">sys</span><span class="op" id="2367435">.</span><span class="ident" id="2367436">Setpgid</span>&nbsp;<span class="op" id="2367444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2367448">_</span><span class="op" id="2367449">,</span>&nbsp;<span class="ident" id="2367451">_</span><span class="op" id="2367452">,</span>&nbsp;<span class="ident" id="2367454">err1</span>&nbsp;<span class="op" id="2367459">=</span>&nbsp;<span class="ident" id="2367461">RawSyscall</span><span class="op" id="2367471">(</span><span class="ident" id="2367472">SYS_SETPGID</span><span class="op" id="2367483">,</span>&nbsp;<span class="num" id="2367485">0</span><span class="op" id="2367486">,</span>&nbsp;<span class="num" id="2367488">0</span><span class="op" id="2367489">,</span>&nbsp;<span class="num" id="2367491">0</span><span class="op" id="2367492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2367496">if</span>&nbsp;<span class="ident" id="2367499">err1</span>&nbsp;<span class="op" id="2367504">!=</span>&nbsp;<span class="num" id="2367507">0</span>&nbsp;<span class="op" id="2367509">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2367514">goto</span>&nbsp;<span class="ident" id="2367519">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2367532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2367535">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2367539">//&nbsp;Chroot</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2367550">if</span>&nbsp;<span class="ident" id="2367553">chroot</span>&nbsp;<span class="op" id="2367560">!=</span>&nbsp;<span class="ident" id="2367563">nil</span>&nbsp;<span class="op" id="2367567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2367571">_</span><span class="op" id="2367572">,</span>&nbsp;<span class="ident" id="2367574">_</span><span class="op" id="2367575">,</span>&nbsp;<span class="ident" id="2367577">err1</span>&nbsp;<span class="op" id="2367582">=</span>&nbsp;<span class="ident" id="2367584">RawSyscall</span><span class="op" id="2367594">(</span><span class="ident" id="2367595">SYS_CHROOT</span><span class="op" id="2367605">,</span>&nbsp;<span class="builtintype" id="2367607">uintptr</span><span class="op" id="2367614">(</span><span class="ident" id="2367615">unsafe</span><span class="op" id="2367621">.</span><span class="ident" id="2367622">Pointer</span><span class="op" id="2367629">(</span><span class="ident" id="2367630">chroot</span><span class="op" id="2367636">)</span><span class="op" id="2367637">)</span><span class="op" id="2367638">,</span>&nbsp;<span class="num" id="2367640">0</span><span class="op" id="2367641">,</span>&nbsp;<span class="num" id="2367643">0</span><span class="op" id="2367644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2367648">if</span>&nbsp;<span class="ident" id="2367651">err1</span>&nbsp;<span class="op" id="2367656">!=</span>&nbsp;<span class="num" id="2367659">0</span>&nbsp;<span class="op" id="2367661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2367666">goto</span>&nbsp;<span class="ident" id="2367671">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2367684">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2367687">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2367691">//&nbsp;User&nbsp;and&nbsp;groups</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2367711">if</span>&nbsp;<span class="ident" id="2367714">cred</span>&nbsp;<span class="op" id="2367719">:=</span>&nbsp;<span class="ident" id="2367722">sys</span><span class="op" id="2367725">.</span><span class="ident" id="2367726">Credential</span><span class="op" id="2367736">;</span>&nbsp;<span class="ident" id="2367738">cred</span>&nbsp;<span class="op" id="2367743">!=</span>&nbsp;<span class="ident" id="2367746">nil</span>&nbsp;<span class="op" id="2367750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2367754">ngroups</span>&nbsp;<span class="op" id="2367762">:=</span>&nbsp;<span class="builtintype" id="2367765">uintptr</span><span class="op" id="2367772">(</span><span class="builtinfunc" id="2367773">len</span><span class="op" id="2367776">(</span><span class="ident" id="2367777">cred</span><span class="op" id="2367781">.</span><span class="ident" id="2367782">Groups</span><span class="op" id="2367788">)</span><span class="op" id="2367789">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2367793">var</span>&nbsp;<span class="ident" id="2367797">groups</span>&nbsp;<span class="ident" id="2367804">unsafe</span><span class="op" id="2367810">.</span><span class="ident" id="2367811">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2367821">if</span>&nbsp;<span class="ident" id="2367824">ngroups</span>&nbsp;<span class="op" id="2367832">&gt;</span>&nbsp;<span class="num" id="2367834">0</span>&nbsp;<span class="op" id="2367836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2367841">groups</span>&nbsp;<span class="op" id="2367848">=</span>&nbsp;<span class="ident" id="2367850">unsafe</span><span class="op" id="2367856">.</span><span class="ident" id="2367857">Pointer</span><span class="op" id="2367864">(</span><span class="op" id="2367865">&amp;</span><span class="ident" id="2367866">cred</span><span class="op" id="2367870">.</span><span class="ident" id="2367871">Groups</span><span class="op" id="2367877">[</span><span class="num" id="2367878">0</span><span class="op" id="2367879">]</span><span class="op" id="2367880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2367884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2367888">_</span><span class="op" id="2367889">,</span>&nbsp;<span class="ident" id="2367891">_</span><span class="op" id="2367892">,</span>&nbsp;<span class="ident" id="2367894">err1</span>&nbsp;<span class="op" id="2367899">=</span>&nbsp;<span class="ident" id="2367901">RawSyscall</span><span class="op" id="2367911">(</span><span class="ident" id="2367912">SYS_SETGROUPS</span><span class="op" id="2367925">,</span>&nbsp;<span class="ident" id="2367927">ngroups</span><span class="op" id="2367934">,</span>&nbsp;<span class="builtintype" id="2367936">uintptr</span><span class="op" id="2367943">(</span><span class="ident" id="2367944">groups</span><span class="op" id="2367950">)</span><span class="op" id="2367951">,</span>&nbsp;<span class="num" id="2367953">0</span><span class="op" id="2367954">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2367958">if</span>&nbsp;<span class="ident" id="2367961">err1</span>&nbsp;<span class="op" id="2367966">!=</span>&nbsp;<span class="num" id="2367969">0</span>&nbsp;<span class="op" id="2367971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2367976">goto</span>&nbsp;<span class="ident" id="2367981">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2367994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2367998">_</span><span class="op" id="2367999">,</span>&nbsp;<span class="ident" id="2368001">_</span><span class="op" id="2368002">,</span>&nbsp;<span class="ident" id="2368004">err1</span>&nbsp;<span class="op" id="2368009">=</span>&nbsp;<span class="ident" id="2368011">RawSyscall</span><span class="op" id="2368021">(</span><span class="ident" id="2368022">SYS_SETGID</span><span class="op" id="2368032">,</span>&nbsp;<span class="builtintype" id="2368034">uintptr</span><span class="op" id="2368041">(</span><span class="ident" id="2368042">cred</span><span class="op" id="2368046">.</span><span class="ident" id="2368047">Gid</span><span class="op" id="2368050">)</span><span class="op" id="2368051">,</span>&nbsp;<span class="num" id="2368053">0</span><span class="op" id="2368054">,</span>&nbsp;<span class="num" id="2368056">0</span><span class="op" id="2368057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2368061">if</span>&nbsp;<span class="ident" id="2368064">err1</span>&nbsp;<span class="op" id="2368069">!=</span>&nbsp;<span class="num" id="2368072">0</span>&nbsp;<span class="op" id="2368074">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2368079">goto</span>&nbsp;<span class="ident" id="2368084">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2368097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2368101">_</span><span class="op" id="2368102">,</span>&nbsp;<span class="ident" id="2368104">_</span><span class="op" id="2368105">,</span>&nbsp;<span class="ident" id="2368107">err1</span>&nbsp;<span class="op" id="2368112">=</span>&nbsp;<span class="ident" id="2368114">RawSyscall</span><span class="op" id="2368124">(</span><span class="ident" id="2368125">SYS_SETUID</span><span class="op" id="2368135">,</span>&nbsp;<span class="builtintype" id="2368137">uintptr</span><span class="op" id="2368144">(</span><span class="ident" id="2368145">cred</span><span class="op" id="2368149">.</span><span class="ident" id="2368150">Uid</span><span class="op" id="2368153">)</span><span class="op" id="2368154">,</span>&nbsp;<span class="num" id="2368156">0</span><span class="op" id="2368157">,</span>&nbsp;<span class="num" id="2368159">0</span><span class="op" id="2368160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2368164">if</span>&nbsp;<span class="ident" id="2368167">err1</span>&nbsp;<span class="op" id="2368172">!=</span>&nbsp;<span class="num" id="2368175">0</span>&nbsp;<span class="op" id="2368177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2368182">goto</span>&nbsp;<span class="ident" id="2368187">childerror</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2368200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2368203">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2368207">//&nbsp;Chdir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2368217">if</span>&nbsp;<span class="ident" id="2368220">dir</span>&nbsp;<span class="op" id="2368224">!=</span>&nbsp;<span class="ident" id="2368227">nil</span>&nbsp;<span class="op" id="2368231">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2368235">_</span><span class="op" id="2368236">,</span>&nbsp;<span class="ident" id="2368238">_</span><span class="op" id="2368239">,</span>&nbsp;<span class="ident" id="2368241">err1</span>&nbsp;<span class="op" id="2368246">=</span>&nbsp;<span class="ident" id="2368248">RawSyscall</span><span class="op" id="2368258">(</span><span class="ident" id="2368259">SYS_CHDIR</span><span class="op" id="2368268">,</span>&nbsp;<span class="builtintype" id="2368270">uintptr</span><span class="op" id="2368277">(</span><span class="ident" id="2368278">unsafe</span><span class="op" id="2368284">.</span><span class="ident" id="2368285">Pointer</span><span class="op" id="2368292">(</span><span class="ident" id="2368293">dir</span><span class="op" id="2368296">)</span><span class="op" id="2368297">)</span><span class="op" id="2368298">,</span>&nbsp;<span class="num" id="2368300">0</span><span class="op" id="2368301">,</span>&nbsp;<span class="num" id="2368303">0</span><span class="op" id="2368304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2368308">if</span>&nbsp;<span class="ident" id="2368311">err1</span>&nbsp;<span class="op" id="2368316">!=</span>&nbsp;<span class="num" id="2368319">0</span>&nbsp;<span class="op" id="2368321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2368326">goto</span>&nbsp;<span class="ident" id="2368331">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2368344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2368347">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2368351">//&nbsp;Pass&nbsp;1:&nbsp;look&nbsp;for&nbsp;fd[i]&nbsp;&lt;&nbsp;i&nbsp;and&nbsp;move&nbsp;those&nbsp;up&nbsp;above&nbsp;len(fd)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2368414">//&nbsp;so&nbsp;that&nbsp;pass&nbsp;2&nbsp;won&#39;t&nbsp;stomp&nbsp;on&nbsp;an&nbsp;fd&nbsp;it&nbsp;needs&nbsp;later.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2368470">if</span>&nbsp;<span class="ident" id="2368473">pipe</span>&nbsp;<span class="op" id="2368478">&lt;</span>&nbsp;<span class="ident" id="2368480">nextfd</span>&nbsp;<span class="op" id="2368487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2368491">_</span><span class="op" id="2368492">,</span>&nbsp;<span class="ident" id="2368494">_</span><span class="op" id="2368495">,</span>&nbsp;<span class="ident" id="2368497">err1</span>&nbsp;<span class="op" id="2368502">=</span>&nbsp;<span class="ident" id="2368504">RawSyscall</span><span class="op" id="2368514">(</span><span class="ident" id="2368515">SYS_DUP2</span><span class="op" id="2368523">,</span>&nbsp;<span class="builtintype" id="2368525">uintptr</span><span class="op" id="2368532">(</span><span class="ident" id="2368533">pipe</span><span class="op" id="2368537">)</span><span class="op" id="2368538">,</span>&nbsp;<span class="builtintype" id="2368540">uintptr</span><span class="op" id="2368547">(</span><span class="ident" id="2368548">nextfd</span><span class="op" id="2368554">)</span><span class="op" id="2368555">,</span>&nbsp;<span class="num" id="2368557">0</span><span class="op" id="2368558">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2368562">if</span>&nbsp;<span class="ident" id="2368565">err1</span>&nbsp;<span class="op" id="2368570">!=</span>&nbsp;<span class="num" id="2368573">0</span>&nbsp;<span class="op" id="2368575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2368580">goto</span>&nbsp;<span class="ident" id="2368585">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2368598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2368602">RawSyscall</span><span class="op" id="2368612">(</span><span class="ident" id="2368613">SYS_FCNTL</span><span class="op" id="2368622">,</span>&nbsp;<span class="builtintype" id="2368624">uintptr</span><span class="op" id="2368631">(</span><span class="ident" id="2368632">nextfd</span><span class="op" id="2368638">)</span><span class="op" id="2368639">,</span>&nbsp;<span class="ident" id="2368641">F_SETFD</span><span class="op" id="2368648">,</span>&nbsp;<span class="ident" id="2368650">FD_CLOEXEC</span><span class="op" id="2368660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2368664">pipe</span>&nbsp;<span class="op" id="2368669">=</span>&nbsp;<span class="ident" id="2368671">nextfd</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2368680">nextfd</span><span class="op" id="2368686">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2368690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2368693">for</span>&nbsp;<span class="ident" id="2368697">i</span>&nbsp;<span class="op" id="2368699">=</span>&nbsp;<span class="num" id="2368701">0</span><span class="op" id="2368702">;</span>&nbsp;<span class="ident" id="2368704">i</span>&nbsp;<span class="op" id="2368706">&lt;</span>&nbsp;<span class="builtinfunc" id="2368708">len</span><span class="op" id="2368711">(</span><span class="ident" id="2368712">fd</span><span class="op" id="2368714">)</span><span class="op" id="2368715">;</span>&nbsp;<span class="ident" id="2368717">i</span><span class="op" id="2368718">++</span>&nbsp;<span class="op" id="2368721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2368725">if</span>&nbsp;<span class="ident" id="2368728">fd</span><span class="op" id="2368730">[</span><span class="ident" id="2368731">i</span><span class="op" id="2368732">]</span>&nbsp;<span class="op" id="2368734">&gt;=</span>&nbsp;<span class="num" id="2368737">0</span>&nbsp;<span class="op" id="2368739">&amp;&amp;</span>&nbsp;<span class="ident" id="2368742">fd</span><span class="op" id="2368744">[</span><span class="ident" id="2368745">i</span><span class="op" id="2368746">]</span>&nbsp;<span class="op" id="2368748">&lt;</span>&nbsp;<span class="builtintype" id="2368750">int</span><span class="op" id="2368753">(</span><span class="ident" id="2368754">i</span><span class="op" id="2368755">)</span>&nbsp;<span class="op" id="2368757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2368762">_</span><span class="op" id="2368763">,</span>&nbsp;<span class="ident" id="2368765">_</span><span class="op" id="2368766">,</span>&nbsp;<span class="ident" id="2368768">err1</span>&nbsp;<span class="op" id="2368773">=</span>&nbsp;<span class="ident" id="2368775">RawSyscall</span><span class="op" id="2368785">(</span><span class="ident" id="2368786">SYS_DUP2</span><span class="op" id="2368794">,</span>&nbsp;<span class="builtintype" id="2368796">uintptr</span><span class="op" id="2368803">(</span><span class="ident" id="2368804">fd</span><span class="op" id="2368806">[</span><span class="ident" id="2368807">i</span><span class="op" id="2368808">]</span><span class="op" id="2368809">)</span><span class="op" id="2368810">,</span>&nbsp;<span class="builtintype" id="2368812">uintptr</span><span class="op" id="2368819">(</span><span class="ident" id="2368820">nextfd</span><span class="op" id="2368826">)</span><span class="op" id="2368827">,</span>&nbsp;<span class="num" id="2368829">0</span><span class="op" id="2368830">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2368835">if</span>&nbsp;<span class="ident" id="2368838">err1</span>&nbsp;<span class="op" id="2368843">!=</span>&nbsp;<span class="num" id="2368846">0</span>&nbsp;<span class="op" id="2368848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2368854">goto</span>&nbsp;<span class="ident" id="2368859">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2368873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2368878">RawSyscall</span><span class="op" id="2368888">(</span><span class="ident" id="2368889">SYS_FCNTL</span><span class="op" id="2368898">,</span>&nbsp;<span class="builtintype" id="2368900">uintptr</span><span class="op" id="2368907">(</span><span class="ident" id="2368908">nextfd</span><span class="op" id="2368914">)</span><span class="op" id="2368915">,</span>&nbsp;<span class="ident" id="2368917">F_SETFD</span><span class="op" id="2368924">,</span>&nbsp;<span class="ident" id="2368926">FD_CLOEXEC</span><span class="op" id="2368936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2368941">fd</span><span class="op" id="2368943">[</span><span class="ident" id="2368944">i</span><span class="op" id="2368945">]</span>&nbsp;<span class="op" id="2368947">=</span>&nbsp;<span class="ident" id="2368949">nextfd</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2368959">nextfd</span><span class="op" id="2368965">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2368971">if</span>&nbsp;<span class="ident" id="2368974">nextfd</span>&nbsp;<span class="op" id="2368981">==</span>&nbsp;<span class="ident" id="2368984">pipe</span>&nbsp;<span class="op" id="2368989">{</span>&nbsp;<span class="comment" id="2368991">//&nbsp;don&#39;t&nbsp;stomp&nbsp;on&nbsp;pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2369018">nextfd</span><span class="op" id="2369024">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2369030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2369034">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2369037">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2369041">//&nbsp;Pass&nbsp;2:&nbsp;dup&nbsp;fd[i]&nbsp;down&nbsp;onto&nbsp;i.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2369076">for</span>&nbsp;<span class="ident" id="2369080">i</span>&nbsp;<span class="op" id="2369082">=</span>&nbsp;<span class="num" id="2369084">0</span><span class="op" id="2369085">;</span>&nbsp;<span class="ident" id="2369087">i</span>&nbsp;<span class="op" id="2369089">&lt;</span>&nbsp;<span class="builtinfunc" id="2369091">len</span><span class="op" id="2369094">(</span><span class="ident" id="2369095">fd</span><span class="op" id="2369097">)</span><span class="op" id="2369098">;</span>&nbsp;<span class="ident" id="2369100">i</span><span class="op" id="2369101">++</span>&nbsp;<span class="op" id="2369104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2369108">if</span>&nbsp;<span class="ident" id="2369111">fd</span><span class="op" id="2369113">[</span><span class="ident" id="2369114">i</span><span class="op" id="2369115">]</span>&nbsp;<span class="op" id="2369117">==</span>&nbsp;<span class="op" id="2369120">-</span><span class="num" id="2369121">1</span>&nbsp;<span class="op" id="2369123">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2369128">RawSyscall</span><span class="op" id="2369138">(</span><span class="ident" id="2369139">SYS_CLOSE</span><span class="op" id="2369148">,</span>&nbsp;<span class="builtintype" id="2369150">uintptr</span><span class="op" id="2369157">(</span><span class="ident" id="2369158">i</span><span class="op" id="2369159">)</span><span class="op" id="2369160">,</span>&nbsp;<span class="num" id="2369162">0</span><span class="op" id="2369163">,</span>&nbsp;<span class="num" id="2369165">0</span><span class="op" id="2369166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2369171">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2369182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2369186">if</span>&nbsp;<span class="ident" id="2369189">fd</span><span class="op" id="2369191">[</span><span class="ident" id="2369192">i</span><span class="op" id="2369193">]</span>&nbsp;<span class="op" id="2369195">==</span>&nbsp;<span class="builtintype" id="2369198">int</span><span class="op" id="2369201">(</span><span class="ident" id="2369202">i</span><span class="op" id="2369203">)</span>&nbsp;<span class="op" id="2369205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2369210">//&nbsp;dup2(i,&nbsp;i)&nbsp;won&#39;t&nbsp;clear&nbsp;close-on-exec&nbsp;flag&nbsp;on&nbsp;Linux,</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2369268">//&nbsp;probably&nbsp;not&nbsp;elsewhere&nbsp;either.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2369305">_</span><span class="op" id="2369306">,</span>&nbsp;<span class="ident" id="2369308">_</span><span class="op" id="2369309">,</span>&nbsp;<span class="ident" id="2369311">err1</span>&nbsp;<span class="op" id="2369316">=</span>&nbsp;<span class="ident" id="2369318">RawSyscall</span><span class="op" id="2369328">(</span><span class="ident" id="2369329">SYS_FCNTL</span><span class="op" id="2369338">,</span>&nbsp;<span class="builtintype" id="2369340">uintptr</span><span class="op" id="2369347">(</span><span class="ident" id="2369348">fd</span><span class="op" id="2369350">[</span><span class="ident" id="2369351">i</span><span class="op" id="2369352">]</span><span class="op" id="2369353">)</span><span class="op" id="2369354">,</span>&nbsp;<span class="ident" id="2369356">F_SETFD</span><span class="op" id="2369363">,</span>&nbsp;<span class="num" id="2369365">0</span><span class="op" id="2369366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2369371">if</span>&nbsp;<span class="ident" id="2369374">err1</span>&nbsp;<span class="op" id="2369379">!=</span>&nbsp;<span class="num" id="2369382">0</span>&nbsp;<span class="op" id="2369384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2369390">goto</span>&nbsp;<span class="ident" id="2369395">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2369409">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2369414">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2369425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2369429">//&nbsp;The&nbsp;new&nbsp;fd&nbsp;is&nbsp;created&nbsp;NOT&nbsp;close-on-exec,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2369475">//&nbsp;which&nbsp;is&nbsp;exactly&nbsp;what&nbsp;we&nbsp;want.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2369511">_</span><span class="op" id="2369512">,</span>&nbsp;<span class="ident" id="2369514">_</span><span class="op" id="2369515">,</span>&nbsp;<span class="ident" id="2369517">err1</span>&nbsp;<span class="op" id="2369522">=</span>&nbsp;<span class="ident" id="2369524">RawSyscall</span><span class="op" id="2369534">(</span><span class="ident" id="2369535">SYS_DUP2</span><span class="op" id="2369543">,</span>&nbsp;<span class="builtintype" id="2369545">uintptr</span><span class="op" id="2369552">(</span><span class="ident" id="2369553">fd</span><span class="op" id="2369555">[</span><span class="ident" id="2369556">i</span><span class="op" id="2369557">]</span><span class="op" id="2369558">)</span><span class="op" id="2369559">,</span>&nbsp;<span class="builtintype" id="2369561">uintptr</span><span class="op" id="2369568">(</span><span class="ident" id="2369569">i</span><span class="op" id="2369570">)</span><span class="op" id="2369571">,</span>&nbsp;<span class="num" id="2369573">0</span><span class="op" id="2369574">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2369578">if</span>&nbsp;<span class="ident" id="2369581">err1</span>&nbsp;<span class="op" id="2369586">!=</span>&nbsp;<span class="num" id="2369589">0</span>&nbsp;<span class="op" id="2369591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2369596">goto</span>&nbsp;<span class="ident" id="2369601">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2369614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2369617">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2369621">//&nbsp;By&nbsp;convention,&nbsp;we&nbsp;don&#39;t&nbsp;close-on-exec&nbsp;the&nbsp;fds&nbsp;we&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2369678">//&nbsp;started&nbsp;with,&nbsp;so&nbsp;if&nbsp;len(fd)&nbsp;&lt;&nbsp;3,&nbsp;close&nbsp;0,&nbsp;1,&nbsp;2&nbsp;as&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2369740">//&nbsp;Programs&nbsp;that&nbsp;know&nbsp;they&nbsp;inherit&nbsp;fds&nbsp;&gt;=&nbsp;3&nbsp;will&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2369795">//&nbsp;to&nbsp;set&nbsp;them&nbsp;close-on-exec.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2369826">for</span>&nbsp;<span class="ident" id="2369830">i</span>&nbsp;<span class="op" id="2369832">=</span>&nbsp;<span class="builtinfunc" id="2369834">len</span><span class="op" id="2369837">(</span><span class="ident" id="2369838">fd</span><span class="op" id="2369840">)</span><span class="op" id="2369841">;</span>&nbsp;<span class="ident" id="2369843">i</span>&nbsp;<span class="op" id="2369845">&lt;</span>&nbsp;<span class="num" id="2369847">3</span><span class="op" id="2369848">;</span>&nbsp;<span class="ident" id="2369850">i</span><span class="op" id="2369851">++</span>&nbsp;<span class="op" id="2369854">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2369858">RawSyscall</span><span class="op" id="2369868">(</span><span class="ident" id="2369869">SYS_CLOSE</span><span class="op" id="2369878">,</span>&nbsp;<span class="builtintype" id="2369880">uintptr</span><span class="op" id="2369887">(</span><span class="ident" id="2369888">i</span><span class="op" id="2369889">)</span><span class="op" id="2369890">,</span>&nbsp;<span class="num" id="2369892">0</span><span class="op" id="2369893">,</span>&nbsp;<span class="num" id="2369895">0</span><span class="op" id="2369896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2369899">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2369903">//&nbsp;Detach&nbsp;fd&nbsp;0&nbsp;from&nbsp;tty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2369928">if</span>&nbsp;<span class="ident" id="2369931">sys</span><span class="op" id="2369934">.</span><span class="ident" id="2369935">Noctty</span>&nbsp;<span class="op" id="2369942">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2369946">_</span><span class="op" id="2369947">,</span>&nbsp;<span class="ident" id="2369949">_</span><span class="op" id="2369950">,</span>&nbsp;<span class="ident" id="2369952">err1</span>&nbsp;<span class="op" id="2369957">=</span>&nbsp;<span class="ident" id="2369959">RawSyscall</span><span class="op" id="2369969">(</span><span class="ident" id="2369970">SYS_IOCTL</span><span class="op" id="2369979">,</span>&nbsp;<span class="num" id="2369981">0</span><span class="op" id="2369982">,</span>&nbsp;<span class="builtintype" id="2369984">uintptr</span><span class="op" id="2369991">(</span><span class="ident" id="2369992">TIOCNOTTY</span><span class="op" id="2370001">)</span><span class="op" id="2370002">,</span>&nbsp;<span class="num" id="2370004">0</span><span class="op" id="2370005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2370009">if</span>&nbsp;<span class="ident" id="2370012">err1</span>&nbsp;<span class="op" id="2370017">!=</span>&nbsp;<span class="num" id="2370020">0</span>&nbsp;<span class="op" id="2370022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2370027">goto</span>&nbsp;<span class="ident" id="2370032">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2370045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2370048">}</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2370052">//&nbsp;Set&nbsp;the&nbsp;controlling&nbsp;TTY&nbsp;to&nbsp;Ctty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2370088">if</span>&nbsp;<span class="ident" id="2370091">sys</span><span class="op" id="2370094">.</span><span class="ident" id="2370095">Setctty</span>&nbsp;<span class="op" id="2370103">&amp;&amp;</span>&nbsp;<span class="ident" id="2370106">sys</span><span class="op" id="2370109">.</span><span class="ident" id="2370110">Ctty</span>&nbsp;<span class="op" id="2370115">&gt;=</span>&nbsp;<span class="num" id="2370118">0</span>&nbsp;<span class="op" id="2370120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2370124">_</span><span class="op" id="2370125">,</span>&nbsp;<span class="ident" id="2370127">_</span><span class="op" id="2370128">,</span>&nbsp;<span class="ident" id="2370130">err1</span>&nbsp;<span class="op" id="2370135">=</span>&nbsp;<span class="ident" id="2370137">RawSyscall</span><span class="op" id="2370147">(</span><span class="ident" id="2370148">SYS_IOCTL</span><span class="op" id="2370157">,</span>&nbsp;<span class="builtintype" id="2370159">uintptr</span><span class="op" id="2370166">(</span><span class="ident" id="2370167">sys</span><span class="op" id="2370170">.</span><span class="ident" id="2370171">Ctty</span><span class="op" id="2370175">)</span><span class="op" id="2370176">,</span>&nbsp;<span class="builtintype" id="2370178">uintptr</span><span class="op" id="2370185">(</span><span class="ident" id="2370186">TIOCSCTTY</span><span class="op" id="2370195">)</span><span class="op" id="2370196">,</span>&nbsp;<span class="num" id="2370198">0</span><span class="op" id="2370199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2370203">if</span>&nbsp;<span class="ident" id="2370206">err1</span>&nbsp;<span class="op" id="2370211">!=</span>&nbsp;<span class="num" id="2370214">0</span>&nbsp;<span class="op" id="2370216">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2370221">goto</span>&nbsp;<span class="ident" id="2370226">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2370239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2370242">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2370246">//&nbsp;Time&nbsp;to&nbsp;exec.</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2370264">_</span><span class="op" id="2370265">,</span>&nbsp;<span class="ident" id="2370267">_</span><span class="op" id="2370268">,</span>&nbsp;<span class="ident" id="2370270">err1</span>&nbsp;<span class="op" id="2370275">=</span>&nbsp;<span class="ident" id="2370277">RawSyscall</span><span class="op" id="2370287">(</span><span class="ident" id="2370288">SYS_EXECVE</span><span class="op" id="2370298">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2370302">uintptr</span><span class="op" id="2370309">(</span><span class="ident" id="2370310">unsafe</span><span class="op" id="2370316">.</span><span class="ident" id="2370317">Pointer</span><span class="op" id="2370324">(</span><span class="ident" id="2370325">argv0</span><span class="op" id="2370330">)</span><span class="op" id="2370331">)</span><span class="op" id="2370332">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2370336">uintptr</span><span class="op" id="2370343">(</span><span class="ident" id="2370344">unsafe</span><span class="op" id="2370350">.</span><span class="ident" id="2370351">Pointer</span><span class="op" id="2370358">(</span><span class="op" id="2370359">&amp;</span><span class="ident" id="2370360">argv</span><span class="op" id="2370364">[</span><span class="num" id="2370365">0</span><span class="op" id="2370366">]</span><span class="op" id="2370367">)</span><span class="op" id="2370368">)</span><span class="op" id="2370369">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2370373">uintptr</span><span class="op" id="2370380">(</span><span class="ident" id="2370381">unsafe</span><span class="op" id="2370387">.</span><span class="ident" id="2370388">Pointer</span><span class="op" id="2370395">(</span><span class="op" id="2370396">&amp;</span><span class="ident" id="2370397">envv</span><span class="op" id="2370401">[</span><span class="num" id="2370402">0</span><span class="op" id="2370403">]</span><span class="op" id="2370404">)</span><span class="op" id="2370405">)</span><span class="op" id="2370406">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="ident" id="2370409">childerror</span><span class="op" id="2370419">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2370422">//&nbsp;send&nbsp;error&nbsp;code&nbsp;on&nbsp;pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2370450">RawSyscall</span><span class="op" id="2370460">(</span><span class="ident" id="2370461">SYS_WRITE</span><span class="op" id="2370470">,</span>&nbsp;<span class="builtintype" id="2370472">uintptr</span><span class="op" id="2370479">(</span><span class="ident" id="2370480">pipe</span><span class="op" id="2370484">)</span><span class="op" id="2370485">,</span>&nbsp;<span class="builtintype" id="2370487">uintptr</span><span class="op" id="2370494">(</span><span class="ident" id="2370495">unsafe</span><span class="op" id="2370501">.</span><span class="ident" id="2370502">Pointer</span><span class="op" id="2370509">(</span><span class="op" id="2370510">&amp;</span><span class="ident" id="2370511">err1</span><span class="op" id="2370515">)</span><span class="op" id="2370516">)</span><span class="op" id="2370517">,</span>&nbsp;<span class="ident" id="2370519">unsafe</span><span class="op" id="2370525">.</span><span class="ident" id="2370526">Sizeof</span><span class="op" id="2370532">(</span><span class="ident" id="2370533">err1</span><span class="op" id="2370537">)</span><span class="op" id="2370538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2370541">for</span>&nbsp;<span class="op" id="2370545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2370549">RawSyscall</span><span class="op" id="2370559">(</span><span class="ident" id="2370560">SYS_EXIT</span><span class="op" id="2370568">,</span>&nbsp;<span class="num" id="2370570">253</span><span class="op" id="2370573">,</span>&nbsp;<span class="num" id="2370575">0</span><span class="op" id="2370576">,</span>&nbsp;<span class="num" id="2370578">0</span><span class="op" id="2370579">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2370582">}</span><br>
<span class="lineno"></span><span class="op" id="2370584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2370587">//&nbsp;Try&nbsp;to&nbsp;open&nbsp;a&nbsp;pipe&nbsp;with&nbsp;O_CLOEXEC&nbsp;set&nbsp;on&nbsp;both&nbsp;file&nbsp;descriptors.</span><br>
<span class="lineno"></span><span class="keyword" id="2370654">func</span>&nbsp;<span class="ident" id="2370659">forkExecPipe</span><span class="op" id="2370671">(</span><span class="ident" id="2370672">p</span>&nbsp;<span class="op" id="2370674">[</span><span class="op" id="2370675">]</span><span class="builtintype" id="2370676">int</span><span class="op" id="2370679">)</span>&nbsp;<span class="op" id="2370681">(</span><span class="ident" id="2370682">err</span>&nbsp;<span class="builtintype" id="2370686">error</span><span class="op" id="2370691">)</span>&nbsp;<span class="op" id="2370693">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2370696">err</span>&nbsp;<span class="op" id="2370700">=</span>&nbsp;<span class="ident" id="2370702">Pipe2</span><span class="op" id="2370707">(</span><span class="ident" id="2370708">p</span><span class="op" id="2370709">,</span>&nbsp;<span class="ident" id="2370711">O_CLOEXEC</span><span class="op" id="2370720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2370723">//&nbsp;pipe2&nbsp;was&nbsp;added&nbsp;in&nbsp;2.6.27&nbsp;and&nbsp;our&nbsp;minimum&nbsp;requirement&nbsp;is&nbsp;2.6.23,&nbsp;so&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2370798">//&nbsp;might&nbsp;not&nbsp;be&nbsp;implemented.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2370828">if</span>&nbsp;<span class="ident" id="2370831">err</span>&nbsp;<span class="op" id="2370835">==</span>&nbsp;<span class="ident" id="2370838">ENOSYS</span>&nbsp;<span class="op" id="2370845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2370849">if</span>&nbsp;<span class="ident" id="2370852">err</span>&nbsp;<span class="op" id="2370856">=</span>&nbsp;<span class="ident" id="2370858">Pipe</span><span class="op" id="2370862">(</span><span class="ident" id="2370863">p</span><span class="op" id="2370864">)</span><span class="op" id="2370865">;</span>&nbsp;<span class="ident" id="2370867">err</span>&nbsp;<span class="op" id="2370871">!=</span>&nbsp;<span class="ident" id="2370874">nil</span>&nbsp;<span class="op" id="2370878">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2370883">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2370892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2370896">if</span>&nbsp;<span class="ident" id="2370899">_</span><span class="op" id="2370900">,</span>&nbsp;<span class="ident" id="2370902">err</span>&nbsp;<span class="op" id="2370906">=</span>&nbsp;<span class="ident" id="2370908">fcntl</span><span class="op" id="2370913">(</span><span class="ident" id="2370914">p</span><span class="op" id="2370915">[</span><span class="num" id="2370916">0</span><span class="op" id="2370917">]</span><span class="op" id="2370918">,</span>&nbsp;<span class="ident" id="2370920">F_SETFD</span><span class="op" id="2370927">,</span>&nbsp;<span class="ident" id="2370929">FD_CLOEXEC</span><span class="op" id="2370939">)</span><span class="op" id="2370940">;</span>&nbsp;<span class="ident" id="2370942">err</span>&nbsp;<span class="op" id="2370946">!=</span>&nbsp;<span class="ident" id="2370949">nil</span>&nbsp;<span class="op" id="2370953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2370958">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2370967">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2370971">_</span><span class="op" id="2370972">,</span>&nbsp;<span class="ident" id="2370974">err</span>&nbsp;<span class="op" id="2370978">=</span>&nbsp;<span class="ident" id="2370980">fcntl</span><span class="op" id="2370985">(</span><span class="ident" id="2370986">p</span><span class="op" id="2370987">[</span><span class="num" id="2370988">1</span><span class="op" id="2370989">]</span><span class="op" id="2370990">,</span>&nbsp;<span class="ident" id="2370992">F_SETFD</span><span class="op" id="2370999">,</span>&nbsp;<span class="ident" id="2371001">FD_CLOEXEC</span><span class="op" id="2371011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2371014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2371017">return</span><br>
<span class="lineno"></span><span class="op" id="2371024">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span><span class="comment" id="2371027">//&nbsp;writeIDMappings&nbsp;writes&nbsp;the&nbsp;user&nbsp;namespace&nbsp;User&nbsp;ID&nbsp;or&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;to&nbsp;the&nbsp;specified&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="2371124">func</span>&nbsp;<span class="ident" id="2371129">writeIDMappings</span><span class="op" id="2371144">(</span><span class="ident" id="2371145">path</span>&nbsp;<span class="builtintype" id="2371150">string</span><span class="op" id="2371156">,</span>&nbsp;<span class="ident" id="2371158">idMap</span>&nbsp;<span class="op" id="2371164">[</span><span class="op" id="2371165">]</span><span class="ident" id="2371166">SysProcIDMap</span><span class="op" id="2371178">)</span>&nbsp;<span class="builtintype" id="2371180">error</span>&nbsp;<span class="op" id="2371186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2371189">fd</span><span class="op" id="2371191">,</span>&nbsp;<span class="ident" id="2371193">err</span>&nbsp;<span class="op" id="2371197">:=</span>&nbsp;<span class="ident" id="2371200">Open</span><span class="op" id="2371204">(</span><span class="ident" id="2371205">path</span><span class="op" id="2371209">,</span>&nbsp;<span class="ident" id="2371211">O_RDWR</span><span class="op" id="2371217">,</span>&nbsp;<span class="num" id="2371219">0</span><span class="op" id="2371220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2371223">if</span>&nbsp;<span class="ident" id="2371226">err</span>&nbsp;<span class="op" id="2371230">!=</span>&nbsp;<span class="ident" id="2371233">nil</span>&nbsp;<span class="op" id="2371237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2371241">return</span>&nbsp;<span class="ident" id="2371248">err</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2371253">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2371257">data</span>&nbsp;<span class="op" id="2371262">:=</span>&nbsp;<span class="string" id="2371265">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2371269">for</span>&nbsp;<span class="ident" id="2371273">_</span><span class="op" id="2371274">,</span>&nbsp;<span class="ident" id="2371276">im</span>&nbsp;<span class="op" id="2371279">:=</span>&nbsp;<span class="keyword" id="2371282">range</span>&nbsp;<span class="ident" id="2371288">idMap</span>&nbsp;<span class="op" id="2371294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2371298">data</span>&nbsp;<span class="op" id="2371303">=</span>&nbsp;<span class="ident" id="2371305">data</span>&nbsp;<span class="op" id="2371310">+</span>&nbsp;<span class="ident" id="2371312">itoa</span><span class="op" id="2371316">(</span><span class="ident" id="2371317">im</span><span class="op" id="2371319">.</span><span class="ident" id="2371320">ContainerID</span><span class="op" id="2371331">)</span>&nbsp;<span class="op" id="2371333">+</span>&nbsp;<span class="string" id="2371335">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="2371339">+</span>&nbsp;<span class="ident" id="2371341">itoa</span><span class="op" id="2371345">(</span><span class="ident" id="2371346">im</span><span class="op" id="2371348">.</span><span class="ident" id="2371349">HostID</span><span class="op" id="2371355">)</span>&nbsp;<span class="op" id="2371357">+</span>&nbsp;<span class="string" id="2371359">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="2371363">+</span>&nbsp;<span class="ident" id="2371365">itoa</span><span class="op" id="2371369">(</span><span class="ident" id="2371370">im</span><span class="op" id="2371372">.</span><span class="ident" id="2371373">Size</span><span class="op" id="2371377">)</span>&nbsp;<span class="op" id="2371379">+</span>&nbsp;<span class="string" id="2371381">&#34;\n&#34;</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2371387">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2371391">bytes</span><span class="op" id="2371396">,</span>&nbsp;<span class="ident" id="2371398">err</span>&nbsp;<span class="op" id="2371402">:=</span>&nbsp;<span class="ident" id="2371405">ByteSliceFromString</span><span class="op" id="2371424">(</span><span class="ident" id="2371425">data</span><span class="op" id="2371429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2371432">if</span>&nbsp;<span class="ident" id="2371435">err</span>&nbsp;<span class="op" id="2371439">!=</span>&nbsp;<span class="ident" id="2371442">nil</span>&nbsp;<span class="op" id="2371446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2371450">Close</span><span class="op" id="2371455">(</span><span class="ident" id="2371456">fd</span><span class="op" id="2371458">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2371462">return</span>&nbsp;<span class="ident" id="2371469">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2371474">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2371478">if</span>&nbsp;<span class="ident" id="2371481">_</span><span class="op" id="2371482">,</span>&nbsp;<span class="ident" id="2371484">err</span>&nbsp;<span class="op" id="2371488">:=</span>&nbsp;<span class="ident" id="2371491">Write</span><span class="op" id="2371496">(</span><span class="ident" id="2371497">fd</span><span class="op" id="2371499">,</span>&nbsp;<span class="ident" id="2371501">bytes</span><span class="op" id="2371506">)</span><span class="op" id="2371507">;</span>&nbsp;<span class="ident" id="2371509">err</span>&nbsp;<span class="op" id="2371513">!=</span>&nbsp;<span class="ident" id="2371516">nil</span>&nbsp;<span class="op" id="2371520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2371524">Close</span><span class="op" id="2371529">(</span><span class="ident" id="2371530">fd</span><span class="op" id="2371532">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2371536">return</span>&nbsp;<span class="ident" id="2371543">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2371548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2371552">if</span>&nbsp;<span class="ident" id="2371555">err</span>&nbsp;<span class="op" id="2371559">:=</span>&nbsp;<span class="ident" id="2371562">Close</span><span class="op" id="2371567">(</span><span class="ident" id="2371568">fd</span><span class="op" id="2371570">)</span><span class="op" id="2371571">;</span>&nbsp;<span class="ident" id="2371573">err</span>&nbsp;<span class="op" id="2371577">!=</span>&nbsp;<span class="ident" id="2371580">nil</span>&nbsp;<span class="op" id="2371584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2371588">return</span>&nbsp;<span class="ident" id="2371595">err</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2371600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2371604">return</span>&nbsp;<span class="ident" id="2371611">nil</span><br>
<span class="lineno"></span><span class="op" id="2371615">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">345</span><span class="comment" id="2371618">//&nbsp;writeUidGidMappings&nbsp;writes&nbsp;User&nbsp;ID&nbsp;and&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces</span><br>
<span class="lineno"></span><span class="comment" id="2371698">//&nbsp;for&nbsp;a&nbsp;process&nbsp;and&nbsp;it&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;parent&nbsp;process.</span><br>
<span class="lineno"></span><span class="keyword" id="2371757">func</span>&nbsp;<span class="ident" id="2371762">writeUidGidMappings</span><span class="op" id="2371781">(</span><span class="ident" id="2371782">pid</span>&nbsp;<span class="builtintype" id="2371786">int</span><span class="op" id="2371789">,</span>&nbsp;<span class="ident" id="2371791">sys</span>&nbsp;<span class="op" id="2371795">*</span><span class="ident" id="2371796">SysProcAttr</span><span class="op" id="2371807">)</span>&nbsp;<span class="builtintype" id="2371809">error</span>&nbsp;<span class="op" id="2371815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2371818">if</span>&nbsp;<span class="ident" id="2371821">sys</span><span class="op" id="2371824">.</span><span class="ident" id="2371825">UidMappings</span>&nbsp;<span class="op" id="2371837">!=</span>&nbsp;<span class="ident" id="2371840">nil</span>&nbsp;<span class="op" id="2371844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2371848">uidf</span>&nbsp;<span class="op" id="2371853">:=</span>&nbsp;<span class="string" id="2371856">&#34;/proc/&#34;</span>&nbsp;<span class="op" id="2371865">+</span>&nbsp;<span class="ident" id="2371867">itoa</span><span class="op" id="2371871">(</span><span class="ident" id="2371872">pid</span><span class="op" id="2371875">)</span>&nbsp;<span class="op" id="2371877">+</span>&nbsp;<span class="string" id="2371879">&#34;/uid_map&#34;</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2371892">if</span>&nbsp;<span class="ident" id="2371895">err</span>&nbsp;<span class="op" id="2371899">:=</span>&nbsp;<span class="ident" id="2371902">writeIDMappings</span><span class="op" id="2371917">(</span><span class="ident" id="2371918">uidf</span><span class="op" id="2371922">,</span>&nbsp;<span class="ident" id="2371924">sys</span><span class="op" id="2371927">.</span><span class="ident" id="2371928">UidMappings</span><span class="op" id="2371939">)</span><span class="op" id="2371940">;</span>&nbsp;<span class="ident" id="2371942">err</span>&nbsp;<span class="op" id="2371946">!=</span>&nbsp;<span class="ident" id="2371949">nil</span>&nbsp;<span class="op" id="2371953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2371958">return</span>&nbsp;<span class="ident" id="2371965">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2371971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2371974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2371978">if</span>&nbsp;<span class="ident" id="2371981">sys</span><span class="op" id="2371984">.</span><span class="ident" id="2371985">GidMappings</span>&nbsp;<span class="op" id="2371997">!=</span>&nbsp;<span class="ident" id="2372000">nil</span>&nbsp;<span class="op" id="2372004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2372008">gidf</span>&nbsp;<span class="op" id="2372013">:=</span>&nbsp;<span class="string" id="2372016">&#34;/proc/&#34;</span>&nbsp;<span class="op" id="2372025">+</span>&nbsp;<span class="ident" id="2372027">itoa</span><span class="op" id="2372031">(</span><span class="ident" id="2372032">pid</span><span class="op" id="2372035">)</span>&nbsp;<span class="op" id="2372037">+</span>&nbsp;<span class="string" id="2372039">&#34;/gid_map&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2372052">if</span>&nbsp;<span class="ident" id="2372055">err</span>&nbsp;<span class="op" id="2372059">:=</span>&nbsp;<span class="ident" id="2372062">writeIDMappings</span><span class="op" id="2372077">(</span><span class="ident" id="2372078">gidf</span><span class="op" id="2372082">,</span>&nbsp;<span class="ident" id="2372084">sys</span><span class="op" id="2372087">.</span><span class="ident" id="2372088">GidMappings</span><span class="op" id="2372099">)</span><span class="op" id="2372100">;</span>&nbsp;<span class="ident" id="2372102">err</span>&nbsp;<span class="op" id="2372106">!=</span>&nbsp;<span class="ident" id="2372109">nil</span>&nbsp;<span class="op" id="2372113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2372118">return</span>&nbsp;<span class="ident" id="2372125">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2372131">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2372134">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2372138">return</span>&nbsp;<span class="ident" id="2372145">nil</span><br>
<span class="lineno"></span><span class="op" id="2372149">}</span>
</div>
</body>
</html>
