<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/cipher</h2>
<ul>
<li><a href="/gostd/crypto/cipher/benchmark_test.go.html">benchmark_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc.go.html" class="current">cbc.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc_aes_test.go.html">cbc_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb.go.html">cfb.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb_test.go.html">cfb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher.go.html">cipher.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher_test.go.html">cipher_test.go</a></li>
<li><a href="/gostd/crypto/cipher/common_test.go.html">common_test.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr.go.html">ctr.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr_aes_test.go.html">ctr_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm.go.html">gcm.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm_test.go.html">gcm_test.go</a></li>
<li><a href="/gostd/crypto/cipher/io.go.html">io.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb.go.html">ofb.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb_test.go.html">ofb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/xor.go.html">xor.go</a></li>
<li><a href="/gostd/crypto/cipher/xor_test.go.html">xor_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3471601">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3471656">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3471710">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3471761">//&nbsp;Cipher&nbsp;block&nbsp;chaining&nbsp;(CBC)&nbsp;mode.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3471799">//&nbsp;CBC&nbsp;provides&nbsp;confidentiality&nbsp;by&nbsp;xoring&nbsp;(chaining)&nbsp;each&nbsp;plaintext&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="3471873">//&nbsp;with&nbsp;the&nbsp;previous&nbsp;ciphertext&nbsp;block&nbsp;before&nbsp;applying&nbsp;the&nbsp;block&nbsp;cipher.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="3471946">//&nbsp;See&nbsp;NIST&nbsp;SP&nbsp;800-38A,&nbsp;pp&nbsp;10-11</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3471980">package</span>&nbsp;<span class="ident" id="3471988">cipher</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3471996">type</span>&nbsp;<span class="ident" id="3472001">cbc</span>&nbsp;<span class="keyword" id="3472005">struct</span>&nbsp;<span class="op" id="3472012">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472015">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3472025">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472032">blockSize</span>&nbsp;<span class="builtintype" id="3472042">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472047">iv</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3472057">[</span><span class="op" id="3472058">]</span><span class="builtintype" id="3472059">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472065">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3472075">[</span><span class="op" id="3472076">]</span><span class="builtintype" id="3472077">byte</span><br>
<span class="lineno"></span><span class="op" id="3472082">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3472085">func</span>&nbsp;<span class="ident" id="3472090">newCBC</span><span class="op" id="3472096">(</span><span class="ident" id="3472097">b</span>&nbsp;<span class="ident" id="3472099">Block</span><span class="op" id="3472104">,</span>&nbsp;<span class="ident" id="3472106">iv</span>&nbsp;<span class="op" id="3472109">[</span><span class="op" id="3472110">]</span><span class="builtintype" id="3472111">byte</span><span class="op" id="3472115">)</span>&nbsp;<span class="op" id="3472117">*</span><span class="ident" id="3472118">cbc</span>&nbsp;<span class="op" id="3472122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3472125">return</span>&nbsp;<span class="op" id="3472132">&amp;</span><span class="ident" id="3472133">cbc</span><span class="op" id="3472136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472140">b</span><span class="op" id="3472141">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3472151">b</span><span class="op" id="3472152">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472156">blockSize</span><span class="op" id="3472165">:</span>&nbsp;<span class="ident" id="3472167">b</span><span class="op" id="3472168">.</span><span class="ident" id="3472169">BlockSize</span><span class="op" id="3472178">(</span><span class="op" id="3472179">)</span><span class="op" id="3472180">,</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472184">iv</span><span class="op" id="3472186">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3472195">dup</span><span class="op" id="3472198">(</span><span class="ident" id="3472199">iv</span><span class="op" id="3472201">)</span><span class="op" id="3472202">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472206">tmp</span><span class="op" id="3472209">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3472217">make</span><span class="op" id="3472221">(</span><span class="op" id="3472222">[</span><span class="op" id="3472223">]</span><span class="builtintype" id="3472224">byte</span><span class="op" id="3472228">,</span>&nbsp;<span class="ident" id="3472230">b</span><span class="op" id="3472231">.</span><span class="ident" id="3472232">BlockSize</span><span class="op" id="3472241">(</span><span class="op" id="3472242">)</span><span class="op" id="3472243">)</span><span class="op" id="3472244">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3472247">}</span><br>
<span class="lineno"></span><span class="op" id="3472249">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="keyword" id="3472252">type</span>&nbsp;<span class="ident" id="3472257">cbcEncrypter</span>&nbsp;<span class="ident" id="3472270">cbc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3472275">//&nbsp;NewCBCEncrypter&nbsp;returns&nbsp;a&nbsp;BlockMode&nbsp;which&nbsp;encrypts&nbsp;in&nbsp;cipher&nbsp;block&nbsp;chaining</span><br>
<span class="lineno"></span><span class="comment" id="3472354">//&nbsp;mode,&nbsp;using&nbsp;the&nbsp;given&nbsp;Block.&nbsp;The&nbsp;length&nbsp;of&nbsp;iv&nbsp;must&nbsp;be&nbsp;the&nbsp;same&nbsp;as&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3472427">//&nbsp;Block&#39;s&nbsp;block&nbsp;size.</span><br>
<span class="lineno">35</span><span class="keyword" id="3472450">func</span>&nbsp;<span class="ident" id="3472455">NewCBCEncrypter</span><span class="op" id="3472470">(</span><span class="ident" id="3472471">b</span>&nbsp;<span class="ident" id="3472473">Block</span><span class="op" id="3472478">,</span>&nbsp;<span class="ident" id="3472480">iv</span>&nbsp;<span class="op" id="3472483">[</span><span class="op" id="3472484">]</span><span class="builtintype" id="3472485">byte</span><span class="op" id="3472489">)</span>&nbsp;<span class="ident" id="3472491">BlockMode</span>&nbsp;<span class="op" id="3472501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3472504">if</span>&nbsp;<span class="builtinfunc" id="3472507">len</span><span class="op" id="3472510">(</span><span class="ident" id="3472511">iv</span><span class="op" id="3472513">)</span>&nbsp;<span class="op" id="3472515">!=</span>&nbsp;<span class="ident" id="3472518">b</span><span class="op" id="3472519">.</span><span class="ident" id="3472520">BlockSize</span><span class="op" id="3472529">(</span><span class="op" id="3472530">)</span>&nbsp;<span class="op" id="3472532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3472536">panic</span><span class="op" id="3472541">(</span><span class="string" id="3472542">&#34;cipher.NewCBCEncrypter:&nbsp;IV&nbsp;length&nbsp;must&nbsp;equal&nbsp;block&nbsp;size&#34;</span><span class="op" id="3472599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3472602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3472605">return</span>&nbsp;<span class="op" id="3472612">(</span><span class="op" id="3472613">*</span><span class="ident" id="3472614">cbcEncrypter</span><span class="op" id="3472626">)</span><span class="op" id="3472627">(</span><span class="ident" id="3472628">newCBC</span><span class="op" id="3472634">(</span><span class="ident" id="3472635">b</span><span class="op" id="3472636">,</span>&nbsp;<span class="ident" id="3472638">iv</span><span class="op" id="3472640">)</span><span class="op" id="3472641">)</span><br>
<span class="lineno">40</span><span class="op" id="3472643">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3472646">func</span>&nbsp;<span class="op" id="3472651">(</span><span class="ident" id="3472652">x</span>&nbsp;<span class="op" id="3472654">*</span><span class="ident" id="3472655">cbcEncrypter</span><span class="op" id="3472667">)</span>&nbsp;<span class="ident" id="3472669">BlockSize</span><span class="op" id="3472678">(</span><span class="op" id="3472679">)</span>&nbsp;<span class="builtintype" id="3472681">int</span>&nbsp;<span class="op" id="3472685">{</span>&nbsp;<span class="keyword" id="3472687">return</span>&nbsp;<span class="ident" id="3472694">x</span><span class="op" id="3472695">.</span><span class="ident" id="3472696">blockSize</span>&nbsp;<span class="op" id="3472706">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3472709">func</span>&nbsp;<span class="op" id="3472714">(</span><span class="ident" id="3472715">x</span>&nbsp;<span class="op" id="3472717">*</span><span class="ident" id="3472718">cbcEncrypter</span><span class="op" id="3472730">)</span>&nbsp;<span class="ident" id="3472732">CryptBlocks</span><span class="op" id="3472743">(</span><span class="ident" id="3472744">dst</span><span class="op" id="3472747">,</span>&nbsp;<span class="ident" id="3472749">src</span>&nbsp;<span class="op" id="3472753">[</span><span class="op" id="3472754">]</span><span class="builtintype" id="3472755">byte</span><span class="op" id="3472759">)</span>&nbsp;<span class="op" id="3472761">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3472764">if</span>&nbsp;<span class="builtinfunc" id="3472767">len</span><span class="op" id="3472770">(</span><span class="ident" id="3472771">src</span><span class="op" id="3472774">)</span><span class="op" id="3472775">%</span><span class="ident" id="3472776">x</span><span class="op" id="3472777">.</span><span class="ident" id="3472778">blockSize</span>&nbsp;<span class="op" id="3472788">!=</span>&nbsp;<span class="num" id="3472791">0</span>&nbsp;<span class="op" id="3472793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3472797">panic</span><span class="op" id="3472802">(</span><span class="string" id="3472803">&#34;crypto/cipher:&nbsp;input&nbsp;not&nbsp;full&nbsp;blocks&#34;</span><span class="op" id="3472841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3472844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3472847">if</span>&nbsp;<span class="builtinfunc" id="3472850">len</span><span class="op" id="3472853">(</span><span class="ident" id="3472854">dst</span><span class="op" id="3472857">)</span>&nbsp;<span class="op" id="3472859">&lt;</span>&nbsp;<span class="builtinfunc" id="3472861">len</span><span class="op" id="3472864">(</span><span class="ident" id="3472865">src</span><span class="op" id="3472868">)</span>&nbsp;<span class="op" id="3472870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3472874">panic</span><span class="op" id="3472879">(</span><span class="string" id="3472880">&#34;crypto/cipher:&nbsp;output&nbsp;smaller&nbsp;than&nbsp;input&#34;</span><span class="op" id="3472922">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3472925">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472929">iv</span>&nbsp;<span class="op" id="3472932">:=</span>&nbsp;<span class="ident" id="3472935">x</span><span class="op" id="3472936">.</span><span class="ident" id="3472937">iv</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3472942">for</span>&nbsp;<span class="builtinfunc" id="3472946">len</span><span class="op" id="3472949">(</span><span class="ident" id="3472950">src</span><span class="op" id="3472953">)</span>&nbsp;<span class="op" id="3472955">&gt;</span>&nbsp;<span class="num" id="3472957">0</span>&nbsp;<span class="op" id="3472959">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3472963">//&nbsp;Write&nbsp;the&nbsp;xor&nbsp;to&nbsp;dst,&nbsp;then&nbsp;encrypt&nbsp;in&nbsp;place.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473013">xorBytes</span><span class="op" id="3473021">(</span><span class="ident" id="3473022">dst</span><span class="op" id="3473025">[</span><span class="op" id="3473026">:</span><span class="ident" id="3473027">x</span><span class="op" id="3473028">.</span><span class="ident" id="3473029">blockSize</span><span class="op" id="3473038">]</span><span class="op" id="3473039">,</span>&nbsp;<span class="ident" id="3473041">src</span><span class="op" id="3473044">[</span><span class="op" id="3473045">:</span><span class="ident" id="3473046">x</span><span class="op" id="3473047">.</span><span class="ident" id="3473048">blockSize</span><span class="op" id="3473057">]</span><span class="op" id="3473058">,</span>&nbsp;<span class="ident" id="3473060">iv</span><span class="op" id="3473062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473066">x</span><span class="op" id="3473067">.</span><span class="ident" id="3473068">b</span><span class="op" id="3473069">.</span><span class="ident" id="3473070">Encrypt</span><span class="op" id="3473077">(</span><span class="ident" id="3473078">dst</span><span class="op" id="3473081">[</span><span class="op" id="3473082">:</span><span class="ident" id="3473083">x</span><span class="op" id="3473084">.</span><span class="ident" id="3473085">blockSize</span><span class="op" id="3473094">]</span><span class="op" id="3473095">,</span>&nbsp;<span class="ident" id="3473097">dst</span><span class="op" id="3473100">[</span><span class="op" id="3473101">:</span><span class="ident" id="3473102">x</span><span class="op" id="3473103">.</span><span class="ident" id="3473104">blockSize</span><span class="op" id="3473113">]</span><span class="op" id="3473114">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3473119">//&nbsp;Move&nbsp;to&nbsp;the&nbsp;next&nbsp;block&nbsp;with&nbsp;this&nbsp;block&nbsp;as&nbsp;the&nbsp;next&nbsp;iv.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473179">iv</span>&nbsp;<span class="op" id="3473182">=</span>&nbsp;<span class="ident" id="3473184">dst</span><span class="op" id="3473187">[</span><span class="op" id="3473188">:</span><span class="ident" id="3473189">x</span><span class="op" id="3473190">.</span><span class="ident" id="3473191">blockSize</span><span class="op" id="3473200">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473204">src</span>&nbsp;<span class="op" id="3473208">=</span>&nbsp;<span class="ident" id="3473210">src</span><span class="op" id="3473213">[</span><span class="ident" id="3473214">x</span><span class="op" id="3473215">.</span><span class="ident" id="3473216">blockSize</span><span class="op" id="3473225">:</span><span class="op" id="3473226">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473230">dst</span>&nbsp;<span class="op" id="3473234">=</span>&nbsp;<span class="ident" id="3473236">dst</span><span class="op" id="3473239">[</span><span class="ident" id="3473240">x</span><span class="op" id="3473241">.</span><span class="ident" id="3473242">blockSize</span><span class="op" id="3473251">:</span><span class="op" id="3473252">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3473255">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3473259">//&nbsp;Save&nbsp;the&nbsp;iv&nbsp;for&nbsp;the&nbsp;next&nbsp;CryptBlocks&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3473306">copy</span><span class="op" id="3473310">(</span><span class="ident" id="3473311">x</span><span class="op" id="3473312">.</span><span class="ident" id="3473313">iv</span><span class="op" id="3473315">,</span>&nbsp;<span class="ident" id="3473317">iv</span><span class="op" id="3473319">)</span><br>
<span class="lineno"></span><span class="op" id="3473321">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3473324">func</span>&nbsp;<span class="op" id="3473329">(</span><span class="ident" id="3473330">x</span>&nbsp;<span class="op" id="3473332">*</span><span class="ident" id="3473333">cbcEncrypter</span><span class="op" id="3473345">)</span>&nbsp;<span class="ident" id="3473347">SetIV</span><span class="op" id="3473352">(</span><span class="ident" id="3473353">iv</span>&nbsp;<span class="op" id="3473356">[</span><span class="op" id="3473357">]</span><span class="builtintype" id="3473358">byte</span><span class="op" id="3473362">)</span>&nbsp;<span class="op" id="3473364">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3473367">if</span>&nbsp;<span class="builtinfunc" id="3473370">len</span><span class="op" id="3473373">(</span><span class="ident" id="3473374">iv</span><span class="op" id="3473376">)</span>&nbsp;<span class="op" id="3473378">!=</span>&nbsp;<span class="builtinfunc" id="3473381">len</span><span class="op" id="3473384">(</span><span class="ident" id="3473385">x</span><span class="op" id="3473386">.</span><span class="ident" id="3473387">iv</span><span class="op" id="3473389">)</span>&nbsp;<span class="op" id="3473391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3473395">panic</span><span class="op" id="3473400">(</span><span class="string" id="3473401">&#34;cipher:&nbsp;incorrect&nbsp;length&nbsp;IV&#34;</span><span class="op" id="3473430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3473433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3473436">copy</span><span class="op" id="3473440">(</span><span class="ident" id="3473441">x</span><span class="op" id="3473442">.</span><span class="ident" id="3473443">iv</span><span class="op" id="3473445">,</span>&nbsp;<span class="ident" id="3473447">iv</span><span class="op" id="3473449">)</span><br>
<span class="lineno"></span><span class="op" id="3473451">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="keyword" id="3473454">type</span>&nbsp;<span class="ident" id="3473459">cbcDecrypter</span>&nbsp;<span class="ident" id="3473472">cbc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3473477">//&nbsp;NewCBCDecrypter&nbsp;returns&nbsp;a&nbsp;BlockMode&nbsp;which&nbsp;decrypts&nbsp;in&nbsp;cipher&nbsp;block&nbsp;chaining</span><br>
<span class="lineno"></span><span class="comment" id="3473556">//&nbsp;mode,&nbsp;using&nbsp;the&nbsp;given&nbsp;Block.&nbsp;The&nbsp;length&nbsp;of&nbsp;iv&nbsp;must&nbsp;be&nbsp;the&nbsp;same&nbsp;as&nbsp;the</span><br>
<span class="lineno">80</span><span class="comment" id="3473629">//&nbsp;Block&#39;s&nbsp;block&nbsp;size&nbsp;and&nbsp;must&nbsp;match&nbsp;the&nbsp;iv&nbsp;used&nbsp;to&nbsp;encrypt&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="3473699">func</span>&nbsp;<span class="ident" id="3473704">NewCBCDecrypter</span><span class="op" id="3473719">(</span><span class="ident" id="3473720">b</span>&nbsp;<span class="ident" id="3473722">Block</span><span class="op" id="3473727">,</span>&nbsp;<span class="ident" id="3473729">iv</span>&nbsp;<span class="op" id="3473732">[</span><span class="op" id="3473733">]</span><span class="builtintype" id="3473734">byte</span><span class="op" id="3473738">)</span>&nbsp;<span class="ident" id="3473740">BlockMode</span>&nbsp;<span class="op" id="3473750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3473753">if</span>&nbsp;<span class="builtinfunc" id="3473756">len</span><span class="op" id="3473759">(</span><span class="ident" id="3473760">iv</span><span class="op" id="3473762">)</span>&nbsp;<span class="op" id="3473764">!=</span>&nbsp;<span class="ident" id="3473767">b</span><span class="op" id="3473768">.</span><span class="ident" id="3473769">BlockSize</span><span class="op" id="3473778">(</span><span class="op" id="3473779">)</span>&nbsp;<span class="op" id="3473781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3473785">panic</span><span class="op" id="3473790">(</span><span class="string" id="3473791">&#34;cipher.NewCBCDecrypter:&nbsp;IV&nbsp;length&nbsp;must&nbsp;equal&nbsp;block&nbsp;size&#34;</span><span class="op" id="3473848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3473851">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3473854">return</span>&nbsp;<span class="op" id="3473861">(</span><span class="op" id="3473862">*</span><span class="ident" id="3473863">cbcDecrypter</span><span class="op" id="3473875">)</span><span class="op" id="3473876">(</span><span class="ident" id="3473877">newCBC</span><span class="op" id="3473883">(</span><span class="ident" id="3473884">b</span><span class="op" id="3473885">,</span>&nbsp;<span class="ident" id="3473887">iv</span><span class="op" id="3473889">)</span><span class="op" id="3473890">)</span><br>
<span class="lineno"></span><span class="op" id="3473892">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3473895">func</span>&nbsp;<span class="op" id="3473900">(</span><span class="ident" id="3473901">x</span>&nbsp;<span class="op" id="3473903">*</span><span class="ident" id="3473904">cbcDecrypter</span><span class="op" id="3473916">)</span>&nbsp;<span class="ident" id="3473918">BlockSize</span><span class="op" id="3473927">(</span><span class="op" id="3473928">)</span>&nbsp;<span class="builtintype" id="3473930">int</span>&nbsp;<span class="op" id="3473934">{</span>&nbsp;<span class="keyword" id="3473936">return</span>&nbsp;<span class="ident" id="3473943">x</span><span class="op" id="3473944">.</span><span class="ident" id="3473945">blockSize</span>&nbsp;<span class="op" id="3473955">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="3473958">func</span>&nbsp;<span class="op" id="3473963">(</span><span class="ident" id="3473964">x</span>&nbsp;<span class="op" id="3473966">*</span><span class="ident" id="3473967">cbcDecrypter</span><span class="op" id="3473979">)</span>&nbsp;<span class="ident" id="3473981">CryptBlocks</span><span class="op" id="3473992">(</span><span class="ident" id="3473993">dst</span><span class="op" id="3473996">,</span>&nbsp;<span class="ident" id="3473998">src</span>&nbsp;<span class="op" id="3474002">[</span><span class="op" id="3474003">]</span><span class="builtintype" id="3474004">byte</span><span class="op" id="3474008">)</span>&nbsp;<span class="op" id="3474010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474013">if</span>&nbsp;<span class="builtinfunc" id="3474016">len</span><span class="op" id="3474019">(</span><span class="ident" id="3474020">src</span><span class="op" id="3474023">)</span><span class="op" id="3474024">%</span><span class="ident" id="3474025">x</span><span class="op" id="3474026">.</span><span class="ident" id="3474027">blockSize</span>&nbsp;<span class="op" id="3474037">!=</span>&nbsp;<span class="num" id="3474040">0</span>&nbsp;<span class="op" id="3474042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3474046">panic</span><span class="op" id="3474051">(</span><span class="string" id="3474052">&#34;crypto/cipher:&nbsp;input&nbsp;not&nbsp;full&nbsp;blocks&#34;</span><span class="op" id="3474090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3474093">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474096">if</span>&nbsp;<span class="builtinfunc" id="3474099">len</span><span class="op" id="3474102">(</span><span class="ident" id="3474103">dst</span><span class="op" id="3474106">)</span>&nbsp;<span class="op" id="3474108">&lt;</span>&nbsp;<span class="builtinfunc" id="3474110">len</span><span class="op" id="3474113">(</span><span class="ident" id="3474114">src</span><span class="op" id="3474117">)</span>&nbsp;<span class="op" id="3474119">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3474123">panic</span><span class="op" id="3474128">(</span><span class="string" id="3474129">&#34;crypto/cipher:&nbsp;output&nbsp;smaller&nbsp;than&nbsp;input&#34;</span><span class="op" id="3474171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3474174">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474177">if</span>&nbsp;<span class="builtinfunc" id="3474180">len</span><span class="op" id="3474183">(</span><span class="ident" id="3474184">src</span><span class="op" id="3474187">)</span>&nbsp;<span class="op" id="3474189">==</span>&nbsp;<span class="num" id="3474192">0</span>&nbsp;<span class="op" id="3474194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474198">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3474206">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3474210">//&nbsp;For&nbsp;each&nbsp;block,&nbsp;we&nbsp;need&nbsp;to&nbsp;xor&nbsp;the&nbsp;decrypted&nbsp;data&nbsp;with&nbsp;the&nbsp;previous&nbsp;block&#39;s&nbsp;ciphertext&nbsp;(the&nbsp;iv).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3474311">//&nbsp;To&nbsp;avoid&nbsp;making&nbsp;a&nbsp;copy&nbsp;each&nbsp;time,&nbsp;we&nbsp;loop&nbsp;over&nbsp;the&nbsp;blocks&nbsp;BACKWARDS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3474384">end</span>&nbsp;<span class="op" id="3474388">:=</span>&nbsp;<span class="builtinfunc" id="3474391">len</span><span class="op" id="3474394">(</span><span class="ident" id="3474395">src</span><span class="op" id="3474398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3474401">start</span>&nbsp;<span class="op" id="3474407">:=</span>&nbsp;<span class="ident" id="3474410">end</span>&nbsp;<span class="op" id="3474414">-</span>&nbsp;<span class="ident" id="3474416">x</span><span class="op" id="3474417">.</span><span class="ident" id="3474418">blockSize</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3474429">prev</span>&nbsp;<span class="op" id="3474434">:=</span>&nbsp;<span class="ident" id="3474437">start</span>&nbsp;<span class="op" id="3474443">-</span>&nbsp;<span class="ident" id="3474445">x</span><span class="op" id="3474446">.</span><span class="ident" id="3474447">blockSize</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3474459">//&nbsp;Copy&nbsp;the&nbsp;last&nbsp;block&nbsp;of&nbsp;ciphertext&nbsp;in&nbsp;preparation&nbsp;as&nbsp;the&nbsp;new&nbsp;iv.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3474527">copy</span><span class="op" id="3474531">(</span><span class="ident" id="3474532">x</span><span class="op" id="3474533">.</span><span class="ident" id="3474534">tmp</span><span class="op" id="3474537">,</span>&nbsp;<span class="ident" id="3474539">src</span><span class="op" id="3474542">[</span><span class="ident" id="3474543">start</span><span class="op" id="3474548">:</span><span class="ident" id="3474549">end</span><span class="op" id="3474552">]</span><span class="op" id="3474553">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3474557">//&nbsp;Loop&nbsp;over&nbsp;all&nbsp;but&nbsp;the&nbsp;first&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474596">for</span>&nbsp;<span class="ident" id="3474600">start</span>&nbsp;<span class="op" id="3474606">&gt;</span>&nbsp;<span class="num" id="3474608">0</span>&nbsp;<span class="op" id="3474610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3474614">x</span><span class="op" id="3474615">.</span><span class="ident" id="3474616">b</span><span class="op" id="3474617">.</span><span class="ident" id="3474618">Decrypt</span><span class="op" id="3474625">(</span><span class="ident" id="3474626">dst</span><span class="op" id="3474629">[</span><span class="ident" id="3474630">start</span><span class="op" id="3474635">:</span><span class="ident" id="3474636">end</span><span class="op" id="3474639">]</span><span class="op" id="3474640">,</span>&nbsp;<span class="ident" id="3474642">src</span><span class="op" id="3474645">[</span><span class="ident" id="3474646">start</span><span class="op" id="3474651">:</span><span class="ident" id="3474652">end</span><span class="op" id="3474655">]</span><span class="op" id="3474656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3474660">xorBytes</span><span class="op" id="3474668">(</span><span class="ident" id="3474669">dst</span><span class="op" id="3474672">[</span><span class="ident" id="3474673">start</span><span class="op" id="3474678">:</span><span class="ident" id="3474679">end</span><span class="op" id="3474682">]</span><span class="op" id="3474683">,</span>&nbsp;<span class="ident" id="3474685">dst</span><span class="op" id="3474688">[</span><span class="ident" id="3474689">start</span><span class="op" id="3474694">:</span><span class="ident" id="3474695">end</span><span class="op" id="3474698">]</span><span class="op" id="3474699">,</span>&nbsp;<span class="ident" id="3474701">src</span><span class="op" id="3474704">[</span><span class="ident" id="3474705">prev</span><span class="op" id="3474709">:</span><span class="ident" id="3474710">start</span><span class="op" id="3474715">]</span><span class="op" id="3474716">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3474721">end</span>&nbsp;<span class="op" id="3474725">=</span>&nbsp;<span class="ident" id="3474727">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3474735">start</span>&nbsp;<span class="op" id="3474741">=</span>&nbsp;<span class="ident" id="3474743">prev</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3474750">prev</span>&nbsp;<span class="op" id="3474755">-=</span>&nbsp;<span class="ident" id="3474758">x</span><span class="op" id="3474759">.</span><span class="ident" id="3474760">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3474771">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3474775">//&nbsp;The&nbsp;first&nbsp;block&nbsp;is&nbsp;special&nbsp;because&nbsp;it&nbsp;uses&nbsp;the&nbsp;saved&nbsp;iv.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3474836">x</span><span class="op" id="3474837">.</span><span class="ident" id="3474838">b</span><span class="op" id="3474839">.</span><span class="ident" id="3474840">Decrypt</span><span class="op" id="3474847">(</span><span class="ident" id="3474848">dst</span><span class="op" id="3474851">[</span><span class="ident" id="3474852">start</span><span class="op" id="3474857">:</span><span class="ident" id="3474858">end</span><span class="op" id="3474861">]</span><span class="op" id="3474862">,</span>&nbsp;<span class="ident" id="3474864">src</span><span class="op" id="3474867">[</span><span class="ident" id="3474868">start</span><span class="op" id="3474873">:</span><span class="ident" id="3474874">end</span><span class="op" id="3474877">]</span><span class="op" id="3474878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3474881">xorBytes</span><span class="op" id="3474889">(</span><span class="ident" id="3474890">dst</span><span class="op" id="3474893">[</span><span class="ident" id="3474894">start</span><span class="op" id="3474899">:</span><span class="ident" id="3474900">end</span><span class="op" id="3474903">]</span><span class="op" id="3474904">,</span>&nbsp;<span class="ident" id="3474906">dst</span><span class="op" id="3474909">[</span><span class="ident" id="3474910">start</span><span class="op" id="3474915">:</span><span class="ident" id="3474916">end</span><span class="op" id="3474919">]</span><span class="op" id="3474920">,</span>&nbsp;<span class="ident" id="3474922">x</span><span class="op" id="3474923">.</span><span class="ident" id="3474924">iv</span><span class="op" id="3474926">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3474930">//&nbsp;Set&nbsp;the&nbsp;new&nbsp;iv&nbsp;to&nbsp;the&nbsp;first&nbsp;block&nbsp;we&nbsp;copied&nbsp;earlier.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3474987">x</span><span class="op" id="3474988">.</span><span class="ident" id="3474989">iv</span><span class="op" id="3474991">,</span>&nbsp;<span class="ident" id="3474993">x</span><span class="op" id="3474994">.</span><span class="ident" id="3474995">tmp</span>&nbsp;<span class="op" id="3474999">=</span>&nbsp;<span class="ident" id="3475001">x</span><span class="op" id="3475002">.</span><span class="ident" id="3475003">tmp</span><span class="op" id="3475006">,</span>&nbsp;<span class="ident" id="3475008">x</span><span class="op" id="3475009">.</span><span class="ident" id="3475010">iv</span><br>
<span class="lineno"></span><span class="op" id="3475013">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3475016">func</span>&nbsp;<span class="op" id="3475021">(</span><span class="ident" id="3475022">x</span>&nbsp;<span class="op" id="3475024">*</span><span class="ident" id="3475025">cbcDecrypter</span><span class="op" id="3475037">)</span>&nbsp;<span class="ident" id="3475039">SetIV</span><span class="op" id="3475044">(</span><span class="ident" id="3475045">iv</span>&nbsp;<span class="op" id="3475048">[</span><span class="op" id="3475049">]</span><span class="builtintype" id="3475050">byte</span><span class="op" id="3475054">)</span>&nbsp;<span class="op" id="3475056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3475059">if</span>&nbsp;<span class="builtinfunc" id="3475062">len</span><span class="op" id="3475065">(</span><span class="ident" id="3475066">iv</span><span class="op" id="3475068">)</span>&nbsp;<span class="op" id="3475070">!=</span>&nbsp;<span class="builtinfunc" id="3475073">len</span><span class="op" id="3475076">(</span><span class="ident" id="3475077">x</span><span class="op" id="3475078">.</span><span class="ident" id="3475079">iv</span><span class="op" id="3475081">)</span>&nbsp;<span class="op" id="3475083">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3475087">panic</span><span class="op" id="3475092">(</span><span class="string" id="3475093">&#34;cipher:&nbsp;incorrect&nbsp;length&nbsp;IV&#34;</span><span class="op" id="3475122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3475125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3475128">copy</span><span class="op" id="3475132">(</span><span class="ident" id="3475133">x</span><span class="op" id="3475134">.</span><span class="ident" id="3475135">iv</span><span class="op" id="3475137">,</span>&nbsp;<span class="ident" id="3475139">iv</span><span class="op" id="3475141">)</span><br>
<span class="lineno"></span><span class="op" id="3475143">}</span>
</div>
</body>
</html>
