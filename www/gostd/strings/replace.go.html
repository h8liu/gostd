<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>strings</h2>
<ul>
<li><a href="/gostd/strings/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/strings/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/strings/reader.go.html">reader.go</a></li>
<li><a href="/gostd/strings/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/strings/replace.go.html" class="current">replace.go</a></li>
<li><a href="/gostd/strings/replace_test.go.html">replace_test.go</a></li>
<li><a href="/gostd/strings/search.go.html">search.go</a></li>
<li><a href="/gostd/strings/search_test.go.html">search_test.go</a></li>
<li><a href="/gostd/strings/strings.go.html">strings.go</a></li>
<li><a href="/gostd/strings/strings_decl.go.html">strings_decl.go</a></li>
<li><a href="/gostd/strings/strings_test.go.html">strings_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2289367">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2289422">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2289476">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="2289527">package</span>&nbsp;<span class="ident" id="2289535">strings</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2289544">import</span>&nbsp;<span class="string" id="2289551">&#34;io&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2289557">//&nbsp;Replacer&nbsp;replaces&nbsp;a&nbsp;list&nbsp;of&nbsp;strings&nbsp;with&nbsp;replacements.</span><br>
<span class="lineno">10</span><span class="comment" id="2289615">//&nbsp;It&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="2289672">type</span>&nbsp;<span class="ident" id="2289677">Replacer</span>&nbsp;<span class="keyword" id="2289686">struct</span>&nbsp;<span class="op" id="2289693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2289696">r</span>&nbsp;<span class="ident" id="2289698">replacer</span><br>
<span class="lineno"></span><span class="op" id="2289707">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="2289710">//&nbsp;replacer&nbsp;is&nbsp;the&nbsp;interface&nbsp;that&nbsp;a&nbsp;replacement&nbsp;algorithm&nbsp;needs&nbsp;to&nbsp;implement.</span><br>
<span class="lineno"></span><span class="keyword" id="2289788">type</span>&nbsp;<span class="ident" id="2289793">replacer</span>&nbsp;<span class="keyword" id="2289802">interface</span>&nbsp;<span class="op" id="2289812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2289815">Replace</span><span class="op" id="2289822">(</span><span class="ident" id="2289823">s</span>&nbsp;<span class="builtintype" id="2289825">string</span><span class="op" id="2289831">)</span>&nbsp;<span class="builtintype" id="2289833">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2289841">WriteString</span><span class="op" id="2289852">(</span><span class="ident" id="2289853">w</span>&nbsp;<span class="ident" id="2289855">io</span><span class="op" id="2289857">.</span><span class="ident" id="2289858">Writer</span><span class="op" id="2289864">,</span>&nbsp;<span class="ident" id="2289866">s</span>&nbsp;<span class="builtintype" id="2289868">string</span><span class="op" id="2289874">)</span>&nbsp;<span class="op" id="2289876">(</span><span class="ident" id="2289877">n</span>&nbsp;<span class="builtintype" id="2289879">int</span><span class="op" id="2289882">,</span>&nbsp;<span class="ident" id="2289884">err</span>&nbsp;<span class="builtintype" id="2289888">error</span><span class="op" id="2289893">)</span><br>
<span class="lineno"></span><span class="op" id="2289895">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="2289898">//&nbsp;NewReplacer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Replacer&nbsp;from&nbsp;a&nbsp;list&nbsp;of&nbsp;old,&nbsp;new&nbsp;string&nbsp;pairs.</span><br>
<span class="lineno"></span><span class="comment" id="2289974">//&nbsp;Replacements&nbsp;are&nbsp;performed&nbsp;in&nbsp;order,&nbsp;without&nbsp;overlapping&nbsp;matches.</span><br>
<span class="lineno"></span><span class="keyword" id="2290043">func</span>&nbsp;<span class="ident" id="2290048">NewReplacer</span><span class="op" id="2290059">(</span><span class="ident" id="2290060">oldnew</span>&nbsp;<span class="op" id="2290067">...</span><span class="builtintype" id="2290070">string</span><span class="op" id="2290076">)</span>&nbsp;<span class="op" id="2290078">*</span><span class="ident" id="2290079">Replacer</span>&nbsp;<span class="op" id="2290088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2290091">if</span>&nbsp;<span class="builtinfunc" id="2290094">len</span><span class="op" id="2290097">(</span><span class="ident" id="2290098">oldnew</span><span class="op" id="2290104">)</span><span class="op" id="2290105">%</span><span class="num" id="2290106">2</span>&nbsp;<span class="op" id="2290108">==</span>&nbsp;<span class="num" id="2290111">1</span>&nbsp;<span class="op" id="2290113">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="2290117">panic</span><span class="op" id="2290122">(</span><span class="string" id="2290123">&#34;strings.NewReplacer:&nbsp;odd&nbsp;argument&nbsp;count&#34;</span><span class="op" id="2290164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2290167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2290171">if</span>&nbsp;<span class="builtinfunc" id="2290174">len</span><span class="op" id="2290177">(</span><span class="ident" id="2290178">oldnew</span><span class="op" id="2290184">)</span>&nbsp;<span class="op" id="2290186">==</span>&nbsp;<span class="num" id="2290189">2</span>&nbsp;<span class="op" id="2290191">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="2290194">len</span><span class="op" id="2290197">(</span><span class="ident" id="2290198">oldnew</span><span class="op" id="2290204">[</span><span class="num" id="2290205">0</span><span class="op" id="2290206">]</span><span class="op" id="2290207">)</span>&nbsp;<span class="op" id="2290209">&gt;</span>&nbsp;<span class="num" id="2290211">1</span>&nbsp;<span class="op" id="2290213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2290217">return</span>&nbsp;<span class="op" id="2290224">&amp;</span><span class="ident" id="2290225">Replacer</span><span class="op" id="2290233">{</span><span class="ident" id="2290234">r</span><span class="op" id="2290235">:</span>&nbsp;<span class="ident" id="2290237">makeSingleStringReplacer</span><span class="op" id="2290261">(</span><span class="ident" id="2290262">oldnew</span><span class="op" id="2290268">[</span><span class="num" id="2290269">0</span><span class="op" id="2290270">]</span><span class="op" id="2290271">,</span>&nbsp;<span class="ident" id="2290273">oldnew</span><span class="op" id="2290279">[</span><span class="num" id="2290280">1</span><span class="op" id="2290281">]</span><span class="op" id="2290282">)</span><span class="op" id="2290283">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2290286">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2290290">allNewBytes</span>&nbsp;<span class="op" id="2290302">:=</span>&nbsp;<span class="builtintype" id="2290305">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2290311">for</span>&nbsp;<span class="ident" id="2290315">i</span>&nbsp;<span class="op" id="2290317">:=</span>&nbsp;<span class="num" id="2290320">0</span><span class="op" id="2290321">;</span>&nbsp;<span class="ident" id="2290323">i</span>&nbsp;<span class="op" id="2290325">&lt;</span>&nbsp;<span class="builtinfunc" id="2290327">len</span><span class="op" id="2290330">(</span><span class="ident" id="2290331">oldnew</span><span class="op" id="2290337">)</span><span class="op" id="2290338">;</span>&nbsp;<span class="ident" id="2290340">i</span>&nbsp;<span class="op" id="2290342">+=</span>&nbsp;<span class="num" id="2290345">2</span>&nbsp;<span class="op" id="2290347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2290351">if</span>&nbsp;<span class="builtinfunc" id="2290354">len</span><span class="op" id="2290357">(</span><span class="ident" id="2290358">oldnew</span><span class="op" id="2290364">[</span><span class="ident" id="2290365">i</span><span class="op" id="2290366">]</span><span class="op" id="2290367">)</span>&nbsp;<span class="op" id="2290369">!=</span>&nbsp;<span class="num" id="2290372">1</span>&nbsp;<span class="op" id="2290374">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2290379">return</span>&nbsp;<span class="op" id="2290386">&amp;</span><span class="ident" id="2290387">Replacer</span><span class="op" id="2290395">{</span><span class="ident" id="2290396">r</span><span class="op" id="2290397">:</span>&nbsp;<span class="ident" id="2290399">makeGenericReplacer</span><span class="op" id="2290418">(</span><span class="ident" id="2290419">oldnew</span><span class="op" id="2290425">)</span><span class="op" id="2290426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2290430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2290434">if</span>&nbsp;<span class="builtinfunc" id="2290437">len</span><span class="op" id="2290440">(</span><span class="ident" id="2290441">oldnew</span><span class="op" id="2290447">[</span><span class="ident" id="2290448">i</span><span class="op" id="2290449">+</span><span class="num" id="2290450">1</span><span class="op" id="2290451">]</span><span class="op" id="2290452">)</span>&nbsp;<span class="op" id="2290454">!=</span>&nbsp;<span class="num" id="2290457">1</span>&nbsp;<span class="op" id="2290459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2290464">allNewBytes</span>&nbsp;<span class="op" id="2290476">=</span>&nbsp;<span class="builtintype" id="2290478">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2290486">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2290489">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2290493">if</span>&nbsp;<span class="ident" id="2290496">allNewBytes</span>&nbsp;<span class="op" id="2290508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2290512">r</span>&nbsp;<span class="op" id="2290514">:=</span>&nbsp;<span class="ident" id="2290517">byteReplacer</span><span class="op" id="2290529">{</span><span class="op" id="2290530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2290534">for</span>&nbsp;<span class="ident" id="2290538">i</span>&nbsp;<span class="op" id="2290540">:=</span>&nbsp;<span class="keyword" id="2290543">range</span>&nbsp;<span class="ident" id="2290549">r</span>&nbsp;<span class="op" id="2290551">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2290556">r</span><span class="op" id="2290557">[</span><span class="ident" id="2290558">i</span><span class="op" id="2290559">]</span>&nbsp;<span class="op" id="2290561">=</span>&nbsp;<span class="builtintype" id="2290563">byte</span><span class="op" id="2290567">(</span><span class="ident" id="2290568">i</span><span class="op" id="2290569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2290573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2290577">//&nbsp;The&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;old-&gt;new&nbsp;map&nbsp;takes&nbsp;precedence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2290636">//&nbsp;over&nbsp;the&nbsp;others&nbsp;with&nbsp;the&nbsp;same&nbsp;old&nbsp;string.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2290683">for</span>&nbsp;<span class="ident" id="2290687">i</span>&nbsp;<span class="op" id="2290689">:=</span>&nbsp;<span class="builtinfunc" id="2290692">len</span><span class="op" id="2290695">(</span><span class="ident" id="2290696">oldnew</span><span class="op" id="2290702">)</span>&nbsp;<span class="op" id="2290704">-</span>&nbsp;<span class="num" id="2290706">2</span><span class="op" id="2290707">;</span>&nbsp;<span class="ident" id="2290709">i</span>&nbsp;<span class="op" id="2290711">&gt;=</span>&nbsp;<span class="num" id="2290714">0</span><span class="op" id="2290715">;</span>&nbsp;<span class="ident" id="2290717">i</span>&nbsp;<span class="op" id="2290719">-=</span>&nbsp;<span class="num" id="2290722">2</span>&nbsp;<span class="op" id="2290724">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2290729">o</span>&nbsp;<span class="op" id="2290731">:=</span>&nbsp;<span class="ident" id="2290734">oldnew</span><span class="op" id="2290740">[</span><span class="ident" id="2290741">i</span><span class="op" id="2290742">]</span><span class="op" id="2290743">[</span><span class="num" id="2290744">0</span><span class="op" id="2290745">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2290750">n</span>&nbsp;<span class="op" id="2290752">:=</span>&nbsp;<span class="ident" id="2290755">oldnew</span><span class="op" id="2290761">[</span><span class="ident" id="2290762">i</span><span class="op" id="2290763">+</span><span class="num" id="2290764">1</span><span class="op" id="2290765">]</span><span class="op" id="2290766">[</span><span class="num" id="2290767">0</span><span class="op" id="2290768">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2290773">r</span><span class="op" id="2290774">[</span><span class="ident" id="2290775">o</span><span class="op" id="2290776">]</span>&nbsp;<span class="op" id="2290778">=</span>&nbsp;<span class="ident" id="2290780">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2290784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2290788">return</span>&nbsp;<span class="op" id="2290795">&amp;</span><span class="ident" id="2290796">Replacer</span><span class="op" id="2290804">{</span><span class="ident" id="2290805">r</span><span class="op" id="2290806">:</span>&nbsp;<span class="op" id="2290808">&amp;</span><span class="ident" id="2290809">r</span><span class="op" id="2290810">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2290813">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2290817">r</span>&nbsp;<span class="op" id="2290819">:=</span>&nbsp;<span class="ident" id="2290822">byteStringReplacer</span><span class="op" id="2290840">{</span><span class="op" id="2290841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2290844">//&nbsp;The&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;old-&gt;new&nbsp;map&nbsp;takes&nbsp;precedence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2290902">//&nbsp;over&nbsp;the&nbsp;others&nbsp;with&nbsp;the&nbsp;same&nbsp;old&nbsp;string.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2290948">for</span>&nbsp;<span class="ident" id="2290952">i</span>&nbsp;<span class="op" id="2290954">:=</span>&nbsp;<span class="builtinfunc" id="2290957">len</span><span class="op" id="2290960">(</span><span class="ident" id="2290961">oldnew</span><span class="op" id="2290967">)</span>&nbsp;<span class="op" id="2290969">-</span>&nbsp;<span class="num" id="2290971">2</span><span class="op" id="2290972">;</span>&nbsp;<span class="ident" id="2290974">i</span>&nbsp;<span class="op" id="2290976">&gt;=</span>&nbsp;<span class="num" id="2290979">0</span><span class="op" id="2290980">;</span>&nbsp;<span class="ident" id="2290982">i</span>&nbsp;<span class="op" id="2290984">-=</span>&nbsp;<span class="num" id="2290987">2</span>&nbsp;<span class="op" id="2290989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2290993">o</span>&nbsp;<span class="op" id="2290995">:=</span>&nbsp;<span class="ident" id="2290998">oldnew</span><span class="op" id="2291004">[</span><span class="ident" id="2291005">i</span><span class="op" id="2291006">]</span><span class="op" id="2291007">[</span><span class="num" id="2291008">0</span><span class="op" id="2291009">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2291013">n</span>&nbsp;<span class="op" id="2291015">:=</span>&nbsp;<span class="ident" id="2291018">oldnew</span><span class="op" id="2291024">[</span><span class="ident" id="2291025">i</span><span class="op" id="2291026">+</span><span class="num" id="2291027">1</span><span class="op" id="2291028">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2291032">r</span><span class="op" id="2291033">[</span><span class="ident" id="2291034">o</span><span class="op" id="2291035">]</span>&nbsp;<span class="op" id="2291037">=</span>&nbsp;<span class="op" id="2291039">[</span><span class="op" id="2291040">]</span><span class="builtintype" id="2291041">byte</span><span class="op" id="2291045">(</span><span class="ident" id="2291046">n</span><span class="op" id="2291047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2291050">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2291053">return</span>&nbsp;<span class="op" id="2291060">&amp;</span><span class="ident" id="2291061">Replacer</span><span class="op" id="2291069">{</span><span class="ident" id="2291070">r</span><span class="op" id="2291071">:</span>&nbsp;<span class="op" id="2291073">&amp;</span><span class="ident" id="2291074">r</span><span class="op" id="2291075">}</span><br>
<span class="lineno"></span><span class="op" id="2291077">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2291080">//&nbsp;Replace&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;s&nbsp;with&nbsp;all&nbsp;replacements&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword" id="2291144">func</span>&nbsp;<span class="op" id="2291149">(</span><span class="ident" id="2291150">r</span>&nbsp;<span class="op" id="2291152">*</span><span class="ident" id="2291153">Replacer</span><span class="op" id="2291161">)</span>&nbsp;<span class="ident" id="2291163">Replace</span><span class="op" id="2291170">(</span><span class="ident" id="2291171">s</span>&nbsp;<span class="builtintype" id="2291173">string</span><span class="op" id="2291179">)</span>&nbsp;<span class="builtintype" id="2291181">string</span>&nbsp;<span class="op" id="2291188">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2291191">return</span>&nbsp;<span class="ident" id="2291198">r</span><span class="op" id="2291199">.</span><span class="ident" id="2291200">r</span><span class="op" id="2291201">.</span><span class="ident" id="2291202">Replace</span><span class="op" id="2291209">(</span><span class="ident" id="2291210">s</span><span class="op" id="2291211">)</span><br>
<span class="lineno"></span><span class="op" id="2291213">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2291216">//&nbsp;WriteString&nbsp;writes&nbsp;s&nbsp;to&nbsp;w&nbsp;with&nbsp;all&nbsp;replacements&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword" id="2291278">func</span>&nbsp;<span class="op" id="2291283">(</span><span class="ident" id="2291284">r</span>&nbsp;<span class="op" id="2291286">*</span><span class="ident" id="2291287">Replacer</span><span class="op" id="2291295">)</span>&nbsp;<span class="ident" id="2291297">WriteString</span><span class="op" id="2291308">(</span><span class="ident" id="2291309">w</span>&nbsp;<span class="ident" id="2291311">io</span><span class="op" id="2291313">.</span><span class="ident" id="2291314">Writer</span><span class="op" id="2291320">,</span>&nbsp;<span class="ident" id="2291322">s</span>&nbsp;<span class="builtintype" id="2291324">string</span><span class="op" id="2291330">)</span>&nbsp;<span class="op" id="2291332">(</span><span class="ident" id="2291333">n</span>&nbsp;<span class="builtintype" id="2291335">int</span><span class="op" id="2291338">,</span>&nbsp;<span class="ident" id="2291340">err</span>&nbsp;<span class="builtintype" id="2291344">error</span><span class="op" id="2291349">)</span>&nbsp;<span class="op" id="2291351">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2291354">return</span>&nbsp;<span class="ident" id="2291361">r</span><span class="op" id="2291362">.</span><span class="ident" id="2291363">r</span><span class="op" id="2291364">.</span><span class="ident" id="2291365">WriteString</span><span class="op" id="2291376">(</span><span class="ident" id="2291377">w</span><span class="op" id="2291378">,</span>&nbsp;<span class="ident" id="2291380">s</span><span class="op" id="2291381">)</span><br>
<span class="lineno"></span><span class="op" id="2291383">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2291386">//&nbsp;trieNode&nbsp;is&nbsp;a&nbsp;node&nbsp;in&nbsp;a&nbsp;lookup&nbsp;trie&nbsp;for&nbsp;prioritized&nbsp;key/value&nbsp;pairs.&nbsp;Keys</span><br>
<span class="lineno"></span><span class="comment" id="2291463">//&nbsp;and&nbsp;values&nbsp;may&nbsp;be&nbsp;empty.&nbsp;For&nbsp;example,&nbsp;the&nbsp;trie&nbsp;containing&nbsp;keys&nbsp;&#34;ax&#34;,&nbsp;&#34;ay&#34;,</span><br>
<span class="lineno">80</span><span class="comment" id="2291541">//&nbsp;&#34;bcbc&#34;,&nbsp;&#34;x&#34;&nbsp;and&nbsp;&#34;xy&#34;&nbsp;could&nbsp;have&nbsp;eight&nbsp;nodes:</span><br>
<span class="lineno"></span><span class="comment" id="2291589">//</span><br>
<span class="lineno"></span><span class="comment" id="2291592">//&nbsp;&nbsp;n0&nbsp;&nbsp;-</span><br>
<span class="lineno"></span><span class="comment" id="2291602">//&nbsp;&nbsp;n1&nbsp;&nbsp;a-</span><br>
<span class="lineno"></span><span class="comment" id="2291613">//&nbsp;&nbsp;n2&nbsp;&nbsp;.x+</span><br>
<span class="lineno">85</span><span class="comment" id="2291625">//&nbsp;&nbsp;n3&nbsp;&nbsp;.y+</span><br>
<span class="lineno"></span><span class="comment" id="2291637">//&nbsp;&nbsp;n4&nbsp;&nbsp;b-</span><br>
<span class="lineno"></span><span class="comment" id="2291648">//&nbsp;&nbsp;n5&nbsp;&nbsp;.cbc+</span><br>
<span class="lineno"></span><span class="comment" id="2291662">//&nbsp;&nbsp;n6&nbsp;&nbsp;x+</span><br>
<span class="lineno"></span><span class="comment" id="2291673">//&nbsp;&nbsp;n7&nbsp;&nbsp;.y+</span><br>
<span class="lineno">90</span><span class="comment" id="2291685">//</span><br>
<span class="lineno"></span><span class="comment" id="2291688">//&nbsp;n0&nbsp;is&nbsp;the&nbsp;root&nbsp;node,&nbsp;and&nbsp;its&nbsp;children&nbsp;are&nbsp;n1,&nbsp;n4&nbsp;and&nbsp;n6;&nbsp;n1&#39;s&nbsp;children&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="2291766">//&nbsp;n2&nbsp;and&nbsp;n3;&nbsp;n4&#39;s&nbsp;child&nbsp;is&nbsp;n5;&nbsp;n6&#39;s&nbsp;child&nbsp;is&nbsp;n7.&nbsp;Nodes&nbsp;n0,&nbsp;n1&nbsp;and&nbsp;n4&nbsp;(marked</span><br>
<span class="lineno"></span><span class="comment" id="2291844">//&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;-&#34;)&nbsp;are&nbsp;partial&nbsp;keys,&nbsp;and&nbsp;nodes&nbsp;n2,&nbsp;n3,&nbsp;n5,&nbsp;n6&nbsp;and&nbsp;n7</span><br>
<span class="lineno"></span><span class="comment" id="2291918">//&nbsp;(marked&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;+&#34;)&nbsp;are&nbsp;complete&nbsp;keys.</span><br>
<span class="lineno">95</span><span class="keyword" id="2291969">type</span>&nbsp;<span class="ident" id="2291974">trieNode</span>&nbsp;<span class="keyword" id="2291983">struct</span>&nbsp;<span class="op" id="2291990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2291993">//&nbsp;value&nbsp;is&nbsp;the&nbsp;value&nbsp;of&nbsp;the&nbsp;trie&nbsp;node&#39;s&nbsp;key/value&nbsp;pair.&nbsp;It&nbsp;is&nbsp;empty&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2292066">//&nbsp;this&nbsp;node&nbsp;is&nbsp;not&nbsp;a&nbsp;complete&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2292103">value</span>&nbsp;<span class="builtintype" id="2292109">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2292117">//&nbsp;priority&nbsp;is&nbsp;the&nbsp;priority&nbsp;(higher&nbsp;is&nbsp;more&nbsp;important)&nbsp;of&nbsp;the&nbsp;trie&nbsp;node&#39;s</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2292192">//&nbsp;key/value&nbsp;pair;&nbsp;keys&nbsp;are&nbsp;not&nbsp;necessarily&nbsp;matched&nbsp;shortest-&nbsp;or&nbsp;longest-</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2292267">//&nbsp;first.&nbsp;Priority&nbsp;is&nbsp;positive&nbsp;if&nbsp;this&nbsp;node&nbsp;is&nbsp;a&nbsp;complete&nbsp;key,&nbsp;and&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2292340">//&nbsp;otherwise.&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;positive/zero&nbsp;priorities&nbsp;are&nbsp;marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2292413">//&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;+&#34;&nbsp;or&nbsp;&#34;-&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2292445">priority</span>&nbsp;<span class="builtintype" id="2292454">int</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2292460">//&nbsp;A&nbsp;trie&nbsp;node&nbsp;may&nbsp;have&nbsp;zero,&nbsp;one&nbsp;or&nbsp;more&nbsp;child&nbsp;nodes:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2292516">//&nbsp;&nbsp;*&nbsp;if&nbsp;the&nbsp;remaining&nbsp;fields&nbsp;are&nbsp;zero,&nbsp;there&nbsp;are&nbsp;no&nbsp;children.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2292580">//&nbsp;&nbsp;*&nbsp;if&nbsp;prefix&nbsp;and&nbsp;next&nbsp;are&nbsp;non-zero,&nbsp;there&nbsp;is&nbsp;one&nbsp;child&nbsp;in&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2292648">//&nbsp;&nbsp;*&nbsp;if&nbsp;table&nbsp;is&nbsp;non-zero,&nbsp;it&nbsp;defines&nbsp;all&nbsp;the&nbsp;children.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2292706">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2292710">//&nbsp;Prefixes&nbsp;are&nbsp;preferred&nbsp;over&nbsp;tables&nbsp;when&nbsp;there&nbsp;is&nbsp;one&nbsp;child,&nbsp;but&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2292782">//&nbsp;root&nbsp;node&nbsp;always&nbsp;uses&nbsp;a&nbsp;table&nbsp;for&nbsp;lookup&nbsp;efficiency.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2292840">//&nbsp;prefix&nbsp;is&nbsp;the&nbsp;difference&nbsp;in&nbsp;keys&nbsp;between&nbsp;this&nbsp;trie&nbsp;node&nbsp;and&nbsp;the&nbsp;next.</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2292914">//&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;node&nbsp;n4&nbsp;has&nbsp;prefix&nbsp;&#34;cbc&#34;&nbsp;and&nbsp;n4&#39;s&nbsp;next&nbsp;node&nbsp;is&nbsp;n5.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2292991">//&nbsp;Node&nbsp;n5&nbsp;has&nbsp;no&nbsp;children&nbsp;and&nbsp;so&nbsp;has&nbsp;zero&nbsp;prefix,&nbsp;next&nbsp;and&nbsp;table&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2293066">prefix</span>&nbsp;<span class="builtintype" id="2293073">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2293081">next</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2293088">*</span><span class="ident" id="2293089">trieNode</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2293100">//&nbsp;table&nbsp;is&nbsp;a&nbsp;lookup&nbsp;table&nbsp;indexed&nbsp;by&nbsp;the&nbsp;next&nbsp;byte&nbsp;in&nbsp;the&nbsp;key,&nbsp;after</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2293171">//&nbsp;remapping&nbsp;that&nbsp;byte&nbsp;through&nbsp;genericReplacer.mapping&nbsp;to&nbsp;create&nbsp;a&nbsp;dense</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2293245">//&nbsp;index.&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;the&nbsp;keys&nbsp;only&nbsp;use&nbsp;&#39;a&#39;,&nbsp;&#39;b&#39;,&nbsp;&#39;c&#39;,&nbsp;&#39;x&#39;&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2293319">//&nbsp;&#39;y&#39;,&nbsp;which&nbsp;remap&nbsp;to&nbsp;0,&nbsp;1,&nbsp;2,&nbsp;3&nbsp;and&nbsp;4.&nbsp;All&nbsp;other&nbsp;bytes&nbsp;remap&nbsp;to&nbsp;5,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2293393">//&nbsp;genericReplacer.tableSize&nbsp;will&nbsp;be&nbsp;5.&nbsp;Node&nbsp;n0&#39;s&nbsp;table&nbsp;will&nbsp;be</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2293458">//&nbsp;[]*trieNode{&nbsp;0:n1,&nbsp;1:n4,&nbsp;3:n6&nbsp;},&nbsp;where&nbsp;the&nbsp;0,&nbsp;1&nbsp;and&nbsp;3&nbsp;are&nbsp;the&nbsp;remapped</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2293533">//&nbsp;&#39;a&#39;,&nbsp;&#39;b&#39;&nbsp;and&nbsp;&#39;x&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2293555">table</span>&nbsp;<span class="op" id="2293561">[</span><span class="op" id="2293562">]</span><span class="op" id="2293563">*</span><span class="ident" id="2293564">trieNode</span><br>
<span class="lineno"></span><span class="op" id="2293573">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="2293576">func</span>&nbsp;<span class="op" id="2293581">(</span><span class="ident" id="2293582">t</span>&nbsp;<span class="op" id="2293584">*</span><span class="ident" id="2293585">trieNode</span><span class="op" id="2293593">)</span>&nbsp;<span class="ident" id="2293595">add</span><span class="op" id="2293598">(</span><span class="ident" id="2293599">key</span><span class="op" id="2293602">,</span>&nbsp;<span class="ident" id="2293604">val</span>&nbsp;<span class="builtintype" id="2293608">string</span><span class="op" id="2293614">,</span>&nbsp;<span class="ident" id="2293616">priority</span>&nbsp;<span class="builtintype" id="2293625">int</span><span class="op" id="2293628">,</span>&nbsp;<span class="ident" id="2293630">r</span>&nbsp;<span class="op" id="2293632">*</span><span class="ident" id="2293633">genericReplacer</span><span class="op" id="2293648">)</span>&nbsp;<span class="op" id="2293650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2293653">if</span>&nbsp;<span class="ident" id="2293656">key</span>&nbsp;<span class="op" id="2293660">==</span>&nbsp;<span class="string" id="2293663">&#34;&#34;</span>&nbsp;<span class="op" id="2293666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2293670">if</span>&nbsp;<span class="ident" id="2293673">t</span><span class="op" id="2293674">.</span><span class="ident" id="2293675">priority</span>&nbsp;<span class="op" id="2293684">==</span>&nbsp;<span class="num" id="2293687">0</span>&nbsp;<span class="op" id="2293689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2293694">t</span><span class="op" id="2293695">.</span><span class="ident" id="2293696">value</span>&nbsp;<span class="op" id="2293702">=</span>&nbsp;<span class="ident" id="2293704">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2293711">t</span><span class="op" id="2293712">.</span><span class="ident" id="2293713">priority</span>&nbsp;<span class="op" id="2293722">=</span>&nbsp;<span class="ident" id="2293724">priority</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2293735">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2293739">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2293747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2293751">if</span>&nbsp;<span class="ident" id="2293754">t</span><span class="op" id="2293755">.</span><span class="ident" id="2293756">prefix</span>&nbsp;<span class="op" id="2293763">!=</span>&nbsp;<span class="string" id="2293766">&#34;&#34;</span>&nbsp;<span class="op" id="2293769">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2293773">//&nbsp;Need&nbsp;to&nbsp;split&nbsp;the&nbsp;prefix&nbsp;among&nbsp;multiple&nbsp;nodes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2293825">var</span>&nbsp;<span class="ident" id="2293829">n</span>&nbsp;<span class="builtintype" id="2293831">int</span>&nbsp;<span class="comment" id="2293835">//&nbsp;length&nbsp;of&nbsp;the&nbsp;longest&nbsp;common&nbsp;prefix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2293876">for</span>&nbsp;<span class="op" id="2293880">;</span>&nbsp;<span class="ident" id="2293882">n</span>&nbsp;<span class="op" id="2293884">&lt;</span>&nbsp;<span class="builtinfunc" id="2293886">len</span><span class="op" id="2293889">(</span><span class="ident" id="2293890">t</span><span class="op" id="2293891">.</span><span class="ident" id="2293892">prefix</span><span class="op" id="2293898">)</span>&nbsp;<span class="op" id="2293900">&amp;&amp;</span>&nbsp;<span class="ident" id="2293903">n</span>&nbsp;<span class="op" id="2293905">&lt;</span>&nbsp;<span class="builtinfunc" id="2293907">len</span><span class="op" id="2293910">(</span><span class="ident" id="2293911">key</span><span class="op" id="2293914">)</span><span class="op" id="2293915">;</span>&nbsp;<span class="ident" id="2293917">n</span><span class="op" id="2293918">++</span>&nbsp;<span class="op" id="2293921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2293926">if</span>&nbsp;<span class="ident" id="2293929">t</span><span class="op" id="2293930">.</span><span class="ident" id="2293931">prefix</span><span class="op" id="2293937">[</span><span class="ident" id="2293938">n</span><span class="op" id="2293939">]</span>&nbsp;<span class="op" id="2293941">!=</span>&nbsp;<span class="ident" id="2293944">key</span><span class="op" id="2293947">[</span><span class="ident" id="2293948">n</span><span class="op" id="2293949">]</span>&nbsp;<span class="op" id="2293951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2293957">break</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2293966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2293970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2293974">if</span>&nbsp;<span class="ident" id="2293977">n</span>&nbsp;<span class="op" id="2293979">==</span>&nbsp;<span class="builtinfunc" id="2293982">len</span><span class="op" id="2293985">(</span><span class="ident" id="2293986">t</span><span class="op" id="2293987">.</span><span class="ident" id="2293988">prefix</span><span class="op" id="2293994">)</span>&nbsp;<span class="op" id="2293996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2294001">t</span><span class="op" id="2294002">.</span><span class="ident" id="2294003">next</span><span class="op" id="2294007">.</span><span class="ident" id="2294008">add</span><span class="op" id="2294011">(</span><span class="ident" id="2294012">key</span><span class="op" id="2294015">[</span><span class="ident" id="2294016">n</span><span class="op" id="2294017">:</span><span class="op" id="2294018">]</span><span class="op" id="2294019">,</span>&nbsp;<span class="ident" id="2294021">val</span><span class="op" id="2294024">,</span>&nbsp;<span class="ident" id="2294026">priority</span><span class="op" id="2294034">,</span>&nbsp;<span class="ident" id="2294036">r</span><span class="op" id="2294037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2294041">}</span>&nbsp;<span class="keyword" id="2294043">else</span>&nbsp;<span class="keyword" id="2294048">if</span>&nbsp;<span class="ident" id="2294051">n</span>&nbsp;<span class="op" id="2294053">==</span>&nbsp;<span class="num" id="2294056">0</span>&nbsp;<span class="op" id="2294058">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2294063">//&nbsp;First&nbsp;byte&nbsp;differs,&nbsp;start&nbsp;a&nbsp;new&nbsp;lookup&nbsp;table&nbsp;here.&nbsp;Looking&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2294131">//&nbsp;what&nbsp;is&nbsp;currently&nbsp;t.prefix[0]&nbsp;will&nbsp;lead&nbsp;to&nbsp;prefixNode,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2294196">//&nbsp;looking&nbsp;up&nbsp;key[0]&nbsp;will&nbsp;lead&nbsp;to&nbsp;keyNode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2294242">var</span>&nbsp;<span class="ident" id="2294246">prefixNode</span>&nbsp;<span class="op" id="2294257">*</span><span class="ident" id="2294258">trieNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2294270">if</span>&nbsp;<span class="builtinfunc" id="2294273">len</span><span class="op" id="2294276">(</span><span class="ident" id="2294277">t</span><span class="op" id="2294278">.</span><span class="ident" id="2294279">prefix</span><span class="op" id="2294285">)</span>&nbsp;<span class="op" id="2294287">==</span>&nbsp;<span class="num" id="2294290">1</span>&nbsp;<span class="op" id="2294292">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2294298">prefixNode</span>&nbsp;<span class="op" id="2294309">=</span>&nbsp;<span class="ident" id="2294311">t</span><span class="op" id="2294312">.</span><span class="ident" id="2294313">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2294321">}</span>&nbsp;<span class="keyword" id="2294323">else</span>&nbsp;<span class="op" id="2294328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2294334">prefixNode</span>&nbsp;<span class="op" id="2294345">=</span>&nbsp;<span class="op" id="2294347">&amp;</span><span class="ident" id="2294348">trieNode</span><span class="op" id="2294356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2294363">prefix</span><span class="op" id="2294369">:</span>&nbsp;<span class="ident" id="2294371">t</span><span class="op" id="2294372">.</span><span class="ident" id="2294373">prefix</span><span class="op" id="2294379">[</span><span class="num" id="2294380">1</span><span class="op" id="2294381">:</span><span class="op" id="2294382">]</span><span class="op" id="2294383">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2294390">next</span><span class="op" id="2294394">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2294398">t</span><span class="op" id="2294399">.</span><span class="ident" id="2294400">next</span><span class="op" id="2294404">,</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2294410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2294415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2294420">keyNode</span>&nbsp;<span class="op" id="2294428">:=</span>&nbsp;<span class="builtinfunc" id="2294431">new</span><span class="op" id="2294434">(</span><span class="ident" id="2294435">trieNode</span><span class="op" id="2294443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2294448">t</span><span class="op" id="2294449">.</span><span class="ident" id="2294450">table</span>&nbsp;<span class="op" id="2294456">=</span>&nbsp;<span class="builtinfunc" id="2294458">make</span><span class="op" id="2294462">(</span><span class="op" id="2294463">[</span><span class="op" id="2294464">]</span><span class="op" id="2294465">*</span><span class="ident" id="2294466">trieNode</span><span class="op" id="2294474">,</span>&nbsp;<span class="ident" id="2294476">r</span><span class="op" id="2294477">.</span><span class="ident" id="2294478">tableSize</span><span class="op" id="2294487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2294492">t</span><span class="op" id="2294493">.</span><span class="ident" id="2294494">table</span><span class="op" id="2294499">[</span><span class="ident" id="2294500">r</span><span class="op" id="2294501">.</span><span class="ident" id="2294502">mapping</span><span class="op" id="2294509">[</span><span class="ident" id="2294510">t</span><span class="op" id="2294511">.</span><span class="ident" id="2294512">prefix</span><span class="op" id="2294518">[</span><span class="num" id="2294519">0</span><span class="op" id="2294520">]</span><span class="op" id="2294521">]</span><span class="op" id="2294522">]</span>&nbsp;<span class="op" id="2294524">=</span>&nbsp;<span class="ident" id="2294526">prefixNode</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2294540">t</span><span class="op" id="2294541">.</span><span class="ident" id="2294542">table</span><span class="op" id="2294547">[</span><span class="ident" id="2294548">r</span><span class="op" id="2294549">.</span><span class="ident" id="2294550">mapping</span><span class="op" id="2294557">[</span><span class="ident" id="2294558">key</span><span class="op" id="2294561">[</span><span class="num" id="2294562">0</span><span class="op" id="2294563">]</span><span class="op" id="2294564">]</span><span class="op" id="2294565">]</span>&nbsp;<span class="op" id="2294567">=</span>&nbsp;<span class="ident" id="2294569">keyNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2294580">t</span><span class="op" id="2294581">.</span><span class="ident" id="2294582">prefix</span>&nbsp;<span class="op" id="2294589">=</span>&nbsp;<span class="string" id="2294591">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2294597">t</span><span class="op" id="2294598">.</span><span class="ident" id="2294599">next</span>&nbsp;<span class="op" id="2294604">=</span>&nbsp;<span class="builtintype" id="2294606">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2294613">keyNode</span><span class="op" id="2294620">.</span><span class="ident" id="2294621">add</span><span class="op" id="2294624">(</span><span class="ident" id="2294625">key</span><span class="op" id="2294628">[</span><span class="num" id="2294629">1</span><span class="op" id="2294630">:</span><span class="op" id="2294631">]</span><span class="op" id="2294632">,</span>&nbsp;<span class="ident" id="2294634">val</span><span class="op" id="2294637">,</span>&nbsp;<span class="ident" id="2294639">priority</span><span class="op" id="2294647">,</span>&nbsp;<span class="ident" id="2294649">r</span><span class="op" id="2294650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2294654">}</span>&nbsp;<span class="keyword" id="2294656">else</span>&nbsp;<span class="op" id="2294661">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2294666">//&nbsp;Insert&nbsp;new&nbsp;node&nbsp;after&nbsp;the&nbsp;common&nbsp;section&nbsp;of&nbsp;the&nbsp;prefix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2294728">next</span>&nbsp;<span class="op" id="2294733">:=</span>&nbsp;<span class="op" id="2294736">&amp;</span><span class="ident" id="2294737">trieNode</span><span class="op" id="2294745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2294751">prefix</span><span class="op" id="2294757">:</span>&nbsp;<span class="ident" id="2294759">t</span><span class="op" id="2294760">.</span><span class="ident" id="2294761">prefix</span><span class="op" id="2294767">[</span><span class="ident" id="2294768">n</span><span class="op" id="2294769">:</span><span class="op" id="2294770">]</span><span class="op" id="2294771">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2294777">next</span><span class="op" id="2294781">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2294785">t</span><span class="op" id="2294786">.</span><span class="ident" id="2294787">next</span><span class="op" id="2294791">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2294796">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2294801">t</span><span class="op" id="2294802">.</span><span class="ident" id="2294803">prefix</span>&nbsp;<span class="op" id="2294810">=</span>&nbsp;<span class="ident" id="2294812">t</span><span class="op" id="2294813">.</span><span class="ident" id="2294814">prefix</span><span class="op" id="2294820">[</span><span class="op" id="2294821">:</span><span class="ident" id="2294822">n</span><span class="op" id="2294823">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2294828">t</span><span class="op" id="2294829">.</span><span class="ident" id="2294830">next</span>&nbsp;<span class="op" id="2294835">=</span>&nbsp;<span class="ident" id="2294837">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2294845">next</span><span class="op" id="2294849">.</span><span class="ident" id="2294850">add</span><span class="op" id="2294853">(</span><span class="ident" id="2294854">key</span><span class="op" id="2294857">[</span><span class="ident" id="2294858">n</span><span class="op" id="2294859">:</span><span class="op" id="2294860">]</span><span class="op" id="2294861">,</span>&nbsp;<span class="ident" id="2294863">val</span><span class="op" id="2294866">,</span>&nbsp;<span class="ident" id="2294868">priority</span><span class="op" id="2294876">,</span>&nbsp;<span class="ident" id="2294878">r</span><span class="op" id="2294879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2294883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2294886">}</span>&nbsp;<span class="keyword" id="2294888">else</span>&nbsp;<span class="keyword" id="2294893">if</span>&nbsp;<span class="ident" id="2294896">t</span><span class="op" id="2294897">.</span><span class="ident" id="2294898">table</span>&nbsp;<span class="op" id="2294904">!=</span>&nbsp;<span class="builtintype" id="2294907">nil</span>&nbsp;<span class="op" id="2294911">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2294915">//&nbsp;Insert&nbsp;into&nbsp;existing&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2294948">m</span>&nbsp;<span class="op" id="2294950">:=</span>&nbsp;<span class="ident" id="2294953">r</span><span class="op" id="2294954">.</span><span class="ident" id="2294955">mapping</span><span class="op" id="2294962">[</span><span class="ident" id="2294963">key</span><span class="op" id="2294966">[</span><span class="num" id="2294967">0</span><span class="op" id="2294968">]</span><span class="op" id="2294969">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2294973">if</span>&nbsp;<span class="ident" id="2294976">t</span><span class="op" id="2294977">.</span><span class="ident" id="2294978">table</span><span class="op" id="2294983">[</span><span class="ident" id="2294984">m</span><span class="op" id="2294985">]</span>&nbsp;<span class="op" id="2294987">==</span>&nbsp;<span class="builtintype" id="2294990">nil</span>&nbsp;<span class="op" id="2294994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2294999">t</span><span class="op" id="2295000">.</span><span class="ident" id="2295001">table</span><span class="op" id="2295006">[</span><span class="ident" id="2295007">m</span><span class="op" id="2295008">]</span>&nbsp;<span class="op" id="2295010">=</span>&nbsp;<span class="builtinfunc" id="2295012">new</span><span class="op" id="2295015">(</span><span class="ident" id="2295016">trieNode</span><span class="op" id="2295024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2295028">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2295032">t</span><span class="op" id="2295033">.</span><span class="ident" id="2295034">table</span><span class="op" id="2295039">[</span><span class="ident" id="2295040">m</span><span class="op" id="2295041">]</span><span class="op" id="2295042">.</span><span class="ident" id="2295043">add</span><span class="op" id="2295046">(</span><span class="ident" id="2295047">key</span><span class="op" id="2295050">[</span><span class="num" id="2295051">1</span><span class="op" id="2295052">:</span><span class="op" id="2295053">]</span><span class="op" id="2295054">,</span>&nbsp;<span class="ident" id="2295056">val</span><span class="op" id="2295059">,</span>&nbsp;<span class="ident" id="2295061">priority</span><span class="op" id="2295069">,</span>&nbsp;<span class="ident" id="2295071">r</span><span class="op" id="2295072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2295075">}</span>&nbsp;<span class="keyword" id="2295077">else</span>&nbsp;<span class="op" id="2295082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2295086">t</span><span class="op" id="2295087">.</span><span class="ident" id="2295088">prefix</span>&nbsp;<span class="op" id="2295095">=</span>&nbsp;<span class="ident" id="2295097">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2295103">t</span><span class="op" id="2295104">.</span><span class="ident" id="2295105">next</span>&nbsp;<span class="op" id="2295110">=</span>&nbsp;<span class="builtinfunc" id="2295112">new</span><span class="op" id="2295115">(</span><span class="ident" id="2295116">trieNode</span><span class="op" id="2295124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2295128">t</span><span class="op" id="2295129">.</span><span class="ident" id="2295130">next</span><span class="op" id="2295134">.</span><span class="ident" id="2295135">add</span><span class="op" id="2295138">(</span><span class="string" id="2295139">&#34;&#34;</span><span class="op" id="2295141">,</span>&nbsp;<span class="ident" id="2295143">val</span><span class="op" id="2295146">,</span>&nbsp;<span class="ident" id="2295148">priority</span><span class="op" id="2295156">,</span>&nbsp;<span class="ident" id="2295158">r</span><span class="op" id="2295159">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2295162">}</span><br>
<span class="lineno"></span><span class="op" id="2295164">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2295167">func</span>&nbsp;<span class="op" id="2295172">(</span><span class="ident" id="2295173">r</span>&nbsp;<span class="op" id="2295175">*</span><span class="ident" id="2295176">genericReplacer</span><span class="op" id="2295191">)</span>&nbsp;<span class="ident" id="2295193">lookup</span><span class="op" id="2295199">(</span><span class="ident" id="2295200">s</span>&nbsp;<span class="builtintype" id="2295202">string</span><span class="op" id="2295208">,</span>&nbsp;<span class="ident" id="2295210">ignoreRoot</span>&nbsp;<span class="builtintype" id="2295221">bool</span><span class="op" id="2295225">)</span>&nbsp;<span class="op" id="2295227">(</span><span class="ident" id="2295228">val</span>&nbsp;<span class="builtintype" id="2295232">string</span><span class="op" id="2295238">,</span>&nbsp;<span class="ident" id="2295240">keylen</span>&nbsp;<span class="builtintype" id="2295247">int</span><span class="op" id="2295250">,</span>&nbsp;<span class="ident" id="2295252">found</span>&nbsp;<span class="builtintype" id="2295258">bool</span><span class="op" id="2295262">)</span>&nbsp;<span class="op" id="2295264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2295267">//&nbsp;Iterate&nbsp;down&nbsp;the&nbsp;trie&nbsp;to&nbsp;the&nbsp;end,&nbsp;and&nbsp;grab&nbsp;the&nbsp;value&nbsp;and&nbsp;keylen&nbsp;with</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2295340">//&nbsp;the&nbsp;highest&nbsp;priority.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2295366">bestPriority</span>&nbsp;<span class="op" id="2295379">:=</span>&nbsp;<span class="num" id="2295382">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2295385">node</span>&nbsp;<span class="op" id="2295390">:=</span>&nbsp;<span class="op" id="2295393">&amp;</span><span class="ident" id="2295394">r</span><span class="op" id="2295395">.</span><span class="ident" id="2295396">root</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2295402">n</span>&nbsp;<span class="op" id="2295404">:=</span>&nbsp;<span class="num" id="2295407">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2295410">for</span>&nbsp;<span class="ident" id="2295414">node</span>&nbsp;<span class="op" id="2295419">!=</span>&nbsp;<span class="builtintype" id="2295422">nil</span>&nbsp;<span class="op" id="2295426">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2295430">if</span>&nbsp;<span class="ident" id="2295433">node</span><span class="op" id="2295437">.</span><span class="ident" id="2295438">priority</span>&nbsp;<span class="op" id="2295447">&gt;</span>&nbsp;<span class="ident" id="2295449">bestPriority</span>&nbsp;<span class="op" id="2295462">&amp;&amp;</span>&nbsp;<span class="op" id="2295465">!</span><span class="op" id="2295466">(</span><span class="ident" id="2295467">ignoreRoot</span>&nbsp;<span class="op" id="2295478">&amp;&amp;</span>&nbsp;<span class="ident" id="2295481">node</span>&nbsp;<span class="op" id="2295486">==</span>&nbsp;<span class="op" id="2295489">&amp;</span><span class="ident" id="2295490">r</span><span class="op" id="2295491">.</span><span class="ident" id="2295492">root</span><span class="op" id="2295496">)</span>&nbsp;<span class="op" id="2295498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2295503">bestPriority</span>&nbsp;<span class="op" id="2295516">=</span>&nbsp;<span class="ident" id="2295518">node</span><span class="op" id="2295522">.</span><span class="ident" id="2295523">priority</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2295535">val</span>&nbsp;<span class="op" id="2295539">=</span>&nbsp;<span class="ident" id="2295541">node</span><span class="op" id="2295545">.</span><span class="ident" id="2295546">value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2295555">keylen</span>&nbsp;<span class="op" id="2295562">=</span>&nbsp;<span class="ident" id="2295564">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2295569">found</span>&nbsp;<span class="op" id="2295575">=</span>&nbsp;<span class="builtintype" id="2295577">true</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2295584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2295589">if</span>&nbsp;<span class="ident" id="2295592">s</span>&nbsp;<span class="op" id="2295594">==</span>&nbsp;<span class="string" id="2295597">&#34;&#34;</span>&nbsp;<span class="op" id="2295600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2295605">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2295613">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2295617">if</span>&nbsp;<span class="ident" id="2295620">node</span><span class="op" id="2295624">.</span><span class="ident" id="2295625">table</span>&nbsp;<span class="op" id="2295631">!=</span>&nbsp;<span class="builtintype" id="2295634">nil</span>&nbsp;<span class="op" id="2295638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2295643">index</span>&nbsp;<span class="op" id="2295649">:=</span>&nbsp;<span class="ident" id="2295652">r</span><span class="op" id="2295653">.</span><span class="ident" id="2295654">mapping</span><span class="op" id="2295661">[</span><span class="ident" id="2295662">s</span><span class="op" id="2295663">[</span><span class="num" id="2295664">0</span><span class="op" id="2295665">]</span><span class="op" id="2295666">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2295671">if</span>&nbsp;<span class="builtintype" id="2295674">int</span><span class="op" id="2295677">(</span><span class="ident" id="2295678">index</span><span class="op" id="2295683">)</span>&nbsp;<span class="op" id="2295685">==</span>&nbsp;<span class="ident" id="2295688">r</span><span class="op" id="2295689">.</span><span class="ident" id="2295690">tableSize</span>&nbsp;<span class="op" id="2295700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2295706">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2295715">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2295720">node</span>&nbsp;<span class="op" id="2295725">=</span>&nbsp;<span class="ident" id="2295727">node</span><span class="op" id="2295731">.</span><span class="ident" id="2295732">table</span><span class="op" id="2295737">[</span><span class="ident" id="2295738">index</span><span class="op" id="2295743">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2295748">s</span>&nbsp;<span class="op" id="2295750">=</span>&nbsp;<span class="ident" id="2295752">s</span><span class="op" id="2295753">[</span><span class="num" id="2295754">1</span><span class="op" id="2295755">:</span><span class="op" id="2295756">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2295761">n</span><span class="op" id="2295762">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2295767">}</span>&nbsp;<span class="keyword" id="2295769">else</span>&nbsp;<span class="keyword" id="2295774">if</span>&nbsp;<span class="ident" id="2295777">node</span><span class="op" id="2295781">.</span><span class="ident" id="2295782">prefix</span>&nbsp;<span class="op" id="2295789">!=</span>&nbsp;<span class="string" id="2295792">&#34;&#34;</span>&nbsp;<span class="op" id="2295795">&amp;&amp;</span>&nbsp;<span class="ident" id="2295798">HasPrefix</span><span class="op" id="2295807">(</span><span class="ident" id="2295808">s</span><span class="op" id="2295809">,</span>&nbsp;<span class="ident" id="2295811">node</span><span class="op" id="2295815">.</span><span class="ident" id="2295816">prefix</span><span class="op" id="2295822">)</span>&nbsp;<span class="op" id="2295824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2295829">n</span>&nbsp;<span class="op" id="2295831">+=</span>&nbsp;<span class="builtinfunc" id="2295834">len</span><span class="op" id="2295837">(</span><span class="ident" id="2295838">node</span><span class="op" id="2295842">.</span><span class="ident" id="2295843">prefix</span><span class="op" id="2295849">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2295854">s</span>&nbsp;<span class="op" id="2295856">=</span>&nbsp;<span class="ident" id="2295858">s</span><span class="op" id="2295859">[</span><span class="builtinfunc" id="2295860">len</span><span class="op" id="2295863">(</span><span class="ident" id="2295864">node</span><span class="op" id="2295868">.</span><span class="ident" id="2295869">prefix</span><span class="op" id="2295875">)</span><span class="op" id="2295876">:</span><span class="op" id="2295877">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2295882">node</span>&nbsp;<span class="op" id="2295887">=</span>&nbsp;<span class="ident" id="2295889">node</span><span class="op" id="2295893">.</span><span class="ident" id="2295894">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2295901">}</span>&nbsp;<span class="keyword" id="2295903">else</span>&nbsp;<span class="op" id="2295908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2295913">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2295921">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2295924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2295927">return</span><br>
<span class="lineno"></span><span class="op" id="2295934">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2295937">//&nbsp;genericReplacer&nbsp;is&nbsp;the&nbsp;fully&nbsp;generic&nbsp;algorithm.</span><br>
<span class="lineno">230</span><span class="comment" id="2295988">//&nbsp;It&#39;s&nbsp;used&nbsp;as&nbsp;a&nbsp;fallback&nbsp;when&nbsp;nothing&nbsp;faster&nbsp;can&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="2296048">type</span>&nbsp;<span class="ident" id="2296053">genericReplacer</span>&nbsp;<span class="keyword" id="2296069">struct</span>&nbsp;<span class="op" id="2296076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2296079">root</span>&nbsp;<span class="ident" id="2296084">trieNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2296094">//&nbsp;tableSize&nbsp;is&nbsp;the&nbsp;size&nbsp;of&nbsp;a&nbsp;trie&nbsp;node&#39;s&nbsp;lookup&nbsp;table.&nbsp;It&nbsp;is&nbsp;the&nbsp;number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2296168">//&nbsp;of&nbsp;unique&nbsp;key&nbsp;bytes.</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2296193">tableSize</span>&nbsp;<span class="builtintype" id="2296203">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2296208">//&nbsp;mapping&nbsp;maps&nbsp;from&nbsp;key&nbsp;bytes&nbsp;to&nbsp;a&nbsp;dense&nbsp;index&nbsp;for&nbsp;trieNode.table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2296277">mapping</span>&nbsp;<span class="op" id="2296285">[</span><span class="num" id="2296286">256</span><span class="op" id="2296289">]</span><span class="builtintype" id="2296290">byte</span><br>
<span class="lineno"></span><span class="op" id="2296295">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span><span class="keyword" id="2296298">func</span>&nbsp;<span class="ident" id="2296303">makeGenericReplacer</span><span class="op" id="2296322">(</span><span class="ident" id="2296323">oldnew</span>&nbsp;<span class="op" id="2296330">[</span><span class="op" id="2296331">]</span><span class="builtintype" id="2296332">string</span><span class="op" id="2296338">)</span>&nbsp;<span class="op" id="2296340">*</span><span class="ident" id="2296341">genericReplacer</span>&nbsp;<span class="op" id="2296357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2296360">r</span>&nbsp;<span class="op" id="2296362">:=</span>&nbsp;<span class="builtinfunc" id="2296365">new</span><span class="op" id="2296368">(</span><span class="ident" id="2296369">genericReplacer</span><span class="op" id="2296384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2296387">//&nbsp;Find&nbsp;each&nbsp;byte&nbsp;used,&nbsp;then&nbsp;assign&nbsp;them&nbsp;each&nbsp;an&nbsp;index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2296444">for</span>&nbsp;<span class="ident" id="2296448">i</span>&nbsp;<span class="op" id="2296450">:=</span>&nbsp;<span class="num" id="2296453">0</span><span class="op" id="2296454">;</span>&nbsp;<span class="ident" id="2296456">i</span>&nbsp;<span class="op" id="2296458">&lt;</span>&nbsp;<span class="builtinfunc" id="2296460">len</span><span class="op" id="2296463">(</span><span class="ident" id="2296464">oldnew</span><span class="op" id="2296470">)</span><span class="op" id="2296471">;</span>&nbsp;<span class="ident" id="2296473">i</span>&nbsp;<span class="op" id="2296475">+=</span>&nbsp;<span class="num" id="2296478">2</span>&nbsp;<span class="op" id="2296480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2296484">key</span>&nbsp;<span class="op" id="2296488">:=</span>&nbsp;<span class="ident" id="2296491">oldnew</span><span class="op" id="2296497">[</span><span class="ident" id="2296498">i</span><span class="op" id="2296499">]</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2296503">for</span>&nbsp;<span class="ident" id="2296507">j</span>&nbsp;<span class="op" id="2296509">:=</span>&nbsp;<span class="num" id="2296512">0</span><span class="op" id="2296513">;</span>&nbsp;<span class="ident" id="2296515">j</span>&nbsp;<span class="op" id="2296517">&lt;</span>&nbsp;<span class="builtinfunc" id="2296519">len</span><span class="op" id="2296522">(</span><span class="ident" id="2296523">key</span><span class="op" id="2296526">)</span><span class="op" id="2296527">;</span>&nbsp;<span class="ident" id="2296529">j</span><span class="op" id="2296530">++</span>&nbsp;<span class="op" id="2296533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2296538">r</span><span class="op" id="2296539">.</span><span class="ident" id="2296540">mapping</span><span class="op" id="2296547">[</span><span class="ident" id="2296548">key</span><span class="op" id="2296551">[</span><span class="ident" id="2296552">j</span><span class="op" id="2296553">]</span><span class="op" id="2296554">]</span>&nbsp;<span class="op" id="2296556">=</span>&nbsp;<span class="num" id="2296558">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2296562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2296565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2296569">for</span>&nbsp;<span class="ident" id="2296573">_</span><span class="op" id="2296574">,</span>&nbsp;<span class="ident" id="2296576">b</span>&nbsp;<span class="op" id="2296578">:=</span>&nbsp;<span class="keyword" id="2296581">range</span>&nbsp;<span class="ident" id="2296587">r</span><span class="op" id="2296588">.</span><span class="ident" id="2296589">mapping</span>&nbsp;<span class="op" id="2296597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2296601">r</span><span class="op" id="2296602">.</span><span class="ident" id="2296603">tableSize</span>&nbsp;<span class="op" id="2296613">+=</span>&nbsp;<span class="builtintype" id="2296616">int</span><span class="op" id="2296619">(</span><span class="ident" id="2296620">b</span><span class="op" id="2296621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2296624">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2296628">var</span>&nbsp;<span class="ident" id="2296632">index</span>&nbsp;<span class="builtintype" id="2296638">byte</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2296644">for</span>&nbsp;<span class="ident" id="2296648">i</span><span class="op" id="2296649">,</span>&nbsp;<span class="ident" id="2296651">b</span>&nbsp;<span class="op" id="2296653">:=</span>&nbsp;<span class="keyword" id="2296656">range</span>&nbsp;<span class="ident" id="2296662">r</span><span class="op" id="2296663">.</span><span class="ident" id="2296664">mapping</span>&nbsp;<span class="op" id="2296672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2296676">if</span>&nbsp;<span class="ident" id="2296679">b</span>&nbsp;<span class="op" id="2296681">==</span>&nbsp;<span class="num" id="2296684">0</span>&nbsp;<span class="op" id="2296686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2296691">r</span><span class="op" id="2296692">.</span><span class="ident" id="2296693">mapping</span><span class="op" id="2296700">[</span><span class="ident" id="2296701">i</span><span class="op" id="2296702">]</span>&nbsp;<span class="op" id="2296704">=</span>&nbsp;<span class="builtintype" id="2296706">byte</span><span class="op" id="2296710">(</span><span class="ident" id="2296711">r</span><span class="op" id="2296712">.</span><span class="ident" id="2296713">tableSize</span><span class="op" id="2296722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2296726">}</span>&nbsp;<span class="keyword" id="2296728">else</span>&nbsp;<span class="op" id="2296733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2296738">r</span><span class="op" id="2296739">.</span><span class="ident" id="2296740">mapping</span><span class="op" id="2296747">[</span><span class="ident" id="2296748">i</span><span class="op" id="2296749">]</span>&nbsp;<span class="op" id="2296751">=</span>&nbsp;<span class="ident" id="2296753">index</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2296762">index</span><span class="op" id="2296767">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2296772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2296775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2296778">//&nbsp;Ensure&nbsp;root&nbsp;node&nbsp;uses&nbsp;a&nbsp;lookup&nbsp;table&nbsp;(for&nbsp;performance).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2296838">r</span><span class="op" id="2296839">.</span><span class="ident" id="2296840">root</span><span class="op" id="2296844">.</span><span class="ident" id="2296845">table</span>&nbsp;<span class="op" id="2296851">=</span>&nbsp;<span class="builtinfunc" id="2296853">make</span><span class="op" id="2296857">(</span><span class="op" id="2296858">[</span><span class="op" id="2296859">]</span><span class="op" id="2296860">*</span><span class="ident" id="2296861">trieNode</span><span class="op" id="2296869">,</span>&nbsp;<span class="ident" id="2296871">r</span><span class="op" id="2296872">.</span><span class="ident" id="2296873">tableSize</span><span class="op" id="2296882">)</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2296886">for</span>&nbsp;<span class="ident" id="2296890">i</span>&nbsp;<span class="op" id="2296892">:=</span>&nbsp;<span class="num" id="2296895">0</span><span class="op" id="2296896">;</span>&nbsp;<span class="ident" id="2296898">i</span>&nbsp;<span class="op" id="2296900">&lt;</span>&nbsp;<span class="builtinfunc" id="2296902">len</span><span class="op" id="2296905">(</span><span class="ident" id="2296906">oldnew</span><span class="op" id="2296912">)</span><span class="op" id="2296913">;</span>&nbsp;<span class="ident" id="2296915">i</span>&nbsp;<span class="op" id="2296917">+=</span>&nbsp;<span class="num" id="2296920">2</span>&nbsp;<span class="op" id="2296922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2296926">r</span><span class="op" id="2296927">.</span><span class="ident" id="2296928">root</span><span class="op" id="2296932">.</span><span class="ident" id="2296933">add</span><span class="op" id="2296936">(</span><span class="ident" id="2296937">oldnew</span><span class="op" id="2296943">[</span><span class="ident" id="2296944">i</span><span class="op" id="2296945">]</span><span class="op" id="2296946">,</span>&nbsp;<span class="ident" id="2296948">oldnew</span><span class="op" id="2296954">[</span><span class="ident" id="2296955">i</span><span class="op" id="2296956">+</span><span class="num" id="2296957">1</span><span class="op" id="2296958">]</span><span class="op" id="2296959">,</span>&nbsp;<span class="builtinfunc" id="2296961">len</span><span class="op" id="2296964">(</span><span class="ident" id="2296965">oldnew</span><span class="op" id="2296971">)</span><span class="op" id="2296972">-</span><span class="ident" id="2296973">i</span><span class="op" id="2296974">,</span>&nbsp;<span class="ident" id="2296976">r</span><span class="op" id="2296977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2296980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2296983">return</span>&nbsp;<span class="ident" id="2296990">r</span><br>
<span class="lineno">270</span><span class="op" id="2296992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2296995">type</span>&nbsp;<span class="ident" id="2297000">appendSliceWriter</span>&nbsp;<span class="op" id="2297018">[</span><span class="op" id="2297019">]</span><span class="builtintype" id="2297020">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2297026">//&nbsp;Write&nbsp;writes&nbsp;to&nbsp;the&nbsp;buffer&nbsp;to&nbsp;satisfy&nbsp;io.Writer.</span><br>
<span class="lineno">275</span><span class="keyword" id="2297078">func</span>&nbsp;<span class="op" id="2297083">(</span><span class="ident" id="2297084">w</span>&nbsp;<span class="op" id="2297086">*</span><span class="ident" id="2297087">appendSliceWriter</span><span class="op" id="2297104">)</span>&nbsp;<span class="ident" id="2297106">Write</span><span class="op" id="2297111">(</span><span class="ident" id="2297112">p</span>&nbsp;<span class="op" id="2297114">[</span><span class="op" id="2297115">]</span><span class="builtintype" id="2297116">byte</span><span class="op" id="2297120">)</span>&nbsp;<span class="op" id="2297122">(</span><span class="builtintype" id="2297123">int</span><span class="op" id="2297126">,</span>&nbsp;<span class="builtintype" id="2297128">error</span><span class="op" id="2297133">)</span>&nbsp;<span class="op" id="2297135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2297138">*</span><span class="ident" id="2297139">w</span>&nbsp;<span class="op" id="2297141">=</span>&nbsp;<span class="builtinfunc" id="2297143">append</span><span class="op" id="2297149">(</span><span class="op" id="2297150">*</span><span class="ident" id="2297151">w</span><span class="op" id="2297152">,</span>&nbsp;<span class="ident" id="2297154">p</span><span class="op" id="2297155">...</span><span class="op" id="2297158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2297161">return</span>&nbsp;<span class="builtinfunc" id="2297168">len</span><span class="op" id="2297171">(</span><span class="ident" id="2297172">p</span><span class="op" id="2297173">)</span><span class="op" id="2297174">,</span>&nbsp;<span class="builtintype" id="2297176">nil</span><br>
<span class="lineno"></span><span class="op" id="2297180">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="2297183">//&nbsp;WriteString&nbsp;writes&nbsp;to&nbsp;the&nbsp;buffer&nbsp;without&nbsp;string-&gt;[]byte-&gt;string&nbsp;allocations.</span><br>
<span class="lineno"></span><span class="keyword" id="2297263">func</span>&nbsp;<span class="op" id="2297268">(</span><span class="ident" id="2297269">w</span>&nbsp;<span class="op" id="2297271">*</span><span class="ident" id="2297272">appendSliceWriter</span><span class="op" id="2297289">)</span>&nbsp;<span class="ident" id="2297291">WriteString</span><span class="op" id="2297302">(</span><span class="ident" id="2297303">s</span>&nbsp;<span class="builtintype" id="2297305">string</span><span class="op" id="2297311">)</span>&nbsp;<span class="op" id="2297313">(</span><span class="builtintype" id="2297314">int</span><span class="op" id="2297317">,</span>&nbsp;<span class="builtintype" id="2297319">error</span><span class="op" id="2297324">)</span>&nbsp;<span class="op" id="2297326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2297329">*</span><span class="ident" id="2297330">w</span>&nbsp;<span class="op" id="2297332">=</span>&nbsp;<span class="builtinfunc" id="2297334">append</span><span class="op" id="2297340">(</span><span class="op" id="2297341">*</span><span class="ident" id="2297342">w</span><span class="op" id="2297343">,</span>&nbsp;<span class="ident" id="2297345">s</span><span class="op" id="2297346">...</span><span class="op" id="2297349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2297352">return</span>&nbsp;<span class="builtinfunc" id="2297359">len</span><span class="op" id="2297362">(</span><span class="ident" id="2297363">s</span><span class="op" id="2297364">)</span><span class="op" id="2297365">,</span>&nbsp;<span class="builtintype" id="2297367">nil</span><br>
<span class="lineno"></span><span class="op" id="2297371">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="2297374">type</span>&nbsp;<span class="ident" id="2297379">stringWriterIface</span>&nbsp;<span class="keyword" id="2297397">interface</span>&nbsp;<span class="op" id="2297407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2297410">WriteString</span><span class="op" id="2297421">(</span><span class="builtintype" id="2297422">string</span><span class="op" id="2297428">)</span>&nbsp;<span class="op" id="2297430">(</span><span class="builtintype" id="2297431">int</span><span class="op" id="2297434">,</span>&nbsp;<span class="builtintype" id="2297436">error</span><span class="op" id="2297441">)</span><br>
<span class="lineno"></span><span class="op" id="2297443">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="keyword" id="2297446">type</span>&nbsp;<span class="ident" id="2297451">stringWriter</span>&nbsp;<span class="keyword" id="2297464">struct</span>&nbsp;<span class="op" id="2297471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2297474">w</span>&nbsp;<span class="ident" id="2297476">io</span><span class="op" id="2297478">.</span><span class="ident" id="2297479">Writer</span><br>
<span class="lineno"></span><span class="op" id="2297486">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2297489">func</span>&nbsp;<span class="op" id="2297494">(</span><span class="ident" id="2297495">w</span>&nbsp;<span class="ident" id="2297497">stringWriter</span><span class="op" id="2297509">)</span>&nbsp;<span class="ident" id="2297511">WriteString</span><span class="op" id="2297522">(</span><span class="ident" id="2297523">s</span>&nbsp;<span class="builtintype" id="2297525">string</span><span class="op" id="2297531">)</span>&nbsp;<span class="op" id="2297533">(</span><span class="builtintype" id="2297534">int</span><span class="op" id="2297537">,</span>&nbsp;<span class="builtintype" id="2297539">error</span><span class="op" id="2297544">)</span>&nbsp;<span class="op" id="2297546">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2297549">return</span>&nbsp;<span class="ident" id="2297556">w</span><span class="op" id="2297557">.</span><span class="ident" id="2297558">w</span><span class="op" id="2297559">.</span><span class="ident" id="2297560">Write</span><span class="op" id="2297565">(</span><span class="op" id="2297566">[</span><span class="op" id="2297567">]</span><span class="builtintype" id="2297568">byte</span><span class="op" id="2297572">(</span><span class="ident" id="2297573">s</span><span class="op" id="2297574">)</span><span class="op" id="2297575">)</span><br>
<span class="lineno"></span><span class="op" id="2297577">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2297580">func</span>&nbsp;<span class="ident" id="2297585">getStringWriter</span><span class="op" id="2297600">(</span><span class="ident" id="2297601">w</span>&nbsp;<span class="ident" id="2297603">io</span><span class="op" id="2297605">.</span><span class="ident" id="2297606">Writer</span><span class="op" id="2297612">)</span>&nbsp;<span class="ident" id="2297614">stringWriterIface</span>&nbsp;<span class="op" id="2297632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2297635">sw</span><span class="op" id="2297637">,</span>&nbsp;<span class="ident" id="2297639">ok</span>&nbsp;<span class="op" id="2297642">:=</span>&nbsp;<span class="ident" id="2297645">w</span><span class="op" id="2297646">.</span><span class="op" id="2297647">(</span><span class="ident" id="2297648">stringWriterIface</span><span class="op" id="2297665">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2297668">if</span>&nbsp;<span class="op" id="2297671">!</span><span class="ident" id="2297672">ok</span>&nbsp;<span class="op" id="2297675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2297679">sw</span>&nbsp;<span class="op" id="2297682">=</span>&nbsp;<span class="ident" id="2297684">stringWriter</span><span class="op" id="2297696">{</span><span class="ident" id="2297697">w</span><span class="op" id="2297698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2297701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2297704">return</span>&nbsp;<span class="ident" id="2297711">sw</span><br>
<span class="lineno"></span><span class="op" id="2297714">}</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span><span class="keyword" id="2297717">func</span>&nbsp;<span class="op" id="2297722">(</span><span class="ident" id="2297723">r</span>&nbsp;<span class="op" id="2297725">*</span><span class="ident" id="2297726">genericReplacer</span><span class="op" id="2297741">)</span>&nbsp;<span class="ident" id="2297743">Replace</span><span class="op" id="2297750">(</span><span class="ident" id="2297751">s</span>&nbsp;<span class="builtintype" id="2297753">string</span><span class="op" id="2297759">)</span>&nbsp;<span class="builtintype" id="2297761">string</span>&nbsp;<span class="op" id="2297768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2297771">buf</span>&nbsp;<span class="op" id="2297775">:=</span>&nbsp;<span class="builtinfunc" id="2297778">make</span><span class="op" id="2297782">(</span><span class="ident" id="2297783">appendSliceWriter</span><span class="op" id="2297800">,</span>&nbsp;<span class="num" id="2297802">0</span><span class="op" id="2297803">,</span>&nbsp;<span class="builtinfunc" id="2297805">len</span><span class="op" id="2297808">(</span><span class="ident" id="2297809">s</span><span class="op" id="2297810">)</span><span class="op" id="2297811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2297814">r</span><span class="op" id="2297815">.</span><span class="ident" id="2297816">WriteString</span><span class="op" id="2297827">(</span><span class="op" id="2297828">&amp;</span><span class="ident" id="2297829">buf</span><span class="op" id="2297832">,</span>&nbsp;<span class="ident" id="2297834">s</span><span class="op" id="2297835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2297838">return</span>&nbsp;<span class="builtintype" id="2297845">string</span><span class="op" id="2297851">(</span><span class="ident" id="2297852">buf</span><span class="op" id="2297855">)</span><br>
<span class="lineno">310</span><span class="op" id="2297857">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2297860">func</span>&nbsp;<span class="op" id="2297865">(</span><span class="ident" id="2297866">r</span>&nbsp;<span class="op" id="2297868">*</span><span class="ident" id="2297869">genericReplacer</span><span class="op" id="2297884">)</span>&nbsp;<span class="ident" id="2297886">WriteString</span><span class="op" id="2297897">(</span><span class="ident" id="2297898">w</span>&nbsp;<span class="ident" id="2297900">io</span><span class="op" id="2297902">.</span><span class="ident" id="2297903">Writer</span><span class="op" id="2297909">,</span>&nbsp;<span class="ident" id="2297911">s</span>&nbsp;<span class="builtintype" id="2297913">string</span><span class="op" id="2297919">)</span>&nbsp;<span class="op" id="2297921">(</span><span class="ident" id="2297922">n</span>&nbsp;<span class="builtintype" id="2297924">int</span><span class="op" id="2297927">,</span>&nbsp;<span class="ident" id="2297929">err</span>&nbsp;<span class="builtintype" id="2297933">error</span><span class="op" id="2297938">)</span>&nbsp;<span class="op" id="2297940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2297943">sw</span>&nbsp;<span class="op" id="2297946">:=</span>&nbsp;<span class="ident" id="2297949">getStringWriter</span><span class="op" id="2297964">(</span><span class="ident" id="2297965">w</span><span class="op" id="2297966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2297969">var</span>&nbsp;<span class="ident" id="2297973">last</span><span class="op" id="2297977">,</span>&nbsp;<span class="ident" id="2297979">wn</span>&nbsp;<span class="builtintype" id="2297982">int</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2297987">var</span>&nbsp;<span class="ident" id="2297991">prevMatchEmpty</span>&nbsp;<span class="builtintype" id="2298006">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2298012">for</span>&nbsp;<span class="ident" id="2298016">i</span>&nbsp;<span class="op" id="2298018">:=</span>&nbsp;<span class="num" id="2298021">0</span><span class="op" id="2298022">;</span>&nbsp;<span class="ident" id="2298024">i</span>&nbsp;<span class="op" id="2298026">&lt;=</span>&nbsp;<span class="builtinfunc" id="2298029">len</span><span class="op" id="2298032">(</span><span class="ident" id="2298033">s</span><span class="op" id="2298034">)</span><span class="op" id="2298035">;</span>&nbsp;<span class="op" id="2298037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2298041">//&nbsp;Fast&nbsp;path:&nbsp;s[i]&nbsp;is&nbsp;not&nbsp;a&nbsp;prefix&nbsp;of&nbsp;any&nbsp;pattern.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2298094">if</span>&nbsp;<span class="ident" id="2298097">i</span>&nbsp;<span class="op" id="2298099">!=</span>&nbsp;<span class="builtinfunc" id="2298102">len</span><span class="op" id="2298105">(</span><span class="ident" id="2298106">s</span><span class="op" id="2298107">)</span>&nbsp;<span class="op" id="2298109">&amp;&amp;</span>&nbsp;<span class="ident" id="2298112">r</span><span class="op" id="2298113">.</span><span class="ident" id="2298114">root</span><span class="op" id="2298118">.</span><span class="ident" id="2298119">priority</span>&nbsp;<span class="op" id="2298128">==</span>&nbsp;<span class="num" id="2298131">0</span>&nbsp;<span class="op" id="2298133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2298138">index</span>&nbsp;<span class="op" id="2298144">:=</span>&nbsp;<span class="builtintype" id="2298147">int</span><span class="op" id="2298150">(</span><span class="ident" id="2298151">r</span><span class="op" id="2298152">.</span><span class="ident" id="2298153">mapping</span><span class="op" id="2298160">[</span><span class="ident" id="2298161">s</span><span class="op" id="2298162">[</span><span class="ident" id="2298163">i</span><span class="op" id="2298164">]</span><span class="op" id="2298165">]</span><span class="op" id="2298166">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2298171">if</span>&nbsp;<span class="ident" id="2298174">index</span>&nbsp;<span class="op" id="2298180">==</span>&nbsp;<span class="ident" id="2298183">r</span><span class="op" id="2298184">.</span><span class="ident" id="2298185">tableSize</span>&nbsp;<span class="op" id="2298195">||</span>&nbsp;<span class="ident" id="2298198">r</span><span class="op" id="2298199">.</span><span class="ident" id="2298200">root</span><span class="op" id="2298204">.</span><span class="ident" id="2298205">table</span><span class="op" id="2298210">[</span><span class="ident" id="2298211">index</span><span class="op" id="2298216">]</span>&nbsp;<span class="op" id="2298218">==</span>&nbsp;<span class="builtintype" id="2298221">nil</span>&nbsp;<span class="op" id="2298225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2298231">i</span><span class="op" id="2298232">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2298239">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2298251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2298255">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2298260">//&nbsp;Ignore&nbsp;the&nbsp;empty&nbsp;match&nbsp;iff&nbsp;the&nbsp;previous&nbsp;loop&nbsp;found&nbsp;the&nbsp;empty&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2298333">val</span><span class="op" id="2298336">,</span>&nbsp;<span class="ident" id="2298338">keylen</span><span class="op" id="2298344">,</span>&nbsp;<span class="ident" id="2298346">match</span>&nbsp;<span class="op" id="2298352">:=</span>&nbsp;<span class="ident" id="2298355">r</span><span class="op" id="2298356">.</span><span class="ident" id="2298357">lookup</span><span class="op" id="2298363">(</span><span class="ident" id="2298364">s</span><span class="op" id="2298365">[</span><span class="ident" id="2298366">i</span><span class="op" id="2298367">:</span><span class="op" id="2298368">]</span><span class="op" id="2298369">,</span>&nbsp;<span class="ident" id="2298371">prevMatchEmpty</span><span class="op" id="2298385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2298389">prevMatchEmpty</span>&nbsp;<span class="op" id="2298404">=</span>&nbsp;<span class="ident" id="2298406">match</span>&nbsp;<span class="op" id="2298412">&amp;&amp;</span>&nbsp;<span class="ident" id="2298415">keylen</span>&nbsp;<span class="op" id="2298422">==</span>&nbsp;<span class="num" id="2298425">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2298429">if</span>&nbsp;<span class="ident" id="2298432">match</span>&nbsp;<span class="op" id="2298438">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2298443">wn</span><span class="op" id="2298445">,</span>&nbsp;<span class="ident" id="2298447">err</span>&nbsp;<span class="op" id="2298451">=</span>&nbsp;<span class="ident" id="2298453">sw</span><span class="op" id="2298455">.</span><span class="ident" id="2298456">WriteString</span><span class="op" id="2298467">(</span><span class="ident" id="2298468">s</span><span class="op" id="2298469">[</span><span class="ident" id="2298470">last</span><span class="op" id="2298474">:</span><span class="ident" id="2298475">i</span><span class="op" id="2298476">]</span><span class="op" id="2298477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2298482">n</span>&nbsp;<span class="op" id="2298484">+=</span>&nbsp;<span class="ident" id="2298487">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2298493">if</span>&nbsp;<span class="ident" id="2298496">err</span>&nbsp;<span class="op" id="2298500">!=</span>&nbsp;<span class="builtintype" id="2298503">nil</span>&nbsp;<span class="op" id="2298507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2298513">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2298523">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2298528">wn</span><span class="op" id="2298530">,</span>&nbsp;<span class="ident" id="2298532">err</span>&nbsp;<span class="op" id="2298536">=</span>&nbsp;<span class="ident" id="2298538">sw</span><span class="op" id="2298540">.</span><span class="ident" id="2298541">WriteString</span><span class="op" id="2298552">(</span><span class="ident" id="2298553">val</span><span class="op" id="2298556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2298561">n</span>&nbsp;<span class="op" id="2298563">+=</span>&nbsp;<span class="ident" id="2298566">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2298572">if</span>&nbsp;<span class="ident" id="2298575">err</span>&nbsp;<span class="op" id="2298579">!=</span>&nbsp;<span class="builtintype" id="2298582">nil</span>&nbsp;<span class="op" id="2298586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2298592">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2298602">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2298607">i</span>&nbsp;<span class="op" id="2298609">+=</span>&nbsp;<span class="ident" id="2298612">keylen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2298622">last</span>&nbsp;<span class="op" id="2298627">=</span>&nbsp;<span class="ident" id="2298629">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2298634">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2298645">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2298649">i</span><span class="op" id="2298650">++</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2298654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2298657">if</span>&nbsp;<span class="ident" id="2298660">last</span>&nbsp;<span class="op" id="2298665">!=</span>&nbsp;<span class="builtinfunc" id="2298668">len</span><span class="op" id="2298671">(</span><span class="ident" id="2298672">s</span><span class="op" id="2298673">)</span>&nbsp;<span class="op" id="2298675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2298679">wn</span><span class="op" id="2298681">,</span>&nbsp;<span class="ident" id="2298683">err</span>&nbsp;<span class="op" id="2298687">=</span>&nbsp;<span class="ident" id="2298689">sw</span><span class="op" id="2298691">.</span><span class="ident" id="2298692">WriteString</span><span class="op" id="2298703">(</span><span class="ident" id="2298704">s</span><span class="op" id="2298705">[</span><span class="ident" id="2298706">last</span><span class="op" id="2298710">:</span><span class="op" id="2298711">]</span><span class="op" id="2298712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2298716">n</span>&nbsp;<span class="op" id="2298718">+=</span>&nbsp;<span class="ident" id="2298721">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2298725">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2298728">return</span><br>
<span class="lineno"></span><span class="op" id="2298735">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2298738">//&nbsp;singleStringReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;there&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="2298815">//&nbsp;one&nbsp;string&nbsp;to&nbsp;replace&nbsp;(and&nbsp;that&nbsp;string&nbsp;has&nbsp;more&nbsp;than&nbsp;one&nbsp;byte).</span><br>
<span class="lineno">355</span><span class="keyword" id="2298882">type</span>&nbsp;<span class="ident" id="2298887">singleStringReplacer</span>&nbsp;<span class="keyword" id="2298908">struct</span>&nbsp;<span class="op" id="2298915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2298918">finder</span>&nbsp;<span class="op" id="2298925">*</span><span class="ident" id="2298926">stringFinder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2298940">//&nbsp;value&nbsp;is&nbsp;the&nbsp;new&nbsp;string&nbsp;that&nbsp;replaces&nbsp;that&nbsp;pattern&nbsp;when&nbsp;it&#39;s&nbsp;found.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2299012">value</span>&nbsp;<span class="builtintype" id="2299018">string</span><br>
<span class="lineno"></span><span class="op" id="2299025">}</span><br>
<span class="lineno">360</span><br>
<span class="lineno"></span><span class="keyword" id="2299028">func</span>&nbsp;<span class="ident" id="2299033">makeSingleStringReplacer</span><span class="op" id="2299057">(</span><span class="ident" id="2299058">pattern</span>&nbsp;<span class="builtintype" id="2299066">string</span><span class="op" id="2299072">,</span>&nbsp;<span class="ident" id="2299074">value</span>&nbsp;<span class="builtintype" id="2299080">string</span><span class="op" id="2299086">)</span>&nbsp;<span class="op" id="2299088">*</span><span class="ident" id="2299089">singleStringReplacer</span>&nbsp;<span class="op" id="2299110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2299113">return</span>&nbsp;<span class="op" id="2299120">&amp;</span><span class="ident" id="2299121">singleStringReplacer</span><span class="op" id="2299141">{</span><span class="ident" id="2299142">finder</span><span class="op" id="2299148">:</span>&nbsp;<span class="ident" id="2299150">makeStringFinder</span><span class="op" id="2299166">(</span><span class="ident" id="2299167">pattern</span><span class="op" id="2299174">)</span><span class="op" id="2299175">,</span>&nbsp;<span class="ident" id="2299177">value</span><span class="op" id="2299182">:</span>&nbsp;<span class="ident" id="2299184">value</span><span class="op" id="2299189">}</span><br>
<span class="lineno"></span><span class="op" id="2299191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="keyword" id="2299194">func</span>&nbsp;<span class="op" id="2299199">(</span><span class="ident" id="2299200">r</span>&nbsp;<span class="op" id="2299202">*</span><span class="ident" id="2299203">singleStringReplacer</span><span class="op" id="2299223">)</span>&nbsp;<span class="ident" id="2299225">Replace</span><span class="op" id="2299232">(</span><span class="ident" id="2299233">s</span>&nbsp;<span class="builtintype" id="2299235">string</span><span class="op" id="2299241">)</span>&nbsp;<span class="builtintype" id="2299243">string</span>&nbsp;<span class="op" id="2299250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2299253">var</span>&nbsp;<span class="ident" id="2299257">buf</span>&nbsp;<span class="op" id="2299261">[</span><span class="op" id="2299262">]</span><span class="builtintype" id="2299263">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2299269">i</span><span class="op" id="2299270">,</span>&nbsp;<span class="ident" id="2299272">matched</span>&nbsp;<span class="op" id="2299280">:=</span>&nbsp;<span class="num" id="2299283">0</span><span class="op" id="2299284">,</span>&nbsp;<span class="builtintype" id="2299286">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2299293">for</span>&nbsp;<span class="op" id="2299297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2299301">match</span>&nbsp;<span class="op" id="2299307">:=</span>&nbsp;<span class="ident" id="2299310">r</span><span class="op" id="2299311">.</span><span class="ident" id="2299312">finder</span><span class="op" id="2299318">.</span><span class="ident" id="2299319">next</span><span class="op" id="2299323">(</span><span class="ident" id="2299324">s</span><span class="op" id="2299325">[</span><span class="ident" id="2299326">i</span><span class="op" id="2299327">:</span><span class="op" id="2299328">]</span><span class="op" id="2299329">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2299333">if</span>&nbsp;<span class="ident" id="2299336">match</span>&nbsp;<span class="op" id="2299342">==</span>&nbsp;<span class="op" id="2299345">-</span><span class="num" id="2299346">1</span>&nbsp;<span class="op" id="2299348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2299353">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2299361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2299365">matched</span>&nbsp;<span class="op" id="2299373">=</span>&nbsp;<span class="builtintype" id="2299375">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2299382">buf</span>&nbsp;<span class="op" id="2299386">=</span>&nbsp;<span class="builtinfunc" id="2299388">append</span><span class="op" id="2299394">(</span><span class="ident" id="2299395">buf</span><span class="op" id="2299398">,</span>&nbsp;<span class="ident" id="2299400">s</span><span class="op" id="2299401">[</span><span class="ident" id="2299402">i</span><span class="op" id="2299403">:</span><span class="ident" id="2299404">i</span><span class="op" id="2299405">+</span><span class="ident" id="2299406">match</span><span class="op" id="2299411">]</span><span class="op" id="2299412">...</span><span class="op" id="2299415">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2299419">buf</span>&nbsp;<span class="op" id="2299423">=</span>&nbsp;<span class="builtinfunc" id="2299425">append</span><span class="op" id="2299431">(</span><span class="ident" id="2299432">buf</span><span class="op" id="2299435">,</span>&nbsp;<span class="ident" id="2299437">r</span><span class="op" id="2299438">.</span><span class="ident" id="2299439">value</span><span class="op" id="2299444">...</span><span class="op" id="2299447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2299451">i</span>&nbsp;<span class="op" id="2299453">+=</span>&nbsp;<span class="ident" id="2299456">match</span>&nbsp;<span class="op" id="2299462">+</span>&nbsp;<span class="builtinfunc" id="2299464">len</span><span class="op" id="2299467">(</span><span class="ident" id="2299468">r</span><span class="op" id="2299469">.</span><span class="ident" id="2299470">finder</span><span class="op" id="2299476">.</span><span class="ident" id="2299477">pattern</span><span class="op" id="2299484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2299487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2299490">if</span>&nbsp;<span class="op" id="2299493">!</span><span class="ident" id="2299494">matched</span>&nbsp;<span class="op" id="2299502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2299506">return</span>&nbsp;<span class="ident" id="2299513">s</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2299516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2299519">buf</span>&nbsp;<span class="op" id="2299523">=</span>&nbsp;<span class="builtinfunc" id="2299525">append</span><span class="op" id="2299531">(</span><span class="ident" id="2299532">buf</span><span class="op" id="2299535">,</span>&nbsp;<span class="ident" id="2299537">s</span><span class="op" id="2299538">[</span><span class="ident" id="2299539">i</span><span class="op" id="2299540">:</span><span class="op" id="2299541">]</span><span class="op" id="2299542">...</span><span class="op" id="2299545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2299548">return</span>&nbsp;<span class="builtintype" id="2299555">string</span><span class="op" id="2299561">(</span><span class="ident" id="2299562">buf</span><span class="op" id="2299565">)</span><br>
<span class="lineno"></span><span class="op" id="2299567">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span><span class="keyword" id="2299570">func</span>&nbsp;<span class="op" id="2299575">(</span><span class="ident" id="2299576">r</span>&nbsp;<span class="op" id="2299578">*</span><span class="ident" id="2299579">singleStringReplacer</span><span class="op" id="2299599">)</span>&nbsp;<span class="ident" id="2299601">WriteString</span><span class="op" id="2299612">(</span><span class="ident" id="2299613">w</span>&nbsp;<span class="ident" id="2299615">io</span><span class="op" id="2299617">.</span><span class="ident" id="2299618">Writer</span><span class="op" id="2299624">,</span>&nbsp;<span class="ident" id="2299626">s</span>&nbsp;<span class="builtintype" id="2299628">string</span><span class="op" id="2299634">)</span>&nbsp;<span class="op" id="2299636">(</span><span class="ident" id="2299637">n</span>&nbsp;<span class="builtintype" id="2299639">int</span><span class="op" id="2299642">,</span>&nbsp;<span class="ident" id="2299644">err</span>&nbsp;<span class="builtintype" id="2299648">error</span><span class="op" id="2299653">)</span>&nbsp;<span class="op" id="2299655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2299658">sw</span>&nbsp;<span class="op" id="2299661">:=</span>&nbsp;<span class="ident" id="2299664">getStringWriter</span><span class="op" id="2299679">(</span><span class="ident" id="2299680">w</span><span class="op" id="2299681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2299684">var</span>&nbsp;<span class="ident" id="2299688">i</span><span class="op" id="2299689">,</span>&nbsp;<span class="ident" id="2299691">wn</span>&nbsp;<span class="builtintype" id="2299694">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2299699">for</span>&nbsp;<span class="op" id="2299703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2299707">match</span>&nbsp;<span class="op" id="2299713">:=</span>&nbsp;<span class="ident" id="2299716">r</span><span class="op" id="2299717">.</span><span class="ident" id="2299718">finder</span><span class="op" id="2299724">.</span><span class="ident" id="2299725">next</span><span class="op" id="2299729">(</span><span class="ident" id="2299730">s</span><span class="op" id="2299731">[</span><span class="ident" id="2299732">i</span><span class="op" id="2299733">:</span><span class="op" id="2299734">]</span><span class="op" id="2299735">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2299739">if</span>&nbsp;<span class="ident" id="2299742">match</span>&nbsp;<span class="op" id="2299748">==</span>&nbsp;<span class="op" id="2299751">-</span><span class="num" id="2299752">1</span>&nbsp;<span class="op" id="2299754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2299759">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2299767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2299771">wn</span><span class="op" id="2299773">,</span>&nbsp;<span class="ident" id="2299775">err</span>&nbsp;<span class="op" id="2299779">=</span>&nbsp;<span class="ident" id="2299781">sw</span><span class="op" id="2299783">.</span><span class="ident" id="2299784">WriteString</span><span class="op" id="2299795">(</span><span class="ident" id="2299796">s</span><span class="op" id="2299797">[</span><span class="ident" id="2299798">i</span>&nbsp;<span class="op" id="2299800">:</span>&nbsp;<span class="ident" id="2299802">i</span><span class="op" id="2299803">+</span><span class="ident" id="2299804">match</span><span class="op" id="2299809">]</span><span class="op" id="2299810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2299814">n</span>&nbsp;<span class="op" id="2299816">+=</span>&nbsp;<span class="ident" id="2299819">wn</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2299824">if</span>&nbsp;<span class="ident" id="2299827">err</span>&nbsp;<span class="op" id="2299831">!=</span>&nbsp;<span class="builtintype" id="2299834">nil</span>&nbsp;<span class="op" id="2299838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2299843">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2299852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2299856">wn</span><span class="op" id="2299858">,</span>&nbsp;<span class="ident" id="2299860">err</span>&nbsp;<span class="op" id="2299864">=</span>&nbsp;<span class="ident" id="2299866">sw</span><span class="op" id="2299868">.</span><span class="ident" id="2299869">WriteString</span><span class="op" id="2299880">(</span><span class="ident" id="2299881">r</span><span class="op" id="2299882">.</span><span class="ident" id="2299883">value</span><span class="op" id="2299888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2299892">n</span>&nbsp;<span class="op" id="2299894">+=</span>&nbsp;<span class="ident" id="2299897">wn</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2299902">if</span>&nbsp;<span class="ident" id="2299905">err</span>&nbsp;<span class="op" id="2299909">!=</span>&nbsp;<span class="builtintype" id="2299912">nil</span>&nbsp;<span class="op" id="2299916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2299921">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2299930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2299934">i</span>&nbsp;<span class="op" id="2299936">+=</span>&nbsp;<span class="ident" id="2299939">match</span>&nbsp;<span class="op" id="2299945">+</span>&nbsp;<span class="builtinfunc" id="2299947">len</span><span class="op" id="2299950">(</span><span class="ident" id="2299951">r</span><span class="op" id="2299952">.</span><span class="ident" id="2299953">finder</span><span class="op" id="2299959">.</span><span class="ident" id="2299960">pattern</span><span class="op" id="2299967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2299970">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2299973">wn</span><span class="op" id="2299975">,</span>&nbsp;<span class="ident" id="2299977">err</span>&nbsp;<span class="op" id="2299981">=</span>&nbsp;<span class="ident" id="2299983">sw</span><span class="op" id="2299985">.</span><span class="ident" id="2299986">WriteString</span><span class="op" id="2299997">(</span><span class="ident" id="2299998">s</span><span class="op" id="2299999">[</span><span class="ident" id="2300000">i</span><span class="op" id="2300001">:</span><span class="op" id="2300002">]</span><span class="op" id="2300003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2300006">n</span>&nbsp;<span class="op" id="2300008">+=</span>&nbsp;<span class="ident" id="2300011">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2300015">return</span><br>
<span class="lineno"></span><span class="op" id="2300022">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="2300025">//&nbsp;byteReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;all&nbsp;the&nbsp;&#34;old&#34;</span><br>
<span class="lineno"></span><span class="comment" id="2300094">//&nbsp;and&nbsp;&#34;new&#34;&nbsp;values&nbsp;are&nbsp;single&nbsp;ASCII&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="2300138">//&nbsp;The&nbsp;array&nbsp;contains&nbsp;replacement&nbsp;bytes&nbsp;indexed&nbsp;by&nbsp;old&nbsp;byte.</span><br>
<span class="lineno"></span><span class="keyword" id="2300199">type</span>&nbsp;<span class="ident" id="2300204">byteReplacer</span>&nbsp;<span class="op" id="2300217">[</span><span class="num" id="2300218">256</span><span class="op" id="2300221">]</span><span class="builtintype" id="2300222">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="keyword" id="2300228">func</span>&nbsp;<span class="op" id="2300233">(</span><span class="ident" id="2300234">r</span>&nbsp;<span class="op" id="2300236">*</span><span class="ident" id="2300237">byteReplacer</span><span class="op" id="2300249">)</span>&nbsp;<span class="ident" id="2300251">Replace</span><span class="op" id="2300258">(</span><span class="ident" id="2300259">s</span>&nbsp;<span class="builtintype" id="2300261">string</span><span class="op" id="2300267">)</span>&nbsp;<span class="builtintype" id="2300269">string</span>&nbsp;<span class="op" id="2300276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2300279">var</span>&nbsp;<span class="ident" id="2300283">buf</span>&nbsp;<span class="op" id="2300287">[</span><span class="op" id="2300288">]</span><span class="builtintype" id="2300289">byte</span>&nbsp;<span class="comment" id="2300294">//&nbsp;lazily&nbsp;allocated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2300315">for</span>&nbsp;<span class="ident" id="2300319">i</span>&nbsp;<span class="op" id="2300321">:=</span>&nbsp;<span class="num" id="2300324">0</span><span class="op" id="2300325">;</span>&nbsp;<span class="ident" id="2300327">i</span>&nbsp;<span class="op" id="2300329">&lt;</span>&nbsp;<span class="builtinfunc" id="2300331">len</span><span class="op" id="2300334">(</span><span class="ident" id="2300335">s</span><span class="op" id="2300336">)</span><span class="op" id="2300337">;</span>&nbsp;<span class="ident" id="2300339">i</span><span class="op" id="2300340">++</span>&nbsp;<span class="op" id="2300343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2300347">b</span>&nbsp;<span class="op" id="2300349">:=</span>&nbsp;<span class="ident" id="2300352">s</span><span class="op" id="2300353">[</span><span class="ident" id="2300354">i</span><span class="op" id="2300355">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2300359">if</span>&nbsp;<span class="ident" id="2300362">r</span><span class="op" id="2300363">[</span><span class="ident" id="2300364">b</span><span class="op" id="2300365">]</span>&nbsp;<span class="op" id="2300367">!=</span>&nbsp;<span class="ident" id="2300370">b</span>&nbsp;<span class="op" id="2300372">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2300377">if</span>&nbsp;<span class="ident" id="2300380">buf</span>&nbsp;<span class="op" id="2300384">==</span>&nbsp;<span class="builtintype" id="2300387">nil</span>&nbsp;<span class="op" id="2300391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2300397">buf</span>&nbsp;<span class="op" id="2300401">=</span>&nbsp;<span class="op" id="2300403">[</span><span class="op" id="2300404">]</span><span class="builtintype" id="2300405">byte</span><span class="op" id="2300409">(</span><span class="ident" id="2300410">s</span><span class="op" id="2300411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2300416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2300421">buf</span><span class="op" id="2300424">[</span><span class="ident" id="2300425">i</span><span class="op" id="2300426">]</span>&nbsp;<span class="op" id="2300428">=</span>&nbsp;<span class="ident" id="2300430">r</span><span class="op" id="2300431">[</span><span class="ident" id="2300432">b</span><span class="op" id="2300433">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2300437">}</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2300440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2300443">if</span>&nbsp;<span class="ident" id="2300446">buf</span>&nbsp;<span class="op" id="2300450">==</span>&nbsp;<span class="builtintype" id="2300453">nil</span>&nbsp;<span class="op" id="2300457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2300461">return</span>&nbsp;<span class="ident" id="2300468">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2300471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2300474">return</span>&nbsp;<span class="builtintype" id="2300481">string</span><span class="op" id="2300487">(</span><span class="ident" id="2300488">buf</span><span class="op" id="2300491">)</span><br>
<span class="lineno">430</span><span class="op" id="2300493">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2300496">func</span>&nbsp;<span class="op" id="2300501">(</span><span class="ident" id="2300502">r</span>&nbsp;<span class="op" id="2300504">*</span><span class="ident" id="2300505">byteReplacer</span><span class="op" id="2300517">)</span>&nbsp;<span class="ident" id="2300519">WriteString</span><span class="op" id="2300530">(</span><span class="ident" id="2300531">w</span>&nbsp;<span class="ident" id="2300533">io</span><span class="op" id="2300535">.</span><span class="ident" id="2300536">Writer</span><span class="op" id="2300542">,</span>&nbsp;<span class="ident" id="2300544">s</span>&nbsp;<span class="builtintype" id="2300546">string</span><span class="op" id="2300552">)</span>&nbsp;<span class="op" id="2300554">(</span><span class="ident" id="2300555">n</span>&nbsp;<span class="builtintype" id="2300557">int</span><span class="op" id="2300560">,</span>&nbsp;<span class="ident" id="2300562">err</span>&nbsp;<span class="builtintype" id="2300566">error</span><span class="op" id="2300571">)</span>&nbsp;<span class="op" id="2300573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2300576">//&nbsp;TODO(bradfitz):&nbsp;use&nbsp;io.WriteString&nbsp;with&nbsp;slices&nbsp;of&nbsp;s,&nbsp;avoiding&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2300654">bufsize</span>&nbsp;<span class="op" id="2300662">:=</span>&nbsp;<span class="num" id="2300665">32</span>&nbsp;<span class="op" id="2300668">&lt;&lt;</span>&nbsp;<span class="num" id="2300671">10</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2300675">if</span>&nbsp;<span class="builtinfunc" id="2300678">len</span><span class="op" id="2300681">(</span><span class="ident" id="2300682">s</span><span class="op" id="2300683">)</span>&nbsp;<span class="op" id="2300685">&lt;</span>&nbsp;<span class="ident" id="2300687">bufsize</span>&nbsp;<span class="op" id="2300695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2300699">bufsize</span>&nbsp;<span class="op" id="2300707">=</span>&nbsp;<span class="builtinfunc" id="2300709">len</span><span class="op" id="2300712">(</span><span class="ident" id="2300713">s</span><span class="op" id="2300714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2300717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2300720">buf</span>&nbsp;<span class="op" id="2300724">:=</span>&nbsp;<span class="builtinfunc" id="2300727">make</span><span class="op" id="2300731">(</span><span class="op" id="2300732">[</span><span class="op" id="2300733">]</span><span class="builtintype" id="2300734">byte</span><span class="op" id="2300738">,</span>&nbsp;<span class="ident" id="2300740">bufsize</span><span class="op" id="2300747">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2300751">for</span>&nbsp;<span class="builtinfunc" id="2300755">len</span><span class="op" id="2300758">(</span><span class="ident" id="2300759">s</span><span class="op" id="2300760">)</span>&nbsp;<span class="op" id="2300762">&gt;</span>&nbsp;<span class="num" id="2300764">0</span>&nbsp;<span class="op" id="2300766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2300770">ncopy</span>&nbsp;<span class="op" id="2300776">:=</span>&nbsp;<span class="builtinfunc" id="2300779">copy</span><span class="op" id="2300783">(</span><span class="ident" id="2300784">buf</span><span class="op" id="2300787">,</span>&nbsp;<span class="ident" id="2300789">s</span><span class="op" id="2300790">[</span><span class="op" id="2300791">:</span><span class="op" id="2300792">]</span><span class="op" id="2300793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2300797">s</span>&nbsp;<span class="op" id="2300799">=</span>&nbsp;<span class="ident" id="2300801">s</span><span class="op" id="2300802">[</span><span class="ident" id="2300803">ncopy</span><span class="op" id="2300808">:</span><span class="op" id="2300809">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2300813">for</span>&nbsp;<span class="ident" id="2300817">i</span><span class="op" id="2300818">,</span>&nbsp;<span class="ident" id="2300820">b</span>&nbsp;<span class="op" id="2300822">:=</span>&nbsp;<span class="keyword" id="2300825">range</span>&nbsp;<span class="ident" id="2300831">buf</span><span class="op" id="2300834">[</span><span class="op" id="2300835">:</span><span class="ident" id="2300836">ncopy</span><span class="op" id="2300841">]</span>&nbsp;<span class="op" id="2300843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2300848">buf</span><span class="op" id="2300851">[</span><span class="ident" id="2300852">i</span><span class="op" id="2300853">]</span>&nbsp;<span class="op" id="2300855">=</span>&nbsp;<span class="ident" id="2300857">r</span><span class="op" id="2300858">[</span><span class="ident" id="2300859">b</span><span class="op" id="2300860">]</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2300864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2300868">wn</span><span class="op" id="2300870">,</span>&nbsp;<span class="ident" id="2300872">err</span>&nbsp;<span class="op" id="2300876">:=</span>&nbsp;<span class="ident" id="2300879">w</span><span class="op" id="2300880">.</span><span class="ident" id="2300881">Write</span><span class="op" id="2300886">(</span><span class="ident" id="2300887">buf</span><span class="op" id="2300890">[</span><span class="op" id="2300891">:</span><span class="ident" id="2300892">ncopy</span><span class="op" id="2300897">]</span><span class="op" id="2300898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2300902">n</span>&nbsp;<span class="op" id="2300904">+=</span>&nbsp;<span class="ident" id="2300907">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2300912">if</span>&nbsp;<span class="ident" id="2300915">err</span>&nbsp;<span class="op" id="2300919">!=</span>&nbsp;<span class="builtintype" id="2300922">nil</span>&nbsp;<span class="op" id="2300926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2300931">return</span>&nbsp;<span class="ident" id="2300938">n</span><span class="op" id="2300939">,</span>&nbsp;<span class="ident" id="2300941">err</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2300947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2300950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2300953">return</span>&nbsp;<span class="ident" id="2300960">n</span><span class="op" id="2300961">,</span>&nbsp;<span class="builtintype" id="2300963">nil</span><br>
<span class="lineno"></span><span class="op" id="2300967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="comment" id="2300970">//&nbsp;byteStringReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;all&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2301039">//&nbsp;&#34;old&#34;&nbsp;values&nbsp;are&nbsp;single&nbsp;ASCII&nbsp;bytes&nbsp;but&nbsp;the&nbsp;&#34;new&#34;&nbsp;values&nbsp;vary&nbsp;in&nbsp;size.</span><br>
<span class="lineno"></span><span class="comment" id="2301113">//&nbsp;The&nbsp;array&nbsp;contains&nbsp;replacement&nbsp;byte&nbsp;slices&nbsp;indexed&nbsp;by&nbsp;old&nbsp;byte.</span><br>
<span class="lineno"></span><span class="comment" id="2301180">//&nbsp;A&nbsp;nil&nbsp;[]byte&nbsp;means&nbsp;that&nbsp;the&nbsp;old&nbsp;byte&nbsp;should&nbsp;not&nbsp;be&nbsp;replaced.</span><br>
<span class="lineno"></span><span class="keyword" id="2301244">type</span>&nbsp;<span class="ident" id="2301249">byteStringReplacer</span>&nbsp;<span class="op" id="2301268">[</span><span class="num" id="2301269">256</span><span class="op" id="2301272">]</span><span class="op" id="2301273">[</span><span class="op" id="2301274">]</span><span class="builtintype" id="2301275">byte</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span><span class="keyword" id="2301281">func</span>&nbsp;<span class="op" id="2301286">(</span><span class="ident" id="2301287">r</span>&nbsp;<span class="op" id="2301289">*</span><span class="ident" id="2301290">byteStringReplacer</span><span class="op" id="2301308">)</span>&nbsp;<span class="ident" id="2301310">Replace</span><span class="op" id="2301317">(</span><span class="ident" id="2301318">s</span>&nbsp;<span class="builtintype" id="2301320">string</span><span class="op" id="2301326">)</span>&nbsp;<span class="builtintype" id="2301328">string</span>&nbsp;<span class="op" id="2301335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2301338">newSize</span>&nbsp;<span class="op" id="2301346">:=</span>&nbsp;<span class="builtinfunc" id="2301349">len</span><span class="op" id="2301352">(</span><span class="ident" id="2301353">s</span><span class="op" id="2301354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2301357">anyChanges</span>&nbsp;<span class="op" id="2301368">:=</span>&nbsp;<span class="builtintype" id="2301371">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2301378">for</span>&nbsp;<span class="ident" id="2301382">i</span>&nbsp;<span class="op" id="2301384">:=</span>&nbsp;<span class="num" id="2301387">0</span><span class="op" id="2301388">;</span>&nbsp;<span class="ident" id="2301390">i</span>&nbsp;<span class="op" id="2301392">&lt;</span>&nbsp;<span class="builtinfunc" id="2301394">len</span><span class="op" id="2301397">(</span><span class="ident" id="2301398">s</span><span class="op" id="2301399">)</span><span class="op" id="2301400">;</span>&nbsp;<span class="ident" id="2301402">i</span><span class="op" id="2301403">++</span>&nbsp;<span class="op" id="2301406">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2301410">b</span>&nbsp;<span class="op" id="2301412">:=</span>&nbsp;<span class="ident" id="2301415">s</span><span class="op" id="2301416">[</span><span class="ident" id="2301417">i</span><span class="op" id="2301418">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2301422">if</span>&nbsp;<span class="ident" id="2301425">r</span><span class="op" id="2301426">[</span><span class="ident" id="2301427">b</span><span class="op" id="2301428">]</span>&nbsp;<span class="op" id="2301430">!=</span>&nbsp;<span class="builtintype" id="2301433">nil</span>&nbsp;<span class="op" id="2301437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2301442">anyChanges</span>&nbsp;<span class="op" id="2301453">=</span>&nbsp;<span class="builtintype" id="2301455">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2301463">//&nbsp;The&nbsp;-1&nbsp;is&nbsp;because&nbsp;we&nbsp;are&nbsp;replacing&nbsp;1&nbsp;byte&nbsp;with&nbsp;len(r[b])&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2301533">newSize</span>&nbsp;<span class="op" id="2301541">+=</span>&nbsp;<span class="builtinfunc" id="2301544">len</span><span class="op" id="2301547">(</span><span class="ident" id="2301548">r</span><span class="op" id="2301549">[</span><span class="ident" id="2301550">b</span><span class="op" id="2301551">]</span><span class="op" id="2301552">)</span>&nbsp;<span class="op" id="2301554">-</span>&nbsp;<span class="num" id="2301556">1</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2301560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2301563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2301566">if</span>&nbsp;<span class="op" id="2301569">!</span><span class="ident" id="2301570">anyChanges</span>&nbsp;<span class="op" id="2301581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2301585">return</span>&nbsp;<span class="ident" id="2301592">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2301595">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2301598">buf</span>&nbsp;<span class="op" id="2301602">:=</span>&nbsp;<span class="builtinfunc" id="2301605">make</span><span class="op" id="2301609">(</span><span class="op" id="2301610">[</span><span class="op" id="2301611">]</span><span class="builtintype" id="2301612">byte</span><span class="op" id="2301616">,</span>&nbsp;<span class="ident" id="2301618">newSize</span><span class="op" id="2301625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2301628">bi</span>&nbsp;<span class="op" id="2301631">:=</span>&nbsp;<span class="ident" id="2301634">buf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2301639">for</span>&nbsp;<span class="ident" id="2301643">i</span>&nbsp;<span class="op" id="2301645">:=</span>&nbsp;<span class="num" id="2301648">0</span><span class="op" id="2301649">;</span>&nbsp;<span class="ident" id="2301651">i</span>&nbsp;<span class="op" id="2301653">&lt;</span>&nbsp;<span class="builtinfunc" id="2301655">len</span><span class="op" id="2301658">(</span><span class="ident" id="2301659">s</span><span class="op" id="2301660">)</span><span class="op" id="2301661">;</span>&nbsp;<span class="ident" id="2301663">i</span><span class="op" id="2301664">++</span>&nbsp;<span class="op" id="2301667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2301671">b</span>&nbsp;<span class="op" id="2301673">:=</span>&nbsp;<span class="ident" id="2301676">s</span><span class="op" id="2301677">[</span><span class="ident" id="2301678">i</span><span class="op" id="2301679">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2301683">if</span>&nbsp;<span class="ident" id="2301686">r</span><span class="op" id="2301687">[</span><span class="ident" id="2301688">b</span><span class="op" id="2301689">]</span>&nbsp;<span class="op" id="2301691">!=</span>&nbsp;<span class="builtintype" id="2301694">nil</span>&nbsp;<span class="op" id="2301698">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2301703">n</span>&nbsp;<span class="op" id="2301705">:=</span>&nbsp;<span class="builtinfunc" id="2301708">copy</span><span class="op" id="2301712">(</span><span class="ident" id="2301713">bi</span><span class="op" id="2301715">,</span>&nbsp;<span class="ident" id="2301717">r</span><span class="op" id="2301718">[</span><span class="ident" id="2301719">b</span><span class="op" id="2301720">]</span><span class="op" id="2301721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2301726">bi</span>&nbsp;<span class="op" id="2301729">=</span>&nbsp;<span class="ident" id="2301731">bi</span><span class="op" id="2301733">[</span><span class="ident" id="2301734">n</span><span class="op" id="2301735">:</span><span class="op" id="2301736">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2301740">}</span>&nbsp;<span class="keyword" id="2301742">else</span>&nbsp;<span class="op" id="2301747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2301752">bi</span><span class="op" id="2301754">[</span><span class="num" id="2301755">0</span><span class="op" id="2301756">]</span>&nbsp;<span class="op" id="2301758">=</span>&nbsp;<span class="ident" id="2301760">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2301765">bi</span>&nbsp;<span class="op" id="2301768">=</span>&nbsp;<span class="ident" id="2301770">bi</span><span class="op" id="2301772">[</span><span class="num" id="2301773">1</span><span class="op" id="2301774">:</span><span class="op" id="2301775">]</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2301779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2301782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2301785">return</span>&nbsp;<span class="builtintype" id="2301792">string</span><span class="op" id="2301798">(</span><span class="ident" id="2301799">buf</span><span class="op" id="2301802">)</span><br>
<span class="lineno"></span><span class="op" id="2301804">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span><span class="keyword" id="2301807">func</span>&nbsp;<span class="op" id="2301812">(</span><span class="ident" id="2301813">r</span>&nbsp;<span class="op" id="2301815">*</span><span class="ident" id="2301816">byteStringReplacer</span><span class="op" id="2301834">)</span>&nbsp;<span class="ident" id="2301836">WriteString</span><span class="op" id="2301847">(</span><span class="ident" id="2301848">w</span>&nbsp;<span class="ident" id="2301850">io</span><span class="op" id="2301852">.</span><span class="ident" id="2301853">Writer</span><span class="op" id="2301859">,</span>&nbsp;<span class="ident" id="2301861">s</span>&nbsp;<span class="builtintype" id="2301863">string</span><span class="op" id="2301869">)</span>&nbsp;<span class="op" id="2301871">(</span><span class="ident" id="2301872">n</span>&nbsp;<span class="builtintype" id="2301874">int</span><span class="op" id="2301877">,</span>&nbsp;<span class="ident" id="2301879">err</span>&nbsp;<span class="builtintype" id="2301883">error</span><span class="op" id="2301888">)</span>&nbsp;<span class="op" id="2301890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2301893">sw</span>&nbsp;<span class="op" id="2301896">:=</span>&nbsp;<span class="ident" id="2301899">getStringWriter</span><span class="op" id="2301914">(</span><span class="ident" id="2301915">w</span><span class="op" id="2301916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2301919">last</span>&nbsp;<span class="op" id="2301924">:=</span>&nbsp;<span class="num" id="2301927">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2301930">for</span>&nbsp;<span class="ident" id="2301934">i</span>&nbsp;<span class="op" id="2301936">:=</span>&nbsp;<span class="num" id="2301939">0</span><span class="op" id="2301940">;</span>&nbsp;<span class="ident" id="2301942">i</span>&nbsp;<span class="op" id="2301944">&lt;</span>&nbsp;<span class="builtinfunc" id="2301946">len</span><span class="op" id="2301949">(</span><span class="ident" id="2301950">s</span><span class="op" id="2301951">)</span><span class="op" id="2301952">;</span>&nbsp;<span class="ident" id="2301954">i</span><span class="op" id="2301955">++</span>&nbsp;<span class="op" id="2301958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2301962">b</span>&nbsp;<span class="op" id="2301964">:=</span>&nbsp;<span class="ident" id="2301967">s</span><span class="op" id="2301968">[</span><span class="ident" id="2301969">i</span><span class="op" id="2301970">]</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2301974">if</span>&nbsp;<span class="ident" id="2301977">r</span><span class="op" id="2301978">[</span><span class="ident" id="2301979">b</span><span class="op" id="2301980">]</span>&nbsp;<span class="op" id="2301982">==</span>&nbsp;<span class="builtintype" id="2301985">nil</span>&nbsp;<span class="op" id="2301989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2301994">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2302005">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2302009">if</span>&nbsp;<span class="ident" id="2302012">last</span>&nbsp;<span class="op" id="2302017">!=</span>&nbsp;<span class="ident" id="2302020">i</span>&nbsp;<span class="op" id="2302022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2302027">nw</span><span class="op" id="2302029">,</span>&nbsp;<span class="ident" id="2302031">err</span>&nbsp;<span class="op" id="2302035">:=</span>&nbsp;<span class="ident" id="2302038">sw</span><span class="op" id="2302040">.</span><span class="ident" id="2302041">WriteString</span><span class="op" id="2302052">(</span><span class="ident" id="2302053">s</span><span class="op" id="2302054">[</span><span class="ident" id="2302055">last</span><span class="op" id="2302059">:</span><span class="ident" id="2302060">i</span><span class="op" id="2302061">]</span><span class="op" id="2302062">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2302067">n</span>&nbsp;<span class="op" id="2302069">+=</span>&nbsp;<span class="ident" id="2302072">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2302078">if</span>&nbsp;<span class="ident" id="2302081">err</span>&nbsp;<span class="op" id="2302085">!=</span>&nbsp;<span class="builtintype" id="2302088">nil</span>&nbsp;<span class="op" id="2302092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2302098">return</span>&nbsp;<span class="ident" id="2302105">n</span><span class="op" id="2302106">,</span>&nbsp;<span class="ident" id="2302108">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2302115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2302119">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2302123">last</span>&nbsp;<span class="op" id="2302128">=</span>&nbsp;<span class="ident" id="2302130">i</span>&nbsp;<span class="op" id="2302132">+</span>&nbsp;<span class="num" id="2302134">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2302138">nw</span><span class="op" id="2302140">,</span>&nbsp;<span class="ident" id="2302142">err</span>&nbsp;<span class="op" id="2302146">:=</span>&nbsp;<span class="ident" id="2302149">w</span><span class="op" id="2302150">.</span><span class="ident" id="2302151">Write</span><span class="op" id="2302156">(</span><span class="ident" id="2302157">r</span><span class="op" id="2302158">[</span><span class="ident" id="2302159">b</span><span class="op" id="2302160">]</span><span class="op" id="2302161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2302165">n</span>&nbsp;<span class="op" id="2302167">+=</span>&nbsp;<span class="ident" id="2302170">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2302175">if</span>&nbsp;<span class="ident" id="2302178">err</span>&nbsp;<span class="op" id="2302182">!=</span>&nbsp;<span class="builtintype" id="2302185">nil</span>&nbsp;<span class="op" id="2302189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2302194">return</span>&nbsp;<span class="ident" id="2302201">n</span><span class="op" id="2302202">,</span>&nbsp;<span class="ident" id="2302204">err</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2302210">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2302213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2302216">if</span>&nbsp;<span class="ident" id="2302219">last</span>&nbsp;<span class="op" id="2302224">!=</span>&nbsp;<span class="builtinfunc" id="2302227">len</span><span class="op" id="2302230">(</span><span class="ident" id="2302231">s</span><span class="op" id="2302232">)</span>&nbsp;<span class="op" id="2302234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2302238">var</span>&nbsp;<span class="ident" id="2302242">nw</span>&nbsp;<span class="builtintype" id="2302245">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2302251">nw</span><span class="op" id="2302253">,</span>&nbsp;<span class="ident" id="2302255">err</span>&nbsp;<span class="op" id="2302259">=</span>&nbsp;<span class="ident" id="2302261">sw</span><span class="op" id="2302263">.</span><span class="ident" id="2302264">WriteString</span><span class="op" id="2302275">(</span><span class="ident" id="2302276">s</span><span class="op" id="2302277">[</span><span class="ident" id="2302278">last</span><span class="op" id="2302282">:</span><span class="op" id="2302283">]</span><span class="op" id="2302284">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2302288">n</span>&nbsp;<span class="op" id="2302290">+=</span>&nbsp;<span class="ident" id="2302293">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2302297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2302300">return</span><br>
<span class="lineno"></span><span class="op" id="2302307">}</span>
</div>
</body>
</html>
