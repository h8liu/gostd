<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword">package</span>&nbsp;<span class="ident">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;sync/atomic&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;A&nbsp;Pool&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;temporary&nbsp;objects&nbsp;that&nbsp;may&nbsp;be&nbsp;individually&nbsp;saved&nbsp;and</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;retrieved.</span><br>
<span class="lineno">15</span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Any&nbsp;item&nbsp;stored&nbsp;in&nbsp;the&nbsp;Pool&nbsp;may&nbsp;be&nbsp;removed&nbsp;automatically&nbsp;at&nbsp;any&nbsp;time&nbsp;without</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;notification.&nbsp;If&nbsp;the&nbsp;Pool&nbsp;holds&nbsp;the&nbsp;only&nbsp;reference&nbsp;when&nbsp;this&nbsp;happens,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;item&nbsp;might&nbsp;be&nbsp;deallocated.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno">20</span><span class="comment">//&nbsp;A&nbsp;Pool&nbsp;is&nbsp;safe&nbsp;for&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines&nbsp;simultaneously.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Pool&#39;s&nbsp;purpose&nbsp;is&nbsp;to&nbsp;cache&nbsp;allocated&nbsp;but&nbsp;unused&nbsp;items&nbsp;for&nbsp;later&nbsp;reuse,</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;relieving&nbsp;pressure&nbsp;on&nbsp;the&nbsp;garbage&nbsp;collector.&nbsp;That&nbsp;is,&nbsp;it&nbsp;makes&nbsp;it&nbsp;easy&nbsp;to</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;build&nbsp;efficient,&nbsp;thread-safe&nbsp;free&nbsp;lists.&nbsp;However,&nbsp;it&nbsp;is&nbsp;not&nbsp;suitable&nbsp;for&nbsp;all</span><br>
<span class="lineno">25</span><span class="comment">//&nbsp;free&nbsp;lists.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;An&nbsp;appropriate&nbsp;use&nbsp;of&nbsp;a&nbsp;Pool&nbsp;is&nbsp;to&nbsp;manage&nbsp;a&nbsp;group&nbsp;of&nbsp;temporary&nbsp;items</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;silently&nbsp;shared&nbsp;among&nbsp;and&nbsp;potentially&nbsp;reused&nbsp;by&nbsp;concurrent&nbsp;independent</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;clients&nbsp;of&nbsp;a&nbsp;package.&nbsp;Pool&nbsp;provides&nbsp;a&nbsp;way&nbsp;to&nbsp;amortize&nbsp;allocation&nbsp;overhead</span><br>
<span class="lineno">30</span><span class="comment">//&nbsp;across&nbsp;many&nbsp;clients.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;An&nbsp;example&nbsp;of&nbsp;good&nbsp;use&nbsp;of&nbsp;a&nbsp;Pool&nbsp;is&nbsp;in&nbsp;the&nbsp;fmt&nbsp;package,&nbsp;which&nbsp;maintains&nbsp;a</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;dynamically-sized&nbsp;store&nbsp;of&nbsp;temporary&nbsp;output&nbsp;buffers.&nbsp;The&nbsp;store&nbsp;scales&nbsp;under</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;load&nbsp;(when&nbsp;many&nbsp;goroutines&nbsp;are&nbsp;actively&nbsp;printing)&nbsp;and&nbsp;shrinks&nbsp;when</span><br>
<span class="lineno">35</span><span class="comment">//&nbsp;quiescent.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;On&nbsp;the&nbsp;other&nbsp;hand,&nbsp;a&nbsp;free&nbsp;list&nbsp;maintained&nbsp;as&nbsp;part&nbsp;of&nbsp;a&nbsp;short-lived&nbsp;object&nbsp;is</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;not&nbsp;a&nbsp;suitable&nbsp;use&nbsp;for&nbsp;a&nbsp;Pool,&nbsp;since&nbsp;the&nbsp;overhead&nbsp;does&nbsp;not&nbsp;amortize&nbsp;well&nbsp;in</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;that&nbsp;scenario.&nbsp;It&nbsp;is&nbsp;more&nbsp;efficient&nbsp;to&nbsp;have&nbsp;such&nbsp;objects&nbsp;implement&nbsp;their&nbsp;own</span><br>
<span class="lineno">40</span><span class="comment">//&nbsp;free&nbsp;list.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">Pool</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span>&nbsp;<span class="comment">//&nbsp;local&nbsp;fixed-size&nbsp;per-P&nbsp;pool,&nbsp;actual&nbsp;type&nbsp;is&nbsp;[P]poolLocal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">localSize</span>&nbsp;<span class="builtintype">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;size&nbsp;of&nbsp;the&nbsp;local&nbsp;array</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;New&nbsp;optionally&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;generate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;a&nbsp;value&nbsp;when&nbsp;Get&nbsp;would&nbsp;otherwise&nbsp;return&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;It&nbsp;may&nbsp;not&nbsp;be&nbsp;changed&nbsp;concurrently&nbsp;with&nbsp;calls&nbsp;to&nbsp;Get.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">New</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="keyword">interface</span><span class="op">{</span><span class="op">}</span><br>
<span class="lineno">50</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Local&nbsp;per-P&nbsp;Pool&nbsp;appendix.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">poolLocal</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">private</span>&nbsp;<span class="keyword">interface</span><span class="op">{</span><span class="op">}</span>&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Can&nbsp;be&nbsp;used&nbsp;only&nbsp;by&nbsp;the&nbsp;respective&nbsp;P.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">shared</span>&nbsp;&nbsp;<span class="op">[</span><span class="op">]</span><span class="keyword">interface</span><span class="op">{</span><span class="op">}</span>&nbsp;<span class="comment">//&nbsp;Can&nbsp;be&nbsp;used&nbsp;by&nbsp;any&nbsp;P.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Protects&nbsp;shared.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">[</span><span class="num">128</span><span class="op">]</span><span class="builtintype">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Prevents&nbsp;false&nbsp;sharing.</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment">//&nbsp;Put&nbsp;adds&nbsp;x&nbsp;to&nbsp;the&nbsp;pool.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">p</span>&nbsp;<span class="op">*</span><span class="ident">Pool</span><span class="op">)</span>&nbsp;<span class="ident">Put</span><span class="op">(</span><span class="ident">x</span>&nbsp;<span class="keyword">interface</span><span class="op">{</span><span class="op">}</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">raceenabled</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Under&nbsp;race&nbsp;detector&nbsp;the&nbsp;Pool&nbsp;degenerates&nbsp;into&nbsp;no-op.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;It&#39;s&nbsp;conforming,&nbsp;simple&nbsp;and&nbsp;does&nbsp;not&nbsp;introduce&nbsp;excessive</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;happens-before&nbsp;edges&nbsp;between&nbsp;unrelated&nbsp;goroutines.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">pin</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="ident">private</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">.</span><span class="ident">private</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runtime_procUnpin</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">.</span><span class="ident">Lock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">.</span><span class="ident">shared</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">l</span><span class="op">.</span><span class="ident">shared</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">.</span><span class="ident">Unlock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="comment">//&nbsp;Get&nbsp;selects&nbsp;an&nbsp;arbitrary&nbsp;item&nbsp;from&nbsp;the&nbsp;Pool,&nbsp;removes&nbsp;it&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Pool,&nbsp;and&nbsp;returns&nbsp;it&nbsp;to&nbsp;the&nbsp;caller.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Get&nbsp;may&nbsp;choose&nbsp;to&nbsp;ignore&nbsp;the&nbsp;pool&nbsp;and&nbsp;treat&nbsp;it&nbsp;as&nbsp;empty.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Callers&nbsp;should&nbsp;not&nbsp;assume&nbsp;any&nbsp;relation&nbsp;between&nbsp;values&nbsp;passed&nbsp;to&nbsp;Put&nbsp;and</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;the&nbsp;values&nbsp;returned&nbsp;by&nbsp;Get.</span><br>
<span class="lineno">90</span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;Get&nbsp;would&nbsp;otherwise&nbsp;return&nbsp;nil&nbsp;and&nbsp;p.New&nbsp;is&nbsp;non-nil,&nbsp;Get&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;the&nbsp;result&nbsp;of&nbsp;calling&nbsp;p.New.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">p</span>&nbsp;<span class="op">*</span><span class="ident">Pool</span><span class="op">)</span>&nbsp;<span class="ident">Get</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="keyword">interface</span><span class="op">{</span><span class="op">}</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">raceenabled</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">New</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">pin</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="ident">private</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">.</span><span class="ident">private</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runtime_procUnpin</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">.</span><span class="ident">Lock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">last</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">l</span><span class="op">.</span><span class="ident">shared</span><span class="op">)</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">last</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="ident">shared</span><span class="op">[</span><span class="ident">last</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">.</span><span class="ident">shared</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="ident">shared</span><span class="op">[</span><span class="op">:</span><span class="ident">last</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">.</span><span class="ident">Unlock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">getSlow</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">p</span>&nbsp;<span class="op">*</span><span class="ident">Pool</span><span class="op">)</span>&nbsp;<span class="ident">getSlow</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">x</span>&nbsp;<span class="keyword">interface</span><span class="op">{</span><span class="op">}</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;in&nbsp;pin&nbsp;regarding&nbsp;ordering&nbsp;of&nbsp;the&nbsp;loads.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">size</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">atomic</span><span class="op">.</span><span class="ident">LoadUintptr</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">p</span><span class="op">.</span><span class="ident">localSize</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;load-acquire</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">local</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;load-consume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Try&nbsp;to&nbsp;steal&nbsp;one&nbsp;element&nbsp;from&nbsp;other&nbsp;procs.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pid</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">runtime_procPin</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runtime_procUnpin</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">size</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">indexLocal</span><span class="op">(</span><span class="ident">local</span><span class="op">,</span>&nbsp;<span class="op">(</span><span class="ident">pid</span><span class="op">+</span><span class="ident">i</span><span class="op">+</span><span class="num">1</span><span class="op">)</span><span class="op">%</span><span class="builtintype">int</span><span class="op">(</span><span class="ident">size</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">.</span><span class="ident">Lock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">last</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">l</span><span class="op">.</span><span class="ident">shared</span><span class="op">)</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">last</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="ident">shared</span><span class="op">[</span><span class="ident">last</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">.</span><span class="ident">shared</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="ident">shared</span><span class="op">[</span><span class="op">:</span><span class="ident">last</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">.</span><span class="ident">Unlock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">.</span><span class="ident">Unlock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">New</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">x</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;pin&nbsp;pins&nbsp;the&nbsp;current&nbsp;goroutine&nbsp;to&nbsp;P,&nbsp;disables&nbsp;preemption&nbsp;and&nbsp;returns&nbsp;poolLocal&nbsp;pool&nbsp;for&nbsp;the&nbsp;P.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Caller&nbsp;must&nbsp;call&nbsp;runtime_procUnpin()&nbsp;when&nbsp;done&nbsp;with&nbsp;the&nbsp;pool.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">p</span>&nbsp;<span class="op">*</span><span class="ident">Pool</span><span class="op">)</span>&nbsp;<span class="ident">pin</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">poolLocal</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pid</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">runtime_procPin</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;In&nbsp;pinSlow&nbsp;we&nbsp;store&nbsp;to&nbsp;localSize&nbsp;and&nbsp;then&nbsp;to&nbsp;local,&nbsp;here&nbsp;we&nbsp;load&nbsp;in&nbsp;opposite&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Since&nbsp;we&#39;ve&nbsp;disabled&nbsp;preemption,&nbsp;GC&nbsp;can&nbsp;not&nbsp;happen&nbsp;in&nbsp;between.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Thus&nbsp;here&nbsp;we&nbsp;must&nbsp;observe&nbsp;local&nbsp;at&nbsp;least&nbsp;as&nbsp;large&nbsp;localSize.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&nbsp;can&nbsp;observe&nbsp;a&nbsp;newer/larger&nbsp;local,&nbsp;it&nbsp;is&nbsp;fine&nbsp;(we&nbsp;must&nbsp;observe&nbsp;its&nbsp;zero-initialized-ness).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">atomic</span><span class="op">.</span><span class="ident">LoadUintptr</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">p</span><span class="op">.</span><span class="ident">localSize</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;load-acquire</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;load-consume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtintype">uintptr</span><span class="op">(</span><span class="ident">pid</span><span class="op">)</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">indexLocal</span><span class="op">(</span><span class="ident">l</span><span class="op">,</span>&nbsp;<span class="ident">pid</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">pinSlow</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">160</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">p</span>&nbsp;<span class="op">*</span><span class="ident">Pool</span><span class="op">)</span>&nbsp;<span class="ident">pinSlow</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">poolLocal</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Retry&nbsp;under&nbsp;the&nbsp;mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Can&nbsp;not&nbsp;lock&nbsp;the&nbsp;mutex&nbsp;while&nbsp;pinned.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runtime_procUnpin</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">allPoolsMu</span><span class="op">.</span><span class="ident">Lock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">allPoolsMu</span><span class="op">.</span><span class="ident">Unlock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pid</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">runtime_procPin</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;poolCleanup&nbsp;won&#39;t&nbsp;be&nbsp;called&nbsp;while&nbsp;we&nbsp;are&nbsp;pinned.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">localSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">local</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtintype">uintptr</span><span class="op">(</span><span class="ident">pid</span><span class="op">)</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">indexLocal</span><span class="op">(</span><span class="ident">l</span><span class="op">,</span>&nbsp;<span class="ident">pid</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">local</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">allPools</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">allPools</span><span class="op">,</span>&nbsp;<span class="ident">p</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;If&nbsp;GOMAXPROCS&nbsp;changes&nbsp;between&nbsp;GCs,&nbsp;we&nbsp;re-allocate&nbsp;the&nbsp;array&nbsp;and&nbsp;lose&nbsp;the&nbsp;old&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">size</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">runtime</span><span class="op">.</span><span class="ident">GOMAXPROCS</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">local</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="ident">poolLocal</span><span class="op">,</span>&nbsp;<span class="ident">size</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">atomic</span><span class="op">.</span><span class="ident">StorePointer</span><span class="op">(</span><span class="op">(</span><span class="op">*</span><span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><span class="op">)</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">p</span><span class="op">.</span><span class="ident">local</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">local</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;store-release</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">atomic</span><span class="op">.</span><span class="ident">StoreUintptr</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">p</span><span class="op">.</span><span class="ident">localSize</span><span class="op">,</span>&nbsp;<span class="builtintype">uintptr</span><span class="op">(</span><span class="ident">size</span><span class="op">)</span><span class="op">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;store-release</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">local</span><span class="op">[</span><span class="ident">pid</span><span class="op">]</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">poolCleanup</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;This&nbsp;function&nbsp;is&nbsp;called&nbsp;with&nbsp;the&nbsp;world&nbsp;stopped,&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;a&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;It&nbsp;must&nbsp;not&nbsp;allocate&nbsp;and&nbsp;probably&nbsp;should&nbsp;not&nbsp;call&nbsp;any&nbsp;runtime&nbsp;functions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Defensively&nbsp;zero&nbsp;out&nbsp;everything,&nbsp;2&nbsp;reasons:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;1.&nbsp;To&nbsp;prevent&nbsp;false&nbsp;retention&nbsp;of&nbsp;whole&nbsp;Pools.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;2.&nbsp;If&nbsp;GC&nbsp;happens&nbsp;while&nbsp;a&nbsp;goroutine&nbsp;works&nbsp;with&nbsp;l.shared&nbsp;in&nbsp;Put/Get,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp;it&nbsp;will&nbsp;retain&nbsp;whole&nbsp;Pool.&nbsp;So&nbsp;next&nbsp;cycle&nbsp;memory&nbsp;consumption&nbsp;would&nbsp;be&nbsp;doubled.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">p</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">allPools</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">allPools</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">p</span><span class="op">.</span><span class="ident">localSize</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">indexLocal</span><span class="op">(</span><span class="ident">p</span><span class="op">.</span><span class="ident">local</span><span class="op">,</span>&nbsp;<span class="ident">i</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">.</span><span class="ident">private</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="ident">shared</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">.</span><span class="ident">shared</span><span class="op">[</span><span class="ident">j</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">.</span><span class="ident">shared</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">p</span><span class="op">.</span><span class="ident">local</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">p</span><span class="op">.</span><span class="ident">localSize</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">allPools</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="op">*</span><span class="ident">Pool</span><span class="op">{</span><span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="op">(</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">allPoolsMu</span>&nbsp;<span class="ident">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">allPools</span>&nbsp;&nbsp;&nbsp;<span class="op">[</span><span class="op">]</span><span class="op">*</span><span class="ident">Pool</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">init</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runtime_registerPoolCleanup</span><span class="op">(</span><span class="ident">poolCleanup</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">indexLocal</span><span class="op">(</span><span class="ident">l</span>&nbsp;<span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><span class="op">,</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">poolLocal</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="op">(</span><span class="op">*</span><span class="op">[</span><span class="num">1000000</span><span class="op">]</span><span class="ident">poolLocal</span><span class="op">)</span><span class="op">(</span><span class="ident">l</span><span class="op">)</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><br>
<span class="lineno">220</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Implemented&nbsp;in&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">runtime_registerPoolCleanup</span><span class="op">(</span><span class="ident">cleanup</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">runtime_procPin</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">int</span><br>
<span class="lineno">225</span><span class="keyword">func</span>&nbsp;<span class="ident">runtime_procUnpin</span><span class="op">(</span><span class="op">)</span>
</div>
</body>
</html>
