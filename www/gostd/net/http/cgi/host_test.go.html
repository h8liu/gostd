<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6994630">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6994685">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6994739">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6994790">//&nbsp;Tests&nbsp;for&nbsp;package&nbsp;cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6994816">package</span>&nbsp;<span class="ident" id="6994824">cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6994829">import</span>&nbsp;<span class="op" id="6994836">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6994839">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6994848">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6994855">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6994861">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6994868">&#34;net/http&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6994880">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6994901">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6994907">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6994918">&#34;path/filepath&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6994935">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6994946">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6994957">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6994968">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6994979">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6994986">)</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="6994989">func</span>&nbsp;<span class="ident" id="6994994">newRequest</span><span class="op" id="6995004">(</span><span class="ident" id="6995005">httpreq</span>&nbsp;<span class="builtintype" id="6995013">string</span><span class="op" id="6995019">)</span>&nbsp;<span class="op" id="6995021">*</span><span class="ident" id="6995022">http</span><span class="op" id="6995026">.</span><span class="ident" id="6995027">Request</span>&nbsp;<span class="op" id="6995035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6995038">buf</span>&nbsp;<span class="op" id="6995042">:=</span>&nbsp;<span class="ident" id="6995045">bufio</span><span class="op" id="6995050">.</span><span class="ident" id="6995051">NewReader</span><span class="op" id="6995060">(</span><span class="ident" id="6995061">strings</span><span class="op" id="6995068">.</span><span class="ident" id="6995069">NewReader</span><span class="op" id="6995078">(</span><span class="ident" id="6995079">httpreq</span><span class="op" id="6995086">)</span><span class="op" id="6995087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6995090">req</span><span class="op" id="6995093">,</span>&nbsp;<span class="ident" id="6995095">err</span>&nbsp;<span class="op" id="6995099">:=</span>&nbsp;<span class="ident" id="6995102">http</span><span class="op" id="6995106">.</span><span class="ident" id="6995107">ReadRequest</span><span class="op" id="6995118">(</span><span class="ident" id="6995119">buf</span><span class="op" id="6995122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6995125">if</span>&nbsp;<span class="ident" id="6995128">err</span>&nbsp;<span class="op" id="6995132">!=</span>&nbsp;<span class="ident" id="6995135">nil</span>&nbsp;<span class="op" id="6995139">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6995143">panic</span><span class="op" id="6995148">(</span><span class="string" id="6995149">&#34;cgi:&nbsp;bogus&nbsp;http&nbsp;request&nbsp;in&nbsp;test:&nbsp;&#34;</span>&nbsp;<span class="op" id="6995185">+</span>&nbsp;<span class="ident" id="6995187">httpreq</span><span class="op" id="6995194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6995197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6995200">req</span><span class="op" id="6995203">.</span><span class="ident" id="6995204">RemoteAddr</span>&nbsp;<span class="op" id="6995215">=</span>&nbsp;<span class="string" id="6995217">&#34;1.2.3.4&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6995228">return</span>&nbsp;<span class="ident" id="6995235">req</span><br>
<span class="lineno"></span><span class="op" id="6995239">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="6995242">func</span>&nbsp;<span class="ident" id="6995247">runCgiTest</span><span class="op" id="6995257">(</span><span class="ident" id="6995258">t</span>&nbsp;<span class="op" id="6995260">*</span><span class="ident" id="6995261">testing</span><span class="op" id="6995268">.</span><span class="ident" id="6995269">T</span><span class="op" id="6995270">,</span>&nbsp;<span class="ident" id="6995272">h</span>&nbsp;<span class="op" id="6995274">*</span><span class="ident" id="6995275">Handler</span><span class="op" id="6995282">,</span>&nbsp;<span class="ident" id="6995284">httpreq</span>&nbsp;<span class="builtintype" id="6995292">string</span><span class="op" id="6995298">,</span>&nbsp;<span class="ident" id="6995300">expectedMap</span>&nbsp;<span class="keyword" id="6995312">map</span><span class="op" id="6995315">[</span><span class="builtintype" id="6995316">string</span><span class="op" id="6995322">]</span><span class="builtintype" id="6995323">string</span><span class="op" id="6995329">)</span>&nbsp;<span class="op" id="6995331">*</span><span class="ident" id="6995332">httptest</span><span class="op" id="6995340">.</span><span class="ident" id="6995341">ResponseRecorder</span>&nbsp;<span class="op" id="6995358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6995361">rw</span>&nbsp;<span class="op" id="6995364">:=</span>&nbsp;<span class="ident" id="6995367">httptest</span><span class="op" id="6995375">.</span><span class="ident" id="6995376">NewRecorder</span><span class="op" id="6995387">(</span><span class="op" id="6995388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6995391">req</span>&nbsp;<span class="op" id="6995395">:=</span>&nbsp;<span class="ident" id="6995398">newRequest</span><span class="op" id="6995408">(</span><span class="ident" id="6995409">httpreq</span><span class="op" id="6995416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6995419">h</span><span class="op" id="6995420">.</span><span class="ident" id="6995421">ServeHTTP</span><span class="op" id="6995430">(</span><span class="ident" id="6995431">rw</span><span class="op" id="6995433">,</span>&nbsp;<span class="ident" id="6995435">req</span><span class="op" id="6995438">)</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6995442">//&nbsp;Make&nbsp;a&nbsp;map&nbsp;to&nbsp;hold&nbsp;the&nbsp;test&nbsp;map&nbsp;that&nbsp;the&nbsp;CGI&nbsp;returns.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6995500">m</span>&nbsp;<span class="op" id="6995502">:=</span>&nbsp;<span class="builtinfunc" id="6995505">make</span><span class="op" id="6995509">(</span><span class="keyword" id="6995510">map</span><span class="op" id="6995513">[</span><span class="builtintype" id="6995514">string</span><span class="op" id="6995520">]</span><span class="builtintype" id="6995521">string</span><span class="op" id="6995527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6995530">m</span><span class="op" id="6995531">[</span><span class="string" id="6995532">&#34;_body&#34;</span><span class="op" id="6995539">]</span>&nbsp;<span class="op" id="6995541">=</span>&nbsp;<span class="ident" id="6995543">rw</span><span class="op" id="6995545">.</span><span class="ident" id="6995546">Body</span><span class="op" id="6995550">.</span><span class="ident" id="6995551">String</span><span class="op" id="6995557">(</span><span class="op" id="6995558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6995561">linesRead</span>&nbsp;<span class="op" id="6995571">:=</span>&nbsp;<span class="num" id="6995574">0</span><br>
<span class="lineno">45</span><span class="ident" id="6995576">readlines</span><span class="op" id="6995585">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6995588">for</span>&nbsp;<span class="op" id="6995592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6995596">line</span><span class="op" id="6995600">,</span>&nbsp;<span class="ident" id="6995602">err</span>&nbsp;<span class="op" id="6995606">:=</span>&nbsp;<span class="ident" id="6995609">rw</span><span class="op" id="6995611">.</span><span class="ident" id="6995612">Body</span><span class="op" id="6995616">.</span><span class="ident" id="6995617">ReadString</span><span class="op" id="6995627">(</span><span class="string" id="6995628">&#39;\n&#39;</span><span class="op" id="6995632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6995636">switch</span>&nbsp;<span class="op" id="6995643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6995647">case</span>&nbsp;<span class="ident" id="6995652">err</span>&nbsp;<span class="op" id="6995656">==</span>&nbsp;<span class="ident" id="6995659">io</span><span class="op" id="6995661">.</span><span class="ident" id="6995662">EOF</span><span class="op" id="6995665">:</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6995670">break</span>&nbsp;<span class="ident" id="6995676">readlines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6995688">case</span>&nbsp;<span class="ident" id="6995693">err</span>&nbsp;<span class="op" id="6995697">!=</span>&nbsp;<span class="ident" id="6995700">nil</span><span class="op" id="6995703">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6995708">t</span><span class="op" id="6995709">.</span><span class="ident" id="6995710">Fatalf</span><span class="op" id="6995716">(</span><span class="string" id="6995717">&#34;unexpected&nbsp;error&nbsp;reading&nbsp;from&nbsp;CGI:&nbsp;%v&#34;</span><span class="op" id="6995756">,</span>&nbsp;<span class="ident" id="6995758">err</span><span class="op" id="6995761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6995765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6995769">linesRead</span><span class="op" id="6995778">++</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6995783">trimmedLine</span>&nbsp;<span class="op" id="6995795">:=</span>&nbsp;<span class="ident" id="6995798">strings</span><span class="op" id="6995805">.</span><span class="ident" id="6995806">TrimRight</span><span class="op" id="6995815">(</span><span class="ident" id="6995816">line</span><span class="op" id="6995820">,</span>&nbsp;<span class="string" id="6995822">&#34;\r\n&#34;</span><span class="op" id="6995828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6995832">split</span>&nbsp;<span class="op" id="6995838">:=</span>&nbsp;<span class="ident" id="6995841">strings</span><span class="op" id="6995848">.</span><span class="ident" id="6995849">SplitN</span><span class="op" id="6995855">(</span><span class="ident" id="6995856">trimmedLine</span><span class="op" id="6995867">,</span>&nbsp;<span class="string" id="6995869">&#34;=&#34;</span><span class="op" id="6995872">,</span>&nbsp;<span class="num" id="6995874">2</span><span class="op" id="6995875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6995879">if</span>&nbsp;<span class="builtinfunc" id="6995882">len</span><span class="op" id="6995885">(</span><span class="ident" id="6995886">split</span><span class="op" id="6995891">)</span>&nbsp;<span class="op" id="6995893">!=</span>&nbsp;<span class="num" id="6995896">2</span>&nbsp;<span class="op" id="6995898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6995903">t</span><span class="op" id="6995904">.</span><span class="ident" id="6995905">Fatalf</span><span class="op" id="6995911">(</span><span class="string" id="6995912">&#34;Unexpected&nbsp;%d&nbsp;parts&nbsp;from&nbsp;invalid&nbsp;line&nbsp;number&nbsp;%v:&nbsp;%q;&nbsp;existing&nbsp;map=%v&#34;</span><span class="op" id="6995982">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6995988">len</span><span class="op" id="6995991">(</span><span class="ident" id="6995992">split</span><span class="op" id="6995997">)</span><span class="op" id="6995998">,</span>&nbsp;<span class="ident" id="6996000">linesRead</span><span class="op" id="6996009">,</span>&nbsp;<span class="ident" id="6996011">line</span><span class="op" id="6996015">,</span>&nbsp;<span class="ident" id="6996017">m</span><span class="op" id="6996018">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6996022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6996026">m</span><span class="op" id="6996027">[</span><span class="ident" id="6996028">split</span><span class="op" id="6996033">[</span><span class="num" id="6996034">0</span><span class="op" id="6996035">]</span><span class="op" id="6996036">]</span>&nbsp;<span class="op" id="6996038">=</span>&nbsp;<span class="ident" id="6996040">split</span><span class="op" id="6996045">[</span><span class="num" id="6996046">1</span><span class="op" id="6996047">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6996050">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6996054">for</span>&nbsp;<span class="ident" id="6996058">key</span><span class="op" id="6996061">,</span>&nbsp;<span class="ident" id="6996063">expected</span>&nbsp;<span class="op" id="6996072">:=</span>&nbsp;<span class="keyword" id="6996075">range</span>&nbsp;<span class="ident" id="6996081">expectedMap</span>&nbsp;<span class="op" id="6996093">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6996097">got</span>&nbsp;<span class="op" id="6996101">:=</span>&nbsp;<span class="ident" id="6996104">m</span><span class="op" id="6996105">[</span><span class="ident" id="6996106">key</span><span class="op" id="6996109">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6996113">if</span>&nbsp;<span class="ident" id="6996116">key</span>&nbsp;<span class="op" id="6996120">==</span>&nbsp;<span class="string" id="6996123">&#34;cwd&#34;</span>&nbsp;<span class="op" id="6996129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6996134">//&nbsp;For&nbsp;Windows.&nbsp;golang.org/issue/4645.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6996176">fi1</span><span class="op" id="6996179">,</span>&nbsp;<span class="ident" id="6996181">_</span>&nbsp;<span class="op" id="6996183">:=</span>&nbsp;<span class="ident" id="6996186">os</span><span class="op" id="6996188">.</span><span class="ident" id="6996189">Stat</span><span class="op" id="6996193">(</span><span class="ident" id="6996194">got</span><span class="op" id="6996197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6996202">fi2</span><span class="op" id="6996205">,</span>&nbsp;<span class="ident" id="6996207">_</span>&nbsp;<span class="op" id="6996209">:=</span>&nbsp;<span class="ident" id="6996212">os</span><span class="op" id="6996214">.</span><span class="ident" id="6996215">Stat</span><span class="op" id="6996219">(</span><span class="ident" id="6996220">expected</span><span class="op" id="6996228">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6996233">if</span>&nbsp;<span class="ident" id="6996236">os</span><span class="op" id="6996238">.</span><span class="ident" id="6996239">SameFile</span><span class="op" id="6996247">(</span><span class="ident" id="6996248">fi1</span><span class="op" id="6996251">,</span>&nbsp;<span class="ident" id="6996253">fi2</span><span class="op" id="6996256">)</span>&nbsp;<span class="op" id="6996258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6996264">got</span>&nbsp;<span class="op" id="6996268">=</span>&nbsp;<span class="ident" id="6996270">expected</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6996282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6996286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6996290">if</span>&nbsp;<span class="ident" id="6996293">got</span>&nbsp;<span class="op" id="6996297">!=</span>&nbsp;<span class="ident" id="6996300">expected</span>&nbsp;<span class="op" id="6996309">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6996314">t</span><span class="op" id="6996315">.</span><span class="ident" id="6996316">Errorf</span><span class="op" id="6996322">(</span><span class="string" id="6996323">&#34;for&nbsp;key&nbsp;%q&nbsp;got&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="6996355">,</span>&nbsp;<span class="ident" id="6996357">key</span><span class="op" id="6996360">,</span>&nbsp;<span class="ident" id="6996362">got</span><span class="op" id="6996365">,</span>&nbsp;<span class="ident" id="6996367">expected</span><span class="op" id="6996375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6996379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6996382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6996385">return</span>&nbsp;<span class="ident" id="6996392">rw</span><br>
<span class="lineno"></span><span class="op" id="6996395">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="6996398">var</span>&nbsp;<span class="ident" id="6996402">cgiTested</span><span class="op" id="6996411">,</span>&nbsp;<span class="ident" id="6996413">cgiWorks</span>&nbsp;<span class="builtintype" id="6996422">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6996428">func</span>&nbsp;<span class="ident" id="6996433">check</span><span class="op" id="6996438">(</span><span class="ident" id="6996439">t</span>&nbsp;<span class="op" id="6996441">*</span><span class="ident" id="6996442">testing</span><span class="op" id="6996449">.</span><span class="ident" id="6996450">T</span><span class="op" id="6996451">)</span>&nbsp;<span class="op" id="6996453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6996456">if</span>&nbsp;<span class="op" id="6996459">!</span><span class="ident" id="6996460">cgiTested</span>&nbsp;<span class="op" id="6996470">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6996474">cgiTested</span>&nbsp;<span class="op" id="6996484">=</span>&nbsp;<span class="builtintype" id="6996486">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6996493">cgiWorks</span>&nbsp;<span class="op" id="6996502">=</span>&nbsp;<span class="ident" id="6996504">exec</span><span class="op" id="6996508">.</span><span class="ident" id="6996509">Command</span><span class="op" id="6996516">(</span><span class="string" id="6996517">&#34;./testdata/test.cgi&#34;</span><span class="op" id="6996538">)</span><span class="op" id="6996539">.</span><span class="ident" id="6996540">Run</span><span class="op" id="6996543">(</span><span class="op" id="6996544">)</span>&nbsp;<span class="op" id="6996546">==</span>&nbsp;<span class="ident" id="6996549">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6996554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6996557">if</span>&nbsp;<span class="op" id="6996560">!</span><span class="ident" id="6996561">cgiWorks</span>&nbsp;<span class="op" id="6996570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6996574">//&nbsp;No&nbsp;Perl&nbsp;on&nbsp;Windows,&nbsp;needed&nbsp;by&nbsp;test.cgi</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6996618">//&nbsp;TODO:&nbsp;make&nbsp;the&nbsp;child&nbsp;process&nbsp;be&nbsp;Go,&nbsp;not&nbsp;Perl.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6996669">t</span><span class="op" id="6996670">.</span><span class="ident" id="6996671">Skip</span><span class="op" id="6996675">(</span><span class="string" id="6996676">&#34;Skipping&nbsp;test:&nbsp;test.cgi&nbsp;failed.&#34;</span><span class="op" id="6996709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6996712">}</span><br>
<span class="lineno"></span><span class="op" id="6996714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="6996717">func</span>&nbsp;<span class="ident" id="6996722">TestCGIBasicGet</span><span class="op" id="6996737">(</span><span class="ident" id="6996738">t</span>&nbsp;<span class="op" id="6996740">*</span><span class="ident" id="6996741">testing</span><span class="op" id="6996748">.</span><span class="ident" id="6996749">T</span><span class="op" id="6996750">)</span>&nbsp;<span class="op" id="6996752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6996755">check</span><span class="op" id="6996760">(</span><span class="ident" id="6996761">t</span><span class="op" id="6996762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6996765">h</span>&nbsp;<span class="op" id="6996767">:=</span>&nbsp;<span class="op" id="6996770">&amp;</span><span class="ident" id="6996771">Handler</span><span class="op" id="6996778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6996782">Path</span><span class="op" id="6996786">:</span>&nbsp;<span class="string" id="6996788">&#34;testdata/test.cgi&#34;</span><span class="op" id="6996807">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6996811">Root</span><span class="op" id="6996815">:</span>&nbsp;<span class="string" id="6996817">&#34;/test.cgi&#34;</span><span class="op" id="6996828">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6996831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6996834">expectedMap</span>&nbsp;<span class="op" id="6996846">:=</span>&nbsp;<span class="keyword" id="6996849">map</span><span class="op" id="6996852">[</span><span class="builtintype" id="6996853">string</span><span class="op" id="6996859">]</span><span class="builtintype" id="6996860">string</span><span class="op" id="6996866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6996870">&#34;test&#34;</span><span class="op" id="6996876">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6996895">&#34;Hello&nbsp;CGI&#34;</span><span class="op" id="6996906">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6996910">&#34;param-a&#34;</span><span class="op" id="6996919">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6996935">&#34;b&#34;</span><span class="op" id="6996938">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6996942">&#34;param-foo&#34;</span><span class="op" id="6996953">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6996967">&#34;bar&#34;</span><span class="op" id="6996972">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6996976">&#34;env-GATEWAY_INTERFACE&#34;</span><span class="op" id="6996999">:</span>&nbsp;<span class="string" id="6997001">&#34;CGI/1.1&#34;</span><span class="op" id="6997010">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6997014">&#34;env-HTTP_HOST&#34;</span><span class="op" id="6997029">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6997039">&#34;example.com&#34;</span><span class="op" id="6997052">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6997056">&#34;env-PATH_INFO&#34;</span><span class="op" id="6997071">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6997081">&#34;&#34;</span><span class="op" id="6997083">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6997087">&#34;env-QUERY_STRING&#34;</span><span class="op" id="6997105">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6997112">&#34;foo=bar&amp;a=b&#34;</span><span class="op" id="6997125">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6997129">&#34;env-REMOTE_ADDR&#34;</span><span class="op" id="6997146">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6997154">&#34;1.2.3.4&#34;</span><span class="op" id="6997163">,</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6997167">&#34;env-REMOTE_HOST&#34;</span><span class="op" id="6997184">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6997192">&#34;1.2.3.4&#34;</span><span class="op" id="6997201">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6997205">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="6997225">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6997230">&#34;GET&#34;</span><span class="op" id="6997235">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6997239">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6997256">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6997264">&#34;/test.cgi?foo=bar&amp;a=b&#34;</span><span class="op" id="6997287">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6997291">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6997312">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="6997316">&#34;testdata/test.cgi&#34;</span><span class="op" id="6997335">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6997339">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="6997356">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6997364">&#34;/test.cgi&#34;</span><span class="op" id="6997375">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6997379">&#34;env-SERVER_NAME&#34;</span><span class="op" id="6997396">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6997404">&#34;example.com&#34;</span><span class="op" id="6997417">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6997421">&#34;env-SERVER_PORT&#34;</span><span class="op" id="6997438">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6997446">&#34;80&#34;</span><span class="op" id="6997450">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6997454">&#34;env-SERVER_SOFTWARE&#34;</span><span class="op" id="6997475">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="6997479">&#34;go&#34;</span><span class="op" id="6997483">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6997486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6997489">replay</span>&nbsp;<span class="op" id="6997496">:=</span>&nbsp;<span class="ident" id="6997499">runCgiTest</span><span class="op" id="6997509">(</span><span class="ident" id="6997510">t</span><span class="op" id="6997511">,</span>&nbsp;<span class="ident" id="6997513">h</span><span class="op" id="6997514">,</span>&nbsp;<span class="string" id="6997516">&#34;GET&nbsp;/test.cgi?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6997575">,</span>&nbsp;<span class="ident" id="6997577">expectedMap</span><span class="op" id="6997588">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6997592">if</span>&nbsp;<span class="ident" id="6997595">expected</span><span class="op" id="6997603">,</span>&nbsp;<span class="ident" id="6997605">got</span>&nbsp;<span class="op" id="6997609">:=</span>&nbsp;<span class="string" id="6997612">&#34;text/html&#34;</span><span class="op" id="6997623">,</span>&nbsp;<span class="ident" id="6997625">replay</span><span class="op" id="6997631">.</span><span class="ident" id="6997632">Header</span><span class="op" id="6997638">(</span><span class="op" id="6997639">)</span><span class="op" id="6997640">.</span><span class="ident" id="6997641">Get</span><span class="op" id="6997644">(</span><span class="string" id="6997645">&#34;Content-Type&#34;</span><span class="op" id="6997659">)</span><span class="op" id="6997660">;</span>&nbsp;<span class="ident" id="6997662">got</span>&nbsp;<span class="op" id="6997666">!=</span>&nbsp;<span class="ident" id="6997669">expected</span>&nbsp;<span class="op" id="6997678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6997682">t</span><span class="op" id="6997683">.</span><span class="ident" id="6997684">Errorf</span><span class="op" id="6997690">(</span><span class="string" id="6997691">&#34;got&nbsp;a&nbsp;Content-Type&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="6997730">,</span>&nbsp;<span class="ident" id="6997732">got</span><span class="op" id="6997735">,</span>&nbsp;<span class="ident" id="6997737">expected</span><span class="op" id="6997745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6997748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6997751">if</span>&nbsp;<span class="ident" id="6997754">expected</span><span class="op" id="6997762">,</span>&nbsp;<span class="ident" id="6997764">got</span>&nbsp;<span class="op" id="6997768">:=</span>&nbsp;<span class="string" id="6997771">&#34;X-Test-Value&#34;</span><span class="op" id="6997785">,</span>&nbsp;<span class="ident" id="6997787">replay</span><span class="op" id="6997793">.</span><span class="ident" id="6997794">Header</span><span class="op" id="6997800">(</span><span class="op" id="6997801">)</span><span class="op" id="6997802">.</span><span class="ident" id="6997803">Get</span><span class="op" id="6997806">(</span><span class="string" id="6997807">&#34;X-Test-Header&#34;</span><span class="op" id="6997822">)</span><span class="op" id="6997823">;</span>&nbsp;<span class="ident" id="6997825">got</span>&nbsp;<span class="op" id="6997829">!=</span>&nbsp;<span class="ident" id="6997832">expected</span>&nbsp;<span class="op" id="6997841">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6997845">t</span><span class="op" id="6997846">.</span><span class="ident" id="6997847">Errorf</span><span class="op" id="6997853">(</span><span class="string" id="6997854">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="6997894">,</span>&nbsp;<span class="ident" id="6997896">got</span><span class="op" id="6997899">,</span>&nbsp;<span class="ident" id="6997901">expected</span><span class="op" id="6997909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6997912">}</span><br>
<span class="lineno"></span><span class="op" id="6997914">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6997917">func</span>&nbsp;<span class="ident" id="6997922">TestCGIBasicGetAbsPath</span><span class="op" id="6997944">(</span><span class="ident" id="6997945">t</span>&nbsp;<span class="op" id="6997947">*</span><span class="ident" id="6997948">testing</span><span class="op" id="6997955">.</span><span class="ident" id="6997956">T</span><span class="op" id="6997957">)</span>&nbsp;<span class="op" id="6997959">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6997962">check</span><span class="op" id="6997967">(</span><span class="ident" id="6997968">t</span><span class="op" id="6997969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6997972">pwd</span><span class="op" id="6997975">,</span>&nbsp;<span class="ident" id="6997977">err</span>&nbsp;<span class="op" id="6997981">:=</span>&nbsp;<span class="ident" id="6997984">os</span><span class="op" id="6997986">.</span><span class="ident" id="6997987">Getwd</span><span class="op" id="6997992">(</span><span class="op" id="6997993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6997996">if</span>&nbsp;<span class="ident" id="6997999">err</span>&nbsp;<span class="op" id="6998003">!=</span>&nbsp;<span class="ident" id="6998006">nil</span>&nbsp;<span class="op" id="6998010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6998014">t</span><span class="op" id="6998015">.</span><span class="ident" id="6998016">Fatalf</span><span class="op" id="6998022">(</span><span class="string" id="6998023">&#34;getwd&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="6998040">,</span>&nbsp;<span class="ident" id="6998042">err</span><span class="op" id="6998045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6998048">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6998051">h</span>&nbsp;<span class="op" id="6998053">:=</span>&nbsp;<span class="op" id="6998056">&amp;</span><span class="ident" id="6998057">Handler</span><span class="op" id="6998064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6998068">Path</span><span class="op" id="6998072">:</span>&nbsp;<span class="ident" id="6998074">pwd</span>&nbsp;<span class="op" id="6998078">+</span>&nbsp;<span class="string" id="6998080">&#34;/testdata/test.cgi&#34;</span><span class="op" id="6998100">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6998104">Root</span><span class="op" id="6998108">:</span>&nbsp;<span class="string" id="6998110">&#34;/test.cgi&#34;</span><span class="op" id="6998121">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6998124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6998127">expectedMap</span>&nbsp;<span class="op" id="6998139">:=</span>&nbsp;<span class="keyword" id="6998142">map</span><span class="op" id="6998145">[</span><span class="builtintype" id="6998146">string</span><span class="op" id="6998152">]</span><span class="builtintype" id="6998153">string</span><span class="op" id="6998159">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6998163">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6998180">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6998186">&#34;/test.cgi?foo=bar&amp;a=b&#34;</span><span class="op" id="6998209">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6998213">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6998234">:</span>&nbsp;<span class="ident" id="6998236">pwd</span>&nbsp;<span class="op" id="6998240">+</span>&nbsp;<span class="string" id="6998242">&#34;/testdata/test.cgi&#34;</span><span class="op" id="6998262">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6998266">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="6998283">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6998289">&#34;/test.cgi&#34;</span><span class="op" id="6998300">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6998303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6998306">runCgiTest</span><span class="op" id="6998316">(</span><span class="ident" id="6998317">t</span><span class="op" id="6998318">,</span>&nbsp;<span class="ident" id="6998320">h</span><span class="op" id="6998321">,</span>&nbsp;<span class="string" id="6998323">&#34;GET&nbsp;/test.cgi?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6998382">,</span>&nbsp;<span class="ident" id="6998384">expectedMap</span><span class="op" id="6998395">)</span><br>
<span class="lineno">145</span><span class="op" id="6998397">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6998400">func</span>&nbsp;<span class="ident" id="6998405">TestPathInfo</span><span class="op" id="6998417">(</span><span class="ident" id="6998418">t</span>&nbsp;<span class="op" id="6998420">*</span><span class="ident" id="6998421">testing</span><span class="op" id="6998428">.</span><span class="ident" id="6998429">T</span><span class="op" id="6998430">)</span>&nbsp;<span class="op" id="6998432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6998435">check</span><span class="op" id="6998440">(</span><span class="ident" id="6998441">t</span><span class="op" id="6998442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6998445">h</span>&nbsp;<span class="op" id="6998447">:=</span>&nbsp;<span class="op" id="6998450">&amp;</span><span class="ident" id="6998451">Handler</span><span class="op" id="6998458">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6998462">Path</span><span class="op" id="6998466">:</span>&nbsp;<span class="string" id="6998468">&#34;testdata/test.cgi&#34;</span><span class="op" id="6998487">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6998491">Root</span><span class="op" id="6998495">:</span>&nbsp;<span class="string" id="6998497">&#34;/test.cgi&#34;</span><span class="op" id="6998508">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6998511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6998514">expectedMap</span>&nbsp;<span class="op" id="6998526">:=</span>&nbsp;<span class="keyword" id="6998529">map</span><span class="op" id="6998532">[</span><span class="builtintype" id="6998533">string</span><span class="op" id="6998539">]</span><span class="builtintype" id="6998540">string</span><span class="op" id="6998546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6998550">&#34;param-a&#34;</span><span class="op" id="6998559">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6998573">&#34;b&#34;</span><span class="op" id="6998576">,</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6998580">&#34;env-PATH_INFO&#34;</span><span class="op" id="6998595">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6998603">&#34;/extrapath&#34;</span><span class="op" id="6998615">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6998619">&#34;env-QUERY_STRING&#34;</span><span class="op" id="6998637">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6998642">&#34;a=b&#34;</span><span class="op" id="6998647">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6998651">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6998668">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6998674">&#34;/test.cgi/extrapath?a=b&#34;</span><span class="op" id="6998699">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6998703">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6998724">:</span>&nbsp;<span class="string" id="6998726">&#34;testdata/test.cgi&#34;</span><span class="op" id="6998745">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6998749">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="6998766">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6998772">&#34;/test.cgi&#34;</span><span class="op" id="6998783">,</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6998786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6998789">runCgiTest</span><span class="op" id="6998799">(</span><span class="ident" id="6998800">t</span><span class="op" id="6998801">,</span>&nbsp;<span class="ident" id="6998803">h</span><span class="op" id="6998804">,</span>&nbsp;<span class="string" id="6998806">&#34;GET&nbsp;/test.cgi/extrapath?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6998867">,</span>&nbsp;<span class="ident" id="6998869">expectedMap</span><span class="op" id="6998880">)</span><br>
<span class="lineno"></span><span class="op" id="6998882">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6998885">func</span>&nbsp;<span class="ident" id="6998890">TestPathInfoDirRoot</span><span class="op" id="6998909">(</span><span class="ident" id="6998910">t</span>&nbsp;<span class="op" id="6998912">*</span><span class="ident" id="6998913">testing</span><span class="op" id="6998920">.</span><span class="ident" id="6998921">T</span><span class="op" id="6998922">)</span>&nbsp;<span class="op" id="6998924">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6998927">check</span><span class="op" id="6998932">(</span><span class="ident" id="6998933">t</span><span class="op" id="6998934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6998937">h</span>&nbsp;<span class="op" id="6998939">:=</span>&nbsp;<span class="op" id="6998942">&amp;</span><span class="ident" id="6998943">Handler</span><span class="op" id="6998950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6998954">Path</span><span class="op" id="6998958">:</span>&nbsp;<span class="string" id="6998960">&#34;testdata/test.cgi&#34;</span><span class="op" id="6998979">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6998983">Root</span><span class="op" id="6998987">:</span>&nbsp;<span class="string" id="6998989">&#34;/myscript/&#34;</span><span class="op" id="6999001">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6999004">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6999007">expectedMap</span>&nbsp;<span class="op" id="6999019">:=</span>&nbsp;<span class="keyword" id="6999022">map</span><span class="op" id="6999025">[</span><span class="builtintype" id="6999026">string</span><span class="op" id="6999032">]</span><span class="builtintype" id="6999033">string</span><span class="op" id="6999039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6999043">&#34;env-PATH_INFO&#34;</span><span class="op" id="6999058">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6999066">&#34;bar&#34;</span><span class="op" id="6999071">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6999075">&#34;env-QUERY_STRING&#34;</span><span class="op" id="6999093">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6999098">&#34;a=b&#34;</span><span class="op" id="6999103">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6999107">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6999124">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6999130">&#34;/myscript/bar?a=b&#34;</span><span class="op" id="6999149">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6999153">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6999174">:</span>&nbsp;<span class="string" id="6999176">&#34;testdata/test.cgi&#34;</span><span class="op" id="6999195">,</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6999199">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="6999216">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6999222">&#34;/myscript/&#34;</span><span class="op" id="6999234">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6999237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6999240">runCgiTest</span><span class="op" id="6999250">(</span><span class="ident" id="6999251">t</span><span class="op" id="6999252">,</span>&nbsp;<span class="ident" id="6999254">h</span><span class="op" id="6999255">,</span>&nbsp;<span class="string" id="6999257">&#34;GET&nbsp;/myscript/bar?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6999312">,</span>&nbsp;<span class="ident" id="6999314">expectedMap</span><span class="op" id="6999325">)</span><br>
<span class="lineno"></span><span class="op" id="6999327">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="6999330">func</span>&nbsp;<span class="ident" id="6999335">TestDupHeaders</span><span class="op" id="6999349">(</span><span class="ident" id="6999350">t</span>&nbsp;<span class="op" id="6999352">*</span><span class="ident" id="6999353">testing</span><span class="op" id="6999360">.</span><span class="ident" id="6999361">T</span><span class="op" id="6999362">)</span>&nbsp;<span class="op" id="6999364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6999367">check</span><span class="op" id="6999372">(</span><span class="ident" id="6999373">t</span><span class="op" id="6999374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6999377">h</span>&nbsp;<span class="op" id="6999379">:=</span>&nbsp;<span class="op" id="6999382">&amp;</span><span class="ident" id="6999383">Handler</span><span class="op" id="6999390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6999394">Path</span><span class="op" id="6999398">:</span>&nbsp;<span class="string" id="6999400">&#34;testdata/test.cgi&#34;</span><span class="op" id="6999419">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6999422">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6999425">expectedMap</span>&nbsp;<span class="op" id="6999437">:=</span>&nbsp;<span class="keyword" id="6999440">map</span><span class="op" id="6999443">[</span><span class="builtintype" id="6999444">string</span><span class="op" id="6999450">]</span><span class="builtintype" id="6999451">string</span><span class="op" id="6999457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6999461">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6999478">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6999484">&#34;/myscript/bar?a=b&#34;</span><span class="op" id="6999503">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6999507">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6999528">:</span>&nbsp;<span class="string" id="6999530">&#34;testdata/test.cgi&#34;</span><span class="op" id="6999549">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6999553">&#34;env-HTTP_COOKIE&#34;</span><span class="op" id="6999570">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6999576">&#34;nom=NOM;&nbsp;yum=YUM&#34;</span><span class="op" id="6999594">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6999598">&#34;env-HTTP_X_FOO&#34;</span><span class="op" id="6999614">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6999621">&#34;val1,&nbsp;val2&#34;</span><span class="op" id="6999633">,</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6999636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6999639">runCgiTest</span><span class="op" id="6999649">(</span><span class="ident" id="6999650">t</span><span class="op" id="6999651">,</span>&nbsp;<span class="ident" id="6999653">h</span><span class="op" id="6999654">,</span>&nbsp;<span class="string" id="6999656">&#34;GET&nbsp;/myscript/bar?a=b&nbsp;HTTP/1.0\n&#34;</span><span class="op" id="6999690">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6999694">&#34;Cookie:&nbsp;nom=NOM\n&#34;</span><span class="op" id="6999713">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6999717">&#34;Cookie:&nbsp;yum=YUM\n&#34;</span><span class="op" id="6999736">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6999740">&#34;X-Foo:&nbsp;val1\n&#34;</span><span class="op" id="6999755">+</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6999759">&#34;X-Foo:&nbsp;val2\n&#34;</span><span class="op" id="6999774">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6999778">&#34;Host:&nbsp;example.com\n\n&#34;</span><span class="op" id="6999801">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6999805">expectedMap</span><span class="op" id="6999816">)</span><br>
<span class="lineno"></span><span class="op" id="6999818">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span><span class="keyword" id="6999821">func</span>&nbsp;<span class="ident" id="6999826">TestPathInfoNoRoot</span><span class="op" id="6999844">(</span><span class="ident" id="6999845">t</span>&nbsp;<span class="op" id="6999847">*</span><span class="ident" id="6999848">testing</span><span class="op" id="6999855">.</span><span class="ident" id="6999856">T</span><span class="op" id="6999857">)</span>&nbsp;<span class="op" id="6999859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6999862">check</span><span class="op" id="6999867">(</span><span class="ident" id="6999868">t</span><span class="op" id="6999869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6999872">h</span>&nbsp;<span class="op" id="6999874">:=</span>&nbsp;<span class="op" id="6999877">&amp;</span><span class="ident" id="6999878">Handler</span><span class="op" id="6999885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6999889">Path</span><span class="op" id="6999893">:</span>&nbsp;<span class="string" id="6999895">&#34;testdata/test.cgi&#34;</span><span class="op" id="6999914">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6999918">Root</span><span class="op" id="6999922">:</span>&nbsp;<span class="string" id="6999924">&#34;&#34;</span><span class="op" id="6999926">,</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6999929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6999932">expectedMap</span>&nbsp;<span class="op" id="6999944">:=</span>&nbsp;<span class="keyword" id="6999947">map</span><span class="op" id="6999950">[</span><span class="builtintype" id="6999951">string</span><span class="op" id="6999957">]</span><span class="builtintype" id="6999958">string</span><span class="op" id="6999964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6999968">&#34;env-PATH_INFO&#34;</span><span class="op" id="6999983">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6999991">&#34;/bar&#34;</span><span class="op" id="6999997">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7000001">&#34;env-QUERY_STRING&#34;</span><span class="op" id="7000019">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7000024">&#34;a=b&#34;</span><span class="op" id="7000029">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7000033">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7000050">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7000056">&#34;/bar?a=b&#34;</span><span class="op" id="7000066">,</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7000070">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7000091">:</span>&nbsp;<span class="string" id="7000093">&#34;testdata/test.cgi&#34;</span><span class="op" id="7000112">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7000116">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7000133">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7000139">&#34;/&#34;</span><span class="op" id="7000142">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7000145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7000148">runCgiTest</span><span class="op" id="7000158">(</span><span class="ident" id="7000159">t</span><span class="op" id="7000160">,</span>&nbsp;<span class="ident" id="7000162">h</span><span class="op" id="7000163">,</span>&nbsp;<span class="string" id="7000165">&#34;GET&nbsp;/bar?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7000211">,</span>&nbsp;<span class="ident" id="7000213">expectedMap</span><span class="op" id="7000224">)</span><br>
<span class="lineno"></span><span class="op" id="7000226">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="7000229">func</span>&nbsp;<span class="ident" id="7000234">TestCGIBasicPost</span><span class="op" id="7000250">(</span><span class="ident" id="7000251">t</span>&nbsp;<span class="op" id="7000253">*</span><span class="ident" id="7000254">testing</span><span class="op" id="7000261">.</span><span class="ident" id="7000262">T</span><span class="op" id="7000263">)</span>&nbsp;<span class="op" id="7000265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7000268">check</span><span class="op" id="7000273">(</span><span class="ident" id="7000274">t</span><span class="op" id="7000275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7000278">postReq</span>&nbsp;<span class="op" id="7000286">:=</span>&nbsp;<span class="string" id="7000289">`POST&nbsp;/test.cgi?a=b&nbsp;HTTP/1.0<br>
<span class="lineno"></span>Host:&nbsp;example.com<br>
<span class="lineno">220</span>Content-Type:&nbsp;application/x-www-form-urlencoded<br>
<span class="lineno"></span>Content-Length:&nbsp;15<br>
<span class="lineno"></span><br>
<span class="lineno"></span>postfoo=postbar`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7000422">h</span>&nbsp;<span class="op" id="7000424">:=</span>&nbsp;<span class="op" id="7000427">&amp;</span><span class="ident" id="7000428">Handler</span><span class="op" id="7000435">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7000439">Path</span><span class="op" id="7000443">:</span>&nbsp;<span class="string" id="7000445">&#34;testdata/test.cgi&#34;</span><span class="op" id="7000464">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7000468">Root</span><span class="op" id="7000472">:</span>&nbsp;<span class="string" id="7000474">&#34;/test.cgi&#34;</span><span class="op" id="7000485">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7000488">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7000491">expectedMap</span>&nbsp;<span class="op" id="7000503">:=</span>&nbsp;<span class="keyword" id="7000506">map</span><span class="op" id="7000509">[</span><span class="builtintype" id="7000510">string</span><span class="op" id="7000516">]</span><span class="builtintype" id="7000517">string</span><span class="op" id="7000523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7000527">&#34;test&#34;</span><span class="op" id="7000533">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7000549">&#34;Hello&nbsp;CGI&#34;</span><span class="op" id="7000560">,</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7000564">&#34;param-postfoo&#34;</span><span class="op" id="7000579">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7000586">&#34;postbar&#34;</span><span class="op" id="7000595">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7000599">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="7000619">:</span>&nbsp;<span class="string" id="7000621">&#34;POST&#34;</span><span class="op" id="7000627">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7000631">&#34;env-CONTENT_LENGTH&#34;</span><span class="op" id="7000651">:</span>&nbsp;<span class="string" id="7000653">&#34;15&#34;</span><span class="op" id="7000657">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7000661">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7000678">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7000683">&#34;/test.cgi?a=b&#34;</span><span class="op" id="7000698">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7000701">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7000704">runCgiTest</span><span class="op" id="7000714">(</span><span class="ident" id="7000715">t</span><span class="op" id="7000716">,</span>&nbsp;<span class="ident" id="7000718">h</span><span class="op" id="7000719">,</span>&nbsp;<span class="ident" id="7000721">postReq</span><span class="op" id="7000728">,</span>&nbsp;<span class="ident" id="7000730">expectedMap</span><span class="op" id="7000741">)</span><br>
<span class="lineno"></span><span class="op" id="7000743">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7000746">func</span>&nbsp;<span class="ident" id="7000751">chunk</span><span class="op" id="7000756">(</span><span class="ident" id="7000757">s</span>&nbsp;<span class="builtintype" id="7000759">string</span><span class="op" id="7000765">)</span>&nbsp;<span class="builtintype" id="7000767">string</span>&nbsp;<span class="op" id="7000774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7000777">return</span>&nbsp;<span class="ident" id="7000784">fmt</span><span class="op" id="7000787">.</span><span class="ident" id="7000788">Sprintf</span><span class="op" id="7000795">(</span><span class="string" id="7000796">&#34;%x\r\n%s\r\n&#34;</span><span class="op" id="7000810">,</span>&nbsp;<span class="builtinfunc" id="7000812">len</span><span class="op" id="7000815">(</span><span class="ident" id="7000816">s</span><span class="op" id="7000817">)</span><span class="op" id="7000818">,</span>&nbsp;<span class="ident" id="7000820">s</span><span class="op" id="7000821">)</span><br>
<span class="lineno">240</span><span class="op" id="7000823">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7000826">//&nbsp;The&nbsp;CGI&nbsp;spec&nbsp;doesn&#39;t&nbsp;allow&nbsp;chunked&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="7000874">func</span>&nbsp;<span class="ident" id="7000879">TestCGIPostChunked</span><span class="op" id="7000897">(</span><span class="ident" id="7000898">t</span>&nbsp;<span class="op" id="7000900">*</span><span class="ident" id="7000901">testing</span><span class="op" id="7000908">.</span><span class="ident" id="7000909">T</span><span class="op" id="7000910">)</span>&nbsp;<span class="op" id="7000912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7000915">check</span><span class="op" id="7000920">(</span><span class="ident" id="7000921">t</span><span class="op" id="7000922">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7000925">postReq</span>&nbsp;<span class="op" id="7000933">:=</span>&nbsp;<span class="string" id="7000936">`POST&nbsp;/test.cgi?a=b&nbsp;HTTP/1.1<br>
<span class="lineno"></span>Host:&nbsp;example.com<br>
<span class="lineno"></span>Content-Type:&nbsp;application/x-www-form-urlencoded<br>
<span class="lineno"></span>Transfer-Encoding:&nbsp;chunked<br>
<span class="lineno"></span><br>
<span class="lineno">250</span>`</span>&nbsp;<span class="op" id="7001061">+</span>&nbsp;<span class="ident" id="7001063">chunk</span><span class="op" id="7001068">(</span><span class="string" id="7001069">&#34;postfoo&#34;</span><span class="op" id="7001078">)</span>&nbsp;<span class="op" id="7001080">+</span>&nbsp;<span class="ident" id="7001082">chunk</span><span class="op" id="7001087">(</span><span class="string" id="7001088">&#34;=&#34;</span><span class="op" id="7001091">)</span>&nbsp;<span class="op" id="7001093">+</span>&nbsp;<span class="ident" id="7001095">chunk</span><span class="op" id="7001100">(</span><span class="string" id="7001101">&#34;postbar&#34;</span><span class="op" id="7001110">)</span>&nbsp;<span class="op" id="7001112">+</span>&nbsp;<span class="ident" id="7001114">chunk</span><span class="op" id="7001119">(</span><span class="string" id="7001120">&#34;&#34;</span><span class="op" id="7001122">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7001126">h</span>&nbsp;<span class="op" id="7001128">:=</span>&nbsp;<span class="op" id="7001131">&amp;</span><span class="ident" id="7001132">Handler</span><span class="op" id="7001139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7001143">Path</span><span class="op" id="7001147">:</span>&nbsp;<span class="string" id="7001149">&#34;testdata/test.cgi&#34;</span><span class="op" id="7001168">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7001172">Root</span><span class="op" id="7001176">:</span>&nbsp;<span class="string" id="7001178">&#34;/test.cgi&#34;</span><span class="op" id="7001189">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7001192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7001195">expectedMap</span>&nbsp;<span class="op" id="7001207">:=</span>&nbsp;<span class="keyword" id="7001210">map</span><span class="op" id="7001213">[</span><span class="builtintype" id="7001214">string</span><span class="op" id="7001220">]</span><span class="builtintype" id="7001221">string</span><span class="op" id="7001227">{</span><span class="op" id="7001228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7001231">resp</span>&nbsp;<span class="op" id="7001236">:=</span>&nbsp;<span class="ident" id="7001239">runCgiTest</span><span class="op" id="7001249">(</span><span class="ident" id="7001250">t</span><span class="op" id="7001251">,</span>&nbsp;<span class="ident" id="7001253">h</span><span class="op" id="7001254">,</span>&nbsp;<span class="ident" id="7001256">postReq</span><span class="op" id="7001263">,</span>&nbsp;<span class="ident" id="7001265">expectedMap</span><span class="op" id="7001276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7001279">if</span>&nbsp;<span class="ident" id="7001282">got</span><span class="op" id="7001285">,</span>&nbsp;<span class="ident" id="7001287">expected</span>&nbsp;<span class="op" id="7001296">:=</span>&nbsp;<span class="ident" id="7001299">resp</span><span class="op" id="7001303">.</span><span class="ident" id="7001304">Code</span><span class="op" id="7001308">,</span>&nbsp;<span class="ident" id="7001310">http</span><span class="op" id="7001314">.</span><span class="ident" id="7001315">StatusBadRequest</span><span class="op" id="7001331">;</span>&nbsp;<span class="ident" id="7001333">got</span>&nbsp;<span class="op" id="7001337">!=</span>&nbsp;<span class="ident" id="7001340">expected</span>&nbsp;<span class="op" id="7001349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7001353">t</span><span class="op" id="7001354">.</span><span class="ident" id="7001355">Fatalf</span><span class="op" id="7001361">(</span><span class="string" id="7001362">&#34;Expected&nbsp;%v&nbsp;response&nbsp;code&nbsp;from&nbsp;chunked&nbsp;request&nbsp;body;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="7001423">,</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7001428">expected</span><span class="op" id="7001436">,</span>&nbsp;<span class="ident" id="7001438">got</span><span class="op" id="7001441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7001444">}</span><br>
<span class="lineno"></span><span class="op" id="7001446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7001449">func</span>&nbsp;<span class="ident" id="7001454">TestRedirect</span><span class="op" id="7001466">(</span><span class="ident" id="7001467">t</span>&nbsp;<span class="op" id="7001469">*</span><span class="ident" id="7001470">testing</span><span class="op" id="7001477">.</span><span class="ident" id="7001478">T</span><span class="op" id="7001479">)</span>&nbsp;<span class="op" id="7001481">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7001484">check</span><span class="op" id="7001489">(</span><span class="ident" id="7001490">t</span><span class="op" id="7001491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7001494">h</span>&nbsp;<span class="op" id="7001496">:=</span>&nbsp;<span class="op" id="7001499">&amp;</span><span class="ident" id="7001500">Handler</span><span class="op" id="7001507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7001511">Path</span><span class="op" id="7001515">:</span>&nbsp;<span class="string" id="7001517">&#34;testdata/test.cgi&#34;</span><span class="op" id="7001536">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7001540">Root</span><span class="op" id="7001544">:</span>&nbsp;<span class="string" id="7001546">&#34;/test.cgi&#34;</span><span class="op" id="7001557">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7001560">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7001563">rec</span>&nbsp;<span class="op" id="7001567">:=</span>&nbsp;<span class="ident" id="7001570">runCgiTest</span><span class="op" id="7001580">(</span><span class="ident" id="7001581">t</span><span class="op" id="7001582">,</span>&nbsp;<span class="ident" id="7001584">h</span><span class="op" id="7001585">,</span>&nbsp;<span class="string" id="7001587">&#34;GET&nbsp;/test.cgi?loc=http://foo.com/&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7001654">,</span>&nbsp;<span class="ident" id="7001656">nil</span><span class="op" id="7001659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7001662">if</span>&nbsp;<span class="ident" id="7001665">e</span><span class="op" id="7001666">,</span>&nbsp;<span class="ident" id="7001668">g</span>&nbsp;<span class="op" id="7001670">:=</span>&nbsp;<span class="num" id="7001673">302</span><span class="op" id="7001676">,</span>&nbsp;<span class="ident" id="7001678">rec</span><span class="op" id="7001681">.</span><span class="ident" id="7001682">Code</span><span class="op" id="7001686">;</span>&nbsp;<span class="ident" id="7001688">e</span>&nbsp;<span class="op" id="7001690">!=</span>&nbsp;<span class="ident" id="7001693">g</span>&nbsp;<span class="op" id="7001695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7001699">t</span><span class="op" id="7001700">.</span><span class="ident" id="7001701">Errorf</span><span class="op" id="7001707">(</span><span class="string" id="7001708">&#34;expected&nbsp;status&nbsp;code&nbsp;%d;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="7001741">,</span>&nbsp;<span class="ident" id="7001743">e</span><span class="op" id="7001744">,</span>&nbsp;<span class="ident" id="7001746">g</span><span class="op" id="7001747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7001750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7001753">if</span>&nbsp;<span class="ident" id="7001756">e</span><span class="op" id="7001757">,</span>&nbsp;<span class="ident" id="7001759">g</span>&nbsp;<span class="op" id="7001761">:=</span>&nbsp;<span class="string" id="7001764">&#34;http://foo.com/&#34;</span><span class="op" id="7001781">,</span>&nbsp;<span class="ident" id="7001783">rec</span><span class="op" id="7001786">.</span><span class="ident" id="7001787">Header</span><span class="op" id="7001793">(</span><span class="op" id="7001794">)</span><span class="op" id="7001795">.</span><span class="ident" id="7001796">Get</span><span class="op" id="7001799">(</span><span class="string" id="7001800">&#34;Location&#34;</span><span class="op" id="7001810">)</span><span class="op" id="7001811">;</span>&nbsp;<span class="ident" id="7001813">e</span>&nbsp;<span class="op" id="7001815">!=</span>&nbsp;<span class="ident" id="7001818">g</span>&nbsp;<span class="op" id="7001820">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7001824">t</span><span class="op" id="7001825">.</span><span class="ident" id="7001826">Errorf</span><span class="op" id="7001832">(</span><span class="string" id="7001833">&#34;expected&nbsp;Location&nbsp;header&nbsp;of&nbsp;%q;&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7001873">,</span>&nbsp;<span class="ident" id="7001875">e</span><span class="op" id="7001876">,</span>&nbsp;<span class="ident" id="7001878">g</span><span class="op" id="7001879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7001882">}</span><br>
<span class="lineno"></span><span class="op" id="7001884">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7001887">func</span>&nbsp;<span class="ident" id="7001892">TestInternalRedirect</span><span class="op" id="7001912">(</span><span class="ident" id="7001913">t</span>&nbsp;<span class="op" id="7001915">*</span><span class="ident" id="7001916">testing</span><span class="op" id="7001923">.</span><span class="ident" id="7001924">T</span><span class="op" id="7001925">)</span>&nbsp;<span class="op" id="7001927">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7001930">check</span><span class="op" id="7001935">(</span><span class="ident" id="7001936">t</span><span class="op" id="7001937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7001940">baseHandler</span>&nbsp;<span class="op" id="7001952">:=</span>&nbsp;<span class="ident" id="7001955">http</span><span class="op" id="7001959">.</span><span class="ident" id="7001960">HandlerFunc</span><span class="op" id="7001971">(</span><span class="keyword" id="7001972">func</span><span class="op" id="7001976">(</span><span class="ident" id="7001977">rw</span>&nbsp;<span class="ident" id="7001980">http</span><span class="op" id="7001984">.</span><span class="ident" id="7001985">ResponseWriter</span><span class="op" id="7001999">,</span>&nbsp;<span class="ident" id="7002001">req</span>&nbsp;<span class="op" id="7002005">*</span><span class="ident" id="7002006">http</span><span class="op" id="7002010">.</span><span class="ident" id="7002011">Request</span><span class="op" id="7002018">)</span>&nbsp;<span class="op" id="7002020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7002024">fmt</span><span class="op" id="7002027">.</span><span class="ident" id="7002028">Fprintf</span><span class="op" id="7002035">(</span><span class="ident" id="7002036">rw</span><span class="op" id="7002038">,</span>&nbsp;<span class="string" id="7002040">&#34;basepath=%s\n&#34;</span><span class="op" id="7002055">,</span>&nbsp;<span class="ident" id="7002057">req</span><span class="op" id="7002060">.</span><span class="ident" id="7002061">URL</span><span class="op" id="7002064">.</span><span class="ident" id="7002065">Path</span><span class="op" id="7002069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7002073">fmt</span><span class="op" id="7002076">.</span><span class="ident" id="7002077">Fprintf</span><span class="op" id="7002084">(</span><span class="ident" id="7002085">rw</span><span class="op" id="7002087">,</span>&nbsp;<span class="string" id="7002089">&#34;remoteaddr=%s\n&#34;</span><span class="op" id="7002106">,</span>&nbsp;<span class="ident" id="7002108">req</span><span class="op" id="7002111">.</span><span class="ident" id="7002112">RemoteAddr</span><span class="op" id="7002122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7002125">}</span><span class="op" id="7002126">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7002129">h</span>&nbsp;<span class="op" id="7002131">:=</span>&nbsp;<span class="op" id="7002134">&amp;</span><span class="ident" id="7002135">Handler</span><span class="op" id="7002142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7002146">Path</span><span class="op" id="7002150">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7002167">&#34;testdata/test.cgi&#34;</span><span class="op" id="7002186">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7002190">Root</span><span class="op" id="7002194">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7002211">&#34;/test.cgi&#34;</span><span class="op" id="7002222">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7002226">PathLocationHandler</span><span class="op" id="7002245">:</span>&nbsp;<span class="ident" id="7002247">baseHandler</span><span class="op" id="7002258">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7002261">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7002264">expectedMap</span>&nbsp;<span class="op" id="7002276">:=</span>&nbsp;<span class="keyword" id="7002279">map</span><span class="op" id="7002282">[</span><span class="builtintype" id="7002283">string</span><span class="op" id="7002289">]</span><span class="builtintype" id="7002290">string</span><span class="op" id="7002296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7002300">&#34;basepath&#34;</span><span class="op" id="7002310">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="7002314">&#34;/foo&#34;</span><span class="op" id="7002320">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7002324">&#34;remoteaddr&#34;</span><span class="op" id="7002336">:</span>&nbsp;<span class="string" id="7002338">&#34;1.2.3.4&#34;</span><span class="op" id="7002347">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7002350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7002353">runCgiTest</span><span class="op" id="7002363">(</span><span class="ident" id="7002364">t</span><span class="op" id="7002365">,</span>&nbsp;<span class="ident" id="7002367">h</span><span class="op" id="7002368">,</span>&nbsp;<span class="string" id="7002370">&#34;GET&nbsp;/test.cgi?loc=/foo&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7002426">,</span>&nbsp;<span class="ident" id="7002428">expectedMap</span><span class="op" id="7002439">)</span><br>
<span class="lineno">295</span><span class="op" id="7002441">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7002444">//&nbsp;TestCopyError&nbsp;tests&nbsp;that&nbsp;we&nbsp;kill&nbsp;the&nbsp;process&nbsp;if&nbsp;there&#39;s&nbsp;an&nbsp;error&nbsp;copying</span><br>
<span class="lineno"></span><span class="comment" id="7002520">//&nbsp;its&nbsp;output.&nbsp;(for&nbsp;example,&nbsp;from&nbsp;the&nbsp;client&nbsp;having&nbsp;gone&nbsp;away)</span><br>
<span class="lineno"></span><span class="keyword" id="7002583">func</span>&nbsp;<span class="ident" id="7002588">TestCopyError</span><span class="op" id="7002601">(</span><span class="ident" id="7002602">t</span>&nbsp;<span class="op" id="7002604">*</span><span class="ident" id="7002605">testing</span><span class="op" id="7002612">.</span><span class="ident" id="7002613">T</span><span class="op" id="7002614">)</span>&nbsp;<span class="op" id="7002616">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7002619">check</span><span class="op" id="7002624">(</span><span class="ident" id="7002625">t</span><span class="op" id="7002626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7002629">if</span>&nbsp;<span class="ident" id="7002632">runtime</span><span class="op" id="7002639">.</span><span class="ident" id="7002640">GOOS</span>&nbsp;<span class="op" id="7002645">==</span>&nbsp;<span class="string" id="7002648">&#34;windows&#34;</span>&nbsp;<span class="op" id="7002658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7002662">t</span><span class="op" id="7002663">.</span><span class="ident" id="7002664">Skipf</span><span class="op" id="7002669">(</span><span class="string" id="7002670">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7002691">,</span>&nbsp;<span class="ident" id="7002693">runtime</span><span class="op" id="7002700">.</span><span class="ident" id="7002701">GOOS</span><span class="op" id="7002705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7002708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7002711">h</span>&nbsp;<span class="op" id="7002713">:=</span>&nbsp;<span class="op" id="7002716">&amp;</span><span class="ident" id="7002717">Handler</span><span class="op" id="7002724">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7002728">Path</span><span class="op" id="7002732">:</span>&nbsp;<span class="string" id="7002734">&#34;testdata/test.cgi&#34;</span><span class="op" id="7002753">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7002757">Root</span><span class="op" id="7002761">:</span>&nbsp;<span class="string" id="7002763">&#34;/test.cgi&#34;</span><span class="op" id="7002774">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7002777">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7002780">ts</span>&nbsp;<span class="op" id="7002783">:=</span>&nbsp;<span class="ident" id="7002786">httptest</span><span class="op" id="7002794">.</span><span class="ident" id="7002795">NewServer</span><span class="op" id="7002804">(</span><span class="ident" id="7002805">h</span><span class="op" id="7002806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7002809">defer</span>&nbsp;<span class="ident" id="7002815">ts</span><span class="op" id="7002817">.</span><span class="ident" id="7002818">Close</span><span class="op" id="7002823">(</span><span class="op" id="7002824">)</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7002828">conn</span><span class="op" id="7002832">,</span>&nbsp;<span class="ident" id="7002834">err</span>&nbsp;<span class="op" id="7002838">:=</span>&nbsp;<span class="ident" id="7002841">net</span><span class="op" id="7002844">.</span><span class="ident" id="7002845">Dial</span><span class="op" id="7002849">(</span><span class="string" id="7002850">&#34;tcp&#34;</span><span class="op" id="7002855">,</span>&nbsp;<span class="ident" id="7002857">ts</span><span class="op" id="7002859">.</span><span class="ident" id="7002860">Listener</span><span class="op" id="7002868">.</span><span class="ident" id="7002869">Addr</span><span class="op" id="7002873">(</span><span class="op" id="7002874">)</span><span class="op" id="7002875">.</span><span class="ident" id="7002876">String</span><span class="op" id="7002882">(</span><span class="op" id="7002883">)</span><span class="op" id="7002884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7002887">if</span>&nbsp;<span class="ident" id="7002890">err</span>&nbsp;<span class="op" id="7002894">!=</span>&nbsp;<span class="ident" id="7002897">nil</span>&nbsp;<span class="op" id="7002901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7002905">t</span><span class="op" id="7002906">.</span><span class="ident" id="7002907">Fatal</span><span class="op" id="7002912">(</span><span class="ident" id="7002913">err</span><span class="op" id="7002916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7002919">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7002922">req</span><span class="op" id="7002925">,</span>&nbsp;<span class="ident" id="7002927">_</span>&nbsp;<span class="op" id="7002929">:=</span>&nbsp;<span class="ident" id="7002932">http</span><span class="op" id="7002936">.</span><span class="ident" id="7002937">NewRequest</span><span class="op" id="7002947">(</span><span class="string" id="7002948">&#34;GET&#34;</span><span class="op" id="7002953">,</span>&nbsp;<span class="string" id="7002955">&#34;http://example.com/test.cgi?bigresponse=1&#34;</span><span class="op" id="7002998">,</span>&nbsp;<span class="ident" id="7003000">nil</span><span class="op" id="7003003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7003006">err</span>&nbsp;<span class="op" id="7003010">=</span>&nbsp;<span class="ident" id="7003012">req</span><span class="op" id="7003015">.</span><span class="ident" id="7003016">Write</span><span class="op" id="7003021">(</span><span class="ident" id="7003022">conn</span><span class="op" id="7003026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7003029">if</span>&nbsp;<span class="ident" id="7003032">err</span>&nbsp;<span class="op" id="7003036">!=</span>&nbsp;<span class="ident" id="7003039">nil</span>&nbsp;<span class="op" id="7003043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7003047">t</span><span class="op" id="7003048">.</span><span class="ident" id="7003049">Fatalf</span><span class="op" id="7003055">(</span><span class="string" id="7003056">&#34;Write:&nbsp;%v&#34;</span><span class="op" id="7003067">,</span>&nbsp;<span class="ident" id="7003069">err</span><span class="op" id="7003072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7003075">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7003079">res</span><span class="op" id="7003082">,</span>&nbsp;<span class="ident" id="7003084">err</span>&nbsp;<span class="op" id="7003088">:=</span>&nbsp;<span class="ident" id="7003091">http</span><span class="op" id="7003095">.</span><span class="ident" id="7003096">ReadResponse</span><span class="op" id="7003108">(</span><span class="ident" id="7003109">bufio</span><span class="op" id="7003114">.</span><span class="ident" id="7003115">NewReader</span><span class="op" id="7003124">(</span><span class="ident" id="7003125">conn</span><span class="op" id="7003129">)</span><span class="op" id="7003130">,</span>&nbsp;<span class="ident" id="7003132">req</span><span class="op" id="7003135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7003138">if</span>&nbsp;<span class="ident" id="7003141">err</span>&nbsp;<span class="op" id="7003145">!=</span>&nbsp;<span class="ident" id="7003148">nil</span>&nbsp;<span class="op" id="7003152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7003156">t</span><span class="op" id="7003157">.</span><span class="ident" id="7003158">Fatalf</span><span class="op" id="7003164">(</span><span class="string" id="7003165">&#34;ReadResponse:&nbsp;%v&#34;</span><span class="op" id="7003183">,</span>&nbsp;<span class="ident" id="7003185">err</span><span class="op" id="7003188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7003191">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7003195">pidstr</span>&nbsp;<span class="op" id="7003202">:=</span>&nbsp;<span class="ident" id="7003205">res</span><span class="op" id="7003208">.</span><span class="ident" id="7003209">Header</span><span class="op" id="7003215">.</span><span class="ident" id="7003216">Get</span><span class="op" id="7003219">(</span><span class="string" id="7003220">&#34;X-CGI-Pid&#34;</span><span class="op" id="7003231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7003234">if</span>&nbsp;<span class="ident" id="7003237">pidstr</span>&nbsp;<span class="op" id="7003244">==</span>&nbsp;<span class="string" id="7003247">&#34;&#34;</span>&nbsp;<span class="op" id="7003250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7003254">t</span><span class="op" id="7003255">.</span><span class="ident" id="7003256">Fatalf</span><span class="op" id="7003262">(</span><span class="string" id="7003263">&#34;expected&nbsp;an&nbsp;X-CGI-Pid&nbsp;header&nbsp;in&nbsp;response&#34;</span><span class="op" id="7003305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7003308">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7003311">pid</span><span class="op" id="7003314">,</span>&nbsp;<span class="ident" id="7003316">err</span>&nbsp;<span class="op" id="7003320">:=</span>&nbsp;<span class="ident" id="7003323">strconv</span><span class="op" id="7003330">.</span><span class="ident" id="7003331">Atoi</span><span class="op" id="7003335">(</span><span class="ident" id="7003336">pidstr</span><span class="op" id="7003342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7003345">if</span>&nbsp;<span class="ident" id="7003348">err</span>&nbsp;<span class="op" id="7003352">!=</span>&nbsp;<span class="ident" id="7003355">nil</span>&nbsp;<span class="op" id="7003359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7003363">t</span><span class="op" id="7003364">.</span><span class="ident" id="7003365">Fatalf</span><span class="op" id="7003371">(</span><span class="string" id="7003372">&#34;invalid&nbsp;X-CGI-Pid&nbsp;value&#34;</span><span class="op" id="7003397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7003400">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7003404">var</span>&nbsp;<span class="ident" id="7003408">buf</span>&nbsp;<span class="op" id="7003412">[</span><span class="num" id="7003413">5000</span><span class="op" id="7003417">]</span><span class="builtintype" id="7003418">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7003424">n</span><span class="op" id="7003425">,</span>&nbsp;<span class="ident" id="7003427">err</span>&nbsp;<span class="op" id="7003431">:=</span>&nbsp;<span class="ident" id="7003434">io</span><span class="op" id="7003436">.</span><span class="ident" id="7003437">ReadFull</span><span class="op" id="7003445">(</span><span class="ident" id="7003446">res</span><span class="op" id="7003449">.</span><span class="ident" id="7003450">Body</span><span class="op" id="7003454">,</span>&nbsp;<span class="ident" id="7003456">buf</span><span class="op" id="7003459">[</span><span class="op" id="7003460">:</span><span class="op" id="7003461">]</span><span class="op" id="7003462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7003465">if</span>&nbsp;<span class="ident" id="7003468">err</span>&nbsp;<span class="op" id="7003472">!=</span>&nbsp;<span class="ident" id="7003475">nil</span>&nbsp;<span class="op" id="7003479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7003483">t</span><span class="op" id="7003484">.</span><span class="ident" id="7003485">Fatalf</span><span class="op" id="7003491">(</span><span class="string" id="7003492">&#34;ReadFull:&nbsp;%d&nbsp;bytes,&nbsp;%v&#34;</span><span class="op" id="7003516">,</span>&nbsp;<span class="ident" id="7003518">n</span><span class="op" id="7003519">,</span>&nbsp;<span class="ident" id="7003521">err</span><span class="op" id="7003524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7003527">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7003531">childRunning</span>&nbsp;<span class="op" id="7003544">:=</span>&nbsp;<span class="keyword" id="7003547">func</span><span class="op" id="7003551">(</span><span class="op" id="7003552">)</span>&nbsp;<span class="builtintype" id="7003554">bool</span>&nbsp;<span class="op" id="7003559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7003563">return</span>&nbsp;<span class="ident" id="7003570">isProcessRunning</span><span class="op" id="7003586">(</span><span class="ident" id="7003587">t</span><span class="op" id="7003588">,</span>&nbsp;<span class="ident" id="7003590">pid</span><span class="op" id="7003593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7003596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7003600">if</span>&nbsp;<span class="op" id="7003603">!</span><span class="ident" id="7003604">childRunning</span><span class="op" id="7003616">(</span><span class="op" id="7003617">)</span>&nbsp;<span class="op" id="7003619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7003623">t</span><span class="op" id="7003624">.</span><span class="ident" id="7003625">Fatalf</span><span class="op" id="7003631">(</span><span class="string" id="7003632">&#34;pre-conn.Close,&nbsp;expected&nbsp;child&nbsp;to&nbsp;be&nbsp;running&#34;</span><span class="op" id="7003678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7003681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7003684">conn</span><span class="op" id="7003688">.</span><span class="ident" id="7003689">Close</span><span class="op" id="7003694">(</span><span class="op" id="7003695">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7003699">tries</span>&nbsp;<span class="op" id="7003705">:=</span>&nbsp;<span class="num" id="7003708">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7003711">for</span>&nbsp;<span class="ident" id="7003715">tries</span>&nbsp;<span class="op" id="7003721">&lt;</span>&nbsp;<span class="num" id="7003723">25</span>&nbsp;<span class="op" id="7003726">&amp;&amp;</span>&nbsp;<span class="ident" id="7003729">childRunning</span><span class="op" id="7003741">(</span><span class="op" id="7003742">)</span>&nbsp;<span class="op" id="7003744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7003748">time</span><span class="op" id="7003752">.</span><span class="ident" id="7003753">Sleep</span><span class="op" id="7003758">(</span><span class="num" id="7003759">50</span>&nbsp;<span class="op" id="7003762">*</span>&nbsp;<span class="ident" id="7003764">time</span><span class="op" id="7003768">.</span><span class="ident" id="7003769">Millisecond</span>&nbsp;<span class="op" id="7003781">*</span>&nbsp;<span class="ident" id="7003783">time</span><span class="op" id="7003787">.</span><span class="ident" id="7003788">Duration</span><span class="op" id="7003796">(</span><span class="ident" id="7003797">tries</span><span class="op" id="7003802">)</span><span class="op" id="7003803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7003807">tries</span><span class="op" id="7003812">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7003816">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7003819">if</span>&nbsp;<span class="ident" id="7003822">childRunning</span><span class="op" id="7003834">(</span><span class="op" id="7003835">)</span>&nbsp;<span class="op" id="7003837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7003841">t</span><span class="op" id="7003842">.</span><span class="ident" id="7003843">Fatalf</span><span class="op" id="7003849">(</span><span class="string" id="7003850">&#34;post-conn.Close,&nbsp;expected&nbsp;child&nbsp;to&nbsp;be&nbsp;gone&#34;</span><span class="op" id="7003894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7003897">}</span><br>
<span class="lineno"></span><span class="op" id="7003899">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span><span class="keyword" id="7003902">func</span>&nbsp;<span class="ident" id="7003907">TestDirUnix</span><span class="op" id="7003918">(</span><span class="ident" id="7003919">t</span>&nbsp;<span class="op" id="7003921">*</span><span class="ident" id="7003922">testing</span><span class="op" id="7003929">.</span><span class="ident" id="7003930">T</span><span class="op" id="7003931">)</span>&nbsp;<span class="op" id="7003933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7003936">check</span><span class="op" id="7003941">(</span><span class="ident" id="7003942">t</span><span class="op" id="7003943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7003946">if</span>&nbsp;<span class="ident" id="7003949">runtime</span><span class="op" id="7003956">.</span><span class="ident" id="7003957">GOOS</span>&nbsp;<span class="op" id="7003962">==</span>&nbsp;<span class="string" id="7003965">&#34;windows&#34;</span>&nbsp;<span class="op" id="7003975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7003979">t</span><span class="op" id="7003980">.</span><span class="ident" id="7003981">Skipf</span><span class="op" id="7003986">(</span><span class="string" id="7003987">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7004008">,</span>&nbsp;<span class="ident" id="7004010">runtime</span><span class="op" id="7004017">.</span><span class="ident" id="7004018">GOOS</span><span class="op" id="7004022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7004025">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004028">cwd</span><span class="op" id="7004031">,</span>&nbsp;<span class="ident" id="7004033">_</span>&nbsp;<span class="op" id="7004035">:=</span>&nbsp;<span class="ident" id="7004038">os</span><span class="op" id="7004040">.</span><span class="ident" id="7004041">Getwd</span><span class="op" id="7004046">(</span><span class="op" id="7004047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004050">h</span>&nbsp;<span class="op" id="7004052">:=</span>&nbsp;<span class="op" id="7004055">&amp;</span><span class="ident" id="7004056">Handler</span><span class="op" id="7004063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004067">Path</span><span class="op" id="7004071">:</span>&nbsp;<span class="string" id="7004073">&#34;testdata/test.cgi&#34;</span><span class="op" id="7004092">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004096">Root</span><span class="op" id="7004100">:</span>&nbsp;<span class="string" id="7004102">&#34;/test.cgi&#34;</span><span class="op" id="7004113">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004117">Dir</span><span class="op" id="7004120">:</span>&nbsp;&nbsp;<span class="ident" id="7004123">cwd</span><span class="op" id="7004126">,</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7004129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004132">expectedMap</span>&nbsp;<span class="op" id="7004144">:=</span>&nbsp;<span class="keyword" id="7004147">map</span><span class="op" id="7004150">[</span><span class="builtintype" id="7004151">string</span><span class="op" id="7004157">]</span><span class="builtintype" id="7004158">string</span><span class="op" id="7004164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7004168">&#34;cwd&#34;</span><span class="op" id="7004173">:</span>&nbsp;<span class="ident" id="7004175">cwd</span><span class="op" id="7004178">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7004181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004184">runCgiTest</span><span class="op" id="7004194">(</span><span class="ident" id="7004195">t</span><span class="op" id="7004196">,</span>&nbsp;<span class="ident" id="7004198">h</span><span class="op" id="7004199">,</span>&nbsp;<span class="string" id="7004201">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7004248">,</span>&nbsp;<span class="ident" id="7004250">expectedMap</span><span class="op" id="7004261">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004265">cwd</span><span class="op" id="7004268">,</span>&nbsp;<span class="ident" id="7004270">_</span>&nbsp;<span class="op" id="7004272">=</span>&nbsp;<span class="ident" id="7004274">os</span><span class="op" id="7004276">.</span><span class="ident" id="7004277">Getwd</span><span class="op" id="7004282">(</span><span class="op" id="7004283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004286">cwd</span>&nbsp;<span class="op" id="7004290">=</span>&nbsp;<span class="ident" id="7004292">filepath</span><span class="op" id="7004300">.</span><span class="ident" id="7004301">Join</span><span class="op" id="7004305">(</span><span class="ident" id="7004306">cwd</span><span class="op" id="7004309">,</span>&nbsp;<span class="string" id="7004311">&#34;testdata&#34;</span><span class="op" id="7004321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004324">h</span>&nbsp;<span class="op" id="7004326">=</span>&nbsp;<span class="op" id="7004328">&amp;</span><span class="ident" id="7004329">Handler</span><span class="op" id="7004336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004340">Path</span><span class="op" id="7004344">:</span>&nbsp;<span class="string" id="7004346">&#34;testdata/test.cgi&#34;</span><span class="op" id="7004365">,</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004369">Root</span><span class="op" id="7004373">:</span>&nbsp;<span class="string" id="7004375">&#34;/test.cgi&#34;</span><span class="op" id="7004386">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7004389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004392">expectedMap</span>&nbsp;<span class="op" id="7004404">=</span>&nbsp;<span class="keyword" id="7004406">map</span><span class="op" id="7004409">[</span><span class="builtintype" id="7004410">string</span><span class="op" id="7004416">]</span><span class="builtintype" id="7004417">string</span><span class="op" id="7004423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7004427">&#34;cwd&#34;</span><span class="op" id="7004432">:</span>&nbsp;<span class="ident" id="7004434">cwd</span><span class="op" id="7004437">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7004440">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004443">runCgiTest</span><span class="op" id="7004453">(</span><span class="ident" id="7004454">t</span><span class="op" id="7004455">,</span>&nbsp;<span class="ident" id="7004457">h</span><span class="op" id="7004458">,</span>&nbsp;<span class="string" id="7004460">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7004507">,</span>&nbsp;<span class="ident" id="7004509">expectedMap</span><span class="op" id="7004520">)</span><br>
<span class="lineno"></span><span class="op" id="7004522">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7004525">func</span>&nbsp;<span class="ident" id="7004530">TestDirWindows</span><span class="op" id="7004544">(</span><span class="ident" id="7004545">t</span>&nbsp;<span class="op" id="7004547">*</span><span class="ident" id="7004548">testing</span><span class="op" id="7004555">.</span><span class="ident" id="7004556">T</span><span class="op" id="7004557">)</span>&nbsp;<span class="op" id="7004559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7004562">if</span>&nbsp;<span class="ident" id="7004565">runtime</span><span class="op" id="7004572">.</span><span class="ident" id="7004573">GOOS</span>&nbsp;<span class="op" id="7004578">!=</span>&nbsp;<span class="string" id="7004581">&#34;windows&#34;</span>&nbsp;<span class="op" id="7004591">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004595">t</span><span class="op" id="7004596">.</span><span class="ident" id="7004597">Skip</span><span class="op" id="7004601">(</span><span class="string" id="7004602">&#34;Skipping&nbsp;windows&nbsp;specific&nbsp;test.&#34;</span><span class="op" id="7004635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7004638">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004642">cgifile</span><span class="op" id="7004649">,</span>&nbsp;<span class="ident" id="7004651">_</span>&nbsp;<span class="op" id="7004653">:=</span>&nbsp;<span class="ident" id="7004656">filepath</span><span class="op" id="7004664">.</span><span class="ident" id="7004665">Abs</span><span class="op" id="7004668">(</span><span class="string" id="7004669">&#34;testdata/test.cgi&#34;</span><span class="op" id="7004688">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7004692">var</span>&nbsp;<span class="ident" id="7004696">perl</span>&nbsp;<span class="builtintype" id="7004701">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7004709">var</span>&nbsp;<span class="ident" id="7004713">err</span>&nbsp;<span class="builtintype" id="7004717">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004724">perl</span><span class="op" id="7004728">,</span>&nbsp;<span class="ident" id="7004730">err</span>&nbsp;<span class="op" id="7004734">=</span>&nbsp;<span class="ident" id="7004736">exec</span><span class="op" id="7004740">.</span><span class="ident" id="7004741">LookPath</span><span class="op" id="7004749">(</span><span class="string" id="7004750">&#34;perl&#34;</span><span class="op" id="7004756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7004759">if</span>&nbsp;<span class="ident" id="7004762">err</span>&nbsp;<span class="op" id="7004766">!=</span>&nbsp;<span class="ident" id="7004769">nil</span>&nbsp;<span class="op" id="7004773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004777">t</span><span class="op" id="7004778">.</span><span class="ident" id="7004779">Skip</span><span class="op" id="7004783">(</span><span class="string" id="7004784">&#34;Skipping&nbsp;test:&nbsp;perl&nbsp;not&nbsp;found.&#34;</span><span class="op" id="7004816">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7004819">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004822">perl</span><span class="op" id="7004826">,</span>&nbsp;<span class="ident" id="7004828">_</span>&nbsp;<span class="op" id="7004830">=</span>&nbsp;<span class="ident" id="7004832">filepath</span><span class="op" id="7004840">.</span><span class="ident" id="7004841">Abs</span><span class="op" id="7004844">(</span><span class="ident" id="7004845">perl</span><span class="op" id="7004849">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004853">cwd</span><span class="op" id="7004856">,</span>&nbsp;<span class="ident" id="7004858">_</span>&nbsp;<span class="op" id="7004860">:=</span>&nbsp;<span class="ident" id="7004863">os</span><span class="op" id="7004865">.</span><span class="ident" id="7004866">Getwd</span><span class="op" id="7004871">(</span><span class="op" id="7004872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004875">h</span>&nbsp;<span class="op" id="7004877">:=</span>&nbsp;<span class="op" id="7004880">&amp;</span><span class="ident" id="7004881">Handler</span><span class="op" id="7004888">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004892">Path</span><span class="op" id="7004896">:</span>&nbsp;<span class="ident" id="7004898">perl</span><span class="op" id="7004902">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004906">Root</span><span class="op" id="7004910">:</span>&nbsp;<span class="string" id="7004912">&#34;/test.cgi&#34;</span><span class="op" id="7004923">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004927">Dir</span><span class="op" id="7004930">:</span>&nbsp;&nbsp;<span class="ident" id="7004933">cwd</span><span class="op" id="7004936">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004940">Args</span><span class="op" id="7004944">:</span>&nbsp;<span class="op" id="7004946">[</span><span class="op" id="7004947">]</span><span class="builtintype" id="7004948">string</span><span class="op" id="7004954">{</span><span class="ident" id="7004955">cgifile</span><span class="op" id="7004962">}</span><span class="op" id="7004963">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004967">Env</span><span class="op" id="7004970">:</span>&nbsp;&nbsp;<span class="op" id="7004973">[</span><span class="op" id="7004974">]</span><span class="builtintype" id="7004975">string</span><span class="op" id="7004981">{</span><span class="string" id="7004982">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="7005001">+</span>&nbsp;<span class="ident" id="7005003">cgifile</span><span class="op" id="7005010">}</span><span class="op" id="7005011">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7005014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005017">expectedMap</span>&nbsp;<span class="op" id="7005029">:=</span>&nbsp;<span class="keyword" id="7005032">map</span><span class="op" id="7005035">[</span><span class="builtintype" id="7005036">string</span><span class="op" id="7005042">]</span><span class="builtintype" id="7005043">string</span><span class="op" id="7005049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7005053">&#34;cwd&#34;</span><span class="op" id="7005058">:</span>&nbsp;<span class="ident" id="7005060">cwd</span><span class="op" id="7005063">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7005066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005069">runCgiTest</span><span class="op" id="7005079">(</span><span class="ident" id="7005080">t</span><span class="op" id="7005081">,</span>&nbsp;<span class="ident" id="7005083">h</span><span class="op" id="7005084">,</span>&nbsp;<span class="string" id="7005086">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7005133">,</span>&nbsp;<span class="ident" id="7005135">expectedMap</span><span class="op" id="7005146">)</span><br>
<span class="lineno">415</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7005150">//&nbsp;If&nbsp;not&nbsp;specify&nbsp;Dir&nbsp;on&nbsp;windows,&nbsp;working&nbsp;directory&nbsp;should&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7005213">//&nbsp;base&nbsp;directory&nbsp;of&nbsp;perl.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005241">cwd</span><span class="op" id="7005244">,</span>&nbsp;<span class="ident" id="7005246">_</span>&nbsp;<span class="op" id="7005248">=</span>&nbsp;<span class="ident" id="7005250">filepath</span><span class="op" id="7005258">.</span><span class="ident" id="7005259">Split</span><span class="op" id="7005264">(</span><span class="ident" id="7005265">perl</span><span class="op" id="7005269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7005272">if</span>&nbsp;<span class="ident" id="7005275">cwd</span>&nbsp;<span class="op" id="7005279">!=</span>&nbsp;<span class="string" id="7005282">&#34;&#34;</span>&nbsp;<span class="op" id="7005285">&amp;&amp;</span>&nbsp;<span class="ident" id="7005288">cwd</span><span class="op" id="7005291">[</span><span class="builtinfunc" id="7005292">len</span><span class="op" id="7005295">(</span><span class="ident" id="7005296">cwd</span><span class="op" id="7005299">)</span><span class="op" id="7005300">-</span><span class="num" id="7005301">1</span><span class="op" id="7005302">]</span>&nbsp;<span class="op" id="7005304">==</span>&nbsp;<span class="ident" id="7005307">filepath</span><span class="op" id="7005315">.</span><span class="ident" id="7005316">Separator</span>&nbsp;<span class="op" id="7005326">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005330">cwd</span>&nbsp;<span class="op" id="7005334">=</span>&nbsp;<span class="ident" id="7005336">cwd</span><span class="op" id="7005339">[</span><span class="op" id="7005340">:</span><span class="builtinfunc" id="7005341">len</span><span class="op" id="7005344">(</span><span class="ident" id="7005345">cwd</span><span class="op" id="7005348">)</span><span class="op" id="7005349">-</span><span class="num" id="7005350">1</span><span class="op" id="7005351">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7005354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005357">h</span>&nbsp;<span class="op" id="7005359">=</span>&nbsp;<span class="op" id="7005361">&amp;</span><span class="ident" id="7005362">Handler</span><span class="op" id="7005369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005373">Path</span><span class="op" id="7005377">:</span>&nbsp;<span class="ident" id="7005379">perl</span><span class="op" id="7005383">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005387">Root</span><span class="op" id="7005391">:</span>&nbsp;<span class="string" id="7005393">&#34;/test.cgi&#34;</span><span class="op" id="7005404">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005408">Args</span><span class="op" id="7005412">:</span>&nbsp;<span class="op" id="7005414">[</span><span class="op" id="7005415">]</span><span class="builtintype" id="7005416">string</span><span class="op" id="7005422">{</span><span class="ident" id="7005423">cgifile</span><span class="op" id="7005430">}</span><span class="op" id="7005431">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005435">Env</span><span class="op" id="7005438">:</span>&nbsp;&nbsp;<span class="op" id="7005441">[</span><span class="op" id="7005442">]</span><span class="builtintype" id="7005443">string</span><span class="op" id="7005449">{</span><span class="string" id="7005450">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="7005469">+</span>&nbsp;<span class="ident" id="7005471">cgifile</span><span class="op" id="7005478">}</span><span class="op" id="7005479">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7005482">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005485">expectedMap</span>&nbsp;<span class="op" id="7005497">=</span>&nbsp;<span class="keyword" id="7005499">map</span><span class="op" id="7005502">[</span><span class="builtintype" id="7005503">string</span><span class="op" id="7005509">]</span><span class="builtintype" id="7005510">string</span><span class="op" id="7005516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7005520">&#34;cwd&#34;</span><span class="op" id="7005525">:</span>&nbsp;<span class="ident" id="7005527">cwd</span><span class="op" id="7005530">,</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7005533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005536">runCgiTest</span><span class="op" id="7005546">(</span><span class="ident" id="7005547">t</span><span class="op" id="7005548">,</span>&nbsp;<span class="ident" id="7005550">h</span><span class="op" id="7005551">,</span>&nbsp;<span class="string" id="7005553">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7005600">,</span>&nbsp;<span class="ident" id="7005602">expectedMap</span><span class="op" id="7005613">)</span><br>
<span class="lineno"></span><span class="op" id="7005615">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7005618">func</span>&nbsp;<span class="ident" id="7005623">TestEnvOverride</span><span class="op" id="7005638">(</span><span class="ident" id="7005639">t</span>&nbsp;<span class="op" id="7005641">*</span><span class="ident" id="7005642">testing</span><span class="op" id="7005649">.</span><span class="ident" id="7005650">T</span><span class="op" id="7005651">)</span>&nbsp;<span class="op" id="7005653">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005656">cgifile</span><span class="op" id="7005663">,</span>&nbsp;<span class="ident" id="7005665">_</span>&nbsp;<span class="op" id="7005667">:=</span>&nbsp;<span class="ident" id="7005670">filepath</span><span class="op" id="7005678">.</span><span class="ident" id="7005679">Abs</span><span class="op" id="7005682">(</span><span class="string" id="7005683">&#34;testdata/test.cgi&#34;</span><span class="op" id="7005702">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7005706">var</span>&nbsp;<span class="ident" id="7005710">perl</span>&nbsp;<span class="builtintype" id="7005715">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7005723">var</span>&nbsp;<span class="ident" id="7005727">err</span>&nbsp;<span class="builtintype" id="7005731">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005738">perl</span><span class="op" id="7005742">,</span>&nbsp;<span class="ident" id="7005744">err</span>&nbsp;<span class="op" id="7005748">=</span>&nbsp;<span class="ident" id="7005750">exec</span><span class="op" id="7005754">.</span><span class="ident" id="7005755">LookPath</span><span class="op" id="7005763">(</span><span class="string" id="7005764">&#34;perl&#34;</span><span class="op" id="7005770">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7005773">if</span>&nbsp;<span class="ident" id="7005776">err</span>&nbsp;<span class="op" id="7005780">!=</span>&nbsp;<span class="ident" id="7005783">nil</span>&nbsp;<span class="op" id="7005787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005791">t</span><span class="op" id="7005792">.</span><span class="ident" id="7005793">Skipf</span><span class="op" id="7005798">(</span><span class="string" id="7005799">&#34;Skipping&nbsp;test:&nbsp;perl&nbsp;not&nbsp;found.&#34;</span><span class="op" id="7005831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7005834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005837">perl</span><span class="op" id="7005841">,</span>&nbsp;<span class="ident" id="7005843">_</span>&nbsp;<span class="op" id="7005845">=</span>&nbsp;<span class="ident" id="7005847">filepath</span><span class="op" id="7005855">.</span><span class="ident" id="7005856">Abs</span><span class="op" id="7005859">(</span><span class="ident" id="7005860">perl</span><span class="op" id="7005864">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005868">cwd</span><span class="op" id="7005871">,</span>&nbsp;<span class="ident" id="7005873">_</span>&nbsp;<span class="op" id="7005875">:=</span>&nbsp;<span class="ident" id="7005878">os</span><span class="op" id="7005880">.</span><span class="ident" id="7005881">Getwd</span><span class="op" id="7005886">(</span><span class="op" id="7005887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005890">h</span>&nbsp;<span class="op" id="7005892">:=</span>&nbsp;<span class="op" id="7005895">&amp;</span><span class="ident" id="7005896">Handler</span><span class="op" id="7005903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005907">Path</span><span class="op" id="7005911">:</span>&nbsp;<span class="ident" id="7005913">perl</span><span class="op" id="7005917">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005921">Root</span><span class="op" id="7005925">:</span>&nbsp;<span class="string" id="7005927">&#34;/test.cgi&#34;</span><span class="op" id="7005938">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005942">Dir</span><span class="op" id="7005945">:</span>&nbsp;&nbsp;<span class="ident" id="7005948">cwd</span><span class="op" id="7005951">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005955">Args</span><span class="op" id="7005959">:</span>&nbsp;<span class="op" id="7005961">[</span><span class="op" id="7005962">]</span><span class="builtintype" id="7005963">string</span><span class="op" id="7005969">{</span><span class="ident" id="7005970">cgifile</span><span class="op" id="7005977">}</span><span class="op" id="7005978">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005982">Env</span><span class="op" id="7005985">:</span>&nbsp;<span class="op" id="7005987">[</span><span class="op" id="7005988">]</span><span class="builtintype" id="7005989">string</span><span class="op" id="7005995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7006000">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="7006019">+</span>&nbsp;<span class="ident" id="7006021">cgifile</span><span class="op" id="7006028">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7006033">&#34;REQUEST_URI=/foo/bar&#34;</span><span class="op" id="7006055">}</span><span class="op" id="7006056">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7006059">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7006062">expectedMap</span>&nbsp;<span class="op" id="7006074">:=</span>&nbsp;<span class="keyword" id="7006077">map</span><span class="op" id="7006080">[</span><span class="builtintype" id="7006081">string</span><span class="op" id="7006087">]</span><span class="builtintype" id="7006088">string</span><span class="op" id="7006094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7006098">&#34;cwd&#34;</span><span class="op" id="7006103">:</span>&nbsp;<span class="ident" id="7006105">cwd</span><span class="op" id="7006108">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7006112">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7006133">:</span>&nbsp;<span class="ident" id="7006135">cgifile</span><span class="op" id="7006142">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7006146">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7006163">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7006169">&#34;/foo/bar&#34;</span><span class="op" id="7006179">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7006182">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7006185">runCgiTest</span><span class="op" id="7006195">(</span><span class="ident" id="7006196">t</span><span class="op" id="7006197">,</span>&nbsp;<span class="ident" id="7006199">h</span><span class="op" id="7006200">,</span>&nbsp;<span class="string" id="7006202">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7006249">,</span>&nbsp;<span class="ident" id="7006251">expectedMap</span><span class="op" id="7006262">)</span><br>
<span class="lineno"></span><span class="op" id="7006264">}</span>
</div>
</body>
</html>
