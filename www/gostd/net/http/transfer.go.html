<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html" class="current">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3576033">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3576088">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3576142">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3576193">package</span>&nbsp;<span class="ident" id="3576201">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3576207">import</span>&nbsp;<span class="op" id="3576214">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3576217">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3576226">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3576235">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3576245">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3576252">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3576258">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3576271">&#34;net/http/internal&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3576292">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3576309">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3576317">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3576328">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3576339">&#34;sync&#34;</span><br>
<span class="lineno">20</span><span class="op" id="3576346">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3576349">//&nbsp;ErrLineTooLong&nbsp;is&nbsp;returned&nbsp;when&nbsp;reading&nbsp;request&nbsp;or&nbsp;response&nbsp;bodies</span><br>
<span class="lineno"></span><span class="comment" id="3576419">//&nbsp;with&nbsp;malformed&nbsp;chunked&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="keyword" id="3576455">var</span>&nbsp;<span class="ident" id="3576459">ErrLineTooLong</span>&nbsp;<span class="op" id="3576474">=</span>&nbsp;<span class="ident" id="3576476">internal</span><span class="op" id="3576484">.</span><span class="ident" id="3576485">ErrLineTooLong</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="3576501">type</span>&nbsp;<span class="ident" id="3576506">errorReader</span>&nbsp;<span class="keyword" id="3576518">struct</span>&nbsp;<span class="op" id="3576525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576528">err</span>&nbsp;<span class="builtintype" id="3576532">error</span><br>
<span class="lineno"></span><span class="op" id="3576538">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="keyword" id="3576541">func</span>&nbsp;<span class="op" id="3576546">(</span><span class="ident" id="3576547">r</span>&nbsp;<span class="op" id="3576549">*</span><span class="ident" id="3576550">errorReader</span><span class="op" id="3576561">)</span>&nbsp;<span class="ident" id="3576563">Read</span><span class="op" id="3576567">(</span><span class="ident" id="3576568">p</span>&nbsp;<span class="op" id="3576570">[</span><span class="op" id="3576571">]</span><span class="builtintype" id="3576572">byte</span><span class="op" id="3576576">)</span>&nbsp;<span class="op" id="3576578">(</span><span class="ident" id="3576579">n</span>&nbsp;<span class="builtintype" id="3576581">int</span><span class="op" id="3576584">,</span>&nbsp;<span class="ident" id="3576586">err</span>&nbsp;<span class="builtintype" id="3576590">error</span><span class="op" id="3576595">)</span>&nbsp;<span class="op" id="3576597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3576600">return</span>&nbsp;<span class="num" id="3576607">0</span><span class="op" id="3576608">,</span>&nbsp;<span class="ident" id="3576610">r</span><span class="op" id="3576611">.</span><span class="ident" id="3576612">err</span><br>
<span class="lineno"></span><span class="op" id="3576616">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3576619">//&nbsp;transferWriter&nbsp;inspects&nbsp;the&nbsp;fields&nbsp;of&nbsp;a&nbsp;user-supplied&nbsp;Request&nbsp;or&nbsp;Response,</span><br>
<span class="lineno">35</span><span class="comment" id="3576697">//&nbsp;sanitizes&nbsp;them&nbsp;without&nbsp;changing&nbsp;the&nbsp;user&nbsp;object&nbsp;and&nbsp;provides&nbsp;methods&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3576773">//&nbsp;writing&nbsp;the&nbsp;respective&nbsp;header,&nbsp;body&nbsp;and&nbsp;trailer&nbsp;in&nbsp;wire&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="3576840">type</span>&nbsp;<span class="ident" id="3576845">transferWriter</span>&nbsp;<span class="keyword" id="3576860">struct</span>&nbsp;<span class="op" id="3576867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576870">Method</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3576887">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576895">Body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576912">io</span><span class="op" id="3576914">.</span><span class="ident" id="3576915">Reader</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576923">BodyCloser</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576940">io</span><span class="op" id="3576942">.</span><span class="ident" id="3576943">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576951">ResponseToHEAD</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3576968">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576974">ContentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576991">int64</span>&nbsp;<span class="comment" id="3576997">//&nbsp;-1&nbsp;means&nbsp;unknown,&nbsp;0&nbsp;means&nbsp;exactly&nbsp;none</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3577040">Close</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3577057">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3577063">TransferEncoding</span>&nbsp;<span class="op" id="3577080">[</span><span class="op" id="3577081">]</span><span class="builtintype" id="3577082">string</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3577090">Trailer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3577107">Header</span><br>
<span class="lineno"></span><span class="op" id="3577114">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3577117">func</span>&nbsp;<span class="ident" id="3577122">newTransferWriter</span><span class="op" id="3577139">(</span><span class="ident" id="3577140">r</span>&nbsp;<span class="keyword" id="3577142">interface</span><span class="op" id="3577151">{</span><span class="op" id="3577152">}</span><span class="op" id="3577153">)</span>&nbsp;<span class="op" id="3577155">(</span><span class="ident" id="3577156">t</span>&nbsp;<span class="op" id="3577158">*</span><span class="ident" id="3577159">transferWriter</span><span class="op" id="3577173">,</span>&nbsp;<span class="ident" id="3577175">err</span>&nbsp;<span class="builtintype" id="3577179">error</span><span class="op" id="3577184">)</span>&nbsp;<span class="op" id="3577186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3577189">t</span>&nbsp;<span class="op" id="3577191">=</span>&nbsp;<span class="op" id="3577193">&amp;</span><span class="ident" id="3577194">transferWriter</span><span class="op" id="3577208">{</span><span class="op" id="3577209">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3577213">//&nbsp;Extract&nbsp;relevant&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3577241">atLeastHTTP11</span>&nbsp;<span class="op" id="3577255">:=</span>&nbsp;<span class="builtintype" id="3577258">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3577265">switch</span>&nbsp;<span class="ident" id="3577272">rr</span>&nbsp;<span class="op" id="3577275">:=</span>&nbsp;<span class="ident" id="3577278">r</span><span class="op" id="3577279">.</span><span class="op" id="3577280">(</span><span class="keyword" id="3577281">type</span><span class="op" id="3577285">)</span>&nbsp;<span class="op" id="3577287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3577290">case</span>&nbsp;<span class="op" id="3577295">*</span><span class="ident" id="3577296">Request</span><span class="op" id="3577303">:</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3577307">if</span>&nbsp;<span class="ident" id="3577310">rr</span><span class="op" id="3577312">.</span><span class="ident" id="3577313">ContentLength</span>&nbsp;<span class="op" id="3577327">!=</span>&nbsp;<span class="num" id="3577330">0</span>&nbsp;<span class="op" id="3577332">&amp;&amp;</span>&nbsp;<span class="ident" id="3577335">rr</span><span class="op" id="3577337">.</span><span class="ident" id="3577338">Body</span>&nbsp;<span class="op" id="3577343">==</span>&nbsp;<span class="ident" id="3577346">nil</span>&nbsp;<span class="op" id="3577350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3577355">return</span>&nbsp;<span class="ident" id="3577362">nil</span><span class="op" id="3577365">,</span>&nbsp;<span class="ident" id="3577367">fmt</span><span class="op" id="3577370">.</span><span class="ident" id="3577371">Errorf</span><span class="op" id="3577377">(</span><span class="string" id="3577378">&#34;http:&nbsp;Request.ContentLength=%d&nbsp;with&nbsp;nil&nbsp;Body&#34;</span><span class="op" id="3577424">,</span>&nbsp;<span class="ident" id="3577426">rr</span><span class="op" id="3577428">.</span><span class="ident" id="3577429">ContentLength</span><span class="op" id="3577442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3577446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3577450">t</span><span class="op" id="3577451">.</span><span class="ident" id="3577452">Method</span>&nbsp;<span class="op" id="3577459">=</span>&nbsp;<span class="ident" id="3577461">rr</span><span class="op" id="3577463">.</span><span class="ident" id="3577464">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3577473">t</span><span class="op" id="3577474">.</span><span class="ident" id="3577475">Body</span>&nbsp;<span class="op" id="3577480">=</span>&nbsp;<span class="ident" id="3577482">rr</span><span class="op" id="3577484">.</span><span class="ident" id="3577485">Body</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3577492">t</span><span class="op" id="3577493">.</span><span class="ident" id="3577494">BodyCloser</span>&nbsp;<span class="op" id="3577505">=</span>&nbsp;<span class="ident" id="3577507">rr</span><span class="op" id="3577509">.</span><span class="ident" id="3577510">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3577517">t</span><span class="op" id="3577518">.</span><span class="ident" id="3577519">ContentLength</span>&nbsp;<span class="op" id="3577533">=</span>&nbsp;<span class="ident" id="3577535">rr</span><span class="op" id="3577537">.</span><span class="ident" id="3577538">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3577554">t</span><span class="op" id="3577555">.</span><span class="ident" id="3577556">Close</span>&nbsp;<span class="op" id="3577562">=</span>&nbsp;<span class="ident" id="3577564">rr</span><span class="op" id="3577566">.</span><span class="ident" id="3577567">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3577575">t</span><span class="op" id="3577576">.</span><span class="ident" id="3577577">TransferEncoding</span>&nbsp;<span class="op" id="3577594">=</span>&nbsp;<span class="ident" id="3577596">rr</span><span class="op" id="3577598">.</span><span class="ident" id="3577599">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3577618">t</span><span class="op" id="3577619">.</span><span class="ident" id="3577620">Trailer</span>&nbsp;<span class="op" id="3577628">=</span>&nbsp;<span class="ident" id="3577630">rr</span><span class="op" id="3577632">.</span><span class="ident" id="3577633">Trailer</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3577643">atLeastHTTP11</span>&nbsp;<span class="op" id="3577657">=</span>&nbsp;<span class="ident" id="3577659">rr</span><span class="op" id="3577661">.</span><span class="ident" id="3577662">ProtoAtLeast</span><span class="op" id="3577674">(</span><span class="num" id="3577675">1</span><span class="op" id="3577676">,</span>&nbsp;<span class="num" id="3577678">1</span><span class="op" id="3577679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3577683">if</span>&nbsp;<span class="ident" id="3577686">t</span><span class="op" id="3577687">.</span><span class="ident" id="3577688">Body</span>&nbsp;<span class="op" id="3577693">!=</span>&nbsp;<span class="ident" id="3577696">nil</span>&nbsp;<span class="op" id="3577700">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3577703">len</span><span class="op" id="3577706">(</span><span class="ident" id="3577707">t</span><span class="op" id="3577708">.</span><span class="ident" id="3577709">TransferEncoding</span><span class="op" id="3577725">)</span>&nbsp;<span class="op" id="3577727">==</span>&nbsp;<span class="num" id="3577730">0</span>&nbsp;<span class="op" id="3577732">&amp;&amp;</span>&nbsp;<span class="ident" id="3577735">atLeastHTTP11</span>&nbsp;<span class="op" id="3577749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3577754">if</span>&nbsp;<span class="ident" id="3577757">t</span><span class="op" id="3577758">.</span><span class="ident" id="3577759">ContentLength</span>&nbsp;<span class="op" id="3577773">==</span>&nbsp;<span class="num" id="3577776">0</span>&nbsp;<span class="op" id="3577778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3577784">//&nbsp;Test&nbsp;to&nbsp;see&nbsp;if&nbsp;it&#39;s&nbsp;actually&nbsp;zero&nbsp;or&nbsp;just&nbsp;unset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3577840">var</span>&nbsp;<span class="ident" id="3577844">buf</span>&nbsp;<span class="op" id="3577848">[</span><span class="num" id="3577849">1</span><span class="op" id="3577850">]</span><span class="builtintype" id="3577851">byte</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3577860">n</span><span class="op" id="3577861">,</span>&nbsp;<span class="ident" id="3577863">rerr</span>&nbsp;<span class="op" id="3577868">:=</span>&nbsp;<span class="ident" id="3577871">io</span><span class="op" id="3577873">.</span><span class="ident" id="3577874">ReadFull</span><span class="op" id="3577882">(</span><span class="ident" id="3577883">t</span><span class="op" id="3577884">.</span><span class="ident" id="3577885">Body</span><span class="op" id="3577889">,</span>&nbsp;<span class="ident" id="3577891">buf</span><span class="op" id="3577894">[</span><span class="op" id="3577895">:</span><span class="op" id="3577896">]</span><span class="op" id="3577897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3577903">if</span>&nbsp;<span class="ident" id="3577906">rerr</span>&nbsp;<span class="op" id="3577911">!=</span>&nbsp;<span class="ident" id="3577914">nil</span>&nbsp;<span class="op" id="3577918">&amp;&amp;</span>&nbsp;<span class="ident" id="3577921">rerr</span>&nbsp;<span class="op" id="3577926">!=</span>&nbsp;<span class="ident" id="3577929">io</span><span class="op" id="3577931">.</span><span class="ident" id="3577932">EOF</span>&nbsp;<span class="op" id="3577936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3577943">t</span><span class="op" id="3577944">.</span><span class="ident" id="3577945">ContentLength</span>&nbsp;<span class="op" id="3577959">=</span>&nbsp;<span class="op" id="3577961">-</span><span class="num" id="3577962">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3577969">t</span><span class="op" id="3577970">.</span><span class="ident" id="3577971">Body</span>&nbsp;<span class="op" id="3577976">=</span>&nbsp;<span class="op" id="3577978">&amp;</span><span class="ident" id="3577979">errorReader</span><span class="op" id="3577990">{</span><span class="ident" id="3577991">rerr</span><span class="op" id="3577995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3578001">}</span>&nbsp;<span class="keyword" id="3578003">else</span>&nbsp;<span class="keyword" id="3578008">if</span>&nbsp;<span class="ident" id="3578011">n</span>&nbsp;<span class="op" id="3578013">==</span>&nbsp;<span class="num" id="3578016">1</span>&nbsp;<span class="op" id="3578018">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3578025">//&nbsp;Oh,&nbsp;guess&nbsp;there&nbsp;is&nbsp;data&nbsp;in&nbsp;this&nbsp;Body&nbsp;Reader&nbsp;after&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3578088">//&nbsp;The&nbsp;ContentLength&nbsp;field&nbsp;just&nbsp;wasn&#39;t&nbsp;set.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3578137">//&nbsp;Stich&nbsp;the&nbsp;Body&nbsp;back&nbsp;together&nbsp;again,&nbsp;re-attaching&nbsp;our</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3578198">//&nbsp;consumed&nbsp;byte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3578221">t</span><span class="op" id="3578222">.</span><span class="ident" id="3578223">ContentLength</span>&nbsp;<span class="op" id="3578237">=</span>&nbsp;<span class="op" id="3578239">-</span><span class="num" id="3578240">1</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3578247">t</span><span class="op" id="3578248">.</span><span class="ident" id="3578249">Body</span>&nbsp;<span class="op" id="3578254">=</span>&nbsp;<span class="ident" id="3578256">io</span><span class="op" id="3578258">.</span><span class="ident" id="3578259">MultiReader</span><span class="op" id="3578270">(</span><span class="ident" id="3578271">bytes</span><span class="op" id="3578276">.</span><span class="ident" id="3578277">NewReader</span><span class="op" id="3578286">(</span><span class="ident" id="3578287">buf</span><span class="op" id="3578290">[</span><span class="op" id="3578291">:</span><span class="op" id="3578292">]</span><span class="op" id="3578293">)</span><span class="op" id="3578294">,</span>&nbsp;<span class="ident" id="3578296">t</span><span class="op" id="3578297">.</span><span class="ident" id="3578298">Body</span><span class="op" id="3578302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3578308">}</span>&nbsp;<span class="keyword" id="3578310">else</span>&nbsp;<span class="op" id="3578315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3578322">//&nbsp;Body&nbsp;is&nbsp;actually&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3578354">t</span><span class="op" id="3578355">.</span><span class="ident" id="3578356">Body</span>&nbsp;<span class="op" id="3578361">=</span>&nbsp;<span class="ident" id="3578363">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3578372">t</span><span class="op" id="3578373">.</span><span class="ident" id="3578374">BodyCloser</span>&nbsp;<span class="op" id="3578385">=</span>&nbsp;<span class="ident" id="3578387">nil</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3578395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3578400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3578405">if</span>&nbsp;<span class="ident" id="3578408">t</span><span class="op" id="3578409">.</span><span class="ident" id="3578410">ContentLength</span>&nbsp;<span class="op" id="3578424">&lt;</span>&nbsp;<span class="num" id="3578426">0</span>&nbsp;<span class="op" id="3578428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3578434">t</span><span class="op" id="3578435">.</span><span class="ident" id="3578436">TransferEncoding</span>&nbsp;<span class="op" id="3578453">=</span>&nbsp;<span class="op" id="3578455">[</span><span class="op" id="3578456">]</span><span class="builtintype" id="3578457">string</span><span class="op" id="3578463">{</span><span class="string" id="3578464">&#34;chunked&#34;</span><span class="op" id="3578473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3578478">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3578482">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3578485">case</span>&nbsp;<span class="op" id="3578490">*</span><span class="ident" id="3578491">Response</span><span class="op" id="3578499">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3578503">if</span>&nbsp;<span class="ident" id="3578506">rr</span><span class="op" id="3578508">.</span><span class="ident" id="3578509">Request</span>&nbsp;<span class="op" id="3578517">!=</span>&nbsp;<span class="ident" id="3578520">nil</span>&nbsp;<span class="op" id="3578524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3578529">t</span><span class="op" id="3578530">.</span><span class="ident" id="3578531">Method</span>&nbsp;<span class="op" id="3578538">=</span>&nbsp;<span class="ident" id="3578540">rr</span><span class="op" id="3578542">.</span><span class="ident" id="3578543">Request</span><span class="op" id="3578550">.</span><span class="ident" id="3578551">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3578560">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3578564">t</span><span class="op" id="3578565">.</span><span class="ident" id="3578566">Body</span>&nbsp;<span class="op" id="3578571">=</span>&nbsp;<span class="ident" id="3578573">rr</span><span class="op" id="3578575">.</span><span class="ident" id="3578576">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3578583">t</span><span class="op" id="3578584">.</span><span class="ident" id="3578585">BodyCloser</span>&nbsp;<span class="op" id="3578596">=</span>&nbsp;<span class="ident" id="3578598">rr</span><span class="op" id="3578600">.</span><span class="ident" id="3578601">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3578608">t</span><span class="op" id="3578609">.</span><span class="ident" id="3578610">ContentLength</span>&nbsp;<span class="op" id="3578624">=</span>&nbsp;<span class="ident" id="3578626">rr</span><span class="op" id="3578628">.</span><span class="ident" id="3578629">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3578645">t</span><span class="op" id="3578646">.</span><span class="ident" id="3578647">Close</span>&nbsp;<span class="op" id="3578653">=</span>&nbsp;<span class="ident" id="3578655">rr</span><span class="op" id="3578657">.</span><span class="ident" id="3578658">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3578666">t</span><span class="op" id="3578667">.</span><span class="ident" id="3578668">TransferEncoding</span>&nbsp;<span class="op" id="3578685">=</span>&nbsp;<span class="ident" id="3578687">rr</span><span class="op" id="3578689">.</span><span class="ident" id="3578690">TransferEncoding</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3578709">t</span><span class="op" id="3578710">.</span><span class="ident" id="3578711">Trailer</span>&nbsp;<span class="op" id="3578719">=</span>&nbsp;<span class="ident" id="3578721">rr</span><span class="op" id="3578723">.</span><span class="ident" id="3578724">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3578734">atLeastHTTP11</span>&nbsp;<span class="op" id="3578748">=</span>&nbsp;<span class="ident" id="3578750">rr</span><span class="op" id="3578752">.</span><span class="ident" id="3578753">ProtoAtLeast</span><span class="op" id="3578765">(</span><span class="num" id="3578766">1</span><span class="op" id="3578767">,</span>&nbsp;<span class="num" id="3578769">1</span><span class="op" id="3578770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3578774">t</span><span class="op" id="3578775">.</span><span class="ident" id="3578776">ResponseToHEAD</span>&nbsp;<span class="op" id="3578791">=</span>&nbsp;<span class="ident" id="3578793">noBodyExpected</span><span class="op" id="3578807">(</span><span class="ident" id="3578808">t</span><span class="op" id="3578809">.</span><span class="ident" id="3578810">Method</span><span class="op" id="3578816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3578819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3578823">//&nbsp;Sanitize&nbsp;Body,ContentLength,TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3578872">if</span>&nbsp;<span class="ident" id="3578875">t</span><span class="op" id="3578876">.</span><span class="ident" id="3578877">ResponseToHEAD</span>&nbsp;<span class="op" id="3578892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3578896">t</span><span class="op" id="3578897">.</span><span class="ident" id="3578898">Body</span>&nbsp;<span class="op" id="3578903">=</span>&nbsp;<span class="ident" id="3578905">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3578911">if</span>&nbsp;<span class="ident" id="3578914">chunked</span><span class="op" id="3578921">(</span><span class="ident" id="3578922">t</span><span class="op" id="3578923">.</span><span class="ident" id="3578924">TransferEncoding</span><span class="op" id="3578940">)</span>&nbsp;<span class="op" id="3578942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3578947">t</span><span class="op" id="3578948">.</span><span class="ident" id="3578949">ContentLength</span>&nbsp;<span class="op" id="3578963">=</span>&nbsp;<span class="op" id="3578965">-</span><span class="num" id="3578966">1</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3578970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3578973">}</span>&nbsp;<span class="keyword" id="3578975">else</span>&nbsp;<span class="op" id="3578980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3578984">if</span>&nbsp;<span class="op" id="3578987">!</span><span class="ident" id="3578988">atLeastHTTP11</span>&nbsp;<span class="op" id="3579002">||</span>&nbsp;<span class="ident" id="3579005">t</span><span class="op" id="3579006">.</span><span class="ident" id="3579007">Body</span>&nbsp;<span class="op" id="3579012">==</span>&nbsp;<span class="ident" id="3579015">nil</span>&nbsp;<span class="op" id="3579019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3579024">t</span><span class="op" id="3579025">.</span><span class="ident" id="3579026">TransferEncoding</span>&nbsp;<span class="op" id="3579043">=</span>&nbsp;<span class="ident" id="3579045">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3579051">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3579055">if</span>&nbsp;<span class="ident" id="3579058">chunked</span><span class="op" id="3579065">(</span><span class="ident" id="3579066">t</span><span class="op" id="3579067">.</span><span class="ident" id="3579068">TransferEncoding</span><span class="op" id="3579084">)</span>&nbsp;<span class="op" id="3579086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3579091">t</span><span class="op" id="3579092">.</span><span class="ident" id="3579093">ContentLength</span>&nbsp;<span class="op" id="3579107">=</span>&nbsp;<span class="op" id="3579109">-</span><span class="num" id="3579110">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3579114">}</span>&nbsp;<span class="keyword" id="3579116">else</span>&nbsp;<span class="keyword" id="3579121">if</span>&nbsp;<span class="ident" id="3579124">t</span><span class="op" id="3579125">.</span><span class="ident" id="3579126">Body</span>&nbsp;<span class="op" id="3579131">==</span>&nbsp;<span class="ident" id="3579134">nil</span>&nbsp;<span class="op" id="3579138">{</span>&nbsp;<span class="comment" id="3579140">//&nbsp;no&nbsp;chunking,&nbsp;no&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3579167">t</span><span class="op" id="3579168">.</span><span class="ident" id="3579169">ContentLength</span>&nbsp;<span class="op" id="3579183">=</span>&nbsp;<span class="num" id="3579185">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3579189">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3579192">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3579196">//&nbsp;Sanitize&nbsp;Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3579217">if</span>&nbsp;<span class="op" id="3579220">!</span><span class="ident" id="3579221">chunked</span><span class="op" id="3579228">(</span><span class="ident" id="3579229">t</span><span class="op" id="3579230">.</span><span class="ident" id="3579231">TransferEncoding</span><span class="op" id="3579247">)</span>&nbsp;<span class="op" id="3579249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3579253">t</span><span class="op" id="3579254">.</span><span class="ident" id="3579255">Trailer</span>&nbsp;<span class="op" id="3579263">=</span>&nbsp;<span class="ident" id="3579265">nil</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3579270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3579274">return</span>&nbsp;<span class="ident" id="3579281">t</span><span class="op" id="3579282">,</span>&nbsp;<span class="ident" id="3579284">nil</span><br>
<span class="lineno"></span><span class="op" id="3579288">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="3579291">func</span>&nbsp;<span class="ident" id="3579296">noBodyExpected</span><span class="op" id="3579310">(</span><span class="ident" id="3579311">requestMethod</span>&nbsp;<span class="builtintype" id="3579325">string</span><span class="op" id="3579331">)</span>&nbsp;<span class="builtintype" id="3579333">bool</span>&nbsp;<span class="op" id="3579338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3579341">return</span>&nbsp;<span class="ident" id="3579348">requestMethod</span>&nbsp;<span class="op" id="3579362">==</span>&nbsp;<span class="string" id="3579365">&#34;HEAD&#34;</span><br>
<span class="lineno"></span><span class="op" id="3579372">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3579375">func</span>&nbsp;<span class="op" id="3579380">(</span><span class="ident" id="3579381">t</span>&nbsp;<span class="op" id="3579383">*</span><span class="ident" id="3579384">transferWriter</span><span class="op" id="3579398">)</span>&nbsp;<span class="ident" id="3579400">shouldSendContentLength</span><span class="op" id="3579423">(</span><span class="op" id="3579424">)</span>&nbsp;<span class="builtintype" id="3579426">bool</span>&nbsp;<span class="op" id="3579431">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3579434">if</span>&nbsp;<span class="ident" id="3579437">chunked</span><span class="op" id="3579444">(</span><span class="ident" id="3579445">t</span><span class="op" id="3579446">.</span><span class="ident" id="3579447">TransferEncoding</span><span class="op" id="3579463">)</span>&nbsp;<span class="op" id="3579465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3579469">return</span>&nbsp;<span class="builtintype" id="3579476">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3579483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3579486">if</span>&nbsp;<span class="ident" id="3579489">t</span><span class="op" id="3579490">.</span><span class="ident" id="3579491">ContentLength</span>&nbsp;<span class="op" id="3579505">&gt;</span>&nbsp;<span class="num" id="3579507">0</span>&nbsp;<span class="op" id="3579509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3579513">return</span>&nbsp;<span class="builtintype" id="3579520">true</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3579526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3579529">//&nbsp;Many&nbsp;servers&nbsp;expect&nbsp;a&nbsp;Content-Length&nbsp;for&nbsp;these&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3579588">if</span>&nbsp;<span class="ident" id="3579591">t</span><span class="op" id="3579592">.</span><span class="ident" id="3579593">Method</span>&nbsp;<span class="op" id="3579600">==</span>&nbsp;<span class="string" id="3579603">&#34;POST&#34;</span>&nbsp;<span class="op" id="3579610">||</span>&nbsp;<span class="ident" id="3579613">t</span><span class="op" id="3579614">.</span><span class="ident" id="3579615">Method</span>&nbsp;<span class="op" id="3579622">==</span>&nbsp;<span class="string" id="3579625">&#34;PUT&#34;</span>&nbsp;<span class="op" id="3579631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3579635">return</span>&nbsp;<span class="builtintype" id="3579642">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3579648">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3579651">if</span>&nbsp;<span class="ident" id="3579654">t</span><span class="op" id="3579655">.</span><span class="ident" id="3579656">ContentLength</span>&nbsp;<span class="op" id="3579670">==</span>&nbsp;<span class="num" id="3579673">0</span>&nbsp;<span class="op" id="3579675">&amp;&amp;</span>&nbsp;<span class="ident" id="3579678">isIdentity</span><span class="op" id="3579688">(</span><span class="ident" id="3579689">t</span><span class="op" id="3579690">.</span><span class="ident" id="3579691">TransferEncoding</span><span class="op" id="3579707">)</span>&nbsp;<span class="op" id="3579709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3579713">return</span>&nbsp;<span class="builtintype" id="3579720">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3579726">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3579730">return</span>&nbsp;<span class="builtintype" id="3579737">false</span><br>
<span class="lineno">150</span><span class="op" id="3579743">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3579746">func</span>&nbsp;<span class="op" id="3579751">(</span><span class="ident" id="3579752">t</span>&nbsp;<span class="op" id="3579754">*</span><span class="ident" id="3579755">transferWriter</span><span class="op" id="3579769">)</span>&nbsp;<span class="ident" id="3579771">WriteHeader</span><span class="op" id="3579782">(</span><span class="ident" id="3579783">w</span>&nbsp;<span class="ident" id="3579785">io</span><span class="op" id="3579787">.</span><span class="ident" id="3579788">Writer</span><span class="op" id="3579794">)</span>&nbsp;<span class="builtintype" id="3579796">error</span>&nbsp;<span class="op" id="3579802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3579805">if</span>&nbsp;<span class="ident" id="3579808">t</span><span class="op" id="3579809">.</span><span class="ident" id="3579810">Close</span>&nbsp;<span class="op" id="3579816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3579820">if</span>&nbsp;<span class="ident" id="3579823">_</span><span class="op" id="3579824">,</span>&nbsp;<span class="ident" id="3579826">err</span>&nbsp;<span class="op" id="3579830">:=</span>&nbsp;<span class="ident" id="3579833">io</span><span class="op" id="3579835">.</span><span class="ident" id="3579836">WriteString</span><span class="op" id="3579847">(</span><span class="ident" id="3579848">w</span><span class="op" id="3579849">,</span>&nbsp;<span class="string" id="3579851">&#34;Connection:&nbsp;close\r\n&#34;</span><span class="op" id="3579874">)</span><span class="op" id="3579875">;</span>&nbsp;<span class="ident" id="3579877">err</span>&nbsp;<span class="op" id="3579881">!=</span>&nbsp;<span class="ident" id="3579884">nil</span>&nbsp;<span class="op" id="3579888">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3579893">return</span>&nbsp;<span class="ident" id="3579900">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3579906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3579909">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3579913">//&nbsp;Write&nbsp;Content-Length&nbsp;and/or&nbsp;Transfer-Encoding&nbsp;whose&nbsp;values&nbsp;are&nbsp;a</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3579982">//&nbsp;function&nbsp;of&nbsp;the&nbsp;sanitized&nbsp;field&nbsp;triple&nbsp;(Body,&nbsp;ContentLength,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3580047">//&nbsp;TransferEncoding)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3580069">if</span>&nbsp;<span class="ident" id="3580072">t</span><span class="op" id="3580073">.</span><span class="ident" id="3580074">shouldSendContentLength</span><span class="op" id="3580097">(</span><span class="op" id="3580098">)</span>&nbsp;<span class="op" id="3580100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3580104">if</span>&nbsp;<span class="ident" id="3580107">_</span><span class="op" id="3580108">,</span>&nbsp;<span class="ident" id="3580110">err</span>&nbsp;<span class="op" id="3580114">:=</span>&nbsp;<span class="ident" id="3580117">io</span><span class="op" id="3580119">.</span><span class="ident" id="3580120">WriteString</span><span class="op" id="3580131">(</span><span class="ident" id="3580132">w</span><span class="op" id="3580133">,</span>&nbsp;<span class="string" id="3580135">&#34;Content-Length:&nbsp;&#34;</span><span class="op" id="3580153">)</span><span class="op" id="3580154">;</span>&nbsp;<span class="ident" id="3580156">err</span>&nbsp;<span class="op" id="3580160">!=</span>&nbsp;<span class="ident" id="3580163">nil</span>&nbsp;<span class="op" id="3580167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3580172">return</span>&nbsp;<span class="ident" id="3580179">err</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3580185">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3580189">if</span>&nbsp;<span class="ident" id="3580192">_</span><span class="op" id="3580193">,</span>&nbsp;<span class="ident" id="3580195">err</span>&nbsp;<span class="op" id="3580199">:=</span>&nbsp;<span class="ident" id="3580202">io</span><span class="op" id="3580204">.</span><span class="ident" id="3580205">WriteString</span><span class="op" id="3580216">(</span><span class="ident" id="3580217">w</span><span class="op" id="3580218">,</span>&nbsp;<span class="ident" id="3580220">strconv</span><span class="op" id="3580227">.</span><span class="ident" id="3580228">FormatInt</span><span class="op" id="3580237">(</span><span class="ident" id="3580238">t</span><span class="op" id="3580239">.</span><span class="ident" id="3580240">ContentLength</span><span class="op" id="3580253">,</span>&nbsp;<span class="num" id="3580255">10</span><span class="op" id="3580257">)</span><span class="op" id="3580258">+</span><span class="string" id="3580259">&#34;\r\n&#34;</span><span class="op" id="3580265">)</span><span class="op" id="3580266">;</span>&nbsp;<span class="ident" id="3580268">err</span>&nbsp;<span class="op" id="3580272">!=</span>&nbsp;<span class="ident" id="3580275">nil</span>&nbsp;<span class="op" id="3580279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3580284">return</span>&nbsp;<span class="ident" id="3580291">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3580297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3580300">}</span>&nbsp;<span class="keyword" id="3580302">else</span>&nbsp;<span class="keyword" id="3580307">if</span>&nbsp;<span class="ident" id="3580310">chunked</span><span class="op" id="3580317">(</span><span class="ident" id="3580318">t</span><span class="op" id="3580319">.</span><span class="ident" id="3580320">TransferEncoding</span><span class="op" id="3580336">)</span>&nbsp;<span class="op" id="3580338">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3580342">if</span>&nbsp;<span class="ident" id="3580345">_</span><span class="op" id="3580346">,</span>&nbsp;<span class="ident" id="3580348">err</span>&nbsp;<span class="op" id="3580352">:=</span>&nbsp;<span class="ident" id="3580355">io</span><span class="op" id="3580357">.</span><span class="ident" id="3580358">WriteString</span><span class="op" id="3580369">(</span><span class="ident" id="3580370">w</span><span class="op" id="3580371">,</span>&nbsp;<span class="string" id="3580373">&#34;Transfer-Encoding:&nbsp;chunked\r\n&#34;</span><span class="op" id="3580405">)</span><span class="op" id="3580406">;</span>&nbsp;<span class="ident" id="3580408">err</span>&nbsp;<span class="op" id="3580412">!=</span>&nbsp;<span class="ident" id="3580415">nil</span>&nbsp;<span class="op" id="3580419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3580424">return</span>&nbsp;<span class="ident" id="3580431">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3580437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3580440">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3580444">//&nbsp;Write&nbsp;Trailer&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3580469">if</span>&nbsp;<span class="ident" id="3580472">t</span><span class="op" id="3580473">.</span><span class="ident" id="3580474">Trailer</span>&nbsp;<span class="op" id="3580482">!=</span>&nbsp;<span class="ident" id="3580485">nil</span>&nbsp;<span class="op" id="3580489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3580493">keys</span>&nbsp;<span class="op" id="3580498">:=</span>&nbsp;<span class="builtinfunc" id="3580501">make</span><span class="op" id="3580505">(</span><span class="op" id="3580506">[</span><span class="op" id="3580507">]</span><span class="builtintype" id="3580508">string</span><span class="op" id="3580514">,</span>&nbsp;<span class="num" id="3580516">0</span><span class="op" id="3580517">,</span>&nbsp;<span class="builtinfunc" id="3580519">len</span><span class="op" id="3580522">(</span><span class="ident" id="3580523">t</span><span class="op" id="3580524">.</span><span class="ident" id="3580525">Trailer</span><span class="op" id="3580532">)</span><span class="op" id="3580533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3580537">for</span>&nbsp;<span class="ident" id="3580541">k</span>&nbsp;<span class="op" id="3580543">:=</span>&nbsp;<span class="keyword" id="3580546">range</span>&nbsp;<span class="ident" id="3580552">t</span><span class="op" id="3580553">.</span><span class="ident" id="3580554">Trailer</span>&nbsp;<span class="op" id="3580562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3580567">k</span>&nbsp;<span class="op" id="3580569">=</span>&nbsp;<span class="ident" id="3580571">CanonicalHeaderKey</span><span class="op" id="3580589">(</span><span class="ident" id="3580590">k</span><span class="op" id="3580591">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3580596">switch</span>&nbsp;<span class="ident" id="3580603">k</span>&nbsp;<span class="op" id="3580605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3580610">case</span>&nbsp;<span class="string" id="3580615">&#34;Transfer-Encoding&#34;</span><span class="op" id="3580634">,</span>&nbsp;<span class="string" id="3580636">&#34;Trailer&#34;</span><span class="op" id="3580645">,</span>&nbsp;<span class="string" id="3580647">&#34;Content-Length&#34;</span><span class="op" id="3580663">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3580669">return</span>&nbsp;<span class="op" id="3580676">&amp;</span><span class="ident" id="3580677">badStringError</span><span class="op" id="3580691">{</span><span class="string" id="3580692">&#34;invalid&nbsp;Trailer&nbsp;key&#34;</span><span class="op" id="3580713">,</span>&nbsp;<span class="ident" id="3580715">k</span><span class="op" id="3580716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3580721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3580726">keys</span>&nbsp;<span class="op" id="3580731">=</span>&nbsp;<span class="builtinfunc" id="3580733">append</span><span class="op" id="3580739">(</span><span class="ident" id="3580740">keys</span><span class="op" id="3580744">,</span>&nbsp;<span class="ident" id="3580746">k</span><span class="op" id="3580747">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3580751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3580755">if</span>&nbsp;<span class="builtinfunc" id="3580758">len</span><span class="op" id="3580761">(</span><span class="ident" id="3580762">keys</span><span class="op" id="3580766">)</span>&nbsp;<span class="op" id="3580768">&gt;</span>&nbsp;<span class="num" id="3580770">0</span>&nbsp;<span class="op" id="3580772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3580777">sort</span><span class="op" id="3580781">.</span><span class="ident" id="3580782">Strings</span><span class="op" id="3580789">(</span><span class="ident" id="3580790">keys</span><span class="op" id="3580794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3580799">//&nbsp;TODO:&nbsp;could&nbsp;do&nbsp;better&nbsp;allocation-wise&nbsp;here,&nbsp;but&nbsp;trailers&nbsp;are&nbsp;rare,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3580872">//&nbsp;so&nbsp;being&nbsp;lazy&nbsp;for&nbsp;now.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3580901">if</span>&nbsp;<span class="ident" id="3580904">_</span><span class="op" id="3580905">,</span>&nbsp;<span class="ident" id="3580907">err</span>&nbsp;<span class="op" id="3580911">:=</span>&nbsp;<span class="ident" id="3580914">io</span><span class="op" id="3580916">.</span><span class="ident" id="3580917">WriteString</span><span class="op" id="3580928">(</span><span class="ident" id="3580929">w</span><span class="op" id="3580930">,</span>&nbsp;<span class="string" id="3580932">&#34;Trailer:&nbsp;&#34;</span><span class="op" id="3580943">+</span><span class="ident" id="3580944">strings</span><span class="op" id="3580951">.</span><span class="ident" id="3580952">Join</span><span class="op" id="3580956">(</span><span class="ident" id="3580957">keys</span><span class="op" id="3580961">,</span>&nbsp;<span class="string" id="3580963">&#34;,&#34;</span><span class="op" id="3580966">)</span><span class="op" id="3580967">+</span><span class="string" id="3580968">&#34;\r\n&#34;</span><span class="op" id="3580974">)</span><span class="op" id="3580975">;</span>&nbsp;<span class="ident" id="3580977">err</span>&nbsp;<span class="op" id="3580981">!=</span>&nbsp;<span class="ident" id="3580984">nil</span>&nbsp;<span class="op" id="3580988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3580994">return</span>&nbsp;<span class="ident" id="3581001">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3581008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3581012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3581015">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3581019">return</span>&nbsp;<span class="ident" id="3581026">nil</span><br>
<span class="lineno"></span><span class="op" id="3581030">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3581033">func</span>&nbsp;<span class="op" id="3581038">(</span><span class="ident" id="3581039">t</span>&nbsp;<span class="op" id="3581041">*</span><span class="ident" id="3581042">transferWriter</span><span class="op" id="3581056">)</span>&nbsp;<span class="ident" id="3581058">WriteBody</span><span class="op" id="3581067">(</span><span class="ident" id="3581068">w</span>&nbsp;<span class="ident" id="3581070">io</span><span class="op" id="3581072">.</span><span class="ident" id="3581073">Writer</span><span class="op" id="3581079">)</span>&nbsp;<span class="builtintype" id="3581081">error</span>&nbsp;<span class="op" id="3581087">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3581090">var</span>&nbsp;<span class="ident" id="3581094">err</span>&nbsp;<span class="builtintype" id="3581098">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3581105">var</span>&nbsp;<span class="ident" id="3581109">ncopy</span>&nbsp;<span class="ident" id="3581115">int64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3581123">//&nbsp;Write&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3581138">if</span>&nbsp;<span class="ident" id="3581141">t</span><span class="op" id="3581142">.</span><span class="ident" id="3581143">Body</span>&nbsp;<span class="op" id="3581148">!=</span>&nbsp;<span class="ident" id="3581151">nil</span>&nbsp;<span class="op" id="3581155">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3581159">if</span>&nbsp;<span class="ident" id="3581162">chunked</span><span class="op" id="3581169">(</span><span class="ident" id="3581170">t</span><span class="op" id="3581171">.</span><span class="ident" id="3581172">TransferEncoding</span><span class="op" id="3581188">)</span>&nbsp;<span class="op" id="3581190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3581195">cw</span>&nbsp;<span class="op" id="3581198">:=</span>&nbsp;<span class="ident" id="3581201">internal</span><span class="op" id="3581209">.</span><span class="ident" id="3581210">NewChunkedWriter</span><span class="op" id="3581226">(</span><span class="ident" id="3581227">w</span><span class="op" id="3581228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3581233">_</span><span class="op" id="3581234">,</span>&nbsp;<span class="ident" id="3581236">err</span>&nbsp;<span class="op" id="3581240">=</span>&nbsp;<span class="ident" id="3581242">io</span><span class="op" id="3581244">.</span><span class="ident" id="3581245">Copy</span><span class="op" id="3581249">(</span><span class="ident" id="3581250">cw</span><span class="op" id="3581252">,</span>&nbsp;<span class="ident" id="3581254">t</span><span class="op" id="3581255">.</span><span class="ident" id="3581256">Body</span><span class="op" id="3581260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3581265">if</span>&nbsp;<span class="ident" id="3581268">err</span>&nbsp;<span class="op" id="3581272">==</span>&nbsp;<span class="ident" id="3581275">nil</span>&nbsp;<span class="op" id="3581279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3581285">err</span>&nbsp;<span class="op" id="3581289">=</span>&nbsp;<span class="ident" id="3581291">cw</span><span class="op" id="3581293">.</span><span class="ident" id="3581294">Close</span><span class="op" id="3581299">(</span><span class="op" id="3581300">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3581305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3581309">}</span>&nbsp;<span class="keyword" id="3581311">else</span>&nbsp;<span class="keyword" id="3581316">if</span>&nbsp;<span class="ident" id="3581319">t</span><span class="op" id="3581320">.</span><span class="ident" id="3581321">ContentLength</span>&nbsp;<span class="op" id="3581335">==</span>&nbsp;<span class="op" id="3581338">-</span><span class="num" id="3581339">1</span>&nbsp;<span class="op" id="3581341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3581346">ncopy</span><span class="op" id="3581351">,</span>&nbsp;<span class="ident" id="3581353">err</span>&nbsp;<span class="op" id="3581357">=</span>&nbsp;<span class="ident" id="3581359">io</span><span class="op" id="3581361">.</span><span class="ident" id="3581362">Copy</span><span class="op" id="3581366">(</span><span class="ident" id="3581367">w</span><span class="op" id="3581368">,</span>&nbsp;<span class="ident" id="3581370">t</span><span class="op" id="3581371">.</span><span class="ident" id="3581372">Body</span><span class="op" id="3581376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3581380">}</span>&nbsp;<span class="keyword" id="3581382">else</span>&nbsp;<span class="op" id="3581387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3581392">ncopy</span><span class="op" id="3581397">,</span>&nbsp;<span class="ident" id="3581399">err</span>&nbsp;<span class="op" id="3581403">=</span>&nbsp;<span class="ident" id="3581405">io</span><span class="op" id="3581407">.</span><span class="ident" id="3581408">Copy</span><span class="op" id="3581412">(</span><span class="ident" id="3581413">w</span><span class="op" id="3581414">,</span>&nbsp;<span class="ident" id="3581416">io</span><span class="op" id="3581418">.</span><span class="ident" id="3581419">LimitReader</span><span class="op" id="3581430">(</span><span class="ident" id="3581431">t</span><span class="op" id="3581432">.</span><span class="ident" id="3581433">Body</span><span class="op" id="3581437">,</span>&nbsp;<span class="ident" id="3581439">t</span><span class="op" id="3581440">.</span><span class="ident" id="3581441">ContentLength</span><span class="op" id="3581454">)</span><span class="op" id="3581455">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3581460">if</span>&nbsp;<span class="ident" id="3581463">err</span>&nbsp;<span class="op" id="3581467">!=</span>&nbsp;<span class="ident" id="3581470">nil</span>&nbsp;<span class="op" id="3581474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3581480">return</span>&nbsp;<span class="ident" id="3581487">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3581494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3581499">var</span>&nbsp;<span class="ident" id="3581503">nextra</span>&nbsp;<span class="ident" id="3581510">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3581519">nextra</span><span class="op" id="3581525">,</span>&nbsp;<span class="ident" id="3581527">err</span>&nbsp;<span class="op" id="3581531">=</span>&nbsp;<span class="ident" id="3581533">io</span><span class="op" id="3581535">.</span><span class="ident" id="3581536">Copy</span><span class="op" id="3581540">(</span><span class="ident" id="3581541">ioutil</span><span class="op" id="3581547">.</span><span class="ident" id="3581548">Discard</span><span class="op" id="3581555">,</span>&nbsp;<span class="ident" id="3581557">t</span><span class="op" id="3581558">.</span><span class="ident" id="3581559">Body</span><span class="op" id="3581563">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3581568">ncopy</span>&nbsp;<span class="op" id="3581574">+=</span>&nbsp;<span class="ident" id="3581577">nextra</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3581586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3581590">if</span>&nbsp;<span class="ident" id="3581593">err</span>&nbsp;<span class="op" id="3581597">!=</span>&nbsp;<span class="ident" id="3581600">nil</span>&nbsp;<span class="op" id="3581604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3581609">return</span>&nbsp;<span class="ident" id="3581616">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3581622">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3581626">if</span>&nbsp;<span class="ident" id="3581629">err</span>&nbsp;<span class="op" id="3581633">=</span>&nbsp;<span class="ident" id="3581635">t</span><span class="op" id="3581636">.</span><span class="ident" id="3581637">BodyCloser</span><span class="op" id="3581647">.</span><span class="ident" id="3581648">Close</span><span class="op" id="3581653">(</span><span class="op" id="3581654">)</span><span class="op" id="3581655">;</span>&nbsp;<span class="ident" id="3581657">err</span>&nbsp;<span class="op" id="3581661">!=</span>&nbsp;<span class="ident" id="3581664">nil</span>&nbsp;<span class="op" id="3581668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3581673">return</span>&nbsp;<span class="ident" id="3581680">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3581686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3581689">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3581693">if</span>&nbsp;<span class="op" id="3581696">!</span><span class="ident" id="3581697">t</span><span class="op" id="3581698">.</span><span class="ident" id="3581699">ResponseToHEAD</span>&nbsp;<span class="op" id="3581714">&amp;&amp;</span>&nbsp;<span class="ident" id="3581717">t</span><span class="op" id="3581718">.</span><span class="ident" id="3581719">ContentLength</span>&nbsp;<span class="op" id="3581733">!=</span>&nbsp;<span class="op" id="3581736">-</span><span class="num" id="3581737">1</span>&nbsp;<span class="op" id="3581739">&amp;&amp;</span>&nbsp;<span class="ident" id="3581742">t</span><span class="op" id="3581743">.</span><span class="ident" id="3581744">ContentLength</span>&nbsp;<span class="op" id="3581758">!=</span>&nbsp;<span class="ident" id="3581761">ncopy</span>&nbsp;<span class="op" id="3581767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3581771">return</span>&nbsp;<span class="ident" id="3581778">fmt</span><span class="op" id="3581781">.</span><span class="ident" id="3581782">Errorf</span><span class="op" id="3581788">(</span><span class="string" id="3581789">&#34;http:&nbsp;ContentLength=%d&nbsp;with&nbsp;Body&nbsp;length&nbsp;%d&#34;</span><span class="op" id="3581833">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3581838">t</span><span class="op" id="3581839">.</span><span class="ident" id="3581840">ContentLength</span><span class="op" id="3581853">,</span>&nbsp;<span class="ident" id="3581855">ncopy</span><span class="op" id="3581860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3581863">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3581867">//&nbsp;TODO(petar):&nbsp;Place&nbsp;trailer&nbsp;writer&nbsp;code&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3581916">if</span>&nbsp;<span class="ident" id="3581919">chunked</span><span class="op" id="3581926">(</span><span class="ident" id="3581927">t</span><span class="op" id="3581928">.</span><span class="ident" id="3581929">TransferEncoding</span><span class="op" id="3581945">)</span>&nbsp;<span class="op" id="3581947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3581951">//&nbsp;Write&nbsp;Trailer&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3581977">if</span>&nbsp;<span class="ident" id="3581980">t</span><span class="op" id="3581981">.</span><span class="ident" id="3581982">Trailer</span>&nbsp;<span class="op" id="3581990">!=</span>&nbsp;<span class="ident" id="3581993">nil</span>&nbsp;<span class="op" id="3581997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3582002">if</span>&nbsp;<span class="ident" id="3582005">err</span>&nbsp;<span class="op" id="3582009">:=</span>&nbsp;<span class="ident" id="3582012">t</span><span class="op" id="3582013">.</span><span class="ident" id="3582014">Trailer</span><span class="op" id="3582021">.</span><span class="ident" id="3582022">Write</span><span class="op" id="3582027">(</span><span class="ident" id="3582028">w</span><span class="op" id="3582029">)</span><span class="op" id="3582030">;</span>&nbsp;<span class="ident" id="3582032">err</span>&nbsp;<span class="op" id="3582036">!=</span>&nbsp;<span class="ident" id="3582039">nil</span>&nbsp;<span class="op" id="3582043">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3582049">return</span>&nbsp;<span class="ident" id="3582056">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3582063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3582067">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3582071">//&nbsp;Last&nbsp;chunk,&nbsp;empty&nbsp;trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3582102">_</span><span class="op" id="3582103">,</span>&nbsp;<span class="ident" id="3582105">err</span>&nbsp;<span class="op" id="3582109">=</span>&nbsp;<span class="ident" id="3582111">io</span><span class="op" id="3582113">.</span><span class="ident" id="3582114">WriteString</span><span class="op" id="3582125">(</span><span class="ident" id="3582126">w</span><span class="op" id="3582127">,</span>&nbsp;<span class="string" id="3582129">&#34;\r\n&#34;</span><span class="op" id="3582135">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3582138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3582141">return</span>&nbsp;<span class="ident" id="3582148">err</span><br>
<span class="lineno"></span><span class="op" id="3582152">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3582155">type</span>&nbsp;<span class="ident" id="3582160">transferReader</span>&nbsp;<span class="keyword" id="3582175">struct</span>&nbsp;<span class="op" id="3582182">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3582185">//&nbsp;Input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3582195">Header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3582209">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3582217">StatusCode</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3582231">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3582236">RequestMethod</span>&nbsp;<span class="builtintype" id="3582250">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3582258">ProtoMajor</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3582272">int</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3582277">ProtoMinor</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3582291">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3582296">//&nbsp;Output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3582307">Body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3582324">io</span><span class="op" id="3582326">.</span><span class="ident" id="3582327">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3582339">ContentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3582356">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3582363">TransferEncoding</span>&nbsp;<span class="op" id="3582380">[</span><span class="op" id="3582381">]</span><span class="builtintype" id="3582382">string</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3582390">Close</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3582407">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3582413">Trailer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3582430">Header</span><br>
<span class="lineno"></span><span class="op" id="3582437">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3582440">//&nbsp;bodyAllowedForStatus&nbsp;reports&nbsp;whether&nbsp;a&nbsp;given&nbsp;response&nbsp;status&nbsp;code</span><br>
<span class="lineno">265</span><span class="comment" id="3582509">//&nbsp;permits&nbsp;a&nbsp;body.&nbsp;&nbsp;See&nbsp;RFC2616,&nbsp;section&nbsp;4.4.</span><br>
<span class="lineno"></span><span class="keyword" id="3582555">func</span>&nbsp;<span class="ident" id="3582560">bodyAllowedForStatus</span><span class="op" id="3582580">(</span><span class="ident" id="3582581">status</span>&nbsp;<span class="builtintype" id="3582588">int</span><span class="op" id="3582591">)</span>&nbsp;<span class="builtintype" id="3582593">bool</span>&nbsp;<span class="op" id="3582598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3582601">switch</span>&nbsp;<span class="op" id="3582608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3582611">case</span>&nbsp;<span class="ident" id="3582616">status</span>&nbsp;<span class="op" id="3582623">&gt;=</span>&nbsp;<span class="num" id="3582626">100</span>&nbsp;<span class="op" id="3582630">&amp;&amp;</span>&nbsp;<span class="ident" id="3582633">status</span>&nbsp;<span class="op" id="3582640">&lt;=</span>&nbsp;<span class="num" id="3582643">199</span><span class="op" id="3582646">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3582650">return</span>&nbsp;<span class="builtintype" id="3582657">false</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3582664">case</span>&nbsp;<span class="ident" id="3582669">status</span>&nbsp;<span class="op" id="3582676">==</span>&nbsp;<span class="num" id="3582679">204</span><span class="op" id="3582682">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3582686">return</span>&nbsp;<span class="builtintype" id="3582693">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3582700">case</span>&nbsp;<span class="ident" id="3582705">status</span>&nbsp;<span class="op" id="3582712">==</span>&nbsp;<span class="num" id="3582715">304</span><span class="op" id="3582718">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3582722">return</span>&nbsp;<span class="builtintype" id="3582729">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3582736">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3582739">return</span>&nbsp;<span class="builtintype" id="3582746">true</span><br>
<span class="lineno"></span><span class="op" id="3582751">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3582754">var</span>&nbsp;<span class="op" id="3582758">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3582761">suppressedHeaders304</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3582785">=</span>&nbsp;<span class="op" id="3582787">[</span><span class="op" id="3582788">]</span><span class="builtintype" id="3582789">string</span><span class="op" id="3582795">{</span><span class="string" id="3582796">&#34;Content-Type&#34;</span><span class="op" id="3582810">,</span>&nbsp;<span class="string" id="3582812">&#34;Content-Length&#34;</span><span class="op" id="3582828">,</span>&nbsp;<span class="string" id="3582830">&#34;Transfer-Encoding&#34;</span><span class="op" id="3582849">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3582852">suppressedHeadersNoBody</span>&nbsp;<span class="op" id="3582876">=</span>&nbsp;<span class="op" id="3582878">[</span><span class="op" id="3582879">]</span><span class="builtintype" id="3582880">string</span><span class="op" id="3582886">{</span><span class="string" id="3582887">&#34;Content-Length&#34;</span><span class="op" id="3582903">,</span>&nbsp;<span class="string" id="3582905">&#34;Transfer-Encoding&#34;</span><span class="op" id="3582924">}</span><br>
<span class="lineno"></span><span class="op" id="3582926">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3582929">func</span>&nbsp;<span class="ident" id="3582934">suppressedHeaders</span><span class="op" id="3582951">(</span><span class="ident" id="3582952">status</span>&nbsp;<span class="builtintype" id="3582959">int</span><span class="op" id="3582962">)</span>&nbsp;<span class="op" id="3582964">[</span><span class="op" id="3582965">]</span><span class="builtintype" id="3582966">string</span>&nbsp;<span class="op" id="3582973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3582976">switch</span>&nbsp;<span class="op" id="3582983">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3582986">case</span>&nbsp;<span class="ident" id="3582991">status</span>&nbsp;<span class="op" id="3582998">==</span>&nbsp;<span class="num" id="3583001">304</span><span class="op" id="3583004">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3583008">//&nbsp;RFC&nbsp;2616&nbsp;section&nbsp;10.3.5:&nbsp;&#34;the&nbsp;response&nbsp;MUST&nbsp;NOT&nbsp;include&nbsp;other&nbsp;entity-headers&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3583091">return</span>&nbsp;<span class="ident" id="3583098">suppressedHeaders304</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3583120">case</span>&nbsp;<span class="op" id="3583125">!</span><span class="ident" id="3583126">bodyAllowedForStatus</span><span class="op" id="3583146">(</span><span class="ident" id="3583147">status</span><span class="op" id="3583153">)</span><span class="op" id="3583154">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3583158">return</span>&nbsp;<span class="ident" id="3583165">suppressedHeadersNoBody</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3583190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3583193">return</span>&nbsp;<span class="ident" id="3583200">nil</span><br>
<span class="lineno"></span><span class="op" id="3583204">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3583207">//&nbsp;msg&nbsp;is&nbsp;*Request&nbsp;or&nbsp;*Response.</span><br>
<span class="lineno">295</span><span class="keyword" id="3583240">func</span>&nbsp;<span class="ident" id="3583245">readTransfer</span><span class="op" id="3583257">(</span><span class="ident" id="3583258">msg</span>&nbsp;<span class="keyword" id="3583262">interface</span><span class="op" id="3583271">{</span><span class="op" id="3583272">}</span><span class="op" id="3583273">,</span>&nbsp;<span class="ident" id="3583275">r</span>&nbsp;<span class="op" id="3583277">*</span><span class="ident" id="3583278">bufio</span><span class="op" id="3583283">.</span><span class="ident" id="3583284">Reader</span><span class="op" id="3583290">)</span>&nbsp;<span class="op" id="3583292">(</span><span class="ident" id="3583293">err</span>&nbsp;<span class="builtintype" id="3583297">error</span><span class="op" id="3583302">)</span>&nbsp;<span class="op" id="3583304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3583307">t</span>&nbsp;<span class="op" id="3583309">:=</span>&nbsp;<span class="op" id="3583312">&amp;</span><span class="ident" id="3583313">transferReader</span><span class="op" id="3583327">{</span><span class="ident" id="3583328">RequestMethod</span><span class="op" id="3583341">:</span>&nbsp;<span class="string" id="3583343">&#34;GET&#34;</span><span class="op" id="3583348">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3583352">//&nbsp;Unify&nbsp;input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3583368">isResponse</span>&nbsp;<span class="op" id="3583379">:=</span>&nbsp;<span class="builtintype" id="3583382">false</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3583389">switch</span>&nbsp;<span class="ident" id="3583396">rr</span>&nbsp;<span class="op" id="3583399">:=</span>&nbsp;<span class="ident" id="3583402">msg</span><span class="op" id="3583405">.</span><span class="op" id="3583406">(</span><span class="keyword" id="3583407">type</span><span class="op" id="3583411">)</span>&nbsp;<span class="op" id="3583413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3583416">case</span>&nbsp;<span class="op" id="3583421">*</span><span class="ident" id="3583422">Response</span><span class="op" id="3583430">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3583434">t</span><span class="op" id="3583435">.</span><span class="ident" id="3583436">Header</span>&nbsp;<span class="op" id="3583443">=</span>&nbsp;<span class="ident" id="3583445">rr</span><span class="op" id="3583447">.</span><span class="ident" id="3583448">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3583457">t</span><span class="op" id="3583458">.</span><span class="ident" id="3583459">StatusCode</span>&nbsp;<span class="op" id="3583470">=</span>&nbsp;<span class="ident" id="3583472">rr</span><span class="op" id="3583474">.</span><span class="ident" id="3583475">StatusCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3583488">t</span><span class="op" id="3583489">.</span><span class="ident" id="3583490">ProtoMajor</span>&nbsp;<span class="op" id="3583501">=</span>&nbsp;<span class="ident" id="3583503">rr</span><span class="op" id="3583505">.</span><span class="ident" id="3583506">ProtoMajor</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3583519">t</span><span class="op" id="3583520">.</span><span class="ident" id="3583521">ProtoMinor</span>&nbsp;<span class="op" id="3583532">=</span>&nbsp;<span class="ident" id="3583534">rr</span><span class="op" id="3583536">.</span><span class="ident" id="3583537">ProtoMinor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3583550">t</span><span class="op" id="3583551">.</span><span class="ident" id="3583552">Close</span>&nbsp;<span class="op" id="3583558">=</span>&nbsp;<span class="ident" id="3583560">shouldClose</span><span class="op" id="3583571">(</span><span class="ident" id="3583572">t</span><span class="op" id="3583573">.</span><span class="ident" id="3583574">ProtoMajor</span><span class="op" id="3583584">,</span>&nbsp;<span class="ident" id="3583586">t</span><span class="op" id="3583587">.</span><span class="ident" id="3583588">ProtoMinor</span><span class="op" id="3583598">,</span>&nbsp;<span class="ident" id="3583600">t</span><span class="op" id="3583601">.</span><span class="ident" id="3583602">Header</span><span class="op" id="3583608">,</span>&nbsp;<span class="builtintype" id="3583610">true</span><span class="op" id="3583614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3583618">isResponse</span>&nbsp;<span class="op" id="3583629">=</span>&nbsp;<span class="builtintype" id="3583631">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3583638">if</span>&nbsp;<span class="ident" id="3583641">rr</span><span class="op" id="3583643">.</span><span class="ident" id="3583644">Request</span>&nbsp;<span class="op" id="3583652">!=</span>&nbsp;<span class="ident" id="3583655">nil</span>&nbsp;<span class="op" id="3583659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3583664">t</span><span class="op" id="3583665">.</span><span class="ident" id="3583666">RequestMethod</span>&nbsp;<span class="op" id="3583680">=</span>&nbsp;<span class="ident" id="3583682">rr</span><span class="op" id="3583684">.</span><span class="ident" id="3583685">Request</span><span class="op" id="3583692">.</span><span class="ident" id="3583693">Method</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3583702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3583705">case</span>&nbsp;<span class="op" id="3583710">*</span><span class="ident" id="3583711">Request</span><span class="op" id="3583718">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3583722">t</span><span class="op" id="3583723">.</span><span class="ident" id="3583724">Header</span>&nbsp;<span class="op" id="3583731">=</span>&nbsp;<span class="ident" id="3583733">rr</span><span class="op" id="3583735">.</span><span class="ident" id="3583736">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3583745">t</span><span class="op" id="3583746">.</span><span class="ident" id="3583747">ProtoMajor</span>&nbsp;<span class="op" id="3583758">=</span>&nbsp;<span class="ident" id="3583760">rr</span><span class="op" id="3583762">.</span><span class="ident" id="3583763">ProtoMajor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3583776">t</span><span class="op" id="3583777">.</span><span class="ident" id="3583778">ProtoMinor</span>&nbsp;<span class="op" id="3583789">=</span>&nbsp;<span class="ident" id="3583791">rr</span><span class="op" id="3583793">.</span><span class="ident" id="3583794">ProtoMinor</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3583807">//&nbsp;Transfer&nbsp;semantics&nbsp;for&nbsp;Requests&nbsp;are&nbsp;exactly&nbsp;like&nbsp;those&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3583871">//&nbsp;Responses&nbsp;with&nbsp;status&nbsp;code&nbsp;200,&nbsp;responding&nbsp;to&nbsp;a&nbsp;GET&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3583935">t</span><span class="op" id="3583936">.</span><span class="ident" id="3583937">StatusCode</span>&nbsp;<span class="op" id="3583948">=</span>&nbsp;<span class="num" id="3583950">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3583955">default</span><span class="op" id="3583962">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3583966">panic</span><span class="op" id="3583971">(</span><span class="string" id="3583972">&#34;unexpected&nbsp;type&#34;</span><span class="op" id="3583989">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3583992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3583996">//&nbsp;Default&nbsp;to&nbsp;HTTP/1.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3584020">if</span>&nbsp;<span class="ident" id="3584023">t</span><span class="op" id="3584024">.</span><span class="ident" id="3584025">ProtoMajor</span>&nbsp;<span class="op" id="3584036">==</span>&nbsp;<span class="num" id="3584039">0</span>&nbsp;<span class="op" id="3584041">&amp;&amp;</span>&nbsp;<span class="ident" id="3584044">t</span><span class="op" id="3584045">.</span><span class="ident" id="3584046">ProtoMinor</span>&nbsp;<span class="op" id="3584057">==</span>&nbsp;<span class="num" id="3584060">0</span>&nbsp;<span class="op" id="3584062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3584066">t</span><span class="op" id="3584067">.</span><span class="ident" id="3584068">ProtoMajor</span><span class="op" id="3584078">,</span>&nbsp;<span class="ident" id="3584080">t</span><span class="op" id="3584081">.</span><span class="ident" id="3584082">ProtoMinor</span>&nbsp;<span class="op" id="3584093">=</span>&nbsp;<span class="num" id="3584095">1</span><span class="op" id="3584096">,</span>&nbsp;<span class="num" id="3584098">1</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3584101">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3584105">//&nbsp;Transfer&nbsp;encoding,&nbsp;content&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3584143">t</span><span class="op" id="3584144">.</span><span class="ident" id="3584145">TransferEncoding</span><span class="op" id="3584161">,</span>&nbsp;<span class="ident" id="3584163">err</span>&nbsp;<span class="op" id="3584167">=</span>&nbsp;<span class="ident" id="3584169">fixTransferEncoding</span><span class="op" id="3584188">(</span><span class="ident" id="3584189">t</span><span class="op" id="3584190">.</span><span class="ident" id="3584191">RequestMethod</span><span class="op" id="3584204">,</span>&nbsp;<span class="ident" id="3584206">t</span><span class="op" id="3584207">.</span><span class="ident" id="3584208">Header</span><span class="op" id="3584214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3584217">if</span>&nbsp;<span class="ident" id="3584220">err</span>&nbsp;<span class="op" id="3584224">!=</span>&nbsp;<span class="ident" id="3584227">nil</span>&nbsp;<span class="op" id="3584231">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3584235">return</span>&nbsp;<span class="ident" id="3584242">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3584247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3584251">realLength</span><span class="op" id="3584261">,</span>&nbsp;<span class="ident" id="3584263">err</span>&nbsp;<span class="op" id="3584267">:=</span>&nbsp;<span class="ident" id="3584270">fixLength</span><span class="op" id="3584279">(</span><span class="ident" id="3584280">isResponse</span><span class="op" id="3584290">,</span>&nbsp;<span class="ident" id="3584292">t</span><span class="op" id="3584293">.</span><span class="ident" id="3584294">StatusCode</span><span class="op" id="3584304">,</span>&nbsp;<span class="ident" id="3584306">t</span><span class="op" id="3584307">.</span><span class="ident" id="3584308">RequestMethod</span><span class="op" id="3584321">,</span>&nbsp;<span class="ident" id="3584323">t</span><span class="op" id="3584324">.</span><span class="ident" id="3584325">Header</span><span class="op" id="3584331">,</span>&nbsp;<span class="ident" id="3584333">t</span><span class="op" id="3584334">.</span><span class="ident" id="3584335">TransferEncoding</span><span class="op" id="3584351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3584354">if</span>&nbsp;<span class="ident" id="3584357">err</span>&nbsp;<span class="op" id="3584361">!=</span>&nbsp;<span class="ident" id="3584364">nil</span>&nbsp;<span class="op" id="3584368">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3584372">return</span>&nbsp;<span class="ident" id="3584379">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3584384">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3584387">if</span>&nbsp;<span class="ident" id="3584390">isResponse</span>&nbsp;<span class="op" id="3584401">&amp;&amp;</span>&nbsp;<span class="ident" id="3584404">t</span><span class="op" id="3584405">.</span><span class="ident" id="3584406">RequestMethod</span>&nbsp;<span class="op" id="3584420">==</span>&nbsp;<span class="string" id="3584423">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3584430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3584434">if</span>&nbsp;<span class="ident" id="3584437">n</span><span class="op" id="3584438">,</span>&nbsp;<span class="ident" id="3584440">err</span>&nbsp;<span class="op" id="3584444">:=</span>&nbsp;<span class="ident" id="3584447">parseContentLength</span><span class="op" id="3584465">(</span><span class="ident" id="3584466">t</span><span class="op" id="3584467">.</span><span class="ident" id="3584468">Header</span><span class="op" id="3584474">.</span><span class="ident" id="3584475">get</span><span class="op" id="3584478">(</span><span class="string" id="3584479">&#34;Content-Length&#34;</span><span class="op" id="3584495">)</span><span class="op" id="3584496">)</span><span class="op" id="3584497">;</span>&nbsp;<span class="ident" id="3584499">err</span>&nbsp;<span class="op" id="3584503">!=</span>&nbsp;<span class="ident" id="3584506">nil</span>&nbsp;<span class="op" id="3584510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3584515">return</span>&nbsp;<span class="ident" id="3584522">err</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3584528">}</span>&nbsp;<span class="keyword" id="3584530">else</span>&nbsp;<span class="op" id="3584535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3584540">t</span><span class="op" id="3584541">.</span><span class="ident" id="3584542">ContentLength</span>&nbsp;<span class="op" id="3584556">=</span>&nbsp;<span class="ident" id="3584558">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3584562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3584565">}</span>&nbsp;<span class="keyword" id="3584567">else</span>&nbsp;<span class="op" id="3584572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3584576">t</span><span class="op" id="3584577">.</span><span class="ident" id="3584578">ContentLength</span>&nbsp;<span class="op" id="3584592">=</span>&nbsp;<span class="ident" id="3584594">realLength</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3584606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3584610">//&nbsp;Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3584622">t</span><span class="op" id="3584623">.</span><span class="ident" id="3584624">Trailer</span><span class="op" id="3584631">,</span>&nbsp;<span class="ident" id="3584633">err</span>&nbsp;<span class="op" id="3584637">=</span>&nbsp;<span class="ident" id="3584639">fixTrailer</span><span class="op" id="3584649">(</span><span class="ident" id="3584650">t</span><span class="op" id="3584651">.</span><span class="ident" id="3584652">Header</span><span class="op" id="3584658">,</span>&nbsp;<span class="ident" id="3584660">t</span><span class="op" id="3584661">.</span><span class="ident" id="3584662">TransferEncoding</span><span class="op" id="3584678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3584681">if</span>&nbsp;<span class="ident" id="3584684">err</span>&nbsp;<span class="op" id="3584688">!=</span>&nbsp;<span class="ident" id="3584691">nil</span>&nbsp;<span class="op" id="3584695">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3584699">return</span>&nbsp;<span class="ident" id="3584706">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3584711">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3584715">//&nbsp;If&nbsp;there&nbsp;is&nbsp;no&nbsp;Content-Length&nbsp;or&nbsp;chunked&nbsp;Transfer-Encoding&nbsp;on&nbsp;a&nbsp;*Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3584793">//&nbsp;and&nbsp;the&nbsp;status&nbsp;is&nbsp;not&nbsp;1xx,&nbsp;204&nbsp;or&nbsp;304,&nbsp;then&nbsp;the&nbsp;body&nbsp;is&nbsp;unbounded.</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3584864">//&nbsp;See&nbsp;RFC2616,&nbsp;section&nbsp;4.4.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3584894">switch</span>&nbsp;<span class="ident" id="3584901">msg</span><span class="op" id="3584904">.</span><span class="op" id="3584905">(</span><span class="keyword" id="3584906">type</span><span class="op" id="3584910">)</span>&nbsp;<span class="op" id="3584912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3584915">case</span>&nbsp;<span class="op" id="3584920">*</span><span class="ident" id="3584921">Response</span><span class="op" id="3584929">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3584933">if</span>&nbsp;<span class="ident" id="3584936">realLength</span>&nbsp;<span class="op" id="3584947">==</span>&nbsp;<span class="op" id="3584950">-</span><span class="num" id="3584951">1</span>&nbsp;<span class="op" id="3584953">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3584959">!</span><span class="ident" id="3584960">chunked</span><span class="op" id="3584967">(</span><span class="ident" id="3584968">t</span><span class="op" id="3584969">.</span><span class="ident" id="3584970">TransferEncoding</span><span class="op" id="3584986">)</span>&nbsp;<span class="op" id="3584988">&amp;&amp;</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3584994">bodyAllowedForStatus</span><span class="op" id="3585014">(</span><span class="ident" id="3585015">t</span><span class="op" id="3585016">.</span><span class="ident" id="3585017">StatusCode</span><span class="op" id="3585027">)</span>&nbsp;<span class="op" id="3585029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3585034">//&nbsp;Unbounded&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3585056">t</span><span class="op" id="3585057">.</span><span class="ident" id="3585058">Close</span>&nbsp;<span class="op" id="3585064">=</span>&nbsp;<span class="builtintype" id="3585066">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3585073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3585076">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3585080">//&nbsp;Prepare&nbsp;body&nbsp;reader.&nbsp;&nbsp;ContentLength&nbsp;&lt;&nbsp;0&nbsp;means&nbsp;chunked&nbsp;encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3585147">//&nbsp;or&nbsp;close&nbsp;connection&nbsp;when&nbsp;finished,&nbsp;since&nbsp;multipart&nbsp;is&nbsp;not&nbsp;supported&nbsp;yet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3585223">switch</span>&nbsp;<span class="op" id="3585230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3585233">case</span>&nbsp;<span class="ident" id="3585238">chunked</span><span class="op" id="3585245">(</span><span class="ident" id="3585246">t</span><span class="op" id="3585247">.</span><span class="ident" id="3585248">TransferEncoding</span><span class="op" id="3585264">)</span><span class="op" id="3585265">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3585269">if</span>&nbsp;<span class="ident" id="3585272">noBodyExpected</span><span class="op" id="3585286">(</span><span class="ident" id="3585287">t</span><span class="op" id="3585288">.</span><span class="ident" id="3585289">RequestMethod</span><span class="op" id="3585302">)</span>&nbsp;<span class="op" id="3585304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3585309">t</span><span class="op" id="3585310">.</span><span class="ident" id="3585311">Body</span>&nbsp;<span class="op" id="3585316">=</span>&nbsp;<span class="ident" id="3585318">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3585330">}</span>&nbsp;<span class="keyword" id="3585332">else</span>&nbsp;<span class="op" id="3585337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3585342">t</span><span class="op" id="3585343">.</span><span class="ident" id="3585344">Body</span>&nbsp;<span class="op" id="3585349">=</span>&nbsp;<span class="op" id="3585351">&amp;</span><span class="ident" id="3585352">body</span><span class="op" id="3585356">{</span><span class="ident" id="3585357">src</span><span class="op" id="3585360">:</span>&nbsp;<span class="ident" id="3585362">internal</span><span class="op" id="3585370">.</span><span class="ident" id="3585371">NewChunkedReader</span><span class="op" id="3585387">(</span><span class="ident" id="3585388">r</span><span class="op" id="3585389">)</span><span class="op" id="3585390">,</span>&nbsp;<span class="ident" id="3585392">hdr</span><span class="op" id="3585395">:</span>&nbsp;<span class="ident" id="3585397">msg</span><span class="op" id="3585400">,</span>&nbsp;<span class="ident" id="3585402">r</span><span class="op" id="3585403">:</span>&nbsp;<span class="ident" id="3585405">r</span><span class="op" id="3585406">,</span>&nbsp;<span class="ident" id="3585408">closing</span><span class="op" id="3585415">:</span>&nbsp;<span class="ident" id="3585417">t</span><span class="op" id="3585418">.</span><span class="ident" id="3585419">Close</span><span class="op" id="3585424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3585428">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3585431">case</span>&nbsp;<span class="ident" id="3585436">realLength</span>&nbsp;<span class="op" id="3585447">==</span>&nbsp;<span class="num" id="3585450">0</span><span class="op" id="3585451">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3585455">t</span><span class="op" id="3585456">.</span><span class="ident" id="3585457">Body</span>&nbsp;<span class="op" id="3585462">=</span>&nbsp;<span class="ident" id="3585464">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3585475">case</span>&nbsp;<span class="ident" id="3585480">realLength</span>&nbsp;<span class="op" id="3585491">&gt;</span>&nbsp;<span class="num" id="3585493">0</span><span class="op" id="3585494">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3585498">t</span><span class="op" id="3585499">.</span><span class="ident" id="3585500">Body</span>&nbsp;<span class="op" id="3585505">=</span>&nbsp;<span class="op" id="3585507">&amp;</span><span class="ident" id="3585508">body</span><span class="op" id="3585512">{</span><span class="ident" id="3585513">src</span><span class="op" id="3585516">:</span>&nbsp;<span class="ident" id="3585518">io</span><span class="op" id="3585520">.</span><span class="ident" id="3585521">LimitReader</span><span class="op" id="3585532">(</span><span class="ident" id="3585533">r</span><span class="op" id="3585534">,</span>&nbsp;<span class="ident" id="3585536">realLength</span><span class="op" id="3585546">)</span><span class="op" id="3585547">,</span>&nbsp;<span class="ident" id="3585549">closing</span><span class="op" id="3585556">:</span>&nbsp;<span class="ident" id="3585558">t</span><span class="op" id="3585559">.</span><span class="ident" id="3585560">Close</span><span class="op" id="3585565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3585568">default</span><span class="op" id="3585575">:</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3585579">//&nbsp;realLength&nbsp;&lt;&nbsp;0,&nbsp;i.e.&nbsp;&#34;Content-Length&#34;&nbsp;not&nbsp;mentioned&nbsp;in&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3585646">if</span>&nbsp;<span class="ident" id="3585649">t</span><span class="op" id="3585650">.</span><span class="ident" id="3585651">Close</span>&nbsp;<span class="op" id="3585657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3585662">//&nbsp;Close&nbsp;semantics&nbsp;(i.e.&nbsp;HTTP/1.0)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3585700">t</span><span class="op" id="3585701">.</span><span class="ident" id="3585702">Body</span>&nbsp;<span class="op" id="3585707">=</span>&nbsp;<span class="op" id="3585709">&amp;</span><span class="ident" id="3585710">body</span><span class="op" id="3585714">{</span><span class="ident" id="3585715">src</span><span class="op" id="3585718">:</span>&nbsp;<span class="ident" id="3585720">r</span><span class="op" id="3585721">,</span>&nbsp;<span class="ident" id="3585723">closing</span><span class="op" id="3585730">:</span>&nbsp;<span class="ident" id="3585732">t</span><span class="op" id="3585733">.</span><span class="ident" id="3585734">Close</span><span class="op" id="3585739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3585743">}</span>&nbsp;<span class="keyword" id="3585745">else</span>&nbsp;<span class="op" id="3585750">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3585755">//&nbsp;Persistent&nbsp;connection&nbsp;(i.e.&nbsp;HTTP/1.1)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3585799">t</span><span class="op" id="3585800">.</span><span class="ident" id="3585801">Body</span>&nbsp;<span class="op" id="3585806">=</span>&nbsp;<span class="ident" id="3585808">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3585820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3585823">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3585827">//&nbsp;Unify&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3585844">switch</span>&nbsp;<span class="ident" id="3585851">rr</span>&nbsp;<span class="op" id="3585854">:=</span>&nbsp;<span class="ident" id="3585857">msg</span><span class="op" id="3585860">.</span><span class="op" id="3585861">(</span><span class="keyword" id="3585862">type</span><span class="op" id="3585866">)</span>&nbsp;<span class="op" id="3585868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3585871">case</span>&nbsp;<span class="op" id="3585876">*</span><span class="ident" id="3585877">Request</span><span class="op" id="3585884">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3585888">rr</span><span class="op" id="3585890">.</span><span class="ident" id="3585891">Body</span>&nbsp;<span class="op" id="3585896">=</span>&nbsp;<span class="ident" id="3585898">t</span><span class="op" id="3585899">.</span><span class="ident" id="3585900">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3585907">rr</span><span class="op" id="3585909">.</span><span class="ident" id="3585910">ContentLength</span>&nbsp;<span class="op" id="3585924">=</span>&nbsp;<span class="ident" id="3585926">t</span><span class="op" id="3585927">.</span><span class="ident" id="3585928">ContentLength</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3585944">rr</span><span class="op" id="3585946">.</span><span class="ident" id="3585947">TransferEncoding</span>&nbsp;<span class="op" id="3585964">=</span>&nbsp;<span class="ident" id="3585966">t</span><span class="op" id="3585967">.</span><span class="ident" id="3585968">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3585987">rr</span><span class="op" id="3585989">.</span><span class="ident" id="3585990">Close</span>&nbsp;<span class="op" id="3585996">=</span>&nbsp;<span class="ident" id="3585998">t</span><span class="op" id="3585999">.</span><span class="ident" id="3586000">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3586008">rr</span><span class="op" id="3586010">.</span><span class="ident" id="3586011">Trailer</span>&nbsp;<span class="op" id="3586019">=</span>&nbsp;<span class="ident" id="3586021">t</span><span class="op" id="3586022">.</span><span class="ident" id="3586023">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3586032">case</span>&nbsp;<span class="op" id="3586037">*</span><span class="ident" id="3586038">Response</span><span class="op" id="3586046">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3586050">rr</span><span class="op" id="3586052">.</span><span class="ident" id="3586053">Body</span>&nbsp;<span class="op" id="3586058">=</span>&nbsp;<span class="ident" id="3586060">t</span><span class="op" id="3586061">.</span><span class="ident" id="3586062">Body</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3586069">rr</span><span class="op" id="3586071">.</span><span class="ident" id="3586072">ContentLength</span>&nbsp;<span class="op" id="3586086">=</span>&nbsp;<span class="ident" id="3586088">t</span><span class="op" id="3586089">.</span><span class="ident" id="3586090">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3586106">rr</span><span class="op" id="3586108">.</span><span class="ident" id="3586109">TransferEncoding</span>&nbsp;<span class="op" id="3586126">=</span>&nbsp;<span class="ident" id="3586128">t</span><span class="op" id="3586129">.</span><span class="ident" id="3586130">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3586149">rr</span><span class="op" id="3586151">.</span><span class="ident" id="3586152">Close</span>&nbsp;<span class="op" id="3586158">=</span>&nbsp;<span class="ident" id="3586160">t</span><span class="op" id="3586161">.</span><span class="ident" id="3586162">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3586170">rr</span><span class="op" id="3586172">.</span><span class="ident" id="3586173">Trailer</span>&nbsp;<span class="op" id="3586181">=</span>&nbsp;<span class="ident" id="3586183">t</span><span class="op" id="3586184">.</span><span class="ident" id="3586185">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3586194">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3586198">return</span>&nbsp;<span class="ident" id="3586205">nil</span><br>
<span class="lineno"></span><span class="op" id="3586209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3586212">//&nbsp;Checks&nbsp;whether&nbsp;chunked&nbsp;is&nbsp;part&nbsp;of&nbsp;the&nbsp;encodings&nbsp;stack</span><br>
<span class="lineno">410</span><span class="keyword" id="3586269">func</span>&nbsp;<span class="ident" id="3586274">chunked</span><span class="op" id="3586281">(</span><span class="ident" id="3586282">te</span>&nbsp;<span class="op" id="3586285">[</span><span class="op" id="3586286">]</span><span class="builtintype" id="3586287">string</span><span class="op" id="3586293">)</span>&nbsp;<span class="builtintype" id="3586295">bool</span>&nbsp;<span class="op" id="3586300">{</span>&nbsp;<span class="keyword" id="3586302">return</span>&nbsp;<span class="builtinfunc" id="3586309">len</span><span class="op" id="3586312">(</span><span class="ident" id="3586313">te</span><span class="op" id="3586315">)</span>&nbsp;<span class="op" id="3586317">&gt;</span>&nbsp;<span class="num" id="3586319">0</span>&nbsp;<span class="op" id="3586321">&amp;&amp;</span>&nbsp;<span class="ident" id="3586324">te</span><span class="op" id="3586326">[</span><span class="num" id="3586327">0</span><span class="op" id="3586328">]</span>&nbsp;<span class="op" id="3586330">==</span>&nbsp;<span class="string" id="3586333">&#34;chunked&#34;</span>&nbsp;<span class="op" id="3586343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3586346">//&nbsp;Checks&nbsp;whether&nbsp;the&nbsp;encoding&nbsp;is&nbsp;explicitly&nbsp;&#34;identity&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="3586403">func</span>&nbsp;<span class="ident" id="3586408">isIdentity</span><span class="op" id="3586418">(</span><span class="ident" id="3586419">te</span>&nbsp;<span class="op" id="3586422">[</span><span class="op" id="3586423">]</span><span class="builtintype" id="3586424">string</span><span class="op" id="3586430">)</span>&nbsp;<span class="builtintype" id="3586432">bool</span>&nbsp;<span class="op" id="3586437">{</span>&nbsp;<span class="keyword" id="3586439">return</span>&nbsp;<span class="builtinfunc" id="3586446">len</span><span class="op" id="3586449">(</span><span class="ident" id="3586450">te</span><span class="op" id="3586452">)</span>&nbsp;<span class="op" id="3586454">==</span>&nbsp;<span class="num" id="3586457">1</span>&nbsp;<span class="op" id="3586459">&amp;&amp;</span>&nbsp;<span class="ident" id="3586462">te</span><span class="op" id="3586464">[</span><span class="num" id="3586465">0</span><span class="op" id="3586466">]</span>&nbsp;<span class="op" id="3586468">==</span>&nbsp;<span class="string" id="3586471">&#34;identity&#34;</span>&nbsp;<span class="op" id="3586482">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="3586485">//&nbsp;Sanitize&nbsp;transfer&nbsp;encoding</span><br>
<span class="lineno"></span><span class="keyword" id="3586515">func</span>&nbsp;<span class="ident" id="3586520">fixTransferEncoding</span><span class="op" id="3586539">(</span><span class="ident" id="3586540">requestMethod</span>&nbsp;<span class="builtintype" id="3586554">string</span><span class="op" id="3586560">,</span>&nbsp;<span class="ident" id="3586562">header</span>&nbsp;<span class="ident" id="3586569">Header</span><span class="op" id="3586575">)</span>&nbsp;<span class="op" id="3586577">(</span><span class="op" id="3586578">[</span><span class="op" id="3586579">]</span><span class="builtintype" id="3586580">string</span><span class="op" id="3586586">,</span>&nbsp;<span class="builtintype" id="3586588">error</span><span class="op" id="3586593">)</span>&nbsp;<span class="op" id="3586595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3586598">raw</span><span class="op" id="3586601">,</span>&nbsp;<span class="ident" id="3586603">present</span>&nbsp;<span class="op" id="3586611">:=</span>&nbsp;<span class="ident" id="3586614">header</span><span class="op" id="3586620">[</span><span class="string" id="3586621">&#34;Transfer-Encoding&#34;</span><span class="op" id="3586640">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3586643">if</span>&nbsp;<span class="op" id="3586646">!</span><span class="ident" id="3586647">present</span>&nbsp;<span class="op" id="3586655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3586659">return</span>&nbsp;<span class="ident" id="3586666">nil</span><span class="op" id="3586669">,</span>&nbsp;<span class="ident" id="3586671">nil</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3586676">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3586680">delete</span><span class="op" id="3586686">(</span><span class="ident" id="3586687">header</span><span class="op" id="3586693">,</span>&nbsp;<span class="string" id="3586695">&#34;Transfer-Encoding&#34;</span><span class="op" id="3586714">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3586718">encodings</span>&nbsp;<span class="op" id="3586728">:=</span>&nbsp;<span class="ident" id="3586731">strings</span><span class="op" id="3586738">.</span><span class="ident" id="3586739">Split</span><span class="op" id="3586744">(</span><span class="ident" id="3586745">raw</span><span class="op" id="3586748">[</span><span class="num" id="3586749">0</span><span class="op" id="3586750">]</span><span class="op" id="3586751">,</span>&nbsp;<span class="string" id="3586753">&#34;,&#34;</span><span class="op" id="3586756">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3586759">te</span>&nbsp;<span class="op" id="3586762">:=</span>&nbsp;<span class="builtinfunc" id="3586765">make</span><span class="op" id="3586769">(</span><span class="op" id="3586770">[</span><span class="op" id="3586771">]</span><span class="builtintype" id="3586772">string</span><span class="op" id="3586778">,</span>&nbsp;<span class="num" id="3586780">0</span><span class="op" id="3586781">,</span>&nbsp;<span class="builtinfunc" id="3586783">len</span><span class="op" id="3586786">(</span><span class="ident" id="3586787">encodings</span><span class="op" id="3586796">)</span><span class="op" id="3586797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3586800">//&nbsp;TODO:&nbsp;Even&nbsp;though&nbsp;we&nbsp;only&nbsp;support&nbsp;&#34;identity&#34;&nbsp;and&nbsp;&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3586863">//&nbsp;encodings,&nbsp;the&nbsp;loop&nbsp;below&nbsp;is&nbsp;designed&nbsp;with&nbsp;foresight.&nbsp;One</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3586925">//&nbsp;invariant&nbsp;that&nbsp;must&nbsp;be&nbsp;maintained&nbsp;is&nbsp;that,&nbsp;if&nbsp;present,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3586984">//&nbsp;chunked&nbsp;encoding&nbsp;must&nbsp;always&nbsp;come&nbsp;first.</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3587029">for</span>&nbsp;<span class="ident" id="3587033">_</span><span class="op" id="3587034">,</span>&nbsp;<span class="ident" id="3587036">encoding</span>&nbsp;<span class="op" id="3587045">:=</span>&nbsp;<span class="keyword" id="3587048">range</span>&nbsp;<span class="ident" id="3587054">encodings</span>&nbsp;<span class="op" id="3587064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3587068">encoding</span>&nbsp;<span class="op" id="3587077">=</span>&nbsp;<span class="ident" id="3587079">strings</span><span class="op" id="3587086">.</span><span class="ident" id="3587087">ToLower</span><span class="op" id="3587094">(</span><span class="ident" id="3587095">strings</span><span class="op" id="3587102">.</span><span class="ident" id="3587103">TrimSpace</span><span class="op" id="3587112">(</span><span class="ident" id="3587113">encoding</span><span class="op" id="3587121">)</span><span class="op" id="3587122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3587126">//&nbsp;&#34;identity&#34;&nbsp;encoding&nbsp;is&nbsp;not&nbsp;recorded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3587167">if</span>&nbsp;<span class="ident" id="3587170">encoding</span>&nbsp;<span class="op" id="3587179">==</span>&nbsp;<span class="string" id="3587182">&#34;identity&#34;</span>&nbsp;<span class="op" id="3587193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3587198">break</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3587206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3587210">if</span>&nbsp;<span class="ident" id="3587213">encoding</span>&nbsp;<span class="op" id="3587222">!=</span>&nbsp;<span class="string" id="3587225">&#34;chunked&#34;</span>&nbsp;<span class="op" id="3587235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3587240">return</span>&nbsp;<span class="ident" id="3587247">nil</span><span class="op" id="3587250">,</span>&nbsp;<span class="op" id="3587252">&amp;</span><span class="ident" id="3587253">badStringError</span><span class="op" id="3587267">{</span><span class="string" id="3587268">&#34;unsupported&nbsp;transfer&nbsp;encoding&#34;</span><span class="op" id="3587299">,</span>&nbsp;<span class="ident" id="3587301">encoding</span><span class="op" id="3587309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3587313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3587317">te</span>&nbsp;<span class="op" id="3587320">=</span>&nbsp;<span class="ident" id="3587322">te</span><span class="op" id="3587324">[</span><span class="num" id="3587325">0</span>&nbsp;<span class="op" id="3587327">:</span>&nbsp;<span class="builtinfunc" id="3587329">len</span><span class="op" id="3587332">(</span><span class="ident" id="3587333">te</span><span class="op" id="3587335">)</span><span class="op" id="3587336">+</span><span class="num" id="3587337">1</span><span class="op" id="3587338">]</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3587342">te</span><span class="op" id="3587344">[</span><span class="builtinfunc" id="3587345">len</span><span class="op" id="3587348">(</span><span class="ident" id="3587349">te</span><span class="op" id="3587351">)</span><span class="op" id="3587352">-</span><span class="num" id="3587353">1</span><span class="op" id="3587354">]</span>&nbsp;<span class="op" id="3587356">=</span>&nbsp;<span class="ident" id="3587358">encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3587368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3587371">if</span>&nbsp;<span class="builtinfunc" id="3587374">len</span><span class="op" id="3587377">(</span><span class="ident" id="3587378">te</span><span class="op" id="3587380">)</span>&nbsp;<span class="op" id="3587382">&gt;</span>&nbsp;<span class="num" id="3587384">1</span>&nbsp;<span class="op" id="3587386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3587390">return</span>&nbsp;<span class="ident" id="3587397">nil</span><span class="op" id="3587400">,</span>&nbsp;<span class="op" id="3587402">&amp;</span><span class="ident" id="3587403">badStringError</span><span class="op" id="3587417">{</span><span class="string" id="3587418">&#34;too&nbsp;many&nbsp;transfer&nbsp;encodings&#34;</span><span class="op" id="3587447">,</span>&nbsp;<span class="ident" id="3587449">strings</span><span class="op" id="3587456">.</span><span class="ident" id="3587457">Join</span><span class="op" id="3587461">(</span><span class="ident" id="3587462">te</span><span class="op" id="3587464">,</span>&nbsp;<span class="string" id="3587466">&#34;,&#34;</span><span class="op" id="3587469">)</span><span class="op" id="3587470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3587473">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3587476">if</span>&nbsp;<span class="builtinfunc" id="3587479">len</span><span class="op" id="3587482">(</span><span class="ident" id="3587483">te</span><span class="op" id="3587485">)</span>&nbsp;<span class="op" id="3587487">&gt;</span>&nbsp;<span class="num" id="3587489">0</span>&nbsp;<span class="op" id="3587491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3587495">//&nbsp;Chunked&nbsp;encoding&nbsp;trumps&nbsp;Content-Length.&nbsp;See&nbsp;RFC&nbsp;2616</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3587553">//&nbsp;Section&nbsp;4.4.&nbsp;Currently&nbsp;len(te)&nbsp;&gt;&nbsp;0&nbsp;implies&nbsp;chunked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3587609">//&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3587624">delete</span><span class="op" id="3587630">(</span><span class="ident" id="3587631">header</span><span class="op" id="3587637">,</span>&nbsp;<span class="string" id="3587639">&#34;Content-Length&#34;</span><span class="op" id="3587655">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3587659">return</span>&nbsp;<span class="ident" id="3587666">te</span><span class="op" id="3587668">,</span>&nbsp;<span class="ident" id="3587670">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3587675">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3587679">return</span>&nbsp;<span class="ident" id="3587686">nil</span><span class="op" id="3587689">,</span>&nbsp;<span class="ident" id="3587691">nil</span><br>
<span class="lineno"></span><span class="op" id="3587695">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="3587698">//&nbsp;Determine&nbsp;the&nbsp;expected&nbsp;body&nbsp;length,&nbsp;using&nbsp;RFC&nbsp;2616&nbsp;Section&nbsp;4.4.&nbsp;This</span><br>
<span class="lineno"></span><span class="comment" id="3587770">//&nbsp;function&nbsp;is&nbsp;not&nbsp;a&nbsp;method,&nbsp;because&nbsp;ultimately&nbsp;it&nbsp;should&nbsp;be&nbsp;shared&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="3587841">//&nbsp;ReadResponse&nbsp;and&nbsp;ReadRequest.</span><br>
<span class="lineno"></span><span class="keyword" id="3587874">func</span>&nbsp;<span class="ident" id="3587879">fixLength</span><span class="op" id="3587888">(</span><span class="ident" id="3587889">isResponse</span>&nbsp;<span class="builtintype" id="3587900">bool</span><span class="op" id="3587904">,</span>&nbsp;<span class="ident" id="3587906">status</span>&nbsp;<span class="builtintype" id="3587913">int</span><span class="op" id="3587916">,</span>&nbsp;<span class="ident" id="3587918">requestMethod</span>&nbsp;<span class="builtintype" id="3587932">string</span><span class="op" id="3587938">,</span>&nbsp;<span class="ident" id="3587940">header</span>&nbsp;<span class="ident" id="3587947">Header</span><span class="op" id="3587953">,</span>&nbsp;<span class="ident" id="3587955">te</span>&nbsp;<span class="op" id="3587958">[</span><span class="op" id="3587959">]</span><span class="builtintype" id="3587960">string</span><span class="op" id="3587966">)</span>&nbsp;<span class="op" id="3587968">(</span><span class="ident" id="3587969">int64</span><span class="op" id="3587974">,</span>&nbsp;<span class="builtintype" id="3587976">error</span><span class="op" id="3587981">)</span>&nbsp;<span class="op" id="3587983">{</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3587987">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;response&nbsp;type&nbsp;or&nbsp;status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3588030">if</span>&nbsp;<span class="ident" id="3588033">noBodyExpected</span><span class="op" id="3588047">(</span><span class="ident" id="3588048">requestMethod</span><span class="op" id="3588061">)</span>&nbsp;<span class="op" id="3588063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3588067">return</span>&nbsp;<span class="num" id="3588074">0</span><span class="op" id="3588075">,</span>&nbsp;<span class="ident" id="3588077">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3588082">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3588085">if</span>&nbsp;<span class="ident" id="3588088">status</span><span class="op" id="3588094">/</span><span class="num" id="3588095">100</span>&nbsp;<span class="op" id="3588099">==</span>&nbsp;<span class="num" id="3588102">1</span>&nbsp;<span class="op" id="3588104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3588108">return</span>&nbsp;<span class="num" id="3588115">0</span><span class="op" id="3588116">,</span>&nbsp;<span class="ident" id="3588118">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3588123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3588126">switch</span>&nbsp;<span class="ident" id="3588133">status</span>&nbsp;<span class="op" id="3588140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3588143">case</span>&nbsp;<span class="num" id="3588148">204</span><span class="op" id="3588151">,</span>&nbsp;<span class="num" id="3588153">304</span><span class="op" id="3588156">:</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3588160">return</span>&nbsp;<span class="num" id="3588167">0</span><span class="op" id="3588168">,</span>&nbsp;<span class="ident" id="3588170">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3588175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3588179">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;Transfer-Encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3588216">if</span>&nbsp;<span class="ident" id="3588219">chunked</span><span class="op" id="3588226">(</span><span class="ident" id="3588227">te</span><span class="op" id="3588229">)</span>&nbsp;<span class="op" id="3588231">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3588235">return</span>&nbsp;<span class="op" id="3588242">-</span><span class="num" id="3588243">1</span><span class="op" id="3588244">,</span>&nbsp;<span class="ident" id="3588246">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3588251">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3588255">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3588289">cl</span>&nbsp;<span class="op" id="3588292">:=</span>&nbsp;<span class="ident" id="3588295">strings</span><span class="op" id="3588302">.</span><span class="ident" id="3588303">TrimSpace</span><span class="op" id="3588312">(</span><span class="ident" id="3588313">header</span><span class="op" id="3588319">.</span><span class="ident" id="3588320">get</span><span class="op" id="3588323">(</span><span class="string" id="3588324">&#34;Content-Length&#34;</span><span class="op" id="3588340">)</span><span class="op" id="3588341">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3588344">if</span>&nbsp;<span class="ident" id="3588347">cl</span>&nbsp;<span class="op" id="3588350">!=</span>&nbsp;<span class="string" id="3588353">&#34;&#34;</span>&nbsp;<span class="op" id="3588356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3588360">n</span><span class="op" id="3588361">,</span>&nbsp;<span class="ident" id="3588363">err</span>&nbsp;<span class="op" id="3588367">:=</span>&nbsp;<span class="ident" id="3588370">parseContentLength</span><span class="op" id="3588388">(</span><span class="ident" id="3588389">cl</span><span class="op" id="3588391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3588395">if</span>&nbsp;<span class="ident" id="3588398">err</span>&nbsp;<span class="op" id="3588402">!=</span>&nbsp;<span class="ident" id="3588405">nil</span>&nbsp;<span class="op" id="3588409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3588414">return</span>&nbsp;<span class="op" id="3588421">-</span><span class="num" id="3588422">1</span><span class="op" id="3588423">,</span>&nbsp;<span class="ident" id="3588425">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3588431">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3588435">return</span>&nbsp;<span class="ident" id="3588442">n</span><span class="op" id="3588443">,</span>&nbsp;<span class="ident" id="3588445">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3588450">}</span>&nbsp;<span class="keyword" id="3588452">else</span>&nbsp;<span class="op" id="3588457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3588461">header</span><span class="op" id="3588467">.</span><span class="ident" id="3588468">Del</span><span class="op" id="3588471">(</span><span class="string" id="3588472">&#34;Content-Length&#34;</span><span class="op" id="3588488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3588491">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3588495">if</span>&nbsp;<span class="op" id="3588498">!</span><span class="ident" id="3588499">isResponse</span>&nbsp;<span class="op" id="3588510">&amp;&amp;</span>&nbsp;<span class="ident" id="3588513">requestMethod</span>&nbsp;<span class="op" id="3588527">==</span>&nbsp;<span class="string" id="3588530">&#34;GET&#34;</span>&nbsp;<span class="op" id="3588536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3588540">//&nbsp;RFC&nbsp;2616&nbsp;doesn&#39;t&nbsp;explicitly&nbsp;permit&nbsp;nor&nbsp;forbid&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3588594">//&nbsp;entity-body&nbsp;on&nbsp;a&nbsp;GET&nbsp;request&nbsp;so&nbsp;we&nbsp;permit&nbsp;one&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3588648">//&nbsp;declared,&nbsp;but&nbsp;we&nbsp;default&nbsp;to&nbsp;0&nbsp;here&nbsp;(not&nbsp;-1&nbsp;below)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3588703">//&nbsp;if&nbsp;there&#39;s&nbsp;no&nbsp;mention&nbsp;of&nbsp;a&nbsp;body.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3588741">return</span>&nbsp;<span class="num" id="3588748">0</span><span class="op" id="3588749">,</span>&nbsp;<span class="ident" id="3588751">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3588756">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3588760">//&nbsp;Body-EOF&nbsp;logic&nbsp;based&nbsp;on&nbsp;other&nbsp;methods&nbsp;(like&nbsp;closing,&nbsp;or&nbsp;chunked&nbsp;coding)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3588836">return</span>&nbsp;<span class="op" id="3588843">-</span><span class="num" id="3588844">1</span><span class="op" id="3588845">,</span>&nbsp;<span class="ident" id="3588847">nil</span><br>
<span class="lineno">500</span><span class="op" id="3588851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3588854">//&nbsp;Determine&nbsp;whether&nbsp;to&nbsp;hang&nbsp;up&nbsp;after&nbsp;sending&nbsp;a&nbsp;request&nbsp;and&nbsp;body,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="3588923">//&nbsp;receiving&nbsp;a&nbsp;response&nbsp;and&nbsp;body</span><br>
<span class="lineno"></span><span class="comment" id="3588956">//&nbsp;&#39;header&#39;&nbsp;is&nbsp;the&nbsp;request&nbsp;headers</span><br>
<span class="lineno">505</span><span class="keyword" id="3588991">func</span>&nbsp;<span class="ident" id="3588996">shouldClose</span><span class="op" id="3589007">(</span><span class="ident" id="3589008">major</span><span class="op" id="3589013">,</span>&nbsp;<span class="ident" id="3589015">minor</span>&nbsp;<span class="builtintype" id="3589021">int</span><span class="op" id="3589024">,</span>&nbsp;<span class="ident" id="3589026">header</span>&nbsp;<span class="ident" id="3589033">Header</span><span class="op" id="3589039">,</span>&nbsp;<span class="ident" id="3589041">removeCloseHeader</span>&nbsp;<span class="builtintype" id="3589059">bool</span><span class="op" id="3589063">)</span>&nbsp;<span class="builtintype" id="3589065">bool</span>&nbsp;<span class="op" id="3589070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3589073">if</span>&nbsp;<span class="ident" id="3589076">major</span>&nbsp;<span class="op" id="3589082">&lt;</span>&nbsp;<span class="num" id="3589084">1</span>&nbsp;<span class="op" id="3589086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3589090">return</span>&nbsp;<span class="builtintype" id="3589097">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3589103">}</span>&nbsp;<span class="keyword" id="3589105">else</span>&nbsp;<span class="keyword" id="3589110">if</span>&nbsp;<span class="ident" id="3589113">major</span>&nbsp;<span class="op" id="3589119">==</span>&nbsp;<span class="num" id="3589122">1</span>&nbsp;<span class="op" id="3589124">&amp;&amp;</span>&nbsp;<span class="ident" id="3589127">minor</span>&nbsp;<span class="op" id="3589133">==</span>&nbsp;<span class="num" id="3589136">0</span>&nbsp;<span class="op" id="3589138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3589142">if</span>&nbsp;<span class="op" id="3589145">!</span><span class="ident" id="3589146">strings</span><span class="op" id="3589153">.</span><span class="ident" id="3589154">Contains</span><span class="op" id="3589162">(</span><span class="ident" id="3589163">strings</span><span class="op" id="3589170">.</span><span class="ident" id="3589171">ToLower</span><span class="op" id="3589178">(</span><span class="ident" id="3589179">header</span><span class="op" id="3589185">.</span><span class="ident" id="3589186">get</span><span class="op" id="3589189">(</span><span class="string" id="3589190">&#34;Connection&#34;</span><span class="op" id="3589202">)</span><span class="op" id="3589203">)</span><span class="op" id="3589204">,</span>&nbsp;<span class="string" id="3589206">&#34;keep-alive&#34;</span><span class="op" id="3589218">)</span>&nbsp;<span class="op" id="3589220">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3589225">return</span>&nbsp;<span class="builtintype" id="3589232">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3589239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3589243">return</span>&nbsp;<span class="builtintype" id="3589250">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3589257">}</span>&nbsp;<span class="keyword" id="3589259">else</span>&nbsp;<span class="op" id="3589264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3589268">//&nbsp;TODO:&nbsp;Should&nbsp;split&nbsp;on&nbsp;commas,&nbsp;toss&nbsp;surrounding&nbsp;white&nbsp;space,</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3589333">//&nbsp;and&nbsp;check&nbsp;each&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3589360">if</span>&nbsp;<span class="ident" id="3589363">strings</span><span class="op" id="3589370">.</span><span class="ident" id="3589371">ToLower</span><span class="op" id="3589378">(</span><span class="ident" id="3589379">header</span><span class="op" id="3589385">.</span><span class="ident" id="3589386">get</span><span class="op" id="3589389">(</span><span class="string" id="3589390">&#34;Connection&#34;</span><span class="op" id="3589402">)</span><span class="op" id="3589403">)</span>&nbsp;<span class="op" id="3589405">==</span>&nbsp;<span class="string" id="3589408">&#34;close&#34;</span>&nbsp;<span class="op" id="3589416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3589421">if</span>&nbsp;<span class="ident" id="3589424">removeCloseHeader</span>&nbsp;<span class="op" id="3589442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3589448">header</span><span class="op" id="3589454">.</span><span class="ident" id="3589455">Del</span><span class="op" id="3589458">(</span><span class="string" id="3589459">&#34;Connection&#34;</span><span class="op" id="3589471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3589476">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3589481">return</span>&nbsp;<span class="builtintype" id="3589488">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3589495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3589498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3589501">return</span>&nbsp;<span class="builtintype" id="3589508">false</span><br>
<span class="lineno"></span><span class="op" id="3589514">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span><span class="comment" id="3589517">//&nbsp;Parse&nbsp;the&nbsp;trailer&nbsp;header</span><br>
<span class="lineno"></span><span class="keyword" id="3589545">func</span>&nbsp;<span class="ident" id="3589550">fixTrailer</span><span class="op" id="3589560">(</span><span class="ident" id="3589561">header</span>&nbsp;<span class="ident" id="3589568">Header</span><span class="op" id="3589574">,</span>&nbsp;<span class="ident" id="3589576">te</span>&nbsp;<span class="op" id="3589579">[</span><span class="op" id="3589580">]</span><span class="builtintype" id="3589581">string</span><span class="op" id="3589587">)</span>&nbsp;<span class="op" id="3589589">(</span><span class="ident" id="3589590">Header</span><span class="op" id="3589596">,</span>&nbsp;<span class="builtintype" id="3589598">error</span><span class="op" id="3589603">)</span>&nbsp;<span class="op" id="3589605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3589608">raw</span>&nbsp;<span class="op" id="3589612">:=</span>&nbsp;<span class="ident" id="3589615">header</span><span class="op" id="3589621">.</span><span class="ident" id="3589622">get</span><span class="op" id="3589625">(</span><span class="string" id="3589626">&#34;Trailer&#34;</span><span class="op" id="3589635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3589638">if</span>&nbsp;<span class="ident" id="3589641">raw</span>&nbsp;<span class="op" id="3589645">==</span>&nbsp;<span class="string" id="3589648">&#34;&#34;</span>&nbsp;<span class="op" id="3589651">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3589655">return</span>&nbsp;<span class="ident" id="3589662">nil</span><span class="op" id="3589665">,</span>&nbsp;<span class="ident" id="3589667">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3589672">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3589676">header</span><span class="op" id="3589682">.</span><span class="ident" id="3589683">Del</span><span class="op" id="3589686">(</span><span class="string" id="3589687">&#34;Trailer&#34;</span><span class="op" id="3589696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3589699">trailer</span>&nbsp;<span class="op" id="3589707">:=</span>&nbsp;<span class="builtinfunc" id="3589710">make</span><span class="op" id="3589714">(</span><span class="ident" id="3589715">Header</span><span class="op" id="3589721">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3589724">keys</span>&nbsp;<span class="op" id="3589729">:=</span>&nbsp;<span class="ident" id="3589732">strings</span><span class="op" id="3589739">.</span><span class="ident" id="3589740">Split</span><span class="op" id="3589745">(</span><span class="ident" id="3589746">raw</span><span class="op" id="3589749">,</span>&nbsp;<span class="string" id="3589751">&#34;,&#34;</span><span class="op" id="3589754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3589757">for</span>&nbsp;<span class="ident" id="3589761">_</span><span class="op" id="3589762">,</span>&nbsp;<span class="ident" id="3589764">key</span>&nbsp;<span class="op" id="3589768">:=</span>&nbsp;<span class="keyword" id="3589771">range</span>&nbsp;<span class="ident" id="3589777">keys</span>&nbsp;<span class="op" id="3589782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3589786">key</span>&nbsp;<span class="op" id="3589790">=</span>&nbsp;<span class="ident" id="3589792">CanonicalHeaderKey</span><span class="op" id="3589810">(</span><span class="ident" id="3589811">strings</span><span class="op" id="3589818">.</span><span class="ident" id="3589819">TrimSpace</span><span class="op" id="3589828">(</span><span class="ident" id="3589829">key</span><span class="op" id="3589832">)</span><span class="op" id="3589833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3589837">switch</span>&nbsp;<span class="ident" id="3589844">key</span>&nbsp;<span class="op" id="3589848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3589852">case</span>&nbsp;<span class="string" id="3589857">&#34;Transfer-Encoding&#34;</span><span class="op" id="3589876">,</span>&nbsp;<span class="string" id="3589878">&#34;Trailer&#34;</span><span class="op" id="3589887">,</span>&nbsp;<span class="string" id="3589889">&#34;Content-Length&#34;</span><span class="op" id="3589905">:</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3589910">return</span>&nbsp;<span class="ident" id="3589917">nil</span><span class="op" id="3589920">,</span>&nbsp;<span class="op" id="3589922">&amp;</span><span class="ident" id="3589923">badStringError</span><span class="op" id="3589937">{</span><span class="string" id="3589938">&#34;bad&nbsp;trailer&nbsp;key&#34;</span><span class="op" id="3589955">,</span>&nbsp;<span class="ident" id="3589957">key</span><span class="op" id="3589960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3589964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3589968">trailer</span><span class="op" id="3589975">[</span><span class="ident" id="3589976">key</span><span class="op" id="3589979">]</span>&nbsp;<span class="op" id="3589981">=</span>&nbsp;<span class="ident" id="3589983">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3589988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3589991">if</span>&nbsp;<span class="builtinfunc" id="3589994">len</span><span class="op" id="3589997">(</span><span class="ident" id="3589998">trailer</span><span class="op" id="3590005">)</span>&nbsp;<span class="op" id="3590007">==</span>&nbsp;<span class="num" id="3590010">0</span>&nbsp;<span class="op" id="3590012">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3590016">return</span>&nbsp;<span class="ident" id="3590023">nil</span><span class="op" id="3590026">,</span>&nbsp;<span class="ident" id="3590028">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3590033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3590036">if</span>&nbsp;<span class="op" id="3590039">!</span><span class="ident" id="3590040">chunked</span><span class="op" id="3590047">(</span><span class="ident" id="3590048">te</span><span class="op" id="3590050">)</span>&nbsp;<span class="op" id="3590052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3590056">//&nbsp;Trailer&nbsp;and&nbsp;no&nbsp;chunking</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3590085">return</span>&nbsp;<span class="ident" id="3590092">nil</span><span class="op" id="3590095">,</span>&nbsp;<span class="ident" id="3590097">ErrUnexpectedTrailer</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3590119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3590122">return</span>&nbsp;<span class="ident" id="3590129">trailer</span><span class="op" id="3590136">,</span>&nbsp;<span class="ident" id="3590138">nil</span><br>
<span class="lineno"></span><span class="op" id="3590142">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3590145">//&nbsp;body&nbsp;turns&nbsp;a&nbsp;Reader&nbsp;into&nbsp;a&nbsp;ReadCloser.</span><br>
<span class="lineno">555</span><span class="comment" id="3590187">//&nbsp;Close&nbsp;ensures&nbsp;that&nbsp;the&nbsp;body&nbsp;has&nbsp;been&nbsp;fully&nbsp;read</span><br>
<span class="lineno"></span><span class="comment" id="3590238">//&nbsp;and&nbsp;then&nbsp;reads&nbsp;the&nbsp;trailer&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="3590282">type</span>&nbsp;<span class="ident" id="3590287">body</span>&nbsp;<span class="keyword" id="3590292">struct</span>&nbsp;<span class="op" id="3590299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3590302">src</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3590310">io</span><span class="op" id="3590312">.</span><span class="ident" id="3590313">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3590321">hdr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3590329">interface</span><span class="op" id="3590338">{</span><span class="op" id="3590339">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3590343">//&nbsp;non-nil&nbsp;(Response&nbsp;or&nbsp;Request)&nbsp;value&nbsp;means&nbsp;read&nbsp;trailer</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3590402">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3590410">*</span><span class="ident" id="3590411">bufio</span><span class="op" id="3590416">.</span><span class="ident" id="3590417">Reader</span>&nbsp;<span class="comment" id="3590424">//&nbsp;underlying&nbsp;wire-format&nbsp;reader&nbsp;for&nbsp;the&nbsp;trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3590474">closing</span>&nbsp;<span class="builtintype" id="3590482">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3590496">//&nbsp;is&nbsp;the&nbsp;connection&nbsp;to&nbsp;be&nbsp;closed&nbsp;after&nbsp;reading&nbsp;body?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3590552">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3590559">sync</span><span class="op" id="3590563">.</span><span class="ident" id="3590564">Mutex</span>&nbsp;<span class="comment" id="3590570">//&nbsp;guards&nbsp;closed,&nbsp;and&nbsp;calls&nbsp;to&nbsp;Read&nbsp;and&nbsp;Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3590617">closed</span>&nbsp;<span class="builtintype" id="3590624">bool</span><br>
<span class="lineno">565</span><span class="op" id="3590629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3590632">//&nbsp;ErrBodyReadAfterClose&nbsp;is&nbsp;returned&nbsp;when&nbsp;reading&nbsp;a&nbsp;Request&nbsp;or&nbsp;Response</span><br>
<span class="lineno"></span><span class="comment" id="3590704">//&nbsp;Body&nbsp;after&nbsp;the&nbsp;body&nbsp;has&nbsp;been&nbsp;closed.&nbsp;This&nbsp;typically&nbsp;happens&nbsp;when&nbsp;the&nbsp;body&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3590784">//&nbsp;read&nbsp;after&nbsp;an&nbsp;HTTP&nbsp;Handler&nbsp;calls&nbsp;WriteHeader&nbsp;or&nbsp;Write&nbsp;on&nbsp;its</span><br>
<span class="lineno">570</span><span class="comment" id="3590848">//&nbsp;ResponseWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="3590867">var</span>&nbsp;<span class="ident" id="3590871">ErrBodyReadAfterClose</span>&nbsp;<span class="op" id="3590893">=</span>&nbsp;<span class="ident" id="3590895">errors</span><span class="op" id="3590901">.</span><span class="ident" id="3590902">New</span><span class="op" id="3590905">(</span><span class="string" id="3590906">&#34;http:&nbsp;invalid&nbsp;Read&nbsp;on&nbsp;closed&nbsp;Body&#34;</span><span class="op" id="3590941">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3590944">func</span>&nbsp;<span class="op" id="3590949">(</span><span class="ident" id="3590950">b</span>&nbsp;<span class="op" id="3590952">*</span><span class="ident" id="3590953">body</span><span class="op" id="3590957">)</span>&nbsp;<span class="ident" id="3590959">Read</span><span class="op" id="3590963">(</span><span class="ident" id="3590964">p</span>&nbsp;<span class="op" id="3590966">[</span><span class="op" id="3590967">]</span><span class="builtintype" id="3590968">byte</span><span class="op" id="3590972">)</span>&nbsp;<span class="op" id="3590974">(</span><span class="ident" id="3590975">n</span>&nbsp;<span class="builtintype" id="3590977">int</span><span class="op" id="3590980">,</span>&nbsp;<span class="ident" id="3590982">err</span>&nbsp;<span class="builtintype" id="3590986">error</span><span class="op" id="3590991">)</span>&nbsp;<span class="op" id="3590993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3590996">b</span><span class="op" id="3590997">.</span><span class="ident" id="3590998">mu</span><span class="op" id="3591000">.</span><span class="ident" id="3591001">Lock</span><span class="op" id="3591005">(</span><span class="op" id="3591006">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3591009">defer</span>&nbsp;<span class="ident" id="3591015">b</span><span class="op" id="3591016">.</span><span class="ident" id="3591017">mu</span><span class="op" id="3591019">.</span><span class="ident" id="3591020">Unlock</span><span class="op" id="3591026">(</span><span class="op" id="3591027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3591030">if</span>&nbsp;<span class="ident" id="3591033">b</span><span class="op" id="3591034">.</span><span class="ident" id="3591035">closed</span>&nbsp;<span class="op" id="3591042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3591046">return</span>&nbsp;<span class="num" id="3591053">0</span><span class="op" id="3591054">,</span>&nbsp;<span class="ident" id="3591056">ErrBodyReadAfterClose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3591079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3591082">return</span>&nbsp;<span class="ident" id="3591089">b</span><span class="op" id="3591090">.</span><span class="ident" id="3591091">readLocked</span><span class="op" id="3591101">(</span><span class="ident" id="3591102">p</span><span class="op" id="3591103">)</span><br>
<span class="lineno">580</span><span class="op" id="3591105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3591108">//&nbsp;Must&nbsp;hold&nbsp;b.mu.</span><br>
<span class="lineno"></span><span class="keyword" id="3591127">func</span>&nbsp;<span class="op" id="3591132">(</span><span class="ident" id="3591133">b</span>&nbsp;<span class="op" id="3591135">*</span><span class="ident" id="3591136">body</span><span class="op" id="3591140">)</span>&nbsp;<span class="ident" id="3591142">readLocked</span><span class="op" id="3591152">(</span><span class="ident" id="3591153">p</span>&nbsp;<span class="op" id="3591155">[</span><span class="op" id="3591156">]</span><span class="builtintype" id="3591157">byte</span><span class="op" id="3591161">)</span>&nbsp;<span class="op" id="3591163">(</span><span class="ident" id="3591164">n</span>&nbsp;<span class="builtintype" id="3591166">int</span><span class="op" id="3591169">,</span>&nbsp;<span class="ident" id="3591171">err</span>&nbsp;<span class="builtintype" id="3591175">error</span><span class="op" id="3591180">)</span>&nbsp;<span class="op" id="3591182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3591185">n</span><span class="op" id="3591186">,</span>&nbsp;<span class="ident" id="3591188">err</span>&nbsp;<span class="op" id="3591192">=</span>&nbsp;<span class="ident" id="3591194">b</span><span class="op" id="3591195">.</span><span class="ident" id="3591196">src</span><span class="op" id="3591199">.</span><span class="ident" id="3591200">Read</span><span class="op" id="3591204">(</span><span class="ident" id="3591205">p</span><span class="op" id="3591206">)</span><br>
<span class="lineno">585</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3591210">if</span>&nbsp;<span class="ident" id="3591213">err</span>&nbsp;<span class="op" id="3591217">==</span>&nbsp;<span class="ident" id="3591220">io</span><span class="op" id="3591222">.</span><span class="ident" id="3591223">EOF</span>&nbsp;<span class="op" id="3591227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3591231">//&nbsp;Chunked&nbsp;case.&nbsp;Read&nbsp;the&nbsp;trailer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3591268">if</span>&nbsp;<span class="ident" id="3591271">b</span><span class="op" id="3591272">.</span><span class="ident" id="3591273">hdr</span>&nbsp;<span class="op" id="3591277">!=</span>&nbsp;<span class="ident" id="3591280">nil</span>&nbsp;<span class="op" id="3591284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3591289">if</span>&nbsp;<span class="ident" id="3591292">e</span>&nbsp;<span class="op" id="3591294">:=</span>&nbsp;<span class="ident" id="3591297">b</span><span class="op" id="3591298">.</span><span class="ident" id="3591299">readTrailer</span><span class="op" id="3591310">(</span><span class="op" id="3591311">)</span><span class="op" id="3591312">;</span>&nbsp;<span class="ident" id="3591314">e</span>&nbsp;<span class="op" id="3591316">!=</span>&nbsp;<span class="ident" id="3591319">nil</span>&nbsp;<span class="op" id="3591323">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3591329">err</span>&nbsp;<span class="op" id="3591333">=</span>&nbsp;<span class="ident" id="3591335">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3591340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3591345">b</span><span class="op" id="3591346">.</span><span class="ident" id="3591347">hdr</span>&nbsp;<span class="op" id="3591351">=</span>&nbsp;<span class="ident" id="3591353">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3591359">}</span>&nbsp;<span class="keyword" id="3591361">else</span>&nbsp;<span class="op" id="3591366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3591371">//&nbsp;If&nbsp;the&nbsp;server&nbsp;declared&nbsp;the&nbsp;Content-Length,&nbsp;our&nbsp;body&nbsp;is&nbsp;a&nbsp;LimitedReader</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3591448">//&nbsp;and&nbsp;we&nbsp;need&nbsp;to&nbsp;check&nbsp;whether&nbsp;this&nbsp;EOF&nbsp;arrived&nbsp;early.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3591507">if</span>&nbsp;<span class="ident" id="3591510">lr</span><span class="op" id="3591512">,</span>&nbsp;<span class="ident" id="3591514">ok</span>&nbsp;<span class="op" id="3591517">:=</span>&nbsp;<span class="ident" id="3591520">b</span><span class="op" id="3591521">.</span><span class="ident" id="3591522">src</span><span class="op" id="3591525">.</span><span class="op" id="3591526">(</span><span class="op" id="3591527">*</span><span class="ident" id="3591528">io</span><span class="op" id="3591530">.</span><span class="ident" id="3591531">LimitedReader</span><span class="op" id="3591544">)</span><span class="op" id="3591545">;</span>&nbsp;<span class="ident" id="3591547">ok</span>&nbsp;<span class="op" id="3591550">&amp;&amp;</span>&nbsp;<span class="ident" id="3591553">lr</span><span class="op" id="3591555">.</span><span class="ident" id="3591556">N</span>&nbsp;<span class="op" id="3591558">&gt;</span>&nbsp;<span class="num" id="3591560">0</span>&nbsp;<span class="op" id="3591562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3591568">err</span>&nbsp;<span class="op" id="3591572">=</span>&nbsp;<span class="ident" id="3591574">io</span><span class="op" id="3591576">.</span><span class="ident" id="3591577">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3591597">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3591601">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3591604">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3591608">//&nbsp;If&nbsp;we&nbsp;can&nbsp;return&nbsp;an&nbsp;EOF&nbsp;here&nbsp;along&nbsp;with&nbsp;the&nbsp;read&nbsp;data,&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3591670">//&nbsp;so.&nbsp;This&nbsp;is&nbsp;optional&nbsp;per&nbsp;the&nbsp;io.Reader&nbsp;contract,&nbsp;but&nbsp;doing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3591733">//&nbsp;so&nbsp;helps&nbsp;the&nbsp;HTTP&nbsp;transport&nbsp;code&nbsp;recycle&nbsp;its&nbsp;connection</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3591793">//&nbsp;earlier&nbsp;(since&nbsp;it&nbsp;will&nbsp;see&nbsp;this&nbsp;EOF&nbsp;itself),&nbsp;even&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3591854">//&nbsp;client&nbsp;doesn&#39;t&nbsp;do&nbsp;future&nbsp;reads&nbsp;or&nbsp;Close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3591899">if</span>&nbsp;<span class="ident" id="3591902">err</span>&nbsp;<span class="op" id="3591906">==</span>&nbsp;<span class="ident" id="3591909">nil</span>&nbsp;<span class="op" id="3591913">&amp;&amp;</span>&nbsp;<span class="ident" id="3591916">n</span>&nbsp;<span class="op" id="3591918">&gt;</span>&nbsp;<span class="num" id="3591920">0</span>&nbsp;<span class="op" id="3591922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3591926">if</span>&nbsp;<span class="ident" id="3591929">lr</span><span class="op" id="3591931">,</span>&nbsp;<span class="ident" id="3591933">ok</span>&nbsp;<span class="op" id="3591936">:=</span>&nbsp;<span class="ident" id="3591939">b</span><span class="op" id="3591940">.</span><span class="ident" id="3591941">src</span><span class="op" id="3591944">.</span><span class="op" id="3591945">(</span><span class="op" id="3591946">*</span><span class="ident" id="3591947">io</span><span class="op" id="3591949">.</span><span class="ident" id="3591950">LimitedReader</span><span class="op" id="3591963">)</span><span class="op" id="3591964">;</span>&nbsp;<span class="ident" id="3591966">ok</span>&nbsp;<span class="op" id="3591969">&amp;&amp;</span>&nbsp;<span class="ident" id="3591972">lr</span><span class="op" id="3591974">.</span><span class="ident" id="3591975">N</span>&nbsp;<span class="op" id="3591977">==</span>&nbsp;<span class="num" id="3591980">0</span>&nbsp;<span class="op" id="3591982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3591987">err</span>&nbsp;<span class="op" id="3591991">=</span>&nbsp;<span class="ident" id="3591993">io</span><span class="op" id="3591995">.</span><span class="ident" id="3591996">EOF</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3592002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3592005">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3592009">return</span>&nbsp;<span class="ident" id="3592016">n</span><span class="op" id="3592017">,</span>&nbsp;<span class="ident" id="3592019">err</span><br>
<span class="lineno"></span><span class="op" id="3592023">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span><span class="keyword" id="3592026">var</span>&nbsp;<span class="op" id="3592030">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3592033">singleCRLF</span>&nbsp;<span class="op" id="3592044">=</span>&nbsp;<span class="op" id="3592046">[</span><span class="op" id="3592047">]</span><span class="builtintype" id="3592048">byte</span><span class="op" id="3592052">(</span><span class="string" id="3592053">&#34;\r\n&#34;</span><span class="op" id="3592059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3592062">doubleCRLF</span>&nbsp;<span class="op" id="3592073">=</span>&nbsp;<span class="op" id="3592075">[</span><span class="op" id="3592076">]</span><span class="builtintype" id="3592077">byte</span><span class="op" id="3592081">(</span><span class="string" id="3592082">&#34;\r\n\r\n&#34;</span><span class="op" id="3592092">)</span><br>
<span class="lineno"></span><span class="op" id="3592094">)</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="keyword" id="3592097">func</span>&nbsp;<span class="ident" id="3592102">seeUpcomingDoubleCRLF</span><span class="op" id="3592123">(</span><span class="ident" id="3592124">r</span>&nbsp;<span class="op" id="3592126">*</span><span class="ident" id="3592127">bufio</span><span class="op" id="3592132">.</span><span class="ident" id="3592133">Reader</span><span class="op" id="3592139">)</span>&nbsp;<span class="builtintype" id="3592141">bool</span>&nbsp;<span class="op" id="3592146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3592149">for</span>&nbsp;<span class="ident" id="3592153">peekSize</span>&nbsp;<span class="op" id="3592162">:=</span>&nbsp;<span class="num" id="3592165">4</span><span class="op" id="3592166">;</span>&nbsp;<span class="op" id="3592168">;</span>&nbsp;<span class="ident" id="3592170">peekSize</span><span class="op" id="3592178">++</span>&nbsp;<span class="op" id="3592181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3592185">//&nbsp;This&nbsp;loop&nbsp;stops&nbsp;when&nbsp;Peek&nbsp;returns&nbsp;an&nbsp;error,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3592234">//&nbsp;which&nbsp;it&nbsp;does&nbsp;when&nbsp;r&#39;s&nbsp;buffer&nbsp;has&nbsp;been&nbsp;filled.</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3592286">buf</span><span class="op" id="3592289">,</span>&nbsp;<span class="ident" id="3592291">err</span>&nbsp;<span class="op" id="3592295">:=</span>&nbsp;<span class="ident" id="3592298">r</span><span class="op" id="3592299">.</span><span class="ident" id="3592300">Peek</span><span class="op" id="3592304">(</span><span class="ident" id="3592305">peekSize</span><span class="op" id="3592313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3592317">if</span>&nbsp;<span class="ident" id="3592320">bytes</span><span class="op" id="3592325">.</span><span class="ident" id="3592326">HasSuffix</span><span class="op" id="3592335">(</span><span class="ident" id="3592336">buf</span><span class="op" id="3592339">,</span>&nbsp;<span class="ident" id="3592341">doubleCRLF</span><span class="op" id="3592351">)</span>&nbsp;<span class="op" id="3592353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3592358">return</span>&nbsp;<span class="builtintype" id="3592365">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3592372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3592376">if</span>&nbsp;<span class="ident" id="3592379">err</span>&nbsp;<span class="op" id="3592383">!=</span>&nbsp;<span class="ident" id="3592386">nil</span>&nbsp;<span class="op" id="3592390">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3592395">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3592403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3592406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3592409">return</span>&nbsp;<span class="builtintype" id="3592416">false</span><br>
<span class="lineno"></span><span class="op" id="3592422">}</span><br>
<span class="lineno">635</span><br>
<span class="lineno"></span><span class="keyword" id="3592425">var</span>&nbsp;<span class="ident" id="3592429">errTrailerEOF</span>&nbsp;<span class="op" id="3592443">=</span>&nbsp;<span class="ident" id="3592445">errors</span><span class="op" id="3592451">.</span><span class="ident" id="3592452">New</span><span class="op" id="3592455">(</span><span class="string" id="3592456">&#34;http:&nbsp;unexpected&nbsp;EOF&nbsp;reading&nbsp;trailer&#34;</span><span class="op" id="3592494">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3592497">func</span>&nbsp;<span class="op" id="3592502">(</span><span class="ident" id="3592503">b</span>&nbsp;<span class="op" id="3592505">*</span><span class="ident" id="3592506">body</span><span class="op" id="3592510">)</span>&nbsp;<span class="ident" id="3592512">readTrailer</span><span class="op" id="3592523">(</span><span class="op" id="3592524">)</span>&nbsp;<span class="builtintype" id="3592526">error</span>&nbsp;<span class="op" id="3592532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3592535">//&nbsp;The&nbsp;common&nbsp;case,&nbsp;since&nbsp;nobody&nbsp;uses&nbsp;trailers.</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3592584">buf</span><span class="op" id="3592587">,</span>&nbsp;<span class="ident" id="3592589">err</span>&nbsp;<span class="op" id="3592593">:=</span>&nbsp;<span class="ident" id="3592596">b</span><span class="op" id="3592597">.</span><span class="ident" id="3592598">r</span><span class="op" id="3592599">.</span><span class="ident" id="3592600">Peek</span><span class="op" id="3592604">(</span><span class="num" id="3592605">2</span><span class="op" id="3592606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3592609">if</span>&nbsp;<span class="ident" id="3592612">bytes</span><span class="op" id="3592617">.</span><span class="ident" id="3592618">Equal</span><span class="op" id="3592623">(</span><span class="ident" id="3592624">buf</span><span class="op" id="3592627">,</span>&nbsp;<span class="ident" id="3592629">singleCRLF</span><span class="op" id="3592639">)</span>&nbsp;<span class="op" id="3592641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3592645">b</span><span class="op" id="3592646">.</span><span class="ident" id="3592647">r</span><span class="op" id="3592648">.</span><span class="ident" id="3592649">ReadByte</span><span class="op" id="3592657">(</span><span class="op" id="3592658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3592662">b</span><span class="op" id="3592663">.</span><span class="ident" id="3592664">r</span><span class="op" id="3592665">.</span><span class="ident" id="3592666">ReadByte</span><span class="op" id="3592674">(</span><span class="op" id="3592675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3592679">return</span>&nbsp;<span class="ident" id="3592686">nil</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3592691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3592694">if</span>&nbsp;<span class="builtinfunc" id="3592697">len</span><span class="op" id="3592700">(</span><span class="ident" id="3592701">buf</span><span class="op" id="3592704">)</span>&nbsp;<span class="op" id="3592706">&lt;</span>&nbsp;<span class="num" id="3592708">2</span>&nbsp;<span class="op" id="3592710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3592714">return</span>&nbsp;<span class="ident" id="3592721">errTrailerEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3592736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3592739">if</span>&nbsp;<span class="ident" id="3592742">err</span>&nbsp;<span class="op" id="3592746">!=</span>&nbsp;<span class="ident" id="3592749">nil</span>&nbsp;<span class="op" id="3592753">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3592757">return</span>&nbsp;<span class="ident" id="3592764">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3592769">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3592773">//&nbsp;Make&nbsp;sure&nbsp;there&#39;s&nbsp;a&nbsp;header&nbsp;terminator&nbsp;coming&nbsp;up,&nbsp;to&nbsp;prevent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3592837">//&nbsp;a&nbsp;DoS&nbsp;with&nbsp;an&nbsp;unbounded&nbsp;size&nbsp;Trailer.&nbsp;&nbsp;It&#39;s&nbsp;not&nbsp;easy&nbsp;to</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3592897">//&nbsp;slip&nbsp;in&nbsp;a&nbsp;LimitReader&nbsp;here,&nbsp;as&nbsp;textproto.NewReader&nbsp;requires</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3592961">//&nbsp;a&nbsp;concrete&nbsp;*bufio.Reader.&nbsp;&nbsp;Also,&nbsp;we&nbsp;can&#39;t&nbsp;get&nbsp;all&nbsp;the&nbsp;way</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3593023">//&nbsp;back&nbsp;up&nbsp;to&nbsp;our&nbsp;conn&#39;s&nbsp;LimitedReader&nbsp;that&nbsp;*might*&nbsp;be&nbsp;backing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3593087">//&nbsp;this&nbsp;bufio.Reader.&nbsp;&nbsp;Instead,&nbsp;a&nbsp;hack:&nbsp;we&nbsp;iteratively&nbsp;Peek&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3593151">//&nbsp;to&nbsp;the&nbsp;bufio.Reader&#39;s&nbsp;max&nbsp;size,&nbsp;looking&nbsp;for&nbsp;a&nbsp;double&nbsp;CRLF.</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3593214">//&nbsp;This&nbsp;limits&nbsp;the&nbsp;trailer&nbsp;to&nbsp;the&nbsp;underlying&nbsp;buffer&nbsp;size,&nbsp;typically&nbsp;4kB.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3593288">if</span>&nbsp;<span class="op" id="3593291">!</span><span class="ident" id="3593292">seeUpcomingDoubleCRLF</span><span class="op" id="3593313">(</span><span class="ident" id="3593314">b</span><span class="op" id="3593315">.</span><span class="ident" id="3593316">r</span><span class="op" id="3593317">)</span>&nbsp;<span class="op" id="3593319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3593323">return</span>&nbsp;<span class="ident" id="3593330">errors</span><span class="op" id="3593336">.</span><span class="ident" id="3593337">New</span><span class="op" id="3593340">(</span><span class="string" id="3593341">&#34;http:&nbsp;suspiciously&nbsp;long&nbsp;trailer&nbsp;after&nbsp;chunked&nbsp;body&#34;</span><span class="op" id="3593393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3593396">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3593400">hdr</span><span class="op" id="3593403">,</span>&nbsp;<span class="ident" id="3593405">err</span>&nbsp;<span class="op" id="3593409">:=</span>&nbsp;<span class="ident" id="3593412">textproto</span><span class="op" id="3593421">.</span><span class="ident" id="3593422">NewReader</span><span class="op" id="3593431">(</span><span class="ident" id="3593432">b</span><span class="op" id="3593433">.</span><span class="ident" id="3593434">r</span><span class="op" id="3593435">)</span><span class="op" id="3593436">.</span><span class="ident" id="3593437">ReadMIMEHeader</span><span class="op" id="3593451">(</span><span class="op" id="3593452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3593455">if</span>&nbsp;<span class="ident" id="3593458">err</span>&nbsp;<span class="op" id="3593462">!=</span>&nbsp;<span class="ident" id="3593465">nil</span>&nbsp;<span class="op" id="3593469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3593473">if</span>&nbsp;<span class="ident" id="3593476">err</span>&nbsp;<span class="op" id="3593480">==</span>&nbsp;<span class="ident" id="3593483">io</span><span class="op" id="3593485">.</span><span class="ident" id="3593486">EOF</span>&nbsp;<span class="op" id="3593490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3593495">return</span>&nbsp;<span class="ident" id="3593502">errTrailerEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3593518">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3593522">return</span>&nbsp;<span class="ident" id="3593529">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3593534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3593537">switch</span>&nbsp;<span class="ident" id="3593544">rr</span>&nbsp;<span class="op" id="3593547">:=</span>&nbsp;<span class="ident" id="3593550">b</span><span class="op" id="3593551">.</span><span class="ident" id="3593552">hdr</span><span class="op" id="3593555">.</span><span class="op" id="3593556">(</span><span class="keyword" id="3593557">type</span><span class="op" id="3593561">)</span>&nbsp;<span class="op" id="3593563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3593566">case</span>&nbsp;<span class="op" id="3593571">*</span><span class="ident" id="3593572">Request</span><span class="op" id="3593579">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3593583">mergeSetHeader</span><span class="op" id="3593597">(</span><span class="op" id="3593598">&amp;</span><span class="ident" id="3593599">rr</span><span class="op" id="3593601">.</span><span class="ident" id="3593602">Trailer</span><span class="op" id="3593609">,</span>&nbsp;<span class="ident" id="3593611">Header</span><span class="op" id="3593617">(</span><span class="ident" id="3593618">hdr</span><span class="op" id="3593621">)</span><span class="op" id="3593622">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3593625">case</span>&nbsp;<span class="op" id="3593630">*</span><span class="ident" id="3593631">Response</span><span class="op" id="3593639">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3593643">mergeSetHeader</span><span class="op" id="3593657">(</span><span class="op" id="3593658">&amp;</span><span class="ident" id="3593659">rr</span><span class="op" id="3593661">.</span><span class="ident" id="3593662">Trailer</span><span class="op" id="3593669">,</span>&nbsp;<span class="ident" id="3593671">Header</span><span class="op" id="3593677">(</span><span class="ident" id="3593678">hdr</span><span class="op" id="3593681">)</span><span class="op" id="3593682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3593685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3593688">return</span>&nbsp;<span class="ident" id="3593695">nil</span><br>
<span class="lineno"></span><span class="op" id="3593699">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="3593702">func</span>&nbsp;<span class="ident" id="3593707">mergeSetHeader</span><span class="op" id="3593721">(</span><span class="ident" id="3593722">dst</span>&nbsp;<span class="op" id="3593726">*</span><span class="ident" id="3593727">Header</span><span class="op" id="3593733">,</span>&nbsp;<span class="ident" id="3593735">src</span>&nbsp;<span class="ident" id="3593739">Header</span><span class="op" id="3593745">)</span>&nbsp;<span class="op" id="3593747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3593750">if</span>&nbsp;<span class="op" id="3593753">*</span><span class="ident" id="3593754">dst</span>&nbsp;<span class="op" id="3593758">==</span>&nbsp;<span class="ident" id="3593761">nil</span>&nbsp;<span class="op" id="3593765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3593769">*</span><span class="ident" id="3593770">dst</span>&nbsp;<span class="op" id="3593774">=</span>&nbsp;<span class="ident" id="3593776">src</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3593782">return</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3593790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3593793">for</span>&nbsp;<span class="ident" id="3593797">k</span><span class="op" id="3593798">,</span>&nbsp;<span class="ident" id="3593800">vv</span>&nbsp;<span class="op" id="3593803">:=</span>&nbsp;<span class="keyword" id="3593806">range</span>&nbsp;<span class="ident" id="3593812">src</span>&nbsp;<span class="op" id="3593816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3593820">(</span><span class="op" id="3593821">*</span><span class="ident" id="3593822">dst</span><span class="op" id="3593825">)</span><span class="op" id="3593826">[</span><span class="ident" id="3593827">k</span><span class="op" id="3593828">]</span>&nbsp;<span class="op" id="3593830">=</span>&nbsp;<span class="ident" id="3593832">vv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3593836">}</span><br>
<span class="lineno"></span><span class="op" id="3593838">}</span><br>
<span class="lineno">690</span><br>
<span class="lineno"></span><span class="keyword" id="3593841">func</span>&nbsp;<span class="op" id="3593846">(</span><span class="ident" id="3593847">b</span>&nbsp;<span class="op" id="3593849">*</span><span class="ident" id="3593850">body</span><span class="op" id="3593854">)</span>&nbsp;<span class="ident" id="3593856">Close</span><span class="op" id="3593861">(</span><span class="op" id="3593862">)</span>&nbsp;<span class="builtintype" id="3593864">error</span>&nbsp;<span class="op" id="3593870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3593873">b</span><span class="op" id="3593874">.</span><span class="ident" id="3593875">mu</span><span class="op" id="3593877">.</span><span class="ident" id="3593878">Lock</span><span class="op" id="3593882">(</span><span class="op" id="3593883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3593886">defer</span>&nbsp;<span class="ident" id="3593892">b</span><span class="op" id="3593893">.</span><span class="ident" id="3593894">mu</span><span class="op" id="3593896">.</span><span class="ident" id="3593897">Unlock</span><span class="op" id="3593903">(</span><span class="op" id="3593904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3593907">if</span>&nbsp;<span class="ident" id="3593910">b</span><span class="op" id="3593911">.</span><span class="ident" id="3593912">closed</span>&nbsp;<span class="op" id="3593919">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3593923">return</span>&nbsp;<span class="ident" id="3593930">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3593935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3593938">var</span>&nbsp;<span class="ident" id="3593942">err</span>&nbsp;<span class="builtintype" id="3593946">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3593953">switch</span>&nbsp;<span class="op" id="3593960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3593963">case</span>&nbsp;<span class="ident" id="3593968">b</span><span class="op" id="3593969">.</span><span class="ident" id="3593970">hdr</span>&nbsp;<span class="op" id="3593974">==</span>&nbsp;<span class="ident" id="3593977">nil</span>&nbsp;<span class="op" id="3593981">&amp;&amp;</span>&nbsp;<span class="ident" id="3593984">b</span><span class="op" id="3593985">.</span><span class="ident" id="3593986">closing</span><span class="op" id="3593993">:</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3593997">//&nbsp;no&nbsp;trailer&nbsp;and&nbsp;closing&nbsp;the&nbsp;connection&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3594046">//&nbsp;no&nbsp;point&nbsp;in&nbsp;reading&nbsp;to&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3594078">default</span><span class="op" id="3594085">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3594089">//&nbsp;Fully&nbsp;consume&nbsp;the&nbsp;body,&nbsp;which&nbsp;will&nbsp;also&nbsp;lead&nbsp;to&nbsp;us&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3594153">//&nbsp;the&nbsp;trailer&nbsp;headers&nbsp;after&nbsp;the&nbsp;body,&nbsp;if&nbsp;present.</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3594206">_</span><span class="op" id="3594207">,</span>&nbsp;<span class="ident" id="3594209">err</span>&nbsp;<span class="op" id="3594213">=</span>&nbsp;<span class="ident" id="3594215">io</span><span class="op" id="3594217">.</span><span class="ident" id="3594218">Copy</span><span class="op" id="3594222">(</span><span class="ident" id="3594223">ioutil</span><span class="op" id="3594229">.</span><span class="ident" id="3594230">Discard</span><span class="op" id="3594237">,</span>&nbsp;<span class="ident" id="3594239">bodyLocked</span><span class="op" id="3594249">{</span><span class="ident" id="3594250">b</span><span class="op" id="3594251">}</span><span class="op" id="3594252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3594255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3594258">b</span><span class="op" id="3594259">.</span><span class="ident" id="3594260">closed</span>&nbsp;<span class="op" id="3594267">=</span>&nbsp;<span class="builtintype" id="3594269">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3594275">return</span>&nbsp;<span class="ident" id="3594282">err</span><br>
<span class="lineno"></span><span class="op" id="3594286">}</span><br>
<span class="lineno">710</span><br>
<span class="lineno"></span><span class="comment" id="3594289">//&nbsp;bodyLocked&nbsp;is&nbsp;a&nbsp;io.Reader&nbsp;reading&nbsp;from&nbsp;a&nbsp;*body&nbsp;when&nbsp;its&nbsp;mutex&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3594357">//&nbsp;already&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="3594374">type</span>&nbsp;<span class="ident" id="3594379">bodyLocked</span>&nbsp;<span class="keyword" id="3594390">struct</span>&nbsp;<span class="op" id="3594397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3594400">b</span>&nbsp;<span class="op" id="3594402">*</span><span class="ident" id="3594403">body</span><br>
<span class="lineno">715</span><span class="op" id="3594408">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3594411">func</span>&nbsp;<span class="op" id="3594416">(</span><span class="ident" id="3594417">bl</span>&nbsp;<span class="ident" id="3594420">bodyLocked</span><span class="op" id="3594430">)</span>&nbsp;<span class="ident" id="3594432">Read</span><span class="op" id="3594436">(</span><span class="ident" id="3594437">p</span>&nbsp;<span class="op" id="3594439">[</span><span class="op" id="3594440">]</span><span class="builtintype" id="3594441">byte</span><span class="op" id="3594445">)</span>&nbsp;<span class="op" id="3594447">(</span><span class="ident" id="3594448">n</span>&nbsp;<span class="builtintype" id="3594450">int</span><span class="op" id="3594453">,</span>&nbsp;<span class="ident" id="3594455">err</span>&nbsp;<span class="builtintype" id="3594459">error</span><span class="op" id="3594464">)</span>&nbsp;<span class="op" id="3594466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3594469">if</span>&nbsp;<span class="ident" id="3594472">bl</span><span class="op" id="3594474">.</span><span class="ident" id="3594475">b</span><span class="op" id="3594476">.</span><span class="ident" id="3594477">closed</span>&nbsp;<span class="op" id="3594484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3594488">return</span>&nbsp;<span class="num" id="3594495">0</span><span class="op" id="3594496">,</span>&nbsp;<span class="ident" id="3594498">ErrBodyReadAfterClose</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3594521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3594524">return</span>&nbsp;<span class="ident" id="3594531">bl</span><span class="op" id="3594533">.</span><span class="ident" id="3594534">b</span><span class="op" id="3594535">.</span><span class="ident" id="3594536">readLocked</span><span class="op" id="3594546">(</span><span class="ident" id="3594547">p</span><span class="op" id="3594548">)</span><br>
<span class="lineno"></span><span class="op" id="3594550">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3594553">//&nbsp;parseContentLength&nbsp;trims&nbsp;whitespace&nbsp;from&nbsp;s&nbsp;and&nbsp;returns&nbsp;-1&nbsp;if&nbsp;no&nbsp;value</span><br>
<span class="lineno">725</span><span class="comment" id="3594626">//&nbsp;is&nbsp;set,&nbsp;or&nbsp;the&nbsp;value&nbsp;if&nbsp;it&#39;s&nbsp;&gt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="3594664">func</span>&nbsp;<span class="ident" id="3594669">parseContentLength</span><span class="op" id="3594687">(</span><span class="ident" id="3594688">cl</span>&nbsp;<span class="builtintype" id="3594691">string</span><span class="op" id="3594697">)</span>&nbsp;<span class="op" id="3594699">(</span><span class="ident" id="3594700">int64</span><span class="op" id="3594705">,</span>&nbsp;<span class="builtintype" id="3594707">error</span><span class="op" id="3594712">)</span>&nbsp;<span class="op" id="3594714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3594717">cl</span>&nbsp;<span class="op" id="3594720">=</span>&nbsp;<span class="ident" id="3594722">strings</span><span class="op" id="3594729">.</span><span class="ident" id="3594730">TrimSpace</span><span class="op" id="3594739">(</span><span class="ident" id="3594740">cl</span><span class="op" id="3594742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3594745">if</span>&nbsp;<span class="ident" id="3594748">cl</span>&nbsp;<span class="op" id="3594751">==</span>&nbsp;<span class="string" id="3594754">&#34;&#34;</span>&nbsp;<span class="op" id="3594757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3594761">return</span>&nbsp;<span class="op" id="3594768">-</span><span class="num" id="3594769">1</span><span class="op" id="3594770">,</span>&nbsp;<span class="ident" id="3594772">nil</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3594777">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3594780">n</span><span class="op" id="3594781">,</span>&nbsp;<span class="ident" id="3594783">err</span>&nbsp;<span class="op" id="3594787">:=</span>&nbsp;<span class="ident" id="3594790">strconv</span><span class="op" id="3594797">.</span><span class="ident" id="3594798">ParseInt</span><span class="op" id="3594806">(</span><span class="ident" id="3594807">cl</span><span class="op" id="3594809">,</span>&nbsp;<span class="num" id="3594811">10</span><span class="op" id="3594813">,</span>&nbsp;<span class="num" id="3594815">64</span><span class="op" id="3594817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3594820">if</span>&nbsp;<span class="ident" id="3594823">err</span>&nbsp;<span class="op" id="3594827">!=</span>&nbsp;<span class="ident" id="3594830">nil</span>&nbsp;<span class="op" id="3594834">||</span>&nbsp;<span class="ident" id="3594837">n</span>&nbsp;<span class="op" id="3594839">&lt;</span>&nbsp;<span class="num" id="3594841">0</span>&nbsp;<span class="op" id="3594843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3594847">return</span>&nbsp;<span class="num" id="3594854">0</span><span class="op" id="3594855">,</span>&nbsp;<span class="op" id="3594857">&amp;</span><span class="ident" id="3594858">badStringError</span><span class="op" id="3594872">{</span><span class="string" id="3594873">&#34;bad&nbsp;Content-Length&#34;</span><span class="op" id="3594893">,</span>&nbsp;<span class="ident" id="3594895">cl</span><span class="op" id="3594897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3594900">}</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3594903">return</span>&nbsp;<span class="ident" id="3594910">n</span><span class="op" id="3594911">,</span>&nbsp;<span class="ident" id="3594913">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="op" id="3594918">}</span>
</div>
</body>
</html>
