<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment">//go:generate&nbsp;go&nbsp;run&nbsp;decgen.go&nbsp;-output&nbsp;dec_helpers.go</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">package</span>&nbsp;<span class="ident">gob</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;math&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;reflect&#34;</span><br>
<span class="lineno">15</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errBadUint</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;gob:&nbsp;encoded&nbsp;unsigned&nbsp;integer&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errBadType</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;gob:&nbsp;unknown&nbsp;type&nbsp;id&nbsp;or&nbsp;corrupted&nbsp;data&#34;</span><span class="op">)</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errRange</span>&nbsp;&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;gob:&nbsp;bad&nbsp;data:&nbsp;field&nbsp;numbers&nbsp;out&nbsp;of&nbsp;bounds&#34;</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">decHelper</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">,</span>&nbsp;<span class="ident">length</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">ovfl</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment">//&nbsp;decoderState&nbsp;is&nbsp;the&nbsp;execution&nbsp;state&nbsp;of&nbsp;an&nbsp;instance&nbsp;of&nbsp;the&nbsp;decoder.&nbsp;A&nbsp;new&nbsp;state</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;is&nbsp;created&nbsp;for&nbsp;nested&nbsp;objects.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">decoderState</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dec</span>&nbsp;<span class="op">*</span><span class="ident">Decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;buffer&nbsp;is&nbsp;stored&nbsp;with&nbsp;an&nbsp;extra&nbsp;indirection&nbsp;because&nbsp;it&nbsp;may&nbsp;be&nbsp;replaced</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;if&nbsp;we&nbsp;load&nbsp;a&nbsp;type&nbsp;during&nbsp;decode&nbsp;(when&nbsp;reading&nbsp;an&nbsp;interface&nbsp;value).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">decBuffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fieldnum</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="comment">//&nbsp;the&nbsp;last&nbsp;field&nbsp;number&nbsp;read.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">decoderState</span>&nbsp;<span class="comment">//&nbsp;for&nbsp;free&nbsp;list</span><br>
<span class="lineno">35</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;decBuffer&nbsp;is&nbsp;an&nbsp;extremely&nbsp;simple,&nbsp;fast&nbsp;implementation&nbsp;of&nbsp;a&nbsp;read-only&nbsp;byte&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;It&nbsp;is&nbsp;initialized&nbsp;by&nbsp;calling&nbsp;Size&nbsp;and&nbsp;then&nbsp;copying&nbsp;the&nbsp;data&nbsp;into&nbsp;the&nbsp;slice&nbsp;returned&nbsp;by&nbsp;Bytes().</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">decBuffer</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">data</span>&nbsp;&nbsp;&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">offset</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="comment">//&nbsp;Read&nbsp;offset.</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">d</span>&nbsp;<span class="op">*</span><span class="ident">decBuffer</span><span class="op">)</span>&nbsp;<span class="ident">Read</span><span class="op">(</span><span class="ident">p</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">copy</span><span class="op">(</span><span class="ident">p</span><span class="op">,</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">data</span><span class="op">[</span><span class="ident">d</span><span class="op">.</span><span class="ident">offset</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">p</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span><span class="op">.</span><span class="ident">offset</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">n</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">d</span>&nbsp;<span class="op">*</span><span class="ident">decBuffer</span><span class="op">)</span>&nbsp;<span class="ident">Drop</span><span class="op">(</span><span class="ident">n</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">Len</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;drop&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span><span class="op">.</span><span class="ident">offset</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">n</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment">//&nbsp;Size&nbsp;grows&nbsp;the&nbsp;buffer&nbsp;to&nbsp;exactly&nbsp;n&nbsp;bytes,&nbsp;so&nbsp;d.Bytes()&nbsp;will</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;return&nbsp;a&nbsp;slice&nbsp;of&nbsp;length&nbsp;n.&nbsp;Existing&nbsp;data&nbsp;is&nbsp;first&nbsp;discarded.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">d</span>&nbsp;<span class="op">*</span><span class="ident">decBuffer</span><span class="op">)</span>&nbsp;<span class="ident">Size</span><span class="op">(</span><span class="ident">n</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span><span class="op">.</span><span class="ident">Reset</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">cap</span><span class="op">(</span><span class="ident">d</span><span class="op">.</span><span class="ident">data</span><span class="op">)</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span><span class="op">.</span><span class="ident">data</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span><span class="op">.</span><span class="ident">data</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">data</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">n</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">d</span>&nbsp;<span class="op">*</span><span class="ident">decBuffer</span><span class="op">)</span>&nbsp;<span class="ident">ReadByte</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">offset</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">d</span><span class="op">.</span><span class="ident">data</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">data</span><span class="op">[</span><span class="ident">d</span><span class="op">.</span><span class="ident">offset</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span><span class="op">.</span><span class="ident">offset</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">d</span>&nbsp;<span class="op">*</span><span class="ident">decBuffer</span><span class="op">)</span>&nbsp;<span class="ident">Len</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">d</span><span class="op">.</span><span class="ident">data</span><span class="op">)</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">offset</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">d</span>&nbsp;<span class="op">*</span><span class="ident">decBuffer</span><span class="op">)</span>&nbsp;<span class="ident">Bytes</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">data</span><span class="op">[</span><span class="ident">d</span><span class="op">.</span><span class="ident">offset</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">d</span>&nbsp;<span class="op">*</span><span class="ident">decBuffer</span><span class="op">)</span>&nbsp;<span class="ident">Reset</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span><span class="op">.</span><span class="ident">data</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">data</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="num">0</span><span class="op">]</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span><span class="op">.</span><span class="ident">offset</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;We&nbsp;pass&nbsp;the&nbsp;bytes.Buffer&nbsp;separately&nbsp;for&nbsp;easier&nbsp;testing&nbsp;of&nbsp;the&nbsp;infrastructure</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;without&nbsp;requiring&nbsp;a&nbsp;full&nbsp;Decoder.</span><br>
<span class="lineno">95</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">dec</span>&nbsp;<span class="op">*</span><span class="ident">Decoder</span><span class="op">)</span>&nbsp;<span class="ident">newDecoderState</span><span class="op">(</span><span class="ident">buf</span>&nbsp;<span class="op">*</span><span class="ident">decBuffer</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">freeList</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">d</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">decoderState</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span><span class="op">.</span><span class="ident">dec</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">dec</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span><span class="op">.</span><span class="ident">buf</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">uint64Size</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dec</span><span class="op">.</span><span class="ident">freeList</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span><span class="op">.</span><span class="ident">b</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">buf</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">d</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">dec</span>&nbsp;<span class="op">*</span><span class="ident">Decoder</span><span class="op">)</span>&nbsp;<span class="ident">freeDecoderState</span><span class="op">(</span><span class="ident">d</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span><span class="op">.</span><span class="ident">next</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">freeList</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dec</span><span class="op">.</span><span class="ident">freeList</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">d</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">overflow</span><span class="op">(</span><span class="ident">name</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">`value&nbsp;for&nbsp;&#34;`</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">name</span>&nbsp;<span class="op">+</span>&nbsp;<span class="string">`&#34;&nbsp;out&nbsp;of&nbsp;range`</span><span class="op">)</span><br>
<span class="lineno">115</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;decodeUintReader&nbsp;reads&nbsp;an&nbsp;encoded&nbsp;unsigned&nbsp;integer&nbsp;from&nbsp;an&nbsp;io.Reader.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Used&nbsp;only&nbsp;by&nbsp;the&nbsp;Decoder&nbsp;to&nbsp;read&nbsp;the&nbsp;message&nbsp;length.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">decodeUintReader</span><span class="op">(</span><span class="ident">r</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">Reader</span><span class="op">,</span>&nbsp;<span class="ident">buf</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">x</span>&nbsp;<span class="ident">uint64</span><span class="op">,</span>&nbsp;<span class="ident">width</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">width</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">ReadFull</span><span class="op">(</span><span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">buf</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">width</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">buf</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="num">0x7f</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">uint64</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">width</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">-</span><span class="builtintype">int</span><span class="op">(</span><span class="builtintype">int8</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">uint64Size</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">errBadUint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">width</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">ReadFull</span><span class="op">(</span><span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">buf</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">n</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">EOF</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Could&nbsp;check&nbsp;that&nbsp;the&nbsp;high&nbsp;byte&nbsp;is&nbsp;zero&nbsp;but&nbsp;it&#39;s&nbsp;not&nbsp;worth&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">buf</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">width</span><span class="op">]</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">x</span><span class="op">&lt;&lt;</span><span class="num">8</span>&nbsp;<span class="op">|</span>&nbsp;<span class="ident">uint64</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">width</span><span class="op">++</span>&nbsp;<span class="comment">//&nbsp;+1&nbsp;for&nbsp;length&nbsp;byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;decodeUint&nbsp;reads&nbsp;an&nbsp;encoded&nbsp;unsigned&nbsp;integer&nbsp;from&nbsp;state.r.</span><br>
<span class="lineno">150</span><span class="comment">//&nbsp;Does&nbsp;not&nbsp;check&nbsp;for&nbsp;overflow.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">)</span>&nbsp;<span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">x</span>&nbsp;<span class="ident">uint64</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">ReadByte</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">error_</span><span class="op">(</span><span class="ident">err</span><span class="op">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="num">0x7f</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">uint64</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">-</span><span class="builtintype">int</span><span class="op">(</span><span class="builtintype">int8</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">uint64Size</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">error_</span><span class="op">(</span><span class="ident">errBadUint</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">width</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">Read</span><span class="op">(</span><span class="ident">state</span><span class="op">.</span><span class="ident">buf</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">n</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">error_</span><span class="op">(</span><span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Don&#39;t&nbsp;need&nbsp;to&nbsp;check&nbsp;error;&nbsp;it&#39;s&nbsp;safe&nbsp;to&nbsp;loop&nbsp;regardless.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Could&nbsp;check&nbsp;that&nbsp;the&nbsp;high&nbsp;byte&nbsp;is&nbsp;zero&nbsp;but&nbsp;it&#39;s&nbsp;not&nbsp;worth&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">buf</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">width</span><span class="op">]</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">x</span><span class="op">&lt;&lt;</span><span class="num">8</span>&nbsp;<span class="op">|</span>&nbsp;<span class="ident">uint64</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">x</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="comment">//&nbsp;decodeInt&nbsp;reads&nbsp;an&nbsp;encoded&nbsp;signed&nbsp;integer&nbsp;from&nbsp;state.r.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Does&nbsp;not&nbsp;check&nbsp;for&nbsp;overflow.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">)</span>&nbsp;<span class="ident">decodeInt</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">int64</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">x</span><span class="op">&amp;</span><span class="num">1</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">^</span><span class="ident">int64</span><span class="op">(</span><span class="ident">x</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="ident">x</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span><span class="comment">//&nbsp;decOp&nbsp;is&nbsp;the&nbsp;signature&nbsp;of&nbsp;a&nbsp;decoding&nbsp;operator&nbsp;for&nbsp;a&nbsp;given&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">decOp</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;&#39;instructions&#39;&nbsp;of&nbsp;the&nbsp;decoding&nbsp;machine</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">decInstr</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">decOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">field</span>&nbsp;<span class="builtintype">int</span>&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;field&nbsp;number&nbsp;of&nbsp;the&nbsp;wire&nbsp;type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">index</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">int</span>&nbsp;<span class="comment">//&nbsp;field&nbsp;access&nbsp;indices&nbsp;for&nbsp;destination&nbsp;type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ovfl</span>&nbsp;&nbsp;<span class="builtintype">error</span>&nbsp;<span class="comment">//&nbsp;error&nbsp;message&nbsp;for&nbsp;overflow/underflow&nbsp;(for&nbsp;arrays,&nbsp;of&nbsp;the&nbsp;elements)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ignoreUint&nbsp;discards&nbsp;a&nbsp;uint&nbsp;value&nbsp;with&nbsp;no&nbsp;destination.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">ignoreUint</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ignoreTwoUints&nbsp;discards&nbsp;a&nbsp;uint&nbsp;value&nbsp;with&nbsp;no&nbsp;destination.&nbsp;It&#39;s&nbsp;used&nbsp;to&nbsp;skip</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;complex&nbsp;values.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">ignoreTwoUints</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Since&nbsp;the&nbsp;encoder&nbsp;writes&nbsp;no&nbsp;zeros,&nbsp;if&nbsp;we&nbsp;arrive&nbsp;at&nbsp;a&nbsp;decoder&nbsp;we&nbsp;have</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;a&nbsp;value&nbsp;to&nbsp;extract&nbsp;and&nbsp;store.&nbsp;&nbsp;The&nbsp;field&nbsp;number&nbsp;has&nbsp;already&nbsp;been&nbsp;read</span><br>
<span class="lineno">210</span><span class="comment">//&nbsp;(it&#39;s&nbsp;how&nbsp;we&nbsp;knew&nbsp;to&nbsp;call&nbsp;this&nbsp;decoder).</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Each&nbsp;decoder&nbsp;is&nbsp;responsible&nbsp;for&nbsp;handling&nbsp;any&nbsp;indirections&nbsp;associated</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;with&nbsp;the&nbsp;data&nbsp;structure.&nbsp;&nbsp;If&nbsp;any&nbsp;pointer&nbsp;so&nbsp;reached&nbsp;is&nbsp;nil,&nbsp;allocation&nbsp;must</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;be&nbsp;done.</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span><span class="comment">//&nbsp;decAlloc&nbsp;takes&nbsp;a&nbsp;value&nbsp;and&nbsp;returns&nbsp;a&nbsp;settable&nbsp;value&nbsp;that&nbsp;can</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;be&nbsp;assigned&nbsp;to.&nbsp;If&nbsp;the&nbsp;value&nbsp;is&nbsp;a&nbsp;pointer,&nbsp;decAlloc&nbsp;guarantees&nbsp;it&nbsp;points&nbsp;to&nbsp;storage.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;callers&nbsp;to&nbsp;the&nbsp;individual&nbsp;decoders&nbsp;are&nbsp;expected&nbsp;to&nbsp;have&nbsp;used&nbsp;decAlloc.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;individual&nbsp;decoders&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">decAlloc</span><span class="op">(</span><span class="ident">v</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">v</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Ptr</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">v</span><span class="op">.</span><span class="ident">IsNil</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span><span class="op">.</span><span class="ident">Set</span><span class="op">(</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="ident">v</span><span class="op">.</span><span class="ident">Type</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">v</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">v</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;decBool&nbsp;decodes&nbsp;a&nbsp;uint&nbsp;and&nbsp;stores&nbsp;it&nbsp;as&nbsp;a&nbsp;boolean&nbsp;in&nbsp;value.</span><br>
<span class="lineno">230</span><span class="keyword">func</span>&nbsp;<span class="ident">decBool</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">value</span><span class="op">.</span><span class="ident">SetBool</span><span class="op">(</span><span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;decInt8&nbsp;decodes&nbsp;an&nbsp;integer&nbsp;and&nbsp;stores&nbsp;it&nbsp;as&nbsp;an&nbsp;int8&nbsp;in&nbsp;value.</span><br>
<span class="lineno">235</span><span class="keyword">func</span>&nbsp;<span class="ident">decInt8</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">decodeInt</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">math</span><span class="op">.</span><span class="ident">MinInt8</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">math</span><span class="op">.</span><span class="ident">MaxInt8</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">error_</span><span class="op">(</span><span class="ident">i</span><span class="op">.</span><span class="ident">ovfl</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">value</span><span class="op">.</span><span class="ident">SetInt</span><span class="op">(</span><span class="ident">v</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;decUint8&nbsp;decodes&nbsp;an&nbsp;unsigned&nbsp;integer&nbsp;and&nbsp;stores&nbsp;it&nbsp;as&nbsp;a&nbsp;uint8&nbsp;in&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">decUint8</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">math</span><span class="op">.</span><span class="ident">MaxUint8</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">error_</span><span class="op">(</span><span class="ident">i</span><span class="op">.</span><span class="ident">ovfl</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">value</span><span class="op">.</span><span class="ident">SetUint</span><span class="op">(</span><span class="ident">v</span><span class="op">)</span><br>
<span class="lineno">250</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;decInt16&nbsp;decodes&nbsp;an&nbsp;integer&nbsp;and&nbsp;stores&nbsp;it&nbsp;as&nbsp;an&nbsp;int16&nbsp;in&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">decInt16</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">decodeInt</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">math</span><span class="op">.</span><span class="ident">MinInt16</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">math</span><span class="op">.</span><span class="ident">MaxInt16</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">error_</span><span class="op">(</span><span class="ident">i</span><span class="op">.</span><span class="ident">ovfl</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">value</span><span class="op">.</span><span class="ident">SetInt</span><span class="op">(</span><span class="ident">v</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;decUint16&nbsp;decodes&nbsp;an&nbsp;unsigned&nbsp;integer&nbsp;and&nbsp;stores&nbsp;it&nbsp;as&nbsp;a&nbsp;uint16&nbsp;in&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">decUint16</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">math</span><span class="op">.</span><span class="ident">MaxUint16</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">error_</span><span class="op">(</span><span class="ident">i</span><span class="op">.</span><span class="ident">ovfl</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">value</span><span class="op">.</span><span class="ident">SetUint</span><span class="op">(</span><span class="ident">v</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="comment">//&nbsp;decInt32&nbsp;decodes&nbsp;an&nbsp;integer&nbsp;and&nbsp;stores&nbsp;it&nbsp;as&nbsp;an&nbsp;int32&nbsp;in&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">decInt32</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">decodeInt</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">math</span><span class="op">.</span><span class="ident">MinInt32</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">math</span><span class="op">.</span><span class="ident">MaxInt32</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">error_</span><span class="op">(</span><span class="ident">i</span><span class="op">.</span><span class="ident">ovfl</span><span class="op">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">value</span><span class="op">.</span><span class="ident">SetInt</span><span class="op">(</span><span class="ident">v</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;decUint32&nbsp;decodes&nbsp;an&nbsp;unsigned&nbsp;integer&nbsp;and&nbsp;stores&nbsp;it&nbsp;as&nbsp;a&nbsp;uint32&nbsp;in&nbsp;value.</span><br>
<span class="lineno">280</span><span class="keyword">func</span>&nbsp;<span class="ident">decUint32</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">math</span><span class="op">.</span><span class="ident">MaxUint32</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">error_</span><span class="op">(</span><span class="ident">i</span><span class="op">.</span><span class="ident">ovfl</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">value</span><span class="op">.</span><span class="ident">SetUint</span><span class="op">(</span><span class="ident">v</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;decInt64&nbsp;decodes&nbsp;an&nbsp;integer&nbsp;and&nbsp;stores&nbsp;it&nbsp;as&nbsp;an&nbsp;int64&nbsp;in&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">decInt64</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">decodeInt</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">value</span><span class="op">.</span><span class="ident">SetInt</span><span class="op">(</span><span class="ident">v</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;decUint64&nbsp;decodes&nbsp;an&nbsp;unsigned&nbsp;integer&nbsp;and&nbsp;stores&nbsp;it&nbsp;as&nbsp;a&nbsp;uint64&nbsp;in&nbsp;value.</span><br>
<span class="lineno">295</span><span class="keyword">func</span>&nbsp;<span class="ident">decUint64</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">value</span><span class="op">.</span><span class="ident">SetUint</span><span class="op">(</span><span class="ident">v</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="comment">//&nbsp;Floating-point&nbsp;numbers&nbsp;are&nbsp;transmitted&nbsp;as&nbsp;uint64s&nbsp;holding&nbsp;the&nbsp;bits</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;of&nbsp;the&nbsp;underlying&nbsp;representation.&nbsp;&nbsp;They&nbsp;are&nbsp;sent&nbsp;byte-reversed,&nbsp;with</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;the&nbsp;exponent&nbsp;end&nbsp;coming&nbsp;out&nbsp;first,&nbsp;so&nbsp;integer&nbsp;floating&nbsp;point&nbsp;numbers</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;(for&nbsp;example)&nbsp;transmit&nbsp;more&nbsp;compactly.&nbsp;&nbsp;This&nbsp;routine&nbsp;does&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;unswizzling.</span><br>
<span class="lineno">305</span><span class="keyword">func</span>&nbsp;<span class="ident">float64FromBits</span><span class="op">(</span><span class="ident">u</span>&nbsp;<span class="ident">uint64</span><span class="op">)</span>&nbsp;<span class="builtintype">float64</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="ident">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">8</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span>&nbsp;<span class="op">&lt;&lt;=</span>&nbsp;<span class="num">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span>&nbsp;<span class="op">|=</span>&nbsp;<span class="ident">u</span>&nbsp;<span class="op">&amp;</span>&nbsp;<span class="num">0xFF</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">u</span>&nbsp;<span class="op">&gt;&gt;=</span>&nbsp;<span class="num">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">math</span><span class="op">.</span><span class="ident">Float64frombits</span><span class="op">(</span><span class="ident">v</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span><span class="comment">//&nbsp;float32FromBits&nbsp;decodes&nbsp;an&nbsp;unsigned&nbsp;integer,&nbsp;treats&nbsp;it&nbsp;as&nbsp;a&nbsp;32-bit&nbsp;floating-point</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;number,&nbsp;and&nbsp;returns&nbsp;it.&nbsp;It&#39;s&nbsp;a&nbsp;helper&nbsp;function&nbsp;for&nbsp;float32&nbsp;and&nbsp;complex64.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;It&nbsp;returns&nbsp;a&nbsp;float64&nbsp;because&nbsp;that&#39;s&nbsp;what&nbsp;reflection&nbsp;needs,&nbsp;but&nbsp;its&nbsp;return</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;value&nbsp;is&nbsp;known&nbsp;to&nbsp;be&nbsp;accurately&nbsp;representable&nbsp;in&nbsp;a&nbsp;float32.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">float32FromBits</span><span class="op">(</span><span class="ident">u</span>&nbsp;<span class="ident">uint64</span><span class="op">,</span>&nbsp;<span class="ident">ovfl</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="builtintype">float64</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">float64FromBits</span><span class="op">(</span><span class="ident">u</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">av</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">av</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">av</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">-</span><span class="ident">av</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;+Inf&nbsp;is&nbsp;OK&nbsp;in&nbsp;both&nbsp;32-&nbsp;and&nbsp;64-bit&nbsp;floats.&nbsp;&nbsp;Underflow&nbsp;is&nbsp;always&nbsp;OK.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">math</span><span class="op">.</span><span class="ident">MaxFloat32</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">av</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">av</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="ident">math</span><span class="op">.</span><span class="ident">MaxFloat64</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">error_</span><span class="op">(</span><span class="ident">ovfl</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">v</span><br>
<span class="lineno">330</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;decFloat32&nbsp;decodes&nbsp;an&nbsp;unsigned&nbsp;integer,&nbsp;treats&nbsp;it&nbsp;as&nbsp;a&nbsp;32-bit&nbsp;floating-point</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;number,&nbsp;and&nbsp;stores&nbsp;it&nbsp;in&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">decFloat32</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">value</span><span class="op">.</span><span class="ident">SetFloat</span><span class="op">(</span><span class="ident">float32FromBits</span><span class="op">(</span><span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">i</span><span class="op">.</span><span class="ident">ovfl</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;decFloat64&nbsp;decodes&nbsp;an&nbsp;unsigned&nbsp;integer,&nbsp;treats&nbsp;it&nbsp;as&nbsp;a&nbsp;64-bit&nbsp;floating-point</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;number,&nbsp;and&nbsp;stores&nbsp;it&nbsp;in&nbsp;value.</span><br>
<span class="lineno">340</span><span class="keyword">func</span>&nbsp;<span class="ident">decFloat64</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">value</span><span class="op">.</span><span class="ident">SetFloat</span><span class="op">(</span><span class="ident">float64FromBits</span><span class="op">(</span><span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;decComplex64&nbsp;decodes&nbsp;a&nbsp;pair&nbsp;of&nbsp;unsigned&nbsp;integers,&nbsp;treats&nbsp;them&nbsp;as&nbsp;a</span><br>
<span class="lineno">345</span><span class="comment">//&nbsp;pair&nbsp;of&nbsp;floating&nbsp;point&nbsp;numbers,&nbsp;and&nbsp;stores&nbsp;them&nbsp;as&nbsp;a&nbsp;complex64&nbsp;in&nbsp;value.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;real&nbsp;part&nbsp;comes&nbsp;first.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">decComplex64</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">real</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">float32FromBits</span><span class="op">(</span><span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">i</span><span class="op">.</span><span class="ident">ovfl</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">imag</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">float32FromBits</span><span class="op">(</span><span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">i</span><span class="op">.</span><span class="ident">ovfl</span><span class="op">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">value</span><span class="op">.</span><span class="ident">SetComplex</span><span class="op">(</span><span class="builtinfunc">complex</span><span class="op">(</span><span class="builtinfunc">real</span><span class="op">,</span>&nbsp;<span class="builtinfunc">imag</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;decComplex128&nbsp;decodes&nbsp;a&nbsp;pair&nbsp;of&nbsp;unsigned&nbsp;integers,&nbsp;treats&nbsp;them&nbsp;as&nbsp;a</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;pair&nbsp;of&nbsp;floating&nbsp;point&nbsp;numbers,&nbsp;and&nbsp;stores&nbsp;them&nbsp;as&nbsp;a&nbsp;complex128&nbsp;in&nbsp;value.</span><br>
<span class="lineno">355</span><span class="comment">//&nbsp;The&nbsp;real&nbsp;part&nbsp;comes&nbsp;first.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">decComplex128</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">real</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">float64FromBits</span><span class="op">(</span><span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">imag</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">float64FromBits</span><span class="op">(</span><span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">value</span><span class="op">.</span><span class="ident">SetComplex</span><span class="op">(</span><span class="builtinfunc">complex</span><span class="op">(</span><span class="builtinfunc">real</span><span class="op">,</span>&nbsp;<span class="builtinfunc">imag</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">360</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;decUint8Slice&nbsp;decodes&nbsp;a&nbsp;byte&nbsp;slice&nbsp;and&nbsp;stores&nbsp;in&nbsp;value&nbsp;a&nbsp;slice&nbsp;header</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;describing&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;uint8&nbsp;slices&nbsp;are&nbsp;encoded&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;the&nbsp;raw&nbsp;bytes.</span><br>
<span class="lineno">365</span><span class="keyword">func</span>&nbsp;<span class="ident">decUint8Slice</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">u</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">u</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">uint64</span><span class="op">(</span><span class="ident">n</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">u</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;length&nbsp;of&nbsp;%s&nbsp;exceeds&nbsp;input&nbsp;size&nbsp;(%d&nbsp;bytes)&#34;</span><span class="op">,</span>&nbsp;<span class="ident">value</span><span class="op">.</span><span class="ident">Type</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">u</span><span class="op">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">Len</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;%s&nbsp;data&nbsp;too&nbsp;long&nbsp;for&nbsp;buffer:&nbsp;%d&#34;</span><span class="op">,</span>&nbsp;<span class="ident">value</span><span class="op">.</span><span class="ident">Type</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">tooBig</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;byte&nbsp;slice&nbsp;too&nbsp;big:&nbsp;%d&#34;</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">value</span><span class="op">.</span><span class="ident">Cap</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">value</span><span class="op">.</span><span class="ident">Set</span><span class="op">(</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">MakeSlice</span><span class="op">(</span><span class="ident">value</span><span class="op">.</span><span class="ident">Type</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">value</span><span class="op">.</span><span class="ident">Set</span><span class="op">(</span><span class="ident">value</span><span class="op">.</span><span class="ident">Slice</span><span class="op">(</span><span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">Read</span><span class="op">(</span><span class="ident">value</span><span class="op">.</span><span class="ident">Bytes</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;error&nbsp;decoding&nbsp;[]byte:&nbsp;%s&#34;</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">385</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;decString&nbsp;decodes&nbsp;byte&nbsp;array&nbsp;and&nbsp;stores&nbsp;in&nbsp;value&nbsp;a&nbsp;string&nbsp;header</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;describing&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Strings&nbsp;are&nbsp;encoded&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;the&nbsp;raw&nbsp;bytes.</span><br>
<span class="lineno">390</span><span class="keyword">func</span>&nbsp;<span class="ident">decString</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">u</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">u</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">uint64</span><span class="op">(</span><span class="ident">n</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">u</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">Len</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;length&nbsp;of&nbsp;%s&nbsp;exceeds&nbsp;input&nbsp;size&nbsp;(%d&nbsp;bytes)&#34;</span><span class="op">,</span>&nbsp;<span class="ident">value</span><span class="op">.</span><span class="ident">Type</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">u</span><span class="op">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">Len</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;%s&nbsp;data&nbsp;too&nbsp;long&nbsp;for&nbsp;buffer:&nbsp;%d&#34;</span><span class="op">,</span>&nbsp;<span class="ident">value</span><span class="op">.</span><span class="ident">Type</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Read&nbsp;the&nbsp;data.</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">data</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">Read</span><span class="op">(</span><span class="ident">data</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;error&nbsp;decoding&nbsp;string:&nbsp;%s&#34;</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">value</span><span class="op">.</span><span class="ident">SetString</span><span class="op">(</span><span class="builtintype">string</span><span class="op">(</span><span class="ident">data</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">405</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ignoreUint8Array&nbsp;skips&nbsp;over&nbsp;the&nbsp;data&nbsp;for&nbsp;a&nbsp;byte&nbsp;slice&nbsp;value&nbsp;with&nbsp;no&nbsp;destination.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">ignoreUint8Array</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">Read</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Execution&nbsp;engine</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment">//&nbsp;The&nbsp;encoder&nbsp;engine&nbsp;is&nbsp;an&nbsp;array&nbsp;of&nbsp;instructions&nbsp;indexed&nbsp;by&nbsp;field&nbsp;number&nbsp;of&nbsp;the&nbsp;incoming</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;decoder.&nbsp;&nbsp;It&nbsp;is&nbsp;executed&nbsp;with&nbsp;random&nbsp;access&nbsp;according&nbsp;to&nbsp;field&nbsp;number.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">decEngine</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">instr</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">decInstr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">numInstr</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="comment">//&nbsp;the&nbsp;number&nbsp;of&nbsp;active&nbsp;instructions</span><br>
<span class="lineno">420</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;decodeSingle&nbsp;decodes&nbsp;a&nbsp;top-level&nbsp;value&nbsp;that&nbsp;is&nbsp;not&nbsp;a&nbsp;struct&nbsp;and&nbsp;stores&nbsp;it&nbsp;in&nbsp;value.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Such&nbsp;values&nbsp;are&nbsp;preceded&nbsp;by&nbsp;a&nbsp;zero,&nbsp;making&nbsp;them&nbsp;have&nbsp;the&nbsp;memory&nbsp;layout&nbsp;of&nbsp;a</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;struct&nbsp;field&nbsp;(although&nbsp;with&nbsp;an&nbsp;illegal&nbsp;field&nbsp;number).</span><br>
<span class="lineno">425</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">dec</span>&nbsp;<span class="op">*</span><span class="ident">Decoder</span><span class="op">)</span>&nbsp;<span class="ident">decodeSingle</span><span class="op">(</span><span class="ident">engine</span>&nbsp;<span class="op">*</span><span class="ident">decEngine</span><span class="op">,</span>&nbsp;<span class="ident">ut</span>&nbsp;<span class="op">*</span><span class="ident">userTypeInfo</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">newDecoderState</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">dec</span><span class="op">.</span><span class="ident">buf</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">freeDecoderState</span><span class="op">(</span><span class="ident">state</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">fieldnum</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">singletonField</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;decode:&nbsp;corrupted&nbsp;data:&nbsp;non-zero&nbsp;delta&nbsp;for&nbsp;singleton&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">instr</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">engine</span><span class="op">.</span><span class="ident">instr</span><span class="op">[</span><span class="ident">singletonField</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">instr</span><span class="op">.</span><span class="ident">op</span><span class="op">(</span><span class="ident">instr</span><span class="op">,</span>&nbsp;<span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">value</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">435</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;decodeStruct&nbsp;decodes&nbsp;a&nbsp;top-level&nbsp;struct&nbsp;and&nbsp;stores&nbsp;it&nbsp;in&nbsp;value.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Indir&nbsp;is&nbsp;for&nbsp;the&nbsp;value,&nbsp;not&nbsp;the&nbsp;type.&nbsp;&nbsp;At&nbsp;the&nbsp;time&nbsp;of&nbsp;the&nbsp;call&nbsp;it&nbsp;may</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;differ&nbsp;from&nbsp;ut.indir,&nbsp;which&nbsp;was&nbsp;computed&nbsp;when&nbsp;the&nbsp;engine&nbsp;was&nbsp;built.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;This&nbsp;state&nbsp;cannot&nbsp;arise&nbsp;for&nbsp;decodeSingle,&nbsp;which&nbsp;is&nbsp;called&nbsp;directly</span><br>
<span class="lineno">440</span><span class="comment">//&nbsp;from&nbsp;the&nbsp;user&#39;s&nbsp;value,&nbsp;not&nbsp;from&nbsp;the&nbsp;innards&nbsp;of&nbsp;an&nbsp;engine.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">dec</span>&nbsp;<span class="op">*</span><span class="ident">Decoder</span><span class="op">)</span>&nbsp;<span class="ident">decodeStruct</span><span class="op">(</span><span class="ident">engine</span>&nbsp;<span class="op">*</span><span class="ident">decEngine</span><span class="op">,</span>&nbsp;<span class="ident">ut</span>&nbsp;<span class="op">*</span><span class="ident">userTypeInfo</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">newDecoderState</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">dec</span><span class="op">.</span><span class="ident">buf</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">freeDecoderState</span><span class="op">(</span><span class="ident">state</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">fieldnum</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">-</span><span class="num">1</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">Len</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">delta</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">delta</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;decode:&nbsp;corrupted&nbsp;data:&nbsp;negative&nbsp;delta&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">delta</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span>&nbsp;<span class="comment">//&nbsp;struct&nbsp;terminator&nbsp;is&nbsp;zero&nbsp;delta&nbsp;fieldnum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fieldnum</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">fieldnum</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">fieldnum</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">engine</span><span class="op">.</span><span class="ident">instr</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">error_</span><span class="op">(</span><span class="ident">errRange</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">instr</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">engine</span><span class="op">.</span><span class="ident">instr</span><span class="op">[</span><span class="ident">fieldnum</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">field</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">instr</span><span class="op">.</span><span class="ident">index</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Otherwise&nbsp;the&nbsp;field&nbsp;is&nbsp;unknown&nbsp;to&nbsp;us&nbsp;and&nbsp;instr.op&nbsp;is&nbsp;an&nbsp;ignore&nbsp;op.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">field</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">value</span><span class="op">.</span><span class="ident">FieldByIndex</span><span class="op">(</span><span class="ident">instr</span><span class="op">.</span><span class="ident">index</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">field</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Ptr</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">field</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">decAlloc</span><span class="op">(</span><span class="ident">field</span><span class="op">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">instr</span><span class="op">.</span><span class="ident">op</span><span class="op">(</span><span class="ident">instr</span><span class="op">,</span>&nbsp;<span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">field</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">fieldnum</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">fieldnum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">470</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">noValue</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ignoreStruct&nbsp;discards&nbsp;the&nbsp;data&nbsp;for&nbsp;a&nbsp;struct&nbsp;with&nbsp;no&nbsp;destination.</span><br>
<span class="lineno">475</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">dec</span>&nbsp;<span class="op">*</span><span class="ident">Decoder</span><span class="op">)</span>&nbsp;<span class="ident">ignoreStruct</span><span class="op">(</span><span class="ident">engine</span>&nbsp;<span class="op">*</span><span class="ident">decEngine</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">newDecoderState</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">dec</span><span class="op">.</span><span class="ident">buf</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">freeDecoderState</span><span class="op">(</span><span class="ident">state</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">fieldnum</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">-</span><span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">Len</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">delta</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">delta</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;ignore&nbsp;decode:&nbsp;corrupted&nbsp;data:&nbsp;negative&nbsp;delta&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">delta</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span>&nbsp;<span class="comment">//&nbsp;struct&nbsp;terminator&nbsp;is&nbsp;zero&nbsp;delta&nbsp;fieldnum</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fieldnum</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">fieldnum</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">fieldnum</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">engine</span><span class="op">.</span><span class="ident">instr</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">error_</span><span class="op">(</span><span class="ident">errRange</span><span class="op">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">instr</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">engine</span><span class="op">.</span><span class="ident">instr</span><span class="op">[</span><span class="ident">fieldnum</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">instr</span><span class="op">.</span><span class="ident">op</span><span class="op">(</span><span class="ident">instr</span><span class="op">,</span>&nbsp;<span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">noValue</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">fieldnum</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">fieldnum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">495</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ignoreSingle&nbsp;discards&nbsp;the&nbsp;data&nbsp;for&nbsp;a&nbsp;top-level&nbsp;non-struct&nbsp;value&nbsp;with&nbsp;no</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;destination.&nbsp;It&#39;s&nbsp;used&nbsp;when&nbsp;calling&nbsp;Decode&nbsp;with&nbsp;a&nbsp;nil&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">dec</span>&nbsp;<span class="op">*</span><span class="ident">Decoder</span><span class="op">)</span>&nbsp;<span class="ident">ignoreSingle</span><span class="op">(</span><span class="ident">engine</span>&nbsp;<span class="op">*</span><span class="ident">decEngine</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">newDecoderState</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">dec</span><span class="op">.</span><span class="ident">buf</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">freeDecoderState</span><span class="op">(</span><span class="ident">state</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">fieldnum</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">singletonField</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">delta</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">delta</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;decode:&nbsp;corrupted&nbsp;data:&nbsp;non-zero&nbsp;delta&nbsp;for&nbsp;singleton&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">instr</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">engine</span><span class="op">.</span><span class="ident">instr</span><span class="op">[</span><span class="ident">singletonField</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">instr</span><span class="op">.</span><span class="ident">op</span><span class="op">(</span><span class="ident">instr</span><span class="op">,</span>&nbsp;<span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">noValue</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">510</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;decodeArrayHelper&nbsp;does&nbsp;the&nbsp;work&nbsp;for&nbsp;decoding&nbsp;arrays&nbsp;and&nbsp;slices.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">dec</span>&nbsp;<span class="op">*</span><span class="ident">Decoder</span><span class="op">)</span>&nbsp;<span class="ident">decodeArrayHelper</span><span class="op">(</span><span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">,</span>&nbsp;<span class="ident">elemOp</span>&nbsp;<span class="ident">decOp</span><span class="op">,</span>&nbsp;<span class="ident">length</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">ovfl</span>&nbsp;<span class="builtintype">error</span><span class="op">,</span>&nbsp;<span class="ident">helper</span>&nbsp;<span class="ident">decHelper</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">helper</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">helper</span><span class="op">(</span><span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">value</span><span class="op">,</span>&nbsp;<span class="ident">length</span><span class="op">,</span>&nbsp;<span class="ident">ovfl</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">instr</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">decInstr</span><span class="op">{</span><span class="ident">elemOp</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">ovfl</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">isPtr</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">value</span><span class="op">.</span><span class="ident">Type</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Ptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">length</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">Len</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;decoding&nbsp;array&nbsp;or&nbsp;slice:&nbsp;length&nbsp;exceeds&nbsp;input&nbsp;size&nbsp;(%d&nbsp;elements)&#34;</span><span class="op">,</span>&nbsp;<span class="ident">length</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">value</span><span class="op">.</span><span class="ident">Index</span><span class="op">(</span><span class="ident">i</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">isPtr</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">decAlloc</span><span class="op">(</span><span class="ident">v</span><span class="op">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">elemOp</span><span class="op">(</span><span class="ident">instr</span><span class="op">,</span>&nbsp;<span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">v</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">530</span><span class="comment">//&nbsp;decodeArray&nbsp;decodes&nbsp;an&nbsp;array&nbsp;and&nbsp;stores&nbsp;it&nbsp;in&nbsp;value.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;length&nbsp;is&nbsp;an&nbsp;unsigned&nbsp;integer&nbsp;preceding&nbsp;the&nbsp;elements.&nbsp;&nbsp;Even&nbsp;though&nbsp;the&nbsp;length&nbsp;is&nbsp;redundant</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;(it&#39;s&nbsp;part&nbsp;of&nbsp;the&nbsp;type),&nbsp;it&#39;s&nbsp;a&nbsp;useful&nbsp;check&nbsp;and&nbsp;is&nbsp;included&nbsp;in&nbsp;the&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">dec</span>&nbsp;<span class="op">*</span><span class="ident">Decoder</span><span class="op">)</span>&nbsp;<span class="ident">decodeArray</span><span class="op">(</span><span class="ident">atyp</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">,</span>&nbsp;<span class="ident">elemOp</span>&nbsp;<span class="ident">decOp</span><span class="op">,</span>&nbsp;<span class="ident">length</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">ovfl</span>&nbsp;<span class="builtintype">error</span><span class="op">,</span>&nbsp;<span class="ident">helper</span>&nbsp;<span class="ident">decHelper</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">uint64</span><span class="op">(</span><span class="ident">length</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;length&nbsp;mismatch&nbsp;in&nbsp;decodeArray&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dec</span><span class="op">.</span><span class="ident">decodeArrayHelper</span><span class="op">(</span><span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">value</span><span class="op">,</span>&nbsp;<span class="ident">elemOp</span><span class="op">,</span>&nbsp;<span class="ident">length</span><span class="op">,</span>&nbsp;<span class="ident">ovfl</span><span class="op">,</span>&nbsp;<span class="ident">helper</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">540</span><span class="comment">//&nbsp;decodeIntoValue&nbsp;is&nbsp;a&nbsp;helper&nbsp;for&nbsp;map&nbsp;decoding.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">decodeIntoValue</span><span class="op">(</span><span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">op</span>&nbsp;<span class="ident">decOp</span><span class="op">,</span>&nbsp;<span class="ident">isPtr</span>&nbsp;<span class="builtintype">bool</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">,</span>&nbsp;<span class="ident">ovfl</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">instr</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">decInstr</span><span class="op">{</span><span class="ident">op</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">ovfl</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">isPtr</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">decAlloc</span><span class="op">(</span><span class="ident">value</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span><span class="op">(</span><span class="ident">instr</span><span class="op">,</span>&nbsp;<span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">v</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">value</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;decodeMap&nbsp;decodes&nbsp;a&nbsp;map&nbsp;and&nbsp;stores&nbsp;it&nbsp;in&nbsp;value.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Maps&nbsp;are&nbsp;encoded&nbsp;as&nbsp;a&nbsp;length&nbsp;followed&nbsp;by&nbsp;key:value&nbsp;pairs.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Because&nbsp;the&nbsp;internals&nbsp;of&nbsp;maps&nbsp;are&nbsp;not&nbsp;visible&nbsp;to&nbsp;us,&nbsp;we&nbsp;must</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;use&nbsp;reflection&nbsp;rather&nbsp;than&nbsp;pointer&nbsp;magic.</span><br>
<span class="lineno">555</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">dec</span>&nbsp;<span class="op">*</span><span class="ident">Decoder</span><span class="op">)</span>&nbsp;<span class="ident">decodeMap</span><span class="op">(</span><span class="ident">mtyp</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">,</span>&nbsp;<span class="ident">keyOp</span><span class="op">,</span>&nbsp;<span class="ident">elemOp</span>&nbsp;<span class="ident">decOp</span><span class="op">,</span>&nbsp;<span class="ident">ovfl</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">value</span><span class="op">.</span><span class="ident">IsNil</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Allocate&nbsp;map.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">value</span><span class="op">.</span><span class="ident">Set</span><span class="op">(</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">MakeMap</span><span class="op">(</span><span class="ident">mtyp</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">keyIsPtr</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">mtyp</span><span class="op">.</span><span class="ident">Key</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Ptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">elemIsPtr</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">mtyp</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Ptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">n</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">key</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">decodeIntoValue</span><span class="op">(</span><span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">keyOp</span><span class="op">,</span>&nbsp;<span class="ident">keyIsPtr</span><span class="op">,</span>&nbsp;<span class="ident">allocValue</span><span class="op">(</span><span class="ident">mtyp</span><span class="op">.</span><span class="ident">Key</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">ovfl</span><span class="op">)</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">elem</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">decodeIntoValue</span><span class="op">(</span><span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">elemOp</span><span class="op">,</span>&nbsp;<span class="ident">elemIsPtr</span><span class="op">,</span>&nbsp;<span class="ident">allocValue</span><span class="op">(</span><span class="ident">mtyp</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">ovfl</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">value</span><span class="op">.</span><span class="ident">SetMapIndex</span><span class="op">(</span><span class="ident">key</span><span class="op">,</span>&nbsp;<span class="ident">elem</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">570</span><span class="comment">//&nbsp;ignoreArrayHelper&nbsp;does&nbsp;the&nbsp;work&nbsp;for&nbsp;discarding&nbsp;arrays&nbsp;and&nbsp;slices.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">dec</span>&nbsp;<span class="op">*</span><span class="ident">Decoder</span><span class="op">)</span>&nbsp;<span class="ident">ignoreArrayHelper</span><span class="op">(</span><span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">elemOp</span>&nbsp;<span class="ident">decOp</span><span class="op">,</span>&nbsp;<span class="ident">length</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">instr</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">decInstr</span><span class="op">{</span><span class="ident">elemOp</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;no&nbsp;error&#34;</span><span class="op">)</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">length</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">elemOp</span><span class="op">(</span><span class="ident">instr</span><span class="op">,</span>&nbsp;<span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">noValue</span><span class="op">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ignoreArray&nbsp;discards&nbsp;the&nbsp;data&nbsp;for&nbsp;an&nbsp;array&nbsp;value&nbsp;with&nbsp;no&nbsp;destination.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">dec</span>&nbsp;<span class="op">*</span><span class="ident">Decoder</span><span class="op">)</span>&nbsp;<span class="ident">ignoreArray</span><span class="op">(</span><span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">elemOp</span>&nbsp;<span class="ident">decOp</span><span class="op">,</span>&nbsp;<span class="ident">length</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">uint64</span><span class="op">(</span><span class="ident">length</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;length&nbsp;mismatch&nbsp;in&nbsp;ignoreArray&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dec</span><span class="op">.</span><span class="ident">ignoreArrayHelper</span><span class="op">(</span><span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">elemOp</span><span class="op">,</span>&nbsp;<span class="ident">length</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">585</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ignoreMap&nbsp;discards&nbsp;the&nbsp;data&nbsp;for&nbsp;a&nbsp;map&nbsp;value&nbsp;with&nbsp;no&nbsp;destination.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">dec</span>&nbsp;<span class="op">*</span><span class="ident">Decoder</span><span class="op">)</span>&nbsp;<span class="ident">ignoreMap</span><span class="op">(</span><span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">keyOp</span><span class="op">,</span>&nbsp;<span class="ident">elemOp</span>&nbsp;<span class="ident">decOp</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">keyInstr</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">decInstr</span><span class="op">{</span><span class="ident">keyOp</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;no&nbsp;error&#34;</span><span class="op">)</span><span class="op">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">elemInstr</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">decInstr</span><span class="op">{</span><span class="ident">elemOp</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;no&nbsp;error&#34;</span><span class="op">)</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">n</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">keyOp</span><span class="op">(</span><span class="ident">keyInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">noValue</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">elemOp</span><span class="op">(</span><span class="ident">elemInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">noValue</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">595</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;decodeSlice&nbsp;decodes&nbsp;a&nbsp;slice&nbsp;and&nbsp;stores&nbsp;it&nbsp;in&nbsp;value.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Slices&nbsp;are&nbsp;encoded&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;length&nbsp;followed&nbsp;by&nbsp;the&nbsp;elements.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">dec</span>&nbsp;<span class="op">*</span><span class="ident">Decoder</span><span class="op">)</span>&nbsp;<span class="ident">decodeSlice</span><span class="op">(</span><span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">,</span>&nbsp;<span class="ident">elemOp</span>&nbsp;<span class="ident">decOp</span><span class="op">,</span>&nbsp;<span class="ident">ovfl</span>&nbsp;<span class="builtintype">error</span><span class="op">,</span>&nbsp;<span class="ident">helper</span>&nbsp;<span class="ident">decHelper</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">u</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">typ</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">value</span><span class="op">.</span><span class="ident">Type</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">size</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">uint64</span><span class="op">(</span><span class="ident">typ</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">Size</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nBytes</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">u</span>&nbsp;<span class="op">*</span>&nbsp;<span class="ident">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">u</span><span class="op">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Take&nbsp;care&nbsp;with&nbsp;overflow&nbsp;in&nbsp;this&nbsp;calculation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">uint64</span><span class="op">(</span><span class="ident">n</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">u</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">nBytes</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">tooBig</span>&nbsp;<span class="op">||</span>&nbsp;<span class="op">(</span><span class="ident">size</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">nBytes</span><span class="op">/</span><span class="ident">size</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">u</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&nbsp;don&#39;t&nbsp;check&nbsp;n&nbsp;against&nbsp;buffer&nbsp;length&nbsp;here&nbsp;because&nbsp;if&nbsp;it&#39;s&nbsp;a&nbsp;slice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;of&nbsp;interfaces,&nbsp;there&nbsp;will&nbsp;be&nbsp;buffer&nbsp;reloads.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;%s&nbsp;slice&nbsp;too&nbsp;big:&nbsp;%d&nbsp;elements&nbsp;of&nbsp;%d&nbsp;bytes&#34;</span><span class="op">,</span>&nbsp;<span class="ident">typ</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">u</span><span class="op">,</span>&nbsp;<span class="ident">size</span><span class="op">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">value</span><span class="op">.</span><span class="ident">Cap</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">value</span><span class="op">.</span><span class="ident">Set</span><span class="op">(</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">MakeSlice</span><span class="op">(</span><span class="ident">typ</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">value</span><span class="op">.</span><span class="ident">Set</span><span class="op">(</span><span class="ident">value</span><span class="op">.</span><span class="ident">Slice</span><span class="op">(</span><span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dec</span><span class="op">.</span><span class="ident">decodeArrayHelper</span><span class="op">(</span><span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">value</span><span class="op">,</span>&nbsp;<span class="ident">elemOp</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">ovfl</span><span class="op">,</span>&nbsp;<span class="ident">helper</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ignoreSlice&nbsp;skips&nbsp;over&nbsp;the&nbsp;data&nbsp;for&nbsp;a&nbsp;slice&nbsp;value&nbsp;with&nbsp;no&nbsp;destination.</span><br>
<span class="lineno">620</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">dec</span>&nbsp;<span class="op">*</span><span class="ident">Decoder</span><span class="op">)</span>&nbsp;<span class="ident">ignoreSlice</span><span class="op">(</span><span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">elemOp</span>&nbsp;<span class="ident">decOp</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dec</span><span class="op">.</span><span class="ident">ignoreArrayHelper</span><span class="op">(</span><span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">elemOp</span><span class="op">,</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;decodeInterface&nbsp;decodes&nbsp;an&nbsp;interface&nbsp;value&nbsp;and&nbsp;stores&nbsp;it&nbsp;in&nbsp;value.</span><br>
<span class="lineno">625</span><span class="comment">//&nbsp;Interfaces&nbsp;are&nbsp;encoded&nbsp;as&nbsp;the&nbsp;name&nbsp;of&nbsp;a&nbsp;concrete&nbsp;type&nbsp;followed&nbsp;by&nbsp;a&nbsp;value.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;the&nbsp;name&nbsp;is&nbsp;empty,&nbsp;the&nbsp;value&nbsp;is&nbsp;nil&nbsp;and&nbsp;no&nbsp;value&nbsp;is&nbsp;sent.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">dec</span>&nbsp;<span class="op">*</span><span class="ident">Decoder</span><span class="op">)</span>&nbsp;<span class="ident">decodeInterface</span><span class="op">(</span><span class="ident">ityp</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Read&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nr</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">nr</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">nr</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">1</span><span class="op">&lt;&lt;</span><span class="num">31</span>&nbsp;<span class="op">{</span>&nbsp;<span class="comment">//&nbsp;zero&nbsp;is&nbsp;permissible&nbsp;for&nbsp;anonymous&nbsp;types</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;invalid&nbsp;type&nbsp;name&nbsp;length&nbsp;%d&#34;</span><span class="op">,</span>&nbsp;<span class="ident">nr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">nr</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">uint64</span><span class="op">(</span><span class="ident">state</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">Len</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;invalid&nbsp;type&nbsp;name&nbsp;length&nbsp;%d:&nbsp;exceeds&nbsp;input&nbsp;size&#34;</span><span class="op">,</span>&nbsp;<span class="ident">nr</span><span class="op">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">nr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">Read</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">string</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Allocate&nbsp;the&nbsp;destination&nbsp;interface&nbsp;value.</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">name</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Copy&nbsp;the&nbsp;nil&nbsp;interface&nbsp;value&nbsp;to&nbsp;the&nbsp;target.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">value</span><span class="op">.</span><span class="ident">Set</span><span class="op">(</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">Zero</span><span class="op">(</span><span class="ident">value</span><span class="op">.</span><span class="ident">Type</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">name</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">1024</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;name&nbsp;too&nbsp;long&nbsp;(%d&nbsp;bytes):&nbsp;%.20q...&#34;</span><span class="op">,</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">name</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">name</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;concrete&nbsp;type&nbsp;must&nbsp;be&nbsp;registered.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">registerLock</span><span class="op">.</span><span class="ident">RLock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">typ</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">nameToConcreteType</span><span class="op">[</span><span class="ident">name</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">registerLock</span><span class="op">.</span><span class="ident">RUnlock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;name&nbsp;not&nbsp;registered&nbsp;for&nbsp;interface:&nbsp;%q&#34;</span><span class="op">,</span>&nbsp;<span class="ident">name</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Read&nbsp;the&nbsp;type&nbsp;id&nbsp;of&nbsp;the&nbsp;concrete&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">concreteId</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">decodeTypeSequence</span><span class="op">(</span><span class="ident">true</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">concreteId</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">error_</span><span class="op">(</span><span class="ident">dec</span><span class="op">.</span><span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Byte&nbsp;count&nbsp;of&nbsp;value&nbsp;is&nbsp;next;&nbsp;we&nbsp;don&#39;t&nbsp;care&nbsp;what&nbsp;it&nbsp;is&nbsp;(it&#39;s&nbsp;there</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;in&nbsp;case&nbsp;we&nbsp;want&nbsp;to&nbsp;ignore&nbsp;the&nbsp;value&nbsp;by&nbsp;skipping&nbsp;it&nbsp;completely).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Read&nbsp;the&nbsp;concrete&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">allocValue</span><span class="op">(</span><span class="ident">typ</span><span class="op">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dec</span><span class="op">.</span><span class="ident">decodeValue</span><span class="op">(</span><span class="ident">concreteId</span><span class="op">,</span>&nbsp;<span class="ident">v</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">error_</span><span class="op">(</span><span class="ident">dec</span><span class="op">.</span><span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Assign&nbsp;the&nbsp;concrete&nbsp;value&nbsp;to&nbsp;the&nbsp;interface.</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Tread&nbsp;carefully;&nbsp;it&nbsp;might&nbsp;not&nbsp;satisfy&nbsp;the&nbsp;interface.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">typ</span><span class="op">.</span><span class="ident">AssignableTo</span><span class="op">(</span><span class="ident">ityp</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;%s&nbsp;is&nbsp;not&nbsp;assignable&nbsp;to&nbsp;type&nbsp;%s&#34;</span><span class="op">,</span>&nbsp;<span class="ident">typ</span><span class="op">,</span>&nbsp;<span class="ident">ityp</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Copy&nbsp;the&nbsp;interface&nbsp;value&nbsp;to&nbsp;the&nbsp;target.</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">value</span><span class="op">.</span><span class="ident">Set</span><span class="op">(</span><span class="ident">v</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ignoreInterface&nbsp;discards&nbsp;the&nbsp;data&nbsp;for&nbsp;an&nbsp;interface&nbsp;value&nbsp;with&nbsp;no&nbsp;destination.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">dec</span>&nbsp;<span class="op">*</span><span class="ident">Decoder</span><span class="op">)</span>&nbsp;<span class="ident">ignoreInterface</span><span class="op">(</span><span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Read&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">Read</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">error_</span><span class="op">(</span><span class="ident">err</span><span class="op">)</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">id</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">decodeTypeSequence</span><span class="op">(</span><span class="ident">true</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">id</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">error_</span><span class="op">(</span><span class="ident">dec</span><span class="op">.</span><span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;At&nbsp;this&nbsp;point,&nbsp;the&nbsp;decoder&nbsp;buffer&nbsp;contains&nbsp;a&nbsp;delimited&nbsp;value.&nbsp;Just&nbsp;toss&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">Drop</span><span class="op">(</span><span class="builtintype">int</span><span class="op">(</span><span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;decodeGobDecoder&nbsp;decodes&nbsp;something&nbsp;implementing&nbsp;the&nbsp;GobDecoder&nbsp;interface.</span><br>
<span class="lineno">695</span><span class="comment">//&nbsp;The&nbsp;data&nbsp;is&nbsp;encoded&nbsp;as&nbsp;a&nbsp;byte&nbsp;slice.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">dec</span>&nbsp;<span class="op">*</span><span class="ident">Decoder</span><span class="op">)</span>&nbsp;<span class="ident">decodeGobDecoder</span><span class="op">(</span><span class="ident">ut</span>&nbsp;<span class="op">*</span><span class="ident">userTypeInfo</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Read&nbsp;the&nbsp;bytes&nbsp;for&nbsp;the&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">Read</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">error_</span><span class="op">(</span><span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&nbsp;know&nbsp;it&#39;s&nbsp;one&nbsp;of&nbsp;these.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">externalDec</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">xGob</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">value</span><span class="op">.</span><span class="ident">Interface</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="op">(</span><span class="ident">GobDecoder</span><span class="op">)</span><span class="op">.</span><span class="ident">GobDecode</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">xBinary</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">value</span><span class="op">.</span><span class="ident">Interface</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="op">(</span><span class="ident">encoding</span><span class="op">.</span><span class="ident">BinaryUnmarshaler</span><span class="op">)</span><span class="op">.</span><span class="ident">UnmarshalBinary</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">xText</span><span class="op">:</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">value</span><span class="op">.</span><span class="ident">Interface</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="op">(</span><span class="ident">encoding</span><span class="op">.</span><span class="ident">TextUnmarshaler</span><span class="op">)</span><span class="op">.</span><span class="ident">UnmarshalText</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">error_</span><span class="op">(</span><span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">715</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ignoreGobDecoder&nbsp;discards&nbsp;the&nbsp;data&nbsp;for&nbsp;a&nbsp;GobDecoder&nbsp;value&nbsp;with&nbsp;no&nbsp;destination.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">dec</span>&nbsp;<span class="op">*</span><span class="ident">Decoder</span><span class="op">)</span>&nbsp;<span class="ident">ignoreGobDecoder</span><span class="op">(</span><span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Read&nbsp;the&nbsp;bytes&nbsp;for&nbsp;the&nbsp;value.</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">decodeUint</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">Read</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">error_</span><span class="op">(</span><span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">725</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Index&nbsp;by&nbsp;Go&nbsp;types.</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">decOpTable</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">...</span><span class="op">]</span><span class="ident">decOp</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reflect</span><span class="op">.</span><span class="ident">Bool</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">decBool</span><span class="op">,</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reflect</span><span class="op">.</span><span class="ident">Int8</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">decInt8</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reflect</span><span class="op">.</span><span class="ident">Int16</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">decInt16</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reflect</span><span class="op">.</span><span class="ident">Int32</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">decInt32</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reflect</span><span class="op">.</span><span class="ident">Int64</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">decInt64</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uint8</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">decUint8</span><span class="op">,</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uint16</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">decUint16</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uint32</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">decUint32</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uint64</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">decUint64</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reflect</span><span class="op">.</span><span class="ident">Float32</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">decFloat32</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reflect</span><span class="op">.</span><span class="ident">Float64</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">decFloat64</span><span class="op">,</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reflect</span><span class="op">.</span><span class="ident">Complex64</span><span class="op">:</span>&nbsp;&nbsp;<span class="ident">decComplex64</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reflect</span><span class="op">.</span><span class="ident">Complex128</span><span class="op">:</span>&nbsp;<span class="ident">decComplex128</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reflect</span><span class="op">.</span><span class="ident">String</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">decString</span><span class="op">,</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">745</span><span class="comment">//&nbsp;Indexed&nbsp;by&nbsp;gob&nbsp;types.&nbsp;&nbsp;tComplex&nbsp;will&nbsp;be&nbsp;added&nbsp;during&nbsp;type.init().</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">decIgnoreOpMap</span>&nbsp;<span class="op">=</span>&nbsp;<span class="keyword">map</span><span class="op">[</span><span class="ident">typeId</span><span class="op">]</span><span class="ident">decOp</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tBool</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">ignoreUint</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tInt</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">ignoreUint</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tUint</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">ignoreUint</span><span class="op">,</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tFloat</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;<span class="ident">ignoreUint</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tBytes</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;<span class="ident">ignoreUint8Array</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tString</span><span class="op">:</span>&nbsp;&nbsp;<span class="ident">ignoreUint8Array</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tComplex</span><span class="op">:</span>&nbsp;<span class="ident">ignoreTwoUints</span><span class="op">,</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">755</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;decOpFor&nbsp;returns&nbsp;the&nbsp;decoding&nbsp;op&nbsp;for&nbsp;the&nbsp;base&nbsp;type&nbsp;under&nbsp;rt&nbsp;and</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;the&nbsp;indirection&nbsp;count&nbsp;to&nbsp;reach&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">dec</span>&nbsp;<span class="op">*</span><span class="ident">Decoder</span><span class="op">)</span>&nbsp;<span class="ident">decOpFor</span><span class="op">(</span><span class="ident">wireId</span>&nbsp;<span class="ident">typeId</span><span class="op">,</span>&nbsp;<span class="ident">rt</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span><span class="op">,</span>&nbsp;<span class="ident">name</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">inProgress</span>&nbsp;<span class="keyword">map</span><span class="op">[</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span><span class="op">]</span><span class="op">*</span><span class="ident">decOp</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">decOp</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ut</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">userType</span><span class="op">(</span><span class="ident">rt</span><span class="op">)</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;If&nbsp;the&nbsp;type&nbsp;implements&nbsp;GobEncoder,&nbsp;we&nbsp;handle&nbsp;it&nbsp;without&nbsp;further&nbsp;processing.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">externalDec</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">gobDecodeOpFor</span><span class="op">(</span><span class="ident">ut</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;If&nbsp;this&nbsp;type&nbsp;is&nbsp;already&nbsp;in&nbsp;progress,&nbsp;it&#39;s&nbsp;a&nbsp;recursive&nbsp;type&nbsp;(e.g.&nbsp;map[string]*T).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Return&nbsp;the&nbsp;pointer&nbsp;to&nbsp;the&nbsp;op&nbsp;we&#39;re&nbsp;already&nbsp;building.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">opPtr</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">inProgress</span><span class="op">[</span><span class="ident">rt</span><span class="op">]</span><span class="op">;</span>&nbsp;<span class="ident">opPtr</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">opPtr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">typ</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">op</span>&nbsp;<span class="ident">decOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">k</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">typ</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">k</span><span class="op">)</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">decOpTable</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">decOpTable</span><span class="op">[</span><span class="ident">k</span><span class="op">]</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">op</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">inProgress</span><span class="op">[</span><span class="ident">rt</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">&amp;</span><span class="ident">op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Special&nbsp;cases</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">t</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">typ</span><span class="op">;</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Array</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#34;element&nbsp;of&nbsp;&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">elemId</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">wireType</span><span class="op">[</span><span class="ident">wireId</span><span class="op">]</span><span class="op">.</span><span class="ident">ArrayT</span><span class="op">.</span><span class="ident">Elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">elemOp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">decOpFor</span><span class="op">(</span><span class="ident">elemId</span><span class="op">,</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">name</span><span class="op">,</span>&nbsp;<span class="ident">inProgress</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ovfl</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">overflow</span><span class="op">(</span><span class="ident">name</span><span class="op">)</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">helper</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">decArrayHelper</span><span class="op">[</span><span class="ident">t</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span>&nbsp;<span class="op">=</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">dec</span><span class="op">.</span><span class="ident">decodeArray</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">value</span><span class="op">,</span>&nbsp;<span class="op">*</span><span class="ident">elemOp</span><span class="op">,</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Len</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">ovfl</span><span class="op">,</span>&nbsp;<span class="ident">helper</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Map</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">keyId</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">wireType</span><span class="op">[</span><span class="ident">wireId</span><span class="op">]</span><span class="op">.</span><span class="ident">MapT</span><span class="op">.</span><span class="ident">Key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">elemId</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">wireType</span><span class="op">[</span><span class="ident">wireId</span><span class="op">]</span><span class="op">.</span><span class="ident">MapT</span><span class="op">.</span><span class="ident">Elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">keyOp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">decOpFor</span><span class="op">(</span><span class="ident">keyId</span><span class="op">,</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Key</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="string">&#34;key&nbsp;of&nbsp;&#34;</span><span class="op">+</span><span class="ident">name</span><span class="op">,</span>&nbsp;<span class="ident">inProgress</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">elemOp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">decOpFor</span><span class="op">(</span><span class="ident">elemId</span><span class="op">,</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="string">&#34;element&nbsp;of&nbsp;&#34;</span><span class="op">+</span><span class="ident">name</span><span class="op">,</span>&nbsp;<span class="ident">inProgress</span><span class="op">)</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ovfl</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">overflow</span><span class="op">(</span><span class="ident">name</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span>&nbsp;<span class="op">=</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">dec</span><span class="op">.</span><span class="ident">decodeMap</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">value</span><span class="op">,</span>&nbsp;<span class="op">*</span><span class="ident">keyOp</span><span class="op">,</span>&nbsp;<span class="op">*</span><span class="ident">elemOp</span><span class="op">,</span>&nbsp;<span class="ident">ovfl</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Slice</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#34;element&nbsp;of&nbsp;&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uint8</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">decUint8Slice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">elemId</span>&nbsp;<span class="ident">typeId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">tt</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">builtinIdToType</span><span class="op">[</span><span class="ident">wireId</span><span class="op">]</span><span class="op">;</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">elemId</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">sliceType</span><span class="op">)</span><span class="op">.</span><span class="ident">Elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">elemId</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">wireType</span><span class="op">[</span><span class="ident">wireId</span><span class="op">]</span><span class="op">.</span><span class="ident">SliceT</span><span class="op">.</span><span class="ident">Elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">elemOp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">decOpFor</span><span class="op">(</span><span class="ident">elemId</span><span class="op">,</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">name</span><span class="op">,</span>&nbsp;<span class="ident">inProgress</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ovfl</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">overflow</span><span class="op">(</span><span class="ident">name</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">helper</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">decSliceHelper</span><span class="op">[</span><span class="ident">t</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span><span class="op">]</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span>&nbsp;<span class="op">=</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">dec</span><span class="op">.</span><span class="ident">decodeSlice</span><span class="op">(</span><span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">value</span><span class="op">,</span>&nbsp;<span class="op">*</span><span class="ident">elemOp</span><span class="op">,</span>&nbsp;<span class="ident">ovfl</span><span class="op">,</span>&nbsp;<span class="ident">helper</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Struct</span><span class="op">:</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Generate&nbsp;a&nbsp;closure&nbsp;that&nbsp;calls&nbsp;out&nbsp;to&nbsp;the&nbsp;engine&nbsp;for&nbsp;the&nbsp;nested&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ut</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">userType</span><span class="op">(</span><span class="ident">typ</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">enginePtr</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">getDecEnginePtr</span><span class="op">(</span><span class="ident">wireId</span><span class="op">,</span>&nbsp;<span class="ident">ut</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">error_</span><span class="op">(</span><span class="ident">err</span><span class="op">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span>&nbsp;<span class="op">=</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;indirect&nbsp;through&nbsp;enginePtr&nbsp;to&nbsp;delay&nbsp;evaluation&nbsp;for&nbsp;recursive&nbsp;structs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dec</span><span class="op">.</span><span class="ident">decodeStruct</span><span class="op">(</span><span class="op">*</span><span class="ident">enginePtr</span><span class="op">,</span>&nbsp;<span class="ident">ut</span><span class="op">,</span>&nbsp;<span class="ident">value</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Interface</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span>&nbsp;<span class="op">=</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">dec</span><span class="op">.</span><span class="ident">decodeInterface</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">value</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">op</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;decode&nbsp;can&#39;t&nbsp;handle&nbsp;type&nbsp;%s&#34;</span><span class="op">,</span>&nbsp;<span class="ident">rt</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">op</span><br>
<span class="lineno">840</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;decIgnoreOpFor&nbsp;returns&nbsp;the&nbsp;decoding&nbsp;op&nbsp;for&nbsp;a&nbsp;field&nbsp;that&nbsp;has&nbsp;no&nbsp;destination.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">dec</span>&nbsp;<span class="op">*</span><span class="ident">Decoder</span><span class="op">)</span>&nbsp;<span class="ident">decIgnoreOpFor</span><span class="op">(</span><span class="ident">wireId</span>&nbsp;<span class="ident">typeId</span><span class="op">)</span>&nbsp;<span class="ident">decOp</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">decIgnoreOpMap</span><span class="op">[</span><span class="ident">wireId</span><span class="op">]</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">wireId</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">tInterface</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Special&nbsp;case&nbsp;because&nbsp;it&#39;s&nbsp;a&nbsp;method:&nbsp;the&nbsp;ignored&nbsp;item&nbsp;might</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;define&nbsp;types&nbsp;and&nbsp;we&nbsp;need&nbsp;to&nbsp;record&nbsp;their&nbsp;state&nbsp;in&nbsp;the&nbsp;decoder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span>&nbsp;<span class="op">=</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">dec</span><span class="op">.</span><span class="ident">ignoreInterface</span><span class="op">(</span><span class="ident">state</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Special&nbsp;cases</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">wire</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">wireType</span><span class="op">[</span><span class="ident">wireId</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">wire</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;bad&nbsp;data:&nbsp;undefined&nbsp;type&nbsp;%s&#34;</span><span class="op">,</span>&nbsp;<span class="ident">wireId</span><span class="op">.</span><span class="builtintype">string</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">wire</span><span class="op">.</span><span class="ident">ArrayT</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span><span class="op">:</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">elemId</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">wire</span><span class="op">.</span><span class="ident">ArrayT</span><span class="op">.</span><span class="ident">Elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">elemOp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">decIgnoreOpFor</span><span class="op">(</span><span class="ident">elemId</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span>&nbsp;<span class="op">=</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">dec</span><span class="op">.</span><span class="ident">ignoreArray</span><span class="op">(</span><span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">elemOp</span><span class="op">,</span>&nbsp;<span class="ident">wire</span><span class="op">.</span><span class="ident">ArrayT</span><span class="op">.</span><span class="ident">Len</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">865</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">wire</span><span class="op">.</span><span class="ident">MapT</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">keyId</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">wireType</span><span class="op">[</span><span class="ident">wireId</span><span class="op">]</span><span class="op">.</span><span class="ident">MapT</span><span class="op">.</span><span class="ident">Key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">elemId</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">wireType</span><span class="op">[</span><span class="ident">wireId</span><span class="op">]</span><span class="op">.</span><span class="ident">MapT</span><span class="op">.</span><span class="ident">Elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">keyOp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">decIgnoreOpFor</span><span class="op">(</span><span class="ident">keyId</span><span class="op">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">elemOp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">decIgnoreOpFor</span><span class="op">(</span><span class="ident">elemId</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span>&nbsp;<span class="op">=</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">dec</span><span class="op">.</span><span class="ident">ignoreMap</span><span class="op">(</span><span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">keyOp</span><span class="op">,</span>&nbsp;<span class="ident">elemOp</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">wire</span><span class="op">.</span><span class="ident">SliceT</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">elemId</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">wire</span><span class="op">.</span><span class="ident">SliceT</span><span class="op">.</span><span class="ident">Elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">elemOp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">decIgnoreOpFor</span><span class="op">(</span><span class="ident">elemId</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span>&nbsp;<span class="op">=</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">dec</span><span class="op">.</span><span class="ident">ignoreSlice</span><span class="op">(</span><span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">elemOp</span><span class="op">)</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">wire</span><span class="op">.</span><span class="ident">StructT</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Generate&nbsp;a&nbsp;closure&nbsp;that&nbsp;calls&nbsp;out&nbsp;to&nbsp;the&nbsp;engine&nbsp;for&nbsp;the&nbsp;nested&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">enginePtr</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">getIgnoreEnginePtr</span><span class="op">(</span><span class="ident">wireId</span><span class="op">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">error_</span><span class="op">(</span><span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span>&nbsp;<span class="op">=</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;indirect&nbsp;through&nbsp;enginePtr&nbsp;to&nbsp;delay&nbsp;evaluation&nbsp;for&nbsp;recursive&nbsp;structs</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">dec</span><span class="op">.</span><span class="ident">ignoreStruct</span><span class="op">(</span><span class="op">*</span><span class="ident">enginePtr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">wire</span><span class="op">.</span><span class="ident">GobEncoderT</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">wire</span><span class="op">.</span><span class="ident">BinaryMarshalerT</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">wire</span><span class="op">.</span><span class="ident">TextMarshalerT</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span>&nbsp;<span class="op">=</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">dec</span><span class="op">.</span><span class="ident">ignoreGobDecoder</span><span class="op">(</span><span class="ident">state</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">op</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;bad&nbsp;data:&nbsp;ignore&nbsp;can&#39;t&nbsp;handle&nbsp;type&nbsp;%s&#34;</span><span class="op">,</span>&nbsp;<span class="ident">wireId</span><span class="op">.</span><span class="builtintype">string</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">op</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">905</span><span class="comment">//&nbsp;gobDecodeOpFor&nbsp;returns&nbsp;the&nbsp;op&nbsp;for&nbsp;a&nbsp;type&nbsp;that&nbsp;is&nbsp;known&nbsp;to&nbsp;implement</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;GobDecoder.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">dec</span>&nbsp;<span class="op">*</span><span class="ident">Decoder</span><span class="op">)</span>&nbsp;<span class="ident">gobDecodeOpFor</span><span class="op">(</span><span class="ident">ut</span>&nbsp;<span class="op">*</span><span class="ident">userTypeInfo</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">decOp</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rcvrType</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">decIndir</span>&nbsp;<span class="op">==</span>&nbsp;<span class="op">-</span><span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rcvrType</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">PtrTo</span><span class="op">(</span><span class="ident">rcvrType</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="keyword">if</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">decIndir</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">int8</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">decIndir</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rcvrType</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">rcvrType</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">op</span>&nbsp;<span class="ident">decOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span>&nbsp;<span class="op">=</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">decoderState</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&nbsp;now&nbsp;have&nbsp;the&nbsp;base&nbsp;type.&nbsp;We&nbsp;need&nbsp;its&nbsp;address&nbsp;if&nbsp;the&nbsp;receiver&nbsp;is&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">value</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Ptr</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">rcvrType</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Ptr</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">value</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">value</span><span class="op">.</span><span class="ident">Addr</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">dec</span><span class="op">.</span><span class="ident">decodeGobDecoder</span><span class="op">(</span><span class="ident">ut</span><span class="op">,</span>&nbsp;<span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">value</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">op</span><br>
<span class="lineno">925</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;compatibleType&nbsp;asks:&nbsp;Are&nbsp;these&nbsp;two&nbsp;gob&nbsp;Types&nbsp;compatible?</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Answers&nbsp;the&nbsp;question&nbsp;for&nbsp;basic&nbsp;types,&nbsp;arrays,&nbsp;maps&nbsp;and&nbsp;slices,&nbsp;plus</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;GobEncoder/Decoder&nbsp;pairs.</span><br>
<span class="lineno">930</span><span class="comment">//&nbsp;Structs&nbsp;are&nbsp;considered&nbsp;ok;&nbsp;fields&nbsp;will&nbsp;be&nbsp;checked&nbsp;later.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">dec</span>&nbsp;<span class="op">*</span><span class="ident">Decoder</span><span class="op">)</span>&nbsp;<span class="ident">compatibleType</span><span class="op">(</span><span class="ident">fr</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span><span class="op">,</span>&nbsp;<span class="ident">fw</span>&nbsp;<span class="ident">typeId</span><span class="op">,</span>&nbsp;<span class="ident">inProgress</span>&nbsp;<span class="keyword">map</span><span class="op">[</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span><span class="op">]</span><span class="ident">typeId</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">rhs</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">inProgress</span><span class="op">[</span><span class="ident">fr</span><span class="op">]</span><span class="op">;</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">rhs</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">fw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">inProgress</span><span class="op">[</span><span class="ident">fr</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">fw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ut</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">userType</span><span class="op">(</span><span class="ident">fr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">wire</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">wireType</span><span class="op">[</span><span class="ident">fw</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;If&nbsp;wire&nbsp;was&nbsp;encoded&nbsp;with&nbsp;an&nbsp;encoding&nbsp;method,&nbsp;fr&nbsp;must&nbsp;have&nbsp;that&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;And&nbsp;if&nbsp;not,&nbsp;it&nbsp;must&nbsp;not.</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;At&nbsp;most&nbsp;one&nbsp;of&nbsp;the&nbsp;booleans&nbsp;in&nbsp;ut&nbsp;is&nbsp;set.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&nbsp;could&nbsp;possibly&nbsp;relax&nbsp;this&nbsp;constraint&nbsp;in&nbsp;the&nbsp;future&nbsp;in&nbsp;order&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;choose&nbsp;the&nbsp;decoding&nbsp;method&nbsp;using&nbsp;the&nbsp;data&nbsp;in&nbsp;the&nbsp;wireType.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;parentheses&nbsp;look&nbsp;odd&nbsp;but&nbsp;are&nbsp;correct.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">(</span><span class="ident">ut</span><span class="op">.</span><span class="ident">externalDec</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">xGob</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="op">(</span><span class="ident">ok</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">wire</span><span class="op">.</span><span class="ident">GobEncoderT</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span><span class="op">)</span>&nbsp;<span class="op">||</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">(</span><span class="ident">ut</span><span class="op">.</span><span class="ident">externalDec</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">xBinary</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="op">(</span><span class="ident">ok</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">wire</span><span class="op">.</span><span class="ident">BinaryMarshalerT</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span><span class="op">)</span>&nbsp;<span class="op">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">(</span><span class="ident">ut</span><span class="op">.</span><span class="ident">externalDec</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">xText</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="op">(</span><span class="ident">ok</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">wire</span><span class="op">.</span><span class="ident">TextMarshalerT</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">externalDec</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span>&nbsp;<span class="comment">//&nbsp;This&nbsp;test&nbsp;trumps&nbsp;all&nbsp;others.</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">t</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">base</span><span class="op">;</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;chan,&nbsp;etc:&nbsp;cannot&nbsp;handle.</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Bool</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fw</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">tBool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Int</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Int8</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Int16</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Int32</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Int64</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fw</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">tInt</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uint</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uint8</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uint16</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uint32</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uint64</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uintptr</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fw</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">tUint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Float32</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Float64</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fw</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">tFloat</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Complex64</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Complex128</span><span class="op">:</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fw</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">tComplex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">String</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fw</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">tString</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Interface</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fw</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">tInterface</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Array</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">wire</span><span class="op">.</span><span class="ident">ArrayT</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">array</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">wire</span><span class="op">.</span><span class="ident">ArrayT</span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Len</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">array</span><span class="op">.</span><span class="ident">Len</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">compatibleType</span><span class="op">(</span><span class="ident">t</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">array</span><span class="op">.</span><span class="ident">Elem</span><span class="op">,</span>&nbsp;<span class="ident">inProgress</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Map</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">wire</span><span class="op">.</span><span class="ident">MapT</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">MapType</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">wire</span><span class="op">.</span><span class="ident">MapT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">compatibleType</span><span class="op">(</span><span class="ident">t</span><span class="op">.</span><span class="ident">Key</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">MapType</span><span class="op">.</span><span class="ident">Key</span><span class="op">,</span>&nbsp;<span class="ident">inProgress</span><span class="op">)</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">compatibleType</span><span class="op">(</span><span class="ident">t</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">MapType</span><span class="op">.</span><span class="ident">Elem</span><span class="op">,</span>&nbsp;<span class="ident">inProgress</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Slice</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Is&nbsp;it&nbsp;an&nbsp;array&nbsp;of&nbsp;bytes?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uint8</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fw</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">tBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Extract&nbsp;and&nbsp;compare&nbsp;element&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">sw</span>&nbsp;<span class="op">*</span><span class="ident">sliceType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">tt</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">builtinIdToType</span><span class="op">[</span><span class="ident">fw</span><span class="op">]</span><span class="op">;</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sw</span><span class="op">,</span>&nbsp;<span class="ident">_</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">sliceType</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="keyword">if</span>&nbsp;<span class="ident">wire</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sw</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">wire</span><span class="op">.</span><span class="ident">SliceT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">elem</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">userType</span><span class="op">(</span><span class="ident">t</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">.</span><span class="ident">base</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">sw</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">compatibleType</span><span class="op">(</span><span class="ident">elem</span><span class="op">,</span>&nbsp;<span class="ident">sw</span><span class="op">.</span><span class="ident">Elem</span><span class="op">,</span>&nbsp;<span class="ident">inProgress</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Struct</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">1000</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;typeString&nbsp;returns&nbsp;a&nbsp;human-readable&nbsp;description&nbsp;of&nbsp;the&nbsp;type&nbsp;identified&nbsp;by&nbsp;remoteId.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">dec</span>&nbsp;<span class="op">*</span><span class="ident">Decoder</span><span class="op">)</span>&nbsp;<span class="ident">typeString</span><span class="op">(</span><span class="ident">remoteId</span>&nbsp;<span class="ident">typeId</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">t</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">idToType</span><span class="op">[</span><span class="ident">remoteId</span><span class="op">]</span><span class="op">;</span>&nbsp;<span class="ident">t</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;globally&nbsp;known&nbsp;type.</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="builtintype">string</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">wireType</span><span class="op">[</span><span class="ident">remoteId</span><span class="op">]</span><span class="op">.</span><span class="builtintype">string</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1010</span><span class="comment">//&nbsp;compileSingle&nbsp;compiles&nbsp;the&nbsp;decoder&nbsp;engine&nbsp;for&nbsp;a&nbsp;non-struct&nbsp;top-level&nbsp;value,&nbsp;including</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;GobDecoders.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">dec</span>&nbsp;<span class="op">*</span><span class="ident">Decoder</span><span class="op">)</span>&nbsp;<span class="ident">compileSingle</span><span class="op">(</span><span class="ident">remoteId</span>&nbsp;<span class="ident">typeId</span><span class="op">,</span>&nbsp;<span class="ident">ut</span>&nbsp;<span class="op">*</span><span class="ident">userTypeInfo</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">engine</span>&nbsp;<span class="op">*</span><span class="ident">decEngine</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rt</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">engine</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">decEngine</span><span class="op">)</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">engine</span><span class="op">.</span><span class="ident">instr</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;one&nbsp;item</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">rt</span><span class="op">.</span><span class="ident">String</span><span class="op">(</span><span class="op">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;best&nbsp;we&nbsp;can&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">dec</span><span class="op">.</span><span class="ident">compatibleType</span><span class="op">(</span><span class="ident">rt</span><span class="op">,</span>&nbsp;<span class="ident">remoteId</span><span class="op">,</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">map</span><span class="op">[</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span><span class="op">]</span><span class="ident">typeId</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">remoteType</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">typeString</span><span class="op">(</span><span class="ident">remoteId</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Common&nbsp;confusing&nbsp;case:&nbsp;local&nbsp;interface&nbsp;type,&nbsp;remote&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">base</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Interface</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">remoteId</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">tInterface</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;gob:&nbsp;local&nbsp;interface&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">name</span>&nbsp;<span class="op">+</span>&nbsp;<span class="string">&#34;&nbsp;can&nbsp;only&nbsp;be&nbsp;decoded&nbsp;from&nbsp;remote&nbsp;interface&nbsp;type;&nbsp;received&nbsp;concrete&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">remoteType</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;gob:&nbsp;decoding&nbsp;into&nbsp;local&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">name</span>&nbsp;<span class="op">+</span>&nbsp;<span class="string">&#34;,&nbsp;received&nbsp;remote&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">remoteType</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">decOpFor</span><span class="op">(</span><span class="ident">remoteId</span><span class="op">,</span>&nbsp;<span class="ident">rt</span><span class="op">,</span>&nbsp;<span class="ident">name</span><span class="op">,</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">map</span><span class="op">[</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span><span class="op">]</span><span class="op">*</span><span class="ident">decOp</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ovfl</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">`value&nbsp;for&nbsp;&#34;`</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">name</span>&nbsp;<span class="op">+</span>&nbsp;<span class="string">`&#34;&nbsp;out&nbsp;of&nbsp;range`</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">engine</span><span class="op">.</span><span class="ident">instr</span><span class="op">[</span><span class="ident">singletonField</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">decInstr</span><span class="op">{</span><span class="op">*</span><span class="ident">op</span><span class="op">,</span>&nbsp;<span class="ident">singletonField</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">ovfl</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">engine</span><span class="op">.</span><span class="ident">numInstr</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno">1030</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;compileIgnoreSingle&nbsp;compiles&nbsp;the&nbsp;decoder&nbsp;engine&nbsp;for&nbsp;a&nbsp;non-struct&nbsp;top-level&nbsp;value&nbsp;that&nbsp;will&nbsp;be&nbsp;discarded.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">dec</span>&nbsp;<span class="op">*</span><span class="ident">Decoder</span><span class="op">)</span>&nbsp;<span class="ident">compileIgnoreSingle</span><span class="op">(</span><span class="ident">remoteId</span>&nbsp;<span class="ident">typeId</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">engine</span>&nbsp;<span class="op">*</span><span class="ident">decEngine</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">engine</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">decEngine</span><span class="op">)</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">engine</span><span class="op">.</span><span class="ident">instr</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;one&nbsp;item</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">decIgnoreOpFor</span><span class="op">(</span><span class="ident">remoteId</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ovfl</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">overflow</span><span class="op">(</span><span class="ident">dec</span><span class="op">.</span><span class="ident">typeString</span><span class="op">(</span><span class="ident">remoteId</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">engine</span><span class="op">.</span><span class="ident">instr</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">decInstr</span><span class="op">{</span><span class="ident">op</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">ovfl</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">engine</span><span class="op">.</span><span class="ident">numInstr</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;compileDec&nbsp;compiles&nbsp;the&nbsp;decoder&nbsp;engine&nbsp;for&nbsp;a&nbsp;value.&nbsp;&nbsp;If&nbsp;the&nbsp;value&nbsp;is&nbsp;not&nbsp;a&nbsp;struct,</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;it&nbsp;calls&nbsp;out&nbsp;to&nbsp;compileSingle.</span><br>
<span class="lineno">1045</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">dec</span>&nbsp;<span class="op">*</span><span class="ident">Decoder</span><span class="op">)</span>&nbsp;<span class="ident">compileDec</span><span class="op">(</span><span class="ident">remoteId</span>&nbsp;<span class="ident">typeId</span><span class="op">,</span>&nbsp;<span class="ident">ut</span>&nbsp;<span class="op">*</span><span class="ident">userTypeInfo</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">engine</span>&nbsp;<span class="op">*</span><span class="ident">decEngine</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rt</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">srt</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">rt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">srt</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Struct</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">externalDec</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">compileSingle</span><span class="op">(</span><span class="ident">remoteId</span><span class="op">,</span>&nbsp;<span class="ident">ut</span><span class="op">)</span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">wireStruct</span>&nbsp;<span class="op">*</span><span class="ident">structType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Builtin&nbsp;types&nbsp;can&nbsp;come&nbsp;from&nbsp;global&nbsp;pool;&nbsp;the&nbsp;rest&nbsp;must&nbsp;be&nbsp;defined&nbsp;by&nbsp;the&nbsp;decoder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Also&nbsp;we&nbsp;know&nbsp;we&#39;re&nbsp;decoding&nbsp;a&nbsp;struct&nbsp;now,&nbsp;so&nbsp;the&nbsp;client&nbsp;must&nbsp;have&nbsp;sent&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">builtinIdToType</span><span class="op">[</span><span class="ident">remoteId</span><span class="op">]</span><span class="op">;</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">wireStruct</span><span class="op">,</span>&nbsp;<span class="ident">_</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">structType</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">wire</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">wireType</span><span class="op">[</span><span class="ident">remoteId</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">wire</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">error_</span><span class="op">(</span><span class="ident">errBadType</span><span class="op">)</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">wireStruct</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">wire</span><span class="op">.</span><span class="ident">StructT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">wireStruct</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;type&nbsp;mismatch&nbsp;in&nbsp;decoder:&nbsp;want&nbsp;struct&nbsp;type&nbsp;%s;&nbsp;got&nbsp;non-struct&#34;</span><span class="op">,</span>&nbsp;<span class="ident">rt</span><span class="op">)</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">engine</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">decEngine</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">engine</span><span class="op">.</span><span class="ident">instr</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="ident">decInstr</span><span class="op">,</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">wireStruct</span><span class="op">.</span><span class="ident">Field</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">seen</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">map</span><span class="op">[</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span><span class="op">]</span><span class="op">*</span><span class="ident">decOp</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Loop&nbsp;over&nbsp;the&nbsp;fields&nbsp;of&nbsp;the&nbsp;wire&nbsp;type.</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">fieldnum</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">fieldnum</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">wireStruct</span><span class="op">.</span><span class="ident">Field</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">fieldnum</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">wireField</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">wireStruct</span><span class="op">.</span><span class="ident">Field</span><span class="op">[</span><span class="ident">fieldnum</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">wireField</span><span class="op">.</span><span class="ident">Name</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;empty&nbsp;name&nbsp;for&nbsp;remote&nbsp;field&nbsp;of&nbsp;type&nbsp;%s&#34;</span><span class="op">,</span>&nbsp;<span class="ident">wireStruct</span><span class="op">.</span><span class="ident">Name</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ovfl</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">overflow</span><span class="op">(</span><span class="ident">wireField</span><span class="op">.</span><span class="ident">Name</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Find&nbsp;the&nbsp;field&nbsp;of&nbsp;the&nbsp;local&nbsp;type&nbsp;with&nbsp;the&nbsp;same&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">localField</span><span class="op">,</span>&nbsp;<span class="ident">present</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">srt</span><span class="op">.</span><span class="ident">FieldByName</span><span class="op">(</span><span class="ident">wireField</span><span class="op">.</span><span class="ident">Name</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;TODO(r):&nbsp;anonymous&nbsp;names</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">present</span>&nbsp;<span class="op">||</span>&nbsp;<span class="op">!</span><span class="ident">isExported</span><span class="op">(</span><span class="ident">wireField</span><span class="op">.</span><span class="ident">Name</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">decIgnoreOpFor</span><span class="op">(</span><span class="ident">wireField</span><span class="op">.</span><span class="ident">Id</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">engine</span><span class="op">.</span><span class="ident">instr</span><span class="op">[</span><span class="ident">fieldnum</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">decInstr</span><span class="op">{</span><span class="ident">op</span><span class="op">,</span>&nbsp;<span class="ident">fieldnum</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">ovfl</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">dec</span><span class="op">.</span><span class="ident">compatibleType</span><span class="op">(</span><span class="ident">localField</span><span class="op">.</span><span class="ident">Type</span><span class="op">,</span>&nbsp;<span class="ident">wireField</span><span class="op">.</span><span class="ident">Id</span><span class="op">,</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">map</span><span class="op">[</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span><span class="op">]</span><span class="ident">typeId</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;wrong&nbsp;type&nbsp;(%s)&nbsp;for&nbsp;received&nbsp;field&nbsp;%s.%s&#34;</span><span class="op">,</span>&nbsp;<span class="ident">localField</span><span class="op">.</span><span class="ident">Type</span><span class="op">,</span>&nbsp;<span class="ident">wireStruct</span><span class="op">.</span><span class="ident">Name</span><span class="op">,</span>&nbsp;<span class="ident">wireField</span><span class="op">.</span><span class="ident">Name</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">decOpFor</span><span class="op">(</span><span class="ident">wireField</span><span class="op">.</span><span class="ident">Id</span><span class="op">,</span>&nbsp;<span class="ident">localField</span><span class="op">.</span><span class="ident">Type</span><span class="op">,</span>&nbsp;<span class="ident">localField</span><span class="op">.</span><span class="ident">Name</span><span class="op">,</span>&nbsp;<span class="ident">seen</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">engine</span><span class="op">.</span><span class="ident">instr</span><span class="op">[</span><span class="ident">fieldnum</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">decInstr</span><span class="op">{</span><span class="op">*</span><span class="ident">op</span><span class="op">,</span>&nbsp;<span class="ident">fieldnum</span><span class="op">,</span>&nbsp;<span class="ident">localField</span><span class="op">.</span><span class="ident">Index</span><span class="op">,</span>&nbsp;<span class="ident">ovfl</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">engine</span><span class="op">.</span><span class="ident">numInstr</span><span class="op">++</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;getDecEnginePtr&nbsp;returns&nbsp;the&nbsp;engine&nbsp;for&nbsp;the&nbsp;specified&nbsp;type.</span><br>
<span class="lineno">1095</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">dec</span>&nbsp;<span class="op">*</span><span class="ident">Decoder</span><span class="op">)</span>&nbsp;<span class="ident">getDecEnginePtr</span><span class="op">(</span><span class="ident">remoteId</span>&nbsp;<span class="ident">typeId</span><span class="op">,</span>&nbsp;<span class="ident">ut</span>&nbsp;<span class="op">*</span><span class="ident">userTypeInfo</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">enginePtr</span>&nbsp;<span class="op">*</span><span class="op">*</span><span class="ident">decEngine</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rt</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">decoderMap</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">decoderCache</span><span class="op">[</span><span class="ident">rt</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">decoderMap</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">map</span><span class="op">[</span><span class="ident">typeId</span><span class="op">]</span><span class="op">*</span><span class="op">*</span><span class="ident">decEngine</span><span class="op">)</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dec</span><span class="op">.</span><span class="ident">decoderCache</span><span class="op">[</span><span class="ident">rt</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">decoderMap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">enginePtr</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">decoderMap</span><span class="op">[</span><span class="ident">remoteId</span><span class="op">]</span><span class="op">;</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;To&nbsp;handle&nbsp;recursive&nbsp;types,&nbsp;mark&nbsp;this&nbsp;engine&nbsp;as&nbsp;underway&nbsp;before&nbsp;compiling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">enginePtr</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="op">*</span><span class="ident">decEngine</span><span class="op">)</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">decoderMap</span><span class="op">[</span><span class="ident">remoteId</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">enginePtr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">*</span><span class="ident">enginePtr</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">compileDec</span><span class="op">(</span><span class="ident">remoteId</span><span class="op">,</span>&nbsp;<span class="ident">ut</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">delete</span><span class="op">(</span><span class="ident">decoderMap</span><span class="op">,</span>&nbsp;<span class="ident">remoteId</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;emptyStruct&nbsp;is&nbsp;the&nbsp;type&nbsp;we&nbsp;compile&nbsp;into&nbsp;when&nbsp;ignoring&nbsp;a&nbsp;struct&nbsp;value.</span><br>
<span class="lineno">1115</span><span class="keyword">type</span>&nbsp;<span class="ident">emptyStruct</span>&nbsp;<span class="keyword">struct</span><span class="op">{</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">emptyStructType</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">TypeOf</span><span class="op">(</span><span class="ident">emptyStruct</span><span class="op">{</span><span class="op">}</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;getDecEnginePtr&nbsp;returns&nbsp;the&nbsp;engine&nbsp;for&nbsp;the&nbsp;specified&nbsp;type&nbsp;when&nbsp;the&nbsp;value&nbsp;is&nbsp;to&nbsp;be&nbsp;discarded.</span><br>
<span class="lineno">1120</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">dec</span>&nbsp;<span class="op">*</span><span class="ident">Decoder</span><span class="op">)</span>&nbsp;<span class="ident">getIgnoreEnginePtr</span><span class="op">(</span><span class="ident">wireId</span>&nbsp;<span class="ident">typeId</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">enginePtr</span>&nbsp;<span class="op">*</span><span class="op">*</span><span class="ident">decEngine</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="builtintype">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">enginePtr</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">ignorerCache</span><span class="op">[</span><span class="ident">wireId</span><span class="op">]</span><span class="op">;</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;To&nbsp;handle&nbsp;recursive&nbsp;types,&nbsp;mark&nbsp;this&nbsp;engine&nbsp;as&nbsp;underway&nbsp;before&nbsp;compiling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">enginePtr</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="op">*</span><span class="ident">decEngine</span><span class="op">)</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dec</span><span class="op">.</span><span class="ident">ignorerCache</span><span class="op">[</span><span class="ident">wireId</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">enginePtr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">wire</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">wireType</span><span class="op">[</span><span class="ident">wireId</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">wire</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">wire</span><span class="op">.</span><span class="ident">StructT</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">*</span><span class="ident">enginePtr</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">compileDec</span><span class="op">(</span><span class="ident">wireId</span><span class="op">,</span>&nbsp;<span class="ident">userType</span><span class="op">(</span><span class="ident">emptyStructType</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">*</span><span class="ident">enginePtr</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">compileIgnoreSingle</span><span class="op">(</span><span class="ident">wireId</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">delete</span><span class="op">(</span><span class="ident">dec</span><span class="op">.</span><span class="ident">ignorerCache</span><span class="op">,</span>&nbsp;<span class="ident">wireId</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;decodeValue&nbsp;decodes&nbsp;the&nbsp;data&nbsp;stream&nbsp;representing&nbsp;a&nbsp;value&nbsp;and&nbsp;stores&nbsp;it&nbsp;in&nbsp;value.</span><br>
<span class="lineno">1140</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">dec</span>&nbsp;<span class="op">*</span><span class="ident">Decoder</span><span class="op">)</span>&nbsp;<span class="ident">decodeValue</span><span class="op">(</span><span class="ident">wireId</span>&nbsp;<span class="ident">typeId</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">catchError</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">dec</span><span class="op">.</span><span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;If&nbsp;the&nbsp;value&nbsp;is&nbsp;nil,&nbsp;it&nbsp;means&nbsp;we&nbsp;should&nbsp;just&nbsp;ignore&nbsp;this&nbsp;item.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">value</span><span class="op">.</span><span class="ident">IsValid</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dec</span><span class="op">.</span><span class="ident">decodeIgnoredValue</span><span class="op">(</span><span class="ident">wireId</span><span class="op">)</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Dereference&nbsp;down&nbsp;to&nbsp;the&nbsp;underlying&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ut</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">userType</span><span class="op">(</span><span class="ident">value</span><span class="op">.</span><span class="ident">Type</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">base</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">base</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">enginePtr</span>&nbsp;<span class="op">*</span><span class="op">*</span><span class="ident">decEngine</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">enginePtr</span><span class="op">,</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">getDecEnginePtr</span><span class="op">(</span><span class="ident">wireId</span><span class="op">,</span>&nbsp;<span class="ident">ut</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">value</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">decAlloc</span><span class="op">(</span><span class="ident">value</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">engine</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">*</span><span class="ident">enginePtr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">st</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">base</span><span class="op">;</span>&nbsp;<span class="ident">st</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Struct</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">externalDec</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">engine</span><span class="op">.</span><span class="ident">numInstr</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">st</span><span class="op">.</span><span class="ident">NumField</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dec</span><span class="op">.</span><span class="ident">wireType</span><span class="op">[</span><span class="ident">wireId</span><span class="op">]</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">dec</span><span class="op">.</span><span class="ident">wireType</span><span class="op">[</span><span class="ident">wireId</span><span class="op">]</span><span class="op">.</span><span class="ident">StructT</span><span class="op">.</span><span class="ident">Field</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">1160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">base</span><span class="op">.</span><span class="ident">Name</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;type&nbsp;mismatch:&nbsp;no&nbsp;fields&nbsp;matched&nbsp;compiling&nbsp;decoder&nbsp;for&nbsp;%s&#34;</span><span class="op">,</span>&nbsp;<span class="ident">name</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dec</span><span class="op">.</span><span class="ident">decodeStruct</span><span class="op">(</span><span class="ident">engine</span><span class="op">,</span>&nbsp;<span class="ident">ut</span><span class="op">,</span>&nbsp;<span class="ident">value</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dec</span><span class="op">.</span><span class="ident">decodeSingle</span><span class="op">(</span><span class="ident">engine</span><span class="op">,</span>&nbsp;<span class="ident">ut</span><span class="op">,</span>&nbsp;<span class="ident">value</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;decodeIgnoredValue&nbsp;decodes&nbsp;the&nbsp;data&nbsp;stream&nbsp;representing&nbsp;a&nbsp;value&nbsp;of&nbsp;the&nbsp;specified&nbsp;type&nbsp;and&nbsp;discards&nbsp;it.</span><br>
<span class="lineno">1170</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">dec</span>&nbsp;<span class="op">*</span><span class="ident">Decoder</span><span class="op">)</span>&nbsp;<span class="ident">decodeIgnoredValue</span><span class="op">(</span><span class="ident">wireId</span>&nbsp;<span class="ident">typeId</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">enginePtr</span>&nbsp;<span class="op">*</span><span class="op">*</span><span class="ident">decEngine</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">enginePtr</span><span class="op">,</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">getIgnoreEnginePtr</span><span class="op">(</span><span class="ident">wireId</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno">1175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">wire</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dec</span><span class="op">.</span><span class="ident">wireType</span><span class="op">[</span><span class="ident">wireId</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">wire</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">wire</span><span class="op">.</span><span class="ident">StructT</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dec</span><span class="op">.</span><span class="ident">ignoreStruct</span><span class="op">(</span><span class="op">*</span><span class="ident">enginePtr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dec</span><span class="op">.</span><span class="ident">ignoreSingle</span><span class="op">(</span><span class="op">*</span><span class="ident">enginePtr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">init</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">1185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">iop</span><span class="op">,</span>&nbsp;<span class="ident">uop</span>&nbsp;<span class="ident">decOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">TypeOf</span><span class="op">(</span><span class="builtintype">int</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">)</span><span class="op">.</span><span class="ident">Bits</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="num">32</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">iop</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">decInt32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">uop</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">decUint32</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="num">64</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">iop</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">decInt64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">uop</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">decUint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;gob:&nbsp;unknown&nbsp;size&nbsp;of&nbsp;int/uint&#34;</span><span class="op">)</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">decOpTable</span><span class="op">[</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">Int</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">iop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">decOpTable</span><span class="op">[</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">Uint</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">uop</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Finally&nbsp;uintptr</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">TypeOf</span><span class="op">(</span><span class="builtintype">uintptr</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">)</span><span class="op">.</span><span class="ident">Bits</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="num">32</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">uop</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">decUint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="num">64</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">uop</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">decUint64</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;gob:&nbsp;unknown&nbsp;size&nbsp;of&nbsp;uintptr&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">decOpTable</span><span class="op">[</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">Uintptr</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">uop</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">1210</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Gob&nbsp;depends&nbsp;on&nbsp;being&nbsp;able&nbsp;to&nbsp;take&nbsp;the&nbsp;address</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;of&nbsp;zeroed&nbsp;Values&nbsp;it&nbsp;creates,&nbsp;so&nbsp;use&nbsp;this&nbsp;wrapper&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;of&nbsp;the&nbsp;standard&nbsp;reflect.Zero.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Each&nbsp;call&nbsp;allocates&nbsp;once.</span><br>
<span class="lineno">1215</span><span class="keyword">func</span>&nbsp;<span class="ident">allocValue</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span><span class="op">)</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="ident">t</span><span class="op">)</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span>
</div>
</body>
</html>
