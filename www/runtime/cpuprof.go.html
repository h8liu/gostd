<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1901334">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1901390">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1901444">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1901495">//&nbsp;CPU&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1901513">//&nbsp;Based&nbsp;on&nbsp;algorithms&nbsp;and&nbsp;data&nbsp;structures&nbsp;used&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1901564">//&nbsp;http://code.google.com/p/google-perftools/.</span><br>
<span class="lineno"></span><span class="comment" id="1901611">//</span><br>
<span class="lineno"></span><span class="comment" id="1901614">//&nbsp;The&nbsp;main&nbsp;difference&nbsp;between&nbsp;this&nbsp;code&nbsp;and&nbsp;the&nbsp;google-perftools</span><br>
<span class="lineno">10</span><span class="comment" id="1901680">//&nbsp;code&nbsp;is&nbsp;that&nbsp;this&nbsp;code&nbsp;is&nbsp;written&nbsp;to&nbsp;allow&nbsp;copying&nbsp;the&nbsp;profile&nbsp;data</span><br>
<span class="lineno"></span><span class="comment" id="1901751">//&nbsp;to&nbsp;an&nbsp;arbitrary&nbsp;io.Writer,&nbsp;while&nbsp;the&nbsp;google-perftools&nbsp;code&nbsp;always</span><br>
<span class="lineno"></span><span class="comment" id="1901820">//&nbsp;writes&nbsp;to&nbsp;an&nbsp;operating&nbsp;system&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="1901859">//</span><br>
<span class="lineno"></span><span class="comment" id="1901862">//&nbsp;The&nbsp;signal&nbsp;handler&nbsp;for&nbsp;the&nbsp;profiling&nbsp;clock&nbsp;tick&nbsp;adds&nbsp;a&nbsp;new&nbsp;stack&nbsp;trace</span><br>
<span class="lineno">15</span><span class="comment" id="1901936">//&nbsp;to&nbsp;a&nbsp;hash&nbsp;table&nbsp;tracking&nbsp;counts&nbsp;for&nbsp;recent&nbsp;traces.&nbsp;&nbsp;Most&nbsp;clock&nbsp;ticks</span><br>
<span class="lineno"></span><span class="comment" id="1902008">//&nbsp;hit&nbsp;in&nbsp;the&nbsp;cache.&nbsp;&nbsp;In&nbsp;the&nbsp;event&nbsp;of&nbsp;a&nbsp;cache&nbsp;miss,&nbsp;an&nbsp;entry&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1902077">//&nbsp;evicted&nbsp;from&nbsp;the&nbsp;hash&nbsp;table,&nbsp;copied&nbsp;to&nbsp;a&nbsp;log&nbsp;that&nbsp;will&nbsp;eventually&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1902149">//&nbsp;written&nbsp;as&nbsp;profile&nbsp;data.&nbsp;&nbsp;The&nbsp;google-perftools&nbsp;code&nbsp;flushed&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1902216">//&nbsp;log&nbsp;itself&nbsp;during&nbsp;the&nbsp;signal&nbsp;handler.&nbsp;&nbsp;This&nbsp;code&nbsp;cannot&nbsp;do&nbsp;that,&nbsp;because</span><br>
<span class="lineno">20</span><span class="comment" id="1902292">//&nbsp;the&nbsp;io.Writer&nbsp;might&nbsp;block&nbsp;or&nbsp;need&nbsp;system&nbsp;calls&nbsp;or&nbsp;locks&nbsp;that&nbsp;are&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="1902364">//&nbsp;safe&nbsp;to&nbsp;use&nbsp;from&nbsp;within&nbsp;the&nbsp;signal&nbsp;handler.&nbsp;&nbsp;Instead,&nbsp;we&nbsp;split&nbsp;the&nbsp;log</span><br>
<span class="lineno"></span><span class="comment" id="1902438">//&nbsp;into&nbsp;two&nbsp;halves&nbsp;and&nbsp;let&nbsp;the&nbsp;signal&nbsp;handler&nbsp;fill&nbsp;one&nbsp;half&nbsp;while&nbsp;a&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1902516">//&nbsp;is&nbsp;writing&nbsp;out&nbsp;the&nbsp;other&nbsp;half.&nbsp;&nbsp;When&nbsp;the&nbsp;signal&nbsp;handler&nbsp;fills&nbsp;its&nbsp;half,&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="1902594">//&nbsp;offers&nbsp;to&nbsp;swap&nbsp;with&nbsp;the&nbsp;goroutine.&nbsp;&nbsp;If&nbsp;the&nbsp;writer&nbsp;is&nbsp;not&nbsp;done&nbsp;with&nbsp;its&nbsp;half,</span><br>
<span class="lineno">25</span><span class="comment" id="1902674">//&nbsp;we&nbsp;lose&nbsp;the&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;clock&nbsp;tick&nbsp;(and&nbsp;record&nbsp;that&nbsp;loss).</span><br>
<span class="lineno"></span><span class="comment" id="1902745">//&nbsp;The&nbsp;goroutine&nbsp;interacts&nbsp;with&nbsp;the&nbsp;signal&nbsp;handler&nbsp;by&nbsp;calling&nbsp;getprofile()&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1902823">//&nbsp;get&nbsp;the&nbsp;next&nbsp;log&nbsp;piece&nbsp;to&nbsp;write,&nbsp;implicitly&nbsp;handing&nbsp;back&nbsp;the&nbsp;last&nbsp;log</span><br>
<span class="lineno"></span><span class="comment" id="1902896">//&nbsp;piece&nbsp;it&nbsp;obtained.</span><br>
<span class="lineno"></span><span class="comment" id="1902918">//</span><br>
<span class="lineno">30</span><span class="comment" id="1902921">//&nbsp;The&nbsp;state&nbsp;of&nbsp;this&nbsp;dance&nbsp;between&nbsp;the&nbsp;signal&nbsp;handler&nbsp;and&nbsp;the&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1902993">//&nbsp;is&nbsp;encoded&nbsp;in&nbsp;the&nbsp;Profile.handoff&nbsp;field.&nbsp;&nbsp;If&nbsp;handoff&nbsp;==&nbsp;0,&nbsp;then&nbsp;the&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1903074">//&nbsp;is&nbsp;not&nbsp;using&nbsp;either&nbsp;log&nbsp;half&nbsp;and&nbsp;is&nbsp;waiting&nbsp;(or&nbsp;will&nbsp;soon&nbsp;be&nbsp;waiting)&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="1903151">//&nbsp;a&nbsp;new&nbsp;piece&nbsp;by&nbsp;calling&nbsp;notesleep(&amp;p-&gt;wait).&nbsp;&nbsp;If&nbsp;the&nbsp;signal&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="1903221">//&nbsp;changes&nbsp;handoff&nbsp;from&nbsp;0&nbsp;to&nbsp;non-zero,&nbsp;it&nbsp;must&nbsp;call&nbsp;notewakeup(&amp;p-&gt;wait)</span><br>
<span class="lineno">35</span><span class="comment" id="1903294">//&nbsp;to&nbsp;wake&nbsp;the&nbsp;goroutine.&nbsp;&nbsp;The&nbsp;value&nbsp;indicates&nbsp;the&nbsp;number&nbsp;of&nbsp;entries&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1903370">//&nbsp;log&nbsp;half&nbsp;being&nbsp;handed&nbsp;off.&nbsp;&nbsp;The&nbsp;goroutine&nbsp;leaves&nbsp;the&nbsp;non-zero&nbsp;value&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1903444">//&nbsp;place&nbsp;until&nbsp;it&nbsp;has&nbsp;finished&nbsp;processing&nbsp;the&nbsp;log&nbsp;half&nbsp;and&nbsp;then&nbsp;flips&nbsp;the&nbsp;number</span><br>
<span class="lineno"></span><span class="comment" id="1903525">//&nbsp;back&nbsp;to&nbsp;zero.&nbsp;&nbsp;Setting&nbsp;the&nbsp;high&nbsp;bit&nbsp;in&nbsp;handoff&nbsp;means&nbsp;that&nbsp;the&nbsp;profiling&nbsp;is&nbsp;over,</span><br>
<span class="lineno"></span><span class="comment" id="1903609">//&nbsp;and&nbsp;the&nbsp;goroutine&nbsp;is&nbsp;now&nbsp;in&nbsp;charge&nbsp;of&nbsp;flushing&nbsp;the&nbsp;data&nbsp;left&nbsp;in&nbsp;the&nbsp;hash&nbsp;table</span><br>
<span class="lineno">40</span><span class="comment" id="1903691">//&nbsp;to&nbsp;the&nbsp;log&nbsp;and&nbsp;returning&nbsp;that&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="1903730">//</span><br>
<span class="lineno"></span><span class="comment" id="1903733">//&nbsp;The&nbsp;handoff&nbsp;field&nbsp;is&nbsp;manipulated&nbsp;using&nbsp;atomic&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="1903794">//&nbsp;For&nbsp;the&nbsp;most&nbsp;part,&nbsp;the&nbsp;manipulation&nbsp;of&nbsp;handoff&nbsp;is&nbsp;orderly:&nbsp;if&nbsp;handoff&nbsp;==&nbsp;0</span><br>
<span class="lineno"></span><span class="comment" id="1903872">//&nbsp;then&nbsp;the&nbsp;signal&nbsp;handler&nbsp;owns&nbsp;it&nbsp;and&nbsp;can&nbsp;change&nbsp;it&nbsp;to&nbsp;non-zero.</span><br>
<span class="lineno">45</span><span class="comment" id="1903938">//&nbsp;If&nbsp;handoff&nbsp;!=&nbsp;0&nbsp;then&nbsp;the&nbsp;goroutine&nbsp;owns&nbsp;it&nbsp;and&nbsp;can&nbsp;change&nbsp;it&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span><span class="comment" id="1904011">//&nbsp;If&nbsp;that&nbsp;were&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;story&nbsp;then&nbsp;we&nbsp;would&nbsp;not&nbsp;need&nbsp;to&nbsp;manipulate</span><br>
<span class="lineno"></span><span class="comment" id="1904085">//&nbsp;handoff&nbsp;using&nbsp;atomic&nbsp;operations.&nbsp;&nbsp;The&nbsp;operations&nbsp;are&nbsp;needed,&nbsp;however,</span><br>
<span class="lineno"></span><span class="comment" id="1904158">//&nbsp;in&nbsp;order&nbsp;to&nbsp;let&nbsp;the&nbsp;log&nbsp;closer&nbsp;set&nbsp;the&nbsp;high&nbsp;bit&nbsp;to&nbsp;indicate&nbsp;&#34;EOF&#34;&nbsp;safely</span><br>
<span class="lineno"></span><span class="comment" id="1904234">//&nbsp;in&nbsp;the&nbsp;situation&nbsp;when&nbsp;normally&nbsp;the&nbsp;goroutine&nbsp;&#34;owns&#34;&nbsp;handoff.</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="1904299">package</span>&nbsp;<span class="ident" id="1904307">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1904316">import</span>&nbsp;<span class="string" id="1904323">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="1904333">const</span>&nbsp;<span class="op" id="1904339">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1904342">numBuckets</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1904358">=</span>&nbsp;<span class="num" id="1904360">1</span>&nbsp;<span class="op" id="1904362">&lt;&lt;</span>&nbsp;<span class="num" id="1904365">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1904369">logSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1904385">=</span>&nbsp;<span class="num" id="1904387">1</span>&nbsp;<span class="op" id="1904389">&lt;&lt;</span>&nbsp;<span class="num" id="1904392">17</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1904396">assoc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1904412">=</span>&nbsp;<span class="num" id="1904414">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1904417">maxCPUProfStack</span>&nbsp;<span class="op" id="1904433">=</span>&nbsp;<span class="num" id="1904435">64</span><br>
<span class="lineno">60</span><span class="op" id="1904438">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1904441">type</span>&nbsp;<span class="ident" id="1904446">cpuprofEntry</span>&nbsp;<span class="keyword" id="1904459">struct</span>&nbsp;<span class="op" id="1904466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1904469">count</span>&nbsp;<span class="builtintype" id="1904475">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1904484">depth</span>&nbsp;<span class="builtintype" id="1904490">uintptr</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1904499">stack</span>&nbsp;<span class="op" id="1904505">[</span><span class="ident" id="1904506"><a href="/runtime/cpuprof.go.html#1904417">maxCPUProfStack</a></span><span class="op" id="1904521">]</span><span class="builtintype" id="1904522">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1904530">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1904533">type</span>&nbsp;<span class="ident" id="1904538">cpuProfile</span>&nbsp;<span class="keyword" id="1904549">struct</span>&nbsp;<span class="op" id="1904556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1904559">on</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1904566">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1904574">//&nbsp;profiling&nbsp;is&nbsp;on</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1904594">wait</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1904601"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2179346">note</a></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1904609">//&nbsp;goroutine&nbsp;waits&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1904634">count</span>&nbsp;&nbsp;<span class="builtintype" id="1904641">uintptr</span>&nbsp;<span class="comment" id="1904649">//&nbsp;tick&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1904664">evicts</span>&nbsp;<span class="builtintype" id="1904671">uintptr</span>&nbsp;<span class="comment" id="1904679">//&nbsp;eviction&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1904698">lost</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1904705">uintptr</span>&nbsp;<span class="comment" id="1904713">//&nbsp;lost&nbsp;ticks&nbsp;that&nbsp;need&nbsp;to&nbsp;be&nbsp;logged</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1904752">//&nbsp;Active&nbsp;recent&nbsp;stack&nbsp;traces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1904784">hash</span>&nbsp;<span class="op" id="1904789">[</span><span class="ident" id="1904790"><a href="/runtime/cpuprof.go.html#1904342">numBuckets</a></span><span class="op" id="1904800">]</span><span class="keyword" id="1904801">struct</span>&nbsp;<span class="op" id="1904808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1904812">entry</span>&nbsp;<span class="op" id="1904818">[</span><span class="ident" id="1904819"><a href="/runtime/cpuprof.go.html#1904396">assoc</a></span><span class="op" id="1904824">]</span><span class="ident" id="1904825"><a href="/runtime/cpuprof.go.html#1904446">cpuprofEntry</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1904839">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1904843">//&nbsp;Log&nbsp;of&nbsp;traces&nbsp;evicted&nbsp;from&nbsp;hash.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1904880">//&nbsp;Signal&nbsp;handler&nbsp;has&nbsp;filled&nbsp;log[toggle][:nlog].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1904930">//&nbsp;Goroutine&nbsp;is&nbsp;writing&nbsp;log[1-toggle][:handoff].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1904980">log</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1904988">[</span><span class="num" id="1904989">2</span><span class="op" id="1904990">]</span><span class="op" id="1904991">[</span><span class="ident" id="1904992"><a href="/runtime/cpuprof.go.html#1904369">logSize</a></span>&nbsp;<span class="op" id="1905000">/</span>&nbsp;<span class="num" id="1905002">2</span><span class="op" id="1905003">]</span><span class="builtintype" id="1905004">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1905013">nlog</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1905021">uintptr</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1905030">toggle</span>&nbsp;&nbsp;<span class="builtintype" id="1905038">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1905045">handoff</span>&nbsp;<span class="builtintype" id="1905053">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1905062">//&nbsp;Writer&nbsp;state.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1905080">//&nbsp;Writer&nbsp;maintains&nbsp;its&nbsp;own&nbsp;toggle&nbsp;to&nbsp;avoid&nbsp;races</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1905131">//&nbsp;looking&nbsp;at&nbsp;signal&nbsp;handler&#39;s&nbsp;toggle.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1905171">wtoggle</span>&nbsp;&nbsp;<span class="builtintype" id="1905180">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1905188">wholding</span>&nbsp;<span class="builtintype" id="1905197">bool</span>&nbsp;<span class="comment" id="1905202">//&nbsp;holding&nbsp;&amp;&nbsp;need&nbsp;to&nbsp;release&nbsp;a&nbsp;log&nbsp;half</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1905243">flushing</span>&nbsp;<span class="builtintype" id="1905252">bool</span>&nbsp;<span class="comment" id="1905257">//&nbsp;flushing&nbsp;hash&nbsp;table&nbsp;-&nbsp;profile&nbsp;is&nbsp;over</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1905299">eodSent</span>&nbsp;&nbsp;<span class="builtintype" id="1905308">bool</span>&nbsp;<span class="comment" id="1905313">//&nbsp;special&nbsp;end-of-data&nbsp;record&nbsp;sent;&nbsp;=&gt;&nbsp;flushing</span><br>
<span class="lineno">95</span><span class="op" id="1905361">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1905364">var</span>&nbsp;<span class="op" id="1905368">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1905371">cpuprofLock</span>&nbsp;<span class="ident" id="1905383"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2179310">mutex</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1905390">cpuprof</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1905402">*</span><span class="ident" id="1905403"><a href="/runtime/cpuprof.go.html#1904538">cpuProfile</a></span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1905416">eod</span>&nbsp;<span class="op" id="1905420">=</span>&nbsp;<span class="op" id="1905422">[</span><span class="num" id="1905423">3</span><span class="op" id="1905424">]</span><span class="builtintype" id="1905425">uintptr</span><span class="op" id="1905432">{</span><span class="num" id="1905433">0</span><span class="op" id="1905434">,</span>&nbsp;<span class="num" id="1905436">1</span><span class="op" id="1905437">,</span>&nbsp;<span class="num" id="1905439">0</span><span class="op" id="1905440">}</span><br>
<span class="lineno"></span><span class="op" id="1905442">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1905445">func</span>&nbsp;<span class="ident" id="1905450">setcpuprofilerate_m</span><span class="op" id="1905469">(</span><span class="op" id="1905470">)</span>&nbsp;<span class="comment" id="1905472">//&nbsp;proc.c</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="1905483">func</span>&nbsp;<span class="ident" id="1905488">setcpuprofilerate</span><span class="op" id="1905505">(</span><span class="ident" id="1905506">hz</span>&nbsp;<span class="builtintype" id="1905509">int32</span><span class="op" id="1905514">)</span>&nbsp;<span class="op" id="1905516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1905519">g</span>&nbsp;<span class="op" id="1905521">:=</span>&nbsp;<span class="ident" id="1905524"><a href="/runtime/stubs.go.html#2132021">getg</a></span><span class="op" id="1905528">(</span><span class="op" id="1905529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1905532"><a href="/runtime/cpuprof.go.html#1905519">g</a></span><span class="op" id="1905533">.</span><span class="ident" id="1905534">m</span><span class="op" id="1905535">.</span><span class="ident" id="1905536">scalararg</span><span class="op" id="1905545">[</span><span class="num" id="1905546">0</span><span class="op" id="1905547">]</span>&nbsp;<span class="op" id="1905549">=</span>&nbsp;<span class="builtintype" id="1905551">uintptr</span><span class="op" id="1905558">(</span><span class="ident" id="1905559"><a href="/runtime/cpuprof.go.html#1905506">hz</a></span><span class="op" id="1905561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1905564"><a href="/runtime/stubs.go.html#2134137">onM</a></span><span class="op" id="1905567">(</span><span class="ident" id="1905568"><a href="/runtime/cpuprof.go.html#1905450">setcpuprofilerate_m</a></span><span class="op" id="1905587">)</span><br>
<span class="lineno">110</span><span class="op" id="1905589">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1905592">//&nbsp;lostProfileData&nbsp;is&nbsp;a&nbsp;no-op&nbsp;function&nbsp;used&nbsp;in&nbsp;profiles</span><br>
<span class="lineno"></span><span class="comment" id="1905648">//&nbsp;to&nbsp;mark&nbsp;the&nbsp;number&nbsp;of&nbsp;profiling&nbsp;stack&nbsp;traces&nbsp;that&nbsp;were</span><br>
<span class="lineno"></span><span class="comment" id="1905706">//&nbsp;discarded&nbsp;due&nbsp;to&nbsp;slow&nbsp;data&nbsp;writers.</span><br>
<span class="lineno">115</span><span class="keyword" id="1905745">func</span>&nbsp;<span class="ident" id="1905750">lostProfileData</span><span class="op" id="1905765">(</span><span class="op" id="1905766">)</span>&nbsp;<span class="op" id="1905768">{</span><span class="op" id="1905769">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1905772">//&nbsp;SetCPUProfileRate&nbsp;sets&nbsp;the&nbsp;CPU&nbsp;profiling&nbsp;rate&nbsp;to&nbsp;hz&nbsp;samples&nbsp;per&nbsp;second.</span><br>
<span class="lineno"></span><span class="comment" id="1905847">//&nbsp;If&nbsp;hz&nbsp;&lt;=&nbsp;0,&nbsp;SetCPUProfileRate&nbsp;turns&nbsp;off&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1905901">//&nbsp;If&nbsp;the&nbsp;profiler&nbsp;is&nbsp;on,&nbsp;the&nbsp;rate&nbsp;cannot&nbsp;be&nbsp;changed&nbsp;without&nbsp;first&nbsp;turning&nbsp;it&nbsp;off.</span><br>
<span class="lineno">120</span><span class="comment" id="1905984">//</span><br>
<span class="lineno"></span><span class="comment" id="1905987">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1906043">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.cpuprofile&nbsp;flag&nbsp;instead&nbsp;of&nbsp;calling</span><br>
<span class="lineno"></span><span class="comment" id="1906109">//&nbsp;SetCPUProfileRate&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1906140">func</span>&nbsp;<span class="ident" id="1906145">SetCPUProfileRate</span><span class="op" id="1906162">(</span><span class="ident" id="1906163">hz</span>&nbsp;<span class="builtintype" id="1906166">int</span><span class="op" id="1906169">)</span>&nbsp;<span class="op" id="1906171">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1906174">//&nbsp;Clamp&nbsp;hz&nbsp;to&nbsp;something&nbsp;reasonable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1906212">if</span>&nbsp;<span class="ident" id="1906215"><a href="/runtime/cpuprof.go.html#1906163">hz</a></span>&nbsp;<span class="op" id="1906218">&lt;</span>&nbsp;<span class="num" id="1906220">0</span>&nbsp;<span class="op" id="1906222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1906226"><a href="/runtime/cpuprof.go.html#1906163">hz</a></span>&nbsp;<span class="op" id="1906229">=</span>&nbsp;<span class="num" id="1906231">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1906234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1906237">if</span>&nbsp;<span class="ident" id="1906240"><a href="/runtime/cpuprof.go.html#1906163">hz</a></span>&nbsp;<span class="op" id="1906243">&gt;</span>&nbsp;<span class="num" id="1906245">1000000</span>&nbsp;<span class="op" id="1906253">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1906257"><a href="/runtime/cpuprof.go.html#1906163">hz</a></span>&nbsp;<span class="op" id="1906260">=</span>&nbsp;<span class="num" id="1906262">1000000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1906271">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1906275"><a href="/runtime/lock_futex.go.html#1978439">lock</a></span><span class="op" id="1906279">(</span><span class="op" id="1906280">&amp;</span><span class="ident" id="1906281"><a href="/runtime/cpuprof.go.html#1905371">cpuprofLock</a></span><span class="op" id="1906292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1906295">if</span>&nbsp;<span class="ident" id="1906298"><a href="/runtime/cpuprof.go.html#1906163">hz</a></span>&nbsp;<span class="op" id="1906301">&gt;</span>&nbsp;<span class="num" id="1906303">0</span>&nbsp;<span class="op" id="1906305">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1906309">if</span>&nbsp;<span class="ident" id="1906312"><a href="/runtime/cpuprof.go.html#1905390">cpuprof</a></span>&nbsp;<span class="op" id="1906320">==</span>&nbsp;<span class="ident" id="1906323">nil</span>&nbsp;<span class="op" id="1906327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1906332"><a href="/runtime/cpuprof.go.html#1905390">cpuprof</a></span>&nbsp;<span class="op" id="1906340">=</span>&nbsp;<span class="op" id="1906342">(</span><span class="op" id="1906343">*</span><span class="ident" id="1906344"><a href="/runtime/cpuprof.go.html#1904538">cpuProfile</a></span><span class="op" id="1906354">)</span><span class="op" id="1906355">(</span><span class="ident" id="1906356"><a href="/runtime/mprof.go.html#2017410">sysAlloc</a></span><span class="op" id="1906364">(</span><span class="ident" id="1906365"><a href="/runtime/cpuprof.go.html#1904323">unsafe</a></span><span class="op" id="1906371">.</span><span class="ident" id="1906372">Sizeof</span><span class="op" id="1906378">(</span><span class="ident" id="1906379"><a href="/runtime/cpuprof.go.html#1904538">cpuProfile</a></span><span class="op" id="1906389">{</span><span class="op" id="1906390">}</span><span class="op" id="1906391">)</span><span class="op" id="1906392">,</span>&nbsp;<span class="op" id="1906394">&amp;</span><span class="ident" id="1906395"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2186172">memstats</a></span><span class="op" id="1906403">.</span><span class="ident" id="1906404">other_sys</span><span class="op" id="1906413">)</span><span class="op" id="1906414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1906419">if</span>&nbsp;<span class="ident" id="1906422"><a href="/runtime/cpuprof.go.html#1905390">cpuprof</a></span>&nbsp;<span class="op" id="1906430">==</span>&nbsp;<span class="ident" id="1906433">nil</span>&nbsp;<span class="op" id="1906437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1906443">print</span><span class="op" id="1906448">(</span><span class="string" id="1906449">&#34;runtime:&nbsp;cpu&nbsp;profiling&nbsp;cannot&nbsp;allocate&nbsp;memory\n&#34;</span><span class="op" id="1906498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1906504"><a href="/runtime/lock_futex.go.html#1979731">unlock</a></span><span class="op" id="1906510">(</span><span class="op" id="1906511">&amp;</span><span class="ident" id="1906512"><a href="/runtime/cpuprof.go.html#1905371">cpuprofLock</a></span><span class="op" id="1906523">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1906529">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1906539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1906543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1906547">if</span>&nbsp;<span class="ident" id="1906550"><a href="/runtime/cpuprof.go.html#1905390">cpuprof</a></span><span class="op" id="1906557">.</span><span class="ident" id="1906558">on</span>&nbsp;<span class="op" id="1906561">||</span>&nbsp;<span class="ident" id="1906564"><a href="/runtime/cpuprof.go.html#1905390">cpuprof</a></span><span class="op" id="1906571">.</span><span class="ident" id="1906572">handoff</span>&nbsp;<span class="op" id="1906580">!=</span>&nbsp;<span class="num" id="1906583">0</span>&nbsp;<span class="op" id="1906585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1906590">print</span><span class="op" id="1906595">(</span><span class="string" id="1906596">&#34;runtime:&nbsp;cannot&nbsp;set&nbsp;cpu&nbsp;profile&nbsp;rate&nbsp;until&nbsp;previous&nbsp;profile&nbsp;has&nbsp;finished.\n&#34;</span><span class="op" id="1906673">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1906678"><a href="/runtime/lock_futex.go.html#1979731">unlock</a></span><span class="op" id="1906684">(</span><span class="op" id="1906685">&amp;</span><span class="ident" id="1906686"><a href="/runtime/cpuprof.go.html#1905371">cpuprofLock</a></span><span class="op" id="1906697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1906702">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1906711">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1906716"><a href="/runtime/cpuprof.go.html#1905390">cpuprof</a></span><span class="op" id="1906723">.</span><span class="ident" id="1906724">on</span>&nbsp;<span class="op" id="1906727">=</span>&nbsp;<span class="builtintype" id="1906729">true</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1906736">//&nbsp;pprof&nbsp;binary&nbsp;header&nbsp;format.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1906769">//&nbsp;http://code.google.com/p/google-perftools/source/browse/trunk/src/profiledata.cc#117</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1906859">p</span>&nbsp;<span class="op" id="1906861">:=</span>&nbsp;<span class="op" id="1906864">&amp;</span><span class="ident" id="1906865"><a href="/runtime/cpuprof.go.html#1905390">cpuprof</a></span><span class="op" id="1906872">.</span><span class="ident" id="1906873">log</span><span class="op" id="1906876">[</span><span class="num" id="1906877">0</span><span class="op" id="1906878">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1906882"><a href="/runtime/cpuprof.go.html#1906859">p</a></span><span class="op" id="1906883">[</span><span class="num" id="1906884">0</span><span class="op" id="1906885">]</span>&nbsp;<span class="op" id="1906887">=</span>&nbsp;<span class="num" id="1906889">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1906907">//&nbsp;count&nbsp;for&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1906929"><a href="/runtime/cpuprof.go.html#1906859">p</a></span><span class="op" id="1906930">[</span><span class="num" id="1906931">1</span><span class="op" id="1906932">]</span>&nbsp;<span class="op" id="1906934">=</span>&nbsp;<span class="num" id="1906936">3</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1906954">//&nbsp;depth&nbsp;for&nbsp;header</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1906976"><a href="/runtime/cpuprof.go.html#1906859">p</a></span><span class="op" id="1906977">[</span><span class="num" id="1906978">2</span><span class="op" id="1906979">]</span>&nbsp;<span class="op" id="1906981">=</span>&nbsp;<span class="num" id="1906983">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1907001">//&nbsp;version&nbsp;number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1907021"><a href="/runtime/cpuprof.go.html#1906859">p</a></span><span class="op" id="1907022">[</span><span class="num" id="1907023">3</span><span class="op" id="1907024">]</span>&nbsp;<span class="op" id="1907026">=</span>&nbsp;<span class="builtintype" id="1907028">uintptr</span><span class="op" id="1907035">(</span><span class="num" id="1907036">1e6</span>&nbsp;<span class="op" id="1907040">/</span>&nbsp;<span class="ident" id="1907042"><a href="/runtime/cpuprof.go.html#1906163">hz</a></span><span class="op" id="1907044">)</span>&nbsp;<span class="comment" id="1907046">//&nbsp;period&nbsp;(microseconds)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1907073"><a href="/runtime/cpuprof.go.html#1906859">p</a></span><span class="op" id="1907074">[</span><span class="num" id="1907075">4</span><span class="op" id="1907076">]</span>&nbsp;<span class="op" id="1907078">=</span>&nbsp;<span class="num" id="1907080">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1907084"><a href="/runtime/cpuprof.go.html#1905390">cpuprof</a></span><span class="op" id="1907091">.</span><span class="ident" id="1907092">nlog</span>&nbsp;<span class="op" id="1907097">=</span>&nbsp;<span class="num" id="1907099">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1907103"><a href="/runtime/cpuprof.go.html#1905390">cpuprof</a></span><span class="op" id="1907110">.</span><span class="ident" id="1907111">toggle</span>&nbsp;<span class="op" id="1907118">=</span>&nbsp;<span class="num" id="1907120">0</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1907124"><a href="/runtime/cpuprof.go.html#1905390">cpuprof</a></span><span class="op" id="1907131">.</span><span class="ident" id="1907132">wholding</span>&nbsp;<span class="op" id="1907141">=</span>&nbsp;<span class="builtintype" id="1907143">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1907151"><a href="/runtime/cpuprof.go.html#1905390">cpuprof</a></span><span class="op" id="1907158">.</span><span class="ident" id="1907159">wtoggle</span>&nbsp;<span class="op" id="1907167">=</span>&nbsp;<span class="num" id="1907169">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1907173"><a href="/runtime/cpuprof.go.html#1905390">cpuprof</a></span><span class="op" id="1907180">.</span><span class="ident" id="1907181">flushing</span>&nbsp;<span class="op" id="1907190">=</span>&nbsp;<span class="builtintype" id="1907192">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1907200"><a href="/runtime/cpuprof.go.html#1905390">cpuprof</a></span><span class="op" id="1907207">.</span><span class="ident" id="1907208">eodSent</span>&nbsp;<span class="op" id="1907216">=</span>&nbsp;<span class="builtintype" id="1907218">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1907226"><a href="/runtime/lock_futex.go.html#1980190">noteclear</a></span><span class="op" id="1907235">(</span><span class="op" id="1907236">&amp;</span><span class="ident" id="1907237"><a href="/runtime/cpuprof.go.html#1905390">cpuprof</a></span><span class="op" id="1907244">.</span><span class="ident" id="1907245">wait</span><span class="op" id="1907249">)</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1907254"><a href="/runtime/cpuprof.go.html#1905488">setcpuprofilerate</a></span><span class="op" id="1907271">(</span><span class="builtintype" id="1907272">int32</span><span class="op" id="1907277">(</span><span class="ident" id="1907278"><a href="/runtime/cpuprof.go.html#1906163">hz</a></span><span class="op" id="1907280">)</span><span class="op" id="1907281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1907284">}</span>&nbsp;<span class="keyword" id="1907286">else</span>&nbsp;<span class="keyword" id="1907291">if</span>&nbsp;<span class="ident" id="1907294"><a href="/runtime/cpuprof.go.html#1905390">cpuprof</a></span>&nbsp;<span class="op" id="1907302">!=</span>&nbsp;<span class="ident" id="1907305">nil</span>&nbsp;<span class="op" id="1907309">&amp;&amp;</span>&nbsp;<span class="ident" id="1907312"><a href="/runtime/cpuprof.go.html#1905390">cpuprof</a></span><span class="op" id="1907319">.</span><span class="ident" id="1907320">on</span>&nbsp;<span class="op" id="1907323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1907327"><a href="/runtime/cpuprof.go.html#1905488">setcpuprofilerate</a></span><span class="op" id="1907344">(</span><span class="num" id="1907345">0</span><span class="op" id="1907346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1907350"><a href="/runtime/cpuprof.go.html#1905390">cpuprof</a></span><span class="op" id="1907357">.</span><span class="ident" id="1907358">on</span>&nbsp;<span class="op" id="1907361">=</span>&nbsp;<span class="builtintype" id="1907363">false</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1907372">//&nbsp;Now&nbsp;add&nbsp;is&nbsp;not&nbsp;running&nbsp;anymore,&nbsp;and&nbsp;getprofile&nbsp;owns&nbsp;the&nbsp;entire&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1907445">//&nbsp;Set&nbsp;the&nbsp;high&nbsp;bit&nbsp;in&nbsp;prof-&gt;handoff&nbsp;to&nbsp;tell&nbsp;getprofile.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1907504">for</span>&nbsp;<span class="op" id="1907508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1907513">n</span>&nbsp;<span class="op" id="1907515">:=</span>&nbsp;<span class="ident" id="1907518"><a href="/runtime/cpuprof.go.html#1905390">cpuprof</a></span><span class="op" id="1907525">.</span><span class="ident" id="1907526">handoff</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1907537">if</span>&nbsp;<span class="ident" id="1907540"><a href="/runtime/cpuprof.go.html#1907513">n</a></span><span class="op" id="1907541">&amp;</span><span class="num" id="1907542">0x80000000</span>&nbsp;<span class="op" id="1907553">!=</span>&nbsp;<span class="num" id="1907556">0</span>&nbsp;<span class="op" id="1907558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1907564">print</span><span class="op" id="1907569">(</span><span class="string" id="1907570">&#34;runtime:&nbsp;setcpuprofile(off)&nbsp;twice\n&#34;</span><span class="op" id="1907607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1907612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1907617">if</span>&nbsp;<span class="ident" id="1907620"><a href="/runtime/stubs.go.html#2137846">cas</a></span><span class="op" id="1907623">(</span><span class="op" id="1907624">&amp;</span><span class="ident" id="1907625"><a href="/runtime/cpuprof.go.html#1905390">cpuprof</a></span><span class="op" id="1907632">.</span><span class="ident" id="1907633">handoff</span><span class="op" id="1907640">,</span>&nbsp;<span class="ident" id="1907642"><a href="/runtime/cpuprof.go.html#1907513">n</a></span><span class="op" id="1907643">,</span>&nbsp;<span class="ident" id="1907645"><a href="/runtime/cpuprof.go.html#1907513">n</a></span><span class="op" id="1907646">|</span><span class="num" id="1907647">0x80000000</span><span class="op" id="1907657">)</span>&nbsp;<span class="op" id="1907659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1907665">if</span>&nbsp;<span class="ident" id="1907668"><a href="/runtime/cpuprof.go.html#1907513">n</a></span>&nbsp;<span class="op" id="1907670">==</span>&nbsp;<span class="num" id="1907673">0</span>&nbsp;<span class="op" id="1907675">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1907682">//&nbsp;we&nbsp;did&nbsp;the&nbsp;transition&nbsp;from&nbsp;0&nbsp;-&gt;&nbsp;nonzero&nbsp;so&nbsp;we&nbsp;wake&nbsp;getprofile</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1907752"><a href="/runtime/lock_futex.go.html#1980230">notewakeup</a></span><span class="op" id="1907762">(</span><span class="op" id="1907763">&amp;</span><span class="ident" id="1907764"><a href="/runtime/cpuprof.go.html#1905390">cpuprof</a></span><span class="op" id="1907771">.</span><span class="ident" id="1907772">wait</span><span class="op" id="1907776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1907782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1907788">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1907797">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1907801">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1907804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1907807"><a href="/runtime/lock_futex.go.html#1979731">unlock</a></span><span class="op" id="1907813">(</span><span class="op" id="1907814">&amp;</span><span class="ident" id="1907815"><a href="/runtime/cpuprof.go.html#1905371">cpuprofLock</a></span><span class="op" id="1907826">)</span><br>
<span class="lineno"></span><span class="op" id="1907828">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span><span class="keyword" id="1907831">func</span>&nbsp;<span class="ident" id="1907836">cpuproftick</span><span class="op" id="1907847">(</span><span class="ident" id="1907848">pc</span>&nbsp;<span class="op" id="1907851">*</span><span class="builtintype" id="1907852">uintptr</span><span class="op" id="1907859">,</span>&nbsp;<span class="ident" id="1907861">n</span>&nbsp;<span class="builtintype" id="1907863">int32</span><span class="op" id="1907868">)</span>&nbsp;<span class="op" id="1907870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1907873">if</span>&nbsp;<span class="ident" id="1907876"><a href="/runtime/cpuprof.go.html#1907861">n</a></span>&nbsp;<span class="op" id="1907878">&gt;</span>&nbsp;<span class="ident" id="1907880"><a href="/runtime/cpuprof.go.html#1904417">maxCPUProfStack</a></span>&nbsp;<span class="op" id="1907896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1907900"><a href="/runtime/cpuprof.go.html#1907861">n</a></span>&nbsp;<span class="op" id="1907902">=</span>&nbsp;<span class="ident" id="1907904"><a href="/runtime/cpuprof.go.html#1904417">maxCPUProfStack</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1907921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1907924">s</span>&nbsp;<span class="op" id="1907926">:=</span>&nbsp;<span class="op" id="1907929">(</span><span class="op" id="1907930">*</span><span class="op" id="1907931">[</span><span class="ident" id="1907932"><a href="/runtime/cpuprof.go.html#1904417">maxCPUProfStack</a></span><span class="op" id="1907947">]</span><span class="builtintype" id="1907948">uintptr</span><span class="op" id="1907955">)</span><span class="op" id="1907956">(</span><span class="ident" id="1907957"><a href="/runtime/cpuprof.go.html#1904323">unsafe</a></span><span class="op" id="1907963">.</span><span class="ident" id="1907964">Pointer</span><span class="op" id="1907971">(</span><span class="ident" id="1907972"><a href="/runtime/cpuprof.go.html#1907848">pc</a></span><span class="op" id="1907974">)</span><span class="op" id="1907975">)</span><span class="op" id="1907976">[</span><span class="op" id="1907977">:</span><span class="ident" id="1907978"><a href="/runtime/cpuprof.go.html#1907861">n</a></span><span class="op" id="1907979">]</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1907982"><a href="/runtime/cpuprof.go.html#1905390">cpuprof</a></span><span class="op" id="1907989">.</span><span class="ident" id="1907990">add</span><span class="op" id="1907993">(</span><span class="ident" id="1907994"><a href="/runtime/cpuprof.go.html#1907924">s</a></span><span class="op" id="1907995">)</span><br>
<span class="lineno"></span><span class="op" id="1907997">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1908000">//&nbsp;add&nbsp;adds&nbsp;the&nbsp;stack&nbsp;trace&nbsp;to&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1908044">//&nbsp;It&nbsp;is&nbsp;called&nbsp;from&nbsp;signal&nbsp;handlers&nbsp;and&nbsp;other&nbsp;limited&nbsp;environments</span><br>
<span class="lineno">200</span><span class="comment" id="1908112">//&nbsp;and&nbsp;cannot&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;acquire&nbsp;locks&nbsp;that&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1908173">//&nbsp;held&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;the&nbsp;signal,&nbsp;nor&nbsp;can&nbsp;it&nbsp;use&nbsp;substantial&nbsp;amounts</span><br>
<span class="lineno"></span><span class="comment" id="1908243">//&nbsp;of&nbsp;stack.&nbsp;&nbsp;It&nbsp;is&nbsp;allowed&nbsp;to&nbsp;call&nbsp;evict.</span><br>
<span class="lineno"></span><span class="keyword" id="1908286">func</span>&nbsp;<span class="op" id="1908291">(</span><span class="ident" id="1908292">p</span>&nbsp;<span class="op" id="1908294">*</span><span class="ident" id="1908295"><a href="/runtime/cpuprof.go.html#1904538">cpuProfile</a></span><span class="op" id="1908305">)</span>&nbsp;<span class="ident" id="1908307">add</span><span class="op" id="1908310">(</span><span class="ident" id="1908311">pc</span>&nbsp;<span class="op" id="1908314">[</span><span class="op" id="1908315">]</span><span class="builtintype" id="1908316">uintptr</span><span class="op" id="1908323">)</span>&nbsp;<span class="op" id="1908325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1908328">//&nbsp;Compute&nbsp;hash.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1908346">h</span>&nbsp;<span class="op" id="1908348">:=</span>&nbsp;<span class="builtintype" id="1908351">uintptr</span><span class="op" id="1908358">(</span><span class="num" id="1908359">0</span><span class="op" id="1908360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1908363">for</span>&nbsp;<span class="ident" id="1908367">_</span><span class="op" id="1908368">,</span>&nbsp;<span class="ident" id="1908370">x</span>&nbsp;<span class="op" id="1908372">:=</span>&nbsp;<span class="keyword" id="1908375">range</span>&nbsp;<span class="ident" id="1908381"><a href="/runtime/cpuprof.go.html#1908311">pc</a></span>&nbsp;<span class="op" id="1908384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1908388"><a href="/runtime/cpuprof.go.html#1908346">h</a></span>&nbsp;<span class="op" id="1908390">=</span>&nbsp;<span class="ident" id="1908392"><a href="/runtime/cpuprof.go.html#1908346">h</a></span><span class="op" id="1908393">&lt;&lt;</span><span class="num" id="1908395">8</span>&nbsp;<span class="op" id="1908397">|</span>&nbsp;<span class="op" id="1908399">(</span><span class="ident" id="1908400"><a href="/runtime/cpuprof.go.html#1908346">h</a></span>&nbsp;<span class="op" id="1908402">&gt;&gt;</span>&nbsp;<span class="op" id="1908405">(</span><span class="num" id="1908406">8</span>&nbsp;<span class="op" id="1908408">*</span>&nbsp;<span class="op" id="1908410">(</span><span class="ident" id="1908411"><a href="/runtime/cpuprof.go.html#1904323">unsafe</a></span><span class="op" id="1908417">.</span><span class="ident" id="1908418">Sizeof</span><span class="op" id="1908424">(</span><span class="ident" id="1908425"><a href="/runtime/cpuprof.go.html#1908346">h</a></span><span class="op" id="1908426">)</span>&nbsp;<span class="op" id="1908428">-</span>&nbsp;<span class="num" id="1908430">1</span><span class="op" id="1908431">)</span><span class="op" id="1908432">)</span><span class="op" id="1908433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1908437"><a href="/runtime/cpuprof.go.html#1908346">h</a></span>&nbsp;<span class="op" id="1908439">+=</span>&nbsp;<span class="ident" id="1908442"><a href="/runtime/cpuprof.go.html#1908370">x</a></span><span class="op" id="1908443">*</span><span class="num" id="1908444">31</span>&nbsp;<span class="op" id="1908447">+</span>&nbsp;<span class="ident" id="1908449"><a href="/runtime/cpuprof.go.html#1908370">x</a></span><span class="op" id="1908450">*</span><span class="num" id="1908451">7</span>&nbsp;<span class="op" id="1908453">+</span>&nbsp;<span class="ident" id="1908455"><a href="/runtime/cpuprof.go.html#1908370">x</a></span><span class="op" id="1908456">*</span><span class="num" id="1908457">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1908460">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1908463"><a href="/runtime/cpuprof.go.html#1908292">p</a></span><span class="op" id="1908464">.</span><span class="ident" id="1908465">count</span><span class="op" id="1908470">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1908475">//&nbsp;Add&nbsp;to&nbsp;entry&nbsp;count&nbsp;if&nbsp;already&nbsp;present&nbsp;in&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1908527">b</span>&nbsp;<span class="op" id="1908529">:=</span>&nbsp;<span class="op" id="1908532">&amp;</span><span class="ident" id="1908533"><a href="/runtime/cpuprof.go.html#1908292">p</a></span><span class="op" id="1908534">.</span><span class="ident" id="1908535">hash</span><span class="op" id="1908539">[</span><span class="ident" id="1908540"><a href="/runtime/cpuprof.go.html#1908346">h</a></span><span class="op" id="1908541">%</span><span class="ident" id="1908542"><a href="/runtime/cpuprof.go.html#1904342">numBuckets</a></span><span class="op" id="1908552">]</span><br>
<span class="lineno"></span><span class="ident" id="1908554">Assoc</span><span class="op" id="1908559">:</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1908562">for</span>&nbsp;<span class="ident" id="1908566">i</span>&nbsp;<span class="op" id="1908568">:=</span>&nbsp;<span class="keyword" id="1908571">range</span>&nbsp;<span class="ident" id="1908577"><a href="/runtime/cpuprof.go.html#1908527">b</a></span><span class="op" id="1908578">.</span><span class="ident" id="1908579">entry</span>&nbsp;<span class="op" id="1908585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1908589">e</span>&nbsp;<span class="op" id="1908591">:=</span>&nbsp;<span class="op" id="1908594">&amp;</span><span class="ident" id="1908595"><a href="/runtime/cpuprof.go.html#1908527">b</a></span><span class="op" id="1908596">.</span><span class="ident" id="1908597">entry</span><span class="op" id="1908602">[</span><span class="ident" id="1908603"><a href="/runtime/cpuprof.go.html#1908566">i</a></span><span class="op" id="1908604">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1908608">if</span>&nbsp;<span class="ident" id="1908611"><a href="/runtime/cpuprof.go.html#1908589">e</a></span><span class="op" id="1908612">.</span><span class="ident" id="1908613">depth</span>&nbsp;<span class="op" id="1908619">!=</span>&nbsp;<span class="builtintype" id="1908622">uintptr</span><span class="op" id="1908629">(</span><span class="builtinfunc" id="1908630">len</span><span class="op" id="1908633">(</span><span class="ident" id="1908634"><a href="/runtime/cpuprof.go.html#1908311">pc</a></span><span class="op" id="1908636">)</span><span class="op" id="1908637">)</span>&nbsp;<span class="op" id="1908639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1908644">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1908655">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1908659">for</span>&nbsp;<span class="ident" id="1908663">j</span>&nbsp;<span class="op" id="1908665">:=</span>&nbsp;<span class="keyword" id="1908668">range</span>&nbsp;<span class="ident" id="1908674"><a href="/runtime/cpuprof.go.html#1908311">pc</a></span>&nbsp;<span class="op" id="1908677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1908682">if</span>&nbsp;<span class="ident" id="1908685"><a href="/runtime/cpuprof.go.html#1908589">e</a></span><span class="op" id="1908686">.</span><span class="ident" id="1908687">stack</span><span class="op" id="1908692">[</span><span class="ident" id="1908693"><a href="/runtime/cpuprof.go.html#1908663">j</a></span><span class="op" id="1908694">]</span>&nbsp;<span class="op" id="1908696">!=</span>&nbsp;<span class="ident" id="1908699"><a href="/runtime/cpuprof.go.html#1908311">pc</a></span><span class="op" id="1908701">[</span><span class="ident" id="1908702"><a href="/runtime/cpuprof.go.html#1908663">j</a></span><span class="op" id="1908703">]</span>&nbsp;<span class="op" id="1908705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1908711">continue</span>&nbsp;<span class="ident" id="1908720">Assoc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1908729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1908733">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1908737"><a href="/runtime/cpuprof.go.html#1908589">e</a></span><span class="op" id="1908738">.</span><span class="ident" id="1908739">count</span><span class="op" id="1908744">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1908749">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1908757">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1908761">//&nbsp;Evict&nbsp;entry&nbsp;with&nbsp;smallest&nbsp;count.</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1908798">var</span>&nbsp;<span class="ident" id="1908802">e</span>&nbsp;<span class="op" id="1908804">*</span><span class="ident" id="1908805"><a href="/runtime/cpuprof.go.html#1904446">cpuprofEntry</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1908819">for</span>&nbsp;<span class="ident" id="1908823">i</span>&nbsp;<span class="op" id="1908825">:=</span>&nbsp;<span class="keyword" id="1908828">range</span>&nbsp;<span class="ident" id="1908834"><a href="/runtime/cpuprof.go.html#1908527">b</a></span><span class="op" id="1908835">.</span><span class="ident" id="1908836">entry</span>&nbsp;<span class="op" id="1908842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1908846">if</span>&nbsp;<span class="ident" id="1908849"><a href="/runtime/cpuprof.go.html#1908802">e</a></span>&nbsp;<span class="op" id="1908851">==</span>&nbsp;<span class="ident" id="1908854">nil</span>&nbsp;<span class="op" id="1908858">||</span>&nbsp;<span class="ident" id="1908861"><a href="/runtime/cpuprof.go.html#1908527">b</a></span><span class="op" id="1908862">.</span><span class="ident" id="1908863">entry</span><span class="op" id="1908868">[</span><span class="ident" id="1908869"><a href="/runtime/cpuprof.go.html#1908823">i</a></span><span class="op" id="1908870">]</span><span class="op" id="1908871">.</span><span class="ident" id="1908872">count</span>&nbsp;<span class="op" id="1908878">&lt;</span>&nbsp;<span class="ident" id="1908880"><a href="/runtime/cpuprof.go.html#1908802">e</a></span><span class="op" id="1908881">.</span><span class="ident" id="1908882">count</span>&nbsp;<span class="op" id="1908888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1908893"><a href="/runtime/cpuprof.go.html#1908802">e</a></span>&nbsp;<span class="op" id="1908895">=</span>&nbsp;<span class="op" id="1908897">&amp;</span><span class="ident" id="1908898"><a href="/runtime/cpuprof.go.html#1908527">b</a></span><span class="op" id="1908899">.</span><span class="ident" id="1908900">entry</span><span class="op" id="1908905">[</span><span class="ident" id="1908906"><a href="/runtime/cpuprof.go.html#1908823">i</a></span><span class="op" id="1908907">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1908911">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1908914">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1908917">if</span>&nbsp;<span class="ident" id="1908920"><a href="/runtime/cpuprof.go.html#1908802">e</a></span><span class="op" id="1908921">.</span><span class="ident" id="1908922">count</span>&nbsp;<span class="op" id="1908928">&gt;</span>&nbsp;<span class="num" id="1908930">0</span>&nbsp;<span class="op" id="1908932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1908936">if</span>&nbsp;<span class="op" id="1908939">!</span><span class="ident" id="1908940"><a href="/runtime/cpuprof.go.html#1908292">p</a></span><span class="op" id="1908941">.</span><span class="ident" id="1908942">evict</span><span class="op" id="1908947">(</span><span class="ident" id="1908948"><a href="/runtime/cpuprof.go.html#1908802">e</a></span><span class="op" id="1908949">)</span>&nbsp;<span class="op" id="1908951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1908956">//&nbsp;Could&nbsp;not&nbsp;evict&nbsp;entry.&nbsp;&nbsp;Record&nbsp;lost&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1909005"><a href="/runtime/cpuprof.go.html#1908292">p</a></span><span class="op" id="1909006">.</span><span class="ident" id="1909007">lost</span><span class="op" id="1909011">++</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1909017">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1909026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1909030"><a href="/runtime/cpuprof.go.html#1908292">p</a></span><span class="op" id="1909031">.</span><span class="ident" id="1909032">evicts</span><span class="op" id="1909038">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1909042">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1909046">//&nbsp;Reuse&nbsp;the&nbsp;newly&nbsp;evicted&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1909081"><a href="/runtime/cpuprof.go.html#1908802">e</a></span><span class="op" id="1909082">.</span><span class="ident" id="1909083">depth</span>&nbsp;<span class="op" id="1909089">=</span>&nbsp;<span class="builtintype" id="1909091">uintptr</span><span class="op" id="1909098">(</span><span class="builtinfunc" id="1909099">len</span><span class="op" id="1909102">(</span><span class="ident" id="1909103"><a href="/runtime/cpuprof.go.html#1908311">pc</a></span><span class="op" id="1909105">)</span><span class="op" id="1909106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1909109"><a href="/runtime/cpuprof.go.html#1908802">e</a></span><span class="op" id="1909110">.</span><span class="ident" id="1909111">count</span>&nbsp;<span class="op" id="1909117">=</span>&nbsp;<span class="num" id="1909119">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1909122">copy</span><span class="op" id="1909126">(</span><span class="ident" id="1909127"><a href="/runtime/cpuprof.go.html#1908802">e</a></span><span class="op" id="1909128">.</span><span class="ident" id="1909129">stack</span><span class="op" id="1909134">[</span><span class="op" id="1909135">:</span><span class="op" id="1909136">]</span><span class="op" id="1909137">,</span>&nbsp;<span class="ident" id="1909139"><a href="/runtime/cpuprof.go.html#1908311">pc</a></span><span class="op" id="1909141">)</span><br>
<span class="lineno"></span><span class="op" id="1909143">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span><span class="comment" id="1909146">//&nbsp;evict&nbsp;copies&nbsp;the&nbsp;given&nbsp;entry&#39;s&nbsp;data&nbsp;into&nbsp;the&nbsp;log,&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="1909207">//&nbsp;the&nbsp;entry&nbsp;can&nbsp;be&nbsp;reused.&nbsp;&nbsp;evict&nbsp;is&nbsp;called&nbsp;from&nbsp;add,&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="1909268">//&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;profiling&nbsp;signal&nbsp;handler,&nbsp;so&nbsp;it&nbsp;must&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="1909331">//&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;block.&nbsp;&nbsp;It&nbsp;is&nbsp;safe&nbsp;to&nbsp;call&nbsp;flushlog.</span><br>
<span class="lineno">255</span><span class="comment" id="1909390">//&nbsp;evict&nbsp;returns&nbsp;true&nbsp;if&nbsp;the&nbsp;entry&nbsp;was&nbsp;copied&nbsp;to&nbsp;the&nbsp;log,</span><br>
<span class="lineno"></span><span class="comment" id="1909448">//&nbsp;false&nbsp;if&nbsp;there&nbsp;was&nbsp;no&nbsp;room&nbsp;available.</span><br>
<span class="lineno"></span><span class="keyword" id="1909489">func</span>&nbsp;<span class="op" id="1909494">(</span><span class="ident" id="1909495">p</span>&nbsp;<span class="op" id="1909497">*</span><span class="ident" id="1909498"><a href="/runtime/cpuprof.go.html#1904538">cpuProfile</a></span><span class="op" id="1909508">)</span>&nbsp;<span class="ident" id="1909510">evict</span><span class="op" id="1909515">(</span><span class="ident" id="1909516">e</span>&nbsp;<span class="op" id="1909518">*</span><span class="ident" id="1909519"><a href="/runtime/cpuprof.go.html#1904446">cpuprofEntry</a></span><span class="op" id="1909531">)</span>&nbsp;<span class="builtintype" id="1909533">bool</span>&nbsp;<span class="op" id="1909538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1909541">d</span>&nbsp;<span class="op" id="1909543">:=</span>&nbsp;<span class="ident" id="1909546"><a href="/runtime/cpuprof.go.html#1909516">e</a></span><span class="op" id="1909547">.</span><span class="ident" id="1909548">depth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1909555">nslot</span>&nbsp;<span class="op" id="1909561">:=</span>&nbsp;<span class="ident" id="1909564"><a href="/runtime/cpuprof.go.html#1909541">d</a></span>&nbsp;<span class="op" id="1909566">+</span>&nbsp;<span class="num" id="1909568">2</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1909571">log</span>&nbsp;<span class="op" id="1909575">:=</span>&nbsp;<span class="op" id="1909578">&amp;</span><span class="ident" id="1909579"><a href="/runtime/cpuprof.go.html#1909495">p</a></span><span class="op" id="1909580">.</span><span class="ident" id="1909581">log</span><span class="op" id="1909584">[</span><span class="ident" id="1909585"><a href="/runtime/cpuprof.go.html#1909495">p</a></span><span class="op" id="1909586">.</span><span class="ident" id="1909587">toggle</span><span class="op" id="1909593">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1909596">if</span>&nbsp;<span class="ident" id="1909599"><a href="/runtime/cpuprof.go.html#1909495">p</a></span><span class="op" id="1909600">.</span><span class="ident" id="1909601">nlog</span><span class="op" id="1909605">+</span><span class="ident" id="1909606"><a href="/runtime/cpuprof.go.html#1909555">nslot</a></span>&nbsp;<span class="op" id="1909612">&gt;</span>&nbsp;<span class="builtintype" id="1909614">uintptr</span><span class="op" id="1909621">(</span><span class="builtinfunc" id="1909622">len</span><span class="op" id="1909625">(</span><span class="ident" id="1909626"><a href="/runtime/cpuprof.go.html#1909495">p</a></span><span class="op" id="1909627">.</span><span class="ident" id="1909628">log</span><span class="op" id="1909631">[</span><span class="num" id="1909632">0</span><span class="op" id="1909633">]</span><span class="op" id="1909634">)</span><span class="op" id="1909635">)</span>&nbsp;<span class="op" id="1909637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1909641">if</span>&nbsp;<span class="op" id="1909644">!</span><span class="ident" id="1909645"><a href="/runtime/cpuprof.go.html#1909495">p</a></span><span class="op" id="1909646">.</span><span class="ident" id="1909647">flushlog</span><span class="op" id="1909655">(</span><span class="op" id="1909656">)</span>&nbsp;<span class="op" id="1909658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1909663">return</span>&nbsp;<span class="builtintype" id="1909670">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1909678">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1909682"><a href="/runtime/cpuprof.go.html#1909571">log</a></span>&nbsp;<span class="op" id="1909686">=</span>&nbsp;<span class="op" id="1909688">&amp;</span><span class="ident" id="1909689"><a href="/runtime/cpuprof.go.html#1909495">p</a></span><span class="op" id="1909690">.</span><span class="ident" id="1909691">log</span><span class="op" id="1909694">[</span><span class="ident" id="1909695"><a href="/runtime/cpuprof.go.html#1909495">p</a></span><span class="op" id="1909696">.</span><span class="ident" id="1909697">toggle</span><span class="op" id="1909703">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1909706">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1909710">q</span>&nbsp;<span class="op" id="1909712">:=</span>&nbsp;<span class="ident" id="1909715"><a href="/runtime/cpuprof.go.html#1909495">p</a></span><span class="op" id="1909716">.</span><span class="ident" id="1909717">nlog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1909723"><a href="/runtime/cpuprof.go.html#1909571">log</a></span><span class="op" id="1909726">[</span><span class="ident" id="1909727"><a href="/runtime/cpuprof.go.html#1909710">q</a></span><span class="op" id="1909728">]</span>&nbsp;<span class="op" id="1909730">=</span>&nbsp;<span class="ident" id="1909732"><a href="/runtime/cpuprof.go.html#1909516">e</a></span><span class="op" id="1909733">.</span><span class="ident" id="1909734">count</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1909741"><a href="/runtime/cpuprof.go.html#1909710">q</a></span><span class="op" id="1909742">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1909746"><a href="/runtime/cpuprof.go.html#1909571">log</a></span><span class="op" id="1909749">[</span><span class="ident" id="1909750"><a href="/runtime/cpuprof.go.html#1909710">q</a></span><span class="op" id="1909751">]</span>&nbsp;<span class="op" id="1909753">=</span>&nbsp;<span class="ident" id="1909755"><a href="/runtime/cpuprof.go.html#1909541">d</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1909758"><a href="/runtime/cpuprof.go.html#1909710">q</a></span><span class="op" id="1909759">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1909763">copy</span><span class="op" id="1909767">(</span><span class="ident" id="1909768"><a href="/runtime/cpuprof.go.html#1909571">log</a></span><span class="op" id="1909771">[</span><span class="ident" id="1909772"><a href="/runtime/cpuprof.go.html#1909710">q</a></span><span class="op" id="1909773">:</span><span class="op" id="1909774">]</span><span class="op" id="1909775">,</span>&nbsp;<span class="ident" id="1909777"><a href="/runtime/cpuprof.go.html#1909516">e</a></span><span class="op" id="1909778">.</span><span class="ident" id="1909779">stack</span><span class="op" id="1909784">[</span><span class="op" id="1909785">:</span><span class="ident" id="1909786"><a href="/runtime/cpuprof.go.html#1909541">d</a></span><span class="op" id="1909787">]</span><span class="op" id="1909788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1909791"><a href="/runtime/cpuprof.go.html#1909710">q</a></span>&nbsp;<span class="op" id="1909793">+=</span>&nbsp;<span class="ident" id="1909796"><a href="/runtime/cpuprof.go.html#1909541">d</a></span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1909799"><a href="/runtime/cpuprof.go.html#1909495">p</a></span><span class="op" id="1909800">.</span><span class="ident" id="1909801">nlog</span>&nbsp;<span class="op" id="1909806">=</span>&nbsp;<span class="ident" id="1909808"><a href="/runtime/cpuprof.go.html#1909710">q</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1909811"><a href="/runtime/cpuprof.go.html#1909516">e</a></span><span class="op" id="1909812">.</span><span class="ident" id="1909813">count</span>&nbsp;<span class="op" id="1909819">=</span>&nbsp;<span class="num" id="1909821">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1909824">return</span>&nbsp;<span class="builtintype" id="1909831">true</span><br>
<span class="lineno"></span><span class="op" id="1909836">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="1909839">//&nbsp;flushlog&nbsp;tries&nbsp;to&nbsp;flush&nbsp;the&nbsp;current&nbsp;log&nbsp;and&nbsp;switch&nbsp;to&nbsp;the&nbsp;other&nbsp;one.</span><br>
<span class="lineno"></span><span class="comment" id="1909911">//&nbsp;flushlog&nbsp;is&nbsp;called&nbsp;from&nbsp;evict,&nbsp;called&nbsp;from&nbsp;add,&nbsp;called&nbsp;from&nbsp;the&nbsp;signal&nbsp;handler,</span><br>
<span class="lineno"></span><span class="comment" id="1909994">//&nbsp;so&nbsp;it&nbsp;cannot&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;block.&nbsp;&nbsp;It&nbsp;can&nbsp;try&nbsp;to&nbsp;swap&nbsp;logs&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="1910066">//&nbsp;the&nbsp;writing&nbsp;goroutine,&nbsp;as&nbsp;explained&nbsp;in&nbsp;the&nbsp;comment&nbsp;at&nbsp;the&nbsp;top&nbsp;of&nbsp;this&nbsp;file.</span><br>
<span class="lineno"></span><span class="keyword" id="1910145">func</span>&nbsp;<span class="op" id="1910150">(</span><span class="ident" id="1910151">p</span>&nbsp;<span class="op" id="1910153">*</span><span class="ident" id="1910154"><a href="/runtime/cpuprof.go.html#1904538">cpuProfile</a></span><span class="op" id="1910164">)</span>&nbsp;<span class="ident" id="1910166">flushlog</span><span class="op" id="1910174">(</span><span class="op" id="1910175">)</span>&nbsp;<span class="builtintype" id="1910177">bool</span>&nbsp;<span class="op" id="1910182">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1910185">if</span>&nbsp;<span class="op" id="1910188">!</span><span class="ident" id="1910189"><a href="/runtime/stubs.go.html#2137846">cas</a></span><span class="op" id="1910192">(</span><span class="op" id="1910193">&amp;</span><span class="ident" id="1910194"><a href="/runtime/cpuprof.go.html#1910151">p</a></span><span class="op" id="1910195">.</span><span class="ident" id="1910196">handoff</span><span class="op" id="1910203">,</span>&nbsp;<span class="num" id="1910205">0</span><span class="op" id="1910206">,</span>&nbsp;<span class="builtintype" id="1910208">uint32</span><span class="op" id="1910214">(</span><span class="ident" id="1910215"><a href="/runtime/cpuprof.go.html#1910151">p</a></span><span class="op" id="1910216">.</span><span class="ident" id="1910217">nlog</span><span class="op" id="1910221">)</span><span class="op" id="1910222">)</span>&nbsp;<span class="op" id="1910224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1910228">return</span>&nbsp;<span class="builtintype" id="1910235">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1910242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1910245"><a href="/runtime/lock_futex.go.html#1980230">notewakeup</a></span><span class="op" id="1910255">(</span><span class="op" id="1910256">&amp;</span><span class="ident" id="1910257"><a href="/runtime/cpuprof.go.html#1910151">p</a></span><span class="op" id="1910258">.</span><span class="ident" id="1910259">wait</span><span class="op" id="1910263">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1910267"><a href="/runtime/cpuprof.go.html#1910151">p</a></span><span class="op" id="1910268">.</span><span class="ident" id="1910269">toggle</span>&nbsp;<span class="op" id="1910276">=</span>&nbsp;<span class="num" id="1910278">1</span>&nbsp;<span class="op" id="1910280">-</span>&nbsp;<span class="ident" id="1910282"><a href="/runtime/cpuprof.go.html#1910151">p</a></span><span class="op" id="1910283">.</span><span class="ident" id="1910284">toggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1910292">log</span>&nbsp;<span class="op" id="1910296">:=</span>&nbsp;<span class="op" id="1910299">&amp;</span><span class="ident" id="1910300"><a href="/runtime/cpuprof.go.html#1910151">p</a></span><span class="op" id="1910301">.</span><span class="ident" id="1910302">log</span><span class="op" id="1910305">[</span><span class="ident" id="1910306"><a href="/runtime/cpuprof.go.html#1910151">p</a></span><span class="op" id="1910307">.</span><span class="ident" id="1910308">toggle</span><span class="op" id="1910314">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1910317">q</span>&nbsp;<span class="op" id="1910319">:=</span>&nbsp;<span class="builtintype" id="1910322">uintptr</span><span class="op" id="1910329">(</span><span class="num" id="1910330">0</span><span class="op" id="1910331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1910334">if</span>&nbsp;<span class="ident" id="1910337"><a href="/runtime/cpuprof.go.html#1910151">p</a></span><span class="op" id="1910338">.</span><span class="ident" id="1910339">lost</span>&nbsp;<span class="op" id="1910344">&gt;</span>&nbsp;<span class="num" id="1910346">0</span>&nbsp;<span class="op" id="1910348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1910352">lostPC</span>&nbsp;<span class="op" id="1910359">:=</span>&nbsp;<span class="ident" id="1910362"><a href="/runtime/proc.go.html#2068560">funcPC</a></span><span class="op" id="1910368">(</span><span class="ident" id="1910369"><a href="/runtime/cpuprof.go.html#1905750">lostProfileData</a></span><span class="op" id="1910384">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1910388"><a href="/runtime/cpuprof.go.html#1910292">log</a></span><span class="op" id="1910391">[</span><span class="num" id="1910392">0</span><span class="op" id="1910393">]</span>&nbsp;<span class="op" id="1910395">=</span>&nbsp;<span class="ident" id="1910397"><a href="/runtime/cpuprof.go.html#1910151">p</a></span><span class="op" id="1910398">.</span><span class="ident" id="1910399">lost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1910406"><a href="/runtime/cpuprof.go.html#1910292">log</a></span><span class="op" id="1910409">[</span><span class="num" id="1910410">1</span><span class="op" id="1910411">]</span>&nbsp;<span class="op" id="1910413">=</span>&nbsp;<span class="num" id="1910415">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1910419"><a href="/runtime/cpuprof.go.html#1910292">log</a></span><span class="op" id="1910422">[</span><span class="num" id="1910423">2</span><span class="op" id="1910424">]</span>&nbsp;<span class="op" id="1910426">=</span>&nbsp;<span class="ident" id="1910428"><a href="/runtime/cpuprof.go.html#1910352">lostPC</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1910437"><a href="/runtime/cpuprof.go.html#1910317">q</a></span>&nbsp;<span class="op" id="1910439">=</span>&nbsp;<span class="num" id="1910441">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1910445"><a href="/runtime/cpuprof.go.html#1910151">p</a></span><span class="op" id="1910446">.</span><span class="ident" id="1910447">lost</span>&nbsp;<span class="op" id="1910452">=</span>&nbsp;<span class="num" id="1910454">0</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1910457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1910460"><a href="/runtime/cpuprof.go.html#1910151">p</a></span><span class="op" id="1910461">.</span><span class="ident" id="1910462">nlog</span>&nbsp;<span class="op" id="1910467">=</span>&nbsp;<span class="ident" id="1910469"><a href="/runtime/cpuprof.go.html#1910317">q</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1910472">return</span>&nbsp;<span class="builtintype" id="1910479">true</span><br>
<span class="lineno"></span><span class="op" id="1910484">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span><span class="comment" id="1910487">//&nbsp;getprofile&nbsp;blocks&nbsp;until&nbsp;the&nbsp;next&nbsp;block&nbsp;of&nbsp;profiling&nbsp;data&nbsp;is&nbsp;available</span><br>
<span class="lineno"></span><span class="comment" id="1910560">//&nbsp;and&nbsp;returns&nbsp;it&nbsp;as&nbsp;a&nbsp;[]byte.&nbsp;&nbsp;It&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;writing&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1910633">func</span>&nbsp;<span class="op" id="1910638">(</span><span class="ident" id="1910639">p</span>&nbsp;<span class="op" id="1910641">*</span><span class="ident" id="1910642"><a href="/runtime/cpuprof.go.html#1904538">cpuProfile</a></span><span class="op" id="1910652">)</span>&nbsp;<span class="ident" id="1910654">getprofile</span><span class="op" id="1910664">(</span><span class="op" id="1910665">)</span>&nbsp;<span class="op" id="1910667">[</span><span class="op" id="1910668">]</span><span class="builtintype" id="1910669">byte</span>&nbsp;<span class="op" id="1910674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1910677">if</span>&nbsp;<span class="ident" id="1910680"><a href="/runtime/cpuprof.go.html#1910639">p</a></span>&nbsp;<span class="op" id="1910682">==</span>&nbsp;<span class="ident" id="1910685">nil</span>&nbsp;<span class="op" id="1910689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1910693">return</span>&nbsp;<span class="ident" id="1910700">nil</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1910705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1910709">if</span>&nbsp;<span class="ident" id="1910712"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1910713">.</span><span class="ident" id="1910714">wholding</span>&nbsp;<span class="op" id="1910723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1910727">//&nbsp;Release&nbsp;previous&nbsp;log&nbsp;to&nbsp;signal&nbsp;handling&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1910778">//&nbsp;Loop&nbsp;because&nbsp;we&nbsp;are&nbsp;racing&nbsp;against&nbsp;SetCPUProfileRate(0).</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1910840">for</span>&nbsp;<span class="op" id="1910844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1910849">n</span>&nbsp;<span class="op" id="1910851">:=</span>&nbsp;<span class="ident" id="1910854"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1910855">.</span><span class="ident" id="1910856">handoff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1910867">if</span>&nbsp;<span class="ident" id="1910870"><a href="/runtime/cpuprof.go.html#1910849">n</a></span>&nbsp;<span class="op" id="1910872">==</span>&nbsp;<span class="num" id="1910875">0</span>&nbsp;<span class="op" id="1910877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1910883">print</span><span class="op" id="1910888">(</span><span class="string" id="1910889">&#34;runtime:&nbsp;phase&nbsp;error&nbsp;during&nbsp;cpu&nbsp;profile&nbsp;handoff\n&#34;</span><span class="op" id="1910940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1910946">return</span>&nbsp;<span class="ident" id="1910953">nil</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1910960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1910965">if</span>&nbsp;<span class="ident" id="1910968"><a href="/runtime/cpuprof.go.html#1910849">n</a></span><span class="op" id="1910969">&amp;</span><span class="num" id="1910970">0x80000000</span>&nbsp;<span class="op" id="1910981">!=</span>&nbsp;<span class="num" id="1910984">0</span>&nbsp;<span class="op" id="1910986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1910992"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1910993">.</span><span class="ident" id="1910994">wtoggle</span>&nbsp;<span class="op" id="1911002">=</span>&nbsp;<span class="num" id="1911004">1</span>&nbsp;<span class="op" id="1911006">-</span>&nbsp;<span class="ident" id="1911008"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1911009">.</span><span class="ident" id="1911010">wtoggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1911022"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1911023">.</span><span class="ident" id="1911024">wholding</span>&nbsp;<span class="op" id="1911033">=</span>&nbsp;<span class="builtintype" id="1911035">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1911045"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1911046">.</span><span class="ident" id="1911047">flushing</span>&nbsp;<span class="op" id="1911056">=</span>&nbsp;<span class="builtintype" id="1911058">true</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1911067">goto</span>&nbsp;<span class="ident" id="1911072">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1911081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1911086">if</span>&nbsp;<span class="ident" id="1911089"><a href="/runtime/stubs.go.html#2137846">cas</a></span><span class="op" id="1911092">(</span><span class="op" id="1911093">&amp;</span><span class="ident" id="1911094"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1911095">.</span><span class="ident" id="1911096">handoff</span><span class="op" id="1911103">,</span>&nbsp;<span class="ident" id="1911105"><a href="/runtime/cpuprof.go.html#1910849">n</a></span><span class="op" id="1911106">,</span>&nbsp;<span class="num" id="1911108">0</span><span class="op" id="1911109">)</span>&nbsp;<span class="op" id="1911111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1911117">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1911126">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1911130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1911134"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1911135">.</span><span class="ident" id="1911136">wtoggle</span>&nbsp;<span class="op" id="1911144">=</span>&nbsp;<span class="num" id="1911146">1</span>&nbsp;<span class="op" id="1911148">-</span>&nbsp;<span class="ident" id="1911150"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1911151">.</span><span class="ident" id="1911152">wtoggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1911162"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1911163">.</span><span class="ident" id="1911164">wholding</span>&nbsp;<span class="op" id="1911173">=</span>&nbsp;<span class="builtintype" id="1911175">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1911182">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1911186">if</span>&nbsp;<span class="ident" id="1911189"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1911190">.</span><span class="ident" id="1911191">flushing</span>&nbsp;<span class="op" id="1911200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1911204">goto</span>&nbsp;<span class="ident" id="1911209">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1911216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1911220">if</span>&nbsp;<span class="op" id="1911223">!</span><span class="ident" id="1911224"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1911225">.</span><span class="ident" id="1911226">on</span>&nbsp;<span class="op" id="1911229">&amp;&amp;</span>&nbsp;<span class="ident" id="1911232"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1911233">.</span><span class="ident" id="1911234">handoff</span>&nbsp;<span class="op" id="1911242">==</span>&nbsp;<span class="num" id="1911245">0</span>&nbsp;<span class="op" id="1911247">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1911251">return</span>&nbsp;<span class="ident" id="1911258">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1911263">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1911267">//&nbsp;Wait&nbsp;for&nbsp;new&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1911289"><a href="/runtime/lock_futex.go.html#1981536">notetsleepg</a></span><span class="op" id="1911300">(</span><span class="op" id="1911301">&amp;</span><span class="ident" id="1911302"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1911303">.</span><span class="ident" id="1911304">wait</span><span class="op" id="1911308">,</span>&nbsp;<span class="op" id="1911310">-</span><span class="num" id="1911311">1</span><span class="op" id="1911312">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1911315"><a href="/runtime/lock_futex.go.html#1980190">noteclear</a></span><span class="op" id="1911324">(</span><span class="op" id="1911325">&amp;</span><span class="ident" id="1911326"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1911327">.</span><span class="ident" id="1911328">wait</span><span class="op" id="1911332">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1911336">switch</span>&nbsp;<span class="ident" id="1911343">n</span>&nbsp;<span class="op" id="1911345">:=</span>&nbsp;<span class="ident" id="1911348"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1911349">.</span><span class="ident" id="1911350">handoff</span><span class="op" id="1911357">;</span>&nbsp;<span class="op" id="1911359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1911362">case</span>&nbsp;<span class="ident" id="1911367"><a href="/runtime/cpuprof.go.html#1911343">n</a></span>&nbsp;<span class="op" id="1911369">==</span>&nbsp;<span class="num" id="1911372">0</span><span class="op" id="1911373">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1911377">print</span><span class="op" id="1911382">(</span><span class="string" id="1911383">&#34;runtime:&nbsp;phase&nbsp;error&nbsp;during&nbsp;cpu&nbsp;profile&nbsp;wait\n&#34;</span><span class="op" id="1911431">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1911435">return</span>&nbsp;<span class="ident" id="1911442">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1911447">case</span>&nbsp;<span class="ident" id="1911452"><a href="/runtime/cpuprof.go.html#1911343">n</a></span>&nbsp;<span class="op" id="1911454">==</span>&nbsp;<span class="num" id="1911457">0x80000000</span><span class="op" id="1911467">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1911471"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1911472">.</span><span class="ident" id="1911473">flushing</span>&nbsp;<span class="op" id="1911482">=</span>&nbsp;<span class="builtintype" id="1911484">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1911491">goto</span>&nbsp;<span class="ident" id="1911496">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1911503">default</span><span class="op" id="1911510">:</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1911514"><a href="/runtime/cpuprof.go.html#1911343">n</a></span>&nbsp;<span class="op" id="1911516">&amp;^=</span>&nbsp;<span class="num" id="1911520">0x80000000</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1911534">//&nbsp;Return&nbsp;new&nbsp;log&nbsp;to&nbsp;caller.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1911565"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1911566">.</span><span class="ident" id="1911567">wholding</span>&nbsp;<span class="op" id="1911576">=</span>&nbsp;<span class="builtintype" id="1911578">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1911586">return</span>&nbsp;<span class="ident" id="1911593"><a href="/runtime/cpuprof.go.html#1912713">uintptrBytes</a></span><span class="op" id="1911605">(</span><span class="ident" id="1911606"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1911607">.</span><span class="ident" id="1911608">log</span><span class="op" id="1911611">[</span><span class="ident" id="1911612"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1911613">.</span><span class="ident" id="1911614">wtoggle</span><span class="op" id="1911621">]</span><span class="op" id="1911622">[</span><span class="op" id="1911623">:</span><span class="ident" id="1911624"><a href="/runtime/cpuprof.go.html#1911343">n</a></span><span class="op" id="1911625">]</span><span class="op" id="1911626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1911629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1911633">//&nbsp;In&nbsp;flush&nbsp;mode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1911652">//&nbsp;Add&nbsp;is&nbsp;no&nbsp;longer&nbsp;being&nbsp;called.&nbsp;&nbsp;We&nbsp;own&nbsp;the&nbsp;log.</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1911704">//&nbsp;Also,&nbsp;p-&gt;handoff&nbsp;is&nbsp;non-zero,&nbsp;so&nbsp;flushlog&nbsp;will&nbsp;return&nbsp;false.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1911769">//&nbsp;Evict&nbsp;the&nbsp;hash&nbsp;table&nbsp;into&nbsp;the&nbsp;log&nbsp;and&nbsp;return&nbsp;it.</span><br>
<span class="lineno"></span><span class="ident" id="1911821">Flush</span><span class="op" id="1911826">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1911829">for</span>&nbsp;<span class="ident" id="1911833">i</span>&nbsp;<span class="op" id="1911835">:=</span>&nbsp;<span class="keyword" id="1911838">range</span>&nbsp;<span class="ident" id="1911844"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1911845">.</span><span class="ident" id="1911846">hash</span>&nbsp;<span class="op" id="1911851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1911855">b</span>&nbsp;<span class="op" id="1911857">:=</span>&nbsp;<span class="op" id="1911860">&amp;</span><span class="ident" id="1911861"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1911862">.</span><span class="ident" id="1911863">hash</span><span class="op" id="1911867">[</span><span class="ident" id="1911868"><a href="/runtime/cpuprof.go.html#1911833">i</a></span><span class="op" id="1911869">]</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1911873">for</span>&nbsp;<span class="ident" id="1911877">j</span>&nbsp;<span class="op" id="1911879">:=</span>&nbsp;<span class="keyword" id="1911882">range</span>&nbsp;<span class="ident" id="1911888"><a href="/runtime/cpuprof.go.html#1911855">b</a></span><span class="op" id="1911889">.</span><span class="ident" id="1911890">entry</span>&nbsp;<span class="op" id="1911896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1911901">e</span>&nbsp;<span class="op" id="1911903">:=</span>&nbsp;<span class="op" id="1911906">&amp;</span><span class="ident" id="1911907"><a href="/runtime/cpuprof.go.html#1911855">b</a></span><span class="op" id="1911908">.</span><span class="ident" id="1911909">entry</span><span class="op" id="1911914">[</span><span class="ident" id="1911915"><a href="/runtime/cpuprof.go.html#1911877">j</a></span><span class="op" id="1911916">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1911921">if</span>&nbsp;<span class="ident" id="1911924"><a href="/runtime/cpuprof.go.html#1911901">e</a></span><span class="op" id="1911925">.</span><span class="ident" id="1911926">count</span>&nbsp;<span class="op" id="1911932">&gt;</span>&nbsp;<span class="num" id="1911934">0</span>&nbsp;<span class="op" id="1911936">&amp;&amp;</span>&nbsp;<span class="op" id="1911939">!</span><span class="ident" id="1911940"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1911941">.</span><span class="ident" id="1911942">evict</span><span class="op" id="1911947">(</span><span class="ident" id="1911948"><a href="/runtime/cpuprof.go.html#1911901">e</a></span><span class="op" id="1911949">)</span>&nbsp;<span class="op" id="1911951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1911957">//&nbsp;Filled&nbsp;the&nbsp;log.&nbsp;&nbsp;Stop&nbsp;the&nbsp;loop&nbsp;and&nbsp;return&nbsp;what&nbsp;we&#39;ve&nbsp;got.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1912022">break</span>&nbsp;<span class="ident" id="1912028">Flush</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1912037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1912041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1912044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1912048">//&nbsp;Return&nbsp;pending&nbsp;log&nbsp;data.</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1912077">if</span>&nbsp;<span class="ident" id="1912080"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1912081">.</span><span class="ident" id="1912082">nlog</span>&nbsp;<span class="op" id="1912087">&gt;</span>&nbsp;<span class="num" id="1912089">0</span>&nbsp;<span class="op" id="1912091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1912095">//&nbsp;Note&nbsp;that&nbsp;we&#39;re&nbsp;using&nbsp;toggle&nbsp;now,&nbsp;not&nbsp;wtoggle,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1912147">//&nbsp;because&nbsp;we&#39;re&nbsp;working&nbsp;on&nbsp;the&nbsp;log&nbsp;directly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1912195">n</span>&nbsp;<span class="op" id="1912197">:=</span>&nbsp;<span class="ident" id="1912200"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1912201">.</span><span class="ident" id="1912202">nlog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1912209"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1912210">.</span><span class="ident" id="1912211">nlog</span>&nbsp;<span class="op" id="1912216">=</span>&nbsp;<span class="num" id="1912218">0</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1912222">return</span>&nbsp;<span class="ident" id="1912229"><a href="/runtime/cpuprof.go.html#1912713">uintptrBytes</a></span><span class="op" id="1912241">(</span><span class="ident" id="1912242"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1912243">.</span><span class="ident" id="1912244">log</span><span class="op" id="1912247">[</span><span class="ident" id="1912248"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1912249">.</span><span class="ident" id="1912250">toggle</span><span class="op" id="1912256">]</span><span class="op" id="1912257">[</span><span class="op" id="1912258">:</span><span class="ident" id="1912259"><a href="/runtime/cpuprof.go.html#1912195">n</a></span><span class="op" id="1912260">]</span><span class="op" id="1912261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1912264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1912268">//&nbsp;Made&nbsp;it&nbsp;through&nbsp;the&nbsp;table&nbsp;without&nbsp;finding&nbsp;anything&nbsp;to&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1912331">if</span>&nbsp;<span class="op" id="1912334">!</span><span class="ident" id="1912335"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1912336">.</span><span class="ident" id="1912337">eodSent</span>&nbsp;<span class="op" id="1912345">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1912349">//&nbsp;We&nbsp;may&nbsp;not&nbsp;have&nbsp;space&nbsp;to&nbsp;append&nbsp;this&nbsp;to&nbsp;the&nbsp;partial&nbsp;log&nbsp;buf,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1912415">//&nbsp;so&nbsp;we&nbsp;always&nbsp;return&nbsp;a&nbsp;new&nbsp;slice&nbsp;for&nbsp;the&nbsp;end-of-data&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1912480"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1912481">.</span><span class="ident" id="1912482">eodSent</span>&nbsp;<span class="op" id="1912490">=</span>&nbsp;<span class="builtintype" id="1912492">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1912499">return</span>&nbsp;<span class="ident" id="1912506"><a href="/runtime/cpuprof.go.html#1912713">uintptrBytes</a></span><span class="op" id="1912518">(</span><span class="ident" id="1912519"><a href="/runtime/cpuprof.go.html#1905416">eod</a></span><span class="op" id="1912522">[</span><span class="op" id="1912523">:</span><span class="op" id="1912524">]</span><span class="op" id="1912525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1912528">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1912532">//&nbsp;Finally&nbsp;done.&nbsp;&nbsp;Clean&nbsp;up&nbsp;and&nbsp;return&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1912576"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1912577">.</span><span class="ident" id="1912578">flushing</span>&nbsp;<span class="op" id="1912587">=</span>&nbsp;<span class="builtintype" id="1912589">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1912596">if</span>&nbsp;<span class="op" id="1912599">!</span><span class="ident" id="1912600"><a href="/runtime/stubs.go.html#2137846">cas</a></span><span class="op" id="1912603">(</span><span class="op" id="1912604">&amp;</span><span class="ident" id="1912605"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1912606">.</span><span class="ident" id="1912607">handoff</span><span class="op" id="1912614">,</span>&nbsp;<span class="ident" id="1912616"><a href="/runtime/cpuprof.go.html#1910639">p</a></span><span class="op" id="1912617">.</span><span class="ident" id="1912618">handoff</span><span class="op" id="1912625">,</span>&nbsp;<span class="num" id="1912627">0</span><span class="op" id="1912628">)</span>&nbsp;<span class="op" id="1912630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1912634">print</span><span class="op" id="1912639">(</span><span class="string" id="1912640">&#34;runtime:&nbsp;profile&nbsp;flush&nbsp;racing&nbsp;with&nbsp;something\n&#34;</span><span class="op" id="1912688">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1912691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1912694">return</span>&nbsp;<span class="ident" id="1912701">nil</span><br>
<span class="lineno"></span><span class="op" id="1912705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1912708">func</span>&nbsp;<span class="ident" id="1912713">uintptrBytes</span><span class="op" id="1912725">(</span><span class="ident" id="1912726">p</span>&nbsp;<span class="op" id="1912728">[</span><span class="op" id="1912729">]</span><span class="builtintype" id="1912730">uintptr</span><span class="op" id="1912737">)</span>&nbsp;<span class="op" id="1912739">(</span><span class="ident" id="1912740">ret</span>&nbsp;<span class="op" id="1912744">[</span><span class="op" id="1912745">]</span><span class="builtintype" id="1912746">byte</span><span class="op" id="1912750">)</span>&nbsp;<span class="op" id="1912752">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1912755">pp</span>&nbsp;<span class="op" id="1912758">:=</span>&nbsp;<span class="op" id="1912761">(</span><span class="op" id="1912762">*</span><span class="ident" id="1912763"><a href="/runtime/slice.go.html#2106458">sliceStruct</a></span><span class="op" id="1912774">)</span><span class="op" id="1912775">(</span><span class="ident" id="1912776"><a href="/runtime/cpuprof.go.html#1904323">unsafe</a></span><span class="op" id="1912782">.</span><span class="ident" id="1912783">Pointer</span><span class="op" id="1912790">(</span><span class="op" id="1912791">&amp;</span><span class="ident" id="1912792"><a href="/runtime/cpuprof.go.html#1912726">p</a></span><span class="op" id="1912793">)</span><span class="op" id="1912794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1912797">rp</span>&nbsp;<span class="op" id="1912800">:=</span>&nbsp;<span class="op" id="1912803">(</span><span class="op" id="1912804">*</span><span class="ident" id="1912805"><a href="/runtime/slice.go.html#2106458">sliceStruct</a></span><span class="op" id="1912816">)</span><span class="op" id="1912817">(</span><span class="ident" id="1912818"><a href="/runtime/cpuprof.go.html#1904323">unsafe</a></span><span class="op" id="1912824">.</span><span class="ident" id="1912825">Pointer</span><span class="op" id="1912832">(</span><span class="op" id="1912833">&amp;</span><span class="ident" id="1912834"><a href="/runtime/cpuprof.go.html#1912740">ret</a></span><span class="op" id="1912837">)</span><span class="op" id="1912838">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1912842"><a href="/runtime/cpuprof.go.html#1912797">rp</a></span><span class="op" id="1912844">.</span><span class="ident" id="1912845">array</span>&nbsp;<span class="op" id="1912851">=</span>&nbsp;<span class="ident" id="1912853"><a href="/runtime/cpuprof.go.html#1912755">pp</a></span><span class="op" id="1912855">.</span><span class="ident" id="1912856">array</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1912863"><a href="/runtime/cpuprof.go.html#1912797">rp</a></span><span class="op" id="1912865">.</span><span class="builtinfunc" id="1912866">len</span>&nbsp;<span class="op" id="1912870">=</span>&nbsp;<span class="ident" id="1912872"><a href="/runtime/cpuprof.go.html#1912755">pp</a></span><span class="op" id="1912874">.</span><span class="builtinfunc" id="1912875">len</span>&nbsp;<span class="op" id="1912879">*</span>&nbsp;<span class="builtintype" id="1912881">int</span><span class="op" id="1912884">(</span><span class="ident" id="1912885"><a href="/runtime/cpuprof.go.html#1904323">unsafe</a></span><span class="op" id="1912891">.</span><span class="ident" id="1912892">Sizeof</span><span class="op" id="1912898">(</span><span class="ident" id="1912899"><a href="/runtime/cpuprof.go.html#1912726">p</a></span><span class="op" id="1912900">[</span><span class="num" id="1912901">0</span><span class="op" id="1912902">]</span><span class="op" id="1912903">)</span><span class="op" id="1912904">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1912907"><a href="/runtime/cpuprof.go.html#1912797">rp</a></span><span class="op" id="1912909">.</span><span class="builtinfunc" id="1912910">cap</span>&nbsp;<span class="op" id="1912914">=</span>&nbsp;<span class="ident" id="1912916"><a href="/runtime/cpuprof.go.html#1912797">rp</a></span><span class="op" id="1912918">.</span><span class="builtinfunc" id="1912919">len</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1912925">return</span><br>
<span class="lineno"></span><span class="op" id="1912932">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="1912935">//&nbsp;CPUProfile&nbsp;returns&nbsp;the&nbsp;next&nbsp;chunk&nbsp;of&nbsp;binary&nbsp;CPU&nbsp;profiling&nbsp;stack&nbsp;trace&nbsp;data,</span><br>
<span class="lineno"></span><span class="comment" id="1913014">//&nbsp;blocking&nbsp;until&nbsp;data&nbsp;is&nbsp;available.&nbsp;&nbsp;If&nbsp;profiling&nbsp;is&nbsp;turned&nbsp;off&nbsp;and&nbsp;all&nbsp;the&nbsp;profile</span><br>
<span class="lineno"></span><span class="comment" id="1913099">//&nbsp;data&nbsp;accumulated&nbsp;while&nbsp;it&nbsp;was&nbsp;on&nbsp;has&nbsp;been&nbsp;returned,&nbsp;CPUProfile&nbsp;returns&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1913178">//&nbsp;The&nbsp;caller&nbsp;must&nbsp;save&nbsp;the&nbsp;returned&nbsp;data&nbsp;before&nbsp;calling&nbsp;CPUProfile&nbsp;again.</span><br>
<span class="lineno"></span><span class="comment" id="1913253">//</span><br>
<span class="lineno">420</span><span class="comment" id="1913256">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1913312">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.cpuprofile&nbsp;flag&nbsp;instead&nbsp;of&nbsp;calling</span><br>
<span class="lineno"></span><span class="comment" id="1913378">//&nbsp;CPUProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1913402">func</span>&nbsp;<span class="ident" id="1913407">CPUProfile</span><span class="op" id="1913417">(</span><span class="op" id="1913418">)</span>&nbsp;<span class="op" id="1913420">[</span><span class="op" id="1913421">]</span><span class="builtintype" id="1913422">byte</span>&nbsp;<span class="op" id="1913427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1913430">return</span>&nbsp;<span class="ident" id="1913437"><a href="/runtime/cpuprof.go.html#1905390">cpuprof</a></span><span class="op" id="1913444">.</span><span class="ident" id="1913445">getprofile</span><span class="op" id="1913455">(</span><span class="op" id="1913456">)</span><br>
<span class="lineno">425</span><span class="op" id="1913458">}</span>
</div>
</body>
</html>
