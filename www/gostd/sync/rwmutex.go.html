<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1411634">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1411689">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1411743">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1411794">package</span>&nbsp;<span class="ident" id="1411802">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1411808">import</span>&nbsp;<span class="op" id="1411815">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1411818">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1411833">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><span class="op" id="1411842">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1411845">//&nbsp;An&nbsp;RWMutex&nbsp;is&nbsp;a&nbsp;reader/writer&nbsp;mutual&nbsp;exclusion&nbsp;lock.</span><br>
<span class="lineno"></span><span class="comment" id="1411901">//&nbsp;The&nbsp;lock&nbsp;can&nbsp;be&nbsp;held&nbsp;by&nbsp;an&nbsp;arbitrary&nbsp;number&nbsp;of&nbsp;readers</span><br>
<span class="lineno"></span><span class="comment" id="1411959">//&nbsp;or&nbsp;a&nbsp;single&nbsp;writer.</span><br>
<span class="lineno">15</span><span class="comment" id="1411982">//&nbsp;RWMutexes&nbsp;can&nbsp;be&nbsp;created&nbsp;as&nbsp;part&nbsp;of&nbsp;other</span><br>
<span class="lineno"></span><span class="comment" id="1412027">//&nbsp;structures;&nbsp;the&nbsp;zero&nbsp;value&nbsp;for&nbsp;a&nbsp;RWMutex&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1412074">//&nbsp;an&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="1412096">type</span>&nbsp;<span class="ident" id="1412101">RWMutex</span>&nbsp;<span class="keyword" id="1412109">struct</span>&nbsp;<span class="op" id="1412116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1412119">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1412131">Mutex</span>&nbsp;&nbsp;<span class="comment" id="1412138">//&nbsp;held&nbsp;if&nbsp;there&nbsp;are&nbsp;pending&nbsp;writers</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1412176">writerSem</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1412188">uint32</span>&nbsp;<span class="comment" id="1412195">//&nbsp;semaphore&nbsp;for&nbsp;writers&nbsp;to&nbsp;wait&nbsp;for&nbsp;completing&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1412252">readerSem</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1412264">uint32</span>&nbsp;<span class="comment" id="1412271">//&nbsp;semaphore&nbsp;for&nbsp;readers&nbsp;to&nbsp;wait&nbsp;for&nbsp;completing&nbsp;writers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1412328">readerCount</span>&nbsp;<span class="builtintype" id="1412340">int32</span>&nbsp;&nbsp;<span class="comment" id="1412347">//&nbsp;number&nbsp;of&nbsp;pending&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1412377">readerWait</span>&nbsp;&nbsp;<span class="builtintype" id="1412389">int32</span>&nbsp;&nbsp;<span class="comment" id="1412396">//&nbsp;number&nbsp;of&nbsp;departing&nbsp;readers</span><br>
<span class="lineno"></span><span class="op" id="1412427">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="1412430">const</span>&nbsp;<span class="ident" id="1412436">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1412454">=</span>&nbsp;<span class="num" id="1412456">1</span>&nbsp;<span class="op" id="1412458">&lt;&lt;</span>&nbsp;<span class="num" id="1412461">30</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1412465">//&nbsp;RLock&nbsp;locks&nbsp;rw&nbsp;for&nbsp;reading.</span><br>
<span class="lineno"></span><span class="keyword" id="1412496">func</span>&nbsp;<span class="op" id="1412501">(</span><span class="ident" id="1412502">rw</span>&nbsp;<span class="op" id="1412505">*</span><span class="ident" id="1412506">RWMutex</span><span class="op" id="1412513">)</span>&nbsp;<span class="ident" id="1412515">RLock</span><span class="op" id="1412520">(</span><span class="op" id="1412521">)</span>&nbsp;<span class="op" id="1412523">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1412526">if</span>&nbsp;<span class="ident" id="1412529">raceenabled</span>&nbsp;<span class="op" id="1412541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1412545">_</span>&nbsp;<span class="op" id="1412547">=</span>&nbsp;<span class="ident" id="1412549">rw</span><span class="op" id="1412551">.</span><span class="ident" id="1412552">w</span><span class="op" id="1412553">.</span><span class="ident" id="1412554">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1412562">raceDisable</span><span class="op" id="1412573">(</span><span class="op" id="1412574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1412577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1412580">if</span>&nbsp;<span class="ident" id="1412583">atomic</span><span class="op" id="1412589">.</span><span class="ident" id="1412590">AddInt32</span><span class="op" id="1412598">(</span><span class="op" id="1412599">&amp;</span><span class="ident" id="1412600">rw</span><span class="op" id="1412602">.</span><span class="ident" id="1412603">readerCount</span><span class="op" id="1412614">,</span>&nbsp;<span class="num" id="1412616">1</span><span class="op" id="1412617">)</span>&nbsp;<span class="op" id="1412619">&lt;</span>&nbsp;<span class="num" id="1412621">0</span>&nbsp;<span class="op" id="1412623">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1412627">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;pending,&nbsp;wait&nbsp;for&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1412666">runtime_Semacquire</span><span class="op" id="1412684">(</span><span class="op" id="1412685">&amp;</span><span class="ident" id="1412686">rw</span><span class="op" id="1412688">.</span><span class="ident" id="1412689">readerSem</span><span class="op" id="1412698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1412701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1412704">if</span>&nbsp;<span class="ident" id="1412707">raceenabled</span>&nbsp;<span class="op" id="1412719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1412723">raceEnable</span><span class="op" id="1412733">(</span><span class="op" id="1412734">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1412738">raceAcquire</span><span class="op" id="1412749">(</span><span class="ident" id="1412750">unsafe</span><span class="op" id="1412756">.</span><span class="ident" id="1412757">Pointer</span><span class="op" id="1412764">(</span><span class="op" id="1412765">&amp;</span><span class="ident" id="1412766">rw</span><span class="op" id="1412768">.</span><span class="ident" id="1412769">readerSem</span><span class="op" id="1412778">)</span><span class="op" id="1412779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1412782">}</span><br>
<span class="lineno"></span><span class="op" id="1412784">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1412787">//&nbsp;RUnlock&nbsp;undoes&nbsp;a&nbsp;single&nbsp;RLock&nbsp;call;</span><br>
<span class="lineno">45</span><span class="comment" id="1412826">//&nbsp;it&nbsp;does&nbsp;not&nbsp;affect&nbsp;other&nbsp;simultaneous&nbsp;readers.</span><br>
<span class="lineno"></span><span class="comment" id="1412876">//&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;rw&nbsp;is&nbsp;not&nbsp;locked&nbsp;for&nbsp;reading</span><br>
<span class="lineno"></span><span class="comment" id="1412934">//&nbsp;on&nbsp;entry&nbsp;to&nbsp;RUnlock.</span><br>
<span class="lineno"></span><span class="keyword" id="1412958">func</span>&nbsp;<span class="op" id="1412963">(</span><span class="ident" id="1412964">rw</span>&nbsp;<span class="op" id="1412967">*</span><span class="ident" id="1412968">RWMutex</span><span class="op" id="1412975">)</span>&nbsp;<span class="ident" id="1412977">RUnlock</span><span class="op" id="1412984">(</span><span class="op" id="1412985">)</span>&nbsp;<span class="op" id="1412987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1412990">if</span>&nbsp;<span class="ident" id="1412993">raceenabled</span>&nbsp;<span class="op" id="1413005">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1413009">_</span>&nbsp;<span class="op" id="1413011">=</span>&nbsp;<span class="ident" id="1413013">rw</span><span class="op" id="1413015">.</span><span class="ident" id="1413016">w</span><span class="op" id="1413017">.</span><span class="ident" id="1413018">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1413026">raceReleaseMerge</span><span class="op" id="1413042">(</span><span class="ident" id="1413043">unsafe</span><span class="op" id="1413049">.</span><span class="ident" id="1413050">Pointer</span><span class="op" id="1413057">(</span><span class="op" id="1413058">&amp;</span><span class="ident" id="1413059">rw</span><span class="op" id="1413061">.</span><span class="ident" id="1413062">writerSem</span><span class="op" id="1413071">)</span><span class="op" id="1413072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1413076">raceDisable</span><span class="op" id="1413087">(</span><span class="op" id="1413088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1413091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1413094">if</span>&nbsp;<span class="ident" id="1413097">r</span>&nbsp;<span class="op" id="1413099">:=</span>&nbsp;<span class="ident" id="1413102">atomic</span><span class="op" id="1413108">.</span><span class="ident" id="1413109">AddInt32</span><span class="op" id="1413117">(</span><span class="op" id="1413118">&amp;</span><span class="ident" id="1413119">rw</span><span class="op" id="1413121">.</span><span class="ident" id="1413122">readerCount</span><span class="op" id="1413133">,</span>&nbsp;<span class="op" id="1413135">-</span><span class="num" id="1413136">1</span><span class="op" id="1413137">)</span><span class="op" id="1413138">;</span>&nbsp;<span class="ident" id="1413140">r</span>&nbsp;<span class="op" id="1413142">&lt;</span>&nbsp;<span class="num" id="1413144">0</span>&nbsp;<span class="op" id="1413146">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1413150">if</span>&nbsp;<span class="ident" id="1413153">r</span><span class="op" id="1413154">+</span><span class="num" id="1413155">1</span>&nbsp;<span class="op" id="1413157">==</span>&nbsp;<span class="num" id="1413160">0</span>&nbsp;<span class="op" id="1413162">||</span>&nbsp;<span class="ident" id="1413165">r</span><span class="op" id="1413166">+</span><span class="num" id="1413167">1</span>&nbsp;<span class="op" id="1413169">==</span>&nbsp;<span class="op" id="1413172">-</span><span class="ident" id="1413173">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1413191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1413196">raceEnable</span><span class="op" id="1413206">(</span><span class="op" id="1413207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1413212">panic</span><span class="op" id="1413217">(</span><span class="string" id="1413218">&#34;sync:&nbsp;RUnlock&nbsp;of&nbsp;unlocked&nbsp;RWMutex&#34;</span><span class="op" id="1413253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1413257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1413261">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;pending.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1413287">if</span>&nbsp;<span class="ident" id="1413290">atomic</span><span class="op" id="1413296">.</span><span class="ident" id="1413297">AddInt32</span><span class="op" id="1413305">(</span><span class="op" id="1413306">&amp;</span><span class="ident" id="1413307">rw</span><span class="op" id="1413309">.</span><span class="ident" id="1413310">readerWait</span><span class="op" id="1413320">,</span>&nbsp;<span class="op" id="1413322">-</span><span class="num" id="1413323">1</span><span class="op" id="1413324">)</span>&nbsp;<span class="op" id="1413326">==</span>&nbsp;<span class="num" id="1413329">0</span>&nbsp;<span class="op" id="1413331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1413336">//&nbsp;The&nbsp;last&nbsp;reader&nbsp;unblocks&nbsp;the&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1413379">runtime_Semrelease</span><span class="op" id="1413397">(</span><span class="op" id="1413398">&amp;</span><span class="ident" id="1413399">rw</span><span class="op" id="1413401">.</span><span class="ident" id="1413402">writerSem</span><span class="op" id="1413411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1413415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1413418">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1413421">if</span>&nbsp;<span class="ident" id="1413424">raceenabled</span>&nbsp;<span class="op" id="1413436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1413440">raceEnable</span><span class="op" id="1413450">(</span><span class="op" id="1413451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1413454">}</span><br>
<span class="lineno"></span><span class="op" id="1413456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="comment" id="1413459">//&nbsp;Lock&nbsp;locks&nbsp;rw&nbsp;for&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="1413489">//&nbsp;If&nbsp;the&nbsp;lock&nbsp;is&nbsp;already&nbsp;locked&nbsp;for&nbsp;reading&nbsp;or&nbsp;writing,</span><br>
<span class="lineno"></span><span class="comment" id="1413546">//&nbsp;Lock&nbsp;blocks&nbsp;until&nbsp;the&nbsp;lock&nbsp;is&nbsp;available.</span><br>
<span class="lineno"></span><span class="comment" id="1413590">//&nbsp;To&nbsp;ensure&nbsp;that&nbsp;the&nbsp;lock&nbsp;eventually&nbsp;becomes&nbsp;available,</span><br>
<span class="lineno"></span><span class="comment" id="1413647">//&nbsp;a&nbsp;blocked&nbsp;Lock&nbsp;call&nbsp;excludes&nbsp;new&nbsp;readers&nbsp;from&nbsp;acquiring</span><br>
<span class="lineno">75</span><span class="comment" id="1413706">//&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="keyword" id="1413719">func</span>&nbsp;<span class="op" id="1413724">(</span><span class="ident" id="1413725">rw</span>&nbsp;<span class="op" id="1413728">*</span><span class="ident" id="1413729">RWMutex</span><span class="op" id="1413736">)</span>&nbsp;<span class="ident" id="1413738">Lock</span><span class="op" id="1413742">(</span><span class="op" id="1413743">)</span>&nbsp;<span class="op" id="1413745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1413748">if</span>&nbsp;<span class="ident" id="1413751">raceenabled</span>&nbsp;<span class="op" id="1413763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1413767">_</span>&nbsp;<span class="op" id="1413769">=</span>&nbsp;<span class="ident" id="1413771">rw</span><span class="op" id="1413773">.</span><span class="ident" id="1413774">w</span><span class="op" id="1413775">.</span><span class="ident" id="1413776">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1413784">raceDisable</span><span class="op" id="1413795">(</span><span class="op" id="1413796">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1413799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1413802">//&nbsp;First,&nbsp;resolve&nbsp;competition&nbsp;with&nbsp;other&nbsp;writers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1413853">rw</span><span class="op" id="1413855">.</span><span class="ident" id="1413856">w</span><span class="op" id="1413857">.</span><span class="ident" id="1413858">Lock</span><span class="op" id="1413862">(</span><span class="op" id="1413863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1413866">//&nbsp;Announce&nbsp;to&nbsp;readers&nbsp;there&nbsp;is&nbsp;a&nbsp;pending&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1413917">r</span>&nbsp;<span class="op" id="1413919">:=</span>&nbsp;<span class="ident" id="1413922">atomic</span><span class="op" id="1413928">.</span><span class="ident" id="1413929">AddInt32</span><span class="op" id="1413937">(</span><span class="op" id="1413938">&amp;</span><span class="ident" id="1413939">rw</span><span class="op" id="1413941">.</span><span class="ident" id="1413942">readerCount</span><span class="op" id="1413953">,</span>&nbsp;<span class="op" id="1413955">-</span><span class="ident" id="1413956">rwmutexMaxReaders</span><span class="op" id="1413973">)</span>&nbsp;<span class="op" id="1413975">+</span>&nbsp;<span class="ident" id="1413977">rwmutexMaxReaders</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1413996">//&nbsp;Wait&nbsp;for&nbsp;active&nbsp;readers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1414025">if</span>&nbsp;<span class="ident" id="1414028">r</span>&nbsp;<span class="op" id="1414030">!=</span>&nbsp;<span class="num" id="1414033">0</span>&nbsp;<span class="op" id="1414035">&amp;&amp;</span>&nbsp;<span class="ident" id="1414038">atomic</span><span class="op" id="1414044">.</span><span class="ident" id="1414045">AddInt32</span><span class="op" id="1414053">(</span><span class="op" id="1414054">&amp;</span><span class="ident" id="1414055">rw</span><span class="op" id="1414057">.</span><span class="ident" id="1414058">readerWait</span><span class="op" id="1414068">,</span>&nbsp;<span class="ident" id="1414070">r</span><span class="op" id="1414071">)</span>&nbsp;<span class="op" id="1414073">!=</span>&nbsp;<span class="num" id="1414076">0</span>&nbsp;<span class="op" id="1414078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1414082">runtime_Semacquire</span><span class="op" id="1414100">(</span><span class="op" id="1414101">&amp;</span><span class="ident" id="1414102">rw</span><span class="op" id="1414104">.</span><span class="ident" id="1414105">writerSem</span><span class="op" id="1414114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1414117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1414120">if</span>&nbsp;<span class="ident" id="1414123">raceenabled</span>&nbsp;<span class="op" id="1414135">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1414139">raceEnable</span><span class="op" id="1414149">(</span><span class="op" id="1414150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1414154">raceAcquire</span><span class="op" id="1414165">(</span><span class="ident" id="1414166">unsafe</span><span class="op" id="1414172">.</span><span class="ident" id="1414173">Pointer</span><span class="op" id="1414180">(</span><span class="op" id="1414181">&amp;</span><span class="ident" id="1414182">rw</span><span class="op" id="1414184">.</span><span class="ident" id="1414185">readerSem</span><span class="op" id="1414194">)</span><span class="op" id="1414195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1414199">raceAcquire</span><span class="op" id="1414210">(</span><span class="ident" id="1414211">unsafe</span><span class="op" id="1414217">.</span><span class="ident" id="1414218">Pointer</span><span class="op" id="1414225">(</span><span class="op" id="1414226">&amp;</span><span class="ident" id="1414227">rw</span><span class="op" id="1414229">.</span><span class="ident" id="1414230">writerSem</span><span class="op" id="1414239">)</span><span class="op" id="1414240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1414243">}</span><br>
<span class="lineno"></span><span class="op" id="1414245">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="1414248">//&nbsp;Unlock&nbsp;unlocks&nbsp;rw&nbsp;for&nbsp;writing.&nbsp;&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;rw&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1414315">//&nbsp;not&nbsp;locked&nbsp;for&nbsp;writing&nbsp;on&nbsp;entry&nbsp;to&nbsp;Unlock.</span><br>
<span class="lineno"></span><span class="comment" id="1414361">//</span><br>
<span class="lineno"></span><span class="comment" id="1414364">//&nbsp;As&nbsp;with&nbsp;Mutexes,&nbsp;a&nbsp;locked&nbsp;RWMutex&nbsp;is&nbsp;not&nbsp;associated&nbsp;with&nbsp;a&nbsp;particular</span><br>
<span class="lineno">100</span><span class="comment" id="1414437">//&nbsp;goroutine.&nbsp;&nbsp;One&nbsp;goroutine&nbsp;may&nbsp;RLock&nbsp;(Lock)&nbsp;an&nbsp;RWMutex&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="1414503">//&nbsp;arrange&nbsp;for&nbsp;another&nbsp;goroutine&nbsp;to&nbsp;RUnlock&nbsp;(Unlock)&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="1414560">func</span>&nbsp;<span class="op" id="1414565">(</span><span class="ident" id="1414566">rw</span>&nbsp;<span class="op" id="1414569">*</span><span class="ident" id="1414570">RWMutex</span><span class="op" id="1414577">)</span>&nbsp;<span class="ident" id="1414579">Unlock</span><span class="op" id="1414585">(</span><span class="op" id="1414586">)</span>&nbsp;<span class="op" id="1414588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1414591">if</span>&nbsp;<span class="ident" id="1414594">raceenabled</span>&nbsp;<span class="op" id="1414606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1414610">_</span>&nbsp;<span class="op" id="1414612">=</span>&nbsp;<span class="ident" id="1414614">rw</span><span class="op" id="1414616">.</span><span class="ident" id="1414617">w</span><span class="op" id="1414618">.</span><span class="ident" id="1414619">state</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1414627">raceRelease</span><span class="op" id="1414638">(</span><span class="ident" id="1414639">unsafe</span><span class="op" id="1414645">.</span><span class="ident" id="1414646">Pointer</span><span class="op" id="1414653">(</span><span class="op" id="1414654">&amp;</span><span class="ident" id="1414655">rw</span><span class="op" id="1414657">.</span><span class="ident" id="1414658">readerSem</span><span class="op" id="1414667">)</span><span class="op" id="1414668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1414672">raceRelease</span><span class="op" id="1414683">(</span><span class="ident" id="1414684">unsafe</span><span class="op" id="1414690">.</span><span class="ident" id="1414691">Pointer</span><span class="op" id="1414698">(</span><span class="op" id="1414699">&amp;</span><span class="ident" id="1414700">rw</span><span class="op" id="1414702">.</span><span class="ident" id="1414703">writerSem</span><span class="op" id="1414712">)</span><span class="op" id="1414713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1414717">raceDisable</span><span class="op" id="1414728">(</span><span class="op" id="1414729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1414732">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1414736">//&nbsp;Announce&nbsp;to&nbsp;readers&nbsp;there&nbsp;is&nbsp;no&nbsp;active&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1414787">r</span>&nbsp;<span class="op" id="1414789">:=</span>&nbsp;<span class="ident" id="1414792">atomic</span><span class="op" id="1414798">.</span><span class="ident" id="1414799">AddInt32</span><span class="op" id="1414807">(</span><span class="op" id="1414808">&amp;</span><span class="ident" id="1414809">rw</span><span class="op" id="1414811">.</span><span class="ident" id="1414812">readerCount</span><span class="op" id="1414823">,</span>&nbsp;<span class="ident" id="1414825">rwmutexMaxReaders</span><span class="op" id="1414842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1414845">if</span>&nbsp;<span class="ident" id="1414848">r</span>&nbsp;<span class="op" id="1414850">&gt;=</span>&nbsp;<span class="ident" id="1414853">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1414871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1414875">raceEnable</span><span class="op" id="1414885">(</span><span class="op" id="1414886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1414890">panic</span><span class="op" id="1414895">(</span><span class="string" id="1414896">&#34;sync:&nbsp;Unlock&nbsp;of&nbsp;unlocked&nbsp;RWMutex&#34;</span><span class="op" id="1414930">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1414933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1414936">//&nbsp;Unblock&nbsp;blocked&nbsp;readers,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1414973">for</span>&nbsp;<span class="ident" id="1414977">i</span>&nbsp;<span class="op" id="1414979">:=</span>&nbsp;<span class="num" id="1414982">0</span><span class="op" id="1414983">;</span>&nbsp;<span class="ident" id="1414985">i</span>&nbsp;<span class="op" id="1414987">&lt;</span>&nbsp;<span class="builtintype" id="1414989">int</span><span class="op" id="1414992">(</span><span class="ident" id="1414993">r</span><span class="op" id="1414994">)</span><span class="op" id="1414995">;</span>&nbsp;<span class="ident" id="1414997">i</span><span class="op" id="1414998">++</span>&nbsp;<span class="op" id="1415001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1415005">runtime_Semrelease</span><span class="op" id="1415023">(</span><span class="op" id="1415024">&amp;</span><span class="ident" id="1415025">rw</span><span class="op" id="1415027">.</span><span class="ident" id="1415028">readerSem</span><span class="op" id="1415037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1415040">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1415043">//&nbsp;Allow&nbsp;other&nbsp;writers&nbsp;to&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1415079">rw</span><span class="op" id="1415081">.</span><span class="ident" id="1415082">w</span><span class="op" id="1415083">.</span><span class="ident" id="1415084">Unlock</span><span class="op" id="1415090">(</span><span class="op" id="1415091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1415094">if</span>&nbsp;<span class="ident" id="1415097">raceenabled</span>&nbsp;<span class="op" id="1415109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1415113">raceEnable</span><span class="op" id="1415123">(</span><span class="op" id="1415124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1415127">}</span><br>
<span class="lineno">125</span><span class="op" id="1415129">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1415132">//&nbsp;RLocker&nbsp;returns&nbsp;a&nbsp;Locker&nbsp;interface&nbsp;that&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1415186">//&nbsp;the&nbsp;Lock&nbsp;and&nbsp;Unlock&nbsp;methods&nbsp;by&nbsp;calling&nbsp;rw.RLock&nbsp;and&nbsp;rw.RUnlock.</span><br>
<span class="lineno"></span><span class="keyword" id="1415253">func</span>&nbsp;<span class="op" id="1415258">(</span><span class="ident" id="1415259">rw</span>&nbsp;<span class="op" id="1415262">*</span><span class="ident" id="1415263">RWMutex</span><span class="op" id="1415270">)</span>&nbsp;<span class="ident" id="1415272">RLocker</span><span class="op" id="1415279">(</span><span class="op" id="1415280">)</span>&nbsp;<span class="ident" id="1415282">Locker</span>&nbsp;<span class="op" id="1415289">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1415292">return</span>&nbsp;<span class="op" id="1415299">(</span><span class="op" id="1415300">*</span><span class="ident" id="1415301">rlocker</span><span class="op" id="1415308">)</span><span class="op" id="1415309">(</span><span class="ident" id="1415310">rw</span><span class="op" id="1415312">)</span><br>
<span class="lineno"></span><span class="op" id="1415314">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1415317">type</span>&nbsp;<span class="ident" id="1415322">rlocker</span>&nbsp;<span class="ident" id="1415330">RWMutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="1415339">func</span>&nbsp;<span class="op" id="1415344">(</span><span class="ident" id="1415345">r</span>&nbsp;<span class="op" id="1415347">*</span><span class="ident" id="1415348">rlocker</span><span class="op" id="1415355">)</span>&nbsp;<span class="ident" id="1415357">Lock</span><span class="op" id="1415361">(</span><span class="op" id="1415362">)</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1415366">{</span>&nbsp;<span class="op" id="1415368">(</span><span class="op" id="1415369">*</span><span class="ident" id="1415370">RWMutex</span><span class="op" id="1415377">)</span><span class="op" id="1415378">(</span><span class="ident" id="1415379">r</span><span class="op" id="1415380">)</span><span class="op" id="1415381">.</span><span class="ident" id="1415382">RLock</span><span class="op" id="1415387">(</span><span class="op" id="1415388">)</span>&nbsp;<span class="op" id="1415390">}</span><br>
<span class="lineno"></span><span class="keyword" id="1415392">func</span>&nbsp;<span class="op" id="1415397">(</span><span class="ident" id="1415398">r</span>&nbsp;<span class="op" id="1415400">*</span><span class="ident" id="1415401">rlocker</span><span class="op" id="1415408">)</span>&nbsp;<span class="ident" id="1415410">Unlock</span><span class="op" id="1415416">(</span><span class="op" id="1415417">)</span>&nbsp;<span class="op" id="1415419">{</span>&nbsp;<span class="op" id="1415421">(</span><span class="op" id="1415422">*</span><span class="ident" id="1415423">RWMutex</span><span class="op" id="1415430">)</span><span class="op" id="1415431">(</span><span class="ident" id="1415432">r</span><span class="op" id="1415433">)</span><span class="op" id="1415434">.</span><span class="ident" id="1415435">RUnlock</span><span class="op" id="1415442">(</span><span class="op" id="1415443">)</span>&nbsp;<span class="op" id="1415445">}</span>
</div>
</body>
</html>
