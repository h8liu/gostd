<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html" class="current">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1359254">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1359309">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1359363">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1359414">//&nbsp;HTTP&nbsp;file&nbsp;system&nbsp;request&nbsp;handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1359451">package</span>&nbsp;<span class="ident" id="1359459">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1359465">import</span>&nbsp;<span class="op" id="1359472">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1359475">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1359485">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1359492">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1359498">&#34;mime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1359506">&#34;mime/multipart&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1359524">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1359541">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1359552">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1359558">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1359566">&#34;path/filepath&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1359583">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1359594">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1359605">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="1359612">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="1359615">//&nbsp;A&nbsp;Dir&nbsp;implements&nbsp;FileSystem&nbsp;using&nbsp;the&nbsp;native&nbsp;file&nbsp;system&nbsp;restricted&nbsp;to&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1359691">//&nbsp;specific&nbsp;directory&nbsp;tree.</span><br>
<span class="lineno"></span><span class="comment" id="1359719">//</span><br>
<span class="lineno"></span><span class="comment" id="1359722">//&nbsp;While&nbsp;the&nbsp;FileSystem.Open&nbsp;method&nbsp;takes&nbsp;&#39;/&#39;-separated&nbsp;paths,&nbsp;a&nbsp;Dir&#39;s&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="1359800">//&nbsp;value&nbsp;is&nbsp;a&nbsp;filename&nbsp;on&nbsp;the&nbsp;native&nbsp;file&nbsp;system,&nbsp;not&nbsp;a&nbsp;URL,&nbsp;so&nbsp;it&nbsp;is&nbsp;separated</span><br>
<span class="lineno">30</span><span class="comment" id="1359880">//&nbsp;by&nbsp;filepath.Separator,&nbsp;which&nbsp;isn&#39;t&nbsp;necessarily&nbsp;&#39;/&#39;.</span><br>
<span class="lineno"></span><span class="comment" id="1359935">//</span><br>
<span class="lineno"></span><span class="comment" id="1359938">//&nbsp;An&nbsp;empty&nbsp;Dir&nbsp;is&nbsp;treated&nbsp;as&nbsp;&#34;.&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="1359973">type</span>&nbsp;<span class="ident" id="1359978">Dir</span>&nbsp;<span class="builtintype" id="1359982">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="1359990">func</span>&nbsp;<span class="op" id="1359995">(</span><span class="ident" id="1359996">d</span>&nbsp;<span class="ident" id="1359998">Dir</span><span class="op" id="1360001">)</span>&nbsp;<span class="ident" id="1360003">Open</span><span class="op" id="1360007">(</span><span class="ident" id="1360008">name</span>&nbsp;<span class="builtintype" id="1360013">string</span><span class="op" id="1360019">)</span>&nbsp;<span class="op" id="1360021">(</span><span class="ident" id="1360022">File</span><span class="op" id="1360026">,</span>&nbsp;<span class="builtintype" id="1360028">error</span><span class="op" id="1360033">)</span>&nbsp;<span class="op" id="1360035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1360038">if</span>&nbsp;<span class="ident" id="1360041">filepath</span><span class="op" id="1360049">.</span><span class="ident" id="1360050">Separator</span>&nbsp;<span class="op" id="1360060">!=</span>&nbsp;<span class="string" id="1360063">&#39;/&#39;</span>&nbsp;<span class="op" id="1360067">&amp;&amp;</span>&nbsp;<span class="ident" id="1360070">strings</span><span class="op" id="1360077">.</span><span class="ident" id="1360078">IndexRune</span><span class="op" id="1360087">(</span><span class="ident" id="1360088">name</span><span class="op" id="1360092">,</span>&nbsp;<span class="ident" id="1360094">filepath</span><span class="op" id="1360102">.</span><span class="ident" id="1360103">Separator</span><span class="op" id="1360112">)</span>&nbsp;<span class="op" id="1360114">&gt;=</span>&nbsp;<span class="num" id="1360117">0</span>&nbsp;<span class="op" id="1360119">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1360124">strings</span><span class="op" id="1360131">.</span><span class="ident" id="1360132">Contains</span><span class="op" id="1360140">(</span><span class="ident" id="1360141">name</span><span class="op" id="1360145">,</span>&nbsp;<span class="string" id="1360147">&#34;\x00&#34;</span><span class="op" id="1360153">)</span>&nbsp;<span class="op" id="1360155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1360159">return</span>&nbsp;<span class="ident" id="1360166">nil</span><span class="op" id="1360169">,</span>&nbsp;<span class="ident" id="1360171">errors</span><span class="op" id="1360177">.</span><span class="ident" id="1360178">New</span><span class="op" id="1360181">(</span><span class="string" id="1360182">&#34;http:&nbsp;invalid&nbsp;character&nbsp;in&nbsp;file&nbsp;path&#34;</span><span class="op" id="1360220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1360223">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1360226">dir</span>&nbsp;<span class="op" id="1360230">:=</span>&nbsp;<span class="builtintype" id="1360233">string</span><span class="op" id="1360239">(</span><span class="ident" id="1360240">d</span><span class="op" id="1360241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1360244">if</span>&nbsp;<span class="ident" id="1360247">dir</span>&nbsp;<span class="op" id="1360251">==</span>&nbsp;<span class="string" id="1360254">&#34;&#34;</span>&nbsp;<span class="op" id="1360257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1360261">dir</span>&nbsp;<span class="op" id="1360265">=</span>&nbsp;<span class="string" id="1360267">&#34;.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1360272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1360275">f</span><span class="op" id="1360276">,</span>&nbsp;<span class="ident" id="1360278">err</span>&nbsp;<span class="op" id="1360282">:=</span>&nbsp;<span class="ident" id="1360285">os</span><span class="op" id="1360287">.</span><span class="ident" id="1360288">Open</span><span class="op" id="1360292">(</span><span class="ident" id="1360293">filepath</span><span class="op" id="1360301">.</span><span class="ident" id="1360302">Join</span><span class="op" id="1360306">(</span><span class="ident" id="1360307">dir</span><span class="op" id="1360310">,</span>&nbsp;<span class="ident" id="1360312">filepath</span><span class="op" id="1360320">.</span><span class="ident" id="1360321">FromSlash</span><span class="op" id="1360330">(</span><span class="ident" id="1360331">path</span><span class="op" id="1360335">.</span><span class="ident" id="1360336">Clean</span><span class="op" id="1360341">(</span><span class="string" id="1360342">&#34;/&#34;</span><span class="op" id="1360345">+</span><span class="ident" id="1360346">name</span><span class="op" id="1360350">)</span><span class="op" id="1360351">)</span><span class="op" id="1360352">)</span><span class="op" id="1360353">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1360356">if</span>&nbsp;<span class="ident" id="1360359">err</span>&nbsp;<span class="op" id="1360363">!=</span>&nbsp;<span class="ident" id="1360366">nil</span>&nbsp;<span class="op" id="1360370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1360374">return</span>&nbsp;<span class="ident" id="1360381">nil</span><span class="op" id="1360384">,</span>&nbsp;<span class="ident" id="1360386">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1360391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1360394">return</span>&nbsp;<span class="ident" id="1360401">f</span><span class="op" id="1360402">,</span>&nbsp;<span class="ident" id="1360404">nil</span><br>
<span class="lineno"></span><span class="op" id="1360408">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="comment" id="1360411">//&nbsp;A&nbsp;FileSystem&nbsp;implements&nbsp;access&nbsp;to&nbsp;a&nbsp;collection&nbsp;of&nbsp;named&nbsp;files.</span><br>
<span class="lineno"></span><span class="comment" id="1360477">//&nbsp;The&nbsp;elements&nbsp;in&nbsp;a&nbsp;file&nbsp;path&nbsp;are&nbsp;separated&nbsp;by&nbsp;slash&nbsp;(&#39;/&#39;,&nbsp;U+002F)</span><br>
<span class="lineno"></span><span class="comment" id="1360545">//&nbsp;characters,&nbsp;regardless&nbsp;of&nbsp;host&nbsp;operating&nbsp;system&nbsp;convention.</span><br>
<span class="lineno"></span><span class="keyword" id="1360608">type</span>&nbsp;<span class="ident" id="1360613">FileSystem</span>&nbsp;<span class="keyword" id="1360624">interface</span>&nbsp;<span class="op" id="1360634">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1360637">Open</span><span class="op" id="1360641">(</span><span class="ident" id="1360642">name</span>&nbsp;<span class="builtintype" id="1360647">string</span><span class="op" id="1360653">)</span>&nbsp;<span class="op" id="1360655">(</span><span class="ident" id="1360656">File</span><span class="op" id="1360660">,</span>&nbsp;<span class="builtintype" id="1360662">error</span><span class="op" id="1360667">)</span><br>
<span class="lineno"></span><span class="op" id="1360669">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1360672">//&nbsp;A&nbsp;File&nbsp;is&nbsp;returned&nbsp;by&nbsp;a&nbsp;FileSystem&#39;s&nbsp;Open&nbsp;method&nbsp;and&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1360735">//&nbsp;served&nbsp;by&nbsp;the&nbsp;FileServer&nbsp;implementation.</span><br>
<span class="lineno">60</span><span class="comment" id="1360779">//</span><br>
<span class="lineno"></span><span class="comment" id="1360782">//&nbsp;The&nbsp;methods&nbsp;should&nbsp;behave&nbsp;the&nbsp;same&nbsp;as&nbsp;those&nbsp;on&nbsp;an&nbsp;*os.File.</span><br>
<span class="lineno"></span><span class="keyword" id="1360845">type</span>&nbsp;<span class="ident" id="1360850">File</span>&nbsp;<span class="keyword" id="1360855">interface</span>&nbsp;<span class="op" id="1360865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1360868">io</span><span class="op" id="1360870">.</span><span class="ident" id="1360871">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1360879">io</span><span class="op" id="1360881">.</span><span class="ident" id="1360882">Reader</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1360890">Readdir</span><span class="op" id="1360897">(</span><span class="ident" id="1360898">count</span>&nbsp;<span class="builtintype" id="1360904">int</span><span class="op" id="1360907">)</span>&nbsp;<span class="op" id="1360909">(</span><span class="op" id="1360910">[</span><span class="op" id="1360911">]</span><span class="ident" id="1360912">os</span><span class="op" id="1360914">.</span><span class="ident" id="1360915">FileInfo</span><span class="op" id="1360923">,</span>&nbsp;<span class="builtintype" id="1360925">error</span><span class="op" id="1360930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1360933">Seek</span><span class="op" id="1360937">(</span><span class="ident" id="1360938">offset</span>&nbsp;<span class="ident" id="1360945">int64</span><span class="op" id="1360950">,</span>&nbsp;<span class="ident" id="1360952">whence</span>&nbsp;<span class="builtintype" id="1360959">int</span><span class="op" id="1360962">)</span>&nbsp;<span class="op" id="1360964">(</span><span class="ident" id="1360965">int64</span><span class="op" id="1360970">,</span>&nbsp;<span class="builtintype" id="1360972">error</span><span class="op" id="1360977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1360980">Stat</span><span class="op" id="1360984">(</span><span class="op" id="1360985">)</span>&nbsp;<span class="op" id="1360987">(</span><span class="ident" id="1360988">os</span><span class="op" id="1360990">.</span><span class="ident" id="1360991">FileInfo</span><span class="op" id="1360999">,</span>&nbsp;<span class="builtintype" id="1361001">error</span><span class="op" id="1361006">)</span><br>
<span class="lineno"></span><span class="op" id="1361008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="1361011">func</span>&nbsp;<span class="ident" id="1361016">dirList</span><span class="op" id="1361023">(</span><span class="ident" id="1361024">w</span>&nbsp;<span class="ident" id="1361026">ResponseWriter</span><span class="op" id="1361040">,</span>&nbsp;<span class="ident" id="1361042">f</span>&nbsp;<span class="ident" id="1361044">File</span><span class="op" id="1361048">)</span>&nbsp;<span class="op" id="1361050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1361053">w</span><span class="op" id="1361054">.</span><span class="ident" id="1361055">Header</span><span class="op" id="1361061">(</span><span class="op" id="1361062">)</span><span class="op" id="1361063">.</span><span class="ident" id="1361064">Set</span><span class="op" id="1361067">(</span><span class="string" id="1361068">&#34;Content-Type&#34;</span><span class="op" id="1361082">,</span>&nbsp;<span class="string" id="1361084">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="1361110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1361113">fmt</span><span class="op" id="1361116">.</span><span class="ident" id="1361117">Fprintf</span><span class="op" id="1361124">(</span><span class="ident" id="1361125">w</span><span class="op" id="1361126">,</span>&nbsp;<span class="string" id="1361128">&#34;&lt;pre&gt;\n&#34;</span><span class="op" id="1361137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1361140">for</span>&nbsp;<span class="op" id="1361144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1361148">dirs</span><span class="op" id="1361152">,</span>&nbsp;<span class="ident" id="1361154">err</span>&nbsp;<span class="op" id="1361158">:=</span>&nbsp;<span class="ident" id="1361161">f</span><span class="op" id="1361162">.</span><span class="ident" id="1361163">Readdir</span><span class="op" id="1361170">(</span><span class="num" id="1361171">100</span><span class="op" id="1361174">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1361178">if</span>&nbsp;<span class="ident" id="1361181">err</span>&nbsp;<span class="op" id="1361185">!=</span>&nbsp;<span class="ident" id="1361188">nil</span>&nbsp;<span class="op" id="1361192">||</span>&nbsp;<span class="builtinfunc" id="1361195">len</span><span class="op" id="1361198">(</span><span class="ident" id="1361199">dirs</span><span class="op" id="1361203">)</span>&nbsp;<span class="op" id="1361205">==</span>&nbsp;<span class="num" id="1361208">0</span>&nbsp;<span class="op" id="1361210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1361215">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1361223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1361227">for</span>&nbsp;<span class="ident" id="1361231">_</span><span class="op" id="1361232">,</span>&nbsp;<span class="ident" id="1361234">d</span>&nbsp;<span class="op" id="1361236">:=</span>&nbsp;<span class="keyword" id="1361239">range</span>&nbsp;<span class="ident" id="1361245">dirs</span>&nbsp;<span class="op" id="1361250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1361255">name</span>&nbsp;<span class="op" id="1361260">:=</span>&nbsp;<span class="ident" id="1361263">d</span><span class="op" id="1361264">.</span><span class="ident" id="1361265">Name</span><span class="op" id="1361269">(</span><span class="op" id="1361270">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1361275">if</span>&nbsp;<span class="ident" id="1361278">d</span><span class="op" id="1361279">.</span><span class="ident" id="1361280">IsDir</span><span class="op" id="1361285">(</span><span class="op" id="1361286">)</span>&nbsp;<span class="op" id="1361288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1361294">name</span>&nbsp;<span class="op" id="1361299">+=</span>&nbsp;<span class="string" id="1361302">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1361309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1361314">//&nbsp;name&nbsp;may&nbsp;contain&nbsp;&#39;?&#39;&nbsp;or&nbsp;&#39;#&#39;,&nbsp;which&nbsp;must&nbsp;be&nbsp;escaped&nbsp;to&nbsp;remain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1361381">//&nbsp;part&nbsp;of&nbsp;the&nbsp;URL&nbsp;path,&nbsp;and&nbsp;not&nbsp;indicate&nbsp;the&nbsp;start&nbsp;of&nbsp;a&nbsp;query</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1361447">//&nbsp;string&nbsp;or&nbsp;fragment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1361473">url</span>&nbsp;<span class="op" id="1361477">:=</span>&nbsp;<span class="ident" id="1361480">url</span><span class="op" id="1361483">.</span><span class="ident" id="1361484">URL</span><span class="op" id="1361487">{</span><span class="ident" id="1361488">Path</span><span class="op" id="1361492">:</span>&nbsp;<span class="ident" id="1361494">name</span><span class="op" id="1361498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1361503">fmt</span><span class="op" id="1361506">.</span><span class="ident" id="1361507">Fprintf</span><span class="op" id="1361514">(</span><span class="ident" id="1361515">w</span><span class="op" id="1361516">,</span>&nbsp;<span class="string" id="1361518">&#34;&lt;a&nbsp;href=\&#34;%s\&#34;&gt;%s&lt;/a&gt;\n&#34;</span><span class="op" id="1361543">,</span>&nbsp;<span class="ident" id="1361545">url</span><span class="op" id="1361548">.</span><span class="ident" id="1361549">String</span><span class="op" id="1361555">(</span><span class="op" id="1361556">)</span><span class="op" id="1361557">,</span>&nbsp;<span class="ident" id="1361559">htmlReplacer</span><span class="op" id="1361571">.</span><span class="ident" id="1361572">Replace</span><span class="op" id="1361579">(</span><span class="ident" id="1361580">name</span><span class="op" id="1361584">)</span><span class="op" id="1361585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1361589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1361592">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1361595">fmt</span><span class="op" id="1361598">.</span><span class="ident" id="1361599">Fprintf</span><span class="op" id="1361606">(</span><span class="ident" id="1361607">w</span><span class="op" id="1361608">,</span>&nbsp;<span class="string" id="1361610">&#34;&lt;/pre&gt;\n&#34;</span><span class="op" id="1361620">)</span><br>
<span class="lineno"></span><span class="op" id="1361622">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1361625">//&nbsp;ServeContent&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;using&nbsp;the&nbsp;content&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1361689">//&nbsp;provided&nbsp;ReadSeeker.&nbsp;&nbsp;The&nbsp;main&nbsp;benefit&nbsp;of&nbsp;ServeContent&nbsp;over&nbsp;io.Copy</span><br>
<span class="lineno">95</span><span class="comment" id="1361760">//&nbsp;is&nbsp;that&nbsp;it&nbsp;handles&nbsp;Range&nbsp;requests&nbsp;properly,&nbsp;sets&nbsp;the&nbsp;MIME&nbsp;type,&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1361831">//&nbsp;handles&nbsp;If-Modified-Since&nbsp;requests.</span><br>
<span class="lineno"></span><span class="comment" id="1361870">//</span><br>
<span class="lineno"></span><span class="comment" id="1361873">//&nbsp;If&nbsp;the&nbsp;response&#39;s&nbsp;Content-Type&nbsp;header&nbsp;is&nbsp;not&nbsp;set,&nbsp;ServeContent</span><br>
<span class="lineno"></span><span class="comment" id="1361939">//&nbsp;first&nbsp;tries&nbsp;to&nbsp;deduce&nbsp;the&nbsp;type&nbsp;from&nbsp;name&#39;s&nbsp;file&nbsp;extension&nbsp;and,</span><br>
<span class="lineno">100</span><span class="comment" id="1362005">//&nbsp;if&nbsp;that&nbsp;fails,&nbsp;falls&nbsp;back&nbsp;to&nbsp;reading&nbsp;the&nbsp;first&nbsp;block&nbsp;of&nbsp;the&nbsp;content</span><br>
<span class="lineno"></span><span class="comment" id="1362076">//&nbsp;and&nbsp;passing&nbsp;it&nbsp;to&nbsp;DetectContentType.</span><br>
<span class="lineno"></span><span class="comment" id="1362116">//&nbsp;The&nbsp;name&nbsp;is&nbsp;otherwise&nbsp;unused;&nbsp;in&nbsp;particular&nbsp;it&nbsp;can&nbsp;be&nbsp;empty&nbsp;and&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1362186">//&nbsp;never&nbsp;sent&nbsp;in&nbsp;the&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="1362217">//</span><br>
<span class="lineno">105</span><span class="comment" id="1362220">//&nbsp;If&nbsp;modtime&nbsp;is&nbsp;not&nbsp;the&nbsp;zero&nbsp;time,&nbsp;ServeContent&nbsp;includes&nbsp;it&nbsp;in&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1362286">//&nbsp;Last-Modified&nbsp;header&nbsp;in&nbsp;the&nbsp;response.&nbsp;&nbsp;If&nbsp;the&nbsp;request&nbsp;includes&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="1362355">//&nbsp;If-Modified-Since&nbsp;header,&nbsp;ServeContent&nbsp;uses&nbsp;modtime&nbsp;to&nbsp;decide</span><br>
<span class="lineno"></span><span class="comment" id="1362420">//&nbsp;whether&nbsp;the&nbsp;content&nbsp;needs&nbsp;to&nbsp;be&nbsp;sent&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span><span class="comment" id="1362468">//</span><br>
<span class="lineno">110</span><span class="comment" id="1362471">//&nbsp;The&nbsp;content&#39;s&nbsp;Seek&nbsp;method&nbsp;must&nbsp;work:&nbsp;ServeContent&nbsp;uses</span><br>
<span class="lineno"></span><span class="comment" id="1362529">//&nbsp;a&nbsp;seek&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;content&nbsp;to&nbsp;determine&nbsp;its&nbsp;size.</span><br>
<span class="lineno"></span><span class="comment" id="1362588">//</span><br>
<span class="lineno"></span><span class="comment" id="1362591">//&nbsp;If&nbsp;the&nbsp;caller&nbsp;has&nbsp;set&nbsp;w&#39;s&nbsp;ETag&nbsp;header,&nbsp;ServeContent&nbsp;uses&nbsp;it&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1362657">//&nbsp;handle&nbsp;requests&nbsp;using&nbsp;If-Range&nbsp;and&nbsp;If-None-Match.</span><br>
<span class="lineno">115</span><span class="comment" id="1362710">//</span><br>
<span class="lineno"></span><span class="comment" id="1362713">//&nbsp;Note&nbsp;that&nbsp;*os.File&nbsp;implements&nbsp;the&nbsp;io.ReadSeeker&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="1362775">func</span>&nbsp;<span class="ident" id="1362780">ServeContent</span><span class="op" id="1362792">(</span><span class="ident" id="1362793">w</span>&nbsp;<span class="ident" id="1362795">ResponseWriter</span><span class="op" id="1362809">,</span>&nbsp;<span class="ident" id="1362811">req</span>&nbsp;<span class="op" id="1362815">*</span><span class="ident" id="1362816">Request</span><span class="op" id="1362823">,</span>&nbsp;<span class="ident" id="1362825">name</span>&nbsp;<span class="builtintype" id="1362830">string</span><span class="op" id="1362836">,</span>&nbsp;<span class="ident" id="1362838">modtime</span>&nbsp;<span class="ident" id="1362846">time</span><span class="op" id="1362850">.</span><span class="ident" id="1362851">Time</span><span class="op" id="1362855">,</span>&nbsp;<span class="ident" id="1362857">content</span>&nbsp;<span class="ident" id="1362865">io</span><span class="op" id="1362867">.</span><span class="ident" id="1362868">ReadSeeker</span><span class="op" id="1362878">)</span>&nbsp;<span class="op" id="1362880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1362883">sizeFunc</span>&nbsp;<span class="op" id="1362892">:=</span>&nbsp;<span class="keyword" id="1362895">func</span><span class="op" id="1362899">(</span><span class="op" id="1362900">)</span>&nbsp;<span class="op" id="1362902">(</span><span class="ident" id="1362903">int64</span><span class="op" id="1362908">,</span>&nbsp;<span class="builtintype" id="1362910">error</span><span class="op" id="1362915">)</span>&nbsp;<span class="op" id="1362917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1362921">size</span><span class="op" id="1362925">,</span>&nbsp;<span class="ident" id="1362927">err</span>&nbsp;<span class="op" id="1362931">:=</span>&nbsp;<span class="ident" id="1362934">content</span><span class="op" id="1362941">.</span><span class="ident" id="1362942">Seek</span><span class="op" id="1362946">(</span><span class="num" id="1362947">0</span><span class="op" id="1362948">,</span>&nbsp;<span class="ident" id="1362950">os</span><span class="op" id="1362952">.</span><span class="ident" id="1362953">SEEK_END</span><span class="op" id="1362961">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1362965">if</span>&nbsp;<span class="ident" id="1362968">err</span>&nbsp;<span class="op" id="1362972">!=</span>&nbsp;<span class="ident" id="1362975">nil</span>&nbsp;<span class="op" id="1362979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1362984">return</span>&nbsp;<span class="num" id="1362991">0</span><span class="op" id="1362992">,</span>&nbsp;<span class="ident" id="1362994">errSeeker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1363006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1363010">_</span><span class="op" id="1363011">,</span>&nbsp;<span class="ident" id="1363013">err</span>&nbsp;<span class="op" id="1363017">=</span>&nbsp;<span class="ident" id="1363019">content</span><span class="op" id="1363026">.</span><span class="ident" id="1363027">Seek</span><span class="op" id="1363031">(</span><span class="num" id="1363032">0</span><span class="op" id="1363033">,</span>&nbsp;<span class="ident" id="1363035">os</span><span class="op" id="1363037">.</span><span class="ident" id="1363038">SEEK_SET</span><span class="op" id="1363046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1363050">if</span>&nbsp;<span class="ident" id="1363053">err</span>&nbsp;<span class="op" id="1363057">!=</span>&nbsp;<span class="ident" id="1363060">nil</span>&nbsp;<span class="op" id="1363064">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1363069">return</span>&nbsp;<span class="num" id="1363076">0</span><span class="op" id="1363077">,</span>&nbsp;<span class="ident" id="1363079">errSeeker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1363091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1363095">return</span>&nbsp;<span class="ident" id="1363102">size</span><span class="op" id="1363106">,</span>&nbsp;<span class="ident" id="1363108">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1363113">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1363116">serveContent</span><span class="op" id="1363128">(</span><span class="ident" id="1363129">w</span><span class="op" id="1363130">,</span>&nbsp;<span class="ident" id="1363132">req</span><span class="op" id="1363135">,</span>&nbsp;<span class="ident" id="1363137">name</span><span class="op" id="1363141">,</span>&nbsp;<span class="ident" id="1363143">modtime</span><span class="op" id="1363150">,</span>&nbsp;<span class="ident" id="1363152">sizeFunc</span><span class="op" id="1363160">,</span>&nbsp;<span class="ident" id="1363162">content</span><span class="op" id="1363169">)</span><br>
<span class="lineno">130</span><span class="op" id="1363171">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1363174">//&nbsp;errSeeker&nbsp;is&nbsp;returned&nbsp;by&nbsp;ServeContent&#39;s&nbsp;sizeFunc&nbsp;when&nbsp;the&nbsp;content</span><br>
<span class="lineno"></span><span class="comment" id="1363243">//&nbsp;doesn&#39;t&nbsp;seek&nbsp;properly.&nbsp;The&nbsp;underlying&nbsp;Seeker&#39;s&nbsp;error&nbsp;text&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="1363310">//&nbsp;included&nbsp;in&nbsp;the&nbsp;sizeFunc&nbsp;reply&nbsp;so&nbsp;it&#39;s&nbsp;not&nbsp;sent&nbsp;over&nbsp;HTTP&nbsp;to&nbsp;end</span><br>
<span class="lineno">135</span><span class="comment" id="1363378">//&nbsp;users.</span><br>
<span class="lineno"></span><span class="keyword" id="1363388">var</span>&nbsp;<span class="ident" id="1363392">errSeeker</span>&nbsp;<span class="op" id="1363402">=</span>&nbsp;<span class="ident" id="1363404">errors</span><span class="op" id="1363410">.</span><span class="ident" id="1363411">New</span><span class="op" id="1363414">(</span><span class="string" id="1363415">&#34;seeker&nbsp;can&#39;t&nbsp;seek&#34;</span><span class="op" id="1363434">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1363437">//&nbsp;if&nbsp;name&nbsp;is&nbsp;empty,&nbsp;filename&nbsp;is&nbsp;unknown.&nbsp;(used&nbsp;for&nbsp;mime&nbsp;type,&nbsp;before&nbsp;sniffing)</span><br>
<span class="lineno"></span><span class="comment" id="1363517">//&nbsp;if&nbsp;modtime.IsZero(),&nbsp;modtime&nbsp;is&nbsp;unknown.</span><br>
<span class="lineno">140</span><span class="comment" id="1363561">//&nbsp;content&nbsp;must&nbsp;be&nbsp;seeked&nbsp;to&nbsp;the&nbsp;beginning&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="1363617">//&nbsp;The&nbsp;sizeFunc&nbsp;is&nbsp;called&nbsp;at&nbsp;most&nbsp;once.&nbsp;Its&nbsp;error,&nbsp;if&nbsp;any,&nbsp;is&nbsp;sent&nbsp;in&nbsp;the&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="1363706">func</span>&nbsp;<span class="ident" id="1363711">serveContent</span><span class="op" id="1363723">(</span><span class="ident" id="1363724">w</span>&nbsp;<span class="ident" id="1363726">ResponseWriter</span><span class="op" id="1363740">,</span>&nbsp;<span class="ident" id="1363742">r</span>&nbsp;<span class="op" id="1363744">*</span><span class="ident" id="1363745">Request</span><span class="op" id="1363752">,</span>&nbsp;<span class="ident" id="1363754">name</span>&nbsp;<span class="builtintype" id="1363759">string</span><span class="op" id="1363765">,</span>&nbsp;<span class="ident" id="1363767">modtime</span>&nbsp;<span class="ident" id="1363775">time</span><span class="op" id="1363779">.</span><span class="ident" id="1363780">Time</span><span class="op" id="1363784">,</span>&nbsp;<span class="ident" id="1363786">sizeFunc</span>&nbsp;<span class="keyword" id="1363795">func</span><span class="op" id="1363799">(</span><span class="op" id="1363800">)</span>&nbsp;<span class="op" id="1363802">(</span><span class="ident" id="1363803">int64</span><span class="op" id="1363808">,</span>&nbsp;<span class="builtintype" id="1363810">error</span><span class="op" id="1363815">)</span><span class="op" id="1363816">,</span>&nbsp;<span class="ident" id="1363818">content</span>&nbsp;<span class="ident" id="1363826">io</span><span class="op" id="1363828">.</span><span class="ident" id="1363829">ReadSeeker</span><span class="op" id="1363839">)</span>&nbsp;<span class="op" id="1363841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1363844">if</span>&nbsp;<span class="ident" id="1363847">checkLastModified</span><span class="op" id="1363864">(</span><span class="ident" id="1363865">w</span><span class="op" id="1363866">,</span>&nbsp;<span class="ident" id="1363868">r</span><span class="op" id="1363869">,</span>&nbsp;<span class="ident" id="1363871">modtime</span><span class="op" id="1363878">)</span>&nbsp;<span class="op" id="1363880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1363884">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1363892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1363895">rangeReq</span><span class="op" id="1363903">,</span>&nbsp;<span class="ident" id="1363905">done</span>&nbsp;<span class="op" id="1363910">:=</span>&nbsp;<span class="ident" id="1363913">checkETag</span><span class="op" id="1363922">(</span><span class="ident" id="1363923">w</span><span class="op" id="1363924">,</span>&nbsp;<span class="ident" id="1363926">r</span><span class="op" id="1363927">,</span>&nbsp;<span class="ident" id="1363929">modtime</span><span class="op" id="1363936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1363939">if</span>&nbsp;<span class="ident" id="1363942">done</span>&nbsp;<span class="op" id="1363947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1363951">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1363959">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1363963">code</span>&nbsp;<span class="op" id="1363968">:=</span>&nbsp;<span class="ident" id="1363971">StatusOK</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1363982">//&nbsp;If&nbsp;Content-Type&nbsp;isn&#39;t&nbsp;set,&nbsp;use&nbsp;the&nbsp;file&#39;s&nbsp;extension&nbsp;to&nbsp;find&nbsp;it,&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1364054">//&nbsp;if&nbsp;the&nbsp;Content-Type&nbsp;is&nbsp;unset&nbsp;explicitly,&nbsp;do&nbsp;not&nbsp;sniff&nbsp;the&nbsp;type.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1364122">ctypes</span><span class="op" id="1364128">,</span>&nbsp;<span class="ident" id="1364130">haveType</span>&nbsp;<span class="op" id="1364139">:=</span>&nbsp;<span class="ident" id="1364142">w</span><span class="op" id="1364143">.</span><span class="ident" id="1364144">Header</span><span class="op" id="1364150">(</span><span class="op" id="1364151">)</span><span class="op" id="1364152">[</span><span class="string" id="1364153">&#34;Content-Type&#34;</span><span class="op" id="1364167">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1364170">var</span>&nbsp;<span class="ident" id="1364174">ctype</span>&nbsp;<span class="builtintype" id="1364180">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1364188">if</span>&nbsp;<span class="op" id="1364191">!</span><span class="ident" id="1364192">haveType</span>&nbsp;<span class="op" id="1364201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1364205">ctype</span>&nbsp;<span class="op" id="1364211">=</span>&nbsp;<span class="ident" id="1364213">mime</span><span class="op" id="1364217">.</span><span class="ident" id="1364218">TypeByExtension</span><span class="op" id="1364233">(</span><span class="ident" id="1364234">filepath</span><span class="op" id="1364242">.</span><span class="ident" id="1364243">Ext</span><span class="op" id="1364246">(</span><span class="ident" id="1364247">name</span><span class="op" id="1364251">)</span><span class="op" id="1364252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1364256">if</span>&nbsp;<span class="ident" id="1364259">ctype</span>&nbsp;<span class="op" id="1364265">==</span>&nbsp;<span class="string" id="1364268">&#34;&#34;</span>&nbsp;<span class="op" id="1364271">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1364276">//&nbsp;read&nbsp;a&nbsp;chunk&nbsp;to&nbsp;decide&nbsp;between&nbsp;utf-8&nbsp;text&nbsp;and&nbsp;binary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1364335">var</span>&nbsp;<span class="ident" id="1364339">buf</span>&nbsp;<span class="op" id="1364343">[</span><span class="ident" id="1364344">sniffLen</span><span class="op" id="1364352">]</span><span class="builtintype" id="1364353">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1364361">n</span><span class="op" id="1364362">,</span>&nbsp;<span class="ident" id="1364364">_</span>&nbsp;<span class="op" id="1364366">:=</span>&nbsp;<span class="ident" id="1364369">io</span><span class="op" id="1364371">.</span><span class="ident" id="1364372">ReadFull</span><span class="op" id="1364380">(</span><span class="ident" id="1364381">content</span><span class="op" id="1364388">,</span>&nbsp;<span class="ident" id="1364390">buf</span><span class="op" id="1364393">[</span><span class="op" id="1364394">:</span><span class="op" id="1364395">]</span><span class="op" id="1364396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1364401">ctype</span>&nbsp;<span class="op" id="1364407">=</span>&nbsp;<span class="ident" id="1364409">DetectContentType</span><span class="op" id="1364426">(</span><span class="ident" id="1364427">buf</span><span class="op" id="1364430">[</span><span class="op" id="1364431">:</span><span class="ident" id="1364432">n</span><span class="op" id="1364433">]</span><span class="op" id="1364434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1364439">_</span><span class="op" id="1364440">,</span>&nbsp;<span class="ident" id="1364442">err</span>&nbsp;<span class="op" id="1364446">:=</span>&nbsp;<span class="ident" id="1364449">content</span><span class="op" id="1364456">.</span><span class="ident" id="1364457">Seek</span><span class="op" id="1364461">(</span><span class="num" id="1364462">0</span><span class="op" id="1364463">,</span>&nbsp;<span class="ident" id="1364465">os</span><span class="op" id="1364467">.</span><span class="ident" id="1364468">SEEK_SET</span><span class="op" id="1364476">)</span>&nbsp;<span class="comment" id="1364478">//&nbsp;rewind&nbsp;to&nbsp;output&nbsp;whole&nbsp;file</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1364512">if</span>&nbsp;<span class="ident" id="1364515">err</span>&nbsp;<span class="op" id="1364519">!=</span>&nbsp;<span class="ident" id="1364522">nil</span>&nbsp;<span class="op" id="1364526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1364532">Error</span><span class="op" id="1364537">(</span><span class="ident" id="1364538">w</span><span class="op" id="1364539">,</span>&nbsp;<span class="string" id="1364541">&#34;seeker&nbsp;can&#39;t&nbsp;seek&#34;</span><span class="op" id="1364560">,</span>&nbsp;<span class="ident" id="1364562">StatusInternalServerError</span><span class="op" id="1364587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1364593">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1364603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1364607">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1364611">w</span><span class="op" id="1364612">.</span><span class="ident" id="1364613">Header</span><span class="op" id="1364619">(</span><span class="op" id="1364620">)</span><span class="op" id="1364621">.</span><span class="ident" id="1364622">Set</span><span class="op" id="1364625">(</span><span class="string" id="1364626">&#34;Content-Type&#34;</span><span class="op" id="1364640">,</span>&nbsp;<span class="ident" id="1364642">ctype</span><span class="op" id="1364647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1364650">}</span>&nbsp;<span class="keyword" id="1364652">else</span>&nbsp;<span class="keyword" id="1364657">if</span>&nbsp;<span class="builtinfunc" id="1364660">len</span><span class="op" id="1364663">(</span><span class="ident" id="1364664">ctypes</span><span class="op" id="1364670">)</span>&nbsp;<span class="op" id="1364672">&gt;</span>&nbsp;<span class="num" id="1364674">0</span>&nbsp;<span class="op" id="1364676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1364680">ctype</span>&nbsp;<span class="op" id="1364686">=</span>&nbsp;<span class="ident" id="1364688">ctypes</span><span class="op" id="1364694">[</span><span class="num" id="1364695">0</span><span class="op" id="1364696">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1364699">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1364703">size</span><span class="op" id="1364707">,</span>&nbsp;<span class="ident" id="1364709">err</span>&nbsp;<span class="op" id="1364713">:=</span>&nbsp;<span class="ident" id="1364716">sizeFunc</span><span class="op" id="1364724">(</span><span class="op" id="1364725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1364728">if</span>&nbsp;<span class="ident" id="1364731">err</span>&nbsp;<span class="op" id="1364735">!=</span>&nbsp;<span class="ident" id="1364738">nil</span>&nbsp;<span class="op" id="1364742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1364746">Error</span><span class="op" id="1364751">(</span><span class="ident" id="1364752">w</span><span class="op" id="1364753">,</span>&nbsp;<span class="ident" id="1364755">err</span><span class="op" id="1364758">.</span><span class="ident" id="1364759">Error</span><span class="op" id="1364764">(</span><span class="op" id="1364765">)</span><span class="op" id="1364766">,</span>&nbsp;<span class="ident" id="1364768">StatusInternalServerError</span><span class="op" id="1364793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1364797">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1364805">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1364809">//&nbsp;handle&nbsp;Content-Range&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1364842">sendSize</span>&nbsp;<span class="op" id="1364851">:=</span>&nbsp;<span class="ident" id="1364854">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1364860">var</span>&nbsp;<span class="ident" id="1364864">sendContent</span>&nbsp;<span class="ident" id="1364876">io</span><span class="op" id="1364878">.</span><span class="ident" id="1364879">Reader</span>&nbsp;<span class="op" id="1364886">=</span>&nbsp;<span class="ident" id="1364888">content</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1364897">if</span>&nbsp;<span class="ident" id="1364900">size</span>&nbsp;<span class="op" id="1364905">&gt;=</span>&nbsp;<span class="num" id="1364908">0</span>&nbsp;<span class="op" id="1364910">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1364914">ranges</span><span class="op" id="1364920">,</span>&nbsp;<span class="ident" id="1364922">err</span>&nbsp;<span class="op" id="1364926">:=</span>&nbsp;<span class="ident" id="1364929">parseRange</span><span class="op" id="1364939">(</span><span class="ident" id="1364940">rangeReq</span><span class="op" id="1364948">,</span>&nbsp;<span class="ident" id="1364950">size</span><span class="op" id="1364954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1364958">if</span>&nbsp;<span class="ident" id="1364961">err</span>&nbsp;<span class="op" id="1364965">!=</span>&nbsp;<span class="ident" id="1364968">nil</span>&nbsp;<span class="op" id="1364972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1364977">Error</span><span class="op" id="1364982">(</span><span class="ident" id="1364983">w</span><span class="op" id="1364984">,</span>&nbsp;<span class="ident" id="1364986">err</span><span class="op" id="1364989">.</span><span class="ident" id="1364990">Error</span><span class="op" id="1364995">(</span><span class="op" id="1364996">)</span><span class="op" id="1364997">,</span>&nbsp;<span class="ident" id="1364999">StatusRequestedRangeNotSatisfiable</span><span class="op" id="1365033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1365038">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1365047">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1365051">if</span>&nbsp;<span class="ident" id="1365054">sumRangesSize</span><span class="op" id="1365067">(</span><span class="ident" id="1365068">ranges</span><span class="op" id="1365074">)</span>&nbsp;<span class="op" id="1365076">&gt;</span>&nbsp;<span class="ident" id="1365078">size</span>&nbsp;<span class="op" id="1365083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1365088">//&nbsp;The&nbsp;total&nbsp;number&nbsp;of&nbsp;bytes&nbsp;in&nbsp;all&nbsp;the&nbsp;ranges</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1365138">//&nbsp;is&nbsp;larger&nbsp;than&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;file&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1365183">//&nbsp;itself,&nbsp;so&nbsp;this&nbsp;is&nbsp;probably&nbsp;an&nbsp;attack,&nbsp;or&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1365233">//&nbsp;dumb&nbsp;client.&nbsp;&nbsp;Ignore&nbsp;the&nbsp;range&nbsp;request.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1365279">ranges</span>&nbsp;<span class="op" id="1365286">=</span>&nbsp;<span class="ident" id="1365288">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1365294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1365298">switch</span>&nbsp;<span class="op" id="1365305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1365309">case</span>&nbsp;<span class="builtinfunc" id="1365314">len</span><span class="op" id="1365317">(</span><span class="ident" id="1365318">ranges</span><span class="op" id="1365324">)</span>&nbsp;<span class="op" id="1365326">==</span>&nbsp;<span class="num" id="1365329">1</span><span class="op" id="1365330">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1365335">//&nbsp;RFC&nbsp;2616,&nbsp;Section&nbsp;14.16:</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1365366">//&nbsp;&#34;When&nbsp;an&nbsp;HTTP&nbsp;message&nbsp;includes&nbsp;the&nbsp;content&nbsp;of&nbsp;a&nbsp;single</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1365427">//&nbsp;range&nbsp;(for&nbsp;example,&nbsp;a&nbsp;response&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1365483">//&nbsp;single&nbsp;range,&nbsp;or&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a&nbsp;set&nbsp;of&nbsp;ranges</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1365539">//&nbsp;that&nbsp;overlap&nbsp;without&nbsp;any&nbsp;holes),&nbsp;this&nbsp;content&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1365594">//&nbsp;transmitted&nbsp;with&nbsp;a&nbsp;Content-Range&nbsp;header,&nbsp;and&nbsp;a</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1365647">//&nbsp;Content-Length&nbsp;header&nbsp;showing&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1365703">//&nbsp;actually&nbsp;transferred.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1365731">//&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1365741">//&nbsp;A&nbsp;response&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a&nbsp;single&nbsp;range&nbsp;MUST&nbsp;NOT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1365799">//&nbsp;be&nbsp;sent&nbsp;using&nbsp;the&nbsp;multipart/byteranges&nbsp;media&nbsp;type.&#34;</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1365857">ra</span>&nbsp;<span class="op" id="1365860">:=</span>&nbsp;<span class="ident" id="1365863">ranges</span><span class="op" id="1365869">[</span><span class="num" id="1365870">0</span><span class="op" id="1365871">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1365876">if</span>&nbsp;<span class="ident" id="1365879">_</span><span class="op" id="1365880">,</span>&nbsp;<span class="ident" id="1365882">err</span>&nbsp;<span class="op" id="1365886">:=</span>&nbsp;<span class="ident" id="1365889">content</span><span class="op" id="1365896">.</span><span class="ident" id="1365897">Seek</span><span class="op" id="1365901">(</span><span class="ident" id="1365902">ra</span><span class="op" id="1365904">.</span><span class="ident" id="1365905">start</span><span class="op" id="1365910">,</span>&nbsp;<span class="ident" id="1365912">os</span><span class="op" id="1365914">.</span><span class="ident" id="1365915">SEEK_SET</span><span class="op" id="1365923">)</span><span class="op" id="1365924">;</span>&nbsp;<span class="ident" id="1365926">err</span>&nbsp;<span class="op" id="1365930">!=</span>&nbsp;<span class="ident" id="1365933">nil</span>&nbsp;<span class="op" id="1365937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1365943">Error</span><span class="op" id="1365948">(</span><span class="ident" id="1365949">w</span><span class="op" id="1365950">,</span>&nbsp;<span class="ident" id="1365952">err</span><span class="op" id="1365955">.</span><span class="ident" id="1365956">Error</span><span class="op" id="1365961">(</span><span class="op" id="1365962">)</span><span class="op" id="1365963">,</span>&nbsp;<span class="ident" id="1365965">StatusRequestedRangeNotSatisfiable</span><span class="op" id="1365999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1366005">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1366015">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366020">sendSize</span>&nbsp;<span class="op" id="1366029">=</span>&nbsp;<span class="ident" id="1366031">ra</span><span class="op" id="1366033">.</span><span class="ident" id="1366034">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366044">code</span>&nbsp;<span class="op" id="1366049">=</span>&nbsp;<span class="ident" id="1366051">StatusPartialContent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366075">w</span><span class="op" id="1366076">.</span><span class="ident" id="1366077">Header</span><span class="op" id="1366083">(</span><span class="op" id="1366084">)</span><span class="op" id="1366085">.</span><span class="ident" id="1366086">Set</span><span class="op" id="1366089">(</span><span class="string" id="1366090">&#34;Content-Range&#34;</span><span class="op" id="1366105">,</span>&nbsp;<span class="ident" id="1366107">ra</span><span class="op" id="1366109">.</span><span class="ident" id="1366110">contentRange</span><span class="op" id="1366122">(</span><span class="ident" id="1366123">size</span><span class="op" id="1366127">)</span><span class="op" id="1366128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1366132">case</span>&nbsp;<span class="builtinfunc" id="1366137">len</span><span class="op" id="1366140">(</span><span class="ident" id="1366141">ranges</span><span class="op" id="1366147">)</span>&nbsp;<span class="op" id="1366149">&gt;</span>&nbsp;<span class="num" id="1366151">1</span><span class="op" id="1366152">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366157">sendSize</span>&nbsp;<span class="op" id="1366166">=</span>&nbsp;<span class="ident" id="1366168">rangesMIMESize</span><span class="op" id="1366182">(</span><span class="ident" id="1366183">ranges</span><span class="op" id="1366189">,</span>&nbsp;<span class="ident" id="1366191">ctype</span><span class="op" id="1366196">,</span>&nbsp;<span class="ident" id="1366198">size</span><span class="op" id="1366202">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366207">code</span>&nbsp;<span class="op" id="1366212">=</span>&nbsp;<span class="ident" id="1366214">StatusPartialContent</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366239">pr</span><span class="op" id="1366241">,</span>&nbsp;<span class="ident" id="1366243">pw</span>&nbsp;<span class="op" id="1366246">:=</span>&nbsp;<span class="ident" id="1366249">io</span><span class="op" id="1366251">.</span><span class="ident" id="1366252">Pipe</span><span class="op" id="1366256">(</span><span class="op" id="1366257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366262">mw</span>&nbsp;<span class="op" id="1366265">:=</span>&nbsp;<span class="ident" id="1366268">multipart</span><span class="op" id="1366277">.</span><span class="ident" id="1366278">NewWriter</span><span class="op" id="1366287">(</span><span class="ident" id="1366288">pw</span><span class="op" id="1366290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366295">w</span><span class="op" id="1366296">.</span><span class="ident" id="1366297">Header</span><span class="op" id="1366303">(</span><span class="op" id="1366304">)</span><span class="op" id="1366305">.</span><span class="ident" id="1366306">Set</span><span class="op" id="1366309">(</span><span class="string" id="1366310">&#34;Content-Type&#34;</span><span class="op" id="1366324">,</span>&nbsp;<span class="string" id="1366326">&#34;multipart/byteranges;&nbsp;boundary=&#34;</span><span class="op" id="1366359">+</span><span class="ident" id="1366360">mw</span><span class="op" id="1366362">.</span><span class="ident" id="1366363">Boundary</span><span class="op" id="1366371">(</span><span class="op" id="1366372">)</span><span class="op" id="1366373">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366378">sendContent</span>&nbsp;<span class="op" id="1366390">=</span>&nbsp;<span class="ident" id="1366392">pr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1366398">defer</span>&nbsp;<span class="ident" id="1366404">pr</span><span class="op" id="1366406">.</span><span class="ident" id="1366407">Close</span><span class="op" id="1366412">(</span><span class="op" id="1366413">)</span>&nbsp;<span class="comment" id="1366415">//&nbsp;cause&nbsp;writing&nbsp;goroutine&nbsp;to&nbsp;fail&nbsp;and&nbsp;exit&nbsp;if&nbsp;CopyN&nbsp;doesn&#39;t&nbsp;finish.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1366487">go</span>&nbsp;<span class="keyword" id="1366490">func</span><span class="op" id="1366494">(</span><span class="op" id="1366495">)</span>&nbsp;<span class="op" id="1366497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1366503">for</span>&nbsp;<span class="ident" id="1366507">_</span><span class="op" id="1366508">,</span>&nbsp;<span class="ident" id="1366510">ra</span>&nbsp;<span class="op" id="1366513">:=</span>&nbsp;<span class="keyword" id="1366516">range</span>&nbsp;<span class="ident" id="1366522">ranges</span>&nbsp;<span class="op" id="1366529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366536">part</span><span class="op" id="1366540">,</span>&nbsp;<span class="ident" id="1366542">err</span>&nbsp;<span class="op" id="1366546">:=</span>&nbsp;<span class="ident" id="1366549">mw</span><span class="op" id="1366551">.</span><span class="ident" id="1366552">CreatePart</span><span class="op" id="1366562">(</span><span class="ident" id="1366563">ra</span><span class="op" id="1366565">.</span><span class="ident" id="1366566">mimeHeader</span><span class="op" id="1366576">(</span><span class="ident" id="1366577">ctype</span><span class="op" id="1366582">,</span>&nbsp;<span class="ident" id="1366584">size</span><span class="op" id="1366588">)</span><span class="op" id="1366589">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1366596">if</span>&nbsp;<span class="ident" id="1366599">err</span>&nbsp;<span class="op" id="1366603">!=</span>&nbsp;<span class="ident" id="1366606">nil</span>&nbsp;<span class="op" id="1366610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366618">pw</span><span class="op" id="1366620">.</span><span class="ident" id="1366621">CloseWithError</span><span class="op" id="1366635">(</span><span class="ident" id="1366636">err</span><span class="op" id="1366639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1366647">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1366659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1366666">if</span>&nbsp;<span class="ident" id="1366669">_</span><span class="op" id="1366670">,</span>&nbsp;<span class="ident" id="1366672">err</span>&nbsp;<span class="op" id="1366676">:=</span>&nbsp;<span class="ident" id="1366679">content</span><span class="op" id="1366686">.</span><span class="ident" id="1366687">Seek</span><span class="op" id="1366691">(</span><span class="ident" id="1366692">ra</span><span class="op" id="1366694">.</span><span class="ident" id="1366695">start</span><span class="op" id="1366700">,</span>&nbsp;<span class="ident" id="1366702">os</span><span class="op" id="1366704">.</span><span class="ident" id="1366705">SEEK_SET</span><span class="op" id="1366713">)</span><span class="op" id="1366714">;</span>&nbsp;<span class="ident" id="1366716">err</span>&nbsp;<span class="op" id="1366720">!=</span>&nbsp;<span class="ident" id="1366723">nil</span>&nbsp;<span class="op" id="1366727">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366735">pw</span><span class="op" id="1366737">.</span><span class="ident" id="1366738">CloseWithError</span><span class="op" id="1366752">(</span><span class="ident" id="1366753">err</span><span class="op" id="1366756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1366764">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1366776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1366783">if</span>&nbsp;<span class="ident" id="1366786">_</span><span class="op" id="1366787">,</span>&nbsp;<span class="ident" id="1366789">err</span>&nbsp;<span class="op" id="1366793">:=</span>&nbsp;<span class="ident" id="1366796">io</span><span class="op" id="1366798">.</span><span class="ident" id="1366799">CopyN</span><span class="op" id="1366804">(</span><span class="ident" id="1366805">part</span><span class="op" id="1366809">,</span>&nbsp;<span class="ident" id="1366811">content</span><span class="op" id="1366818">,</span>&nbsp;<span class="ident" id="1366820">ra</span><span class="op" id="1366822">.</span><span class="ident" id="1366823">length</span><span class="op" id="1366829">)</span><span class="op" id="1366830">;</span>&nbsp;<span class="ident" id="1366832">err</span>&nbsp;<span class="op" id="1366836">!=</span>&nbsp;<span class="ident" id="1366839">nil</span>&nbsp;<span class="op" id="1366843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366851">pw</span><span class="op" id="1366853">.</span><span class="ident" id="1366854">CloseWithError</span><span class="op" id="1366868">(</span><span class="ident" id="1366869">err</span><span class="op" id="1366872">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1366880">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1366892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1366898">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366904">mw</span><span class="op" id="1366906">.</span><span class="ident" id="1366907">Close</span><span class="op" id="1366912">(</span><span class="op" id="1366913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366919">pw</span><span class="op" id="1366921">.</span><span class="ident" id="1366922">Close</span><span class="op" id="1366927">(</span><span class="op" id="1366928">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1366933">}</span><span class="op" id="1366934">(</span><span class="op" id="1366935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1366939">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366944">w</span><span class="op" id="1366945">.</span><span class="ident" id="1366946">Header</span><span class="op" id="1366952">(</span><span class="op" id="1366953">)</span><span class="op" id="1366954">.</span><span class="ident" id="1366955">Set</span><span class="op" id="1366958">(</span><span class="string" id="1366959">&#34;Accept-Ranges&#34;</span><span class="op" id="1366974">,</span>&nbsp;<span class="string" id="1366976">&#34;bytes&#34;</span><span class="op" id="1366983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1366987">if</span>&nbsp;<span class="ident" id="1366990">w</span><span class="op" id="1366991">.</span><span class="ident" id="1366992">Header</span><span class="op" id="1366998">(</span><span class="op" id="1366999">)</span><span class="op" id="1367000">.</span><span class="ident" id="1367001">Get</span><span class="op" id="1367004">(</span><span class="string" id="1367005">&#34;Content-Encoding&#34;</span><span class="op" id="1367023">)</span>&nbsp;<span class="op" id="1367025">==</span>&nbsp;<span class="string" id="1367028">&#34;&#34;</span>&nbsp;<span class="op" id="1367031">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1367036">w</span><span class="op" id="1367037">.</span><span class="ident" id="1367038">Header</span><span class="op" id="1367044">(</span><span class="op" id="1367045">)</span><span class="op" id="1367046">.</span><span class="ident" id="1367047">Set</span><span class="op" id="1367050">(</span><span class="string" id="1367051">&#34;Content-Length&#34;</span><span class="op" id="1367067">,</span>&nbsp;<span class="ident" id="1367069">strconv</span><span class="op" id="1367076">.</span><span class="ident" id="1367077">FormatInt</span><span class="op" id="1367086">(</span><span class="ident" id="1367087">sendSize</span><span class="op" id="1367095">,</span>&nbsp;<span class="num" id="1367097">10</span><span class="op" id="1367099">)</span><span class="op" id="1367100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1367104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1367107">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1367111">w</span><span class="op" id="1367112">.</span><span class="ident" id="1367113">WriteHeader</span><span class="op" id="1367124">(</span><span class="ident" id="1367125">code</span><span class="op" id="1367129">)</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1367133">if</span>&nbsp;<span class="ident" id="1367136">r</span><span class="op" id="1367137">.</span><span class="ident" id="1367138">Method</span>&nbsp;<span class="op" id="1367145">!=</span>&nbsp;<span class="string" id="1367148">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="1367155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1367159">io</span><span class="op" id="1367161">.</span><span class="ident" id="1367162">CopyN</span><span class="op" id="1367167">(</span><span class="ident" id="1367168">w</span><span class="op" id="1367169">,</span>&nbsp;<span class="ident" id="1367171">sendContent</span><span class="op" id="1367182">,</span>&nbsp;<span class="ident" id="1367184">sendSize</span><span class="op" id="1367192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1367195">}</span><br>
<span class="lineno"></span><span class="op" id="1367197">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="1367200">//&nbsp;modtime&nbsp;is&nbsp;the&nbsp;modification&nbsp;time&nbsp;of&nbsp;the&nbsp;resource&nbsp;to&nbsp;be&nbsp;served,&nbsp;or&nbsp;IsZero().</span><br>
<span class="lineno"></span><span class="comment" id="1367279">//&nbsp;return&nbsp;value&nbsp;is&nbsp;whether&nbsp;this&nbsp;request&nbsp;is&nbsp;now&nbsp;complete.</span><br>
<span class="lineno"></span><span class="keyword" id="1367336">func</span>&nbsp;<span class="ident" id="1367341">checkLastModified</span><span class="op" id="1367358">(</span><span class="ident" id="1367359">w</span>&nbsp;<span class="ident" id="1367361">ResponseWriter</span><span class="op" id="1367375">,</span>&nbsp;<span class="ident" id="1367377">r</span>&nbsp;<span class="op" id="1367379">*</span><span class="ident" id="1367380">Request</span><span class="op" id="1367387">,</span>&nbsp;<span class="ident" id="1367389">modtime</span>&nbsp;<span class="ident" id="1367397">time</span><span class="op" id="1367401">.</span><span class="ident" id="1367402">Time</span><span class="op" id="1367406">)</span>&nbsp;<span class="builtintype" id="1367408">bool</span>&nbsp;<span class="op" id="1367413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1367416">if</span>&nbsp;<span class="ident" id="1367419">modtime</span><span class="op" id="1367426">.</span><span class="ident" id="1367427">IsZero</span><span class="op" id="1367433">(</span><span class="op" id="1367434">)</span>&nbsp;<span class="op" id="1367436">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1367440">return</span>&nbsp;<span class="builtintype" id="1367447">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1367454">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1367458">//&nbsp;The&nbsp;Date-Modified&nbsp;header&nbsp;truncates&nbsp;sub-second&nbsp;precision,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1367522">//&nbsp;use&nbsp;mtime&nbsp;&lt;&nbsp;t+1s&nbsp;instead&nbsp;of&nbsp;mtime&nbsp;&lt;=&nbsp;t&nbsp;to&nbsp;check&nbsp;for&nbsp;unmodified.</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1367590">if</span>&nbsp;<span class="ident" id="1367593">t</span><span class="op" id="1367594">,</span>&nbsp;<span class="ident" id="1367596">err</span>&nbsp;<span class="op" id="1367600">:=</span>&nbsp;<span class="ident" id="1367603">time</span><span class="op" id="1367607">.</span><span class="ident" id="1367608">Parse</span><span class="op" id="1367613">(</span><span class="ident" id="1367614">TimeFormat</span><span class="op" id="1367624">,</span>&nbsp;<span class="ident" id="1367626">r</span><span class="op" id="1367627">.</span><span class="ident" id="1367628">Header</span><span class="op" id="1367634">.</span><span class="ident" id="1367635">Get</span><span class="op" id="1367638">(</span><span class="string" id="1367639">&#34;If-Modified-Since&#34;</span><span class="op" id="1367658">)</span><span class="op" id="1367659">)</span><span class="op" id="1367660">;</span>&nbsp;<span class="ident" id="1367662">err</span>&nbsp;<span class="op" id="1367666">==</span>&nbsp;<span class="ident" id="1367669">nil</span>&nbsp;<span class="op" id="1367673">&amp;&amp;</span>&nbsp;<span class="ident" id="1367676">modtime</span><span class="op" id="1367683">.</span><span class="ident" id="1367684">Before</span><span class="op" id="1367690">(</span><span class="ident" id="1367691">t</span><span class="op" id="1367692">.</span><span class="ident" id="1367693">Add</span><span class="op" id="1367696">(</span><span class="num" id="1367697">1</span><span class="op" id="1367698">*</span><span class="ident" id="1367699">time</span><span class="op" id="1367703">.</span><span class="ident" id="1367704">Second</span><span class="op" id="1367710">)</span><span class="op" id="1367711">)</span>&nbsp;<span class="op" id="1367713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1367717">h</span>&nbsp;<span class="op" id="1367719">:=</span>&nbsp;<span class="ident" id="1367722">w</span><span class="op" id="1367723">.</span><span class="ident" id="1367724">Header</span><span class="op" id="1367730">(</span><span class="op" id="1367731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1367735">delete</span><span class="op" id="1367741">(</span><span class="ident" id="1367742">h</span><span class="op" id="1367743">,</span>&nbsp;<span class="string" id="1367745">&#34;Content-Type&#34;</span><span class="op" id="1367759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1367763">delete</span><span class="op" id="1367769">(</span><span class="ident" id="1367770">h</span><span class="op" id="1367771">,</span>&nbsp;<span class="string" id="1367773">&#34;Content-Length&#34;</span><span class="op" id="1367789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1367793">w</span><span class="op" id="1367794">.</span><span class="ident" id="1367795">WriteHeader</span><span class="op" id="1367806">(</span><span class="ident" id="1367807">StatusNotModified</span><span class="op" id="1367824">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1367828">return</span>&nbsp;<span class="builtintype" id="1367835">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1367841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1367844">w</span><span class="op" id="1367845">.</span><span class="ident" id="1367846">Header</span><span class="op" id="1367852">(</span><span class="op" id="1367853">)</span><span class="op" id="1367854">.</span><span class="ident" id="1367855">Set</span><span class="op" id="1367858">(</span><span class="string" id="1367859">&#34;Last-Modified&#34;</span><span class="op" id="1367874">,</span>&nbsp;<span class="ident" id="1367876">modtime</span><span class="op" id="1367883">.</span><span class="ident" id="1367884">UTC</span><span class="op" id="1367887">(</span><span class="op" id="1367888">)</span><span class="op" id="1367889">.</span><span class="ident" id="1367890">Format</span><span class="op" id="1367896">(</span><span class="ident" id="1367897">TimeFormat</span><span class="op" id="1367907">)</span><span class="op" id="1367908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1367911">return</span>&nbsp;<span class="builtintype" id="1367918">false</span><br>
<span class="lineno"></span><span class="op" id="1367924">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="1367927">//&nbsp;checkETag&nbsp;implements&nbsp;If-None-Match&nbsp;and&nbsp;If-Range&nbsp;checks.</span><br>
<span class="lineno"></span><span class="comment" id="1367986">//</span><br>
<span class="lineno"></span><span class="comment" id="1367989">//&nbsp;The&nbsp;ETag&nbsp;or&nbsp;modtime&nbsp;must&nbsp;have&nbsp;been&nbsp;previously&nbsp;set&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1368049">//&nbsp;ResponseWriter&#39;s&nbsp;headers.&nbsp;&nbsp;The&nbsp;modtime&nbsp;is&nbsp;only&nbsp;compared&nbsp;at&nbsp;second</span><br>
<span class="lineno">285</span><span class="comment" id="1368118">//&nbsp;granularity&nbsp;and&nbsp;may&nbsp;be&nbsp;the&nbsp;zero&nbsp;value&nbsp;to&nbsp;mean&nbsp;unknown.</span><br>
<span class="lineno"></span><span class="comment" id="1368176">//</span><br>
<span class="lineno"></span><span class="comment" id="1368179">//&nbsp;The&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;effective&nbsp;request&nbsp;&#34;Range&#34;&nbsp;header&nbsp;to&nbsp;use&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1368250">//&nbsp;whether&nbsp;this&nbsp;request&nbsp;is&nbsp;now&nbsp;considered&nbsp;done.</span><br>
<span class="lineno"></span><span class="keyword" id="1368298">func</span>&nbsp;<span class="ident" id="1368303">checkETag</span><span class="op" id="1368312">(</span><span class="ident" id="1368313">w</span>&nbsp;<span class="ident" id="1368315">ResponseWriter</span><span class="op" id="1368329">,</span>&nbsp;<span class="ident" id="1368331">r</span>&nbsp;<span class="op" id="1368333">*</span><span class="ident" id="1368334">Request</span><span class="op" id="1368341">,</span>&nbsp;<span class="ident" id="1368343">modtime</span>&nbsp;<span class="ident" id="1368351">time</span><span class="op" id="1368355">.</span><span class="ident" id="1368356">Time</span><span class="op" id="1368360">)</span>&nbsp;<span class="op" id="1368362">(</span><span class="ident" id="1368363">rangeReq</span>&nbsp;<span class="builtintype" id="1368372">string</span><span class="op" id="1368378">,</span>&nbsp;<span class="ident" id="1368380">done</span>&nbsp;<span class="builtintype" id="1368385">bool</span><span class="op" id="1368389">)</span>&nbsp;<span class="op" id="1368391">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1368394">etag</span>&nbsp;<span class="op" id="1368399">:=</span>&nbsp;<span class="ident" id="1368402">w</span><span class="op" id="1368403">.</span><span class="ident" id="1368404">Header</span><span class="op" id="1368410">(</span><span class="op" id="1368411">)</span><span class="op" id="1368412">.</span><span class="ident" id="1368413">get</span><span class="op" id="1368416">(</span><span class="string" id="1368417">&#34;Etag&#34;</span><span class="op" id="1368423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1368426">rangeReq</span>&nbsp;<span class="op" id="1368435">=</span>&nbsp;<span class="ident" id="1368437">r</span><span class="op" id="1368438">.</span><span class="ident" id="1368439">Header</span><span class="op" id="1368445">.</span><span class="ident" id="1368446">get</span><span class="op" id="1368449">(</span><span class="string" id="1368450">&#34;Range&#34;</span><span class="op" id="1368457">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1368461">//&nbsp;Invalidate&nbsp;the&nbsp;range&nbsp;request&nbsp;if&nbsp;the&nbsp;entity&nbsp;doesn&#39;t&nbsp;match&nbsp;the&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1368530">//&nbsp;the&nbsp;client&nbsp;was&nbsp;expecting.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1368560">//&nbsp;&#34;If-Range:&nbsp;version&#34;&nbsp;means&nbsp;&#34;ignore&nbsp;the&nbsp;Range:&nbsp;header&nbsp;unless&nbsp;version&nbsp;matches&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1368643">//&nbsp;current&nbsp;file.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1368662">//&nbsp;We&nbsp;only&nbsp;support&nbsp;ETag&nbsp;versions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1368697">//&nbsp;The&nbsp;caller&nbsp;must&nbsp;have&nbsp;set&nbsp;the&nbsp;ETag&nbsp;on&nbsp;the&nbsp;response&nbsp;already.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1368760">if</span>&nbsp;<span class="ident" id="1368763">ir</span>&nbsp;<span class="op" id="1368766">:=</span>&nbsp;<span class="ident" id="1368769">r</span><span class="op" id="1368770">.</span><span class="ident" id="1368771">Header</span><span class="op" id="1368777">.</span><span class="ident" id="1368778">get</span><span class="op" id="1368781">(</span><span class="string" id="1368782">&#34;If-Range&#34;</span><span class="op" id="1368792">)</span><span class="op" id="1368793">;</span>&nbsp;<span class="ident" id="1368795">ir</span>&nbsp;<span class="op" id="1368798">!=</span>&nbsp;<span class="string" id="1368801">&#34;&#34;</span>&nbsp;<span class="op" id="1368804">&amp;&amp;</span>&nbsp;<span class="ident" id="1368807">ir</span>&nbsp;<span class="op" id="1368810">!=</span>&nbsp;<span class="ident" id="1368813">etag</span>&nbsp;<span class="op" id="1368818">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1368822">//&nbsp;The&nbsp;If-Range&nbsp;value&nbsp;is&nbsp;typically&nbsp;the&nbsp;ETag&nbsp;value,&nbsp;but&nbsp;it&nbsp;may&nbsp;also&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1368894">//&nbsp;the&nbsp;modtime&nbsp;date.&nbsp;See&nbsp;golang.org/issue/8367.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1368944">timeMatches</span>&nbsp;<span class="op" id="1368956">:=</span>&nbsp;<span class="builtintype" id="1368959">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1368967">if</span>&nbsp;<span class="op" id="1368970">!</span><span class="ident" id="1368971">modtime</span><span class="op" id="1368978">.</span><span class="ident" id="1368979">IsZero</span><span class="op" id="1368985">(</span><span class="op" id="1368986">)</span>&nbsp;<span class="op" id="1368988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1368993">if</span>&nbsp;<span class="ident" id="1368996">t</span><span class="op" id="1368997">,</span>&nbsp;<span class="ident" id="1368999">err</span>&nbsp;<span class="op" id="1369003">:=</span>&nbsp;<span class="ident" id="1369006">ParseTime</span><span class="op" id="1369015">(</span><span class="ident" id="1369016">ir</span><span class="op" id="1369018">)</span><span class="op" id="1369019">;</span>&nbsp;<span class="ident" id="1369021">err</span>&nbsp;<span class="op" id="1369025">==</span>&nbsp;<span class="ident" id="1369028">nil</span>&nbsp;<span class="op" id="1369032">&amp;&amp;</span>&nbsp;<span class="ident" id="1369035">t</span><span class="op" id="1369036">.</span><span class="ident" id="1369037">Unix</span><span class="op" id="1369041">(</span><span class="op" id="1369042">)</span>&nbsp;<span class="op" id="1369044">==</span>&nbsp;<span class="ident" id="1369047">modtime</span><span class="op" id="1369054">.</span><span class="ident" id="1369055">Unix</span><span class="op" id="1369059">(</span><span class="op" id="1369060">)</span>&nbsp;<span class="op" id="1369062">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1369068">timeMatches</span>&nbsp;<span class="op" id="1369080">=</span>&nbsp;<span class="builtintype" id="1369082">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1369090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1369094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1369098">if</span>&nbsp;<span class="op" id="1369101">!</span><span class="ident" id="1369102">timeMatches</span>&nbsp;<span class="op" id="1369114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1369119">rangeReq</span>&nbsp;<span class="op" id="1369128">=</span>&nbsp;<span class="string" id="1369130">&#34;&#34;</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1369135">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1369138">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1369142">if</span>&nbsp;<span class="ident" id="1369145">inm</span>&nbsp;<span class="op" id="1369149">:=</span>&nbsp;<span class="ident" id="1369152">r</span><span class="op" id="1369153">.</span><span class="ident" id="1369154">Header</span><span class="op" id="1369160">.</span><span class="ident" id="1369161">get</span><span class="op" id="1369164">(</span><span class="string" id="1369165">&#34;If-None-Match&#34;</span><span class="op" id="1369180">)</span><span class="op" id="1369181">;</span>&nbsp;<span class="ident" id="1369183">inm</span>&nbsp;<span class="op" id="1369187">!=</span>&nbsp;<span class="string" id="1369190">&#34;&#34;</span>&nbsp;<span class="op" id="1369193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1369197">//&nbsp;Must&nbsp;know&nbsp;ETag.</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1369218">if</span>&nbsp;<span class="ident" id="1369221">etag</span>&nbsp;<span class="op" id="1369226">==</span>&nbsp;<span class="string" id="1369229">&#34;&#34;</span>&nbsp;<span class="op" id="1369232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1369237">return</span>&nbsp;<span class="ident" id="1369244">rangeReq</span><span class="op" id="1369252">,</span>&nbsp;<span class="builtintype" id="1369254">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1369262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1369267">//&nbsp;TODO(bradfitz):&nbsp;non-GET/HEAD&nbsp;requests&nbsp;require&nbsp;more&nbsp;work:</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1369329">//&nbsp;sending&nbsp;a&nbsp;different&nbsp;status&nbsp;code&nbsp;on&nbsp;matches,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1369382">//&nbsp;also&nbsp;can&#39;t&nbsp;use&nbsp;weak&nbsp;cache&nbsp;validators&nbsp;(those&nbsp;with&nbsp;a&nbsp;&#34;W/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1369442">//&nbsp;prefix).&nbsp;&nbsp;But&nbsp;most&nbsp;users&nbsp;of&nbsp;ServeContent&nbsp;will&nbsp;be&nbsp;using</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1369502">//&nbsp;it&nbsp;on&nbsp;GET&nbsp;or&nbsp;HEAD,&nbsp;so&nbsp;only&nbsp;support&nbsp;those&nbsp;for&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1369557">if</span>&nbsp;<span class="ident" id="1369560">r</span><span class="op" id="1369561">.</span><span class="ident" id="1369562">Method</span>&nbsp;<span class="op" id="1369569">!=</span>&nbsp;<span class="string" id="1369572">&#34;GET&#34;</span>&nbsp;<span class="op" id="1369578">&amp;&amp;</span>&nbsp;<span class="ident" id="1369581">r</span><span class="op" id="1369582">.</span><span class="ident" id="1369583">Method</span>&nbsp;<span class="op" id="1369590">!=</span>&nbsp;<span class="string" id="1369593">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="1369600">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1369605">return</span>&nbsp;<span class="ident" id="1369612">rangeReq</span><span class="op" id="1369620">,</span>&nbsp;<span class="builtintype" id="1369622">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1369630">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1369635">//&nbsp;TODO(bradfitz):&nbsp;deal&nbsp;with&nbsp;comma-separated&nbsp;or&nbsp;multiple-valued</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1369701">//&nbsp;list&nbsp;of&nbsp;If-None-match&nbsp;values.&nbsp;&nbsp;For&nbsp;now&nbsp;just&nbsp;handle&nbsp;the&nbsp;common</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1369768">//&nbsp;case&nbsp;of&nbsp;a&nbsp;single&nbsp;item.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1369796">if</span>&nbsp;<span class="ident" id="1369799">inm</span>&nbsp;<span class="op" id="1369803">==</span>&nbsp;<span class="ident" id="1369806">etag</span>&nbsp;<span class="op" id="1369811">||</span>&nbsp;<span class="ident" id="1369814">inm</span>&nbsp;<span class="op" id="1369818">==</span>&nbsp;<span class="string" id="1369821">&#34;*&#34;</span>&nbsp;<span class="op" id="1369825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1369830">h</span>&nbsp;<span class="op" id="1369832">:=</span>&nbsp;<span class="ident" id="1369835">w</span><span class="op" id="1369836">.</span><span class="ident" id="1369837">Header</span><span class="op" id="1369843">(</span><span class="op" id="1369844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1369849">delete</span><span class="op" id="1369855">(</span><span class="ident" id="1369856">h</span><span class="op" id="1369857">,</span>&nbsp;<span class="string" id="1369859">&#34;Content-Type&#34;</span><span class="op" id="1369873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1369878">delete</span><span class="op" id="1369884">(</span><span class="ident" id="1369885">h</span><span class="op" id="1369886">,</span>&nbsp;<span class="string" id="1369888">&#34;Content-Length&#34;</span><span class="op" id="1369904">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1369909">w</span><span class="op" id="1369910">.</span><span class="ident" id="1369911">WriteHeader</span><span class="op" id="1369922">(</span><span class="ident" id="1369923">StatusNotModified</span><span class="op" id="1369940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1369945">return</span>&nbsp;<span class="string" id="1369952">&#34;&#34;</span><span class="op" id="1369954">,</span>&nbsp;<span class="builtintype" id="1369956">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1369963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1369966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1369969">return</span>&nbsp;<span class="ident" id="1369976">rangeReq</span><span class="op" id="1369984">,</span>&nbsp;<span class="builtintype" id="1369986">false</span><br>
<span class="lineno">340</span><span class="op" id="1369992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1369995">//&nbsp;name&nbsp;is&nbsp;&#39;/&#39;-separated,&nbsp;not&nbsp;filepath.Separator.</span><br>
<span class="lineno"></span><span class="keyword" id="1370045">func</span>&nbsp;<span class="ident" id="1370050">serveFile</span><span class="op" id="1370059">(</span><span class="ident" id="1370060">w</span>&nbsp;<span class="ident" id="1370062">ResponseWriter</span><span class="op" id="1370076">,</span>&nbsp;<span class="ident" id="1370078">r</span>&nbsp;<span class="op" id="1370080">*</span><span class="ident" id="1370081">Request</span><span class="op" id="1370088">,</span>&nbsp;<span class="ident" id="1370090">fs</span>&nbsp;<span class="ident" id="1370093">FileSystem</span><span class="op" id="1370103">,</span>&nbsp;<span class="ident" id="1370105">name</span>&nbsp;<span class="builtintype" id="1370110">string</span><span class="op" id="1370116">,</span>&nbsp;<span class="ident" id="1370118">redirect</span>&nbsp;<span class="builtintype" id="1370127">bool</span><span class="op" id="1370131">)</span>&nbsp;<span class="op" id="1370133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1370136">const</span>&nbsp;<span class="ident" id="1370142">indexPage</span>&nbsp;<span class="op" id="1370152">=</span>&nbsp;<span class="string" id="1370154">&#34;/index.html&#34;</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1370170">//&nbsp;redirect&nbsp;.../index.html&nbsp;to&nbsp;.../</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1370206">//&nbsp;can&#39;t&nbsp;use&nbsp;Redirect()&nbsp;because&nbsp;that&nbsp;would&nbsp;make&nbsp;the&nbsp;path&nbsp;absolute,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1370274">//&nbsp;which&nbsp;would&nbsp;be&nbsp;a&nbsp;problem&nbsp;running&nbsp;under&nbsp;StripPrefix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1370329">if</span>&nbsp;<span class="ident" id="1370332">strings</span><span class="op" id="1370339">.</span><span class="ident" id="1370340">HasSuffix</span><span class="op" id="1370349">(</span><span class="ident" id="1370350">r</span><span class="op" id="1370351">.</span><span class="ident" id="1370352">URL</span><span class="op" id="1370355">.</span><span class="ident" id="1370356">Path</span><span class="op" id="1370360">,</span>&nbsp;<span class="ident" id="1370362">indexPage</span><span class="op" id="1370371">)</span>&nbsp;<span class="op" id="1370373">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370377">localRedirect</span><span class="op" id="1370390">(</span><span class="ident" id="1370391">w</span><span class="op" id="1370392">,</span>&nbsp;<span class="ident" id="1370394">r</span><span class="op" id="1370395">,</span>&nbsp;<span class="string" id="1370397">&#34;./&#34;</span><span class="op" id="1370401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1370405">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1370413">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370417">f</span><span class="op" id="1370418">,</span>&nbsp;<span class="ident" id="1370420">err</span>&nbsp;<span class="op" id="1370424">:=</span>&nbsp;<span class="ident" id="1370427">fs</span><span class="op" id="1370429">.</span><span class="ident" id="1370430">Open</span><span class="op" id="1370434">(</span><span class="ident" id="1370435">name</span><span class="op" id="1370439">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1370442">if</span>&nbsp;<span class="ident" id="1370445">err</span>&nbsp;<span class="op" id="1370449">!=</span>&nbsp;<span class="ident" id="1370452">nil</span>&nbsp;<span class="op" id="1370456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1370460">//&nbsp;TODO&nbsp;expose&nbsp;actual&nbsp;error?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370491">NotFound</span><span class="op" id="1370499">(</span><span class="ident" id="1370500">w</span><span class="op" id="1370501">,</span>&nbsp;<span class="ident" id="1370503">r</span><span class="op" id="1370504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1370508">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1370516">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1370519">defer</span>&nbsp;<span class="ident" id="1370525">f</span><span class="op" id="1370526">.</span><span class="ident" id="1370527">Close</span><span class="op" id="1370532">(</span><span class="op" id="1370533">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370537">d</span><span class="op" id="1370538">,</span>&nbsp;<span class="ident" id="1370540">err1</span>&nbsp;<span class="op" id="1370545">:=</span>&nbsp;<span class="ident" id="1370548">f</span><span class="op" id="1370549">.</span><span class="ident" id="1370550">Stat</span><span class="op" id="1370554">(</span><span class="op" id="1370555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1370558">if</span>&nbsp;<span class="ident" id="1370561">err1</span>&nbsp;<span class="op" id="1370566">!=</span>&nbsp;<span class="ident" id="1370569">nil</span>&nbsp;<span class="op" id="1370573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1370577">//&nbsp;TODO&nbsp;expose&nbsp;actual&nbsp;error?</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370608">NotFound</span><span class="op" id="1370616">(</span><span class="ident" id="1370617">w</span><span class="op" id="1370618">,</span>&nbsp;<span class="ident" id="1370620">r</span><span class="op" id="1370621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1370625">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1370633">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1370637">if</span>&nbsp;<span class="ident" id="1370640">redirect</span>&nbsp;<span class="op" id="1370649">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1370653">//&nbsp;redirect&nbsp;to&nbsp;canonical&nbsp;path:&nbsp;/&nbsp;at&nbsp;end&nbsp;of&nbsp;directory&nbsp;url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1370712">//&nbsp;r.URL.Path&nbsp;always&nbsp;begins&nbsp;with&nbsp;/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370749">url</span>&nbsp;<span class="op" id="1370753">:=</span>&nbsp;<span class="ident" id="1370756">r</span><span class="op" id="1370757">.</span><span class="ident" id="1370758">URL</span><span class="op" id="1370761">.</span><span class="ident" id="1370762">Path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1370769">if</span>&nbsp;<span class="ident" id="1370772">d</span><span class="op" id="1370773">.</span><span class="ident" id="1370774">IsDir</span><span class="op" id="1370779">(</span><span class="op" id="1370780">)</span>&nbsp;<span class="op" id="1370782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1370787">if</span>&nbsp;<span class="ident" id="1370790">url</span><span class="op" id="1370793">[</span><span class="builtinfunc" id="1370794">len</span><span class="op" id="1370797">(</span><span class="ident" id="1370798">url</span><span class="op" id="1370801">)</span><span class="op" id="1370802">-</span><span class="num" id="1370803">1</span><span class="op" id="1370804">]</span>&nbsp;<span class="op" id="1370806">!=</span>&nbsp;<span class="string" id="1370809">&#39;/&#39;</span>&nbsp;<span class="op" id="1370813">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370819">localRedirect</span><span class="op" id="1370832">(</span><span class="ident" id="1370833">w</span><span class="op" id="1370834">,</span>&nbsp;<span class="ident" id="1370836">r</span><span class="op" id="1370837">,</span>&nbsp;<span class="ident" id="1370839">path</span><span class="op" id="1370843">.</span><span class="ident" id="1370844">Base</span><span class="op" id="1370848">(</span><span class="ident" id="1370849">url</span><span class="op" id="1370852">)</span><span class="op" id="1370853">+</span><span class="string" id="1370854">&#34;/&#34;</span><span class="op" id="1370857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1370863">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1370873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1370877">}</span>&nbsp;<span class="keyword" id="1370879">else</span>&nbsp;<span class="op" id="1370884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1370889">if</span>&nbsp;<span class="ident" id="1370892">url</span><span class="op" id="1370895">[</span><span class="builtinfunc" id="1370896">len</span><span class="op" id="1370899">(</span><span class="ident" id="1370900">url</span><span class="op" id="1370903">)</span><span class="op" id="1370904">-</span><span class="num" id="1370905">1</span><span class="op" id="1370906">]</span>&nbsp;<span class="op" id="1370908">==</span>&nbsp;<span class="string" id="1370911">&#39;/&#39;</span>&nbsp;<span class="op" id="1370915">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370921">localRedirect</span><span class="op" id="1370934">(</span><span class="ident" id="1370935">w</span><span class="op" id="1370936">,</span>&nbsp;<span class="ident" id="1370938">r</span><span class="op" id="1370939">,</span>&nbsp;<span class="string" id="1370941">&#34;../&#34;</span><span class="op" id="1370946">+</span><span class="ident" id="1370947">path</span><span class="op" id="1370951">.</span><span class="ident" id="1370952">Base</span><span class="op" id="1370956">(</span><span class="ident" id="1370957">url</span><span class="op" id="1370960">)</span><span class="op" id="1370961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1370967">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1370977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1370981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1370984">}</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1370988">//&nbsp;use&nbsp;contents&nbsp;of&nbsp;index.html&nbsp;for&nbsp;directory,&nbsp;if&nbsp;present</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371045">if</span>&nbsp;<span class="ident" id="1371048">d</span><span class="op" id="1371049">.</span><span class="ident" id="1371050">IsDir</span><span class="op" id="1371055">(</span><span class="op" id="1371056">)</span>&nbsp;<span class="op" id="1371058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371062">index</span>&nbsp;<span class="op" id="1371068">:=</span>&nbsp;<span class="ident" id="1371071">strings</span><span class="op" id="1371078">.</span><span class="ident" id="1371079">TrimSuffix</span><span class="op" id="1371089">(</span><span class="ident" id="1371090">name</span><span class="op" id="1371094">,</span>&nbsp;<span class="string" id="1371096">&#34;/&#34;</span><span class="op" id="1371099">)</span>&nbsp;<span class="op" id="1371101">+</span>&nbsp;<span class="ident" id="1371103">indexPage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371115">ff</span><span class="op" id="1371117">,</span>&nbsp;<span class="ident" id="1371119">err</span>&nbsp;<span class="op" id="1371123">:=</span>&nbsp;<span class="ident" id="1371126">fs</span><span class="op" id="1371128">.</span><span class="ident" id="1371129">Open</span><span class="op" id="1371133">(</span><span class="ident" id="1371134">index</span><span class="op" id="1371139">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371143">if</span>&nbsp;<span class="ident" id="1371146">err</span>&nbsp;<span class="op" id="1371150">==</span>&nbsp;<span class="ident" id="1371153">nil</span>&nbsp;<span class="op" id="1371157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371162">defer</span>&nbsp;<span class="ident" id="1371168">ff</span><span class="op" id="1371170">.</span><span class="ident" id="1371171">Close</span><span class="op" id="1371176">(</span><span class="op" id="1371177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371182">dd</span><span class="op" id="1371184">,</span>&nbsp;<span class="ident" id="1371186">err</span>&nbsp;<span class="op" id="1371190">:=</span>&nbsp;<span class="ident" id="1371193">ff</span><span class="op" id="1371195">.</span><span class="ident" id="1371196">Stat</span><span class="op" id="1371200">(</span><span class="op" id="1371201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371206">if</span>&nbsp;<span class="ident" id="1371209">err</span>&nbsp;<span class="op" id="1371213">==</span>&nbsp;<span class="ident" id="1371216">nil</span>&nbsp;<span class="op" id="1371220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371226">name</span>&nbsp;<span class="op" id="1371231">=</span>&nbsp;<span class="ident" id="1371233">index</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371243">d</span>&nbsp;<span class="op" id="1371245">=</span>&nbsp;<span class="ident" id="1371247">dd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371254">f</span>&nbsp;<span class="op" id="1371256">=</span>&nbsp;<span class="ident" id="1371258">ff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1371264">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1371268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1371271">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1371275">//&nbsp;Still&nbsp;a&nbsp;directory?&nbsp;(we&nbsp;didn&#39;t&nbsp;find&nbsp;an&nbsp;index.html&nbsp;file)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371334">if</span>&nbsp;<span class="ident" id="1371337">d</span><span class="op" id="1371338">.</span><span class="ident" id="1371339">IsDir</span><span class="op" id="1371344">(</span><span class="op" id="1371345">)</span>&nbsp;<span class="op" id="1371347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371351">if</span>&nbsp;<span class="ident" id="1371354">checkLastModified</span><span class="op" id="1371371">(</span><span class="ident" id="1371372">w</span><span class="op" id="1371373">,</span>&nbsp;<span class="ident" id="1371375">r</span><span class="op" id="1371376">,</span>&nbsp;<span class="ident" id="1371378">d</span><span class="op" id="1371379">.</span><span class="ident" id="1371380">ModTime</span><span class="op" id="1371387">(</span><span class="op" id="1371388">)</span><span class="op" id="1371389">)</span>&nbsp;<span class="op" id="1371391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371396">return</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1371405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371409">dirList</span><span class="op" id="1371416">(</span><span class="ident" id="1371417">w</span><span class="op" id="1371418">,</span>&nbsp;<span class="ident" id="1371420">f</span><span class="op" id="1371421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371425">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1371433">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1371437">//&nbsp;serveContent&nbsp;will&nbsp;check&nbsp;modification&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371483">sizeFunc</span>&nbsp;<span class="op" id="1371492">:=</span>&nbsp;<span class="keyword" id="1371495">func</span><span class="op" id="1371499">(</span><span class="op" id="1371500">)</span>&nbsp;<span class="op" id="1371502">(</span><span class="ident" id="1371503">int64</span><span class="op" id="1371508">,</span>&nbsp;<span class="builtintype" id="1371510">error</span><span class="op" id="1371515">)</span>&nbsp;<span class="op" id="1371517">{</span>&nbsp;<span class="keyword" id="1371519">return</span>&nbsp;<span class="ident" id="1371526">d</span><span class="op" id="1371527">.</span><span class="ident" id="1371528">Size</span><span class="op" id="1371532">(</span><span class="op" id="1371533">)</span><span class="op" id="1371534">,</span>&nbsp;<span class="ident" id="1371536">nil</span>&nbsp;<span class="op" id="1371540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371543">serveContent</span><span class="op" id="1371555">(</span><span class="ident" id="1371556">w</span><span class="op" id="1371557">,</span>&nbsp;<span class="ident" id="1371559">r</span><span class="op" id="1371560">,</span>&nbsp;<span class="ident" id="1371562">d</span><span class="op" id="1371563">.</span><span class="ident" id="1371564">Name</span><span class="op" id="1371568">(</span><span class="op" id="1371569">)</span><span class="op" id="1371570">,</span>&nbsp;<span class="ident" id="1371572">d</span><span class="op" id="1371573">.</span><span class="ident" id="1371574">ModTime</span><span class="op" id="1371581">(</span><span class="op" id="1371582">)</span><span class="op" id="1371583">,</span>&nbsp;<span class="ident" id="1371585">sizeFunc</span><span class="op" id="1371593">,</span>&nbsp;<span class="ident" id="1371595">f</span><span class="op" id="1371596">)</span><br>
<span class="lineno"></span><span class="op" id="1371598">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="1371601">//&nbsp;localRedirect&nbsp;gives&nbsp;a&nbsp;Moved&nbsp;Permanently&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="1371654">//&nbsp;It&nbsp;does&nbsp;not&nbsp;convert&nbsp;relative&nbsp;paths&nbsp;to&nbsp;absolute&nbsp;paths&nbsp;like&nbsp;Redirect&nbsp;does.</span><br>
<span class="lineno"></span><span class="keyword" id="1371730">func</span>&nbsp;<span class="ident" id="1371735">localRedirect</span><span class="op" id="1371748">(</span><span class="ident" id="1371749">w</span>&nbsp;<span class="ident" id="1371751">ResponseWriter</span><span class="op" id="1371765">,</span>&nbsp;<span class="ident" id="1371767">r</span>&nbsp;<span class="op" id="1371769">*</span><span class="ident" id="1371770">Request</span><span class="op" id="1371777">,</span>&nbsp;<span class="ident" id="1371779">newPath</span>&nbsp;<span class="builtintype" id="1371787">string</span><span class="op" id="1371793">)</span>&nbsp;<span class="op" id="1371795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371798">if</span>&nbsp;<span class="ident" id="1371801">q</span>&nbsp;<span class="op" id="1371803">:=</span>&nbsp;<span class="ident" id="1371806">r</span><span class="op" id="1371807">.</span><span class="ident" id="1371808">URL</span><span class="op" id="1371811">.</span><span class="ident" id="1371812">RawQuery</span><span class="op" id="1371820">;</span>&nbsp;<span class="ident" id="1371822">q</span>&nbsp;<span class="op" id="1371824">!=</span>&nbsp;<span class="string" id="1371827">&#34;&#34;</span>&nbsp;<span class="op" id="1371830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371834">newPath</span>&nbsp;<span class="op" id="1371842">+=</span>&nbsp;<span class="string" id="1371845">&#34;?&#34;</span>&nbsp;<span class="op" id="1371849">+</span>&nbsp;<span class="ident" id="1371851">q</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1371854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371857">w</span><span class="op" id="1371858">.</span><span class="ident" id="1371859">Header</span><span class="op" id="1371865">(</span><span class="op" id="1371866">)</span><span class="op" id="1371867">.</span><span class="ident" id="1371868">Set</span><span class="op" id="1371871">(</span><span class="string" id="1371872">&#34;Location&#34;</span><span class="op" id="1371882">,</span>&nbsp;<span class="ident" id="1371884">newPath</span><span class="op" id="1371891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371894">w</span><span class="op" id="1371895">.</span><span class="ident" id="1371896">WriteHeader</span><span class="op" id="1371907">(</span><span class="ident" id="1371908">StatusMovedPermanently</span><span class="op" id="1371930">)</span><br>
<span class="lineno"></span><span class="op" id="1371932">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">425</span><span class="comment" id="1371935">//&nbsp;ServeFile&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;named&nbsp;file&nbsp;or&nbsp;directory.</span><br>
<span class="lineno"></span><span class="keyword" id="1372021">func</span>&nbsp;<span class="ident" id="1372026">ServeFile</span><span class="op" id="1372035">(</span><span class="ident" id="1372036">w</span>&nbsp;<span class="ident" id="1372038">ResponseWriter</span><span class="op" id="1372052">,</span>&nbsp;<span class="ident" id="1372054">r</span>&nbsp;<span class="op" id="1372056">*</span><span class="ident" id="1372057">Request</span><span class="op" id="1372064">,</span>&nbsp;<span class="ident" id="1372066">name</span>&nbsp;<span class="builtintype" id="1372071">string</span><span class="op" id="1372077">)</span>&nbsp;<span class="op" id="1372079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372082">dir</span><span class="op" id="1372085">,</span>&nbsp;<span class="ident" id="1372087">file</span>&nbsp;<span class="op" id="1372092">:=</span>&nbsp;<span class="ident" id="1372095">filepath</span><span class="op" id="1372103">.</span><span class="ident" id="1372104">Split</span><span class="op" id="1372109">(</span><span class="ident" id="1372110">name</span><span class="op" id="1372114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372117">serveFile</span><span class="op" id="1372126">(</span><span class="ident" id="1372127">w</span><span class="op" id="1372128">,</span>&nbsp;<span class="ident" id="1372130">r</span><span class="op" id="1372131">,</span>&nbsp;<span class="ident" id="1372133">Dir</span><span class="op" id="1372136">(</span><span class="ident" id="1372137">dir</span><span class="op" id="1372140">)</span><span class="op" id="1372141">,</span>&nbsp;<span class="ident" id="1372143">file</span><span class="op" id="1372147">,</span>&nbsp;<span class="builtintype" id="1372149">false</span><span class="op" id="1372154">)</span><br>
<span class="lineno"></span><span class="op" id="1372156">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="1372159">type</span>&nbsp;<span class="ident" id="1372164">fileHandler</span>&nbsp;<span class="keyword" id="1372176">struct</span>&nbsp;<span class="op" id="1372183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372186">root</span>&nbsp;<span class="ident" id="1372191">FileSystem</span><br>
<span class="lineno"></span><span class="op" id="1372202">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="comment" id="1372205">//&nbsp;FileServer&nbsp;returns&nbsp;a&nbsp;handler&nbsp;that&nbsp;serves&nbsp;HTTP&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="1372263">//&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;file&nbsp;system&nbsp;rooted&nbsp;at&nbsp;root.</span><br>
<span class="lineno"></span><span class="comment" id="1372319">//</span><br>
<span class="lineno"></span><span class="comment" id="1372322">//&nbsp;To&nbsp;use&nbsp;the&nbsp;operating&nbsp;system&#39;s&nbsp;file&nbsp;system&nbsp;implementation,</span><br>
<span class="lineno"></span><span class="comment" id="1372383">//&nbsp;use&nbsp;http.Dir:</span><br>
<span class="lineno">440</span><span class="comment" id="1372400">//</span><br>
<span class="lineno"></span><span class="comment" id="1372403">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http.Handle(&#34;/&#34;,&nbsp;http.FileServer(http.Dir(&#34;/tmp&#34;)))</span><br>
<span class="lineno"></span><span class="keyword" id="1372462">func</span>&nbsp;<span class="ident" id="1372467">FileServer</span><span class="op" id="1372477">(</span><span class="ident" id="1372478">root</span>&nbsp;<span class="ident" id="1372483">FileSystem</span><span class="op" id="1372493">)</span>&nbsp;<span class="ident" id="1372495">Handler</span>&nbsp;<span class="op" id="1372503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1372506">return</span>&nbsp;<span class="op" id="1372513">&amp;</span><span class="ident" id="1372514">fileHandler</span><span class="op" id="1372525">{</span><span class="ident" id="1372526">root</span><span class="op" id="1372530">}</span><br>
<span class="lineno"></span><span class="op" id="1372532">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span><span class="keyword" id="1372535">func</span>&nbsp;<span class="op" id="1372540">(</span><span class="ident" id="1372541">f</span>&nbsp;<span class="op" id="1372543">*</span><span class="ident" id="1372544">fileHandler</span><span class="op" id="1372555">)</span>&nbsp;<span class="ident" id="1372557">ServeHTTP</span><span class="op" id="1372566">(</span><span class="ident" id="1372567">w</span>&nbsp;<span class="ident" id="1372569">ResponseWriter</span><span class="op" id="1372583">,</span>&nbsp;<span class="ident" id="1372585">r</span>&nbsp;<span class="op" id="1372587">*</span><span class="ident" id="1372588">Request</span><span class="op" id="1372595">)</span>&nbsp;<span class="op" id="1372597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372600">upath</span>&nbsp;<span class="op" id="1372606">:=</span>&nbsp;<span class="ident" id="1372609">r</span><span class="op" id="1372610">.</span><span class="ident" id="1372611">URL</span><span class="op" id="1372614">.</span><span class="ident" id="1372615">Path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1372621">if</span>&nbsp;<span class="op" id="1372624">!</span><span class="ident" id="1372625">strings</span><span class="op" id="1372632">.</span><span class="ident" id="1372633">HasPrefix</span><span class="op" id="1372642">(</span><span class="ident" id="1372643">upath</span><span class="op" id="1372648">,</span>&nbsp;<span class="string" id="1372650">&#34;/&#34;</span><span class="op" id="1372653">)</span>&nbsp;<span class="op" id="1372655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372659">upath</span>&nbsp;<span class="op" id="1372665">=</span>&nbsp;<span class="string" id="1372667">&#34;/&#34;</span>&nbsp;<span class="op" id="1372671">+</span>&nbsp;<span class="ident" id="1372673">upath</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372681">r</span><span class="op" id="1372682">.</span><span class="ident" id="1372683">URL</span><span class="op" id="1372686">.</span><span class="ident" id="1372687">Path</span>&nbsp;<span class="op" id="1372692">=</span>&nbsp;<span class="ident" id="1372694">upath</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1372701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372704">serveFile</span><span class="op" id="1372713">(</span><span class="ident" id="1372714">w</span><span class="op" id="1372715">,</span>&nbsp;<span class="ident" id="1372717">r</span><span class="op" id="1372718">,</span>&nbsp;<span class="ident" id="1372720">f</span><span class="op" id="1372721">.</span><span class="ident" id="1372722">root</span><span class="op" id="1372726">,</span>&nbsp;<span class="ident" id="1372728">path</span><span class="op" id="1372732">.</span><span class="ident" id="1372733">Clean</span><span class="op" id="1372738">(</span><span class="ident" id="1372739">upath</span><span class="op" id="1372744">)</span><span class="op" id="1372745">,</span>&nbsp;<span class="builtintype" id="1372747">true</span><span class="op" id="1372751">)</span><br>
<span class="lineno"></span><span class="op" id="1372753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="comment" id="1372756">//&nbsp;httpRange&nbsp;specifies&nbsp;the&nbsp;byte&nbsp;range&nbsp;to&nbsp;be&nbsp;sent&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="1372820">type</span>&nbsp;<span class="ident" id="1372825">httpRange</span>&nbsp;<span class="keyword" id="1372835">struct</span>&nbsp;<span class="op" id="1372842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372845">start</span><span class="op" id="1372850">,</span>&nbsp;<span class="ident" id="1372852">length</span>&nbsp;<span class="ident" id="1372859">int64</span><br>
<span class="lineno"></span><span class="op" id="1372865">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="keyword" id="1372868">func</span>&nbsp;<span class="op" id="1372873">(</span><span class="ident" id="1372874">r</span>&nbsp;<span class="ident" id="1372876">httpRange</span><span class="op" id="1372885">)</span>&nbsp;<span class="ident" id="1372887">contentRange</span><span class="op" id="1372899">(</span><span class="ident" id="1372900">size</span>&nbsp;<span class="ident" id="1372905">int64</span><span class="op" id="1372910">)</span>&nbsp;<span class="builtintype" id="1372912">string</span>&nbsp;<span class="op" id="1372919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1372922">return</span>&nbsp;<span class="ident" id="1372929">fmt</span><span class="op" id="1372932">.</span><span class="ident" id="1372933">Sprintf</span><span class="op" id="1372940">(</span><span class="string" id="1372941">&#34;bytes&nbsp;%d-%d/%d&#34;</span><span class="op" id="1372957">,</span>&nbsp;<span class="ident" id="1372959">r</span><span class="op" id="1372960">.</span><span class="ident" id="1372961">start</span><span class="op" id="1372966">,</span>&nbsp;<span class="ident" id="1372968">r</span><span class="op" id="1372969">.</span><span class="ident" id="1372970">start</span><span class="op" id="1372975">+</span><span class="ident" id="1372976">r</span><span class="op" id="1372977">.</span><span class="ident" id="1372978">length</span><span class="op" id="1372984">-</span><span class="num" id="1372985">1</span><span class="op" id="1372986">,</span>&nbsp;<span class="ident" id="1372988">size</span><span class="op" id="1372992">)</span><br>
<span class="lineno"></span><span class="op" id="1372994">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1372997">func</span>&nbsp;<span class="op" id="1373002">(</span><span class="ident" id="1373003">r</span>&nbsp;<span class="ident" id="1373005">httpRange</span><span class="op" id="1373014">)</span>&nbsp;<span class="ident" id="1373016">mimeHeader</span><span class="op" id="1373026">(</span><span class="ident" id="1373027">contentType</span>&nbsp;<span class="builtintype" id="1373039">string</span><span class="op" id="1373045">,</span>&nbsp;<span class="ident" id="1373047">size</span>&nbsp;<span class="ident" id="1373052">int64</span><span class="op" id="1373057">)</span>&nbsp;<span class="ident" id="1373059">textproto</span><span class="op" id="1373068">.</span><span class="ident" id="1373069">MIMEHeader</span>&nbsp;<span class="op" id="1373080">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1373083">return</span>&nbsp;<span class="ident" id="1373090">textproto</span><span class="op" id="1373099">.</span><span class="ident" id="1373100">MIMEHeader</span><span class="op" id="1373110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1373114">&#34;Content-Range&#34;</span><span class="op" id="1373129">:</span>&nbsp;<span class="op" id="1373131">{</span><span class="ident" id="1373132">r</span><span class="op" id="1373133">.</span><span class="ident" id="1373134">contentRange</span><span class="op" id="1373146">(</span><span class="ident" id="1373147">size</span><span class="op" id="1373151">)</span><span class="op" id="1373152">}</span><span class="op" id="1373153">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1373157">&#34;Content-Type&#34;</span><span class="op" id="1373171">:</span>&nbsp;&nbsp;<span class="op" id="1373174">{</span><span class="ident" id="1373175">contentType</span><span class="op" id="1373186">}</span><span class="op" id="1373187">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1373190">}</span><br>
<span class="lineno"></span><span class="op" id="1373192">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span><span class="comment" id="1373195">//&nbsp;parseRange&nbsp;parses&nbsp;a&nbsp;Range&nbsp;header&nbsp;string&nbsp;as&nbsp;per&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><span class="keyword" id="1373255">func</span>&nbsp;<span class="ident" id="1373260">parseRange</span><span class="op" id="1373270">(</span><span class="ident" id="1373271">s</span>&nbsp;<span class="builtintype" id="1373273">string</span><span class="op" id="1373279">,</span>&nbsp;<span class="ident" id="1373281">size</span>&nbsp;<span class="ident" id="1373286">int64</span><span class="op" id="1373291">)</span>&nbsp;<span class="op" id="1373293">(</span><span class="op" id="1373294">[</span><span class="op" id="1373295">]</span><span class="ident" id="1373296">httpRange</span><span class="op" id="1373305">,</span>&nbsp;<span class="builtintype" id="1373307">error</span><span class="op" id="1373312">)</span>&nbsp;<span class="op" id="1373314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1373317">if</span>&nbsp;<span class="ident" id="1373320">s</span>&nbsp;<span class="op" id="1373322">==</span>&nbsp;<span class="string" id="1373325">&#34;&#34;</span>&nbsp;<span class="op" id="1373328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1373332">return</span>&nbsp;<span class="ident" id="1373339">nil</span><span class="op" id="1373342">,</span>&nbsp;<span class="ident" id="1373344">nil</span>&nbsp;<span class="comment" id="1373348">//&nbsp;header&nbsp;not&nbsp;present</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1373371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1373374">const</span>&nbsp;<span class="ident" id="1373380">b</span>&nbsp;<span class="op" id="1373382">=</span>&nbsp;<span class="string" id="1373384">&#34;bytes=&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1373394">if</span>&nbsp;<span class="op" id="1373397">!</span><span class="ident" id="1373398">strings</span><span class="op" id="1373405">.</span><span class="ident" id="1373406">HasPrefix</span><span class="op" id="1373415">(</span><span class="ident" id="1373416">s</span><span class="op" id="1373417">,</span>&nbsp;<span class="ident" id="1373419">b</span><span class="op" id="1373420">)</span>&nbsp;<span class="op" id="1373422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1373426">return</span>&nbsp;<span class="ident" id="1373433">nil</span><span class="op" id="1373436">,</span>&nbsp;<span class="ident" id="1373438">errors</span><span class="op" id="1373444">.</span><span class="ident" id="1373445">New</span><span class="op" id="1373448">(</span><span class="string" id="1373449">&#34;invalid&nbsp;range&#34;</span><span class="op" id="1373464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1373467">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1373470">var</span>&nbsp;<span class="ident" id="1373474">ranges</span>&nbsp;<span class="op" id="1373481">[</span><span class="op" id="1373482">]</span><span class="ident" id="1373483">httpRange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1373494">for</span>&nbsp;<span class="ident" id="1373498">_</span><span class="op" id="1373499">,</span>&nbsp;<span class="ident" id="1373501">ra</span>&nbsp;<span class="op" id="1373504">:=</span>&nbsp;<span class="keyword" id="1373507">range</span>&nbsp;<span class="ident" id="1373513">strings</span><span class="op" id="1373520">.</span><span class="ident" id="1373521">Split</span><span class="op" id="1373526">(</span><span class="ident" id="1373527">s</span><span class="op" id="1373528">[</span><span class="builtinfunc" id="1373529">len</span><span class="op" id="1373532">(</span><span class="ident" id="1373533">b</span><span class="op" id="1373534">)</span><span class="op" id="1373535">:</span><span class="op" id="1373536">]</span><span class="op" id="1373537">,</span>&nbsp;<span class="string" id="1373539">&#34;,&#34;</span><span class="op" id="1373542">)</span>&nbsp;<span class="op" id="1373544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1373548">ra</span>&nbsp;<span class="op" id="1373551">=</span>&nbsp;<span class="ident" id="1373553">strings</span><span class="op" id="1373560">.</span><span class="ident" id="1373561">TrimSpace</span><span class="op" id="1373570">(</span><span class="ident" id="1373571">ra</span><span class="op" id="1373573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1373577">if</span>&nbsp;<span class="ident" id="1373580">ra</span>&nbsp;<span class="op" id="1373583">==</span>&nbsp;<span class="string" id="1373586">&#34;&#34;</span>&nbsp;<span class="op" id="1373589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1373594">continue</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1373605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1373609">i</span>&nbsp;<span class="op" id="1373611">:=</span>&nbsp;<span class="ident" id="1373614">strings</span><span class="op" id="1373621">.</span><span class="ident" id="1373622">Index</span><span class="op" id="1373627">(</span><span class="ident" id="1373628">ra</span><span class="op" id="1373630">,</span>&nbsp;<span class="string" id="1373632">&#34;-&#34;</span><span class="op" id="1373635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1373639">if</span>&nbsp;<span class="ident" id="1373642">i</span>&nbsp;<span class="op" id="1373644">&lt;</span>&nbsp;<span class="num" id="1373646">0</span>&nbsp;<span class="op" id="1373648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1373653">return</span>&nbsp;<span class="ident" id="1373660">nil</span><span class="op" id="1373663">,</span>&nbsp;<span class="ident" id="1373665">errors</span><span class="op" id="1373671">.</span><span class="ident" id="1373672">New</span><span class="op" id="1373675">(</span><span class="string" id="1373676">&#34;invalid&nbsp;range&#34;</span><span class="op" id="1373691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1373695">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1373699">start</span><span class="op" id="1373704">,</span>&nbsp;<span class="ident" id="1373706">end</span>&nbsp;<span class="op" id="1373710">:=</span>&nbsp;<span class="ident" id="1373713">strings</span><span class="op" id="1373720">.</span><span class="ident" id="1373721">TrimSpace</span><span class="op" id="1373730">(</span><span class="ident" id="1373731">ra</span><span class="op" id="1373733">[</span><span class="op" id="1373734">:</span><span class="ident" id="1373735">i</span><span class="op" id="1373736">]</span><span class="op" id="1373737">)</span><span class="op" id="1373738">,</span>&nbsp;<span class="ident" id="1373740">strings</span><span class="op" id="1373747">.</span><span class="ident" id="1373748">TrimSpace</span><span class="op" id="1373757">(</span><span class="ident" id="1373758">ra</span><span class="op" id="1373760">[</span><span class="ident" id="1373761">i</span><span class="op" id="1373762">+</span><span class="num" id="1373763">1</span><span class="op" id="1373764">:</span><span class="op" id="1373765">]</span><span class="op" id="1373766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1373770">var</span>&nbsp;<span class="ident" id="1373774">r</span>&nbsp;<span class="ident" id="1373776">httpRange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1373788">if</span>&nbsp;<span class="ident" id="1373791">start</span>&nbsp;<span class="op" id="1373797">==</span>&nbsp;<span class="string" id="1373800">&#34;&#34;</span>&nbsp;<span class="op" id="1373803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1373808">//&nbsp;If&nbsp;no&nbsp;start&nbsp;is&nbsp;specified,&nbsp;end&nbsp;specifies&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1373858">//&nbsp;range&nbsp;start&nbsp;relative&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1373909">i</span><span class="op" id="1373910">,</span>&nbsp;<span class="ident" id="1373912">err</span>&nbsp;<span class="op" id="1373916">:=</span>&nbsp;<span class="ident" id="1373919">strconv</span><span class="op" id="1373926">.</span><span class="ident" id="1373927">ParseInt</span><span class="op" id="1373935">(</span><span class="ident" id="1373936">end</span><span class="op" id="1373939">,</span>&nbsp;<span class="num" id="1373941">10</span><span class="op" id="1373943">,</span>&nbsp;<span class="num" id="1373945">64</span><span class="op" id="1373947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1373952">if</span>&nbsp;<span class="ident" id="1373955">err</span>&nbsp;<span class="op" id="1373959">!=</span>&nbsp;<span class="ident" id="1373962">nil</span>&nbsp;<span class="op" id="1373966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1373972">return</span>&nbsp;<span class="ident" id="1373979">nil</span><span class="op" id="1373982">,</span>&nbsp;<span class="ident" id="1373984">errors</span><span class="op" id="1373990">.</span><span class="ident" id="1373991">New</span><span class="op" id="1373994">(</span><span class="string" id="1373995">&#34;invalid&nbsp;range&#34;</span><span class="op" id="1374010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1374015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1374020">if</span>&nbsp;<span class="ident" id="1374023">i</span>&nbsp;<span class="op" id="1374025">&gt;</span>&nbsp;<span class="ident" id="1374027">size</span>&nbsp;<span class="op" id="1374032">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1374038">i</span>&nbsp;<span class="op" id="1374040">=</span>&nbsp;<span class="ident" id="1374042">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1374050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1374055">r</span><span class="op" id="1374056">.</span><span class="ident" id="1374057">start</span>&nbsp;<span class="op" id="1374063">=</span>&nbsp;<span class="ident" id="1374065">size</span>&nbsp;<span class="op" id="1374070">-</span>&nbsp;<span class="ident" id="1374072">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1374077">r</span><span class="op" id="1374078">.</span><span class="ident" id="1374079">length</span>&nbsp;<span class="op" id="1374086">=</span>&nbsp;<span class="ident" id="1374088">size</span>&nbsp;<span class="op" id="1374093">-</span>&nbsp;<span class="ident" id="1374095">r</span><span class="op" id="1374096">.</span><span class="ident" id="1374097">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1374105">}</span>&nbsp;<span class="keyword" id="1374107">else</span>&nbsp;<span class="op" id="1374112">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1374117">i</span><span class="op" id="1374118">,</span>&nbsp;<span class="ident" id="1374120">err</span>&nbsp;<span class="op" id="1374124">:=</span>&nbsp;<span class="ident" id="1374127">strconv</span><span class="op" id="1374134">.</span><span class="ident" id="1374135">ParseInt</span><span class="op" id="1374143">(</span><span class="ident" id="1374144">start</span><span class="op" id="1374149">,</span>&nbsp;<span class="num" id="1374151">10</span><span class="op" id="1374153">,</span>&nbsp;<span class="num" id="1374155">64</span><span class="op" id="1374157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1374162">if</span>&nbsp;<span class="ident" id="1374165">err</span>&nbsp;<span class="op" id="1374169">!=</span>&nbsp;<span class="ident" id="1374172">nil</span>&nbsp;<span class="op" id="1374176">||</span>&nbsp;<span class="ident" id="1374179">i</span>&nbsp;<span class="op" id="1374181">&gt;</span>&nbsp;<span class="ident" id="1374183">size</span>&nbsp;<span class="op" id="1374188">||</span>&nbsp;<span class="ident" id="1374191">i</span>&nbsp;<span class="op" id="1374193">&lt;</span>&nbsp;<span class="num" id="1374195">0</span>&nbsp;<span class="op" id="1374197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1374203">return</span>&nbsp;<span class="ident" id="1374210">nil</span><span class="op" id="1374213">,</span>&nbsp;<span class="ident" id="1374215">errors</span><span class="op" id="1374221">.</span><span class="ident" id="1374222">New</span><span class="op" id="1374225">(</span><span class="string" id="1374226">&#34;invalid&nbsp;range&#34;</span><span class="op" id="1374241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1374246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1374251">r</span><span class="op" id="1374252">.</span><span class="ident" id="1374253">start</span>&nbsp;<span class="op" id="1374259">=</span>&nbsp;<span class="ident" id="1374261">i</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1374266">if</span>&nbsp;<span class="ident" id="1374269">end</span>&nbsp;<span class="op" id="1374273">==</span>&nbsp;<span class="string" id="1374276">&#34;&#34;</span>&nbsp;<span class="op" id="1374279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1374285">//&nbsp;If&nbsp;no&nbsp;end&nbsp;is&nbsp;specified,&nbsp;range&nbsp;extends&nbsp;to&nbsp;end&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1374350">r</span><span class="op" id="1374351">.</span><span class="ident" id="1374352">length</span>&nbsp;<span class="op" id="1374359">=</span>&nbsp;<span class="ident" id="1374361">size</span>&nbsp;<span class="op" id="1374366">-</span>&nbsp;<span class="ident" id="1374368">r</span><span class="op" id="1374369">.</span><span class="ident" id="1374370">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1374379">}</span>&nbsp;<span class="keyword" id="1374381">else</span>&nbsp;<span class="op" id="1374386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1374392">i</span><span class="op" id="1374393">,</span>&nbsp;<span class="ident" id="1374395">err</span>&nbsp;<span class="op" id="1374399">:=</span>&nbsp;<span class="ident" id="1374402">strconv</span><span class="op" id="1374409">.</span><span class="ident" id="1374410">ParseInt</span><span class="op" id="1374418">(</span><span class="ident" id="1374419">end</span><span class="op" id="1374422">,</span>&nbsp;<span class="num" id="1374424">10</span><span class="op" id="1374426">,</span>&nbsp;<span class="num" id="1374428">64</span><span class="op" id="1374430">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1374436">if</span>&nbsp;<span class="ident" id="1374439">err</span>&nbsp;<span class="op" id="1374443">!=</span>&nbsp;<span class="ident" id="1374446">nil</span>&nbsp;<span class="op" id="1374450">||</span>&nbsp;<span class="ident" id="1374453">r</span><span class="op" id="1374454">.</span><span class="ident" id="1374455">start</span>&nbsp;<span class="op" id="1374461">&gt;</span>&nbsp;<span class="ident" id="1374463">i</span>&nbsp;<span class="op" id="1374465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1374472">return</span>&nbsp;<span class="ident" id="1374479">nil</span><span class="op" id="1374482">,</span>&nbsp;<span class="ident" id="1374484">errors</span><span class="op" id="1374490">.</span><span class="ident" id="1374491">New</span><span class="op" id="1374494">(</span><span class="string" id="1374495">&#34;invalid&nbsp;range&#34;</span><span class="op" id="1374510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1374516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1374522">if</span>&nbsp;<span class="ident" id="1374525">i</span>&nbsp;<span class="op" id="1374527">&gt;=</span>&nbsp;<span class="ident" id="1374530">size</span>&nbsp;<span class="op" id="1374535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1374542">i</span>&nbsp;<span class="op" id="1374544">=</span>&nbsp;<span class="ident" id="1374546">size</span>&nbsp;<span class="op" id="1374551">-</span>&nbsp;<span class="num" id="1374553">1</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1374559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1374565">r</span><span class="op" id="1374566">.</span><span class="ident" id="1374567">length</span>&nbsp;<span class="op" id="1374574">=</span>&nbsp;<span class="ident" id="1374576">i</span>&nbsp;<span class="op" id="1374578">-</span>&nbsp;<span class="ident" id="1374580">r</span><span class="op" id="1374581">.</span><span class="ident" id="1374582">start</span>&nbsp;<span class="op" id="1374588">+</span>&nbsp;<span class="num" id="1374590">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1374595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1374599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1374603">ranges</span>&nbsp;<span class="op" id="1374610">=</span>&nbsp;<span class="builtinfunc" id="1374612">append</span><span class="op" id="1374618">(</span><span class="ident" id="1374619">ranges</span><span class="op" id="1374625">,</span>&nbsp;<span class="ident" id="1374627">r</span><span class="op" id="1374628">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1374631">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1374634">return</span>&nbsp;<span class="ident" id="1374641">ranges</span><span class="op" id="1374647">,</span>&nbsp;<span class="ident" id="1374649">nil</span><br>
<span class="lineno"></span><span class="op" id="1374653">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1374656">//&nbsp;countingWriter&nbsp;counts&nbsp;how&nbsp;many&nbsp;bytes&nbsp;have&nbsp;been&nbsp;written&nbsp;to&nbsp;it.</span><br>
<span class="lineno">530</span><span class="keyword" id="1374721">type</span>&nbsp;<span class="ident" id="1374726">countingWriter</span>&nbsp;<span class="ident" id="1374741">int64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1374748">func</span>&nbsp;<span class="op" id="1374753">(</span><span class="ident" id="1374754">w</span>&nbsp;<span class="op" id="1374756">*</span><span class="ident" id="1374757">countingWriter</span><span class="op" id="1374771">)</span>&nbsp;<span class="ident" id="1374773">Write</span><span class="op" id="1374778">(</span><span class="ident" id="1374779">p</span>&nbsp;<span class="op" id="1374781">[</span><span class="op" id="1374782">]</span><span class="builtintype" id="1374783">byte</span><span class="op" id="1374787">)</span>&nbsp;<span class="op" id="1374789">(</span><span class="ident" id="1374790">n</span>&nbsp;<span class="builtintype" id="1374792">int</span><span class="op" id="1374795">,</span>&nbsp;<span class="ident" id="1374797">err</span>&nbsp;<span class="builtintype" id="1374801">error</span><span class="op" id="1374806">)</span>&nbsp;<span class="op" id="1374808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1374811">*</span><span class="ident" id="1374812">w</span>&nbsp;<span class="op" id="1374814">+=</span>&nbsp;<span class="ident" id="1374817">countingWriter</span><span class="op" id="1374831">(</span><span class="builtinfunc" id="1374832">len</span><span class="op" id="1374835">(</span><span class="ident" id="1374836">p</span><span class="op" id="1374837">)</span><span class="op" id="1374838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1374841">return</span>&nbsp;<span class="builtinfunc" id="1374848">len</span><span class="op" id="1374851">(</span><span class="ident" id="1374852">p</span><span class="op" id="1374853">)</span><span class="op" id="1374854">,</span>&nbsp;<span class="ident" id="1374856">nil</span><br>
<span class="lineno">535</span><span class="op" id="1374860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1374863">//&nbsp;rangesMIMESize&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;it&nbsp;takes&nbsp;to&nbsp;encode&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1374932">//&nbsp;provided&nbsp;ranges&nbsp;as&nbsp;a&nbsp;multipart&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="1374976">func</span>&nbsp;<span class="ident" id="1374981">rangesMIMESize</span><span class="op" id="1374995">(</span><span class="ident" id="1374996">ranges</span>&nbsp;<span class="op" id="1375003">[</span><span class="op" id="1375004">]</span><span class="ident" id="1375005">httpRange</span><span class="op" id="1375014">,</span>&nbsp;<span class="ident" id="1375016">contentType</span>&nbsp;<span class="builtintype" id="1375028">string</span><span class="op" id="1375034">,</span>&nbsp;<span class="ident" id="1375036">contentSize</span>&nbsp;<span class="ident" id="1375048">int64</span><span class="op" id="1375053">)</span>&nbsp;<span class="op" id="1375055">(</span><span class="ident" id="1375056">encSize</span>&nbsp;<span class="ident" id="1375064">int64</span><span class="op" id="1375069">)</span>&nbsp;<span class="op" id="1375071">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1375074">var</span>&nbsp;<span class="ident" id="1375078">w</span>&nbsp;<span class="ident" id="1375080">countingWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1375096">mw</span>&nbsp;<span class="op" id="1375099">:=</span>&nbsp;<span class="ident" id="1375102">multipart</span><span class="op" id="1375111">.</span><span class="ident" id="1375112">NewWriter</span><span class="op" id="1375121">(</span><span class="op" id="1375122">&amp;</span><span class="ident" id="1375123">w</span><span class="op" id="1375124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1375127">for</span>&nbsp;<span class="ident" id="1375131">_</span><span class="op" id="1375132">,</span>&nbsp;<span class="ident" id="1375134">ra</span>&nbsp;<span class="op" id="1375137">:=</span>&nbsp;<span class="keyword" id="1375140">range</span>&nbsp;<span class="ident" id="1375146">ranges</span>&nbsp;<span class="op" id="1375153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1375157">mw</span><span class="op" id="1375159">.</span><span class="ident" id="1375160">CreatePart</span><span class="op" id="1375170">(</span><span class="ident" id="1375171">ra</span><span class="op" id="1375173">.</span><span class="ident" id="1375174">mimeHeader</span><span class="op" id="1375184">(</span><span class="ident" id="1375185">contentType</span><span class="op" id="1375196">,</span>&nbsp;<span class="ident" id="1375198">contentSize</span><span class="op" id="1375209">)</span><span class="op" id="1375210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1375214">encSize</span>&nbsp;<span class="op" id="1375222">+=</span>&nbsp;<span class="ident" id="1375225">ra</span><span class="op" id="1375227">.</span><span class="ident" id="1375228">length</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1375236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1375239">mw</span><span class="op" id="1375241">.</span><span class="ident" id="1375242">Close</span><span class="op" id="1375247">(</span><span class="op" id="1375248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1375251">encSize</span>&nbsp;<span class="op" id="1375259">+=</span>&nbsp;<span class="ident" id="1375262">int64</span><span class="op" id="1375267">(</span><span class="ident" id="1375268">w</span><span class="op" id="1375269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1375272">return</span><br>
<span class="lineno"></span><span class="op" id="1375279">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="keyword" id="1375282">func</span>&nbsp;<span class="ident" id="1375287">sumRangesSize</span><span class="op" id="1375300">(</span><span class="ident" id="1375301">ranges</span>&nbsp;<span class="op" id="1375308">[</span><span class="op" id="1375309">]</span><span class="ident" id="1375310">httpRange</span><span class="op" id="1375319">)</span>&nbsp;<span class="op" id="1375321">(</span><span class="ident" id="1375322">size</span>&nbsp;<span class="ident" id="1375327">int64</span><span class="op" id="1375332">)</span>&nbsp;<span class="op" id="1375334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1375337">for</span>&nbsp;<span class="ident" id="1375341">_</span><span class="op" id="1375342">,</span>&nbsp;<span class="ident" id="1375344">ra</span>&nbsp;<span class="op" id="1375347">:=</span>&nbsp;<span class="keyword" id="1375350">range</span>&nbsp;<span class="ident" id="1375356">ranges</span>&nbsp;<span class="op" id="1375363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1375367">size</span>&nbsp;<span class="op" id="1375372">+=</span>&nbsp;<span class="ident" id="1375375">ra</span><span class="op" id="1375377">.</span><span class="ident" id="1375378">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1375386">}</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1375389">return</span><br>
<span class="lineno"></span><span class="op" id="1375396">}</span>
</div>
</body>
</html>
