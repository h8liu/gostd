<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/lzw</h2>
<ul>
<li><a href="/gostd/compress/lzw/reader.go.html">reader.go</a></li>
<li><a href="/gostd/compress/lzw/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/compress/lzw/writer.go.html">writer.go</a></li>
<li><a href="/gostd/compress/lzw/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4317739">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4317794">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4317848">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4317899">package</span>&nbsp;<span class="ident" id="4317907">lzw</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4317912">import</span>&nbsp;<span class="op" id="4317919">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4317922">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4317931">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4317941">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4317948">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="4317953">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4317956">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;a&nbsp;buffered,&nbsp;flushable&nbsp;writer.</span><br>
<span class="lineno">15</span><span class="keyword" id="4318001">type</span>&nbsp;<span class="ident" id="4318006">writer</span>&nbsp;<span class="keyword" id="4318013">interface</span>&nbsp;<span class="op" id="4318023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4318026">io</span><span class="op" id="4318028">.</span><span class="ident" id="4318029">ByteWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4318041">Flush</span><span class="op" id="4318046">(</span><span class="op" id="4318047">)</span>&nbsp;<span class="builtintype" id="4318049">error</span><br>
<span class="lineno"></span><span class="op" id="4318055">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="4318058">//&nbsp;An&nbsp;errWriteCloser&nbsp;is&nbsp;an&nbsp;io.WriteCloser&nbsp;that&nbsp;always&nbsp;returns&nbsp;a&nbsp;given&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="4318135">type</span>&nbsp;<span class="ident" id="4318140">errWriteCloser</span>&nbsp;<span class="keyword" id="4318155">struct</span>&nbsp;<span class="op" id="4318162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4318165">err</span>&nbsp;<span class="builtintype" id="4318169">error</span><br>
<span class="lineno"></span><span class="op" id="4318175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="4318178">func</span>&nbsp;<span class="op" id="4318183">(</span><span class="ident" id="4318184">e</span>&nbsp;<span class="op" id="4318186">*</span><span class="ident" id="4318187">errWriteCloser</span><span class="op" id="4318201">)</span>&nbsp;<span class="ident" id="4318203">Write</span><span class="op" id="4318208">(</span><span class="op" id="4318209">[</span><span class="op" id="4318210">]</span><span class="builtintype" id="4318211">byte</span><span class="op" id="4318215">)</span>&nbsp;<span class="op" id="4318217">(</span><span class="builtintype" id="4318218">int</span><span class="op" id="4318221">,</span>&nbsp;<span class="builtintype" id="4318223">error</span><span class="op" id="4318228">)</span>&nbsp;<span class="op" id="4318230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4318233">return</span>&nbsp;<span class="num" id="4318240">0</span><span class="op" id="4318241">,</span>&nbsp;<span class="ident" id="4318243">e</span><span class="op" id="4318244">.</span><span class="ident" id="4318245">err</span><br>
<span class="lineno"></span><span class="op" id="4318249">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4318252">func</span>&nbsp;<span class="op" id="4318257">(</span><span class="ident" id="4318258">e</span>&nbsp;<span class="op" id="4318260">*</span><span class="ident" id="4318261">errWriteCloser</span><span class="op" id="4318275">)</span>&nbsp;<span class="ident" id="4318277">Close</span><span class="op" id="4318282">(</span><span class="op" id="4318283">)</span>&nbsp;<span class="builtintype" id="4318285">error</span>&nbsp;<span class="op" id="4318291">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4318294">return</span>&nbsp;<span class="ident" id="4318301">e</span><span class="op" id="4318302">.</span><span class="ident" id="4318303">err</span><br>
<span class="lineno"></span><span class="op" id="4318307">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4318310">const</span>&nbsp;<span class="op" id="4318316">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4318319">//&nbsp;A&nbsp;code&nbsp;is&nbsp;a&nbsp;12&nbsp;bit&nbsp;value,&nbsp;stored&nbsp;as&nbsp;a&nbsp;uint32&nbsp;when&nbsp;encoding&nbsp;to&nbsp;avoid</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4318391">//&nbsp;type&nbsp;conversions&nbsp;when&nbsp;shifting&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4318432">maxCode</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4318444">=</span>&nbsp;<span class="num" id="4318446">1</span><span class="op" id="4318447">&lt;&lt;</span><span class="num" id="4318449">12</span>&nbsp;<span class="op" id="4318452">-</span>&nbsp;<span class="num" id="4318454">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4318457">invalidCode</span>&nbsp;<span class="op" id="4318469">=</span>&nbsp;<span class="num" id="4318471">1</span><span class="op" id="4318472">&lt;&lt;</span><span class="num" id="4318474">32</span>&nbsp;<span class="op" id="4318477">-</span>&nbsp;<span class="num" id="4318479">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4318482">//&nbsp;There&nbsp;are&nbsp;1&lt;&lt;12&nbsp;possible&nbsp;codes,&nbsp;which&nbsp;is&nbsp;an&nbsp;upper&nbsp;bound&nbsp;on&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4318559">//&nbsp;valid&nbsp;hash&nbsp;table&nbsp;entries&nbsp;at&nbsp;any&nbsp;given&nbsp;point&nbsp;in&nbsp;time.&nbsp;tableSize&nbsp;is&nbsp;4x&nbsp;that.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4318638">tableSize</span>&nbsp;<span class="op" id="4318648">=</span>&nbsp;<span class="num" id="4318650">4</span>&nbsp;<span class="op" id="4318652">*</span>&nbsp;<span class="num" id="4318654">1</span>&nbsp;<span class="op" id="4318656">&lt;&lt;</span>&nbsp;<span class="num" id="4318659">12</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4318663">tableMask</span>&nbsp;<span class="op" id="4318673">=</span>&nbsp;<span class="ident" id="4318675">tableSize</span>&nbsp;<span class="op" id="4318685">-</span>&nbsp;<span class="num" id="4318687">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4318690">//&nbsp;A&nbsp;hash&nbsp;table&nbsp;entry&nbsp;is&nbsp;a&nbsp;uint32.&nbsp;Zero&nbsp;is&nbsp;an&nbsp;invalid&nbsp;entry&nbsp;since&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4318761">//&nbsp;lower&nbsp;12&nbsp;bits&nbsp;of&nbsp;a&nbsp;valid&nbsp;entry&nbsp;must&nbsp;be&nbsp;a&nbsp;non-literal&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4318824">invalidEntry</span>&nbsp;<span class="op" id="4318837">=</span>&nbsp;<span class="num" id="4318839">0</span><br>
<span class="lineno">45</span><span class="op" id="4318841">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4318844">//&nbsp;encoder&nbsp;is&nbsp;LZW&nbsp;compressor.</span><br>
<span class="lineno"></span><span class="keyword" id="4318874">type</span>&nbsp;<span class="ident" id="4318879">encoder</span>&nbsp;<span class="keyword" id="4318887">struct</span>&nbsp;<span class="op" id="4318894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4318897">//&nbsp;w&nbsp;is&nbsp;the&nbsp;writer&nbsp;that&nbsp;compressed&nbsp;bytes&nbsp;are&nbsp;written&nbsp;to.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4318955">w</span>&nbsp;<span class="ident" id="4318957">writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4318965">//&nbsp;order,&nbsp;write,&nbsp;bits,&nbsp;nBits&nbsp;and&nbsp;width&nbsp;are&nbsp;the&nbsp;state&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4319023">//&nbsp;converting&nbsp;a&nbsp;code&nbsp;stream&nbsp;into&nbsp;a&nbsp;byte&nbsp;stream.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4319072">order</span>&nbsp;<span class="ident" id="4319078">Order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4319085">write</span>&nbsp;<span class="keyword" id="4319091">func</span><span class="op" id="4319095">(</span><span class="op" id="4319096">*</span><span class="ident" id="4319097">encoder</span><span class="op" id="4319104">,</span>&nbsp;<span class="builtintype" id="4319106">uint32</span><span class="op" id="4319112">)</span>&nbsp;<span class="builtintype" id="4319114">error</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4319121">bits</span>&nbsp;&nbsp;<span class="builtintype" id="4319127">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4319135">nBits</span>&nbsp;<span class="builtintype" id="4319141">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4319147">width</span>&nbsp;<span class="builtintype" id="4319153">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4319159">//&nbsp;litWidth&nbsp;is&nbsp;the&nbsp;width&nbsp;in&nbsp;bits&nbsp;of&nbsp;literal&nbsp;codes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4319211">litWidth</span>&nbsp;<span class="builtintype" id="4319220">uint</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4319226">//&nbsp;hi&nbsp;is&nbsp;the&nbsp;code&nbsp;implied&nbsp;by&nbsp;the&nbsp;next&nbsp;code&nbsp;emission.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4319280">//&nbsp;overflow&nbsp;is&nbsp;the&nbsp;code&nbsp;at&nbsp;which&nbsp;hi&nbsp;overflows&nbsp;the&nbsp;code&nbsp;width.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4319343">hi</span><span class="op" id="4319345">,</span>&nbsp;<span class="ident" id="4319347">overflow</span>&nbsp;<span class="builtintype" id="4319356">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4319364">//&nbsp;savedCode&nbsp;is&nbsp;the&nbsp;accumulated&nbsp;code&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;most&nbsp;recent&nbsp;Write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4319438">//&nbsp;call.&nbsp;It&nbsp;is&nbsp;equal&nbsp;to&nbsp;invalidCode&nbsp;if&nbsp;there&nbsp;was&nbsp;no&nbsp;such&nbsp;call.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4319502">savedCode</span>&nbsp;<span class="builtintype" id="4319512">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4319520">//&nbsp;err&nbsp;is&nbsp;the&nbsp;first&nbsp;error&nbsp;encountered&nbsp;during&nbsp;writing.&nbsp;Closing&nbsp;the&nbsp;encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4319595">//&nbsp;will&nbsp;make&nbsp;any&nbsp;future&nbsp;Write&nbsp;calls&nbsp;return&nbsp;errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4319649">err</span>&nbsp;<span class="builtintype" id="4319653">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4319660">//&nbsp;table&nbsp;is&nbsp;the&nbsp;hash&nbsp;table&nbsp;from&nbsp;20-bit&nbsp;keys&nbsp;to&nbsp;12-bit&nbsp;values.&nbsp;Each&nbsp;table</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4319734">//&nbsp;entry&nbsp;contains&nbsp;key&lt;&lt;12|val&nbsp;and&nbsp;collisions&nbsp;resolve&nbsp;by&nbsp;linear&nbsp;probing.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4319807">//&nbsp;The&nbsp;keys&nbsp;consist&nbsp;of&nbsp;a&nbsp;12-bit&nbsp;code&nbsp;prefix&nbsp;and&nbsp;an&nbsp;8-bit&nbsp;byte&nbsp;suffix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4319878">//&nbsp;The&nbsp;values&nbsp;are&nbsp;a&nbsp;12-bit&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4319912">table</span>&nbsp;<span class="op" id="4319918">[</span><span class="ident" id="4319919">tableSize</span><span class="op" id="4319928">]</span><span class="builtintype" id="4319929">uint32</span><br>
<span class="lineno"></span><span class="op" id="4319936">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="4319939">//&nbsp;writeLSB&nbsp;writes&nbsp;the&nbsp;code&nbsp;c&nbsp;for&nbsp;&#34;Least&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="4320010">func</span>&nbsp;<span class="op" id="4320015">(</span><span class="ident" id="4320016">e</span>&nbsp;<span class="op" id="4320018">*</span><span class="ident" id="4320019">encoder</span><span class="op" id="4320026">)</span>&nbsp;<span class="ident" id="4320028">writeLSB</span><span class="op" id="4320036">(</span><span class="ident" id="4320037">c</span>&nbsp;<span class="builtintype" id="4320039">uint32</span><span class="op" id="4320045">)</span>&nbsp;<span class="builtintype" id="4320047">error</span>&nbsp;<span class="op" id="4320053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4320056">e</span><span class="op" id="4320057">.</span><span class="ident" id="4320058">bits</span>&nbsp;<span class="op" id="4320063">|=</span>&nbsp;<span class="ident" id="4320066">c</span>&nbsp;<span class="op" id="4320068">&lt;&lt;</span>&nbsp;<span class="ident" id="4320071">e</span><span class="op" id="4320072">.</span><span class="ident" id="4320073">nBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4320080">e</span><span class="op" id="4320081">.</span><span class="ident" id="4320082">nBits</span>&nbsp;<span class="op" id="4320088">+=</span>&nbsp;<span class="ident" id="4320091">e</span><span class="op" id="4320092">.</span><span class="ident" id="4320093">width</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4320100">for</span>&nbsp;<span class="ident" id="4320104">e</span><span class="op" id="4320105">.</span><span class="ident" id="4320106">nBits</span>&nbsp;<span class="op" id="4320112">&gt;=</span>&nbsp;<span class="num" id="4320115">8</span>&nbsp;<span class="op" id="4320117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4320121">if</span>&nbsp;<span class="ident" id="4320124">err</span>&nbsp;<span class="op" id="4320128">:=</span>&nbsp;<span class="ident" id="4320131">e</span><span class="op" id="4320132">.</span><span class="ident" id="4320133">w</span><span class="op" id="4320134">.</span><span class="ident" id="4320135">WriteByte</span><span class="op" id="4320144">(</span><span class="builtintype" id="4320145">uint8</span><span class="op" id="4320150">(</span><span class="ident" id="4320151">e</span><span class="op" id="4320152">.</span><span class="ident" id="4320153">bits</span><span class="op" id="4320157">)</span><span class="op" id="4320158">)</span><span class="op" id="4320159">;</span>&nbsp;<span class="ident" id="4320161">err</span>&nbsp;<span class="op" id="4320165">!=</span>&nbsp;<span class="ident" id="4320168">nil</span>&nbsp;<span class="op" id="4320172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4320177">return</span>&nbsp;<span class="ident" id="4320184">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4320190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4320194">e</span><span class="op" id="4320195">.</span><span class="ident" id="4320196">bits</span>&nbsp;<span class="op" id="4320201">&gt;&gt;=</span>&nbsp;<span class="num" id="4320205">8</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4320209">e</span><span class="op" id="4320210">.</span><span class="ident" id="4320211">nBits</span>&nbsp;<span class="op" id="4320217">-=</span>&nbsp;<span class="num" id="4320220">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4320223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4320226">return</span>&nbsp;<span class="ident" id="4320233">nil</span><br>
<span class="lineno"></span><span class="op" id="4320237">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="4320240">//&nbsp;writeMSB&nbsp;writes&nbsp;the&nbsp;code&nbsp;c&nbsp;for&nbsp;&#34;Most&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="4320310">func</span>&nbsp;<span class="op" id="4320315">(</span><span class="ident" id="4320316">e</span>&nbsp;<span class="op" id="4320318">*</span><span class="ident" id="4320319">encoder</span><span class="op" id="4320326">)</span>&nbsp;<span class="ident" id="4320328">writeMSB</span><span class="op" id="4320336">(</span><span class="ident" id="4320337">c</span>&nbsp;<span class="builtintype" id="4320339">uint32</span><span class="op" id="4320345">)</span>&nbsp;<span class="builtintype" id="4320347">error</span>&nbsp;<span class="op" id="4320353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4320356">e</span><span class="op" id="4320357">.</span><span class="ident" id="4320358">bits</span>&nbsp;<span class="op" id="4320363">|=</span>&nbsp;<span class="ident" id="4320366">c</span>&nbsp;<span class="op" id="4320368">&lt;&lt;</span>&nbsp;<span class="op" id="4320371">(</span><span class="num" id="4320372">32</span>&nbsp;<span class="op" id="4320375">-</span>&nbsp;<span class="ident" id="4320377">e</span><span class="op" id="4320378">.</span><span class="ident" id="4320379">width</span>&nbsp;<span class="op" id="4320385">-</span>&nbsp;<span class="ident" id="4320387">e</span><span class="op" id="4320388">.</span><span class="ident" id="4320389">nBits</span><span class="op" id="4320394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4320397">e</span><span class="op" id="4320398">.</span><span class="ident" id="4320399">nBits</span>&nbsp;<span class="op" id="4320405">+=</span>&nbsp;<span class="ident" id="4320408">e</span><span class="op" id="4320409">.</span><span class="ident" id="4320410">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4320417">for</span>&nbsp;<span class="ident" id="4320421">e</span><span class="op" id="4320422">.</span><span class="ident" id="4320423">nBits</span>&nbsp;<span class="op" id="4320429">&gt;=</span>&nbsp;<span class="num" id="4320432">8</span>&nbsp;<span class="op" id="4320434">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4320438">if</span>&nbsp;<span class="ident" id="4320441">err</span>&nbsp;<span class="op" id="4320445">:=</span>&nbsp;<span class="ident" id="4320448">e</span><span class="op" id="4320449">.</span><span class="ident" id="4320450">w</span><span class="op" id="4320451">.</span><span class="ident" id="4320452">WriteByte</span><span class="op" id="4320461">(</span><span class="builtintype" id="4320462">uint8</span><span class="op" id="4320467">(</span><span class="ident" id="4320468">e</span><span class="op" id="4320469">.</span><span class="ident" id="4320470">bits</span>&nbsp;<span class="op" id="4320475">&gt;&gt;</span>&nbsp;<span class="num" id="4320478">24</span><span class="op" id="4320480">)</span><span class="op" id="4320481">)</span><span class="op" id="4320482">;</span>&nbsp;<span class="ident" id="4320484">err</span>&nbsp;<span class="op" id="4320488">!=</span>&nbsp;<span class="ident" id="4320491">nil</span>&nbsp;<span class="op" id="4320495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4320500">return</span>&nbsp;<span class="ident" id="4320507">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4320513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4320517">e</span><span class="op" id="4320518">.</span><span class="ident" id="4320519">bits</span>&nbsp;<span class="op" id="4320524">&lt;&lt;=</span>&nbsp;<span class="num" id="4320528">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4320532">e</span><span class="op" id="4320533">.</span><span class="ident" id="4320534">nBits</span>&nbsp;<span class="op" id="4320540">-=</span>&nbsp;<span class="num" id="4320543">8</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4320546">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4320549">return</span>&nbsp;<span class="ident" id="4320556">nil</span><br>
<span class="lineno"></span><span class="op" id="4320560">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4320563">//&nbsp;errOutOfCodes&nbsp;is&nbsp;an&nbsp;internal&nbsp;error&nbsp;that&nbsp;means&nbsp;that&nbsp;the&nbsp;encoder&nbsp;has&nbsp;run&nbsp;out</span><br>
<span class="lineno">105</span><span class="comment" id="4320641">//&nbsp;of&nbsp;unused&nbsp;codes&nbsp;and&nbsp;a&nbsp;clear&nbsp;code&nbsp;needs&nbsp;to&nbsp;be&nbsp;sent&nbsp;next.</span><br>
<span class="lineno"></span><span class="keyword" id="4320700">var</span>&nbsp;<span class="ident" id="4320704">errOutOfCodes</span>&nbsp;<span class="op" id="4320718">=</span>&nbsp;<span class="ident" id="4320720">errors</span><span class="op" id="4320726">.</span><span class="ident" id="4320727">New</span><span class="op" id="4320730">(</span><span class="string" id="4320731">&#34;lzw:&nbsp;out&nbsp;of&nbsp;codes&#34;</span><span class="op" id="4320750">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4320753">//&nbsp;incHi&nbsp;increments&nbsp;e.hi&nbsp;and&nbsp;checks&nbsp;for&nbsp;both&nbsp;overflow&nbsp;and&nbsp;running&nbsp;out&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4320826">//&nbsp;unused&nbsp;codes.&nbsp;In&nbsp;the&nbsp;latter&nbsp;case,&nbsp;incHi&nbsp;sends&nbsp;a&nbsp;clear&nbsp;code,&nbsp;resets&nbsp;the</span><br>
<span class="lineno">110</span><span class="comment" id="4320900">//&nbsp;encoder&nbsp;state&nbsp;and&nbsp;returns&nbsp;errOutOfCodes.</span><br>
<span class="lineno"></span><span class="keyword" id="4320944">func</span>&nbsp;<span class="op" id="4320949">(</span><span class="ident" id="4320950">e</span>&nbsp;<span class="op" id="4320952">*</span><span class="ident" id="4320953">encoder</span><span class="op" id="4320960">)</span>&nbsp;<span class="ident" id="4320962">incHi</span><span class="op" id="4320967">(</span><span class="op" id="4320968">)</span>&nbsp;<span class="builtintype" id="4320970">error</span>&nbsp;<span class="op" id="4320976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4320979">e</span><span class="op" id="4320980">.</span><span class="ident" id="4320981">hi</span><span class="op" id="4320983">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4320987">if</span>&nbsp;<span class="ident" id="4320990">e</span><span class="op" id="4320991">.</span><span class="ident" id="4320992">hi</span>&nbsp;<span class="op" id="4320995">==</span>&nbsp;<span class="ident" id="4320998">e</span><span class="op" id="4320999">.</span><span class="ident" id="4321000">overflow</span>&nbsp;<span class="op" id="4321009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4321013">e</span><span class="op" id="4321014">.</span><span class="ident" id="4321015">width</span><span class="op" id="4321020">++</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4321025">e</span><span class="op" id="4321026">.</span><span class="ident" id="4321027">overflow</span>&nbsp;<span class="op" id="4321036">&lt;&lt;=</span>&nbsp;<span class="num" id="4321040">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4321043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321046">if</span>&nbsp;<span class="ident" id="4321049">e</span><span class="op" id="4321050">.</span><span class="ident" id="4321051">hi</span>&nbsp;<span class="op" id="4321054">==</span>&nbsp;<span class="ident" id="4321057">maxCode</span>&nbsp;<span class="op" id="4321065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4321069">clear</span>&nbsp;<span class="op" id="4321075">:=</span>&nbsp;<span class="builtintype" id="4321078">uint32</span><span class="op" id="4321084">(</span><span class="num" id="4321085">1</span><span class="op" id="4321086">)</span>&nbsp;<span class="op" id="4321088">&lt;&lt;</span>&nbsp;<span class="ident" id="4321091">e</span><span class="op" id="4321092">.</span><span class="ident" id="4321093">litWidth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321104">if</span>&nbsp;<span class="ident" id="4321107">err</span>&nbsp;<span class="op" id="4321111">:=</span>&nbsp;<span class="ident" id="4321114">e</span><span class="op" id="4321115">.</span><span class="ident" id="4321116">write</span><span class="op" id="4321121">(</span><span class="ident" id="4321122">e</span><span class="op" id="4321123">,</span>&nbsp;<span class="ident" id="4321125">clear</span><span class="op" id="4321130">)</span><span class="op" id="4321131">;</span>&nbsp;<span class="ident" id="4321133">err</span>&nbsp;<span class="op" id="4321137">!=</span>&nbsp;<span class="ident" id="4321140">nil</span>&nbsp;<span class="op" id="4321144">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321149">return</span>&nbsp;<span class="ident" id="4321156">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4321162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4321166">e</span><span class="op" id="4321167">.</span><span class="ident" id="4321168">width</span>&nbsp;<span class="op" id="4321174">=</span>&nbsp;<span class="builtintype" id="4321176">uint</span><span class="op" id="4321180">(</span><span class="ident" id="4321181">e</span><span class="op" id="4321182">.</span><span class="ident" id="4321183">litWidth</span><span class="op" id="4321191">)</span>&nbsp;<span class="op" id="4321193">+</span>&nbsp;<span class="num" id="4321195">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4321199">e</span><span class="op" id="4321200">.</span><span class="ident" id="4321201">hi</span>&nbsp;<span class="op" id="4321204">=</span>&nbsp;<span class="ident" id="4321206">clear</span>&nbsp;<span class="op" id="4321212">+</span>&nbsp;<span class="num" id="4321214">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4321218">e</span><span class="op" id="4321219">.</span><span class="ident" id="4321220">overflow</span>&nbsp;<span class="op" id="4321229">=</span>&nbsp;<span class="ident" id="4321231">clear</span>&nbsp;<span class="op" id="4321237">&lt;&lt;</span>&nbsp;<span class="num" id="4321240">1</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321244">for</span>&nbsp;<span class="ident" id="4321248">i</span>&nbsp;<span class="op" id="4321250">:=</span>&nbsp;<span class="keyword" id="4321253">range</span>&nbsp;<span class="ident" id="4321259">e</span><span class="op" id="4321260">.</span><span class="ident" id="4321261">table</span>&nbsp;<span class="op" id="4321267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4321272">e</span><span class="op" id="4321273">.</span><span class="ident" id="4321274">table</span><span class="op" id="4321279">[</span><span class="ident" id="4321280">i</span><span class="op" id="4321281">]</span>&nbsp;<span class="op" id="4321283">=</span>&nbsp;<span class="ident" id="4321285">invalidEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4321300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321304">return</span>&nbsp;<span class="ident" id="4321311">errOutOfCodes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4321326">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321329">return</span>&nbsp;<span class="ident" id="4321336">nil</span><br>
<span class="lineno"></span><span class="op" id="4321340">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4321343">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;compressed&nbsp;representation&nbsp;of&nbsp;p&nbsp;to&nbsp;e&#39;s&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4321418">func</span>&nbsp;<span class="op" id="4321423">(</span><span class="ident" id="4321424">e</span>&nbsp;<span class="op" id="4321426">*</span><span class="ident" id="4321427">encoder</span><span class="op" id="4321434">)</span>&nbsp;<span class="ident" id="4321436">Write</span><span class="op" id="4321441">(</span><span class="ident" id="4321442">p</span>&nbsp;<span class="op" id="4321444">[</span><span class="op" id="4321445">]</span><span class="builtintype" id="4321446">byte</span><span class="op" id="4321450">)</span>&nbsp;<span class="op" id="4321452">(</span><span class="ident" id="4321453">n</span>&nbsp;<span class="builtintype" id="4321455">int</span><span class="op" id="4321458">,</span>&nbsp;<span class="ident" id="4321460">err</span>&nbsp;<span class="builtintype" id="4321464">error</span><span class="op" id="4321469">)</span>&nbsp;<span class="op" id="4321471">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321474">if</span>&nbsp;<span class="ident" id="4321477">e</span><span class="op" id="4321478">.</span><span class="ident" id="4321479">err</span>&nbsp;<span class="op" id="4321483">!=</span>&nbsp;<span class="ident" id="4321486">nil</span>&nbsp;<span class="op" id="4321490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321494">return</span>&nbsp;<span class="num" id="4321501">0</span><span class="op" id="4321502">,</span>&nbsp;<span class="ident" id="4321504">e</span><span class="op" id="4321505">.</span><span class="ident" id="4321506">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4321511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321514">if</span>&nbsp;<span class="builtinfunc" id="4321517">len</span><span class="op" id="4321520">(</span><span class="ident" id="4321521">p</span><span class="op" id="4321522">)</span>&nbsp;<span class="op" id="4321524">==</span>&nbsp;<span class="num" id="4321527">0</span>&nbsp;<span class="op" id="4321529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321533">return</span>&nbsp;<span class="num" id="4321540">0</span><span class="op" id="4321541">,</span>&nbsp;<span class="ident" id="4321543">nil</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4321548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4321551">n</span>&nbsp;<span class="op" id="4321553">=</span>&nbsp;<span class="builtinfunc" id="4321555">len</span><span class="op" id="4321558">(</span><span class="ident" id="4321559">p</span><span class="op" id="4321560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4321563">litMask</span>&nbsp;<span class="op" id="4321571">:=</span>&nbsp;<span class="builtintype" id="4321574">uint32</span><span class="op" id="4321580">(</span><span class="num" id="4321581">1</span><span class="op" id="4321582">&lt;&lt;</span><span class="ident" id="4321584">e</span><span class="op" id="4321585">.</span><span class="ident" id="4321586">litWidth</span>&nbsp;<span class="op" id="4321595">-</span>&nbsp;<span class="num" id="4321597">1</span><span class="op" id="4321598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4321601">code</span>&nbsp;<span class="op" id="4321606">:=</span>&nbsp;<span class="ident" id="4321609">e</span><span class="op" id="4321610">.</span><span class="ident" id="4321611">savedCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321622">if</span>&nbsp;<span class="ident" id="4321625">code</span>&nbsp;<span class="op" id="4321630">==</span>&nbsp;<span class="ident" id="4321633">invalidCode</span>&nbsp;<span class="op" id="4321645">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4321649">//&nbsp;The&nbsp;first&nbsp;code&nbsp;sent&nbsp;is&nbsp;always&nbsp;a&nbsp;literal&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4321700">code</span><span class="op" id="4321704">,</span>&nbsp;<span class="ident" id="4321706">p</span>&nbsp;<span class="op" id="4321708">=</span>&nbsp;<span class="builtintype" id="4321710">uint32</span><span class="op" id="4321716">(</span><span class="ident" id="4321717">p</span><span class="op" id="4321718">[</span><span class="num" id="4321719">0</span><span class="op" id="4321720">]</span><span class="op" id="4321721">)</span><span class="op" id="4321722">&amp;</span><span class="ident" id="4321723">litMask</span><span class="op" id="4321730">,</span>&nbsp;<span class="ident" id="4321732">p</span><span class="op" id="4321733">[</span><span class="num" id="4321734">1</span><span class="op" id="4321735">:</span><span class="op" id="4321736">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4321739">}</span><br>
<span class="lineno"></span><span class="ident" id="4321741">loop</span><span class="op" id="4321745">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321748">for</span>&nbsp;<span class="ident" id="4321752">_</span><span class="op" id="4321753">,</span>&nbsp;<span class="ident" id="4321755">x</span>&nbsp;<span class="op" id="4321757">:=</span>&nbsp;<span class="keyword" id="4321760">range</span>&nbsp;<span class="ident" id="4321766">p</span>&nbsp;<span class="op" id="4321768">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4321772">literal</span>&nbsp;<span class="op" id="4321780">:=</span>&nbsp;<span class="builtintype" id="4321783">uint32</span><span class="op" id="4321789">(</span><span class="ident" id="4321790">x</span><span class="op" id="4321791">)</span>&nbsp;<span class="op" id="4321793">&amp;</span>&nbsp;<span class="ident" id="4321795">litMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4321805">key</span>&nbsp;<span class="op" id="4321809">:=</span>&nbsp;<span class="ident" id="4321812">code</span><span class="op" id="4321816">&lt;&lt;</span><span class="num" id="4321818">8</span>&nbsp;<span class="op" id="4321820">|</span>&nbsp;<span class="ident" id="4321822">literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4321832">//&nbsp;If&nbsp;there&nbsp;is&nbsp;a&nbsp;hash&nbsp;table&nbsp;hit&nbsp;for&nbsp;this&nbsp;key&nbsp;then&nbsp;we&nbsp;continue&nbsp;the&nbsp;loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4321905">//&nbsp;and&nbsp;do&nbsp;not&nbsp;emit&nbsp;a&nbsp;code&nbsp;yet.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4321938">hash</span>&nbsp;<span class="op" id="4321943">:=</span>&nbsp;<span class="op" id="4321946">(</span><span class="ident" id="4321947">key</span><span class="op" id="4321950">&gt;&gt;</span><span class="num" id="4321952">12</span>&nbsp;<span class="op" id="4321955">^</span>&nbsp;<span class="ident" id="4321957">key</span><span class="op" id="4321960">)</span>&nbsp;<span class="op" id="4321962">&amp;</span>&nbsp;<span class="ident" id="4321964">tableMask</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321976">for</span>&nbsp;<span class="ident" id="4321980">h</span><span class="op" id="4321981">,</span>&nbsp;<span class="ident" id="4321983">t</span>&nbsp;<span class="op" id="4321985">:=</span>&nbsp;<span class="ident" id="4321988">hash</span><span class="op" id="4321992">,</span>&nbsp;<span class="ident" id="4321994">e</span><span class="op" id="4321995">.</span><span class="ident" id="4321996">table</span><span class="op" id="4322001">[</span><span class="ident" id="4322002">hash</span><span class="op" id="4322006">]</span><span class="op" id="4322007">;</span>&nbsp;<span class="ident" id="4322009">t</span>&nbsp;<span class="op" id="4322011">!=</span>&nbsp;<span class="ident" id="4322014">invalidEntry</span><span class="op" id="4322026">;</span>&nbsp;<span class="op" id="4322028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4322033">if</span>&nbsp;<span class="ident" id="4322036">key</span>&nbsp;<span class="op" id="4322040">==</span>&nbsp;<span class="ident" id="4322043">t</span><span class="op" id="4322044">&gt;&gt;</span><span class="num" id="4322046">12</span>&nbsp;<span class="op" id="4322049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4322055">code</span>&nbsp;<span class="op" id="4322060">=</span>&nbsp;<span class="ident" id="4322062">t</span>&nbsp;<span class="op" id="4322064">&amp;</span>&nbsp;<span class="ident" id="4322066">maxCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4322078">continue</span>&nbsp;<span class="ident" id="4322087">loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4322095">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4322100">h</span>&nbsp;<span class="op" id="4322102">=</span>&nbsp;<span class="op" id="4322104">(</span><span class="ident" id="4322105">h</span>&nbsp;<span class="op" id="4322107">+</span>&nbsp;<span class="num" id="4322109">1</span><span class="op" id="4322110">)</span>&nbsp;<span class="op" id="4322112">&amp;</span>&nbsp;<span class="ident" id="4322114">tableMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4322127">t</span>&nbsp;<span class="op" id="4322129">=</span>&nbsp;<span class="ident" id="4322131">e</span><span class="op" id="4322132">.</span><span class="ident" id="4322133">table</span><span class="op" id="4322138">[</span><span class="ident" id="4322139">h</span><span class="op" id="4322140">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4322144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4322148">//&nbsp;Otherwise,&nbsp;write&nbsp;the&nbsp;current&nbsp;code,&nbsp;and&nbsp;literal&nbsp;becomes&nbsp;the&nbsp;start&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4322221">//&nbsp;the&nbsp;next&nbsp;emitted&nbsp;code.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4322249">if</span>&nbsp;<span class="ident" id="4322252">e</span><span class="op" id="4322253">.</span><span class="ident" id="4322254">err</span>&nbsp;<span class="op" id="4322258">=</span>&nbsp;<span class="ident" id="4322260">e</span><span class="op" id="4322261">.</span><span class="ident" id="4322262">write</span><span class="op" id="4322267">(</span><span class="ident" id="4322268">e</span><span class="op" id="4322269">,</span>&nbsp;<span class="ident" id="4322271">code</span><span class="op" id="4322275">)</span><span class="op" id="4322276">;</span>&nbsp;<span class="ident" id="4322278">e</span><span class="op" id="4322279">.</span><span class="ident" id="4322280">err</span>&nbsp;<span class="op" id="4322284">!=</span>&nbsp;<span class="ident" id="4322287">nil</span>&nbsp;<span class="op" id="4322291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4322296">return</span>&nbsp;<span class="num" id="4322303">0</span><span class="op" id="4322304">,</span>&nbsp;<span class="ident" id="4322306">e</span><span class="op" id="4322307">.</span><span class="ident" id="4322308">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4322314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4322318">code</span>&nbsp;<span class="op" id="4322323">=</span>&nbsp;<span class="ident" id="4322325">literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4322335">//&nbsp;Increment&nbsp;e.hi,&nbsp;the&nbsp;next&nbsp;implied&nbsp;code.&nbsp;If&nbsp;we&nbsp;run&nbsp;out&nbsp;of&nbsp;codes,&nbsp;reset</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4322409">//&nbsp;the&nbsp;encoder&nbsp;state&nbsp;(including&nbsp;clearing&nbsp;the&nbsp;hash&nbsp;table)&nbsp;and&nbsp;continue.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4322482">if</span>&nbsp;<span class="ident" id="4322485">err1</span>&nbsp;<span class="op" id="4322490">:=</span>&nbsp;<span class="ident" id="4322493">e</span><span class="op" id="4322494">.</span><span class="ident" id="4322495">incHi</span><span class="op" id="4322500">(</span><span class="op" id="4322501">)</span><span class="op" id="4322502">;</span>&nbsp;<span class="ident" id="4322504">err1</span>&nbsp;<span class="op" id="4322509">!=</span>&nbsp;<span class="ident" id="4322512">nil</span>&nbsp;<span class="op" id="4322516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4322521">if</span>&nbsp;<span class="ident" id="4322524">err1</span>&nbsp;<span class="op" id="4322529">==</span>&nbsp;<span class="ident" id="4322532">errOutOfCodes</span>&nbsp;<span class="op" id="4322546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4322552">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4322564">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4322569">e</span><span class="op" id="4322570">.</span><span class="ident" id="4322571">err</span>&nbsp;<span class="op" id="4322575">=</span>&nbsp;<span class="ident" id="4322577">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4322585">return</span>&nbsp;<span class="num" id="4322592">0</span><span class="op" id="4322593">,</span>&nbsp;<span class="ident" id="4322595">e</span><span class="op" id="4322596">.</span><span class="ident" id="4322597">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4322603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4322607">//&nbsp;Otherwise,&nbsp;insert&nbsp;key&nbsp;-&gt;&nbsp;e.hi&nbsp;into&nbsp;the&nbsp;map&nbsp;that&nbsp;e.table&nbsp;represents.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4322680">for</span>&nbsp;<span class="op" id="4322684">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4322689">if</span>&nbsp;<span class="ident" id="4322692">e</span><span class="op" id="4322693">.</span><span class="ident" id="4322694">table</span><span class="op" id="4322699">[</span><span class="ident" id="4322700">hash</span><span class="op" id="4322704">]</span>&nbsp;<span class="op" id="4322706">==</span>&nbsp;<span class="ident" id="4322709">invalidEntry</span>&nbsp;<span class="op" id="4322722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4322728">e</span><span class="op" id="4322729">.</span><span class="ident" id="4322730">table</span><span class="op" id="4322735">[</span><span class="ident" id="4322736">hash</span><span class="op" id="4322740">]</span>&nbsp;<span class="op" id="4322742">=</span>&nbsp;<span class="op" id="4322744">(</span><span class="ident" id="4322745">key</span>&nbsp;<span class="op" id="4322749">&lt;&lt;</span>&nbsp;<span class="num" id="4322752">12</span><span class="op" id="4322754">)</span>&nbsp;<span class="op" id="4322756">|</span>&nbsp;<span class="ident" id="4322758">e</span><span class="op" id="4322759">.</span><span class="ident" id="4322760">hi</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4322767">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4322776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4322781">hash</span>&nbsp;<span class="op" id="4322786">=</span>&nbsp;<span class="op" id="4322788">(</span><span class="ident" id="4322789">hash</span>&nbsp;<span class="op" id="4322794">+</span>&nbsp;<span class="num" id="4322796">1</span><span class="op" id="4322797">)</span>&nbsp;<span class="op" id="4322799">&amp;</span>&nbsp;<span class="ident" id="4322801">tableMask</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4322813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4322816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4322819">e</span><span class="op" id="4322820">.</span><span class="ident" id="4322821">savedCode</span>&nbsp;<span class="op" id="4322831">=</span>&nbsp;<span class="ident" id="4322833">code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4322839">return</span>&nbsp;<span class="ident" id="4322846">n</span><span class="op" id="4322847">,</span>&nbsp;<span class="ident" id="4322849">nil</span><br>
<span class="lineno"></span><span class="op" id="4322853">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="4322856">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;encoder,&nbsp;flushing&nbsp;any&nbsp;pending&nbsp;output.&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="4322935">//&nbsp;flush&nbsp;e&#39;s&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4322967">func</span>&nbsp;<span class="op" id="4322972">(</span><span class="ident" id="4322973">e</span>&nbsp;<span class="op" id="4322975">*</span><span class="ident" id="4322976">encoder</span><span class="op" id="4322983">)</span>&nbsp;<span class="ident" id="4322985">Close</span><span class="op" id="4322990">(</span><span class="op" id="4322991">)</span>&nbsp;<span class="builtintype" id="4322993">error</span>&nbsp;<span class="op" id="4322999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4323002">if</span>&nbsp;<span class="ident" id="4323005">e</span><span class="op" id="4323006">.</span><span class="ident" id="4323007">err</span>&nbsp;<span class="op" id="4323011">!=</span>&nbsp;<span class="ident" id="4323014">nil</span>&nbsp;<span class="op" id="4323018">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4323022">if</span>&nbsp;<span class="ident" id="4323025">e</span><span class="op" id="4323026">.</span><span class="ident" id="4323027">err</span>&nbsp;<span class="op" id="4323031">==</span>&nbsp;<span class="ident" id="4323034">errClosed</span>&nbsp;<span class="op" id="4323044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4323049">return</span>&nbsp;<span class="ident" id="4323056">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4323062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4323066">return</span>&nbsp;<span class="ident" id="4323073">e</span><span class="op" id="4323074">.</span><span class="ident" id="4323075">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4323080">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4323083">//&nbsp;Make&nbsp;any&nbsp;future&nbsp;calls&nbsp;to&nbsp;Write&nbsp;return&nbsp;errClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4323136">e</span><span class="op" id="4323137">.</span><span class="ident" id="4323138">err</span>&nbsp;<span class="op" id="4323142">=</span>&nbsp;<span class="ident" id="4323144">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4323155">//&nbsp;Write&nbsp;the&nbsp;savedCode&nbsp;if&nbsp;valid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4323189">if</span>&nbsp;<span class="ident" id="4323192">e</span><span class="op" id="4323193">.</span><span class="ident" id="4323194">savedCode</span>&nbsp;<span class="op" id="4323204">!=</span>&nbsp;<span class="ident" id="4323207">invalidCode</span>&nbsp;<span class="op" id="4323219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4323223">if</span>&nbsp;<span class="ident" id="4323226">err</span>&nbsp;<span class="op" id="4323230">:=</span>&nbsp;<span class="ident" id="4323233">e</span><span class="op" id="4323234">.</span><span class="ident" id="4323235">write</span><span class="op" id="4323240">(</span><span class="ident" id="4323241">e</span><span class="op" id="4323242">,</span>&nbsp;<span class="ident" id="4323244">e</span><span class="op" id="4323245">.</span><span class="ident" id="4323246">savedCode</span><span class="op" id="4323255">)</span><span class="op" id="4323256">;</span>&nbsp;<span class="ident" id="4323258">err</span>&nbsp;<span class="op" id="4323262">!=</span>&nbsp;<span class="ident" id="4323265">nil</span>&nbsp;<span class="op" id="4323269">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4323274">return</span>&nbsp;<span class="ident" id="4323281">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4323287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4323291">if</span>&nbsp;<span class="ident" id="4323294">err</span>&nbsp;<span class="op" id="4323298">:=</span>&nbsp;<span class="ident" id="4323301">e</span><span class="op" id="4323302">.</span><span class="ident" id="4323303">incHi</span><span class="op" id="4323308">(</span><span class="op" id="4323309">)</span><span class="op" id="4323310">;</span>&nbsp;<span class="ident" id="4323312">err</span>&nbsp;<span class="op" id="4323316">!=</span>&nbsp;<span class="ident" id="4323319">nil</span>&nbsp;<span class="op" id="4323323">&amp;&amp;</span>&nbsp;<span class="ident" id="4323326">err</span>&nbsp;<span class="op" id="4323330">!=</span>&nbsp;<span class="ident" id="4323333">errOutOfCodes</span>&nbsp;<span class="op" id="4323347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4323352">return</span>&nbsp;<span class="ident" id="4323359">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4323365">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4323368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4323371">//&nbsp;Write&nbsp;the&nbsp;eof&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4323395">eof</span>&nbsp;<span class="op" id="4323399">:=</span>&nbsp;<span class="builtintype" id="4323402">uint32</span><span class="op" id="4323408">(</span><span class="num" id="4323409">1</span><span class="op" id="4323410">)</span><span class="op" id="4323411">&lt;&lt;</span><span class="ident" id="4323413">e</span><span class="op" id="4323414">.</span><span class="ident" id="4323415">litWidth</span>&nbsp;<span class="op" id="4323424">+</span>&nbsp;<span class="num" id="4323426">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4323429">if</span>&nbsp;<span class="ident" id="4323432">err</span>&nbsp;<span class="op" id="4323436">:=</span>&nbsp;<span class="ident" id="4323439">e</span><span class="op" id="4323440">.</span><span class="ident" id="4323441">write</span><span class="op" id="4323446">(</span><span class="ident" id="4323447">e</span><span class="op" id="4323448">,</span>&nbsp;<span class="ident" id="4323450">eof</span><span class="op" id="4323453">)</span><span class="op" id="4323454">;</span>&nbsp;<span class="ident" id="4323456">err</span>&nbsp;<span class="op" id="4323460">!=</span>&nbsp;<span class="ident" id="4323463">nil</span>&nbsp;<span class="op" id="4323467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4323471">return</span>&nbsp;<span class="ident" id="4323478">err</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4323483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4323486">//&nbsp;Write&nbsp;the&nbsp;final&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4323512">if</span>&nbsp;<span class="ident" id="4323515">e</span><span class="op" id="4323516">.</span><span class="ident" id="4323517">nBits</span>&nbsp;<span class="op" id="4323523">&gt;</span>&nbsp;<span class="num" id="4323525">0</span>&nbsp;<span class="op" id="4323527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4323531">if</span>&nbsp;<span class="ident" id="4323534">e</span><span class="op" id="4323535">.</span><span class="ident" id="4323536">order</span>&nbsp;<span class="op" id="4323542">==</span>&nbsp;<span class="ident" id="4323545">MSB</span>&nbsp;<span class="op" id="4323549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4323554">e</span><span class="op" id="4323555">.</span><span class="ident" id="4323556">bits</span>&nbsp;<span class="op" id="4323561">&gt;&gt;=</span>&nbsp;<span class="num" id="4323565">24</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4323570">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4323574">if</span>&nbsp;<span class="ident" id="4323577">err</span>&nbsp;<span class="op" id="4323581">:=</span>&nbsp;<span class="ident" id="4323584">e</span><span class="op" id="4323585">.</span><span class="ident" id="4323586">w</span><span class="op" id="4323587">.</span><span class="ident" id="4323588">WriteByte</span><span class="op" id="4323597">(</span><span class="builtintype" id="4323598">uint8</span><span class="op" id="4323603">(</span><span class="ident" id="4323604">e</span><span class="op" id="4323605">.</span><span class="ident" id="4323606">bits</span><span class="op" id="4323610">)</span><span class="op" id="4323611">)</span><span class="op" id="4323612">;</span>&nbsp;<span class="ident" id="4323614">err</span>&nbsp;<span class="op" id="4323618">!=</span>&nbsp;<span class="ident" id="4323621">nil</span>&nbsp;<span class="op" id="4323625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4323630">return</span>&nbsp;<span class="ident" id="4323637">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4323643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4323646">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4323649">return</span>&nbsp;<span class="ident" id="4323656">e</span><span class="op" id="4323657">.</span><span class="ident" id="4323658">w</span><span class="op" id="4323659">.</span><span class="ident" id="4323660">Flush</span><span class="op" id="4323665">(</span><span class="op" id="4323666">)</span><br>
<span class="lineno"></span><span class="op" id="4323668">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4323671">//&nbsp;NewWriter&nbsp;creates&nbsp;a&nbsp;new&nbsp;io.WriteCloser.</span><br>
<span class="lineno"></span><span class="comment" id="4323714">//&nbsp;Writes&nbsp;to&nbsp;the&nbsp;returned&nbsp;io.WriteCloser&nbsp;are&nbsp;compressed&nbsp;and&nbsp;written&nbsp;to&nbsp;w.</span><br>
<span class="lineno">230</span><span class="comment" id="4323788">//&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;call&nbsp;Close&nbsp;on&nbsp;the&nbsp;WriteCloser&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="4323863">//&nbsp;finished&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="4323884">//&nbsp;The&nbsp;number&nbsp;of&nbsp;bits&nbsp;to&nbsp;use&nbsp;for&nbsp;literal&nbsp;codes,&nbsp;litWidth,&nbsp;must&nbsp;be&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4323957">//&nbsp;range&nbsp;[2,8]&nbsp;and&nbsp;is&nbsp;typically&nbsp;8.</span><br>
<span class="lineno"></span><span class="keyword" id="4323992">func</span>&nbsp;<span class="ident" id="4323997">NewWriter</span><span class="op" id="4324006">(</span><span class="ident" id="4324007">w</span>&nbsp;<span class="ident" id="4324009">io</span><span class="op" id="4324011">.</span><span class="ident" id="4324012">Writer</span><span class="op" id="4324018">,</span>&nbsp;<span class="ident" id="4324020">order</span>&nbsp;<span class="ident" id="4324026">Order</span><span class="op" id="4324031">,</span>&nbsp;<span class="ident" id="4324033">litWidth</span>&nbsp;<span class="builtintype" id="4324042">int</span><span class="op" id="4324045">)</span>&nbsp;<span class="ident" id="4324047">io</span><span class="op" id="4324049">.</span><span class="ident" id="4324050">WriteCloser</span>&nbsp;<span class="op" id="4324062">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4324065">var</span>&nbsp;<span class="ident" id="4324069">write</span>&nbsp;<span class="keyword" id="4324075">func</span><span class="op" id="4324079">(</span><span class="op" id="4324080">*</span><span class="ident" id="4324081">encoder</span><span class="op" id="4324088">,</span>&nbsp;<span class="builtintype" id="4324090">uint32</span><span class="op" id="4324096">)</span>&nbsp;<span class="builtintype" id="4324098">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4324105">switch</span>&nbsp;<span class="ident" id="4324112">order</span>&nbsp;<span class="op" id="4324118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4324121">case</span>&nbsp;<span class="ident" id="4324126">LSB</span><span class="op" id="4324129">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4324133">write</span>&nbsp;<span class="op" id="4324139">=</span>&nbsp;<span class="op" id="4324141">(</span><span class="op" id="4324142">*</span><span class="ident" id="4324143">encoder</span><span class="op" id="4324150">)</span><span class="op" id="4324151">.</span><span class="ident" id="4324152">writeLSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4324162">case</span>&nbsp;<span class="ident" id="4324167">MSB</span><span class="op" id="4324170">:</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4324174">write</span>&nbsp;<span class="op" id="4324180">=</span>&nbsp;<span class="op" id="4324182">(</span><span class="op" id="4324183">*</span><span class="ident" id="4324184">encoder</span><span class="op" id="4324191">)</span><span class="op" id="4324192">.</span><span class="ident" id="4324193">writeMSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4324203">default</span><span class="op" id="4324210">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4324214">return</span>&nbsp;<span class="op" id="4324221">&amp;</span><span class="ident" id="4324222">errWriteCloser</span><span class="op" id="4324236">{</span><span class="ident" id="4324237">errors</span><span class="op" id="4324243">.</span><span class="ident" id="4324244">New</span><span class="op" id="4324247">(</span><span class="string" id="4324248">&#34;lzw:&nbsp;unknown&nbsp;order&#34;</span><span class="op" id="4324268">)</span><span class="op" id="4324269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4324272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4324275">if</span>&nbsp;<span class="ident" id="4324278">litWidth</span>&nbsp;<span class="op" id="4324287">&lt;</span>&nbsp;<span class="num" id="4324289">2</span>&nbsp;<span class="op" id="4324291">||</span>&nbsp;<span class="num" id="4324294">8</span>&nbsp;<span class="op" id="4324296">&lt;</span>&nbsp;<span class="ident" id="4324298">litWidth</span>&nbsp;<span class="op" id="4324307">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4324311">return</span>&nbsp;<span class="op" id="4324318">&amp;</span><span class="ident" id="4324319">errWriteCloser</span><span class="op" id="4324333">{</span><span class="ident" id="4324334">fmt</span><span class="op" id="4324337">.</span><span class="ident" id="4324338">Errorf</span><span class="op" id="4324344">(</span><span class="string" id="4324345">&#34;lzw:&nbsp;litWidth&nbsp;%d&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="4324376">,</span>&nbsp;<span class="ident" id="4324378">litWidth</span><span class="op" id="4324386">)</span><span class="op" id="4324387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4324390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4324393">bw</span><span class="op" id="4324395">,</span>&nbsp;<span class="ident" id="4324397">ok</span>&nbsp;<span class="op" id="4324400">:=</span>&nbsp;<span class="ident" id="4324403">w</span><span class="op" id="4324404">.</span><span class="op" id="4324405">(</span><span class="ident" id="4324406">writer</span><span class="op" id="4324412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4324415">if</span>&nbsp;<span class="op" id="4324418">!</span><span class="ident" id="4324419">ok</span>&nbsp;<span class="op" id="4324422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4324426">bw</span>&nbsp;<span class="op" id="4324429">=</span>&nbsp;<span class="ident" id="4324431">bufio</span><span class="op" id="4324436">.</span><span class="ident" id="4324437">NewWriter</span><span class="op" id="4324446">(</span><span class="ident" id="4324447">w</span><span class="op" id="4324448">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4324451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4324454">lw</span>&nbsp;<span class="op" id="4324457">:=</span>&nbsp;<span class="builtintype" id="4324460">uint</span><span class="op" id="4324464">(</span><span class="ident" id="4324465">litWidth</span><span class="op" id="4324473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4324476">return</span>&nbsp;<span class="op" id="4324483">&amp;</span><span class="ident" id="4324484">encoder</span><span class="op" id="4324491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4324495">w</span><span class="op" id="4324496">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4324506">bw</span><span class="op" id="4324508">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4324512">order</span><span class="op" id="4324517">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4324523">order</span><span class="op" id="4324528">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4324532">write</span><span class="op" id="4324537">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4324543">write</span><span class="op" id="4324548">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4324552">width</span><span class="op" id="4324557">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="4324563">1</span>&nbsp;<span class="op" id="4324565">+</span>&nbsp;<span class="ident" id="4324567">lw</span><span class="op" id="4324569">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4324573">litWidth</span><span class="op" id="4324581">:</span>&nbsp;&nbsp;<span class="ident" id="4324584">lw</span><span class="op" id="4324586">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4324590">hi</span><span class="op" id="4324592">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="4324601">1</span><span class="op" id="4324602">&lt;&lt;</span><span class="ident" id="4324604">lw</span>&nbsp;<span class="op" id="4324607">+</span>&nbsp;<span class="num" id="4324609">1</span><span class="op" id="4324610">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4324614">overflow</span><span class="op" id="4324622">:</span>&nbsp;&nbsp;<span class="num" id="4324625">1</span>&nbsp;<span class="op" id="4324627">&lt;&lt;</span>&nbsp;<span class="op" id="4324630">(</span><span class="ident" id="4324631">lw</span>&nbsp;<span class="op" id="4324634">+</span>&nbsp;<span class="num" id="4324636">1</span><span class="op" id="4324637">)</span><span class="op" id="4324638">,</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4324642">savedCode</span><span class="op" id="4324651">:</span>&nbsp;<span class="ident" id="4324653">invalidCode</span><span class="op" id="4324664">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4324667">}</span><br>
<span class="lineno"></span><span class="op" id="4324669">}</span>
</div>
</body>
</html>
