<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html" class="current">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1580856">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1580911">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1580965">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1581016">//&nbsp;+build&nbsp;dragonfly&nbsp;freebsd&nbsp;linux</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1581051">package</span>&nbsp;<span class="ident" id="1581059">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1581068">import</span>&nbsp;<span class="string" id="1581075">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="1581085">//&nbsp;This&nbsp;implementation&nbsp;depends&nbsp;on&nbsp;OS-specific&nbsp;implementations&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1581150">//</span><br>
<span class="lineno"></span><span class="comment" id="1581153">//&nbsp;&nbsp;&nbsp;&nbspruntime路futexsleep(uint32&nbsp;*addr,&nbsp;uint32&nbsp;val,&nbsp;int64&nbsp;ns)</span><br>
<span class="lineno"></span><span class="comment" id="1581212">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspAtomically,</span><br>
<span class="lineno">15</span><span class="comment" id="1581228">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif(*addr&nbsp;==&nbsp;val)&nbsp;sleep</span><br>
<span class="lineno"></span><span class="comment" id="1581256">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspMight&nbsp;be&nbsp;woken&nbsp;up&nbsp;spuriously;&nbsp;that&#39;s&nbsp;allowed.</span><br>
<span class="lineno"></span><span class="comment" id="1581306">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspDon&#39;t&nbsp;sleep&nbsp;longer&nbsp;than&nbsp;ns;&nbsp;ns&nbsp;&lt;&nbsp;0&nbsp;means&nbsp;forever.</span><br>
<span class="lineno"></span><span class="comment" id="1581360">//</span><br>
<span class="lineno"></span><span class="comment" id="1581363">//&nbsp;&nbsp;&nbsp;&nbspruntime路futexwakeup(uint32&nbsp;*addr,&nbsp;uint32&nbsp;cnt)</span><br>
<span class="lineno">20</span><span class="comment" id="1581413">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspIf&nbsp;any&nbsp;procs&nbsp;are&nbsp;sleeping&nbsp;on&nbsp;addr,&nbsp;wake&nbsp;up&nbsp;at&nbsp;most&nbsp;cnt.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1581474">const</span>&nbsp;<span class="op" id="1581480">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581483">mutex_unlocked</span>&nbsp;<span class="op" id="1581498">=</span>&nbsp;<span class="num" id="1581500">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581503">mutex_locked</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1581518">=</span>&nbsp;<span class="num" id="1581520">1</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581523">mutex_sleeping</span>&nbsp;<span class="op" id="1581538">=</span>&nbsp;<span class="num" id="1581540">2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581544">active_spin</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1581560">=</span>&nbsp;<span class="num" id="1581562">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581565">active_spin_cnt</span>&nbsp;<span class="op" id="1581581">=</span>&nbsp;<span class="num" id="1581583">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581587">passive_spin</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1581603">=</span>&nbsp;<span class="num" id="1581605">1</span><br>
<span class="lineno">30</span><span class="op" id="1581607">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1581610">//&nbsp;Possible&nbsp;lock&nbsp;states&nbsp;are&nbsp;mutex_unlocked,&nbsp;mutex_locked&nbsp;and&nbsp;mutex_sleeping.</span><br>
<span class="lineno"></span><span class="comment" id="1581687">//&nbsp;mutex_sleeping&nbsp;means&nbsp;that&nbsp;there&nbsp;is&nbsp;presumably&nbsp;at&nbsp;least&nbsp;one&nbsp;sleeping&nbsp;thread.</span><br>
<span class="lineno"></span><span class="comment" id="1581766">//&nbsp;Note&nbsp;that&nbsp;there&nbsp;can&nbsp;be&nbsp;spinning&nbsp;threads&nbsp;during&nbsp;all&nbsp;states&nbsp;-&nbsp;they&nbsp;do&nbsp;not</span><br>
<span class="lineno">35</span><span class="comment" id="1581841">//&nbsp;affect&nbsp;mutex&#39;s&nbsp;state.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1581867">func</span>&nbsp;<span class="ident" id="1581872">futexsleep</span><span class="op" id="1581882">(</span><span class="ident" id="1581883">addr</span>&nbsp;<span class="op" id="1581888">*</span><span class="builtintype" id="1581889">uint32</span><span class="op" id="1581895">,</span>&nbsp;<span class="ident" id="1581897">val</span>&nbsp;<span class="builtintype" id="1581901">uint32</span><span class="op" id="1581907">,</span>&nbsp;<span class="ident" id="1581909">ns</span>&nbsp;<span class="ident" id="1581912">int64</span><span class="op" id="1581917">)</span><br>
<span class="lineno"></span><span class="keyword" id="1581919">func</span>&nbsp;<span class="ident" id="1581924">futexwakeup</span><span class="op" id="1581935">(</span><span class="ident" id="1581936">addr</span>&nbsp;<span class="op" id="1581941">*</span><span class="builtintype" id="1581942">uint32</span><span class="op" id="1581948">,</span>&nbsp;<span class="ident" id="1581950">cnt</span>&nbsp;<span class="builtintype" id="1581954">uint32</span><span class="op" id="1581960">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="1581963">//&nbsp;We&nbsp;use&nbsp;the&nbsp;uintptr&nbsp;mutex.key&nbsp;and&nbsp;note.key&nbsp;as&nbsp;a&nbsp;uint32.</span><br>
<span class="lineno"></span><span class="keyword" id="1582021">func</span>&nbsp;<span class="ident" id="1582026">key32</span><span class="op" id="1582031">(</span><span class="ident" id="1582032">p</span>&nbsp;<span class="op" id="1582034">*</span><span class="builtintype" id="1582035">uintptr</span><span class="op" id="1582042">)</span>&nbsp;<span class="op" id="1582044">*</span><span class="builtintype" id="1582045">uint32</span>&nbsp;<span class="op" id="1582052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1582055">return</span>&nbsp;<span class="op" id="1582062">(</span><span class="op" id="1582063">*</span><span class="builtintype" id="1582064">uint32</span><span class="op" id="1582070">)</span><span class="op" id="1582071">(</span><span class="ident" id="1582072">unsafe</span><span class="op" id="1582078">.</span><span class="ident" id="1582079">Pointer</span><span class="op" id="1582086">(</span><span class="ident" id="1582087">p</span><span class="op" id="1582088">)</span><span class="op" id="1582089">)</span><br>
<span class="lineno"></span><span class="op" id="1582091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="1582094">func</span>&nbsp;<span class="ident" id="1582099">lock</span><span class="op" id="1582103">(</span><span class="ident" id="1582104">l</span>&nbsp;<span class="op" id="1582106">*</span><span class="ident" id="1582107">mutex</span><span class="op" id="1582112">)</span>&nbsp;<span class="op" id="1582114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582117">gp</span>&nbsp;<span class="op" id="1582120">:=</span>&nbsp;<span class="ident" id="1582123">getg</span><span class="op" id="1582127">(</span><span class="op" id="1582128">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1582132">if</span>&nbsp;<span class="ident" id="1582135">gp</span><span class="op" id="1582137">.</span><span class="ident" id="1582138">m</span><span class="op" id="1582139">.</span><span class="ident" id="1582140">locks</span>&nbsp;<span class="op" id="1582146">&lt;</span>&nbsp;<span class="num" id="1582148">0</span>&nbsp;<span class="op" id="1582150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582154">gothrow</span><span class="op" id="1582161">(</span><span class="string" id="1582162">&#34;runtime路lock:&nbsp;lock&nbsp;count&#34;</span><span class="op" id="1582189">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1582192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582195">gp</span><span class="op" id="1582197">.</span><span class="ident" id="1582198">m</span><span class="op" id="1582199">.</span><span class="ident" id="1582200">locks</span><span class="op" id="1582205">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1582210">//&nbsp;Speculative&nbsp;grab&nbsp;for&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582241">v</span>&nbsp;<span class="op" id="1582243">:=</span>&nbsp;<span class="ident" id="1582246">xchg</span><span class="op" id="1582250">(</span><span class="ident" id="1582251">key32</span><span class="op" id="1582256">(</span><span class="op" id="1582257">&amp;</span><span class="ident" id="1582258">l</span><span class="op" id="1582259">.</span><span class="ident" id="1582260">key</span><span class="op" id="1582263">)</span><span class="op" id="1582264">,</span>&nbsp;<span class="ident" id="1582266">mutex_locked</span><span class="op" id="1582278">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1582281">if</span>&nbsp;<span class="ident" id="1582284">v</span>&nbsp;<span class="op" id="1582286">==</span>&nbsp;<span class="ident" id="1582289">mutex_unlocked</span>&nbsp;<span class="op" id="1582304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1582308">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1582316">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1582320">//&nbsp;wait&nbsp;is&nbsp;either&nbsp;MUTEX_LOCKED&nbsp;or&nbsp;MUTEX_SLEEPING</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1582370">//&nbsp;depending&nbsp;on&nbsp;whether&nbsp;there&nbsp;is&nbsp;a&nbsp;thread&nbsp;sleeping</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1582422">//&nbsp;on&nbsp;this&nbsp;mutex.&nbsp;&nbsp;If&nbsp;we&nbsp;ever&nbsp;change&nbsp;l-&gt;key&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1582472">//&nbsp;MUTEX_SLEEPING&nbsp;to&nbsp;some&nbsp;other&nbsp;value,&nbsp;we&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1582523">//&nbsp;careful&nbsp;to&nbsp;change&nbsp;it&nbsp;back&nbsp;to&nbsp;MUTEX_SLEEPING&nbsp;before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1582578">//&nbsp;returning,&nbsp;to&nbsp;ensure&nbsp;that&nbsp;the&nbsp;sleeping&nbsp;thread&nbsp;gets</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1582633">//&nbsp;its&nbsp;wakeup&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582654">wait</span>&nbsp;<span class="op" id="1582659">:=</span>&nbsp;<span class="ident" id="1582662">v</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1582666">//&nbsp;On&nbsp;uniprocessors,&nbsp;no&nbsp;point&nbsp;spinning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1582707">//&nbsp;On&nbsp;multiprocessors,&nbsp;spin&nbsp;for&nbsp;ACTIVE_SPIN&nbsp;attempts.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582762">spin</span>&nbsp;<span class="op" id="1582767">:=</span>&nbsp;<span class="num" id="1582770">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1582773">if</span>&nbsp;<span class="ident" id="1582776">ncpu</span>&nbsp;<span class="op" id="1582781">&gt;</span>&nbsp;<span class="num" id="1582783">1</span>&nbsp;<span class="op" id="1582785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582789">spin</span>&nbsp;<span class="op" id="1582794">=</span>&nbsp;<span class="ident" id="1582796">active_spin</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1582809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1582812">for</span>&nbsp;<span class="op" id="1582816">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1582820">//&nbsp;Try&nbsp;for&nbsp;lock,&nbsp;spinning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1582849">for</span>&nbsp;<span class="ident" id="1582853">i</span>&nbsp;<span class="op" id="1582855">:=</span>&nbsp;<span class="num" id="1582858">0</span><span class="op" id="1582859">;</span>&nbsp;<span class="ident" id="1582861">i</span>&nbsp;<span class="op" id="1582863">&lt;</span>&nbsp;<span class="ident" id="1582865">spin</span><span class="op" id="1582869">;</span>&nbsp;<span class="ident" id="1582871">i</span><span class="op" id="1582872">++</span>&nbsp;<span class="op" id="1582875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1582880">for</span>&nbsp;<span class="ident" id="1582884">l</span><span class="op" id="1582885">.</span><span class="ident" id="1582886">key</span>&nbsp;<span class="op" id="1582890">==</span>&nbsp;<span class="ident" id="1582893">mutex_unlocked</span>&nbsp;<span class="op" id="1582908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1582914">if</span>&nbsp;<span class="ident" id="1582917">cas</span><span class="op" id="1582920">(</span><span class="ident" id="1582921">key32</span><span class="op" id="1582926">(</span><span class="op" id="1582927">&amp;</span><span class="ident" id="1582928">l</span><span class="op" id="1582929">.</span><span class="ident" id="1582930">key</span><span class="op" id="1582933">)</span><span class="op" id="1582934">,</span>&nbsp;<span class="ident" id="1582936">mutex_unlocked</span><span class="op" id="1582950">,</span>&nbsp;<span class="ident" id="1582952">wait</span><span class="op" id="1582956">)</span>&nbsp;<span class="op" id="1582958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1582965">return</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1582976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1582981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582986">procyield</span><span class="op" id="1582995">(</span><span class="ident" id="1582996">active_spin_cnt</span><span class="op" id="1583011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1583015">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1583020">//&nbsp;Try&nbsp;for&nbsp;lock,&nbsp;rescheduling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583053">for</span>&nbsp;<span class="ident" id="1583057">i</span>&nbsp;<span class="op" id="1583059">:=</span>&nbsp;<span class="num" id="1583062">0</span><span class="op" id="1583063">;</span>&nbsp;<span class="ident" id="1583065">i</span>&nbsp;<span class="op" id="1583067">&lt;</span>&nbsp;<span class="ident" id="1583069">passive_spin</span><span class="op" id="1583081">;</span>&nbsp;<span class="ident" id="1583083">i</span><span class="op" id="1583084">++</span>&nbsp;<span class="op" id="1583087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583092">for</span>&nbsp;<span class="ident" id="1583096">l</span><span class="op" id="1583097">.</span><span class="ident" id="1583098">key</span>&nbsp;<span class="op" id="1583102">==</span>&nbsp;<span class="ident" id="1583105">mutex_unlocked</span>&nbsp;<span class="op" id="1583120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583126">if</span>&nbsp;<span class="ident" id="1583129">cas</span><span class="op" id="1583132">(</span><span class="ident" id="1583133">key32</span><span class="op" id="1583138">(</span><span class="op" id="1583139">&amp;</span><span class="ident" id="1583140">l</span><span class="op" id="1583141">.</span><span class="ident" id="1583142">key</span><span class="op" id="1583145">)</span><span class="op" id="1583146">,</span>&nbsp;<span class="ident" id="1583148">mutex_unlocked</span><span class="op" id="1583162">,</span>&nbsp;<span class="ident" id="1583164">wait</span><span class="op" id="1583168">)</span>&nbsp;<span class="op" id="1583170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583177">return</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1583188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1583193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583198">osyield</span><span class="op" id="1583205">(</span><span class="op" id="1583206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1583210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1583215">//&nbsp;Sleep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583227">v</span>&nbsp;<span class="op" id="1583229">=</span>&nbsp;<span class="ident" id="1583231">xchg</span><span class="op" id="1583235">(</span><span class="ident" id="1583236">key32</span><span class="op" id="1583241">(</span><span class="op" id="1583242">&amp;</span><span class="ident" id="1583243">l</span><span class="op" id="1583244">.</span><span class="ident" id="1583245">key</span><span class="op" id="1583248">)</span><span class="op" id="1583249">,</span>&nbsp;<span class="ident" id="1583251">mutex_sleeping</span><span class="op" id="1583265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583269">if</span>&nbsp;<span class="ident" id="1583272">v</span>&nbsp;<span class="op" id="1583274">==</span>&nbsp;<span class="ident" id="1583277">mutex_unlocked</span>&nbsp;<span class="op" id="1583292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583297">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1583306">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583310">wait</span>&nbsp;<span class="op" id="1583315">=</span>&nbsp;<span class="ident" id="1583317">mutex_sleeping</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583334">futexsleep</span><span class="op" id="1583344">(</span><span class="ident" id="1583345">key32</span><span class="op" id="1583350">(</span><span class="op" id="1583351">&amp;</span><span class="ident" id="1583352">l</span><span class="op" id="1583353">.</span><span class="ident" id="1583354">key</span><span class="op" id="1583357">)</span><span class="op" id="1583358">,</span>&nbsp;<span class="ident" id="1583360">mutex_sleeping</span><span class="op" id="1583374">,</span>&nbsp;<span class="op" id="1583376">-</span><span class="num" id="1583377">1</span><span class="op" id="1583378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1583381">}</span><br>
<span class="lineno"></span><span class="op" id="1583383">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="1583386">func</span>&nbsp;<span class="ident" id="1583391">unlock</span><span class="op" id="1583397">(</span><span class="ident" id="1583398">l</span>&nbsp;<span class="op" id="1583400">*</span><span class="ident" id="1583401">mutex</span><span class="op" id="1583406">)</span>&nbsp;<span class="op" id="1583408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583411">v</span>&nbsp;<span class="op" id="1583413">:=</span>&nbsp;<span class="ident" id="1583416">xchg</span><span class="op" id="1583420">(</span><span class="ident" id="1583421">key32</span><span class="op" id="1583426">(</span><span class="op" id="1583427">&amp;</span><span class="ident" id="1583428">l</span><span class="op" id="1583429">.</span><span class="ident" id="1583430">key</span><span class="op" id="1583433">)</span><span class="op" id="1583434">,</span>&nbsp;<span class="ident" id="1583436">mutex_unlocked</span><span class="op" id="1583450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583453">if</span>&nbsp;<span class="ident" id="1583456">v</span>&nbsp;<span class="op" id="1583458">==</span>&nbsp;<span class="ident" id="1583461">mutex_unlocked</span>&nbsp;<span class="op" id="1583476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583480">gothrow</span><span class="op" id="1583487">(</span><span class="string" id="1583488">&#34;unlock&nbsp;of&nbsp;unlocked&nbsp;lock&#34;</span><span class="op" id="1583513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1583516">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583519">if</span>&nbsp;<span class="ident" id="1583522">v</span>&nbsp;<span class="op" id="1583524">==</span>&nbsp;<span class="ident" id="1583527">mutex_sleeping</span>&nbsp;<span class="op" id="1583542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583546">futexwakeup</span><span class="op" id="1583557">(</span><span class="ident" id="1583558">key32</span><span class="op" id="1583563">(</span><span class="op" id="1583564">&amp;</span><span class="ident" id="1583565">l</span><span class="op" id="1583566">.</span><span class="ident" id="1583567">key</span><span class="op" id="1583570">)</span><span class="op" id="1583571">,</span>&nbsp;<span class="num" id="1583573">1</span><span class="op" id="1583574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1583577">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583581">gp</span>&nbsp;<span class="op" id="1583584">:=</span>&nbsp;<span class="ident" id="1583587">getg</span><span class="op" id="1583591">(</span><span class="op" id="1583592">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583595">gp</span><span class="op" id="1583597">.</span><span class="ident" id="1583598">m</span><span class="op" id="1583599">.</span><span class="ident" id="1583600">locks</span><span class="op" id="1583605">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583609">if</span>&nbsp;<span class="ident" id="1583612">gp</span><span class="op" id="1583614">.</span><span class="ident" id="1583615">m</span><span class="op" id="1583616">.</span><span class="ident" id="1583617">locks</span>&nbsp;<span class="op" id="1583623">&lt;</span>&nbsp;<span class="num" id="1583625">0</span>&nbsp;<span class="op" id="1583627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583631">gothrow</span><span class="op" id="1583638">(</span><span class="string" id="1583639">&#34;runtime路unlock:&nbsp;lock&nbsp;count&#34;</span><span class="op" id="1583668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1583671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583674">if</span>&nbsp;<span class="ident" id="1583677">gp</span><span class="op" id="1583679">.</span><span class="ident" id="1583680">m</span><span class="op" id="1583681">.</span><span class="ident" id="1583682">locks</span>&nbsp;<span class="op" id="1583688">==</span>&nbsp;<span class="num" id="1583691">0</span>&nbsp;<span class="op" id="1583693">&amp;&amp;</span>&nbsp;<span class="ident" id="1583696">gp</span><span class="op" id="1583698">.</span><span class="ident" id="1583699">preempt</span>&nbsp;<span class="op" id="1583707">{</span>&nbsp;<span class="comment" id="1583709">//&nbsp;restore&nbsp;the&nbsp;preemption&nbsp;request&nbsp;in&nbsp;case&nbsp;we&#39;ve&nbsp;cleared&nbsp;it&nbsp;in&nbsp;newstack</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583782">gp</span><span class="op" id="1583784">.</span><span class="ident" id="1583785">stackguard0</span>&nbsp;<span class="op" id="1583797">=</span>&nbsp;<span class="ident" id="1583799">stackPreempt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1583813">}</span><br>
<span class="lineno"></span><span class="op" id="1583815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1583818">//&nbsp;One-time&nbsp;notifications.</span><br>
<span class="lineno">125</span><span class="keyword" id="1583845">func</span>&nbsp;<span class="ident" id="1583850">noteclear</span><span class="op" id="1583859">(</span><span class="ident" id="1583860">n</span>&nbsp;<span class="op" id="1583862">*</span><span class="ident" id="1583863">note</span><span class="op" id="1583867">)</span>&nbsp;<span class="op" id="1583869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583872">n</span><span class="op" id="1583873">.</span><span class="ident" id="1583874">key</span>&nbsp;<span class="op" id="1583878">=</span>&nbsp;<span class="num" id="1583880">0</span><br>
<span class="lineno"></span><span class="op" id="1583882">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1583885">func</span>&nbsp;<span class="ident" id="1583890">notewakeup</span><span class="op" id="1583900">(</span><span class="ident" id="1583901">n</span>&nbsp;<span class="op" id="1583903">*</span><span class="ident" id="1583904">note</span><span class="op" id="1583908">)</span>&nbsp;<span class="op" id="1583910">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583913">old</span>&nbsp;<span class="op" id="1583917">:=</span>&nbsp;<span class="ident" id="1583920">xchg</span><span class="op" id="1583924">(</span><span class="ident" id="1583925">key32</span><span class="op" id="1583930">(</span><span class="op" id="1583931">&amp;</span><span class="ident" id="1583932">n</span><span class="op" id="1583933">.</span><span class="ident" id="1583934">key</span><span class="op" id="1583937">)</span><span class="op" id="1583938">,</span>&nbsp;<span class="num" id="1583940">1</span><span class="op" id="1583941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583944">if</span>&nbsp;<span class="ident" id="1583947">old</span>&nbsp;<span class="op" id="1583951">!=</span>&nbsp;<span class="num" id="1583954">0</span>&nbsp;<span class="op" id="1583956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1583960">print</span><span class="op" id="1583965">(</span><span class="string" id="1583966">&#34;notewakeup&nbsp;-&nbsp;double&nbsp;wakeup&nbsp;(&#34;</span><span class="op" id="1583996">,</span>&nbsp;<span class="ident" id="1583998">old</span><span class="op" id="1584001">,</span>&nbsp;<span class="string" id="1584003">&#34;)\n&#34;</span><span class="op" id="1584008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584012">gothrow</span><span class="op" id="1584019">(</span><span class="string" id="1584020">&#34;notewakeup&nbsp;-&nbsp;double&nbsp;wakeup&#34;</span><span class="op" id="1584048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1584051">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584054">futexwakeup</span><span class="op" id="1584065">(</span><span class="ident" id="1584066">key32</span><span class="op" id="1584071">(</span><span class="op" id="1584072">&amp;</span><span class="ident" id="1584073">n</span><span class="op" id="1584074">.</span><span class="ident" id="1584075">key</span><span class="op" id="1584078">)</span><span class="op" id="1584079">,</span>&nbsp;<span class="num" id="1584081">1</span><span class="op" id="1584082">)</span><br>
<span class="lineno"></span><span class="op" id="1584084">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1584087">func</span>&nbsp;<span class="ident" id="1584092">notesleep</span><span class="op" id="1584101">(</span><span class="ident" id="1584102">n</span>&nbsp;<span class="op" id="1584104">*</span><span class="ident" id="1584105">note</span><span class="op" id="1584109">)</span>&nbsp;<span class="op" id="1584111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584114">gp</span>&nbsp;<span class="op" id="1584117">:=</span>&nbsp;<span class="ident" id="1584120">getg</span><span class="op" id="1584124">(</span><span class="op" id="1584125">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1584128">if</span>&nbsp;<span class="ident" id="1584131">gp</span>&nbsp;<span class="op" id="1584134">!=</span>&nbsp;<span class="ident" id="1584137">gp</span><span class="op" id="1584139">.</span><span class="ident" id="1584140">m</span><span class="op" id="1584141">.</span><span class="ident" id="1584142">g0</span>&nbsp;<span class="op" id="1584145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584149">gothrow</span><span class="op" id="1584156">(</span><span class="string" id="1584157">&#34;notesleep&nbsp;not&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1584178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1584181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1584184">for</span>&nbsp;<span class="ident" id="1584188">atomicload</span><span class="op" id="1584198">(</span><span class="ident" id="1584199">key32</span><span class="op" id="1584204">(</span><span class="op" id="1584205">&amp;</span><span class="ident" id="1584206">n</span><span class="op" id="1584207">.</span><span class="ident" id="1584208">key</span><span class="op" id="1584211">)</span><span class="op" id="1584212">)</span>&nbsp;<span class="op" id="1584214">==</span>&nbsp;<span class="num" id="1584217">0</span>&nbsp;<span class="op" id="1584219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584223">gp</span><span class="op" id="1584225">.</span><span class="ident" id="1584226">m</span><span class="op" id="1584227">.</span><span class="ident" id="1584228">blocked</span>&nbsp;<span class="op" id="1584236">=</span>&nbsp;<span class="builtintype" id="1584238">true</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584245">futexsleep</span><span class="op" id="1584255">(</span><span class="ident" id="1584256">key32</span><span class="op" id="1584261">(</span><span class="op" id="1584262">&amp;</span><span class="ident" id="1584263">n</span><span class="op" id="1584264">.</span><span class="ident" id="1584265">key</span><span class="op" id="1584268">)</span><span class="op" id="1584269">,</span>&nbsp;<span class="num" id="1584271">0</span><span class="op" id="1584272">,</span>&nbsp;<span class="op" id="1584274">-</span><span class="num" id="1584275">1</span><span class="op" id="1584276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584280">gp</span><span class="op" id="1584282">.</span><span class="ident" id="1584283">m</span><span class="op" id="1584284">.</span><span class="ident" id="1584285">blocked</span>&nbsp;<span class="op" id="1584293">=</span>&nbsp;<span class="builtintype" id="1584295">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1584302">}</span><br>
<span class="lineno"></span><span class="op" id="1584304">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="1584307">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1584320">func</span>&nbsp;<span class="ident" id="1584325">notetsleep_internal</span><span class="op" id="1584344">(</span><span class="ident" id="1584345">n</span>&nbsp;<span class="op" id="1584347">*</span><span class="ident" id="1584348">note</span><span class="op" id="1584352">,</span>&nbsp;<span class="ident" id="1584354">ns</span>&nbsp;<span class="ident" id="1584357">int64</span><span class="op" id="1584362">)</span>&nbsp;<span class="builtintype" id="1584364">bool</span>&nbsp;<span class="op" id="1584369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584372">gp</span>&nbsp;<span class="op" id="1584375">:=</span>&nbsp;<span class="ident" id="1584378">getg</span><span class="op" id="1584382">(</span><span class="op" id="1584383">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1584387">if</span>&nbsp;<span class="ident" id="1584390">ns</span>&nbsp;<span class="op" id="1584393">&lt;</span>&nbsp;<span class="num" id="1584395">0</span>&nbsp;<span class="op" id="1584397">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1584401">for</span>&nbsp;<span class="ident" id="1584405">atomicload</span><span class="op" id="1584415">(</span><span class="ident" id="1584416">key32</span><span class="op" id="1584421">(</span><span class="op" id="1584422">&amp;</span><span class="ident" id="1584423">n</span><span class="op" id="1584424">.</span><span class="ident" id="1584425">key</span><span class="op" id="1584428">)</span><span class="op" id="1584429">)</span>&nbsp;<span class="op" id="1584431">==</span>&nbsp;<span class="num" id="1584434">0</span>&nbsp;<span class="op" id="1584436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584441">gp</span><span class="op" id="1584443">.</span><span class="ident" id="1584444">m</span><span class="op" id="1584445">.</span><span class="ident" id="1584446">blocked</span>&nbsp;<span class="op" id="1584454">=</span>&nbsp;<span class="builtintype" id="1584456">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584464">futexsleep</span><span class="op" id="1584474">(</span><span class="ident" id="1584475">key32</span><span class="op" id="1584480">(</span><span class="op" id="1584481">&amp;</span><span class="ident" id="1584482">n</span><span class="op" id="1584483">.</span><span class="ident" id="1584484">key</span><span class="op" id="1584487">)</span><span class="op" id="1584488">,</span>&nbsp;<span class="num" id="1584490">0</span><span class="op" id="1584491">,</span>&nbsp;<span class="op" id="1584493">-</span><span class="num" id="1584494">1</span><span class="op" id="1584495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584500">gp</span><span class="op" id="1584502">.</span><span class="ident" id="1584503">m</span><span class="op" id="1584504">.</span><span class="ident" id="1584505">blocked</span>&nbsp;<span class="op" id="1584513">=</span>&nbsp;<span class="builtintype" id="1584515">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1584523">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1584527">return</span>&nbsp;<span class="builtintype" id="1584534">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1584540">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1584544">if</span>&nbsp;<span class="ident" id="1584547">atomicload</span><span class="op" id="1584557">(</span><span class="ident" id="1584558">key32</span><span class="op" id="1584563">(</span><span class="op" id="1584564">&amp;</span><span class="ident" id="1584565">n</span><span class="op" id="1584566">.</span><span class="ident" id="1584567">key</span><span class="op" id="1584570">)</span><span class="op" id="1584571">)</span>&nbsp;<span class="op" id="1584573">!=</span>&nbsp;<span class="num" id="1584576">0</span>&nbsp;<span class="op" id="1584578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1584582">return</span>&nbsp;<span class="builtintype" id="1584589">true</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1584595">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584599">deadline</span>&nbsp;<span class="op" id="1584608">:=</span>&nbsp;<span class="ident" id="1584611">nanotime</span><span class="op" id="1584619">(</span><span class="op" id="1584620">)</span>&nbsp;<span class="op" id="1584622">+</span>&nbsp;<span class="ident" id="1584624">ns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1584628">for</span>&nbsp;<span class="op" id="1584632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584636">gp</span><span class="op" id="1584638">.</span><span class="ident" id="1584639">m</span><span class="op" id="1584640">.</span><span class="ident" id="1584641">blocked</span>&nbsp;<span class="op" id="1584649">=</span>&nbsp;<span class="builtintype" id="1584651">true</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584658">futexsleep</span><span class="op" id="1584668">(</span><span class="ident" id="1584669">key32</span><span class="op" id="1584674">(</span><span class="op" id="1584675">&amp;</span><span class="ident" id="1584676">n</span><span class="op" id="1584677">.</span><span class="ident" id="1584678">key</span><span class="op" id="1584681">)</span><span class="op" id="1584682">,</span>&nbsp;<span class="num" id="1584684">0</span><span class="op" id="1584685">,</span>&nbsp;<span class="ident" id="1584687">ns</span><span class="op" id="1584689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584693">gp</span><span class="op" id="1584695">.</span><span class="ident" id="1584696">m</span><span class="op" id="1584697">.</span><span class="ident" id="1584698">blocked</span>&nbsp;<span class="op" id="1584706">=</span>&nbsp;<span class="builtintype" id="1584708">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1584716">if</span>&nbsp;<span class="ident" id="1584719">atomicload</span><span class="op" id="1584729">(</span><span class="ident" id="1584730">key32</span><span class="op" id="1584735">(</span><span class="op" id="1584736">&amp;</span><span class="ident" id="1584737">n</span><span class="op" id="1584738">.</span><span class="ident" id="1584739">key</span><span class="op" id="1584742">)</span><span class="op" id="1584743">)</span>&nbsp;<span class="op" id="1584745">!=</span>&nbsp;<span class="num" id="1584748">0</span>&nbsp;<span class="op" id="1584750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1584755">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1584763">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584767">now</span>&nbsp;<span class="op" id="1584771">:=</span>&nbsp;<span class="ident" id="1584774">nanotime</span><span class="op" id="1584782">(</span><span class="op" id="1584783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1584787">if</span>&nbsp;<span class="ident" id="1584790">now</span>&nbsp;<span class="op" id="1584794">&gt;=</span>&nbsp;<span class="ident" id="1584797">deadline</span>&nbsp;<span class="op" id="1584806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1584811">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1584819">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584823">ns</span>&nbsp;<span class="op" id="1584826">=</span>&nbsp;<span class="ident" id="1584828">deadline</span>&nbsp;<span class="op" id="1584837">-</span>&nbsp;<span class="ident" id="1584839">now</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1584844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1584847">return</span>&nbsp;<span class="ident" id="1584854">atomicload</span><span class="op" id="1584864">(</span><span class="ident" id="1584865">key32</span><span class="op" id="1584870">(</span><span class="op" id="1584871">&amp;</span><span class="ident" id="1584872">n</span><span class="op" id="1584873">.</span><span class="ident" id="1584874">key</span><span class="op" id="1584877">)</span><span class="op" id="1584878">)</span>&nbsp;<span class="op" id="1584880">!=</span>&nbsp;<span class="num" id="1584883">0</span><br>
<span class="lineno"></span><span class="op" id="1584885">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1584888">func</span>&nbsp;<span class="ident" id="1584893">notetsleep</span><span class="op" id="1584903">(</span><span class="ident" id="1584904">n</span>&nbsp;<span class="op" id="1584906">*</span><span class="ident" id="1584907">note</span><span class="op" id="1584911">,</span>&nbsp;<span class="ident" id="1584913">ns</span>&nbsp;<span class="ident" id="1584916">int64</span><span class="op" id="1584921">)</span>&nbsp;<span class="builtintype" id="1584923">bool</span>&nbsp;<span class="op" id="1584928">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584931">gp</span>&nbsp;<span class="op" id="1584934">:=</span>&nbsp;<span class="ident" id="1584937">getg</span><span class="op" id="1584941">(</span><span class="op" id="1584942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1584945">if</span>&nbsp;<span class="ident" id="1584948">gp</span>&nbsp;<span class="op" id="1584951">!=</span>&nbsp;<span class="ident" id="1584954">gp</span><span class="op" id="1584956">.</span><span class="ident" id="1584957">m</span><span class="op" id="1584958">.</span><span class="ident" id="1584959">g0</span>&nbsp;<span class="op" id="1584962">&amp;&amp;</span>&nbsp;<span class="ident" id="1584965">gp</span><span class="op" id="1584967">.</span><span class="ident" id="1584968">m</span><span class="op" id="1584969">.</span><span class="ident" id="1584970">gcing</span>&nbsp;<span class="op" id="1584976">==</span>&nbsp;<span class="num" id="1584979">0</span>&nbsp;<span class="op" id="1584981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584985">gothrow</span><span class="op" id="1584992">(</span><span class="string" id="1584993">&#34;notetsleep&nbsp;not&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1585015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1585018">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1585022">return</span>&nbsp;<span class="ident" id="1585029">notetsleep_internal</span><span class="op" id="1585048">(</span><span class="ident" id="1585049">n</span><span class="op" id="1585050">,</span>&nbsp;<span class="ident" id="1585052">ns</span><span class="op" id="1585054">)</span><br>
<span class="lineno"></span><span class="op" id="1585056">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1585059">//&nbsp;same&nbsp;as&nbsp;runtime路notetsleep,&nbsp;but&nbsp;called&nbsp;on&nbsp;user&nbsp;g&nbsp;(not&nbsp;g0)</span><br>
<span class="lineno"></span><span class="comment" id="1585121">//&nbsp;calls&nbsp;only&nbsp;nosplit&nbsp;functions&nbsp;between&nbsp;entersyscallblock/exitsyscall</span><br>
<span class="lineno">195</span><span class="keyword" id="1585191">func</span>&nbsp;<span class="ident" id="1585196">notetsleepg</span><span class="op" id="1585207">(</span><span class="ident" id="1585208">n</span>&nbsp;<span class="op" id="1585210">*</span><span class="ident" id="1585211">note</span><span class="op" id="1585215">,</span>&nbsp;<span class="ident" id="1585217">ns</span>&nbsp;<span class="ident" id="1585220">int64</span><span class="op" id="1585225">)</span>&nbsp;<span class="builtintype" id="1585227">bool</span>&nbsp;<span class="op" id="1585232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585235">gp</span>&nbsp;<span class="op" id="1585238">:=</span>&nbsp;<span class="ident" id="1585241">getg</span><span class="op" id="1585245">(</span><span class="op" id="1585246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1585249">if</span>&nbsp;<span class="ident" id="1585252">gp</span>&nbsp;<span class="op" id="1585255">==</span>&nbsp;<span class="ident" id="1585258">gp</span><span class="op" id="1585260">.</span><span class="ident" id="1585261">m</span><span class="op" id="1585262">.</span><span class="ident" id="1585263">g0</span>&nbsp;<span class="op" id="1585266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585270">gothrow</span><span class="op" id="1585277">(</span><span class="string" id="1585278">&#34;notetsleepg&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1585297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1585300">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585304">entersyscallblock</span><span class="op" id="1585321">(</span><span class="op" id="1585322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585325">ok</span>&nbsp;<span class="op" id="1585328">:=</span>&nbsp;<span class="ident" id="1585331">notetsleep_internal</span><span class="op" id="1585350">(</span><span class="ident" id="1585351">n</span><span class="op" id="1585352">,</span>&nbsp;<span class="ident" id="1585354">ns</span><span class="op" id="1585356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585359">exitsyscall</span><span class="op" id="1585370">(</span><span class="op" id="1585371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1585374">return</span>&nbsp;<span class="ident" id="1585381">ok</span><br>
<span class="lineno">205</span><span class="op" id="1585384">}</span>
</div>
</body>
</html>
