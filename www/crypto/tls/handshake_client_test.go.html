<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="7806983">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7807038">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7807092">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7807143">package</span>&nbsp;<span class="ident" id="7807151">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7807156">import</span>&nbsp;<span class="op" id="7807163">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7807166">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7807175">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7807191">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7807205">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7807220">&#34;encoding/pem&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7807236">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7807243">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7807249">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7807256">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7807262">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7807273">&#34;path/filepath&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7807290">&#34;strconv&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7807301">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7807312">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7807319">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7807322">//&nbsp;Note:&nbsp;see&nbsp;comment&nbsp;in&nbsp;handshake_test.go&nbsp;for&nbsp;details&nbsp;of&nbsp;how&nbsp;the&nbsp;reference</span><br>
<span class="lineno">25</span><span class="comment" id="7807397">//&nbsp;tests&nbsp;work.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7807413">//&nbsp;blockingSource&nbsp;is&nbsp;an&nbsp;io.Reader&nbsp;that&nbsp;blocks&nbsp;a&nbsp;Read&nbsp;call&nbsp;until&nbsp;it&#39;s&nbsp;closed.</span><br>
<span class="lineno"></span><span class="keyword" id="7807490">type</span>&nbsp;<span class="ident" id="7807495">blockingSource</span>&nbsp;<span class="keyword" id="7807510">chan</span>&nbsp;<span class="builtintype" id="7807515">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="keyword" id="7807521">func</span>&nbsp;<span class="op" id="7807526">(</span><span class="ident" id="7807527">b</span>&nbsp;<span class="ident" id="7807529">blockingSource</span><span class="op" id="7807543">)</span>&nbsp;<span class="ident" id="7807545">Read</span><span class="op" id="7807549">(</span><span class="op" id="7807550">[</span><span class="op" id="7807551">]</span><span class="builtintype" id="7807552">byte</span><span class="op" id="7807556">)</span>&nbsp;<span class="op" id="7807558">(</span><span class="ident" id="7807559">n</span>&nbsp;<span class="builtintype" id="7807561">int</span><span class="op" id="7807564">,</span>&nbsp;<span class="ident" id="7807566">err</span>&nbsp;<span class="builtintype" id="7807570">error</span><span class="op" id="7807575">)</span>&nbsp;<span class="op" id="7807577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7807580">&lt;-</span><span class="ident" id="7807582">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7807585">return</span>&nbsp;<span class="num" id="7807592">0</span><span class="op" id="7807593">,</span>&nbsp;<span class="ident" id="7807595">io</span><span class="op" id="7807597">.</span><span class="ident" id="7807598">EOF</span><br>
<span class="lineno"></span><span class="op" id="7807602">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="7807605">//&nbsp;clientTest&nbsp;represents&nbsp;a&nbsp;test&nbsp;of&nbsp;the&nbsp;TLS&nbsp;client&nbsp;handshake&nbsp;against&nbsp;a&nbsp;reference</span><br>
<span class="lineno"></span><span class="comment" id="7807685">//&nbsp;implementation.</span><br>
<span class="lineno"></span><span class="keyword" id="7807704">type</span>&nbsp;<span class="ident" id="7807709">clientTest</span>&nbsp;<span class="keyword" id="7807720">struct</span>&nbsp;<span class="op" id="7807727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7807730">//&nbsp;name&nbsp;is&nbsp;a&nbsp;freeform&nbsp;string&nbsp;identifying&nbsp;the&nbsp;test&nbsp;and&nbsp;the&nbsp;file&nbsp;in&nbsp;which</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7807803">//&nbsp;the&nbsp;expected&nbsp;results&nbsp;will&nbsp;be&nbsp;stored.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7807844">name</span>&nbsp;<span class="builtintype" id="7807849">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7807857">//&nbsp;command,&nbsp;if&nbsp;not&nbsp;empty,&nbsp;contains&nbsp;a&nbsp;series&nbsp;of&nbsp;arguments&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7807923">//&nbsp;command&nbsp;to&nbsp;run&nbsp;for&nbsp;the&nbsp;reference&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7807968">command</span>&nbsp;<span class="op" id="7807976">[</span><span class="op" id="7807977">]</span><span class="builtintype" id="7807978">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7807986">//&nbsp;config,&nbsp;if&nbsp;not&nbsp;nil,&nbsp;contains&nbsp;a&nbsp;custom&nbsp;Config&nbsp;to&nbsp;use&nbsp;for&nbsp;this&nbsp;test.</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7808057">config</span>&nbsp;<span class="op" id="7808064">*</span><span class="ident" id="7808065">Config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7808073">//&nbsp;cert,&nbsp;if&nbsp;not&nbsp;empty,&nbsp;contains&nbsp;a&nbsp;DER-encoded&nbsp;certificate&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7808140">//&nbsp;reference&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7808162">cert</span>&nbsp;<span class="op" id="7808167">[</span><span class="op" id="7808168">]</span><span class="builtintype" id="7808169">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7808175">//&nbsp;key,&nbsp;if&nbsp;not&nbsp;nil,&nbsp;contains&nbsp;either&nbsp;a&nbsp;*rsa.PrivateKey&nbsp;or</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7808233">//&nbsp;*ecdsa.PrivateKey&nbsp;which&nbsp;is&nbsp;the&nbsp;private&nbsp;key&nbsp;for&nbsp;the&nbsp;reference&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7808306">key</span>&nbsp;<span class="keyword" id="7808310">interface</span><span class="op" id="7808319">{</span><span class="op" id="7808320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7808323">//&nbsp;validate,&nbsp;if&nbsp;not&nbsp;nil,&nbsp;is&nbsp;a&nbsp;function&nbsp;that&nbsp;will&nbsp;be&nbsp;called&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7808392">//&nbsp;ConnectionState&nbsp;of&nbsp;the&nbsp;resulting&nbsp;connection.&nbsp;It&nbsp;returns&nbsp;a&nbsp;non-nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7808462">//&nbsp;error&nbsp;if&nbsp;the&nbsp;ConnectionState&nbsp;is&nbsp;unacceptable.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7808512">validate</span>&nbsp;<span class="keyword" id="7808521">func</span><span class="op" id="7808525">(</span><span class="ident" id="7808526">ConnectionState</span><span class="op" id="7808541">)</span>&nbsp;<span class="builtintype" id="7808543">error</span><br>
<span class="lineno"></span><span class="op" id="7808549">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7808552">var</span>&nbsp;<span class="ident" id="7808556">defaultServerCommand</span>&nbsp;<span class="op" id="7808577">=</span>&nbsp;<span class="op" id="7808579">[</span><span class="op" id="7808580">]</span><span class="builtintype" id="7808581">string</span><span class="op" id="7808587">{</span><span class="string" id="7808588">&#34;openssl&#34;</span><span class="op" id="7808597">,</span>&nbsp;<span class="string" id="7808599">&#34;s_server&#34;</span><span class="op" id="7808609">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="7808612">//&nbsp;connFromCommand&nbsp;starts&nbsp;the&nbsp;reference&nbsp;server&nbsp;process,&nbsp;connects&nbsp;to&nbsp;it&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="7808687">//&nbsp;returns&nbsp;a&nbsp;recordingConn&nbsp;for&nbsp;the&nbsp;connection.&nbsp;The&nbsp;stdin&nbsp;return&nbsp;value&nbsp;is&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="7808762">//&nbsp;blockingSource&nbsp;for&nbsp;the&nbsp;stdin&nbsp;of&nbsp;the&nbsp;child&nbsp;process.&nbsp;It&nbsp;must&nbsp;be&nbsp;closed&nbsp;before</span><br>
<span class="lineno"></span><span class="comment" id="7808841">//&nbsp;Waiting&nbsp;for&nbsp;child.</span><br>
<span class="lineno"></span><span class="keyword" id="7808863">func</span>&nbsp;<span class="op" id="7808868">(</span><span class="ident" id="7808869">test</span>&nbsp;<span class="op" id="7808874">*</span><span class="ident" id="7808875">clientTest</span><span class="op" id="7808885">)</span>&nbsp;<span class="ident" id="7808887">connFromCommand</span><span class="op" id="7808902">(</span><span class="op" id="7808903">)</span>&nbsp;<span class="op" id="7808905">(</span><span class="ident" id="7808906">conn</span>&nbsp;<span class="op" id="7808911">*</span><span class="ident" id="7808912">recordingConn</span><span class="op" id="7808925">,</span>&nbsp;<span class="ident" id="7808927">child</span>&nbsp;<span class="op" id="7808933">*</span><span class="ident" id="7808934">exec</span><span class="op" id="7808938">.</span><span class="ident" id="7808939">Cmd</span><span class="op" id="7808942">,</span>&nbsp;<span class="ident" id="7808944">stdin</span>&nbsp;<span class="ident" id="7808950">blockingSource</span><span class="op" id="7808964">,</span>&nbsp;<span class="ident" id="7808966">err</span>&nbsp;<span class="builtintype" id="7808970">error</span><span class="op" id="7808975">)</span>&nbsp;<span class="op" id="7808977">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7808980">cert</span>&nbsp;<span class="op" id="7808985">:=</span>&nbsp;<span class="ident" id="7808988">testRSACertificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7809008">if</span>&nbsp;<span class="builtinfunc" id="7809011">len</span><span class="op" id="7809014">(</span><span class="ident" id="7809015">test</span><span class="op" id="7809019">.</span><span class="ident" id="7809020">cert</span><span class="op" id="7809024">)</span>&nbsp;<span class="op" id="7809026">&gt;</span>&nbsp;<span class="num" id="7809028">0</span>&nbsp;<span class="op" id="7809030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7809034">cert</span>&nbsp;<span class="op" id="7809039">=</span>&nbsp;<span class="ident" id="7809041">test</span><span class="op" id="7809045">.</span><span class="ident" id="7809046">cert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7809052">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7809055">certPath</span>&nbsp;<span class="op" id="7809064">:=</span>&nbsp;<span class="ident" id="7809067">tempFile</span><span class="op" id="7809075">(</span><span class="builtintype" id="7809076">string</span><span class="op" id="7809082">(</span><span class="ident" id="7809083">cert</span><span class="op" id="7809087">)</span><span class="op" id="7809088">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7809091">defer</span>&nbsp;<span class="ident" id="7809097">os</span><span class="op" id="7809099">.</span><span class="ident" id="7809100">Remove</span><span class="op" id="7809106">(</span><span class="ident" id="7809107">certPath</span><span class="op" id="7809115">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7809119">var</span>&nbsp;<span class="ident" id="7809123">key</span>&nbsp;<span class="keyword" id="7809127">interface</span><span class="op" id="7809136">{</span><span class="op" id="7809137">}</span>&nbsp;<span class="op" id="7809139">=</span>&nbsp;<span class="ident" id="7809141">testRSAPrivateKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7809160">if</span>&nbsp;<span class="ident" id="7809163">test</span><span class="op" id="7809167">.</span><span class="ident" id="7809168">key</span>&nbsp;<span class="op" id="7809172">!=</span>&nbsp;<span class="ident" id="7809175">nil</span>&nbsp;<span class="op" id="7809179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7809183">key</span>&nbsp;<span class="op" id="7809187">=</span>&nbsp;<span class="ident" id="7809189">test</span><span class="op" id="7809193">.</span><span class="ident" id="7809194">key</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7809199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7809202">var</span>&nbsp;<span class="ident" id="7809206">pemType</span>&nbsp;<span class="builtintype" id="7809214">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7809222">var</span>&nbsp;<span class="ident" id="7809226">derBytes</span>&nbsp;<span class="op" id="7809235">[</span><span class="op" id="7809236">]</span><span class="builtintype" id="7809237">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7809243">switch</span>&nbsp;<span class="ident" id="7809250">key</span>&nbsp;<span class="op" id="7809254">:=</span>&nbsp;<span class="ident" id="7809257">key</span><span class="op" id="7809260">.</span><span class="op" id="7809261">(</span><span class="keyword" id="7809262">type</span><span class="op" id="7809266">)</span>&nbsp;<span class="op" id="7809268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7809271">case</span>&nbsp;<span class="op" id="7809276">*</span><span class="ident" id="7809277">rsa</span><span class="op" id="7809280">.</span><span class="ident" id="7809281">PrivateKey</span><span class="op" id="7809291">:</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7809295">pemType</span>&nbsp;<span class="op" id="7809303">=</span>&nbsp;<span class="string" id="7809305">&#34;RSA&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7809313">derBytes</span>&nbsp;<span class="op" id="7809322">=</span>&nbsp;<span class="ident" id="7809324">x509</span><span class="op" id="7809328">.</span><span class="ident" id="7809329">MarshalPKCS1PrivateKey</span><span class="op" id="7809351">(</span><span class="ident" id="7809352">key</span><span class="op" id="7809355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7809358">case</span>&nbsp;<span class="op" id="7809363">*</span><span class="ident" id="7809364">ecdsa</span><span class="op" id="7809369">.</span><span class="ident" id="7809370">PrivateKey</span><span class="op" id="7809380">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7809384">pemType</span>&nbsp;<span class="op" id="7809392">=</span>&nbsp;<span class="string" id="7809394">&#34;EC&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7809401">var</span>&nbsp;<span class="ident" id="7809405">err</span>&nbsp;<span class="builtintype" id="7809409">error</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7809417">derBytes</span><span class="op" id="7809425">,</span>&nbsp;<span class="ident" id="7809427">err</span>&nbsp;<span class="op" id="7809431">=</span>&nbsp;<span class="ident" id="7809433">x509</span><span class="op" id="7809437">.</span><span class="ident" id="7809438">MarshalECPrivateKey</span><span class="op" id="7809457">(</span><span class="ident" id="7809458">key</span><span class="op" id="7809461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7809465">if</span>&nbsp;<span class="ident" id="7809468">err</span>&nbsp;<span class="op" id="7809472">!=</span>&nbsp;<span class="ident" id="7809475">nil</span>&nbsp;<span class="op" id="7809479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7809484">panic</span><span class="op" id="7809489">(</span><span class="ident" id="7809490">err</span><span class="op" id="7809493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7809497">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7809500">default</span><span class="op" id="7809507">:</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7809511">panic</span><span class="op" id="7809516">(</span><span class="string" id="7809517">&#34;unknown&nbsp;key&nbsp;type&#34;</span><span class="op" id="7809535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7809538">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7809542">var</span>&nbsp;<span class="ident" id="7809546">pemOut</span>&nbsp;<span class="ident" id="7809553">bytes</span><span class="op" id="7809558">.</span><span class="ident" id="7809559">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7809567">pem</span><span class="op" id="7809570">.</span><span class="ident" id="7809571">Encode</span><span class="op" id="7809577">(</span><span class="op" id="7809578">&amp;</span><span class="ident" id="7809579">pemOut</span><span class="op" id="7809585">,</span>&nbsp;<span class="op" id="7809587">&amp;</span><span class="ident" id="7809588">pem</span><span class="op" id="7809591">.</span><span class="ident" id="7809592">Block</span><span class="op" id="7809597">{</span><span class="ident" id="7809598">Type</span><span class="op" id="7809602">:</span>&nbsp;<span class="ident" id="7809604">pemType</span>&nbsp;<span class="op" id="7809612">+</span>&nbsp;<span class="string" id="7809614">&#34;&nbsp;PRIVATE&nbsp;KEY&#34;</span><span class="op" id="7809628">,</span>&nbsp;<span class="ident" id="7809630">Bytes</span><span class="op" id="7809635">:</span>&nbsp;<span class="ident" id="7809637">derBytes</span><span class="op" id="7809645">}</span><span class="op" id="7809646">)</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7809650">keyPath</span>&nbsp;<span class="op" id="7809658">:=</span>&nbsp;<span class="ident" id="7809661">tempFile</span><span class="op" id="7809669">(</span><span class="builtintype" id="7809670">string</span><span class="op" id="7809676">(</span><span class="ident" id="7809677">pemOut</span><span class="op" id="7809683">.</span><span class="ident" id="7809684">Bytes</span><span class="op" id="7809689">(</span><span class="op" id="7809690">)</span><span class="op" id="7809691">)</span><span class="op" id="7809692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7809695">defer</span>&nbsp;<span class="ident" id="7809701">os</span><span class="op" id="7809703">.</span><span class="ident" id="7809704">Remove</span><span class="op" id="7809710">(</span><span class="ident" id="7809711">keyPath</span><span class="op" id="7809718">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7809722">var</span>&nbsp;<span class="ident" id="7809726">command</span>&nbsp;<span class="op" id="7809734">[</span><span class="op" id="7809735">]</span><span class="builtintype" id="7809736">string</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7809744">if</span>&nbsp;<span class="builtinfunc" id="7809747">len</span><span class="op" id="7809750">(</span><span class="ident" id="7809751">test</span><span class="op" id="7809755">.</span><span class="ident" id="7809756">command</span><span class="op" id="7809763">)</span>&nbsp;<span class="op" id="7809765">&gt;</span>&nbsp;<span class="num" id="7809767">0</span>&nbsp;<span class="op" id="7809769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7809773">command</span>&nbsp;<span class="op" id="7809781">=</span>&nbsp;<span class="builtinfunc" id="7809783">append</span><span class="op" id="7809789">(</span><span class="ident" id="7809790">command</span><span class="op" id="7809797">,</span>&nbsp;<span class="ident" id="7809799">test</span><span class="op" id="7809803">.</span><span class="ident" id="7809804">command</span><span class="op" id="7809811">...</span><span class="op" id="7809814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7809817">}</span>&nbsp;<span class="keyword" id="7809819">else</span>&nbsp;<span class="op" id="7809824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7809828">command</span>&nbsp;<span class="op" id="7809836">=</span>&nbsp;<span class="builtinfunc" id="7809838">append</span><span class="op" id="7809844">(</span><span class="ident" id="7809845">command</span><span class="op" id="7809852">,</span>&nbsp;<span class="ident" id="7809854">defaultServerCommand</span><span class="op" id="7809874">...</span><span class="op" id="7809877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7809880">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7809883">command</span>&nbsp;<span class="op" id="7809891">=</span>&nbsp;<span class="builtinfunc" id="7809893">append</span><span class="op" id="7809899">(</span><span class="ident" id="7809900">command</span><span class="op" id="7809907">,</span>&nbsp;<span class="string" id="7809909">&#34;-cert&#34;</span><span class="op" id="7809916">,</span>&nbsp;<span class="ident" id="7809918">certPath</span><span class="op" id="7809926">,</span>&nbsp;<span class="string" id="7809928">&#34;-certform&#34;</span><span class="op" id="7809939">,</span>&nbsp;<span class="string" id="7809941">&#34;DER&#34;</span><span class="op" id="7809946">,</span>&nbsp;<span class="string" id="7809948">&#34;-key&#34;</span><span class="op" id="7809954">,</span>&nbsp;<span class="ident" id="7809956">keyPath</span><span class="op" id="7809963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7809966">//&nbsp;serverPort&nbsp;contains&nbsp;the&nbsp;port&nbsp;that&nbsp;OpenSSL&nbsp;will&nbsp;listen&nbsp;on.&nbsp;OpenSSL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7810036">//&nbsp;can&#39;t&nbsp;take&nbsp;&#34;0&#34;&nbsp;as&nbsp;an&nbsp;argument&nbsp;here&nbsp;so&nbsp;we&nbsp;have&nbsp;to&nbsp;pick&nbsp;a&nbsp;number&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7810107">//&nbsp;hope&nbsp;that&nbsp;it&#39;s&nbsp;not&nbsp;in&nbsp;use&nbsp;on&nbsp;the&nbsp;machine.&nbsp;Since&nbsp;this&nbsp;only&nbsp;occurs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7810176">//&nbsp;when&nbsp;-update&nbsp;is&nbsp;given&nbsp;and&nbsp;thus&nbsp;when&nbsp;there&#39;s&nbsp;a&nbsp;human&nbsp;watching&nbsp;the</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7810245">//&nbsp;test,&nbsp;this&nbsp;isn&#39;t&nbsp;too&nbsp;bad.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7810275">const</span>&nbsp;<span class="ident" id="7810281">serverPort</span>&nbsp;<span class="op" id="7810292">=</span>&nbsp;<span class="num" id="7810294">24323</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7810301">command</span>&nbsp;<span class="op" id="7810309">=</span>&nbsp;<span class="builtinfunc" id="7810311">append</span><span class="op" id="7810317">(</span><span class="ident" id="7810318">command</span><span class="op" id="7810325">,</span>&nbsp;<span class="string" id="7810327">&#34;-accept&#34;</span><span class="op" id="7810336">,</span>&nbsp;<span class="ident" id="7810338">strconv</span><span class="op" id="7810345">.</span><span class="ident" id="7810346">Itoa</span><span class="op" id="7810350">(</span><span class="ident" id="7810351">serverPort</span><span class="op" id="7810361">)</span><span class="op" id="7810362">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7810366">cmd</span>&nbsp;<span class="op" id="7810370">:=</span>&nbsp;<span class="ident" id="7810373">exec</span><span class="op" id="7810377">.</span><span class="ident" id="7810378">Command</span><span class="op" id="7810385">(</span><span class="ident" id="7810386">command</span><span class="op" id="7810393">[</span><span class="num" id="7810394">0</span><span class="op" id="7810395">]</span><span class="op" id="7810396">,</span>&nbsp;<span class="ident" id="7810398">command</span><span class="op" id="7810405">[</span><span class="num" id="7810406">1</span><span class="op" id="7810407">:</span><span class="op" id="7810408">]</span><span class="op" id="7810409">...</span><span class="op" id="7810412">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7810415">stdin</span>&nbsp;<span class="op" id="7810421">=</span>&nbsp;<span class="ident" id="7810423">blockingSource</span><span class="op" id="7810437">(</span><span class="builtinfunc" id="7810438">make</span><span class="op" id="7810442">(</span><span class="keyword" id="7810443">chan</span>&nbsp;<span class="builtintype" id="7810448">bool</span><span class="op" id="7810452">)</span><span class="op" id="7810453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7810456">cmd</span><span class="op" id="7810459">.</span><span class="ident" id="7810460">Stdin</span>&nbsp;<span class="op" id="7810466">=</span>&nbsp;<span class="ident" id="7810468">stdin</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7810475">var</span>&nbsp;<span class="ident" id="7810479">out</span>&nbsp;<span class="ident" id="7810483">bytes</span><span class="op" id="7810488">.</span><span class="ident" id="7810489">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7810497">cmd</span><span class="op" id="7810500">.</span><span class="ident" id="7810501">Stdout</span>&nbsp;<span class="op" id="7810508">=</span>&nbsp;<span class="op" id="7810510">&amp;</span><span class="ident" id="7810511">out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7810516">cmd</span><span class="op" id="7810519">.</span><span class="ident" id="7810520">Stderr</span>&nbsp;<span class="op" id="7810527">=</span>&nbsp;<span class="op" id="7810529">&amp;</span><span class="ident" id="7810530">out</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7810535">if</span>&nbsp;<span class="ident" id="7810538">err</span>&nbsp;<span class="op" id="7810542">:=</span>&nbsp;<span class="ident" id="7810545">cmd</span><span class="op" id="7810548">.</span><span class="ident" id="7810549">Start</span><span class="op" id="7810554">(</span><span class="op" id="7810555">)</span><span class="op" id="7810556">;</span>&nbsp;<span class="ident" id="7810558">err</span>&nbsp;<span class="op" id="7810562">!=</span>&nbsp;<span class="ident" id="7810565">nil</span>&nbsp;<span class="op" id="7810569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7810573">return</span>&nbsp;<span class="ident" id="7810580">nil</span><span class="op" id="7810583">,</span>&nbsp;<span class="ident" id="7810585">nil</span><span class="op" id="7810588">,</span>&nbsp;<span class="ident" id="7810590">nil</span><span class="op" id="7810593">,</span>&nbsp;<span class="ident" id="7810595">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7810600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7810604">//&nbsp;OpenSSL&nbsp;does&nbsp;print&nbsp;an&nbsp;&#34;ACCEPT&#34;&nbsp;banner,&nbsp;but&nbsp;it&nbsp;does&nbsp;so&nbsp;*before*</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7810671">//&nbsp;opening&nbsp;the&nbsp;listening&nbsp;socket,&nbsp;so&nbsp;we&nbsp;can&#39;t&nbsp;use&nbsp;that&nbsp;to&nbsp;wait&nbsp;until&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7810743">//&nbsp;has&nbsp;started&nbsp;listening.&nbsp;Thus&nbsp;we&nbsp;are&nbsp;forced&nbsp;to&nbsp;poll&nbsp;until&nbsp;we&nbsp;get&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7810812">//&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7810828">var</span>&nbsp;<span class="ident" id="7810832">tcpConn</span>&nbsp;<span class="ident" id="7810840">net</span><span class="op" id="7810843">.</span><span class="ident" id="7810844">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7810850">for</span>&nbsp;<span class="ident" id="7810854">i</span>&nbsp;<span class="op" id="7810856">:=</span>&nbsp;<span class="builtintype" id="7810859">uint</span><span class="op" id="7810863">(</span><span class="num" id="7810864">0</span><span class="op" id="7810865">)</span><span class="op" id="7810866">;</span>&nbsp;<span class="ident" id="7810868">i</span>&nbsp;<span class="op" id="7810870">&lt;</span>&nbsp;<span class="num" id="7810872">5</span><span class="op" id="7810873">;</span>&nbsp;<span class="ident" id="7810875">i</span><span class="op" id="7810876">++</span>&nbsp;<span class="op" id="7810879">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7810883">var</span>&nbsp;<span class="ident" id="7810887">err</span>&nbsp;<span class="builtintype" id="7810891">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7810899">tcpConn</span><span class="op" id="7810906">,</span>&nbsp;<span class="ident" id="7810908">err</span>&nbsp;<span class="op" id="7810912">=</span>&nbsp;<span class="ident" id="7810914">net</span><span class="op" id="7810917">.</span><span class="ident" id="7810918">DialTCP</span><span class="op" id="7810925">(</span><span class="string" id="7810926">&#34;tcp&#34;</span><span class="op" id="7810931">,</span>&nbsp;<span class="ident" id="7810933">nil</span><span class="op" id="7810936">,</span>&nbsp;<span class="op" id="7810938">&amp;</span><span class="ident" id="7810939">net</span><span class="op" id="7810942">.</span><span class="ident" id="7810943">TCPAddr</span><span class="op" id="7810950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7810955">IP</span><span class="op" id="7810957">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="7810961">net</span><span class="op" id="7810964">.</span><span class="ident" id="7810965">IPv4</span><span class="op" id="7810969">(</span><span class="num" id="7810970">127</span><span class="op" id="7810973">,</span>&nbsp;<span class="num" id="7810975">0</span><span class="op" id="7810976">,</span>&nbsp;<span class="num" id="7810978">0</span><span class="op" id="7810979">,</span>&nbsp;<span class="num" id="7810981">1</span><span class="op" id="7810982">)</span><span class="op" id="7810983">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7810988">Port</span><span class="op" id="7810992">:</span>&nbsp;<span class="ident" id="7810994">serverPort</span><span class="op" id="7811004">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7811008">}</span><span class="op" id="7811009">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7811013">if</span>&nbsp;<span class="ident" id="7811016">err</span>&nbsp;<span class="op" id="7811020">==</span>&nbsp;<span class="ident" id="7811023">nil</span>&nbsp;<span class="op" id="7811027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7811032">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7811040">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7811044">time</span><span class="op" id="7811048">.</span><span class="ident" id="7811049">Sleep</span><span class="op" id="7811054">(</span><span class="op" id="7811055">(</span><span class="num" id="7811056">1</span>&nbsp;<span class="op" id="7811058">&lt;&lt;</span>&nbsp;<span class="ident" id="7811061">i</span><span class="op" id="7811062">)</span>&nbsp;<span class="op" id="7811064">*</span>&nbsp;<span class="num" id="7811066">5</span>&nbsp;<span class="op" id="7811068">*</span>&nbsp;<span class="ident" id="7811070">time</span><span class="op" id="7811074">.</span><span class="ident" id="7811075">Millisecond</span><span class="op" id="7811086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7811089">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7811092">if</span>&nbsp;<span class="ident" id="7811095">tcpConn</span>&nbsp;<span class="op" id="7811103">==</span>&nbsp;<span class="ident" id="7811106">nil</span>&nbsp;<span class="op" id="7811110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7811114">close</span><span class="op" id="7811119">(</span><span class="ident" id="7811120">stdin</span><span class="op" id="7811125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7811129">out</span><span class="op" id="7811132">.</span><span class="ident" id="7811133">WriteTo</span><span class="op" id="7811140">(</span><span class="ident" id="7811141">os</span><span class="op" id="7811143">.</span><span class="ident" id="7811144">Stdout</span><span class="op" id="7811150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7811154">cmd</span><span class="op" id="7811157">.</span><span class="ident" id="7811158">Process</span><span class="op" id="7811165">.</span><span class="ident" id="7811166">Kill</span><span class="op" id="7811170">(</span><span class="op" id="7811171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7811175">return</span>&nbsp;<span class="ident" id="7811182">nil</span><span class="op" id="7811185">,</span>&nbsp;<span class="ident" id="7811187">nil</span><span class="op" id="7811190">,</span>&nbsp;<span class="ident" id="7811192">nil</span><span class="op" id="7811195">,</span>&nbsp;<span class="ident" id="7811197">cmd</span><span class="op" id="7811200">.</span><span class="ident" id="7811201">Wait</span><span class="op" id="7811205">(</span><span class="op" id="7811206">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7811209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7811213">record</span>&nbsp;<span class="op" id="7811220">:=</span>&nbsp;<span class="op" id="7811223">&amp;</span><span class="ident" id="7811224">recordingConn</span><span class="op" id="7811237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7811241">Conn</span><span class="op" id="7811245">:</span>&nbsp;<span class="ident" id="7811247">tcpConn</span><span class="op" id="7811254">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7811257">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7811261">return</span>&nbsp;<span class="ident" id="7811268">record</span><span class="op" id="7811274">,</span>&nbsp;<span class="ident" id="7811276">cmd</span><span class="op" id="7811279">,</span>&nbsp;<span class="ident" id="7811281">stdin</span><span class="op" id="7811286">,</span>&nbsp;<span class="ident" id="7811288">nil</span><br>
<span class="lineno"></span><span class="op" id="7811292">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7811295">func</span>&nbsp;<span class="op" id="7811300">(</span><span class="ident" id="7811301">test</span>&nbsp;<span class="op" id="7811306">*</span><span class="ident" id="7811307">clientTest</span><span class="op" id="7811317">)</span>&nbsp;<span class="ident" id="7811319">dataPath</span><span class="op" id="7811327">(</span><span class="op" id="7811328">)</span>&nbsp;<span class="builtintype" id="7811330">string</span>&nbsp;<span class="op" id="7811337">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7811340">return</span>&nbsp;<span class="ident" id="7811347">filepath</span><span class="op" id="7811355">.</span><span class="ident" id="7811356">Join</span><span class="op" id="7811360">(</span><span class="string" id="7811361">&#34;testdata&#34;</span><span class="op" id="7811371">,</span>&nbsp;<span class="string" id="7811373">&#34;Client-&#34;</span><span class="op" id="7811382">+</span><span class="ident" id="7811383">test</span><span class="op" id="7811387">.</span><span class="ident" id="7811388">name</span><span class="op" id="7811392">)</span><br>
<span class="lineno"></span><span class="op" id="7811394">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7811397">func</span>&nbsp;<span class="op" id="7811402">(</span><span class="ident" id="7811403">test</span>&nbsp;<span class="op" id="7811408">*</span><span class="ident" id="7811409">clientTest</span><span class="op" id="7811419">)</span>&nbsp;<span class="ident" id="7811421">loadData</span><span class="op" id="7811429">(</span><span class="op" id="7811430">)</span>&nbsp;<span class="op" id="7811432">(</span><span class="ident" id="7811433">flows</span>&nbsp;<span class="op" id="7811439">[</span><span class="op" id="7811440">]</span><span class="op" id="7811441">[</span><span class="op" id="7811442">]</span><span class="builtintype" id="7811443">byte</span><span class="op" id="7811447">,</span>&nbsp;<span class="ident" id="7811449">err</span>&nbsp;<span class="builtintype" id="7811453">error</span><span class="op" id="7811458">)</span>&nbsp;<span class="op" id="7811460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7811463">in</span><span class="op" id="7811465">,</span>&nbsp;<span class="ident" id="7811467">err</span>&nbsp;<span class="op" id="7811471">:=</span>&nbsp;<span class="ident" id="7811474">os</span><span class="op" id="7811476">.</span><span class="ident" id="7811477">Open</span><span class="op" id="7811481">(</span><span class="ident" id="7811482">test</span><span class="op" id="7811486">.</span><span class="ident" id="7811487">dataPath</span><span class="op" id="7811495">(</span><span class="op" id="7811496">)</span><span class="op" id="7811497">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7811500">if</span>&nbsp;<span class="ident" id="7811503">err</span>&nbsp;<span class="op" id="7811507">!=</span>&nbsp;<span class="ident" id="7811510">nil</span>&nbsp;<span class="op" id="7811514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7811518">return</span>&nbsp;<span class="ident" id="7811525">nil</span><span class="op" id="7811528">,</span>&nbsp;<span class="ident" id="7811530">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7811535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7811538">defer</span>&nbsp;<span class="ident" id="7811544">in</span><span class="op" id="7811546">.</span><span class="ident" id="7811547">Close</span><span class="op" id="7811552">(</span><span class="op" id="7811553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7811556">return</span>&nbsp;<span class="ident" id="7811563">parseTestData</span><span class="op" id="7811576">(</span><span class="ident" id="7811577">in</span><span class="op" id="7811579">)</span><br>
<span class="lineno">165</span><span class="op" id="7811581">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7811584">func</span>&nbsp;<span class="op" id="7811589">(</span><span class="ident" id="7811590">test</span>&nbsp;<span class="op" id="7811595">*</span><span class="ident" id="7811596">clientTest</span><span class="op" id="7811606">)</span>&nbsp;<span class="ident" id="7811608">run</span><span class="op" id="7811611">(</span><span class="ident" id="7811612">t</span>&nbsp;<span class="op" id="7811614">*</span><span class="ident" id="7811615">testing</span><span class="op" id="7811622">.</span><span class="ident" id="7811623">T</span><span class="op" id="7811624">,</span>&nbsp;<span class="ident" id="7811626">write</span>&nbsp;<span class="builtintype" id="7811632">bool</span><span class="op" id="7811636">)</span>&nbsp;<span class="op" id="7811638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7811641">var</span>&nbsp;<span class="ident" id="7811645">clientConn</span><span class="op" id="7811655">,</span>&nbsp;<span class="ident" id="7811657">serverConn</span>&nbsp;<span class="ident" id="7811668">net</span><span class="op" id="7811671">.</span><span class="ident" id="7811672">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7811678">var</span>&nbsp;<span class="ident" id="7811682">recordingConn</span>&nbsp;<span class="op" id="7811696">*</span><span class="ident" id="7811697">recordingConn</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7811712">var</span>&nbsp;<span class="ident" id="7811716">childProcess</span>&nbsp;<span class="op" id="7811729">*</span><span class="ident" id="7811730">exec</span><span class="op" id="7811734">.</span><span class="ident" id="7811735">Cmd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7811740">var</span>&nbsp;<span class="ident" id="7811744">stdin</span>&nbsp;<span class="ident" id="7811750">blockingSource</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7811767">if</span>&nbsp;<span class="ident" id="7811770">write</span>&nbsp;<span class="op" id="7811776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7811780">var</span>&nbsp;<span class="ident" id="7811784">err</span>&nbsp;<span class="builtintype" id="7811788">error</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7811796">recordingConn</span><span class="op" id="7811809">,</span>&nbsp;<span class="ident" id="7811811">childProcess</span><span class="op" id="7811823">,</span>&nbsp;<span class="ident" id="7811825">stdin</span><span class="op" id="7811830">,</span>&nbsp;<span class="ident" id="7811832">err</span>&nbsp;<span class="op" id="7811836">=</span>&nbsp;<span class="ident" id="7811838">test</span><span class="op" id="7811842">.</span><span class="ident" id="7811843">connFromCommand</span><span class="op" id="7811858">(</span><span class="op" id="7811859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7811863">if</span>&nbsp;<span class="ident" id="7811866">err</span>&nbsp;<span class="op" id="7811870">!=</span>&nbsp;<span class="ident" id="7811873">nil</span>&nbsp;<span class="op" id="7811877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7811882">t</span><span class="op" id="7811883">.</span><span class="ident" id="7811884">Fatalf</span><span class="op" id="7811890">(</span><span class="string" id="7811891">&#34;Failed&nbsp;to&nbsp;start&nbsp;subcommand:&nbsp;%s&#34;</span><span class="op" id="7811923">,</span>&nbsp;<span class="ident" id="7811925">err</span><span class="op" id="7811928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7811932">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7811936">clientConn</span>&nbsp;<span class="op" id="7811947">=</span>&nbsp;<span class="ident" id="7811949">recordingConn</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7811964">}</span>&nbsp;<span class="keyword" id="7811966">else</span>&nbsp;<span class="op" id="7811971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7811975">clientConn</span><span class="op" id="7811985">,</span>&nbsp;<span class="ident" id="7811987">serverConn</span>&nbsp;<span class="op" id="7811998">=</span>&nbsp;<span class="ident" id="7812000">net</span><span class="op" id="7812003">.</span><span class="ident" id="7812004">Pipe</span><span class="op" id="7812008">(</span><span class="op" id="7812009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7812012">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7812016">config</span>&nbsp;<span class="op" id="7812023">:=</span>&nbsp;<span class="ident" id="7812026">test</span><span class="op" id="7812030">.</span><span class="ident" id="7812031">config</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7812039">if</span>&nbsp;<span class="ident" id="7812042">config</span>&nbsp;<span class="op" id="7812049">==</span>&nbsp;<span class="ident" id="7812052">nil</span>&nbsp;<span class="op" id="7812056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7812060">config</span>&nbsp;<span class="op" id="7812067">=</span>&nbsp;<span class="ident" id="7812069">testConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7812081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7812084">client</span>&nbsp;<span class="op" id="7812091">:=</span>&nbsp;<span class="ident" id="7812094">Client</span><span class="op" id="7812100">(</span><span class="ident" id="7812101">clientConn</span><span class="op" id="7812111">,</span>&nbsp;<span class="ident" id="7812113">config</span><span class="op" id="7812119">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7812123">doneChan</span>&nbsp;<span class="op" id="7812132">:=</span>&nbsp;<span class="builtinfunc" id="7812135">make</span><span class="op" id="7812139">(</span><span class="keyword" id="7812140">chan</span>&nbsp;<span class="builtintype" id="7812145">bool</span><span class="op" id="7812149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7812152">go</span>&nbsp;<span class="keyword" id="7812155">func</span><span class="op" id="7812159">(</span><span class="op" id="7812160">)</span>&nbsp;<span class="op" id="7812162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7812166">if</span>&nbsp;<span class="ident" id="7812169">_</span><span class="op" id="7812170">,</span>&nbsp;<span class="ident" id="7812172">err</span>&nbsp;<span class="op" id="7812176">:=</span>&nbsp;<span class="ident" id="7812179">client</span><span class="op" id="7812185">.</span><span class="ident" id="7812186">Write</span><span class="op" id="7812191">(</span><span class="op" id="7812192">[</span><span class="op" id="7812193">]</span><span class="builtintype" id="7812194">byte</span><span class="op" id="7812198">(</span><span class="string" id="7812199">&#34;hello\n&#34;</span><span class="op" id="7812208">)</span><span class="op" id="7812209">)</span><span class="op" id="7812210">;</span>&nbsp;<span class="ident" id="7812212">err</span>&nbsp;<span class="op" id="7812216">!=</span>&nbsp;<span class="ident" id="7812219">nil</span>&nbsp;<span class="op" id="7812223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7812228">t</span><span class="op" id="7812229">.</span><span class="ident" id="7812230">Logf</span><span class="op" id="7812234">(</span><span class="string" id="7812235">&#34;Client.Write&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7812260">,</span>&nbsp;<span class="ident" id="7812262">err</span><span class="op" id="7812265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7812269">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7812273">if</span>&nbsp;<span class="ident" id="7812276">test</span><span class="op" id="7812280">.</span><span class="ident" id="7812281">validate</span>&nbsp;<span class="op" id="7812290">!=</span>&nbsp;<span class="ident" id="7812293">nil</span>&nbsp;<span class="op" id="7812297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7812302">if</span>&nbsp;<span class="ident" id="7812305">err</span>&nbsp;<span class="op" id="7812309">:=</span>&nbsp;<span class="ident" id="7812312">test</span><span class="op" id="7812316">.</span><span class="ident" id="7812317">validate</span><span class="op" id="7812325">(</span><span class="ident" id="7812326">client</span><span class="op" id="7812332">.</span><span class="ident" id="7812333">ConnectionState</span><span class="op" id="7812348">(</span><span class="op" id="7812349">)</span><span class="op" id="7812350">)</span><span class="op" id="7812351">;</span>&nbsp;<span class="ident" id="7812353">err</span>&nbsp;<span class="op" id="7812357">!=</span>&nbsp;<span class="ident" id="7812360">nil</span>&nbsp;<span class="op" id="7812364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7812370">t</span><span class="op" id="7812371">.</span><span class="ident" id="7812372">Logf</span><span class="op" id="7812376">(</span><span class="string" id="7812377">&#34;validate&nbsp;callback&nbsp;returned&nbsp;error:&nbsp;%s&#34;</span><span class="op" id="7812415">,</span>&nbsp;<span class="ident" id="7812417">err</span><span class="op" id="7812420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7812425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7812429">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7812433">client</span><span class="op" id="7812439">.</span><span class="ident" id="7812440">Close</span><span class="op" id="7812445">(</span><span class="op" id="7812446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7812450">clientConn</span><span class="op" id="7812460">.</span><span class="ident" id="7812461">Close</span><span class="op" id="7812466">(</span><span class="op" id="7812467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7812471">doneChan</span>&nbsp;<span class="op" id="7812480">&lt;-</span>&nbsp;<span class="ident" id="7812483">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7812489">}</span><span class="op" id="7812490">(</span><span class="op" id="7812491">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7812495">if</span>&nbsp;<span class="op" id="7812498">!</span><span class="ident" id="7812499">write</span>&nbsp;<span class="op" id="7812505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7812509">flows</span><span class="op" id="7812514">,</span>&nbsp;<span class="ident" id="7812516">err</span>&nbsp;<span class="op" id="7812520">:=</span>&nbsp;<span class="ident" id="7812523">test</span><span class="op" id="7812527">.</span><span class="ident" id="7812528">loadData</span><span class="op" id="7812536">(</span><span class="op" id="7812537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7812541">if</span>&nbsp;<span class="ident" id="7812544">err</span>&nbsp;<span class="op" id="7812548">!=</span>&nbsp;<span class="ident" id="7812551">nil</span>&nbsp;<span class="op" id="7812555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7812560">t</span><span class="op" id="7812561">.</span><span class="ident" id="7812562">Fatalf</span><span class="op" id="7812568">(</span><span class="string" id="7812569">&#34;%s:&nbsp;failed&nbsp;to&nbsp;load&nbsp;data&nbsp;from&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="7812606">,</span>&nbsp;<span class="ident" id="7812608">test</span><span class="op" id="7812612">.</span><span class="ident" id="7812613">name</span><span class="op" id="7812617">,</span>&nbsp;<span class="ident" id="7812619">test</span><span class="op" id="7812623">.</span><span class="ident" id="7812624">dataPath</span><span class="op" id="7812632">(</span><span class="op" id="7812633">)</span><span class="op" id="7812634">,</span>&nbsp;<span class="ident" id="7812636">err</span><span class="op" id="7812639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7812643">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7812647">for</span>&nbsp;<span class="ident" id="7812651">i</span><span class="op" id="7812652">,</span>&nbsp;<span class="ident" id="7812654">b</span>&nbsp;<span class="op" id="7812656">:=</span>&nbsp;<span class="keyword" id="7812659">range</span>&nbsp;<span class="ident" id="7812665">flows</span>&nbsp;<span class="op" id="7812671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7812676">if</span>&nbsp;<span class="ident" id="7812679">i</span><span class="op" id="7812680">%</span><span class="num" id="7812681">2</span>&nbsp;<span class="op" id="7812683">==</span>&nbsp;<span class="num" id="7812686">1</span>&nbsp;<span class="op" id="7812688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7812694">serverConn</span><span class="op" id="7812704">.</span><span class="ident" id="7812705">Write</span><span class="op" id="7812710">(</span><span class="ident" id="7812711">b</span><span class="op" id="7812712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7812718">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7812730">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7812735">bb</span>&nbsp;<span class="op" id="7812738">:=</span>&nbsp;<span class="builtinfunc" id="7812741">make</span><span class="op" id="7812745">(</span><span class="op" id="7812746">[</span><span class="op" id="7812747">]</span><span class="builtintype" id="7812748">byte</span><span class="op" id="7812752">,</span>&nbsp;<span class="builtinfunc" id="7812754">len</span><span class="op" id="7812757">(</span><span class="ident" id="7812758">b</span><span class="op" id="7812759">)</span><span class="op" id="7812760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7812765">_</span><span class="op" id="7812766">,</span>&nbsp;<span class="ident" id="7812768">err</span>&nbsp;<span class="op" id="7812772">:=</span>&nbsp;<span class="ident" id="7812775">io</span><span class="op" id="7812777">.</span><span class="ident" id="7812778">ReadFull</span><span class="op" id="7812786">(</span><span class="ident" id="7812787">serverConn</span><span class="op" id="7812797">,</span>&nbsp;<span class="ident" id="7812799">bb</span><span class="op" id="7812801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7812806">if</span>&nbsp;<span class="ident" id="7812809">err</span>&nbsp;<span class="op" id="7812813">!=</span>&nbsp;<span class="ident" id="7812816">nil</span>&nbsp;<span class="op" id="7812820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7812826">t</span><span class="op" id="7812827">.</span><span class="ident" id="7812828">Fatalf</span><span class="op" id="7812834">(</span><span class="string" id="7812835">&#34;%s&nbsp;#%d:&nbsp;%s&#34;</span><span class="op" id="7812847">,</span>&nbsp;<span class="ident" id="7812849">test</span><span class="op" id="7812853">.</span><span class="ident" id="7812854">name</span><span class="op" id="7812858">,</span>&nbsp;<span class="ident" id="7812860">i</span><span class="op" id="7812861">,</span>&nbsp;<span class="ident" id="7812863">err</span><span class="op" id="7812866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7812871">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7812876">if</span>&nbsp;<span class="op" id="7812879">!</span><span class="ident" id="7812880">bytes</span><span class="op" id="7812885">.</span><span class="ident" id="7812886">Equal</span><span class="op" id="7812891">(</span><span class="ident" id="7812892">b</span><span class="op" id="7812893">,</span>&nbsp;<span class="ident" id="7812895">bb</span><span class="op" id="7812897">)</span>&nbsp;<span class="op" id="7812899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7812905">t</span><span class="op" id="7812906">.</span><span class="ident" id="7812907">Fatalf</span><span class="op" id="7812913">(</span><span class="string" id="7812914">&#34;%s&nbsp;#%d:&nbsp;mismatch&nbsp;on&nbsp;read:&nbsp;got:%x&nbsp;want:%x&#34;</span><span class="op" id="7812956">,</span>&nbsp;<span class="ident" id="7812958">test</span><span class="op" id="7812962">.</span><span class="ident" id="7812963">name</span><span class="op" id="7812967">,</span>&nbsp;<span class="ident" id="7812969">i</span><span class="op" id="7812970">,</span>&nbsp;<span class="ident" id="7812972">bb</span><span class="op" id="7812974">,</span>&nbsp;<span class="ident" id="7812976">b</span><span class="op" id="7812977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7812982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7812986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7812990">serverConn</span><span class="op" id="7813000">.</span><span class="ident" id="7813001">Close</span><span class="op" id="7813006">(</span><span class="op" id="7813007">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7813010">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7813014">&lt;-</span><span class="ident" id="7813016">doneChan</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7813027">if</span>&nbsp;<span class="ident" id="7813030">write</span>&nbsp;<span class="op" id="7813036">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7813040">path</span>&nbsp;<span class="op" id="7813045">:=</span>&nbsp;<span class="ident" id="7813048">test</span><span class="op" id="7813052">.</span><span class="ident" id="7813053">dataPath</span><span class="op" id="7813061">(</span><span class="op" id="7813062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7813066">out</span><span class="op" id="7813069">,</span>&nbsp;<span class="ident" id="7813071">err</span>&nbsp;<span class="op" id="7813075">:=</span>&nbsp;<span class="ident" id="7813078">os</span><span class="op" id="7813080">.</span><span class="ident" id="7813081">OpenFile</span><span class="op" id="7813089">(</span><span class="ident" id="7813090">path</span><span class="op" id="7813094">,</span>&nbsp;<span class="ident" id="7813096">os</span><span class="op" id="7813098">.</span><span class="ident" id="7813099">O_WRONLY</span><span class="op" id="7813107">|</span><span class="ident" id="7813108">os</span><span class="op" id="7813110">.</span><span class="ident" id="7813111">O_CREATE</span><span class="op" id="7813119">|</span><span class="ident" id="7813120">os</span><span class="op" id="7813122">.</span><span class="ident" id="7813123">O_TRUNC</span><span class="op" id="7813130">,</span>&nbsp;<span class="num" id="7813132">0644</span><span class="op" id="7813136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7813140">if</span>&nbsp;<span class="ident" id="7813143">err</span>&nbsp;<span class="op" id="7813147">!=</span>&nbsp;<span class="ident" id="7813150">nil</span>&nbsp;<span class="op" id="7813154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7813159">t</span><span class="op" id="7813160">.</span><span class="ident" id="7813161">Fatalf</span><span class="op" id="7813167">(</span><span class="string" id="7813168">&#34;Failed&nbsp;to&nbsp;create&nbsp;output&nbsp;file:&nbsp;%s&#34;</span><span class="op" id="7813202">,</span>&nbsp;<span class="ident" id="7813204">err</span><span class="op" id="7813207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7813211">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7813215">defer</span>&nbsp;<span class="ident" id="7813221">out</span><span class="op" id="7813224">.</span><span class="ident" id="7813225">Close</span><span class="op" id="7813230">(</span><span class="op" id="7813231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7813235">recordingConn</span><span class="op" id="7813248">.</span><span class="ident" id="7813249">Close</span><span class="op" id="7813254">(</span><span class="op" id="7813255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7813259">close</span><span class="op" id="7813264">(</span><span class="ident" id="7813265">stdin</span><span class="op" id="7813270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7813274">childProcess</span><span class="op" id="7813286">.</span><span class="ident" id="7813287">Process</span><span class="op" id="7813294">.</span><span class="ident" id="7813295">Kill</span><span class="op" id="7813299">(</span><span class="op" id="7813300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7813304">childProcess</span><span class="op" id="7813316">.</span><span class="ident" id="7813317">Wait</span><span class="op" id="7813321">(</span><span class="op" id="7813322">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7813326">if</span>&nbsp;<span class="builtinfunc" id="7813329">len</span><span class="op" id="7813332">(</span><span class="ident" id="7813333">recordingConn</span><span class="op" id="7813346">.</span><span class="ident" id="7813347">flows</span><span class="op" id="7813352">)</span>&nbsp;<span class="op" id="7813354">&lt;</span>&nbsp;<span class="num" id="7813356">3</span>&nbsp;<span class="op" id="7813358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7813363">childProcess</span><span class="op" id="7813375">.</span><span class="ident" id="7813376">Stdout</span><span class="op" id="7813382">.</span><span class="op" id="7813383">(</span><span class="op" id="7813384">*</span><span class="ident" id="7813385">bytes</span><span class="op" id="7813390">.</span><span class="ident" id="7813391">Buffer</span><span class="op" id="7813397">)</span><span class="op" id="7813398">.</span><span class="ident" id="7813399">WriteTo</span><span class="op" id="7813406">(</span><span class="ident" id="7813407">os</span><span class="op" id="7813409">.</span><span class="ident" id="7813410">Stdout</span><span class="op" id="7813416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7813421">t</span><span class="op" id="7813422">.</span><span class="ident" id="7813423">Fatalf</span><span class="op" id="7813429">(</span><span class="string" id="7813430">&#34;Client&nbsp;connection&nbsp;didn&#39;t&nbsp;work&#34;</span><span class="op" id="7813461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7813465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7813469">recordingConn</span><span class="op" id="7813482">.</span><span class="ident" id="7813483">WriteTo</span><span class="op" id="7813490">(</span><span class="ident" id="7813491">out</span><span class="op" id="7813494">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7813498">fmt</span><span class="op" id="7813501">.</span><span class="ident" id="7813502">Printf</span><span class="op" id="7813508">(</span><span class="string" id="7813509">&#34;Wrote&nbsp;%s\n&#34;</span><span class="op" id="7813521">,</span>&nbsp;<span class="ident" id="7813523">path</span><span class="op" id="7813527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7813530">}</span><br>
<span class="lineno"></span><span class="op" id="7813532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7813535">func</span>&nbsp;<span class="ident" id="7813540">runClientTestForVersion</span><span class="op" id="7813563">(</span><span class="ident" id="7813564">t</span>&nbsp;<span class="op" id="7813566">*</span><span class="ident" id="7813567">testing</span><span class="op" id="7813574">.</span><span class="ident" id="7813575">T</span><span class="op" id="7813576">,</span>&nbsp;<span class="ident" id="7813578">template</span>&nbsp;<span class="op" id="7813587">*</span><span class="ident" id="7813588">clientTest</span><span class="op" id="7813598">,</span>&nbsp;<span class="ident" id="7813600">prefix</span><span class="op" id="7813606">,</span>&nbsp;<span class="ident" id="7813608">option</span>&nbsp;<span class="builtintype" id="7813615">string</span><span class="op" id="7813621">)</span>&nbsp;<span class="op" id="7813623">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7813626">test</span>&nbsp;<span class="op" id="7813631">:=</span>&nbsp;<span class="op" id="7813634">*</span><span class="ident" id="7813635">template</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7813645">test</span><span class="op" id="7813649">.</span><span class="ident" id="7813650">name</span>&nbsp;<span class="op" id="7813655">=</span>&nbsp;<span class="ident" id="7813657">prefix</span>&nbsp;<span class="op" id="7813664">+</span>&nbsp;<span class="ident" id="7813666">test</span><span class="op" id="7813670">.</span><span class="ident" id="7813671">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7813677">if</span>&nbsp;<span class="builtinfunc" id="7813680">len</span><span class="op" id="7813683">(</span><span class="ident" id="7813684">test</span><span class="op" id="7813688">.</span><span class="ident" id="7813689">command</span><span class="op" id="7813696">)</span>&nbsp;<span class="op" id="7813698">==</span>&nbsp;<span class="num" id="7813701">0</span>&nbsp;<span class="op" id="7813703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7813707">test</span><span class="op" id="7813711">.</span><span class="ident" id="7813712">command</span>&nbsp;<span class="op" id="7813720">=</span>&nbsp;<span class="ident" id="7813722">defaultClientCommand</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7813744">}</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7813747">test</span><span class="op" id="7813751">.</span><span class="ident" id="7813752">command</span>&nbsp;<span class="op" id="7813760">=</span>&nbsp;<span class="builtinfunc" id="7813762">append</span><span class="op" id="7813768">(</span><span class="op" id="7813769">[</span><span class="op" id="7813770">]</span><span class="builtintype" id="7813771">string</span><span class="op" id="7813777">(</span><span class="ident" id="7813778">nil</span><span class="op" id="7813781">)</span><span class="op" id="7813782">,</span>&nbsp;<span class="ident" id="7813784">test</span><span class="op" id="7813788">.</span><span class="ident" id="7813789">command</span><span class="op" id="7813796">...</span><span class="op" id="7813799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7813802">test</span><span class="op" id="7813806">.</span><span class="ident" id="7813807">command</span>&nbsp;<span class="op" id="7813815">=</span>&nbsp;<span class="builtinfunc" id="7813817">append</span><span class="op" id="7813823">(</span><span class="ident" id="7813824">test</span><span class="op" id="7813828">.</span><span class="ident" id="7813829">command</span><span class="op" id="7813836">,</span>&nbsp;<span class="ident" id="7813838">option</span><span class="op" id="7813844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7813847">test</span><span class="op" id="7813851">.</span><span class="ident" id="7813852">run</span><span class="op" id="7813855">(</span><span class="ident" id="7813856">t</span><span class="op" id="7813857">,</span>&nbsp;<span class="op" id="7813859">*</span><span class="ident" id="7813860">update</span><span class="op" id="7813866">)</span><br>
<span class="lineno"></span><span class="op" id="7813868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span><span class="keyword" id="7813871">func</span>&nbsp;<span class="ident" id="7813876">runClientTestTLS10</span><span class="op" id="7813894">(</span><span class="ident" id="7813895">t</span>&nbsp;<span class="op" id="7813897">*</span><span class="ident" id="7813898">testing</span><span class="op" id="7813905">.</span><span class="ident" id="7813906">T</span><span class="op" id="7813907">,</span>&nbsp;<span class="ident" id="7813909">template</span>&nbsp;<span class="op" id="7813918">*</span><span class="ident" id="7813919">clientTest</span><span class="op" id="7813929">)</span>&nbsp;<span class="op" id="7813931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7813934">runClientTestForVersion</span><span class="op" id="7813957">(</span><span class="ident" id="7813958">t</span><span class="op" id="7813959">,</span>&nbsp;<span class="ident" id="7813961">template</span><span class="op" id="7813969">,</span>&nbsp;<span class="string" id="7813971">&#34;TLSv10-&#34;</span><span class="op" id="7813980">,</span>&nbsp;<span class="string" id="7813982">&#34;-tls1&#34;</span><span class="op" id="7813989">)</span><br>
<span class="lineno"></span><span class="op" id="7813991">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7813994">func</span>&nbsp;<span class="ident" id="7813999">runClientTestTLS11</span><span class="op" id="7814017">(</span><span class="ident" id="7814018">t</span>&nbsp;<span class="op" id="7814020">*</span><span class="ident" id="7814021">testing</span><span class="op" id="7814028">.</span><span class="ident" id="7814029">T</span><span class="op" id="7814030">,</span>&nbsp;<span class="ident" id="7814032">template</span>&nbsp;<span class="op" id="7814041">*</span><span class="ident" id="7814042">clientTest</span><span class="op" id="7814052">)</span>&nbsp;<span class="op" id="7814054">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7814057">runClientTestForVersion</span><span class="op" id="7814080">(</span><span class="ident" id="7814081">t</span><span class="op" id="7814082">,</span>&nbsp;<span class="ident" id="7814084">template</span><span class="op" id="7814092">,</span>&nbsp;<span class="string" id="7814094">&#34;TLSv11-&#34;</span><span class="op" id="7814103">,</span>&nbsp;<span class="string" id="7814105">&#34;-tls1_1&#34;</span><span class="op" id="7814114">)</span><br>
<span class="lineno"></span><span class="op" id="7814116">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7814119">func</span>&nbsp;<span class="ident" id="7814124">runClientTestTLS12</span><span class="op" id="7814142">(</span><span class="ident" id="7814143">t</span>&nbsp;<span class="op" id="7814145">*</span><span class="ident" id="7814146">testing</span><span class="op" id="7814153">.</span><span class="ident" id="7814154">T</span><span class="op" id="7814155">,</span>&nbsp;<span class="ident" id="7814157">template</span>&nbsp;<span class="op" id="7814166">*</span><span class="ident" id="7814167">clientTest</span><span class="op" id="7814177">)</span>&nbsp;<span class="op" id="7814179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7814182">runClientTestForVersion</span><span class="op" id="7814205">(</span><span class="ident" id="7814206">t</span><span class="op" id="7814207">,</span>&nbsp;<span class="ident" id="7814209">template</span><span class="op" id="7814217">,</span>&nbsp;<span class="string" id="7814219">&#34;TLSv12-&#34;</span><span class="op" id="7814228">,</span>&nbsp;<span class="string" id="7814230">&#34;-tls1_2&#34;</span><span class="op" id="7814239">)</span><br>
<span class="lineno">270</span><span class="op" id="7814241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7814244">func</span>&nbsp;<span class="ident" id="7814249">TestHandshakeClientRSARC4</span><span class="op" id="7814274">(</span><span class="ident" id="7814275">t</span>&nbsp;<span class="op" id="7814277">*</span><span class="ident" id="7814278">testing</span><span class="op" id="7814285">.</span><span class="ident" id="7814286">T</span><span class="op" id="7814287">)</span>&nbsp;<span class="op" id="7814289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7814292">test</span>&nbsp;<span class="op" id="7814297">:=</span>&nbsp;<span class="op" id="7814300">&amp;</span><span class="ident" id="7814301">clientTest</span><span class="op" id="7814311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7814315">name</span><span class="op" id="7814319">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7814324">&#34;RSA-RC4&#34;</span><span class="op" id="7814333">,</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7814337">command</span><span class="op" id="7814344">:</span>&nbsp;<span class="op" id="7814346">[</span><span class="op" id="7814347">]</span><span class="builtintype" id="7814348">string</span><span class="op" id="7814354">{</span><span class="string" id="7814355">&#34;openssl&#34;</span><span class="op" id="7814364">,</span>&nbsp;<span class="string" id="7814366">&#34;s_server&#34;</span><span class="op" id="7814376">,</span>&nbsp;<span class="string" id="7814378">&#34;-cipher&#34;</span><span class="op" id="7814387">,</span>&nbsp;<span class="string" id="7814389">&#34;RC4-SHA&#34;</span><span class="op" id="7814398">}</span><span class="op" id="7814399">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7814402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7814405">runClientTestTLS10</span><span class="op" id="7814423">(</span><span class="ident" id="7814424">t</span><span class="op" id="7814425">,</span>&nbsp;<span class="ident" id="7814427">test</span><span class="op" id="7814431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7814434">runClientTestTLS11</span><span class="op" id="7814452">(</span><span class="ident" id="7814453">t</span><span class="op" id="7814454">,</span>&nbsp;<span class="ident" id="7814456">test</span><span class="op" id="7814460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7814463">runClientTestTLS12</span><span class="op" id="7814481">(</span><span class="ident" id="7814482">t</span><span class="op" id="7814483">,</span>&nbsp;<span class="ident" id="7814485">test</span><span class="op" id="7814489">)</span><br>
<span class="lineno">280</span><span class="op" id="7814491">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7814494">func</span>&nbsp;<span class="ident" id="7814499">TestHandshakeClientECDHERSAAES</span><span class="op" id="7814529">(</span><span class="ident" id="7814530">t</span>&nbsp;<span class="op" id="7814532">*</span><span class="ident" id="7814533">testing</span><span class="op" id="7814540">.</span><span class="ident" id="7814541">T</span><span class="op" id="7814542">)</span>&nbsp;<span class="op" id="7814544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7814547">test</span>&nbsp;<span class="op" id="7814552">:=</span>&nbsp;<span class="op" id="7814555">&amp;</span><span class="ident" id="7814556">clientTest</span><span class="op" id="7814566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7814570">name</span><span class="op" id="7814574">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7814579">&#34;ECDHE-RSA-AES&#34;</span><span class="op" id="7814594">,</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7814598">command</span><span class="op" id="7814605">:</span>&nbsp;<span class="op" id="7814607">[</span><span class="op" id="7814608">]</span><span class="builtintype" id="7814609">string</span><span class="op" id="7814615">{</span><span class="string" id="7814616">&#34;openssl&#34;</span><span class="op" id="7814625">,</span>&nbsp;<span class="string" id="7814627">&#34;s_server&#34;</span><span class="op" id="7814637">,</span>&nbsp;<span class="string" id="7814639">&#34;-cipher&#34;</span><span class="op" id="7814648">,</span>&nbsp;<span class="string" id="7814650">&#34;ECDHE-RSA-AES128-SHA&#34;</span><span class="op" id="7814672">}</span><span class="op" id="7814673">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7814676">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7814679">runClientTestTLS10</span><span class="op" id="7814697">(</span><span class="ident" id="7814698">t</span><span class="op" id="7814699">,</span>&nbsp;<span class="ident" id="7814701">test</span><span class="op" id="7814705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7814708">runClientTestTLS11</span><span class="op" id="7814726">(</span><span class="ident" id="7814727">t</span><span class="op" id="7814728">,</span>&nbsp;<span class="ident" id="7814730">test</span><span class="op" id="7814734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7814737">runClientTestTLS12</span><span class="op" id="7814755">(</span><span class="ident" id="7814756">t</span><span class="op" id="7814757">,</span>&nbsp;<span class="ident" id="7814759">test</span><span class="op" id="7814763">)</span><br>
<span class="lineno">290</span><span class="op" id="7814765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7814768">func</span>&nbsp;<span class="ident" id="7814773">TestHandshakeClientECDHEECDSAAES</span><span class="op" id="7814805">(</span><span class="ident" id="7814806">t</span>&nbsp;<span class="op" id="7814808">*</span><span class="ident" id="7814809">testing</span><span class="op" id="7814816">.</span><span class="ident" id="7814817">T</span><span class="op" id="7814818">)</span>&nbsp;<span class="op" id="7814820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7814823">test</span>&nbsp;<span class="op" id="7814828">:=</span>&nbsp;<span class="op" id="7814831">&amp;</span><span class="ident" id="7814832">clientTest</span><span class="op" id="7814842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7814846">name</span><span class="op" id="7814850">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7814855">&#34;ECDHE-ECDSA-AES&#34;</span><span class="op" id="7814872">,</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7814876">command</span><span class="op" id="7814883">:</span>&nbsp;<span class="op" id="7814885">[</span><span class="op" id="7814886">]</span><span class="builtintype" id="7814887">string</span><span class="op" id="7814893">{</span><span class="string" id="7814894">&#34;openssl&#34;</span><span class="op" id="7814903">,</span>&nbsp;<span class="string" id="7814905">&#34;s_server&#34;</span><span class="op" id="7814915">,</span>&nbsp;<span class="string" id="7814917">&#34;-cipher&#34;</span><span class="op" id="7814926">,</span>&nbsp;<span class="string" id="7814928">&#34;ECDHE-ECDSA-AES128-SHA&#34;</span><span class="op" id="7814952">}</span><span class="op" id="7814953">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7814957">cert</span><span class="op" id="7814961">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7814966">testECDSACertificate</span><span class="op" id="7814986">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7814990">key</span><span class="op" id="7814993">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7814999">testECDSAPrivateKey</span><span class="op" id="7815018">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7815021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7815024">runClientTestTLS10</span><span class="op" id="7815042">(</span><span class="ident" id="7815043">t</span><span class="op" id="7815044">,</span>&nbsp;<span class="ident" id="7815046">test</span><span class="op" id="7815050">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7815053">runClientTestTLS11</span><span class="op" id="7815071">(</span><span class="ident" id="7815072">t</span><span class="op" id="7815073">,</span>&nbsp;<span class="ident" id="7815075">test</span><span class="op" id="7815079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7815082">runClientTestTLS12</span><span class="op" id="7815100">(</span><span class="ident" id="7815101">t</span><span class="op" id="7815102">,</span>&nbsp;<span class="ident" id="7815104">test</span><span class="op" id="7815108">)</span><br>
<span class="lineno"></span><span class="op" id="7815110">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7815113">func</span>&nbsp;<span class="ident" id="7815118">TestHandshakeClientECDHEECDSAAESGCM</span><span class="op" id="7815153">(</span><span class="ident" id="7815154">t</span>&nbsp;<span class="op" id="7815156">*</span><span class="ident" id="7815157">testing</span><span class="op" id="7815164">.</span><span class="ident" id="7815165">T</span><span class="op" id="7815166">)</span>&nbsp;<span class="op" id="7815168">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7815171">test</span>&nbsp;<span class="op" id="7815176">:=</span>&nbsp;<span class="op" id="7815179">&amp;</span><span class="ident" id="7815180">clientTest</span><span class="op" id="7815190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7815194">name</span><span class="op" id="7815198">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7815203">&#34;ECDHE-ECDSA-AES-GCM&#34;</span><span class="op" id="7815224">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7815228">command</span><span class="op" id="7815235">:</span>&nbsp;<span class="op" id="7815237">[</span><span class="op" id="7815238">]</span><span class="builtintype" id="7815239">string</span><span class="op" id="7815245">{</span><span class="string" id="7815246">&#34;openssl&#34;</span><span class="op" id="7815255">,</span>&nbsp;<span class="string" id="7815257">&#34;s_server&#34;</span><span class="op" id="7815267">,</span>&nbsp;<span class="string" id="7815269">&#34;-cipher&#34;</span><span class="op" id="7815278">,</span>&nbsp;<span class="string" id="7815280">&#34;ECDHE-ECDSA-AES128-GCM-SHA256&#34;</span><span class="op" id="7815311">}</span><span class="op" id="7815312">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7815316">cert</span><span class="op" id="7815320">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7815325">testECDSACertificate</span><span class="op" id="7815345">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7815349">key</span><span class="op" id="7815352">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7815358">testECDSAPrivateKey</span><span class="op" id="7815377">,</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7815380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7815383">runClientTestTLS12</span><span class="op" id="7815401">(</span><span class="ident" id="7815402">t</span><span class="op" id="7815403">,</span>&nbsp;<span class="ident" id="7815405">test</span><span class="op" id="7815409">)</span><br>
<span class="lineno"></span><span class="op" id="7815411">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7815414">func</span>&nbsp;<span class="ident" id="7815419">TestHandshakeClientCertRSA</span><span class="op" id="7815445">(</span><span class="ident" id="7815446">t</span>&nbsp;<span class="op" id="7815448">*</span><span class="ident" id="7815449">testing</span><span class="op" id="7815456">.</span><span class="ident" id="7815457">T</span><span class="op" id="7815458">)</span>&nbsp;<span class="op" id="7815460">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7815463">config</span>&nbsp;<span class="op" id="7815470">:=</span>&nbsp;<span class="op" id="7815473">*</span><span class="ident" id="7815474">testConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7815486">cert</span><span class="op" id="7815490">,</span>&nbsp;<span class="ident" id="7815492">_</span>&nbsp;<span class="op" id="7815494">:=</span>&nbsp;<span class="ident" id="7815497">X509KeyPair</span><span class="op" id="7815508">(</span><span class="op" id="7815509">[</span><span class="op" id="7815510">]</span><span class="builtintype" id="7815511">byte</span><span class="op" id="7815515">(</span><span class="ident" id="7815516">clientCertificatePEM</span><span class="op" id="7815536">)</span><span class="op" id="7815537">,</span>&nbsp;<span class="op" id="7815539">[</span><span class="op" id="7815540">]</span><span class="builtintype" id="7815541">byte</span><span class="op" id="7815545">(</span><span class="ident" id="7815546">clientKeyPEM</span><span class="op" id="7815558">)</span><span class="op" id="7815559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7815562">config</span><span class="op" id="7815568">.</span><span class="ident" id="7815569">Certificates</span>&nbsp;<span class="op" id="7815582">=</span>&nbsp;<span class="op" id="7815584">[</span><span class="op" id="7815585">]</span><span class="ident" id="7815586">Certificate</span><span class="op" id="7815597">{</span><span class="ident" id="7815598">cert</span><span class="op" id="7815602">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7815606">test</span>&nbsp;<span class="op" id="7815611">:=</span>&nbsp;<span class="op" id="7815614">&amp;</span><span class="ident" id="7815615">clientTest</span><span class="op" id="7815625">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7815629">name</span><span class="op" id="7815633">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7815638">&#34;ClientCert-RSA-RSA&#34;</span><span class="op" id="7815658">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7815662">command</span><span class="op" id="7815669">:</span>&nbsp;<span class="op" id="7815671">[</span><span class="op" id="7815672">]</span><span class="builtintype" id="7815673">string</span><span class="op" id="7815679">{</span><span class="string" id="7815680">&#34;openssl&#34;</span><span class="op" id="7815689">,</span>&nbsp;<span class="string" id="7815691">&#34;s_server&#34;</span><span class="op" id="7815701">,</span>&nbsp;<span class="string" id="7815703">&#34;-cipher&#34;</span><span class="op" id="7815712">,</span>&nbsp;<span class="string" id="7815714">&#34;RC4-SHA&#34;</span><span class="op" id="7815723">,</span>&nbsp;<span class="string" id="7815725">&#34;-verify&#34;</span><span class="op" id="7815734">,</span>&nbsp;<span class="string" id="7815736">&#34;1&#34;</span><span class="op" id="7815739">}</span><span class="op" id="7815740">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7815744">config</span><span class="op" id="7815750">:</span>&nbsp;&nbsp;<span class="op" id="7815753">&amp;</span><span class="ident" id="7815754">config</span><span class="op" id="7815760">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7815763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7815767">runClientTestTLS10</span><span class="op" id="7815785">(</span><span class="ident" id="7815786">t</span><span class="op" id="7815787">,</span>&nbsp;<span class="ident" id="7815789">test</span><span class="op" id="7815793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7815796">runClientTestTLS12</span><span class="op" id="7815814">(</span><span class="ident" id="7815815">t</span><span class="op" id="7815816">,</span>&nbsp;<span class="ident" id="7815818">test</span><span class="op" id="7815822">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7815826">test</span>&nbsp;<span class="op" id="7815831">=</span>&nbsp;<span class="op" id="7815833">&amp;</span><span class="ident" id="7815834">clientTest</span><span class="op" id="7815844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7815848">name</span><span class="op" id="7815852">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7815857">&#34;ClientCert-RSA-ECDSA&#34;</span><span class="op" id="7815879">,</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7815883">command</span><span class="op" id="7815890">:</span>&nbsp;<span class="op" id="7815892">[</span><span class="op" id="7815893">]</span><span class="builtintype" id="7815894">string</span><span class="op" id="7815900">{</span><span class="string" id="7815901">&#34;openssl&#34;</span><span class="op" id="7815910">,</span>&nbsp;<span class="string" id="7815912">&#34;s_server&#34;</span><span class="op" id="7815922">,</span>&nbsp;<span class="string" id="7815924">&#34;-cipher&#34;</span><span class="op" id="7815933">,</span>&nbsp;<span class="string" id="7815935">&#34;ECDHE-ECDSA-AES128-SHA&#34;</span><span class="op" id="7815959">,</span>&nbsp;<span class="string" id="7815961">&#34;-verify&#34;</span><span class="op" id="7815970">,</span>&nbsp;<span class="string" id="7815972">&#34;1&#34;</span><span class="op" id="7815975">}</span><span class="op" id="7815976">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7815980">config</span><span class="op" id="7815986">:</span>&nbsp;&nbsp;<span class="op" id="7815989">&amp;</span><span class="ident" id="7815990">config</span><span class="op" id="7815996">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7816000">cert</span><span class="op" id="7816004">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7816009">testECDSACertificate</span><span class="op" id="7816029">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7816033">key</span><span class="op" id="7816036">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7816042">testECDSAPrivateKey</span><span class="op" id="7816061">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7816064">}</span><br>
<span class="lineno">335</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7816068">runClientTestTLS10</span><span class="op" id="7816086">(</span><span class="ident" id="7816087">t</span><span class="op" id="7816088">,</span>&nbsp;<span class="ident" id="7816090">test</span><span class="op" id="7816094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7816097">runClientTestTLS12</span><span class="op" id="7816115">(</span><span class="ident" id="7816116">t</span><span class="op" id="7816117">,</span>&nbsp;<span class="ident" id="7816119">test</span><span class="op" id="7816123">)</span><br>
<span class="lineno"></span><span class="op" id="7816125">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span><span class="keyword" id="7816128">func</span>&nbsp;<span class="ident" id="7816133">TestHandshakeClientCertECDSA</span><span class="op" id="7816161">(</span><span class="ident" id="7816162">t</span>&nbsp;<span class="op" id="7816164">*</span><span class="ident" id="7816165">testing</span><span class="op" id="7816172">.</span><span class="ident" id="7816173">T</span><span class="op" id="7816174">)</span>&nbsp;<span class="op" id="7816176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7816179">config</span>&nbsp;<span class="op" id="7816186">:=</span>&nbsp;<span class="op" id="7816189">*</span><span class="ident" id="7816190">testConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7816202">cert</span><span class="op" id="7816206">,</span>&nbsp;<span class="ident" id="7816208">_</span>&nbsp;<span class="op" id="7816210">:=</span>&nbsp;<span class="ident" id="7816213">X509KeyPair</span><span class="op" id="7816224">(</span><span class="op" id="7816225">[</span><span class="op" id="7816226">]</span><span class="builtintype" id="7816227">byte</span><span class="op" id="7816231">(</span><span class="ident" id="7816232">clientECDSACertificatePEM</span><span class="op" id="7816257">)</span><span class="op" id="7816258">,</span>&nbsp;<span class="op" id="7816260">[</span><span class="op" id="7816261">]</span><span class="builtintype" id="7816262">byte</span><span class="op" id="7816266">(</span><span class="ident" id="7816267">clientECDSAKeyPEM</span><span class="op" id="7816284">)</span><span class="op" id="7816285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7816288">config</span><span class="op" id="7816294">.</span><span class="ident" id="7816295">Certificates</span>&nbsp;<span class="op" id="7816308">=</span>&nbsp;<span class="op" id="7816310">[</span><span class="op" id="7816311">]</span><span class="ident" id="7816312">Certificate</span><span class="op" id="7816323">{</span><span class="ident" id="7816324">cert</span><span class="op" id="7816328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7816332">test</span>&nbsp;<span class="op" id="7816337">:=</span>&nbsp;<span class="op" id="7816340">&amp;</span><span class="ident" id="7816341">clientTest</span><span class="op" id="7816351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7816355">name</span><span class="op" id="7816359">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7816364">&#34;ClientCert-ECDSA-RSA&#34;</span><span class="op" id="7816386">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7816390">command</span><span class="op" id="7816397">:</span>&nbsp;<span class="op" id="7816399">[</span><span class="op" id="7816400">]</span><span class="builtintype" id="7816401">string</span><span class="op" id="7816407">{</span><span class="string" id="7816408">&#34;openssl&#34;</span><span class="op" id="7816417">,</span>&nbsp;<span class="string" id="7816419">&#34;s_server&#34;</span><span class="op" id="7816429">,</span>&nbsp;<span class="string" id="7816431">&#34;-cipher&#34;</span><span class="op" id="7816440">,</span>&nbsp;<span class="string" id="7816442">&#34;RC4-SHA&#34;</span><span class="op" id="7816451">,</span>&nbsp;<span class="string" id="7816453">&#34;-verify&#34;</span><span class="op" id="7816462">,</span>&nbsp;<span class="string" id="7816464">&#34;1&#34;</span><span class="op" id="7816467">}</span><span class="op" id="7816468">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7816472">config</span><span class="op" id="7816478">:</span>&nbsp;&nbsp;<span class="op" id="7816481">&amp;</span><span class="ident" id="7816482">config</span><span class="op" id="7816488">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7816491">}</span><br>
<span class="lineno">350</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7816495">runClientTestTLS10</span><span class="op" id="7816513">(</span><span class="ident" id="7816514">t</span><span class="op" id="7816515">,</span>&nbsp;<span class="ident" id="7816517">test</span><span class="op" id="7816521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7816524">runClientTestTLS12</span><span class="op" id="7816542">(</span><span class="ident" id="7816543">t</span><span class="op" id="7816544">,</span>&nbsp;<span class="ident" id="7816546">test</span><span class="op" id="7816550">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7816554">test</span>&nbsp;<span class="op" id="7816559">=</span>&nbsp;<span class="op" id="7816561">&amp;</span><span class="ident" id="7816562">clientTest</span><span class="op" id="7816572">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7816576">name</span><span class="op" id="7816580">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7816585">&#34;ClientCert-ECDSA-ECDSA&#34;</span><span class="op" id="7816609">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7816613">command</span><span class="op" id="7816620">:</span>&nbsp;<span class="op" id="7816622">[</span><span class="op" id="7816623">]</span><span class="builtintype" id="7816624">string</span><span class="op" id="7816630">{</span><span class="string" id="7816631">&#34;openssl&#34;</span><span class="op" id="7816640">,</span>&nbsp;<span class="string" id="7816642">&#34;s_server&#34;</span><span class="op" id="7816652">,</span>&nbsp;<span class="string" id="7816654">&#34;-cipher&#34;</span><span class="op" id="7816663">,</span>&nbsp;<span class="string" id="7816665">&#34;ECDHE-ECDSA-AES128-SHA&#34;</span><span class="op" id="7816689">,</span>&nbsp;<span class="string" id="7816691">&#34;-verify&#34;</span><span class="op" id="7816700">,</span>&nbsp;<span class="string" id="7816702">&#34;1&#34;</span><span class="op" id="7816705">}</span><span class="op" id="7816706">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7816710">config</span><span class="op" id="7816716">:</span>&nbsp;&nbsp;<span class="op" id="7816719">&amp;</span><span class="ident" id="7816720">config</span><span class="op" id="7816726">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7816730">cert</span><span class="op" id="7816734">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7816739">testECDSACertificate</span><span class="op" id="7816759">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7816763">key</span><span class="op" id="7816766">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7816772">testECDSAPrivateKey</span><span class="op" id="7816791">,</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7816794">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7816798">runClientTestTLS10</span><span class="op" id="7816816">(</span><span class="ident" id="7816817">t</span><span class="op" id="7816818">,</span>&nbsp;<span class="ident" id="7816820">test</span><span class="op" id="7816824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7816827">runClientTestTLS12</span><span class="op" id="7816845">(</span><span class="ident" id="7816846">t</span><span class="op" id="7816847">,</span>&nbsp;<span class="ident" id="7816849">test</span><span class="op" id="7816853">)</span><br>
<span class="lineno"></span><span class="op" id="7816855">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span><span class="keyword" id="7816858">func</span>&nbsp;<span class="ident" id="7816863">TestClientResumption</span><span class="op" id="7816883">(</span><span class="ident" id="7816884">t</span>&nbsp;<span class="op" id="7816886">*</span><span class="ident" id="7816887">testing</span><span class="op" id="7816894">.</span><span class="ident" id="7816895">T</span><span class="op" id="7816896">)</span>&nbsp;<span class="op" id="7816898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7816901">serverConfig</span>&nbsp;<span class="op" id="7816914">:=</span>&nbsp;<span class="op" id="7816917">&amp;</span><span class="ident" id="7816918">Config</span><span class="op" id="7816924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7816928">CipherSuites</span><span class="op" id="7816940">:</span>&nbsp;<span class="op" id="7816942">[</span><span class="op" id="7816943">]</span><span class="builtintype" id="7816944">uint16</span><span class="op" id="7816950">{</span><span class="ident" id="7816951">TLS_RSA_WITH_RC4_128_SHA</span><span class="op" id="7816975">,</span>&nbsp;<span class="ident" id="7816977">TLS_ECDHE_RSA_WITH_RC4_128_SHA</span><span class="op" id="7817007">}</span><span class="op" id="7817008">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7817012">Certificates</span><span class="op" id="7817024">:</span>&nbsp;<span class="ident" id="7817026">testConfig</span><span class="op" id="7817036">.</span><span class="ident" id="7817037">Certificates</span><span class="op" id="7817049">,</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7817052">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7817055">clientConfig</span>&nbsp;<span class="op" id="7817068">:=</span>&nbsp;<span class="op" id="7817071">&amp;</span><span class="ident" id="7817072">Config</span><span class="op" id="7817078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7817082">CipherSuites</span><span class="op" id="7817094">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7817102">[</span><span class="op" id="7817103">]</span><span class="builtintype" id="7817104">uint16</span><span class="op" id="7817110">{</span><span class="ident" id="7817111">TLS_RSA_WITH_RC4_128_SHA</span><span class="op" id="7817135">}</span><span class="op" id="7817136">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7817140">InsecureSkipVerify</span><span class="op" id="7817158">:</span>&nbsp;<span class="ident" id="7817160">true</span><span class="op" id="7817164">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7817168">ClientSessionCache</span><span class="op" id="7817186">:</span>&nbsp;<span class="ident" id="7817188">NewLRUClientSessionCache</span><span class="op" id="7817212">(</span><span class="num" id="7817213">32</span><span class="op" id="7817215">)</span><span class="op" id="7817216">,</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7817219">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7817223">testResumeState</span>&nbsp;<span class="op" id="7817239">:=</span>&nbsp;<span class="keyword" id="7817242">func</span><span class="op" id="7817246">(</span><span class="ident" id="7817247">test</span>&nbsp;<span class="builtintype" id="7817252">string</span><span class="op" id="7817258">,</span>&nbsp;<span class="ident" id="7817260">didResume</span>&nbsp;<span class="builtintype" id="7817270">bool</span><span class="op" id="7817274">)</span>&nbsp;<span class="op" id="7817276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7817280">hs</span><span class="op" id="7817282">,</span>&nbsp;<span class="ident" id="7817284">err</span>&nbsp;<span class="op" id="7817288">:=</span>&nbsp;<span class="ident" id="7817291">testHandshake</span><span class="op" id="7817304">(</span><span class="ident" id="7817305">clientConfig</span><span class="op" id="7817317">,</span>&nbsp;<span class="ident" id="7817319">serverConfig</span><span class="op" id="7817331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7817335">if</span>&nbsp;<span class="ident" id="7817338">err</span>&nbsp;<span class="op" id="7817342">!=</span>&nbsp;<span class="ident" id="7817345">nil</span>&nbsp;<span class="op" id="7817349">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7817354">t</span><span class="op" id="7817355">.</span><span class="ident" id="7817356">Fatalf</span><span class="op" id="7817362">(</span><span class="string" id="7817363">&#34;%s:&nbsp;handshake&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7817389">,</span>&nbsp;<span class="ident" id="7817391">test</span><span class="op" id="7817395">,</span>&nbsp;<span class="ident" id="7817397">err</span><span class="op" id="7817400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7817404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7817408">if</span>&nbsp;<span class="ident" id="7817411">hs</span><span class="op" id="7817413">.</span><span class="ident" id="7817414">DidResume</span>&nbsp;<span class="op" id="7817424">!=</span>&nbsp;<span class="ident" id="7817427">didResume</span>&nbsp;<span class="op" id="7817437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7817442">t</span><span class="op" id="7817443">.</span><span class="ident" id="7817444">Fatalf</span><span class="op" id="7817450">(</span><span class="string" id="7817451">&#34;%s&nbsp;resumed:&nbsp;%v,&nbsp;expected:&nbsp;%v&#34;</span><span class="op" id="7817481">,</span>&nbsp;<span class="ident" id="7817483">test</span><span class="op" id="7817487">,</span>&nbsp;<span class="ident" id="7817489">hs</span><span class="op" id="7817491">.</span><span class="ident" id="7817492">DidResume</span><span class="op" id="7817501">,</span>&nbsp;<span class="ident" id="7817503">didResume</span><span class="op" id="7817512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7817516">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7817519">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7817523">testResumeState</span><span class="op" id="7817538">(</span><span class="string" id="7817539">&#34;Handshake&#34;</span><span class="op" id="7817550">,</span>&nbsp;<span class="ident" id="7817552">false</span><span class="op" id="7817557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7817560">testResumeState</span><span class="op" id="7817575">(</span><span class="string" id="7817576">&#34;Resume&#34;</span><span class="op" id="7817584">,</span>&nbsp;<span class="ident" id="7817586">true</span><span class="op" id="7817590">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7817594">if</span>&nbsp;<span class="ident" id="7817597">_</span><span class="op" id="7817598">,</span>&nbsp;<span class="ident" id="7817600">err</span>&nbsp;<span class="op" id="7817604">:=</span>&nbsp;<span class="ident" id="7817607">io</span><span class="op" id="7817609">.</span><span class="ident" id="7817610">ReadFull</span><span class="op" id="7817618">(</span><span class="ident" id="7817619">serverConfig</span><span class="op" id="7817631">.</span><span class="ident" id="7817632">rand</span><span class="op" id="7817636">(</span><span class="op" id="7817637">)</span><span class="op" id="7817638">,</span>&nbsp;<span class="ident" id="7817640">serverConfig</span><span class="op" id="7817652">.</span><span class="ident" id="7817653">SessionTicketKey</span><span class="op" id="7817669">[</span><span class="op" id="7817670">:</span><span class="op" id="7817671">]</span><span class="op" id="7817672">)</span><span class="op" id="7817673">;</span>&nbsp;<span class="ident" id="7817675">err</span>&nbsp;<span class="op" id="7817679">!=</span>&nbsp;<span class="ident" id="7817682">nil</span>&nbsp;<span class="op" id="7817686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7817690">t</span><span class="op" id="7817691">.</span><span class="ident" id="7817692">Fatalf</span><span class="op" id="7817698">(</span><span class="string" id="7817699">&#34;Failed&nbsp;to&nbsp;invalidate&nbsp;SessionTicketKey&#34;</span><span class="op" id="7817738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7817741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7817744">testResumeState</span><span class="op" id="7817759">(</span><span class="string" id="7817760">&#34;InvalidSessionTicketKey&#34;</span><span class="op" id="7817785">,</span>&nbsp;<span class="ident" id="7817787">false</span><span class="op" id="7817792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7817795">testResumeState</span><span class="op" id="7817810">(</span><span class="string" id="7817811">&#34;ResumeAfterInvalidSessionTicketKey&#34;</span><span class="op" id="7817847">,</span>&nbsp;<span class="ident" id="7817849">true</span><span class="op" id="7817853">)</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7817857">clientConfig</span><span class="op" id="7817869">.</span><span class="ident" id="7817870">CipherSuites</span>&nbsp;<span class="op" id="7817883">=</span>&nbsp;<span class="op" id="7817885">[</span><span class="op" id="7817886">]</span><span class="builtintype" id="7817887">uint16</span><span class="op" id="7817893">{</span><span class="ident" id="7817894">TLS_ECDHE_RSA_WITH_RC4_128_SHA</span><span class="op" id="7817924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7817927">testResumeState</span><span class="op" id="7817942">(</span><span class="string" id="7817943">&#34;DifferentCipherSuite&#34;</span><span class="op" id="7817965">,</span>&nbsp;<span class="ident" id="7817967">false</span><span class="op" id="7817972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7817975">testResumeState</span><span class="op" id="7817990">(</span><span class="string" id="7817991">&#34;DifferentCipherSuiteRecovers&#34;</span><span class="op" id="7818021">,</span>&nbsp;<span class="ident" id="7818023">true</span><span class="op" id="7818027">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7818031">clientConfig</span><span class="op" id="7818043">.</span><span class="ident" id="7818044">ClientSessionCache</span>&nbsp;<span class="op" id="7818063">=</span>&nbsp;<span class="ident" id="7818065">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7818070">testResumeState</span><span class="op" id="7818085">(</span><span class="string" id="7818086">&#34;WithoutSessionCache&#34;</span><span class="op" id="7818107">,</span>&nbsp;<span class="ident" id="7818109">false</span><span class="op" id="7818114">)</span><br>
<span class="lineno"></span><span class="op" id="7818116">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7818119">func</span>&nbsp;<span class="ident" id="7818124">TestLRUClientSessionCache</span><span class="op" id="7818149">(</span><span class="ident" id="7818150">t</span>&nbsp;<span class="op" id="7818152">*</span><span class="ident" id="7818153">testing</span><span class="op" id="7818160">.</span><span class="ident" id="7818161">T</span><span class="op" id="7818162">)</span>&nbsp;<span class="op" id="7818164">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7818167">//&nbsp;Initialize&nbsp;cache&nbsp;of&nbsp;capacity&nbsp;4.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7818203">cache</span>&nbsp;<span class="op" id="7818209">:=</span>&nbsp;<span class="ident" id="7818212">NewLRUClientSessionCache</span><span class="op" id="7818236">(</span><span class="num" id="7818237">4</span><span class="op" id="7818238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7818241">cs</span>&nbsp;<span class="op" id="7818244">:=</span>&nbsp;<span class="builtinfunc" id="7818247">make</span><span class="op" id="7818251">(</span><span class="op" id="7818252">[</span><span class="op" id="7818253">]</span><span class="ident" id="7818254">ClientSessionState</span><span class="op" id="7818272">,</span>&nbsp;<span class="num" id="7818274">6</span><span class="op" id="7818275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7818278">keys</span>&nbsp;<span class="op" id="7818283">:=</span>&nbsp;<span class="op" id="7818286">[</span><span class="op" id="7818287">]</span><span class="builtintype" id="7818288">string</span><span class="op" id="7818294">{</span><span class="string" id="7818295">&#34;0&#34;</span><span class="op" id="7818298">,</span>&nbsp;<span class="string" id="7818300">&#34;1&#34;</span><span class="op" id="7818303">,</span>&nbsp;<span class="string" id="7818305">&#34;2&#34;</span><span class="op" id="7818308">,</span>&nbsp;<span class="string" id="7818310">&#34;3&#34;</span><span class="op" id="7818313">,</span>&nbsp;<span class="string" id="7818315">&#34;4&#34;</span><span class="op" id="7818318">,</span>&nbsp;<span class="string" id="7818320">&#34;5&#34;</span><span class="op" id="7818323">,</span>&nbsp;<span class="string" id="7818325">&#34;6&#34;</span><span class="op" id="7818328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7818332">//&nbsp;Add&nbsp;4&nbsp;entries&nbsp;to&nbsp;the&nbsp;cache&nbsp;and&nbsp;look&nbsp;them&nbsp;up.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7818381">for</span>&nbsp;<span class="ident" id="7818385">i</span>&nbsp;<span class="op" id="7818387">:=</span>&nbsp;<span class="num" id="7818390">0</span><span class="op" id="7818391">;</span>&nbsp;<span class="ident" id="7818393">i</span>&nbsp;<span class="op" id="7818395">&lt;</span>&nbsp;<span class="num" id="7818397">4</span><span class="op" id="7818398">;</span>&nbsp;<span class="ident" id="7818400">i</span><span class="op" id="7818401">++</span>&nbsp;<span class="op" id="7818404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7818408">cache</span><span class="op" id="7818413">.</span><span class="ident" id="7818414">Put</span><span class="op" id="7818417">(</span><span class="ident" id="7818418">keys</span><span class="op" id="7818422">[</span><span class="ident" id="7818423">i</span><span class="op" id="7818424">]</span><span class="op" id="7818425">,</span>&nbsp;<span class="op" id="7818427">&amp;</span><span class="ident" id="7818428">cs</span><span class="op" id="7818430">[</span><span class="ident" id="7818431">i</span><span class="op" id="7818432">]</span><span class="op" id="7818433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7818436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7818439">for</span>&nbsp;<span class="ident" id="7818443">i</span>&nbsp;<span class="op" id="7818445">:=</span>&nbsp;<span class="num" id="7818448">0</span><span class="op" id="7818449">;</span>&nbsp;<span class="ident" id="7818451">i</span>&nbsp;<span class="op" id="7818453">&lt;</span>&nbsp;<span class="num" id="7818455">4</span><span class="op" id="7818456">;</span>&nbsp;<span class="ident" id="7818458">i</span><span class="op" id="7818459">++</span>&nbsp;<span class="op" id="7818462">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7818466">if</span>&nbsp;<span class="ident" id="7818469">s</span><span class="op" id="7818470">,</span>&nbsp;<span class="ident" id="7818472">ok</span>&nbsp;<span class="op" id="7818475">:=</span>&nbsp;<span class="ident" id="7818478">cache</span><span class="op" id="7818483">.</span><span class="ident" id="7818484">Get</span><span class="op" id="7818487">(</span><span class="ident" id="7818488">keys</span><span class="op" id="7818492">[</span><span class="ident" id="7818493">i</span><span class="op" id="7818494">]</span><span class="op" id="7818495">)</span><span class="op" id="7818496">;</span>&nbsp;<span class="op" id="7818498">!</span><span class="ident" id="7818499">ok</span>&nbsp;<span class="op" id="7818502">||</span>&nbsp;<span class="ident" id="7818505">s</span>&nbsp;<span class="op" id="7818507">!=</span>&nbsp;<span class="op" id="7818510">&amp;</span><span class="ident" id="7818511">cs</span><span class="op" id="7818513">[</span><span class="ident" id="7818514">i</span><span class="op" id="7818515">]</span>&nbsp;<span class="op" id="7818517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7818522">t</span><span class="op" id="7818523">.</span><span class="ident" id="7818524">Fatalf</span><span class="op" id="7818530">(</span><span class="string" id="7818531">&#34;session&nbsp;cache&nbsp;failed&nbsp;lookup&nbsp;for&nbsp;added&nbsp;key:&nbsp;%s&#34;</span><span class="op" id="7818578">,</span>&nbsp;<span class="ident" id="7818580">keys</span><span class="op" id="7818584">[</span><span class="ident" id="7818585">i</span><span class="op" id="7818586">]</span><span class="op" id="7818587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7818591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7818594">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7818598">//&nbsp;Add&nbsp;2&nbsp;more&nbsp;entries&nbsp;to&nbsp;the&nbsp;cache.&nbsp;First&nbsp;2&nbsp;should&nbsp;be&nbsp;evicted.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7818662">for</span>&nbsp;<span class="ident" id="7818666">i</span>&nbsp;<span class="op" id="7818668">:=</span>&nbsp;<span class="num" id="7818671">4</span><span class="op" id="7818672">;</span>&nbsp;<span class="ident" id="7818674">i</span>&nbsp;<span class="op" id="7818676">&lt;</span>&nbsp;<span class="num" id="7818678">6</span><span class="op" id="7818679">;</span>&nbsp;<span class="ident" id="7818681">i</span><span class="op" id="7818682">++</span>&nbsp;<span class="op" id="7818685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7818689">cache</span><span class="op" id="7818694">.</span><span class="ident" id="7818695">Put</span><span class="op" id="7818698">(</span><span class="ident" id="7818699">keys</span><span class="op" id="7818703">[</span><span class="ident" id="7818704">i</span><span class="op" id="7818705">]</span><span class="op" id="7818706">,</span>&nbsp;<span class="op" id="7818708">&amp;</span><span class="ident" id="7818709">cs</span><span class="op" id="7818711">[</span><span class="ident" id="7818712">i</span><span class="op" id="7818713">]</span><span class="op" id="7818714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7818717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7818720">for</span>&nbsp;<span class="ident" id="7818724">i</span>&nbsp;<span class="op" id="7818726">:=</span>&nbsp;<span class="num" id="7818729">0</span><span class="op" id="7818730">;</span>&nbsp;<span class="ident" id="7818732">i</span>&nbsp;<span class="op" id="7818734">&lt;</span>&nbsp;<span class="num" id="7818736">2</span><span class="op" id="7818737">;</span>&nbsp;<span class="ident" id="7818739">i</span><span class="op" id="7818740">++</span>&nbsp;<span class="op" id="7818743">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7818747">if</span>&nbsp;<span class="ident" id="7818750">s</span><span class="op" id="7818751">,</span>&nbsp;<span class="ident" id="7818753">ok</span>&nbsp;<span class="op" id="7818756">:=</span>&nbsp;<span class="ident" id="7818759">cache</span><span class="op" id="7818764">.</span><span class="ident" id="7818765">Get</span><span class="op" id="7818768">(</span><span class="ident" id="7818769">keys</span><span class="op" id="7818773">[</span><span class="ident" id="7818774">i</span><span class="op" id="7818775">]</span><span class="op" id="7818776">)</span><span class="op" id="7818777">;</span>&nbsp;<span class="ident" id="7818779">ok</span>&nbsp;<span class="op" id="7818782">||</span>&nbsp;<span class="ident" id="7818785">s</span>&nbsp;<span class="op" id="7818787">!=</span>&nbsp;<span class="ident" id="7818790">nil</span>&nbsp;<span class="op" id="7818794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7818799">t</span><span class="op" id="7818800">.</span><span class="ident" id="7818801">Fatalf</span><span class="op" id="7818807">(</span><span class="string" id="7818808">&#34;session&nbsp;cache&nbsp;should&nbsp;have&nbsp;evicted&nbsp;key:&nbsp;%s&#34;</span><span class="op" id="7818851">,</span>&nbsp;<span class="ident" id="7818853">keys</span><span class="op" id="7818857">[</span><span class="ident" id="7818858">i</span><span class="op" id="7818859">]</span><span class="op" id="7818860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7818864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7818867">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7818871">//&nbsp;Touch&nbsp;entry&nbsp;2.&nbsp;LRU&nbsp;should&nbsp;evict&nbsp;3&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7818915">cache</span><span class="op" id="7818920">.</span><span class="ident" id="7818921">Get</span><span class="op" id="7818924">(</span><span class="ident" id="7818925">keys</span><span class="op" id="7818929">[</span><span class="num" id="7818930">2</span><span class="op" id="7818931">]</span><span class="op" id="7818932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7818935">cache</span><span class="op" id="7818940">.</span><span class="ident" id="7818941">Put</span><span class="op" id="7818944">(</span><span class="ident" id="7818945">keys</span><span class="op" id="7818949">[</span><span class="num" id="7818950">0</span><span class="op" id="7818951">]</span><span class="op" id="7818952">,</span>&nbsp;<span class="op" id="7818954">&amp;</span><span class="ident" id="7818955">cs</span><span class="op" id="7818957">[</span><span class="num" id="7818958">0</span><span class="op" id="7818959">]</span><span class="op" id="7818960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7818963">if</span>&nbsp;<span class="ident" id="7818966">s</span><span class="op" id="7818967">,</span>&nbsp;<span class="ident" id="7818969">ok</span>&nbsp;<span class="op" id="7818972">:=</span>&nbsp;<span class="ident" id="7818975">cache</span><span class="op" id="7818980">.</span><span class="ident" id="7818981">Get</span><span class="op" id="7818984">(</span><span class="ident" id="7818985">keys</span><span class="op" id="7818989">[</span><span class="num" id="7818990">3</span><span class="op" id="7818991">]</span><span class="op" id="7818992">)</span><span class="op" id="7818993">;</span>&nbsp;<span class="ident" id="7818995">ok</span>&nbsp;<span class="op" id="7818998">||</span>&nbsp;<span class="ident" id="7819001">s</span>&nbsp;<span class="op" id="7819003">!=</span>&nbsp;<span class="ident" id="7819006">nil</span>&nbsp;<span class="op" id="7819010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7819014">t</span><span class="op" id="7819015">.</span><span class="ident" id="7819016">Fatalf</span><span class="op" id="7819022">(</span><span class="string" id="7819023">&#34;session&nbsp;cache&nbsp;should&nbsp;have&nbsp;evicted&nbsp;key&nbsp;3&#34;</span><span class="op" id="7819064">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7819067">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7819071">//&nbsp;Update&nbsp;entry&nbsp;0&nbsp;in&nbsp;place.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7819100">cache</span><span class="op" id="7819105">.</span><span class="ident" id="7819106">Put</span><span class="op" id="7819109">(</span><span class="ident" id="7819110">keys</span><span class="op" id="7819114">[</span><span class="num" id="7819115">0</span><span class="op" id="7819116">]</span><span class="op" id="7819117">,</span>&nbsp;<span class="op" id="7819119">&amp;</span><span class="ident" id="7819120">cs</span><span class="op" id="7819122">[</span><span class="num" id="7819123">3</span><span class="op" id="7819124">]</span><span class="op" id="7819125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7819128">if</span>&nbsp;<span class="ident" id="7819131">s</span><span class="op" id="7819132">,</span>&nbsp;<span class="ident" id="7819134">ok</span>&nbsp;<span class="op" id="7819137">:=</span>&nbsp;<span class="ident" id="7819140">cache</span><span class="op" id="7819145">.</span><span class="ident" id="7819146">Get</span><span class="op" id="7819149">(</span><span class="ident" id="7819150">keys</span><span class="op" id="7819154">[</span><span class="num" id="7819155">0</span><span class="op" id="7819156">]</span><span class="op" id="7819157">)</span><span class="op" id="7819158">;</span>&nbsp;<span class="op" id="7819160">!</span><span class="ident" id="7819161">ok</span>&nbsp;<span class="op" id="7819164">||</span>&nbsp;<span class="ident" id="7819167">s</span>&nbsp;<span class="op" id="7819169">!=</span>&nbsp;<span class="op" id="7819172">&amp;</span><span class="ident" id="7819173">cs</span><span class="op" id="7819175">[</span><span class="num" id="7819176">3</span><span class="op" id="7819177">]</span>&nbsp;<span class="op" id="7819179">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7819183">t</span><span class="op" id="7819184">.</span><span class="ident" id="7819185">Fatalf</span><span class="op" id="7819191">(</span><span class="string" id="7819192">&#34;session&nbsp;cache&nbsp;failed&nbsp;update&nbsp;for&nbsp;key&nbsp;0&#34;</span><span class="op" id="7819231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7819234">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7819238">//&nbsp;Adding&nbsp;a&nbsp;nil&nbsp;entry&nbsp;is&nbsp;valid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7819271">cache</span><span class="op" id="7819276">.</span><span class="ident" id="7819277">Put</span><span class="op" id="7819280">(</span><span class="ident" id="7819281">keys</span><span class="op" id="7819285">[</span><span class="num" id="7819286">0</span><span class="op" id="7819287">]</span><span class="op" id="7819288">,</span>&nbsp;<span class="ident" id="7819290">nil</span><span class="op" id="7819293">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7819296">if</span>&nbsp;<span class="ident" id="7819299">s</span><span class="op" id="7819300">,</span>&nbsp;<span class="ident" id="7819302">ok</span>&nbsp;<span class="op" id="7819305">:=</span>&nbsp;<span class="ident" id="7819308">cache</span><span class="op" id="7819313">.</span><span class="ident" id="7819314">Get</span><span class="op" id="7819317">(</span><span class="ident" id="7819318">keys</span><span class="op" id="7819322">[</span><span class="num" id="7819323">0</span><span class="op" id="7819324">]</span><span class="op" id="7819325">)</span><span class="op" id="7819326">;</span>&nbsp;<span class="op" id="7819328">!</span><span class="ident" id="7819329">ok</span>&nbsp;<span class="op" id="7819332">||</span>&nbsp;<span class="ident" id="7819335">s</span>&nbsp;<span class="op" id="7819337">!=</span>&nbsp;<span class="ident" id="7819340">nil</span>&nbsp;<span class="op" id="7819344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7819348">t</span><span class="op" id="7819349">.</span><span class="ident" id="7819350">Fatalf</span><span class="op" id="7819356">(</span><span class="string" id="7819357">&#34;failed&nbsp;to&nbsp;add&nbsp;nil&nbsp;entry&nbsp;to&nbsp;cache&#34;</span><span class="op" id="7819391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7819394">}</span><br>
<span class="lineno"></span><span class="op" id="7819396">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">450</span><span class="keyword" id="7819399">func</span>&nbsp;<span class="ident" id="7819404">TestHandshakeClientALPNMatch</span><span class="op" id="7819432">(</span><span class="ident" id="7819433">t</span>&nbsp;<span class="op" id="7819435">*</span><span class="ident" id="7819436">testing</span><span class="op" id="7819443">.</span><span class="ident" id="7819444">T</span><span class="op" id="7819445">)</span>&nbsp;<span class="op" id="7819447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7819450">config</span>&nbsp;<span class="op" id="7819457">:=</span>&nbsp;<span class="op" id="7819460">*</span><span class="ident" id="7819461">testConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7819473">config</span><span class="op" id="7819479">.</span><span class="ident" id="7819480">NextProtos</span>&nbsp;<span class="op" id="7819491">=</span>&nbsp;<span class="op" id="7819493">[</span><span class="op" id="7819494">]</span><span class="builtintype" id="7819495">string</span><span class="op" id="7819501">{</span><span class="string" id="7819502">&#34;proto2&#34;</span><span class="op" id="7819510">,</span>&nbsp;<span class="string" id="7819512">&#34;proto1&#34;</span><span class="op" id="7819520">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7819524">test</span>&nbsp;<span class="op" id="7819529">:=</span>&nbsp;<span class="op" id="7819532">&amp;</span><span class="ident" id="7819533">clientTest</span><span class="op" id="7819543">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7819547">name</span><span class="op" id="7819551">:</span>&nbsp;<span class="string" id="7819553">&#34;ALPN&#34;</span><span class="op" id="7819559">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7819563">//&nbsp;Note&nbsp;that&nbsp;this&nbsp;needs&nbsp;OpenSSL&nbsp;1.0.2&nbsp;because&nbsp;that&nbsp;is&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7819629">//&nbsp;version&nbsp;that&nbsp;supports&nbsp;the&nbsp;-alpn&nbsp;flag.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7819672">command</span><span class="op" id="7819679">:</span>&nbsp;<span class="op" id="7819681">[</span><span class="op" id="7819682">]</span><span class="builtintype" id="7819683">string</span><span class="op" id="7819689">{</span><span class="string" id="7819690">&#34;openssl&#34;</span><span class="op" id="7819699">,</span>&nbsp;<span class="string" id="7819701">&#34;s_server&#34;</span><span class="op" id="7819711">,</span>&nbsp;<span class="string" id="7819713">&#34;-alpn&#34;</span><span class="op" id="7819720">,</span>&nbsp;<span class="string" id="7819722">&#34;proto1,proto2&#34;</span><span class="op" id="7819737">}</span><span class="op" id="7819738">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7819742">config</span><span class="op" id="7819748">:</span>&nbsp;&nbsp;<span class="op" id="7819751">&amp;</span><span class="ident" id="7819752">config</span><span class="op" id="7819758">,</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7819762">validate</span><span class="op" id="7819770">:</span>&nbsp;<span class="keyword" id="7819772">func</span><span class="op" id="7819776">(</span><span class="ident" id="7819777">state</span>&nbsp;<span class="ident" id="7819783">ConnectionState</span><span class="op" id="7819798">)</span>&nbsp;<span class="builtintype" id="7819800">error</span>&nbsp;<span class="op" id="7819806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7819811">//&nbsp;The&nbsp;server&#39;s&nbsp;preferences&nbsp;should&nbsp;override&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7819870">if</span>&nbsp;<span class="ident" id="7819873">state</span><span class="op" id="7819878">.</span><span class="ident" id="7819879">NegotiatedProtocol</span>&nbsp;<span class="op" id="7819898">!=</span>&nbsp;<span class="string" id="7819901">&#34;proto1&#34;</span>&nbsp;<span class="op" id="7819910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7819916">return</span>&nbsp;<span class="ident" id="7819923">fmt</span><span class="op" id="7819926">.</span><span class="ident" id="7819927">Errorf</span><span class="op" id="7819933">(</span><span class="string" id="7819934">&#34;Got&nbsp;protocol&nbsp;%q,&nbsp;wanted&nbsp;proto1&#34;</span><span class="op" id="7819966">,</span>&nbsp;<span class="ident" id="7819968">state</span><span class="op" id="7819973">.</span><span class="ident" id="7819974">NegotiatedProtocol</span><span class="op" id="7819992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7819997">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7820002">return</span>&nbsp;<span class="ident" id="7820009">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7820015">}</span><span class="op" id="7820016">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7820019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7820022">runClientTestTLS12</span><span class="op" id="7820040">(</span><span class="ident" id="7820041">t</span><span class="op" id="7820042">,</span>&nbsp;<span class="ident" id="7820044">test</span><span class="op" id="7820048">)</span><br>
<span class="lineno"></span><span class="op" id="7820050">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span><span class="keyword" id="7820053">func</span>&nbsp;<span class="ident" id="7820058">TestHandshakeClientALPNNoMatch</span><span class="op" id="7820088">(</span><span class="ident" id="7820089">t</span>&nbsp;<span class="op" id="7820091">*</span><span class="ident" id="7820092">testing</span><span class="op" id="7820099">.</span><span class="ident" id="7820100">T</span><span class="op" id="7820101">)</span>&nbsp;<span class="op" id="7820103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7820106">config</span>&nbsp;<span class="op" id="7820113">:=</span>&nbsp;<span class="op" id="7820116">*</span><span class="ident" id="7820117">testConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7820129">config</span><span class="op" id="7820135">.</span><span class="ident" id="7820136">NextProtos</span>&nbsp;<span class="op" id="7820147">=</span>&nbsp;<span class="op" id="7820149">[</span><span class="op" id="7820150">]</span><span class="builtintype" id="7820151">string</span><span class="op" id="7820157">{</span><span class="string" id="7820158">&#34;proto3&#34;</span><span class="op" id="7820166">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7820170">test</span>&nbsp;<span class="op" id="7820175">:=</span>&nbsp;<span class="op" id="7820178">&amp;</span><span class="ident" id="7820179">clientTest</span><span class="op" id="7820189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7820193">name</span><span class="op" id="7820197">:</span>&nbsp;<span class="string" id="7820199">&#34;ALPN-NoMatch&#34;</span><span class="op" id="7820213">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7820217">//&nbsp;Note&nbsp;that&nbsp;this&nbsp;needs&nbsp;OpenSSL&nbsp;1.0.2&nbsp;because&nbsp;that&nbsp;is&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7820283">//&nbsp;version&nbsp;that&nbsp;supports&nbsp;the&nbsp;-alpn&nbsp;flag.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7820326">command</span><span class="op" id="7820333">:</span>&nbsp;<span class="op" id="7820335">[</span><span class="op" id="7820336">]</span><span class="builtintype" id="7820337">string</span><span class="op" id="7820343">{</span><span class="string" id="7820344">&#34;openssl&#34;</span><span class="op" id="7820353">,</span>&nbsp;<span class="string" id="7820355">&#34;s_server&#34;</span><span class="op" id="7820365">,</span>&nbsp;<span class="string" id="7820367">&#34;-alpn&#34;</span><span class="op" id="7820374">,</span>&nbsp;<span class="string" id="7820376">&#34;proto1,proto2&#34;</span><span class="op" id="7820391">}</span><span class="op" id="7820392">,</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7820396">config</span><span class="op" id="7820402">:</span>&nbsp;&nbsp;<span class="op" id="7820405">&amp;</span><span class="ident" id="7820406">config</span><span class="op" id="7820412">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7820416">validate</span><span class="op" id="7820424">:</span>&nbsp;<span class="keyword" id="7820426">func</span><span class="op" id="7820430">(</span><span class="ident" id="7820431">state</span>&nbsp;<span class="ident" id="7820437">ConnectionState</span><span class="op" id="7820452">)</span>&nbsp;<span class="builtintype" id="7820454">error</span>&nbsp;<span class="op" id="7820460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7820465">//&nbsp;There&#39;s&nbsp;no&nbsp;overlap&nbsp;so&nbsp;OpenSSL&nbsp;will&nbsp;not&nbsp;select&nbsp;a&nbsp;protocol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7820529">if</span>&nbsp;<span class="ident" id="7820532">state</span><span class="op" id="7820537">.</span><span class="ident" id="7820538">NegotiatedProtocol</span>&nbsp;<span class="op" id="7820557">!=</span>&nbsp;<span class="string" id="7820560">&#34;&#34;</span>&nbsp;<span class="op" id="7820563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7820569">return</span>&nbsp;<span class="ident" id="7820576">fmt</span><span class="op" id="7820579">.</span><span class="ident" id="7820580">Errorf</span><span class="op" id="7820586">(</span><span class="string" id="7820587">&#34;Got&nbsp;protocol&nbsp;%q,&nbsp;wanted&nbsp;&#39;&#39;&#34;</span><span class="op" id="7820615">,</span>&nbsp;<span class="ident" id="7820617">state</span><span class="op" id="7820622">.</span><span class="ident" id="7820623">NegotiatedProtocol</span><span class="op" id="7820641">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7820646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7820651">return</span>&nbsp;<span class="ident" id="7820658">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7820664">}</span><span class="op" id="7820665">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7820668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7820671">runClientTestTLS12</span><span class="op" id="7820689">(</span><span class="ident" id="7820690">t</span><span class="op" id="7820691">,</span>&nbsp;<span class="ident" id="7820693">test</span><span class="op" id="7820697">)</span><br>
<span class="lineno">490</span><span class="op" id="7820699">}</span>
</div>
</body>
</html>
