<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html" class="current">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6550326">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6550381">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6550435">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6550486">package</span>&nbsp;<span class="ident" id="6550494">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6550499">import</span>&nbsp;<span class="op" id="6550506">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6550509">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6550516">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6550522">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6550533">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6550544">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6550552">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6550563">&#34;time&#34;</span><br>
<span class="lineno">15</span><span class="op" id="6550570">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6550573">func</span>&nbsp;<span class="ident" id="6550578">BenchmarkTCP4OneShot</span><span class="op" id="6550598">(</span><span class="ident" id="6550599">b</span>&nbsp;<span class="op" id="6550601">*</span><span class="ident" id="6550602">testing</span><span class="op" id="6550609">.</span><span class="ident" id="6550610">B</span><span class="op" id="6550611">)</span>&nbsp;<span class="op" id="6550613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6550616">benchmarkTCP</span><span class="op" id="6550628">(</span><span class="ident" id="6550629">b</span><span class="op" id="6550630">,</span>&nbsp;<span class="builtintype" id="6550632">false</span><span class="op" id="6550637">,</span>&nbsp;<span class="builtintype" id="6550639">false</span><span class="op" id="6550644">,</span>&nbsp;<span class="string" id="6550646">&#34;127.0.0.1:0&#34;</span><span class="op" id="6550659">)</span><br>
<span class="lineno"></span><span class="op" id="6550661">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="6550664">func</span>&nbsp;<span class="ident" id="6550669">BenchmarkTCP4OneShotTimeout</span><span class="op" id="6550696">(</span><span class="ident" id="6550697">b</span>&nbsp;<span class="op" id="6550699">*</span><span class="ident" id="6550700">testing</span><span class="op" id="6550707">.</span><span class="ident" id="6550708">B</span><span class="op" id="6550709">)</span>&nbsp;<span class="op" id="6550711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6550714">benchmarkTCP</span><span class="op" id="6550726">(</span><span class="ident" id="6550727">b</span><span class="op" id="6550728">,</span>&nbsp;<span class="builtintype" id="6550730">false</span><span class="op" id="6550735">,</span>&nbsp;<span class="builtintype" id="6550737">true</span><span class="op" id="6550741">,</span>&nbsp;<span class="string" id="6550743">&#34;127.0.0.1:0&#34;</span><span class="op" id="6550756">)</span><br>
<span class="lineno"></span><span class="op" id="6550758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="6550761">func</span>&nbsp;<span class="ident" id="6550766">BenchmarkTCP4Persistent</span><span class="op" id="6550789">(</span><span class="ident" id="6550790">b</span>&nbsp;<span class="op" id="6550792">*</span><span class="ident" id="6550793">testing</span><span class="op" id="6550800">.</span><span class="ident" id="6550801">B</span><span class="op" id="6550802">)</span>&nbsp;<span class="op" id="6550804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6550807">benchmarkTCP</span><span class="op" id="6550819">(</span><span class="ident" id="6550820">b</span><span class="op" id="6550821">,</span>&nbsp;<span class="builtintype" id="6550823">true</span><span class="op" id="6550827">,</span>&nbsp;<span class="builtintype" id="6550829">false</span><span class="op" id="6550834">,</span>&nbsp;<span class="string" id="6550836">&#34;127.0.0.1:0&#34;</span><span class="op" id="6550849">)</span><br>
<span class="lineno"></span><span class="op" id="6550851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6550854">func</span>&nbsp;<span class="ident" id="6550859">BenchmarkTCP4PersistentTimeout</span><span class="op" id="6550889">(</span><span class="ident" id="6550890">b</span>&nbsp;<span class="op" id="6550892">*</span><span class="ident" id="6550893">testing</span><span class="op" id="6550900">.</span><span class="ident" id="6550901">B</span><span class="op" id="6550902">)</span>&nbsp;<span class="op" id="6550904">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6550907">benchmarkTCP</span><span class="op" id="6550919">(</span><span class="ident" id="6550920">b</span><span class="op" id="6550921">,</span>&nbsp;<span class="builtintype" id="6550923">true</span><span class="op" id="6550927">,</span>&nbsp;<span class="builtintype" id="6550929">true</span><span class="op" id="6550933">,</span>&nbsp;<span class="string" id="6550935">&#34;127.0.0.1:0&#34;</span><span class="op" id="6550948">)</span><br>
<span class="lineno"></span><span class="op" id="6550950">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6550953">func</span>&nbsp;<span class="ident" id="6550958">BenchmarkTCP6OneShot</span><span class="op" id="6550978">(</span><span class="ident" id="6550979">b</span>&nbsp;<span class="op" id="6550981">*</span><span class="ident" id="6550982">testing</span><span class="op" id="6550989">.</span><span class="ident" id="6550990">B</span><span class="op" id="6550991">)</span>&nbsp;<span class="op" id="6550993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6550996">if</span>&nbsp;<span class="op" id="6550999">!</span><span class="ident" id="6551000">supportsIPv6</span>&nbsp;<span class="op" id="6551013">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6551017">b</span><span class="op" id="6551018">.</span><span class="ident" id="6551019">Skip</span><span class="op" id="6551023">(</span><span class="string" id="6551024">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="6551047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6551050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6551053">benchmarkTCP</span><span class="op" id="6551065">(</span><span class="ident" id="6551066">b</span><span class="op" id="6551067">,</span>&nbsp;<span class="builtintype" id="6551069">false</span><span class="op" id="6551074">,</span>&nbsp;<span class="builtintype" id="6551076">false</span><span class="op" id="6551081">,</span>&nbsp;<span class="string" id="6551083">&#34;[::1]:0&#34;</span><span class="op" id="6551092">)</span><br>
<span class="lineno"></span><span class="op" id="6551094">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="6551097">func</span>&nbsp;<span class="ident" id="6551102">BenchmarkTCP6OneShotTimeout</span><span class="op" id="6551129">(</span><span class="ident" id="6551130">b</span>&nbsp;<span class="op" id="6551132">*</span><span class="ident" id="6551133">testing</span><span class="op" id="6551140">.</span><span class="ident" id="6551141">B</span><span class="op" id="6551142">)</span>&nbsp;<span class="op" id="6551144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6551147">if</span>&nbsp;<span class="op" id="6551150">!</span><span class="ident" id="6551151">supportsIPv6</span>&nbsp;<span class="op" id="6551164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6551168">b</span><span class="op" id="6551169">.</span><span class="ident" id="6551170">Skip</span><span class="op" id="6551174">(</span><span class="string" id="6551175">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="6551198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6551201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6551204">benchmarkTCP</span><span class="op" id="6551216">(</span><span class="ident" id="6551217">b</span><span class="op" id="6551218">,</span>&nbsp;<span class="builtintype" id="6551220">false</span><span class="op" id="6551225">,</span>&nbsp;<span class="builtintype" id="6551227">true</span><span class="op" id="6551231">,</span>&nbsp;<span class="string" id="6551233">&#34;[::1]:0&#34;</span><span class="op" id="6551242">)</span><br>
<span class="lineno">45</span><span class="op" id="6551244">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6551247">func</span>&nbsp;<span class="ident" id="6551252">BenchmarkTCP6Persistent</span><span class="op" id="6551275">(</span><span class="ident" id="6551276">b</span>&nbsp;<span class="op" id="6551278">*</span><span class="ident" id="6551279">testing</span><span class="op" id="6551286">.</span><span class="ident" id="6551287">B</span><span class="op" id="6551288">)</span>&nbsp;<span class="op" id="6551290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6551293">if</span>&nbsp;<span class="op" id="6551296">!</span><span class="ident" id="6551297">supportsIPv6</span>&nbsp;<span class="op" id="6551310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6551314">b</span><span class="op" id="6551315">.</span><span class="ident" id="6551316">Skip</span><span class="op" id="6551320">(</span><span class="string" id="6551321">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="6551344">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6551347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6551350">benchmarkTCP</span><span class="op" id="6551362">(</span><span class="ident" id="6551363">b</span><span class="op" id="6551364">,</span>&nbsp;<span class="builtintype" id="6551366">true</span><span class="op" id="6551370">,</span>&nbsp;<span class="builtintype" id="6551372">false</span><span class="op" id="6551377">,</span>&nbsp;<span class="string" id="6551379">&#34;[::1]:0&#34;</span><span class="op" id="6551388">)</span><br>
<span class="lineno"></span><span class="op" id="6551390">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6551393">func</span>&nbsp;<span class="ident" id="6551398">BenchmarkTCP6PersistentTimeout</span><span class="op" id="6551428">(</span><span class="ident" id="6551429">b</span>&nbsp;<span class="op" id="6551431">*</span><span class="ident" id="6551432">testing</span><span class="op" id="6551439">.</span><span class="ident" id="6551440">B</span><span class="op" id="6551441">)</span>&nbsp;<span class="op" id="6551443">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6551446">if</span>&nbsp;<span class="op" id="6551449">!</span><span class="ident" id="6551450">supportsIPv6</span>&nbsp;<span class="op" id="6551463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6551467">b</span><span class="op" id="6551468">.</span><span class="ident" id="6551469">Skip</span><span class="op" id="6551473">(</span><span class="string" id="6551474">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="6551497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6551500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6551503">benchmarkTCP</span><span class="op" id="6551515">(</span><span class="ident" id="6551516">b</span><span class="op" id="6551517">,</span>&nbsp;<span class="builtintype" id="6551519">true</span><span class="op" id="6551523">,</span>&nbsp;<span class="builtintype" id="6551525">true</span><span class="op" id="6551529">,</span>&nbsp;<span class="string" id="6551531">&#34;[::1]:0&#34;</span><span class="op" id="6551540">)</span><br>
<span class="lineno"></span><span class="op" id="6551542">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="6551545">func</span>&nbsp;<span class="ident" id="6551550">benchmarkTCP</span><span class="op" id="6551562">(</span><span class="ident" id="6551563">b</span>&nbsp;<span class="op" id="6551565">*</span><span class="ident" id="6551566">testing</span><span class="op" id="6551573">.</span><span class="ident" id="6551574">B</span><span class="op" id="6551575">,</span>&nbsp;<span class="ident" id="6551577">persistent</span><span class="op" id="6551587">,</span>&nbsp;<span class="ident" id="6551589">timeout</span>&nbsp;<span class="builtintype" id="6551597">bool</span><span class="op" id="6551601">,</span>&nbsp;<span class="ident" id="6551603">laddr</span>&nbsp;<span class="builtintype" id="6551609">string</span><span class="op" id="6551615">)</span>&nbsp;<span class="op" id="6551617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6551620">const</span>&nbsp;<span class="ident" id="6551626">msgLen</span>&nbsp;<span class="op" id="6551633">=</span>&nbsp;<span class="num" id="6551635">512</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6551640">conns</span>&nbsp;<span class="op" id="6551646">:=</span>&nbsp;<span class="ident" id="6551649">b</span><span class="op" id="6551650">.</span><span class="ident" id="6551651">N</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6551654">numConcurrent</span>&nbsp;<span class="op" id="6551668">:=</span>&nbsp;<span class="ident" id="6551671">runtime</span><span class="op" id="6551678">.</span><span class="ident" id="6551679">GOMAXPROCS</span><span class="op" id="6551689">(</span><span class="op" id="6551690">-</span><span class="num" id="6551691">1</span><span class="op" id="6551692">)</span>&nbsp;<span class="op" id="6551694">*</span>&nbsp;<span class="num" id="6551696">2</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6551699">msgs</span>&nbsp;<span class="op" id="6551704">:=</span>&nbsp;<span class="num" id="6551707">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6551710">if</span>&nbsp;<span class="ident" id="6551713">persistent</span>&nbsp;<span class="op" id="6551724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6551728">conns</span>&nbsp;<span class="op" id="6551734">=</span>&nbsp;<span class="ident" id="6551736">numConcurrent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6551752">msgs</span>&nbsp;<span class="op" id="6551757">=</span>&nbsp;<span class="ident" id="6551759">b</span><span class="op" id="6551760">.</span><span class="ident" id="6551761">N</span>&nbsp;<span class="op" id="6551763">/</span>&nbsp;<span class="ident" id="6551765">conns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6551773">if</span>&nbsp;<span class="ident" id="6551776">msgs</span>&nbsp;<span class="op" id="6551781">==</span>&nbsp;<span class="num" id="6551784">0</span>&nbsp;<span class="op" id="6551786">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6551791">msgs</span>&nbsp;<span class="op" id="6551796">=</span>&nbsp;<span class="num" id="6551798">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6551802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6551806">if</span>&nbsp;<span class="ident" id="6551809">conns</span>&nbsp;<span class="op" id="6551815">&gt;</span>&nbsp;<span class="ident" id="6551817">b</span><span class="op" id="6551818">.</span><span class="ident" id="6551819">N</span>&nbsp;<span class="op" id="6551821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6551826">conns</span>&nbsp;<span class="op" id="6551832">=</span>&nbsp;<span class="ident" id="6551834">b</span><span class="op" id="6551835">.</span><span class="ident" id="6551836">N</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6551840">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6551843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6551846">sendMsg</span>&nbsp;<span class="op" id="6551854">:=</span>&nbsp;<span class="keyword" id="6551857">func</span><span class="op" id="6551861">(</span><span class="ident" id="6551862">c</span>&nbsp;<span class="ident" id="6551864">Conn</span><span class="op" id="6551868">,</span>&nbsp;<span class="ident" id="6551870">buf</span>&nbsp;<span class="op" id="6551874">[</span><span class="op" id="6551875">]</span><span class="builtintype" id="6551876">byte</span><span class="op" id="6551880">)</span>&nbsp;<span class="builtintype" id="6551882">bool</span>&nbsp;<span class="op" id="6551887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6551891">n</span><span class="op" id="6551892">,</span>&nbsp;<span class="ident" id="6551894">err</span>&nbsp;<span class="op" id="6551898">:=</span>&nbsp;<span class="ident" id="6551901">c</span><span class="op" id="6551902">.</span><span class="ident" id="6551903">Write</span><span class="op" id="6551908">(</span><span class="ident" id="6551909">buf</span><span class="op" id="6551912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6551916">if</span>&nbsp;<span class="ident" id="6551919">n</span>&nbsp;<span class="op" id="6551921">!=</span>&nbsp;<span class="builtinfunc" id="6551924">len</span><span class="op" id="6551927">(</span><span class="ident" id="6551928">buf</span><span class="op" id="6551931">)</span>&nbsp;<span class="op" id="6551933">||</span>&nbsp;<span class="ident" id="6551936">err</span>&nbsp;<span class="op" id="6551940">!=</span>&nbsp;<span class="builtintype" id="6551943">nil</span>&nbsp;<span class="op" id="6551947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6551952">b</span><span class="op" id="6551953">.</span><span class="ident" id="6551954">Logf</span><span class="op" id="6551958">(</span><span class="string" id="6551959">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6551977">,</span>&nbsp;<span class="ident" id="6551979">err</span><span class="op" id="6551982">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6551987">return</span>&nbsp;<span class="builtintype" id="6551994">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6552002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6552006">return</span>&nbsp;<span class="builtintype" id="6552013">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6552019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6552022">recvMsg</span>&nbsp;<span class="op" id="6552030">:=</span>&nbsp;<span class="keyword" id="6552033">func</span><span class="op" id="6552037">(</span><span class="ident" id="6552038">c</span>&nbsp;<span class="ident" id="6552040">Conn</span><span class="op" id="6552044">,</span>&nbsp;<span class="ident" id="6552046">buf</span>&nbsp;<span class="op" id="6552050">[</span><span class="op" id="6552051">]</span><span class="builtintype" id="6552052">byte</span><span class="op" id="6552056">)</span>&nbsp;<span class="builtintype" id="6552058">bool</span>&nbsp;<span class="op" id="6552063">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6552067">for</span>&nbsp;<span class="ident" id="6552071">read</span>&nbsp;<span class="op" id="6552076">:=</span>&nbsp;<span class="num" id="6552079">0</span><span class="op" id="6552080">;</span>&nbsp;<span class="ident" id="6552082">read</span>&nbsp;<span class="op" id="6552087">!=</span>&nbsp;<span class="builtinfunc" id="6552090">len</span><span class="op" id="6552093">(</span><span class="ident" id="6552094">buf</span><span class="op" id="6552097">)</span><span class="op" id="6552098">;</span>&nbsp;<span class="op" id="6552100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6552105">n</span><span class="op" id="6552106">,</span>&nbsp;<span class="ident" id="6552108">err</span>&nbsp;<span class="op" id="6552112">:=</span>&nbsp;<span class="ident" id="6552115">c</span><span class="op" id="6552116">.</span><span class="ident" id="6552117">Read</span><span class="op" id="6552121">(</span><span class="ident" id="6552122">buf</span><span class="op" id="6552125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6552130">read</span>&nbsp;<span class="op" id="6552135">+=</span>&nbsp;<span class="ident" id="6552138">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6552143">if</span>&nbsp;<span class="ident" id="6552146">err</span>&nbsp;<span class="op" id="6552150">!=</span>&nbsp;<span class="builtintype" id="6552153">nil</span>&nbsp;<span class="op" id="6552157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6552163">b</span><span class="op" id="6552164">.</span><span class="ident" id="6552165">Logf</span><span class="op" id="6552169">(</span><span class="string" id="6552170">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6552187">,</span>&nbsp;<span class="ident" id="6552189">err</span><span class="op" id="6552192">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6552198">return</span>&nbsp;<span class="builtintype" id="6552205">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6552214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6552218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6552222">return</span>&nbsp;<span class="builtintype" id="6552229">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6552235">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6552238">ln</span><span class="op" id="6552240">,</span>&nbsp;<span class="ident" id="6552242">err</span>&nbsp;<span class="op" id="6552246">:=</span>&nbsp;<span class="ident" id="6552249">Listen</span><span class="op" id="6552255">(</span><span class="string" id="6552256">&#34;tcp&#34;</span><span class="op" id="6552261">,</span>&nbsp;<span class="ident" id="6552263">laddr</span><span class="op" id="6552268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6552271">if</span>&nbsp;<span class="ident" id="6552274">err</span>&nbsp;<span class="op" id="6552278">!=</span>&nbsp;<span class="builtintype" id="6552281">nil</span>&nbsp;<span class="op" id="6552285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6552289">b</span><span class="op" id="6552290">.</span><span class="ident" id="6552291">Fatalf</span><span class="op" id="6552297">(</span><span class="string" id="6552298">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6552317">,</span>&nbsp;<span class="ident" id="6552319">err</span><span class="op" id="6552322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6552325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6552328">defer</span>&nbsp;<span class="ident" id="6552334">ln</span><span class="op" id="6552336">.</span><span class="ident" id="6552337">Close</span><span class="op" id="6552342">(</span><span class="op" id="6552343">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6552346">serverSem</span>&nbsp;<span class="op" id="6552356">:=</span>&nbsp;<span class="builtinfunc" id="6552359">make</span><span class="op" id="6552363">(</span><span class="keyword" id="6552364">chan</span>&nbsp;<span class="builtintype" id="6552369">bool</span><span class="op" id="6552373">,</span>&nbsp;<span class="ident" id="6552375">numConcurrent</span><span class="op" id="6552388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6552391">//&nbsp;Acceptor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6552405">go</span>&nbsp;<span class="keyword" id="6552408">func</span><span class="op" id="6552412">(</span><span class="op" id="6552413">)</span>&nbsp;<span class="op" id="6552415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6552419">for</span>&nbsp;<span class="op" id="6552423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6552428">c</span><span class="op" id="6552429">,</span>&nbsp;<span class="ident" id="6552431">err</span>&nbsp;<span class="op" id="6552435">:=</span>&nbsp;<span class="ident" id="6552438">ln</span><span class="op" id="6552440">.</span><span class="ident" id="6552441">Accept</span><span class="op" id="6552447">(</span><span class="op" id="6552448">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6552453">if</span>&nbsp;<span class="ident" id="6552456">err</span>&nbsp;<span class="op" id="6552460">!=</span>&nbsp;<span class="builtintype" id="6552463">nil</span>&nbsp;<span class="op" id="6552467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6552473">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6552482">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6552487">serverSem</span>&nbsp;<span class="op" id="6552497">&lt;-</span>&nbsp;<span class="builtintype" id="6552500">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6552508">//&nbsp;Server&nbsp;connection.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6552533">go</span>&nbsp;<span class="keyword" id="6552536">func</span><span class="op" id="6552540">(</span><span class="ident" id="6552541">c</span>&nbsp;<span class="ident" id="6552543">Conn</span><span class="op" id="6552547">)</span>&nbsp;<span class="op" id="6552549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6552555">defer</span>&nbsp;<span class="keyword" id="6552561">func</span><span class="op" id="6552565">(</span><span class="op" id="6552566">)</span>&nbsp;<span class="op" id="6552568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6552575">c</span><span class="op" id="6552576">.</span><span class="ident" id="6552577">Close</span><span class="op" id="6552582">(</span><span class="op" id="6552583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6552590">&lt;-</span><span class="ident" id="6552592">serverSem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6552606">}</span><span class="op" id="6552607">(</span><span class="op" id="6552608">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6552614">if</span>&nbsp;<span class="ident" id="6552617">timeout</span>&nbsp;<span class="op" id="6552625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6552632">c</span><span class="op" id="6552633">.</span><span class="ident" id="6552634">SetDeadline</span><span class="op" id="6552645">(</span><span class="ident" id="6552646">time</span><span class="op" id="6552650">.</span><span class="ident" id="6552651">Now</span><span class="op" id="6552654">(</span><span class="op" id="6552655">)</span><span class="op" id="6552656">.</span><span class="ident" id="6552657">Add</span><span class="op" id="6552660">(</span><span class="ident" id="6552661">time</span><span class="op" id="6552665">.</span><span class="ident" id="6552666">Hour</span><span class="op" id="6552670">)</span><span class="op" id="6552671">)</span>&nbsp;<span class="comment" id="6552673">//&nbsp;Not&nbsp;intended&nbsp;to&nbsp;fire.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6552702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6552708">var</span>&nbsp;<span class="ident" id="6552712">buf</span>&nbsp;<span class="op" id="6552716">[</span><span class="ident" id="6552717">msgLen</span><span class="op" id="6552723">]</span><span class="builtintype" id="6552724">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6552733">for</span>&nbsp;<span class="ident" id="6552737">m</span>&nbsp;<span class="op" id="6552739">:=</span>&nbsp;<span class="num" id="6552742">0</span><span class="op" id="6552743">;</span>&nbsp;<span class="ident" id="6552745">m</span>&nbsp;<span class="op" id="6552747">&lt;</span>&nbsp;<span class="ident" id="6552749">msgs</span><span class="op" id="6552753">;</span>&nbsp;<span class="ident" id="6552755">m</span><span class="op" id="6552756">++</span>&nbsp;<span class="op" id="6552759">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6552766">if</span>&nbsp;<span class="op" id="6552769">!</span><span class="ident" id="6552770">recvMsg</span><span class="op" id="6552777">(</span><span class="ident" id="6552778">c</span><span class="op" id="6552779">,</span>&nbsp;<span class="ident" id="6552781">buf</span><span class="op" id="6552784">[</span><span class="op" id="6552785">:</span><span class="op" id="6552786">]</span><span class="op" id="6552787">)</span>&nbsp;<span class="op" id="6552789">||</span>&nbsp;<span class="op" id="6552792">!</span><span class="ident" id="6552793">sendMsg</span><span class="op" id="6552800">(</span><span class="ident" id="6552801">c</span><span class="op" id="6552802">,</span>&nbsp;<span class="ident" id="6552804">buf</span><span class="op" id="6552807">[</span><span class="op" id="6552808">:</span><span class="op" id="6552809">]</span><span class="op" id="6552810">)</span>&nbsp;<span class="op" id="6552812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6552820">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6552831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6552837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6552842">}</span><span class="op" id="6552843">(</span><span class="ident" id="6552844">c</span><span class="op" id="6552845">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6552849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6552852">}</span><span class="op" id="6552853">(</span><span class="op" id="6552854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6552857">clientSem</span>&nbsp;<span class="op" id="6552867">:=</span>&nbsp;<span class="builtinfunc" id="6552870">make</span><span class="op" id="6552874">(</span><span class="keyword" id="6552875">chan</span>&nbsp;<span class="builtintype" id="6552880">bool</span><span class="op" id="6552884">,</span>&nbsp;<span class="ident" id="6552886">numConcurrent</span><span class="op" id="6552899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6552902">for</span>&nbsp;<span class="ident" id="6552906">i</span>&nbsp;<span class="op" id="6552908">:=</span>&nbsp;<span class="num" id="6552911">0</span><span class="op" id="6552912">;</span>&nbsp;<span class="ident" id="6552914">i</span>&nbsp;<span class="op" id="6552916">&lt;</span>&nbsp;<span class="ident" id="6552918">conns</span><span class="op" id="6552923">;</span>&nbsp;<span class="ident" id="6552925">i</span><span class="op" id="6552926">++</span>&nbsp;<span class="op" id="6552929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6552933">clientSem</span>&nbsp;<span class="op" id="6552943">&lt;-</span>&nbsp;<span class="builtintype" id="6552946">true</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6552953">//&nbsp;Client&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6552977">go</span>&nbsp;<span class="keyword" id="6552980">func</span><span class="op" id="6552984">(</span><span class="op" id="6552985">)</span>&nbsp;<span class="op" id="6552987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6552992">defer</span>&nbsp;<span class="keyword" id="6552998">func</span><span class="op" id="6553002">(</span><span class="op" id="6553003">)</span>&nbsp;<span class="op" id="6553005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6553011">&lt;-</span><span class="ident" id="6553013">clientSem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6553026">}</span><span class="op" id="6553027">(</span><span class="op" id="6553028">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6553033">c</span><span class="op" id="6553034">,</span>&nbsp;<span class="ident" id="6553036">err</span>&nbsp;<span class="op" id="6553040">:=</span>&nbsp;<span class="ident" id="6553043">Dial</span><span class="op" id="6553047">(</span><span class="string" id="6553048">&#34;tcp&#34;</span><span class="op" id="6553053">,</span>&nbsp;<span class="ident" id="6553055">ln</span><span class="op" id="6553057">.</span><span class="ident" id="6553058">Addr</span><span class="op" id="6553062">(</span><span class="op" id="6553063">)</span><span class="op" id="6553064">.</span><span class="ident" id="6553065">String</span><span class="op" id="6553071">(</span><span class="op" id="6553072">)</span><span class="op" id="6553073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6553078">if</span>&nbsp;<span class="ident" id="6553081">err</span>&nbsp;<span class="op" id="6553085">!=</span>&nbsp;<span class="builtintype" id="6553088">nil</span>&nbsp;<span class="op" id="6553092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6553098">b</span><span class="op" id="6553099">.</span><span class="ident" id="6553100">Logf</span><span class="op" id="6553104">(</span><span class="string" id="6553105">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6553122">,</span>&nbsp;<span class="ident" id="6553124">err</span><span class="op" id="6553127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6553133">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6553143">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6553148">defer</span>&nbsp;<span class="ident" id="6553154">c</span><span class="op" id="6553155">.</span><span class="ident" id="6553156">Close</span><span class="op" id="6553161">(</span><span class="op" id="6553162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6553167">if</span>&nbsp;<span class="ident" id="6553170">timeout</span>&nbsp;<span class="op" id="6553178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6553184">c</span><span class="op" id="6553185">.</span><span class="ident" id="6553186">SetDeadline</span><span class="op" id="6553197">(</span><span class="ident" id="6553198">time</span><span class="op" id="6553202">.</span><span class="ident" id="6553203">Now</span><span class="op" id="6553206">(</span><span class="op" id="6553207">)</span><span class="op" id="6553208">.</span><span class="ident" id="6553209">Add</span><span class="op" id="6553212">(</span><span class="ident" id="6553213">time</span><span class="op" id="6553217">.</span><span class="ident" id="6553218">Hour</span><span class="op" id="6553222">)</span><span class="op" id="6553223">)</span>&nbsp;<span class="comment" id="6553225">//&nbsp;Not&nbsp;intended&nbsp;to&nbsp;fire.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6553253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6553258">var</span>&nbsp;<span class="ident" id="6553262">buf</span>&nbsp;<span class="op" id="6553266">[</span><span class="ident" id="6553267">msgLen</span><span class="op" id="6553273">]</span><span class="builtintype" id="6553274">byte</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6553282">for</span>&nbsp;<span class="ident" id="6553286">m</span>&nbsp;<span class="op" id="6553288">:=</span>&nbsp;<span class="num" id="6553291">0</span><span class="op" id="6553292">;</span>&nbsp;<span class="ident" id="6553294">m</span>&nbsp;<span class="op" id="6553296">&lt;</span>&nbsp;<span class="ident" id="6553298">msgs</span><span class="op" id="6553302">;</span>&nbsp;<span class="ident" id="6553304">m</span><span class="op" id="6553305">++</span>&nbsp;<span class="op" id="6553308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6553314">if</span>&nbsp;<span class="op" id="6553317">!</span><span class="ident" id="6553318">sendMsg</span><span class="op" id="6553325">(</span><span class="ident" id="6553326">c</span><span class="op" id="6553327">,</span>&nbsp;<span class="ident" id="6553329">buf</span><span class="op" id="6553332">[</span><span class="op" id="6553333">:</span><span class="op" id="6553334">]</span><span class="op" id="6553335">)</span>&nbsp;<span class="op" id="6553337">||</span>&nbsp;<span class="op" id="6553340">!</span><span class="ident" id="6553341">recvMsg</span><span class="op" id="6553348">(</span><span class="ident" id="6553349">c</span><span class="op" id="6553350">,</span>&nbsp;<span class="ident" id="6553352">buf</span><span class="op" id="6553355">[</span><span class="op" id="6553356">:</span><span class="op" id="6553357">]</span><span class="op" id="6553358">)</span>&nbsp;<span class="op" id="6553360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6553367">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6553377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6553382">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6553386">}</span><span class="op" id="6553387">(</span><span class="op" id="6553388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6553391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6553394">for</span>&nbsp;<span class="ident" id="6553398">i</span>&nbsp;<span class="op" id="6553400">:=</span>&nbsp;<span class="num" id="6553403">0</span><span class="op" id="6553404">;</span>&nbsp;<span class="ident" id="6553406">i</span>&nbsp;<span class="op" id="6553408">&lt;</span>&nbsp;<span class="ident" id="6553410">numConcurrent</span><span class="op" id="6553423">;</span>&nbsp;<span class="ident" id="6553425">i</span><span class="op" id="6553426">++</span>&nbsp;<span class="op" id="6553429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6553433">clientSem</span>&nbsp;<span class="op" id="6553443">&lt;-</span>&nbsp;<span class="builtintype" id="6553446">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6553453">serverSem</span>&nbsp;<span class="op" id="6553463">&lt;-</span>&nbsp;<span class="builtintype" id="6553466">true</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6553472">}</span><br>
<span class="lineno"></span><span class="op" id="6553474">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6553477">func</span>&nbsp;<span class="ident" id="6553482">BenchmarkTCP4ConcurrentReadWrite</span><span class="op" id="6553514">(</span><span class="ident" id="6553515">b</span>&nbsp;<span class="op" id="6553517">*</span><span class="ident" id="6553518">testing</span><span class="op" id="6553525">.</span><span class="ident" id="6553526">B</span><span class="op" id="6553527">)</span>&nbsp;<span class="op" id="6553529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6553532">benchmarkTCPConcurrentReadWrite</span><span class="op" id="6553563">(</span><span class="ident" id="6553564">b</span><span class="op" id="6553565">,</span>&nbsp;<span class="string" id="6553567">&#34;127.0.0.1:0&#34;</span><span class="op" id="6553580">)</span><br>
<span class="lineno">160</span><span class="op" id="6553582">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6553585">func</span>&nbsp;<span class="ident" id="6553590">BenchmarkTCP6ConcurrentReadWrite</span><span class="op" id="6553622">(</span><span class="ident" id="6553623">b</span>&nbsp;<span class="op" id="6553625">*</span><span class="ident" id="6553626">testing</span><span class="op" id="6553633">.</span><span class="ident" id="6553634">B</span><span class="op" id="6553635">)</span>&nbsp;<span class="op" id="6553637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6553640">if</span>&nbsp;<span class="op" id="6553643">!</span><span class="ident" id="6553644">supportsIPv6</span>&nbsp;<span class="op" id="6553657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6553661">b</span><span class="op" id="6553662">.</span><span class="ident" id="6553663">Skip</span><span class="op" id="6553667">(</span><span class="string" id="6553668">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="6553691">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6553694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6553697">benchmarkTCPConcurrentReadWrite</span><span class="op" id="6553728">(</span><span class="ident" id="6553729">b</span><span class="op" id="6553730">,</span>&nbsp;<span class="string" id="6553732">&#34;[::1]:0&#34;</span><span class="op" id="6553741">)</span><br>
<span class="lineno"></span><span class="op" id="6553743">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6553746">func</span>&nbsp;<span class="ident" id="6553751">benchmarkTCPConcurrentReadWrite</span><span class="op" id="6553782">(</span><span class="ident" id="6553783">b</span>&nbsp;<span class="op" id="6553785">*</span><span class="ident" id="6553786">testing</span><span class="op" id="6553793">.</span><span class="ident" id="6553794">B</span><span class="op" id="6553795">,</span>&nbsp;<span class="ident" id="6553797">laddr</span>&nbsp;<span class="builtintype" id="6553803">string</span><span class="op" id="6553809">)</span>&nbsp;<span class="op" id="6553811">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6553814">//&nbsp;The&nbsp;benchmark&nbsp;creates&nbsp;GOMAXPROCS&nbsp;client/server&nbsp;pairs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6553872">//&nbsp;Each&nbsp;pair&nbsp;creates&nbsp;4&nbsp;goroutines:&nbsp;client&nbsp;reader/writer&nbsp;and&nbsp;server&nbsp;reader/writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6553955">//&nbsp;The&nbsp;benchmark&nbsp;stresses&nbsp;concurrent&nbsp;reading&nbsp;and&nbsp;writing&nbsp;to&nbsp;the&nbsp;same&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6554037">//&nbsp;Such&nbsp;pattern&nbsp;is&nbsp;used&nbsp;in&nbsp;net/http&nbsp;and&nbsp;net/rpc.</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6554088">b</span><span class="op" id="6554089">.</span><span class="ident" id="6554090">StopTimer</span><span class="op" id="6554099">(</span><span class="op" id="6554100">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6554104">P</span>&nbsp;<span class="op" id="6554106">:=</span>&nbsp;<span class="ident" id="6554109">runtime</span><span class="op" id="6554116">.</span><span class="ident" id="6554117">GOMAXPROCS</span><span class="op" id="6554127">(</span><span class="num" id="6554128">0</span><span class="op" id="6554129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6554132">N</span>&nbsp;<span class="op" id="6554134">:=</span>&nbsp;<span class="ident" id="6554137">b</span><span class="op" id="6554138">.</span><span class="ident" id="6554139">N</span>&nbsp;<span class="op" id="6554141">/</span>&nbsp;<span class="ident" id="6554143">P</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6554146">W</span>&nbsp;<span class="op" id="6554148">:=</span>&nbsp;<span class="num" id="6554151">1000</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6554158">//&nbsp;Setup&nbsp;P&nbsp;client/server&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6554197">clients</span>&nbsp;<span class="op" id="6554205">:=</span>&nbsp;<span class="builtinfunc" id="6554208">make</span><span class="op" id="6554212">(</span><span class="op" id="6554213">[</span><span class="op" id="6554214">]</span><span class="ident" id="6554215">Conn</span><span class="op" id="6554219">,</span>&nbsp;<span class="ident" id="6554221">P</span><span class="op" id="6554222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6554225">servers</span>&nbsp;<span class="op" id="6554233">:=</span>&nbsp;<span class="builtinfunc" id="6554236">make</span><span class="op" id="6554240">(</span><span class="op" id="6554241">[</span><span class="op" id="6554242">]</span><span class="ident" id="6554243">Conn</span><span class="op" id="6554247">,</span>&nbsp;<span class="ident" id="6554249">P</span><span class="op" id="6554250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6554253">ln</span><span class="op" id="6554255">,</span>&nbsp;<span class="ident" id="6554257">err</span>&nbsp;<span class="op" id="6554261">:=</span>&nbsp;<span class="ident" id="6554264">Listen</span><span class="op" id="6554270">(</span><span class="string" id="6554271">&#34;tcp&#34;</span><span class="op" id="6554276">,</span>&nbsp;<span class="ident" id="6554278">laddr</span><span class="op" id="6554283">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6554286">if</span>&nbsp;<span class="ident" id="6554289">err</span>&nbsp;<span class="op" id="6554293">!=</span>&nbsp;<span class="builtintype" id="6554296">nil</span>&nbsp;<span class="op" id="6554300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6554304">b</span><span class="op" id="6554305">.</span><span class="ident" id="6554306">Fatalf</span><span class="op" id="6554312">(</span><span class="string" id="6554313">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6554332">,</span>&nbsp;<span class="ident" id="6554334">err</span><span class="op" id="6554337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6554340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6554343">defer</span>&nbsp;<span class="ident" id="6554349">ln</span><span class="op" id="6554351">.</span><span class="ident" id="6554352">Close</span><span class="op" id="6554357">(</span><span class="op" id="6554358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6554361">done</span>&nbsp;<span class="op" id="6554366">:=</span>&nbsp;<span class="builtinfunc" id="6554369">make</span><span class="op" id="6554373">(</span><span class="keyword" id="6554374">chan</span>&nbsp;<span class="builtintype" id="6554379">bool</span><span class="op" id="6554383">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6554386">go</span>&nbsp;<span class="keyword" id="6554389">func</span><span class="op" id="6554393">(</span><span class="op" id="6554394">)</span>&nbsp;<span class="op" id="6554396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6554400">for</span>&nbsp;<span class="ident" id="6554404">p</span>&nbsp;<span class="op" id="6554406">:=</span>&nbsp;<span class="num" id="6554409">0</span><span class="op" id="6554410">;</span>&nbsp;<span class="ident" id="6554412">p</span>&nbsp;<span class="op" id="6554414">&lt;</span>&nbsp;<span class="ident" id="6554416">P</span><span class="op" id="6554417">;</span>&nbsp;<span class="ident" id="6554419">p</span><span class="op" id="6554420">++</span>&nbsp;<span class="op" id="6554423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6554428">s</span><span class="op" id="6554429">,</span>&nbsp;<span class="ident" id="6554431">err</span>&nbsp;<span class="op" id="6554435">:=</span>&nbsp;<span class="ident" id="6554438">ln</span><span class="op" id="6554440">.</span><span class="ident" id="6554441">Accept</span><span class="op" id="6554447">(</span><span class="op" id="6554448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6554453">if</span>&nbsp;<span class="ident" id="6554456">err</span>&nbsp;<span class="op" id="6554460">!=</span>&nbsp;<span class="builtintype" id="6554463">nil</span>&nbsp;<span class="op" id="6554467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6554473">b</span><span class="op" id="6554474">.</span><span class="ident" id="6554475">Errorf</span><span class="op" id="6554481">(</span><span class="string" id="6554482">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6554501">,</span>&nbsp;<span class="ident" id="6554503">err</span><span class="op" id="6554506">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6554512">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6554522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6554527">servers</span><span class="op" id="6554534">[</span><span class="ident" id="6554535">p</span><span class="op" id="6554536">]</span>&nbsp;<span class="op" id="6554538">=</span>&nbsp;<span class="ident" id="6554540">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6554544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6554548">done</span>&nbsp;<span class="op" id="6554553">&lt;-</span>&nbsp;<span class="builtintype" id="6554556">true</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6554562">}</span><span class="op" id="6554563">(</span><span class="op" id="6554564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6554567">for</span>&nbsp;<span class="ident" id="6554571">p</span>&nbsp;<span class="op" id="6554573">:=</span>&nbsp;<span class="num" id="6554576">0</span><span class="op" id="6554577">;</span>&nbsp;<span class="ident" id="6554579">p</span>&nbsp;<span class="op" id="6554581">&lt;</span>&nbsp;<span class="ident" id="6554583">P</span><span class="op" id="6554584">;</span>&nbsp;<span class="ident" id="6554586">p</span><span class="op" id="6554587">++</span>&nbsp;<span class="op" id="6554590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6554594">c</span><span class="op" id="6554595">,</span>&nbsp;<span class="ident" id="6554597">err</span>&nbsp;<span class="op" id="6554601">:=</span>&nbsp;<span class="ident" id="6554604">Dial</span><span class="op" id="6554608">(</span><span class="string" id="6554609">&#34;tcp&#34;</span><span class="op" id="6554614">,</span>&nbsp;<span class="ident" id="6554616">ln</span><span class="op" id="6554618">.</span><span class="ident" id="6554619">Addr</span><span class="op" id="6554623">(</span><span class="op" id="6554624">)</span><span class="op" id="6554625">.</span><span class="ident" id="6554626">String</span><span class="op" id="6554632">(</span><span class="op" id="6554633">)</span><span class="op" id="6554634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6554638">if</span>&nbsp;<span class="ident" id="6554641">err</span>&nbsp;<span class="op" id="6554645">!=</span>&nbsp;<span class="builtintype" id="6554648">nil</span>&nbsp;<span class="op" id="6554652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6554657">b</span><span class="op" id="6554658">.</span><span class="ident" id="6554659">Fatalf</span><span class="op" id="6554665">(</span><span class="string" id="6554666">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6554683">,</span>&nbsp;<span class="ident" id="6554685">err</span><span class="op" id="6554688">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6554692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6554696">clients</span><span class="op" id="6554703">[</span><span class="ident" id="6554704">p</span><span class="op" id="6554705">]</span>&nbsp;<span class="op" id="6554707">=</span>&nbsp;<span class="ident" id="6554709">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6554712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6554715">&lt;-</span><span class="ident" id="6554717">done</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6554724">b</span><span class="op" id="6554725">.</span><span class="ident" id="6554726">StartTimer</span><span class="op" id="6554736">(</span><span class="op" id="6554737">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6554741">var</span>&nbsp;<span class="ident" id="6554745">wg</span>&nbsp;<span class="ident" id="6554748">sync</span><span class="op" id="6554752">.</span><span class="ident" id="6554753">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6554764">wg</span><span class="op" id="6554766">.</span><span class="ident" id="6554767">Add</span><span class="op" id="6554770">(</span><span class="num" id="6554771">4</span>&nbsp;<span class="op" id="6554773">*</span>&nbsp;<span class="ident" id="6554775">P</span><span class="op" id="6554776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6554779">for</span>&nbsp;<span class="ident" id="6554783">p</span>&nbsp;<span class="op" id="6554785">:=</span>&nbsp;<span class="num" id="6554788">0</span><span class="op" id="6554789">;</span>&nbsp;<span class="ident" id="6554791">p</span>&nbsp;<span class="op" id="6554793">&lt;</span>&nbsp;<span class="ident" id="6554795">P</span><span class="op" id="6554796">;</span>&nbsp;<span class="ident" id="6554798">p</span><span class="op" id="6554799">++</span>&nbsp;<span class="op" id="6554802">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6554806">//&nbsp;Client&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6554826">go</span>&nbsp;<span class="keyword" id="6554829">func</span><span class="op" id="6554833">(</span><span class="ident" id="6554834">c</span>&nbsp;<span class="ident" id="6554836">Conn</span><span class="op" id="6554840">)</span>&nbsp;<span class="op" id="6554842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6554847">defer</span>&nbsp;<span class="ident" id="6554853">wg</span><span class="op" id="6554855">.</span><span class="ident" id="6554856">Done</span><span class="op" id="6554860">(</span><span class="op" id="6554861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6554866">var</span>&nbsp;<span class="ident" id="6554870">buf</span>&nbsp;<span class="op" id="6554874">[</span><span class="num" id="6554875">1</span><span class="op" id="6554876">]</span><span class="builtintype" id="6554877">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6554885">for</span>&nbsp;<span class="ident" id="6554889">i</span>&nbsp;<span class="op" id="6554891">:=</span>&nbsp;<span class="num" id="6554894">0</span><span class="op" id="6554895">;</span>&nbsp;<span class="ident" id="6554897">i</span>&nbsp;<span class="op" id="6554899">&lt;</span>&nbsp;<span class="ident" id="6554901">N</span><span class="op" id="6554902">;</span>&nbsp;<span class="ident" id="6554904">i</span><span class="op" id="6554905">++</span>&nbsp;<span class="op" id="6554908">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6554914">v</span>&nbsp;<span class="op" id="6554916">:=</span>&nbsp;<span class="builtintype" id="6554919">byte</span><span class="op" id="6554923">(</span><span class="ident" id="6554924">i</span><span class="op" id="6554925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6554931">for</span>&nbsp;<span class="ident" id="6554935">w</span>&nbsp;<span class="op" id="6554937">:=</span>&nbsp;<span class="num" id="6554940">0</span><span class="op" id="6554941">;</span>&nbsp;<span class="ident" id="6554943">w</span>&nbsp;<span class="op" id="6554945">&lt;</span>&nbsp;<span class="ident" id="6554947">W</span><span class="op" id="6554948">;</span>&nbsp;<span class="ident" id="6554950">w</span><span class="op" id="6554951">++</span>&nbsp;<span class="op" id="6554954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6554961">v</span>&nbsp;<span class="op" id="6554963">*=</span>&nbsp;<span class="ident" id="6554966">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6554972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6554978">buf</span><span class="op" id="6554981">[</span><span class="num" id="6554982">0</span><span class="op" id="6554983">]</span>&nbsp;<span class="op" id="6554985">=</span>&nbsp;<span class="ident" id="6554987">v</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6554993">_</span><span class="op" id="6554994">,</span>&nbsp;<span class="ident" id="6554996">err</span>&nbsp;<span class="op" id="6555000">:=</span>&nbsp;<span class="ident" id="6555003">c</span><span class="op" id="6555004">.</span><span class="ident" id="6555005">Write</span><span class="op" id="6555010">(</span><span class="ident" id="6555011">buf</span><span class="op" id="6555014">[</span><span class="op" id="6555015">:</span><span class="op" id="6555016">]</span><span class="op" id="6555017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6555023">if</span>&nbsp;<span class="ident" id="6555026">err</span>&nbsp;<span class="op" id="6555030">!=</span>&nbsp;<span class="builtintype" id="6555033">nil</span>&nbsp;<span class="op" id="6555037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6555044">b</span><span class="op" id="6555045">.</span><span class="ident" id="6555046">Errorf</span><span class="op" id="6555052">(</span><span class="string" id="6555053">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6555071">,</span>&nbsp;<span class="ident" id="6555073">err</span><span class="op" id="6555076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6555083">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6555094">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6555099">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6555103">}</span><span class="op" id="6555104">(</span><span class="ident" id="6555105">clients</span><span class="op" id="6555112">[</span><span class="ident" id="6555113">p</span><span class="op" id="6555114">]</span><span class="op" id="6555115">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6555120">//&nbsp;Pipe&nbsp;between&nbsp;server&nbsp;reader&nbsp;and&nbsp;server&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6555171">pipe</span>&nbsp;<span class="op" id="6555176">:=</span>&nbsp;<span class="builtinfunc" id="6555179">make</span><span class="op" id="6555183">(</span><span class="keyword" id="6555184">chan</span>&nbsp;<span class="builtintype" id="6555189">byte</span><span class="op" id="6555193">,</span>&nbsp;<span class="num" id="6555195">128</span><span class="op" id="6555198">)</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6555203">//&nbsp;Server&nbsp;reader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6555223">go</span>&nbsp;<span class="keyword" id="6555226">func</span><span class="op" id="6555230">(</span><span class="ident" id="6555231">s</span>&nbsp;<span class="ident" id="6555233">Conn</span><span class="op" id="6555237">)</span>&nbsp;<span class="op" id="6555239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6555244">defer</span>&nbsp;<span class="ident" id="6555250">wg</span><span class="op" id="6555252">.</span><span class="ident" id="6555253">Done</span><span class="op" id="6555257">(</span><span class="op" id="6555258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6555263">var</span>&nbsp;<span class="ident" id="6555267">buf</span>&nbsp;<span class="op" id="6555271">[</span><span class="num" id="6555272">1</span><span class="op" id="6555273">]</span><span class="builtintype" id="6555274">byte</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6555282">for</span>&nbsp;<span class="ident" id="6555286">i</span>&nbsp;<span class="op" id="6555288">:=</span>&nbsp;<span class="num" id="6555291">0</span><span class="op" id="6555292">;</span>&nbsp;<span class="ident" id="6555294">i</span>&nbsp;<span class="op" id="6555296">&lt;</span>&nbsp;<span class="ident" id="6555298">N</span><span class="op" id="6555299">;</span>&nbsp;<span class="ident" id="6555301">i</span><span class="op" id="6555302">++</span>&nbsp;<span class="op" id="6555305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6555311">_</span><span class="op" id="6555312">,</span>&nbsp;<span class="ident" id="6555314">err</span>&nbsp;<span class="op" id="6555318">:=</span>&nbsp;<span class="ident" id="6555321">s</span><span class="op" id="6555322">.</span><span class="ident" id="6555323">Read</span><span class="op" id="6555327">(</span><span class="ident" id="6555328">buf</span><span class="op" id="6555331">[</span><span class="op" id="6555332">:</span><span class="op" id="6555333">]</span><span class="op" id="6555334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6555340">if</span>&nbsp;<span class="ident" id="6555343">err</span>&nbsp;<span class="op" id="6555347">!=</span>&nbsp;<span class="builtintype" id="6555350">nil</span>&nbsp;<span class="op" id="6555354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6555361">b</span><span class="op" id="6555362">.</span><span class="ident" id="6555363">Errorf</span><span class="op" id="6555369">(</span><span class="string" id="6555370">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6555387">,</span>&nbsp;<span class="ident" id="6555389">err</span><span class="op" id="6555392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6555399">return</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6555410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6555416">pipe</span>&nbsp;<span class="op" id="6555421">&lt;-</span>&nbsp;<span class="ident" id="6555424">buf</span><span class="op" id="6555427">[</span><span class="num" id="6555428">0</span><span class="op" id="6555429">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6555434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6555438">}</span><span class="op" id="6555439">(</span><span class="ident" id="6555440">servers</span><span class="op" id="6555447">[</span><span class="ident" id="6555448">p</span><span class="op" id="6555449">]</span><span class="op" id="6555450">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6555455">//&nbsp;Server&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6555475">go</span>&nbsp;<span class="keyword" id="6555478">func</span><span class="op" id="6555482">(</span><span class="ident" id="6555483">s</span>&nbsp;<span class="ident" id="6555485">Conn</span><span class="op" id="6555489">)</span>&nbsp;<span class="op" id="6555491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6555496">defer</span>&nbsp;<span class="ident" id="6555502">wg</span><span class="op" id="6555504">.</span><span class="ident" id="6555505">Done</span><span class="op" id="6555509">(</span><span class="op" id="6555510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6555515">var</span>&nbsp;<span class="ident" id="6555519">buf</span>&nbsp;<span class="op" id="6555523">[</span><span class="num" id="6555524">1</span><span class="op" id="6555525">]</span><span class="builtintype" id="6555526">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6555534">for</span>&nbsp;<span class="ident" id="6555538">i</span>&nbsp;<span class="op" id="6555540">:=</span>&nbsp;<span class="num" id="6555543">0</span><span class="op" id="6555544">;</span>&nbsp;<span class="ident" id="6555546">i</span>&nbsp;<span class="op" id="6555548">&lt;</span>&nbsp;<span class="ident" id="6555550">N</span><span class="op" id="6555551">;</span>&nbsp;<span class="ident" id="6555553">i</span><span class="op" id="6555554">++</span>&nbsp;<span class="op" id="6555557">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6555563">v</span>&nbsp;<span class="op" id="6555565">:=</span>&nbsp;<span class="op" id="6555568">&lt;-</span><span class="ident" id="6555570">pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6555579">for</span>&nbsp;<span class="ident" id="6555583">w</span>&nbsp;<span class="op" id="6555585">:=</span>&nbsp;<span class="num" id="6555588">0</span><span class="op" id="6555589">;</span>&nbsp;<span class="ident" id="6555591">w</span>&nbsp;<span class="op" id="6555593">&lt;</span>&nbsp;<span class="ident" id="6555595">W</span><span class="op" id="6555596">;</span>&nbsp;<span class="ident" id="6555598">w</span><span class="op" id="6555599">++</span>&nbsp;<span class="op" id="6555602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6555609">v</span>&nbsp;<span class="op" id="6555611">*=</span>&nbsp;<span class="ident" id="6555614">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6555620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6555626">buf</span><span class="op" id="6555629">[</span><span class="num" id="6555630">0</span><span class="op" id="6555631">]</span>&nbsp;<span class="op" id="6555633">=</span>&nbsp;<span class="ident" id="6555635">v</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6555641">_</span><span class="op" id="6555642">,</span>&nbsp;<span class="ident" id="6555644">err</span>&nbsp;<span class="op" id="6555648">:=</span>&nbsp;<span class="ident" id="6555651">s</span><span class="op" id="6555652">.</span><span class="ident" id="6555653">Write</span><span class="op" id="6555658">(</span><span class="ident" id="6555659">buf</span><span class="op" id="6555662">[</span><span class="op" id="6555663">:</span><span class="op" id="6555664">]</span><span class="op" id="6555665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6555671">if</span>&nbsp;<span class="ident" id="6555674">err</span>&nbsp;<span class="op" id="6555678">!=</span>&nbsp;<span class="builtintype" id="6555681">nil</span>&nbsp;<span class="op" id="6555685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6555692">b</span><span class="op" id="6555693">.</span><span class="ident" id="6555694">Errorf</span><span class="op" id="6555700">(</span><span class="string" id="6555701">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6555719">,</span>&nbsp;<span class="ident" id="6555721">err</span><span class="op" id="6555724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6555731">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6555742">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6555747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6555752">s</span><span class="op" id="6555753">.</span><span class="ident" id="6555754">Close</span><span class="op" id="6555759">(</span><span class="op" id="6555760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6555764">}</span><span class="op" id="6555765">(</span><span class="ident" id="6555766">servers</span><span class="op" id="6555773">[</span><span class="ident" id="6555774">p</span><span class="op" id="6555775">]</span><span class="op" id="6555776">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6555781">//&nbsp;Client&nbsp;reader.</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6555801">go</span>&nbsp;<span class="keyword" id="6555804">func</span><span class="op" id="6555808">(</span><span class="ident" id="6555809">c</span>&nbsp;<span class="ident" id="6555811">Conn</span><span class="op" id="6555815">)</span>&nbsp;<span class="op" id="6555817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6555822">defer</span>&nbsp;<span class="ident" id="6555828">wg</span><span class="op" id="6555830">.</span><span class="ident" id="6555831">Done</span><span class="op" id="6555835">(</span><span class="op" id="6555836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6555841">var</span>&nbsp;<span class="ident" id="6555845">buf</span>&nbsp;<span class="op" id="6555849">[</span><span class="num" id="6555850">1</span><span class="op" id="6555851">]</span><span class="builtintype" id="6555852">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6555860">for</span>&nbsp;<span class="ident" id="6555864">i</span>&nbsp;<span class="op" id="6555866">:=</span>&nbsp;<span class="num" id="6555869">0</span><span class="op" id="6555870">;</span>&nbsp;<span class="ident" id="6555872">i</span>&nbsp;<span class="op" id="6555874">&lt;</span>&nbsp;<span class="ident" id="6555876">N</span><span class="op" id="6555877">;</span>&nbsp;<span class="ident" id="6555879">i</span><span class="op" id="6555880">++</span>&nbsp;<span class="op" id="6555883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6555889">_</span><span class="op" id="6555890">,</span>&nbsp;<span class="ident" id="6555892">err</span>&nbsp;<span class="op" id="6555896">:=</span>&nbsp;<span class="ident" id="6555899">c</span><span class="op" id="6555900">.</span><span class="ident" id="6555901">Read</span><span class="op" id="6555905">(</span><span class="ident" id="6555906">buf</span><span class="op" id="6555909">[</span><span class="op" id="6555910">:</span><span class="op" id="6555911">]</span><span class="op" id="6555912">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6555918">if</span>&nbsp;<span class="ident" id="6555921">err</span>&nbsp;<span class="op" id="6555925">!=</span>&nbsp;<span class="builtintype" id="6555928">nil</span>&nbsp;<span class="op" id="6555932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6555939">b</span><span class="op" id="6555940">.</span><span class="ident" id="6555941">Errorf</span><span class="op" id="6555947">(</span><span class="string" id="6555948">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6555965">,</span>&nbsp;<span class="ident" id="6555967">err</span><span class="op" id="6555970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6555977">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6555988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6555993">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6555998">c</span><span class="op" id="6555999">.</span><span class="ident" id="6556000">Close</span><span class="op" id="6556005">(</span><span class="op" id="6556006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6556010">}</span><span class="op" id="6556011">(</span><span class="ident" id="6556012">clients</span><span class="op" id="6556019">[</span><span class="ident" id="6556020">p</span><span class="op" id="6556021">]</span><span class="op" id="6556022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6556025">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6556028">wg</span><span class="op" id="6556030">.</span><span class="ident" id="6556031">Wait</span><span class="op" id="6556035">(</span><span class="op" id="6556036">)</span><br>
<span class="lineno"></span><span class="op" id="6556038">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="6556041">type</span>&nbsp;<span class="ident" id="6556046">resolveTCPAddrTest</span>&nbsp;<span class="keyword" id="6556065">struct</span>&nbsp;<span class="op" id="6556072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6556075">net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6556089">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6556097">litAddrOrName</span>&nbsp;<span class="builtintype" id="6556111">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6556119">addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6556133">*</span><span class="ident" id="6556134">TCPAddr</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6556143">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6556157">error</span><br>
<span class="lineno"></span><span class="op" id="6556163">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6556166">var</span>&nbsp;<span class="ident" id="6556170">resolveTCPAddrTests</span>&nbsp;<span class="op" id="6556190">=</span>&nbsp;<span class="op" id="6556192">[</span><span class="op" id="6556193">]</span><span class="ident" id="6556194">resolveTCPAddrTest</span><span class="op" id="6556212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6556215">{</span><span class="string" id="6556216">&#34;tcp&#34;</span><span class="op" id="6556221">,</span>&nbsp;<span class="string" id="6556223">&#34;127.0.0.1:0&#34;</span><span class="op" id="6556236">,</span>&nbsp;<span class="op" id="6556238">&amp;</span><span class="ident" id="6556239">TCPAddr</span><span class="op" id="6556246">{</span><span class="ident" id="6556247">IP</span><span class="op" id="6556249">:</span>&nbsp;<span class="ident" id="6556251">IPv4</span><span class="op" id="6556255">(</span><span class="num" id="6556256">127</span><span class="op" id="6556259">,</span>&nbsp;<span class="num" id="6556261">0</span><span class="op" id="6556262">,</span>&nbsp;<span class="num" id="6556264">0</span><span class="op" id="6556265">,</span>&nbsp;<span class="num" id="6556267">1</span><span class="op" id="6556268">)</span><span class="op" id="6556269">,</span>&nbsp;<span class="ident" id="6556271">Port</span><span class="op" id="6556275">:</span>&nbsp;<span class="num" id="6556277">0</span><span class="op" id="6556278">}</span><span class="op" id="6556279">,</span>&nbsp;<span class="builtintype" id="6556281">nil</span><span class="op" id="6556284">}</span><span class="op" id="6556285">,</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6556288">{</span><span class="string" id="6556289">&#34;tcp4&#34;</span><span class="op" id="6556295">,</span>&nbsp;<span class="string" id="6556297">&#34;127.0.0.1:65535&#34;</span><span class="op" id="6556314">,</span>&nbsp;<span class="op" id="6556316">&amp;</span><span class="ident" id="6556317">TCPAddr</span><span class="op" id="6556324">{</span><span class="ident" id="6556325">IP</span><span class="op" id="6556327">:</span>&nbsp;<span class="ident" id="6556329">IPv4</span><span class="op" id="6556333">(</span><span class="num" id="6556334">127</span><span class="op" id="6556337">,</span>&nbsp;<span class="num" id="6556339">0</span><span class="op" id="6556340">,</span>&nbsp;<span class="num" id="6556342">0</span><span class="op" id="6556343">,</span>&nbsp;<span class="num" id="6556345">1</span><span class="op" id="6556346">)</span><span class="op" id="6556347">,</span>&nbsp;<span class="ident" id="6556349">Port</span><span class="op" id="6556353">:</span>&nbsp;<span class="num" id="6556355">65535</span><span class="op" id="6556360">}</span><span class="op" id="6556361">,</span>&nbsp;<span class="builtintype" id="6556363">nil</span><span class="op" id="6556366">}</span><span class="op" id="6556367">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6556371">{</span><span class="string" id="6556372">&#34;tcp&#34;</span><span class="op" id="6556377">,</span>&nbsp;<span class="string" id="6556379">&#34;[::1]:1&#34;</span><span class="op" id="6556388">,</span>&nbsp;<span class="op" id="6556390">&amp;</span><span class="ident" id="6556391">TCPAddr</span><span class="op" id="6556398">{</span><span class="ident" id="6556399">IP</span><span class="op" id="6556401">:</span>&nbsp;<span class="ident" id="6556403">ParseIP</span><span class="op" id="6556410">(</span><span class="string" id="6556411">&#34;::1&#34;</span><span class="op" id="6556416">)</span><span class="op" id="6556417">,</span>&nbsp;<span class="ident" id="6556419">Port</span><span class="op" id="6556423">:</span>&nbsp;<span class="num" id="6556425">1</span><span class="op" id="6556426">}</span><span class="op" id="6556427">,</span>&nbsp;<span class="builtintype" id="6556429">nil</span><span class="op" id="6556432">}</span><span class="op" id="6556433">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6556436">{</span><span class="string" id="6556437">&#34;tcp6&#34;</span><span class="op" id="6556443">,</span>&nbsp;<span class="string" id="6556445">&#34;[::1]:65534&#34;</span><span class="op" id="6556458">,</span>&nbsp;<span class="op" id="6556460">&amp;</span><span class="ident" id="6556461">TCPAddr</span><span class="op" id="6556468">{</span><span class="ident" id="6556469">IP</span><span class="op" id="6556471">:</span>&nbsp;<span class="ident" id="6556473">ParseIP</span><span class="op" id="6556480">(</span><span class="string" id="6556481">&#34;::1&#34;</span><span class="op" id="6556486">)</span><span class="op" id="6556487">,</span>&nbsp;<span class="ident" id="6556489">Port</span><span class="op" id="6556493">:</span>&nbsp;<span class="num" id="6556495">65534</span><span class="op" id="6556500">}</span><span class="op" id="6556501">,</span>&nbsp;<span class="builtintype" id="6556503">nil</span><span class="op" id="6556506">}</span><span class="op" id="6556507">,</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6556511">{</span><span class="string" id="6556512">&#34;tcp&#34;</span><span class="op" id="6556517">,</span>&nbsp;<span class="string" id="6556519">&#34;[::1%en0]:1&#34;</span><span class="op" id="6556532">,</span>&nbsp;<span class="op" id="6556534">&amp;</span><span class="ident" id="6556535">TCPAddr</span><span class="op" id="6556542">{</span><span class="ident" id="6556543">IP</span><span class="op" id="6556545">:</span>&nbsp;<span class="ident" id="6556547">ParseIP</span><span class="op" id="6556554">(</span><span class="string" id="6556555">&#34;::1&#34;</span><span class="op" id="6556560">)</span><span class="op" id="6556561">,</span>&nbsp;<span class="ident" id="6556563">Port</span><span class="op" id="6556567">:</span>&nbsp;<span class="num" id="6556569">1</span><span class="op" id="6556570">,</span>&nbsp;<span class="ident" id="6556572">Zone</span><span class="op" id="6556576">:</span>&nbsp;<span class="string" id="6556578">&#34;en0&#34;</span><span class="op" id="6556583">}</span><span class="op" id="6556584">,</span>&nbsp;<span class="builtintype" id="6556586">nil</span><span class="op" id="6556589">}</span><span class="op" id="6556590">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6556593">{</span><span class="string" id="6556594">&#34;tcp6&#34;</span><span class="op" id="6556600">,</span>&nbsp;<span class="string" id="6556602">&#34;[::1%911]:2&#34;</span><span class="op" id="6556615">,</span>&nbsp;<span class="op" id="6556617">&amp;</span><span class="ident" id="6556618">TCPAddr</span><span class="op" id="6556625">{</span><span class="ident" id="6556626">IP</span><span class="op" id="6556628">:</span>&nbsp;<span class="ident" id="6556630">ParseIP</span><span class="op" id="6556637">(</span><span class="string" id="6556638">&#34;::1&#34;</span><span class="op" id="6556643">)</span><span class="op" id="6556644">,</span>&nbsp;<span class="ident" id="6556646">Port</span><span class="op" id="6556650">:</span>&nbsp;<span class="num" id="6556652">2</span><span class="op" id="6556653">,</span>&nbsp;<span class="ident" id="6556655">Zone</span><span class="op" id="6556659">:</span>&nbsp;<span class="string" id="6556661">&#34;911&#34;</span><span class="op" id="6556666">}</span><span class="op" id="6556667">,</span>&nbsp;<span class="builtintype" id="6556669">nil</span><span class="op" id="6556672">}</span><span class="op" id="6556673">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6556677">{</span><span class="string" id="6556678">&#34;&#34;</span><span class="op" id="6556680">,</span>&nbsp;<span class="string" id="6556682">&#34;127.0.0.1:0&#34;</span><span class="op" id="6556695">,</span>&nbsp;<span class="op" id="6556697">&amp;</span><span class="ident" id="6556698">TCPAddr</span><span class="op" id="6556705">{</span><span class="ident" id="6556706">IP</span><span class="op" id="6556708">:</span>&nbsp;<span class="ident" id="6556710">IPv4</span><span class="op" id="6556714">(</span><span class="num" id="6556715">127</span><span class="op" id="6556718">,</span>&nbsp;<span class="num" id="6556720">0</span><span class="op" id="6556721">,</span>&nbsp;<span class="num" id="6556723">0</span><span class="op" id="6556724">,</span>&nbsp;<span class="num" id="6556726">1</span><span class="op" id="6556727">)</span><span class="op" id="6556728">,</span>&nbsp;<span class="ident" id="6556730">Port</span><span class="op" id="6556734">:</span>&nbsp;<span class="num" id="6556736">0</span><span class="op" id="6556737">}</span><span class="op" id="6556738">,</span>&nbsp;<span class="builtintype" id="6556740">nil</span><span class="op" id="6556743">}</span><span class="op" id="6556744">,</span>&nbsp;<span class="comment" id="6556746">//&nbsp;Go&nbsp;1.0&nbsp;behavior</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6556766">{</span><span class="string" id="6556767">&#34;&#34;</span><span class="op" id="6556769">,</span>&nbsp;<span class="string" id="6556771">&#34;[::1]:0&#34;</span><span class="op" id="6556780">,</span>&nbsp;<span class="op" id="6556782">&amp;</span><span class="ident" id="6556783">TCPAddr</span><span class="op" id="6556790">{</span><span class="ident" id="6556791">IP</span><span class="op" id="6556793">:</span>&nbsp;<span class="ident" id="6556795">ParseIP</span><span class="op" id="6556802">(</span><span class="string" id="6556803">&#34;::1&#34;</span><span class="op" id="6556808">)</span><span class="op" id="6556809">,</span>&nbsp;<span class="ident" id="6556811">Port</span><span class="op" id="6556815">:</span>&nbsp;<span class="num" id="6556817">0</span><span class="op" id="6556818">}</span><span class="op" id="6556819">,</span>&nbsp;<span class="builtintype" id="6556821">nil</span><span class="op" id="6556824">}</span><span class="op" id="6556825">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6556835">//&nbsp;Go&nbsp;1.0&nbsp;behavior</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6556856">{</span><span class="string" id="6556857">&#34;tcp&#34;</span><span class="op" id="6556862">,</span>&nbsp;<span class="string" id="6556864">&#34;:12345&#34;</span><span class="op" id="6556872">,</span>&nbsp;<span class="op" id="6556874">&amp;</span><span class="ident" id="6556875">TCPAddr</span><span class="op" id="6556882">{</span><span class="ident" id="6556883">Port</span><span class="op" id="6556887">:</span>&nbsp;<span class="num" id="6556889">12345</span><span class="op" id="6556894">}</span><span class="op" id="6556895">,</span>&nbsp;<span class="builtintype" id="6556897">nil</span><span class="op" id="6556900">}</span><span class="op" id="6556901">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6556905">{</span><span class="string" id="6556906">&#34;http&#34;</span><span class="op" id="6556912">,</span>&nbsp;<span class="string" id="6556914">&#34;127.0.0.1:0&#34;</span><span class="op" id="6556927">,</span>&nbsp;<span class="builtintype" id="6556929">nil</span><span class="op" id="6556932">,</span>&nbsp;<span class="ident" id="6556934">UnknownNetworkError</span><span class="op" id="6556953">(</span><span class="string" id="6556954">&#34;http&#34;</span><span class="op" id="6556960">)</span><span class="op" id="6556961">}</span><span class="op" id="6556962">,</span><br>
<span class="lineno"></span><span class="op" id="6556964">}</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span><span class="keyword" id="6556967">func</span>&nbsp;<span class="ident" id="6556972">init</span><span class="op" id="6556976">(</span><span class="op" id="6556977">)</span>&nbsp;<span class="op" id="6556979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6556982">if</span>&nbsp;<span class="ident" id="6556985">ifi</span>&nbsp;<span class="op" id="6556989">:=</span>&nbsp;<span class="ident" id="6556992">loopbackInterface</span><span class="op" id="6557009">(</span><span class="op" id="6557010">)</span><span class="op" id="6557011">;</span>&nbsp;<span class="ident" id="6557013">ifi</span>&nbsp;<span class="op" id="6557017">!=</span>&nbsp;<span class="builtintype" id="6557020">nil</span>&nbsp;<span class="op" id="6557024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6557028">index</span>&nbsp;<span class="op" id="6557034">:=</span>&nbsp;<span class="ident" id="6557037">fmt</span><span class="op" id="6557040">.</span><span class="ident" id="6557041">Sprintf</span><span class="op" id="6557048">(</span><span class="string" id="6557049">&#34;%v&#34;</span><span class="op" id="6557053">,</span>&nbsp;<span class="ident" id="6557055">ifi</span><span class="op" id="6557058">.</span><span class="ident" id="6557059">Index</span><span class="op" id="6557064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6557068">resolveTCPAddrTests</span>&nbsp;<span class="op" id="6557088">=</span>&nbsp;<span class="builtinfunc" id="6557090">append</span><span class="op" id="6557096">(</span><span class="ident" id="6557097">resolveTCPAddrTests</span><span class="op" id="6557116">,</span>&nbsp;<span class="op" id="6557118">[</span><span class="op" id="6557119">]</span><span class="ident" id="6557120">resolveTCPAddrTest</span><span class="op" id="6557138">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6557143">{</span><span class="string" id="6557144">&#34;tcp6&#34;</span><span class="op" id="6557150">,</span>&nbsp;<span class="string" id="6557152">&#34;[fe80::1%&#34;</span>&nbsp;<span class="op" id="6557164">+</span>&nbsp;<span class="ident" id="6557166">ifi</span><span class="op" id="6557169">.</span><span class="ident" id="6557170">Name</span>&nbsp;<span class="op" id="6557175">+</span>&nbsp;<span class="string" id="6557177">&#34;]:3&#34;</span><span class="op" id="6557182">,</span>&nbsp;<span class="op" id="6557184">&amp;</span><span class="ident" id="6557185">TCPAddr</span><span class="op" id="6557192">{</span><span class="ident" id="6557193">IP</span><span class="op" id="6557195">:</span>&nbsp;<span class="ident" id="6557197">ParseIP</span><span class="op" id="6557204">(</span><span class="string" id="6557205">&#34;fe80::1&#34;</span><span class="op" id="6557214">)</span><span class="op" id="6557215">,</span>&nbsp;<span class="ident" id="6557217">Port</span><span class="op" id="6557221">:</span>&nbsp;<span class="num" id="6557223">3</span><span class="op" id="6557224">,</span>&nbsp;<span class="ident" id="6557226">Zone</span><span class="op" id="6557230">:</span>&nbsp;<span class="ident" id="6557232">zoneToString</span><span class="op" id="6557244">(</span><span class="ident" id="6557245">ifi</span><span class="op" id="6557248">.</span><span class="ident" id="6557249">Index</span><span class="op" id="6557254">)</span><span class="op" id="6557255">}</span><span class="op" id="6557256">,</span>&nbsp;<span class="builtintype" id="6557258">nil</span><span class="op" id="6557261">}</span><span class="op" id="6557262">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6557267">{</span><span class="string" id="6557268">&#34;tcp6&#34;</span><span class="op" id="6557274">,</span>&nbsp;<span class="string" id="6557276">&#34;[fe80::1%&#34;</span>&nbsp;<span class="op" id="6557288">+</span>&nbsp;<span class="ident" id="6557290">index</span>&nbsp;<span class="op" id="6557296">+</span>&nbsp;<span class="string" id="6557298">&#34;]:4&#34;</span><span class="op" id="6557303">,</span>&nbsp;<span class="op" id="6557305">&amp;</span><span class="ident" id="6557306">TCPAddr</span><span class="op" id="6557313">{</span><span class="ident" id="6557314">IP</span><span class="op" id="6557316">:</span>&nbsp;<span class="ident" id="6557318">ParseIP</span><span class="op" id="6557325">(</span><span class="string" id="6557326">&#34;fe80::1&#34;</span><span class="op" id="6557335">)</span><span class="op" id="6557336">,</span>&nbsp;<span class="ident" id="6557338">Port</span><span class="op" id="6557342">:</span>&nbsp;<span class="num" id="6557344">4</span><span class="op" id="6557345">,</span>&nbsp;<span class="ident" id="6557347">Zone</span><span class="op" id="6557351">:</span>&nbsp;<span class="ident" id="6557353">index</span><span class="op" id="6557358">}</span><span class="op" id="6557359">,</span>&nbsp;<span class="builtintype" id="6557361">nil</span><span class="op" id="6557364">}</span><span class="op" id="6557365">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6557369">}</span><span class="op" id="6557370">...</span><span class="op" id="6557373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6557376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6557379">if</span>&nbsp;<span class="ident" id="6557382">ips</span><span class="op" id="6557385">,</span>&nbsp;<span class="ident" id="6557387">err</span>&nbsp;<span class="op" id="6557391">:=</span>&nbsp;<span class="ident" id="6557394">LookupIP</span><span class="op" id="6557402">(</span><span class="string" id="6557403">&#34;localhost&#34;</span><span class="op" id="6557414">)</span><span class="op" id="6557415">;</span>&nbsp;<span class="ident" id="6557417">err</span>&nbsp;<span class="op" id="6557421">==</span>&nbsp;<span class="builtintype" id="6557424">nil</span>&nbsp;<span class="op" id="6557428">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="6557431">len</span><span class="op" id="6557434">(</span><span class="ident" id="6557435">ips</span><span class="op" id="6557438">)</span>&nbsp;<span class="op" id="6557440">&gt;</span>&nbsp;<span class="num" id="6557442">1</span>&nbsp;<span class="op" id="6557444">&amp;&amp;</span>&nbsp;<span class="ident" id="6557447">supportsIPv4</span>&nbsp;<span class="op" id="6557460">&amp;&amp;</span>&nbsp;<span class="ident" id="6557463">supportsIPv6</span>&nbsp;<span class="op" id="6557476">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6557480">resolveTCPAddrTests</span>&nbsp;<span class="op" id="6557500">=</span>&nbsp;<span class="builtinfunc" id="6557502">append</span><span class="op" id="6557508">(</span><span class="ident" id="6557509">resolveTCPAddrTests</span><span class="op" id="6557528">,</span>&nbsp;<span class="op" id="6557530">[</span><span class="op" id="6557531">]</span><span class="ident" id="6557532">resolveTCPAddrTest</span><span class="op" id="6557550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6557555">{</span><span class="string" id="6557556">&#34;tcp&#34;</span><span class="op" id="6557561">,</span>&nbsp;<span class="string" id="6557563">&#34;localhost:5&#34;</span><span class="op" id="6557576">,</span>&nbsp;<span class="op" id="6557578">&amp;</span><span class="ident" id="6557579">TCPAddr</span><span class="op" id="6557586">{</span><span class="ident" id="6557587">IP</span><span class="op" id="6557589">:</span>&nbsp;<span class="ident" id="6557591">IPv4</span><span class="op" id="6557595">(</span><span class="num" id="6557596">127</span><span class="op" id="6557599">,</span>&nbsp;<span class="num" id="6557601">0</span><span class="op" id="6557602">,</span>&nbsp;<span class="num" id="6557604">0</span><span class="op" id="6557605">,</span>&nbsp;<span class="num" id="6557607">1</span><span class="op" id="6557608">)</span><span class="op" id="6557609">,</span>&nbsp;<span class="ident" id="6557611">Port</span><span class="op" id="6557615">:</span>&nbsp;<span class="num" id="6557617">5</span><span class="op" id="6557618">}</span><span class="op" id="6557619">,</span>&nbsp;<span class="builtintype" id="6557621">nil</span><span class="op" id="6557624">}</span><span class="op" id="6557625">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6557630">{</span><span class="string" id="6557631">&#34;tcp4&#34;</span><span class="op" id="6557637">,</span>&nbsp;<span class="string" id="6557639">&#34;localhost:6&#34;</span><span class="op" id="6557652">,</span>&nbsp;<span class="op" id="6557654">&amp;</span><span class="ident" id="6557655">TCPAddr</span><span class="op" id="6557662">{</span><span class="ident" id="6557663">IP</span><span class="op" id="6557665">:</span>&nbsp;<span class="ident" id="6557667">IPv4</span><span class="op" id="6557671">(</span><span class="num" id="6557672">127</span><span class="op" id="6557675">,</span>&nbsp;<span class="num" id="6557677">0</span><span class="op" id="6557678">,</span>&nbsp;<span class="num" id="6557680">0</span><span class="op" id="6557681">,</span>&nbsp;<span class="num" id="6557683">1</span><span class="op" id="6557684">)</span><span class="op" id="6557685">,</span>&nbsp;<span class="ident" id="6557687">Port</span><span class="op" id="6557691">:</span>&nbsp;<span class="num" id="6557693">6</span><span class="op" id="6557694">}</span><span class="op" id="6557695">,</span>&nbsp;<span class="builtintype" id="6557697">nil</span><span class="op" id="6557700">}</span><span class="op" id="6557701">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6557706">{</span><span class="string" id="6557707">&#34;tcp6&#34;</span><span class="op" id="6557713">,</span>&nbsp;<span class="string" id="6557715">&#34;localhost:7&#34;</span><span class="op" id="6557728">,</span>&nbsp;<span class="op" id="6557730">&amp;</span><span class="ident" id="6557731">TCPAddr</span><span class="op" id="6557738">{</span><span class="ident" id="6557739">IP</span><span class="op" id="6557741">:</span>&nbsp;<span class="ident" id="6557743">IPv6loopback</span><span class="op" id="6557755">,</span>&nbsp;<span class="ident" id="6557757">Port</span><span class="op" id="6557761">:</span>&nbsp;<span class="num" id="6557763">7</span><span class="op" id="6557764">}</span><span class="op" id="6557765">,</span>&nbsp;<span class="builtintype" id="6557767">nil</span><span class="op" id="6557770">}</span><span class="op" id="6557771">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6557775">}</span><span class="op" id="6557776">...</span><span class="op" id="6557779">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6557782">}</span><br>
<span class="lineno"></span><span class="op" id="6557784">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6557787">func</span>&nbsp;<span class="ident" id="6557792">TestResolveTCPAddr</span><span class="op" id="6557810">(</span><span class="ident" id="6557811">t</span>&nbsp;<span class="op" id="6557813">*</span><span class="ident" id="6557814">testing</span><span class="op" id="6557821">.</span><span class="ident" id="6557822">T</span><span class="op" id="6557823">)</span>&nbsp;<span class="op" id="6557825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6557828">for</span>&nbsp;<span class="ident" id="6557832">_</span><span class="op" id="6557833">,</span>&nbsp;<span class="ident" id="6557835">tt</span>&nbsp;<span class="op" id="6557838">:=</span>&nbsp;<span class="keyword" id="6557841">range</span>&nbsp;<span class="ident" id="6557847">resolveTCPAddrTests</span>&nbsp;<span class="op" id="6557867">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6557871">addr</span><span class="op" id="6557875">,</span>&nbsp;<span class="ident" id="6557877">err</span>&nbsp;<span class="op" id="6557881">:=</span>&nbsp;<span class="ident" id="6557884">ResolveTCPAddr</span><span class="op" id="6557898">(</span><span class="ident" id="6557899">tt</span><span class="op" id="6557901">.</span><span class="ident" id="6557902">net</span><span class="op" id="6557905">,</span>&nbsp;<span class="ident" id="6557907">tt</span><span class="op" id="6557909">.</span><span class="ident" id="6557910">litAddrOrName</span><span class="op" id="6557923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6557927">if</span>&nbsp;<span class="ident" id="6557930">err</span>&nbsp;<span class="op" id="6557934">!=</span>&nbsp;<span class="ident" id="6557937">tt</span><span class="op" id="6557939">.</span><span class="ident" id="6557940">err</span>&nbsp;<span class="op" id="6557944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6557949">t</span><span class="op" id="6557950">.</span><span class="ident" id="6557951">Fatalf</span><span class="op" id="6557957">(</span><span class="string" id="6557958">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6557993">,</span>&nbsp;<span class="ident" id="6557995">tt</span><span class="op" id="6557997">.</span><span class="ident" id="6557998">net</span><span class="op" id="6558001">,</span>&nbsp;<span class="ident" id="6558003">tt</span><span class="op" id="6558005">.</span><span class="ident" id="6558006">litAddrOrName</span><span class="op" id="6558019">,</span>&nbsp;<span class="ident" id="6558021">err</span><span class="op" id="6558024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6558028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6558032">if</span>&nbsp;<span class="op" id="6558035">!</span><span class="ident" id="6558036">reflect</span><span class="op" id="6558043">.</span><span class="ident" id="6558044">DeepEqual</span><span class="op" id="6558053">(</span><span class="ident" id="6558054">addr</span><span class="op" id="6558058">,</span>&nbsp;<span class="ident" id="6558060">tt</span><span class="op" id="6558062">.</span><span class="ident" id="6558063">addr</span><span class="op" id="6558067">)</span>&nbsp;<span class="op" id="6558069">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6558074">t</span><span class="op" id="6558075">.</span><span class="ident" id="6558076">Fatalf</span><span class="op" id="6558082">(</span><span class="string" id="6558083">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;=&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="6558123">,</span>&nbsp;<span class="ident" id="6558125">tt</span><span class="op" id="6558127">.</span><span class="ident" id="6558128">net</span><span class="op" id="6558131">,</span>&nbsp;<span class="ident" id="6558133">tt</span><span class="op" id="6558135">.</span><span class="ident" id="6558136">litAddrOrName</span><span class="op" id="6558149">,</span>&nbsp;<span class="ident" id="6558151">addr</span><span class="op" id="6558155">,</span>&nbsp;<span class="ident" id="6558157">tt</span><span class="op" id="6558159">.</span><span class="ident" id="6558160">addr</span><span class="op" id="6558164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6558168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6558172">if</span>&nbsp;<span class="ident" id="6558175">err</span>&nbsp;<span class="op" id="6558179">==</span>&nbsp;<span class="builtintype" id="6558182">nil</span>&nbsp;<span class="op" id="6558186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6558191">str</span>&nbsp;<span class="op" id="6558195">:=</span>&nbsp;<span class="ident" id="6558198">addr</span><span class="op" id="6558202">.</span><span class="ident" id="6558203">String</span><span class="op" id="6558209">(</span><span class="op" id="6558210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6558215">addr1</span><span class="op" id="6558220">,</span>&nbsp;<span class="ident" id="6558222">err</span>&nbsp;<span class="op" id="6558226">:=</span>&nbsp;<span class="ident" id="6558229">ResolveTCPAddr</span><span class="op" id="6558243">(</span><span class="ident" id="6558244">tt</span><span class="op" id="6558246">.</span><span class="ident" id="6558247">net</span><span class="op" id="6558250">,</span>&nbsp;<span class="ident" id="6558252">str</span><span class="op" id="6558255">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6558260">if</span>&nbsp;<span class="ident" id="6558263">err</span>&nbsp;<span class="op" id="6558267">!=</span>&nbsp;<span class="builtintype" id="6558270">nil</span>&nbsp;<span class="op" id="6558274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6558280">t</span><span class="op" id="6558281">.</span><span class="ident" id="6558282">Fatalf</span><span class="op" id="6558288">(</span><span class="string" id="6558289">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;[from&nbsp;%q]:&nbsp;%v&#34;</span><span class="op" id="6558327">,</span>&nbsp;<span class="ident" id="6558329">tt</span><span class="op" id="6558331">.</span><span class="ident" id="6558332">net</span><span class="op" id="6558335">,</span>&nbsp;<span class="ident" id="6558337">str</span><span class="op" id="6558340">,</span>&nbsp;<span class="ident" id="6558342">tt</span><span class="op" id="6558344">.</span><span class="ident" id="6558345">litAddrOrName</span><span class="op" id="6558358">,</span>&nbsp;<span class="ident" id="6558360">err</span><span class="op" id="6558363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6558368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6558373">if</span>&nbsp;<span class="op" id="6558376">!</span><span class="ident" id="6558377">reflect</span><span class="op" id="6558384">.</span><span class="ident" id="6558385">DeepEqual</span><span class="op" id="6558394">(</span><span class="ident" id="6558395">addr1</span><span class="op" id="6558400">,</span>&nbsp;<span class="ident" id="6558402">addr</span><span class="op" id="6558406">)</span>&nbsp;<span class="op" id="6558408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6558414">t</span><span class="op" id="6558415">.</span><span class="ident" id="6558416">Fatalf</span><span class="op" id="6558422">(</span><span class="string" id="6558423">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;[from&nbsp;%q]&nbsp;=&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="6558473">,</span>&nbsp;<span class="ident" id="6558475">tt</span><span class="op" id="6558477">.</span><span class="ident" id="6558478">net</span><span class="op" id="6558481">,</span>&nbsp;<span class="ident" id="6558483">str</span><span class="op" id="6558486">,</span>&nbsp;<span class="ident" id="6558488">tt</span><span class="op" id="6558490">.</span><span class="ident" id="6558491">litAddrOrName</span><span class="op" id="6558504">,</span>&nbsp;<span class="ident" id="6558506">addr1</span><span class="op" id="6558511">,</span>&nbsp;<span class="ident" id="6558513">addr</span><span class="op" id="6558517">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6558522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6558526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6558529">}</span><br>
<span class="lineno"></span><span class="op" id="6558531">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span><span class="keyword" id="6558534">var</span>&nbsp;<span class="ident" id="6558538">tcpListenerNameTests</span>&nbsp;<span class="op" id="6558559">=</span>&nbsp;<span class="op" id="6558561">[</span><span class="op" id="6558562">]</span><span class="keyword" id="6558563">struct</span>&nbsp;<span class="op" id="6558570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6558573">net</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6558579">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6558587">laddr</span>&nbsp;<span class="op" id="6558593">*</span><span class="ident" id="6558594">TCPAddr</span><br>
<span class="lineno"></span><span class="op" id="6558602">}</span><span class="op" id="6558603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6558606">{</span><span class="string" id="6558607">&#34;tcp4&#34;</span><span class="op" id="6558613">,</span>&nbsp;<span class="op" id="6558615">&amp;</span><span class="ident" id="6558616">TCPAddr</span><span class="op" id="6558623">{</span><span class="ident" id="6558624">IP</span><span class="op" id="6558626">:</span>&nbsp;<span class="ident" id="6558628">IPv4</span><span class="op" id="6558632">(</span><span class="num" id="6558633">127</span><span class="op" id="6558636">,</span>&nbsp;<span class="num" id="6558638">0</span><span class="op" id="6558639">,</span>&nbsp;<span class="num" id="6558641">0</span><span class="op" id="6558642">,</span>&nbsp;<span class="num" id="6558644">1</span><span class="op" id="6558645">)</span><span class="op" id="6558646">}</span><span class="op" id="6558647">}</span><span class="op" id="6558648">,</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6558651">{</span><span class="string" id="6558652">&#34;tcp4&#34;</span><span class="op" id="6558658">,</span>&nbsp;<span class="op" id="6558660">&amp;</span><span class="ident" id="6558661">TCPAddr</span><span class="op" id="6558668">{</span><span class="op" id="6558669">}</span><span class="op" id="6558670">}</span><span class="op" id="6558671">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6558674">{</span><span class="string" id="6558675">&#34;tcp4&#34;</span><span class="op" id="6558681">,</span>&nbsp;<span class="builtintype" id="6558683">nil</span><span class="op" id="6558686">}</span><span class="op" id="6558687">,</span><br>
<span class="lineno"></span><span class="op" id="6558689">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6558692">func</span>&nbsp;<span class="ident" id="6558697">TestTCPListenerName</span><span class="op" id="6558716">(</span><span class="ident" id="6558717">t</span>&nbsp;<span class="op" id="6558719">*</span><span class="ident" id="6558720">testing</span><span class="op" id="6558727">.</span><span class="ident" id="6558728">T</span><span class="op" id="6558729">)</span>&nbsp;<span class="op" id="6558731">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6558734">if</span>&nbsp;<span class="ident" id="6558737">testing</span><span class="op" id="6558744">.</span><span class="ident" id="6558745">Short</span><span class="op" id="6558750">(</span><span class="op" id="6558751">)</span>&nbsp;<span class="op" id="6558753">||</span>&nbsp;<span class="op" id="6558756">!</span><span class="op" id="6558757">*</span><span class="ident" id="6558758">testExternal</span>&nbsp;<span class="op" id="6558771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6558775">t</span><span class="op" id="6558776">.</span><span class="ident" id="6558777">Skip</span><span class="op" id="6558781">(</span><span class="string" id="6558782">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="6558823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6558826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6558830">for</span>&nbsp;<span class="ident" id="6558834">_</span><span class="op" id="6558835">,</span>&nbsp;<span class="ident" id="6558837">tt</span>&nbsp;<span class="op" id="6558840">:=</span>&nbsp;<span class="keyword" id="6558843">range</span>&nbsp;<span class="ident" id="6558849">tcpListenerNameTests</span>&nbsp;<span class="op" id="6558870">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6558874">ln</span><span class="op" id="6558876">,</span>&nbsp;<span class="ident" id="6558878">err</span>&nbsp;<span class="op" id="6558882">:=</span>&nbsp;<span class="ident" id="6558885">ListenTCP</span><span class="op" id="6558894">(</span><span class="ident" id="6558895">tt</span><span class="op" id="6558897">.</span><span class="ident" id="6558898">net</span><span class="op" id="6558901">,</span>&nbsp;<span class="ident" id="6558903">tt</span><span class="op" id="6558905">.</span><span class="ident" id="6558906">laddr</span><span class="op" id="6558911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6558915">if</span>&nbsp;<span class="ident" id="6558918">err</span>&nbsp;<span class="op" id="6558922">!=</span>&nbsp;<span class="builtintype" id="6558925">nil</span>&nbsp;<span class="op" id="6558929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6558934">t</span><span class="op" id="6558935">.</span><span class="ident" id="6558936">Fatalf</span><span class="op" id="6558942">(</span><span class="string" id="6558943">&#34;ListenTCP&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6558965">,</span>&nbsp;<span class="ident" id="6558967">err</span><span class="op" id="6558970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6558974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6558978">defer</span>&nbsp;<span class="ident" id="6558984">ln</span><span class="op" id="6558986">.</span><span class="ident" id="6558987">Close</span><span class="op" id="6558992">(</span><span class="op" id="6558993">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6558997">la</span>&nbsp;<span class="op" id="6559000">:=</span>&nbsp;<span class="ident" id="6559003">ln</span><span class="op" id="6559005">.</span><span class="ident" id="6559006">Addr</span><span class="op" id="6559010">(</span><span class="op" id="6559011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6559015">if</span>&nbsp;<span class="ident" id="6559018">a</span><span class="op" id="6559019">,</span>&nbsp;<span class="ident" id="6559021">ok</span>&nbsp;<span class="op" id="6559024">:=</span>&nbsp;<span class="ident" id="6559027">la</span><span class="op" id="6559029">.</span><span class="op" id="6559030">(</span><span class="op" id="6559031">*</span><span class="ident" id="6559032">TCPAddr</span><span class="op" id="6559039">)</span><span class="op" id="6559040">;</span>&nbsp;<span class="op" id="6559042">!</span><span class="ident" id="6559043">ok</span>&nbsp;<span class="op" id="6559046">||</span>&nbsp;<span class="ident" id="6559049">a</span><span class="op" id="6559050">.</span><span class="ident" id="6559051">Port</span>&nbsp;<span class="op" id="6559056">==</span>&nbsp;<span class="num" id="6559059">0</span>&nbsp;<span class="op" id="6559061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6559066">t</span><span class="op" id="6559067">.</span><span class="ident" id="6559068">Fatalf</span><span class="op" id="6559074">(</span><span class="string" id="6559075">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;non-zero&nbsp;port&nbsp;number&#34;</span><span class="op" id="6559136">,</span>&nbsp;<span class="ident" id="6559138">la</span><span class="op" id="6559140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6559144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6559147">}</span><br>
<span class="lineno">375</span><span class="op" id="6559149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6559152">func</span>&nbsp;<span class="ident" id="6559157">TestIPv6LinkLocalUnicastTCP</span><span class="op" id="6559184">(</span><span class="ident" id="6559185">t</span>&nbsp;<span class="op" id="6559187">*</span><span class="ident" id="6559188">testing</span><span class="op" id="6559195">.</span><span class="ident" id="6559196">T</span><span class="op" id="6559197">)</span>&nbsp;<span class="op" id="6559199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6559202">if</span>&nbsp;<span class="ident" id="6559205">testing</span><span class="op" id="6559212">.</span><span class="ident" id="6559213">Short</span><span class="op" id="6559218">(</span><span class="op" id="6559219">)</span>&nbsp;<span class="op" id="6559221">||</span>&nbsp;<span class="op" id="6559224">!</span><span class="op" id="6559225">*</span><span class="ident" id="6559226">testExternal</span>&nbsp;<span class="op" id="6559239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6559243">t</span><span class="op" id="6559244">.</span><span class="ident" id="6559245">Skip</span><span class="op" id="6559249">(</span><span class="string" id="6559250">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="6559291">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6559294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6559297">if</span>&nbsp;<span class="op" id="6559300">!</span><span class="ident" id="6559301">supportsIPv6</span>&nbsp;<span class="op" id="6559314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6559318">t</span><span class="op" id="6559319">.</span><span class="ident" id="6559320">Skip</span><span class="op" id="6559324">(</span><span class="string" id="6559325">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="6559348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6559351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6559354">ifi</span>&nbsp;<span class="op" id="6559358">:=</span>&nbsp;<span class="ident" id="6559361">loopbackInterface</span><span class="op" id="6559378">(</span><span class="op" id="6559379">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6559382">if</span>&nbsp;<span class="ident" id="6559385">ifi</span>&nbsp;<span class="op" id="6559389">==</span>&nbsp;<span class="builtintype" id="6559392">nil</span>&nbsp;<span class="op" id="6559396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6559400">t</span><span class="op" id="6559401">.</span><span class="ident" id="6559402">Skip</span><span class="op" id="6559406">(</span><span class="string" id="6559407">&#34;loopback&nbsp;interface&nbsp;not&nbsp;found&#34;</span><span class="op" id="6559437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6559440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6559443">laddr</span>&nbsp;<span class="op" id="6559449">:=</span>&nbsp;<span class="ident" id="6559452">ipv6LinkLocalUnicastAddr</span><span class="op" id="6559476">(</span><span class="ident" id="6559477">ifi</span><span class="op" id="6559480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6559483">if</span>&nbsp;<span class="ident" id="6559486">laddr</span>&nbsp;<span class="op" id="6559492">==</span>&nbsp;<span class="string" id="6559495">&#34;&#34;</span>&nbsp;<span class="op" id="6559498">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6559502">t</span><span class="op" id="6559503">.</span><span class="ident" id="6559504">Skip</span><span class="op" id="6559508">(</span><span class="string" id="6559509">&#34;ipv6&nbsp;unicast&nbsp;address&nbsp;on&nbsp;loopback&nbsp;not&nbsp;found&#34;</span><span class="op" id="6559553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6559556">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6559560">type</span>&nbsp;<span class="ident" id="6559565">test</span>&nbsp;<span class="keyword" id="6559570">struct</span>&nbsp;<span class="op" id="6559577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6559581">net</span><span class="op" id="6559584">,</span>&nbsp;<span class="ident" id="6559586">addr</span>&nbsp;&nbsp;<span class="builtintype" id="6559592">string</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6559601">nameLookup</span>&nbsp;<span class="builtintype" id="6559612">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6559618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6559621">var</span>&nbsp;<span class="ident" id="6559625">tests</span>&nbsp;<span class="op" id="6559631">=</span>&nbsp;<span class="op" id="6559633">[</span><span class="op" id="6559634">]</span><span class="ident" id="6559635">test</span><span class="op" id="6559639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6559643">{</span><span class="string" id="6559644">&#34;tcp&#34;</span><span class="op" id="6559649">,</span>&nbsp;<span class="string" id="6559651">&#34;[&#34;</span>&nbsp;<span class="op" id="6559655">+</span>&nbsp;<span class="ident" id="6559657">laddr</span>&nbsp;<span class="op" id="6559663">+</span>&nbsp;<span class="string" id="6559665">&#34;%&#34;</span>&nbsp;<span class="op" id="6559669">+</span>&nbsp;<span class="ident" id="6559671">ifi</span><span class="op" id="6559674">.</span><span class="ident" id="6559675">Name</span>&nbsp;<span class="op" id="6559680">+</span>&nbsp;<span class="string" id="6559682">&#34;]:0&#34;</span><span class="op" id="6559687">,</span>&nbsp;<span class="builtintype" id="6559689">false</span><span class="op" id="6559694">}</span><span class="op" id="6559695">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6559699">{</span><span class="string" id="6559700">&#34;tcp6&#34;</span><span class="op" id="6559706">,</span>&nbsp;<span class="string" id="6559708">&#34;[&#34;</span>&nbsp;<span class="op" id="6559712">+</span>&nbsp;<span class="ident" id="6559714">laddr</span>&nbsp;<span class="op" id="6559720">+</span>&nbsp;<span class="string" id="6559722">&#34;%&#34;</span>&nbsp;<span class="op" id="6559726">+</span>&nbsp;<span class="ident" id="6559728">ifi</span><span class="op" id="6559731">.</span><span class="ident" id="6559732">Name</span>&nbsp;<span class="op" id="6559737">+</span>&nbsp;<span class="string" id="6559739">&#34;]:0&#34;</span><span class="op" id="6559744">,</span>&nbsp;<span class="builtintype" id="6559746">false</span><span class="op" id="6559751">}</span><span class="op" id="6559752">,</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6559755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6559758">switch</span>&nbsp;<span class="ident" id="6559765">runtime</span><span class="op" id="6559772">.</span><span class="ident" id="6559773">GOOS</span>&nbsp;<span class="op" id="6559778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6559781">case</span>&nbsp;<span class="string" id="6559786">&#34;darwin&#34;</span><span class="op" id="6559794">,</span>&nbsp;<span class="string" id="6559796">&#34;freebsd&#34;</span><span class="op" id="6559805">,</span>&nbsp;<span class="string" id="6559807">&#34;openbsd&#34;</span><span class="op" id="6559816">,</span>&nbsp;<span class="string" id="6559818">&#34;netbsd&#34;</span><span class="op" id="6559826">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6559830">tests</span>&nbsp;<span class="op" id="6559836">=</span>&nbsp;<span class="builtinfunc" id="6559838">append</span><span class="op" id="6559844">(</span><span class="ident" id="6559845">tests</span><span class="op" id="6559850">,</span>&nbsp;<span class="op" id="6559852">[</span><span class="op" id="6559853">]</span><span class="ident" id="6559854">test</span><span class="op" id="6559858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6559863">{</span><span class="string" id="6559864">&#34;tcp&#34;</span><span class="op" id="6559869">,</span>&nbsp;<span class="string" id="6559871">&#34;[localhost%&#34;</span>&nbsp;<span class="op" id="6559885">+</span>&nbsp;<span class="ident" id="6559887">ifi</span><span class="op" id="6559890">.</span><span class="ident" id="6559891">Name</span>&nbsp;<span class="op" id="6559896">+</span>&nbsp;<span class="string" id="6559898">&#34;]:0&#34;</span><span class="op" id="6559903">,</span>&nbsp;<span class="builtintype" id="6559905">true</span><span class="op" id="6559909">}</span><span class="op" id="6559910">,</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6559915">{</span><span class="string" id="6559916">&#34;tcp6&#34;</span><span class="op" id="6559922">,</span>&nbsp;<span class="string" id="6559924">&#34;[localhost%&#34;</span>&nbsp;<span class="op" id="6559938">+</span>&nbsp;<span class="ident" id="6559940">ifi</span><span class="op" id="6559943">.</span><span class="ident" id="6559944">Name</span>&nbsp;<span class="op" id="6559949">+</span>&nbsp;<span class="string" id="6559951">&#34;]:0&#34;</span><span class="op" id="6559956">,</span>&nbsp;<span class="builtintype" id="6559958">true</span><span class="op" id="6559962">}</span><span class="op" id="6559963">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6559967">}</span><span class="op" id="6559968">...</span><span class="op" id="6559971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6559974">case</span>&nbsp;<span class="string" id="6559979">&#34;linux&#34;</span><span class="op" id="6559986">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6559990">tests</span>&nbsp;<span class="op" id="6559996">=</span>&nbsp;<span class="builtinfunc" id="6559998">append</span><span class="op" id="6560004">(</span><span class="ident" id="6560005">tests</span><span class="op" id="6560010">,</span>&nbsp;<span class="op" id="6560012">[</span><span class="op" id="6560013">]</span><span class="ident" id="6560014">test</span><span class="op" id="6560018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6560023">{</span><span class="string" id="6560024">&#34;tcp&#34;</span><span class="op" id="6560029">,</span>&nbsp;<span class="string" id="6560031">&#34;[ip6-localhost%&#34;</span>&nbsp;<span class="op" id="6560049">+</span>&nbsp;<span class="ident" id="6560051">ifi</span><span class="op" id="6560054">.</span><span class="ident" id="6560055">Name</span>&nbsp;<span class="op" id="6560060">+</span>&nbsp;<span class="string" id="6560062">&#34;]:0&#34;</span><span class="op" id="6560067">,</span>&nbsp;<span class="builtintype" id="6560069">true</span><span class="op" id="6560073">}</span><span class="op" id="6560074">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6560079">{</span><span class="string" id="6560080">&#34;tcp6&#34;</span><span class="op" id="6560086">,</span>&nbsp;<span class="string" id="6560088">&#34;[ip6-localhost%&#34;</span>&nbsp;<span class="op" id="6560106">+</span>&nbsp;<span class="ident" id="6560108">ifi</span><span class="op" id="6560111">.</span><span class="ident" id="6560112">Name</span>&nbsp;<span class="op" id="6560117">+</span>&nbsp;<span class="string" id="6560119">&#34;]:0&#34;</span><span class="op" id="6560124">,</span>&nbsp;<span class="builtintype" id="6560126">true</span><span class="op" id="6560130">}</span><span class="op" id="6560131">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6560135">}</span><span class="op" id="6560136">...</span><span class="op" id="6560139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6560142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6560145">for</span>&nbsp;<span class="ident" id="6560149">_</span><span class="op" id="6560150">,</span>&nbsp;<span class="ident" id="6560152">tt</span>&nbsp;<span class="op" id="6560155">:=</span>&nbsp;<span class="keyword" id="6560158">range</span>&nbsp;<span class="ident" id="6560164">tests</span>&nbsp;<span class="op" id="6560170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6560174">ln</span><span class="op" id="6560176">,</span>&nbsp;<span class="ident" id="6560178">err</span>&nbsp;<span class="op" id="6560182">:=</span>&nbsp;<span class="ident" id="6560185">Listen</span><span class="op" id="6560191">(</span><span class="ident" id="6560192">tt</span><span class="op" id="6560194">.</span><span class="ident" id="6560195">net</span><span class="op" id="6560198">,</span>&nbsp;<span class="ident" id="6560200">tt</span><span class="op" id="6560202">.</span><span class="ident" id="6560203">addr</span><span class="op" id="6560207">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6560211">if</span>&nbsp;<span class="ident" id="6560214">err</span>&nbsp;<span class="op" id="6560218">!=</span>&nbsp;<span class="builtintype" id="6560221">nil</span>&nbsp;<span class="op" id="6560225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6560230">//&nbsp;It&nbsp;might&nbsp;return&nbsp;&#34;LookupHost&nbsp;returned&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6560276">//&nbsp;suitable&nbsp;address&#34;&nbsp;error&nbsp;on&nbsp;some&nbsp;platforms.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6560325">t</span><span class="op" id="6560326">.</span><span class="ident" id="6560327">Logf</span><span class="op" id="6560331">(</span><span class="string" id="6560332">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6560351">,</span>&nbsp;<span class="ident" id="6560353">err</span><span class="op" id="6560356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6560361">continue</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6560372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6560376">defer</span>&nbsp;<span class="ident" id="6560382">ln</span><span class="op" id="6560384">.</span><span class="ident" id="6560385">Close</span><span class="op" id="6560390">(</span><span class="op" id="6560391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6560395">if</span>&nbsp;<span class="ident" id="6560398">la</span><span class="op" id="6560400">,</span>&nbsp;<span class="ident" id="6560402">ok</span>&nbsp;<span class="op" id="6560405">:=</span>&nbsp;<span class="ident" id="6560408">ln</span><span class="op" id="6560410">.</span><span class="ident" id="6560411">Addr</span><span class="op" id="6560415">(</span><span class="op" id="6560416">)</span><span class="op" id="6560417">.</span><span class="op" id="6560418">(</span><span class="op" id="6560419">*</span><span class="ident" id="6560420">TCPAddr</span><span class="op" id="6560427">)</span><span class="op" id="6560428">;</span>&nbsp;<span class="op" id="6560430">!</span><span class="ident" id="6560431">ok</span>&nbsp;<span class="op" id="6560434">||</span>&nbsp;<span class="op" id="6560437">!</span><span class="ident" id="6560438">tt</span><span class="op" id="6560440">.</span><span class="ident" id="6560441">nameLookup</span>&nbsp;<span class="op" id="6560452">&amp;&amp;</span>&nbsp;<span class="ident" id="6560455">la</span><span class="op" id="6560457">.</span><span class="ident" id="6560458">Zone</span>&nbsp;<span class="op" id="6560463">==</span>&nbsp;<span class="string" id="6560466">&#34;&#34;</span>&nbsp;<span class="op" id="6560469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6560474">t</span><span class="op" id="6560475">.</span><span class="ident" id="6560476">Fatalf</span><span class="op" id="6560482">(</span><span class="string" id="6560483">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="6560539">,</span>&nbsp;<span class="ident" id="6560541">la</span><span class="op" id="6560543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6560547">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6560552">done</span>&nbsp;<span class="op" id="6560557">:=</span>&nbsp;<span class="builtinfunc" id="6560560">make</span><span class="op" id="6560564">(</span><span class="keyword" id="6560565">chan</span>&nbsp;<span class="builtintype" id="6560570">int</span><span class="op" id="6560573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6560577">go</span>&nbsp;<span class="ident" id="6560580">transponder</span><span class="op" id="6560591">(</span><span class="ident" id="6560592">t</span><span class="op" id="6560593">,</span>&nbsp;<span class="ident" id="6560595">ln</span><span class="op" id="6560597">,</span>&nbsp;<span class="ident" id="6560599">done</span><span class="op" id="6560603">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6560608">c</span><span class="op" id="6560609">,</span>&nbsp;<span class="ident" id="6560611">err</span>&nbsp;<span class="op" id="6560615">:=</span>&nbsp;<span class="ident" id="6560618">Dial</span><span class="op" id="6560622">(</span><span class="ident" id="6560623">tt</span><span class="op" id="6560625">.</span><span class="ident" id="6560626">net</span><span class="op" id="6560629">,</span>&nbsp;<span class="ident" id="6560631">ln</span><span class="op" id="6560633">.</span><span class="ident" id="6560634">Addr</span><span class="op" id="6560638">(</span><span class="op" id="6560639">)</span><span class="op" id="6560640">.</span><span class="ident" id="6560641">String</span><span class="op" id="6560647">(</span><span class="op" id="6560648">)</span><span class="op" id="6560649">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6560653">if</span>&nbsp;<span class="ident" id="6560656">err</span>&nbsp;<span class="op" id="6560660">!=</span>&nbsp;<span class="builtintype" id="6560663">nil</span>&nbsp;<span class="op" id="6560667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6560672">t</span><span class="op" id="6560673">.</span><span class="ident" id="6560674">Fatalf</span><span class="op" id="6560680">(</span><span class="string" id="6560681">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6560698">,</span>&nbsp;<span class="ident" id="6560700">err</span><span class="op" id="6560703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6560707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6560711">defer</span>&nbsp;<span class="ident" id="6560717">c</span><span class="op" id="6560718">.</span><span class="ident" id="6560719">Close</span><span class="op" id="6560724">(</span><span class="op" id="6560725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6560729">if</span>&nbsp;<span class="ident" id="6560732">la</span><span class="op" id="6560734">,</span>&nbsp;<span class="ident" id="6560736">ok</span>&nbsp;<span class="op" id="6560739">:=</span>&nbsp;<span class="ident" id="6560742">c</span><span class="op" id="6560743">.</span><span class="ident" id="6560744">LocalAddr</span><span class="op" id="6560753">(</span><span class="op" id="6560754">)</span><span class="op" id="6560755">.</span><span class="op" id="6560756">(</span><span class="op" id="6560757">*</span><span class="ident" id="6560758">TCPAddr</span><span class="op" id="6560765">)</span><span class="op" id="6560766">;</span>&nbsp;<span class="op" id="6560768">!</span><span class="ident" id="6560769">ok</span>&nbsp;<span class="op" id="6560772">||</span>&nbsp;<span class="op" id="6560775">!</span><span class="ident" id="6560776">tt</span><span class="op" id="6560778">.</span><span class="ident" id="6560779">nameLookup</span>&nbsp;<span class="op" id="6560790">&amp;&amp;</span>&nbsp;<span class="ident" id="6560793">la</span><span class="op" id="6560795">.</span><span class="ident" id="6560796">Zone</span>&nbsp;<span class="op" id="6560801">==</span>&nbsp;<span class="string" id="6560804">&#34;&#34;</span>&nbsp;<span class="op" id="6560807">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6560812">t</span><span class="op" id="6560813">.</span><span class="ident" id="6560814">Fatalf</span><span class="op" id="6560820">(</span><span class="string" id="6560821">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="6560877">,</span>&nbsp;<span class="ident" id="6560879">la</span><span class="op" id="6560881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6560885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6560889">if</span>&nbsp;<span class="ident" id="6560892">ra</span><span class="op" id="6560894">,</span>&nbsp;<span class="ident" id="6560896">ok</span>&nbsp;<span class="op" id="6560899">:=</span>&nbsp;<span class="ident" id="6560902">c</span><span class="op" id="6560903">.</span><span class="ident" id="6560904">RemoteAddr</span><span class="op" id="6560914">(</span><span class="op" id="6560915">)</span><span class="op" id="6560916">.</span><span class="op" id="6560917">(</span><span class="op" id="6560918">*</span><span class="ident" id="6560919">TCPAddr</span><span class="op" id="6560926">)</span><span class="op" id="6560927">;</span>&nbsp;<span class="op" id="6560929">!</span><span class="ident" id="6560930">ok</span>&nbsp;<span class="op" id="6560933">||</span>&nbsp;<span class="op" id="6560936">!</span><span class="ident" id="6560937">tt</span><span class="op" id="6560939">.</span><span class="ident" id="6560940">nameLookup</span>&nbsp;<span class="op" id="6560951">&amp;&amp;</span>&nbsp;<span class="ident" id="6560954">ra</span><span class="op" id="6560956">.</span><span class="ident" id="6560957">Zone</span>&nbsp;<span class="op" id="6560962">==</span>&nbsp;<span class="string" id="6560965">&#34;&#34;</span>&nbsp;<span class="op" id="6560968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6560973">t</span><span class="op" id="6560974">.</span><span class="ident" id="6560975">Fatalf</span><span class="op" id="6560981">(</span><span class="string" id="6560982">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="6561038">,</span>&nbsp;<span class="ident" id="6561040">ra</span><span class="op" id="6561042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6561046">}</span><br>
<span class="lineno">440</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6561051">if</span>&nbsp;<span class="ident" id="6561054">_</span><span class="op" id="6561055">,</span>&nbsp;<span class="ident" id="6561057">err</span>&nbsp;<span class="op" id="6561061">:=</span>&nbsp;<span class="ident" id="6561064">c</span><span class="op" id="6561065">.</span><span class="ident" id="6561066">Write</span><span class="op" id="6561071">(</span><span class="op" id="6561072">[</span><span class="op" id="6561073">]</span><span class="builtintype" id="6561074">byte</span><span class="op" id="6561078">(</span><span class="string" id="6561079">&#34;TCP&nbsp;OVER&nbsp;IPV6&nbsp;LINKLOCAL&nbsp;TEST&#34;</span><span class="op" id="6561109">)</span><span class="op" id="6561110">)</span><span class="op" id="6561111">;</span>&nbsp;<span class="ident" id="6561113">err</span>&nbsp;<span class="op" id="6561117">!=</span>&nbsp;<span class="builtintype" id="6561120">nil</span>&nbsp;<span class="op" id="6561124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6561129">t</span><span class="op" id="6561130">.</span><span class="ident" id="6561131">Fatalf</span><span class="op" id="6561137">(</span><span class="string" id="6561138">&#34;Conn.Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6561161">,</span>&nbsp;<span class="ident" id="6561163">err</span><span class="op" id="6561166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6561170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6561174">b</span>&nbsp;<span class="op" id="6561176">:=</span>&nbsp;<span class="builtinfunc" id="6561179">make</span><span class="op" id="6561183">(</span><span class="op" id="6561184">[</span><span class="op" id="6561185">]</span><span class="builtintype" id="6561186">byte</span><span class="op" id="6561190">,</span>&nbsp;<span class="num" id="6561192">32</span><span class="op" id="6561194">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6561198">if</span>&nbsp;<span class="ident" id="6561201">_</span><span class="op" id="6561202">,</span>&nbsp;<span class="ident" id="6561204">err</span>&nbsp;<span class="op" id="6561208">:=</span>&nbsp;<span class="ident" id="6561211">c</span><span class="op" id="6561212">.</span><span class="ident" id="6561213">Read</span><span class="op" id="6561217">(</span><span class="ident" id="6561218">b</span><span class="op" id="6561219">)</span><span class="op" id="6561220">;</span>&nbsp;<span class="ident" id="6561222">err</span>&nbsp;<span class="op" id="6561226">!=</span>&nbsp;<span class="builtintype" id="6561229">nil</span>&nbsp;<span class="op" id="6561233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6561238">t</span><span class="op" id="6561239">.</span><span class="ident" id="6561240">Fatalf</span><span class="op" id="6561246">(</span><span class="string" id="6561247">&#34;Conn.Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6561269">,</span>&nbsp;<span class="ident" id="6561271">err</span><span class="op" id="6561274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6561278">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6561283">&lt;-</span><span class="ident" id="6561285">done</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6561291">}</span><br>
<span class="lineno"></span><span class="op" id="6561293">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6561296">func</span>&nbsp;<span class="ident" id="6561301">TestTCPConcurrentAccept</span><span class="op" id="6561324">(</span><span class="ident" id="6561325">t</span>&nbsp;<span class="op" id="6561327">*</span><span class="ident" id="6561328">testing</span><span class="op" id="6561335">.</span><span class="ident" id="6561336">T</span><span class="op" id="6561337">)</span>&nbsp;<span class="op" id="6561339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6561342">defer</span>&nbsp;<span class="ident" id="6561348">runtime</span><span class="op" id="6561355">.</span><span class="ident" id="6561356">GOMAXPROCS</span><span class="op" id="6561366">(</span><span class="ident" id="6561367">runtime</span><span class="op" id="6561374">.</span><span class="ident" id="6561375">GOMAXPROCS</span><span class="op" id="6561385">(</span><span class="num" id="6561386">4</span><span class="op" id="6561387">)</span><span class="op" id="6561388">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6561391">ln</span><span class="op" id="6561393">,</span>&nbsp;<span class="ident" id="6561395">err</span>&nbsp;<span class="op" id="6561399">:=</span>&nbsp;<span class="ident" id="6561402">Listen</span><span class="op" id="6561408">(</span><span class="string" id="6561409">&#34;tcp&#34;</span><span class="op" id="6561414">,</span>&nbsp;<span class="string" id="6561416">&#34;127.0.0.1:0&#34;</span><span class="op" id="6561429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6561432">if</span>&nbsp;<span class="ident" id="6561435">err</span>&nbsp;<span class="op" id="6561439">!=</span>&nbsp;<span class="builtintype" id="6561442">nil</span>&nbsp;<span class="op" id="6561446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6561450">t</span><span class="op" id="6561451">.</span><span class="ident" id="6561452">Fatalf</span><span class="op" id="6561458">(</span><span class="string" id="6561459">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6561478">,</span>&nbsp;<span class="ident" id="6561480">err</span><span class="op" id="6561483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6561486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6561489">const</span>&nbsp;<span class="ident" id="6561495">N</span>&nbsp;<span class="op" id="6561497">=</span>&nbsp;<span class="num" id="6561499">10</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6561503">var</span>&nbsp;<span class="ident" id="6561507">wg</span>&nbsp;<span class="ident" id="6561510">sync</span><span class="op" id="6561514">.</span><span class="ident" id="6561515">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6561526">wg</span><span class="op" id="6561528">.</span><span class="ident" id="6561529">Add</span><span class="op" id="6561532">(</span><span class="ident" id="6561533">N</span><span class="op" id="6561534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6561537">for</span>&nbsp;<span class="ident" id="6561541">i</span>&nbsp;<span class="op" id="6561543">:=</span>&nbsp;<span class="num" id="6561546">0</span><span class="op" id="6561547">;</span>&nbsp;<span class="ident" id="6561549">i</span>&nbsp;<span class="op" id="6561551">&lt;</span>&nbsp;<span class="ident" id="6561553">N</span><span class="op" id="6561554">;</span>&nbsp;<span class="ident" id="6561556">i</span><span class="op" id="6561557">++</span>&nbsp;<span class="op" id="6561560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6561564">go</span>&nbsp;<span class="keyword" id="6561567">func</span><span class="op" id="6561571">(</span><span class="op" id="6561572">)</span>&nbsp;<span class="op" id="6561574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6561579">for</span>&nbsp;<span class="op" id="6561583">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6561589">c</span><span class="op" id="6561590">,</span>&nbsp;<span class="ident" id="6561592">err</span>&nbsp;<span class="op" id="6561596">:=</span>&nbsp;<span class="ident" id="6561599">ln</span><span class="op" id="6561601">.</span><span class="ident" id="6561602">Accept</span><span class="op" id="6561608">(</span><span class="op" id="6561609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6561615">if</span>&nbsp;<span class="ident" id="6561618">err</span>&nbsp;<span class="op" id="6561622">!=</span>&nbsp;<span class="builtintype" id="6561625">nil</span>&nbsp;<span class="op" id="6561629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6561636">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6561646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6561652">c</span><span class="op" id="6561653">.</span><span class="ident" id="6561654">Close</span><span class="op" id="6561659">(</span><span class="op" id="6561660">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6561665">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6561670">wg</span><span class="op" id="6561672">.</span><span class="ident" id="6561673">Done</span><span class="op" id="6561677">(</span><span class="op" id="6561678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6561682">}</span><span class="op" id="6561683">(</span><span class="op" id="6561684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6561687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6561690">attempts</span>&nbsp;<span class="op" id="6561699">:=</span>&nbsp;<span class="num" id="6561702">10</span>&nbsp;<span class="op" id="6561705">*</span>&nbsp;<span class="ident" id="6561707">N</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6561710">fails</span>&nbsp;<span class="op" id="6561716">:=</span>&nbsp;<span class="num" id="6561719">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6561722">d</span>&nbsp;<span class="op" id="6561724">:=</span>&nbsp;<span class="op" id="6561727">&amp;</span><span class="ident" id="6561728">Dialer</span><span class="op" id="6561734">{</span><span class="ident" id="6561735">Timeout</span><span class="op" id="6561742">:</span>&nbsp;<span class="num" id="6561744">200</span>&nbsp;<span class="op" id="6561748">*</span>&nbsp;<span class="ident" id="6561750">time</span><span class="op" id="6561754">.</span><span class="ident" id="6561755">Millisecond</span><span class="op" id="6561766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6561769">for</span>&nbsp;<span class="ident" id="6561773">i</span>&nbsp;<span class="op" id="6561775">:=</span>&nbsp;<span class="num" id="6561778">0</span><span class="op" id="6561779">;</span>&nbsp;<span class="ident" id="6561781">i</span>&nbsp;<span class="op" id="6561783">&lt;</span>&nbsp;<span class="ident" id="6561785">attempts</span><span class="op" id="6561793">;</span>&nbsp;<span class="ident" id="6561795">i</span><span class="op" id="6561796">++</span>&nbsp;<span class="op" id="6561799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6561803">c</span><span class="op" id="6561804">,</span>&nbsp;<span class="ident" id="6561806">err</span>&nbsp;<span class="op" id="6561810">:=</span>&nbsp;<span class="ident" id="6561813">d</span><span class="op" id="6561814">.</span><span class="ident" id="6561815">Dial</span><span class="op" id="6561819">(</span><span class="string" id="6561820">&#34;tcp&#34;</span><span class="op" id="6561825">,</span>&nbsp;<span class="ident" id="6561827">ln</span><span class="op" id="6561829">.</span><span class="ident" id="6561830">Addr</span><span class="op" id="6561834">(</span><span class="op" id="6561835">)</span><span class="op" id="6561836">.</span><span class="ident" id="6561837">String</span><span class="op" id="6561843">(</span><span class="op" id="6561844">)</span><span class="op" id="6561845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6561849">if</span>&nbsp;<span class="ident" id="6561852">err</span>&nbsp;<span class="op" id="6561856">!=</span>&nbsp;<span class="builtintype" id="6561859">nil</span>&nbsp;<span class="op" id="6561863">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6561868">fails</span><span class="op" id="6561873">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6561878">}</span>&nbsp;<span class="keyword" id="6561880">else</span>&nbsp;<span class="op" id="6561885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6561890">c</span><span class="op" id="6561891">.</span><span class="ident" id="6561892">Close</span><span class="op" id="6561897">(</span><span class="op" id="6561898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6561902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6561905">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6561908">ln</span><span class="op" id="6561910">.</span><span class="ident" id="6561911">Close</span><span class="op" id="6561916">(</span><span class="op" id="6561917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6561920">wg</span><span class="op" id="6561922">.</span><span class="ident" id="6561923">Wait</span><span class="op" id="6561927">(</span><span class="op" id="6561928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6561931">if</span>&nbsp;<span class="ident" id="6561934">fails</span>&nbsp;<span class="op" id="6561940">&gt;</span>&nbsp;<span class="ident" id="6561942">attempts</span><span class="op" id="6561950">/</span><span class="num" id="6561951">9</span>&nbsp;<span class="op" id="6561953">{</span>&nbsp;<span class="comment" id="6561955">//&nbsp;see&nbsp;issues&nbsp;7400&nbsp;and&nbsp;7541</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6561985">t</span><span class="op" id="6561986">.</span><span class="ident" id="6561987">Fatalf</span><span class="op" id="6561993">(</span><span class="string" id="6561994">&#34;too&nbsp;many&nbsp;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6562020">,</span>&nbsp;<span class="ident" id="6562022">fails</span><span class="op" id="6562027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6562030">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6562033">if</span>&nbsp;<span class="ident" id="6562036">fails</span>&nbsp;<span class="op" id="6562042">&gt;</span>&nbsp;<span class="num" id="6562044">0</span>&nbsp;<span class="op" id="6562046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6562050">t</span><span class="op" id="6562051">.</span><span class="ident" id="6562052">Logf</span><span class="op" id="6562056">(</span><span class="string" id="6562057">&#34;#&nbsp;of&nbsp;failed&nbsp;Dials:&nbsp;%v&#34;</span><span class="op" id="6562080">,</span>&nbsp;<span class="ident" id="6562082">fails</span><span class="op" id="6562087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6562090">}</span><br>
<span class="lineno"></span><span class="op" id="6562092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="keyword" id="6562095">func</span>&nbsp;<span class="ident" id="6562100">TestTCPReadWriteMallocs</span><span class="op" id="6562123">(</span><span class="ident" id="6562124">t</span>&nbsp;<span class="op" id="6562126">*</span><span class="ident" id="6562127">testing</span><span class="op" id="6562134">.</span><span class="ident" id="6562135">T</span><span class="op" id="6562136">)</span>&nbsp;<span class="op" id="6562138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6562141">if</span>&nbsp;<span class="ident" id="6562144">testing</span><span class="op" id="6562151">.</span><span class="ident" id="6562152">Short</span><span class="op" id="6562157">(</span><span class="op" id="6562158">)</span>&nbsp;<span class="op" id="6562160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6562164">t</span><span class="op" id="6562165">.</span><span class="ident" id="6562166">Skip</span><span class="op" id="6562170">(</span><span class="string" id="6562171">&#34;skipping&nbsp;malloc&nbsp;count&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="6562208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6562211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6562214">ln</span><span class="op" id="6562216">,</span>&nbsp;<span class="ident" id="6562218">err</span>&nbsp;<span class="op" id="6562222">:=</span>&nbsp;<span class="ident" id="6562225">Listen</span><span class="op" id="6562231">(</span><span class="string" id="6562232">&#34;tcp&#34;</span><span class="op" id="6562237">,</span>&nbsp;<span class="string" id="6562239">&#34;127.0.0.1:0&#34;</span><span class="op" id="6562252">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6562255">if</span>&nbsp;<span class="ident" id="6562258">err</span>&nbsp;<span class="op" id="6562262">!=</span>&nbsp;<span class="builtintype" id="6562265">nil</span>&nbsp;<span class="op" id="6562269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6562273">t</span><span class="op" id="6562274">.</span><span class="ident" id="6562275">Fatalf</span><span class="op" id="6562281">(</span><span class="string" id="6562282">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6562301">,</span>&nbsp;<span class="ident" id="6562303">err</span><span class="op" id="6562306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6562309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6562312">defer</span>&nbsp;<span class="ident" id="6562318">ln</span><span class="op" id="6562320">.</span><span class="ident" id="6562321">Close</span><span class="op" id="6562326">(</span><span class="op" id="6562327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6562330">var</span>&nbsp;<span class="ident" id="6562334">server</span>&nbsp;<span class="ident" id="6562341">Conn</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6562347">errc</span>&nbsp;<span class="op" id="6562352">:=</span>&nbsp;<span class="builtinfunc" id="6562355">make</span><span class="op" id="6562359">(</span><span class="keyword" id="6562360">chan</span>&nbsp;<span class="builtintype" id="6562365">error</span><span class="op" id="6562370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6562373">go</span>&nbsp;<span class="keyword" id="6562376">func</span><span class="op" id="6562380">(</span><span class="op" id="6562381">)</span>&nbsp;<span class="op" id="6562383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6562387">var</span>&nbsp;<span class="ident" id="6562391">err</span>&nbsp;<span class="builtintype" id="6562395">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6562403">server</span><span class="op" id="6562409">,</span>&nbsp;<span class="ident" id="6562411">err</span>&nbsp;<span class="op" id="6562415">=</span>&nbsp;<span class="ident" id="6562417">ln</span><span class="op" id="6562419">.</span><span class="ident" id="6562420">Accept</span><span class="op" id="6562426">(</span><span class="op" id="6562427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6562431">errc</span>&nbsp;<span class="op" id="6562436">&lt;-</span>&nbsp;<span class="ident" id="6562439">err</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6562444">}</span><span class="op" id="6562445">(</span><span class="op" id="6562446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6562449">client</span><span class="op" id="6562455">,</span>&nbsp;<span class="ident" id="6562457">err</span>&nbsp;<span class="op" id="6562461">:=</span>&nbsp;<span class="ident" id="6562464">Dial</span><span class="op" id="6562468">(</span><span class="string" id="6562469">&#34;tcp&#34;</span><span class="op" id="6562474">,</span>&nbsp;<span class="ident" id="6562476">ln</span><span class="op" id="6562478">.</span><span class="ident" id="6562479">Addr</span><span class="op" id="6562483">(</span><span class="op" id="6562484">)</span><span class="op" id="6562485">.</span><span class="ident" id="6562486">String</span><span class="op" id="6562492">(</span><span class="op" id="6562493">)</span><span class="op" id="6562494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6562497">if</span>&nbsp;<span class="ident" id="6562500">err</span>&nbsp;<span class="op" id="6562504">!=</span>&nbsp;<span class="builtintype" id="6562507">nil</span>&nbsp;<span class="op" id="6562511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6562515">t</span><span class="op" id="6562516">.</span><span class="ident" id="6562517">Fatalf</span><span class="op" id="6562523">(</span><span class="string" id="6562524">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6562541">,</span>&nbsp;<span class="ident" id="6562543">err</span><span class="op" id="6562546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6562549">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6562552">if</span>&nbsp;<span class="ident" id="6562555">err</span>&nbsp;<span class="op" id="6562559">:=</span>&nbsp;<span class="op" id="6562562">&lt;-</span><span class="ident" id="6562564">errc</span><span class="op" id="6562568">;</span>&nbsp;<span class="ident" id="6562570">err</span>&nbsp;<span class="op" id="6562574">!=</span>&nbsp;<span class="builtintype" id="6562577">nil</span>&nbsp;<span class="op" id="6562581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6562585">t</span><span class="op" id="6562586">.</span><span class="ident" id="6562587">Fatalf</span><span class="op" id="6562593">(</span><span class="string" id="6562594">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6562613">,</span>&nbsp;<span class="ident" id="6562615">err</span><span class="op" id="6562618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6562621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6562624">defer</span>&nbsp;<span class="ident" id="6562630">server</span><span class="op" id="6562636">.</span><span class="ident" id="6562637">Close</span><span class="op" id="6562642">(</span><span class="op" id="6562643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6562646">var</span>&nbsp;<span class="ident" id="6562650">buf</span>&nbsp;<span class="op" id="6562654">[</span><span class="num" id="6562655">128</span><span class="op" id="6562658">]</span><span class="builtintype" id="6562659">byte</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6562665">mallocs</span>&nbsp;<span class="op" id="6562673">:=</span>&nbsp;<span class="ident" id="6562676">testing</span><span class="op" id="6562683">.</span><span class="ident" id="6562684">AllocsPerRun</span><span class="op" id="6562696">(</span><span class="num" id="6562697">1000</span><span class="op" id="6562701">,</span>&nbsp;<span class="keyword" id="6562703">func</span><span class="op" id="6562707">(</span><span class="op" id="6562708">)</span>&nbsp;<span class="op" id="6562710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6562714">_</span><span class="op" id="6562715">,</span>&nbsp;<span class="ident" id="6562717">err</span>&nbsp;<span class="op" id="6562721">:=</span>&nbsp;<span class="ident" id="6562724">server</span><span class="op" id="6562730">.</span><span class="ident" id="6562731">Write</span><span class="op" id="6562736">(</span><span class="ident" id="6562737">buf</span><span class="op" id="6562740">[</span><span class="op" id="6562741">:</span><span class="op" id="6562742">]</span><span class="op" id="6562743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6562747">if</span>&nbsp;<span class="ident" id="6562750">err</span>&nbsp;<span class="op" id="6562754">!=</span>&nbsp;<span class="builtintype" id="6562757">nil</span>&nbsp;<span class="op" id="6562761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6562766">t</span><span class="op" id="6562767">.</span><span class="ident" id="6562768">Fatalf</span><span class="op" id="6562774">(</span><span class="string" id="6562775">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6562793">,</span>&nbsp;<span class="ident" id="6562795">err</span><span class="op" id="6562798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6562802">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6562806">_</span><span class="op" id="6562807">,</span>&nbsp;<span class="ident" id="6562809">err</span>&nbsp;<span class="op" id="6562813">=</span>&nbsp;<span class="ident" id="6562815">io</span><span class="op" id="6562817">.</span><span class="ident" id="6562818">ReadFull</span><span class="op" id="6562826">(</span><span class="ident" id="6562827">client</span><span class="op" id="6562833">,</span>&nbsp;<span class="ident" id="6562835">buf</span><span class="op" id="6562838">[</span><span class="op" id="6562839">:</span><span class="op" id="6562840">]</span><span class="op" id="6562841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6562845">if</span>&nbsp;<span class="ident" id="6562848">err</span>&nbsp;<span class="op" id="6562852">!=</span>&nbsp;<span class="builtintype" id="6562855">nil</span>&nbsp;<span class="op" id="6562859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6562864">t</span><span class="op" id="6562865">.</span><span class="ident" id="6562866">Fatalf</span><span class="op" id="6562872">(</span><span class="string" id="6562873">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6562890">,</span>&nbsp;<span class="ident" id="6562892">err</span><span class="op" id="6562895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6562899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6562902">}</span><span class="op" id="6562903">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6562906">if</span>&nbsp;<span class="ident" id="6562909">mallocs</span>&nbsp;<span class="op" id="6562917">&gt;</span>&nbsp;<span class="num" id="6562919">0</span>&nbsp;<span class="op" id="6562921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6562925">t</span><span class="op" id="6562926">.</span><span class="ident" id="6562927">Fatalf</span><span class="op" id="6562933">(</span><span class="string" id="6562934">&#34;Got&nbsp;%v&nbsp;allocs,&nbsp;want&nbsp;0&#34;</span><span class="op" id="6562957">,</span>&nbsp;<span class="ident" id="6562959">mallocs</span><span class="op" id="6562966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6562969">}</span><br>
<span class="lineno"></span><span class="op" id="6562971">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="6562974">func</span>&nbsp;<span class="ident" id="6562979">TestTCPStress</span><span class="op" id="6562992">(</span><span class="ident" id="6562993">t</span>&nbsp;<span class="op" id="6562995">*</span><span class="ident" id="6562996">testing</span><span class="op" id="6563003">.</span><span class="ident" id="6563004">T</span><span class="op" id="6563005">)</span>&nbsp;<span class="op" id="6563007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6563010">const</span>&nbsp;<span class="ident" id="6563016">conns</span>&nbsp;<span class="op" id="6563022">=</span>&nbsp;<span class="num" id="6563024">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6563027">const</span>&nbsp;<span class="ident" id="6563033">msgLen</span>&nbsp;<span class="op" id="6563040">=</span>&nbsp;<span class="num" id="6563042">512</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6563047">msgs</span>&nbsp;<span class="op" id="6563052">:=</span>&nbsp;<span class="builtintype" id="6563055">int</span><span class="op" id="6563058">(</span><span class="num" id="6563059">1e4</span><span class="op" id="6563062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6563065">if</span>&nbsp;<span class="ident" id="6563068">testing</span><span class="op" id="6563075">.</span><span class="ident" id="6563076">Short</span><span class="op" id="6563081">(</span><span class="op" id="6563082">)</span>&nbsp;<span class="op" id="6563084">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6563088">msgs</span>&nbsp;<span class="op" id="6563093">=</span>&nbsp;<span class="num" id="6563095">1e2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6563100">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6563104">sendMsg</span>&nbsp;<span class="op" id="6563112">:=</span>&nbsp;<span class="keyword" id="6563115">func</span><span class="op" id="6563119">(</span><span class="ident" id="6563120">c</span>&nbsp;<span class="ident" id="6563122">Conn</span><span class="op" id="6563126">,</span>&nbsp;<span class="ident" id="6563128">buf</span>&nbsp;<span class="op" id="6563132">[</span><span class="op" id="6563133">]</span><span class="builtintype" id="6563134">byte</span><span class="op" id="6563138">)</span>&nbsp;<span class="builtintype" id="6563140">bool</span>&nbsp;<span class="op" id="6563145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6563149">n</span><span class="op" id="6563150">,</span>&nbsp;<span class="ident" id="6563152">err</span>&nbsp;<span class="op" id="6563156">:=</span>&nbsp;<span class="ident" id="6563159">c</span><span class="op" id="6563160">.</span><span class="ident" id="6563161">Write</span><span class="op" id="6563166">(</span><span class="ident" id="6563167">buf</span><span class="op" id="6563170">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6563174">if</span>&nbsp;<span class="ident" id="6563177">n</span>&nbsp;<span class="op" id="6563179">!=</span>&nbsp;<span class="builtinfunc" id="6563182">len</span><span class="op" id="6563185">(</span><span class="ident" id="6563186">buf</span><span class="op" id="6563189">)</span>&nbsp;<span class="op" id="6563191">||</span>&nbsp;<span class="ident" id="6563194">err</span>&nbsp;<span class="op" id="6563198">!=</span>&nbsp;<span class="builtintype" id="6563201">nil</span>&nbsp;<span class="op" id="6563205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6563210">t</span><span class="op" id="6563211">.</span><span class="ident" id="6563212">Logf</span><span class="op" id="6563216">(</span><span class="string" id="6563217">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6563235">,</span>&nbsp;<span class="ident" id="6563237">err</span><span class="op" id="6563240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6563245">return</span>&nbsp;<span class="builtintype" id="6563252">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6563260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6563264">return</span>&nbsp;<span class="builtintype" id="6563271">true</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6563277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6563280">recvMsg</span>&nbsp;<span class="op" id="6563288">:=</span>&nbsp;<span class="keyword" id="6563291">func</span><span class="op" id="6563295">(</span><span class="ident" id="6563296">c</span>&nbsp;<span class="ident" id="6563298">Conn</span><span class="op" id="6563302">,</span>&nbsp;<span class="ident" id="6563304">buf</span>&nbsp;<span class="op" id="6563308">[</span><span class="op" id="6563309">]</span><span class="builtintype" id="6563310">byte</span><span class="op" id="6563314">)</span>&nbsp;<span class="builtintype" id="6563316">bool</span>&nbsp;<span class="op" id="6563321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6563325">for</span>&nbsp;<span class="ident" id="6563329">read</span>&nbsp;<span class="op" id="6563334">:=</span>&nbsp;<span class="num" id="6563337">0</span><span class="op" id="6563338">;</span>&nbsp;<span class="ident" id="6563340">read</span>&nbsp;<span class="op" id="6563345">!=</span>&nbsp;<span class="builtinfunc" id="6563348">len</span><span class="op" id="6563351">(</span><span class="ident" id="6563352">buf</span><span class="op" id="6563355">)</span><span class="op" id="6563356">;</span>&nbsp;<span class="op" id="6563358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6563363">n</span><span class="op" id="6563364">,</span>&nbsp;<span class="ident" id="6563366">err</span>&nbsp;<span class="op" id="6563370">:=</span>&nbsp;<span class="ident" id="6563373">c</span><span class="op" id="6563374">.</span><span class="ident" id="6563375">Read</span><span class="op" id="6563379">(</span><span class="ident" id="6563380">buf</span><span class="op" id="6563383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6563388">read</span>&nbsp;<span class="op" id="6563393">+=</span>&nbsp;<span class="ident" id="6563396">n</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6563401">if</span>&nbsp;<span class="ident" id="6563404">err</span>&nbsp;<span class="op" id="6563408">!=</span>&nbsp;<span class="builtintype" id="6563411">nil</span>&nbsp;<span class="op" id="6563415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6563421">t</span><span class="op" id="6563422">.</span><span class="ident" id="6563423">Logf</span><span class="op" id="6563427">(</span><span class="string" id="6563428">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6563445">,</span>&nbsp;<span class="ident" id="6563447">err</span><span class="op" id="6563450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6563456">return</span>&nbsp;<span class="builtintype" id="6563463">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6563472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6563476">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6563480">return</span>&nbsp;<span class="builtintype" id="6563487">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6563493">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6563497">ln</span><span class="op" id="6563499">,</span>&nbsp;<span class="ident" id="6563501">err</span>&nbsp;<span class="op" id="6563505">:=</span>&nbsp;<span class="ident" id="6563508">Listen</span><span class="op" id="6563514">(</span><span class="string" id="6563515">&#34;tcp&#34;</span><span class="op" id="6563520">,</span>&nbsp;<span class="string" id="6563522">&#34;127.0.0.1:0&#34;</span><span class="op" id="6563535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6563538">if</span>&nbsp;<span class="ident" id="6563541">err</span>&nbsp;<span class="op" id="6563545">!=</span>&nbsp;<span class="builtintype" id="6563548">nil</span>&nbsp;<span class="op" id="6563552">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6563556">t</span><span class="op" id="6563557">.</span><span class="ident" id="6563558">Fatalf</span><span class="op" id="6563564">(</span><span class="string" id="6563565">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6563584">,</span>&nbsp;<span class="ident" id="6563586">err</span><span class="op" id="6563589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6563592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6563595">defer</span>&nbsp;<span class="ident" id="6563601">ln</span><span class="op" id="6563603">.</span><span class="ident" id="6563604">Close</span><span class="op" id="6563609">(</span><span class="op" id="6563610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6563613">//&nbsp;Acceptor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6563627">go</span>&nbsp;<span class="keyword" id="6563630">func</span><span class="op" id="6563634">(</span><span class="op" id="6563635">)</span>&nbsp;<span class="op" id="6563637">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6563641">for</span>&nbsp;<span class="op" id="6563645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6563650">c</span><span class="op" id="6563651">,</span>&nbsp;<span class="ident" id="6563653">err</span>&nbsp;<span class="op" id="6563657">:=</span>&nbsp;<span class="ident" id="6563660">ln</span><span class="op" id="6563662">.</span><span class="ident" id="6563663">Accept</span><span class="op" id="6563669">(</span><span class="op" id="6563670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6563675">if</span>&nbsp;<span class="ident" id="6563678">err</span>&nbsp;<span class="op" id="6563682">!=</span>&nbsp;<span class="builtintype" id="6563685">nil</span>&nbsp;<span class="op" id="6563689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6563695">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6563704">}</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6563709">//&nbsp;Server&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6563734">go</span>&nbsp;<span class="keyword" id="6563737">func</span><span class="op" id="6563741">(</span><span class="ident" id="6563742">c</span>&nbsp;<span class="ident" id="6563744">Conn</span><span class="op" id="6563748">)</span>&nbsp;<span class="op" id="6563750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6563756">defer</span>&nbsp;<span class="ident" id="6563762">c</span><span class="op" id="6563763">.</span><span class="ident" id="6563764">Close</span><span class="op" id="6563769">(</span><span class="op" id="6563770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6563776">var</span>&nbsp;<span class="ident" id="6563780">buf</span>&nbsp;<span class="op" id="6563784">[</span><span class="ident" id="6563785">msgLen</span><span class="op" id="6563791">]</span><span class="builtintype" id="6563792">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6563801">for</span>&nbsp;<span class="ident" id="6563805">m</span>&nbsp;<span class="op" id="6563807">:=</span>&nbsp;<span class="num" id="6563810">0</span><span class="op" id="6563811">;</span>&nbsp;<span class="ident" id="6563813">m</span>&nbsp;<span class="op" id="6563815">&lt;</span>&nbsp;<span class="ident" id="6563817">msgs</span><span class="op" id="6563821">;</span>&nbsp;<span class="ident" id="6563823">m</span><span class="op" id="6563824">++</span>&nbsp;<span class="op" id="6563827">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6563834">if</span>&nbsp;<span class="op" id="6563837">!</span><span class="ident" id="6563838">recvMsg</span><span class="op" id="6563845">(</span><span class="ident" id="6563846">c</span><span class="op" id="6563847">,</span>&nbsp;<span class="ident" id="6563849">buf</span><span class="op" id="6563852">[</span><span class="op" id="6563853">:</span><span class="op" id="6563854">]</span><span class="op" id="6563855">)</span>&nbsp;<span class="op" id="6563857">||</span>&nbsp;<span class="op" id="6563860">!</span><span class="ident" id="6563861">sendMsg</span><span class="op" id="6563868">(</span><span class="ident" id="6563869">c</span><span class="op" id="6563870">,</span>&nbsp;<span class="ident" id="6563872">buf</span><span class="op" id="6563875">[</span><span class="op" id="6563876">:</span><span class="op" id="6563877">]</span><span class="op" id="6563878">)</span>&nbsp;<span class="op" id="6563880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6563888">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6563899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6563905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6563910">}</span><span class="op" id="6563911">(</span><span class="ident" id="6563912">c</span><span class="op" id="6563913">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6563917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6563920">}</span><span class="op" id="6563921">(</span><span class="op" id="6563922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6563925">done</span>&nbsp;<span class="op" id="6563930">:=</span>&nbsp;<span class="builtinfunc" id="6563933">make</span><span class="op" id="6563937">(</span><span class="keyword" id="6563938">chan</span>&nbsp;<span class="builtintype" id="6563943">bool</span><span class="op" id="6563947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6563950">for</span>&nbsp;<span class="ident" id="6563954">i</span>&nbsp;<span class="op" id="6563956">:=</span>&nbsp;<span class="num" id="6563959">0</span><span class="op" id="6563960">;</span>&nbsp;<span class="ident" id="6563962">i</span>&nbsp;<span class="op" id="6563964">&lt;</span>&nbsp;<span class="ident" id="6563966">conns</span><span class="op" id="6563971">;</span>&nbsp;<span class="ident" id="6563973">i</span><span class="op" id="6563974">++</span>&nbsp;<span class="op" id="6563977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6563981">//&nbsp;Client&nbsp;connection.</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6564005">go</span>&nbsp;<span class="keyword" id="6564008">func</span><span class="op" id="6564012">(</span><span class="op" id="6564013">)</span>&nbsp;<span class="op" id="6564015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6564020">defer</span>&nbsp;<span class="keyword" id="6564026">func</span><span class="op" id="6564030">(</span><span class="op" id="6564031">)</span>&nbsp;<span class="op" id="6564033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6564039">done</span>&nbsp;<span class="op" id="6564044">&lt;-</span>&nbsp;<span class="builtintype" id="6564047">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6564055">}</span><span class="op" id="6564056">(</span><span class="op" id="6564057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6564062">c</span><span class="op" id="6564063">,</span>&nbsp;<span class="ident" id="6564065">err</span>&nbsp;<span class="op" id="6564069">:=</span>&nbsp;<span class="ident" id="6564072">Dial</span><span class="op" id="6564076">(</span><span class="string" id="6564077">&#34;tcp&#34;</span><span class="op" id="6564082">,</span>&nbsp;<span class="ident" id="6564084">ln</span><span class="op" id="6564086">.</span><span class="ident" id="6564087">Addr</span><span class="op" id="6564091">(</span><span class="op" id="6564092">)</span><span class="op" id="6564093">.</span><span class="ident" id="6564094">String</span><span class="op" id="6564100">(</span><span class="op" id="6564101">)</span><span class="op" id="6564102">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6564107">if</span>&nbsp;<span class="ident" id="6564110">err</span>&nbsp;<span class="op" id="6564114">!=</span>&nbsp;<span class="builtintype" id="6564117">nil</span>&nbsp;<span class="op" id="6564121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6564127">t</span><span class="op" id="6564128">.</span><span class="ident" id="6564129">Logf</span><span class="op" id="6564133">(</span><span class="string" id="6564134">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6564151">,</span>&nbsp;<span class="ident" id="6564153">err</span><span class="op" id="6564156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6564162">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6564172">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6564177">defer</span>&nbsp;<span class="ident" id="6564183">c</span><span class="op" id="6564184">.</span><span class="ident" id="6564185">Close</span><span class="op" id="6564190">(</span><span class="op" id="6564191">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6564196">var</span>&nbsp;<span class="ident" id="6564200">buf</span>&nbsp;<span class="op" id="6564204">[</span><span class="ident" id="6564205">msgLen</span><span class="op" id="6564211">]</span><span class="builtintype" id="6564212">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6564220">for</span>&nbsp;<span class="ident" id="6564224">m</span>&nbsp;<span class="op" id="6564226">:=</span>&nbsp;<span class="num" id="6564229">0</span><span class="op" id="6564230">;</span>&nbsp;<span class="ident" id="6564232">m</span>&nbsp;<span class="op" id="6564234">&lt;</span>&nbsp;<span class="ident" id="6564236">msgs</span><span class="op" id="6564240">;</span>&nbsp;<span class="ident" id="6564242">m</span><span class="op" id="6564243">++</span>&nbsp;<span class="op" id="6564246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6564252">if</span>&nbsp;<span class="op" id="6564255">!</span><span class="ident" id="6564256">sendMsg</span><span class="op" id="6564263">(</span><span class="ident" id="6564264">c</span><span class="op" id="6564265">,</span>&nbsp;<span class="ident" id="6564267">buf</span><span class="op" id="6564270">[</span><span class="op" id="6564271">:</span><span class="op" id="6564272">]</span><span class="op" id="6564273">)</span>&nbsp;<span class="op" id="6564275">||</span>&nbsp;<span class="op" id="6564278">!</span><span class="ident" id="6564279">recvMsg</span><span class="op" id="6564286">(</span><span class="ident" id="6564287">c</span><span class="op" id="6564288">,</span>&nbsp;<span class="ident" id="6564290">buf</span><span class="op" id="6564293">[</span><span class="op" id="6564294">:</span><span class="op" id="6564295">]</span><span class="op" id="6564296">)</span>&nbsp;<span class="op" id="6564298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6564305">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6564315">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6564320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6564324">}</span><span class="op" id="6564325">(</span><span class="op" id="6564326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6564329">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6564332">for</span>&nbsp;<span class="ident" id="6564336">i</span>&nbsp;<span class="op" id="6564338">:=</span>&nbsp;<span class="num" id="6564341">0</span><span class="op" id="6564342">;</span>&nbsp;<span class="ident" id="6564344">i</span>&nbsp;<span class="op" id="6564346">&lt;</span>&nbsp;<span class="ident" id="6564348">conns</span><span class="op" id="6564353">;</span>&nbsp;<span class="ident" id="6564355">i</span><span class="op" id="6564356">++</span>&nbsp;<span class="op" id="6564359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6564363">&lt;-</span><span class="ident" id="6564365">done</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6564371">}</span><br>
<span class="lineno"></span><span class="op" id="6564373">}</span>
</div>
</body>
</html>
