<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment">//&nbsp;Package&nbsp;fcgi&nbsp;implements&nbsp;the&nbsp;FastCGI&nbsp;protocol.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Currently&nbsp;only&nbsp;the&nbsp;responder&nbsp;role&nbsp;is&nbsp;supported.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;protocol&nbsp;is&nbsp;defined&nbsp;at&nbsp;http://www.fastcgi.com/drupal/node/6?q=node/22</span><br>
<span class="lineno"></span><span class="keyword">package</span>&nbsp;<span class="ident">fcgi</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment">//&nbsp;This&nbsp;file&nbsp;defines&nbsp;the&nbsp;raw&nbsp;protocol&nbsp;and&nbsp;some&nbsp;utilities&nbsp;used&nbsp;by&nbsp;the&nbsp;child&nbsp;and</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;the&nbsp;host.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;bufio&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;encoding/binary&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;sync&#34;</span><br>
<span class="lineno">20</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;recType&nbsp;is&nbsp;a&nbsp;record&nbsp;type,&nbsp;as&nbsp;defined&nbsp;by</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;http://www.fastcgi.com/devkit/doc/fcgi-spec.html#S8</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">recType</span>&nbsp;<span class="builtintype">uint8</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword">const</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">typeBeginRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">recType</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">typeAbortRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">recType</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">typeEndRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">recType</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">3</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">typeParams</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">recType</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">typeStdin</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">recType</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">typeStdout</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">recType</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">typeStderr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">recType</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">typeData</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">recType</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">8</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">typeGetValues</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">recType</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">typeGetValuesResult</span>&nbsp;<span class="ident">recType</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">typeUnknownType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">recType</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">11</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment">//&nbsp;keep&nbsp;the&nbsp;connection&nbsp;between&nbsp;web-server&nbsp;and&nbsp;responder&nbsp;open&nbsp;after&nbsp;request</span><br>
<span class="lineno"></span><span class="keyword">const</span>&nbsp;<span class="ident">flagKeepConn</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">const</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">maxWrite</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">65535</span>&nbsp;<span class="comment">//&nbsp;maximum&nbsp;record&nbsp;body</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">maxPad</span>&nbsp;&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="num">255</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">const</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">roleResponder</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">iota</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">1</span>&nbsp;<span class="comment">//&nbsp;only&nbsp;Responders&nbsp;are&nbsp;implemented.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">roleAuthorizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">roleFilter</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">const</span>&nbsp;<span class="op">(</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">statusRequestComplete</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">statusCantMultiplex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">statusOverloaded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">statusUnknownRole</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword">const</span>&nbsp;<span class="ident">headerLen</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">header</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Version</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">uint8</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Type</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ContentLength</span>&nbsp;<span class="builtintype">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">PaddingLength</span>&nbsp;<span class="builtintype">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Reserved</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">uint8</span><br>
<span class="lineno">70</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">beginRequest</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">role</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">flags</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">uint8</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reserved</span>&nbsp;<span class="op">[</span><span class="num">5</span><span class="op">]</span><span class="builtintype">uint8</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">br</span>&nbsp;<span class="op">*</span><span class="ident">beginRequest</span><span class="op">)</span>&nbsp;<span class="ident">read</span><span class="op">(</span><span class="ident">content</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">content</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">8</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;fcgi:&nbsp;invalid&nbsp;begin&nbsp;request&nbsp;record&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">br</span><span class="op">.</span><span class="ident">role</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">binary</span><span class="op">.</span><span class="ident">BigEndian</span><span class="op">.</span><span class="ident">Uint16</span><span class="op">(</span><span class="ident">content</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">br</span><span class="op">.</span><span class="ident">flags</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">content</span><span class="op">[</span><span class="num">2</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno">85</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;for&nbsp;padding&nbsp;so&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;to&nbsp;allocate&nbsp;all&nbsp;the&nbsp;time</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;not&nbsp;synchronized&nbsp;because&nbsp;we&nbsp;don&#39;t&nbsp;care&nbsp;what&nbsp;the&nbsp;contents&nbsp;are</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">pad</span>&nbsp;<span class="op">[</span><span class="ident">maxPad</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">h</span>&nbsp;<span class="op">*</span><span class="ident">header</span><span class="op">)</span>&nbsp;<span class="ident">init</span><span class="op">(</span><span class="ident">recType</span>&nbsp;<span class="ident">recType</span><span class="op">,</span>&nbsp;<span class="ident">reqId</span>&nbsp;<span class="builtintype">uint16</span><span class="op">,</span>&nbsp;<span class="ident">contentLength</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">h</span><span class="op">.</span><span class="ident">Version</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">h</span><span class="op">.</span><span class="ident">Type</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">h</span><span class="op">.</span><span class="ident">Id</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">reqId</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">h</span><span class="op">.</span><span class="ident">ContentLength</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">uint16</span><span class="op">(</span><span class="ident">contentLength</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">h</span><span class="op">.</span><span class="ident">PaddingLength</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">uint8</span><span class="op">(</span><span class="op">-</span><span class="ident">contentLength</span>&nbsp;<span class="op">&amp;</span>&nbsp;<span class="num">7</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;conn&nbsp;sends&nbsp;records&nbsp;over&nbsp;rwc</span><br>
<span class="lineno">100</span><span class="keyword">type</span>&nbsp;<span class="ident">conn</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mutex</span>&nbsp;<span class="ident">sync</span><span class="op">.</span><span class="ident">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rwc</span>&nbsp;&nbsp;&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">ReadWriteCloser</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;to&nbsp;avoid&nbsp;allocations</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">buf</span>&nbsp;<span class="ident">bytes</span><span class="op">.</span><span class="ident">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">h</span>&nbsp;&nbsp;&nbsp;<span class="ident">header</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">newConn</span><span class="op">(</span><span class="ident">rwc</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">ReadWriteCloser</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">conn</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">conn</span><span class="op">{</span><span class="ident">rwc</span><span class="op">:</span>&nbsp;<span class="ident">rwc</span><span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">conn</span><span class="op">)</span>&nbsp;<span class="ident">Close</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">.</span><span class="ident">mutex</span><span class="op">.</span><span class="ident">Lock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">mutex</span><span class="op">.</span><span class="ident">Unlock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">rwc</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">record</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">h</span>&nbsp;&nbsp;&nbsp;<span class="ident">header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">buf</span>&nbsp;<span class="op">[</span><span class="ident">maxWrite</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">maxPad</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">rec</span>&nbsp;<span class="op">*</span><span class="ident">record</span><span class="op">)</span>&nbsp;<span class="ident">read</span><span class="op">(</span><span class="ident">r</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">Reader</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">binary</span><span class="op">.</span><span class="ident">Read</span><span class="op">(</span><span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">binary</span><span class="op">.</span><span class="ident">BigEndian</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">rec</span><span class="op">.</span><span class="ident">h</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">rec</span><span class="op">.</span><span class="ident">h</span><span class="op">.</span><span class="ident">Version</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;fcgi:&nbsp;invalid&nbsp;header&nbsp;version&#34;</span><span class="op">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">rec</span><span class="op">.</span><span class="ident">h</span><span class="op">.</span><span class="ident">ContentLength</span><span class="op">)</span>&nbsp;<span class="op">+</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">rec</span><span class="op">.</span><span class="ident">h</span><span class="op">.</span><span class="ident">PaddingLength</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">ReadFull</span><span class="op">(</span><span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">rec</span><span class="op">.</span><span class="ident">buf</span><span class="op">[</span><span class="op">:</span><span class="ident">n</span><span class="op">]</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">record</span><span class="op">)</span>&nbsp;<span class="ident">content</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">buf</span><span class="op">[</span><span class="op">:</span><span class="ident">r</span><span class="op">.</span><span class="ident">h</span><span class="op">.</span><span class="ident">ContentLength</span><span class="op">]</span><br>
<span class="lineno">140</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;writeRecord&nbsp;writes&nbsp;and&nbsp;sends&nbsp;a&nbsp;single&nbsp;record.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">conn</span><span class="op">)</span>&nbsp;<span class="ident">writeRecord</span><span class="op">(</span><span class="ident">recType</span>&nbsp;<span class="ident">recType</span><span class="op">,</span>&nbsp;<span class="ident">reqId</span>&nbsp;<span class="builtintype">uint16</span><span class="op">,</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">.</span><span class="ident">mutex</span><span class="op">.</span><span class="ident">Lock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">mutex</span><span class="op">.</span><span class="ident">Unlock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">.</span><span class="ident">buf</span><span class="op">.</span><span class="ident">Reset</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">.</span><span class="ident">h</span><span class="op">.</span><span class="ident">init</span><span class="op">(</span><span class="ident">recType</span><span class="op">,</span>&nbsp;<span class="ident">reqId</span><span class="op">,</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">binary</span><span class="op">.</span><span class="ident">Write</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">c</span><span class="op">.</span><span class="ident">buf</span><span class="op">,</span>&nbsp;<span class="ident">binary</span><span class="op">.</span><span class="ident">BigEndian</span><span class="op">,</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">h</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">buf</span><span class="op">.</span><span class="ident">Write</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">buf</span><span class="op">.</span><span class="ident">Write</span><span class="op">(</span><span class="ident">pad</span><span class="op">[</span><span class="op">:</span><span class="ident">c</span><span class="op">.</span><span class="ident">h</span><span class="op">.</span><span class="ident">PaddingLength</span><span class="op">]</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">rwc</span><span class="op">.</span><span class="ident">Write</span><span class="op">(</span><span class="ident">c</span><span class="op">.</span><span class="ident">buf</span><span class="op">.</span><span class="ident">Bytes</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">conn</span><span class="op">)</span>&nbsp;<span class="ident">writeBeginRequest</span><span class="op">(</span><span class="ident">reqId</span>&nbsp;<span class="builtintype">uint16</span><span class="op">,</span>&nbsp;<span class="ident">role</span>&nbsp;<span class="builtintype">uint16</span><span class="op">,</span>&nbsp;<span class="ident">flags</span>&nbsp;<span class="builtintype">uint8</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">[</span><span class="num">8</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">{</span><span class="builtintype">byte</span><span class="op">(</span><span class="ident">role</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="num">8</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="builtintype">byte</span><span class="op">(</span><span class="ident">role</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">flags</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">writeRecord</span><span class="op">(</span><span class="ident">typeBeginRequest</span><span class="op">,</span>&nbsp;<span class="ident">reqId</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">conn</span><span class="op">)</span>&nbsp;<span class="ident">writeEndRequest</span><span class="op">(</span><span class="ident">reqId</span>&nbsp;<span class="builtintype">uint16</span><span class="op">,</span>&nbsp;<span class="ident">appStatus</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">protocolStatus</span>&nbsp;<span class="builtintype">uint8</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">binary</span><span class="op">.</span><span class="ident">BigEndian</span><span class="op">.</span><span class="ident">PutUint32</span><span class="op">(</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="builtintype">uint32</span><span class="op">(</span><span class="ident">appStatus</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">[</span><span class="num">4</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">protocolStatus</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">writeRecord</span><span class="op">(</span><span class="ident">typeEndRequest</span><span class="op">,</span>&nbsp;<span class="ident">reqId</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">conn</span><span class="op">)</span>&nbsp;<span class="ident">writePairs</span><span class="op">(</span><span class="ident">recType</span>&nbsp;<span class="ident">recType</span><span class="op">,</span>&nbsp;<span class="ident">reqId</span>&nbsp;<span class="builtintype">uint16</span><span class="op">,</span>&nbsp;<span class="ident">pairs</span>&nbsp;<span class="keyword">map</span><span class="op">[</span><span class="builtintype">string</span><span class="op">]</span><span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">newWriter</span><span class="op">(</span><span class="ident">c</span><span class="op">,</span>&nbsp;<span class="ident">recType</span><span class="op">,</span>&nbsp;<span class="ident">reqId</span><span class="op">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">k</span><span class="op">,</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">pairs</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">encodeSize</span><span class="op">(</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="builtintype">uint32</span><span class="op">(</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">k</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">encodeSize</span><span class="op">(</span><span class="ident">b</span><span class="op">[</span><span class="ident">n</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="builtintype">uint32</span><span class="op">(</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">v</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">Write</span><span class="op">(</span><span class="ident">b</span><span class="op">[</span><span class="op">:</span><span class="ident">n</span><span class="op">]</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">WriteString</span><span class="op">(</span><span class="ident">k</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">WriteString</span><span class="op">(</span><span class="ident">v</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">readSize</span><span class="op">(</span><span class="ident">s</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="builtintype">uint32</span><span class="op">,</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">s</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">size</span><span class="op">,</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">uint32</span><span class="op">(</span><span class="ident">s</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">size</span><span class="op">&amp;</span><span class="op">(</span><span class="num">1</span><span class="op">&lt;&lt;</span><span class="num">7</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">s</span><span class="op">)</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">4</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">size</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">binary</span><span class="op">.</span><span class="ident">BigEndian</span><span class="op">.</span><span class="ident">Uint32</span><span class="op">(</span><span class="ident">s</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">size</span>&nbsp;<span class="op">&amp;^=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="num">31</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">size</span><span class="op">,</span>&nbsp;<span class="ident">n</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">readString</span><span class="op">(</span><span class="ident">s</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">size</span>&nbsp;<span class="builtintype">uint32</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">size</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="builtintype">uint32</span><span class="op">(</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">s</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="string">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="builtintype">string</span><span class="op">(</span><span class="ident">s</span><span class="op">[</span><span class="op">:</span><span class="ident">size</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">encodeSize</span><span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">size</span>&nbsp;<span class="builtintype">uint32</span><span class="op">)</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">size</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">127</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">size</span>&nbsp;<span class="op">|=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="num">31</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">binary</span><span class="op">.</span><span class="ident">BigEndian</span><span class="op">.</span><span class="ident">PutUint32</span><span class="op">(</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">size</span><span class="op">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">byte</span><span class="op">(</span><span class="ident">size</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;bufWriter&nbsp;encapsulates&nbsp;bufio.Writer&nbsp;but&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;stream&nbsp;when</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Closed.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">bufWriter</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">closer</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">Closer</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">*</span><span class="ident">bufio</span><span class="op">.</span><span class="ident">Writer</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">w</span>&nbsp;<span class="op">*</span><span class="ident">bufWriter</span><span class="op">)</span>&nbsp;<span class="ident">Close</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">Writer</span><span class="op">.</span><span class="ident">Flush</span><span class="op">(</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">closer</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">closer</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">newWriter</span><span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">conn</span><span class="op">,</span>&nbsp;<span class="ident">recType</span>&nbsp;<span class="ident">recType</span><span class="op">,</span>&nbsp;<span class="ident">reqId</span>&nbsp;<span class="builtintype">uint16</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">bufWriter</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">streamWriter</span><span class="op">{</span><span class="ident">c</span><span class="op">:</span>&nbsp;<span class="ident">c</span><span class="op">,</span>&nbsp;<span class="ident">recType</span><span class="op">:</span>&nbsp;<span class="ident">recType</span><span class="op">,</span>&nbsp;<span class="ident">reqId</span><span class="op">:</span>&nbsp;<span class="ident">reqId</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">bufio</span><span class="op">.</span><span class="ident">NewWriterSize</span><span class="op">(</span><span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">maxWrite</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">bufWriter</span><span class="op">{</span><span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">w</span><span class="op">}</span><br>
<span class="lineno">245</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;streamWriter&nbsp;abstracts&nbsp;out&nbsp;the&nbsp;separation&nbsp;of&nbsp;a&nbsp;stream&nbsp;into&nbsp;discrete&nbsp;records.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;It&nbsp;only&nbsp;writes&nbsp;maxWrite&nbsp;bytes&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">streamWriter</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">recType</span>&nbsp;<span class="ident">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reqId</span>&nbsp;&nbsp;&nbsp;<span class="builtintype">uint16</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">w</span>&nbsp;<span class="op">*</span><span class="ident">streamWriter</span><span class="op">)</span>&nbsp;<span class="ident">Write</span><span class="op">(</span><span class="ident">p</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nn</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">p</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">p</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">maxWrite</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">maxWrite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">c</span><span class="op">.</span><span class="ident">writeRecord</span><span class="op">(</span><span class="ident">w</span><span class="op">.</span><span class="ident">recType</span><span class="op">,</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">reqId</span><span class="op">,</span>&nbsp;<span class="ident">p</span><span class="op">[</span><span class="op">:</span><span class="ident">n</span><span class="op">]</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nn</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nn</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">p</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">p</span><span class="op">[</span><span class="ident">n</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nn</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">w</span>&nbsp;<span class="op">*</span><span class="ident">streamWriter</span><span class="op">)</span>&nbsp;<span class="ident">Close</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;send&nbsp;empty&nbsp;record&nbsp;to&nbsp;close&nbsp;the&nbsp;stream</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">c</span><span class="op">.</span><span class="ident">writeRecord</span><span class="op">(</span><span class="ident">w</span><span class="op">.</span><span class="ident">recType</span><span class="op">,</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">reqId</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span>
</div>
</body>
</html>
