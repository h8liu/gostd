<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/mail</h2>
<ul>
<li><a href="/gostd/net/mail/message.go.html" class="current">message.go</a></li>
<li><a href="/gostd/net/mail/message_test.go.html">message_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4861025">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4861080">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4861134">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4861185">/*<br>
<span class="lineno"></span>Package&nbsp;mail&nbsp;implements&nbsp;parsing&nbsp;of&nbsp;mail&nbsp;messages.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>For&nbsp;the&nbsp;most&nbsp;part,&nbsp;this&nbsp;package&nbsp;follows&nbsp;the&nbsp;syntax&nbsp;as&nbsp;specified&nbsp;by&nbsp;RFC&nbsp;5322.<br>
<span class="lineno"></span>Notable&nbsp;divergences:<br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Obsolete&nbsp;address&nbsp;formats&nbsp;are&nbsp;not&nbsp;parsed,&nbsp;including&nbsp;addresses&nbsp;with<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;embedded&nbsp;route&nbsp;information.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Group&nbsp;addresses&nbsp;are&nbsp;not&nbsp;parsed.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;full&nbsp;range&nbsp;of&nbsp;spacing&nbsp;(the&nbsp;CFWS&nbsp;syntax&nbsp;element)&nbsp;is&nbsp;not&nbsp;supported,<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;such&nbsp;as&nbsp;breaking&nbsp;addresses&nbsp;across&nbsp;lines.<br>
<span class="lineno">15</span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="4861592">package</span>&nbsp;<span class="ident" id="4861600">mail</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4861606">import</span>&nbsp;<span class="op" id="4861613">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4861616">&#34;bufio&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4861625">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4861634">&#34;encoding/base64&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4861653">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4861663">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4861670">&#34;io&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4861676">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4861689">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4861696">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4861713">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4861724">&#34;strings&#34;</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4861735">&#34;time&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4861743">&#34;unicode&#34;</span><br>
<span class="lineno"></span><span class="op" id="4861753">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4861756">var</span>&nbsp;<span class="ident" id="4861760">debug</span>&nbsp;<span class="op" id="4861766">=</span>&nbsp;<span class="ident" id="4861768">debugT</span><span class="op" id="4861774">(</span><span class="builtintype" id="4861775">false</span><span class="op" id="4861780">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="4861783">type</span>&nbsp;<span class="ident" id="4861788">debugT</span>&nbsp;<span class="builtintype" id="4861795">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4861801">func</span>&nbsp;<span class="op" id="4861806">(</span><span class="ident" id="4861807">d</span>&nbsp;<span class="ident" id="4861809">debugT</span><span class="op" id="4861815">)</span>&nbsp;<span class="ident" id="4861817">Printf</span><span class="op" id="4861823">(</span><span class="ident" id="4861824">format</span>&nbsp;<span class="builtintype" id="4861831">string</span><span class="op" id="4861837">,</span>&nbsp;<span class="ident" id="4861839">args</span>&nbsp;<span class="op" id="4861844">...</span><span class="keyword" id="4861847">interface</span><span class="op" id="4861856">{</span><span class="op" id="4861857">}</span><span class="op" id="4861858">)</span>&nbsp;<span class="op" id="4861860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4861863">if</span>&nbsp;<span class="ident" id="4861866">d</span>&nbsp;<span class="op" id="4861868">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4861872">log</span><span class="op" id="4861875">.</span><span class="ident" id="4861876">Printf</span><span class="op" id="4861882">(</span><span class="ident" id="4861883">format</span><span class="op" id="4861889">,</span>&nbsp;<span class="ident" id="4861891">args</span><span class="op" id="4861895">...</span><span class="op" id="4861898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4861901">}</span><br>
<span class="lineno"></span><span class="op" id="4861903">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4861906">//&nbsp;A&nbsp;Message&nbsp;represents&nbsp;a&nbsp;parsed&nbsp;mail&nbsp;message.</span><br>
<span class="lineno">45</span><span class="keyword" id="4861953">type</span>&nbsp;<span class="ident" id="4861958">Message</span>&nbsp;<span class="keyword" id="4861966">struct</span>&nbsp;<span class="op" id="4861973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4861976">Header</span>&nbsp;<span class="ident" id="4861983">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4861991">Body</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4861998">io</span><span class="op" id="4862000">.</span><span class="ident" id="4862001">Reader</span><br>
<span class="lineno"></span><span class="op" id="4862008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="4862011">//&nbsp;ReadMessage&nbsp;reads&nbsp;a&nbsp;message&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="comment" id="4862050">//&nbsp;The&nbsp;headers&nbsp;are&nbsp;parsed,&nbsp;and&nbsp;the&nbsp;body&nbsp;of&nbsp;the&nbsp;message&nbsp;will&nbsp;be&nbsp;available</span><br>
<span class="lineno"></span><span class="comment" id="4862123">//&nbsp;for&nbsp;reading&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="4862146">func</span>&nbsp;<span class="ident" id="4862151">ReadMessage</span><span class="op" id="4862162">(</span><span class="ident" id="4862163">r</span>&nbsp;<span class="ident" id="4862165">io</span><span class="op" id="4862167">.</span><span class="ident" id="4862168">Reader</span><span class="op" id="4862174">)</span>&nbsp;<span class="op" id="4862176">(</span><span class="ident" id="4862177">msg</span>&nbsp;<span class="op" id="4862181">*</span><span class="ident" id="4862182">Message</span><span class="op" id="4862189">,</span>&nbsp;<span class="ident" id="4862191">err</span>&nbsp;<span class="builtintype" id="4862195">error</span><span class="op" id="4862200">)</span>&nbsp;<span class="op" id="4862202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4862205">tp</span>&nbsp;<span class="op" id="4862208">:=</span>&nbsp;<span class="ident" id="4862211">textproto</span><span class="op" id="4862220">.</span><span class="ident" id="4862221">NewReader</span><span class="op" id="4862230">(</span><span class="ident" id="4862231">bufio</span><span class="op" id="4862236">.</span><span class="ident" id="4862237">NewReader</span><span class="op" id="4862246">(</span><span class="ident" id="4862247">r</span><span class="op" id="4862248">)</span><span class="op" id="4862249">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4862253">hdr</span><span class="op" id="4862256">,</span>&nbsp;<span class="ident" id="4862258">err</span>&nbsp;<span class="op" id="4862262">:=</span>&nbsp;<span class="ident" id="4862265">tp</span><span class="op" id="4862267">.</span><span class="ident" id="4862268">ReadMIMEHeader</span><span class="op" id="4862282">(</span><span class="op" id="4862283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4862286">if</span>&nbsp;<span class="ident" id="4862289">err</span>&nbsp;<span class="op" id="4862293">!=</span>&nbsp;<span class="builtintype" id="4862296">nil</span>&nbsp;<span class="op" id="4862300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4862304">return</span>&nbsp;<span class="builtintype" id="4862311">nil</span><span class="op" id="4862314">,</span>&nbsp;<span class="ident" id="4862316">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4862321">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4862325">return</span>&nbsp;<span class="op" id="4862332">&amp;</span><span class="ident" id="4862333">Message</span><span class="op" id="4862340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4862344">Header</span><span class="op" id="4862350">:</span>&nbsp;<span class="ident" id="4862352">Header</span><span class="op" id="4862358">(</span><span class="ident" id="4862359">hdr</span><span class="op" id="4862362">)</span><span class="op" id="4862363">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4862367">Body</span><span class="op" id="4862371">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4862375">tp</span><span class="op" id="4862377">.</span><span class="ident" id="4862378">R</span><span class="op" id="4862379">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4862382">}</span><span class="op" id="4862383">,</span>&nbsp;<span class="builtintype" id="4862385">nil</span><br>
<span class="lineno">65</span><span class="op" id="4862389">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4862392">//&nbsp;Layouts&nbsp;suitable&nbsp;for&nbsp;passing&nbsp;to&nbsp;time.Parse.</span><br>
<span class="lineno"></span><span class="comment" id="4862439">//&nbsp;These&nbsp;are&nbsp;tried&nbsp;in&nbsp;order.</span><br>
<span class="lineno"></span><span class="keyword" id="4862468">var</span>&nbsp;<span class="ident" id="4862472">dateLayouts</span>&nbsp;<span class="op" id="4862484">[</span><span class="op" id="4862485">]</span><span class="builtintype" id="4862486">string</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="4862494">func</span>&nbsp;<span class="ident" id="4862499">init</span><span class="op" id="4862503">(</span><span class="op" id="4862504">)</span>&nbsp;<span class="op" id="4862506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4862509">//&nbsp;Generate&nbsp;layouts&nbsp;based&nbsp;on&nbsp;RFC&nbsp;5322,&nbsp;section&nbsp;3.3.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4862563">dows</span>&nbsp;<span class="op" id="4862568">:=</span>&nbsp;<span class="op" id="4862571">[</span><span class="op" id="4862572">...</span><span class="op" id="4862575">]</span><span class="builtintype" id="4862576">string</span><span class="op" id="4862582">{</span><span class="string" id="4862583">&#34;&#34;</span><span class="op" id="4862585">,</span>&nbsp;<span class="string" id="4862587">&#34;Mon,&nbsp;&#34;</span><span class="op" id="4862594">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4862598">//&nbsp;day-of-week</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4862614">days</span>&nbsp;<span class="op" id="4862619">:=</span>&nbsp;<span class="op" id="4862622">[</span><span class="op" id="4862623">...</span><span class="op" id="4862626">]</span><span class="builtintype" id="4862627">string</span><span class="op" id="4862633">{</span><span class="string" id="4862634">&#34;2&#34;</span><span class="op" id="4862637">,</span>&nbsp;<span class="string" id="4862639">&#34;02&#34;</span><span class="op" id="4862643">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4862649">//&nbsp;day&nbsp;=&nbsp;1*2DIGIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4862668">years</span>&nbsp;<span class="op" id="4862674">:=</span>&nbsp;<span class="op" id="4862677">[</span><span class="op" id="4862678">...</span><span class="op" id="4862681">]</span><span class="builtintype" id="4862682">string</span><span class="op" id="4862688">{</span><span class="string" id="4862689">&#34;2006&#34;</span><span class="op" id="4862695">,</span>&nbsp;<span class="string" id="4862697">&#34;06&#34;</span><span class="op" id="4862701">}</span>&nbsp;<span class="comment" id="4862703">//&nbsp;year&nbsp;=&nbsp;4*DIGIT&nbsp;/&nbsp;2*DIGIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4862732">seconds</span>&nbsp;<span class="op" id="4862740">:=</span>&nbsp;<span class="op" id="4862743">[</span><span class="op" id="4862744">...</span><span class="op" id="4862747">]</span><span class="builtintype" id="4862748">string</span><span class="op" id="4862754">{</span><span class="string" id="4862755">&#34;:05&#34;</span><span class="op" id="4862760">,</span>&nbsp;<span class="string" id="4862762">&#34;&#34;</span><span class="op" id="4862764">}</span>&nbsp;&nbsp;<span class="comment" id="4862767">//&nbsp;second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4862778">//&nbsp;&#34;-0700&nbsp;(MST)&#34;&nbsp;is&nbsp;not&nbsp;in&nbsp;RFC&nbsp;5322,&nbsp;but&nbsp;is&nbsp;common.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4862831">zones</span>&nbsp;<span class="op" id="4862837">:=</span>&nbsp;<span class="op" id="4862840">[</span><span class="op" id="4862841">...</span><span class="op" id="4862844">]</span><span class="builtintype" id="4862845">string</span><span class="op" id="4862851">{</span><span class="string" id="4862852">&#34;-0700&#34;</span><span class="op" id="4862859">,</span>&nbsp;<span class="string" id="4862861">&#34;MST&#34;</span><span class="op" id="4862866">,</span>&nbsp;<span class="string" id="4862868">&#34;-0700&nbsp;(MST)&#34;</span><span class="op" id="4862881">}</span>&nbsp;<span class="comment" id="4862883">//&nbsp;zone&nbsp;=&nbsp;((&#34;+&#34;&nbsp;/&nbsp;&#34;-&#34;)&nbsp;4DIGIT)&nbsp;/&nbsp;&#34;GMT&#34;&nbsp;/&nbsp;...</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4862930">for</span>&nbsp;<span class="ident" id="4862934">_</span><span class="op" id="4862935">,</span>&nbsp;<span class="ident" id="4862937">dow</span>&nbsp;<span class="op" id="4862941">:=</span>&nbsp;<span class="keyword" id="4862944">range</span>&nbsp;<span class="ident" id="4862950">dows</span>&nbsp;<span class="op" id="4862955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4862959">for</span>&nbsp;<span class="ident" id="4862963">_</span><span class="op" id="4862964">,</span>&nbsp;<span class="ident" id="4862966">day</span>&nbsp;<span class="op" id="4862970">:=</span>&nbsp;<span class="keyword" id="4862973">range</span>&nbsp;<span class="ident" id="4862979">days</span>&nbsp;<span class="op" id="4862984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4862989">for</span>&nbsp;<span class="ident" id="4862993">_</span><span class="op" id="4862994">,</span>&nbsp;<span class="ident" id="4862996">year</span>&nbsp;<span class="op" id="4863001">:=</span>&nbsp;<span class="keyword" id="4863004">range</span>&nbsp;<span class="ident" id="4863010">years</span>&nbsp;<span class="op" id="4863016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4863022">for</span>&nbsp;<span class="ident" id="4863026">_</span><span class="op" id="4863027">,</span>&nbsp;<span class="ident" id="4863029">second</span>&nbsp;<span class="op" id="4863036">:=</span>&nbsp;<span class="keyword" id="4863039">range</span>&nbsp;<span class="ident" id="4863045">seconds</span>&nbsp;<span class="op" id="4863053">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4863060">for</span>&nbsp;<span class="ident" id="4863064">_</span><span class="op" id="4863065">,</span>&nbsp;<span class="ident" id="4863067">zone</span>&nbsp;<span class="op" id="4863072">:=</span>&nbsp;<span class="keyword" id="4863075">range</span>&nbsp;<span class="ident" id="4863081">zones</span>&nbsp;<span class="op" id="4863087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4863095">s</span>&nbsp;<span class="op" id="4863097">:=</span>&nbsp;<span class="ident" id="4863100">dow</span>&nbsp;<span class="op" id="4863104">+</span>&nbsp;<span class="ident" id="4863106">day</span>&nbsp;<span class="op" id="4863110">+</span>&nbsp;<span class="string" id="4863112">&#34;&nbsp;Jan&nbsp;&#34;</span>&nbsp;<span class="op" id="4863120">+</span>&nbsp;<span class="ident" id="4863122">year</span>&nbsp;<span class="op" id="4863127">+</span>&nbsp;<span class="string" id="4863129">&#34;&nbsp;15:04&#34;</span>&nbsp;<span class="op" id="4863138">+</span>&nbsp;<span class="ident" id="4863140">second</span>&nbsp;<span class="op" id="4863147">+</span>&nbsp;<span class="string" id="4863149">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="4863153">+</span>&nbsp;<span class="ident" id="4863155">zone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4863166">dateLayouts</span>&nbsp;<span class="op" id="4863178">=</span>&nbsp;<span class="builtinfunc" id="4863180">append</span><span class="op" id="4863186">(</span><span class="ident" id="4863187">dateLayouts</span><span class="op" id="4863198">,</span>&nbsp;<span class="ident" id="4863200">s</span><span class="op" id="4863201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4863208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4863214">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4863219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4863223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4863226">}</span><br>
<span class="lineno"></span><span class="op" id="4863228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="4863231">func</span>&nbsp;<span class="ident" id="4863236">parseDate</span><span class="op" id="4863245">(</span><span class="ident" id="4863246">date</span>&nbsp;<span class="builtintype" id="4863251">string</span><span class="op" id="4863257">)</span>&nbsp;<span class="op" id="4863259">(</span><span class="ident" id="4863260">time</span><span class="op" id="4863264">.</span><span class="ident" id="4863265">Time</span><span class="op" id="4863269">,</span>&nbsp;<span class="builtintype" id="4863271">error</span><span class="op" id="4863276">)</span>&nbsp;<span class="op" id="4863278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4863281">for</span>&nbsp;<span class="ident" id="4863285">_</span><span class="op" id="4863286">,</span>&nbsp;<span class="ident" id="4863288">layout</span>&nbsp;<span class="op" id="4863295">:=</span>&nbsp;<span class="keyword" id="4863298">range</span>&nbsp;<span class="ident" id="4863304">dateLayouts</span>&nbsp;<span class="op" id="4863316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4863320">t</span><span class="op" id="4863321">,</span>&nbsp;<span class="ident" id="4863323">err</span>&nbsp;<span class="op" id="4863327">:=</span>&nbsp;<span class="ident" id="4863330">time</span><span class="op" id="4863334">.</span><span class="ident" id="4863335">Parse</span><span class="op" id="4863340">(</span><span class="ident" id="4863341">layout</span><span class="op" id="4863347">,</span>&nbsp;<span class="ident" id="4863349">date</span><span class="op" id="4863353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4863357">if</span>&nbsp;<span class="ident" id="4863360">err</span>&nbsp;<span class="op" id="4863364">==</span>&nbsp;<span class="builtintype" id="4863367">nil</span>&nbsp;<span class="op" id="4863371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4863376">return</span>&nbsp;<span class="ident" id="4863383">t</span><span class="op" id="4863384">,</span>&nbsp;<span class="builtintype" id="4863386">nil</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4863392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4863395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4863398">return</span>&nbsp;<span class="ident" id="4863405">time</span><span class="op" id="4863409">.</span><span class="ident" id="4863410">Time</span><span class="op" id="4863414">{</span><span class="op" id="4863415">}</span><span class="op" id="4863416">,</span>&nbsp;<span class="ident" id="4863418">errors</span><span class="op" id="4863424">.</span><span class="ident" id="4863425">New</span><span class="op" id="4863428">(</span><span class="string" id="4863429">&#34;mail:&nbsp;header&nbsp;could&nbsp;not&nbsp;be&nbsp;parsed&#34;</span><span class="op" id="4863463">)</span><br>
<span class="lineno"></span><span class="op" id="4863465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="4863468">//&nbsp;A&nbsp;Header&nbsp;represents&nbsp;the&nbsp;key-value&nbsp;pairs&nbsp;in&nbsp;a&nbsp;mail&nbsp;message&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="4863537">type</span>&nbsp;<span class="ident" id="4863542">Header</span>&nbsp;<span class="keyword" id="4863549">map</span><span class="op" id="4863552">[</span><span class="builtintype" id="4863553">string</span><span class="op" id="4863559">]</span><span class="op" id="4863560">[</span><span class="op" id="4863561">]</span><span class="builtintype" id="4863562">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4863570">//&nbsp;Get&nbsp;gets&nbsp;the&nbsp;first&nbsp;value&nbsp;associated&nbsp;with&nbsp;the&nbsp;given&nbsp;key.</span><br>
<span class="lineno"></span><span class="comment" id="4863629">//&nbsp;If&nbsp;there&nbsp;are&nbsp;no&nbsp;values&nbsp;associated&nbsp;with&nbsp;the&nbsp;key,&nbsp;Get&nbsp;returns&nbsp;&#34;&#34;.</span><br>
<span class="lineno">110</span><span class="keyword" id="4863696">func</span>&nbsp;<span class="op" id="4863701">(</span><span class="ident" id="4863702">h</span>&nbsp;<span class="ident" id="4863704">Header</span><span class="op" id="4863710">)</span>&nbsp;<span class="ident" id="4863712">Get</span><span class="op" id="4863715">(</span><span class="ident" id="4863716">key</span>&nbsp;<span class="builtintype" id="4863720">string</span><span class="op" id="4863726">)</span>&nbsp;<span class="builtintype" id="4863728">string</span>&nbsp;<span class="op" id="4863735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4863738">return</span>&nbsp;<span class="ident" id="4863745">textproto</span><span class="op" id="4863754">.</span><span class="ident" id="4863755">MIMEHeader</span><span class="op" id="4863765">(</span><span class="ident" id="4863766">h</span><span class="op" id="4863767">)</span><span class="op" id="4863768">.</span><span class="ident" id="4863769">Get</span><span class="op" id="4863772">(</span><span class="ident" id="4863773">key</span><span class="op" id="4863776">)</span><br>
<span class="lineno"></span><span class="op" id="4863778">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4863781">var</span>&nbsp;<span class="ident" id="4863785">ErrHeaderNotPresent</span>&nbsp;<span class="op" id="4863805">=</span>&nbsp;<span class="ident" id="4863807">errors</span><span class="op" id="4863813">.</span><span class="ident" id="4863814">New</span><span class="op" id="4863817">(</span><span class="string" id="4863818">&#34;mail:&nbsp;header&nbsp;not&nbsp;in&nbsp;message&#34;</span><span class="op" id="4863847">)</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="4863850">//&nbsp;Date&nbsp;parses&nbsp;the&nbsp;Date&nbsp;header&nbsp;field.</span><br>
<span class="lineno"></span><span class="keyword" id="4863888">func</span>&nbsp;<span class="op" id="4863893">(</span><span class="ident" id="4863894">h</span>&nbsp;<span class="ident" id="4863896">Header</span><span class="op" id="4863902">)</span>&nbsp;<span class="ident" id="4863904">Date</span><span class="op" id="4863908">(</span><span class="op" id="4863909">)</span>&nbsp;<span class="op" id="4863911">(</span><span class="ident" id="4863912">time</span><span class="op" id="4863916">.</span><span class="ident" id="4863917">Time</span><span class="op" id="4863921">,</span>&nbsp;<span class="builtintype" id="4863923">error</span><span class="op" id="4863928">)</span>&nbsp;<span class="op" id="4863930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4863933">hdr</span>&nbsp;<span class="op" id="4863937">:=</span>&nbsp;<span class="ident" id="4863940">h</span><span class="op" id="4863941">.</span><span class="ident" id="4863942">Get</span><span class="op" id="4863945">(</span><span class="string" id="4863946">&#34;Date&#34;</span><span class="op" id="4863952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4863955">if</span>&nbsp;<span class="ident" id="4863958">hdr</span>&nbsp;<span class="op" id="4863962">==</span>&nbsp;<span class="string" id="4863965">&#34;&#34;</span>&nbsp;<span class="op" id="4863968">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4863972">return</span>&nbsp;<span class="ident" id="4863979">time</span><span class="op" id="4863983">.</span><span class="ident" id="4863984">Time</span><span class="op" id="4863988">{</span><span class="op" id="4863989">}</span><span class="op" id="4863990">,</span>&nbsp;<span class="ident" id="4863992">ErrHeaderNotPresent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4864013">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4864016">return</span>&nbsp;<span class="ident" id="4864023">parseDate</span><span class="op" id="4864032">(</span><span class="ident" id="4864033">hdr</span><span class="op" id="4864036">)</span><br>
<span class="lineno"></span><span class="op" id="4864038">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="comment" id="4864041">//&nbsp;AddressList&nbsp;parses&nbsp;the&nbsp;named&nbsp;header&nbsp;field&nbsp;as&nbsp;a&nbsp;list&nbsp;of&nbsp;addresses.</span><br>
<span class="lineno"></span><span class="keyword" id="4864110">func</span>&nbsp;<span class="op" id="4864115">(</span><span class="ident" id="4864116">h</span>&nbsp;<span class="ident" id="4864118">Header</span><span class="op" id="4864124">)</span>&nbsp;<span class="ident" id="4864126">AddressList</span><span class="op" id="4864137">(</span><span class="ident" id="4864138">key</span>&nbsp;<span class="builtintype" id="4864142">string</span><span class="op" id="4864148">)</span>&nbsp;<span class="op" id="4864150">(</span><span class="op" id="4864151">[</span><span class="op" id="4864152">]</span><span class="op" id="4864153">*</span><span class="ident" id="4864154">Address</span><span class="op" id="4864161">,</span>&nbsp;<span class="builtintype" id="4864163">error</span><span class="op" id="4864168">)</span>&nbsp;<span class="op" id="4864170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4864173">hdr</span>&nbsp;<span class="op" id="4864177">:=</span>&nbsp;<span class="ident" id="4864180">h</span><span class="op" id="4864181">.</span><span class="ident" id="4864182">Get</span><span class="op" id="4864185">(</span><span class="ident" id="4864186">key</span><span class="op" id="4864189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4864192">if</span>&nbsp;<span class="ident" id="4864195">hdr</span>&nbsp;<span class="op" id="4864199">==</span>&nbsp;<span class="string" id="4864202">&#34;&#34;</span>&nbsp;<span class="op" id="4864205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4864209">return</span>&nbsp;<span class="builtintype" id="4864216">nil</span><span class="op" id="4864219">,</span>&nbsp;<span class="ident" id="4864221">ErrHeaderNotPresent</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4864242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4864245">return</span>&nbsp;<span class="ident" id="4864252">ParseAddressList</span><span class="op" id="4864268">(</span><span class="ident" id="4864269">hdr</span><span class="op" id="4864272">)</span><br>
<span class="lineno"></span><span class="op" id="4864274">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4864277">//&nbsp;Address&nbsp;represents&nbsp;a&nbsp;single&nbsp;mail&nbsp;address.</span><br>
<span class="lineno">135</span><span class="comment" id="4864322">//&nbsp;An&nbsp;address&nbsp;such&nbsp;as&nbsp;&#34;Barry&nbsp;Gibbs&nbsp;&lt;bg@example.com&gt;&#34;&nbsp;is&nbsp;represented</span><br>
<span class="lineno"></span><span class="comment" id="4864390">//&nbsp;as&nbsp;Address{Name:&nbsp;&#34;Barry&nbsp;Gibbs&#34;,&nbsp;Address:&nbsp;&#34;bg@example.com&#34;}.</span><br>
<span class="lineno"></span><span class="keyword" id="4864453">type</span>&nbsp;<span class="ident" id="4864458">Address</span>&nbsp;<span class="keyword" id="4864466">struct</span>&nbsp;<span class="op" id="4864473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4864476">Name</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4864484">string</span>&nbsp;<span class="comment" id="4864491">//&nbsp;Proper&nbsp;name;&nbsp;may&nbsp;be&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4864522">Address</span>&nbsp;<span class="builtintype" id="4864530">string</span>&nbsp;<span class="comment" id="4864537">//&nbsp;user@domain</span><br>
<span class="lineno">140</span><span class="op" id="4864552">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4864555">//&nbsp;Parses&nbsp;a&nbsp;single&nbsp;RFC&nbsp;5322&nbsp;address,&nbsp;e.g.&nbsp;&#34;Barry&nbsp;Gibbs&nbsp;&lt;bg@example.com&gt;&#34;</span><br>
<span class="lineno"></span><span class="keyword" id="4864628">func</span>&nbsp;<span class="ident" id="4864633">ParseAddress</span><span class="op" id="4864645">(</span><span class="ident" id="4864646">address</span>&nbsp;<span class="builtintype" id="4864654">string</span><span class="op" id="4864660">)</span>&nbsp;<span class="op" id="4864662">(</span><span class="op" id="4864663">*</span><span class="ident" id="4864664">Address</span><span class="op" id="4864671">,</span>&nbsp;<span class="builtintype" id="4864673">error</span><span class="op" id="4864678">)</span>&nbsp;<span class="op" id="4864680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4864683">return</span>&nbsp;<span class="ident" id="4864690">newAddrParser</span><span class="op" id="4864703">(</span><span class="ident" id="4864704">address</span><span class="op" id="4864711">)</span><span class="op" id="4864712">.</span><span class="ident" id="4864713">parseAddress</span><span class="op" id="4864725">(</span><span class="op" id="4864726">)</span><br>
<span class="lineno">145</span><span class="op" id="4864728">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4864731">//&nbsp;ParseAddressList&nbsp;parses&nbsp;the&nbsp;given&nbsp;string&nbsp;as&nbsp;a&nbsp;list&nbsp;of&nbsp;addresses.</span><br>
<span class="lineno"></span><span class="keyword" id="4864799">func</span>&nbsp;<span class="ident" id="4864804">ParseAddressList</span><span class="op" id="4864820">(</span><span class="ident" id="4864821">list</span>&nbsp;<span class="builtintype" id="4864826">string</span><span class="op" id="4864832">)</span>&nbsp;<span class="op" id="4864834">(</span><span class="op" id="4864835">[</span><span class="op" id="4864836">]</span><span class="op" id="4864837">*</span><span class="ident" id="4864838">Address</span><span class="op" id="4864845">,</span>&nbsp;<span class="builtintype" id="4864847">error</span><span class="op" id="4864852">)</span>&nbsp;<span class="op" id="4864854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4864857">return</span>&nbsp;<span class="ident" id="4864864">newAddrParser</span><span class="op" id="4864877">(</span><span class="ident" id="4864878">list</span><span class="op" id="4864882">)</span><span class="op" id="4864883">.</span><span class="ident" id="4864884">parseAddressList</span><span class="op" id="4864900">(</span><span class="op" id="4864901">)</span><br>
<span class="lineno">150</span><span class="op" id="4864903">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4864906">//&nbsp;String&nbsp;formats&nbsp;the&nbsp;address&nbsp;as&nbsp;a&nbsp;valid&nbsp;RFC&nbsp;5322&nbsp;address.</span><br>
<span class="lineno"></span><span class="comment" id="4864965">//&nbsp;If&nbsp;the&nbsp;address&#39;s&nbsp;name&nbsp;contains&nbsp;non-ASCII&nbsp;characters</span><br>
<span class="lineno"></span><span class="comment" id="4865020">//&nbsp;the&nbsp;name&nbsp;will&nbsp;be&nbsp;rendered&nbsp;according&nbsp;to&nbsp;RFC&nbsp;2047.</span><br>
<span class="lineno">155</span><span class="keyword" id="4865072">func</span>&nbsp;<span class="op" id="4865077">(</span><span class="ident" id="4865078">a</span>&nbsp;<span class="op" id="4865080">*</span><span class="ident" id="4865081">Address</span><span class="op" id="4865088">)</span>&nbsp;<span class="ident" id="4865090">String</span><span class="op" id="4865096">(</span><span class="op" id="4865097">)</span>&nbsp;<span class="builtintype" id="4865099">string</span>&nbsp;<span class="op" id="4865106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4865109">s</span>&nbsp;<span class="op" id="4865111">:=</span>&nbsp;<span class="string" id="4865114">&#34;&lt;&#34;</span>&nbsp;<span class="op" id="4865118">+</span>&nbsp;<span class="ident" id="4865120">a</span><span class="op" id="4865121">.</span><span class="ident" id="4865122">Address</span>&nbsp;<span class="op" id="4865130">+</span>&nbsp;<span class="string" id="4865132">&#34;&gt;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4865137">if</span>&nbsp;<span class="ident" id="4865140">a</span><span class="op" id="4865141">.</span><span class="ident" id="4865142">Name</span>&nbsp;<span class="op" id="4865147">==</span>&nbsp;<span class="string" id="4865150">&#34;&#34;</span>&nbsp;<span class="op" id="4865153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4865157">return</span>&nbsp;<span class="ident" id="4865164">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4865167">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4865170">//&nbsp;If&nbsp;every&nbsp;character&nbsp;is&nbsp;printable&nbsp;ASCII,&nbsp;quoting&nbsp;is&nbsp;simple.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4865232">allPrintable</span>&nbsp;<span class="op" id="4865245">:=</span>&nbsp;<span class="builtintype" id="4865248">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4865254">for</span>&nbsp;<span class="ident" id="4865258">i</span>&nbsp;<span class="op" id="4865260">:=</span>&nbsp;<span class="num" id="4865263">0</span><span class="op" id="4865264">;</span>&nbsp;<span class="ident" id="4865266">i</span>&nbsp;<span class="op" id="4865268">&lt;</span>&nbsp;<span class="builtinfunc" id="4865270">len</span><span class="op" id="4865273">(</span><span class="ident" id="4865274">a</span><span class="op" id="4865275">.</span><span class="ident" id="4865276">Name</span><span class="op" id="4865280">)</span><span class="op" id="4865281">;</span>&nbsp;<span class="ident" id="4865283">i</span><span class="op" id="4865284">++</span>&nbsp;<span class="op" id="4865287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4865291">//&nbsp;isWSP&nbsp;here&nbsp;should&nbsp;actually&nbsp;be&nbsp;isFWS,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4865333">//&nbsp;but&nbsp;we&nbsp;don&#39;t&nbsp;support&nbsp;folding&nbsp;yet.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4865372">if</span>&nbsp;<span class="op" id="4865375">!</span><span class="ident" id="4865376">isVchar</span><span class="op" id="4865383">(</span><span class="ident" id="4865384">a</span><span class="op" id="4865385">.</span><span class="ident" id="4865386">Name</span><span class="op" id="4865390">[</span><span class="ident" id="4865391">i</span><span class="op" id="4865392">]</span><span class="op" id="4865393">)</span>&nbsp;<span class="op" id="4865395">&amp;&amp;</span>&nbsp;<span class="op" id="4865398">!</span><span class="ident" id="4865399">isWSP</span><span class="op" id="4865404">(</span><span class="ident" id="4865405">a</span><span class="op" id="4865406">.</span><span class="ident" id="4865407">Name</span><span class="op" id="4865411">[</span><span class="ident" id="4865412">i</span><span class="op" id="4865413">]</span><span class="op" id="4865414">)</span>&nbsp;<span class="op" id="4865416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4865421">allPrintable</span>&nbsp;<span class="op" id="4865434">=</span>&nbsp;<span class="builtintype" id="4865436">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4865445">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4865453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4865456">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4865459">if</span>&nbsp;<span class="ident" id="4865462">allPrintable</span>&nbsp;<span class="op" id="4865475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4865479">b</span>&nbsp;<span class="op" id="4865481">:=</span>&nbsp;<span class="ident" id="4865484">bytes</span><span class="op" id="4865489">.</span><span class="ident" id="4865490">NewBufferString</span><span class="op" id="4865505">(</span><span class="string" id="4865506">`&#34;`</span><span class="op" id="4865509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4865513">for</span>&nbsp;<span class="ident" id="4865517">i</span>&nbsp;<span class="op" id="4865519">:=</span>&nbsp;<span class="num" id="4865522">0</span><span class="op" id="4865523">;</span>&nbsp;<span class="ident" id="4865525">i</span>&nbsp;<span class="op" id="4865527">&lt;</span>&nbsp;<span class="builtinfunc" id="4865529">len</span><span class="op" id="4865532">(</span><span class="ident" id="4865533">a</span><span class="op" id="4865534">.</span><span class="ident" id="4865535">Name</span><span class="op" id="4865539">)</span><span class="op" id="4865540">;</span>&nbsp;<span class="ident" id="4865542">i</span><span class="op" id="4865543">++</span>&nbsp;<span class="op" id="4865546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4865551">if</span>&nbsp;<span class="op" id="4865554">!</span><span class="ident" id="4865555">isQtext</span><span class="op" id="4865562">(</span><span class="ident" id="4865563">a</span><span class="op" id="4865564">.</span><span class="ident" id="4865565">Name</span><span class="op" id="4865569">[</span><span class="ident" id="4865570">i</span><span class="op" id="4865571">]</span><span class="op" id="4865572">)</span>&nbsp;<span class="op" id="4865574">&amp;&amp;</span>&nbsp;<span class="op" id="4865577">!</span><span class="ident" id="4865578">isWSP</span><span class="op" id="4865583">(</span><span class="ident" id="4865584">a</span><span class="op" id="4865585">.</span><span class="ident" id="4865586">Name</span><span class="op" id="4865590">[</span><span class="ident" id="4865591">i</span><span class="op" id="4865592">]</span><span class="op" id="4865593">)</span>&nbsp;<span class="op" id="4865595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4865601">b</span><span class="op" id="4865602">.</span><span class="ident" id="4865603">WriteByte</span><span class="op" id="4865612">(</span><span class="string" id="4865613">&#39;\\&#39;</span><span class="op" id="4865617">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4865622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4865627">b</span><span class="op" id="4865628">.</span><span class="ident" id="4865629">WriteByte</span><span class="op" id="4865638">(</span><span class="ident" id="4865639">a</span><span class="op" id="4865640">.</span><span class="ident" id="4865641">Name</span><span class="op" id="4865645">[</span><span class="ident" id="4865646">i</span><span class="op" id="4865647">]</span><span class="op" id="4865648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4865652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4865656">b</span><span class="op" id="4865657">.</span><span class="ident" id="4865658">WriteString</span><span class="op" id="4865669">(</span><span class="string" id="4865670">`&#34;&nbsp;`</span><span class="op" id="4865674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4865678">b</span><span class="op" id="4865679">.</span><span class="ident" id="4865680">WriteString</span><span class="op" id="4865691">(</span><span class="ident" id="4865692">s</span><span class="op" id="4865693">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4865697">return</span>&nbsp;<span class="ident" id="4865704">b</span><span class="op" id="4865705">.</span><span class="ident" id="4865706">String</span><span class="op" id="4865712">(</span><span class="op" id="4865713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4865716">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4865720">//&nbsp;UTF-8&nbsp;&#34;Q&#34;&nbsp;encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4865743">b</span>&nbsp;<span class="op" id="4865745">:=</span>&nbsp;<span class="ident" id="4865748">bytes</span><span class="op" id="4865753">.</span><span class="ident" id="4865754">NewBufferString</span><span class="op" id="4865769">(</span><span class="string" id="4865770">&#34;=?utf-8?q?&#34;</span><span class="op" id="4865782">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4865785">for</span>&nbsp;<span class="ident" id="4865789">i</span>&nbsp;<span class="op" id="4865791">:=</span>&nbsp;<span class="num" id="4865794">0</span><span class="op" id="4865795">;</span>&nbsp;<span class="ident" id="4865797">i</span>&nbsp;<span class="op" id="4865799">&lt;</span>&nbsp;<span class="builtinfunc" id="4865801">len</span><span class="op" id="4865804">(</span><span class="ident" id="4865805">a</span><span class="op" id="4865806">.</span><span class="ident" id="4865807">Name</span><span class="op" id="4865811">)</span><span class="op" id="4865812">;</span>&nbsp;<span class="ident" id="4865814">i</span><span class="op" id="4865815">++</span>&nbsp;<span class="op" id="4865818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4865822">switch</span>&nbsp;<span class="ident" id="4865829">c</span>&nbsp;<span class="op" id="4865831">:=</span>&nbsp;<span class="ident" id="4865834">a</span><span class="op" id="4865835">.</span><span class="ident" id="4865836">Name</span><span class="op" id="4865840">[</span><span class="ident" id="4865841">i</span><span class="op" id="4865842">]</span><span class="op" id="4865843">;</span>&nbsp;<span class="op" id="4865845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4865849">case</span>&nbsp;<span class="ident" id="4865854">c</span>&nbsp;<span class="op" id="4865856">==</span>&nbsp;<span class="string" id="4865859">&#39;&nbsp;&#39;</span><span class="op" id="4865862">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4865867">b</span><span class="op" id="4865868">.</span><span class="ident" id="4865869">WriteByte</span><span class="op" id="4865878">(</span><span class="string" id="4865879">&#39;_&#39;</span><span class="op" id="4865882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4865886">case</span>&nbsp;<span class="ident" id="4865891">isVchar</span><span class="op" id="4865898">(</span><span class="ident" id="4865899">c</span><span class="op" id="4865900">)</span>&nbsp;<span class="op" id="4865902">&amp;&amp;</span>&nbsp;<span class="ident" id="4865905">c</span>&nbsp;<span class="op" id="4865907">!=</span>&nbsp;<span class="string" id="4865910">&#39;=&#39;</span>&nbsp;<span class="op" id="4865914">&amp;&amp;</span>&nbsp;<span class="ident" id="4865917">c</span>&nbsp;<span class="op" id="4865919">!=</span>&nbsp;<span class="string" id="4865922">&#39;?&#39;</span>&nbsp;<span class="op" id="4865926">&amp;&amp;</span>&nbsp;<span class="ident" id="4865929">c</span>&nbsp;<span class="op" id="4865931">!=</span>&nbsp;<span class="string" id="4865934">&#39;_&#39;</span><span class="op" id="4865937">:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4865942">b</span><span class="op" id="4865943">.</span><span class="ident" id="4865944">WriteByte</span><span class="op" id="4865953">(</span><span class="ident" id="4865954">c</span><span class="op" id="4865955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4865959">default</span><span class="op" id="4865966">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4865971">fmt</span><span class="op" id="4865974">.</span><span class="ident" id="4865975">Fprintf</span><span class="op" id="4865982">(</span><span class="ident" id="4865983">b</span><span class="op" id="4865984">,</span>&nbsp;<span class="string" id="4865986">&#34;=%02X&#34;</span><span class="op" id="4865993">,</span>&nbsp;<span class="ident" id="4865995">c</span><span class="op" id="4865996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4866000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4866003">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4866006">b</span><span class="op" id="4866007">.</span><span class="ident" id="4866008">WriteString</span><span class="op" id="4866019">(</span><span class="string" id="4866020">&#34;?=&nbsp;&#34;</span><span class="op" id="4866025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4866028">b</span><span class="op" id="4866029">.</span><span class="ident" id="4866030">WriteString</span><span class="op" id="4866041">(</span><span class="ident" id="4866042">s</span><span class="op" id="4866043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4866046">return</span>&nbsp;<span class="ident" id="4866053">b</span><span class="op" id="4866054">.</span><span class="ident" id="4866055">String</span><span class="op" id="4866061">(</span><span class="op" id="4866062">)</span><br>
<span class="lineno"></span><span class="op" id="4866064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span><span class="keyword" id="4866067">type</span>&nbsp;<span class="ident" id="4866072">addrParser</span>&nbsp;<span class="op" id="4866083">[</span><span class="op" id="4866084">]</span><span class="builtintype" id="4866085">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4866091">func</span>&nbsp;<span class="ident" id="4866096">newAddrParser</span><span class="op" id="4866109">(</span><span class="ident" id="4866110">s</span>&nbsp;<span class="builtintype" id="4866112">string</span><span class="op" id="4866118">)</span>&nbsp;<span class="op" id="4866120">*</span><span class="ident" id="4866121">addrParser</span>&nbsp;<span class="op" id="4866132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4866135">p</span>&nbsp;<span class="op" id="4866137">:=</span>&nbsp;<span class="ident" id="4866140">addrParser</span><span class="op" id="4866150">(</span><span class="ident" id="4866151">s</span><span class="op" id="4866152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4866155">return</span>&nbsp;<span class="op" id="4866162">&amp;</span><span class="ident" id="4866163">p</span><br>
<span class="lineno">205</span><span class="op" id="4866165">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4866168">func</span>&nbsp;<span class="op" id="4866173">(</span><span class="ident" id="4866174">p</span>&nbsp;<span class="op" id="4866176">*</span><span class="ident" id="4866177">addrParser</span><span class="op" id="4866187">)</span>&nbsp;<span class="ident" id="4866189">parseAddressList</span><span class="op" id="4866205">(</span><span class="op" id="4866206">)</span>&nbsp;<span class="op" id="4866208">(</span><span class="op" id="4866209">[</span><span class="op" id="4866210">]</span><span class="op" id="4866211">*</span><span class="ident" id="4866212">Address</span><span class="op" id="4866219">,</span>&nbsp;<span class="builtintype" id="4866221">error</span><span class="op" id="4866226">)</span>&nbsp;<span class="op" id="4866228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4866231">var</span>&nbsp;<span class="ident" id="4866235">list</span>&nbsp;<span class="op" id="4866240">[</span><span class="op" id="4866241">]</span><span class="op" id="4866242">*</span><span class="ident" id="4866243">Address</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4866252">for</span>&nbsp;<span class="op" id="4866256">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4866260">p</span><span class="op" id="4866261">.</span><span class="ident" id="4866262">skipSpace</span><span class="op" id="4866271">(</span><span class="op" id="4866272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4866276">addr</span><span class="op" id="4866280">,</span>&nbsp;<span class="ident" id="4866282">err</span>&nbsp;<span class="op" id="4866286">:=</span>&nbsp;<span class="ident" id="4866289">p</span><span class="op" id="4866290">.</span><span class="ident" id="4866291">parseAddress</span><span class="op" id="4866303">(</span><span class="op" id="4866304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4866308">if</span>&nbsp;<span class="ident" id="4866311">err</span>&nbsp;<span class="op" id="4866315">!=</span>&nbsp;<span class="builtintype" id="4866318">nil</span>&nbsp;<span class="op" id="4866322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4866327">return</span>&nbsp;<span class="builtintype" id="4866334">nil</span><span class="op" id="4866337">,</span>&nbsp;<span class="ident" id="4866339">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4866345">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4866349">list</span>&nbsp;<span class="op" id="4866354">=</span>&nbsp;<span class="builtinfunc" id="4866356">append</span><span class="op" id="4866362">(</span><span class="ident" id="4866363">list</span><span class="op" id="4866367">,</span>&nbsp;<span class="ident" id="4866369">addr</span><span class="op" id="4866373">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4866378">p</span><span class="op" id="4866379">.</span><span class="ident" id="4866380">skipSpace</span><span class="op" id="4866389">(</span><span class="op" id="4866390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4866394">if</span>&nbsp;<span class="ident" id="4866397">p</span><span class="op" id="4866398">.</span><span class="ident" id="4866399">empty</span><span class="op" id="4866404">(</span><span class="op" id="4866405">)</span>&nbsp;<span class="op" id="4866407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4866412">break</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4866420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4866424">if</span>&nbsp;<span class="op" id="4866427">!</span><span class="ident" id="4866428">p</span><span class="op" id="4866429">.</span><span class="ident" id="4866430">consume</span><span class="op" id="4866437">(</span><span class="string" id="4866438">&#39;,&#39;</span><span class="op" id="4866441">)</span>&nbsp;<span class="op" id="4866443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4866448">return</span>&nbsp;<span class="builtintype" id="4866455">nil</span><span class="op" id="4866458">,</span>&nbsp;<span class="ident" id="4866460">errors</span><span class="op" id="4866466">.</span><span class="ident" id="4866467">New</span><span class="op" id="4866470">(</span><span class="string" id="4866471">&#34;mail:&nbsp;expected&nbsp;comma&#34;</span><span class="op" id="4866493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4866497">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4866500">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4866503">return</span>&nbsp;<span class="ident" id="4866510">list</span><span class="op" id="4866514">,</span>&nbsp;<span class="builtintype" id="4866516">nil</span><br>
<span class="lineno"></span><span class="op" id="4866520">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4866523">//&nbsp;parseAddress&nbsp;parses&nbsp;a&nbsp;single&nbsp;RFC&nbsp;5322&nbsp;address&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="4866591">func</span>&nbsp;<span class="op" id="4866596">(</span><span class="ident" id="4866597">p</span>&nbsp;<span class="op" id="4866599">*</span><span class="ident" id="4866600">addrParser</span><span class="op" id="4866610">)</span>&nbsp;<span class="ident" id="4866612">parseAddress</span><span class="op" id="4866624">(</span><span class="op" id="4866625">)</span>&nbsp;<span class="op" id="4866627">(</span><span class="ident" id="4866628">addr</span>&nbsp;<span class="op" id="4866633">*</span><span class="ident" id="4866634">Address</span><span class="op" id="4866641">,</span>&nbsp;<span class="ident" id="4866643">err</span>&nbsp;<span class="builtintype" id="4866647">error</span><span class="op" id="4866652">)</span>&nbsp;<span class="op" id="4866654">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4866657">debug</span><span class="op" id="4866662">.</span><span class="ident" id="4866663">Printf</span><span class="op" id="4866669">(</span><span class="string" id="4866670">&#34;parseAddress:&nbsp;%q&#34;</span><span class="op" id="4866688">,</span>&nbsp;<span class="op" id="4866690">*</span><span class="ident" id="4866691">p</span><span class="op" id="4866692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4866695">p</span><span class="op" id="4866696">.</span><span class="ident" id="4866697">skipSpace</span><span class="op" id="4866706">(</span><span class="op" id="4866707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4866710">if</span>&nbsp;<span class="ident" id="4866713">p</span><span class="op" id="4866714">.</span><span class="ident" id="4866715">empty</span><span class="op" id="4866720">(</span><span class="op" id="4866721">)</span>&nbsp;<span class="op" id="4866723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4866727">return</span>&nbsp;<span class="builtintype" id="4866734">nil</span><span class="op" id="4866737">,</span>&nbsp;<span class="ident" id="4866739">errors</span><span class="op" id="4866745">.</span><span class="ident" id="4866746">New</span><span class="op" id="4866749">(</span><span class="string" id="4866750">&#34;mail:&nbsp;no&nbsp;address&#34;</span><span class="op" id="4866768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4866771">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4866775">//&nbsp;address&nbsp;=&nbsp;name-addr&nbsp;/&nbsp;addr-spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4866811">//&nbsp;TODO(dsymonds):&nbsp;Support&nbsp;parsing&nbsp;group&nbsp;address.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4866863">//&nbsp;addr-spec&nbsp;has&nbsp;a&nbsp;more&nbsp;restricted&nbsp;grammar&nbsp;than&nbsp;name-addr,</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4866923">//&nbsp;so&nbsp;try&nbsp;parsing&nbsp;it&nbsp;first,&nbsp;and&nbsp;fallback&nbsp;to&nbsp;name-addr.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4866979">//&nbsp;TODO(dsymonds):&nbsp;Is&nbsp;this&nbsp;really&nbsp;correct?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4867023">spec</span><span class="op" id="4867027">,</span>&nbsp;<span class="ident" id="4867029">err</span>&nbsp;<span class="op" id="4867033">:=</span>&nbsp;<span class="ident" id="4867036">p</span><span class="op" id="4867037">.</span><span class="ident" id="4867038">consumeAddrSpec</span><span class="op" id="4867053">(</span><span class="op" id="4867054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4867057">if</span>&nbsp;<span class="ident" id="4867060">err</span>&nbsp;<span class="op" id="4867064">==</span>&nbsp;<span class="builtintype" id="4867067">nil</span>&nbsp;<span class="op" id="4867071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4867075">return</span>&nbsp;<span class="op" id="4867082">&amp;</span><span class="ident" id="4867083">Address</span><span class="op" id="4867090">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4867095">Address</span><span class="op" id="4867102">:</span>&nbsp;<span class="ident" id="4867104">spec</span><span class="op" id="4867108">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4867112">}</span><span class="op" id="4867113">,</span>&nbsp;<span class="ident" id="4867115">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4867120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4867123">debug</span><span class="op" id="4867128">.</span><span class="ident" id="4867129">Printf</span><span class="op" id="4867135">(</span><span class="string" id="4867136">&#34;parseAddress:&nbsp;not&nbsp;an&nbsp;addr-spec:&nbsp;%v&#34;</span><span class="op" id="4867172">,</span>&nbsp;<span class="ident" id="4867174">err</span><span class="op" id="4867177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4867180">debug</span><span class="op" id="4867185">.</span><span class="ident" id="4867186">Printf</span><span class="op" id="4867192">(</span><span class="string" id="4867193">&#34;parseAddress:&nbsp;state&nbsp;is&nbsp;now&nbsp;%q&#34;</span><span class="op" id="4867224">,</span>&nbsp;<span class="op" id="4867226">*</span><span class="ident" id="4867227">p</span><span class="op" id="4867228">)</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4867232">//&nbsp;display-name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4867249">var</span>&nbsp;<span class="ident" id="4867253">displayName</span>&nbsp;<span class="builtintype" id="4867265">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4867273">if</span>&nbsp;<span class="ident" id="4867276">p</span><span class="op" id="4867277">.</span><span class="ident" id="4867278">peek</span><span class="op" id="4867282">(</span><span class="op" id="4867283">)</span>&nbsp;<span class="op" id="4867285">!=</span>&nbsp;<span class="string" id="4867288">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="4867292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4867296">displayName</span><span class="op" id="4867307">,</span>&nbsp;<span class="ident" id="4867309">err</span>&nbsp;<span class="op" id="4867313">=</span>&nbsp;<span class="ident" id="4867315">p</span><span class="op" id="4867316">.</span><span class="ident" id="4867317">consumePhrase</span><span class="op" id="4867330">(</span><span class="op" id="4867331">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4867335">if</span>&nbsp;<span class="ident" id="4867338">err</span>&nbsp;<span class="op" id="4867342">!=</span>&nbsp;<span class="builtintype" id="4867345">nil</span>&nbsp;<span class="op" id="4867349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4867354">return</span>&nbsp;<span class="builtintype" id="4867361">nil</span><span class="op" id="4867364">,</span>&nbsp;<span class="ident" id="4867366">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4867372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4867375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4867378">debug</span><span class="op" id="4867383">.</span><span class="ident" id="4867384">Printf</span><span class="op" id="4867390">(</span><span class="string" id="4867391">&#34;parseAddress:&nbsp;displayName=%q&#34;</span><span class="op" id="4867421">,</span>&nbsp;<span class="ident" id="4867423">displayName</span><span class="op" id="4867434">)</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4867438">//&nbsp;angle-addr&nbsp;=&nbsp;&#34;&lt;&#34;&nbsp;addr-spec&nbsp;&#34;&gt;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4867473">p</span><span class="op" id="4867474">.</span><span class="ident" id="4867475">skipSpace</span><span class="op" id="4867484">(</span><span class="op" id="4867485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4867488">if</span>&nbsp;<span class="op" id="4867491">!</span><span class="ident" id="4867492">p</span><span class="op" id="4867493">.</span><span class="ident" id="4867494">consume</span><span class="op" id="4867501">(</span><span class="string" id="4867502">&#39;&lt;&#39;</span><span class="op" id="4867505">)</span>&nbsp;<span class="op" id="4867507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4867511">return</span>&nbsp;<span class="builtintype" id="4867518">nil</span><span class="op" id="4867521">,</span>&nbsp;<span class="ident" id="4867523">errors</span><span class="op" id="4867529">.</span><span class="ident" id="4867530">New</span><span class="op" id="4867533">(</span><span class="string" id="4867534">&#34;mail:&nbsp;no&nbsp;angle-addr&#34;</span><span class="op" id="4867555">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4867558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4867561">spec</span><span class="op" id="4867565">,</span>&nbsp;<span class="ident" id="4867567">err</span>&nbsp;<span class="op" id="4867571">=</span>&nbsp;<span class="ident" id="4867573">p</span><span class="op" id="4867574">.</span><span class="ident" id="4867575">consumeAddrSpec</span><span class="op" id="4867590">(</span><span class="op" id="4867591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4867594">if</span>&nbsp;<span class="ident" id="4867597">err</span>&nbsp;<span class="op" id="4867601">!=</span>&nbsp;<span class="builtintype" id="4867604">nil</span>&nbsp;<span class="op" id="4867608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4867612">return</span>&nbsp;<span class="builtintype" id="4867619">nil</span><span class="op" id="4867622">,</span>&nbsp;<span class="ident" id="4867624">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4867629">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4867632">if</span>&nbsp;<span class="op" id="4867635">!</span><span class="ident" id="4867636">p</span><span class="op" id="4867637">.</span><span class="ident" id="4867638">consume</span><span class="op" id="4867645">(</span><span class="string" id="4867646">&#39;&gt;&#39;</span><span class="op" id="4867649">)</span>&nbsp;<span class="op" id="4867651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4867655">return</span>&nbsp;<span class="builtintype" id="4867662">nil</span><span class="op" id="4867665">,</span>&nbsp;<span class="ident" id="4867667">errors</span><span class="op" id="4867673">.</span><span class="ident" id="4867674">New</span><span class="op" id="4867677">(</span><span class="string" id="4867678">&#34;mail:&nbsp;unclosed&nbsp;angle-addr&#34;</span><span class="op" id="4867705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4867708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4867711">debug</span><span class="op" id="4867716">.</span><span class="ident" id="4867717">Printf</span><span class="op" id="4867723">(</span><span class="string" id="4867724">&#34;parseAddress:&nbsp;spec=%q&#34;</span><span class="op" id="4867747">,</span>&nbsp;<span class="ident" id="4867749">spec</span><span class="op" id="4867753">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4867757">return</span>&nbsp;<span class="op" id="4867764">&amp;</span><span class="ident" id="4867765">Address</span><span class="op" id="4867772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4867776">Name</span><span class="op" id="4867780">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4867785">displayName</span><span class="op" id="4867796">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4867800">Address</span><span class="op" id="4867807">:</span>&nbsp;<span class="ident" id="4867809">spec</span><span class="op" id="4867813">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4867816">}</span><span class="op" id="4867817">,</span>&nbsp;<span class="builtintype" id="4867819">nil</span><br>
<span class="lineno"></span><span class="op" id="4867823">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="4867826">//&nbsp;consumeAddrSpec&nbsp;parses&nbsp;a&nbsp;single&nbsp;RFC&nbsp;5322&nbsp;addr-spec&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="4867899">func</span>&nbsp;<span class="op" id="4867904">(</span><span class="ident" id="4867905">p</span>&nbsp;<span class="op" id="4867907">*</span><span class="ident" id="4867908">addrParser</span><span class="op" id="4867918">)</span>&nbsp;<span class="ident" id="4867920">consumeAddrSpec</span><span class="op" id="4867935">(</span><span class="op" id="4867936">)</span>&nbsp;<span class="op" id="4867938">(</span><span class="ident" id="4867939">spec</span>&nbsp;<span class="builtintype" id="4867944">string</span><span class="op" id="4867950">,</span>&nbsp;<span class="ident" id="4867952">err</span>&nbsp;<span class="builtintype" id="4867956">error</span><span class="op" id="4867961">)</span>&nbsp;<span class="op" id="4867963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4867966">debug</span><span class="op" id="4867971">.</span><span class="ident" id="4867972">Printf</span><span class="op" id="4867978">(</span><span class="string" id="4867979">&#34;consumeAddrSpec:&nbsp;%q&#34;</span><span class="op" id="4868000">,</span>&nbsp;<span class="op" id="4868002">*</span><span class="ident" id="4868003">p</span><span class="op" id="4868004">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4868008">orig</span>&nbsp;<span class="op" id="4868013">:=</span>&nbsp;<span class="op" id="4868016">*</span><span class="ident" id="4868017">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4868020">defer</span>&nbsp;<span class="keyword" id="4868026">func</span><span class="op" id="4868030">(</span><span class="op" id="4868031">)</span>&nbsp;<span class="op" id="4868033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4868037">if</span>&nbsp;<span class="ident" id="4868040">err</span>&nbsp;<span class="op" id="4868044">!=</span>&nbsp;<span class="builtintype" id="4868047">nil</span>&nbsp;<span class="op" id="4868051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4868056">*</span><span class="ident" id="4868057">p</span>&nbsp;<span class="op" id="4868059">=</span>&nbsp;<span class="ident" id="4868061">orig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4868068">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4868071">}</span><span class="op" id="4868072">(</span><span class="op" id="4868073">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4868077">//&nbsp;local-part&nbsp;=&nbsp;dot-atom&nbsp;/&nbsp;quoted-string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4868119">var</span>&nbsp;<span class="ident" id="4868123">localPart</span>&nbsp;<span class="builtintype" id="4868133">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4868141">p</span><span class="op" id="4868142">.</span><span class="ident" id="4868143">skipSpace</span><span class="op" id="4868152">(</span><span class="op" id="4868153">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4868156">if</span>&nbsp;<span class="ident" id="4868159">p</span><span class="op" id="4868160">.</span><span class="ident" id="4868161">empty</span><span class="op" id="4868166">(</span><span class="op" id="4868167">)</span>&nbsp;<span class="op" id="4868169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4868173">return</span>&nbsp;<span class="string" id="4868180">&#34;&#34;</span><span class="op" id="4868182">,</span>&nbsp;<span class="ident" id="4868184">errors</span><span class="op" id="4868190">.</span><span class="ident" id="4868191">New</span><span class="op" id="4868194">(</span><span class="string" id="4868195">&#34;mail:&nbsp;no&nbsp;addr-spec&#34;</span><span class="op" id="4868215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4868218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4868221">if</span>&nbsp;<span class="ident" id="4868224">p</span><span class="op" id="4868225">.</span><span class="ident" id="4868226">peek</span><span class="op" id="4868230">(</span><span class="op" id="4868231">)</span>&nbsp;<span class="op" id="4868233">==</span>&nbsp;<span class="string" id="4868236">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="4868240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4868244">//&nbsp;quoted-string</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4868263">debug</span><span class="op" id="4868268">.</span><span class="ident" id="4868269">Printf</span><span class="op" id="4868275">(</span><span class="string" id="4868276">&#34;consumeAddrSpec:&nbsp;parsing&nbsp;quoted-string&#34;</span><span class="op" id="4868316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4868320">localPart</span><span class="op" id="4868329">,</span>&nbsp;<span class="ident" id="4868331">err</span>&nbsp;<span class="op" id="4868335">=</span>&nbsp;<span class="ident" id="4868337">p</span><span class="op" id="4868338">.</span><span class="ident" id="4868339">consumeQuotedString</span><span class="op" id="4868358">(</span><span class="op" id="4868359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4868362">}</span>&nbsp;<span class="keyword" id="4868364">else</span>&nbsp;<span class="op" id="4868369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4868373">//&nbsp;dot-atom</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4868387">debug</span><span class="op" id="4868392">.</span><span class="ident" id="4868393">Printf</span><span class="op" id="4868399">(</span><span class="string" id="4868400">&#34;consumeAddrSpec:&nbsp;parsing&nbsp;dot-atom&#34;</span><span class="op" id="4868435">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4868439">localPart</span><span class="op" id="4868448">,</span>&nbsp;<span class="ident" id="4868450">err</span>&nbsp;<span class="op" id="4868454">=</span>&nbsp;<span class="ident" id="4868456">p</span><span class="op" id="4868457">.</span><span class="ident" id="4868458">consumeAtom</span><span class="op" id="4868469">(</span><span class="builtintype" id="4868470">true</span><span class="op" id="4868474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4868477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4868480">if</span>&nbsp;<span class="ident" id="4868483">err</span>&nbsp;<span class="op" id="4868487">!=</span>&nbsp;<span class="builtintype" id="4868490">nil</span>&nbsp;<span class="op" id="4868494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4868498">debug</span><span class="op" id="4868503">.</span><span class="ident" id="4868504">Printf</span><span class="op" id="4868510">(</span><span class="string" id="4868511">&#34;consumeAddrSpec:&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="4868540">,</span>&nbsp;<span class="ident" id="4868542">err</span><span class="op" id="4868545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4868549">return</span>&nbsp;<span class="string" id="4868556">&#34;&#34;</span><span class="op" id="4868558">,</span>&nbsp;<span class="ident" id="4868560">err</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4868565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4868569">if</span>&nbsp;<span class="op" id="4868572">!</span><span class="ident" id="4868573">p</span><span class="op" id="4868574">.</span><span class="ident" id="4868575">consume</span><span class="op" id="4868582">(</span><span class="string" id="4868583">&#39;@&#39;</span><span class="op" id="4868586">)</span>&nbsp;<span class="op" id="4868588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4868592">return</span>&nbsp;<span class="string" id="4868599">&#34;&#34;</span><span class="op" id="4868601">,</span>&nbsp;<span class="ident" id="4868603">errors</span><span class="op" id="4868609">.</span><span class="ident" id="4868610">New</span><span class="op" id="4868613">(</span><span class="string" id="4868614">&#34;mail:&nbsp;missing&nbsp;@&nbsp;in&nbsp;addr-spec&#34;</span><span class="op" id="4868644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4868647">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4868651">//&nbsp;domain&nbsp;=&nbsp;dot-atom&nbsp;/&nbsp;domain-literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4868690">var</span>&nbsp;<span class="ident" id="4868694">domain</span>&nbsp;<span class="builtintype" id="4868701">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4868709">p</span><span class="op" id="4868710">.</span><span class="ident" id="4868711">skipSpace</span><span class="op" id="4868720">(</span><span class="op" id="4868721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4868724">if</span>&nbsp;<span class="ident" id="4868727">p</span><span class="op" id="4868728">.</span><span class="ident" id="4868729">empty</span><span class="op" id="4868734">(</span><span class="op" id="4868735">)</span>&nbsp;<span class="op" id="4868737">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4868741">return</span>&nbsp;<span class="string" id="4868748">&#34;&#34;</span><span class="op" id="4868750">,</span>&nbsp;<span class="ident" id="4868752">errors</span><span class="op" id="4868758">.</span><span class="ident" id="4868759">New</span><span class="op" id="4868762">(</span><span class="string" id="4868763">&#34;mail:&nbsp;no&nbsp;domain&nbsp;in&nbsp;addr-spec&#34;</span><span class="op" id="4868793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4868796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4868799">//&nbsp;TODO(dsymonds):&nbsp;Handle&nbsp;domain-literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4868841">domain</span><span class="op" id="4868847">,</span>&nbsp;<span class="ident" id="4868849">err</span>&nbsp;<span class="op" id="4868853">=</span>&nbsp;<span class="ident" id="4868855">p</span><span class="op" id="4868856">.</span><span class="ident" id="4868857">consumeAtom</span><span class="op" id="4868868">(</span><span class="builtintype" id="4868869">true</span><span class="op" id="4868873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4868876">if</span>&nbsp;<span class="ident" id="4868879">err</span>&nbsp;<span class="op" id="4868883">!=</span>&nbsp;<span class="builtintype" id="4868886">nil</span>&nbsp;<span class="op" id="4868890">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4868894">return</span>&nbsp;<span class="string" id="4868901">&#34;&#34;</span><span class="op" id="4868903">,</span>&nbsp;<span class="ident" id="4868905">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4868910">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4868914">return</span>&nbsp;<span class="ident" id="4868921">localPart</span>&nbsp;<span class="op" id="4868931">+</span>&nbsp;<span class="string" id="4868933">&#34;@&#34;</span>&nbsp;<span class="op" id="4868937">+</span>&nbsp;<span class="ident" id="4868939">domain</span><span class="op" id="4868945">,</span>&nbsp;<span class="builtintype" id="4868947">nil</span><br>
<span class="lineno"></span><span class="op" id="4868951">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span><span class="comment" id="4868954">//&nbsp;consumePhrase&nbsp;parses&nbsp;the&nbsp;RFC&nbsp;5322&nbsp;phrase&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="4869017">func</span>&nbsp;<span class="op" id="4869022">(</span><span class="ident" id="4869023">p</span>&nbsp;<span class="op" id="4869025">*</span><span class="ident" id="4869026">addrParser</span><span class="op" id="4869036">)</span>&nbsp;<span class="ident" id="4869038">consumePhrase</span><span class="op" id="4869051">(</span><span class="op" id="4869052">)</span>&nbsp;<span class="op" id="4869054">(</span><span class="ident" id="4869055">phrase</span>&nbsp;<span class="builtintype" id="4869062">string</span><span class="op" id="4869068">,</span>&nbsp;<span class="ident" id="4869070">err</span>&nbsp;<span class="builtintype" id="4869074">error</span><span class="op" id="4869079">)</span>&nbsp;<span class="op" id="4869081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4869084">debug</span><span class="op" id="4869089">.</span><span class="ident" id="4869090">Printf</span><span class="op" id="4869096">(</span><span class="string" id="4869097">&#34;consumePhrase:&nbsp;[%s]&#34;</span><span class="op" id="4869118">,</span>&nbsp;<span class="op" id="4869120">*</span><span class="ident" id="4869121">p</span><span class="op" id="4869122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4869125">//&nbsp;phrase&nbsp;=&nbsp;1*word</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4869145">var</span>&nbsp;<span class="ident" id="4869149">words</span>&nbsp;<span class="op" id="4869155">[</span><span class="op" id="4869156">]</span><span class="builtintype" id="4869157">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4869165">for</span>&nbsp;<span class="op" id="4869169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4869173">//&nbsp;word&nbsp;=&nbsp;atom&nbsp;/&nbsp;quoted-string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4869206">var</span>&nbsp;<span class="ident" id="4869210">word</span>&nbsp;<span class="builtintype" id="4869215">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4869224">p</span><span class="op" id="4869225">.</span><span class="ident" id="4869226">skipSpace</span><span class="op" id="4869235">(</span><span class="op" id="4869236">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4869240">if</span>&nbsp;<span class="ident" id="4869243">p</span><span class="op" id="4869244">.</span><span class="ident" id="4869245">empty</span><span class="op" id="4869250">(</span><span class="op" id="4869251">)</span>&nbsp;<span class="op" id="4869253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4869258">return</span>&nbsp;<span class="string" id="4869265">&#34;&#34;</span><span class="op" id="4869267">,</span>&nbsp;<span class="ident" id="4869269">errors</span><span class="op" id="4869275">.</span><span class="ident" id="4869276">New</span><span class="op" id="4869279">(</span><span class="string" id="4869280">&#34;mail:&nbsp;missing&nbsp;phrase&#34;</span><span class="op" id="4869302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4869306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4869310">if</span>&nbsp;<span class="ident" id="4869313">p</span><span class="op" id="4869314">.</span><span class="ident" id="4869315">peek</span><span class="op" id="4869319">(</span><span class="op" id="4869320">)</span>&nbsp;<span class="op" id="4869322">==</span>&nbsp;<span class="string" id="4869325">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="4869329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4869334">//&nbsp;quoted-string</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4869354">word</span><span class="op" id="4869358">,</span>&nbsp;<span class="ident" id="4869360">err</span>&nbsp;<span class="op" id="4869364">=</span>&nbsp;<span class="ident" id="4869366">p</span><span class="op" id="4869367">.</span><span class="ident" id="4869368">consumeQuotedString</span><span class="op" id="4869387">(</span><span class="op" id="4869388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4869392">}</span>&nbsp;<span class="keyword" id="4869394">else</span>&nbsp;<span class="op" id="4869399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4869404">//&nbsp;atom</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4869415">//&nbsp;We&nbsp;actually&nbsp;parse&nbsp;dot-atom&nbsp;here&nbsp;to&nbsp;be&nbsp;more&nbsp;permissive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4869475">//&nbsp;than&nbsp;what&nbsp;RFC&nbsp;5322&nbsp;specifies.</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4869511">word</span><span class="op" id="4869515">,</span>&nbsp;<span class="ident" id="4869517">err</span>&nbsp;<span class="op" id="4869521">=</span>&nbsp;<span class="ident" id="4869523">p</span><span class="op" id="4869524">.</span><span class="ident" id="4869525">consumeAtom</span><span class="op" id="4869536">(</span><span class="builtintype" id="4869537">true</span><span class="op" id="4869541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4869545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4869550">//&nbsp;RFC&nbsp;2047&nbsp;encoded-word&nbsp;starts&nbsp;with&nbsp;=?,&nbsp;ends&nbsp;with&nbsp;?=,&nbsp;and&nbsp;has&nbsp;two&nbsp;other&nbsp;?s.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4869629">if</span>&nbsp;<span class="ident" id="4869632">err</span>&nbsp;<span class="op" id="4869636">==</span>&nbsp;<span class="builtintype" id="4869639">nil</span>&nbsp;<span class="op" id="4869643">&amp;&amp;</span>&nbsp;<span class="ident" id="4869646">strings</span><span class="op" id="4869653">.</span><span class="ident" id="4869654">HasPrefix</span><span class="op" id="4869663">(</span><span class="ident" id="4869664">word</span><span class="op" id="4869668">,</span>&nbsp;<span class="string" id="4869670">&#34;=?&#34;</span><span class="op" id="4869674">)</span>&nbsp;<span class="op" id="4869676">&amp;&amp;</span>&nbsp;<span class="ident" id="4869679">strings</span><span class="op" id="4869686">.</span><span class="ident" id="4869687">HasSuffix</span><span class="op" id="4869696">(</span><span class="ident" id="4869697">word</span><span class="op" id="4869701">,</span>&nbsp;<span class="string" id="4869703">&#34;?=&#34;</span><span class="op" id="4869707">)</span>&nbsp;<span class="op" id="4869709">&amp;&amp;</span>&nbsp;<span class="ident" id="4869712">strings</span><span class="op" id="4869719">.</span><span class="ident" id="4869720">Count</span><span class="op" id="4869725">(</span><span class="ident" id="4869726">word</span><span class="op" id="4869730">,</span>&nbsp;<span class="string" id="4869732">&#34;?&#34;</span><span class="op" id="4869735">)</span>&nbsp;<span class="op" id="4869737">==</span>&nbsp;<span class="num" id="4869740">4</span>&nbsp;<span class="op" id="4869742">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4869747">word</span><span class="op" id="4869751">,</span>&nbsp;<span class="ident" id="4869753">err</span>&nbsp;<span class="op" id="4869757">=</span>&nbsp;<span class="ident" id="4869759">decodeRFC2047Word</span><span class="op" id="4869776">(</span><span class="ident" id="4869777">word</span><span class="op" id="4869781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4869785">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4869790">if</span>&nbsp;<span class="ident" id="4869793">err</span>&nbsp;<span class="op" id="4869797">!=</span>&nbsp;<span class="builtintype" id="4869800">nil</span>&nbsp;<span class="op" id="4869804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4869809">break</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4869817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4869821">debug</span><span class="op" id="4869826">.</span><span class="ident" id="4869827">Printf</span><span class="op" id="4869833">(</span><span class="string" id="4869834">&#34;consumePhrase:&nbsp;consumed&nbsp;%q&#34;</span><span class="op" id="4869862">,</span>&nbsp;<span class="ident" id="4869864">word</span><span class="op" id="4869868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4869872">words</span>&nbsp;<span class="op" id="4869878">=</span>&nbsp;<span class="builtinfunc" id="4869880">append</span><span class="op" id="4869886">(</span><span class="ident" id="4869887">words</span><span class="op" id="4869892">,</span>&nbsp;<span class="ident" id="4869894">word</span><span class="op" id="4869898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4869901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4869904">//&nbsp;Ignore&nbsp;any&nbsp;error&nbsp;if&nbsp;we&nbsp;got&nbsp;at&nbsp;least&nbsp;one&nbsp;word.</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4869954">if</span>&nbsp;<span class="ident" id="4869957">err</span>&nbsp;<span class="op" id="4869961">!=</span>&nbsp;<span class="builtintype" id="4869964">nil</span>&nbsp;<span class="op" id="4869968">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4869971">len</span><span class="op" id="4869974">(</span><span class="ident" id="4869975">words</span><span class="op" id="4869980">)</span>&nbsp;<span class="op" id="4869982">==</span>&nbsp;<span class="num" id="4869985">0</span>&nbsp;<span class="op" id="4869987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4869991">debug</span><span class="op" id="4869996">.</span><span class="ident" id="4869997">Printf</span><span class="op" id="4870003">(</span><span class="string" id="4870004">&#34;consumePhrase:&nbsp;hit&nbsp;err:&nbsp;%v&#34;</span><span class="op" id="4870032">,</span>&nbsp;<span class="ident" id="4870034">err</span><span class="op" id="4870037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4870041">return</span>&nbsp;<span class="string" id="4870048">&#34;&#34;</span><span class="op" id="4870050">,</span>&nbsp;<span class="ident" id="4870052">fmt</span><span class="op" id="4870055">.</span><span class="ident" id="4870056">Errorf</span><span class="op" id="4870062">(</span><span class="string" id="4870063">&#34;mail:&nbsp;missing&nbsp;word&nbsp;in&nbsp;phrase:&nbsp;%v&#34;</span><span class="op" id="4870097">,</span>&nbsp;<span class="ident" id="4870099">err</span><span class="op" id="4870102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4870105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4870108">phrase</span>&nbsp;<span class="op" id="4870115">=</span>&nbsp;<span class="ident" id="4870117">strings</span><span class="op" id="4870124">.</span><span class="ident" id="4870125">Join</span><span class="op" id="4870129">(</span><span class="ident" id="4870130">words</span><span class="op" id="4870135">,</span>&nbsp;<span class="string" id="4870137">&#34;&nbsp;&#34;</span><span class="op" id="4870140">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4870143">return</span>&nbsp;<span class="ident" id="4870150">phrase</span><span class="op" id="4870156">,</span>&nbsp;<span class="builtintype" id="4870158">nil</span><br>
<span class="lineno"></span><span class="op" id="4870162">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4870165">//&nbsp;consumeQuotedString&nbsp;parses&nbsp;the&nbsp;quoted&nbsp;string&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="4870232">func</span>&nbsp;<span class="op" id="4870237">(</span><span class="ident" id="4870238">p</span>&nbsp;<span class="op" id="4870240">*</span><span class="ident" id="4870241">addrParser</span><span class="op" id="4870251">)</span>&nbsp;<span class="ident" id="4870253">consumeQuotedString</span><span class="op" id="4870272">(</span><span class="op" id="4870273">)</span>&nbsp;<span class="op" id="4870275">(</span><span class="ident" id="4870276">qs</span>&nbsp;<span class="builtintype" id="4870279">string</span><span class="op" id="4870285">,</span>&nbsp;<span class="ident" id="4870287">err</span>&nbsp;<span class="builtintype" id="4870291">error</span><span class="op" id="4870296">)</span>&nbsp;<span class="op" id="4870298">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4870301">//&nbsp;Assume&nbsp;first&nbsp;byte&nbsp;is&nbsp;&#39;&#34;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4870331">i</span>&nbsp;<span class="op" id="4870333">:=</span>&nbsp;<span class="num" id="4870336">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4870339">qsb</span>&nbsp;<span class="op" id="4870343">:=</span>&nbsp;<span class="builtinfunc" id="4870346">make</span><span class="op" id="4870350">(</span><span class="op" id="4870351">[</span><span class="op" id="4870352">]</span><span class="builtintype" id="4870353">byte</span><span class="op" id="4870357">,</span>&nbsp;<span class="num" id="4870359">0</span><span class="op" id="4870360">,</span>&nbsp;<span class="num" id="4870362">10</span><span class="op" id="4870364">)</span><br>
<span class="lineno"></span><span class="ident" id="4870366">Loop</span><span class="op" id="4870370">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4870373">for</span>&nbsp;<span class="op" id="4870377">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4870381">if</span>&nbsp;<span class="ident" id="4870384">i</span>&nbsp;<span class="op" id="4870386">&gt;=</span>&nbsp;<span class="ident" id="4870389">p</span><span class="op" id="4870390">.</span><span class="builtinfunc" id="4870391">len</span><span class="op" id="4870394">(</span><span class="op" id="4870395">)</span>&nbsp;<span class="op" id="4870397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4870402">return</span>&nbsp;<span class="string" id="4870409">&#34;&#34;</span><span class="op" id="4870411">,</span>&nbsp;<span class="ident" id="4870413">errors</span><span class="op" id="4870419">.</span><span class="ident" id="4870420">New</span><span class="op" id="4870423">(</span><span class="string" id="4870424">&#34;mail:&nbsp;unclosed&nbsp;quoted-string&#34;</span><span class="op" id="4870454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4870458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4870462">switch</span>&nbsp;<span class="ident" id="4870469">c</span>&nbsp;<span class="op" id="4870471">:=</span>&nbsp;<span class="op" id="4870474">(</span><span class="op" id="4870475">*</span><span class="ident" id="4870476">p</span><span class="op" id="4870477">)</span><span class="op" id="4870478">[</span><span class="ident" id="4870479">i</span><span class="op" id="4870480">]</span><span class="op" id="4870481">;</span>&nbsp;<span class="op" id="4870483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4870487">case</span>&nbsp;<span class="ident" id="4870492">c</span>&nbsp;<span class="op" id="4870494">==</span>&nbsp;<span class="string" id="4870497">&#39;&#34;&#39;</span><span class="op" id="4870500">:</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4870505">break</span>&nbsp;<span class="ident" id="4870511">Loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4870518">case</span>&nbsp;<span class="ident" id="4870523">c</span>&nbsp;<span class="op" id="4870525">==</span>&nbsp;<span class="string" id="4870528">&#39;\\&#39;</span><span class="op" id="4870532">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4870537">if</span>&nbsp;<span class="ident" id="4870540">i</span><span class="op" id="4870541">+</span><span class="num" id="4870542">1</span>&nbsp;<span class="op" id="4870544">==</span>&nbsp;<span class="ident" id="4870547">p</span><span class="op" id="4870548">.</span><span class="builtinfunc" id="4870549">len</span><span class="op" id="4870552">(</span><span class="op" id="4870553">)</span>&nbsp;<span class="op" id="4870555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4870561">return</span>&nbsp;<span class="string" id="4870568">&#34;&#34;</span><span class="op" id="4870570">,</span>&nbsp;<span class="ident" id="4870572">errors</span><span class="op" id="4870578">.</span><span class="ident" id="4870579">New</span><span class="op" id="4870582">(</span><span class="string" id="4870583">&#34;mail:&nbsp;unclosed&nbsp;quoted-string&#34;</span><span class="op" id="4870613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4870618">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4870623">qsb</span>&nbsp;<span class="op" id="4870627">=</span>&nbsp;<span class="builtinfunc" id="4870629">append</span><span class="op" id="4870635">(</span><span class="ident" id="4870636">qsb</span><span class="op" id="4870639">,</span>&nbsp;<span class="op" id="4870641">(</span><span class="op" id="4870642">*</span><span class="ident" id="4870643">p</span><span class="op" id="4870644">)</span><span class="op" id="4870645">[</span><span class="ident" id="4870646">i</span><span class="op" id="4870647">+</span><span class="num" id="4870648">1</span><span class="op" id="4870649">]</span><span class="op" id="4870650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4870655">i</span>&nbsp;<span class="op" id="4870657">+=</span>&nbsp;<span class="num" id="4870660">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4870664">case</span>&nbsp;<span class="ident" id="4870669">isQtext</span><span class="op" id="4870676">(</span><span class="ident" id="4870677">c</span><span class="op" id="4870678">)</span><span class="op" id="4870679">,</span>&nbsp;<span class="ident" id="4870681">c</span>&nbsp;<span class="op" id="4870683">==</span>&nbsp;<span class="string" id="4870686">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="4870690">||</span>&nbsp;<span class="ident" id="4870693">c</span>&nbsp;<span class="op" id="4870695">==</span>&nbsp;<span class="string" id="4870698">&#39;\t&#39;</span><span class="op" id="4870702">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4870707">//&nbsp;qtext&nbsp;(printable&nbsp;US-ASCII&nbsp;excluding&nbsp;&#34;&nbsp;and&nbsp;\),&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4870762">//&nbsp;FWS&nbsp;(almost;&nbsp;we&#39;re&nbsp;ignoring&nbsp;CRLF)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4870802">qsb</span>&nbsp;<span class="op" id="4870806">=</span>&nbsp;<span class="builtinfunc" id="4870808">append</span><span class="op" id="4870814">(</span><span class="ident" id="4870815">qsb</span><span class="op" id="4870818">,</span>&nbsp;<span class="ident" id="4870820">c</span><span class="op" id="4870821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4870826">i</span><span class="op" id="4870827">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4870832">default</span><span class="op" id="4870839">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4870844">return</span>&nbsp;<span class="string" id="4870851">&#34;&#34;</span><span class="op" id="4870853">,</span>&nbsp;<span class="ident" id="4870855">fmt</span><span class="op" id="4870858">.</span><span class="ident" id="4870859">Errorf</span><span class="op" id="4870865">(</span><span class="string" id="4870866">&#34;mail:&nbsp;bad&nbsp;character&nbsp;in&nbsp;quoted-string:&nbsp;%q&#34;</span><span class="op" id="4870908">,</span>&nbsp;<span class="ident" id="4870910">c</span><span class="op" id="4870911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4870915">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4870918">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4870921">*</span><span class="ident" id="4870922">p</span>&nbsp;<span class="op" id="4870924">=</span>&nbsp;<span class="op" id="4870926">(</span><span class="op" id="4870927">*</span><span class="ident" id="4870928">p</span><span class="op" id="4870929">)</span><span class="op" id="4870930">[</span><span class="ident" id="4870931">i</span><span class="op" id="4870932">+</span><span class="num" id="4870933">1</span><span class="op" id="4870934">:</span><span class="op" id="4870935">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4870938">return</span>&nbsp;<span class="builtintype" id="4870945">string</span><span class="op" id="4870951">(</span><span class="ident" id="4870952">qsb</span><span class="op" id="4870955">)</span><span class="op" id="4870956">,</span>&nbsp;<span class="builtintype" id="4870958">nil</span><br>
<span class="lineno"></span><span class="op" id="4870962">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="comment" id="4870965">//&nbsp;consumeAtom&nbsp;parses&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;atom&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="comment" id="4871023">//&nbsp;If&nbsp;dot&nbsp;is&nbsp;true,&nbsp;consumeAtom&nbsp;parses&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;dot-atom&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="4871091">func</span>&nbsp;<span class="op" id="4871096">(</span><span class="ident" id="4871097">p</span>&nbsp;<span class="op" id="4871099">*</span><span class="ident" id="4871100">addrParser</span><span class="op" id="4871110">)</span>&nbsp;<span class="ident" id="4871112">consumeAtom</span><span class="op" id="4871123">(</span><span class="ident" id="4871124">dot</span>&nbsp;<span class="builtintype" id="4871128">bool</span><span class="op" id="4871132">)</span>&nbsp;<span class="op" id="4871134">(</span><span class="ident" id="4871135">atom</span>&nbsp;<span class="builtintype" id="4871140">string</span><span class="op" id="4871146">,</span>&nbsp;<span class="ident" id="4871148">err</span>&nbsp;<span class="builtintype" id="4871152">error</span><span class="op" id="4871157">)</span>&nbsp;<span class="op" id="4871159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4871162">if</span>&nbsp;<span class="op" id="4871165">!</span><span class="ident" id="4871166">isAtext</span><span class="op" id="4871173">(</span><span class="ident" id="4871174">p</span><span class="op" id="4871175">.</span><span class="ident" id="4871176">peek</span><span class="op" id="4871180">(</span><span class="op" id="4871181">)</span><span class="op" id="4871182">,</span>&nbsp;<span class="builtintype" id="4871184">false</span><span class="op" id="4871189">)</span>&nbsp;<span class="op" id="4871191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4871195">return</span>&nbsp;<span class="string" id="4871202">&#34;&#34;</span><span class="op" id="4871204">,</span>&nbsp;<span class="ident" id="4871206">errors</span><span class="op" id="4871212">.</span><span class="ident" id="4871213">New</span><span class="op" id="4871216">(</span><span class="string" id="4871217">&#34;mail:&nbsp;invalid&nbsp;string&#34;</span><span class="op" id="4871239">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4871242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4871245">i</span>&nbsp;<span class="op" id="4871247">:=</span>&nbsp;<span class="num" id="4871250">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4871253">for</span>&nbsp;<span class="op" id="4871257">;</span>&nbsp;<span class="ident" id="4871259">i</span>&nbsp;<span class="op" id="4871261">&lt;</span>&nbsp;<span class="ident" id="4871263">p</span><span class="op" id="4871264">.</span><span class="builtinfunc" id="4871265">len</span><span class="op" id="4871268">(</span><span class="op" id="4871269">)</span>&nbsp;<span class="op" id="4871271">&amp;&amp;</span>&nbsp;<span class="ident" id="4871274">isAtext</span><span class="op" id="4871281">(</span><span class="op" id="4871282">(</span><span class="op" id="4871283">*</span><span class="ident" id="4871284">p</span><span class="op" id="4871285">)</span><span class="op" id="4871286">[</span><span class="ident" id="4871287">i</span><span class="op" id="4871288">]</span><span class="op" id="4871289">,</span>&nbsp;<span class="ident" id="4871291">dot</span><span class="op" id="4871294">)</span><span class="op" id="4871295">;</span>&nbsp;<span class="ident" id="4871297">i</span><span class="op" id="4871298">++</span>&nbsp;<span class="op" id="4871301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4871304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4871307">atom</span><span class="op" id="4871311">,</span>&nbsp;<span class="op" id="4871313">*</span><span class="ident" id="4871314">p</span>&nbsp;<span class="op" id="4871316">=</span>&nbsp;<span class="builtintype" id="4871318">string</span><span class="op" id="4871324">(</span><span class="op" id="4871325">(</span><span class="op" id="4871326">*</span><span class="ident" id="4871327">p</span><span class="op" id="4871328">)</span><span class="op" id="4871329">[</span><span class="op" id="4871330">:</span><span class="ident" id="4871331">i</span><span class="op" id="4871332">]</span><span class="op" id="4871333">)</span><span class="op" id="4871334">,</span>&nbsp;<span class="op" id="4871336">(</span><span class="op" id="4871337">*</span><span class="ident" id="4871338">p</span><span class="op" id="4871339">)</span><span class="op" id="4871340">[</span><span class="ident" id="4871341">i</span><span class="op" id="4871342">:</span><span class="op" id="4871343">]</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4871346">return</span>&nbsp;<span class="ident" id="4871353">atom</span><span class="op" id="4871357">,</span>&nbsp;<span class="builtintype" id="4871359">nil</span><br>
<span class="lineno"></span><span class="op" id="4871363">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4871366">func</span>&nbsp;<span class="op" id="4871371">(</span><span class="ident" id="4871372">p</span>&nbsp;<span class="op" id="4871374">*</span><span class="ident" id="4871375">addrParser</span><span class="op" id="4871385">)</span>&nbsp;<span class="ident" id="4871387">consume</span><span class="op" id="4871394">(</span><span class="ident" id="4871395">c</span>&nbsp;<span class="builtintype" id="4871397">byte</span><span class="op" id="4871401">)</span>&nbsp;<span class="builtintype" id="4871403">bool</span>&nbsp;<span class="op" id="4871408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4871411">if</span>&nbsp;<span class="ident" id="4871414">p</span><span class="op" id="4871415">.</span><span class="ident" id="4871416">empty</span><span class="op" id="4871421">(</span><span class="op" id="4871422">)</span>&nbsp;<span class="op" id="4871424">||</span>&nbsp;<span class="ident" id="4871427">p</span><span class="op" id="4871428">.</span><span class="ident" id="4871429">peek</span><span class="op" id="4871433">(</span><span class="op" id="4871434">)</span>&nbsp;<span class="op" id="4871436">!=</span>&nbsp;<span class="ident" id="4871439">c</span>&nbsp;<span class="op" id="4871441">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4871445">return</span>&nbsp;<span class="builtintype" id="4871452">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4871459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4871462">*</span><span class="ident" id="4871463">p</span>&nbsp;<span class="op" id="4871465">=</span>&nbsp;<span class="op" id="4871467">(</span><span class="op" id="4871468">*</span><span class="ident" id="4871469">p</span><span class="op" id="4871470">)</span><span class="op" id="4871471">[</span><span class="num" id="4871472">1</span><span class="op" id="4871473">:</span><span class="op" id="4871474">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4871477">return</span>&nbsp;<span class="builtintype" id="4871484">true</span><br>
<span class="lineno"></span><span class="op" id="4871489">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="comment" id="4871492">//&nbsp;skipSpace&nbsp;skips&nbsp;the&nbsp;leading&nbsp;space&nbsp;and&nbsp;tab&nbsp;characters.</span><br>
<span class="lineno"></span><span class="keyword" id="4871549">func</span>&nbsp;<span class="op" id="4871554">(</span><span class="ident" id="4871555">p</span>&nbsp;<span class="op" id="4871557">*</span><span class="ident" id="4871558">addrParser</span><span class="op" id="4871568">)</span>&nbsp;<span class="ident" id="4871570">skipSpace</span><span class="op" id="4871579">(</span><span class="op" id="4871580">)</span>&nbsp;<span class="op" id="4871582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4871585">*</span><span class="ident" id="4871586">p</span>&nbsp;<span class="op" id="4871588">=</span>&nbsp;<span class="ident" id="4871590">bytes</span><span class="op" id="4871595">.</span><span class="ident" id="4871596">TrimLeft</span><span class="op" id="4871604">(</span><span class="op" id="4871605">*</span><span class="ident" id="4871606">p</span><span class="op" id="4871607">,</span>&nbsp;<span class="string" id="4871609">&#34;&nbsp;\t&#34;</span><span class="op" id="4871614">)</span><br>
<span class="lineno"></span><span class="op" id="4871616">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="4871619">func</span>&nbsp;<span class="op" id="4871624">(</span><span class="ident" id="4871625">p</span>&nbsp;<span class="op" id="4871627">*</span><span class="ident" id="4871628">addrParser</span><span class="op" id="4871638">)</span>&nbsp;<span class="ident" id="4871640">peek</span><span class="op" id="4871644">(</span><span class="op" id="4871645">)</span>&nbsp;<span class="builtintype" id="4871647">byte</span>&nbsp;<span class="op" id="4871652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4871655">return</span>&nbsp;<span class="op" id="4871662">(</span><span class="op" id="4871663">*</span><span class="ident" id="4871664">p</span><span class="op" id="4871665">)</span><span class="op" id="4871666">[</span><span class="num" id="4871667">0</span><span class="op" id="4871668">]</span><br>
<span class="lineno"></span><span class="op" id="4871670">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="keyword" id="4871673">func</span>&nbsp;<span class="op" id="4871678">(</span><span class="ident" id="4871679">p</span>&nbsp;<span class="op" id="4871681">*</span><span class="ident" id="4871682">addrParser</span><span class="op" id="4871692">)</span>&nbsp;<span class="ident" id="4871694">empty</span><span class="op" id="4871699">(</span><span class="op" id="4871700">)</span>&nbsp;<span class="builtintype" id="4871702">bool</span>&nbsp;<span class="op" id="4871707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4871710">return</span>&nbsp;<span class="ident" id="4871717">p</span><span class="op" id="4871718">.</span><span class="builtinfunc" id="4871719">len</span><span class="op" id="4871722">(</span><span class="op" id="4871723">)</span>&nbsp;<span class="op" id="4871725">==</span>&nbsp;<span class="num" id="4871728">0</span><br>
<span class="lineno"></span><span class="op" id="4871730">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4871733">func</span>&nbsp;<span class="op" id="4871738">(</span><span class="ident" id="4871739">p</span>&nbsp;<span class="op" id="4871741">*</span><span class="ident" id="4871742">addrParser</span><span class="op" id="4871752">)</span>&nbsp;<span class="builtinfunc" id="4871754">len</span><span class="op" id="4871757">(</span><span class="op" id="4871758">)</span>&nbsp;<span class="builtintype" id="4871760">int</span>&nbsp;<span class="op" id="4871764">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4871767">return</span>&nbsp;<span class="builtinfunc" id="4871774">len</span><span class="op" id="4871777">(</span><span class="op" id="4871778">*</span><span class="ident" id="4871779">p</span><span class="op" id="4871780">)</span><br>
<span class="lineno"></span><span class="op" id="4871782">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4871785">func</span>&nbsp;<span class="ident" id="4871790">decodeRFC2047Word</span><span class="op" id="4871807">(</span><span class="ident" id="4871808">s</span>&nbsp;<span class="builtintype" id="4871810">string</span><span class="op" id="4871816">)</span>&nbsp;<span class="op" id="4871818">(</span><span class="builtintype" id="4871819">string</span><span class="op" id="4871825">,</span>&nbsp;<span class="builtintype" id="4871827">error</span><span class="op" id="4871832">)</span>&nbsp;<span class="op" id="4871834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4871837">fields</span>&nbsp;<span class="op" id="4871844">:=</span>&nbsp;<span class="ident" id="4871847">strings</span><span class="op" id="4871854">.</span><span class="ident" id="4871855">Split</span><span class="op" id="4871860">(</span><span class="ident" id="4871861">s</span><span class="op" id="4871862">,</span>&nbsp;<span class="string" id="4871864">&#34;?&#34;</span><span class="op" id="4871867">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4871870">if</span>&nbsp;<span class="builtinfunc" id="4871873">len</span><span class="op" id="4871876">(</span><span class="ident" id="4871877">fields</span><span class="op" id="4871883">)</span>&nbsp;<span class="op" id="4871885">!=</span>&nbsp;<span class="num" id="4871888">5</span>&nbsp;<span class="op" id="4871890">||</span>&nbsp;<span class="ident" id="4871893">fields</span><span class="op" id="4871899">[</span><span class="num" id="4871900">0</span><span class="op" id="4871901">]</span>&nbsp;<span class="op" id="4871903">!=</span>&nbsp;<span class="string" id="4871906">&#34;=&#34;</span>&nbsp;<span class="op" id="4871910">||</span>&nbsp;<span class="ident" id="4871913">fields</span><span class="op" id="4871919">[</span><span class="num" id="4871920">4</span><span class="op" id="4871921">]</span>&nbsp;<span class="op" id="4871923">!=</span>&nbsp;<span class="string" id="4871926">&#34;=&#34;</span>&nbsp;<span class="op" id="4871930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4871934">return</span>&nbsp;<span class="string" id="4871941">&#34;&#34;</span><span class="op" id="4871943">,</span>&nbsp;<span class="ident" id="4871945">errors</span><span class="op" id="4871951">.</span><span class="ident" id="4871952">New</span><span class="op" id="4871955">(</span><span class="string" id="4871956">&#34;address&nbsp;not&nbsp;RFC&nbsp;2047&nbsp;encoded&#34;</span><span class="op" id="4871986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4871989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4871992">charset</span><span class="op" id="4871999">,</span>&nbsp;<span class="ident" id="4872001">enc</span>&nbsp;<span class="op" id="4872005">:=</span>&nbsp;<span class="ident" id="4872008">strings</span><span class="op" id="4872015">.</span><span class="ident" id="4872016">ToLower</span><span class="op" id="4872023">(</span><span class="ident" id="4872024">fields</span><span class="op" id="4872030">[</span><span class="num" id="4872031">1</span><span class="op" id="4872032">]</span><span class="op" id="4872033">)</span><span class="op" id="4872034">,</span>&nbsp;<span class="ident" id="4872036">strings</span><span class="op" id="4872043">.</span><span class="ident" id="4872044">ToLower</span><span class="op" id="4872051">(</span><span class="ident" id="4872052">fields</span><span class="op" id="4872058">[</span><span class="num" id="4872059">2</span><span class="op" id="4872060">]</span><span class="op" id="4872061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4872064">if</span>&nbsp;<span class="ident" id="4872067">charset</span>&nbsp;<span class="op" id="4872075">!=</span>&nbsp;<span class="string" id="4872078">&#34;us-ascii&#34;</span>&nbsp;<span class="op" id="4872089">&amp;&amp;</span>&nbsp;<span class="ident" id="4872092">charset</span>&nbsp;<span class="op" id="4872100">!=</span>&nbsp;<span class="string" id="4872103">&#34;iso-8859-1&#34;</span>&nbsp;<span class="op" id="4872116">&amp;&amp;</span>&nbsp;<span class="ident" id="4872119">charset</span>&nbsp;<span class="op" id="4872127">!=</span>&nbsp;<span class="string" id="4872130">&#34;utf-8&#34;</span>&nbsp;<span class="op" id="4872138">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4872142">return</span>&nbsp;<span class="string" id="4872149">&#34;&#34;</span><span class="op" id="4872151">,</span>&nbsp;<span class="ident" id="4872153">fmt</span><span class="op" id="4872156">.</span><span class="ident" id="4872157">Errorf</span><span class="op" id="4872163">(</span><span class="string" id="4872164">&#34;charset&nbsp;not&nbsp;supported:&nbsp;%q&#34;</span><span class="op" id="4872191">,</span>&nbsp;<span class="ident" id="4872193">charset</span><span class="op" id="4872200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4872203">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4872207">in</span>&nbsp;<span class="op" id="4872210">:=</span>&nbsp;<span class="ident" id="4872213">bytes</span><span class="op" id="4872218">.</span><span class="ident" id="4872219">NewBufferString</span><span class="op" id="4872234">(</span><span class="ident" id="4872235">fields</span><span class="op" id="4872241">[</span><span class="num" id="4872242">3</span><span class="op" id="4872243">]</span><span class="op" id="4872244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4872247">var</span>&nbsp;<span class="ident" id="4872251">r</span>&nbsp;<span class="ident" id="4872253">io</span><span class="op" id="4872255">.</span><span class="ident" id="4872256">Reader</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4872264">switch</span>&nbsp;<span class="ident" id="4872271">enc</span>&nbsp;<span class="op" id="4872275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4872278">case</span>&nbsp;<span class="string" id="4872283">&#34;b&#34;</span><span class="op" id="4872286">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4872290">r</span>&nbsp;<span class="op" id="4872292">=</span>&nbsp;<span class="ident" id="4872294">base64</span><span class="op" id="4872300">.</span><span class="ident" id="4872301">NewDecoder</span><span class="op" id="4872311">(</span><span class="ident" id="4872312">base64</span><span class="op" id="4872318">.</span><span class="ident" id="4872319">StdEncoding</span><span class="op" id="4872330">,</span>&nbsp;<span class="ident" id="4872332">in</span><span class="op" id="4872334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4872337">case</span>&nbsp;<span class="string" id="4872342">&#34;q&#34;</span><span class="op" id="4872345">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4872349">r</span>&nbsp;<span class="op" id="4872351">=</span>&nbsp;<span class="ident" id="4872353">qDecoder</span><span class="op" id="4872361">{</span><span class="ident" id="4872362">r</span><span class="op" id="4872363">:</span>&nbsp;<span class="ident" id="4872365">in</span><span class="op" id="4872367">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4872370">default</span><span class="op" id="4872377">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4872381">return</span>&nbsp;<span class="string" id="4872388">&#34;&#34;</span><span class="op" id="4872390">,</span>&nbsp;<span class="ident" id="4872392">fmt</span><span class="op" id="4872395">.</span><span class="ident" id="4872396">Errorf</span><span class="op" id="4872402">(</span><span class="string" id="4872403">&#34;RFC&nbsp;2047&nbsp;encoding&nbsp;not&nbsp;supported:&nbsp;%q&#34;</span><span class="op" id="4872440">,</span>&nbsp;<span class="ident" id="4872442">enc</span><span class="op" id="4872445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4872448">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4872452">dec</span><span class="op" id="4872455">,</span>&nbsp;<span class="ident" id="4872457">err</span>&nbsp;<span class="op" id="4872461">:=</span>&nbsp;<span class="ident" id="4872464">ioutil</span><span class="op" id="4872470">.</span><span class="ident" id="4872471">ReadAll</span><span class="op" id="4872478">(</span><span class="ident" id="4872479">r</span><span class="op" id="4872480">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4872483">if</span>&nbsp;<span class="ident" id="4872486">err</span>&nbsp;<span class="op" id="4872490">!=</span>&nbsp;<span class="builtintype" id="4872493">nil</span>&nbsp;<span class="op" id="4872497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4872501">return</span>&nbsp;<span class="string" id="4872508">&#34;&#34;</span><span class="op" id="4872510">,</span>&nbsp;<span class="ident" id="4872512">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4872517">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4872521">switch</span>&nbsp;<span class="ident" id="4872528">charset</span>&nbsp;<span class="op" id="4872536">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4872539">case</span>&nbsp;<span class="string" id="4872544">&#34;us-ascii&#34;</span><span class="op" id="4872554">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4872558">b</span>&nbsp;<span class="op" id="4872560">:=</span>&nbsp;<span class="builtinfunc" id="4872563">new</span><span class="op" id="4872566">(</span><span class="ident" id="4872567">bytes</span><span class="op" id="4872572">.</span><span class="ident" id="4872573">Buffer</span><span class="op" id="4872579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4872583">for</span>&nbsp;<span class="ident" id="4872587">_</span><span class="op" id="4872588">,</span>&nbsp;<span class="ident" id="4872590">c</span>&nbsp;<span class="op" id="4872592">:=</span>&nbsp;<span class="keyword" id="4872595">range</span>&nbsp;<span class="ident" id="4872601">dec</span>&nbsp;<span class="op" id="4872605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4872610">if</span>&nbsp;<span class="ident" id="4872613">c</span>&nbsp;<span class="op" id="4872615">&gt;=</span>&nbsp;<span class="num" id="4872618">0x80</span>&nbsp;<span class="op" id="4872623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4872629">b</span><span class="op" id="4872630">.</span><span class="ident" id="4872631">WriteRune</span><span class="op" id="4872640">(</span><span class="ident" id="4872641">unicode</span><span class="op" id="4872648">.</span><span class="ident" id="4872649">ReplacementChar</span><span class="op" id="4872664">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4872669">}</span>&nbsp;<span class="keyword" id="4872671">else</span>&nbsp;<span class="op" id="4872676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4872682">b</span><span class="op" id="4872683">.</span><span class="ident" id="4872684">WriteRune</span><span class="op" id="4872693">(</span><span class="builtintype" id="4872694">rune</span><span class="op" id="4872698">(</span><span class="ident" id="4872699">c</span><span class="op" id="4872700">)</span><span class="op" id="4872701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4872706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4872710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4872714">return</span>&nbsp;<span class="ident" id="4872721">b</span><span class="op" id="4872722">.</span><span class="ident" id="4872723">String</span><span class="op" id="4872729">(</span><span class="op" id="4872730">)</span><span class="op" id="4872731">,</span>&nbsp;<span class="builtintype" id="4872733">nil</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4872738">case</span>&nbsp;<span class="string" id="4872743">&#34;iso-8859-1&#34;</span><span class="op" id="4872755">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4872759">b</span>&nbsp;<span class="op" id="4872761">:=</span>&nbsp;<span class="builtinfunc" id="4872764">new</span><span class="op" id="4872767">(</span><span class="ident" id="4872768">bytes</span><span class="op" id="4872773">.</span><span class="ident" id="4872774">Buffer</span><span class="op" id="4872780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4872784">for</span>&nbsp;<span class="ident" id="4872788">_</span><span class="op" id="4872789">,</span>&nbsp;<span class="ident" id="4872791">c</span>&nbsp;<span class="op" id="4872793">:=</span>&nbsp;<span class="keyword" id="4872796">range</span>&nbsp;<span class="ident" id="4872802">dec</span>&nbsp;<span class="op" id="4872806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4872811">b</span><span class="op" id="4872812">.</span><span class="ident" id="4872813">WriteRune</span><span class="op" id="4872822">(</span><span class="builtintype" id="4872823">rune</span><span class="op" id="4872827">(</span><span class="ident" id="4872828">c</span><span class="op" id="4872829">)</span><span class="op" id="4872830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4872834">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4872838">return</span>&nbsp;<span class="ident" id="4872845">b</span><span class="op" id="4872846">.</span><span class="ident" id="4872847">String</span><span class="op" id="4872853">(</span><span class="op" id="4872854">)</span><span class="op" id="4872855">,</span>&nbsp;<span class="builtintype" id="4872857">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4872862">case</span>&nbsp;<span class="string" id="4872867">&#34;utf-8&#34;</span><span class="op" id="4872874">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4872878">return</span>&nbsp;<span class="builtintype" id="4872885">string</span><span class="op" id="4872891">(</span><span class="ident" id="4872892">dec</span><span class="op" id="4872895">)</span><span class="op" id="4872896">,</span>&nbsp;<span class="builtintype" id="4872898">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4872903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4872906">panic</span><span class="op" id="4872911">(</span><span class="string" id="4872912">&#34;unreachable&#34;</span><span class="op" id="4872925">)</span><br>
<span class="lineno">490</span><span class="op" id="4872927">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4872930">type</span>&nbsp;<span class="ident" id="4872935">qDecoder</span>&nbsp;<span class="keyword" id="4872944">struct</span>&nbsp;<span class="op" id="4872951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4872954">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4872962">io</span><span class="op" id="4872964">.</span><span class="ident" id="4872965">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4872973">scratch</span>&nbsp;<span class="op" id="4872981">[</span><span class="num" id="4872982">2</span><span class="op" id="4872983">]</span><span class="builtintype" id="4872984">byte</span><br>
<span class="lineno">495</span><span class="op" id="4872989">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4872992">func</span>&nbsp;<span class="op" id="4872997">(</span><span class="ident" id="4872998">qd</span>&nbsp;<span class="ident" id="4873001">qDecoder</span><span class="op" id="4873009">)</span>&nbsp;<span class="ident" id="4873011">Read</span><span class="op" id="4873015">(</span><span class="ident" id="4873016">p</span>&nbsp;<span class="op" id="4873018">[</span><span class="op" id="4873019">]</span><span class="builtintype" id="4873020">byte</span><span class="op" id="4873024">)</span>&nbsp;<span class="op" id="4873026">(</span><span class="ident" id="4873027">n</span>&nbsp;<span class="builtintype" id="4873029">int</span><span class="op" id="4873032">,</span>&nbsp;<span class="ident" id="4873034">err</span>&nbsp;<span class="builtintype" id="4873038">error</span><span class="op" id="4873043">)</span>&nbsp;<span class="op" id="4873045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4873048">//&nbsp;This&nbsp;method&nbsp;writes&nbsp;at&nbsp;most&nbsp;one&nbsp;byte&nbsp;into&nbsp;p.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4873096">if</span>&nbsp;<span class="builtinfunc" id="4873099">len</span><span class="op" id="4873102">(</span><span class="ident" id="4873103">p</span><span class="op" id="4873104">)</span>&nbsp;<span class="op" id="4873106">==</span>&nbsp;<span class="num" id="4873109">0</span>&nbsp;<span class="op" id="4873111">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4873115">return</span>&nbsp;<span class="num" id="4873122">0</span><span class="op" id="4873123">,</span>&nbsp;<span class="builtintype" id="4873125">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4873130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4873133">if</span>&nbsp;<span class="ident" id="4873136">_</span><span class="op" id="4873137">,</span>&nbsp;<span class="ident" id="4873139">err</span>&nbsp;<span class="op" id="4873143">:=</span>&nbsp;<span class="ident" id="4873146">qd</span><span class="op" id="4873148">.</span><span class="ident" id="4873149">r</span><span class="op" id="4873150">.</span><span class="ident" id="4873151">Read</span><span class="op" id="4873155">(</span><span class="ident" id="4873156">qd</span><span class="op" id="4873158">.</span><span class="ident" id="4873159">scratch</span><span class="op" id="4873166">[</span><span class="op" id="4873167">:</span><span class="num" id="4873168">1</span><span class="op" id="4873169">]</span><span class="op" id="4873170">)</span><span class="op" id="4873171">;</span>&nbsp;<span class="ident" id="4873173">err</span>&nbsp;<span class="op" id="4873177">!=</span>&nbsp;<span class="builtintype" id="4873180">nil</span>&nbsp;<span class="op" id="4873184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4873188">return</span>&nbsp;<span class="num" id="4873195">0</span><span class="op" id="4873196">,</span>&nbsp;<span class="ident" id="4873198">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4873203">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4873206">switch</span>&nbsp;<span class="ident" id="4873213">c</span>&nbsp;<span class="op" id="4873215">:=</span>&nbsp;<span class="ident" id="4873218">qd</span><span class="op" id="4873220">.</span><span class="ident" id="4873221">scratch</span><span class="op" id="4873228">[</span><span class="num" id="4873229">0</span><span class="op" id="4873230">]</span><span class="op" id="4873231">;</span>&nbsp;<span class="op" id="4873233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4873236">case</span>&nbsp;<span class="ident" id="4873241">c</span>&nbsp;<span class="op" id="4873243">==</span>&nbsp;<span class="string" id="4873246">&#39;=&#39;</span><span class="op" id="4873249">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4873253">if</span>&nbsp;<span class="ident" id="4873256">_</span><span class="op" id="4873257">,</span>&nbsp;<span class="ident" id="4873259">err</span>&nbsp;<span class="op" id="4873263">:=</span>&nbsp;<span class="ident" id="4873266">io</span><span class="op" id="4873268">.</span><span class="ident" id="4873269">ReadFull</span><span class="op" id="4873277">(</span><span class="ident" id="4873278">qd</span><span class="op" id="4873280">.</span><span class="ident" id="4873281">r</span><span class="op" id="4873282">,</span>&nbsp;<span class="ident" id="4873284">qd</span><span class="op" id="4873286">.</span><span class="ident" id="4873287">scratch</span><span class="op" id="4873294">[</span><span class="op" id="4873295">:</span><span class="num" id="4873296">2</span><span class="op" id="4873297">]</span><span class="op" id="4873298">)</span><span class="op" id="4873299">;</span>&nbsp;<span class="ident" id="4873301">err</span>&nbsp;<span class="op" id="4873305">!=</span>&nbsp;<span class="builtintype" id="4873308">nil</span>&nbsp;<span class="op" id="4873312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4873317">return</span>&nbsp;<span class="num" id="4873324">0</span><span class="op" id="4873325">,</span>&nbsp;<span class="ident" id="4873327">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4873333">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4873337">x</span><span class="op" id="4873338">,</span>&nbsp;<span class="ident" id="4873340">err</span>&nbsp;<span class="op" id="4873344">:=</span>&nbsp;<span class="ident" id="4873347">strconv</span><span class="op" id="4873354">.</span><span class="ident" id="4873355">ParseInt</span><span class="op" id="4873363">(</span><span class="builtintype" id="4873364">string</span><span class="op" id="4873370">(</span><span class="ident" id="4873371">qd</span><span class="op" id="4873373">.</span><span class="ident" id="4873374">scratch</span><span class="op" id="4873381">[</span><span class="op" id="4873382">:</span><span class="num" id="4873383">2</span><span class="op" id="4873384">]</span><span class="op" id="4873385">)</span><span class="op" id="4873386">,</span>&nbsp;<span class="num" id="4873388">16</span><span class="op" id="4873390">,</span>&nbsp;<span class="num" id="4873392">64</span><span class="op" id="4873394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4873398">if</span>&nbsp;<span class="ident" id="4873401">err</span>&nbsp;<span class="op" id="4873405">!=</span>&nbsp;<span class="builtintype" id="4873408">nil</span>&nbsp;<span class="op" id="4873412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4873417">return</span>&nbsp;<span class="num" id="4873424">0</span><span class="op" id="4873425">,</span>&nbsp;<span class="ident" id="4873427">fmt</span><span class="op" id="4873430">.</span><span class="ident" id="4873431">Errorf</span><span class="op" id="4873437">(</span><span class="string" id="4873438">&#34;mail:&nbsp;invalid&nbsp;RFC&nbsp;2047&nbsp;encoding:&nbsp;%q&#34;</span><span class="op" id="4873475">,</span>&nbsp;<span class="ident" id="4873477">qd</span><span class="op" id="4873479">.</span><span class="ident" id="4873480">scratch</span><span class="op" id="4873487">[</span><span class="op" id="4873488">:</span><span class="num" id="4873489">2</span><span class="op" id="4873490">]</span><span class="op" id="4873491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4873495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4873499">p</span><span class="op" id="4873500">[</span><span class="num" id="4873501">0</span><span class="op" id="4873502">]</span>&nbsp;<span class="op" id="4873504">=</span>&nbsp;<span class="builtintype" id="4873506">byte</span><span class="op" id="4873510">(</span><span class="ident" id="4873511">x</span><span class="op" id="4873512">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4873515">case</span>&nbsp;<span class="ident" id="4873520">c</span>&nbsp;<span class="op" id="4873522">==</span>&nbsp;<span class="string" id="4873525">&#39;_&#39;</span><span class="op" id="4873528">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4873532">p</span><span class="op" id="4873533">[</span><span class="num" id="4873534">0</span><span class="op" id="4873535">]</span>&nbsp;<span class="op" id="4873537">=</span>&nbsp;<span class="string" id="4873539">&#39;&nbsp;&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4873544">default</span><span class="op" id="4873551">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4873555">p</span><span class="op" id="4873556">[</span><span class="num" id="4873557">0</span><span class="op" id="4873558">]</span>&nbsp;<span class="op" id="4873560">=</span>&nbsp;<span class="ident" id="4873562">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4873565">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4873568">return</span>&nbsp;<span class="num" id="4873575">1</span><span class="op" id="4873576">,</span>&nbsp;<span class="builtintype" id="4873578">nil</span><br>
<span class="lineno"></span><span class="op" id="4873582">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4873585">var</span>&nbsp;<span class="ident" id="4873589">atextChars</span>&nbsp;<span class="op" id="4873600">=</span>&nbsp;<span class="op" id="4873602">[</span><span class="op" id="4873603">]</span><span class="builtintype" id="4873604">byte</span><span class="op" id="4873608">(</span><span class="string" id="4873609">&#34;ABCDEFGHIJKLMNOPQRSTUVWXYZ&#34;</span>&nbsp;<span class="op" id="4873638">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4873641">&#34;abcdefghijklmnopqrstuvwxyz&#34;</span>&nbsp;<span class="op" id="4873670">+</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4873673">&#34;0123456789&#34;</span>&nbsp;<span class="op" id="4873686">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4873689">&#34;!#$%&amp;&#39;*+-/=?^_`{|}~&#34;</span><span class="op" id="4873710">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4873713">//&nbsp;isAtext&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;atext&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="4873774">//&nbsp;If&nbsp;dot&nbsp;is&nbsp;true,&nbsp;period&nbsp;is&nbsp;included.</span><br>
<span class="lineno">530</span><span class="keyword" id="4873813">func</span>&nbsp;<span class="ident" id="4873818">isAtext</span><span class="op" id="4873825">(</span><span class="ident" id="4873826">c</span>&nbsp;<span class="builtintype" id="4873828">byte</span><span class="op" id="4873832">,</span>&nbsp;<span class="ident" id="4873834">dot</span>&nbsp;<span class="builtintype" id="4873838">bool</span><span class="op" id="4873842">)</span>&nbsp;<span class="builtintype" id="4873844">bool</span>&nbsp;<span class="op" id="4873849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4873852">if</span>&nbsp;<span class="ident" id="4873855">dot</span>&nbsp;<span class="op" id="4873859">&amp;&amp;</span>&nbsp;<span class="ident" id="4873862">c</span>&nbsp;<span class="op" id="4873864">==</span>&nbsp;<span class="string" id="4873867">&#39;.&#39;</span>&nbsp;<span class="op" id="4873871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4873875">return</span>&nbsp;<span class="builtintype" id="4873882">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4873888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4873891">return</span>&nbsp;<span class="ident" id="4873898">bytes</span><span class="op" id="4873903">.</span><span class="ident" id="4873904">IndexByte</span><span class="op" id="4873913">(</span><span class="ident" id="4873914">atextChars</span><span class="op" id="4873924">,</span>&nbsp;<span class="ident" id="4873926">c</span><span class="op" id="4873927">)</span>&nbsp;<span class="op" id="4873929">&gt;=</span>&nbsp;<span class="num" id="4873932">0</span><br>
<span class="lineno">535</span><span class="op" id="4873934">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4873937">//&nbsp;isQtext&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;qtext&nbsp;character.</span><br>
<span class="lineno"></span><span class="keyword" id="4873998">func</span>&nbsp;<span class="ident" id="4874003">isQtext</span><span class="op" id="4874010">(</span><span class="ident" id="4874011">c</span>&nbsp;<span class="builtintype" id="4874013">byte</span><span class="op" id="4874017">)</span>&nbsp;<span class="builtintype" id="4874019">bool</span>&nbsp;<span class="op" id="4874024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4874027">//&nbsp;Printable&nbsp;US-ASCII,&nbsp;excluding&nbsp;backslash&nbsp;or&nbsp;quote.</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4874081">if</span>&nbsp;<span class="ident" id="4874084">c</span>&nbsp;<span class="op" id="4874086">==</span>&nbsp;<span class="string" id="4874089">&#39;\\&#39;</span>&nbsp;<span class="op" id="4874094">||</span>&nbsp;<span class="ident" id="4874097">c</span>&nbsp;<span class="op" id="4874099">==</span>&nbsp;<span class="string" id="4874102">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="4874106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4874110">return</span>&nbsp;<span class="builtintype" id="4874117">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4874124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4874127">return</span>&nbsp;<span class="string" id="4874134">&#39;!&#39;</span>&nbsp;<span class="op" id="4874138">&lt;=</span>&nbsp;<span class="ident" id="4874141">c</span>&nbsp;<span class="op" id="4874143">&amp;&amp;</span>&nbsp;<span class="ident" id="4874146">c</span>&nbsp;<span class="op" id="4874148">&lt;=</span>&nbsp;<span class="string" id="4874151">&#39;~&#39;</span><br>
<span class="lineno"></span><span class="op" id="4874155">}</span><br>
<span class="lineno">545</span><br>
<span class="lineno"></span><span class="comment" id="4874158">//&nbsp;isVchar&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;VCHAR&nbsp;character.</span><br>
<span class="lineno"></span><span class="keyword" id="4874219">func</span>&nbsp;<span class="ident" id="4874224">isVchar</span><span class="op" id="4874231">(</span><span class="ident" id="4874232">c</span>&nbsp;<span class="builtintype" id="4874234">byte</span><span class="op" id="4874238">)</span>&nbsp;<span class="builtintype" id="4874240">bool</span>&nbsp;<span class="op" id="4874245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4874248">//&nbsp;Visible&nbsp;(printing)&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4874283">return</span>&nbsp;<span class="string" id="4874290">&#39;!&#39;</span>&nbsp;<span class="op" id="4874294">&lt;=</span>&nbsp;<span class="ident" id="4874297">c</span>&nbsp;<span class="op" id="4874299">&amp;&amp;</span>&nbsp;<span class="ident" id="4874302">c</span>&nbsp;<span class="op" id="4874304">&lt;=</span>&nbsp;<span class="string" id="4874307">&#39;~&#39;</span><br>
<span class="lineno">550</span><span class="op" id="4874311">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4874314">//&nbsp;isWSP&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;a&nbsp;WSP&nbsp;(white&nbsp;space).</span><br>
<span class="lineno"></span><span class="comment" id="4874365">//&nbsp;WSP&nbsp;is&nbsp;a&nbsp;space&nbsp;or&nbsp;horizontal&nbsp;tab&nbsp;(RFC5234&nbsp;Appendix&nbsp;B).</span><br>
<span class="lineno"></span><span class="keyword" id="4874423">func</span>&nbsp;<span class="ident" id="4874428">isWSP</span><span class="op" id="4874433">(</span><span class="ident" id="4874434">c</span>&nbsp;<span class="builtintype" id="4874436">byte</span><span class="op" id="4874440">)</span>&nbsp;<span class="builtintype" id="4874442">bool</span>&nbsp;<span class="op" id="4874447">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4874450">return</span>&nbsp;<span class="ident" id="4874457">c</span>&nbsp;<span class="op" id="4874459">==</span>&nbsp;<span class="string" id="4874462">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="4874466">||</span>&nbsp;<span class="ident" id="4874469">c</span>&nbsp;<span class="op" id="4874471">==</span>&nbsp;<span class="string" id="4874474">&#39;\t&#39;</span><br>
<span class="lineno"></span><span class="op" id="4874479">}</span>
</div>
</body>
</html>
