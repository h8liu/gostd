<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>html/template</h2>
<ul>
<li><a href="/gostd/html/template/attr.go.html">attr.go</a></li>
<li><a href="/gostd/html/template/clone_test.go.html">clone_test.go</a></li>
<li><a href="/gostd/html/template/content.go.html">content.go</a></li>
<li><a href="/gostd/html/template/content_test.go.html">content_test.go</a></li>
<li><a href="/gostd/html/template/context.go.html">context.go</a></li>
<li><a href="/gostd/html/template/css.go.html">css.go</a></li>
<li><a href="/gostd/html/template/css_test.go.html">css_test.go</a></li>
<li><a href="/gostd/html/template/doc.go.html">doc.go</a></li>
<li><a href="/gostd/html/template/error.go.html">error.go</a></li>
<li><a href="/gostd/html/template/escape.go.html">escape.go</a></li>
<li><a href="/gostd/html/template/escape_test.go.html">escape_test.go</a></li>
<li><a href="/gostd/html/template/html.go.html">html.go</a></li>
<li><a href="/gostd/html/template/html_test.go.html">html_test.go</a></li>
<li><a href="/gostd/html/template/js.go.html">js.go</a></li>
<li><a href="/gostd/html/template/js_test.go.html">js_test.go</a></li>
<li><a href="/gostd/html/template/template.go.html">template.go</a></li>
<li><a href="/gostd/html/template/transition.go.html">transition.go</a></li>
<li><a href="/gostd/html/template/url.go.html">url.go</a></li>
<li><a href="/gostd/html/template/url_test.go.html">url_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5233411">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5233466">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5233520">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5233571">package</span>&nbsp;<span class="ident" id="5233579">template</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5233589">import</span>&nbsp;<span class="op" id="5233596">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5233599">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5233608">&#34;encoding/json&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5233625">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5233632">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5233643">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5233654">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="5233669">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="5233672">//&nbsp;nextJSCtx&nbsp;returns&nbsp;the&nbsp;context&nbsp;that&nbsp;determines&nbsp;whether&nbsp;a&nbsp;slash&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5233747">//&nbsp;given&nbsp;run&nbsp;of&nbsp;tokens&nbsp;starts&nbsp;a&nbsp;regular&nbsp;expression&nbsp;instead&nbsp;of&nbsp;a&nbsp;division</span><br>
<span class="lineno"></span><span class="comment" id="5233820">//&nbsp;operator:&nbsp;/&nbsp;or&nbsp;/=.</span><br>
<span class="lineno"></span><span class="comment" id="5233842">//</span><br>
<span class="lineno">20</span><span class="comment" id="5233845">//&nbsp;This&nbsp;assumes&nbsp;that&nbsp;the&nbsp;token&nbsp;run&nbsp;does&nbsp;not&nbsp;include&nbsp;any&nbsp;string&nbsp;tokens,&nbsp;comment</span><br>
<span class="lineno"></span><span class="comment" id="5233924">//&nbsp;tokens,&nbsp;regular&nbsp;expression&nbsp;literal&nbsp;tokens,&nbsp;or&nbsp;division&nbsp;operators.</span><br>
<span class="lineno"></span><span class="comment" id="5233993">//</span><br>
<span class="lineno"></span><span class="comment" id="5233996">//&nbsp;This&nbsp;fails&nbsp;on&nbsp;some&nbsp;valid&nbsp;but&nbsp;nonsensical&nbsp;JavaScript&nbsp;programs&nbsp;like</span><br>
<span class="lineno"></span><span class="comment" id="5234065">//&nbsp;&#34;x&nbsp;=&nbsp;++/foo/i&#34;&nbsp;which&nbsp;is&nbsp;quite&nbsp;different&nbsp;than&nbsp;&#34;x++/foo/i&#34;,&nbsp;but&nbsp;is&nbsp;not&nbsp;known&nbsp;to</span><br>
<span class="lineno">25</span><span class="comment" id="5234146">//&nbsp;fail&nbsp;on&nbsp;any&nbsp;known&nbsp;useful&nbsp;programs.&nbsp;It&nbsp;is&nbsp;based&nbsp;on&nbsp;the&nbsp;draft</span><br>
<span class="lineno"></span><span class="comment" id="5234209">//&nbsp;JavaScript&nbsp;2.0&nbsp;lexical&nbsp;grammar&nbsp;and&nbsp;requires&nbsp;one&nbsp;token&nbsp;of&nbsp;lookbehind:</span><br>
<span class="lineno"></span><span class="comment" id="5234281">//&nbsp;http://www.mozilla.org/js/language/js20-2000-07/rationale/syntax.html</span><br>
<span class="lineno"></span><span class="keyword" id="5234354">func</span>&nbsp;<span class="ident" id="5234359">nextJSCtx</span><span class="op" id="5234368">(</span><span class="ident" id="5234369">s</span>&nbsp;<span class="op" id="5234371">[</span><span class="op" id="5234372">]</span><span class="builtintype" id="5234373">byte</span><span class="op" id="5234377">,</span>&nbsp;<span class="ident" id="5234379">preceding</span>&nbsp;<span class="ident" id="5234389">jsCtx</span><span class="op" id="5234394">)</span>&nbsp;<span class="ident" id="5234396">jsCtx</span>&nbsp;<span class="op" id="5234402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5234405">s</span>&nbsp;<span class="op" id="5234407">=</span>&nbsp;<span class="ident" id="5234409">bytes</span><span class="op" id="5234414">.</span><span class="ident" id="5234415">TrimRight</span><span class="op" id="5234424">(</span><span class="ident" id="5234425">s</span><span class="op" id="5234426">,</span>&nbsp;<span class="string" id="5234428">&#34;\t\n\f\r&nbsp;\u2028\u2029&#34;</span><span class="op" id="5234451">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5234454">if</span>&nbsp;<span class="builtinfunc" id="5234457">len</span><span class="op" id="5234460">(</span><span class="ident" id="5234461">s</span><span class="op" id="5234462">)</span>&nbsp;<span class="op" id="5234464">==</span>&nbsp;<span class="num" id="5234467">0</span>&nbsp;<span class="op" id="5234469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5234473">return</span>&nbsp;<span class="ident" id="5234480">preceding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5234491">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5234495">//&nbsp;All&nbsp;cases&nbsp;below&nbsp;are&nbsp;in&nbsp;the&nbsp;single-byte&nbsp;UTF-8&nbsp;group.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5234551">switch</span>&nbsp;<span class="ident" id="5234558">c</span><span class="op" id="5234559">,</span>&nbsp;<span class="ident" id="5234561">n</span>&nbsp;<span class="op" id="5234563">:=</span>&nbsp;<span class="ident" id="5234566">s</span><span class="op" id="5234567">[</span><span class="builtinfunc" id="5234568">len</span><span class="op" id="5234571">(</span><span class="ident" id="5234572">s</span><span class="op" id="5234573">)</span><span class="op" id="5234574">-</span><span class="num" id="5234575">1</span><span class="op" id="5234576">]</span><span class="op" id="5234577">,</span>&nbsp;<span class="builtinfunc" id="5234579">len</span><span class="op" id="5234582">(</span><span class="ident" id="5234583">s</span><span class="op" id="5234584">)</span><span class="op" id="5234585">;</span>&nbsp;<span class="ident" id="5234587">c</span>&nbsp;<span class="op" id="5234589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5234592">case</span>&nbsp;<span class="string" id="5234597">&#39;+&#39;</span><span class="op" id="5234600">,</span>&nbsp;<span class="string" id="5234602">&#39;-&#39;</span><span class="op" id="5234605">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5234609">//&nbsp;++&nbsp;and&nbsp;--&nbsp;are&nbsp;not&nbsp;regexp&nbsp;preceders,&nbsp;but&nbsp;+&nbsp;and&nbsp;-&nbsp;are&nbsp;whether</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5234674">//&nbsp;they&nbsp;are&nbsp;used&nbsp;as&nbsp;infix&nbsp;or&nbsp;prefix&nbsp;operators.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5234723">start</span>&nbsp;<span class="op" id="5234729">:=</span>&nbsp;<span class="ident" id="5234732">n</span>&nbsp;<span class="op" id="5234734">-</span>&nbsp;<span class="num" id="5234736">1</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5234740">//&nbsp;Count&nbsp;the&nbsp;number&nbsp;of&nbsp;adjacent&nbsp;dashes&nbsp;or&nbsp;pluses.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5234792">for</span>&nbsp;<span class="ident" id="5234796">start</span>&nbsp;<span class="op" id="5234802">&gt;</span>&nbsp;<span class="num" id="5234804">0</span>&nbsp;<span class="op" id="5234806">&amp;&amp;</span>&nbsp;<span class="ident" id="5234809">s</span><span class="op" id="5234810">[</span><span class="ident" id="5234811">start</span><span class="op" id="5234816">-</span><span class="num" id="5234817">1</span><span class="op" id="5234818">]</span>&nbsp;<span class="op" id="5234820">==</span>&nbsp;<span class="ident" id="5234823">c</span>&nbsp;<span class="op" id="5234825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5234830">start</span><span class="op" id="5234835">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5234840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5234844">if</span>&nbsp;<span class="op" id="5234847">(</span><span class="ident" id="5234848">n</span><span class="op" id="5234849">-</span><span class="ident" id="5234850">start</span><span class="op" id="5234855">)</span><span class="op" id="5234856">&amp;</span><span class="num" id="5234857">1</span>&nbsp;<span class="op" id="5234859">==</span>&nbsp;<span class="num" id="5234862">1</span>&nbsp;<span class="op" id="5234864">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5234869">//&nbsp;Reached&nbsp;for&nbsp;trailing&nbsp;minus&nbsp;signs&nbsp;since&nbsp;&#34;---&#34;&nbsp;is&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5234927">//&nbsp;same&nbsp;as&nbsp;&#34;--&nbsp;-&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5234949">return</span>&nbsp;<span class="ident" id="5234956">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5234970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5234974">return</span>&nbsp;<span class="ident" id="5234981">jsCtxDivOp</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5234993">case</span>&nbsp;<span class="string" id="5234998">&#39;.&#39;</span><span class="op" id="5235001">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5235005">//&nbsp;Handle&nbsp;&#34;42.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5235023">if</span>&nbsp;<span class="ident" id="5235026">n</span>&nbsp;<span class="op" id="5235028">!=</span>&nbsp;<span class="num" id="5235031">1</span>&nbsp;<span class="op" id="5235033">&amp;&amp;</span>&nbsp;<span class="string" id="5235036">&#39;0&#39;</span>&nbsp;<span class="op" id="5235040">&lt;=</span>&nbsp;<span class="ident" id="5235043">s</span><span class="op" id="5235044">[</span><span class="ident" id="5235045">n</span><span class="op" id="5235046">-</span><span class="num" id="5235047">2</span><span class="op" id="5235048">]</span>&nbsp;<span class="op" id="5235050">&amp;&amp;</span>&nbsp;<span class="ident" id="5235053">s</span><span class="op" id="5235054">[</span><span class="ident" id="5235055">n</span><span class="op" id="5235056">-</span><span class="num" id="5235057">2</span><span class="op" id="5235058">]</span>&nbsp;<span class="op" id="5235060">&lt;=</span>&nbsp;<span class="string" id="5235063">&#39;9&#39;</span>&nbsp;<span class="op" id="5235067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5235072">return</span>&nbsp;<span class="ident" id="5235079">jsCtxDivOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5235092">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5235096">return</span>&nbsp;<span class="ident" id="5235103">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5235116">//&nbsp;Suffixes&nbsp;for&nbsp;all&nbsp;punctuators&nbsp;from&nbsp;section&nbsp;7.7&nbsp;of&nbsp;the&nbsp;language&nbsp;spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5235187">//&nbsp;that&nbsp;only&nbsp;end&nbsp;binary&nbsp;operators&nbsp;not&nbsp;handled&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5235241">case</span>&nbsp;<span class="string" id="5235246">&#39;,&#39;</span><span class="op" id="5235249">,</span>&nbsp;<span class="string" id="5235251">&#39;&lt;&#39;</span><span class="op" id="5235254">,</span>&nbsp;<span class="string" id="5235256">&#39;&gt;&#39;</span><span class="op" id="5235259">,</span>&nbsp;<span class="string" id="5235261">&#39;=&#39;</span><span class="op" id="5235264">,</span>&nbsp;<span class="string" id="5235266">&#39;*&#39;</span><span class="op" id="5235269">,</span>&nbsp;<span class="string" id="5235271">&#39;%&#39;</span><span class="op" id="5235274">,</span>&nbsp;<span class="string" id="5235276">&#39;&amp;&#39;</span><span class="op" id="5235279">,</span>&nbsp;<span class="string" id="5235281">&#39;|&#39;</span><span class="op" id="5235284">,</span>&nbsp;<span class="string" id="5235286">&#39;^&#39;</span><span class="op" id="5235289">,</span>&nbsp;<span class="string" id="5235291">&#39;?&#39;</span><span class="op" id="5235294">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5235298">return</span>&nbsp;<span class="ident" id="5235305">jsCtxRegexp</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5235318">//&nbsp;Suffixes&nbsp;for&nbsp;all&nbsp;punctuators&nbsp;from&nbsp;section&nbsp;7.7&nbsp;of&nbsp;the&nbsp;language&nbsp;spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5235389">//&nbsp;that&nbsp;are&nbsp;prefix&nbsp;operators&nbsp;not&nbsp;handled&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5235438">case</span>&nbsp;<span class="string" id="5235443">&#39;!&#39;</span><span class="op" id="5235446">,</span>&nbsp;<span class="string" id="5235448">&#39;~&#39;</span><span class="op" id="5235451">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5235455">return</span>&nbsp;<span class="ident" id="5235462">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5235475">//&nbsp;Matches&nbsp;all&nbsp;the&nbsp;punctuators&nbsp;from&nbsp;section&nbsp;7.7&nbsp;of&nbsp;the&nbsp;language&nbsp;spec</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5235545">//&nbsp;that&nbsp;are&nbsp;open&nbsp;brackets&nbsp;not&nbsp;handled&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5235591">case</span>&nbsp;<span class="string" id="5235596">&#39;(&#39;</span><span class="op" id="5235599">,</span>&nbsp;<span class="string" id="5235601">&#39;[&#39;</span><span class="op" id="5235604">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5235608">return</span>&nbsp;<span class="ident" id="5235615">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5235628">//&nbsp;Matches&nbsp;all&nbsp;the&nbsp;punctuators&nbsp;from&nbsp;section&nbsp;7.7&nbsp;of&nbsp;the&nbsp;language&nbsp;spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5235698">//&nbsp;that&nbsp;precede&nbsp;expression&nbsp;starts.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5235734">case</span>&nbsp;<span class="string" id="5235739">&#39;:&#39;</span><span class="op" id="5235742">,</span>&nbsp;<span class="string" id="5235744">&#39;;&#39;</span><span class="op" id="5235747">,</span>&nbsp;<span class="string" id="5235749">&#39;{&#39;</span><span class="op" id="5235752">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5235756">return</span>&nbsp;<span class="ident" id="5235763">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5235776">//&nbsp;CAVEAT:&nbsp;the&nbsp;close&nbsp;punctuators&nbsp;(&#39;}&#39;,&nbsp;&#39;]&#39;,&nbsp;&#39;)&#39;)&nbsp;precede&nbsp;div&nbsp;ops&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5235846">//&nbsp;are&nbsp;handled&nbsp;in&nbsp;the&nbsp;default&nbsp;except&nbsp;for&nbsp;&#39;}&#39;&nbsp;which&nbsp;can&nbsp;precede&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5235912">//&nbsp;division&nbsp;op&nbsp;as&nbsp;in</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5235934">//&nbsp;&nbsp;&nbsp;&nbsp;({&nbsp;valueOf:&nbsp;function&nbsp;()&nbsp;{&nbsp;return&nbsp;42&nbsp;}&nbsp;}&nbsp;/&nbsp;2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5235985">//&nbsp;which&nbsp;is&nbsp;valid,&nbsp;but,&nbsp;in&nbsp;practice,&nbsp;developers&nbsp;don&#39;t&nbsp;divide&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5236054">//&nbsp;literals,&nbsp;so&nbsp;our&nbsp;heuristic&nbsp;works&nbsp;well&nbsp;for&nbsp;code&nbsp;like</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5236110">//&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;()&nbsp;{&nbsp;...&nbsp;}&nbsp;&nbsp;/foo/.test(x)&nbsp;&amp;&amp;&nbsp;sideEffect();</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5236169">//&nbsp;The&nbsp;&#39;)&#39;&nbsp;punctuator&nbsp;can&nbsp;precede&nbsp;a&nbsp;regular&nbsp;expression&nbsp;as&nbsp;in</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5236231">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(b)&nbsp;/foo/.test(x)&nbsp;&amp;&amp;&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5236267">//&nbsp;but&nbsp;this&nbsp;is&nbsp;much&nbsp;less&nbsp;likely&nbsp;than</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5236305">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(a&nbsp;+&nbsp;b)&nbsp;/&nbsp;c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5236325">case</span>&nbsp;<span class="string" id="5236330">&#39;}&#39;</span><span class="op" id="5236333">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5236337">return</span>&nbsp;<span class="ident" id="5236344">jsCtxRegexp</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5236357">default</span><span class="op" id="5236364">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5236368">//&nbsp;Look&nbsp;for&nbsp;an&nbsp;IdentifierName&nbsp;and&nbsp;see&nbsp;if&nbsp;it&nbsp;is&nbsp;a&nbsp;keyword&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5236432">//&nbsp;can&nbsp;precede&nbsp;a&nbsp;regular&nbsp;expression.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5236471">j</span>&nbsp;<span class="op" id="5236473">:=</span>&nbsp;<span class="ident" id="5236476">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5236480">for</span>&nbsp;<span class="ident" id="5236484">j</span>&nbsp;<span class="op" id="5236486">&gt;</span>&nbsp;<span class="num" id="5236488">0</span>&nbsp;<span class="op" id="5236490">&amp;&amp;</span>&nbsp;<span class="ident" id="5236493">isJSIdentPart</span><span class="op" id="5236506">(</span><span class="builtintype" id="5236507">rune</span><span class="op" id="5236511">(</span><span class="ident" id="5236512">s</span><span class="op" id="5236513">[</span><span class="ident" id="5236514">j</span><span class="op" id="5236515">-</span><span class="num" id="5236516">1</span><span class="op" id="5236517">]</span><span class="op" id="5236518">)</span><span class="op" id="5236519">)</span>&nbsp;<span class="op" id="5236521">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5236526">j</span><span class="op" id="5236527">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5236532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5236536">if</span>&nbsp;<span class="ident" id="5236539">regexpPrecederKeywords</span><span class="op" id="5236561">[</span><span class="builtintype" id="5236562">string</span><span class="op" id="5236568">(</span><span class="ident" id="5236569">s</span><span class="op" id="5236570">[</span><span class="ident" id="5236571">j</span><span class="op" id="5236572">:</span><span class="op" id="5236573">]</span><span class="op" id="5236574">)</span><span class="op" id="5236575">]</span>&nbsp;<span class="op" id="5236577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5236582">return</span>&nbsp;<span class="ident" id="5236589">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5236603">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5236606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5236609">//&nbsp;Otherwise&nbsp;is&nbsp;a&nbsp;punctuator&nbsp;not&nbsp;listed&nbsp;above,&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5236660">//&nbsp;a&nbsp;string&nbsp;which&nbsp;precedes&nbsp;a&nbsp;div&nbsp;op,&nbsp;or&nbsp;an&nbsp;identifier</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5236715">//&nbsp;which&nbsp;precedes&nbsp;a&nbsp;div&nbsp;op.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5236744">return</span>&nbsp;<span class="ident" id="5236751">jsCtxDivOp</span><br>
<span class="lineno">100</span><span class="op" id="5236762">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5236765">//&nbsp;regexpPrecederKeywords&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;reserved&nbsp;JS&nbsp;keywords&nbsp;that&nbsp;can&nbsp;precede&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5236843">//&nbsp;regular&nbsp;expression&nbsp;in&nbsp;JS&nbsp;source.</span><br>
<span class="lineno"></span><span class="keyword" id="5236879">var</span>&nbsp;<span class="ident" id="5236883">regexpPrecederKeywords</span>&nbsp;<span class="op" id="5236906">=</span>&nbsp;<span class="keyword" id="5236908">map</span><span class="op" id="5236911">[</span><span class="builtintype" id="5236912">string</span><span class="op" id="5236918">]</span><span class="builtintype" id="5236919">bool</span><span class="op" id="5236923">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5236926">&#34;break&#34;</span><span class="op" id="5236933">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5236940">true</span><span class="op" id="5236944">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5236947">&#34;case&#34;</span><span class="op" id="5236953">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5236961">true</span><span class="op" id="5236965">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5236968">&#34;continue&#34;</span><span class="op" id="5236978">:</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5236982">true</span><span class="op" id="5236986">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5236989">&#34;delete&#34;</span><span class="op" id="5236997">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5237003">true</span><span class="op" id="5237007">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5237010">&#34;do&#34;</span><span class="op" id="5237014">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5237024">true</span><span class="op" id="5237028">,</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5237031">&#34;else&#34;</span><span class="op" id="5237037">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5237045">true</span><span class="op" id="5237049">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5237052">&#34;finally&#34;</span><span class="op" id="5237061">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5237066">true</span><span class="op" id="5237070">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5237073">&#34;in&#34;</span><span class="op" id="5237077">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5237087">true</span><span class="op" id="5237091">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5237094">&#34;instanceof&#34;</span><span class="op" id="5237106">:</span>&nbsp;<span class="builtintype" id="5237108">true</span><span class="op" id="5237112">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5237115">&#34;return&#34;</span><span class="op" id="5237123">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5237129">true</span><span class="op" id="5237133">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5237136">&#34;throw&#34;</span><span class="op" id="5237143">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5237150">true</span><span class="op" id="5237154">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5237157">&#34;try&#34;</span><span class="op" id="5237162">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5237171">true</span><span class="op" id="5237175">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5237178">&#34;typeof&#34;</span><span class="op" id="5237186">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5237192">true</span><span class="op" id="5237196">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5237199">&#34;void&#34;</span><span class="op" id="5237205">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5237213">true</span><span class="op" id="5237217">,</span><br>
<span class="lineno"></span><span class="op" id="5237219">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="keyword" id="5237222">var</span>&nbsp;<span class="ident" id="5237226">jsonMarshalType</span>&nbsp;<span class="op" id="5237242">=</span>&nbsp;<span class="ident" id="5237244">reflect</span><span class="op" id="5237251">.</span><span class="ident" id="5237252">TypeOf</span><span class="op" id="5237258">(</span><span class="op" id="5237259">(</span><span class="op" id="5237260">*</span><span class="ident" id="5237261">json</span><span class="op" id="5237265">.</span><span class="ident" id="5237266">Marshaler</span><span class="op" id="5237275">)</span><span class="op" id="5237276">(</span><span class="ident" id="5237277">nil</span><span class="op" id="5237280">)</span><span class="op" id="5237281">)</span><span class="op" id="5237282">.</span><span class="ident" id="5237283">Elem</span><span class="op" id="5237287">(</span><span class="op" id="5237288">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5237291">//&nbsp;indirectToJSONMarshaler&nbsp;returns&nbsp;the&nbsp;value,&nbsp;after&nbsp;dereferencing&nbsp;as&nbsp;many&nbsp;times</span><br>
<span class="lineno"></span><span class="comment" id="5237371">//&nbsp;as&nbsp;necessary&nbsp;to&nbsp;reach&nbsp;the&nbsp;base&nbsp;type&nbsp;(or&nbsp;nil)&nbsp;or&nbsp;an&nbsp;implementation&nbsp;of&nbsp;json.Marshal.</span><br>
<span class="lineno">125</span><span class="keyword" id="5237457">func</span>&nbsp;<span class="ident" id="5237462">indirectToJSONMarshaler</span><span class="op" id="5237485">(</span><span class="ident" id="5237486">a</span>&nbsp;<span class="keyword" id="5237488">interface</span><span class="op" id="5237497">{</span><span class="op" id="5237498">}</span><span class="op" id="5237499">)</span>&nbsp;<span class="keyword" id="5237501">interface</span><span class="op" id="5237510">{</span><span class="op" id="5237511">}</span>&nbsp;<span class="op" id="5237513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5237516">v</span>&nbsp;<span class="op" id="5237518">:=</span>&nbsp;<span class="ident" id="5237521">reflect</span><span class="op" id="5237528">.</span><span class="ident" id="5237529">ValueOf</span><span class="op" id="5237536">(</span><span class="ident" id="5237537">a</span><span class="op" id="5237538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5237541">for</span>&nbsp;<span class="op" id="5237545">!</span><span class="ident" id="5237546">v</span><span class="op" id="5237547">.</span><span class="ident" id="5237548">Type</span><span class="op" id="5237552">(</span><span class="op" id="5237553">)</span><span class="op" id="5237554">.</span><span class="ident" id="5237555">Implements</span><span class="op" id="5237565">(</span><span class="ident" id="5237566">jsonMarshalType</span><span class="op" id="5237581">)</span>&nbsp;<span class="op" id="5237583">&amp;&amp;</span>&nbsp;<span class="ident" id="5237586">v</span><span class="op" id="5237587">.</span><span class="ident" id="5237588">Kind</span><span class="op" id="5237592">(</span><span class="op" id="5237593">)</span>&nbsp;<span class="op" id="5237595">==</span>&nbsp;<span class="ident" id="5237598">reflect</span><span class="op" id="5237605">.</span><span class="ident" id="5237606">Ptr</span>&nbsp;<span class="op" id="5237610">&amp;&amp;</span>&nbsp;<span class="op" id="5237613">!</span><span class="ident" id="5237614">v</span><span class="op" id="5237615">.</span><span class="ident" id="5237616">IsNil</span><span class="op" id="5237621">(</span><span class="op" id="5237622">)</span>&nbsp;<span class="op" id="5237624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5237628">v</span>&nbsp;<span class="op" id="5237630">=</span>&nbsp;<span class="ident" id="5237632">v</span><span class="op" id="5237633">.</span><span class="ident" id="5237634">Elem</span><span class="op" id="5237638">(</span><span class="op" id="5237639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5237642">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5237645">return</span>&nbsp;<span class="ident" id="5237652">v</span><span class="op" id="5237653">.</span><span class="ident" id="5237654">Interface</span><span class="op" id="5237663">(</span><span class="op" id="5237664">)</span><br>
<span class="lineno"></span><span class="op" id="5237666">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5237669">//&nbsp;jsValEscaper&nbsp;escapes&nbsp;its&nbsp;inputs&nbsp;to&nbsp;a&nbsp;JS&nbsp;Expression&nbsp;(section&nbsp;11.14)&nbsp;that&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="5237748">//&nbsp;neither&nbsp;side-effects&nbsp;nor&nbsp;free&nbsp;variables&nbsp;outside&nbsp;(NaN,&nbsp;Infinity).</span><br>
<span class="lineno">135</span><span class="keyword" id="5237816">func</span>&nbsp;<span class="ident" id="5237821">jsValEscaper</span><span class="op" id="5237833">(</span><span class="ident" id="5237834">args</span>&nbsp;<span class="op" id="5237839">...</span><span class="keyword" id="5237842">interface</span><span class="op" id="5237851">{</span><span class="op" id="5237852">}</span><span class="op" id="5237853">)</span>&nbsp;<span class="builtintype" id="5237855">string</span>&nbsp;<span class="op" id="5237862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5237865">var</span>&nbsp;<span class="ident" id="5237869">a</span>&nbsp;<span class="keyword" id="5237871">interface</span><span class="op" id="5237880">{</span><span class="op" id="5237881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5237884">if</span>&nbsp;<span class="builtinfunc" id="5237887">len</span><span class="op" id="5237890">(</span><span class="ident" id="5237891">args</span><span class="op" id="5237895">)</span>&nbsp;<span class="op" id="5237897">==</span>&nbsp;<span class="num" id="5237900">1</span>&nbsp;<span class="op" id="5237902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5237906">a</span>&nbsp;<span class="op" id="5237908">=</span>&nbsp;<span class="ident" id="5237910">indirectToJSONMarshaler</span><span class="op" id="5237933">(</span><span class="ident" id="5237934">args</span><span class="op" id="5237938">[</span><span class="num" id="5237939">0</span><span class="op" id="5237940">]</span><span class="op" id="5237941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5237945">switch</span>&nbsp;<span class="ident" id="5237952">t</span>&nbsp;<span class="op" id="5237954">:=</span>&nbsp;<span class="ident" id="5237957">a</span><span class="op" id="5237958">.</span><span class="op" id="5237959">(</span><span class="keyword" id="5237960">type</span><span class="op" id="5237964">)</span>&nbsp;<span class="op" id="5237966">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5237970">case</span>&nbsp;<span class="ident" id="5237975">JS</span><span class="op" id="5237977">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5237982">return</span>&nbsp;<span class="builtintype" id="5237989">string</span><span class="op" id="5237995">(</span><span class="ident" id="5237996">t</span><span class="op" id="5237997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238001">case</span>&nbsp;<span class="ident" id="5238006">JSStr</span><span class="op" id="5238011">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5238016">//&nbsp;TODO:&nbsp;normalize&nbsp;quotes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238046">return</span>&nbsp;<span class="string" id="5238053">`&#34;`</span>&nbsp;<span class="op" id="5238057">+</span>&nbsp;<span class="builtintype" id="5238059">string</span><span class="op" id="5238065">(</span><span class="ident" id="5238066">t</span><span class="op" id="5238067">)</span>&nbsp;<span class="op" id="5238069">+</span>&nbsp;<span class="string" id="5238071">`&#34;`</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238077">case</span>&nbsp;<span class="ident" id="5238082">json</span><span class="op" id="5238086">.</span><span class="ident" id="5238087">Marshaler</span><span class="op" id="5238096">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5238101">//&nbsp;Do&nbsp;not&nbsp;treat&nbsp;as&nbsp;a&nbsp;Stringer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238134">case</span>&nbsp;<span class="ident" id="5238139">fmt</span><span class="op" id="5238142">.</span><span class="ident" id="5238143">Stringer</span><span class="op" id="5238151">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238156">a</span>&nbsp;<span class="op" id="5238158">=</span>&nbsp;<span class="ident" id="5238160">t</span><span class="op" id="5238161">.</span><span class="ident" id="5238162">String</span><span class="op" id="5238168">(</span><span class="op" id="5238169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5238173">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5238176">}</span>&nbsp;<span class="keyword" id="5238178">else</span>&nbsp;<span class="op" id="5238183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238187">for</span>&nbsp;<span class="ident" id="5238191">i</span><span class="op" id="5238192">,</span>&nbsp;<span class="ident" id="5238194">arg</span>&nbsp;<span class="op" id="5238198">:=</span>&nbsp;<span class="keyword" id="5238201">range</span>&nbsp;<span class="ident" id="5238207">args</span>&nbsp;<span class="op" id="5238212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238217">args</span><span class="op" id="5238221">[</span><span class="ident" id="5238222">i</span><span class="op" id="5238223">]</span>&nbsp;<span class="op" id="5238225">=</span>&nbsp;<span class="ident" id="5238227">indirectToJSONMarshaler</span><span class="op" id="5238250">(</span><span class="ident" id="5238251">arg</span><span class="op" id="5238254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5238258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238262">a</span>&nbsp;<span class="op" id="5238264">=</span>&nbsp;<span class="ident" id="5238266">fmt</span><span class="op" id="5238269">.</span><span class="ident" id="5238270">Sprint</span><span class="op" id="5238276">(</span><span class="ident" id="5238277">args</span><span class="op" id="5238281">...</span><span class="op" id="5238284">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5238287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5238290">//&nbsp;TODO:&nbsp;detect&nbsp;cycles&nbsp;before&nbsp;calling&nbsp;Marshal&nbsp;which&nbsp;loops&nbsp;infinitely&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5238363">//&nbsp;cyclic&nbsp;data.&nbsp;This&nbsp;may&nbsp;be&nbsp;an&nbsp;unacceptable&nbsp;DoS&nbsp;risk.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238419">b</span><span class="op" id="5238420">,</span>&nbsp;<span class="ident" id="5238422">err</span>&nbsp;<span class="op" id="5238426">:=</span>&nbsp;<span class="ident" id="5238429">json</span><span class="op" id="5238433">.</span><span class="ident" id="5238434">Marshal</span><span class="op" id="5238441">(</span><span class="ident" id="5238442">a</span><span class="op" id="5238443">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238446">if</span>&nbsp;<span class="ident" id="5238449">err</span>&nbsp;<span class="op" id="5238453">!=</span>&nbsp;<span class="ident" id="5238456">nil</span>&nbsp;<span class="op" id="5238460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5238464">//&nbsp;Put&nbsp;a&nbsp;space&nbsp;before&nbsp;comment&nbsp;so&nbsp;that&nbsp;if&nbsp;it&nbsp;is&nbsp;flush&nbsp;against</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5238527">//&nbsp;a&nbsp;division&nbsp;operator&nbsp;it&nbsp;is&nbsp;not&nbsp;turned&nbsp;into&nbsp;a&nbsp;line&nbsp;comment:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5238590">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x/{{y}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5238607">//&nbsp;turning&nbsp;into</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5238625">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x//*&nbsp;error&nbsp;marshalling&nbsp;y:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5238660">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;second&nbsp;line&nbsp;of&nbsp;error&nbsp;message&nbsp;*/null</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238710">return</span>&nbsp;<span class="ident" id="5238717">fmt</span><span class="op" id="5238720">.</span><span class="ident" id="5238721">Sprintf</span><span class="op" id="5238728">(</span><span class="string" id="5238729">&#34;&nbsp;/*&nbsp;%s&nbsp;*/null&nbsp;&#34;</span><span class="op" id="5238745">,</span>&nbsp;<span class="ident" id="5238747">strings</span><span class="op" id="5238754">.</span><span class="ident" id="5238755">Replace</span><span class="op" id="5238762">(</span><span class="ident" id="5238763">err</span><span class="op" id="5238766">.</span><span class="ident" id="5238767">Error</span><span class="op" id="5238772">(</span><span class="op" id="5238773">)</span><span class="op" id="5238774">,</span>&nbsp;<span class="string" id="5238776">&#34;*/&#34;</span><span class="op" id="5238780">,</span>&nbsp;<span class="string" id="5238782">&#34;*&nbsp;/&#34;</span><span class="op" id="5238787">,</span>&nbsp;<span class="op" id="5238789">-</span><span class="num" id="5238790">1</span><span class="op" id="5238791">)</span><span class="op" id="5238792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5238795">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5238799">//&nbsp;TODO:&nbsp;maybe&nbsp;post-process&nbsp;output&nbsp;to&nbsp;prevent&nbsp;it&nbsp;from&nbsp;containing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5238865">//&nbsp;&#34;&lt;!--&#34;,&nbsp;&#34;--&gt;&#34;,&nbsp;&#34;&lt;![CDATA[&#34;,&nbsp;&#34;]]&gt;&#34;,&nbsp;or&nbsp;&#34;&lt;/script&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5238918">//&nbsp;in&nbsp;case&nbsp;custom&nbsp;marshallers&nbsp;produce&nbsp;output&nbsp;containing&nbsp;those.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5238983">//&nbsp;TODO:&nbsp;Maybe&nbsp;abbreviate&nbsp;\u00ab&nbsp;to&nbsp;\xab&nbsp;to&nbsp;produce&nbsp;more&nbsp;compact&nbsp;output.</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5239057">if</span>&nbsp;<span class="builtinfunc" id="5239060">len</span><span class="op" id="5239063">(</span><span class="ident" id="5239064">b</span><span class="op" id="5239065">)</span>&nbsp;<span class="op" id="5239067">==</span>&nbsp;<span class="num" id="5239070">0</span>&nbsp;<span class="op" id="5239072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5239076">//&nbsp;In,&nbsp;`x=y/{{.}}*z`&nbsp;a&nbsp;json.Marshaler&nbsp;that&nbsp;produces&nbsp;&#34;&#34;&nbsp;should</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5239140">//&nbsp;not&nbsp;cause&nbsp;the&nbsp;output&nbsp;`x=y/*z`.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5239176">return</span>&nbsp;<span class="string" id="5239183">&#34;&nbsp;null&nbsp;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5239193">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239196">first</span><span class="op" id="5239201">,</span>&nbsp;<span class="ident" id="5239203">_</span>&nbsp;<span class="op" id="5239205">:=</span>&nbsp;<span class="ident" id="5239208">utf8</span><span class="op" id="5239212">.</span><span class="ident" id="5239213">DecodeRune</span><span class="op" id="5239223">(</span><span class="ident" id="5239224">b</span><span class="op" id="5239225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239228">last</span><span class="op" id="5239232">,</span>&nbsp;<span class="ident" id="5239234">_</span>&nbsp;<span class="op" id="5239236">:=</span>&nbsp;<span class="ident" id="5239239">utf8</span><span class="op" id="5239243">.</span><span class="ident" id="5239244">DecodeLastRune</span><span class="op" id="5239258">(</span><span class="ident" id="5239259">b</span><span class="op" id="5239260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5239263">var</span>&nbsp;<span class="ident" id="5239267">buf</span>&nbsp;<span class="ident" id="5239271">bytes</span><span class="op" id="5239276">.</span><span class="ident" id="5239277">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5239285">//&nbsp;Prevent&nbsp;IdentifierNames&nbsp;and&nbsp;NumericLiterals&nbsp;from&nbsp;running&nbsp;into</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5239351">//&nbsp;keywords:&nbsp;in,&nbsp;instanceof,&nbsp;typeof,&nbsp;void</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239394">pad</span>&nbsp;<span class="op" id="5239398">:=</span>&nbsp;<span class="ident" id="5239401">isJSIdentPart</span><span class="op" id="5239414">(</span><span class="ident" id="5239415">first</span><span class="op" id="5239420">)</span>&nbsp;<span class="op" id="5239422">||</span>&nbsp;<span class="ident" id="5239425">isJSIdentPart</span><span class="op" id="5239438">(</span><span class="ident" id="5239439">last</span><span class="op" id="5239443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5239446">if</span>&nbsp;<span class="ident" id="5239449">pad</span>&nbsp;<span class="op" id="5239453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239457">buf</span><span class="op" id="5239460">.</span><span class="ident" id="5239461">WriteByte</span><span class="op" id="5239470">(</span><span class="string" id="5239471">&#39;&nbsp;&#39;</span><span class="op" id="5239474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5239477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239480">written</span>&nbsp;<span class="op" id="5239488">:=</span>&nbsp;<span class="num" id="5239491">0</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5239494">//&nbsp;Make&nbsp;sure&nbsp;that&nbsp;json.Marshal&nbsp;escapes&nbsp;codepoints&nbsp;U+2028&nbsp;&amp;&nbsp;U+2029</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5239561">//&nbsp;so&nbsp;it&nbsp;falls&nbsp;within&nbsp;the&nbsp;subset&nbsp;of&nbsp;JSON&nbsp;which&nbsp;is&nbsp;valid&nbsp;JS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5239622">for</span>&nbsp;<span class="ident" id="5239626">i</span>&nbsp;<span class="op" id="5239628">:=</span>&nbsp;<span class="num" id="5239631">0</span><span class="op" id="5239632">;</span>&nbsp;<span class="ident" id="5239634">i</span>&nbsp;<span class="op" id="5239636">&lt;</span>&nbsp;<span class="builtinfunc" id="5239638">len</span><span class="op" id="5239641">(</span><span class="ident" id="5239642">b</span><span class="op" id="5239643">)</span><span class="op" id="5239644">;</span>&nbsp;<span class="op" id="5239646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="5239650">rune</span><span class="op" id="5239654">,</span>&nbsp;<span class="ident" id="5239656">n</span>&nbsp;<span class="op" id="5239658">:=</span>&nbsp;<span class="ident" id="5239661">utf8</span><span class="op" id="5239665">.</span><span class="ident" id="5239666">DecodeRune</span><span class="op" id="5239676">(</span><span class="ident" id="5239677">b</span><span class="op" id="5239678">[</span><span class="ident" id="5239679">i</span><span class="op" id="5239680">:</span><span class="op" id="5239681">]</span><span class="op" id="5239682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239686">repl</span>&nbsp;<span class="op" id="5239691">:=</span>&nbsp;<span class="string" id="5239694">&#34;&#34;</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5239699">if</span>&nbsp;<span class="builtintype" id="5239702">rune</span>&nbsp;<span class="op" id="5239707">==</span>&nbsp;<span class="num" id="5239710">0x2028</span>&nbsp;<span class="op" id="5239717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239722">repl</span>&nbsp;<span class="op" id="5239727">=</span>&nbsp;<span class="string" id="5239729">`\u2028`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5239740">}</span>&nbsp;<span class="keyword" id="5239742">else</span>&nbsp;<span class="keyword" id="5239747">if</span>&nbsp;<span class="builtintype" id="5239750">rune</span>&nbsp;<span class="op" id="5239755">==</span>&nbsp;<span class="num" id="5239758">0x2029</span>&nbsp;<span class="op" id="5239765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239770">repl</span>&nbsp;<span class="op" id="5239775">=</span>&nbsp;<span class="string" id="5239777">`\u2029`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5239788">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5239792">if</span>&nbsp;<span class="ident" id="5239795">repl</span>&nbsp;<span class="op" id="5239800">!=</span>&nbsp;<span class="string" id="5239803">&#34;&#34;</span>&nbsp;<span class="op" id="5239806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239811">buf</span><span class="op" id="5239814">.</span><span class="ident" id="5239815">Write</span><span class="op" id="5239820">(</span><span class="ident" id="5239821">b</span><span class="op" id="5239822">[</span><span class="ident" id="5239823">written</span><span class="op" id="5239830">:</span><span class="ident" id="5239831">i</span><span class="op" id="5239832">]</span><span class="op" id="5239833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239838">buf</span><span class="op" id="5239841">.</span><span class="ident" id="5239842">WriteString</span><span class="op" id="5239853">(</span><span class="ident" id="5239854">repl</span><span class="op" id="5239858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239863">written</span>&nbsp;<span class="op" id="5239871">=</span>&nbsp;<span class="ident" id="5239873">i</span>&nbsp;<span class="op" id="5239875">+</span>&nbsp;<span class="ident" id="5239877">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5239881">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239885">i</span>&nbsp;<span class="op" id="5239887">+=</span>&nbsp;<span class="ident" id="5239890">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5239893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5239896">if</span>&nbsp;<span class="ident" id="5239899">buf</span><span class="op" id="5239902">.</span><span class="ident" id="5239903">Len</span><span class="op" id="5239906">(</span><span class="op" id="5239907">)</span>&nbsp;<span class="op" id="5239909">!=</span>&nbsp;<span class="num" id="5239912">0</span>&nbsp;<span class="op" id="5239914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239918">buf</span><span class="op" id="5239921">.</span><span class="ident" id="5239922">Write</span><span class="op" id="5239927">(</span><span class="ident" id="5239928">b</span><span class="op" id="5239929">[</span><span class="ident" id="5239930">written</span><span class="op" id="5239937">:</span><span class="op" id="5239938">]</span><span class="op" id="5239939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5239943">if</span>&nbsp;<span class="ident" id="5239946">pad</span>&nbsp;<span class="op" id="5239950">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239955">buf</span><span class="op" id="5239958">.</span><span class="ident" id="5239959">WriteByte</span><span class="op" id="5239968">(</span><span class="string" id="5239969">&#39;&nbsp;&#39;</span><span class="op" id="5239972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5239976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239980">b</span>&nbsp;<span class="op" id="5239982">=</span>&nbsp;<span class="ident" id="5239984">buf</span><span class="op" id="5239987">.</span><span class="ident" id="5239988">Bytes</span><span class="op" id="5239993">(</span><span class="op" id="5239994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5239997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240000">return</span>&nbsp;<span class="builtintype" id="5240007">string</span><span class="op" id="5240013">(</span><span class="ident" id="5240014">b</span><span class="op" id="5240015">)</span><br>
<span class="lineno">215</span><span class="op" id="5240017">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5240020">//&nbsp;jsStrEscaper&nbsp;produces&nbsp;a&nbsp;string&nbsp;that&nbsp;can&nbsp;be&nbsp;included&nbsp;between&nbsp;quotes&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="5240093">//&nbsp;JavaScript&nbsp;source,&nbsp;in&nbsp;JavaScript&nbsp;embedded&nbsp;in&nbsp;an&nbsp;HTML5&nbsp;&lt;script&gt;&nbsp;element,</span><br>
<span class="lineno"></span><span class="comment" id="5240168">//&nbsp;or&nbsp;in&nbsp;an&nbsp;HTML5&nbsp;event&nbsp;handler&nbsp;attribute&nbsp;such&nbsp;as&nbsp;onclick.</span><br>
<span class="lineno">220</span><span class="keyword" id="5240227">func</span>&nbsp;<span class="ident" id="5240232">jsStrEscaper</span><span class="op" id="5240244">(</span><span class="ident" id="5240245">args</span>&nbsp;<span class="op" id="5240250">...</span><span class="keyword" id="5240253">interface</span><span class="op" id="5240262">{</span><span class="op" id="5240263">}</span><span class="op" id="5240264">)</span>&nbsp;<span class="builtintype" id="5240266">string</span>&nbsp;<span class="op" id="5240273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5240276">s</span><span class="op" id="5240277">,</span>&nbsp;<span class="ident" id="5240279">t</span>&nbsp;<span class="op" id="5240281">:=</span>&nbsp;<span class="ident" id="5240284">stringify</span><span class="op" id="5240293">(</span><span class="ident" id="5240294">args</span><span class="op" id="5240298">...</span><span class="op" id="5240301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240304">if</span>&nbsp;<span class="ident" id="5240307">t</span>&nbsp;<span class="op" id="5240309">==</span>&nbsp;<span class="ident" id="5240312">contentTypeJSStr</span>&nbsp;<span class="op" id="5240329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240333">return</span>&nbsp;<span class="ident" id="5240340">replace</span><span class="op" id="5240347">(</span><span class="ident" id="5240348">s</span><span class="op" id="5240349">,</span>&nbsp;<span class="ident" id="5240351">jsStrNormReplacementTable</span><span class="op" id="5240376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5240379">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240382">return</span>&nbsp;<span class="ident" id="5240389">replace</span><span class="op" id="5240396">(</span><span class="ident" id="5240397">s</span><span class="op" id="5240398">,</span>&nbsp;<span class="ident" id="5240400">jsStrReplacementTable</span><span class="op" id="5240421">)</span><br>
<span class="lineno"></span><span class="op" id="5240423">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5240426">//&nbsp;jsRegexpEscaper&nbsp;behaves&nbsp;like&nbsp;jsStrEscaper&nbsp;but&nbsp;escapes&nbsp;regular&nbsp;expression</span><br>
<span class="lineno"></span><span class="comment" id="5240502">//&nbsp;specials&nbsp;so&nbsp;the&nbsp;result&nbsp;is&nbsp;treated&nbsp;literally&nbsp;when&nbsp;included&nbsp;in&nbsp;a&nbsp;regular</span><br>
<span class="lineno">230</span><span class="comment" id="5240576">//&nbsp;expression&nbsp;literal.&nbsp;/foo{{.X}}bar/&nbsp;matches&nbsp;the&nbsp;string&nbsp;&#34;foo&#34;&nbsp;followed&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="5240651">//&nbsp;the&nbsp;literal&nbsp;text&nbsp;of&nbsp;{{.X}}&nbsp;followed&nbsp;by&nbsp;the&nbsp;string&nbsp;&#34;bar&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="5240711">func</span>&nbsp;<span class="ident" id="5240716">jsRegexpEscaper</span><span class="op" id="5240731">(</span><span class="ident" id="5240732">args</span>&nbsp;<span class="op" id="5240737">...</span><span class="keyword" id="5240740">interface</span><span class="op" id="5240749">{</span><span class="op" id="5240750">}</span><span class="op" id="5240751">)</span>&nbsp;<span class="builtintype" id="5240753">string</span>&nbsp;<span class="op" id="5240760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5240763">s</span><span class="op" id="5240764">,</span>&nbsp;<span class="ident" id="5240766">_</span>&nbsp;<span class="op" id="5240768">:=</span>&nbsp;<span class="ident" id="5240771">stringify</span><span class="op" id="5240780">(</span><span class="ident" id="5240781">args</span><span class="op" id="5240785">...</span><span class="op" id="5240788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5240791">s</span>&nbsp;<span class="op" id="5240793">=</span>&nbsp;<span class="ident" id="5240795">replace</span><span class="op" id="5240802">(</span><span class="ident" id="5240803">s</span><span class="op" id="5240804">,</span>&nbsp;<span class="ident" id="5240806">jsRegexpReplacementTable</span><span class="op" id="5240830">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240833">if</span>&nbsp;<span class="ident" id="5240836">s</span>&nbsp;<span class="op" id="5240838">==</span>&nbsp;<span class="string" id="5240841">&#34;&#34;</span>&nbsp;<span class="op" id="5240844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5240848">//&nbsp;/{{.X}}/&nbsp;should&nbsp;not&nbsp;produce&nbsp;a&nbsp;line&nbsp;comment&nbsp;when&nbsp;.X&nbsp;==&nbsp;&#34;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240911">return</span>&nbsp;<span class="string" id="5240918">&#34;(?:)&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5240926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240929">return</span>&nbsp;<span class="ident" id="5240936">s</span><br>
<span class="lineno">240</span><span class="op" id="5240938">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5240941">//&nbsp;replace&nbsp;replaces&nbsp;each&nbsp;rune&nbsp;r&nbsp;of&nbsp;s&nbsp;with&nbsp;replacementTable[r],&nbsp;provided&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="5241018">//&nbsp;r&nbsp;&lt;&nbsp;len(replacementTable).&nbsp;If&nbsp;replacementTable[r]&nbsp;is&nbsp;the&nbsp;empty&nbsp;string&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="5241096">//&nbsp;no&nbsp;replacement&nbsp;is&nbsp;made.</span><br>
<span class="lineno">245</span><span class="comment" id="5241123">//&nbsp;It&nbsp;also&nbsp;replaces&nbsp;runes&nbsp;U+2028&nbsp;and&nbsp;U+2029&nbsp;with&nbsp;the&nbsp;raw&nbsp;strings&nbsp;`\u2028`&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5241201">//&nbsp;`\u2029`.</span><br>
<span class="lineno"></span><span class="keyword" id="5241214">func</span>&nbsp;<span class="ident" id="5241219">replace</span><span class="op" id="5241226">(</span><span class="ident" id="5241227">s</span>&nbsp;<span class="builtintype" id="5241229">string</span><span class="op" id="5241235">,</span>&nbsp;<span class="ident" id="5241237">replacementTable</span>&nbsp;<span class="op" id="5241254">[</span><span class="op" id="5241255">]</span><span class="builtintype" id="5241256">string</span><span class="op" id="5241262">)</span>&nbsp;<span class="builtintype" id="5241264">string</span>&nbsp;<span class="op" id="5241271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241274">var</span>&nbsp;<span class="ident" id="5241278">b</span>&nbsp;<span class="ident" id="5241280">bytes</span><span class="op" id="5241285">.</span><span class="ident" id="5241286">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5241294">written</span>&nbsp;<span class="op" id="5241302">:=</span>&nbsp;<span class="num" id="5241305">0</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241308">for</span>&nbsp;<span class="ident" id="5241312">i</span><span class="op" id="5241313">,</span>&nbsp;<span class="ident" id="5241315">r</span>&nbsp;<span class="op" id="5241317">:=</span>&nbsp;<span class="keyword" id="5241320">range</span>&nbsp;<span class="ident" id="5241326">s</span>&nbsp;<span class="op" id="5241328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241332">var</span>&nbsp;<span class="ident" id="5241336">repl</span>&nbsp;<span class="builtintype" id="5241341">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241350">switch</span>&nbsp;<span class="op" id="5241357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241361">case</span>&nbsp;<span class="builtintype" id="5241366">int</span><span class="op" id="5241369">(</span><span class="ident" id="5241370">r</span><span class="op" id="5241371">)</span>&nbsp;<span class="op" id="5241373">&lt;</span>&nbsp;<span class="builtinfunc" id="5241375">len</span><span class="op" id="5241378">(</span><span class="ident" id="5241379">replacementTable</span><span class="op" id="5241395">)</span>&nbsp;<span class="op" id="5241397">&amp;&amp;</span>&nbsp;<span class="ident" id="5241400">replacementTable</span><span class="op" id="5241416">[</span><span class="ident" id="5241417">r</span><span class="op" id="5241418">]</span>&nbsp;<span class="op" id="5241420">!=</span>&nbsp;<span class="string" id="5241423">&#34;&#34;</span><span class="op" id="5241425">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5241430">repl</span>&nbsp;<span class="op" id="5241435">=</span>&nbsp;<span class="ident" id="5241437">replacementTable</span><span class="op" id="5241453">[</span><span class="ident" id="5241454">r</span><span class="op" id="5241455">]</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241459">case</span>&nbsp;<span class="ident" id="5241464">r</span>&nbsp;<span class="op" id="5241466">==</span>&nbsp;<span class="string" id="5241469">&#39;\u2028&#39;</span><span class="op" id="5241477">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5241482">repl</span>&nbsp;<span class="op" id="5241487">=</span>&nbsp;<span class="string" id="5241489">`\u2028`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241500">case</span>&nbsp;<span class="ident" id="5241505">r</span>&nbsp;<span class="op" id="5241507">==</span>&nbsp;<span class="string" id="5241510">&#39;\u2029&#39;</span><span class="op" id="5241518">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5241523">repl</span>&nbsp;<span class="op" id="5241528">=</span>&nbsp;<span class="string" id="5241530">`\u2029`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241541">default</span><span class="op" id="5241548">:</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241553">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5241564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5241568">b</span><span class="op" id="5241569">.</span><span class="ident" id="5241570">WriteString</span><span class="op" id="5241581">(</span><span class="ident" id="5241582">s</span><span class="op" id="5241583">[</span><span class="ident" id="5241584">written</span><span class="op" id="5241591">:</span><span class="ident" id="5241592">i</span><span class="op" id="5241593">]</span><span class="op" id="5241594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5241598">b</span><span class="op" id="5241599">.</span><span class="ident" id="5241600">WriteString</span><span class="op" id="5241611">(</span><span class="ident" id="5241612">repl</span><span class="op" id="5241616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5241620">written</span>&nbsp;<span class="op" id="5241628">=</span>&nbsp;<span class="ident" id="5241630">i</span>&nbsp;<span class="op" id="5241632">+</span>&nbsp;<span class="ident" id="5241634">utf8</span><span class="op" id="5241638">.</span><span class="ident" id="5241639">RuneLen</span><span class="op" id="5241646">(</span><span class="ident" id="5241647">r</span><span class="op" id="5241648">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5241651">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241654">if</span>&nbsp;<span class="ident" id="5241657">written</span>&nbsp;<span class="op" id="5241665">==</span>&nbsp;<span class="num" id="5241668">0</span>&nbsp;<span class="op" id="5241670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241674">return</span>&nbsp;<span class="ident" id="5241681">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5241684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5241687">b</span><span class="op" id="5241688">.</span><span class="ident" id="5241689">WriteString</span><span class="op" id="5241700">(</span><span class="ident" id="5241701">s</span><span class="op" id="5241702">[</span><span class="ident" id="5241703">written</span><span class="op" id="5241710">:</span><span class="op" id="5241711">]</span><span class="op" id="5241712">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241715">return</span>&nbsp;<span class="ident" id="5241722">b</span><span class="op" id="5241723">.</span><span class="ident" id="5241724">String</span><span class="op" id="5241730">(</span><span class="op" id="5241731">)</span><br>
<span class="lineno"></span><span class="op" id="5241733">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5241736">var</span>&nbsp;<span class="ident" id="5241740">jsStrReplacementTable</span>&nbsp;<span class="op" id="5241762">=</span>&nbsp;<span class="op" id="5241764">[</span><span class="op" id="5241765">]</span><span class="builtintype" id="5241766">string</span><span class="op" id="5241772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5241775">0</span><span class="op" id="5241776">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5241781">`\0`</span><span class="op" id="5241785">,</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5241788">&#39;\t&#39;</span><span class="op" id="5241792">:</span>&nbsp;<span class="string" id="5241794">`\t`</span><span class="op" id="5241798">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5241801">&#39;\n&#39;</span><span class="op" id="5241805">:</span>&nbsp;<span class="string" id="5241807">`\n`</span><span class="op" id="5241811">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5241814">&#39;\v&#39;</span><span class="op" id="5241818">:</span>&nbsp;<span class="string" id="5241820">`\x0b`</span><span class="op" id="5241826">,</span>&nbsp;<span class="comment" id="5241828">//&nbsp;&#34;\v&#34;&nbsp;==&nbsp;&#34;v&#34;&nbsp;on&nbsp;IE&nbsp;6.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5241853">&#39;\f&#39;</span><span class="op" id="5241857">:</span>&nbsp;<span class="string" id="5241859">`\f`</span><span class="op" id="5241863">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5241866">&#39;\r&#39;</span><span class="op" id="5241870">:</span>&nbsp;<span class="string" id="5241872">`\r`</span><span class="op" id="5241876">,</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5241879">//&nbsp;Encode&nbsp;HTML&nbsp;specials&nbsp;as&nbsp;hex&nbsp;so&nbsp;the&nbsp;output&nbsp;can&nbsp;be&nbsp;embedded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5241941">//&nbsp;in&nbsp;HTML&nbsp;attributes&nbsp;without&nbsp;further&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5241990">&#39;&#34;&#39;</span><span class="op" id="5241993">:</span>&nbsp;&nbsp;<span class="string" id="5241996">`\x22`</span><span class="op" id="5242002">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242005">&#39;&amp;&#39;</span><span class="op" id="5242008">:</span>&nbsp;&nbsp;<span class="string" id="5242011">`\x26`</span><span class="op" id="5242017">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242020">&#39;\&#39;&#39;</span><span class="op" id="5242024">:</span>&nbsp;<span class="string" id="5242026">`\x27`</span><span class="op" id="5242032">,</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242035">&#39;+&#39;</span><span class="op" id="5242038">:</span>&nbsp;&nbsp;<span class="string" id="5242041">`\x2b`</span><span class="op" id="5242047">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242050">&#39;/&#39;</span><span class="op" id="5242053">:</span>&nbsp;&nbsp;<span class="string" id="5242056">`\/`</span><span class="op" id="5242060">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242063">&#39;&lt;&#39;</span><span class="op" id="5242066">:</span>&nbsp;&nbsp;<span class="string" id="5242069">`\x3c`</span><span class="op" id="5242075">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242078">&#39;&gt;&#39;</span><span class="op" id="5242081">:</span>&nbsp;&nbsp;<span class="string" id="5242084">`\x3e`</span><span class="op" id="5242090">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242093">&#39;\\&#39;</span><span class="op" id="5242097">:</span>&nbsp;<span class="string" id="5242099">`\\`</span><span class="op" id="5242103">,</span><br>
<span class="lineno">290</span><span class="op" id="5242105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5242108">//&nbsp;jsStrNormReplacementTable&nbsp;is&nbsp;like&nbsp;jsStrReplacementTable&nbsp;but&nbsp;does&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="5242180">//&nbsp;overencode&nbsp;existing&nbsp;escapes&nbsp;since&nbsp;this&nbsp;table&nbsp;has&nbsp;no&nbsp;entry&nbsp;for&nbsp;`\`.</span><br>
<span class="lineno"></span><span class="keyword" id="5242250">var</span>&nbsp;<span class="ident" id="5242254">jsStrNormReplacementTable</span>&nbsp;<span class="op" id="5242280">=</span>&nbsp;<span class="op" id="5242282">[</span><span class="op" id="5242283">]</span><span class="builtintype" id="5242284">string</span><span class="op" id="5242290">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5242293">0</span><span class="op" id="5242294">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5242299">`\0`</span><span class="op" id="5242303">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242306">&#39;\t&#39;</span><span class="op" id="5242310">:</span>&nbsp;<span class="string" id="5242312">`\t`</span><span class="op" id="5242316">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242319">&#39;\n&#39;</span><span class="op" id="5242323">:</span>&nbsp;<span class="string" id="5242325">`\n`</span><span class="op" id="5242329">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242332">&#39;\v&#39;</span><span class="op" id="5242336">:</span>&nbsp;<span class="string" id="5242338">`\x0b`</span><span class="op" id="5242344">,</span>&nbsp;<span class="comment" id="5242346">//&nbsp;&#34;\v&#34;&nbsp;==&nbsp;&#34;v&#34;&nbsp;on&nbsp;IE&nbsp;6.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242371">&#39;\f&#39;</span><span class="op" id="5242375">:</span>&nbsp;<span class="string" id="5242377">`\f`</span><span class="op" id="5242381">,</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242384">&#39;\r&#39;</span><span class="op" id="5242388">:</span>&nbsp;<span class="string" id="5242390">`\r`</span><span class="op" id="5242394">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5242397">//&nbsp;Encode&nbsp;HTML&nbsp;specials&nbsp;as&nbsp;hex&nbsp;so&nbsp;the&nbsp;output&nbsp;can&nbsp;be&nbsp;embedded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5242459">//&nbsp;in&nbsp;HTML&nbsp;attributes&nbsp;without&nbsp;further&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242508">&#39;&#34;&#39;</span><span class="op" id="5242511">:</span>&nbsp;&nbsp;<span class="string" id="5242514">`\x22`</span><span class="op" id="5242520">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242523">&#39;&amp;&#39;</span><span class="op" id="5242526">:</span>&nbsp;&nbsp;<span class="string" id="5242529">`\x26`</span><span class="op" id="5242535">,</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242538">&#39;\&#39;&#39;</span><span class="op" id="5242542">:</span>&nbsp;<span class="string" id="5242544">`\x27`</span><span class="op" id="5242550">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242553">&#39;+&#39;</span><span class="op" id="5242556">:</span>&nbsp;&nbsp;<span class="string" id="5242559">`\x2b`</span><span class="op" id="5242565">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242568">&#39;/&#39;</span><span class="op" id="5242571">:</span>&nbsp;&nbsp;<span class="string" id="5242574">`\/`</span><span class="op" id="5242578">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242581">&#39;&lt;&#39;</span><span class="op" id="5242584">:</span>&nbsp;&nbsp;<span class="string" id="5242587">`\x3c`</span><span class="op" id="5242593">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242596">&#39;&gt;&#39;</span><span class="op" id="5242599">:</span>&nbsp;&nbsp;<span class="string" id="5242602">`\x3e`</span><span class="op" id="5242608">,</span><br>
<span class="lineno">310</span><span class="op" id="5242610">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5242613">var</span>&nbsp;<span class="ident" id="5242617">jsRegexpReplacementTable</span>&nbsp;<span class="op" id="5242642">=</span>&nbsp;<span class="op" id="5242644">[</span><span class="op" id="5242645">]</span><span class="builtintype" id="5242646">string</span><span class="op" id="5242652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5242655">0</span><span class="op" id="5242656">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5242661">`\0`</span><span class="op" id="5242665">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242668">&#39;\t&#39;</span><span class="op" id="5242672">:</span>&nbsp;<span class="string" id="5242674">`\t`</span><span class="op" id="5242678">,</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242681">&#39;\n&#39;</span><span class="op" id="5242685">:</span>&nbsp;<span class="string" id="5242687">`\n`</span><span class="op" id="5242691">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242694">&#39;\v&#39;</span><span class="op" id="5242698">:</span>&nbsp;<span class="string" id="5242700">`\x0b`</span><span class="op" id="5242706">,</span>&nbsp;<span class="comment" id="5242708">//&nbsp;&#34;\v&#34;&nbsp;==&nbsp;&#34;v&#34;&nbsp;on&nbsp;IE&nbsp;6.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242733">&#39;\f&#39;</span><span class="op" id="5242737">:</span>&nbsp;<span class="string" id="5242739">`\f`</span><span class="op" id="5242743">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242746">&#39;\r&#39;</span><span class="op" id="5242750">:</span>&nbsp;<span class="string" id="5242752">`\r`</span><span class="op" id="5242756">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5242759">//&nbsp;Encode&nbsp;HTML&nbsp;specials&nbsp;as&nbsp;hex&nbsp;so&nbsp;the&nbsp;output&nbsp;can&nbsp;be&nbsp;embedded</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5242821">//&nbsp;in&nbsp;HTML&nbsp;attributes&nbsp;without&nbsp;further&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242870">&#39;&#34;&#39;</span><span class="op" id="5242873">:</span>&nbsp;&nbsp;<span class="string" id="5242876">`\x22`</span><span class="op" id="5242882">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242885">&#39;$&#39;</span><span class="op" id="5242888">:</span>&nbsp;&nbsp;<span class="string" id="5242891">`\$`</span><span class="op" id="5242895">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242898">&#39;&amp;&#39;</span><span class="op" id="5242901">:</span>&nbsp;&nbsp;<span class="string" id="5242904">`\x26`</span><span class="op" id="5242910">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242913">&#39;\&#39;&#39;</span><span class="op" id="5242917">:</span>&nbsp;<span class="string" id="5242919">`\x27`</span><span class="op" id="5242925">,</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242928">&#39;(&#39;</span><span class="op" id="5242931">:</span>&nbsp;&nbsp;<span class="string" id="5242934">`\(`</span><span class="op" id="5242938">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242941">&#39;)&#39;</span><span class="op" id="5242944">:</span>&nbsp;&nbsp;<span class="string" id="5242947">`\)`</span><span class="op" id="5242951">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242954">&#39;*&#39;</span><span class="op" id="5242957">:</span>&nbsp;&nbsp;<span class="string" id="5242960">`\*`</span><span class="op" id="5242964">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242967">&#39;+&#39;</span><span class="op" id="5242970">:</span>&nbsp;&nbsp;<span class="string" id="5242973">`\x2b`</span><span class="op" id="5242979">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242982">&#39;-&#39;</span><span class="op" id="5242985">:</span>&nbsp;&nbsp;<span class="string" id="5242988">`\-`</span><span class="op" id="5242992">,</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5242995">&#39;.&#39;</span><span class="op" id="5242998">:</span>&nbsp;&nbsp;<span class="string" id="5243001">`\.`</span><span class="op" id="5243005">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5243008">&#39;/&#39;</span><span class="op" id="5243011">:</span>&nbsp;&nbsp;<span class="string" id="5243014">`\/`</span><span class="op" id="5243018">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5243021">&#39;&lt;&#39;</span><span class="op" id="5243024">:</span>&nbsp;&nbsp;<span class="string" id="5243027">`\x3c`</span><span class="op" id="5243033">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5243036">&#39;&gt;&#39;</span><span class="op" id="5243039">:</span>&nbsp;&nbsp;<span class="string" id="5243042">`\x3e`</span><span class="op" id="5243048">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5243051">&#39;?&#39;</span><span class="op" id="5243054">:</span>&nbsp;&nbsp;<span class="string" id="5243057">`\?`</span><span class="op" id="5243061">,</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5243064">&#39;[&#39;</span><span class="op" id="5243067">:</span>&nbsp;&nbsp;<span class="string" id="5243070">`\[`</span><span class="op" id="5243074">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5243077">&#39;\\&#39;</span><span class="op" id="5243081">:</span>&nbsp;<span class="string" id="5243083">`\\`</span><span class="op" id="5243087">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5243090">&#39;]&#39;</span><span class="op" id="5243093">:</span>&nbsp;&nbsp;<span class="string" id="5243096">`\]`</span><span class="op" id="5243100">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5243103">&#39;^&#39;</span><span class="op" id="5243106">:</span>&nbsp;&nbsp;<span class="string" id="5243109">`\^`</span><span class="op" id="5243113">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5243116">&#39;{&#39;</span><span class="op" id="5243119">:</span>&nbsp;&nbsp;<span class="string" id="5243122">`\{`</span><span class="op" id="5243126">,</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5243129">&#39;|&#39;</span><span class="op" id="5243132">:</span>&nbsp;&nbsp;<span class="string" id="5243135">`\|`</span><span class="op" id="5243139">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5243142">&#39;}&#39;</span><span class="op" id="5243145">:</span>&nbsp;&nbsp;<span class="string" id="5243148">`\}`</span><span class="op" id="5243152">,</span><br>
<span class="lineno"></span><span class="op" id="5243154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5243157">//&nbsp;isJSIdentPart&nbsp;reports&nbsp;whether&nbsp;the&nbsp;given&nbsp;rune&nbsp;is&nbsp;a&nbsp;JS&nbsp;identifier&nbsp;part.</span><br>
<span class="lineno">345</span><span class="comment" id="5243230">//&nbsp;It&nbsp;does&nbsp;not&nbsp;handle&nbsp;all&nbsp;the&nbsp;non-Latin&nbsp;letters,&nbsp;joiners,&nbsp;and&nbsp;combining&nbsp;marks,</span><br>
<span class="lineno"></span><span class="comment" id="5243309">//&nbsp;but&nbsp;it&nbsp;does&nbsp;handle&nbsp;every&nbsp;codepoint&nbsp;that&nbsp;can&nbsp;occur&nbsp;in&nbsp;a&nbsp;numeric&nbsp;literal&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5243386">//&nbsp;a&nbsp;keyword.</span><br>
<span class="lineno"></span><span class="keyword" id="5243400">func</span>&nbsp;<span class="ident" id="5243405">isJSIdentPart</span><span class="op" id="5243418">(</span><span class="ident" id="5243419">r</span>&nbsp;<span class="builtintype" id="5243421">rune</span><span class="op" id="5243425">)</span>&nbsp;<span class="builtintype" id="5243427">bool</span>&nbsp;<span class="op" id="5243432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243435">switch</span>&nbsp;<span class="op" id="5243442">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243445">case</span>&nbsp;<span class="ident" id="5243450">r</span>&nbsp;<span class="op" id="5243452">==</span>&nbsp;<span class="string" id="5243455">&#39;$&#39;</span><span class="op" id="5243458">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243462">return</span>&nbsp;<span class="builtintype" id="5243469">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243475">case</span>&nbsp;<span class="string" id="5243480">&#39;0&#39;</span>&nbsp;<span class="op" id="5243484">&lt;=</span>&nbsp;<span class="ident" id="5243487">r</span>&nbsp;<span class="op" id="5243489">&amp;&amp;</span>&nbsp;<span class="ident" id="5243492">r</span>&nbsp;<span class="op" id="5243494">&lt;=</span>&nbsp;<span class="string" id="5243497">&#39;9&#39;</span><span class="op" id="5243500">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243504">return</span>&nbsp;<span class="builtintype" id="5243511">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243517">case</span>&nbsp;<span class="string" id="5243522">&#39;A&#39;</span>&nbsp;<span class="op" id="5243526">&lt;=</span>&nbsp;<span class="ident" id="5243529">r</span>&nbsp;<span class="op" id="5243531">&amp;&amp;</span>&nbsp;<span class="ident" id="5243534">r</span>&nbsp;<span class="op" id="5243536">&lt;=</span>&nbsp;<span class="string" id="5243539">&#39;Z&#39;</span><span class="op" id="5243542">:</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243546">return</span>&nbsp;<span class="builtintype" id="5243553">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243559">case</span>&nbsp;<span class="ident" id="5243564">r</span>&nbsp;<span class="op" id="5243566">==</span>&nbsp;<span class="string" id="5243569">&#39;_&#39;</span><span class="op" id="5243572">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243576">return</span>&nbsp;<span class="builtintype" id="5243583">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243589">case</span>&nbsp;<span class="string" id="5243594">&#39;a&#39;</span>&nbsp;<span class="op" id="5243598">&lt;=</span>&nbsp;<span class="ident" id="5243601">r</span>&nbsp;<span class="op" id="5243603">&amp;&amp;</span>&nbsp;<span class="ident" id="5243606">r</span>&nbsp;<span class="op" id="5243608">&lt;=</span>&nbsp;<span class="string" id="5243611">&#39;z&#39;</span><span class="op" id="5243614">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243618">return</span>&nbsp;<span class="builtintype" id="5243625">true</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5243631">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243634">return</span>&nbsp;<span class="builtintype" id="5243641">false</span><br>
<span class="lineno"></span><span class="op" id="5243647">}</span>
</div>
</body>
</html>
