<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="keyword" id="5058234">package</span>&nbsp;<span class="ident" id="5058242">arch8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5058249">//&nbsp;Interrupt&nbsp;defines&nbsp;the&nbsp;interrupt&nbsp;page</span><br>
<span class="lineno"></span><span class="keyword" id="5058289">type</span>&nbsp;<span class="ident" id="5058294">interrupt</span>&nbsp;<span class="keyword" id="5058304">struct</span>&nbsp;<span class="op" id="5058311">{</span><br>
<span class="lineno">5</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5058314">p</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5058319">*</span><span class="ident" id="5058320">page</span>&nbsp;&nbsp;<span class="comment" id="5058326">//&nbsp;the&nbsp;dma&nbsp;page&nbsp;for&nbsp;interrupt&nbsp;handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5058365">base</span>&nbsp;<span class="builtintype" id="5058370">uint32</span>&nbsp;<span class="comment" id="5058377">//&nbsp;dma&nbsp;offset</span><br>
<span class="lineno"></span><span class="op" id="5058391">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5058394">//&nbsp;Number&nbsp;of&nbsp;interrupts</span><br>
<span class="lineno">10</span><span class="keyword" id="5058418">const</span>&nbsp;<span class="ident" id="5058424">Ninterrupt</span>&nbsp;<span class="op" id="5058435">=</span>&nbsp;<span class="num" id="5058437">256</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5058442">const</span>&nbsp;<span class="op" id="5058448">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5058451">intFlags</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5058464">=</span>&nbsp;<span class="num" id="5058466">0</span>&nbsp;&nbsp;<span class="comment" id="5058469">//&nbsp;flags,&nbsp;bit&nbsp;0&nbsp;is&nbsp;master&nbsp;enabling&nbsp;switch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5058512">intKernelSP</span>&nbsp;&nbsp;<span class="op" id="5058525">=</span>&nbsp;<span class="num" id="5058527">4</span>&nbsp;&nbsp;<span class="comment" id="5058530">//&nbsp;position&nbsp;of&nbsp;the&nbsp;handler&nbsp;stack&nbsp;base&nbsp;pointer</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5058577">intHandlerPC</span>&nbsp;<span class="op" id="5058590">=</span>&nbsp;<span class="num" id="5058592">8</span>&nbsp;&nbsp;<span class="comment" id="5058595">//&nbsp;position&nbsp;of&nbsp;the&nbsp;handler&nbsp;start&nbsp;PC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5058632">intSyscallPC</span>&nbsp;<span class="op" id="5058645">=</span>&nbsp;<span class="num" id="5058647">12</span>&nbsp;<span class="comment" id="5058650">//&nbsp;position&nbsp;of&nbsp;the&nbsp;syscall&nbsp;start&nbsp;PC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5058687">intMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5058700">=</span>&nbsp;<span class="num" id="5058702">32</span>&nbsp;<span class="comment" id="5058705">//&nbsp;interrupt&nbsp;enable&nbsp;mask&nbsp;bits&nbsp;offset&nbsp;(32&nbsp;bytes)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5058754">intPending</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5058767">=</span>&nbsp;<span class="num" id="5058769">64</span>&nbsp;<span class="comment" id="5058772">//&nbsp;interrupt&nbsp;pending&nbsp;bits&nbsp;offset&nbsp;(32&nbsp;bytes)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5058818">intCtrlSize</span>&nbsp;<span class="op" id="5058830">=</span>&nbsp;<span class="num" id="5058832">128</span><br>
<span class="lineno"></span><span class="op" id="5058836">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5058839">//&nbsp;NewInterrupt&nbsp;creates&nbsp;a&nbsp;interrupt&nbsp;on&nbsp;the&nbsp;given&nbsp;DMA&nbsp;page.</span><br>
<span class="lineno"></span><span class="keyword" id="5058898">func</span>&nbsp;<span class="ident" id="5058903">newInterrupt</span><span class="op" id="5058915">(</span><span class="ident" id="5058916">p</span>&nbsp;<span class="op" id="5058918">*</span><span class="ident" id="5058919">page</span><span class="op" id="5058923">,</span>&nbsp;<span class="ident" id="5058925">core</span>&nbsp;<span class="builtintype" id="5058930">byte</span><span class="op" id="5058934">)</span>&nbsp;<span class="op" id="5058936">*</span><span class="ident" id="5058937">interrupt</span>&nbsp;<span class="op" id="5058947">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5058950">ret</span>&nbsp;<span class="op" id="5058954">:=</span>&nbsp;<span class="builtinfunc" id="5058957">new</span><span class="op" id="5058960">(</span><span class="ident" id="5058961">interrupt</span><span class="op" id="5058970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5058973">ret</span><span class="op" id="5058976">.</span><span class="ident" id="5058977">p</span>&nbsp;<span class="op" id="5058979">=</span>&nbsp;<span class="ident" id="5058981">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5058984">ret</span><span class="op" id="5058987">.</span><span class="ident" id="5058988">base</span>&nbsp;<span class="op" id="5058993">=</span>&nbsp;<span class="builtintype" id="5058995">uint32</span><span class="op" id="5059001">(</span><span class="ident" id="5059002">core</span><span class="op" id="5059006">)</span>&nbsp;<span class="op" id="5059008">*</span>&nbsp;<span class="ident" id="5059010">intCtrlSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5059023">if</span>&nbsp;<span class="ident" id="5059026">ret</span><span class="op" id="5059029">.</span><span class="ident" id="5059030">base</span><span class="op" id="5059034">+</span><span class="ident" id="5059035">intCtrlSize</span>&nbsp;<span class="op" id="5059047">&gt;</span>&nbsp;<span class="ident" id="5059049">PageSize</span>&nbsp;<span class="op" id="5059058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5059062">panic</span><span class="op" id="5059067">(</span><span class="string" id="5059068">&#34;bug&#34;</span><span class="op" id="5059073">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5059076">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5059080">return</span>&nbsp;<span class="ident" id="5059087">ret</span><br>
<span class="lineno"></span><span class="op" id="5059091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="5059094">func</span>&nbsp;<span class="op" id="5059099">(</span><span class="ident" id="5059100">in</span>&nbsp;<span class="op" id="5059103">*</span><span class="ident" id="5059104">interrupt</span><span class="op" id="5059113">)</span>&nbsp;<span class="ident" id="5059115">readWord</span><span class="op" id="5059123">(</span><span class="ident" id="5059124">off</span>&nbsp;<span class="builtintype" id="5059128">uint32</span><span class="op" id="5059134">)</span>&nbsp;<span class="builtintype" id="5059136">uint32</span>&nbsp;<span class="op" id="5059143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5059146">return</span>&nbsp;<span class="ident" id="5059153">in</span><span class="op" id="5059155">.</span><span class="ident" id="5059156">p</span><span class="op" id="5059157">.</span><span class="ident" id="5059158">ReadWord</span><span class="op" id="5059166">(</span><span class="ident" id="5059167">in</span><span class="op" id="5059169">.</span><span class="ident" id="5059170">base</span>&nbsp;<span class="op" id="5059175">+</span>&nbsp;<span class="ident" id="5059177">off</span><span class="op" id="5059180">)</span><br>
<span class="lineno"></span><span class="op" id="5059182">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5059185">func</span>&nbsp;<span class="op" id="5059190">(</span><span class="ident" id="5059191">in</span>&nbsp;<span class="op" id="5059194">*</span><span class="ident" id="5059195">interrupt</span><span class="op" id="5059204">)</span>&nbsp;<span class="ident" id="5059206">readByte</span><span class="op" id="5059214">(</span><span class="ident" id="5059215">off</span>&nbsp;<span class="builtintype" id="5059219">uint32</span><span class="op" id="5059225">)</span>&nbsp;<span class="builtintype" id="5059227">byte</span>&nbsp;<span class="op" id="5059232">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5059235">return</span>&nbsp;<span class="ident" id="5059242">in</span><span class="op" id="5059244">.</span><span class="ident" id="5059245">p</span><span class="op" id="5059246">.</span><span class="ident" id="5059247">ReadByte</span><span class="op" id="5059255">(</span><span class="ident" id="5059256">in</span><span class="op" id="5059258">.</span><span class="ident" id="5059259">base</span>&nbsp;<span class="op" id="5059264">+</span>&nbsp;<span class="ident" id="5059266">off</span><span class="op" id="5059269">)</span><br>
<span class="lineno"></span><span class="op" id="5059271">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5059274">func</span>&nbsp;<span class="op" id="5059279">(</span><span class="ident" id="5059280">in</span>&nbsp;<span class="op" id="5059283">*</span><span class="ident" id="5059284">interrupt</span><span class="op" id="5059293">)</span>&nbsp;<span class="ident" id="5059295">writeWord</span><span class="op" id="5059304">(</span><span class="ident" id="5059305">off</span>&nbsp;<span class="builtintype" id="5059309">uint32</span><span class="op" id="5059315">,</span>&nbsp;<span class="ident" id="5059317">v</span>&nbsp;<span class="builtintype" id="5059319">uint32</span><span class="op" id="5059325">)</span>&nbsp;<span class="op" id="5059327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5059330">in</span><span class="op" id="5059332">.</span><span class="ident" id="5059333">p</span><span class="op" id="5059334">.</span><span class="ident" id="5059335">WriteWord</span><span class="op" id="5059344">(</span><span class="ident" id="5059345">in</span><span class="op" id="5059347">.</span><span class="ident" id="5059348">base</span><span class="op" id="5059352">+</span><span class="ident" id="5059353">off</span><span class="op" id="5059356">,</span>&nbsp;<span class="ident" id="5059358">v</span><span class="op" id="5059359">)</span><br>
<span class="lineno">45</span><span class="op" id="5059361">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5059364">func</span>&nbsp;<span class="op" id="5059369">(</span><span class="ident" id="5059370">in</span>&nbsp;<span class="op" id="5059373">*</span><span class="ident" id="5059374">interrupt</span><span class="op" id="5059383">)</span>&nbsp;<span class="ident" id="5059385">writeByte</span><span class="op" id="5059394">(</span><span class="ident" id="5059395">off</span>&nbsp;<span class="builtintype" id="5059399">uint32</span><span class="op" id="5059405">,</span>&nbsp;<span class="ident" id="5059407">v</span>&nbsp;<span class="builtintype" id="5059409">byte</span><span class="op" id="5059413">)</span>&nbsp;<span class="op" id="5059415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5059418">in</span><span class="op" id="5059420">.</span><span class="ident" id="5059421">p</span><span class="op" id="5059422">.</span><span class="ident" id="5059423">WriteByte</span><span class="op" id="5059432">(</span><span class="ident" id="5059433">in</span><span class="op" id="5059435">.</span><span class="ident" id="5059436">base</span><span class="op" id="5059440">+</span><span class="ident" id="5059441">off</span><span class="op" id="5059444">,</span>&nbsp;<span class="ident" id="5059446">v</span><span class="op" id="5059447">)</span><br>
<span class="lineno"></span><span class="op" id="5059449">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="5059452">func</span>&nbsp;<span class="op" id="5059457">(</span><span class="ident" id="5059458">in</span>&nbsp;<span class="op" id="5059461">*</span><span class="ident" id="5059462">interrupt</span><span class="op" id="5059471">)</span>&nbsp;<span class="ident" id="5059473">kernelSP</span><span class="op" id="5059481">(</span><span class="op" id="5059482">)</span>&nbsp;<span class="builtintype" id="5059484">uint32</span>&nbsp;<span class="op" id="5059491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5059494">return</span>&nbsp;<span class="ident" id="5059501">in</span><span class="op" id="5059503">.</span><span class="ident" id="5059504">readWord</span><span class="op" id="5059512">(</span><span class="ident" id="5059513">intKernelSP</span><span class="op" id="5059524">)</span><br>
<span class="lineno"></span><span class="op" id="5059526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="5059529">func</span>&nbsp;<span class="op" id="5059534">(</span><span class="ident" id="5059535">in</span>&nbsp;<span class="op" id="5059538">*</span><span class="ident" id="5059539">interrupt</span><span class="op" id="5059548">)</span>&nbsp;<span class="ident" id="5059550">handlerPC</span><span class="op" id="5059559">(</span><span class="op" id="5059560">)</span>&nbsp;<span class="builtintype" id="5059562">uint32</span>&nbsp;<span class="op" id="5059569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5059572">return</span>&nbsp;<span class="ident" id="5059579">in</span><span class="op" id="5059581">.</span><span class="ident" id="5059582">readWord</span><span class="op" id="5059590">(</span><span class="ident" id="5059591">intHandlerPC</span><span class="op" id="5059603">)</span><br>
<span class="lineno"></span><span class="op" id="5059605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5059608">func</span>&nbsp;<span class="op" id="5059613">(</span><span class="ident" id="5059614">in</span>&nbsp;<span class="op" id="5059617">*</span><span class="ident" id="5059618">interrupt</span><span class="op" id="5059627">)</span>&nbsp;<span class="ident" id="5059629">syscallPC</span><span class="op" id="5059638">(</span><span class="op" id="5059639">)</span>&nbsp;<span class="builtintype" id="5059641">uint32</span>&nbsp;<span class="op" id="5059648">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5059651">return</span>&nbsp;<span class="ident" id="5059658">in</span><span class="op" id="5059660">.</span><span class="ident" id="5059661">readWord</span><span class="op" id="5059669">(</span><span class="ident" id="5059670">intSyscallPC</span><span class="op" id="5059682">)</span><br>
<span class="lineno"></span><span class="op" id="5059684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5059687">//&nbsp;Issue&nbsp;issues&nbsp;an&nbsp;interrupt.&nbsp;If&nbsp;the&nbsp;interrupt&nbsp;is&nbsp;already&nbsp;issued,</span><br>
<span class="lineno"></span><span class="comment" id="5059753">//&nbsp;this&nbsp;has&nbsp;no&nbsp;effect.</span><br>
<span class="lineno">65</span><span class="keyword" id="5059776">func</span>&nbsp;<span class="op" id="5059781">(</span><span class="ident" id="5059782">in</span>&nbsp;<span class="op" id="5059785">*</span><span class="ident" id="5059786">interrupt</span><span class="op" id="5059795">)</span>&nbsp;<span class="ident" id="5059797">Issue</span><span class="op" id="5059802">(</span><span class="ident" id="5059803">i</span>&nbsp;<span class="builtintype" id="5059805">byte</span><span class="op" id="5059809">)</span>&nbsp;<span class="op" id="5059811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5059814">off</span>&nbsp;<span class="op" id="5059818">:=</span>&nbsp;<span class="builtintype" id="5059821">uint32</span><span class="op" id="5059827">(</span><span class="ident" id="5059828">i</span><span class="op" id="5059829">/</span><span class="num" id="5059830">8</span><span class="op" id="5059831">)</span>&nbsp;<span class="op" id="5059833">+</span>&nbsp;<span class="ident" id="5059835">intPending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5059847">b</span>&nbsp;<span class="op" id="5059849">:=</span>&nbsp;<span class="ident" id="5059852">in</span><span class="op" id="5059854">.</span><span class="ident" id="5059855">readByte</span><span class="op" id="5059863">(</span><span class="ident" id="5059864">off</span><span class="op" id="5059867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5059870">b</span>&nbsp;<span class="op" id="5059872">|=</span>&nbsp;<span class="num" id="5059875">0x1</span>&nbsp;<span class="op" id="5059879">&lt;&lt;</span>&nbsp;<span class="op" id="5059882">(</span><span class="ident" id="5059883">i</span>&nbsp;<span class="op" id="5059885">%</span>&nbsp;<span class="num" id="5059887">8</span><span class="op" id="5059888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5059891">in</span><span class="op" id="5059893">.</span><span class="ident" id="5059894">writeByte</span><span class="op" id="5059903">(</span><span class="ident" id="5059904">off</span><span class="op" id="5059907">,</span>&nbsp;<span class="ident" id="5059909">b</span><span class="op" id="5059910">)</span><br>
<span class="lineno">70</span><span class="op" id="5059912">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5059915">//&nbsp;Clear&nbsp;clears&nbsp;an&nbsp;interrupt.&nbsp;If&nbsp;the&nbsp;interrupt&nbsp;is&nbsp;already&nbsp;cleared,</span><br>
<span class="lineno"></span><span class="comment" id="5059982">//&nbsp;this&nbsp;has&nbsp;no&nbsp;effect.</span><br>
<span class="lineno"></span><span class="keyword" id="5060005">func</span>&nbsp;<span class="op" id="5060010">(</span><span class="ident" id="5060011">in</span>&nbsp;<span class="op" id="5060014">*</span><span class="ident" id="5060015">interrupt</span><span class="op" id="5060024">)</span>&nbsp;<span class="ident" id="5060026">Clear</span><span class="op" id="5060031">(</span><span class="ident" id="5060032">i</span>&nbsp;<span class="builtintype" id="5060034">byte</span><span class="op" id="5060038">)</span>&nbsp;<span class="op" id="5060040">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5060043">off</span>&nbsp;<span class="op" id="5060047">:=</span>&nbsp;<span class="builtintype" id="5060050">uint32</span><span class="op" id="5060056">(</span><span class="ident" id="5060057">i</span><span class="op" id="5060058">/</span><span class="num" id="5060059">8</span><span class="op" id="5060060">)</span>&nbsp;<span class="op" id="5060062">+</span>&nbsp;<span class="ident" id="5060064">intPending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5060076">b</span>&nbsp;<span class="op" id="5060078">:=</span>&nbsp;<span class="ident" id="5060081">in</span><span class="op" id="5060083">.</span><span class="ident" id="5060084">readByte</span><span class="op" id="5060092">(</span><span class="ident" id="5060093">off</span><span class="op" id="5060096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5060099">b</span>&nbsp;<span class="op" id="5060101">&amp;=</span>&nbsp;<span class="op" id="5060104">^</span><span class="op" id="5060105">(</span><span class="num" id="5060106">0x1</span>&nbsp;<span class="op" id="5060110">&lt;&lt;</span>&nbsp;<span class="op" id="5060113">(</span><span class="ident" id="5060114">i</span>&nbsp;<span class="op" id="5060116">%</span>&nbsp;<span class="num" id="5060118">8</span><span class="op" id="5060119">)</span><span class="op" id="5060120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5060123">in</span><span class="op" id="5060125">.</span><span class="ident" id="5060126">writeByte</span><span class="op" id="5060135">(</span><span class="ident" id="5060136">off</span><span class="op" id="5060139">,</span>&nbsp;<span class="ident" id="5060141">b</span><span class="op" id="5060142">)</span><br>
<span class="lineno"></span><span class="op" id="5060144">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="comment" id="5060147">//&nbsp;Enable&nbsp;sets&nbsp;the&nbsp;interrupt&nbsp;enable&nbsp;bit&nbsp;in&nbsp;the&nbsp;flags.</span><br>
<span class="lineno"></span><span class="keyword" id="5060201">func</span>&nbsp;<span class="op" id="5060206">(</span><span class="ident" id="5060207">in</span>&nbsp;<span class="op" id="5060210">*</span><span class="ident" id="5060211">interrupt</span><span class="op" id="5060220">)</span>&nbsp;<span class="ident" id="5060222">Enable</span><span class="op" id="5060228">(</span><span class="op" id="5060229">)</span>&nbsp;<span class="op" id="5060231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5060234">b</span>&nbsp;<span class="op" id="5060236">:=</span>&nbsp;<span class="ident" id="5060239">in</span><span class="op" id="5060241">.</span><span class="ident" id="5060242">readByte</span><span class="op" id="5060250">(</span><span class="ident" id="5060251">intFlags</span><span class="op" id="5060259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5060262">b</span>&nbsp;<span class="op" id="5060264">|=</span>&nbsp;<span class="num" id="5060267">0x1</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5060272">in</span><span class="op" id="5060274">.</span><span class="ident" id="5060275">writeByte</span><span class="op" id="5060284">(</span><span class="ident" id="5060285">intFlags</span><span class="op" id="5060293">,</span>&nbsp;<span class="ident" id="5060295">b</span><span class="op" id="5060296">)</span><br>
<span class="lineno"></span><span class="op" id="5060298">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5060301">//&nbsp;Enabled&nbsp;tests&nbsp;if&nbsp;interrupt&nbsp;is&nbsp;enabled</span><br>
<span class="lineno"></span><span class="keyword" id="5060342">func</span>&nbsp;<span class="op" id="5060347">(</span><span class="ident" id="5060348">in</span>&nbsp;<span class="op" id="5060351">*</span><span class="ident" id="5060352">interrupt</span><span class="op" id="5060361">)</span>&nbsp;<span class="ident" id="5060363">Enabled</span><span class="op" id="5060370">(</span><span class="op" id="5060371">)</span>&nbsp;<span class="builtintype" id="5060373">bool</span>&nbsp;<span class="op" id="5060378">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5060381">b</span>&nbsp;<span class="op" id="5060383">:=</span>&nbsp;<span class="ident" id="5060386">in</span><span class="op" id="5060388">.</span><span class="ident" id="5060389">readByte</span><span class="op" id="5060397">(</span><span class="ident" id="5060398">intFlags</span><span class="op" id="5060406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5060409">return</span>&nbsp;<span class="op" id="5060416">(</span><span class="ident" id="5060417">b</span>&nbsp;<span class="op" id="5060419">&amp;</span>&nbsp;<span class="num" id="5060421">0x1</span><span class="op" id="5060424">)</span>&nbsp;<span class="op" id="5060426">!=</span>&nbsp;<span class="num" id="5060429">0</span><br>
<span class="lineno"></span><span class="op" id="5060431">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5060434">//&nbsp;Disable&nbsp;clears&nbsp;the&nbsp;interrupt&nbsp;enable&nbsp;bit&nbsp;in&nbsp;the&nbsp;flags.</span><br>
<span class="lineno">95</span><span class="keyword" id="5060491">func</span>&nbsp;<span class="op" id="5060496">(</span><span class="ident" id="5060497">in</span>&nbsp;<span class="op" id="5060500">*</span><span class="ident" id="5060501">interrupt</span><span class="op" id="5060510">)</span>&nbsp;<span class="ident" id="5060512">Disable</span><span class="op" id="5060519">(</span><span class="op" id="5060520">)</span>&nbsp;<span class="op" id="5060522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5060525">b</span>&nbsp;<span class="op" id="5060527">:=</span>&nbsp;<span class="ident" id="5060530">in</span><span class="op" id="5060532">.</span><span class="ident" id="5060533">readByte</span><span class="op" id="5060541">(</span><span class="ident" id="5060542">intFlags</span><span class="op" id="5060550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5060553">b</span>&nbsp;<span class="op" id="5060555">&amp;=</span>&nbsp;<span class="op" id="5060558">^</span><span class="builtintype" id="5060559">byte</span><span class="op" id="5060563">(</span><span class="num" id="5060564">0x1</span><span class="op" id="5060567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5060570">in</span><span class="op" id="5060572">.</span><span class="ident" id="5060573">writeByte</span><span class="op" id="5060582">(</span><span class="ident" id="5060583">intFlags</span><span class="op" id="5060591">,</span>&nbsp;<span class="ident" id="5060593">b</span><span class="op" id="5060594">)</span><br>
<span class="lineno"></span><span class="op" id="5060596">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="5060599">//&nbsp;EnableInt&nbsp;enables&nbsp;a&nbsp;particular&nbsp;interrupt&nbsp;by&nbsp;clearing&nbsp;the&nbsp;mask.</span><br>
<span class="lineno"></span><span class="keyword" id="5060665">func</span>&nbsp;<span class="op" id="5060670">(</span><span class="ident" id="5060671">in</span>&nbsp;<span class="op" id="5060674">*</span><span class="ident" id="5060675">interrupt</span><span class="op" id="5060684">)</span>&nbsp;<span class="ident" id="5060686">EnableInt</span><span class="op" id="5060695">(</span><span class="ident" id="5060696">i</span>&nbsp;<span class="builtintype" id="5060698">byte</span><span class="op" id="5060702">)</span>&nbsp;<span class="op" id="5060704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5060707">off</span>&nbsp;<span class="op" id="5060711">:=</span>&nbsp;<span class="builtintype" id="5060714">uint32</span><span class="op" id="5060720">(</span><span class="ident" id="5060721">i</span><span class="op" id="5060722">/</span><span class="num" id="5060723">8</span><span class="op" id="5060724">)</span>&nbsp;<span class="op" id="5060726">+</span>&nbsp;<span class="ident" id="5060728">intMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5060737">b</span>&nbsp;<span class="op" id="5060739">:=</span>&nbsp;<span class="ident" id="5060742">in</span><span class="op" id="5060744">.</span><span class="ident" id="5060745">readByte</span><span class="op" id="5060753">(</span><span class="ident" id="5060754">off</span><span class="op" id="5060757">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5060760">b</span>&nbsp;<span class="op" id="5060762">|=</span>&nbsp;<span class="num" id="5060765">0x1</span>&nbsp;<span class="op" id="5060769">&lt;&lt;</span>&nbsp;<span class="op" id="5060772">(</span><span class="ident" id="5060773">i</span>&nbsp;<span class="op" id="5060775">%</span>&nbsp;<span class="num" id="5060777">8</span><span class="op" id="5060778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5060781">in</span><span class="op" id="5060783">.</span><span class="ident" id="5060784">writeByte</span><span class="op" id="5060793">(</span><span class="ident" id="5060794">off</span><span class="op" id="5060797">,</span>&nbsp;<span class="ident" id="5060799">b</span><span class="op" id="5060800">)</span><br>
<span class="lineno"></span><span class="op" id="5060802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5060805">//&nbsp;DisableInt&nbsp;disables&nbsp;a&nbsp;particular&nbsp;interrupt&nbsp;by&nbsp;setting&nbsp;the&nbsp;mask.</span><br>
<span class="lineno">110</span><span class="keyword" id="5060872">func</span>&nbsp;<span class="op" id="5060877">(</span><span class="ident" id="5060878">in</span>&nbsp;<span class="op" id="5060881">*</span><span class="ident" id="5060882">interrupt</span><span class="op" id="5060891">)</span>&nbsp;<span class="ident" id="5060893">DisableInt</span><span class="op" id="5060903">(</span><span class="ident" id="5060904">i</span>&nbsp;<span class="builtintype" id="5060906">byte</span><span class="op" id="5060910">)</span>&nbsp;<span class="op" id="5060912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5060915">off</span>&nbsp;<span class="op" id="5060919">:=</span>&nbsp;<span class="builtintype" id="5060922">uint32</span><span class="op" id="5060928">(</span><span class="ident" id="5060929">i</span><span class="op" id="5060930">/</span><span class="num" id="5060931">8</span><span class="op" id="5060932">)</span>&nbsp;<span class="op" id="5060934">+</span>&nbsp;<span class="ident" id="5060936">intMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5060945">b</span>&nbsp;<span class="op" id="5060947">:=</span>&nbsp;<span class="ident" id="5060950">in</span><span class="op" id="5060952">.</span><span class="ident" id="5060953">readByte</span><span class="op" id="5060961">(</span><span class="ident" id="5060962">off</span><span class="op" id="5060965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5060968">b</span>&nbsp;<span class="op" id="5060970">&amp;=</span>&nbsp;<span class="op" id="5060973">^</span><span class="op" id="5060974">(</span><span class="num" id="5060975">0x1</span>&nbsp;<span class="op" id="5060979">&lt;&lt;</span>&nbsp;<span class="op" id="5060982">(</span><span class="ident" id="5060983">i</span>&nbsp;<span class="op" id="5060985">%</span>&nbsp;<span class="num" id="5060987">8</span><span class="op" id="5060988">)</span><span class="op" id="5060989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5060992">in</span><span class="op" id="5060994">.</span><span class="ident" id="5060995">writeByte</span><span class="op" id="5061004">(</span><span class="ident" id="5061005">off</span><span class="op" id="5061008">,</span>&nbsp;<span class="ident" id="5061010">b</span><span class="op" id="5061011">)</span><br>
<span class="lineno">115</span><span class="op" id="5061013">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5061016">//&nbsp;Flags&nbsp;returns&nbsp;the&nbsp;flags&nbsp;byte.</span><br>
<span class="lineno"></span><span class="keyword" id="5061049">func</span>&nbsp;<span class="op" id="5061054">(</span><span class="ident" id="5061055">in</span>&nbsp;<span class="op" id="5061058">*</span><span class="ident" id="5061059">interrupt</span><span class="op" id="5061068">)</span>&nbsp;<span class="ident" id="5061070">Flags</span><span class="op" id="5061075">(</span><span class="op" id="5061076">)</span>&nbsp;<span class="builtintype" id="5061078">byte</span>&nbsp;<span class="op" id="5061083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5061086">return</span>&nbsp;<span class="ident" id="5061093">in</span><span class="op" id="5061095">.</span><span class="ident" id="5061096">readByte</span><span class="op" id="5061104">(</span><span class="ident" id="5061105">intFlags</span><span class="op" id="5061113">)</span><br>
<span class="lineno">120</span><span class="op" id="5061115">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5061118">//&nbsp;Poll&nbsp;looks&nbsp;for&nbsp;the&nbsp;next&nbsp;pending&nbsp;interrupt.</span><br>
<span class="lineno"></span><span class="keyword" id="5061164">func</span>&nbsp;<span class="op" id="5061169">(</span><span class="ident" id="5061170">in</span>&nbsp;<span class="op" id="5061173">*</span><span class="ident" id="5061174">interrupt</span><span class="op" id="5061183">)</span>&nbsp;<span class="ident" id="5061185">Poll</span><span class="op" id="5061189">(</span><span class="op" id="5061190">)</span>&nbsp;<span class="op" id="5061192">(</span><span class="builtintype" id="5061193">bool</span><span class="op" id="5061197">,</span>&nbsp;<span class="builtintype" id="5061199">byte</span><span class="op" id="5061203">)</span>&nbsp;<span class="op" id="5061205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5061208">flag</span>&nbsp;<span class="op" id="5061213">:=</span>&nbsp;<span class="ident" id="5061216">in</span><span class="op" id="5061218">.</span><span class="ident" id="5061219">Flags</span><span class="op" id="5061224">(</span><span class="op" id="5061225">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5061228">if</span>&nbsp;<span class="ident" id="5061231">flag</span><span class="op" id="5061235">&amp;</span><span class="num" id="5061236">0x1</span>&nbsp;<span class="op" id="5061240">==</span>&nbsp;<span class="num" id="5061243">0</span>&nbsp;<span class="op" id="5061245">{</span>&nbsp;<span class="comment" id="5061247">//&nbsp;interrupt&nbsp;is&nbsp;disabled</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5061274">return</span>&nbsp;<span class="builtintype" id="5061281">false</span><span class="op" id="5061286">,</span>&nbsp;<span class="num" id="5061288">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5061291">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5061295">//&nbsp;search&nbsp;bits&nbsp;based&nbsp;on&nbsp;priorities.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5061332">//&nbsp;smaller&nbsp;is&nbsp;higher</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5061354">for</span>&nbsp;<span class="ident" id="5061358">i</span>&nbsp;<span class="op" id="5061360">:=</span>&nbsp;<span class="builtintype" id="5061363">uint32</span><span class="op" id="5061369">(</span><span class="num" id="5061370">0</span><span class="op" id="5061371">)</span><span class="op" id="5061372">;</span>&nbsp;<span class="ident" id="5061374">i</span>&nbsp;<span class="op" id="5061376">&lt;</span>&nbsp;<span class="ident" id="5061378">Ninterrupt</span><span class="op" id="5061388">/</span><span class="num" id="5061389">8</span><span class="op" id="5061390">;</span>&nbsp;<span class="ident" id="5061392">i</span><span class="op" id="5061393">++</span>&nbsp;<span class="op" id="5061396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5061400">pending</span>&nbsp;<span class="op" id="5061408">:=</span>&nbsp;<span class="ident" id="5061411">in</span><span class="op" id="5061413">.</span><span class="ident" id="5061414">readByte</span><span class="op" id="5061422">(</span><span class="ident" id="5061423">intPending</span>&nbsp;<span class="op" id="5061434">+</span>&nbsp;<span class="ident" id="5061436">i</span><span class="op" id="5061437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5061441">mask</span>&nbsp;<span class="op" id="5061446">:=</span>&nbsp;<span class="ident" id="5061449">in</span><span class="op" id="5061451">.</span><span class="ident" id="5061452">readByte</span><span class="op" id="5061460">(</span><span class="ident" id="5061461">intMask</span>&nbsp;<span class="op" id="5061469">+</span>&nbsp;<span class="ident" id="5061471">i</span><span class="op" id="5061472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5061476">pending</span>&nbsp;<span class="op" id="5061484">&amp;=</span>&nbsp;<span class="ident" id="5061487">mask</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5061494">if</span>&nbsp;<span class="ident" id="5061497">pending</span>&nbsp;<span class="op" id="5061505">==</span>&nbsp;<span class="num" id="5061508">0</span>&nbsp;<span class="op" id="5061510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5061515">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5061526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5061531">for</span>&nbsp;<span class="ident" id="5061535">b</span>&nbsp;<span class="op" id="5061537">:=</span>&nbsp;<span class="builtintype" id="5061540">byte</span><span class="op" id="5061544">(</span><span class="num" id="5061545">0</span><span class="op" id="5061546">)</span><span class="op" id="5061547">;</span>&nbsp;<span class="ident" id="5061549">b</span>&nbsp;<span class="op" id="5061551">&lt;</span>&nbsp;<span class="num" id="5061553">8</span><span class="op" id="5061554">;</span>&nbsp;<span class="ident" id="5061556">b</span><span class="op" id="5061557">++</span>&nbsp;<span class="op" id="5061560">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5061565">if</span>&nbsp;<span class="ident" id="5061568">pending</span><span class="op" id="5061575">&amp;</span><span class="op" id="5061576">(</span><span class="num" id="5061577">0x1</span><span class="op" id="5061580">&lt;&lt;</span><span class="ident" id="5061582">b</span><span class="op" id="5061583">)</span>&nbsp;<span class="op" id="5061585">==</span>&nbsp;<span class="num" id="5061588">0</span>&nbsp;<span class="op" id="5061590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5061596">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5061608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5061614">return</span>&nbsp;<span class="builtintype" id="5061621">true</span><span class="op" id="5061625">,</span>&nbsp;<span class="builtintype" id="5061627">byte</span><span class="op" id="5061631">(</span><span class="ident" id="5061632">i</span><span class="op" id="5061633">*</span><span class="num" id="5061634">8</span><span class="op" id="5061635">)</span>&nbsp;<span class="op" id="5061637">+</span>&nbsp;<span class="ident" id="5061639">b</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5061643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5061646">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5061650">return</span>&nbsp;<span class="builtintype" id="5061657">false</span><span class="op" id="5061662">,</span>&nbsp;<span class="num" id="5061664">0</span><br>
<span class="lineno"></span><span class="op" id="5061666">}</span>
</div>
</body>
</html>
