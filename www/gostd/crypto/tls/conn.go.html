<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html" class="current">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4344389">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4344444">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4344498">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4344549">//&nbsp;TLS&nbsp;low&nbsp;level&nbsp;connection&nbsp;and&nbsp;record&nbsp;layer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4344595">package</span>&nbsp;<span class="ident" id="4344603">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4344608">import</span>&nbsp;<span class="op" id="4344615">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4344618">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4344627">&#34;crypto/cipher&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4344644">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4344661">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4344676">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4344686">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4344693">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4344699">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4344706">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4344714">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="4344721">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4344724">//&nbsp;A&nbsp;Conn&nbsp;represents&nbsp;a&nbsp;secured&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4344767">//&nbsp;It&nbsp;implements&nbsp;the&nbsp;net.Conn&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="4344808">type</span>&nbsp;<span class="ident" id="4344813">Conn</span>&nbsp;<span class="keyword" id="4344818">struct</span>&nbsp;<span class="op" id="4344825">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4344828">//&nbsp;constant</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4344841">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4344850">net</span><span class="op" id="4344853">.</span><span class="ident" id="4344854">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4344860">isClient</span>&nbsp;<span class="builtintype" id="4344869">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4344876">//&nbsp;constant&nbsp;after&nbsp;handshake;&nbsp;protected&nbsp;by&nbsp;handshakeMutex</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4344934">handshakeMutex</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4344952">sync</span><span class="op" id="4344956">.</span><span class="ident" id="4344957">Mutex</span>&nbsp;<span class="comment" id="4344963">//&nbsp;handshakeMutex&nbsp;&lt;&nbsp;in.Mutex,&nbsp;out.Mutex,&nbsp;errMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4345014">handshakeErr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4345032">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4345043">//&nbsp;error&nbsp;resulting&nbsp;from&nbsp;handshake</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4345078">vers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4345096">uint16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4345107">//&nbsp;TLS&nbsp;version</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4345123">haveVers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4345141">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4345152">//&nbsp;version&nbsp;has&nbsp;been&nbsp;negotiated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4345184">config</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4345202">*</span><span class="ident" id="4345203">Config</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4345213">//&nbsp;configuration&nbsp;passed&nbsp;to&nbsp;constructor</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4345253">handshakeComplete</span>&nbsp;<span class="builtintype" id="4345271">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4345277">didResume</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4345295">bool</span>&nbsp;<span class="comment" id="4345300">//&nbsp;whether&nbsp;this&nbsp;connection&nbsp;was&nbsp;a&nbsp;session&nbsp;resumption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4345353">cipherSuite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4345371">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4345379">ocspResponse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4345397">[</span><span class="op" id="4345398">]</span><span class="builtintype" id="4345399">byte</span>&nbsp;<span class="comment" id="4345404">//&nbsp;stapled&nbsp;OCSP&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4345430">peerCertificates</span>&nbsp;&nbsp;<span class="op" id="4345448">[</span><span class="op" id="4345449">]</span><span class="op" id="4345450">*</span><span class="ident" id="4345451">x509</span><span class="op" id="4345455">.</span><span class="ident" id="4345456">Certificate</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4345469">//&nbsp;verifiedChains&nbsp;contains&nbsp;the&nbsp;certificate&nbsp;chains&nbsp;that&nbsp;we&nbsp;built,&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4345538">//&nbsp;opposed&nbsp;to&nbsp;the&nbsp;ones&nbsp;presented&nbsp;by&nbsp;the&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4345587">verifiedChains</span>&nbsp;<span class="op" id="4345602">[</span><span class="op" id="4345603">]</span><span class="op" id="4345604">[</span><span class="op" id="4345605">]</span><span class="op" id="4345606">*</span><span class="ident" id="4345607">x509</span><span class="op" id="4345611">.</span><span class="ident" id="4345612">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4345625">//&nbsp;serverName&nbsp;contains&nbsp;the&nbsp;server&nbsp;name&nbsp;indicated&nbsp;by&nbsp;the&nbsp;client,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4345698">serverName</span>&nbsp;<span class="builtintype" id="4345709">string</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4345717">//&nbsp;firstFinished&nbsp;contains&nbsp;the&nbsp;first&nbsp;Finished&nbsp;hash&nbsp;sent&nbsp;during&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4345784">//&nbsp;handshake.&nbsp;This&nbsp;is&nbsp;the&nbsp;&#34;tls-unique&#34;&nbsp;channel&nbsp;binding&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4345847">firstFinished</span>&nbsp;<span class="op" id="4345861">[</span><span class="num" id="4345862">12</span><span class="op" id="4345864">]</span><span class="builtintype" id="4345865">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4345872">clientProtocol</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4345895">string</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4345903">clientProtocolFallback</span>&nbsp;<span class="builtintype" id="4345926">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4345933">//&nbsp;input/output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4345950">in</span><span class="op" id="4345952">,</span>&nbsp;<span class="ident" id="4345954">out</span>&nbsp;&nbsp;<span class="ident" id="4345959">halfConn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4345972">//&nbsp;in.Mutex&nbsp;&lt;&nbsp;out.Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4345997">rawInput</span>&nbsp;<span class="op" id="4346006">*</span><span class="ident" id="4346007">block</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4346019">//&nbsp;raw&nbsp;input,&nbsp;right&nbsp;off&nbsp;the&nbsp;wire</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4346053">input</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4346062">*</span><span class="ident" id="4346063">block</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4346075">//&nbsp;application&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4346115">hand</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4346124">bytes</span><span class="op" id="4346129">.</span><span class="ident" id="4346130">Buffer</span>&nbsp;<span class="comment" id="4346137">//&nbsp;handshake&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;read</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4346176">tmp</span>&nbsp;<span class="op" id="4346180">[</span><span class="num" id="4346181">16</span><span class="op" id="4346183">]</span><span class="builtintype" id="4346184">byte</span><br>
<span class="lineno"></span><span class="op" id="4346189">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="4346192">//&nbsp;Access&nbsp;to&nbsp;net.Conn&nbsp;methods.</span><br>
<span class="lineno"></span><span class="comment" id="4346223">//&nbsp;Cannot&nbsp;just&nbsp;embed&nbsp;net.Conn&nbsp;because&nbsp;that&nbsp;would</span><br>
<span class="lineno"></span><span class="comment" id="4346272">//&nbsp;export&nbsp;the&nbsp;struct&nbsp;field&nbsp;too.</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="4346305">//&nbsp;LocalAddr&nbsp;returns&nbsp;the&nbsp;local&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="4346353">func</span>&nbsp;<span class="op" id="4346358">(</span><span class="ident" id="4346359">c</span>&nbsp;<span class="op" id="4346361">*</span><span class="ident" id="4346362">Conn</span><span class="op" id="4346366">)</span>&nbsp;<span class="ident" id="4346368">LocalAddr</span><span class="op" id="4346377">(</span><span class="op" id="4346378">)</span>&nbsp;<span class="ident" id="4346380">net</span><span class="op" id="4346383">.</span><span class="ident" id="4346384">Addr</span>&nbsp;<span class="op" id="4346389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4346392">return</span>&nbsp;<span class="ident" id="4346399">c</span><span class="op" id="4346400">.</span><span class="ident" id="4346401">conn</span><span class="op" id="4346405">.</span><span class="ident" id="4346406">LocalAddr</span><span class="op" id="4346415">(</span><span class="op" id="4346416">)</span><br>
<span class="lineno"></span><span class="op" id="4346418">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="comment" id="4346421">//&nbsp;RemoteAddr&nbsp;returns&nbsp;the&nbsp;remote&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="4346471">func</span>&nbsp;<span class="op" id="4346476">(</span><span class="ident" id="4346477">c</span>&nbsp;<span class="op" id="4346479">*</span><span class="ident" id="4346480">Conn</span><span class="op" id="4346484">)</span>&nbsp;<span class="ident" id="4346486">RemoteAddr</span><span class="op" id="4346496">(</span><span class="op" id="4346497">)</span>&nbsp;<span class="ident" id="4346499">net</span><span class="op" id="4346502">.</span><span class="ident" id="4346503">Addr</span>&nbsp;<span class="op" id="4346508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4346511">return</span>&nbsp;<span class="ident" id="4346518">c</span><span class="op" id="4346519">.</span><span class="ident" id="4346520">conn</span><span class="op" id="4346524">.</span><span class="ident" id="4346525">RemoteAddr</span><span class="op" id="4346535">(</span><span class="op" id="4346536">)</span><br>
<span class="lineno"></span><span class="op" id="4346538">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="4346541">//&nbsp;SetDeadline&nbsp;sets&nbsp;the&nbsp;read&nbsp;and&nbsp;write&nbsp;deadlines&nbsp;associated&nbsp;with&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4346622">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Read&nbsp;and&nbsp;Write&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno"></span><span class="comment" id="4346684">//&nbsp;After&nbsp;a&nbsp;Write&nbsp;has&nbsp;timed&nbsp;out,&nbsp;the&nbsp;TLS&nbsp;state&nbsp;is&nbsp;corrupt&nbsp;and&nbsp;all&nbsp;future&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;same&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="4346791">func</span>&nbsp;<span class="op" id="4346796">(</span><span class="ident" id="4346797">c</span>&nbsp;<span class="op" id="4346799">*</span><span class="ident" id="4346800">Conn</span><span class="op" id="4346804">)</span>&nbsp;<span class="ident" id="4346806">SetDeadline</span><span class="op" id="4346817">(</span><span class="ident" id="4346818">t</span>&nbsp;<span class="ident" id="4346820">time</span><span class="op" id="4346824">.</span><span class="ident" id="4346825">Time</span><span class="op" id="4346829">)</span>&nbsp;<span class="builtintype" id="4346831">error</span>&nbsp;<span class="op" id="4346837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4346840">return</span>&nbsp;<span class="ident" id="4346847">c</span><span class="op" id="4346848">.</span><span class="ident" id="4346849">conn</span><span class="op" id="4346853">.</span><span class="ident" id="4346854">SetDeadline</span><span class="op" id="4346865">(</span><span class="ident" id="4346866">t</span><span class="op" id="4346867">)</span><br>
<span class="lineno">80</span><span class="op" id="4346869">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4346872">//&nbsp;SetReadDeadline&nbsp;sets&nbsp;the&nbsp;read&nbsp;deadline&nbsp;on&nbsp;the&nbsp;underlying&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4346944">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Read&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="4346996">func</span>&nbsp;<span class="op" id="4347001">(</span><span class="ident" id="4347002">c</span>&nbsp;<span class="op" id="4347004">*</span><span class="ident" id="4347005">Conn</span><span class="op" id="4347009">)</span>&nbsp;<span class="ident" id="4347011">SetReadDeadline</span><span class="op" id="4347026">(</span><span class="ident" id="4347027">t</span>&nbsp;<span class="ident" id="4347029">time</span><span class="op" id="4347033">.</span><span class="ident" id="4347034">Time</span><span class="op" id="4347038">)</span>&nbsp;<span class="builtintype" id="4347040">error</span>&nbsp;<span class="op" id="4347046">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4347049">return</span>&nbsp;<span class="ident" id="4347056">c</span><span class="op" id="4347057">.</span><span class="ident" id="4347058">conn</span><span class="op" id="4347062">.</span><span class="ident" id="4347063">SetReadDeadline</span><span class="op" id="4347078">(</span><span class="ident" id="4347079">t</span><span class="op" id="4347080">)</span><br>
<span class="lineno"></span><span class="op" id="4347082">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4347085">//&nbsp;SetWriteDeadline&nbsp;sets&nbsp;the&nbsp;write&nbsp;deadline&nbsp;on&nbsp;the&nbsp;underlying&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4347159">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Write&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno">90</span><span class="comment" id="4347212">//&nbsp;After&nbsp;a&nbsp;Write&nbsp;has&nbsp;timed&nbsp;out,&nbsp;the&nbsp;TLS&nbsp;state&nbsp;is&nbsp;corrupt&nbsp;and&nbsp;all&nbsp;future&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;same&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="4347319">func</span>&nbsp;<span class="op" id="4347324">(</span><span class="ident" id="4347325">c</span>&nbsp;<span class="op" id="4347327">*</span><span class="ident" id="4347328">Conn</span><span class="op" id="4347332">)</span>&nbsp;<span class="ident" id="4347334">SetWriteDeadline</span><span class="op" id="4347350">(</span><span class="ident" id="4347351">t</span>&nbsp;<span class="ident" id="4347353">time</span><span class="op" id="4347357">.</span><span class="ident" id="4347358">Time</span><span class="op" id="4347362">)</span>&nbsp;<span class="builtintype" id="4347364">error</span>&nbsp;<span class="op" id="4347370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4347373">return</span>&nbsp;<span class="ident" id="4347380">c</span><span class="op" id="4347381">.</span><span class="ident" id="4347382">conn</span><span class="op" id="4347386">.</span><span class="ident" id="4347387">SetWriteDeadline</span><span class="op" id="4347403">(</span><span class="ident" id="4347404">t</span><span class="op" id="4347405">)</span><br>
<span class="lineno"></span><span class="op" id="4347407">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="4347410">//&nbsp;A&nbsp;halfConn&nbsp;represents&nbsp;one&nbsp;direction&nbsp;of&nbsp;the&nbsp;record&nbsp;layer</span><br>
<span class="lineno"></span><span class="comment" id="4347469">//&nbsp;connection,&nbsp;either&nbsp;sending&nbsp;or&nbsp;receiving.</span><br>
<span class="lineno"></span><span class="keyword" id="4347513">type</span>&nbsp;<span class="ident" id="4347518">halfConn</span>&nbsp;<span class="keyword" id="4347527">struct</span>&nbsp;<span class="op" id="4347534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4347537">sync</span><span class="op" id="4347541">.</span><span class="ident" id="4347542">Mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4347550">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4347558">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4347570">//&nbsp;first&nbsp;permanent&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4347596">version</span>&nbsp;<span class="builtintype" id="4347604">uint16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4347616">//&nbsp;protocol&nbsp;version</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4347637">cipher</span>&nbsp;&nbsp;<span class="keyword" id="4347645">interface</span><span class="op" id="4347654">{</span><span class="op" id="4347655">}</span>&nbsp;<span class="comment" id="4347657">//&nbsp;cipher&nbsp;algorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4347678">mac</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4347686">macFunction</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4347699">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4347707">[</span><span class="num" id="4347708">8</span><span class="op" id="4347709">]</span><span class="builtintype" id="4347710">byte</span>&nbsp;<span class="comment" id="4347715">//&nbsp;64-bit&nbsp;sequence&nbsp;number</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4347742">bfree</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4347750">*</span><span class="ident" id="4347751">block</span>&nbsp;&nbsp;<span class="comment" id="4347758">//&nbsp;list&nbsp;of&nbsp;free&nbsp;blocks</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4347783">nextCipher</span>&nbsp;<span class="keyword" id="4347794">interface</span><span class="op" id="4347803">{</span><span class="op" id="4347804">}</span>&nbsp;<span class="comment" id="4347806">//&nbsp;next&nbsp;encryption&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4347832">nextMac</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4347843">macFunction</span>&nbsp;<span class="comment" id="4347855">//&nbsp;next&nbsp;MAC&nbsp;algorithm</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4347879">//&nbsp;used&nbsp;to&nbsp;save&nbsp;allocating&nbsp;a&nbsp;new&nbsp;buffer&nbsp;for&nbsp;each&nbsp;MAC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4347934">inDigestBuf</span><span class="op" id="4347945">,</span>&nbsp;<span class="ident" id="4347947">outDigestBuf</span>&nbsp;<span class="op" id="4347960">[</span><span class="op" id="4347961">]</span><span class="builtintype" id="4347962">byte</span><br>
<span class="lineno"></span><span class="op" id="4347967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4347970">func</span>&nbsp;<span class="op" id="4347975">(</span><span class="ident" id="4347976">hc</span>&nbsp;<span class="op" id="4347979">*</span><span class="ident" id="4347980">halfConn</span><span class="op" id="4347988">)</span>&nbsp;<span class="ident" id="4347990">setErrorLocked</span><span class="op" id="4348004">(</span><span class="ident" id="4348005">err</span>&nbsp;<span class="builtintype" id="4348009">error</span><span class="op" id="4348014">)</span>&nbsp;<span class="builtintype" id="4348016">error</span>&nbsp;<span class="op" id="4348022">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4348025">hc</span><span class="op" id="4348027">.</span><span class="ident" id="4348028">err</span>&nbsp;<span class="op" id="4348032">=</span>&nbsp;<span class="ident" id="4348034">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4348039">return</span>&nbsp;<span class="ident" id="4348046">err</span><br>
<span class="lineno"></span><span class="op" id="4348050">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4348053">func</span>&nbsp;<span class="op" id="4348058">(</span><span class="ident" id="4348059">hc</span>&nbsp;<span class="op" id="4348062">*</span><span class="ident" id="4348063">halfConn</span><span class="op" id="4348071">)</span>&nbsp;<span class="builtintype" id="4348073">error</span><span class="op" id="4348078">(</span><span class="op" id="4348079">)</span>&nbsp;<span class="builtintype" id="4348081">error</span>&nbsp;<span class="op" id="4348087">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4348090">hc</span><span class="op" id="4348092">.</span><span class="ident" id="4348093">Lock</span><span class="op" id="4348097">(</span><span class="op" id="4348098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4348101">err</span>&nbsp;<span class="op" id="4348105">:=</span>&nbsp;<span class="ident" id="4348108">hc</span><span class="op" id="4348110">.</span><span class="ident" id="4348111">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4348116">hc</span><span class="op" id="4348118">.</span><span class="ident" id="4348119">Unlock</span><span class="op" id="4348125">(</span><span class="op" id="4348126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4348129">return</span>&nbsp;<span class="ident" id="4348136">err</span><br>
<span class="lineno"></span><span class="op" id="4348140">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="comment" id="4348143">//&nbsp;prepareCipherSpec&nbsp;sets&nbsp;the&nbsp;encryption&nbsp;and&nbsp;MAC&nbsp;states</span><br>
<span class="lineno"></span><span class="comment" id="4348199">//&nbsp;that&nbsp;a&nbsp;subsequent&nbsp;changeCipherSpec&nbsp;will&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="4348247">func</span>&nbsp;<span class="op" id="4348252">(</span><span class="ident" id="4348253">hc</span>&nbsp;<span class="op" id="4348256">*</span><span class="ident" id="4348257">halfConn</span><span class="op" id="4348265">)</span>&nbsp;<span class="ident" id="4348267">prepareCipherSpec</span><span class="op" id="4348284">(</span><span class="ident" id="4348285">version</span>&nbsp;<span class="builtintype" id="4348293">uint16</span><span class="op" id="4348299">,</span>&nbsp;<span class="ident" id="4348301">cipher</span>&nbsp;<span class="keyword" id="4348308">interface</span><span class="op" id="4348317">{</span><span class="op" id="4348318">}</span><span class="op" id="4348319">,</span>&nbsp;<span class="ident" id="4348321">mac</span>&nbsp;<span class="ident" id="4348325">macFunction</span><span class="op" id="4348336">)</span>&nbsp;<span class="op" id="4348338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4348341">hc</span><span class="op" id="4348343">.</span><span class="ident" id="4348344">version</span>&nbsp;<span class="op" id="4348352">=</span>&nbsp;<span class="ident" id="4348354">version</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4348363">hc</span><span class="op" id="4348365">.</span><span class="ident" id="4348366">nextCipher</span>&nbsp;<span class="op" id="4348377">=</span>&nbsp;<span class="ident" id="4348379">cipher</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4348387">hc</span><span class="op" id="4348389">.</span><span class="ident" id="4348390">nextMac</span>&nbsp;<span class="op" id="4348398">=</span>&nbsp;<span class="ident" id="4348400">mac</span><br>
<span class="lineno"></span><span class="op" id="4348404">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4348407">//&nbsp;changeCipherSpec&nbsp;changes&nbsp;the&nbsp;encryption&nbsp;and&nbsp;MAC&nbsp;states</span><br>
<span class="lineno">135</span><span class="comment" id="4348465">//&nbsp;to&nbsp;the&nbsp;ones&nbsp;previously&nbsp;passed&nbsp;to&nbsp;prepareCipherSpec.</span><br>
<span class="lineno"></span><span class="keyword" id="4348520">func</span>&nbsp;<span class="op" id="4348525">(</span><span class="ident" id="4348526">hc</span>&nbsp;<span class="op" id="4348529">*</span><span class="ident" id="4348530">halfConn</span><span class="op" id="4348538">)</span>&nbsp;<span class="ident" id="4348540">changeCipherSpec</span><span class="op" id="4348556">(</span><span class="op" id="4348557">)</span>&nbsp;<span class="builtintype" id="4348559">error</span>&nbsp;<span class="op" id="4348565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4348568">if</span>&nbsp;<span class="ident" id="4348571">hc</span><span class="op" id="4348573">.</span><span class="ident" id="4348574">nextCipher</span>&nbsp;<span class="op" id="4348585">==</span>&nbsp;<span class="builtintype" id="4348588">nil</span>&nbsp;<span class="op" id="4348592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4348596">return</span>&nbsp;<span class="ident" id="4348603">alertInternalError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4348623">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4348626">hc</span><span class="op" id="4348628">.</span><span class="ident" id="4348629">cipher</span>&nbsp;<span class="op" id="4348636">=</span>&nbsp;<span class="ident" id="4348638">hc</span><span class="op" id="4348640">.</span><span class="ident" id="4348641">nextCipher</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4348653">hc</span><span class="op" id="4348655">.</span><span class="ident" id="4348656">mac</span>&nbsp;<span class="op" id="4348660">=</span>&nbsp;<span class="ident" id="4348662">hc</span><span class="op" id="4348664">.</span><span class="ident" id="4348665">nextMac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4348674">hc</span><span class="op" id="4348676">.</span><span class="ident" id="4348677">nextCipher</span>&nbsp;<span class="op" id="4348688">=</span>&nbsp;<span class="builtintype" id="4348690">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4348695">hc</span><span class="op" id="4348697">.</span><span class="ident" id="4348698">nextMac</span>&nbsp;<span class="op" id="4348706">=</span>&nbsp;<span class="builtintype" id="4348708">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4348713">for</span>&nbsp;<span class="ident" id="4348717">i</span>&nbsp;<span class="op" id="4348719">:=</span>&nbsp;<span class="keyword" id="4348722">range</span>&nbsp;<span class="ident" id="4348728">hc</span><span class="op" id="4348730">.</span><span class="ident" id="4348731">seq</span>&nbsp;<span class="op" id="4348735">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4348739">hc</span><span class="op" id="4348741">.</span><span class="ident" id="4348742">seq</span><span class="op" id="4348745">[</span><span class="ident" id="4348746">i</span><span class="op" id="4348747">]</span>&nbsp;<span class="op" id="4348749">=</span>&nbsp;<span class="num" id="4348751">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4348754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4348757">return</span>&nbsp;<span class="builtintype" id="4348764">nil</span><br>
<span class="lineno"></span><span class="op" id="4348768">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="4348771">//&nbsp;incSeq&nbsp;increments&nbsp;the&nbsp;sequence&nbsp;number.</span><br>
<span class="lineno"></span><span class="keyword" id="4348813">func</span>&nbsp;<span class="op" id="4348818">(</span><span class="ident" id="4348819">hc</span>&nbsp;<span class="op" id="4348822">*</span><span class="ident" id="4348823">halfConn</span><span class="op" id="4348831">)</span>&nbsp;<span class="ident" id="4348833">incSeq</span><span class="op" id="4348839">(</span><span class="op" id="4348840">)</span>&nbsp;<span class="op" id="4348842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4348845">for</span>&nbsp;<span class="ident" id="4348849">i</span>&nbsp;<span class="op" id="4348851">:=</span>&nbsp;<span class="num" id="4348854">7</span><span class="op" id="4348855">;</span>&nbsp;<span class="ident" id="4348857">i</span>&nbsp;<span class="op" id="4348859">&gt;=</span>&nbsp;<span class="num" id="4348862">0</span><span class="op" id="4348863">;</span>&nbsp;<span class="ident" id="4348865">i</span><span class="op" id="4348866">--</span>&nbsp;<span class="op" id="4348869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4348873">hc</span><span class="op" id="4348875">.</span><span class="ident" id="4348876">seq</span><span class="op" id="4348879">[</span><span class="ident" id="4348880">i</span><span class="op" id="4348881">]</span><span class="op" id="4348882">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4348887">if</span>&nbsp;<span class="ident" id="4348890">hc</span><span class="op" id="4348892">.</span><span class="ident" id="4348893">seq</span><span class="op" id="4348896">[</span><span class="ident" id="4348897">i</span><span class="op" id="4348898">]</span>&nbsp;<span class="op" id="4348900">!=</span>&nbsp;<span class="num" id="4348903">0</span>&nbsp;<span class="op" id="4348905">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4348910">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4348919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4348922">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4348926">//&nbsp;Not&nbsp;allowed&nbsp;to&nbsp;let&nbsp;sequence&nbsp;number&nbsp;wrap.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4348971">//&nbsp;Instead,&nbsp;must&nbsp;renegotiate&nbsp;before&nbsp;it&nbsp;does.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4349017">//&nbsp;Not&nbsp;likely&nbsp;enough&nbsp;to&nbsp;bother.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4349050">panic</span><span class="op" id="4349055">(</span><span class="string" id="4349056">&#34;TLS:&nbsp;sequence&nbsp;number&nbsp;wraparound&#34;</span><span class="op" id="4349089">)</span><br>
<span class="lineno"></span><span class="op" id="4349091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="4349094">//&nbsp;resetSeq&nbsp;resets&nbsp;the&nbsp;sequence&nbsp;number&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span><span class="keyword" id="4349142">func</span>&nbsp;<span class="op" id="4349147">(</span><span class="ident" id="4349148">hc</span>&nbsp;<span class="op" id="4349151">*</span><span class="ident" id="4349152">halfConn</span><span class="op" id="4349160">)</span>&nbsp;<span class="ident" id="4349162">resetSeq</span><span class="op" id="4349170">(</span><span class="op" id="4349171">)</span>&nbsp;<span class="op" id="4349173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4349176">for</span>&nbsp;<span class="ident" id="4349180">i</span>&nbsp;<span class="op" id="4349182">:=</span>&nbsp;<span class="keyword" id="4349185">range</span>&nbsp;<span class="ident" id="4349191">hc</span><span class="op" id="4349193">.</span><span class="ident" id="4349194">seq</span>&nbsp;<span class="op" id="4349198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4349202">hc</span><span class="op" id="4349204">.</span><span class="ident" id="4349205">seq</span><span class="op" id="4349208">[</span><span class="ident" id="4349209">i</span><span class="op" id="4349210">]</span>&nbsp;<span class="op" id="4349212">=</span>&nbsp;<span class="num" id="4349214">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4349217">}</span><br>
<span class="lineno">170</span><span class="op" id="4349219">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4349222">//&nbsp;removePadding&nbsp;returns&nbsp;an&nbsp;unpadded&nbsp;slice,&nbsp;in&nbsp;constant&nbsp;time,&nbsp;which&nbsp;is&nbsp;a&nbsp;prefix</span><br>
<span class="lineno"></span><span class="comment" id="4349302">//&nbsp;of&nbsp;the&nbsp;input.&nbsp;It&nbsp;also&nbsp;returns&nbsp;a&nbsp;byte&nbsp;which&nbsp;is&nbsp;equal&nbsp;to&nbsp;255&nbsp;if&nbsp;the&nbsp;padding</span><br>
<span class="lineno"></span><span class="comment" id="4349379">//&nbsp;was&nbsp;valid&nbsp;and&nbsp;0&nbsp;otherwise.&nbsp;See&nbsp;RFC&nbsp;2246,&nbsp;section&nbsp;6.2.3.2</span><br>
<span class="lineno">175</span><span class="keyword" id="4349439">func</span>&nbsp;<span class="ident" id="4349444">removePadding</span><span class="op" id="4349457">(</span><span class="ident" id="4349458">payload</span>&nbsp;<span class="op" id="4349466">[</span><span class="op" id="4349467">]</span><span class="builtintype" id="4349468">byte</span><span class="op" id="4349472">)</span>&nbsp;<span class="op" id="4349474">(</span><span class="op" id="4349475">[</span><span class="op" id="4349476">]</span><span class="builtintype" id="4349477">byte</span><span class="op" id="4349481">,</span>&nbsp;<span class="builtintype" id="4349483">byte</span><span class="op" id="4349487">)</span>&nbsp;<span class="op" id="4349489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4349492">if</span>&nbsp;<span class="builtinfunc" id="4349495">len</span><span class="op" id="4349498">(</span><span class="ident" id="4349499">payload</span><span class="op" id="4349506">)</span>&nbsp;<span class="op" id="4349508">&lt;</span>&nbsp;<span class="num" id="4349510">1</span>&nbsp;<span class="op" id="4349512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4349516">return</span>&nbsp;<span class="ident" id="4349523">payload</span><span class="op" id="4349530">,</span>&nbsp;<span class="num" id="4349532">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4349535">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4349539">paddingLen</span>&nbsp;<span class="op" id="4349550">:=</span>&nbsp;<span class="ident" id="4349553">payload</span><span class="op" id="4349560">[</span><span class="builtinfunc" id="4349561">len</span><span class="op" id="4349564">(</span><span class="ident" id="4349565">payload</span><span class="op" id="4349572">)</span><span class="op" id="4349573">-</span><span class="num" id="4349574">1</span><span class="op" id="4349575">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4349578">t</span>&nbsp;<span class="op" id="4349580">:=</span>&nbsp;<span class="builtintype" id="4349583">uint</span><span class="op" id="4349587">(</span><span class="builtinfunc" id="4349588">len</span><span class="op" id="4349591">(</span><span class="ident" id="4349592">payload</span><span class="op" id="4349599">)</span><span class="op" id="4349600">-</span><span class="num" id="4349601">1</span><span class="op" id="4349602">)</span>&nbsp;<span class="op" id="4349604">-</span>&nbsp;<span class="builtintype" id="4349606">uint</span><span class="op" id="4349610">(</span><span class="ident" id="4349611">paddingLen</span><span class="op" id="4349621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4349624">//&nbsp;if&nbsp;len(payload)&nbsp;&gt;=&nbsp;(paddingLen&nbsp;-&nbsp;1)&nbsp;then&nbsp;the&nbsp;MSB&nbsp;of&nbsp;t&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4349690">good</span>&nbsp;<span class="op" id="4349695">:=</span>&nbsp;<span class="builtintype" id="4349698">byte</span><span class="op" id="4349702">(</span><span class="builtintype" id="4349703">int32</span><span class="op" id="4349708">(</span><span class="op" id="4349709">^</span><span class="ident" id="4349710">t</span><span class="op" id="4349711">)</span>&nbsp;<span class="op" id="4349713">&gt;&gt;</span>&nbsp;<span class="num" id="4349716">31</span><span class="op" id="4349718">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4349722">toCheck</span>&nbsp;<span class="op" id="4349730">:=</span>&nbsp;<span class="num" id="4349733">255</span>&nbsp;<span class="comment" id="4349737">//&nbsp;the&nbsp;maximum&nbsp;possible&nbsp;padding&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4349777">//&nbsp;The&nbsp;length&nbsp;of&nbsp;the&nbsp;padded&nbsp;data&nbsp;is&nbsp;public,&nbsp;so&nbsp;we&nbsp;can&nbsp;use&nbsp;an&nbsp;if&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4349847">if</span>&nbsp;<span class="ident" id="4349850">toCheck</span><span class="op" id="4349857">+</span><span class="num" id="4349858">1</span>&nbsp;<span class="op" id="4349860">&gt;</span>&nbsp;<span class="builtinfunc" id="4349862">len</span><span class="op" id="4349865">(</span><span class="ident" id="4349866">payload</span><span class="op" id="4349873">)</span>&nbsp;<span class="op" id="4349875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4349879">toCheck</span>&nbsp;<span class="op" id="4349887">=</span>&nbsp;<span class="builtinfunc" id="4349889">len</span><span class="op" id="4349892">(</span><span class="ident" id="4349893">payload</span><span class="op" id="4349900">)</span>&nbsp;<span class="op" id="4349902">-</span>&nbsp;<span class="num" id="4349904">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4349907">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4349911">for</span>&nbsp;<span class="ident" id="4349915">i</span>&nbsp;<span class="op" id="4349917">:=</span>&nbsp;<span class="num" id="4349920">0</span><span class="op" id="4349921">;</span>&nbsp;<span class="ident" id="4349923">i</span>&nbsp;<span class="op" id="4349925">&lt;</span>&nbsp;<span class="ident" id="4349927">toCheck</span><span class="op" id="4349934">;</span>&nbsp;<span class="ident" id="4349936">i</span><span class="op" id="4349937">++</span>&nbsp;<span class="op" id="4349940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4349944">t</span>&nbsp;<span class="op" id="4349946">:=</span>&nbsp;<span class="builtintype" id="4349949">uint</span><span class="op" id="4349953">(</span><span class="ident" id="4349954">paddingLen</span><span class="op" id="4349964">)</span>&nbsp;<span class="op" id="4349966">-</span>&nbsp;<span class="builtintype" id="4349968">uint</span><span class="op" id="4349972">(</span><span class="ident" id="4349973">i</span><span class="op" id="4349974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4349978">//&nbsp;if&nbsp;i&nbsp;&lt;=&nbsp;paddingLen&nbsp;then&nbsp;the&nbsp;MSB&nbsp;of&nbsp;t&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4350028">mask</span>&nbsp;<span class="op" id="4350033">:=</span>&nbsp;<span class="builtintype" id="4350036">byte</span><span class="op" id="4350040">(</span><span class="builtintype" id="4350041">int32</span><span class="op" id="4350046">(</span><span class="op" id="4350047">^</span><span class="ident" id="4350048">t</span><span class="op" id="4350049">)</span>&nbsp;<span class="op" id="4350051">&gt;&gt;</span>&nbsp;<span class="num" id="4350054">31</span><span class="op" id="4350056">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4350060">b</span>&nbsp;<span class="op" id="4350062">:=</span>&nbsp;<span class="ident" id="4350065">payload</span><span class="op" id="4350072">[</span><span class="builtinfunc" id="4350073">len</span><span class="op" id="4350076">(</span><span class="ident" id="4350077">payload</span><span class="op" id="4350084">)</span><span class="op" id="4350085">-</span><span class="num" id="4350086">1</span><span class="op" id="4350087">-</span><span class="ident" id="4350088">i</span><span class="op" id="4350089">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4350093">good</span>&nbsp;<span class="op" id="4350098">&amp;^=</span>&nbsp;<span class="ident" id="4350102">mask</span><span class="op" id="4350106">&amp;</span><span class="ident" id="4350107">paddingLen</span>&nbsp;<span class="op" id="4350118">^</span>&nbsp;<span class="ident" id="4350120">mask</span><span class="op" id="4350124">&amp;</span><span class="ident" id="4350125">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4350128">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4350132">//&nbsp;We&nbsp;AND&nbsp;together&nbsp;the&nbsp;bits&nbsp;of&nbsp;good&nbsp;and&nbsp;replicate&nbsp;the&nbsp;result&nbsp;across</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4350201">//&nbsp;all&nbsp;the&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4350219">good</span>&nbsp;<span class="op" id="4350224">&amp;=</span>&nbsp;<span class="ident" id="4350227">good</span>&nbsp;<span class="op" id="4350232">&lt;&lt;</span>&nbsp;<span class="num" id="4350235">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4350238">good</span>&nbsp;<span class="op" id="4350243">&amp;=</span>&nbsp;<span class="ident" id="4350246">good</span>&nbsp;<span class="op" id="4350251">&lt;&lt;</span>&nbsp;<span class="num" id="4350254">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4350257">good</span>&nbsp;<span class="op" id="4350262">&amp;=</span>&nbsp;<span class="ident" id="4350265">good</span>&nbsp;<span class="op" id="4350270">&lt;&lt;</span>&nbsp;<span class="num" id="4350273">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4350276">good</span>&nbsp;<span class="op" id="4350281">=</span>&nbsp;<span class="builtintype" id="4350283">uint8</span><span class="op" id="4350288">(</span><span class="builtintype" id="4350289">int8</span><span class="op" id="4350293">(</span><span class="ident" id="4350294">good</span><span class="op" id="4350298">)</span>&nbsp;<span class="op" id="4350300">&gt;&gt;</span>&nbsp;<span class="num" id="4350303">7</span><span class="op" id="4350304">)</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4350308">toRemove</span>&nbsp;<span class="op" id="4350317">:=</span>&nbsp;<span class="ident" id="4350320">good</span><span class="op" id="4350324">&amp;</span><span class="ident" id="4350325">paddingLen</span>&nbsp;<span class="op" id="4350336">+</span>&nbsp;<span class="num" id="4350338">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4350341">return</span>&nbsp;<span class="ident" id="4350348">payload</span><span class="op" id="4350355">[</span><span class="op" id="4350356">:</span><span class="builtinfunc" id="4350357">len</span><span class="op" id="4350360">(</span><span class="ident" id="4350361">payload</span><span class="op" id="4350368">)</span><span class="op" id="4350369">-</span><span class="builtintype" id="4350370">int</span><span class="op" id="4350373">(</span><span class="ident" id="4350374">toRemove</span><span class="op" id="4350382">)</span><span class="op" id="4350383">]</span><span class="op" id="4350384">,</span>&nbsp;<span class="ident" id="4350386">good</span><br>
<span class="lineno"></span><span class="op" id="4350391">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="comment" id="4350394">//&nbsp;removePaddingSSL30&nbsp;is&nbsp;a&nbsp;replacement&nbsp;for&nbsp;removePadding&nbsp;in&nbsp;the&nbsp;case&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4350472">//&nbsp;protocol&nbsp;version&nbsp;is&nbsp;SSLv3.&nbsp;In&nbsp;this&nbsp;version,&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;padding</span><br>
<span class="lineno"></span><span class="comment" id="4350547">//&nbsp;are&nbsp;random&nbsp;and&nbsp;cannot&nbsp;be&nbsp;checked.</span><br>
<span class="lineno"></span><span class="keyword" id="4350584">func</span>&nbsp;<span class="ident" id="4350589">removePaddingSSL30</span><span class="op" id="4350607">(</span><span class="ident" id="4350608">payload</span>&nbsp;<span class="op" id="4350616">[</span><span class="op" id="4350617">]</span><span class="builtintype" id="4350618">byte</span><span class="op" id="4350622">)</span>&nbsp;<span class="op" id="4350624">(</span><span class="op" id="4350625">[</span><span class="op" id="4350626">]</span><span class="builtintype" id="4350627">byte</span><span class="op" id="4350631">,</span>&nbsp;<span class="builtintype" id="4350633">byte</span><span class="op" id="4350637">)</span>&nbsp;<span class="op" id="4350639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4350642">if</span>&nbsp;<span class="builtinfunc" id="4350645">len</span><span class="op" id="4350648">(</span><span class="ident" id="4350649">payload</span><span class="op" id="4350656">)</span>&nbsp;<span class="op" id="4350658">&lt;</span>&nbsp;<span class="num" id="4350660">1</span>&nbsp;<span class="op" id="4350662">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4350666">return</span>&nbsp;<span class="ident" id="4350673">payload</span><span class="op" id="4350680">,</span>&nbsp;<span class="num" id="4350682">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4350685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4350689">paddingLen</span>&nbsp;<span class="op" id="4350700">:=</span>&nbsp;<span class="builtintype" id="4350703">int</span><span class="op" id="4350706">(</span><span class="ident" id="4350707">payload</span><span class="op" id="4350714">[</span><span class="builtinfunc" id="4350715">len</span><span class="op" id="4350718">(</span><span class="ident" id="4350719">payload</span><span class="op" id="4350726">)</span><span class="op" id="4350727">-</span><span class="num" id="4350728">1</span><span class="op" id="4350729">]</span><span class="op" id="4350730">)</span>&nbsp;<span class="op" id="4350732">+</span>&nbsp;<span class="num" id="4350734">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4350737">if</span>&nbsp;<span class="ident" id="4350740">paddingLen</span>&nbsp;<span class="op" id="4350751">&gt;</span>&nbsp;<span class="builtinfunc" id="4350753">len</span><span class="op" id="4350756">(</span><span class="ident" id="4350757">payload</span><span class="op" id="4350764">)</span>&nbsp;<span class="op" id="4350766">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4350770">return</span>&nbsp;<span class="ident" id="4350777">payload</span><span class="op" id="4350784">,</span>&nbsp;<span class="num" id="4350786">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4350789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4350793">return</span>&nbsp;<span class="ident" id="4350800">payload</span><span class="op" id="4350807">[</span><span class="op" id="4350808">:</span><span class="builtinfunc" id="4350809">len</span><span class="op" id="4350812">(</span><span class="ident" id="4350813">payload</span><span class="op" id="4350820">)</span><span class="op" id="4350821">-</span><span class="ident" id="4350822">paddingLen</span><span class="op" id="4350832">]</span><span class="op" id="4350833">,</span>&nbsp;<span class="num" id="4350835">255</span><br>
<span class="lineno"></span><span class="op" id="4350839">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="keyword" id="4350842">func</span>&nbsp;<span class="ident" id="4350847">roundUp</span><span class="op" id="4350854">(</span><span class="ident" id="4350855">a</span><span class="op" id="4350856">,</span>&nbsp;<span class="ident" id="4350858">b</span>&nbsp;<span class="builtintype" id="4350860">int</span><span class="op" id="4350863">)</span>&nbsp;<span class="builtintype" id="4350865">int</span>&nbsp;<span class="op" id="4350869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4350872">return</span>&nbsp;<span class="ident" id="4350879">a</span>&nbsp;<span class="op" id="4350881">+</span>&nbsp;<span class="op" id="4350883">(</span><span class="ident" id="4350884">b</span><span class="op" id="4350885">-</span><span class="ident" id="4350886">a</span><span class="op" id="4350887">%</span><span class="ident" id="4350888">b</span><span class="op" id="4350889">)</span><span class="op" id="4350890">%</span><span class="ident" id="4350891">b</span><br>
<span class="lineno"></span><span class="op" id="4350893">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="comment" id="4350896">//&nbsp;cbcMode&nbsp;is&nbsp;an&nbsp;interface&nbsp;for&nbsp;block&nbsp;ciphers&nbsp;using&nbsp;cipher&nbsp;block&nbsp;chaining.</span><br>
<span class="lineno"></span><span class="keyword" id="4350970">type</span>&nbsp;<span class="ident" id="4350975">cbcMode</span>&nbsp;<span class="keyword" id="4350983">interface</span>&nbsp;<span class="op" id="4350993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4350996">cipher</span><span class="op" id="4351002">.</span><span class="ident" id="4351003">BlockMode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4351014">SetIV</span><span class="op" id="4351019">(</span><span class="op" id="4351020">[</span><span class="op" id="4351021">]</span><span class="builtintype" id="4351022">byte</span><span class="op" id="4351026">)</span><br>
<span class="lineno"></span><span class="op" id="4351028">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="4351031">//&nbsp;decrypt&nbsp;checks&nbsp;and&nbsp;strips&nbsp;the&nbsp;mac&nbsp;and&nbsp;decrypts&nbsp;the&nbsp;data&nbsp;in&nbsp;b.&nbsp;Returns&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4351106">//&nbsp;success&nbsp;boolean,&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;to&nbsp;skip&nbsp;from&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;record&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="4351186">//&nbsp;order&nbsp;to&nbsp;get&nbsp;the&nbsp;application&nbsp;payload,&nbsp;and&nbsp;an&nbsp;optional&nbsp;alert&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="4351256">func</span>&nbsp;<span class="op" id="4351261">(</span><span class="ident" id="4351262">hc</span>&nbsp;<span class="op" id="4351265">*</span><span class="ident" id="4351266">halfConn</span><span class="op" id="4351274">)</span>&nbsp;<span class="ident" id="4351276">decrypt</span><span class="op" id="4351283">(</span><span class="ident" id="4351284">b</span>&nbsp;<span class="op" id="4351286">*</span><span class="ident" id="4351287">block</span><span class="op" id="4351292">)</span>&nbsp;<span class="op" id="4351294">(</span><span class="ident" id="4351295">ok</span>&nbsp;<span class="builtintype" id="4351298">bool</span><span class="op" id="4351302">,</span>&nbsp;<span class="ident" id="4351304">prefixLen</span>&nbsp;<span class="builtintype" id="4351314">int</span><span class="op" id="4351317">,</span>&nbsp;<span class="ident" id="4351319">alertValue</span>&nbsp;<span class="ident" id="4351330">alert</span><span class="op" id="4351335">)</span>&nbsp;<span class="op" id="4351337">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4351340">//&nbsp;pull&nbsp;out&nbsp;payload</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4351361">payload</span>&nbsp;<span class="op" id="4351369">:=</span>&nbsp;<span class="ident" id="4351372">b</span><span class="op" id="4351373">.</span><span class="ident" id="4351374">data</span><span class="op" id="4351378">[</span><span class="ident" id="4351379">recordHeaderLen</span><span class="op" id="4351394">:</span><span class="op" id="4351395">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4351399">macSize</span>&nbsp;<span class="op" id="4351407">:=</span>&nbsp;<span class="num" id="4351410">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4351413">if</span>&nbsp;<span class="ident" id="4351416">hc</span><span class="op" id="4351418">.</span><span class="ident" id="4351419">mac</span>&nbsp;<span class="op" id="4351423">!=</span>&nbsp;<span class="builtintype" id="4351426">nil</span>&nbsp;<span class="op" id="4351430">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4351434">macSize</span>&nbsp;<span class="op" id="4351442">=</span>&nbsp;<span class="ident" id="4351444">hc</span><span class="op" id="4351446">.</span><span class="ident" id="4351447">mac</span><span class="op" id="4351450">.</span><span class="ident" id="4351451">Size</span><span class="op" id="4351455">(</span><span class="op" id="4351456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4351459">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4351463">paddingGood</span>&nbsp;<span class="op" id="4351475">:=</span>&nbsp;<span class="builtintype" id="4351478">byte</span><span class="op" id="4351482">(</span><span class="num" id="4351483">255</span><span class="op" id="4351486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4351489">explicitIVLen</span>&nbsp;<span class="op" id="4351503">:=</span>&nbsp;<span class="num" id="4351506">0</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4351510">//&nbsp;decrypt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4351522">if</span>&nbsp;<span class="ident" id="4351525">hc</span><span class="op" id="4351527">.</span><span class="ident" id="4351528">cipher</span>&nbsp;<span class="op" id="4351535">!=</span>&nbsp;<span class="builtintype" id="4351538">nil</span>&nbsp;<span class="op" id="4351542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4351546">switch</span>&nbsp;<span class="ident" id="4351553">c</span>&nbsp;<span class="op" id="4351555">:=</span>&nbsp;<span class="ident" id="4351558">hc</span><span class="op" id="4351560">.</span><span class="ident" id="4351561">cipher</span><span class="op" id="4351567">.</span><span class="op" id="4351568">(</span><span class="keyword" id="4351569">type</span><span class="op" id="4351573">)</span>&nbsp;<span class="op" id="4351575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4351579">case</span>&nbsp;<span class="ident" id="4351584">cipher</span><span class="op" id="4351590">.</span><span class="ident" id="4351591">Stream</span><span class="op" id="4351597">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4351602">c</span><span class="op" id="4351603">.</span><span class="ident" id="4351604">XORKeyStream</span><span class="op" id="4351616">(</span><span class="ident" id="4351617">payload</span><span class="op" id="4351624">,</span>&nbsp;<span class="ident" id="4351626">payload</span><span class="op" id="4351633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4351637">case</span>&nbsp;<span class="ident" id="4351642">cipher</span><span class="op" id="4351648">.</span><span class="ident" id="4351649">AEAD</span><span class="op" id="4351653">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4351658">explicitIVLen</span>&nbsp;<span class="op" id="4351672">=</span>&nbsp;<span class="num" id="4351674">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4351679">if</span>&nbsp;<span class="builtinfunc" id="4351682">len</span><span class="op" id="4351685">(</span><span class="ident" id="4351686">payload</span><span class="op" id="4351693">)</span>&nbsp;<span class="op" id="4351695">&lt;</span>&nbsp;<span class="ident" id="4351697">explicitIVLen</span>&nbsp;<span class="op" id="4351711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4351717">return</span>&nbsp;<span class="builtintype" id="4351724">false</span><span class="op" id="4351729">,</span>&nbsp;<span class="num" id="4351731">0</span><span class="op" id="4351732">,</span>&nbsp;<span class="ident" id="4351734">alertBadRecordMAC</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4351755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4351760">nonce</span>&nbsp;<span class="op" id="4351766">:=</span>&nbsp;<span class="ident" id="4351769">payload</span><span class="op" id="4351776">[</span><span class="op" id="4351777">:</span><span class="num" id="4351778">8</span><span class="op" id="4351779">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4351784">payload</span>&nbsp;<span class="op" id="4351792">=</span>&nbsp;<span class="ident" id="4351794">payload</span><span class="op" id="4351801">[</span><span class="num" id="4351802">8</span><span class="op" id="4351803">:</span><span class="op" id="4351804">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4351810">var</span>&nbsp;<span class="ident" id="4351814">additionalData</span>&nbsp;<span class="op" id="4351829">[</span><span class="num" id="4351830">13</span><span class="op" id="4351832">]</span><span class="builtintype" id="4351833">byte</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4351841">copy</span><span class="op" id="4351845">(</span><span class="ident" id="4351846">additionalData</span><span class="op" id="4351860">[</span><span class="op" id="4351861">:</span><span class="op" id="4351862">]</span><span class="op" id="4351863">,</span>&nbsp;<span class="ident" id="4351865">hc</span><span class="op" id="4351867">.</span><span class="ident" id="4351868">seq</span><span class="op" id="4351871">[</span><span class="op" id="4351872">:</span><span class="op" id="4351873">]</span><span class="op" id="4351874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4351879">copy</span><span class="op" id="4351883">(</span><span class="ident" id="4351884">additionalData</span><span class="op" id="4351898">[</span><span class="num" id="4351899">8</span><span class="op" id="4351900">:</span><span class="op" id="4351901">]</span><span class="op" id="4351902">,</span>&nbsp;<span class="ident" id="4351904">b</span><span class="op" id="4351905">.</span><span class="ident" id="4351906">data</span><span class="op" id="4351910">[</span><span class="op" id="4351911">:</span><span class="num" id="4351912">3</span><span class="op" id="4351913">]</span><span class="op" id="4351914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4351919">n</span>&nbsp;<span class="op" id="4351921">:=</span>&nbsp;<span class="builtinfunc" id="4351924">len</span><span class="op" id="4351927">(</span><span class="ident" id="4351928">payload</span><span class="op" id="4351935">)</span>&nbsp;<span class="op" id="4351937">-</span>&nbsp;<span class="ident" id="4351939">c</span><span class="op" id="4351940">.</span><span class="ident" id="4351941">Overhead</span><span class="op" id="4351949">(</span><span class="op" id="4351950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4351955">additionalData</span><span class="op" id="4351969">[</span><span class="num" id="4351970">11</span><span class="op" id="4351972">]</span>&nbsp;<span class="op" id="4351974">=</span>&nbsp;<span class="builtintype" id="4351976">byte</span><span class="op" id="4351980">(</span><span class="ident" id="4351981">n</span>&nbsp;<span class="op" id="4351983">&gt;&gt;</span>&nbsp;<span class="num" id="4351986">8</span><span class="op" id="4351987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4351992">additionalData</span><span class="op" id="4352006">[</span><span class="num" id="4352007">12</span><span class="op" id="4352009">]</span>&nbsp;<span class="op" id="4352011">=</span>&nbsp;<span class="builtintype" id="4352013">byte</span><span class="op" id="4352017">(</span><span class="ident" id="4352018">n</span><span class="op" id="4352019">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4352024">var</span>&nbsp;<span class="ident" id="4352028">err</span>&nbsp;<span class="builtintype" id="4352032">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4352041">payload</span><span class="op" id="4352048">,</span>&nbsp;<span class="ident" id="4352050">err</span>&nbsp;<span class="op" id="4352054">=</span>&nbsp;<span class="ident" id="4352056">c</span><span class="op" id="4352057">.</span><span class="ident" id="4352058">Open</span><span class="op" id="4352062">(</span><span class="ident" id="4352063">payload</span><span class="op" id="4352070">[</span><span class="op" id="4352071">:</span><span class="num" id="4352072">0</span><span class="op" id="4352073">]</span><span class="op" id="4352074">,</span>&nbsp;<span class="ident" id="4352076">nonce</span><span class="op" id="4352081">,</span>&nbsp;<span class="ident" id="4352083">payload</span><span class="op" id="4352090">,</span>&nbsp;<span class="ident" id="4352092">additionalData</span><span class="op" id="4352106">[</span><span class="op" id="4352107">:</span><span class="op" id="4352108">]</span><span class="op" id="4352109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4352114">if</span>&nbsp;<span class="ident" id="4352117">err</span>&nbsp;<span class="op" id="4352121">!=</span>&nbsp;<span class="builtintype" id="4352124">nil</span>&nbsp;<span class="op" id="4352128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4352134">return</span>&nbsp;<span class="builtintype" id="4352141">false</span><span class="op" id="4352146">,</span>&nbsp;<span class="num" id="4352148">0</span><span class="op" id="4352149">,</span>&nbsp;<span class="ident" id="4352151">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4352172">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4352177">b</span><span class="op" id="4352178">.</span><span class="ident" id="4352179">resize</span><span class="op" id="4352185">(</span><span class="ident" id="4352186">recordHeaderLen</span>&nbsp;<span class="op" id="4352202">+</span>&nbsp;<span class="ident" id="4352204">explicitIVLen</span>&nbsp;<span class="op" id="4352218">+</span>&nbsp;<span class="builtinfunc" id="4352220">len</span><span class="op" id="4352223">(</span><span class="ident" id="4352224">payload</span><span class="op" id="4352231">)</span><span class="op" id="4352232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4352236">case</span>&nbsp;<span class="ident" id="4352241">cbcMode</span><span class="op" id="4352248">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4352253">blockSize</span>&nbsp;<span class="op" id="4352263">:=</span>&nbsp;<span class="ident" id="4352266">c</span><span class="op" id="4352267">.</span><span class="ident" id="4352268">BlockSize</span><span class="op" id="4352277">(</span><span class="op" id="4352278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4352283">if</span>&nbsp;<span class="ident" id="4352286">hc</span><span class="op" id="4352288">.</span><span class="ident" id="4352289">version</span>&nbsp;<span class="op" id="4352297">&gt;=</span>&nbsp;<span class="ident" id="4352300">VersionTLS11</span>&nbsp;<span class="op" id="4352313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4352319">explicitIVLen</span>&nbsp;<span class="op" id="4352333">=</span>&nbsp;<span class="ident" id="4352335">blockSize</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4352348">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4352354">if</span>&nbsp;<span class="builtinfunc" id="4352357">len</span><span class="op" id="4352360">(</span><span class="ident" id="4352361">payload</span><span class="op" id="4352368">)</span><span class="op" id="4352369">%</span><span class="ident" id="4352370">blockSize</span>&nbsp;<span class="op" id="4352380">!=</span>&nbsp;<span class="num" id="4352383">0</span>&nbsp;<span class="op" id="4352385">||</span>&nbsp;<span class="builtinfunc" id="4352388">len</span><span class="op" id="4352391">(</span><span class="ident" id="4352392">payload</span><span class="op" id="4352399">)</span>&nbsp;<span class="op" id="4352401">&lt;</span>&nbsp;<span class="ident" id="4352403">roundUp</span><span class="op" id="4352410">(</span><span class="ident" id="4352411">explicitIVLen</span><span class="op" id="4352424">+</span><span class="ident" id="4352425">macSize</span><span class="op" id="4352432">+</span><span class="num" id="4352433">1</span><span class="op" id="4352434">,</span>&nbsp;<span class="ident" id="4352436">blockSize</span><span class="op" id="4352445">)</span>&nbsp;<span class="op" id="4352447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4352453">return</span>&nbsp;<span class="builtintype" id="4352460">false</span><span class="op" id="4352465">,</span>&nbsp;<span class="num" id="4352467">0</span><span class="op" id="4352468">,</span>&nbsp;<span class="ident" id="4352470">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4352491">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4352497">if</span>&nbsp;<span class="ident" id="4352500">explicitIVLen</span>&nbsp;<span class="op" id="4352514">&gt;</span>&nbsp;<span class="num" id="4352516">0</span>&nbsp;<span class="op" id="4352518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4352524">c</span><span class="op" id="4352525">.</span><span class="ident" id="4352526">SetIV</span><span class="op" id="4352531">(</span><span class="ident" id="4352532">payload</span><span class="op" id="4352539">[</span><span class="op" id="4352540">:</span><span class="ident" id="4352541">explicitIVLen</span><span class="op" id="4352554">]</span><span class="op" id="4352555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4352561">payload</span>&nbsp;<span class="op" id="4352569">=</span>&nbsp;<span class="ident" id="4352571">payload</span><span class="op" id="4352578">[</span><span class="ident" id="4352579">explicitIVLen</span><span class="op" id="4352592">:</span><span class="op" id="4352593">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4352598">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4352603">c</span><span class="op" id="4352604">.</span><span class="ident" id="4352605">CryptBlocks</span><span class="op" id="4352616">(</span><span class="ident" id="4352617">payload</span><span class="op" id="4352624">,</span>&nbsp;<span class="ident" id="4352626">payload</span><span class="op" id="4352633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4352638">if</span>&nbsp;<span class="ident" id="4352641">hc</span><span class="op" id="4352643">.</span><span class="ident" id="4352644">version</span>&nbsp;<span class="op" id="4352652">==</span>&nbsp;<span class="ident" id="4352655">VersionSSL30</span>&nbsp;<span class="op" id="4352668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4352674">payload</span><span class="op" id="4352681">,</span>&nbsp;<span class="ident" id="4352683">paddingGood</span>&nbsp;<span class="op" id="4352695">=</span>&nbsp;<span class="ident" id="4352697">removePaddingSSL30</span><span class="op" id="4352715">(</span><span class="ident" id="4352716">payload</span><span class="op" id="4352723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4352728">}</span>&nbsp;<span class="keyword" id="4352730">else</span>&nbsp;<span class="op" id="4352735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4352741">payload</span><span class="op" id="4352748">,</span>&nbsp;<span class="ident" id="4352750">paddingGood</span>&nbsp;<span class="op" id="4352762">=</span>&nbsp;<span class="ident" id="4352764">removePadding</span><span class="op" id="4352777">(</span><span class="ident" id="4352778">payload</span><span class="op" id="4352785">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4352790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4352795">b</span><span class="op" id="4352796">.</span><span class="ident" id="4352797">resize</span><span class="op" id="4352803">(</span><span class="ident" id="4352804">recordHeaderLen</span>&nbsp;<span class="op" id="4352820">+</span>&nbsp;<span class="ident" id="4352822">explicitIVLen</span>&nbsp;<span class="op" id="4352836">+</span>&nbsp;<span class="builtinfunc" id="4352838">len</span><span class="op" id="4352841">(</span><span class="ident" id="4352842">payload</span><span class="op" id="4352849">)</span><span class="op" id="4352850">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4352856">//&nbsp;note&nbsp;that&nbsp;we&nbsp;still&nbsp;have&nbsp;a&nbsp;timing&nbsp;side-channel&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4352915">//&nbsp;MAC&nbsp;check,&nbsp;below.&nbsp;An&nbsp;attacker&nbsp;can&nbsp;align&nbsp;the&nbsp;record</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4352972">//&nbsp;so&nbsp;that&nbsp;a&nbsp;correct&nbsp;padding&nbsp;will&nbsp;cause&nbsp;one&nbsp;less&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4353029">//&nbsp;block&nbsp;to&nbsp;be&nbsp;calculated.&nbsp;Then&nbsp;they&nbsp;can&nbsp;iteratively</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4353085">//&nbsp;decrypt&nbsp;a&nbsp;record&nbsp;by&nbsp;breaking&nbsp;each&nbsp;byte.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4353135">//&nbsp;&#34;Password&nbsp;Interception&nbsp;in&nbsp;a&nbsp;SSL/TLS&nbsp;Channel&#34;,&nbsp;Brice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4353193">//&nbsp;Canvel&nbsp;et&nbsp;al.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4353213">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4353219">//&nbsp;However,&nbsp;our&nbsp;behavior&nbsp;matches&nbsp;OpenSSL,&nbsp;so&nbsp;we&nbsp;leak</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4353275">//&nbsp;only&nbsp;as&nbsp;much&nbsp;as&nbsp;they&nbsp;do.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4353305">default</span><span class="op" id="4353312">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4353317">panic</span><span class="op" id="4353322">(</span><span class="string" id="4353323">&#34;unknown&nbsp;cipher&nbsp;type&#34;</span><span class="op" id="4353344">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4353348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4353351">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4353355">//&nbsp;check,&nbsp;strip&nbsp;mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4353376">if</span>&nbsp;<span class="ident" id="4353379">hc</span><span class="op" id="4353381">.</span><span class="ident" id="4353382">mac</span>&nbsp;<span class="op" id="4353386">!=</span>&nbsp;<span class="builtintype" id="4353389">nil</span>&nbsp;<span class="op" id="4353393">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4353397">if</span>&nbsp;<span class="builtinfunc" id="4353400">len</span><span class="op" id="4353403">(</span><span class="ident" id="4353404">payload</span><span class="op" id="4353411">)</span>&nbsp;<span class="op" id="4353413">&lt;</span>&nbsp;<span class="ident" id="4353415">macSize</span>&nbsp;<span class="op" id="4353423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4353428">return</span>&nbsp;<span class="builtintype" id="4353435">false</span><span class="op" id="4353440">,</span>&nbsp;<span class="num" id="4353442">0</span><span class="op" id="4353443">,</span>&nbsp;<span class="ident" id="4353445">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4353465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4353470">//&nbsp;strip&nbsp;mac&nbsp;off&nbsp;payload,&nbsp;b.data</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4353505">n</span>&nbsp;<span class="op" id="4353507">:=</span>&nbsp;<span class="builtinfunc" id="4353510">len</span><span class="op" id="4353513">(</span><span class="ident" id="4353514">payload</span><span class="op" id="4353521">)</span>&nbsp;<span class="op" id="4353523">-</span>&nbsp;<span class="ident" id="4353525">macSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4353535">b</span><span class="op" id="4353536">.</span><span class="ident" id="4353537">data</span><span class="op" id="4353541">[</span><span class="num" id="4353542">3</span><span class="op" id="4353543">]</span>&nbsp;<span class="op" id="4353545">=</span>&nbsp;<span class="builtintype" id="4353547">byte</span><span class="op" id="4353551">(</span><span class="ident" id="4353552">n</span>&nbsp;<span class="op" id="4353554">&gt;&gt;</span>&nbsp;<span class="num" id="4353557">8</span><span class="op" id="4353558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4353562">b</span><span class="op" id="4353563">.</span><span class="ident" id="4353564">data</span><span class="op" id="4353568">[</span><span class="num" id="4353569">4</span><span class="op" id="4353570">]</span>&nbsp;<span class="op" id="4353572">=</span>&nbsp;<span class="builtintype" id="4353574">byte</span><span class="op" id="4353578">(</span><span class="ident" id="4353579">n</span><span class="op" id="4353580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4353584">b</span><span class="op" id="4353585">.</span><span class="ident" id="4353586">resize</span><span class="op" id="4353592">(</span><span class="ident" id="4353593">recordHeaderLen</span>&nbsp;<span class="op" id="4353609">+</span>&nbsp;<span class="ident" id="4353611">explicitIVLen</span>&nbsp;<span class="op" id="4353625">+</span>&nbsp;<span class="ident" id="4353627">n</span><span class="op" id="4353628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4353632">remoteMAC</span>&nbsp;<span class="op" id="4353642">:=</span>&nbsp;<span class="ident" id="4353645">payload</span><span class="op" id="4353652">[</span><span class="ident" id="4353653">n</span><span class="op" id="4353654">:</span><span class="op" id="4353655">]</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4353659">localMAC</span>&nbsp;<span class="op" id="4353668">:=</span>&nbsp;<span class="ident" id="4353671">hc</span><span class="op" id="4353673">.</span><span class="ident" id="4353674">mac</span><span class="op" id="4353677">.</span><span class="ident" id="4353678">MAC</span><span class="op" id="4353681">(</span><span class="ident" id="4353682">hc</span><span class="op" id="4353684">.</span><span class="ident" id="4353685">inDigestBuf</span><span class="op" id="4353696">,</span>&nbsp;<span class="ident" id="4353698">hc</span><span class="op" id="4353700">.</span><span class="ident" id="4353701">seq</span><span class="op" id="4353704">[</span><span class="num" id="4353705">0</span><span class="op" id="4353706">:</span><span class="op" id="4353707">]</span><span class="op" id="4353708">,</span>&nbsp;<span class="ident" id="4353710">b</span><span class="op" id="4353711">.</span><span class="ident" id="4353712">data</span><span class="op" id="4353716">[</span><span class="op" id="4353717">:</span><span class="ident" id="4353718">recordHeaderLen</span><span class="op" id="4353733">]</span><span class="op" id="4353734">,</span>&nbsp;<span class="ident" id="4353736">payload</span><span class="op" id="4353743">[</span><span class="op" id="4353744">:</span><span class="ident" id="4353745">n</span><span class="op" id="4353746">]</span><span class="op" id="4353747">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4353752">if</span>&nbsp;<span class="ident" id="4353755">subtle</span><span class="op" id="4353761">.</span><span class="ident" id="4353762">ConstantTimeCompare</span><span class="op" id="4353781">(</span><span class="ident" id="4353782">localMAC</span><span class="op" id="4353790">,</span>&nbsp;<span class="ident" id="4353792">remoteMAC</span><span class="op" id="4353801">)</span>&nbsp;<span class="op" id="4353803">!=</span>&nbsp;<span class="num" id="4353806">1</span>&nbsp;<span class="op" id="4353808">||</span>&nbsp;<span class="ident" id="4353811">paddingGood</span>&nbsp;<span class="op" id="4353823">!=</span>&nbsp;<span class="num" id="4353826">255</span>&nbsp;<span class="op" id="4353830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4353835">return</span>&nbsp;<span class="builtintype" id="4353842">false</span><span class="op" id="4353847">,</span>&nbsp;<span class="num" id="4353849">0</span><span class="op" id="4353850">,</span>&nbsp;<span class="ident" id="4353852">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4353872">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4353876">hc</span><span class="op" id="4353878">.</span><span class="ident" id="4353879">inDigestBuf</span>&nbsp;<span class="op" id="4353891">=</span>&nbsp;<span class="ident" id="4353893">localMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4353903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4353906">hc</span><span class="op" id="4353908">.</span><span class="ident" id="4353909">incSeq</span><span class="op" id="4353915">(</span><span class="op" id="4353916">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4353920">return</span>&nbsp;<span class="builtintype" id="4353927">true</span><span class="op" id="4353931">,</span>&nbsp;<span class="ident" id="4353933">recordHeaderLen</span>&nbsp;<span class="op" id="4353949">+</span>&nbsp;<span class="ident" id="4353951">explicitIVLen</span><span class="op" id="4353964">,</span>&nbsp;<span class="num" id="4353966">0</span><br>
<span class="lineno">335</span><span class="op" id="4353968">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4353971">//&nbsp;padToBlockSize&nbsp;calculates&nbsp;the&nbsp;needed&nbsp;padding&nbsp;block,&nbsp;if&nbsp;any,&nbsp;for&nbsp;a&nbsp;payload.</span><br>
<span class="lineno"></span><span class="comment" id="4354049">//&nbsp;On&nbsp;exit,&nbsp;prefix&nbsp;aliases&nbsp;payload&nbsp;and&nbsp;extends&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;last&nbsp;full</span><br>
<span class="lineno"></span><span class="comment" id="4354124">//&nbsp;block&nbsp;of&nbsp;payload.&nbsp;finalBlock&nbsp;is&nbsp;a&nbsp;fresh&nbsp;slice&nbsp;which&nbsp;contains&nbsp;the&nbsp;contents&nbsp;of</span><br>
<span class="lineno">340</span><span class="comment" id="4354204">//&nbsp;any&nbsp;suffix&nbsp;of&nbsp;payload&nbsp;as&nbsp;well&nbsp;as&nbsp;the&nbsp;needed&nbsp;padding&nbsp;to&nbsp;make&nbsp;finalBlock&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4354280">//&nbsp;full&nbsp;block.</span><br>
<span class="lineno"></span><span class="keyword" id="4354295">func</span>&nbsp;<span class="ident" id="4354300">padToBlockSize</span><span class="op" id="4354314">(</span><span class="ident" id="4354315">payload</span>&nbsp;<span class="op" id="4354323">[</span><span class="op" id="4354324">]</span><span class="builtintype" id="4354325">byte</span><span class="op" id="4354329">,</span>&nbsp;<span class="ident" id="4354331">blockSize</span>&nbsp;<span class="builtintype" id="4354341">int</span><span class="op" id="4354344">)</span>&nbsp;<span class="op" id="4354346">(</span><span class="ident" id="4354347">prefix</span><span class="op" id="4354353">,</span>&nbsp;<span class="ident" id="4354355">finalBlock</span>&nbsp;<span class="op" id="4354366">[</span><span class="op" id="4354367">]</span><span class="builtintype" id="4354368">byte</span><span class="op" id="4354372">)</span>&nbsp;<span class="op" id="4354374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4354377">overrun</span>&nbsp;<span class="op" id="4354385">:=</span>&nbsp;<span class="builtinfunc" id="4354388">len</span><span class="op" id="4354391">(</span><span class="ident" id="4354392">payload</span><span class="op" id="4354399">)</span>&nbsp;<span class="op" id="4354401">%</span>&nbsp;<span class="ident" id="4354403">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4354414">paddingLen</span>&nbsp;<span class="op" id="4354425">:=</span>&nbsp;<span class="ident" id="4354428">blockSize</span>&nbsp;<span class="op" id="4354438">-</span>&nbsp;<span class="ident" id="4354440">overrun</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4354449">prefix</span>&nbsp;<span class="op" id="4354456">=</span>&nbsp;<span class="ident" id="4354458">payload</span><span class="op" id="4354465">[</span><span class="op" id="4354466">:</span><span class="builtinfunc" id="4354467">len</span><span class="op" id="4354470">(</span><span class="ident" id="4354471">payload</span><span class="op" id="4354478">)</span><span class="op" id="4354479">-</span><span class="ident" id="4354480">overrun</span><span class="op" id="4354487">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4354490">finalBlock</span>&nbsp;<span class="op" id="4354501">=</span>&nbsp;<span class="builtinfunc" id="4354503">make</span><span class="op" id="4354507">(</span><span class="op" id="4354508">[</span><span class="op" id="4354509">]</span><span class="builtintype" id="4354510">byte</span><span class="op" id="4354514">,</span>&nbsp;<span class="ident" id="4354516">blockSize</span><span class="op" id="4354525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4354528">copy</span><span class="op" id="4354532">(</span><span class="ident" id="4354533">finalBlock</span><span class="op" id="4354543">,</span>&nbsp;<span class="ident" id="4354545">payload</span><span class="op" id="4354552">[</span><span class="builtinfunc" id="4354553">len</span><span class="op" id="4354556">(</span><span class="ident" id="4354557">payload</span><span class="op" id="4354564">)</span><span class="op" id="4354565">-</span><span class="ident" id="4354566">overrun</span><span class="op" id="4354573">:</span><span class="op" id="4354574">]</span><span class="op" id="4354575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4354578">for</span>&nbsp;<span class="ident" id="4354582">i</span>&nbsp;<span class="op" id="4354584">:=</span>&nbsp;<span class="ident" id="4354587">overrun</span><span class="op" id="4354594">;</span>&nbsp;<span class="ident" id="4354596">i</span>&nbsp;<span class="op" id="4354598">&lt;</span>&nbsp;<span class="ident" id="4354600">blockSize</span><span class="op" id="4354609">;</span>&nbsp;<span class="ident" id="4354611">i</span><span class="op" id="4354612">++</span>&nbsp;<span class="op" id="4354615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4354619">finalBlock</span><span class="op" id="4354629">[</span><span class="ident" id="4354630">i</span><span class="op" id="4354631">]</span>&nbsp;<span class="op" id="4354633">=</span>&nbsp;<span class="builtintype" id="4354635">byte</span><span class="op" id="4354639">(</span><span class="ident" id="4354640">paddingLen</span>&nbsp;<span class="op" id="4354651">-</span>&nbsp;<span class="num" id="4354653">1</span><span class="op" id="4354654">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4354657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4354660">return</span><br>
<span class="lineno"></span><span class="op" id="4354667">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4354670">//&nbsp;encrypt&nbsp;encrypts&nbsp;and&nbsp;macs&nbsp;the&nbsp;data&nbsp;in&nbsp;b.</span><br>
<span class="lineno">355</span><span class="keyword" id="4354714">func</span>&nbsp;<span class="op" id="4354719">(</span><span class="ident" id="4354720">hc</span>&nbsp;<span class="op" id="4354723">*</span><span class="ident" id="4354724">halfConn</span><span class="op" id="4354732">)</span>&nbsp;<span class="ident" id="4354734">encrypt</span><span class="op" id="4354741">(</span><span class="ident" id="4354742">b</span>&nbsp;<span class="op" id="4354744">*</span><span class="ident" id="4354745">block</span><span class="op" id="4354750">,</span>&nbsp;<span class="ident" id="4354752">explicitIVLen</span>&nbsp;<span class="builtintype" id="4354766">int</span><span class="op" id="4354769">)</span>&nbsp;<span class="op" id="4354771">(</span><span class="builtintype" id="4354772">bool</span><span class="op" id="4354776">,</span>&nbsp;<span class="ident" id="4354778">alert</span><span class="op" id="4354783">)</span>&nbsp;<span class="op" id="4354785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4354788">//&nbsp;mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4354796">if</span>&nbsp;<span class="ident" id="4354799">hc</span><span class="op" id="4354801">.</span><span class="ident" id="4354802">mac</span>&nbsp;<span class="op" id="4354806">!=</span>&nbsp;<span class="builtintype" id="4354809">nil</span>&nbsp;<span class="op" id="4354813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4354817">mac</span>&nbsp;<span class="op" id="4354821">:=</span>&nbsp;<span class="ident" id="4354824">hc</span><span class="op" id="4354826">.</span><span class="ident" id="4354827">mac</span><span class="op" id="4354830">.</span><span class="ident" id="4354831">MAC</span><span class="op" id="4354834">(</span><span class="ident" id="4354835">hc</span><span class="op" id="4354837">.</span><span class="ident" id="4354838">outDigestBuf</span><span class="op" id="4354850">,</span>&nbsp;<span class="ident" id="4354852">hc</span><span class="op" id="4354854">.</span><span class="ident" id="4354855">seq</span><span class="op" id="4354858">[</span><span class="num" id="4354859">0</span><span class="op" id="4354860">:</span><span class="op" id="4354861">]</span><span class="op" id="4354862">,</span>&nbsp;<span class="ident" id="4354864">b</span><span class="op" id="4354865">.</span><span class="ident" id="4354866">data</span><span class="op" id="4354870">[</span><span class="op" id="4354871">:</span><span class="ident" id="4354872">recordHeaderLen</span><span class="op" id="4354887">]</span><span class="op" id="4354888">,</span>&nbsp;<span class="ident" id="4354890">b</span><span class="op" id="4354891">.</span><span class="ident" id="4354892">data</span><span class="op" id="4354896">[</span><span class="ident" id="4354897">recordHeaderLen</span><span class="op" id="4354912">+</span><span class="ident" id="4354913">explicitIVLen</span><span class="op" id="4354926">:</span><span class="op" id="4354927">]</span><span class="op" id="4354928">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4354933">n</span>&nbsp;<span class="op" id="4354935">:=</span>&nbsp;<span class="builtinfunc" id="4354938">len</span><span class="op" id="4354941">(</span><span class="ident" id="4354942">b</span><span class="op" id="4354943">.</span><span class="ident" id="4354944">data</span><span class="op" id="4354948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4354952">b</span><span class="op" id="4354953">.</span><span class="ident" id="4354954">resize</span><span class="op" id="4354960">(</span><span class="ident" id="4354961">n</span>&nbsp;<span class="op" id="4354963">+</span>&nbsp;<span class="builtinfunc" id="4354965">len</span><span class="op" id="4354968">(</span><span class="ident" id="4354969">mac</span><span class="op" id="4354972">)</span><span class="op" id="4354973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4354977">copy</span><span class="op" id="4354981">(</span><span class="ident" id="4354982">b</span><span class="op" id="4354983">.</span><span class="ident" id="4354984">data</span><span class="op" id="4354988">[</span><span class="ident" id="4354989">n</span><span class="op" id="4354990">:</span><span class="op" id="4354991">]</span><span class="op" id="4354992">,</span>&nbsp;<span class="ident" id="4354994">mac</span><span class="op" id="4354997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355001">hc</span><span class="op" id="4355003">.</span><span class="ident" id="4355004">outDigestBuf</span>&nbsp;<span class="op" id="4355017">=</span>&nbsp;<span class="ident" id="4355019">mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4355024">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355028">payload</span>&nbsp;<span class="op" id="4355036">:=</span>&nbsp;<span class="ident" id="4355039">b</span><span class="op" id="4355040">.</span><span class="ident" id="4355041">data</span><span class="op" id="4355045">[</span><span class="ident" id="4355046">recordHeaderLen</span><span class="op" id="4355061">:</span><span class="op" id="4355062">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4355066">//&nbsp;encrypt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4355078">if</span>&nbsp;<span class="ident" id="4355081">hc</span><span class="op" id="4355083">.</span><span class="ident" id="4355084">cipher</span>&nbsp;<span class="op" id="4355091">!=</span>&nbsp;<span class="builtintype" id="4355094">nil</span>&nbsp;<span class="op" id="4355098">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4355102">switch</span>&nbsp;<span class="ident" id="4355109">c</span>&nbsp;<span class="op" id="4355111">:=</span>&nbsp;<span class="ident" id="4355114">hc</span><span class="op" id="4355116">.</span><span class="ident" id="4355117">cipher</span><span class="op" id="4355123">.</span><span class="op" id="4355124">(</span><span class="keyword" id="4355125">type</span><span class="op" id="4355129">)</span>&nbsp;<span class="op" id="4355131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4355135">case</span>&nbsp;<span class="ident" id="4355140">cipher</span><span class="op" id="4355146">.</span><span class="ident" id="4355147">Stream</span><span class="op" id="4355153">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355158">c</span><span class="op" id="4355159">.</span><span class="ident" id="4355160">XORKeyStream</span><span class="op" id="4355172">(</span><span class="ident" id="4355173">payload</span><span class="op" id="4355180">,</span>&nbsp;<span class="ident" id="4355182">payload</span><span class="op" id="4355189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4355193">case</span>&nbsp;<span class="ident" id="4355198">cipher</span><span class="op" id="4355204">.</span><span class="ident" id="4355205">AEAD</span><span class="op" id="4355209">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355214">payloadLen</span>&nbsp;<span class="op" id="4355225">:=</span>&nbsp;<span class="builtinfunc" id="4355228">len</span><span class="op" id="4355231">(</span><span class="ident" id="4355232">b</span><span class="op" id="4355233">.</span><span class="ident" id="4355234">data</span><span class="op" id="4355238">)</span>&nbsp;<span class="op" id="4355240">-</span>&nbsp;<span class="ident" id="4355242">recordHeaderLen</span>&nbsp;<span class="op" id="4355258">-</span>&nbsp;<span class="ident" id="4355260">explicitIVLen</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355277">b</span><span class="op" id="4355278">.</span><span class="ident" id="4355279">resize</span><span class="op" id="4355285">(</span><span class="builtinfunc" id="4355286">len</span><span class="op" id="4355289">(</span><span class="ident" id="4355290">b</span><span class="op" id="4355291">.</span><span class="ident" id="4355292">data</span><span class="op" id="4355296">)</span>&nbsp;<span class="op" id="4355298">+</span>&nbsp;<span class="ident" id="4355300">c</span><span class="op" id="4355301">.</span><span class="ident" id="4355302">Overhead</span><span class="op" id="4355310">(</span><span class="op" id="4355311">)</span><span class="op" id="4355312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355317">nonce</span>&nbsp;<span class="op" id="4355323">:=</span>&nbsp;<span class="ident" id="4355326">b</span><span class="op" id="4355327">.</span><span class="ident" id="4355328">data</span><span class="op" id="4355332">[</span><span class="ident" id="4355333">recordHeaderLen</span>&nbsp;<span class="op" id="4355349">:</span>&nbsp;<span class="ident" id="4355351">recordHeaderLen</span><span class="op" id="4355366">+</span><span class="ident" id="4355367">explicitIVLen</span><span class="op" id="4355380">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355385">payload</span>&nbsp;<span class="op" id="4355393">:=</span>&nbsp;<span class="ident" id="4355396">b</span><span class="op" id="4355397">.</span><span class="ident" id="4355398">data</span><span class="op" id="4355402">[</span><span class="ident" id="4355403">recordHeaderLen</span><span class="op" id="4355418">+</span><span class="ident" id="4355419">explicitIVLen</span><span class="op" id="4355432">:</span><span class="op" id="4355433">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355438">payload</span>&nbsp;<span class="op" id="4355446">=</span>&nbsp;<span class="ident" id="4355448">payload</span><span class="op" id="4355455">[</span><span class="op" id="4355456">:</span><span class="ident" id="4355457">payloadLen</span><span class="op" id="4355467">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4355473">var</span>&nbsp;<span class="ident" id="4355477">additionalData</span>&nbsp;<span class="op" id="4355492">[</span><span class="num" id="4355493">13</span><span class="op" id="4355495">]</span><span class="builtintype" id="4355496">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4355504">copy</span><span class="op" id="4355508">(</span><span class="ident" id="4355509">additionalData</span><span class="op" id="4355523">[</span><span class="op" id="4355524">:</span><span class="op" id="4355525">]</span><span class="op" id="4355526">,</span>&nbsp;<span class="ident" id="4355528">hc</span><span class="op" id="4355530">.</span><span class="ident" id="4355531">seq</span><span class="op" id="4355534">[</span><span class="op" id="4355535">:</span><span class="op" id="4355536">]</span><span class="op" id="4355537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4355542">copy</span><span class="op" id="4355546">(</span><span class="ident" id="4355547">additionalData</span><span class="op" id="4355561">[</span><span class="num" id="4355562">8</span><span class="op" id="4355563">:</span><span class="op" id="4355564">]</span><span class="op" id="4355565">,</span>&nbsp;<span class="ident" id="4355567">b</span><span class="op" id="4355568">.</span><span class="ident" id="4355569">data</span><span class="op" id="4355573">[</span><span class="op" id="4355574">:</span><span class="num" id="4355575">3</span><span class="op" id="4355576">]</span><span class="op" id="4355577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355582">additionalData</span><span class="op" id="4355596">[</span><span class="num" id="4355597">11</span><span class="op" id="4355599">]</span>&nbsp;<span class="op" id="4355601">=</span>&nbsp;<span class="builtintype" id="4355603">byte</span><span class="op" id="4355607">(</span><span class="ident" id="4355608">payloadLen</span>&nbsp;<span class="op" id="4355619">&gt;&gt;</span>&nbsp;<span class="num" id="4355622">8</span><span class="op" id="4355623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355628">additionalData</span><span class="op" id="4355642">[</span><span class="num" id="4355643">12</span><span class="op" id="4355645">]</span>&nbsp;<span class="op" id="4355647">=</span>&nbsp;<span class="builtintype" id="4355649">byte</span><span class="op" id="4355653">(</span><span class="ident" id="4355654">payloadLen</span><span class="op" id="4355664">)</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355670">c</span><span class="op" id="4355671">.</span><span class="ident" id="4355672">Seal</span><span class="op" id="4355676">(</span><span class="ident" id="4355677">payload</span><span class="op" id="4355684">[</span><span class="op" id="4355685">:</span><span class="num" id="4355686">0</span><span class="op" id="4355687">]</span><span class="op" id="4355688">,</span>&nbsp;<span class="ident" id="4355690">nonce</span><span class="op" id="4355695">,</span>&nbsp;<span class="ident" id="4355697">payload</span><span class="op" id="4355704">,</span>&nbsp;<span class="ident" id="4355706">additionalData</span><span class="op" id="4355720">[</span><span class="op" id="4355721">:</span><span class="op" id="4355722">]</span><span class="op" id="4355723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4355727">case</span>&nbsp;<span class="ident" id="4355732">cbcMode</span><span class="op" id="4355739">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355744">blockSize</span>&nbsp;<span class="op" id="4355754">:=</span>&nbsp;<span class="ident" id="4355757">c</span><span class="op" id="4355758">.</span><span class="ident" id="4355759">BlockSize</span><span class="op" id="4355768">(</span><span class="op" id="4355769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4355774">if</span>&nbsp;<span class="ident" id="4355777">explicitIVLen</span>&nbsp;<span class="op" id="4355791">&gt;</span>&nbsp;<span class="num" id="4355793">0</span>&nbsp;<span class="op" id="4355795">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355801">c</span><span class="op" id="4355802">.</span><span class="ident" id="4355803">SetIV</span><span class="op" id="4355808">(</span><span class="ident" id="4355809">payload</span><span class="op" id="4355816">[</span><span class="op" id="4355817">:</span><span class="ident" id="4355818">explicitIVLen</span><span class="op" id="4355831">]</span><span class="op" id="4355832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355838">payload</span>&nbsp;<span class="op" id="4355846">=</span>&nbsp;<span class="ident" id="4355848">payload</span><span class="op" id="4355855">[</span><span class="ident" id="4355856">explicitIVLen</span><span class="op" id="4355869">:</span><span class="op" id="4355870">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4355875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355880">prefix</span><span class="op" id="4355886">,</span>&nbsp;<span class="ident" id="4355888">finalBlock</span>&nbsp;<span class="op" id="4355899">:=</span>&nbsp;<span class="ident" id="4355902">padToBlockSize</span><span class="op" id="4355916">(</span><span class="ident" id="4355917">payload</span><span class="op" id="4355924">,</span>&nbsp;<span class="ident" id="4355926">blockSize</span><span class="op" id="4355935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355940">b</span><span class="op" id="4355941">.</span><span class="ident" id="4355942">resize</span><span class="op" id="4355948">(</span><span class="ident" id="4355949">recordHeaderLen</span>&nbsp;<span class="op" id="4355965">+</span>&nbsp;<span class="ident" id="4355967">explicitIVLen</span>&nbsp;<span class="op" id="4355981">+</span>&nbsp;<span class="builtinfunc" id="4355983">len</span><span class="op" id="4355986">(</span><span class="ident" id="4355987">prefix</span><span class="op" id="4355993">)</span>&nbsp;<span class="op" id="4355995">+</span>&nbsp;<span class="builtinfunc" id="4355997">len</span><span class="op" id="4356000">(</span><span class="ident" id="4356001">finalBlock</span><span class="op" id="4356011">)</span><span class="op" id="4356012">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4356017">c</span><span class="op" id="4356018">.</span><span class="ident" id="4356019">CryptBlocks</span><span class="op" id="4356030">(</span><span class="ident" id="4356031">b</span><span class="op" id="4356032">.</span><span class="ident" id="4356033">data</span><span class="op" id="4356037">[</span><span class="ident" id="4356038">recordHeaderLen</span><span class="op" id="4356053">+</span><span class="ident" id="4356054">explicitIVLen</span><span class="op" id="4356067">:</span><span class="op" id="4356068">]</span><span class="op" id="4356069">,</span>&nbsp;<span class="ident" id="4356071">prefix</span><span class="op" id="4356077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4356082">c</span><span class="op" id="4356083">.</span><span class="ident" id="4356084">CryptBlocks</span><span class="op" id="4356095">(</span><span class="ident" id="4356096">b</span><span class="op" id="4356097">.</span><span class="ident" id="4356098">data</span><span class="op" id="4356102">[</span><span class="ident" id="4356103">recordHeaderLen</span><span class="op" id="4356118">+</span><span class="ident" id="4356119">explicitIVLen</span><span class="op" id="4356132">+</span><span class="builtinfunc" id="4356133">len</span><span class="op" id="4356136">(</span><span class="ident" id="4356137">prefix</span><span class="op" id="4356143">)</span><span class="op" id="4356144">:</span><span class="op" id="4356145">]</span><span class="op" id="4356146">,</span>&nbsp;<span class="ident" id="4356148">finalBlock</span><span class="op" id="4356158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4356162">default</span><span class="op" id="4356169">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4356174">panic</span><span class="op" id="4356179">(</span><span class="string" id="4356180">&#34;unknown&nbsp;cipher&nbsp;type&#34;</span><span class="op" id="4356201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4356205">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4356208">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4356212">//&nbsp;update&nbsp;length&nbsp;to&nbsp;include&nbsp;MAC&nbsp;and&nbsp;any&nbsp;block&nbsp;padding&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4356275">n</span>&nbsp;<span class="op" id="4356277">:=</span>&nbsp;<span class="builtinfunc" id="4356280">len</span><span class="op" id="4356283">(</span><span class="ident" id="4356284">b</span><span class="op" id="4356285">.</span><span class="ident" id="4356286">data</span><span class="op" id="4356290">)</span>&nbsp;<span class="op" id="4356292">-</span>&nbsp;<span class="ident" id="4356294">recordHeaderLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4356311">b</span><span class="op" id="4356312">.</span><span class="ident" id="4356313">data</span><span class="op" id="4356317">[</span><span class="num" id="4356318">3</span><span class="op" id="4356319">]</span>&nbsp;<span class="op" id="4356321">=</span>&nbsp;<span class="builtintype" id="4356323">byte</span><span class="op" id="4356327">(</span><span class="ident" id="4356328">n</span>&nbsp;<span class="op" id="4356330">&gt;&gt;</span>&nbsp;<span class="num" id="4356333">8</span><span class="op" id="4356334">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4356337">b</span><span class="op" id="4356338">.</span><span class="ident" id="4356339">data</span><span class="op" id="4356343">[</span><span class="num" id="4356344">4</span><span class="op" id="4356345">]</span>&nbsp;<span class="op" id="4356347">=</span>&nbsp;<span class="builtintype" id="4356349">byte</span><span class="op" id="4356353">(</span><span class="ident" id="4356354">n</span><span class="op" id="4356355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4356358">hc</span><span class="op" id="4356360">.</span><span class="ident" id="4356361">incSeq</span><span class="op" id="4356367">(</span><span class="op" id="4356368">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4356372">return</span>&nbsp;<span class="builtintype" id="4356379">true</span><span class="op" id="4356383">,</span>&nbsp;<span class="num" id="4356385">0</span><br>
<span class="lineno"></span><span class="op" id="4356387">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span><span class="comment" id="4356390">//&nbsp;A&nbsp;block&nbsp;is&nbsp;a&nbsp;simple&nbsp;data&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="4356426">type</span>&nbsp;<span class="ident" id="4356431">block</span>&nbsp;<span class="keyword" id="4356437">struct</span>&nbsp;<span class="op" id="4356444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4356447">data</span>&nbsp;<span class="op" id="4356452">[</span><span class="op" id="4356453">]</span><span class="builtintype" id="4356454">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4356460">off</span>&nbsp;&nbsp;<span class="builtintype" id="4356465">int</span>&nbsp;<span class="comment" id="4356469">//&nbsp;index&nbsp;for&nbsp;Read</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4356488">link</span>&nbsp;<span class="op" id="4356493">*</span><span class="ident" id="4356494">block</span><br>
<span class="lineno"></span><span class="op" id="4356500">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4356503">//&nbsp;resize&nbsp;resizes&nbsp;block&nbsp;to&nbsp;be&nbsp;n&nbsp;bytes,&nbsp;growing&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="4356564">func</span>&nbsp;<span class="op" id="4356569">(</span><span class="ident" id="4356570">b</span>&nbsp;<span class="op" id="4356572">*</span><span class="ident" id="4356573">block</span><span class="op" id="4356578">)</span>&nbsp;<span class="ident" id="4356580">resize</span><span class="op" id="4356586">(</span><span class="ident" id="4356587">n</span>&nbsp;<span class="builtintype" id="4356589">int</span><span class="op" id="4356592">)</span>&nbsp;<span class="op" id="4356594">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4356597">if</span>&nbsp;<span class="ident" id="4356600">n</span>&nbsp;<span class="op" id="4356602">&gt;</span>&nbsp;<span class="builtinfunc" id="4356604">cap</span><span class="op" id="4356607">(</span><span class="ident" id="4356608">b</span><span class="op" id="4356609">.</span><span class="ident" id="4356610">data</span><span class="op" id="4356614">)</span>&nbsp;<span class="op" id="4356616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4356620">b</span><span class="op" id="4356621">.</span><span class="ident" id="4356622">reserve</span><span class="op" id="4356629">(</span><span class="ident" id="4356630">n</span><span class="op" id="4356631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4356634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4356637">b</span><span class="op" id="4356638">.</span><span class="ident" id="4356639">data</span>&nbsp;<span class="op" id="4356644">=</span>&nbsp;<span class="ident" id="4356646">b</span><span class="op" id="4356647">.</span><span class="ident" id="4356648">data</span><span class="op" id="4356652">[</span><span class="num" id="4356653">0</span><span class="op" id="4356654">:</span><span class="ident" id="4356655">n</span><span class="op" id="4356656">]</span><br>
<span class="lineno"></span><span class="op" id="4356658">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="comment" id="4356661">//&nbsp;reserve&nbsp;makes&nbsp;sure&nbsp;that&nbsp;block&nbsp;contains&nbsp;a&nbsp;capacity&nbsp;of&nbsp;at&nbsp;least&nbsp;n&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="4356735">func</span>&nbsp;<span class="op" id="4356740">(</span><span class="ident" id="4356741">b</span>&nbsp;<span class="op" id="4356743">*</span><span class="ident" id="4356744">block</span><span class="op" id="4356749">)</span>&nbsp;<span class="ident" id="4356751">reserve</span><span class="op" id="4356758">(</span><span class="ident" id="4356759">n</span>&nbsp;<span class="builtintype" id="4356761">int</span><span class="op" id="4356764">)</span>&nbsp;<span class="op" id="4356766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4356769">if</span>&nbsp;<span class="builtinfunc" id="4356772">cap</span><span class="op" id="4356775">(</span><span class="ident" id="4356776">b</span><span class="op" id="4356777">.</span><span class="ident" id="4356778">data</span><span class="op" id="4356782">)</span>&nbsp;<span class="op" id="4356784">&gt;=</span>&nbsp;<span class="ident" id="4356787">n</span>&nbsp;<span class="op" id="4356789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4356793">return</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4356801">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4356804">m</span>&nbsp;<span class="op" id="4356806">:=</span>&nbsp;<span class="builtinfunc" id="4356809">cap</span><span class="op" id="4356812">(</span><span class="ident" id="4356813">b</span><span class="op" id="4356814">.</span><span class="ident" id="4356815">data</span><span class="op" id="4356819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4356822">if</span>&nbsp;<span class="ident" id="4356825">m</span>&nbsp;<span class="op" id="4356827">==</span>&nbsp;<span class="num" id="4356830">0</span>&nbsp;<span class="op" id="4356832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4356836">m</span>&nbsp;<span class="op" id="4356838">=</span>&nbsp;<span class="num" id="4356840">1024</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4356846">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4356849">for</span>&nbsp;<span class="ident" id="4356853">m</span>&nbsp;<span class="op" id="4356855">&lt;</span>&nbsp;<span class="ident" id="4356857">n</span>&nbsp;<span class="op" id="4356859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4356863">m</span>&nbsp;<span class="op" id="4356865">*=</span>&nbsp;<span class="num" id="4356868">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4356871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4356874">data</span>&nbsp;<span class="op" id="4356879">:=</span>&nbsp;<span class="builtinfunc" id="4356882">make</span><span class="op" id="4356886">(</span><span class="op" id="4356887">[</span><span class="op" id="4356888">]</span><span class="builtintype" id="4356889">byte</span><span class="op" id="4356893">,</span>&nbsp;<span class="builtinfunc" id="4356895">len</span><span class="op" id="4356898">(</span><span class="ident" id="4356899">b</span><span class="op" id="4356900">.</span><span class="ident" id="4356901">data</span><span class="op" id="4356905">)</span><span class="op" id="4356906">,</span>&nbsp;<span class="ident" id="4356908">m</span><span class="op" id="4356909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4356912">copy</span><span class="op" id="4356916">(</span><span class="ident" id="4356917">data</span><span class="op" id="4356921">,</span>&nbsp;<span class="ident" id="4356923">b</span><span class="op" id="4356924">.</span><span class="ident" id="4356925">data</span><span class="op" id="4356929">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4356932">b</span><span class="op" id="4356933">.</span><span class="ident" id="4356934">data</span>&nbsp;<span class="op" id="4356939">=</span>&nbsp;<span class="ident" id="4356941">data</span><br>
<span class="lineno"></span><span class="op" id="4356946">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4356949">//&nbsp;readFromUntil&nbsp;reads&nbsp;from&nbsp;r&nbsp;into&nbsp;b&nbsp;until&nbsp;b&nbsp;contains&nbsp;at&nbsp;least&nbsp;n&nbsp;bytes</span><br>
<span class="lineno"></span><span class="comment" id="4357020">//&nbsp;or&nbsp;else&nbsp;returns&nbsp;an&nbsp;error.</span><br>
<span class="lineno">445</span><span class="keyword" id="4357049">func</span>&nbsp;<span class="op" id="4357054">(</span><span class="ident" id="4357055">b</span>&nbsp;<span class="op" id="4357057">*</span><span class="ident" id="4357058">block</span><span class="op" id="4357063">)</span>&nbsp;<span class="ident" id="4357065">readFromUntil</span><span class="op" id="4357078">(</span><span class="ident" id="4357079">r</span>&nbsp;<span class="ident" id="4357081">io</span><span class="op" id="4357083">.</span><span class="ident" id="4357084">Reader</span><span class="op" id="4357090">,</span>&nbsp;<span class="ident" id="4357092">n</span>&nbsp;<span class="builtintype" id="4357094">int</span><span class="op" id="4357097">)</span>&nbsp;<span class="builtintype" id="4357099">error</span>&nbsp;<span class="op" id="4357105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4357108">//&nbsp;quick&nbsp;case</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4357123">if</span>&nbsp;<span class="builtinfunc" id="4357126">len</span><span class="op" id="4357129">(</span><span class="ident" id="4357130">b</span><span class="op" id="4357131">.</span><span class="ident" id="4357132">data</span><span class="op" id="4357136">)</span>&nbsp;<span class="op" id="4357138">&gt;=</span>&nbsp;<span class="ident" id="4357141">n</span>&nbsp;<span class="op" id="4357143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4357147">return</span>&nbsp;<span class="builtintype" id="4357154">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4357159">}</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4357163">//&nbsp;read&nbsp;until&nbsp;have&nbsp;enough.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4357191">b</span><span class="op" id="4357192">.</span><span class="ident" id="4357193">reserve</span><span class="op" id="4357200">(</span><span class="ident" id="4357201">n</span><span class="op" id="4357202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4357205">for</span>&nbsp;<span class="op" id="4357209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4357213">m</span><span class="op" id="4357214">,</span>&nbsp;<span class="ident" id="4357216">err</span>&nbsp;<span class="op" id="4357220">:=</span>&nbsp;<span class="ident" id="4357223">r</span><span class="op" id="4357224">.</span><span class="ident" id="4357225">Read</span><span class="op" id="4357229">(</span><span class="ident" id="4357230">b</span><span class="op" id="4357231">.</span><span class="ident" id="4357232">data</span><span class="op" id="4357236">[</span><span class="builtinfunc" id="4357237">len</span><span class="op" id="4357240">(</span><span class="ident" id="4357241">b</span><span class="op" id="4357242">.</span><span class="ident" id="4357243">data</span><span class="op" id="4357247">)</span><span class="op" id="4357248">:</span><span class="builtinfunc" id="4357249">cap</span><span class="op" id="4357252">(</span><span class="ident" id="4357253">b</span><span class="op" id="4357254">.</span><span class="ident" id="4357255">data</span><span class="op" id="4357259">)</span><span class="op" id="4357260">]</span><span class="op" id="4357261">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4357265">b</span><span class="op" id="4357266">.</span><span class="ident" id="4357267">data</span>&nbsp;<span class="op" id="4357272">=</span>&nbsp;<span class="ident" id="4357274">b</span><span class="op" id="4357275">.</span><span class="ident" id="4357276">data</span><span class="op" id="4357280">[</span><span class="num" id="4357281">0</span>&nbsp;<span class="op" id="4357283">:</span>&nbsp;<span class="builtinfunc" id="4357285">len</span><span class="op" id="4357288">(</span><span class="ident" id="4357289">b</span><span class="op" id="4357290">.</span><span class="ident" id="4357291">data</span><span class="op" id="4357295">)</span><span class="op" id="4357296">+</span><span class="ident" id="4357297">m</span><span class="op" id="4357298">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4357302">if</span>&nbsp;<span class="builtinfunc" id="4357305">len</span><span class="op" id="4357308">(</span><span class="ident" id="4357309">b</span><span class="op" id="4357310">.</span><span class="ident" id="4357311">data</span><span class="op" id="4357315">)</span>&nbsp;<span class="op" id="4357317">&gt;=</span>&nbsp;<span class="ident" id="4357320">n</span>&nbsp;<span class="op" id="4357322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4357327">//&nbsp;TODO(bradfitz,agl):&nbsp;slightly&nbsp;suspicious</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4357373">//&nbsp;that&nbsp;we&#39;re&nbsp;throwing&nbsp;away&nbsp;r.Read&#39;s&nbsp;err&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4357423">break</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4357431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4357435">if</span>&nbsp;<span class="ident" id="4357438">err</span>&nbsp;<span class="op" id="4357442">!=</span>&nbsp;<span class="builtintype" id="4357445">nil</span>&nbsp;<span class="op" id="4357449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4357454">return</span>&nbsp;<span class="ident" id="4357461">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4357467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4357470">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4357473">return</span>&nbsp;<span class="builtintype" id="4357480">nil</span><br>
<span class="lineno"></span><span class="op" id="4357484">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4357487">func</span>&nbsp;<span class="op" id="4357492">(</span><span class="ident" id="4357493">b</span>&nbsp;<span class="op" id="4357495">*</span><span class="ident" id="4357496">block</span><span class="op" id="4357501">)</span>&nbsp;<span class="ident" id="4357503">Read</span><span class="op" id="4357507">(</span><span class="ident" id="4357508">p</span>&nbsp;<span class="op" id="4357510">[</span><span class="op" id="4357511">]</span><span class="builtintype" id="4357512">byte</span><span class="op" id="4357516">)</span>&nbsp;<span class="op" id="4357518">(</span><span class="ident" id="4357519">n</span>&nbsp;<span class="builtintype" id="4357521">int</span><span class="op" id="4357524">,</span>&nbsp;<span class="ident" id="4357526">err</span>&nbsp;<span class="builtintype" id="4357530">error</span><span class="op" id="4357535">)</span>&nbsp;<span class="op" id="4357537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4357540">n</span>&nbsp;<span class="op" id="4357542">=</span>&nbsp;<span class="builtinfunc" id="4357544">copy</span><span class="op" id="4357548">(</span><span class="ident" id="4357549">p</span><span class="op" id="4357550">,</span>&nbsp;<span class="ident" id="4357552">b</span><span class="op" id="4357553">.</span><span class="ident" id="4357554">data</span><span class="op" id="4357558">[</span><span class="ident" id="4357559">b</span><span class="op" id="4357560">.</span><span class="ident" id="4357561">off</span><span class="op" id="4357564">:</span><span class="op" id="4357565">]</span><span class="op" id="4357566">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4357569">b</span><span class="op" id="4357570">.</span><span class="ident" id="4357571">off</span>&nbsp;<span class="op" id="4357575">+=</span>&nbsp;<span class="ident" id="4357578">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4357581">return</span><br>
<span class="lineno"></span><span class="op" id="4357588">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4357591">//&nbsp;newBlock&nbsp;allocates&nbsp;a&nbsp;new&nbsp;block,&nbsp;from&nbsp;hc&#39;s&nbsp;free&nbsp;list&nbsp;if&nbsp;possible.</span><br>
<span class="lineno">475</span><span class="keyword" id="4357659">func</span>&nbsp;<span class="op" id="4357664">(</span><span class="ident" id="4357665">hc</span>&nbsp;<span class="op" id="4357668">*</span><span class="ident" id="4357669">halfConn</span><span class="op" id="4357677">)</span>&nbsp;<span class="ident" id="4357679">newBlock</span><span class="op" id="4357687">(</span><span class="op" id="4357688">)</span>&nbsp;<span class="op" id="4357690">*</span><span class="ident" id="4357691">block</span>&nbsp;<span class="op" id="4357697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4357700">b</span>&nbsp;<span class="op" id="4357702">:=</span>&nbsp;<span class="ident" id="4357705">hc</span><span class="op" id="4357707">.</span><span class="ident" id="4357708">bfree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4357715">if</span>&nbsp;<span class="ident" id="4357718">b</span>&nbsp;<span class="op" id="4357720">==</span>&nbsp;<span class="builtintype" id="4357723">nil</span>&nbsp;<span class="op" id="4357727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4357731">return</span>&nbsp;<span class="builtinfunc" id="4357738">new</span><span class="op" id="4357741">(</span><span class="ident" id="4357742">block</span><span class="op" id="4357747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4357750">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4357753">hc</span><span class="op" id="4357755">.</span><span class="ident" id="4357756">bfree</span>&nbsp;<span class="op" id="4357762">=</span>&nbsp;<span class="ident" id="4357764">b</span><span class="op" id="4357765">.</span><span class="ident" id="4357766">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4357772">b</span><span class="op" id="4357773">.</span><span class="ident" id="4357774">link</span>&nbsp;<span class="op" id="4357779">=</span>&nbsp;<span class="builtintype" id="4357781">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4357786">b</span><span class="op" id="4357787">.</span><span class="ident" id="4357788">resize</span><span class="op" id="4357794">(</span><span class="num" id="4357795">0</span><span class="op" id="4357796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4357799">return</span>&nbsp;<span class="ident" id="4357806">b</span><br>
<span class="lineno"></span><span class="op" id="4357808">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="comment" id="4357811">//&nbsp;freeBlock&nbsp;returns&nbsp;a&nbsp;block&nbsp;to&nbsp;hc&#39;s&nbsp;free&nbsp;list.</span><br>
<span class="lineno"></span><span class="comment" id="4357859">//&nbsp;The&nbsp;protocol&nbsp;is&nbsp;such&nbsp;that&nbsp;each&nbsp;side&nbsp;only&nbsp;has&nbsp;a&nbsp;block&nbsp;or&nbsp;two&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="4357925">//&nbsp;its&nbsp;free&nbsp;list&nbsp;at&nbsp;a&nbsp;time,&nbsp;so&nbsp;there&#39;s&nbsp;no&nbsp;need&nbsp;to&nbsp;worry&nbsp;about</span><br>
<span class="lineno"></span><span class="comment" id="4357987">//&nbsp;trimming&nbsp;the&nbsp;list,&nbsp;etc.</span><br>
<span class="lineno">490</span><span class="keyword" id="4358014">func</span>&nbsp;<span class="op" id="4358019">(</span><span class="ident" id="4358020">hc</span>&nbsp;<span class="op" id="4358023">*</span><span class="ident" id="4358024">halfConn</span><span class="op" id="4358032">)</span>&nbsp;<span class="ident" id="4358034">freeBlock</span><span class="op" id="4358043">(</span><span class="ident" id="4358044">b</span>&nbsp;<span class="op" id="4358046">*</span><span class="ident" id="4358047">block</span><span class="op" id="4358052">)</span>&nbsp;<span class="op" id="4358054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4358057">b</span><span class="op" id="4358058">.</span><span class="ident" id="4358059">link</span>&nbsp;<span class="op" id="4358064">=</span>&nbsp;<span class="ident" id="4358066">hc</span><span class="op" id="4358068">.</span><span class="ident" id="4358069">bfree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4358076">hc</span><span class="op" id="4358078">.</span><span class="ident" id="4358079">bfree</span>&nbsp;<span class="op" id="4358085">=</span>&nbsp;<span class="ident" id="4358087">b</span><br>
<span class="lineno"></span><span class="op" id="4358089">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="4358092">//&nbsp;splitBlock&nbsp;splits&nbsp;a&nbsp;block&nbsp;after&nbsp;the&nbsp;first&nbsp;n&nbsp;bytes,</span><br>
<span class="lineno"></span><span class="comment" id="4358146">//&nbsp;returning&nbsp;a&nbsp;block&nbsp;with&nbsp;those&nbsp;n&nbsp;bytes&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4358192">//&nbsp;block&nbsp;with&nbsp;the&nbsp;remainder.&nbsp;&nbsp;the&nbsp;latter&nbsp;may&nbsp;be&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword" id="4358245">func</span>&nbsp;<span class="op" id="4358250">(</span><span class="ident" id="4358251">hc</span>&nbsp;<span class="op" id="4358254">*</span><span class="ident" id="4358255">halfConn</span><span class="op" id="4358263">)</span>&nbsp;<span class="ident" id="4358265">splitBlock</span><span class="op" id="4358275">(</span><span class="ident" id="4358276">b</span>&nbsp;<span class="op" id="4358278">*</span><span class="ident" id="4358279">block</span><span class="op" id="4358284">,</span>&nbsp;<span class="ident" id="4358286">n</span>&nbsp;<span class="builtintype" id="4358288">int</span><span class="op" id="4358291">)</span>&nbsp;<span class="op" id="4358293">(</span><span class="op" id="4358294">*</span><span class="ident" id="4358295">block</span><span class="op" id="4358300">,</span>&nbsp;<span class="op" id="4358302">*</span><span class="ident" id="4358303">block</span><span class="op" id="4358308">)</span>&nbsp;<span class="op" id="4358310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4358313">if</span>&nbsp;<span class="builtinfunc" id="4358316">len</span><span class="op" id="4358319">(</span><span class="ident" id="4358320">b</span><span class="op" id="4358321">.</span><span class="ident" id="4358322">data</span><span class="op" id="4358326">)</span>&nbsp;<span class="op" id="4358328">&lt;=</span>&nbsp;<span class="ident" id="4358331">n</span>&nbsp;<span class="op" id="4358333">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4358337">return</span>&nbsp;<span class="ident" id="4358344">b</span><span class="op" id="4358345">,</span>&nbsp;<span class="builtintype" id="4358347">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4358352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4358355">bb</span>&nbsp;<span class="op" id="4358358">:=</span>&nbsp;<span class="ident" id="4358361">hc</span><span class="op" id="4358363">.</span><span class="ident" id="4358364">newBlock</span><span class="op" id="4358372">(</span><span class="op" id="4358373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4358376">bb</span><span class="op" id="4358378">.</span><span class="ident" id="4358379">resize</span><span class="op" id="4358385">(</span><span class="builtinfunc" id="4358386">len</span><span class="op" id="4358389">(</span><span class="ident" id="4358390">b</span><span class="op" id="4358391">.</span><span class="ident" id="4358392">data</span><span class="op" id="4358396">)</span>&nbsp;<span class="op" id="4358398">-</span>&nbsp;<span class="ident" id="4358400">n</span><span class="op" id="4358401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4358404">copy</span><span class="op" id="4358408">(</span><span class="ident" id="4358409">bb</span><span class="op" id="4358411">.</span><span class="ident" id="4358412">data</span><span class="op" id="4358416">,</span>&nbsp;<span class="ident" id="4358418">b</span><span class="op" id="4358419">.</span><span class="ident" id="4358420">data</span><span class="op" id="4358424">[</span><span class="ident" id="4358425">n</span><span class="op" id="4358426">:</span><span class="op" id="4358427">]</span><span class="op" id="4358428">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4358431">b</span><span class="op" id="4358432">.</span><span class="ident" id="4358433">data</span>&nbsp;<span class="op" id="4358438">=</span>&nbsp;<span class="ident" id="4358440">b</span><span class="op" id="4358441">.</span><span class="ident" id="4358442">data</span><span class="op" id="4358446">[</span><span class="num" id="4358447">0</span><span class="op" id="4358448">:</span><span class="ident" id="4358449">n</span><span class="op" id="4358450">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4358453">return</span>&nbsp;<span class="ident" id="4358460">b</span><span class="op" id="4358461">,</span>&nbsp;<span class="ident" id="4358463">bb</span><br>
<span class="lineno"></span><span class="op" id="4358466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4358469">//&nbsp;readRecord&nbsp;reads&nbsp;the&nbsp;next&nbsp;TLS&nbsp;record&nbsp;from&nbsp;the&nbsp;connection</span><br>
<span class="lineno">510</span><span class="comment" id="4358529">//&nbsp;and&nbsp;updates&nbsp;the&nbsp;record&nbsp;layer&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="4358568">//&nbsp;c.in.Mutex&nbsp;&lt;=&nbsp;L;&nbsp;c.input&nbsp;==&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword" id="4358604">func</span>&nbsp;<span class="op" id="4358609">(</span><span class="ident" id="4358610">c</span>&nbsp;<span class="op" id="4358612">*</span><span class="ident" id="4358613">Conn</span><span class="op" id="4358617">)</span>&nbsp;<span class="ident" id="4358619">readRecord</span><span class="op" id="4358629">(</span><span class="ident" id="4358630">want</span>&nbsp;<span class="ident" id="4358635">recordType</span><span class="op" id="4358645">)</span>&nbsp;<span class="builtintype" id="4358647">error</span>&nbsp;<span class="op" id="4358653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4358656">//&nbsp;Caller&nbsp;must&nbsp;be&nbsp;in&nbsp;sync&nbsp;with&nbsp;connection:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4358700">//&nbsp;handshake&nbsp;data&nbsp;if&nbsp;handshake&nbsp;not&nbsp;yet&nbsp;completed,</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4358751">//&nbsp;else&nbsp;application&nbsp;data.&nbsp;&nbsp;(We&nbsp;don&#39;t&nbsp;support&nbsp;renegotiation.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4358813">switch</span>&nbsp;<span class="ident" id="4358820">want</span>&nbsp;<span class="op" id="4358825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4358828">default</span><span class="op" id="4358835">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4358839">c</span><span class="op" id="4358840">.</span><span class="ident" id="4358841">sendAlert</span><span class="op" id="4358850">(</span><span class="ident" id="4358851">alertInternalError</span><span class="op" id="4358869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4358873">return</span>&nbsp;<span class="ident" id="4358880">c</span><span class="op" id="4358881">.</span><span class="ident" id="4358882">in</span><span class="op" id="4358884">.</span><span class="ident" id="4358885">setErrorLocked</span><span class="op" id="4358899">(</span><span class="ident" id="4358900">errors</span><span class="op" id="4358906">.</span><span class="ident" id="4358907">New</span><span class="op" id="4358910">(</span><span class="string" id="4358911">&#34;tls:&nbsp;unknown&nbsp;record&nbsp;type&nbsp;requested&#34;</span><span class="op" id="4358947">)</span><span class="op" id="4358948">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4358951">case</span>&nbsp;<span class="ident" id="4358956">recordTypeHandshake</span><span class="op" id="4358975">,</span>&nbsp;<span class="ident" id="4358977">recordTypeChangeCipherSpec</span><span class="op" id="4359003">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4359007">if</span>&nbsp;<span class="ident" id="4359010">c</span><span class="op" id="4359011">.</span><span class="ident" id="4359012">handshakeComplete</span>&nbsp;<span class="op" id="4359030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4359035">c</span><span class="op" id="4359036">.</span><span class="ident" id="4359037">sendAlert</span><span class="op" id="4359046">(</span><span class="ident" id="4359047">alertInternalError</span><span class="op" id="4359065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4359070">return</span>&nbsp;<span class="ident" id="4359077">c</span><span class="op" id="4359078">.</span><span class="ident" id="4359079">in</span><span class="op" id="4359081">.</span><span class="ident" id="4359082">setErrorLocked</span><span class="op" id="4359096">(</span><span class="ident" id="4359097">errors</span><span class="op" id="4359103">.</span><span class="ident" id="4359104">New</span><span class="op" id="4359107">(</span><span class="string" id="4359108">&#34;tls:&nbsp;handshake&nbsp;or&nbsp;ChangeCipherSpec&nbsp;requested&nbsp;after&nbsp;handshake&nbsp;complete&#34;</span><span class="op" id="4359179">)</span><span class="op" id="4359180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4359184">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4359187">case</span>&nbsp;<span class="ident" id="4359192">recordTypeApplicationData</span><span class="op" id="4359217">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4359221">if</span>&nbsp;<span class="op" id="4359224">!</span><span class="ident" id="4359225">c</span><span class="op" id="4359226">.</span><span class="ident" id="4359227">handshakeComplete</span>&nbsp;<span class="op" id="4359245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4359250">c</span><span class="op" id="4359251">.</span><span class="ident" id="4359252">sendAlert</span><span class="op" id="4359261">(</span><span class="ident" id="4359262">alertInternalError</span><span class="op" id="4359280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4359285">return</span>&nbsp;<span class="ident" id="4359292">c</span><span class="op" id="4359293">.</span><span class="ident" id="4359294">in</span><span class="op" id="4359296">.</span><span class="ident" id="4359297">setErrorLocked</span><span class="op" id="4359311">(</span><span class="ident" id="4359312">errors</span><span class="op" id="4359318">.</span><span class="ident" id="4359319">New</span><span class="op" id="4359322">(</span><span class="string" id="4359323">&#34;tls:&nbsp;application&nbsp;data&nbsp;record&nbsp;requested&nbsp;before&nbsp;handshake&nbsp;complete&#34;</span><span class="op" id="4359389">)</span><span class="op" id="4359390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4359394">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4359397">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="4359400">Again</span><span class="op" id="4359405">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4359408">if</span>&nbsp;<span class="ident" id="4359411">c</span><span class="op" id="4359412">.</span><span class="ident" id="4359413">rawInput</span>&nbsp;<span class="op" id="4359422">==</span>&nbsp;<span class="builtintype" id="4359425">nil</span>&nbsp;<span class="op" id="4359429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4359433">c</span><span class="op" id="4359434">.</span><span class="ident" id="4359435">rawInput</span>&nbsp;<span class="op" id="4359444">=</span>&nbsp;<span class="ident" id="4359446">c</span><span class="op" id="4359447">.</span><span class="ident" id="4359448">in</span><span class="op" id="4359450">.</span><span class="ident" id="4359451">newBlock</span><span class="op" id="4359459">(</span><span class="op" id="4359460">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4359463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4359466">b</span>&nbsp;<span class="op" id="4359468">:=</span>&nbsp;<span class="ident" id="4359471">c</span><span class="op" id="4359472">.</span><span class="ident" id="4359473">rawInput</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4359484">//&nbsp;Read&nbsp;header,&nbsp;payload.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4359510">if</span>&nbsp;<span class="ident" id="4359513">err</span>&nbsp;<span class="op" id="4359517">:=</span>&nbsp;<span class="ident" id="4359520">b</span><span class="op" id="4359521">.</span><span class="ident" id="4359522">readFromUntil</span><span class="op" id="4359535">(</span><span class="ident" id="4359536">c</span><span class="op" id="4359537">.</span><span class="ident" id="4359538">conn</span><span class="op" id="4359542">,</span>&nbsp;<span class="ident" id="4359544">recordHeaderLen</span><span class="op" id="4359559">)</span><span class="op" id="4359560">;</span>&nbsp;<span class="ident" id="4359562">err</span>&nbsp;<span class="op" id="4359566">!=</span>&nbsp;<span class="builtintype" id="4359569">nil</span>&nbsp;<span class="op" id="4359573">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4359577">//&nbsp;RFC&nbsp;suggests&nbsp;that&nbsp;EOF&nbsp;without&nbsp;an&nbsp;alertCloseNotify&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4359635">//&nbsp;an&nbsp;error,&nbsp;but&nbsp;popular&nbsp;web&nbsp;sites&nbsp;seem&nbsp;to&nbsp;do&nbsp;this,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4359689">//&nbsp;so&nbsp;we&nbsp;can&#39;t&nbsp;make&nbsp;it&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4359724">//&nbsp;if&nbsp;err&nbsp;==&nbsp;io.EOF&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4359748">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;io.ErrUnexpectedEOF</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4359780">//&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4359787">if</span>&nbsp;<span class="ident" id="4359790">e</span><span class="op" id="4359791">,</span>&nbsp;<span class="ident" id="4359793">ok</span>&nbsp;<span class="op" id="4359796">:=</span>&nbsp;<span class="ident" id="4359799">err</span><span class="op" id="4359802">.</span><span class="op" id="4359803">(</span><span class="ident" id="4359804">net</span><span class="op" id="4359807">.</span><span class="ident" id="4359808">Error</span><span class="op" id="4359813">)</span><span class="op" id="4359814">;</span>&nbsp;<span class="op" id="4359816">!</span><span class="ident" id="4359817">ok</span>&nbsp;<span class="op" id="4359820">||</span>&nbsp;<span class="op" id="4359823">!</span><span class="ident" id="4359824">e</span><span class="op" id="4359825">.</span><span class="ident" id="4359826">Temporary</span><span class="op" id="4359835">(</span><span class="op" id="4359836">)</span>&nbsp;<span class="op" id="4359838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4359843">c</span><span class="op" id="4359844">.</span><span class="ident" id="4359845">in</span><span class="op" id="4359847">.</span><span class="ident" id="4359848">setErrorLocked</span><span class="op" id="4359862">(</span><span class="ident" id="4359863">err</span><span class="op" id="4359866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4359870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4359874">return</span>&nbsp;<span class="ident" id="4359881">err</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4359886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4359889">typ</span>&nbsp;<span class="op" id="4359893">:=</span>&nbsp;<span class="ident" id="4359896">recordType</span><span class="op" id="4359906">(</span><span class="ident" id="4359907">b</span><span class="op" id="4359908">.</span><span class="ident" id="4359909">data</span><span class="op" id="4359913">[</span><span class="num" id="4359914">0</span><span class="op" id="4359915">]</span><span class="op" id="4359916">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4359920">//&nbsp;No&nbsp;valid&nbsp;TLS&nbsp;record&nbsp;has&nbsp;a&nbsp;type&nbsp;of&nbsp;0x80,&nbsp;however&nbsp;SSLv2&nbsp;handshakes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4359989">//&nbsp;start&nbsp;with&nbsp;a&nbsp;uint16&nbsp;length&nbsp;where&nbsp;the&nbsp;MSB&nbsp;is&nbsp;set&nbsp;and&nbsp;the&nbsp;first&nbsp;record</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4360062">//&nbsp;is&nbsp;always&nbsp;&lt;&nbsp;256&nbsp;bytes&nbsp;long.&nbsp;Therefore&nbsp;typ&nbsp;==&nbsp;0x80&nbsp;strongly&nbsp;suggests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4360134">//&nbsp;an&nbsp;SSLv2&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4360155">if</span>&nbsp;<span class="ident" id="4360158">want</span>&nbsp;<span class="op" id="4360163">==</span>&nbsp;<span class="ident" id="4360166">recordTypeHandshake</span>&nbsp;<span class="op" id="4360186">&amp;&amp;</span>&nbsp;<span class="ident" id="4360189">typ</span>&nbsp;<span class="op" id="4360193">==</span>&nbsp;<span class="num" id="4360196">0x80</span>&nbsp;<span class="op" id="4360201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4360205">c</span><span class="op" id="4360206">.</span><span class="ident" id="4360207">sendAlert</span><span class="op" id="4360216">(</span><span class="ident" id="4360217">alertProtocolVersion</span><span class="op" id="4360237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4360241">return</span>&nbsp;<span class="ident" id="4360248">c</span><span class="op" id="4360249">.</span><span class="ident" id="4360250">in</span><span class="op" id="4360252">.</span><span class="ident" id="4360253">setErrorLocked</span><span class="op" id="4360267">(</span><span class="ident" id="4360268">errors</span><span class="op" id="4360274">.</span><span class="ident" id="4360275">New</span><span class="op" id="4360278">(</span><span class="string" id="4360279">&#34;tls:&nbsp;unsupported&nbsp;SSLv2&nbsp;handshake&nbsp;received&#34;</span><span class="op" id="4360322">)</span><span class="op" id="4360323">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4360326">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4360330">vers</span>&nbsp;<span class="op" id="4360335">:=</span>&nbsp;<span class="builtintype" id="4360338">uint16</span><span class="op" id="4360344">(</span><span class="ident" id="4360345">b</span><span class="op" id="4360346">.</span><span class="ident" id="4360347">data</span><span class="op" id="4360351">[</span><span class="num" id="4360352">1</span><span class="op" id="4360353">]</span><span class="op" id="4360354">)</span><span class="op" id="4360355">&lt;&lt;</span><span class="num" id="4360357">8</span>&nbsp;<span class="op" id="4360359">|</span>&nbsp;<span class="builtintype" id="4360361">uint16</span><span class="op" id="4360367">(</span><span class="ident" id="4360368">b</span><span class="op" id="4360369">.</span><span class="ident" id="4360370">data</span><span class="op" id="4360374">[</span><span class="num" id="4360375">2</span><span class="op" id="4360376">]</span><span class="op" id="4360377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4360380">n</span>&nbsp;<span class="op" id="4360382">:=</span>&nbsp;<span class="builtintype" id="4360385">int</span><span class="op" id="4360388">(</span><span class="ident" id="4360389">b</span><span class="op" id="4360390">.</span><span class="ident" id="4360391">data</span><span class="op" id="4360395">[</span><span class="num" id="4360396">3</span><span class="op" id="4360397">]</span><span class="op" id="4360398">)</span><span class="op" id="4360399">&lt;&lt;</span><span class="num" id="4360401">8</span>&nbsp;<span class="op" id="4360403">|</span>&nbsp;<span class="builtintype" id="4360405">int</span><span class="op" id="4360408">(</span><span class="ident" id="4360409">b</span><span class="op" id="4360410">.</span><span class="ident" id="4360411">data</span><span class="op" id="4360415">[</span><span class="num" id="4360416">4</span><span class="op" id="4360417">]</span><span class="op" id="4360418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4360421">if</span>&nbsp;<span class="ident" id="4360424">c</span><span class="op" id="4360425">.</span><span class="ident" id="4360426">haveVers</span>&nbsp;<span class="op" id="4360435">&amp;&amp;</span>&nbsp;<span class="ident" id="4360438">vers</span>&nbsp;<span class="op" id="4360443">!=</span>&nbsp;<span class="ident" id="4360446">c</span><span class="op" id="4360447">.</span><span class="ident" id="4360448">vers</span>&nbsp;<span class="op" id="4360453">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4360457">c</span><span class="op" id="4360458">.</span><span class="ident" id="4360459">sendAlert</span><span class="op" id="4360468">(</span><span class="ident" id="4360469">alertProtocolVersion</span><span class="op" id="4360489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4360493">return</span>&nbsp;<span class="ident" id="4360500">c</span><span class="op" id="4360501">.</span><span class="ident" id="4360502">in</span><span class="op" id="4360504">.</span><span class="ident" id="4360505">setErrorLocked</span><span class="op" id="4360519">(</span><span class="ident" id="4360520">fmt</span><span class="op" id="4360523">.</span><span class="ident" id="4360524">Errorf</span><span class="op" id="4360530">(</span><span class="string" id="4360531">&#34;tls:&nbsp;received&nbsp;record&nbsp;with&nbsp;version&nbsp;%x&nbsp;when&nbsp;expecting&nbsp;version&nbsp;%x&#34;</span><span class="op" id="4360595">,</span>&nbsp;<span class="ident" id="4360597">vers</span><span class="op" id="4360601">,</span>&nbsp;<span class="ident" id="4360603">c</span><span class="op" id="4360604">.</span><span class="ident" id="4360605">vers</span><span class="op" id="4360609">)</span><span class="op" id="4360610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4360613">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4360616">if</span>&nbsp;<span class="ident" id="4360619">n</span>&nbsp;<span class="op" id="4360621">&gt;</span>&nbsp;<span class="ident" id="4360623">maxCiphertext</span>&nbsp;<span class="op" id="4360637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4360641">c</span><span class="op" id="4360642">.</span><span class="ident" id="4360643">sendAlert</span><span class="op" id="4360652">(</span><span class="ident" id="4360653">alertRecordOverflow</span><span class="op" id="4360672">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4360676">return</span>&nbsp;<span class="ident" id="4360683">c</span><span class="op" id="4360684">.</span><span class="ident" id="4360685">in</span><span class="op" id="4360687">.</span><span class="ident" id="4360688">setErrorLocked</span><span class="op" id="4360702">(</span><span class="ident" id="4360703">fmt</span><span class="op" id="4360706">.</span><span class="ident" id="4360707">Errorf</span><span class="op" id="4360713">(</span><span class="string" id="4360714">&#34;tls:&nbsp;oversized&nbsp;record&nbsp;received&nbsp;with&nbsp;length&nbsp;%d&#34;</span><span class="op" id="4360761">,</span>&nbsp;<span class="ident" id="4360763">n</span><span class="op" id="4360764">)</span><span class="op" id="4360765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4360768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4360771">if</span>&nbsp;<span class="op" id="4360774">!</span><span class="ident" id="4360775">c</span><span class="op" id="4360776">.</span><span class="ident" id="4360777">haveVers</span>&nbsp;<span class="op" id="4360786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4360790">//&nbsp;First&nbsp;message,&nbsp;be&nbsp;extra&nbsp;suspicious:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4360831">//&nbsp;this&nbsp;might&nbsp;not&nbsp;be&nbsp;a&nbsp;TLS&nbsp;client.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4360868">//&nbsp;Bail&nbsp;out&nbsp;before&nbsp;reading&nbsp;a&nbsp;full&nbsp;&#39;body&#39;,&nbsp;if&nbsp;possible.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4360925">//&nbsp;The&nbsp;current&nbsp;max&nbsp;version&nbsp;is&nbsp;3.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4360962">//&nbsp;If&nbsp;the&nbsp;version&nbsp;is&nbsp;&gt;=&nbsp;16.0,&nbsp;it&#39;s&nbsp;probably&nbsp;not&nbsp;real.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4361018">//&nbsp;Similarly,&nbsp;a&nbsp;clientHello&nbsp;message&nbsp;encodes&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4361067">//&nbsp;well&nbsp;under&nbsp;a&nbsp;kilobyte.&nbsp;&nbsp;If&nbsp;the&nbsp;length&nbsp;is&nbsp;&gt;=&nbsp;12&nbsp;kB,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4361123">//&nbsp;it&#39;s&nbsp;probably&nbsp;not&nbsp;real.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4361152">if</span>&nbsp;<span class="op" id="4361155">(</span><span class="ident" id="4361156">typ</span>&nbsp;<span class="op" id="4361160">!=</span>&nbsp;<span class="ident" id="4361163">recordTypeAlert</span>&nbsp;<span class="op" id="4361179">&amp;&amp;</span>&nbsp;<span class="ident" id="4361182">typ</span>&nbsp;<span class="op" id="4361186">!=</span>&nbsp;<span class="ident" id="4361189">want</span><span class="op" id="4361193">)</span>&nbsp;<span class="op" id="4361195">||</span>&nbsp;<span class="ident" id="4361198">vers</span>&nbsp;<span class="op" id="4361203">&gt;=</span>&nbsp;<span class="num" id="4361206">0x1000</span>&nbsp;<span class="op" id="4361213">||</span>&nbsp;<span class="ident" id="4361216">n</span>&nbsp;<span class="op" id="4361218">&gt;=</span>&nbsp;<span class="num" id="4361221">0x3000</span>&nbsp;<span class="op" id="4361228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4361233">c</span><span class="op" id="4361234">.</span><span class="ident" id="4361235">sendAlert</span><span class="op" id="4361244">(</span><span class="ident" id="4361245">alertUnexpectedMessage</span><span class="op" id="4361267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4361272">return</span>&nbsp;<span class="ident" id="4361279">c</span><span class="op" id="4361280">.</span><span class="ident" id="4361281">in</span><span class="op" id="4361283">.</span><span class="ident" id="4361284">setErrorLocked</span><span class="op" id="4361298">(</span><span class="ident" id="4361299">fmt</span><span class="op" id="4361302">.</span><span class="ident" id="4361303">Errorf</span><span class="op" id="4361309">(</span><span class="string" id="4361310">&#34;tls:&nbsp;first&nbsp;record&nbsp;does&nbsp;not&nbsp;look&nbsp;like&nbsp;a&nbsp;TLS&nbsp;handshake&#34;</span><span class="op" id="4361364">)</span><span class="op" id="4361365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4361369">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4361372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4361375">if</span>&nbsp;<span class="ident" id="4361378">err</span>&nbsp;<span class="op" id="4361382">:=</span>&nbsp;<span class="ident" id="4361385">b</span><span class="op" id="4361386">.</span><span class="ident" id="4361387">readFromUntil</span><span class="op" id="4361400">(</span><span class="ident" id="4361401">c</span><span class="op" id="4361402">.</span><span class="ident" id="4361403">conn</span><span class="op" id="4361407">,</span>&nbsp;<span class="ident" id="4361409">recordHeaderLen</span><span class="op" id="4361424">+</span><span class="ident" id="4361425">n</span><span class="op" id="4361426">)</span><span class="op" id="4361427">;</span>&nbsp;<span class="ident" id="4361429">err</span>&nbsp;<span class="op" id="4361433">!=</span>&nbsp;<span class="builtintype" id="4361436">nil</span>&nbsp;<span class="op" id="4361440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4361444">if</span>&nbsp;<span class="ident" id="4361447">err</span>&nbsp;<span class="op" id="4361451">==</span>&nbsp;<span class="ident" id="4361454">io</span><span class="op" id="4361456">.</span><span class="ident" id="4361457">EOF</span>&nbsp;<span class="op" id="4361461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4361466">err</span>&nbsp;<span class="op" id="4361470">=</span>&nbsp;<span class="ident" id="4361472">io</span><span class="op" id="4361474">.</span><span class="ident" id="4361475">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4361494">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4361498">if</span>&nbsp;<span class="ident" id="4361501">e</span><span class="op" id="4361502">,</span>&nbsp;<span class="ident" id="4361504">ok</span>&nbsp;<span class="op" id="4361507">:=</span>&nbsp;<span class="ident" id="4361510">err</span><span class="op" id="4361513">.</span><span class="op" id="4361514">(</span><span class="ident" id="4361515">net</span><span class="op" id="4361518">.</span><span class="ident" id="4361519">Error</span><span class="op" id="4361524">)</span><span class="op" id="4361525">;</span>&nbsp;<span class="op" id="4361527">!</span><span class="ident" id="4361528">ok</span>&nbsp;<span class="op" id="4361531">||</span>&nbsp;<span class="op" id="4361534">!</span><span class="ident" id="4361535">e</span><span class="op" id="4361536">.</span><span class="ident" id="4361537">Temporary</span><span class="op" id="4361546">(</span><span class="op" id="4361547">)</span>&nbsp;<span class="op" id="4361549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4361554">c</span><span class="op" id="4361555">.</span><span class="ident" id="4361556">in</span><span class="op" id="4361558">.</span><span class="ident" id="4361559">setErrorLocked</span><span class="op" id="4361573">(</span><span class="ident" id="4361574">err</span><span class="op" id="4361577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4361581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4361585">return</span>&nbsp;<span class="ident" id="4361592">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4361597">}</span><br>
<span class="lineno">595</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4361601">//&nbsp;Process&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4361622">b</span><span class="op" id="4361623">,</span>&nbsp;<span class="ident" id="4361625">c</span><span class="op" id="4361626">.</span><span class="ident" id="4361627">rawInput</span>&nbsp;<span class="op" id="4361636">=</span>&nbsp;<span class="ident" id="4361638">c</span><span class="op" id="4361639">.</span><span class="ident" id="4361640">in</span><span class="op" id="4361642">.</span><span class="ident" id="4361643">splitBlock</span><span class="op" id="4361653">(</span><span class="ident" id="4361654">b</span><span class="op" id="4361655">,</span>&nbsp;<span class="ident" id="4361657">recordHeaderLen</span><span class="op" id="4361672">+</span><span class="ident" id="4361673">n</span><span class="op" id="4361674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4361677">ok</span><span class="op" id="4361679">,</span>&nbsp;<span class="ident" id="4361681">off</span><span class="op" id="4361684">,</span>&nbsp;<span class="ident" id="4361686">err</span>&nbsp;<span class="op" id="4361690">:=</span>&nbsp;<span class="ident" id="4361693">c</span><span class="op" id="4361694">.</span><span class="ident" id="4361695">in</span><span class="op" id="4361697">.</span><span class="ident" id="4361698">decrypt</span><span class="op" id="4361705">(</span><span class="ident" id="4361706">b</span><span class="op" id="4361707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4361710">if</span>&nbsp;<span class="op" id="4361713">!</span><span class="ident" id="4361714">ok</span>&nbsp;<span class="op" id="4361717">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4361721">c</span><span class="op" id="4361722">.</span><span class="ident" id="4361723">in</span><span class="op" id="4361725">.</span><span class="ident" id="4361726">setErrorLocked</span><span class="op" id="4361740">(</span><span class="ident" id="4361741">c</span><span class="op" id="4361742">.</span><span class="ident" id="4361743">sendAlert</span><span class="op" id="4361752">(</span><span class="ident" id="4361753">err</span><span class="op" id="4361756">)</span><span class="op" id="4361757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4361760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4361763">b</span><span class="op" id="4361764">.</span><span class="ident" id="4361765">off</span>&nbsp;<span class="op" id="4361769">=</span>&nbsp;<span class="ident" id="4361771">off</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4361776">data</span>&nbsp;<span class="op" id="4361781">:=</span>&nbsp;<span class="ident" id="4361784">b</span><span class="op" id="4361785">.</span><span class="ident" id="4361786">data</span><span class="op" id="4361790">[</span><span class="ident" id="4361791">b</span><span class="op" id="4361792">.</span><span class="ident" id="4361793">off</span><span class="op" id="4361796">:</span><span class="op" id="4361797">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4361800">if</span>&nbsp;<span class="builtinfunc" id="4361803">len</span><span class="op" id="4361806">(</span><span class="ident" id="4361807">data</span><span class="op" id="4361811">)</span>&nbsp;<span class="op" id="4361813">&gt;</span>&nbsp;<span class="ident" id="4361815">maxPlaintext</span>&nbsp;<span class="op" id="4361828">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4361832">err</span>&nbsp;<span class="op" id="4361836">:=</span>&nbsp;<span class="ident" id="4361839">c</span><span class="op" id="4361840">.</span><span class="ident" id="4361841">sendAlert</span><span class="op" id="4361850">(</span><span class="ident" id="4361851">alertRecordOverflow</span><span class="op" id="4361870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4361874">c</span><span class="op" id="4361875">.</span><span class="ident" id="4361876">in</span><span class="op" id="4361878">.</span><span class="ident" id="4361879">freeBlock</span><span class="op" id="4361888">(</span><span class="ident" id="4361889">b</span><span class="op" id="4361890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4361894">return</span>&nbsp;<span class="ident" id="4361901">c</span><span class="op" id="4361902">.</span><span class="ident" id="4361903">in</span><span class="op" id="4361905">.</span><span class="ident" id="4361906">setErrorLocked</span><span class="op" id="4361920">(</span><span class="ident" id="4361921">err</span><span class="op" id="4361924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4361927">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4361931">switch</span>&nbsp;<span class="ident" id="4361938">typ</span>&nbsp;<span class="op" id="4361942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4361945">default</span><span class="op" id="4361952">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4361956">c</span><span class="op" id="4361957">.</span><span class="ident" id="4361958">in</span><span class="op" id="4361960">.</span><span class="ident" id="4361961">setErrorLocked</span><span class="op" id="4361975">(</span><span class="ident" id="4361976">c</span><span class="op" id="4361977">.</span><span class="ident" id="4361978">sendAlert</span><span class="op" id="4361987">(</span><span class="ident" id="4361988">alertUnexpectedMessage</span><span class="op" id="4362010">)</span><span class="op" id="4362011">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4362015">case</span>&nbsp;<span class="ident" id="4362020">recordTypeAlert</span><span class="op" id="4362035">:</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4362039">if</span>&nbsp;<span class="builtinfunc" id="4362042">len</span><span class="op" id="4362045">(</span><span class="ident" id="4362046">data</span><span class="op" id="4362050">)</span>&nbsp;<span class="op" id="4362052">!=</span>&nbsp;<span class="num" id="4362055">2</span>&nbsp;<span class="op" id="4362057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4362062">c</span><span class="op" id="4362063">.</span><span class="ident" id="4362064">in</span><span class="op" id="4362066">.</span><span class="ident" id="4362067">setErrorLocked</span><span class="op" id="4362081">(</span><span class="ident" id="4362082">c</span><span class="op" id="4362083">.</span><span class="ident" id="4362084">sendAlert</span><span class="op" id="4362093">(</span><span class="ident" id="4362094">alertUnexpectedMessage</span><span class="op" id="4362116">)</span><span class="op" id="4362117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4362122">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4362130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4362134">if</span>&nbsp;<span class="ident" id="4362137">alert</span><span class="op" id="4362142">(</span><span class="ident" id="4362143">data</span><span class="op" id="4362147">[</span><span class="num" id="4362148">1</span><span class="op" id="4362149">]</span><span class="op" id="4362150">)</span>&nbsp;<span class="op" id="4362152">==</span>&nbsp;<span class="ident" id="4362155">alertCloseNotify</span>&nbsp;<span class="op" id="4362172">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4362177">c</span><span class="op" id="4362178">.</span><span class="ident" id="4362179">in</span><span class="op" id="4362181">.</span><span class="ident" id="4362182">setErrorLocked</span><span class="op" id="4362196">(</span><span class="ident" id="4362197">io</span><span class="op" id="4362199">.</span><span class="ident" id="4362200">EOF</span><span class="op" id="4362203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4362208">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4362216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4362220">switch</span>&nbsp;<span class="ident" id="4362227">data</span><span class="op" id="4362231">[</span><span class="num" id="4362232">0</span><span class="op" id="4362233">]</span>&nbsp;<span class="op" id="4362235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4362239">case</span>&nbsp;<span class="ident" id="4362244">alertLevelWarning</span><span class="op" id="4362261">:</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4362266">//&nbsp;drop&nbsp;on&nbsp;the&nbsp;floor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4362290">c</span><span class="op" id="4362291">.</span><span class="ident" id="4362292">in</span><span class="op" id="4362294">.</span><span class="ident" id="4362295">freeBlock</span><span class="op" id="4362304">(</span><span class="ident" id="4362305">b</span><span class="op" id="4362306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4362311">goto</span>&nbsp;<span class="ident" id="4362316">Again</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4362324">case</span>&nbsp;<span class="ident" id="4362329">alertLevelError</span><span class="op" id="4362344">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4362349">c</span><span class="op" id="4362350">.</span><span class="ident" id="4362351">in</span><span class="op" id="4362353">.</span><span class="ident" id="4362354">setErrorLocked</span><span class="op" id="4362368">(</span><span class="op" id="4362369">&amp;</span><span class="ident" id="4362370">net</span><span class="op" id="4362373">.</span><span class="ident" id="4362374">OpError</span><span class="op" id="4362381">{</span><span class="ident" id="4362382">Op</span><span class="op" id="4362384">:</span>&nbsp;<span class="string" id="4362386">&#34;remote&nbsp;error&#34;</span><span class="op" id="4362400">,</span>&nbsp;<span class="ident" id="4362402">Err</span><span class="op" id="4362405">:</span>&nbsp;<span class="ident" id="4362407">alert</span><span class="op" id="4362412">(</span><span class="ident" id="4362413">data</span><span class="op" id="4362417">[</span><span class="num" id="4362418">1</span><span class="op" id="4362419">]</span><span class="op" id="4362420">)</span><span class="op" id="4362421">}</span><span class="op" id="4362422">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4362426">default</span><span class="op" id="4362433">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4362438">c</span><span class="op" id="4362439">.</span><span class="ident" id="4362440">in</span><span class="op" id="4362442">.</span><span class="ident" id="4362443">setErrorLocked</span><span class="op" id="4362457">(</span><span class="ident" id="4362458">c</span><span class="op" id="4362459">.</span><span class="ident" id="4362460">sendAlert</span><span class="op" id="4362469">(</span><span class="ident" id="4362470">alertUnexpectedMessage</span><span class="op" id="4362492">)</span><span class="op" id="4362493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4362497">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4362501">case</span>&nbsp;<span class="ident" id="4362506">recordTypeChangeCipherSpec</span><span class="op" id="4362532">:</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4362536">if</span>&nbsp;<span class="ident" id="4362539">typ</span>&nbsp;<span class="op" id="4362543">!=</span>&nbsp;<span class="ident" id="4362546">want</span>&nbsp;<span class="op" id="4362551">||</span>&nbsp;<span class="builtinfunc" id="4362554">len</span><span class="op" id="4362557">(</span><span class="ident" id="4362558">data</span><span class="op" id="4362562">)</span>&nbsp;<span class="op" id="4362564">!=</span>&nbsp;<span class="num" id="4362567">1</span>&nbsp;<span class="op" id="4362569">||</span>&nbsp;<span class="ident" id="4362572">data</span><span class="op" id="4362576">[</span><span class="num" id="4362577">0</span><span class="op" id="4362578">]</span>&nbsp;<span class="op" id="4362580">!=</span>&nbsp;<span class="num" id="4362583">1</span>&nbsp;<span class="op" id="4362585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4362590">c</span><span class="op" id="4362591">.</span><span class="ident" id="4362592">in</span><span class="op" id="4362594">.</span><span class="ident" id="4362595">setErrorLocked</span><span class="op" id="4362609">(</span><span class="ident" id="4362610">c</span><span class="op" id="4362611">.</span><span class="ident" id="4362612">sendAlert</span><span class="op" id="4362621">(</span><span class="ident" id="4362622">alertUnexpectedMessage</span><span class="op" id="4362644">)</span><span class="op" id="4362645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4362650">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4362658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4362662">err</span>&nbsp;<span class="op" id="4362666">:=</span>&nbsp;<span class="ident" id="4362669">c</span><span class="op" id="4362670">.</span><span class="ident" id="4362671">in</span><span class="op" id="4362673">.</span><span class="ident" id="4362674">changeCipherSpec</span><span class="op" id="4362690">(</span><span class="op" id="4362691">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4362695">if</span>&nbsp;<span class="ident" id="4362698">err</span>&nbsp;<span class="op" id="4362702">!=</span>&nbsp;<span class="builtintype" id="4362705">nil</span>&nbsp;<span class="op" id="4362709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4362714">c</span><span class="op" id="4362715">.</span><span class="ident" id="4362716">in</span><span class="op" id="4362718">.</span><span class="ident" id="4362719">setErrorLocked</span><span class="op" id="4362733">(</span><span class="ident" id="4362734">c</span><span class="op" id="4362735">.</span><span class="ident" id="4362736">sendAlert</span><span class="op" id="4362745">(</span><span class="ident" id="4362746">err</span><span class="op" id="4362749">.</span><span class="op" id="4362750">(</span><span class="ident" id="4362751">alert</span><span class="op" id="4362756">)</span><span class="op" id="4362757">)</span><span class="op" id="4362758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4362762">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4362766">case</span>&nbsp;<span class="ident" id="4362771">recordTypeApplicationData</span><span class="op" id="4362796">:</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4362800">if</span>&nbsp;<span class="ident" id="4362803">typ</span>&nbsp;<span class="op" id="4362807">!=</span>&nbsp;<span class="ident" id="4362810">want</span>&nbsp;<span class="op" id="4362815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4362820">c</span><span class="op" id="4362821">.</span><span class="ident" id="4362822">in</span><span class="op" id="4362824">.</span><span class="ident" id="4362825">setErrorLocked</span><span class="op" id="4362839">(</span><span class="ident" id="4362840">c</span><span class="op" id="4362841">.</span><span class="ident" id="4362842">sendAlert</span><span class="op" id="4362851">(</span><span class="ident" id="4362852">alertUnexpectedMessage</span><span class="op" id="4362874">)</span><span class="op" id="4362875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4362880">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4362888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4362892">c</span><span class="op" id="4362893">.</span><span class="ident" id="4362894">input</span>&nbsp;<span class="op" id="4362900">=</span>&nbsp;<span class="ident" id="4362902">b</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4362906">b</span>&nbsp;<span class="op" id="4362908">=</span>&nbsp;<span class="builtintype" id="4362910">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4362916">case</span>&nbsp;<span class="ident" id="4362921">recordTypeHandshake</span><span class="op" id="4362940">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4362944">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;at&nbsp;least&nbsp;pick&nbsp;off&nbsp;connection&nbsp;close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4363003">if</span>&nbsp;<span class="ident" id="4363006">typ</span>&nbsp;<span class="op" id="4363010">!=</span>&nbsp;<span class="ident" id="4363013">want</span>&nbsp;<span class="op" id="4363018">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4363023">return</span>&nbsp;<span class="ident" id="4363030">c</span><span class="op" id="4363031">.</span><span class="ident" id="4363032">in</span><span class="op" id="4363034">.</span><span class="ident" id="4363035">setErrorLocked</span><span class="op" id="4363049">(</span><span class="ident" id="4363050">c</span><span class="op" id="4363051">.</span><span class="ident" id="4363052">sendAlert</span><span class="op" id="4363061">(</span><span class="ident" id="4363062">alertNoRenegotiation</span><span class="op" id="4363082">)</span><span class="op" id="4363083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4363087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4363091">c</span><span class="op" id="4363092">.</span><span class="ident" id="4363093">hand</span><span class="op" id="4363097">.</span><span class="ident" id="4363098">Write</span><span class="op" id="4363103">(</span><span class="ident" id="4363104">data</span><span class="op" id="4363108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4363111">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4363115">if</span>&nbsp;<span class="ident" id="4363118">b</span>&nbsp;<span class="op" id="4363120">!=</span>&nbsp;<span class="builtintype" id="4363123">nil</span>&nbsp;<span class="op" id="4363127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4363131">c</span><span class="op" id="4363132">.</span><span class="ident" id="4363133">in</span><span class="op" id="4363135">.</span><span class="ident" id="4363136">freeBlock</span><span class="op" id="4363145">(</span><span class="ident" id="4363146">b</span><span class="op" id="4363147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4363150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4363153">return</span>&nbsp;<span class="ident" id="4363160">c</span><span class="op" id="4363161">.</span><span class="ident" id="4363162">in</span><span class="op" id="4363164">.</span><span class="ident" id="4363165">err</span><br>
<span class="lineno"></span><span class="op" id="4363169">}</span><br>
<span class="lineno">665</span><br>
<span class="lineno"></span><span class="comment" id="4363172">//&nbsp;sendAlert&nbsp;sends&nbsp;a&nbsp;TLS&nbsp;alert&nbsp;message.</span><br>
<span class="lineno"></span><span class="comment" id="4363212">//&nbsp;c.out.Mutex&nbsp;&lt;=&nbsp;L.</span><br>
<span class="lineno"></span><span class="keyword" id="4363233">func</span>&nbsp;<span class="op" id="4363238">(</span><span class="ident" id="4363239">c</span>&nbsp;<span class="op" id="4363241">*</span><span class="ident" id="4363242">Conn</span><span class="op" id="4363246">)</span>&nbsp;<span class="ident" id="4363248">sendAlertLocked</span><span class="op" id="4363263">(</span><span class="ident" id="4363264">err</span>&nbsp;<span class="ident" id="4363268">alert</span><span class="op" id="4363273">)</span>&nbsp;<span class="builtintype" id="4363275">error</span>&nbsp;<span class="op" id="4363281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4363284">switch</span>&nbsp;<span class="ident" id="4363291">err</span>&nbsp;<span class="op" id="4363295">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4363298">case</span>&nbsp;<span class="ident" id="4363303">alertNoRenegotiation</span><span class="op" id="4363323">,</span>&nbsp;<span class="ident" id="4363325">alertCloseNotify</span><span class="op" id="4363341">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4363345">c</span><span class="op" id="4363346">.</span><span class="ident" id="4363347">tmp</span><span class="op" id="4363350">[</span><span class="num" id="4363351">0</span><span class="op" id="4363352">]</span>&nbsp;<span class="op" id="4363354">=</span>&nbsp;<span class="ident" id="4363356">alertLevelWarning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4363375">default</span><span class="op" id="4363382">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4363386">c</span><span class="op" id="4363387">.</span><span class="ident" id="4363388">tmp</span><span class="op" id="4363391">[</span><span class="num" id="4363392">0</span><span class="op" id="4363393">]</span>&nbsp;<span class="op" id="4363395">=</span>&nbsp;<span class="ident" id="4363397">alertLevelError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4363414">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4363417">c</span><span class="op" id="4363418">.</span><span class="ident" id="4363419">tmp</span><span class="op" id="4363422">[</span><span class="num" id="4363423">1</span><span class="op" id="4363424">]</span>&nbsp;<span class="op" id="4363426">=</span>&nbsp;<span class="builtintype" id="4363428">byte</span><span class="op" id="4363432">(</span><span class="ident" id="4363433">err</span><span class="op" id="4363436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4363439">c</span><span class="op" id="4363440">.</span><span class="ident" id="4363441">writeRecord</span><span class="op" id="4363452">(</span><span class="ident" id="4363453">recordTypeAlert</span><span class="op" id="4363468">,</span>&nbsp;<span class="ident" id="4363470">c</span><span class="op" id="4363471">.</span><span class="ident" id="4363472">tmp</span><span class="op" id="4363475">[</span><span class="num" id="4363476">0</span><span class="op" id="4363477">:</span><span class="num" id="4363478">2</span><span class="op" id="4363479">]</span><span class="op" id="4363480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4363483">//&nbsp;closeNotify&nbsp;is&nbsp;a&nbsp;special&nbsp;case&nbsp;in&nbsp;that&nbsp;it&nbsp;isn&#39;t&nbsp;an&nbsp;error:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4363544">if</span>&nbsp;<span class="ident" id="4363547">err</span>&nbsp;<span class="op" id="4363551">!=</span>&nbsp;<span class="ident" id="4363554">alertCloseNotify</span>&nbsp;<span class="op" id="4363571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4363575">return</span>&nbsp;<span class="ident" id="4363582">c</span><span class="op" id="4363583">.</span><span class="ident" id="4363584">out</span><span class="op" id="4363587">.</span><span class="ident" id="4363588">setErrorLocked</span><span class="op" id="4363602">(</span><span class="op" id="4363603">&amp;</span><span class="ident" id="4363604">net</span><span class="op" id="4363607">.</span><span class="ident" id="4363608">OpError</span><span class="op" id="4363615">{</span><span class="ident" id="4363616">Op</span><span class="op" id="4363618">:</span>&nbsp;<span class="string" id="4363620">&#34;local&nbsp;error&#34;</span><span class="op" id="4363633">,</span>&nbsp;<span class="ident" id="4363635">Err</span><span class="op" id="4363638">:</span>&nbsp;<span class="ident" id="4363640">err</span><span class="op" id="4363643">}</span><span class="op" id="4363644">)</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4363647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4363650">return</span>&nbsp;<span class="builtintype" id="4363657">nil</span><br>
<span class="lineno"></span><span class="op" id="4363661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4363664">//&nbsp;sendAlert&nbsp;sends&nbsp;a&nbsp;TLS&nbsp;alert&nbsp;message.</span><br>
<span class="lineno">685</span><span class="comment" id="4363704">//&nbsp;L&nbsp;&lt;&nbsp;c.out.Mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="4363724">func</span>&nbsp;<span class="op" id="4363729">(</span><span class="ident" id="4363730">c</span>&nbsp;<span class="op" id="4363732">*</span><span class="ident" id="4363733">Conn</span><span class="op" id="4363737">)</span>&nbsp;<span class="ident" id="4363739">sendAlert</span><span class="op" id="4363748">(</span><span class="ident" id="4363749">err</span>&nbsp;<span class="ident" id="4363753">alert</span><span class="op" id="4363758">)</span>&nbsp;<span class="builtintype" id="4363760">error</span>&nbsp;<span class="op" id="4363766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4363769">c</span><span class="op" id="4363770">.</span><span class="ident" id="4363771">out</span><span class="op" id="4363774">.</span><span class="ident" id="4363775">Lock</span><span class="op" id="4363779">(</span><span class="op" id="4363780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4363783">defer</span>&nbsp;<span class="ident" id="4363789">c</span><span class="op" id="4363790">.</span><span class="ident" id="4363791">out</span><span class="op" id="4363794">.</span><span class="ident" id="4363795">Unlock</span><span class="op" id="4363801">(</span><span class="op" id="4363802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4363805">return</span>&nbsp;<span class="ident" id="4363812">c</span><span class="op" id="4363813">.</span><span class="ident" id="4363814">sendAlertLocked</span><span class="op" id="4363829">(</span><span class="ident" id="4363830">err</span><span class="op" id="4363833">)</span><br>
<span class="lineno">690</span><span class="op" id="4363835">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4363838">//&nbsp;writeRecord&nbsp;writes&nbsp;a&nbsp;TLS&nbsp;record&nbsp;with&nbsp;the&nbsp;given&nbsp;type&nbsp;and&nbsp;payload</span><br>
<span class="lineno"></span><span class="comment" id="4363905">//&nbsp;to&nbsp;the&nbsp;connection&nbsp;and&nbsp;updates&nbsp;the&nbsp;record&nbsp;layer&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="4363962">//&nbsp;c.out.Mutex&nbsp;&lt;=&nbsp;L.</span><br>
<span class="lineno">695</span><span class="keyword" id="4363983">func</span>&nbsp;<span class="op" id="4363988">(</span><span class="ident" id="4363989">c</span>&nbsp;<span class="op" id="4363991">*</span><span class="ident" id="4363992">Conn</span><span class="op" id="4363996">)</span>&nbsp;<span class="ident" id="4363998">writeRecord</span><span class="op" id="4364009">(</span><span class="ident" id="4364010">typ</span>&nbsp;<span class="ident" id="4364014">recordType</span><span class="op" id="4364024">,</span>&nbsp;<span class="ident" id="4364026">data</span>&nbsp;<span class="op" id="4364031">[</span><span class="op" id="4364032">]</span><span class="builtintype" id="4364033">byte</span><span class="op" id="4364037">)</span>&nbsp;<span class="op" id="4364039">(</span><span class="ident" id="4364040">n</span>&nbsp;<span class="builtintype" id="4364042">int</span><span class="op" id="4364045">,</span>&nbsp;<span class="ident" id="4364047">err</span>&nbsp;<span class="builtintype" id="4364051">error</span><span class="op" id="4364056">)</span>&nbsp;<span class="op" id="4364058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4364061">b</span>&nbsp;<span class="op" id="4364063">:=</span>&nbsp;<span class="ident" id="4364066">c</span><span class="op" id="4364067">.</span><span class="ident" id="4364068">out</span><span class="op" id="4364071">.</span><span class="ident" id="4364072">newBlock</span><span class="op" id="4364080">(</span><span class="op" id="4364081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4364084">for</span>&nbsp;<span class="builtinfunc" id="4364088">len</span><span class="op" id="4364091">(</span><span class="ident" id="4364092">data</span><span class="op" id="4364096">)</span>&nbsp;<span class="op" id="4364098">&gt;</span>&nbsp;<span class="num" id="4364100">0</span>&nbsp;<span class="op" id="4364102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4364106">m</span>&nbsp;<span class="op" id="4364108">:=</span>&nbsp;<span class="builtinfunc" id="4364111">len</span><span class="op" id="4364114">(</span><span class="ident" id="4364115">data</span><span class="op" id="4364119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4364123">if</span>&nbsp;<span class="ident" id="4364126">m</span>&nbsp;<span class="op" id="4364128">&gt;</span>&nbsp;<span class="ident" id="4364130">maxPlaintext</span>&nbsp;<span class="op" id="4364143">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4364148">m</span>&nbsp;<span class="op" id="4364150">=</span>&nbsp;<span class="ident" id="4364152">maxPlaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4364167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4364171">explicitIVLen</span>&nbsp;<span class="op" id="4364185">:=</span>&nbsp;<span class="num" id="4364188">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4364192">explicitIVIsSeq</span>&nbsp;<span class="op" id="4364208">:=</span>&nbsp;<span class="builtintype" id="4364211">false</span><br>
<span class="lineno"></span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4364220">var</span>&nbsp;<span class="ident" id="4364224">cbc</span>&nbsp;<span class="ident" id="4364228">cbcMode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4364238">if</span>&nbsp;<span class="ident" id="4364241">c</span><span class="op" id="4364242">.</span><span class="ident" id="4364243">out</span><span class="op" id="4364246">.</span><span class="ident" id="4364247">version</span>&nbsp;<span class="op" id="4364255">&gt;=</span>&nbsp;<span class="ident" id="4364258">VersionTLS11</span>&nbsp;<span class="op" id="4364271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4364276">var</span>&nbsp;<span class="ident" id="4364280">ok</span>&nbsp;<span class="builtintype" id="4364283">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4364291">if</span>&nbsp;<span class="ident" id="4364294">cbc</span><span class="op" id="4364297">,</span>&nbsp;<span class="ident" id="4364299">ok</span>&nbsp;<span class="op" id="4364302">=</span>&nbsp;<span class="ident" id="4364304">c</span><span class="op" id="4364305">.</span><span class="ident" id="4364306">out</span><span class="op" id="4364309">.</span><span class="ident" id="4364310">cipher</span><span class="op" id="4364316">.</span><span class="op" id="4364317">(</span><span class="ident" id="4364318">cbcMode</span><span class="op" id="4364325">)</span><span class="op" id="4364326">;</span>&nbsp;<span class="ident" id="4364328">ok</span>&nbsp;<span class="op" id="4364331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4364337">explicitIVLen</span>&nbsp;<span class="op" id="4364351">=</span>&nbsp;<span class="ident" id="4364353">cbc</span><span class="op" id="4364356">.</span><span class="ident" id="4364357">BlockSize</span><span class="op" id="4364366">(</span><span class="op" id="4364367">)</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4364372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4364376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4364380">if</span>&nbsp;<span class="ident" id="4364383">explicitIVLen</span>&nbsp;<span class="op" id="4364397">==</span>&nbsp;<span class="num" id="4364400">0</span>&nbsp;<span class="op" id="4364402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4364407">if</span>&nbsp;<span class="ident" id="4364410">_</span><span class="op" id="4364411">,</span>&nbsp;<span class="ident" id="4364413">ok</span>&nbsp;<span class="op" id="4364416">:=</span>&nbsp;<span class="ident" id="4364419">c</span><span class="op" id="4364420">.</span><span class="ident" id="4364421">out</span><span class="op" id="4364424">.</span><span class="ident" id="4364425">cipher</span><span class="op" id="4364431">.</span><span class="op" id="4364432">(</span><span class="ident" id="4364433">cipher</span><span class="op" id="4364439">.</span><span class="ident" id="4364440">AEAD</span><span class="op" id="4364444">)</span><span class="op" id="4364445">;</span>&nbsp;<span class="ident" id="4364447">ok</span>&nbsp;<span class="op" id="4364450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4364456">explicitIVLen</span>&nbsp;<span class="op" id="4364470">=</span>&nbsp;<span class="num" id="4364472">8</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4364478">//&nbsp;The&nbsp;AES-GCM&nbsp;construction&nbsp;in&nbsp;TLS&nbsp;has&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4364524">//&nbsp;explicit&nbsp;nonce&nbsp;so&nbsp;that&nbsp;the&nbsp;nonce&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4364571">//&nbsp;random.&nbsp;However,&nbsp;the&nbsp;nonce&nbsp;is&nbsp;only&nbsp;8&nbsp;bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4364621">//&nbsp;which&nbsp;is&nbsp;too&nbsp;small&nbsp;for&nbsp;a&nbsp;secure,&nbsp;random</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4364668">//&nbsp;nonce.&nbsp;Therefore&nbsp;we&nbsp;use&nbsp;the&nbsp;sequence&nbsp;number</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4364719">//&nbsp;as&nbsp;the&nbsp;nonce.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4364740">explicitIVIsSeq</span>&nbsp;<span class="op" id="4364756">=</span>&nbsp;<span class="builtintype" id="4364758">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4364766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4364770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4364774">b</span><span class="op" id="4364775">.</span><span class="ident" id="4364776">resize</span><span class="op" id="4364782">(</span><span class="ident" id="4364783">recordHeaderLen</span>&nbsp;<span class="op" id="4364799">+</span>&nbsp;<span class="ident" id="4364801">explicitIVLen</span>&nbsp;<span class="op" id="4364815">+</span>&nbsp;<span class="ident" id="4364817">m</span><span class="op" id="4364818">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4364822">b</span><span class="op" id="4364823">.</span><span class="ident" id="4364824">data</span><span class="op" id="4364828">[</span><span class="num" id="4364829">0</span><span class="op" id="4364830">]</span>&nbsp;<span class="op" id="4364832">=</span>&nbsp;<span class="builtintype" id="4364834">byte</span><span class="op" id="4364838">(</span><span class="ident" id="4364839">typ</span><span class="op" id="4364842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4364846">vers</span>&nbsp;<span class="op" id="4364851">:=</span>&nbsp;<span class="ident" id="4364854">c</span><span class="op" id="4364855">.</span><span class="ident" id="4364856">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4364863">if</span>&nbsp;<span class="ident" id="4364866">vers</span>&nbsp;<span class="op" id="4364871">==</span>&nbsp;<span class="num" id="4364874">0</span>&nbsp;<span class="op" id="4364876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4364881">//&nbsp;Some&nbsp;TLS&nbsp;servers&nbsp;fail&nbsp;if&nbsp;the&nbsp;record&nbsp;version&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4364934">//&nbsp;greater&nbsp;than&nbsp;TLS&nbsp;1.0&nbsp;for&nbsp;the&nbsp;initial&nbsp;ClientHello.</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4364990">vers</span>&nbsp;<span class="op" id="4364995">=</span>&nbsp;<span class="ident" id="4364997">VersionTLS10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4365012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4365016">b</span><span class="op" id="4365017">.</span><span class="ident" id="4365018">data</span><span class="op" id="4365022">[</span><span class="num" id="4365023">1</span><span class="op" id="4365024">]</span>&nbsp;<span class="op" id="4365026">=</span>&nbsp;<span class="builtintype" id="4365028">byte</span><span class="op" id="4365032">(</span><span class="ident" id="4365033">vers</span>&nbsp;<span class="op" id="4365038">&gt;&gt;</span>&nbsp;<span class="num" id="4365041">8</span><span class="op" id="4365042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4365046">b</span><span class="op" id="4365047">.</span><span class="ident" id="4365048">data</span><span class="op" id="4365052">[</span><span class="num" id="4365053">2</span><span class="op" id="4365054">]</span>&nbsp;<span class="op" id="4365056">=</span>&nbsp;<span class="builtintype" id="4365058">byte</span><span class="op" id="4365062">(</span><span class="ident" id="4365063">vers</span><span class="op" id="4365067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4365071">b</span><span class="op" id="4365072">.</span><span class="ident" id="4365073">data</span><span class="op" id="4365077">[</span><span class="num" id="4365078">3</span><span class="op" id="4365079">]</span>&nbsp;<span class="op" id="4365081">=</span>&nbsp;<span class="builtintype" id="4365083">byte</span><span class="op" id="4365087">(</span><span class="ident" id="4365088">m</span>&nbsp;<span class="op" id="4365090">&gt;&gt;</span>&nbsp;<span class="num" id="4365093">8</span><span class="op" id="4365094">)</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4365098">b</span><span class="op" id="4365099">.</span><span class="ident" id="4365100">data</span><span class="op" id="4365104">[</span><span class="num" id="4365105">4</span><span class="op" id="4365106">]</span>&nbsp;<span class="op" id="4365108">=</span>&nbsp;<span class="builtintype" id="4365110">byte</span><span class="op" id="4365114">(</span><span class="ident" id="4365115">m</span><span class="op" id="4365116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4365120">if</span>&nbsp;<span class="ident" id="4365123">explicitIVLen</span>&nbsp;<span class="op" id="4365137">&gt;</span>&nbsp;<span class="num" id="4365139">0</span>&nbsp;<span class="op" id="4365141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4365146">explicitIV</span>&nbsp;<span class="op" id="4365157">:=</span>&nbsp;<span class="ident" id="4365160">b</span><span class="op" id="4365161">.</span><span class="ident" id="4365162">data</span><span class="op" id="4365166">[</span><span class="ident" id="4365167">recordHeaderLen</span>&nbsp;<span class="op" id="4365183">:</span>&nbsp;<span class="ident" id="4365185">recordHeaderLen</span><span class="op" id="4365200">+</span><span class="ident" id="4365201">explicitIVLen</span><span class="op" id="4365214">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4365219">if</span>&nbsp;<span class="ident" id="4365222">explicitIVIsSeq</span>&nbsp;<span class="op" id="4365238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4365244">copy</span><span class="op" id="4365248">(</span><span class="ident" id="4365249">explicitIV</span><span class="op" id="4365259">,</span>&nbsp;<span class="ident" id="4365261">c</span><span class="op" id="4365262">.</span><span class="ident" id="4365263">out</span><span class="op" id="4365266">.</span><span class="ident" id="4365267">seq</span><span class="op" id="4365270">[</span><span class="op" id="4365271">:</span><span class="op" id="4365272">]</span><span class="op" id="4365273">)</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4365278">}</span>&nbsp;<span class="keyword" id="4365280">else</span>&nbsp;<span class="op" id="4365285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4365291">if</span>&nbsp;<span class="ident" id="4365294">_</span><span class="op" id="4365295">,</span>&nbsp;<span class="ident" id="4365297">err</span>&nbsp;<span class="op" id="4365301">=</span>&nbsp;<span class="ident" id="4365303">io</span><span class="op" id="4365305">.</span><span class="ident" id="4365306">ReadFull</span><span class="op" id="4365314">(</span><span class="ident" id="4365315">c</span><span class="op" id="4365316">.</span><span class="ident" id="4365317">config</span><span class="op" id="4365323">.</span><span class="ident" id="4365324">rand</span><span class="op" id="4365328">(</span><span class="op" id="4365329">)</span><span class="op" id="4365330">,</span>&nbsp;<span class="ident" id="4365332">explicitIV</span><span class="op" id="4365342">)</span><span class="op" id="4365343">;</span>&nbsp;<span class="ident" id="4365345">err</span>&nbsp;<span class="op" id="4365349">!=</span>&nbsp;<span class="builtintype" id="4365352">nil</span>&nbsp;<span class="op" id="4365356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4365363">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4365373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4365378">}</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4365382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4365386">copy</span><span class="op" id="4365390">(</span><span class="ident" id="4365391">b</span><span class="op" id="4365392">.</span><span class="ident" id="4365393">data</span><span class="op" id="4365397">[</span><span class="ident" id="4365398">recordHeaderLen</span><span class="op" id="4365413">+</span><span class="ident" id="4365414">explicitIVLen</span><span class="op" id="4365427">:</span><span class="op" id="4365428">]</span><span class="op" id="4365429">,</span>&nbsp;<span class="ident" id="4365431">data</span><span class="op" id="4365435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4365439">c</span><span class="op" id="4365440">.</span><span class="ident" id="4365441">out</span><span class="op" id="4365444">.</span><span class="ident" id="4365445">encrypt</span><span class="op" id="4365452">(</span><span class="ident" id="4365453">b</span><span class="op" id="4365454">,</span>&nbsp;<span class="ident" id="4365456">explicitIVLen</span><span class="op" id="4365469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4365473">_</span><span class="op" id="4365474">,</span>&nbsp;<span class="ident" id="4365476">err</span>&nbsp;<span class="op" id="4365480">=</span>&nbsp;<span class="ident" id="4365482">c</span><span class="op" id="4365483">.</span><span class="ident" id="4365484">conn</span><span class="op" id="4365488">.</span><span class="ident" id="4365489">Write</span><span class="op" id="4365494">(</span><span class="ident" id="4365495">b</span><span class="op" id="4365496">.</span><span class="ident" id="4365497">data</span><span class="op" id="4365501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4365505">if</span>&nbsp;<span class="ident" id="4365508">err</span>&nbsp;<span class="op" id="4365512">!=</span>&nbsp;<span class="builtintype" id="4365515">nil</span>&nbsp;<span class="op" id="4365519">{</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4365524">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4365532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4365536">n</span>&nbsp;<span class="op" id="4365538">+=</span>&nbsp;<span class="ident" id="4365541">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4365545">data</span>&nbsp;<span class="op" id="4365550">=</span>&nbsp;<span class="ident" id="4365552">data</span><span class="op" id="4365556">[</span><span class="ident" id="4365557">m</span><span class="op" id="4365558">:</span><span class="op" id="4365559">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4365562">}</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4365565">c</span><span class="op" id="4365566">.</span><span class="ident" id="4365567">out</span><span class="op" id="4365570">.</span><span class="ident" id="4365571">freeBlock</span><span class="op" id="4365580">(</span><span class="ident" id="4365581">b</span><span class="op" id="4365582">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4365586">if</span>&nbsp;<span class="ident" id="4365589">typ</span>&nbsp;<span class="op" id="4365593">==</span>&nbsp;<span class="ident" id="4365596">recordTypeChangeCipherSpec</span>&nbsp;<span class="op" id="4365623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4365627">err</span>&nbsp;<span class="op" id="4365631">=</span>&nbsp;<span class="ident" id="4365633">c</span><span class="op" id="4365634">.</span><span class="ident" id="4365635">out</span><span class="op" id="4365638">.</span><span class="ident" id="4365639">changeCipherSpec</span><span class="op" id="4365655">(</span><span class="op" id="4365656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4365660">if</span>&nbsp;<span class="ident" id="4365663">err</span>&nbsp;<span class="op" id="4365667">!=</span>&nbsp;<span class="builtintype" id="4365670">nil</span>&nbsp;<span class="op" id="4365674">{</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4365679">//&nbsp;Cannot&nbsp;call&nbsp;sendAlert&nbsp;directly,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4365717">//&nbsp;because&nbsp;we&nbsp;already&nbsp;hold&nbsp;c.out.Mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4365760">c</span><span class="op" id="4365761">.</span><span class="ident" id="4365762">tmp</span><span class="op" id="4365765">[</span><span class="num" id="4365766">0</span><span class="op" id="4365767">]</span>&nbsp;<span class="op" id="4365769">=</span>&nbsp;<span class="ident" id="4365771">alertLevelError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4365790">c</span><span class="op" id="4365791">.</span><span class="ident" id="4365792">tmp</span><span class="op" id="4365795">[</span><span class="num" id="4365796">1</span><span class="op" id="4365797">]</span>&nbsp;<span class="op" id="4365799">=</span>&nbsp;<span class="builtintype" id="4365801">byte</span><span class="op" id="4365805">(</span><span class="ident" id="4365806">err</span><span class="op" id="4365809">.</span><span class="op" id="4365810">(</span><span class="ident" id="4365811">alert</span><span class="op" id="4365816">)</span><span class="op" id="4365817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4365822">c</span><span class="op" id="4365823">.</span><span class="ident" id="4365824">writeRecord</span><span class="op" id="4365835">(</span><span class="ident" id="4365836">recordTypeAlert</span><span class="op" id="4365851">,</span>&nbsp;<span class="ident" id="4365853">c</span><span class="op" id="4365854">.</span><span class="ident" id="4365855">tmp</span><span class="op" id="4365858">[</span><span class="num" id="4365859">0</span><span class="op" id="4365860">:</span><span class="num" id="4365861">2</span><span class="op" id="4365862">]</span><span class="op" id="4365863">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4365868">return</span>&nbsp;<span class="ident" id="4365875">n</span><span class="op" id="4365876">,</span>&nbsp;<span class="ident" id="4365878">c</span><span class="op" id="4365879">.</span><span class="ident" id="4365880">out</span><span class="op" id="4365883">.</span><span class="ident" id="4365884">setErrorLocked</span><span class="op" id="4365898">(</span><span class="op" id="4365899">&amp;</span><span class="ident" id="4365900">net</span><span class="op" id="4365903">.</span><span class="ident" id="4365904">OpError</span><span class="op" id="4365911">{</span><span class="ident" id="4365912">Op</span><span class="op" id="4365914">:</span>&nbsp;<span class="string" id="4365916">&#34;local&nbsp;error&#34;</span><span class="op" id="4365929">,</span>&nbsp;<span class="ident" id="4365931">Err</span><span class="op" id="4365934">:</span>&nbsp;<span class="ident" id="4365936">err</span><span class="op" id="4365939">}</span><span class="op" id="4365940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4365944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4365947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4365950">return</span><br>
<span class="lineno"></span><span class="op" id="4365957">}</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span><span class="comment" id="4365960">//&nbsp;readHandshake&nbsp;reads&nbsp;the&nbsp;next&nbsp;handshake&nbsp;message&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="4366015">//&nbsp;the&nbsp;record&nbsp;layer.</span><br>
<span class="lineno"></span><span class="comment" id="4366036">//&nbsp;c.in.Mutex&nbsp;&lt;&nbsp;L;&nbsp;c.out.Mutex&nbsp;&lt;&nbsp;L.</span><br>
<span class="lineno"></span><span class="keyword" id="4366072">func</span>&nbsp;<span class="op" id="4366077">(</span><span class="ident" id="4366078">c</span>&nbsp;<span class="op" id="4366080">*</span><span class="ident" id="4366081">Conn</span><span class="op" id="4366085">)</span>&nbsp;<span class="ident" id="4366087">readHandshake</span><span class="op" id="4366100">(</span><span class="op" id="4366101">)</span>&nbsp;<span class="op" id="4366103">(</span><span class="keyword" id="4366104">interface</span><span class="op" id="4366113">{</span><span class="op" id="4366114">}</span><span class="op" id="4366115">,</span>&nbsp;<span class="builtintype" id="4366117">error</span><span class="op" id="4366122">)</span>&nbsp;<span class="op" id="4366124">{</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4366127">for</span>&nbsp;<span class="ident" id="4366131">c</span><span class="op" id="4366132">.</span><span class="ident" id="4366133">hand</span><span class="op" id="4366137">.</span><span class="ident" id="4366138">Len</span><span class="op" id="4366141">(</span><span class="op" id="4366142">)</span>&nbsp;<span class="op" id="4366144">&lt;</span>&nbsp;<span class="num" id="4366146">4</span>&nbsp;<span class="op" id="4366148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4366152">if</span>&nbsp;<span class="ident" id="4366155">err</span>&nbsp;<span class="op" id="4366159">:=</span>&nbsp;<span class="ident" id="4366162">c</span><span class="op" id="4366163">.</span><span class="ident" id="4366164">in</span><span class="op" id="4366166">.</span><span class="ident" id="4366167">err</span><span class="op" id="4366170">;</span>&nbsp;<span class="ident" id="4366172">err</span>&nbsp;<span class="op" id="4366176">!=</span>&nbsp;<span class="builtintype" id="4366179">nil</span>&nbsp;<span class="op" id="4366183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4366188">return</span>&nbsp;<span class="builtintype" id="4366195">nil</span><span class="op" id="4366198">,</span>&nbsp;<span class="ident" id="4366200">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4366206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4366210">if</span>&nbsp;<span class="ident" id="4366213">err</span>&nbsp;<span class="op" id="4366217">:=</span>&nbsp;<span class="ident" id="4366220">c</span><span class="op" id="4366221">.</span><span class="ident" id="4366222">readRecord</span><span class="op" id="4366232">(</span><span class="ident" id="4366233">recordTypeHandshake</span><span class="op" id="4366252">)</span><span class="op" id="4366253">;</span>&nbsp;<span class="ident" id="4366255">err</span>&nbsp;<span class="op" id="4366259">!=</span>&nbsp;<span class="builtintype" id="4366262">nil</span>&nbsp;<span class="op" id="4366266">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4366271">return</span>&nbsp;<span class="builtintype" id="4366278">nil</span><span class="op" id="4366281">,</span>&nbsp;<span class="ident" id="4366283">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4366289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4366292">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4366296">data</span>&nbsp;<span class="op" id="4366301">:=</span>&nbsp;<span class="ident" id="4366304">c</span><span class="op" id="4366305">.</span><span class="ident" id="4366306">hand</span><span class="op" id="4366310">.</span><span class="ident" id="4366311">Bytes</span><span class="op" id="4366316">(</span><span class="op" id="4366317">)</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4366320">n</span>&nbsp;<span class="op" id="4366322">:=</span>&nbsp;<span class="builtintype" id="4366325">int</span><span class="op" id="4366328">(</span><span class="ident" id="4366329">data</span><span class="op" id="4366333">[</span><span class="num" id="4366334">1</span><span class="op" id="4366335">]</span><span class="op" id="4366336">)</span><span class="op" id="4366337">&lt;&lt;</span><span class="num" id="4366339">16</span>&nbsp;<span class="op" id="4366342">|</span>&nbsp;<span class="builtintype" id="4366344">int</span><span class="op" id="4366347">(</span><span class="ident" id="4366348">data</span><span class="op" id="4366352">[</span><span class="num" id="4366353">2</span><span class="op" id="4366354">]</span><span class="op" id="4366355">)</span><span class="op" id="4366356">&lt;&lt;</span><span class="num" id="4366358">8</span>&nbsp;<span class="op" id="4366360">|</span>&nbsp;<span class="builtintype" id="4366362">int</span><span class="op" id="4366365">(</span><span class="ident" id="4366366">data</span><span class="op" id="4366370">[</span><span class="num" id="4366371">3</span><span class="op" id="4366372">]</span><span class="op" id="4366373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4366376">if</span>&nbsp;<span class="ident" id="4366379">n</span>&nbsp;<span class="op" id="4366381">&gt;</span>&nbsp;<span class="ident" id="4366383">maxHandshake</span>&nbsp;<span class="op" id="4366396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4366400">return</span>&nbsp;<span class="builtintype" id="4366407">nil</span><span class="op" id="4366410">,</span>&nbsp;<span class="ident" id="4366412">c</span><span class="op" id="4366413">.</span><span class="ident" id="4366414">in</span><span class="op" id="4366416">.</span><span class="ident" id="4366417">setErrorLocked</span><span class="op" id="4366431">(</span><span class="ident" id="4366432">c</span><span class="op" id="4366433">.</span><span class="ident" id="4366434">sendAlert</span><span class="op" id="4366443">(</span><span class="ident" id="4366444">alertInternalError</span><span class="op" id="4366462">)</span><span class="op" id="4366463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4366466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4366469">for</span>&nbsp;<span class="ident" id="4366473">c</span><span class="op" id="4366474">.</span><span class="ident" id="4366475">hand</span><span class="op" id="4366479">.</span><span class="ident" id="4366480">Len</span><span class="op" id="4366483">(</span><span class="op" id="4366484">)</span>&nbsp;<span class="op" id="4366486">&lt;</span>&nbsp;<span class="num" id="4366488">4</span><span class="op" id="4366489">+</span><span class="ident" id="4366490">n</span>&nbsp;<span class="op" id="4366492">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4366496">if</span>&nbsp;<span class="ident" id="4366499">err</span>&nbsp;<span class="op" id="4366503">:=</span>&nbsp;<span class="ident" id="4366506">c</span><span class="op" id="4366507">.</span><span class="ident" id="4366508">in</span><span class="op" id="4366510">.</span><span class="ident" id="4366511">err</span><span class="op" id="4366514">;</span>&nbsp;<span class="ident" id="4366516">err</span>&nbsp;<span class="op" id="4366520">!=</span>&nbsp;<span class="builtintype" id="4366523">nil</span>&nbsp;<span class="op" id="4366527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4366532">return</span>&nbsp;<span class="builtintype" id="4366539">nil</span><span class="op" id="4366542">,</span>&nbsp;<span class="ident" id="4366544">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4366550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4366554">if</span>&nbsp;<span class="ident" id="4366557">err</span>&nbsp;<span class="op" id="4366561">:=</span>&nbsp;<span class="ident" id="4366564">c</span><span class="op" id="4366565">.</span><span class="ident" id="4366566">readRecord</span><span class="op" id="4366576">(</span><span class="ident" id="4366577">recordTypeHandshake</span><span class="op" id="4366596">)</span><span class="op" id="4366597">;</span>&nbsp;<span class="ident" id="4366599">err</span>&nbsp;<span class="op" id="4366603">!=</span>&nbsp;<span class="builtintype" id="4366606">nil</span>&nbsp;<span class="op" id="4366610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4366615">return</span>&nbsp;<span class="builtintype" id="4366622">nil</span><span class="op" id="4366625">,</span>&nbsp;<span class="ident" id="4366627">err</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4366633">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4366636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4366639">data</span>&nbsp;<span class="op" id="4366644">=</span>&nbsp;<span class="ident" id="4366646">c</span><span class="op" id="4366647">.</span><span class="ident" id="4366648">hand</span><span class="op" id="4366652">.</span><span class="ident" id="4366653">Next</span><span class="op" id="4366657">(</span><span class="num" id="4366658">4</span>&nbsp;<span class="op" id="4366660">+</span>&nbsp;<span class="ident" id="4366662">n</span><span class="op" id="4366663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4366666">var</span>&nbsp;<span class="ident" id="4366670">m</span>&nbsp;<span class="ident" id="4366672">handshakeMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4366690">switch</span>&nbsp;<span class="ident" id="4366697">data</span><span class="op" id="4366701">[</span><span class="num" id="4366702">0</span><span class="op" id="4366703">]</span>&nbsp;<span class="op" id="4366705">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4366708">case</span>&nbsp;<span class="ident" id="4366713">typeClientHello</span><span class="op" id="4366728">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4366732">m</span>&nbsp;<span class="op" id="4366734">=</span>&nbsp;<span class="builtinfunc" id="4366736">new</span><span class="op" id="4366739">(</span><span class="ident" id="4366740">clientHelloMsg</span><span class="op" id="4366754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4366757">case</span>&nbsp;<span class="ident" id="4366762">typeServerHello</span><span class="op" id="4366777">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4366781">m</span>&nbsp;<span class="op" id="4366783">=</span>&nbsp;<span class="builtinfunc" id="4366785">new</span><span class="op" id="4366788">(</span><span class="ident" id="4366789">serverHelloMsg</span><span class="op" id="4366803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4366806">case</span>&nbsp;<span class="ident" id="4366811">typeNewSessionTicket</span><span class="op" id="4366831">:</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4366835">m</span>&nbsp;<span class="op" id="4366837">=</span>&nbsp;<span class="builtinfunc" id="4366839">new</span><span class="op" id="4366842">(</span><span class="ident" id="4366843">newSessionTicketMsg</span><span class="op" id="4366862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4366865">case</span>&nbsp;<span class="ident" id="4366870">typeCertificate</span><span class="op" id="4366885">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4366889">m</span>&nbsp;<span class="op" id="4366891">=</span>&nbsp;<span class="builtinfunc" id="4366893">new</span><span class="op" id="4366896">(</span><span class="ident" id="4366897">certificateMsg</span><span class="op" id="4366911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4366914">case</span>&nbsp;<span class="ident" id="4366919">typeCertificateRequest</span><span class="op" id="4366941">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4366945">m</span>&nbsp;<span class="op" id="4366947">=</span>&nbsp;<span class="op" id="4366949">&amp;</span><span class="ident" id="4366950">certificateRequestMsg</span><span class="op" id="4366971">{</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4366976">hasSignatureAndHash</span><span class="op" id="4366995">:</span>&nbsp;<span class="ident" id="4366997">c</span><span class="op" id="4366998">.</span><span class="ident" id="4366999">vers</span>&nbsp;<span class="op" id="4367004">&gt;=</span>&nbsp;<span class="ident" id="4367007">VersionTLS12</span><span class="op" id="4367019">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4367023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4367026">case</span>&nbsp;<span class="ident" id="4367031">typeCertificateStatus</span><span class="op" id="4367052">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4367056">m</span>&nbsp;<span class="op" id="4367058">=</span>&nbsp;<span class="builtinfunc" id="4367060">new</span><span class="op" id="4367063">(</span><span class="ident" id="4367064">certificateStatusMsg</span><span class="op" id="4367084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4367087">case</span>&nbsp;<span class="ident" id="4367092">typeServerKeyExchange</span><span class="op" id="4367113">:</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4367117">m</span>&nbsp;<span class="op" id="4367119">=</span>&nbsp;<span class="builtinfunc" id="4367121">new</span><span class="op" id="4367124">(</span><span class="ident" id="4367125">serverKeyExchangeMsg</span><span class="op" id="4367145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4367148">case</span>&nbsp;<span class="ident" id="4367153">typeServerHelloDone</span><span class="op" id="4367172">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4367176">m</span>&nbsp;<span class="op" id="4367178">=</span>&nbsp;<span class="builtinfunc" id="4367180">new</span><span class="op" id="4367183">(</span><span class="ident" id="4367184">serverHelloDoneMsg</span><span class="op" id="4367202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4367205">case</span>&nbsp;<span class="ident" id="4367210">typeClientKeyExchange</span><span class="op" id="4367231">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4367235">m</span>&nbsp;<span class="op" id="4367237">=</span>&nbsp;<span class="builtinfunc" id="4367239">new</span><span class="op" id="4367242">(</span><span class="ident" id="4367243">clientKeyExchangeMsg</span><span class="op" id="4367263">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4367266">case</span>&nbsp;<span class="ident" id="4367271">typeCertificateVerify</span><span class="op" id="4367292">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4367296">m</span>&nbsp;<span class="op" id="4367298">=</span>&nbsp;<span class="op" id="4367300">&amp;</span><span class="ident" id="4367301">certificateVerifyMsg</span><span class="op" id="4367321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4367326">hasSignatureAndHash</span><span class="op" id="4367345">:</span>&nbsp;<span class="ident" id="4367347">c</span><span class="op" id="4367348">.</span><span class="ident" id="4367349">vers</span>&nbsp;<span class="op" id="4367354">&gt;=</span>&nbsp;<span class="ident" id="4367357">VersionTLS12</span><span class="op" id="4367369">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4367373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4367376">case</span>&nbsp;<span class="ident" id="4367381">typeNextProtocol</span><span class="op" id="4367397">:</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4367401">m</span>&nbsp;<span class="op" id="4367403">=</span>&nbsp;<span class="builtinfunc" id="4367405">new</span><span class="op" id="4367408">(</span><span class="ident" id="4367409">nextProtoMsg</span><span class="op" id="4367421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4367424">case</span>&nbsp;<span class="ident" id="4367429">typeFinished</span><span class="op" id="4367441">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4367445">m</span>&nbsp;<span class="op" id="4367447">=</span>&nbsp;<span class="builtinfunc" id="4367449">new</span><span class="op" id="4367452">(</span><span class="ident" id="4367453">finishedMsg</span><span class="op" id="4367464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4367467">default</span><span class="op" id="4367474">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4367478">return</span>&nbsp;<span class="builtintype" id="4367485">nil</span><span class="op" id="4367488">,</span>&nbsp;<span class="ident" id="4367490">c</span><span class="op" id="4367491">.</span><span class="ident" id="4367492">in</span><span class="op" id="4367494">.</span><span class="ident" id="4367495">setErrorLocked</span><span class="op" id="4367509">(</span><span class="ident" id="4367510">c</span><span class="op" id="4367511">.</span><span class="ident" id="4367512">sendAlert</span><span class="op" id="4367521">(</span><span class="ident" id="4367522">alertUnexpectedMessage</span><span class="op" id="4367544">)</span><span class="op" id="4367545">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4367548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4367552">//&nbsp;The&nbsp;handshake&nbsp;message&nbsp;unmarshallers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4367592">//&nbsp;expect&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;keep&nbsp;references&nbsp;to&nbsp;data,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4367642">//&nbsp;so&nbsp;pass&nbsp;in&nbsp;a&nbsp;fresh&nbsp;copy&nbsp;that&nbsp;won&#39;t&nbsp;be&nbsp;overwritten.</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4367697">data</span>&nbsp;<span class="op" id="4367702">=</span>&nbsp;<span class="builtinfunc" id="4367704">append</span><span class="op" id="4367710">(</span><span class="op" id="4367711">[</span><span class="op" id="4367712">]</span><span class="builtintype" id="4367713">byte</span><span class="op" id="4367717">(</span><span class="builtintype" id="4367718">nil</span><span class="op" id="4367721">)</span><span class="op" id="4367722">,</span>&nbsp;<span class="ident" id="4367724">data</span><span class="op" id="4367728">...</span><span class="op" id="4367731">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4367735">if</span>&nbsp;<span class="op" id="4367738">!</span><span class="ident" id="4367739">m</span><span class="op" id="4367740">.</span><span class="ident" id="4367741">unmarshal</span><span class="op" id="4367750">(</span><span class="ident" id="4367751">data</span><span class="op" id="4367755">)</span>&nbsp;<span class="op" id="4367757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4367761">return</span>&nbsp;<span class="builtintype" id="4367768">nil</span><span class="op" id="4367771">,</span>&nbsp;<span class="ident" id="4367773">c</span><span class="op" id="4367774">.</span><span class="ident" id="4367775">in</span><span class="op" id="4367777">.</span><span class="ident" id="4367778">setErrorLocked</span><span class="op" id="4367792">(</span><span class="ident" id="4367793">c</span><span class="op" id="4367794">.</span><span class="ident" id="4367795">sendAlert</span><span class="op" id="4367804">(</span><span class="ident" id="4367805">alertUnexpectedMessage</span><span class="op" id="4367827">)</span><span class="op" id="4367828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4367831">}</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4367834">return</span>&nbsp;<span class="ident" id="4367841">m</span><span class="op" id="4367842">,</span>&nbsp;<span class="builtintype" id="4367844">nil</span><br>
<span class="lineno"></span><span class="op" id="4367848">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4367851">//&nbsp;Write&nbsp;writes&nbsp;data&nbsp;to&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4367891">func</span>&nbsp;<span class="op" id="4367896">(</span><span class="ident" id="4367897">c</span>&nbsp;<span class="op" id="4367899">*</span><span class="ident" id="4367900">Conn</span><span class="op" id="4367904">)</span>&nbsp;<span class="ident" id="4367906">Write</span><span class="op" id="4367911">(</span><span class="ident" id="4367912">b</span>&nbsp;<span class="op" id="4367914">[</span><span class="op" id="4367915">]</span><span class="builtintype" id="4367916">byte</span><span class="op" id="4367920">)</span>&nbsp;<span class="op" id="4367922">(</span><span class="builtintype" id="4367923">int</span><span class="op" id="4367926">,</span>&nbsp;<span class="builtintype" id="4367928">error</span><span class="op" id="4367933">)</span>&nbsp;<span class="op" id="4367935">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4367938">if</span>&nbsp;<span class="ident" id="4367941">err</span>&nbsp;<span class="op" id="4367945">:=</span>&nbsp;<span class="ident" id="4367948">c</span><span class="op" id="4367949">.</span><span class="ident" id="4367950">Handshake</span><span class="op" id="4367959">(</span><span class="op" id="4367960">)</span><span class="op" id="4367961">;</span>&nbsp;<span class="ident" id="4367963">err</span>&nbsp;<span class="op" id="4367967">!=</span>&nbsp;<span class="builtintype" id="4367970">nil</span>&nbsp;<span class="op" id="4367974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4367978">return</span>&nbsp;<span class="num" id="4367985">0</span><span class="op" id="4367986">,</span>&nbsp;<span class="ident" id="4367988">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4367993">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4367997">c</span><span class="op" id="4367998">.</span><span class="ident" id="4367999">out</span><span class="op" id="4368002">.</span><span class="ident" id="4368003">Lock</span><span class="op" id="4368007">(</span><span class="op" id="4368008">)</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4368011">defer</span>&nbsp;<span class="ident" id="4368017">c</span><span class="op" id="4368018">.</span><span class="ident" id="4368019">out</span><span class="op" id="4368022">.</span><span class="ident" id="4368023">Unlock</span><span class="op" id="4368029">(</span><span class="op" id="4368030">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4368034">if</span>&nbsp;<span class="ident" id="4368037">err</span>&nbsp;<span class="op" id="4368041">:=</span>&nbsp;<span class="ident" id="4368044">c</span><span class="op" id="4368045">.</span><span class="ident" id="4368046">out</span><span class="op" id="4368049">.</span><span class="ident" id="4368050">err</span><span class="op" id="4368053">;</span>&nbsp;<span class="ident" id="4368055">err</span>&nbsp;<span class="op" id="4368059">!=</span>&nbsp;<span class="builtintype" id="4368062">nil</span>&nbsp;<span class="op" id="4368066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4368070">return</span>&nbsp;<span class="num" id="4368077">0</span><span class="op" id="4368078">,</span>&nbsp;<span class="ident" id="4368080">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4368085">}</span><br>
<span class="lineno">855</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4368089">if</span>&nbsp;<span class="op" id="4368092">!</span><span class="ident" id="4368093">c</span><span class="op" id="4368094">.</span><span class="ident" id="4368095">handshakeComplete</span>&nbsp;<span class="op" id="4368113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4368117">return</span>&nbsp;<span class="num" id="4368124">0</span><span class="op" id="4368125">,</span>&nbsp;<span class="ident" id="4368127">alertInternalError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4368147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4368151">//&nbsp;SSL&nbsp;3.0&nbsp;and&nbsp;TLS&nbsp;1.0&nbsp;are&nbsp;susceptible&nbsp;to&nbsp;a&nbsp;chosen-plaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4368213">//&nbsp;attack&nbsp;when&nbsp;using&nbsp;block&nbsp;mode&nbsp;ciphers&nbsp;due&nbsp;to&nbsp;predictable&nbsp;IVs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4368278">//&nbsp;This&nbsp;can&nbsp;be&nbsp;prevented&nbsp;by&nbsp;splitting&nbsp;each&nbsp;Application&nbsp;Data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4368339">//&nbsp;record&nbsp;into&nbsp;two&nbsp;records,&nbsp;effectively&nbsp;randomizing&nbsp;the&nbsp;IV.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4368400">//</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4368404">//&nbsp;http://www.openssl.org/~bodo/tls-cbc.txt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4368449">//&nbsp;https://bugzilla.mozilla.org/show_bug.cgi?id=665814</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4368505">//&nbsp;http://www.imperialviolet.org/2012/01/15/beastfollowup.html</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4368570">var</span>&nbsp;<span class="ident" id="4368574">m</span>&nbsp;<span class="builtintype" id="4368576">int</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4368581">if</span>&nbsp;<span class="builtinfunc" id="4368584">len</span><span class="op" id="4368587">(</span><span class="ident" id="4368588">b</span><span class="op" id="4368589">)</span>&nbsp;<span class="op" id="4368591">&gt;</span>&nbsp;<span class="num" id="4368593">1</span>&nbsp;<span class="op" id="4368595">&amp;&amp;</span>&nbsp;<span class="ident" id="4368598">c</span><span class="op" id="4368599">.</span><span class="ident" id="4368600">vers</span>&nbsp;<span class="op" id="4368605">&lt;=</span>&nbsp;<span class="ident" id="4368608">VersionTLS10</span>&nbsp;<span class="op" id="4368621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4368625">if</span>&nbsp;<span class="ident" id="4368628">_</span><span class="op" id="4368629">,</span>&nbsp;<span class="ident" id="4368631">ok</span>&nbsp;<span class="op" id="4368634">:=</span>&nbsp;<span class="ident" id="4368637">c</span><span class="op" id="4368638">.</span><span class="ident" id="4368639">out</span><span class="op" id="4368642">.</span><span class="ident" id="4368643">cipher</span><span class="op" id="4368649">.</span><span class="op" id="4368650">(</span><span class="ident" id="4368651">cipher</span><span class="op" id="4368657">.</span><span class="ident" id="4368658">BlockMode</span><span class="op" id="4368667">)</span><span class="op" id="4368668">;</span>&nbsp;<span class="ident" id="4368670">ok</span>&nbsp;<span class="op" id="4368673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4368678">n</span><span class="op" id="4368679">,</span>&nbsp;<span class="ident" id="4368681">err</span>&nbsp;<span class="op" id="4368685">:=</span>&nbsp;<span class="ident" id="4368688">c</span><span class="op" id="4368689">.</span><span class="ident" id="4368690">writeRecord</span><span class="op" id="4368701">(</span><span class="ident" id="4368702">recordTypeApplicationData</span><span class="op" id="4368727">,</span>&nbsp;<span class="ident" id="4368729">b</span><span class="op" id="4368730">[</span><span class="op" id="4368731">:</span><span class="num" id="4368732">1</span><span class="op" id="4368733">]</span><span class="op" id="4368734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4368739">if</span>&nbsp;<span class="ident" id="4368742">err</span>&nbsp;<span class="op" id="4368746">!=</span>&nbsp;<span class="builtintype" id="4368749">nil</span>&nbsp;<span class="op" id="4368753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4368759">return</span>&nbsp;<span class="ident" id="4368766">n</span><span class="op" id="4368767">,</span>&nbsp;<span class="ident" id="4368769">c</span><span class="op" id="4368770">.</span><span class="ident" id="4368771">out</span><span class="op" id="4368774">.</span><span class="ident" id="4368775">setErrorLocked</span><span class="op" id="4368789">(</span><span class="ident" id="4368790">err</span><span class="op" id="4368793">)</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4368798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4368803">m</span><span class="op" id="4368804">,</span>&nbsp;<span class="ident" id="4368806">b</span>&nbsp;<span class="op" id="4368808">=</span>&nbsp;<span class="num" id="4368810">1</span><span class="op" id="4368811">,</span>&nbsp;<span class="ident" id="4368813">b</span><span class="op" id="4368814">[</span><span class="num" id="4368815">1</span><span class="op" id="4368816">:</span><span class="op" id="4368817">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4368821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4368824">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4368828">n</span><span class="op" id="4368829">,</span>&nbsp;<span class="ident" id="4368831">err</span>&nbsp;<span class="op" id="4368835">:=</span>&nbsp;<span class="ident" id="4368838">c</span><span class="op" id="4368839">.</span><span class="ident" id="4368840">writeRecord</span><span class="op" id="4368851">(</span><span class="ident" id="4368852">recordTypeApplicationData</span><span class="op" id="4368877">,</span>&nbsp;<span class="ident" id="4368879">b</span><span class="op" id="4368880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4368883">return</span>&nbsp;<span class="ident" id="4368890">n</span>&nbsp;<span class="op" id="4368892">+</span>&nbsp;<span class="ident" id="4368894">m</span><span class="op" id="4368895">,</span>&nbsp;<span class="ident" id="4368897">c</span><span class="op" id="4368898">.</span><span class="ident" id="4368899">out</span><span class="op" id="4368902">.</span><span class="ident" id="4368903">setErrorLocked</span><span class="op" id="4368917">(</span><span class="ident" id="4368918">err</span><span class="op" id="4368921">)</span><br>
<span class="lineno"></span><span class="op" id="4368923">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4368926">//&nbsp;Read&nbsp;can&nbsp;be&nbsp;made&nbsp;to&nbsp;time&nbsp;out&nbsp;and&nbsp;return&nbsp;a&nbsp;net.Error&nbsp;with&nbsp;Timeout()&nbsp;==&nbsp;true</span><br>
<span class="lineno">885</span><span class="comment" id="4369004">//&nbsp;after&nbsp;a&nbsp;fixed&nbsp;time&nbsp;limit;&nbsp;see&nbsp;SetDeadline&nbsp;and&nbsp;SetReadDeadline.</span><br>
<span class="lineno"></span><span class="keyword" id="4369070">func</span>&nbsp;<span class="op" id="4369075">(</span><span class="ident" id="4369076">c</span>&nbsp;<span class="op" id="4369078">*</span><span class="ident" id="4369079">Conn</span><span class="op" id="4369083">)</span>&nbsp;<span class="ident" id="4369085">Read</span><span class="op" id="4369089">(</span><span class="ident" id="4369090">b</span>&nbsp;<span class="op" id="4369092">[</span><span class="op" id="4369093">]</span><span class="builtintype" id="4369094">byte</span><span class="op" id="4369098">)</span>&nbsp;<span class="op" id="4369100">(</span><span class="ident" id="4369101">n</span>&nbsp;<span class="builtintype" id="4369103">int</span><span class="op" id="4369106">,</span>&nbsp;<span class="ident" id="4369108">err</span>&nbsp;<span class="builtintype" id="4369112">error</span><span class="op" id="4369117">)</span>&nbsp;<span class="op" id="4369119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4369122">if</span>&nbsp;<span class="ident" id="4369125">err</span>&nbsp;<span class="op" id="4369129">=</span>&nbsp;<span class="ident" id="4369131">c</span><span class="op" id="4369132">.</span><span class="ident" id="4369133">Handshake</span><span class="op" id="4369142">(</span><span class="op" id="4369143">)</span><span class="op" id="4369144">;</span>&nbsp;<span class="ident" id="4369146">err</span>&nbsp;<span class="op" id="4369150">!=</span>&nbsp;<span class="builtintype" id="4369153">nil</span>&nbsp;<span class="op" id="4369157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4369161">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4369169">}</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4369172">if</span>&nbsp;<span class="builtinfunc" id="4369175">len</span><span class="op" id="4369178">(</span><span class="ident" id="4369179">b</span><span class="op" id="4369180">)</span>&nbsp;<span class="op" id="4369182">==</span>&nbsp;<span class="num" id="4369185">0</span>&nbsp;<span class="op" id="4369187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4369191">//&nbsp;Put&nbsp;this&nbsp;after&nbsp;Handshake,&nbsp;in&nbsp;case&nbsp;people&nbsp;were&nbsp;calling</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4369250">//&nbsp;Read(nil)&nbsp;for&nbsp;the&nbsp;side&nbsp;effect&nbsp;of&nbsp;the&nbsp;Handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4369303">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4369311">}</span><br>
<span class="lineno">895</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4369315">c</span><span class="op" id="4369316">.</span><span class="ident" id="4369317">in</span><span class="op" id="4369319">.</span><span class="ident" id="4369320">Lock</span><span class="op" id="4369324">(</span><span class="op" id="4369325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4369328">defer</span>&nbsp;<span class="ident" id="4369334">c</span><span class="op" id="4369335">.</span><span class="ident" id="4369336">in</span><span class="op" id="4369338">.</span><span class="ident" id="4369339">Unlock</span><span class="op" id="4369345">(</span><span class="op" id="4369346">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4369350">//&nbsp;Some&nbsp;OpenSSL&nbsp;servers&nbsp;send&nbsp;empty&nbsp;records&nbsp;in&nbsp;order&nbsp;to&nbsp;randomize&nbsp;the</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4369420">//&nbsp;CBC&nbsp;IV.&nbsp;So&nbsp;this&nbsp;loop&nbsp;ignores&nbsp;a&nbsp;limited&nbsp;number&nbsp;of&nbsp;empty&nbsp;records.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4369488">const</span>&nbsp;<span class="ident" id="4369494">maxConsecutiveEmptyRecords</span>&nbsp;<span class="op" id="4369521">=</span>&nbsp;<span class="num" id="4369523">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4369528">for</span>&nbsp;<span class="ident" id="4369532">emptyRecordCount</span>&nbsp;<span class="op" id="4369549">:=</span>&nbsp;<span class="num" id="4369552">0</span><span class="op" id="4369553">;</span>&nbsp;<span class="ident" id="4369555">emptyRecordCount</span>&nbsp;<span class="op" id="4369572">&lt;=</span>&nbsp;<span class="ident" id="4369575">maxConsecutiveEmptyRecords</span><span class="op" id="4369601">;</span>&nbsp;<span class="ident" id="4369603">emptyRecordCount</span><span class="op" id="4369619">++</span>&nbsp;<span class="op" id="4369622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4369626">for</span>&nbsp;<span class="ident" id="4369630">c</span><span class="op" id="4369631">.</span><span class="ident" id="4369632">input</span>&nbsp;<span class="op" id="4369638">==</span>&nbsp;<span class="builtintype" id="4369641">nil</span>&nbsp;<span class="op" id="4369645">&amp;&amp;</span>&nbsp;<span class="ident" id="4369648">c</span><span class="op" id="4369649">.</span><span class="ident" id="4369650">in</span><span class="op" id="4369652">.</span><span class="ident" id="4369653">err</span>&nbsp;<span class="op" id="4369657">==</span>&nbsp;<span class="builtintype" id="4369660">nil</span>&nbsp;<span class="op" id="4369664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4369669">if</span>&nbsp;<span class="ident" id="4369672">err</span>&nbsp;<span class="op" id="4369676">:=</span>&nbsp;<span class="ident" id="4369679">c</span><span class="op" id="4369680">.</span><span class="ident" id="4369681">readRecord</span><span class="op" id="4369691">(</span><span class="ident" id="4369692">recordTypeApplicationData</span><span class="op" id="4369717">)</span><span class="op" id="4369718">;</span>&nbsp;<span class="ident" id="4369720">err</span>&nbsp;<span class="op" id="4369724">!=</span>&nbsp;<span class="builtintype" id="4369727">nil</span>&nbsp;<span class="op" id="4369731">{</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4369737">//&nbsp;Soft&nbsp;error,&nbsp;like&nbsp;EAGAIN</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4369768">return</span>&nbsp;<span class="num" id="4369775">0</span><span class="op" id="4369776">,</span>&nbsp;<span class="ident" id="4369778">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4369785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4369789">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4369793">if</span>&nbsp;<span class="ident" id="4369796">err</span>&nbsp;<span class="op" id="4369800">:=</span>&nbsp;<span class="ident" id="4369803">c</span><span class="op" id="4369804">.</span><span class="ident" id="4369805">in</span><span class="op" id="4369807">.</span><span class="ident" id="4369808">err</span><span class="op" id="4369811">;</span>&nbsp;<span class="ident" id="4369813">err</span>&nbsp;<span class="op" id="4369817">!=</span>&nbsp;<span class="builtintype" id="4369820">nil</span>&nbsp;<span class="op" id="4369824">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4369829">return</span>&nbsp;<span class="num" id="4369836">0</span><span class="op" id="4369837">,</span>&nbsp;<span class="ident" id="4369839">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4369845">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4369850">n</span><span class="op" id="4369851">,</span>&nbsp;<span class="ident" id="4369853">err</span>&nbsp;<span class="op" id="4369857">=</span>&nbsp;<span class="ident" id="4369859">c</span><span class="op" id="4369860">.</span><span class="ident" id="4369861">input</span><span class="op" id="4369866">.</span><span class="ident" id="4369867">Read</span><span class="op" id="4369871">(</span><span class="ident" id="4369872">b</span><span class="op" id="4369873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4369877">if</span>&nbsp;<span class="ident" id="4369880">c</span><span class="op" id="4369881">.</span><span class="ident" id="4369882">input</span><span class="op" id="4369887">.</span><span class="ident" id="4369888">off</span>&nbsp;<span class="op" id="4369892">&gt;=</span>&nbsp;<span class="builtinfunc" id="4369895">len</span><span class="op" id="4369898">(</span><span class="ident" id="4369899">c</span><span class="op" id="4369900">.</span><span class="ident" id="4369901">input</span><span class="op" id="4369906">.</span><span class="ident" id="4369907">data</span><span class="op" id="4369911">)</span>&nbsp;<span class="op" id="4369913">{</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4369918">c</span><span class="op" id="4369919">.</span><span class="ident" id="4369920">in</span><span class="op" id="4369922">.</span><span class="ident" id="4369923">freeBlock</span><span class="op" id="4369932">(</span><span class="ident" id="4369933">c</span><span class="op" id="4369934">.</span><span class="ident" id="4369935">input</span><span class="op" id="4369940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4369945">c</span><span class="op" id="4369946">.</span><span class="ident" id="4369947">input</span>&nbsp;<span class="op" id="4369953">=</span>&nbsp;<span class="builtintype" id="4369955">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4369961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4369966">//&nbsp;If&nbsp;a&nbsp;close-notify&nbsp;alert&nbsp;is&nbsp;waiting,&nbsp;read&nbsp;it&nbsp;so&nbsp;that</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4370023">//&nbsp;we&nbsp;can&nbsp;return&nbsp;(n,&nbsp;EOF)&nbsp;instead&nbsp;of&nbsp;(n,&nbsp;nil),&nbsp;to&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4370082">//&nbsp;to&nbsp;the&nbsp;HTTP&nbsp;response&nbsp;reading&nbsp;goroutine&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4370135">//&nbsp;connection&nbsp;is&nbsp;now&nbsp;closed.&nbsp;This&nbsp;eliminates&nbsp;a&nbsp;race</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4370189">//&nbsp;where&nbsp;the&nbsp;HTTP&nbsp;response&nbsp;reading&nbsp;goroutine&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4370242">//&nbsp;otherwise&nbsp;not&nbsp;observe&nbsp;the&nbsp;EOF&nbsp;until&nbsp;its&nbsp;next&nbsp;read,</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4370298">//&nbsp;by&nbsp;which&nbsp;time&nbsp;a&nbsp;client&nbsp;goroutine&nbsp;might&nbsp;have&nbsp;already</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4370355">//&nbsp;tried&nbsp;to&nbsp;reuse&nbsp;the&nbsp;HTTP&nbsp;connection&nbsp;for&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4370405">//&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4370419">//&nbsp;See&nbsp;https://codereview.appspot.com/76400046</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4370468">//&nbsp;and&nbsp;http://golang.org/issue/3514</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4370506">if</span>&nbsp;<span class="ident" id="4370509">ri</span>&nbsp;<span class="op" id="4370512">:=</span>&nbsp;<span class="ident" id="4370515">c</span><span class="op" id="4370516">.</span><span class="ident" id="4370517">rawInput</span><span class="op" id="4370525">;</span>&nbsp;<span class="ident" id="4370527">ri</span>&nbsp;<span class="op" id="4370530">!=</span>&nbsp;<span class="builtintype" id="4370533">nil</span>&nbsp;<span class="op" id="4370537">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4370543">n</span>&nbsp;<span class="op" id="4370545">!=</span>&nbsp;<span class="num" id="4370548">0</span>&nbsp;<span class="op" id="4370550">&amp;&amp;</span>&nbsp;<span class="ident" id="4370553">err</span>&nbsp;<span class="op" id="4370557">==</span>&nbsp;<span class="builtintype" id="4370560">nil</span>&nbsp;<span class="op" id="4370564">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4370570">c</span><span class="op" id="4370571">.</span><span class="ident" id="4370572">input</span>&nbsp;<span class="op" id="4370578">==</span>&nbsp;<span class="builtintype" id="4370581">nil</span>&nbsp;<span class="op" id="4370585">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4370588">len</span><span class="op" id="4370591">(</span><span class="ident" id="4370592">ri</span><span class="op" id="4370594">.</span><span class="ident" id="4370595">data</span><span class="op" id="4370599">)</span>&nbsp;<span class="op" id="4370601">&gt;</span>&nbsp;<span class="num" id="4370603">0</span>&nbsp;<span class="op" id="4370605">&amp;&amp;</span>&nbsp;<span class="ident" id="4370608">recordType</span><span class="op" id="4370618">(</span><span class="ident" id="4370619">ri</span><span class="op" id="4370621">.</span><span class="ident" id="4370622">data</span><span class="op" id="4370626">[</span><span class="num" id="4370627">0</span><span class="op" id="4370628">]</span><span class="op" id="4370629">)</span>&nbsp;<span class="op" id="4370631">==</span>&nbsp;<span class="ident" id="4370634">recordTypeAlert</span>&nbsp;<span class="op" id="4370650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4370655">if</span>&nbsp;<span class="ident" id="4370658">recErr</span>&nbsp;<span class="op" id="4370665">:=</span>&nbsp;<span class="ident" id="4370668">c</span><span class="op" id="4370669">.</span><span class="ident" id="4370670">readRecord</span><span class="op" id="4370680">(</span><span class="ident" id="4370681">recordTypeApplicationData</span><span class="op" id="4370706">)</span><span class="op" id="4370707">;</span>&nbsp;<span class="ident" id="4370709">recErr</span>&nbsp;<span class="op" id="4370716">!=</span>&nbsp;<span class="builtintype" id="4370719">nil</span>&nbsp;<span class="op" id="4370723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4370729">err</span>&nbsp;<span class="op" id="4370733">=</span>&nbsp;<span class="ident" id="4370735">recErr</span>&nbsp;<span class="comment" id="4370742">//&nbsp;will&nbsp;be&nbsp;io.EOF&nbsp;on&nbsp;closeNotify</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4370778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4370782">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4370787">if</span>&nbsp;<span class="ident" id="4370790">n</span>&nbsp;<span class="op" id="4370792">!=</span>&nbsp;<span class="num" id="4370795">0</span>&nbsp;<span class="op" id="4370797">||</span>&nbsp;<span class="ident" id="4370800">err</span>&nbsp;<span class="op" id="4370804">!=</span>&nbsp;<span class="builtintype" id="4370807">nil</span>&nbsp;<span class="op" id="4370811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4370816">return</span>&nbsp;<span class="ident" id="4370823">n</span><span class="op" id="4370824">,</span>&nbsp;<span class="ident" id="4370826">err</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4370832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4370835">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4370839">return</span>&nbsp;<span class="num" id="4370846">0</span><span class="op" id="4370847">,</span>&nbsp;<span class="ident" id="4370849">io</span><span class="op" id="4370851">.</span><span class="ident" id="4370852">ErrNoProgress</span><br>
<span class="lineno"></span><span class="op" id="4370866">}</span><br>
<span class="lineno">945</span><br>
<span class="lineno"></span><span class="comment" id="4370869">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4370901">func</span>&nbsp;<span class="op" id="4370906">(</span><span class="ident" id="4370907">c</span>&nbsp;<span class="op" id="4370909">*</span><span class="ident" id="4370910">Conn</span><span class="op" id="4370914">)</span>&nbsp;<span class="ident" id="4370916">Close</span><span class="op" id="4370921">(</span><span class="op" id="4370922">)</span>&nbsp;<span class="builtintype" id="4370924">error</span>&nbsp;<span class="op" id="4370930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4370933">var</span>&nbsp;<span class="ident" id="4370937">alertErr</span>&nbsp;<span class="builtintype" id="4370946">error</span><br>
<span class="lineno"></span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4370954">c</span><span class="op" id="4370955">.</span><span class="ident" id="4370956">handshakeMutex</span><span class="op" id="4370970">.</span><span class="ident" id="4370971">Lock</span><span class="op" id="4370975">(</span><span class="op" id="4370976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4370979">defer</span>&nbsp;<span class="ident" id="4370985">c</span><span class="op" id="4370986">.</span><span class="ident" id="4370987">handshakeMutex</span><span class="op" id="4371001">.</span><span class="ident" id="4371002">Unlock</span><span class="op" id="4371008">(</span><span class="op" id="4371009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4371012">if</span>&nbsp;<span class="ident" id="4371015">c</span><span class="op" id="4371016">.</span><span class="ident" id="4371017">handshakeComplete</span>&nbsp;<span class="op" id="4371035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4371039">alertErr</span>&nbsp;<span class="op" id="4371048">=</span>&nbsp;<span class="ident" id="4371050">c</span><span class="op" id="4371051">.</span><span class="ident" id="4371052">sendAlert</span><span class="op" id="4371061">(</span><span class="ident" id="4371062">alertCloseNotify</span><span class="op" id="4371078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4371081">}</span><br>
<span class="lineno">955</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4371085">if</span>&nbsp;<span class="ident" id="4371088">err</span>&nbsp;<span class="op" id="4371092">:=</span>&nbsp;<span class="ident" id="4371095">c</span><span class="op" id="4371096">.</span><span class="ident" id="4371097">conn</span><span class="op" id="4371101">.</span><span class="ident" id="4371102">Close</span><span class="op" id="4371107">(</span><span class="op" id="4371108">)</span><span class="op" id="4371109">;</span>&nbsp;<span class="ident" id="4371111">err</span>&nbsp;<span class="op" id="4371115">!=</span>&nbsp;<span class="builtintype" id="4371118">nil</span>&nbsp;<span class="op" id="4371122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4371126">return</span>&nbsp;<span class="ident" id="4371133">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4371138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4371141">return</span>&nbsp;<span class="ident" id="4371148">alertErr</span><br>
<span class="lineno">960</span><span class="op" id="4371157">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4371160">//&nbsp;Handshake&nbsp;runs&nbsp;the&nbsp;client&nbsp;or&nbsp;server&nbsp;handshake</span><br>
<span class="lineno"></span><span class="comment" id="4371209">//&nbsp;protocol&nbsp;if&nbsp;it&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;run.</span><br>
<span class="lineno"></span><span class="comment" id="4371249">//&nbsp;Most&nbsp;uses&nbsp;of&nbsp;this&nbsp;package&nbsp;need&nbsp;not&nbsp;call&nbsp;Handshake</span><br>
<span class="lineno">965</span><span class="comment" id="4371302">//&nbsp;explicitly:&nbsp;the&nbsp;first&nbsp;Read&nbsp;or&nbsp;Write&nbsp;will&nbsp;call&nbsp;it&nbsp;automatically.</span><br>
<span class="lineno"></span><span class="keyword" id="4371369">func</span>&nbsp;<span class="op" id="4371374">(</span><span class="ident" id="4371375">c</span>&nbsp;<span class="op" id="4371377">*</span><span class="ident" id="4371378">Conn</span><span class="op" id="4371382">)</span>&nbsp;<span class="ident" id="4371384">Handshake</span><span class="op" id="4371393">(</span><span class="op" id="4371394">)</span>&nbsp;<span class="builtintype" id="4371396">error</span>&nbsp;<span class="op" id="4371402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4371405">c</span><span class="op" id="4371406">.</span><span class="ident" id="4371407">handshakeMutex</span><span class="op" id="4371421">.</span><span class="ident" id="4371422">Lock</span><span class="op" id="4371426">(</span><span class="op" id="4371427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4371430">defer</span>&nbsp;<span class="ident" id="4371436">c</span><span class="op" id="4371437">.</span><span class="ident" id="4371438">handshakeMutex</span><span class="op" id="4371452">.</span><span class="ident" id="4371453">Unlock</span><span class="op" id="4371459">(</span><span class="op" id="4371460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4371463">if</span>&nbsp;<span class="ident" id="4371466">err</span>&nbsp;<span class="op" id="4371470">:=</span>&nbsp;<span class="ident" id="4371473">c</span><span class="op" id="4371474">.</span><span class="ident" id="4371475">handshakeErr</span><span class="op" id="4371487">;</span>&nbsp;<span class="ident" id="4371489">err</span>&nbsp;<span class="op" id="4371493">!=</span>&nbsp;<span class="builtintype" id="4371496">nil</span>&nbsp;<span class="op" id="4371500">{</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4371504">return</span>&nbsp;<span class="ident" id="4371511">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4371516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4371519">if</span>&nbsp;<span class="ident" id="4371522">c</span><span class="op" id="4371523">.</span><span class="ident" id="4371524">handshakeComplete</span>&nbsp;<span class="op" id="4371542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4371546">return</span>&nbsp;<span class="builtintype" id="4371553">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4371558">}</span><br>
<span class="lineno">975</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4371562">if</span>&nbsp;<span class="ident" id="4371565">c</span><span class="op" id="4371566">.</span><span class="ident" id="4371567">isClient</span>&nbsp;<span class="op" id="4371576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4371580">c</span><span class="op" id="4371581">.</span><span class="ident" id="4371582">handshakeErr</span>&nbsp;<span class="op" id="4371595">=</span>&nbsp;<span class="ident" id="4371597">c</span><span class="op" id="4371598">.</span><span class="ident" id="4371599">clientHandshake</span><span class="op" id="4371614">(</span><span class="op" id="4371615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4371618">}</span>&nbsp;<span class="keyword" id="4371620">else</span>&nbsp;<span class="op" id="4371625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4371629">c</span><span class="op" id="4371630">.</span><span class="ident" id="4371631">handshakeErr</span>&nbsp;<span class="op" id="4371644">=</span>&nbsp;<span class="ident" id="4371646">c</span><span class="op" id="4371647">.</span><span class="ident" id="4371648">serverHandshake</span><span class="op" id="4371663">(</span><span class="op" id="4371664">)</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4371667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4371670">return</span>&nbsp;<span class="ident" id="4371677">c</span><span class="op" id="4371678">.</span><span class="ident" id="4371679">handshakeErr</span><br>
<span class="lineno"></span><span class="op" id="4371692">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4371695">//&nbsp;ConnectionState&nbsp;returns&nbsp;basic&nbsp;TLS&nbsp;details&nbsp;about&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">985</span><span class="keyword" id="4371762">func</span>&nbsp;<span class="op" id="4371767">(</span><span class="ident" id="4371768">c</span>&nbsp;<span class="op" id="4371770">*</span><span class="ident" id="4371771">Conn</span><span class="op" id="4371775">)</span>&nbsp;<span class="ident" id="4371777">ConnectionState</span><span class="op" id="4371792">(</span><span class="op" id="4371793">)</span>&nbsp;<span class="ident" id="4371795">ConnectionState</span>&nbsp;<span class="op" id="4371811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4371814">c</span><span class="op" id="4371815">.</span><span class="ident" id="4371816">handshakeMutex</span><span class="op" id="4371830">.</span><span class="ident" id="4371831">Lock</span><span class="op" id="4371835">(</span><span class="op" id="4371836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4371839">defer</span>&nbsp;<span class="ident" id="4371845">c</span><span class="op" id="4371846">.</span><span class="ident" id="4371847">handshakeMutex</span><span class="op" id="4371861">.</span><span class="ident" id="4371862">Unlock</span><span class="op" id="4371868">(</span><span class="op" id="4371869">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4371873">var</span>&nbsp;<span class="ident" id="4371877">state</span>&nbsp;<span class="ident" id="4371883">ConnectionState</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4371900">state</span><span class="op" id="4371905">.</span><span class="ident" id="4371906">HandshakeComplete</span>&nbsp;<span class="op" id="4371924">=</span>&nbsp;<span class="ident" id="4371926">c</span><span class="op" id="4371927">.</span><span class="ident" id="4371928">handshakeComplete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4371947">if</span>&nbsp;<span class="ident" id="4371950">c</span><span class="op" id="4371951">.</span><span class="ident" id="4371952">handshakeComplete</span>&nbsp;<span class="op" id="4371970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4371974">state</span><span class="op" id="4371979">.</span><span class="ident" id="4371980">Version</span>&nbsp;<span class="op" id="4371988">=</span>&nbsp;<span class="ident" id="4371990">c</span><span class="op" id="4371991">.</span><span class="ident" id="4371992">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4371999">state</span><span class="op" id="4372004">.</span><span class="ident" id="4372005">NegotiatedProtocol</span>&nbsp;<span class="op" id="4372024">=</span>&nbsp;<span class="ident" id="4372026">c</span><span class="op" id="4372027">.</span><span class="ident" id="4372028">clientProtocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4372045">state</span><span class="op" id="4372050">.</span><span class="ident" id="4372051">DidResume</span>&nbsp;<span class="op" id="4372061">=</span>&nbsp;<span class="ident" id="4372063">c</span><span class="op" id="4372064">.</span><span class="ident" id="4372065">didResume</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4372077">state</span><span class="op" id="4372082">.</span><span class="ident" id="4372083">NegotiatedProtocolIsMutual</span>&nbsp;<span class="op" id="4372110">=</span>&nbsp;<span class="op" id="4372112">!</span><span class="ident" id="4372113">c</span><span class="op" id="4372114">.</span><span class="ident" id="4372115">clientProtocolFallback</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4372140">state</span><span class="op" id="4372145">.</span><span class="ident" id="4372146">CipherSuite</span>&nbsp;<span class="op" id="4372158">=</span>&nbsp;<span class="ident" id="4372160">c</span><span class="op" id="4372161">.</span><span class="ident" id="4372162">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4372176">state</span><span class="op" id="4372181">.</span><span class="ident" id="4372182">PeerCertificates</span>&nbsp;<span class="op" id="4372199">=</span>&nbsp;<span class="ident" id="4372201">c</span><span class="op" id="4372202">.</span><span class="ident" id="4372203">peerCertificates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4372222">state</span><span class="op" id="4372227">.</span><span class="ident" id="4372228">VerifiedChains</span>&nbsp;<span class="op" id="4372243">=</span>&nbsp;<span class="ident" id="4372245">c</span><span class="op" id="4372246">.</span><span class="ident" id="4372247">verifiedChains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4372264">state</span><span class="op" id="4372269">.</span><span class="ident" id="4372270">ServerName</span>&nbsp;<span class="op" id="4372281">=</span>&nbsp;<span class="ident" id="4372283">c</span><span class="op" id="4372284">.</span><span class="ident" id="4372285">serverName</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4372298">if</span>&nbsp;<span class="op" id="4372301">!</span><span class="ident" id="4372302">c</span><span class="op" id="4372303">.</span><span class="ident" id="4372304">didResume</span>&nbsp;<span class="op" id="4372314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4372319">state</span><span class="op" id="4372324">.</span><span class="ident" id="4372325">TLSUnique</span>&nbsp;<span class="op" id="4372335">=</span>&nbsp;<span class="ident" id="4372337">c</span><span class="op" id="4372338">.</span><span class="ident" id="4372339">firstFinished</span><span class="op" id="4372352">[</span><span class="op" id="4372353">:</span><span class="op" id="4372354">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4372358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4372361">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4372365">return</span>&nbsp;<span class="ident" id="4372372">state</span><br>
<span class="lineno"></span><span class="op" id="4372378">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4372381">//&nbsp;OCSPResponse&nbsp;returns&nbsp;the&nbsp;stapled&nbsp;OCSP&nbsp;response&nbsp;from&nbsp;the&nbsp;TLS&nbsp;server,&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="4372455">//&nbsp;any.&nbsp;(Only&nbsp;valid&nbsp;for&nbsp;client&nbsp;connections.)</span><br>
<span class="lineno">1010</span><span class="keyword" id="4372500">func</span>&nbsp;<span class="op" id="4372505">(</span><span class="ident" id="4372506">c</span>&nbsp;<span class="op" id="4372508">*</span><span class="ident" id="4372509">Conn</span><span class="op" id="4372513">)</span>&nbsp;<span class="ident" id="4372515">OCSPResponse</span><span class="op" id="4372527">(</span><span class="op" id="4372528">)</span>&nbsp;<span class="op" id="4372530">[</span><span class="op" id="4372531">]</span><span class="builtintype" id="4372532">byte</span>&nbsp;<span class="op" id="4372537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4372540">c</span><span class="op" id="4372541">.</span><span class="ident" id="4372542">handshakeMutex</span><span class="op" id="4372556">.</span><span class="ident" id="4372557">Lock</span><span class="op" id="4372561">(</span><span class="op" id="4372562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4372565">defer</span>&nbsp;<span class="ident" id="4372571">c</span><span class="op" id="4372572">.</span><span class="ident" id="4372573">handshakeMutex</span><span class="op" id="4372587">.</span><span class="ident" id="4372588">Unlock</span><span class="op" id="4372594">(</span><span class="op" id="4372595">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4372599">return</span>&nbsp;<span class="ident" id="4372606">c</span><span class="op" id="4372607">.</span><span class="ident" id="4372608">ocspResponse</span><br>
<span class="lineno">1015</span><span class="op" id="4372621">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4372624">//&nbsp;VerifyHostname&nbsp;checks&nbsp;that&nbsp;the&nbsp;peer&nbsp;certificate&nbsp;chain&nbsp;is&nbsp;valid&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="4372694">//&nbsp;connecting&nbsp;to&nbsp;host.&nbsp;&nbsp;If&nbsp;so,&nbsp;it&nbsp;returns&nbsp;nil;&nbsp;if&nbsp;not,&nbsp;it&nbsp;returns&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="4372769">//&nbsp;describing&nbsp;the&nbsp;problem.</span><br>
<span class="lineno">1020</span><span class="keyword" id="4372796">func</span>&nbsp;<span class="op" id="4372801">(</span><span class="ident" id="4372802">c</span>&nbsp;<span class="op" id="4372804">*</span><span class="ident" id="4372805">Conn</span><span class="op" id="4372809">)</span>&nbsp;<span class="ident" id="4372811">VerifyHostname</span><span class="op" id="4372825">(</span><span class="ident" id="4372826">host</span>&nbsp;<span class="builtintype" id="4372831">string</span><span class="op" id="4372837">)</span>&nbsp;<span class="builtintype" id="4372839">error</span>&nbsp;<span class="op" id="4372845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4372848">c</span><span class="op" id="4372849">.</span><span class="ident" id="4372850">handshakeMutex</span><span class="op" id="4372864">.</span><span class="ident" id="4372865">Lock</span><span class="op" id="4372869">(</span><span class="op" id="4372870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4372873">defer</span>&nbsp;<span class="ident" id="4372879">c</span><span class="op" id="4372880">.</span><span class="ident" id="4372881">handshakeMutex</span><span class="op" id="4372895">.</span><span class="ident" id="4372896">Unlock</span><span class="op" id="4372902">(</span><span class="op" id="4372903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4372906">if</span>&nbsp;<span class="op" id="4372909">!</span><span class="ident" id="4372910">c</span><span class="op" id="4372911">.</span><span class="ident" id="4372912">isClient</span>&nbsp;<span class="op" id="4372921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4372925">return</span>&nbsp;<span class="ident" id="4372932">errors</span><span class="op" id="4372938">.</span><span class="ident" id="4372939">New</span><span class="op" id="4372942">(</span><span class="string" id="4372943">&#34;tls:&nbsp;VerifyHostname&nbsp;called&nbsp;on&nbsp;TLS&nbsp;server&nbsp;connection&#34;</span><span class="op" id="4372996">)</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4372999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4373002">if</span>&nbsp;<span class="op" id="4373005">!</span><span class="ident" id="4373006">c</span><span class="op" id="4373007">.</span><span class="ident" id="4373008">handshakeComplete</span>&nbsp;<span class="op" id="4373026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4373030">return</span>&nbsp;<span class="ident" id="4373037">errors</span><span class="op" id="4373043">.</span><span class="ident" id="4373044">New</span><span class="op" id="4373047">(</span><span class="string" id="4373048">&#34;tls:&nbsp;handshake&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;performed&#34;</span><span class="op" id="4373091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4373094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4373097">return</span>&nbsp;<span class="ident" id="4373104">c</span><span class="op" id="4373105">.</span><span class="ident" id="4373106">peerCertificates</span><span class="op" id="4373122">[</span><span class="num" id="4373123">0</span><span class="op" id="4373124">]</span><span class="op" id="4373125">.</span><span class="ident" id="4373126">VerifyHostname</span><span class="op" id="4373140">(</span><span class="ident" id="4373141">host</span><span class="op" id="4373145">)</span><br>
<span class="lineno">1030</span><span class="op" id="4373147">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
