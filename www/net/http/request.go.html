<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment">//&nbsp;HTTP&nbsp;Request&nbsp;reading&nbsp;and&nbsp;parsing.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">package</span>&nbsp;<span class="ident">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;encoding/base64&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;mime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;mime/multipart&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;sync&#34;</span><br>
<span class="lineno">25</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">const</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">maxValueLength</span>&nbsp;&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="num">4096</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">maxHeaderLines</span>&nbsp;&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="num">1024</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">chunkSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="num">4</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="num">10</span>&nbsp;&nbsp;<span class="comment">//&nbsp;4&nbsp;KB&nbsp;chunks</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">defaultMaxMemory</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">32</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="num">20</span>&nbsp;<span class="comment">//&nbsp;32&nbsp;MB</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ErrMissingFile&nbsp;is&nbsp;returned&nbsp;by&nbsp;FormFile&nbsp;when&nbsp;the&nbsp;provided&nbsp;file&nbsp;field&nbsp;name</span><br>
<span class="lineno">35</span><span class="comment">//&nbsp;is&nbsp;either&nbsp;not&nbsp;present&nbsp;in&nbsp;the&nbsp;request&nbsp;or&nbsp;not&nbsp;a&nbsp;file&nbsp;field.</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">ErrMissingFile</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;http:&nbsp;no&nbsp;such&nbsp;file&#34;</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;HTTP&nbsp;request&nbsp;parsing&nbsp;errors.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">ProtocolError</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ErrorString</span>&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">err</span>&nbsp;<span class="op">*</span><span class="ident">ProtocolError</span><span class="op">)</span>&nbsp;<span class="ident">Error</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span>&nbsp;<span class="keyword">return</span>&nbsp;<span class="ident">err</span><span class="op">.</span><span class="ident">ErrorString</span>&nbsp;<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword">var</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ErrHeaderTooLong</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="op">&amp;</span><span class="ident">ProtocolError</span><span class="op">{</span><span class="string">&#34;header&nbsp;too&nbsp;long&#34;</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ErrShortBody</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="op">&amp;</span><span class="ident">ProtocolError</span><span class="op">{</span><span class="string">&#34;entity&nbsp;body&nbsp;too&nbsp;short&#34;</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ErrNotSupported</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="op">&amp;</span><span class="ident">ProtocolError</span><span class="op">{</span><span class="string">&#34;feature&nbsp;not&nbsp;supported&#34;</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ErrUnexpectedTrailer</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="op">&amp;</span><span class="ident">ProtocolError</span><span class="op">{</span><span class="string">&#34;trailer&nbsp;header&nbsp;without&nbsp;chunked&nbsp;transfer&nbsp;encoding&#34;</span><span class="op">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ErrMissingContentLength</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">&amp;</span><span class="ident">ProtocolError</span><span class="op">{</span><span class="string">&#34;missing&nbsp;ContentLength&nbsp;in&nbsp;HEAD&nbsp;response&#34;</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ErrNotMultipart</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="op">&amp;</span><span class="ident">ProtocolError</span><span class="op">{</span><span class="string">&#34;request&nbsp;Content-Type&nbsp;isn&#39;t&nbsp;multipart/form-data&#34;</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ErrMissingBoundary</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="op">&amp;</span><span class="ident">ProtocolError</span><span class="op">{</span><span class="string">&#34;no&nbsp;multipart&nbsp;boundary&nbsp;param&nbsp;in&nbsp;Content-Type&#34;</span><span class="op">}</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword">type</span>&nbsp;<span class="ident">badStringError</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">what</span>&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">str</span>&nbsp;&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">e</span>&nbsp;<span class="op">*</span><span class="ident">badStringError</span><span class="op">)</span>&nbsp;<span class="ident">Error</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span>&nbsp;<span class="keyword">return</span>&nbsp;<span class="ident">fmt</span><span class="op">.</span><span class="ident">Sprintf</span><span class="op">(</span><span class="string">&#34;%s&nbsp;%q&#34;</span><span class="op">,</span>&nbsp;<span class="ident">e</span><span class="op">.</span><span class="ident">what</span><span class="op">,</span>&nbsp;<span class="ident">e</span><span class="op">.</span><span class="ident">str</span><span class="op">)</span>&nbsp;<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Headers&nbsp;that&nbsp;Request.Write&nbsp;handles&nbsp;itself&nbsp;and&nbsp;should&nbsp;be&nbsp;skipped.</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">reqWriteExcludeHeader</span>&nbsp;<span class="op">=</span>&nbsp;<span class="keyword">map</span><span class="op">[</span><span class="builtintype">string</span><span class="op">]</span><span class="builtintype">bool</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;Host&#34;</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">true</span><span class="op">,</span>&nbsp;<span class="comment">//&nbsp;not&nbsp;in&nbsp;Header&nbsp;map&nbsp;anyway</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;User-Agent&#34;</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">true</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;Content-Length&#34;</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">true</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;Transfer-Encoding&#34;</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;Trailer&#34;</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">true</span><span class="op">,</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;A&nbsp;Request&nbsp;represents&nbsp;an&nbsp;HTTP&nbsp;request&nbsp;received&nbsp;by&nbsp;a&nbsp;server</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;or&nbsp;to&nbsp;be&nbsp;sent&nbsp;by&nbsp;a&nbsp;client.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;field&nbsp;semantics&nbsp;differ&nbsp;slightly&nbsp;between&nbsp;client&nbsp;and&nbsp;server</span><br>
<span class="lineno">75</span><span class="comment">//&nbsp;usage.&nbsp;In&nbsp;addition&nbsp;to&nbsp;the&nbsp;notes&nbsp;on&nbsp;the&nbsp;fields&nbsp;below,&nbsp;see&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;documentation&nbsp;for&nbsp;Request.Write&nbsp;and&nbsp;RoundTripper.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">Request</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Method&nbsp;specifies&nbsp;the&nbsp;HTTP&nbsp;method&nbsp;(GET,&nbsp;POST,&nbsp;PUT,&nbsp;etc.).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;For&nbsp;client&nbsp;requests&nbsp;an&nbsp;empty&nbsp;string&nbsp;means&nbsp;GET.</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Method</span>&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;URL&nbsp;specifies&nbsp;either&nbsp;the&nbsp;URI&nbsp;being&nbsp;requested&nbsp;(for&nbsp;server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;requests)&nbsp;or&nbsp;the&nbsp;URL&nbsp;to&nbsp;access&nbsp;(for&nbsp;client&nbsp;requests).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;For&nbsp;server&nbsp;requests&nbsp;the&nbsp;URL&nbsp;is&nbsp;parsed&nbsp;from&nbsp;the&nbsp;URI</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;supplied&nbsp;on&nbsp;the&nbsp;Request-Line&nbsp;as&nbsp;stored&nbsp;in&nbsp;RequestURI.&nbsp;&nbsp;For</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;most&nbsp;requests,&nbsp;fields&nbsp;other&nbsp;than&nbsp;Path&nbsp;and&nbsp;RawQuery&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;empty.&nbsp;(See&nbsp;RFC&nbsp;2616,&nbsp;Section&nbsp;5.1.2)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;For&nbsp;client&nbsp;requests,&nbsp;the&nbsp;URL&#39;s&nbsp;Host&nbsp;specifies&nbsp;the&nbsp;server&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;connect&nbsp;to,&nbsp;while&nbsp;the&nbsp;Request&#39;s&nbsp;Host&nbsp;field&nbsp;optionally</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;specifies&nbsp;the&nbsp;Host&nbsp;header&nbsp;value&nbsp;to&nbsp;send&nbsp;in&nbsp;the&nbsp;HTTP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">URL</span>&nbsp;<span class="op">*</span><span class="ident">url</span><span class="op">.</span><span class="ident">URL</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;protocol&nbsp;version&nbsp;for&nbsp;incoming&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Client&nbsp;requests&nbsp;always&nbsp;use&nbsp;HTTP/1.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Proto</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">string</span>&nbsp;<span class="comment">//&nbsp;&#34;HTTP/1.0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ProtoMajor</span>&nbsp;<span class="builtintype">int</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;1</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ProtoMinor</span>&nbsp;<span class="builtintype">int</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;A&nbsp;header&nbsp;maps&nbsp;request&nbsp;lines&nbsp;to&nbsp;their&nbsp;values.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;If&nbsp;the&nbsp;header&nbsp;says</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;&nbspaccept-encoding:&nbsp;gzip,&nbsp;deflate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;&nbspAccept-Language:&nbsp;en-us</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;&nbspConnection:&nbsp;keep-alive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;then</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;&nbspHeader&nbsp;=&nbsp;map[string][]string{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;Accept-Encoding&#34;:&nbsp;{&#34;gzip,&nbsp;deflate&#34;},</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;Accept-Language&#34;:&nbsp;{&#34;en-us&#34;},</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;Connection&#34;:&nbsp;{&#34;keep-alive&#34;},</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;HTTP&nbsp;defines&nbsp;that&nbsp;header&nbsp;names&nbsp;are&nbsp;case-insensitive.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;request&nbsp;parser&nbsp;implements&nbsp;this&nbsp;by&nbsp;canonicalizing&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;name,&nbsp;making&nbsp;the&nbsp;first&nbsp;character&nbsp;and&nbsp;any&nbsp;characters</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;following&nbsp;a&nbsp;hyphen&nbsp;uppercase&nbsp;and&nbsp;the&nbsp;rest&nbsp;lowercase.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;For&nbsp;client&nbsp;requests&nbsp;certain&nbsp;headers&nbsp;are&nbsp;automatically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;added&nbsp;and&nbsp;may&nbsp;override&nbsp;values&nbsp;in&nbsp;Header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;See&nbsp;the&nbsp;documentation&nbsp;for&nbsp;the&nbsp;Request.Write&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Header</span>&nbsp;<span class="ident">Header</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Body&nbsp;is&nbsp;the&nbsp;request&#39;s&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;For&nbsp;client&nbsp;requests&nbsp;a&nbsp;nil&nbsp;body&nbsp;means&nbsp;the&nbsp;request&nbsp;has&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;body,&nbsp;such&nbsp;as&nbsp;a&nbsp;GET&nbsp;request.&nbsp;The&nbsp;HTTP&nbsp;Client&#39;s&nbsp;Transport</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;is&nbsp;responsible&nbsp;for&nbsp;calling&nbsp;the&nbsp;Close&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;For&nbsp;server&nbsp;requests&nbsp;the&nbsp;Request&nbsp;Body&nbsp;is&nbsp;always&nbsp;non-nil</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;but&nbsp;will&nbsp;return&nbsp;EOF&nbsp;immediately&nbsp;when&nbsp;no&nbsp;body&nbsp;is&nbsp;present.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;Server&nbsp;will&nbsp;close&nbsp;the&nbsp;request&nbsp;body.&nbsp;The&nbsp;ServeHTTP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Handler&nbsp;does&nbsp;not&nbsp;need&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Body</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">ReadCloser</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;ContentLength&nbsp;records&nbsp;the&nbsp;length&nbsp;of&nbsp;the&nbsp;associated&nbsp;content.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;value&nbsp;-1&nbsp;indicates&nbsp;that&nbsp;the&nbsp;length&nbsp;is&nbsp;unknown.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Values&nbsp;&gt;=&nbsp;0&nbsp;indicate&nbsp;that&nbsp;the&nbsp;given&nbsp;number&nbsp;of&nbsp;bytes&nbsp;may</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;be&nbsp;read&nbsp;from&nbsp;Body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;For&nbsp;client&nbsp;requests,&nbsp;a&nbsp;value&nbsp;of&nbsp;0&nbsp;means&nbsp;unknown&nbsp;if&nbsp;Body&nbsp;is&nbsp;not&nbsp;nil.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ContentLength</span>&nbsp;<span class="ident">int64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;TransferEncoding&nbsp;lists&nbsp;the&nbsp;transfer&nbsp;encodings&nbsp;from&nbsp;outermost&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;innermost.&nbsp;An&nbsp;empty&nbsp;list&nbsp;denotes&nbsp;the&nbsp;&#34;identity&#34;&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;TransferEncoding&nbsp;can&nbsp;usually&nbsp;be&nbsp;ignored;&nbsp;chunked&nbsp;encoding&nbsp;is</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;automatically&nbsp;added&nbsp;and&nbsp;removed&nbsp;as&nbsp;necessary&nbsp;when&nbsp;sending&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;receiving&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">TransferEncoding</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Close&nbsp;indicates&nbsp;whether&nbsp;to&nbsp;close&nbsp;the&nbsp;connection&nbsp;after</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;replying&nbsp;to&nbsp;this&nbsp;request&nbsp;(for&nbsp;servers)&nbsp;or&nbsp;after&nbsp;sending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;the&nbsp;request&nbsp;(for&nbsp;clients).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Close</span>&nbsp;<span class="builtintype">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;For&nbsp;server&nbsp;requests&nbsp;Host&nbsp;specifies&nbsp;the&nbsp;host&nbsp;on&nbsp;which&nbsp;the</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;URL&nbsp;is&nbsp;sought.&nbsp;Per&nbsp;RFC&nbsp;2616,&nbsp;this&nbsp;is&nbsp;either&nbsp;the&nbsp;value&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;the&nbsp;&#34;Host&#34;&nbsp;header&nbsp;or&nbsp;the&nbsp;host&nbsp;name&nbsp;given&nbsp;in&nbsp;the&nbsp;URL&nbsp;itself.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;It&nbsp;may&nbsp;be&nbsp;of&nbsp;the&nbsp;form&nbsp;&#34;host:port&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;For&nbsp;client&nbsp;requests&nbsp;Host&nbsp;optionally&nbsp;overrides&nbsp;the&nbsp;Host</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;header&nbsp;to&nbsp;send.&nbsp;If&nbsp;empty,&nbsp;the&nbsp;Request.Write&nbsp;method&nbsp;uses</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;the&nbsp;value&nbsp;of&nbsp;URL.Host.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Host</span>&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Form&nbsp;contains&nbsp;the&nbsp;parsed&nbsp;form&nbsp;data,&nbsp;including&nbsp;both&nbsp;the&nbsp;URL</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;field&#39;s&nbsp;query&nbsp;parameters&nbsp;and&nbsp;the&nbsp;POST&nbsp;or&nbsp;PUT&nbsp;form&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;This&nbsp;field&nbsp;is&nbsp;only&nbsp;available&nbsp;after&nbsp;ParseForm&nbsp;is&nbsp;called.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;HTTP&nbsp;client&nbsp;ignores&nbsp;Form&nbsp;and&nbsp;uses&nbsp;Body&nbsp;instead.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Form</span>&nbsp;<span class="ident">url</span><span class="op">.</span><span class="ident">Values</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;PostForm&nbsp;contains&nbsp;the&nbsp;parsed&nbsp;form&nbsp;data&nbsp;from&nbsp;POST&nbsp;or&nbsp;PUT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;body&nbsp;parameters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;This&nbsp;field&nbsp;is&nbsp;only&nbsp;available&nbsp;after&nbsp;ParseForm&nbsp;is&nbsp;called.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;HTTP&nbsp;client&nbsp;ignores&nbsp;PostForm&nbsp;and&nbsp;uses&nbsp;Body&nbsp;instead.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">PostForm</span>&nbsp;<span class="ident">url</span><span class="op">.</span><span class="ident">Values</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;MultipartForm&nbsp;is&nbsp;the&nbsp;parsed&nbsp;multipart&nbsp;form,&nbsp;including&nbsp;file&nbsp;uploads.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;This&nbsp;field&nbsp;is&nbsp;only&nbsp;available&nbsp;after&nbsp;ParseMultipartForm&nbsp;is&nbsp;called.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;HTTP&nbsp;client&nbsp;ignores&nbsp;MultipartForm&nbsp;and&nbsp;uses&nbsp;Body&nbsp;instead.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">MultipartForm</span>&nbsp;<span class="op">*</span><span class="ident">multipart</span><span class="op">.</span><span class="ident">Form</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Trailer&nbsp;specifies&nbsp;additional&nbsp;headers&nbsp;that&nbsp;are&nbsp;sent&nbsp;after&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;For&nbsp;server&nbsp;requests&nbsp;the&nbsp;Trailer&nbsp;map&nbsp;initially&nbsp;contains&nbsp;only&nbsp;the</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;trailer&nbsp;keys,&nbsp;with&nbsp;nil&nbsp;values.&nbsp;(The&nbsp;client&nbsp;declares&nbsp;which&nbsp;trailers&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;will&nbsp;later&nbsp;send.)&nbsp;&nbsp;While&nbsp;the&nbsp;handler&nbsp;is&nbsp;reading&nbsp;from&nbsp;Body,&nbsp;it&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;not&nbsp;reference&nbsp;Trailer.&nbsp;After&nbsp;reading&nbsp;from&nbsp;Body&nbsp;returns&nbsp;EOF,&nbsp;Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;can&nbsp;be&nbsp;read&nbsp;again&nbsp;and&nbsp;will&nbsp;contain&nbsp;non-nil&nbsp;values,&nbsp;if&nbsp;they&nbsp;were&nbsp;sent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;by&nbsp;the&nbsp;client.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;For&nbsp;client&nbsp;requests&nbsp;Trailer&nbsp;must&nbsp;be&nbsp;initialized&nbsp;to&nbsp;a&nbsp;map&nbsp;containing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;the&nbsp;trailer&nbsp;keys&nbsp;to&nbsp;later&nbsp;send.&nbsp;The&nbsp;values&nbsp;may&nbsp;be&nbsp;nil&nbsp;or&nbsp;their&nbsp;final</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;values.&nbsp;The&nbsp;ContentLength&nbsp;must&nbsp;be&nbsp;0&nbsp;or&nbsp;-1,&nbsp;to&nbsp;send&nbsp;a&nbsp;chunked&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;After&nbsp;the&nbsp;HTTP&nbsp;request&nbsp;is&nbsp;sent&nbsp;the&nbsp;map&nbsp;values&nbsp;can&nbsp;be&nbsp;updated&nbsp;while</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;the&nbsp;request&nbsp;body&nbsp;is&nbsp;read.&nbsp;Once&nbsp;the&nbsp;body&nbsp;returns&nbsp;EOF,&nbsp;the&nbsp;caller&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;not&nbsp;mutate&nbsp;Trailer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Few&nbsp;HTTP&nbsp;clients,&nbsp;servers,&nbsp;or&nbsp;proxies&nbsp;support&nbsp;HTTP&nbsp;trailers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Trailer</span>&nbsp;<span class="ident">Header</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;RemoteAddr&nbsp;allows&nbsp;HTTP&nbsp;servers&nbsp;and&nbsp;other&nbsp;software&nbsp;to&nbsp;record</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;the&nbsp;network&nbsp;address&nbsp;that&nbsp;sent&nbsp;the&nbsp;request,&nbsp;usually&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;logging.&nbsp;This&nbsp;field&nbsp;is&nbsp;not&nbsp;filled&nbsp;in&nbsp;by&nbsp;ReadRequest&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;has&nbsp;no&nbsp;defined&nbsp;format.&nbsp;The&nbsp;HTTP&nbsp;server&nbsp;in&nbsp;this&nbsp;package</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;sets&nbsp;RemoteAddr&nbsp;to&nbsp;an&nbsp;&#34;IP:port&#34;&nbsp;address&nbsp;before&nbsp;invoking&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;handler.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;This&nbsp;field&nbsp;is&nbsp;ignored&nbsp;by&nbsp;the&nbsp;HTTP&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">RemoteAddr</span>&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;RequestURI&nbsp;is&nbsp;the&nbsp;unmodified&nbsp;Request-URI&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Request-Line&nbsp;(RFC&nbsp;2616,&nbsp;Section&nbsp;5.1)&nbsp;as&nbsp;sent&nbsp;by&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;to&nbsp;a&nbsp;server.&nbsp;Usually&nbsp;the&nbsp;URL&nbsp;field&nbsp;should&nbsp;be&nbsp;used&nbsp;instead.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;It&nbsp;is&nbsp;an&nbsp;error&nbsp;to&nbsp;set&nbsp;this&nbsp;field&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;client&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">RequestURI</span>&nbsp;<span class="builtintype">string</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;TLS&nbsp;allows&nbsp;HTTP&nbsp;servers&nbsp;and&nbsp;other&nbsp;software&nbsp;to&nbsp;record</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;information&nbsp;about&nbsp;the&nbsp;TLS&nbsp;connection&nbsp;on&nbsp;which&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;was&nbsp;received.&nbsp;This&nbsp;field&nbsp;is&nbsp;not&nbsp;filled&nbsp;in&nbsp;by&nbsp;ReadRequest.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;HTTP&nbsp;server&nbsp;in&nbsp;this&nbsp;package&nbsp;sets&nbsp;the&nbsp;field&nbsp;for</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;TLS-enabled&nbsp;connections&nbsp;before&nbsp;invoking&nbsp;a&nbsp;handler;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;otherwise&nbsp;it&nbsp;leaves&nbsp;the&nbsp;field&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;This&nbsp;field&nbsp;is&nbsp;ignored&nbsp;by&nbsp;the&nbsp;HTTP&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">TLS</span>&nbsp;<span class="op">*</span><span class="ident">tls</span><span class="op">.</span><span class="ident">ConnectionState</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ProtoAtLeast&nbsp;reports&nbsp;whether&nbsp;the&nbsp;HTTP&nbsp;protocol&nbsp;used</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;in&nbsp;the&nbsp;request&nbsp;is&nbsp;at&nbsp;least&nbsp;major.minor.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">Request</span><span class="op">)</span>&nbsp;<span class="ident">ProtoAtLeast</span><span class="op">(</span><span class="ident">major</span><span class="op">,</span>&nbsp;<span class="ident">minor</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ProtoMajor</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">major</span>&nbsp;<span class="op">||</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">.</span><span class="ident">ProtoMajor</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">major</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ProtoMinor</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="ident">minor</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;UserAgent&nbsp;returns&nbsp;the&nbsp;client&#39;s&nbsp;User-Agent,&nbsp;if&nbsp;sent&nbsp;in&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">Request</span><span class="op">)</span>&nbsp;<span class="ident">UserAgent</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">Header</span><span class="op">.</span><span class="ident">Get</span><span class="op">(</span><span class="string">&#34;User-Agent&#34;</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Cookies&nbsp;parses&nbsp;and&nbsp;returns&nbsp;the&nbsp;HTTP&nbsp;cookies&nbsp;sent&nbsp;with&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">Request</span><span class="op">)</span>&nbsp;<span class="ident">Cookies</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="op">*</span><span class="ident">Cookie</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">readCookies</span><span class="op">(</span><span class="ident">r</span><span class="op">.</span><span class="ident">Header</span><span class="op">,</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">ErrNoCookie</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;http:&nbsp;named&nbsp;cookie&nbsp;not&nbsp;present&#34;</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span><span class="comment">//&nbsp;Cookie&nbsp;returns&nbsp;the&nbsp;named&nbsp;cookie&nbsp;provided&nbsp;in&nbsp;the&nbsp;request&nbsp;or</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ErrNoCookie&nbsp;if&nbsp;not&nbsp;found.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">Request</span><span class="op">)</span>&nbsp;<span class="ident">Cookie</span><span class="op">(</span><span class="ident">name</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">Cookie</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">c</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">readCookies</span><span class="op">(</span><span class="ident">r</span><span class="op">.</span><span class="ident">Header</span><span class="op">,</span>&nbsp;<span class="ident">name</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">ErrNoCookie</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;AddCookie&nbsp;adds&nbsp;a&nbsp;cookie&nbsp;to&nbsp;the&nbsp;request.&nbsp;&nbsp;Per&nbsp;RFC&nbsp;6265&nbsp;section&nbsp;5.4,</span><br>
<span class="lineno">260</span><span class="comment">//&nbsp;AddCookie&nbsp;does&nbsp;not&nbsp;attach&nbsp;more&nbsp;than&nbsp;one&nbsp;Cookie&nbsp;header&nbsp;field.&nbsp;&nbsp;That</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;means&nbsp;all&nbsp;cookies,&nbsp;if&nbsp;any,&nbsp;are&nbsp;written&nbsp;into&nbsp;the&nbsp;same&nbsp;line,</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;separated&nbsp;by&nbsp;semicolon.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">Request</span><span class="op">)</span>&nbsp;<span class="ident">AddCookie</span><span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">Cookie</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">fmt</span><span class="op">.</span><span class="ident">Sprintf</span><span class="op">(</span><span class="string">&#34;%s=%s&#34;</span><span class="op">,</span>&nbsp;<span class="ident">sanitizeCookieName</span><span class="op">(</span><span class="ident">c</span><span class="op">.</span><span class="ident">Name</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">sanitizeCookieValue</span><span class="op">(</span><span class="ident">c</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">c</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">Header</span><span class="op">.</span><span class="ident">Get</span><span class="op">(</span><span class="string">&#34;Cookie&#34;</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">c</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="string">&#34;&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">.</span><span class="ident">Header</span><span class="op">.</span><span class="ident">Set</span><span class="op">(</span><span class="string">&#34;Cookie&#34;</span><span class="op">,</span>&nbsp;<span class="ident">c</span><span class="op">+</span><span class="string">&#34;;&nbsp;&#34;</span><span class="op">+</span><span class="ident">s</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">.</span><span class="ident">Header</span><span class="op">.</span><span class="ident">Set</span><span class="op">(</span><span class="string">&#34;Cookie&#34;</span><span class="op">,</span>&nbsp;<span class="ident">s</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">270</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Referer&nbsp;returns&nbsp;the&nbsp;referring&nbsp;URL,&nbsp;if&nbsp;sent&nbsp;in&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Referer&nbsp;is&nbsp;misspelled&nbsp;as&nbsp;in&nbsp;the&nbsp;request&nbsp;itself,&nbsp;a&nbsp;mistake&nbsp;from&nbsp;the</span><br>
<span class="lineno">275</span><span class="comment">//&nbsp;earliest&nbsp;days&nbsp;of&nbsp;HTTP.&nbsp;&nbsp;This&nbsp;value&nbsp;can&nbsp;also&nbsp;be&nbsp;fetched&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Header&nbsp;map&nbsp;as&nbsp;Header[&#34;Referer&#34;];&nbsp;the&nbsp;benefit&nbsp;of&nbsp;making&nbsp;it&nbsp;available</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;as&nbsp;a&nbsp;method&nbsp;is&nbsp;that&nbsp;the&nbsp;compiler&nbsp;can&nbsp;diagnose&nbsp;programs&nbsp;that&nbsp;use&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;alternate&nbsp;(correct&nbsp;English)&nbsp;spelling&nbsp;req.Referrer()&nbsp;but&nbsp;cannot</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;diagnose&nbsp;programs&nbsp;that&nbsp;use&nbsp;Header[&#34;Referrer&#34;].</span><br>
<span class="lineno">280</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">Request</span><span class="op">)</span>&nbsp;<span class="ident">Referer</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">Header</span><span class="op">.</span><span class="ident">Get</span><span class="op">(</span><span class="string">&#34;Referer&#34;</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;multipartByReader&nbsp;is&nbsp;a&nbsp;sentinel&nbsp;value.</span><br>
<span class="lineno">285</span><span class="comment">//&nbsp;Its&nbsp;presence&nbsp;in&nbsp;Request.MultipartForm&nbsp;indicates&nbsp;that&nbsp;parsing&nbsp;of&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;body&nbsp;has&nbsp;been&nbsp;handed&nbsp;off&nbsp;to&nbsp;a&nbsp;MultipartReader&nbsp;instead&nbsp;of&nbsp;ParseMultipartFrom.</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">multipartByReader</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">&amp;</span><span class="ident">multipart</span><span class="op">.</span><span class="ident">Form</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Value</span><span class="op">:</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">map</span><span class="op">[</span><span class="builtintype">string</span><span class="op">]</span><span class="op">[</span><span class="op">]</span><span class="builtintype">string</span><span class="op">)</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">File</span><span class="op">:</span>&nbsp;&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">map</span><span class="op">[</span><span class="builtintype">string</span><span class="op">]</span><span class="op">[</span><span class="op">]</span><span class="op">*</span><span class="ident">multipart</span><span class="op">.</span><span class="ident">FileHeader</span><span class="op">)</span><span class="op">,</span><br>
<span class="lineno">290</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;MultipartReader&nbsp;returns&nbsp;a&nbsp;MIME&nbsp;multipart&nbsp;reader&nbsp;if&nbsp;this&nbsp;is&nbsp;a</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;multipart/form-data&nbsp;POST&nbsp;request,&nbsp;else&nbsp;returns&nbsp;nil&nbsp;and&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;this&nbsp;function&nbsp;instead&nbsp;of&nbsp;ParseMultipartForm&nbsp;to</span><br>
<span class="lineno">295</span><span class="comment">//&nbsp;process&nbsp;the&nbsp;request&nbsp;body&nbsp;as&nbsp;a&nbsp;stream.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">Request</span><span class="op">)</span>&nbsp;<span class="ident">MultipartReader</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">multipart</span><span class="op">.</span><span class="ident">Reader</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">MultipartForm</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">multipartByReader</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;http:&nbsp;MultipartReader&nbsp;called&nbsp;twice&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">MultipartForm</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;http:&nbsp;multipart&nbsp;handled&nbsp;by&nbsp;ParseMultipartForm&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">.</span><span class="ident">MultipartForm</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">multipartByReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">multipartReader</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">305</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">Request</span><span class="op">)</span>&nbsp;<span class="ident">multipartReader</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">multipart</span><span class="op">.</span><span class="ident">Reader</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">Header</span><span class="op">.</span><span class="ident">Get</span><span class="op">(</span><span class="string">&#34;Content-Type&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">ErrNotMultipart</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span><span class="op">,</span>&nbsp;<span class="ident">params</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">mime</span><span class="op">.</span><span class="ident">ParseMediaType</span><span class="op">(</span><span class="ident">v</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">d</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="string">&#34;multipart/form-data&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">ErrNotMultipart</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">boundary</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">params</span><span class="op">[</span><span class="string">&#34;boundary&#34;</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">ErrMissingBoundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">multipart</span><span class="op">.</span><span class="ident">NewReader</span><span class="op">(</span><span class="ident">r</span><span class="op">.</span><span class="ident">Body</span><span class="op">,</span>&nbsp;<span class="ident">boundary</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Return&nbsp;value&nbsp;if&nbsp;nonempty,&nbsp;def&nbsp;otherwise.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">valueOrDefault</span><span class="op">(</span><span class="ident">value</span><span class="op">,</span>&nbsp;<span class="ident">def</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="string">&#34;&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">def</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;NOTE:&nbsp;This&nbsp;is&nbsp;not&nbsp;intended&nbsp;to&nbsp;reflect&nbsp;the&nbsp;actual&nbsp;Go&nbsp;version&nbsp;being&nbsp;used.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;It&nbsp;was&nbsp;changed&nbsp;from&nbsp;&#34;Go&nbsp;http&nbsp;package&#34;&nbsp;to&nbsp;&#34;Go&nbsp;1.1&nbsp;package&nbsp;http&#34;&nbsp;at&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;time&nbsp;of&nbsp;the&nbsp;Go&nbsp;1.1&nbsp;release&nbsp;because&nbsp;the&nbsp;former&nbsp;User-Agent&nbsp;had&nbsp;ended&nbsp;up</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;on&nbsp;a&nbsp;blacklist&nbsp;for&nbsp;some&nbsp;intrusion&nbsp;detection&nbsp;systems.</span><br>
<span class="lineno">335</span><span class="comment">//&nbsp;See&nbsp;https://codereview.appspot.com/7532043.</span><br>
<span class="lineno"></span><span class="keyword">const</span>&nbsp;<span class="ident">defaultUserAgent</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#34;Go&nbsp;1.1&nbsp;package&nbsp;http&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Write&nbsp;writes&nbsp;an&nbsp;HTTP/1.1&nbsp;request&nbsp;--&nbsp;header&nbsp;and&nbsp;body&nbsp;--&nbsp;in&nbsp;wire&nbsp;format.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;This&nbsp;method&nbsp;consults&nbsp;the&nbsp;following&nbsp;fields&nbsp;of&nbsp;the&nbsp;request:</span><br>
<span class="lineno">340</span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbspHost</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbspURL</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbspMethod&nbsp;(defaults&nbsp;to&nbsp;&#34;GET&#34;)</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbspHeader</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbspContentLength</span><br>
<span class="lineno">345</span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbspTransferEncoding</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbspBody</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;Body&nbsp;is&nbsp;present,&nbsp;Content-Length&nbsp;is&nbsp;&lt;=&nbsp;0&nbsp;and&nbsp;TransferEncoding</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;hasn&#39;t&nbsp;been&nbsp;set&nbsp;to&nbsp;&#34;identity&#34;,&nbsp;Write&nbsp;adds&nbsp;&#34;Transfer-Encoding:</span><br>
<span class="lineno">350</span><span class="comment">//&nbsp;chunked&#34;&nbsp;to&nbsp;the&nbsp;header.&nbsp;Body&nbsp;is&nbsp;closed&nbsp;after&nbsp;it&nbsp;is&nbsp;sent.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">Request</span><span class="op">)</span>&nbsp;<span class="ident">Write</span><span class="op">(</span><span class="ident">w</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">Writer</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">write</span><span class="op">(</span><span class="ident">w</span><span class="op">,</span>&nbsp;<span class="ident">false</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span><span class="comment">//&nbsp;WriteProxy&nbsp;is&nbsp;like&nbsp;Write&nbsp;but&nbsp;writes&nbsp;the&nbsp;request&nbsp;in&nbsp;the&nbsp;form</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;expected&nbsp;by&nbsp;an&nbsp;HTTP&nbsp;proxy.&nbsp;&nbsp;In&nbsp;particular,&nbsp;WriteProxy&nbsp;writes&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;initial&nbsp;Request-URI&nbsp;line&nbsp;of&nbsp;the&nbsp;request&nbsp;with&nbsp;an&nbsp;absolute&nbsp;URI,&nbsp;per</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;section&nbsp;5.1.2&nbsp;of&nbsp;RFC&nbsp;2616,&nbsp;including&nbsp;the&nbsp;scheme&nbsp;and&nbsp;host.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;In&nbsp;either&nbsp;case,&nbsp;WriteProxy&nbsp;also&nbsp;writes&nbsp;a&nbsp;Host&nbsp;header,&nbsp;using</span><br>
<span class="lineno">360</span><span class="comment">//&nbsp;either&nbsp;r.Host&nbsp;or&nbsp;r.URL.Host.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">Request</span><span class="op">)</span>&nbsp;<span class="ident">WriteProxy</span><span class="op">(</span><span class="ident">w</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">Writer</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">write</span><span class="op">(</span><span class="ident">w</span><span class="op">,</span>&nbsp;<span class="ident">true</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="comment">//&nbsp;extraHeaders&nbsp;may&nbsp;be&nbsp;nil</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">req</span>&nbsp;<span class="op">*</span><span class="ident">Request</span><span class="op">)</span>&nbsp;<span class="ident">write</span><span class="op">(</span><span class="ident">w</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">Writer</span><span class="op">,</span>&nbsp;<span class="ident">usingProxy</span>&nbsp;<span class="builtintype">bool</span><span class="op">,</span>&nbsp;<span class="ident">extraHeaders</span>&nbsp;<span class="ident">Header</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">host</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">req</span><span class="op">.</span><span class="ident">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">host</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">req</span><span class="op">.</span><span class="ident">URL</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;http:&nbsp;Request.Write&nbsp;on&nbsp;Request&nbsp;with&nbsp;no&nbsp;Host&nbsp;or&nbsp;URL&nbsp;set&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">host</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">req</span><span class="op">.</span><span class="ident">URL</span><span class="op">.</span><span class="ident">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ruri</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">req</span><span class="op">.</span><span class="ident">URL</span><span class="op">.</span><span class="ident">RequestURI</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">usingProxy</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">req</span><span class="op">.</span><span class="ident">URL</span><span class="op">.</span><span class="ident">Scheme</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="string">&#34;&#34;</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">req</span><span class="op">.</span><span class="ident">URL</span><span class="op">.</span><span class="ident">Opaque</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ruri</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">req</span><span class="op">.</span><span class="ident">URL</span><span class="op">.</span><span class="ident">Scheme</span>&nbsp;<span class="op">+</span>&nbsp;<span class="string">&#34;://&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">host</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">ruri</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="keyword">if</span>&nbsp;<span class="ident">req</span><span class="op">.</span><span class="ident">Method</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;CONNECT&#34;</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">req</span><span class="op">.</span><span class="ident">URL</span><span class="op">.</span><span class="ident">Path</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;CONNECT&nbsp;requests&nbsp;normally&nbsp;give&nbsp;just&nbsp;the&nbsp;host&nbsp;and&nbsp;port,&nbsp;not&nbsp;a&nbsp;full&nbsp;URL.</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ruri</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;TODO(bradfitz):&nbsp;escape&nbsp;at&nbsp;least&nbsp;newlines&nbsp;in&nbsp;ruri?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Wrap&nbsp;the&nbsp;writer&nbsp;in&nbsp;a&nbsp;bufio&nbsp;Writer&nbsp;if&nbsp;it&#39;s&nbsp;not&nbsp;already&nbsp;buffered.</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Don&#39;t&nbsp;always&nbsp;call&nbsp;NewWriter,&nbsp;as&nbsp;that&nbsp;forces&nbsp;a&nbsp;bytes.Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;and&nbsp;other&nbsp;small&nbsp;bufio&nbsp;Writers&nbsp;to&nbsp;have&nbsp;a&nbsp;minimum&nbsp;4k&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">bw</span>&nbsp;<span class="op">*</span><span class="ident">bufio</span><span class="op">.</span><span class="ident">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="op">(</span><span class="ident">io</span><span class="op">.</span><span class="ident">ByteWriter</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bw</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">bufio</span><span class="op">.</span><span class="ident">NewWriter</span><span class="op">(</span><span class="ident">w</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">bw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">fmt</span><span class="op">.</span><span class="ident">Fprintf</span><span class="op">(</span><span class="ident">w</span><span class="op">,</span>&nbsp;<span class="string">&#34;%s&nbsp;%s&nbsp;HTTP/1.1\r\n&#34;</span><span class="op">,</span>&nbsp;<span class="ident">valueOrDefault</span><span class="op">(</span><span class="ident">req</span><span class="op">.</span><span class="ident">Method</span><span class="op">,</span>&nbsp;<span class="string">&#34;GET&#34;</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">ruri</span><span class="op">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Header&nbsp;lines</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">fmt</span><span class="op">.</span><span class="ident">Fprintf</span><span class="op">(</span><span class="ident">w</span><span class="op">,</span>&nbsp;<span class="string">&#34;Host:&nbsp;%s\r\n&#34;</span><span class="op">,</span>&nbsp;<span class="ident">host</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Use&nbsp;the&nbsp;defaultUserAgent&nbsp;unless&nbsp;the&nbsp;Header&nbsp;contains&nbsp;one,&nbsp;which</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;may&nbsp;be&nbsp;blank&nbsp;to&nbsp;not&nbsp;send&nbsp;the&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">userAgent</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">defaultUserAgent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">req</span><span class="op">.</span><span class="ident">Header</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ua</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">req</span><span class="op">.</span><span class="ident">Header</span><span class="op">[</span><span class="string">&#34;User-Agent&#34;</span><span class="op">]</span><span class="op">;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">ua</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">userAgent</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">ua</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">userAgent</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="string">&#34;&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">fmt</span><span class="op">.</span><span class="ident">Fprintf</span><span class="op">(</span><span class="ident">w</span><span class="op">,</span>&nbsp;<span class="string">&#34;User-Agent:&nbsp;%s\r\n&#34;</span><span class="op">,</span>&nbsp;<span class="ident">userAgent</span><span class="op">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Process&nbsp;Body,ContentLength,Close,Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tw</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">newTransferWriter</span><span class="op">(</span><span class="ident">req</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">tw</span><span class="op">.</span><span class="ident">WriteHeader</span><span class="op">(</span><span class="ident">w</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">req</span><span class="op">.</span><span class="ident">Header</span><span class="op">.</span><span class="ident">WriteSubset</span><span class="op">(</span><span class="ident">w</span><span class="op">,</span>&nbsp;<span class="ident">reqWriteExcludeHeader</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">extraHeaders</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">extraHeaders</span><span class="op">.</span><span class="ident">Write</span><span class="op">(</span><span class="ident">w</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">WriteString</span><span class="op">(</span><span class="ident">w</span><span class="op">,</span>&nbsp;<span class="string">&#34;\r\n&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Write&nbsp;body&nbsp;and&nbsp;trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">tw</span><span class="op">.</span><span class="ident">WriteBody</span><span class="op">(</span><span class="ident">w</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">bw</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">bw</span><span class="op">.</span><span class="ident">Flush</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ParseHTTPVersion&nbsp;parses&nbsp;a&nbsp;HTTP&nbsp;version&nbsp;string.</span><br>
<span class="lineno">460</span><span class="comment">//&nbsp;&#34;HTTP/1.0&#34;&nbsp;returns&nbsp;(1,&nbsp;0,&nbsp;true).</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">ParseHTTPVersion</span><span class="op">(</span><span class="ident">vers</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">major</span><span class="op">,</span>&nbsp;<span class="ident">minor</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">const</span>&nbsp;<span class="ident">Big</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1000000</span>&nbsp;<span class="comment">//&nbsp;arbitrary&nbsp;upper&nbsp;bound</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">vers</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;HTTP/1.1&#34;</span><span class="op">:</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;HTTP/1.0&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">strings</span><span class="op">.</span><span class="ident">HasPrefix</span><span class="op">(</span><span class="ident">vers</span><span class="op">,</span>&nbsp;<span class="string">&#34;HTTP/&#34;</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dot</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">strings</span><span class="op">.</span><span class="ident">Index</span><span class="op">(</span><span class="ident">vers</span><span class="op">,</span>&nbsp;<span class="string">&#34;.&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">dot</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">major</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">strconv</span><span class="op">.</span><span class="ident">Atoi</span><span class="op">(</span><span class="ident">vers</span><span class="op">[</span><span class="num">5</span><span class="op">:</span><span class="ident">dot</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">major</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">major</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">Big</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">minor</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">strconv</span><span class="op">.</span><span class="ident">Atoi</span><span class="op">(</span><span class="ident">vers</span><span class="op">[</span><span class="ident">dot</span><span class="op">+</span><span class="num">1</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">minor</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">minor</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">Big</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">major</span><span class="op">,</span>&nbsp;<span class="ident">minor</span><span class="op">,</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno">485</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;NewRequest&nbsp;returns&nbsp;a&nbsp;new&nbsp;Request&nbsp;given&nbsp;a&nbsp;method,&nbsp;URL,&nbsp;and&nbsp;optional&nbsp;body.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;the&nbsp;provided&nbsp;body&nbsp;is&nbsp;also&nbsp;an&nbsp;io.Closer,&nbsp;the&nbsp;returned</span><br>
<span class="lineno">490</span><span class="comment">//&nbsp;Request.Body&nbsp;is&nbsp;set&nbsp;to&nbsp;body&nbsp;and&nbsp;will&nbsp;be&nbsp;closed&nbsp;by&nbsp;the&nbsp;Client</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;methods&nbsp;Do,&nbsp;Post,&nbsp;and&nbsp;PostForm,&nbsp;and&nbsp;Transport.RoundTrip.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">NewRequest</span><span class="op">(</span><span class="ident">method</span><span class="op">,</span>&nbsp;<span class="ident">urlStr</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">body</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">Reader</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">Request</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">u</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">url</span><span class="op">.</span><span class="ident">Parse</span><span class="op">(</span><span class="ident">urlStr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rc</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">body</span><span class="op">.</span><span class="op">(</span><span class="ident">io</span><span class="op">.</span><span class="ident">ReadCloser</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">body</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rc</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">ioutil</span><span class="op">.</span><span class="ident">NopCloser</span><span class="op">(</span><span class="ident">body</span><span class="op">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">req</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">Request</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Method</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">method</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">URL</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">u</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Proto</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">&#34;HTTP/1.1&#34;</span><span class="op">,</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ProtoMajor</span><span class="op">:</span>&nbsp;<span class="num">1</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ProtoMinor</span><span class="op">:</span>&nbsp;<span class="num">1</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Header</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="ident">Header</span><span class="op">)</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Body</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">rc</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Host</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">u</span><span class="op">.</span><span class="ident">Host</span><span class="op">,</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">body</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">body</span><span class="op">.</span><span class="op">(</span><span class="keyword">type</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="op">*</span><span class="ident">bytes</span><span class="op">.</span><span class="ident">Buffer</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">req</span><span class="op">.</span><span class="ident">ContentLength</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="ident">v</span><span class="op">.</span><span class="ident">Len</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="op">*</span><span class="ident">bytes</span><span class="op">.</span><span class="ident">Reader</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">req</span><span class="op">.</span><span class="ident">ContentLength</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="ident">v</span><span class="op">.</span><span class="ident">Len</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="op">*</span><span class="ident">strings</span><span class="op">.</span><span class="ident">Reader</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">req</span><span class="op">.</span><span class="ident">ContentLength</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="ident">v</span><span class="op">.</span><span class="ident">Len</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">req</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">525</span><span class="comment">//&nbsp;BasicAuth&nbsp;returns&nbsp;the&nbsp;username&nbsp;and&nbsp;password&nbsp;provided&nbsp;in&nbsp;the&nbsp;request&#39;s</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Authorization&nbsp;header,&nbsp;if&nbsp;the&nbsp;request&nbsp;uses&nbsp;HTTP&nbsp;Basic&nbsp;Authentication.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;See&nbsp;RFC&nbsp;2617,&nbsp;Section&nbsp;2.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">Request</span><span class="op">)</span>&nbsp;<span class="ident">BasicAuth</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">username</span><span class="op">,</span>&nbsp;<span class="ident">password</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">auth</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">Header</span><span class="op">.</span><span class="ident">Get</span><span class="op">(</span><span class="string">&#34;Authorization&#34;</span><span class="op">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">auth</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">parseBasicAuth</span><span class="op">(</span><span class="ident">auth</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;parseBasicAuth&nbsp;parses&nbsp;an&nbsp;HTTP&nbsp;Basic&nbsp;Authentication&nbsp;string.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&#34;Basic&nbsp;QWxhZGRpbjpvcGVuIHNlc2FtZQ==&#34;&nbsp;returns&nbsp;(&#34;Aladdin&#34;,&nbsp;&#34;open&nbsp;sesame&#34;,&nbsp;true).</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">parseBasicAuth</span><span class="op">(</span><span class="ident">auth</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">username</span><span class="op">,</span>&nbsp;<span class="ident">password</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">strings</span><span class="op">.</span><span class="ident">HasPrefix</span><span class="op">(</span><span class="ident">auth</span><span class="op">,</span>&nbsp;<span class="string">&#34;Basic&nbsp;&#34;</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">base64</span><span class="op">.</span><span class="ident">StdEncoding</span><span class="op">.</span><span class="ident">DecodeString</span><span class="op">(</span><span class="ident">strings</span><span class="op">.</span><span class="ident">TrimPrefix</span><span class="op">(</span><span class="ident">auth</span><span class="op">,</span>&nbsp;<span class="string">&#34;Basic&nbsp;&#34;</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cs</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">string</span><span class="op">(</span><span class="ident">c</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">strings</span><span class="op">.</span><span class="ident">IndexByte</span><span class="op">(</span><span class="ident">cs</span><span class="op">,</span>&nbsp;<span class="string">&#39;:&#39;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">cs</span><span class="op">[</span><span class="op">:</span><span class="ident">s</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">cs</span><span class="op">[</span><span class="ident">s</span><span class="op">+</span><span class="num">1</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;SetBasicAuth&nbsp;sets&nbsp;the&nbsp;request&#39;s&nbsp;Authorization&nbsp;header&nbsp;to&nbsp;use&nbsp;HTTP</span><br>
<span class="lineno">555</span><span class="comment">//&nbsp;Basic&nbsp;Authentication&nbsp;with&nbsp;the&nbsp;provided&nbsp;username&nbsp;and&nbsp;password.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;With&nbsp;HTTP&nbsp;Basic&nbsp;Authentication&nbsp;the&nbsp;provided&nbsp;username&nbsp;and&nbsp;password</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;are&nbsp;not&nbsp;encrypted.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">Request</span><span class="op">)</span>&nbsp;<span class="ident">SetBasicAuth</span><span class="op">(</span><span class="ident">username</span><span class="op">,</span>&nbsp;<span class="ident">password</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">.</span><span class="ident">Header</span><span class="op">.</span><span class="ident">Set</span><span class="op">(</span><span class="string">&#34;Authorization&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;Basic&nbsp;&#34;</span><span class="op">+</span><span class="ident">basicAuth</span><span class="op">(</span><span class="ident">username</span><span class="op">,</span>&nbsp;<span class="ident">password</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;parseRequestLine&nbsp;parses&nbsp;&#34;GET&nbsp;/foo&nbsp;HTTP/1.1&#34;&nbsp;into&nbsp;its&nbsp;three&nbsp;parts.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">parseRequestLine</span><span class="op">(</span><span class="ident">line</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">method</span><span class="op">,</span>&nbsp;<span class="ident">requestURI</span><span class="op">,</span>&nbsp;<span class="ident">proto</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s1</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">strings</span><span class="op">.</span><span class="ident">Index</span><span class="op">(</span><span class="ident">line</span><span class="op">,</span>&nbsp;<span class="string">&#34;&nbsp;&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s2</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">strings</span><span class="op">.</span><span class="ident">Index</span><span class="op">(</span><span class="ident">line</span><span class="op">[</span><span class="ident">s1</span><span class="op">+</span><span class="num">1</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="string">&#34;&nbsp;&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">s1</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">s2</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s2</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">s1</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">line</span><span class="op">[</span><span class="op">:</span><span class="ident">s1</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">line</span><span class="op">[</span><span class="ident">s1</span><span class="op">+</span><span class="num">1</span>&nbsp;<span class="op">:</span>&nbsp;<span class="ident">s2</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">line</span><span class="op">[</span><span class="ident">s2</span><span class="op">+</span><span class="num">1</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">textprotoReaderPool</span>&nbsp;<span class="ident">sync</span><span class="op">.</span><span class="ident">Pool</span><br>
<span class="lineno">575</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">newTextprotoReader</span><span class="op">(</span><span class="ident">br</span>&nbsp;<span class="op">*</span><span class="ident">bufio</span><span class="op">.</span><span class="ident">Reader</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">textproto</span><span class="op">.</span><span class="ident">Reader</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">textprotoReaderPool</span><span class="op">.</span><span class="ident">Get</span><span class="op">(</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tr</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">v</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">textproto</span><span class="op">.</span><span class="ident">Reader</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tr</span><span class="op">.</span><span class="ident">R</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">br</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">tr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">textproto</span><span class="op">.</span><span class="ident">NewReader</span><span class="op">(</span><span class="ident">br</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span><span class="keyword">func</span>&nbsp;<span class="ident">putTextprotoReader</span><span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">textproto</span><span class="op">.</span><span class="ident">Reader</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">.</span><span class="ident">R</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">textprotoReaderPool</span><span class="op">.</span><span class="ident">Put</span><span class="op">(</span><span class="ident">r</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span><span class="comment">//&nbsp;ReadRequest&nbsp;reads&nbsp;and&nbsp;parses&nbsp;a&nbsp;request&nbsp;from&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">ReadRequest</span><span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">bufio</span><span class="op">.</span><span class="ident">Reader</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">req</span>&nbsp;<span class="op">*</span><span class="ident">Request</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">newTextprotoReader</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">req</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">Request</span><span class="op">)</span><br>
<span class="lineno">595</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;First&nbsp;line:&nbsp;GET&nbsp;/index.html&nbsp;HTTP/1.0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">tp</span><span class="op">.</span><span class="ident">ReadLine</span><span class="op">(</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">putTextprotoReader</span><span class="op">(</span><span class="ident">tp</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">EOF</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">ErrUnexpectedEOF</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="builtintype">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">req</span><span class="op">.</span><span class="ident">Method</span><span class="op">,</span>&nbsp;<span class="ident">req</span><span class="op">.</span><span class="ident">RequestURI</span><span class="op">,</span>&nbsp;<span class="ident">req</span><span class="op">.</span><span class="ident">Proto</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">parseRequestLine</span><span class="op">(</span><span class="ident">s</span><span class="op">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">badStringError</span><span class="op">{</span><span class="string">&#34;malformed&nbsp;HTTP&nbsp;request&#34;</span><span class="op">,</span>&nbsp;<span class="ident">s</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rawurl</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">req</span><span class="op">.</span><span class="ident">RequestURI</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">req</span><span class="op">.</span><span class="ident">ProtoMajor</span><span class="op">,</span>&nbsp;<span class="ident">req</span><span class="op">.</span><span class="ident">ProtoMinor</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">ParseHTTPVersion</span><span class="op">(</span><span class="ident">req</span><span class="op">.</span><span class="ident">Proto</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">badStringError</span><span class="op">{</span><span class="string">&#34;malformed&nbsp;HTTP&nbsp;version&#34;</span><span class="op">,</span>&nbsp;<span class="ident">req</span><span class="op">.</span><span class="ident">Proto</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;CONNECT&nbsp;requests&nbsp;are&nbsp;used&nbsp;two&nbsp;different&nbsp;ways,&nbsp;and&nbsp;neither&nbsp;uses&nbsp;a&nbsp;full&nbsp;URL:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;standard&nbsp;use&nbsp;is&nbsp;to&nbsp;tunnel&nbsp;HTTPS&nbsp;through&nbsp;an&nbsp;HTTP&nbsp;proxy.</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;It&nbsp;looks&nbsp;like&nbsp;&#34;CONNECT&nbsp;www.google.com:443&nbsp;HTTP/1.1&#34;,&nbsp;and&nbsp;the&nbsp;parameter&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;just&nbsp;the&nbsp;authority&nbsp;section&nbsp;of&nbsp;a&nbsp;URL.&nbsp;This&nbsp;information&nbsp;should&nbsp;go&nbsp;in&nbsp;req.URL.Host.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;net/rpc&nbsp;package&nbsp;also&nbsp;uses&nbsp;CONNECT,&nbsp;but&nbsp;there&nbsp;the&nbsp;parameter&nbsp;is&nbsp;a&nbsp;path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;that&nbsp;starts&nbsp;with&nbsp;a&nbsp;slash.&nbsp;It&nbsp;can&nbsp;be&nbsp;parsed&nbsp;with&nbsp;the&nbsp;regular&nbsp;URL&nbsp;parser,</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;and&nbsp;the&nbsp;path&nbsp;will&nbsp;end&nbsp;up&nbsp;in&nbsp;req.URL.Path,&nbsp;where&nbsp;it&nbsp;needs&nbsp;to&nbsp;be&nbsp;in&nbsp;order&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;RPC&nbsp;to&nbsp;work.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">justAuthority</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">req</span><span class="op">.</span><span class="ident">Method</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;CONNECT&#34;</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="op">!</span><span class="ident">strings</span><span class="op">.</span><span class="ident">HasPrefix</span><span class="op">(</span><span class="ident">rawurl</span><span class="op">,</span>&nbsp;<span class="string">&#34;/&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">justAuthority</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rawurl</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#34;http://&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">rawurl</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">req</span><span class="op">.</span><span class="ident">URL</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">url</span><span class="op">.</span><span class="ident">ParseRequestURI</span><span class="op">(</span><span class="ident">rawurl</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">635</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">justAuthority</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Strip&nbsp;the&nbsp;bogus&nbsp;&#34;http://&#34;&nbsp;back&nbsp;off.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">req</span><span class="op">.</span><span class="ident">URL</span><span class="op">.</span><span class="ident">Scheme</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">640</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Subsequent&nbsp;lines:&nbsp;Key:&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mimeHeader</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">tp</span><span class="op">.</span><span class="ident">ReadMIMEHeader</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">req</span><span class="op">.</span><span class="ident">Header</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">Header</span><span class="op">(</span><span class="ident">mimeHeader</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;RFC2616:&nbsp;Must&nbsp;treat</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;&nbspGET&nbsp;/index.html&nbsp;HTTP/1.1</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;&nbspHost:&nbsp;www.google.com</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;&nbspGET&nbsp;http://www.google.com/index.html&nbsp;HTTP/1.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;&nbspHost:&nbsp;doesntmatter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;the&nbsp;same.&nbsp;&nbsp;In&nbsp;the&nbsp;second&nbsp;case,&nbsp;any&nbsp;Host&nbsp;line&nbsp;is&nbsp;ignored.</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">req</span><span class="op">.</span><span class="ident">Host</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">req</span><span class="op">.</span><span class="ident">URL</span><span class="op">.</span><span class="ident">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">req</span><span class="op">.</span><span class="ident">Host</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">req</span><span class="op">.</span><span class="ident">Host</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">req</span><span class="op">.</span><span class="ident">Header</span><span class="op">.</span><span class="ident">get</span><span class="op">(</span><span class="string">&#34;Host&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">delete</span><span class="op">(</span><span class="ident">req</span><span class="op">.</span><span class="ident">Header</span><span class="op">,</span>&nbsp;<span class="string">&#34;Host&#34;</span><span class="op">)</span><br>
<span class="lineno">660</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fixPragmaCacheControl</span><span class="op">(</span><span class="ident">req</span><span class="op">.</span><span class="ident">Header</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">readTransfer</span><span class="op">(</span><span class="ident">req</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">req</span><span class="op">.</span><span class="ident">Close</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">shouldClose</span><span class="op">(</span><span class="ident">req</span><span class="op">.</span><span class="ident">ProtoMajor</span><span class="op">,</span>&nbsp;<span class="ident">req</span><span class="op">.</span><span class="ident">ProtoMinor</span><span class="op">,</span>&nbsp;<span class="ident">req</span><span class="op">.</span><span class="ident">Header</span><span class="op">,</span>&nbsp;<span class="ident">false</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">req</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno">670</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;MaxBytesReader&nbsp;is&nbsp;similar&nbsp;to&nbsp;io.LimitReader&nbsp;but&nbsp;is&nbsp;intended&nbsp;for</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;limiting&nbsp;the&nbsp;size&nbsp;of&nbsp;incoming&nbsp;request&nbsp;bodies.&nbsp;In&nbsp;contrast&nbsp;to</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;io.LimitReader,&nbsp;MaxBytesReader&#39;s&nbsp;result&nbsp;is&nbsp;a&nbsp;ReadCloser,&nbsp;returns&nbsp;a</span><br>
<span class="lineno">675</span><span class="comment">//&nbsp;non-EOF&nbsp;error&nbsp;for&nbsp;a&nbsp;Read&nbsp;beyond&nbsp;the&nbsp;limit,&nbsp;and&nbsp;Closes&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;underlying&nbsp;reader&nbsp;when&nbsp;its&nbsp;Close&nbsp;method&nbsp;is&nbsp;called.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;MaxBytesReader&nbsp;prevents&nbsp;clients&nbsp;from&nbsp;accidentally&nbsp;or&nbsp;maliciously</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;sending&nbsp;a&nbsp;large&nbsp;request&nbsp;and&nbsp;wasting&nbsp;server&nbsp;resources.</span><br>
<span class="lineno">680</span><span class="keyword">func</span>&nbsp;<span class="ident">MaxBytesReader</span><span class="op">(</span><span class="ident">w</span>&nbsp;<span class="ident">ResponseWriter</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">ReadCloser</span><span class="op">,</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="ident">int64</span><span class="op">)</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">ReadCloser</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">maxBytesReader</span><span class="op">{</span><span class="ident">w</span><span class="op">:</span>&nbsp;<span class="ident">w</span><span class="op">,</span>&nbsp;<span class="ident">r</span><span class="op">:</span>&nbsp;<span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">:</span>&nbsp;<span class="ident">n</span><span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">maxBytesReader</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">ResponseWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">ReadCloser</span>&nbsp;<span class="comment">//&nbsp;underlying&nbsp;reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;max&nbsp;bytes&nbsp;remaining</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">stopped</span>&nbsp;<span class="builtintype">bool</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">690</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">l</span>&nbsp;<span class="op">*</span><span class="ident">maxBytesReader</span><span class="op">)</span>&nbsp;<span class="ident">Read</span><span class="op">(</span><span class="ident">p</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">n</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="ident">n</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">l</span><span class="op">.</span><span class="ident">stopped</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">.</span><span class="ident">stopped</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">res</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="ident">w</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">response</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">res</span><span class="op">.</span><span class="ident">requestTooLarge</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;http:&nbsp;request&nbsp;body&nbsp;too&nbsp;large&#34;</span><span class="op">)</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">p</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="ident">n</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">p</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">p</span><span class="op">[</span><span class="op">:</span><span class="ident">l</span><span class="op">.</span><span class="ident">n</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="ident">r</span><span class="op">.</span><span class="ident">Read</span><span class="op">(</span><span class="ident">p</span><span class="op">)</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">.</span><span class="ident">n</span>&nbsp;<span class="op">-=</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="ident">n</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">l</span>&nbsp;<span class="op">*</span><span class="ident">maxBytesReader</span><span class="op">)</span>&nbsp;<span class="ident">Close</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="ident">r</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">copyValues</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="ident">src</span>&nbsp;<span class="ident">url</span><span class="op">.</span><span class="ident">Values</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">k</span><span class="op">,</span>&nbsp;<span class="ident">vs</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">src</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">vs</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dst</span><span class="op">.</span><span class="ident">Add</span><span class="op">(</span><span class="ident">k</span><span class="op">,</span>&nbsp;<span class="ident">value</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">720</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">parsePostForm</span><span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">Request</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">vs</span>&nbsp;<span class="ident">url</span><span class="op">.</span><span class="ident">Values</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">Body</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;missing&nbsp;form&nbsp;body&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ct</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">Header</span><span class="op">.</span><span class="ident">Get</span><span class="op">(</span><span class="string">&#34;Content-Type&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;RFC&nbsp;2616,&nbsp;section&nbsp;7.2.1&nbsp;-&nbsp;empty&nbsp;type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;SHOULD&nbsp;be&nbsp;treated&nbsp;as&nbsp;application/octet-stream</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ct</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ct</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#34;application/octet-stream&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ct</span><span class="op">,</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">mime</span><span class="op">.</span><span class="ident">ParseMediaType</span><span class="op">(</span><span class="ident">ct</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">ct</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;application/x-www-form-urlencoded&#34;</span><span class="op">:</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">reader</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">Reader</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">maxFormSize</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="num">1</span><span class="op">&lt;&lt;</span><span class="num">63</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">Body</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">maxBytesReader</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">maxFormSize</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="num">10</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="num">20</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;10&nbsp;MB&nbsp;is&nbsp;a&nbsp;lot&nbsp;of&nbsp;text.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reader</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">LimitReader</span><span class="op">(</span><span class="ident">r</span><span class="op">.</span><span class="ident">Body</span><span class="op">,</span>&nbsp;<span class="ident">maxFormSize</span><span class="op">+</span><span class="num">1</span><span class="op">)</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">e</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ioutil</span><span class="op">.</span><span class="ident">ReadAll</span><span class="op">(</span><span class="ident">reader</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">e</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">e</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">maxFormSize</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;http:&nbsp;POST&nbsp;too&nbsp;large&#34;</span><span class="op">)</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">vs</span><span class="op">,</span>&nbsp;<span class="ident">e</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">url</span><span class="op">.</span><span class="ident">ParseQuery</span><span class="op">(</span><span class="builtintype">string</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">e</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">ct</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;multipart/form-data&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;handled&nbsp;by&nbsp;ParseMultipartForm&nbsp;(which&nbsp;is&nbsp;calling&nbsp;us,&nbsp;or&nbsp;should&nbsp;be)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;TODO(bradfitz):&nbsp;there&nbsp;are&nbsp;too&nbsp;many&nbsp;possible</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;orders&nbsp;to&nbsp;call&nbsp;too&nbsp;many&nbsp;functions&nbsp;here.</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Clean&nbsp;this&nbsp;up&nbsp;and&nbsp;write&nbsp;more&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;request_test.go&nbsp;contains&nbsp;the&nbsp;start&nbsp;of&nbsp;this,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;in&nbsp;TestParseMultipartFormOrder&nbsp;and&nbsp;others.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno">765</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ParseForm&nbsp;parses&nbsp;the&nbsp;raw&nbsp;query&nbsp;from&nbsp;the&nbsp;URL&nbsp;and&nbsp;updates&nbsp;r.Form.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;For&nbsp;POST&nbsp;or&nbsp;PUT&nbsp;requests,&nbsp;it&nbsp;also&nbsp;parses&nbsp;the&nbsp;request&nbsp;body&nbsp;as&nbsp;a&nbsp;form&nbsp;and</span><br>
<span class="lineno">770</span><span class="comment">//&nbsp;put&nbsp;the&nbsp;results&nbsp;into&nbsp;both&nbsp;r.PostForm&nbsp;and&nbsp;r.Form.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;POST&nbsp;and&nbsp;PUT&nbsp;body&nbsp;parameters&nbsp;take&nbsp;precedence&nbsp;over&nbsp;URL&nbsp;query&nbsp;string&nbsp;values</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;in&nbsp;r.Form.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;the&nbsp;request&nbsp;Body&#39;s&nbsp;size&nbsp;has&nbsp;not&nbsp;already&nbsp;been&nbsp;limited&nbsp;by&nbsp;MaxBytesReader,</span><br>
<span class="lineno">775</span><span class="comment">//&nbsp;the&nbsp;size&nbsp;is&nbsp;capped&nbsp;at&nbsp;10MB.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ParseMultipartForm&nbsp;calls&nbsp;ParseForm&nbsp;automatically.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;It&nbsp;is&nbsp;idempotent.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">Request</span><span class="op">)</span>&nbsp;<span class="ident">ParseForm</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">PostForm</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">Method</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;POST&#34;</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">Method</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;PUT&#34;</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">Method</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;PATCH&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">.</span><span class="ident">PostForm</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">parsePostForm</span><span class="op">(</span><span class="ident">r</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">PostForm</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">.</span><span class="ident">PostForm</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="ident">url</span><span class="op">.</span><span class="ident">Values</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">Form</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">r</span><span class="op">.</span><span class="ident">PostForm</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">.</span><span class="ident">Form</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="ident">url</span><span class="op">.</span><span class="ident">Values</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">copyValues</span><span class="op">(</span><span class="ident">r</span><span class="op">.</span><span class="ident">Form</span><span class="op">,</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">PostForm</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">newValues</span>&nbsp;<span class="ident">url</span><span class="op">.</span><span class="ident">Values</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">URL</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">e</span>&nbsp;<span class="builtintype">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">newValues</span><span class="op">,</span>&nbsp;<span class="ident">e</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">url</span><span class="op">.</span><span class="ident">ParseQuery</span><span class="op">(</span><span class="ident">r</span><span class="op">.</span><span class="ident">URL</span><span class="op">.</span><span class="ident">RawQuery</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">e</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">newValues</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">newValues</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="ident">url</span><span class="op">.</span><span class="ident">Values</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">Form</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">.</span><span class="ident">Form</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">newValues</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">copyValues</span><span class="op">(</span><span class="ident">r</span><span class="op">.</span><span class="ident">Form</span><span class="op">,</span>&nbsp;<span class="ident">newValues</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ParseMultipartForm&nbsp;parses&nbsp;a&nbsp;request&nbsp;body&nbsp;as&nbsp;multipart/form-data.</span><br>
<span class="lineno">815</span><span class="comment">//&nbsp;The&nbsp;whole&nbsp;request&nbsp;body&nbsp;is&nbsp;parsed&nbsp;and&nbsp;up&nbsp;to&nbsp;a&nbsp;total&nbsp;of&nbsp;maxMemory&nbsp;bytes&nbsp;of</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;its&nbsp;file&nbsp;parts&nbsp;are&nbsp;stored&nbsp;in&nbsp;memory,&nbsp;with&nbsp;the&nbsp;remainder&nbsp;stored&nbsp;on</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;disk&nbsp;in&nbsp;temporary&nbsp;files.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ParseMultipartForm&nbsp;calls&nbsp;ParseForm&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;After&nbsp;one&nbsp;call&nbsp;to&nbsp;ParseMultipartForm,&nbsp;subsequent&nbsp;calls&nbsp;have&nbsp;no&nbsp;effect.</span><br>
<span class="lineno">820</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">Request</span><span class="op">)</span>&nbsp;<span class="ident">ParseMultipartForm</span><span class="op">(</span><span class="ident">maxMemory</span>&nbsp;<span class="ident">int64</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">MultipartForm</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">multipartByReader</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;http:&nbsp;multipart&nbsp;handled&nbsp;by&nbsp;MultipartReader&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">Form</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ParseForm</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">MultipartForm</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mr</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">multipartReader</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">mr</span><span class="op">.</span><span class="ident">ReadForm</span><span class="op">(</span><span class="ident">maxMemory</span><span class="op">)</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">k</span><span class="op">,</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">f</span><span class="op">.</span><span class="ident">Value</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">.</span><span class="ident">Form</span><span class="op">[</span><span class="ident">k</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">r</span><span class="op">.</span><span class="ident">Form</span><span class="op">[</span><span class="ident">k</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">v</span><span class="op">...</span><span class="op">)</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">.</span><span class="ident">MultipartForm</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">f</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">850</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;FormValue&nbsp;returns&nbsp;the&nbsp;first&nbsp;value&nbsp;for&nbsp;the&nbsp;named&nbsp;component&nbsp;of&nbsp;the&nbsp;query.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;POST&nbsp;and&nbsp;PUT&nbsp;body&nbsp;parameters&nbsp;take&nbsp;precedence&nbsp;over&nbsp;URL&nbsp;query&nbsp;string&nbsp;values.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;FormValue&nbsp;calls&nbsp;ParseMultipartForm&nbsp;and&nbsp;ParseForm&nbsp;if&nbsp;necessary&nbsp;and&nbsp;ignores</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;any&nbsp;errors&nbsp;returned&nbsp;by&nbsp;these&nbsp;functions.</span><br>
<span class="lineno">855</span><span class="comment">//&nbsp;To&nbsp;access&nbsp;multiple&nbsp;values&nbsp;of&nbsp;the&nbsp;same&nbsp;key,&nbsp;call&nbsp;ParseForm&nbsp;and</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;then&nbsp;inspect&nbsp;Request.Form&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">Request</span><span class="op">)</span>&nbsp;<span class="ident">FormValue</span><span class="op">(</span><span class="ident">key</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">Form</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">.</span><span class="ident">ParseMultipartForm</span><span class="op">(</span><span class="ident">defaultMaxMemory</span><span class="op">)</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">vs</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">Form</span><span class="op">[</span><span class="ident">key</span><span class="op">]</span><span class="op">;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">vs</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">vs</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="string">&#34;&#34;</span><br>
<span class="lineno">865</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;PostFormValue&nbsp;returns&nbsp;the&nbsp;first&nbsp;value&nbsp;for&nbsp;the&nbsp;named&nbsp;component&nbsp;of&nbsp;the&nbsp;POST</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;or&nbsp;PUT&nbsp;request&nbsp;body.&nbsp;URL&nbsp;query&nbsp;parameters&nbsp;are&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;PostFormValue&nbsp;calls&nbsp;ParseMultipartForm&nbsp;and&nbsp;ParseForm&nbsp;if&nbsp;necessary&nbsp;and&nbsp;ignores</span><br>
<span class="lineno">870</span><span class="comment">//&nbsp;any&nbsp;errors&nbsp;returned&nbsp;by&nbsp;these&nbsp;functions.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">Request</span><span class="op">)</span>&nbsp;<span class="ident">PostFormValue</span><span class="op">(</span><span class="ident">key</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">PostForm</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">.</span><span class="ident">ParseMultipartForm</span><span class="op">(</span><span class="ident">defaultMaxMemory</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">vs</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">PostForm</span><span class="op">[</span><span class="ident">key</span><span class="op">]</span><span class="op">;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">vs</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">vs</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="string">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">880</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;FormFile&nbsp;returns&nbsp;the&nbsp;first&nbsp;file&nbsp;for&nbsp;the&nbsp;provided&nbsp;form&nbsp;key.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;FormFile&nbsp;calls&nbsp;ParseMultipartForm&nbsp;and&nbsp;ParseForm&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">Request</span><span class="op">)</span>&nbsp;<span class="ident">FormFile</span><span class="op">(</span><span class="ident">key</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">multipart</span><span class="op">.</span><span class="ident">File</span><span class="op">,</span>&nbsp;<span class="op">*</span><span class="ident">multipart</span><span class="op">.</span><span class="ident">FileHeader</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">MultipartForm</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">multipartByReader</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;http:&nbsp;multipart&nbsp;handled&nbsp;by&nbsp;MultipartReader&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">MultipartForm</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ParseMultipartForm</span><span class="op">(</span><span class="ident">defaultMaxMemory</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">MultipartForm</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">MultipartForm</span><span class="op">.</span><span class="ident">File</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">fhs</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">MultipartForm</span><span class="op">.</span><span class="ident">File</span><span class="op">[</span><span class="ident">key</span><span class="op">]</span><span class="op">;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">fhs</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">fhs</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="ident">Open</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">f</span><span class="op">,</span>&nbsp;<span class="ident">fhs</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">ErrMissingFile</span><br>
<span class="lineno">900</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">Request</span><span class="op">)</span>&nbsp;<span class="ident">expectsContinue</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">hasToken</span><span class="op">(</span><span class="ident">r</span><span class="op">.</span><span class="ident">Header</span><span class="op">.</span><span class="ident">get</span><span class="op">(</span><span class="string">&#34;Expect&#34;</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="string">&#34;100-continue&#34;</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">905</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">Request</span><span class="op">)</span>&nbsp;<span class="ident">wantsHttp10KeepAlive</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ProtoMajor</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">ProtoMinor</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">hasToken</span><span class="op">(</span><span class="ident">r</span><span class="op">.</span><span class="ident">Header</span><span class="op">.</span><span class="ident">get</span><span class="op">(</span><span class="string">&#34;Connection&#34;</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="string">&#34;keep-alive&#34;</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">Request</span><span class="op">)</span>&nbsp;<span class="ident">wantsClose</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">hasToken</span><span class="op">(</span><span class="ident">r</span><span class="op">.</span><span class="ident">Header</span><span class="op">.</span><span class="ident">get</span><span class="op">(</span><span class="string">&#34;Connection&#34;</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="string">&#34;close&#34;</span><span class="op">)</span><br>
<span class="lineno">915</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">Request</span><span class="op">)</span>&nbsp;<span class="ident">closeBody</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">Body</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">.</span><span class="ident">Body</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span>
</div>
</body>
</html>
