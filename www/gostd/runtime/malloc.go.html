<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1510222">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1510277">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1510331">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1510382">package</span>&nbsp;<span class="ident" id="1510390">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1510399">import</span>&nbsp;<span class="op" id="1510406">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1510409">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1510418">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1510421">const</span>&nbsp;<span class="op" id="1510427">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510430">debugMalloc</span>&nbsp;<span class="op" id="1510442">=</span>&nbsp;<span class="builtintype" id="1510444">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510452">flagNoScan</span>&nbsp;<span class="op" id="1510463">=</span>&nbsp;<span class="ident" id="1510465">_FlagNoScan</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510478">flagNoZero</span>&nbsp;<span class="op" id="1510489">=</span>&nbsp;<span class="ident" id="1510491">_FlagNoZero</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510505">maxTinySize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1510519">=</span>&nbsp;<span class="ident" id="1510521">_TinySize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510532">tinySizeClass</span>&nbsp;<span class="op" id="1510546">=</span>&nbsp;<span class="ident" id="1510548">_TinySizeClass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510564">maxSmallSize</span>&nbsp;&nbsp;<span class="op" id="1510578">=</span>&nbsp;<span class="ident" id="1510580">_MaxSmallSize</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510596">pageShift</span>&nbsp;<span class="op" id="1510606">=</span>&nbsp;<span class="ident" id="1510608">_PageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510620">pageSize</span>&nbsp;&nbsp;<span class="op" id="1510630">=</span>&nbsp;<span class="ident" id="1510632">_PageSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510643">pageMask</span>&nbsp;&nbsp;<span class="op" id="1510653">=</span>&nbsp;<span class="ident" id="1510655">_PageMask</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510667">bitsPerPointer</span>&nbsp;&nbsp;<span class="op" id="1510683">=</span>&nbsp;<span class="ident" id="1510685">_BitsPerPointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510702">bitsMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510718">=</span>&nbsp;<span class="ident" id="1510720">_BitsMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510731">pointersPerByte</span>&nbsp;<span class="op" id="1510747">=</span>&nbsp;<span class="ident" id="1510749">_PointersPerByte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510767">maxGCMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510783">=</span>&nbsp;<span class="ident" id="1510785">_MaxGCMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510797">bitsDead</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510813">=</span>&nbsp;<span class="ident" id="1510815">_BitsDead</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510826">bitsPointer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510842">=</span>&nbsp;<span class="ident" id="1510844">_BitsPointer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510859">mSpanInUse</span>&nbsp;<span class="op" id="1510870">=</span>&nbsp;<span class="ident" id="1510872">_MSpanInUse</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510886">concurrentSweep</span>&nbsp;<span class="op" id="1510902">=</span>&nbsp;<span class="ident" id="1510904">_ConcurrentSweep</span>&nbsp;<span class="op" id="1510921">!=</span>&nbsp;<span class="num" id="1510924">0</span><br>
<span class="lineno">35</span><span class="op" id="1510926">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1510929">//&nbsp;Page&nbsp;number&nbsp;(address&gt;&gt;pageShift)</span><br>
<span class="lineno"></span><span class="keyword" id="1510965">type</span>&nbsp;<span class="ident" id="1510970">pageID</span>&nbsp;<span class="builtintype" id="1510977">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="1510986">//&nbsp;base&nbsp;address&nbsp;for&nbsp;all&nbsp;0-byte&nbsp;allocations</span><br>
<span class="lineno"></span><span class="keyword" id="1511029">var</span>&nbsp;<span class="ident" id="1511033">zerobase</span>&nbsp;<span class="builtintype" id="1511042">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1511051">//&nbsp;Allocate&nbsp;an&nbsp;object&nbsp;of&nbsp;size&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="1511088">//&nbsp;Small&nbsp;objects&nbsp;are&nbsp;allocated&nbsp;from&nbsp;the&nbsp;per-P&nbsp;cache&#39;s&nbsp;free&nbsp;lists.</span><br>
<span class="lineno">45</span><span class="comment" id="1511154">//&nbsp;Large&nbsp;objects&nbsp;(&gt;&nbsp;32&nbsp;kB)&nbsp;are&nbsp;allocated&nbsp;straight&nbsp;from&nbsp;the&nbsp;heap.</span><br>
<span class="lineno"></span><span class="keyword" id="1511219">func</span>&nbsp;<span class="ident" id="1511224">mallocgc</span><span class="op" id="1511232">(</span><span class="ident" id="1511233">size</span>&nbsp;<span class="builtintype" id="1511238">uintptr</span><span class="op" id="1511245">,</span>&nbsp;<span class="ident" id="1511247">typ</span>&nbsp;<span class="op" id="1511251">*</span><span class="ident" id="1511252">_type</span><span class="op" id="1511257">,</span>&nbsp;<span class="ident" id="1511259">flags</span>&nbsp;<span class="builtintype" id="1511265">uint32</span><span class="op" id="1511271">)</span>&nbsp;<span class="ident" id="1511273">unsafe</span><span class="op" id="1511279">.</span><span class="ident" id="1511280">Pointer</span>&nbsp;<span class="op" id="1511288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1511291">if</span>&nbsp;<span class="ident" id="1511294">size</span>&nbsp;<span class="op" id="1511299">==</span>&nbsp;<span class="num" id="1511302">0</span>&nbsp;<span class="op" id="1511304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1511308">return</span>&nbsp;<span class="ident" id="1511315">unsafe</span><span class="op" id="1511321">.</span><span class="ident" id="1511322">Pointer</span><span class="op" id="1511329">(</span><span class="op" id="1511330">&amp;</span><span class="ident" id="1511331">zerobase</span><span class="op" id="1511339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1511342">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1511345">size0</span>&nbsp;<span class="op" id="1511351">:=</span>&nbsp;<span class="ident" id="1511354">size</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1511361">if</span>&nbsp;<span class="ident" id="1511364">flags</span><span class="op" id="1511369">&amp;</span><span class="ident" id="1511370">flagNoScan</span>&nbsp;<span class="op" id="1511381">==</span>&nbsp;<span class="num" id="1511384">0</span>&nbsp;<span class="op" id="1511386">&amp;&amp;</span>&nbsp;<span class="ident" id="1511389">typ</span>&nbsp;<span class="op" id="1511393">==</span>&nbsp;<span class="ident" id="1511396">nil</span>&nbsp;<span class="op" id="1511400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1511404">gothrow</span><span class="op" id="1511411">(</span><span class="string" id="1511412">&#34;malloc&nbsp;missing&nbsp;type&#34;</span><span class="op" id="1511433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1511436">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511440">//&nbsp;This&nbsp;function&nbsp;must&nbsp;be&nbsp;atomic&nbsp;wrt&nbsp;GC,&nbsp;but&nbsp;for&nbsp;performance&nbsp;reasons</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511509">//&nbsp;we&nbsp;don&#39;t&nbsp;acquirem/releasem&nbsp;on&nbsp;fast&nbsp;path.&nbsp;The&nbsp;code&nbsp;below&nbsp;does&nbsp;not&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511583">//&nbsp;split&nbsp;stack&nbsp;checks,&nbsp;so&nbsp;it&nbsp;can&#39;t&nbsp;be&nbsp;preempted&nbsp;by&nbsp;GC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511639">//&nbsp;Functions&nbsp;like&nbsp;roundup/add&nbsp;are&nbsp;inlined.&nbsp;And&nbsp;onM/racemalloc&nbsp;are&nbsp;nosplit.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511715">//&nbsp;If&nbsp;debugMalloc&nbsp;=&nbsp;true,&nbsp;these&nbsp;assumptions&nbsp;are&nbsp;checked&nbsp;below.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1511779">if</span>&nbsp;<span class="ident" id="1511782">debugMalloc</span>&nbsp;<span class="op" id="1511794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1511798">mp</span>&nbsp;<span class="op" id="1511801">:=</span>&nbsp;<span class="ident" id="1511804">acquirem</span><span class="op" id="1511812">(</span><span class="op" id="1511813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1511817">if</span>&nbsp;<span class="ident" id="1511820">mp</span><span class="op" id="1511822">.</span><span class="ident" id="1511823">mallocing</span>&nbsp;<span class="op" id="1511833">!=</span>&nbsp;<span class="num" id="1511836">0</span>&nbsp;<span class="op" id="1511838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1511843">gothrow</span><span class="op" id="1511850">(</span><span class="string" id="1511851">&#34;malloc&nbsp;deadlock&#34;</span><span class="op" id="1511868">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1511872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1511876">mp</span><span class="op" id="1511878">.</span><span class="ident" id="1511879">mallocing</span>&nbsp;<span class="op" id="1511889">=</span>&nbsp;<span class="num" id="1511891">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1511895">if</span>&nbsp;<span class="ident" id="1511898">mp</span><span class="op" id="1511900">.</span><span class="ident" id="1511901">curg</span>&nbsp;<span class="op" id="1511906">!=</span>&nbsp;<span class="ident" id="1511909">nil</span>&nbsp;<span class="op" id="1511913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1511918">mp</span><span class="op" id="1511920">.</span><span class="ident" id="1511921">curg</span><span class="op" id="1511925">.</span><span class="ident" id="1511926">stackguard0</span>&nbsp;<span class="op" id="1511938">=</span>&nbsp;<span class="op" id="1511940">^</span><span class="builtintype" id="1511941">uintptr</span><span class="op" id="1511948">(</span><span class="num" id="1511949">0xfff</span><span class="op" id="1511954">)</span>&nbsp;<span class="op" id="1511956">|</span>&nbsp;<span class="num" id="1511958">0xbad</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1511966">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1511969">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1511973">c</span>&nbsp;<span class="op" id="1511975">:=</span>&nbsp;<span class="ident" id="1511978">gomcache</span><span class="op" id="1511986">(</span><span class="op" id="1511987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1511990">var</span>&nbsp;<span class="ident" id="1511994">s</span>&nbsp;<span class="op" id="1511996">*</span><span class="ident" id="1511997">mspan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1512004">var</span>&nbsp;<span class="ident" id="1512008">x</span>&nbsp;<span class="ident" id="1512010">unsafe</span><span class="op" id="1512016">.</span><span class="ident" id="1512017">Pointer</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1512026">if</span>&nbsp;<span class="ident" id="1512029">size</span>&nbsp;<span class="op" id="1512034">&lt;=</span>&nbsp;<span class="ident" id="1512037">maxSmallSize</span>&nbsp;<span class="op" id="1512050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1512054">if</span>&nbsp;<span class="ident" id="1512057">flags</span><span class="op" id="1512062">&amp;</span><span class="ident" id="1512063">flagNoScan</span>&nbsp;<span class="op" id="1512074">!=</span>&nbsp;<span class="num" id="1512077">0</span>&nbsp;<span class="op" id="1512079">&amp;&amp;</span>&nbsp;<span class="ident" id="1512082">size</span>&nbsp;<span class="op" id="1512087">&lt;</span>&nbsp;<span class="ident" id="1512089">maxTinySize</span>&nbsp;<span class="op" id="1512101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512106">//&nbsp;Tiny&nbsp;allocator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512128">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512134">//&nbsp;Tiny&nbsp;allocator&nbsp;combines&nbsp;several&nbsp;tiny&nbsp;allocation&nbsp;requests</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512197">//&nbsp;into&nbsp;a&nbsp;single&nbsp;memory&nbsp;block.&nbsp;The&nbsp;resulting&nbsp;memory&nbsp;block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512258">//&nbsp;is&nbsp;freed&nbsp;when&nbsp;all&nbsp;subobjects&nbsp;are&nbsp;unreachable.&nbsp;The&nbsp;subobjects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512325">//&nbsp;must&nbsp;be&nbsp;FlagNoScan&nbsp;(don&#39;t&nbsp;have&nbsp;pointers),&nbsp;this&nbsp;ensures&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512391">//&nbsp;the&nbsp;amount&nbsp;of&nbsp;potentially&nbsp;wasted&nbsp;memory&nbsp;is&nbsp;bounded.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512449">//</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512455">//&nbsp;Size&nbsp;of&nbsp;the&nbsp;memory&nbsp;block&nbsp;used&nbsp;for&nbsp;combining&nbsp;(maxTinySize)&nbsp;is&nbsp;tunable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512531">//&nbsp;Current&nbsp;setting&nbsp;is&nbsp;16&nbsp;bytes,&nbsp;which&nbsp;relates&nbsp;to&nbsp;2x&nbsp;worst&nbsp;case&nbsp;memory</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512604">//&nbsp;wastage&nbsp;(when&nbsp;all&nbsp;but&nbsp;one&nbsp;subobjects&nbsp;are&nbsp;unreachable).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512665">//&nbsp;8&nbsp;bytes&nbsp;would&nbsp;result&nbsp;in&nbsp;no&nbsp;wastage&nbsp;at&nbsp;all,&nbsp;but&nbsp;provides&nbsp;less</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512732">//&nbsp;opportunities&nbsp;for&nbsp;combining.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512767">//&nbsp;32&nbsp;bytes&nbsp;provides&nbsp;more&nbsp;opportunities&nbsp;for&nbsp;combining,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512825">//&nbsp;but&nbsp;can&nbsp;lead&nbsp;to&nbsp;4x&nbsp;worst&nbsp;case&nbsp;wastage.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512870">//&nbsp;The&nbsp;best&nbsp;case&nbsp;winning&nbsp;is&nbsp;8x&nbsp;regardless&nbsp;of&nbsp;block&nbsp;size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512930">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512936">//&nbsp;Objects&nbsp;obtained&nbsp;from&nbsp;tiny&nbsp;allocator&nbsp;must&nbsp;not&nbsp;be&nbsp;freed&nbsp;explicitly.</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1513009">//&nbsp;So&nbsp;when&nbsp;an&nbsp;object&nbsp;will&nbsp;be&nbsp;freed&nbsp;explicitly,&nbsp;we&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1513074">//&nbsp;its&nbsp;size&nbsp;&gt;=&nbsp;maxTinySize.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1513105">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1513111">//&nbsp;SetFinalizer&nbsp;has&nbsp;a&nbsp;special&nbsp;case&nbsp;for&nbsp;objects&nbsp;potentially&nbsp;coming</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1513180">//&nbsp;from&nbsp;tiny&nbsp;allocator,&nbsp;it&nbsp;such&nbsp;case&nbsp;it&nbsp;allows&nbsp;to&nbsp;set&nbsp;finalizers</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1513248">//&nbsp;for&nbsp;an&nbsp;inner&nbsp;byte&nbsp;of&nbsp;a&nbsp;memory&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1513291">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1513297">//&nbsp;The&nbsp;main&nbsp;targets&nbsp;of&nbsp;tiny&nbsp;allocator&nbsp;are&nbsp;small&nbsp;strings&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1513360">//&nbsp;standalone&nbsp;escaping&nbsp;variables.&nbsp;On&nbsp;a&nbsp;json&nbsp;benchmark</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1513417">//&nbsp;the&nbsp;allocator&nbsp;reduces&nbsp;number&nbsp;of&nbsp;allocations&nbsp;by&nbsp;~12%&nbsp;and</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1513479">//&nbsp;reduces&nbsp;heap&nbsp;size&nbsp;by&nbsp;~20%.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513512">tinysize</span>&nbsp;<span class="op" id="1513521">:=</span>&nbsp;<span class="builtintype" id="1513524">uintptr</span><span class="op" id="1513531">(</span><span class="ident" id="1513532">c</span><span class="op" id="1513533">.</span><span class="ident" id="1513534">tinysize</span><span class="op" id="1513542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1513547">if</span>&nbsp;<span class="ident" id="1513550">size</span>&nbsp;<span class="op" id="1513555">&lt;=</span>&nbsp;<span class="ident" id="1513558">tinysize</span>&nbsp;<span class="op" id="1513567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513573">tiny</span>&nbsp;<span class="op" id="1513578">:=</span>&nbsp;<span class="ident" id="1513581">unsafe</span><span class="op" id="1513587">.</span><span class="ident" id="1513588">Pointer</span><span class="op" id="1513595">(</span><span class="ident" id="1513596">c</span><span class="op" id="1513597">.</span><span class="ident" id="1513598">tiny</span><span class="op" id="1513602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1513608">//&nbsp;Align&nbsp;tiny&nbsp;pointer&nbsp;for&nbsp;required&nbsp;(conservative)&nbsp;alignment.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1513673">if</span>&nbsp;<span class="ident" id="1513676">size</span><span class="op" id="1513680">&amp;</span><span class="num" id="1513681">7</span>&nbsp;<span class="op" id="1513683">==</span>&nbsp;<span class="num" id="1513686">0</span>&nbsp;<span class="op" id="1513688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513695">tiny</span>&nbsp;<span class="op" id="1513700">=</span>&nbsp;<span class="ident" id="1513702">roundup</span><span class="op" id="1513709">(</span><span class="ident" id="1513710">tiny</span><span class="op" id="1513714">,</span>&nbsp;<span class="num" id="1513716">8</span><span class="op" id="1513717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1513723">}</span>&nbsp;<span class="keyword" id="1513725">else</span>&nbsp;<span class="keyword" id="1513730">if</span>&nbsp;<span class="ident" id="1513733">size</span><span class="op" id="1513737">&amp;</span><span class="num" id="1513738">3</span>&nbsp;<span class="op" id="1513740">==</span>&nbsp;<span class="num" id="1513743">0</span>&nbsp;<span class="op" id="1513745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513752">tiny</span>&nbsp;<span class="op" id="1513757">=</span>&nbsp;<span class="ident" id="1513759">roundup</span><span class="op" id="1513766">(</span><span class="ident" id="1513767">tiny</span><span class="op" id="1513771">,</span>&nbsp;<span class="num" id="1513773">4</span><span class="op" id="1513774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1513780">}</span>&nbsp;<span class="keyword" id="1513782">else</span>&nbsp;<span class="keyword" id="1513787">if</span>&nbsp;<span class="ident" id="1513790">size</span><span class="op" id="1513794">&amp;</span><span class="num" id="1513795">1</span>&nbsp;<span class="op" id="1513797">==</span>&nbsp;<span class="num" id="1513800">0</span>&nbsp;<span class="op" id="1513802">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513809">tiny</span>&nbsp;<span class="op" id="1513814">=</span>&nbsp;<span class="ident" id="1513816">roundup</span><span class="op" id="1513823">(</span><span class="ident" id="1513824">tiny</span><span class="op" id="1513828">,</span>&nbsp;<span class="num" id="1513830">2</span><span class="op" id="1513831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1513837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513843">size1</span>&nbsp;<span class="op" id="1513849">:=</span>&nbsp;<span class="ident" id="1513852">size</span>&nbsp;<span class="op" id="1513857">+</span>&nbsp;<span class="op" id="1513859">(</span><span class="builtintype" id="1513860">uintptr</span><span class="op" id="1513867">(</span><span class="ident" id="1513868">tiny</span><span class="op" id="1513872">)</span>&nbsp;<span class="op" id="1513874">-</span>&nbsp;<span class="builtintype" id="1513876">uintptr</span><span class="op" id="1513883">(</span><span class="ident" id="1513884">unsafe</span><span class="op" id="1513890">.</span><span class="ident" id="1513891">Pointer</span><span class="op" id="1513898">(</span><span class="ident" id="1513899">c</span><span class="op" id="1513900">.</span><span class="ident" id="1513901">tiny</span><span class="op" id="1513905">)</span><span class="op" id="1513906">)</span><span class="op" id="1513907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1513913">if</span>&nbsp;<span class="ident" id="1513916">size1</span>&nbsp;<span class="op" id="1513922">&lt;=</span>&nbsp;<span class="ident" id="1513925">tinysize</span>&nbsp;<span class="op" id="1513934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1513941">//&nbsp;The&nbsp;object&nbsp;fits&nbsp;into&nbsp;existing&nbsp;tiny&nbsp;block.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513991">x</span>&nbsp;<span class="op" id="1513993">=</span>&nbsp;<span class="ident" id="1513995">tiny</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514005">c</span><span class="op" id="1514006">.</span><span class="ident" id="1514007">tiny</span>&nbsp;<span class="op" id="1514012">=</span>&nbsp;<span class="op" id="1514014">(</span><span class="op" id="1514015">*</span><span class="builtintype" id="1514016">byte</span><span class="op" id="1514020">)</span><span class="op" id="1514021">(</span><span class="ident" id="1514022">add</span><span class="op" id="1514025">(</span><span class="ident" id="1514026">x</span><span class="op" id="1514027">,</span>&nbsp;<span class="ident" id="1514029">size</span><span class="op" id="1514033">)</span><span class="op" id="1514034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514041">c</span><span class="op" id="1514042">.</span><span class="ident" id="1514043">tinysize</span>&nbsp;<span class="op" id="1514052">-=</span>&nbsp;<span class="builtintype" id="1514055">uintptr</span><span class="op" id="1514062">(</span><span class="ident" id="1514063">size1</span><span class="op" id="1514068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514075">c</span><span class="op" id="1514076">.</span><span class="ident" id="1514077">local_tinyallocs</span><span class="op" id="1514093">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514101">if</span>&nbsp;<span class="ident" id="1514104">debugMalloc</span>&nbsp;<span class="op" id="1514116">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514124">mp</span>&nbsp;<span class="op" id="1514127">:=</span>&nbsp;<span class="ident" id="1514130">acquirem</span><span class="op" id="1514138">(</span><span class="op" id="1514139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514147">if</span>&nbsp;<span class="ident" id="1514150">mp</span><span class="op" id="1514152">.</span><span class="ident" id="1514153">mallocing</span>&nbsp;<span class="op" id="1514163">==</span>&nbsp;<span class="num" id="1514166">0</span>&nbsp;<span class="op" id="1514168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514177">gothrow</span><span class="op" id="1514184">(</span><span class="string" id="1514185">&#34;bad&nbsp;malloc&#34;</span><span class="op" id="1514197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1514205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514213">mp</span><span class="op" id="1514215">.</span><span class="ident" id="1514216">mallocing</span>&nbsp;<span class="op" id="1514226">=</span>&nbsp;<span class="num" id="1514228">0</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514236">if</span>&nbsp;<span class="ident" id="1514239">mp</span><span class="op" id="1514241">.</span><span class="ident" id="1514242">curg</span>&nbsp;<span class="op" id="1514247">!=</span>&nbsp;<span class="ident" id="1514250">nil</span>&nbsp;<span class="op" id="1514254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514263">mp</span><span class="op" id="1514265">.</span><span class="ident" id="1514266">curg</span><span class="op" id="1514270">.</span><span class="ident" id="1514271">stackguard0</span>&nbsp;<span class="op" id="1514283">=</span>&nbsp;<span class="ident" id="1514285">mp</span><span class="op" id="1514287">.</span><span class="ident" id="1514288">curg</span><span class="op" id="1514292">.</span><span class="ident" id="1514293">stack</span><span class="op" id="1514298">.</span><span class="ident" id="1514299">lo</span>&nbsp;<span class="op" id="1514302">+</span>&nbsp;<span class="ident" id="1514304">_StackGuard</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1514322">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1514330">//&nbsp;Note:&nbsp;one&nbsp;releasem&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;just&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1514387">//&nbsp;The&nbsp;other&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;at&nbsp;start&nbsp;of&nbsp;malloc.</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514443">releasem</span><span class="op" id="1514451">(</span><span class="ident" id="1514452">mp</span><span class="op" id="1514454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514462">releasem</span><span class="op" id="1514470">(</span><span class="ident" id="1514471">mp</span><span class="op" id="1514473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1514480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514487">return</span>&nbsp;<span class="ident" id="1514494">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1514500">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1514505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1514510">//&nbsp;Allocate&nbsp;a&nbsp;new&nbsp;maxTinySize&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514550">s</span>&nbsp;<span class="op" id="1514552">=</span>&nbsp;<span class="ident" id="1514554">c</span><span class="op" id="1514555">.</span><span class="ident" id="1514556">alloc</span><span class="op" id="1514561">[</span><span class="ident" id="1514562">tinySizeClass</span><span class="op" id="1514575">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514580">v</span>&nbsp;<span class="op" id="1514582">:=</span>&nbsp;<span class="ident" id="1514585">s</span><span class="op" id="1514586">.</span><span class="ident" id="1514587">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514599">if</span>&nbsp;<span class="ident" id="1514602">v</span>&nbsp;<span class="op" id="1514604">==</span>&nbsp;<span class="ident" id="1514607">nil</span>&nbsp;<span class="op" id="1514611">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514617">mp</span>&nbsp;<span class="op" id="1514620">:=</span>&nbsp;<span class="ident" id="1514623">acquirem</span><span class="op" id="1514631">(</span><span class="op" id="1514632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514638">mp</span><span class="op" id="1514640">.</span><span class="ident" id="1514641">scalararg</span><span class="op" id="1514650">[</span><span class="num" id="1514651">0</span><span class="op" id="1514652">]</span>&nbsp;<span class="op" id="1514654">=</span>&nbsp;<span class="ident" id="1514656">tinySizeClass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514674">onM</span><span class="op" id="1514677">(</span><span class="ident" id="1514678">mcacheRefill_m</span><span class="op" id="1514692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514698">releasem</span><span class="op" id="1514706">(</span><span class="ident" id="1514707">mp</span><span class="op" id="1514709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514715">s</span>&nbsp;<span class="op" id="1514717">=</span>&nbsp;<span class="ident" id="1514719">c</span><span class="op" id="1514720">.</span><span class="ident" id="1514721">alloc</span><span class="op" id="1514726">[</span><span class="ident" id="1514727">tinySizeClass</span><span class="op" id="1514740">]</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514746">v</span>&nbsp;<span class="op" id="1514748">=</span>&nbsp;<span class="ident" id="1514750">s</span><span class="op" id="1514751">.</span><span class="ident" id="1514752">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1514764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514769">s</span><span class="op" id="1514770">.</span><span class="ident" id="1514771">freelist</span>&nbsp;<span class="op" id="1514780">=</span>&nbsp;<span class="ident" id="1514782">v</span><span class="op" id="1514783">.</span><span class="ident" id="1514784">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514792">s</span><span class="op" id="1514793">.</span><span class="ident" id="1514794">ref</span><span class="op" id="1514797">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1514803">//TODO:&nbsp;prefetch&nbsp;v.next</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514830">x</span>&nbsp;<span class="op" id="1514832">=</span>&nbsp;<span class="ident" id="1514834">unsafe</span><span class="op" id="1514840">.</span><span class="ident" id="1514841">Pointer</span><span class="op" id="1514848">(</span><span class="ident" id="1514849">v</span><span class="op" id="1514850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1514855">(</span><span class="op" id="1514856">*</span><span class="op" id="1514857">[</span><span class="num" id="1514858">2</span><span class="op" id="1514859">]</span><span class="ident" id="1514860">uint64</span><span class="op" id="1514866">)</span><span class="op" id="1514867">(</span><span class="ident" id="1514868">x</span><span class="op" id="1514869">)</span><span class="op" id="1514870">[</span><span class="num" id="1514871">0</span><span class="op" id="1514872">]</span>&nbsp;<span class="op" id="1514874">=</span>&nbsp;<span class="num" id="1514876">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1514881">(</span><span class="op" id="1514882">*</span><span class="op" id="1514883">[</span><span class="num" id="1514884">2</span><span class="op" id="1514885">]</span><span class="ident" id="1514886">uint64</span><span class="op" id="1514892">)</span><span class="op" id="1514893">(</span><span class="ident" id="1514894">x</span><span class="op" id="1514895">)</span><span class="op" id="1514896">[</span><span class="num" id="1514897">1</span><span class="op" id="1514898">]</span>&nbsp;<span class="op" id="1514900">=</span>&nbsp;<span class="num" id="1514902">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1514907">//&nbsp;See&nbsp;if&nbsp;we&nbsp;need&nbsp;to&nbsp;replace&nbsp;the&nbsp;existing&nbsp;tiny&nbsp;block&nbsp;with&nbsp;the&nbsp;new&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1514980">//&nbsp;based&nbsp;on&nbsp;amount&nbsp;of&nbsp;remaining&nbsp;free&nbsp;space.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515027">if</span>&nbsp;<span class="ident" id="1515030">maxTinySize</span><span class="op" id="1515041">-</span><span class="ident" id="1515042">size</span>&nbsp;<span class="op" id="1515047">&gt;</span>&nbsp;<span class="ident" id="1515049">tinysize</span>&nbsp;<span class="op" id="1515058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515064">c</span><span class="op" id="1515065">.</span><span class="ident" id="1515066">tiny</span>&nbsp;<span class="op" id="1515071">=</span>&nbsp;<span class="op" id="1515073">(</span><span class="op" id="1515074">*</span><span class="builtintype" id="1515075">byte</span><span class="op" id="1515079">)</span><span class="op" id="1515080">(</span><span class="ident" id="1515081">add</span><span class="op" id="1515084">(</span><span class="ident" id="1515085">x</span><span class="op" id="1515086">,</span>&nbsp;<span class="ident" id="1515088">size</span><span class="op" id="1515092">)</span><span class="op" id="1515093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515099">c</span><span class="op" id="1515100">.</span><span class="ident" id="1515101">tinysize</span>&nbsp;<span class="op" id="1515110">=</span>&nbsp;<span class="builtintype" id="1515112">uintptr</span><span class="op" id="1515119">(</span><span class="ident" id="1515120">maxTinySize</span>&nbsp;<span class="op" id="1515132">-</span>&nbsp;<span class="ident" id="1515134">size</span><span class="op" id="1515138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1515143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515148">size</span>&nbsp;<span class="op" id="1515153">=</span>&nbsp;<span class="ident" id="1515155">maxTinySize</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1515169">}</span>&nbsp;<span class="keyword" id="1515171">else</span>&nbsp;<span class="op" id="1515176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515181">var</span>&nbsp;<span class="ident" id="1515185">sizeclass</span>&nbsp;<span class="builtintype" id="1515195">int8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515203">if</span>&nbsp;<span class="ident" id="1515206">size</span>&nbsp;<span class="op" id="1515211">&lt;=</span>&nbsp;<span class="num" id="1515214">1024</span><span class="op" id="1515218">-</span><span class="num" id="1515219">8</span>&nbsp;<span class="op" id="1515221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515227">sizeclass</span>&nbsp;<span class="op" id="1515237">=</span>&nbsp;<span class="ident" id="1515239">size_to_class8</span><span class="op" id="1515253">[</span><span class="op" id="1515254">(</span><span class="ident" id="1515255">size</span><span class="op" id="1515259">+</span><span class="num" id="1515260">7</span><span class="op" id="1515261">)</span><span class="op" id="1515262">&gt;&gt;</span><span class="num" id="1515264">3</span><span class="op" id="1515265">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1515270">}</span>&nbsp;<span class="keyword" id="1515272">else</span>&nbsp;<span class="op" id="1515277">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515283">sizeclass</span>&nbsp;<span class="op" id="1515293">=</span>&nbsp;<span class="ident" id="1515295">size_to_class128</span><span class="op" id="1515311">[</span><span class="op" id="1515312">(</span><span class="ident" id="1515313">size</span><span class="op" id="1515317">-</span><span class="num" id="1515318">1024</span><span class="op" id="1515322">+</span><span class="num" id="1515323">127</span><span class="op" id="1515326">)</span><span class="op" id="1515327">&gt;&gt;</span><span class="num" id="1515329">7</span><span class="op" id="1515330">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1515335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515340">size</span>&nbsp;<span class="op" id="1515345">=</span>&nbsp;<span class="builtintype" id="1515347">uintptr</span><span class="op" id="1515354">(</span><span class="ident" id="1515355">class_to_size</span><span class="op" id="1515368">[</span><span class="ident" id="1515369">sizeclass</span><span class="op" id="1515378">]</span><span class="op" id="1515379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515384">s</span>&nbsp;<span class="op" id="1515386">=</span>&nbsp;<span class="ident" id="1515388">c</span><span class="op" id="1515389">.</span><span class="ident" id="1515390">alloc</span><span class="op" id="1515395">[</span><span class="ident" id="1515396">sizeclass</span><span class="op" id="1515405">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515410">v</span>&nbsp;<span class="op" id="1515412">:=</span>&nbsp;<span class="ident" id="1515415">s</span><span class="op" id="1515416">.</span><span class="ident" id="1515417">freelist</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515429">if</span>&nbsp;<span class="ident" id="1515432">v</span>&nbsp;<span class="op" id="1515434">==</span>&nbsp;<span class="ident" id="1515437">nil</span>&nbsp;<span class="op" id="1515441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515447">mp</span>&nbsp;<span class="op" id="1515450">:=</span>&nbsp;<span class="ident" id="1515453">acquirem</span><span class="op" id="1515461">(</span><span class="op" id="1515462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515468">mp</span><span class="op" id="1515470">.</span><span class="ident" id="1515471">scalararg</span><span class="op" id="1515480">[</span><span class="num" id="1515481">0</span><span class="op" id="1515482">]</span>&nbsp;<span class="op" id="1515484">=</span>&nbsp;<span class="builtintype" id="1515486">uintptr</span><span class="op" id="1515493">(</span><span class="ident" id="1515494">sizeclass</span><span class="op" id="1515503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515509">onM</span><span class="op" id="1515512">(</span><span class="ident" id="1515513">mcacheRefill_m</span><span class="op" id="1515527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515533">releasem</span><span class="op" id="1515541">(</span><span class="ident" id="1515542">mp</span><span class="op" id="1515544">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515550">s</span>&nbsp;<span class="op" id="1515552">=</span>&nbsp;<span class="ident" id="1515554">c</span><span class="op" id="1515555">.</span><span class="ident" id="1515556">alloc</span><span class="op" id="1515561">[</span><span class="ident" id="1515562">sizeclass</span><span class="op" id="1515571">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515577">v</span>&nbsp;<span class="op" id="1515579">=</span>&nbsp;<span class="ident" id="1515581">s</span><span class="op" id="1515582">.</span><span class="ident" id="1515583">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1515595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515600">s</span><span class="op" id="1515601">.</span><span class="ident" id="1515602">freelist</span>&nbsp;<span class="op" id="1515611">=</span>&nbsp;<span class="ident" id="1515613">v</span><span class="op" id="1515614">.</span><span class="ident" id="1515615">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515623">s</span><span class="op" id="1515624">.</span><span class="ident" id="1515625">ref</span><span class="op" id="1515628">++</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1515634">//TODO:&nbsp;prefetch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515654">x</span>&nbsp;<span class="op" id="1515656">=</span>&nbsp;<span class="ident" id="1515658">unsafe</span><span class="op" id="1515664">.</span><span class="ident" id="1515665">Pointer</span><span class="op" id="1515672">(</span><span class="ident" id="1515673">v</span><span class="op" id="1515674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515679">if</span>&nbsp;<span class="ident" id="1515682">flags</span><span class="op" id="1515687">&amp;</span><span class="ident" id="1515688">flagNoZero</span>&nbsp;<span class="op" id="1515699">==</span>&nbsp;<span class="num" id="1515702">0</span>&nbsp;<span class="op" id="1515704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515710">v</span><span class="op" id="1515711">.</span><span class="ident" id="1515712">next</span>&nbsp;<span class="op" id="1515717">=</span>&nbsp;<span class="ident" id="1515719">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515727">if</span>&nbsp;<span class="ident" id="1515730">size</span>&nbsp;<span class="op" id="1515735">&gt;</span>&nbsp;<span class="num" id="1515737">2</span><span class="op" id="1515738">*</span><span class="ident" id="1515739">ptrSize</span>&nbsp;<span class="op" id="1515747">&amp;&amp;</span>&nbsp;<span class="op" id="1515750">(</span><span class="op" id="1515751">(</span><span class="op" id="1515752">*</span><span class="op" id="1515753">[</span><span class="num" id="1515754">2</span><span class="op" id="1515755">]</span><span class="builtintype" id="1515756">uintptr</span><span class="op" id="1515763">)</span><span class="op" id="1515764">(</span><span class="ident" id="1515765">x</span><span class="op" id="1515766">)</span><span class="op" id="1515767">)</span><span class="op" id="1515768">[</span><span class="num" id="1515769">1</span><span class="op" id="1515770">]</span>&nbsp;<span class="op" id="1515772">!=</span>&nbsp;<span class="num" id="1515775">0</span>&nbsp;<span class="op" id="1515777">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515784">memclr</span><span class="op" id="1515790">(</span><span class="ident" id="1515791">unsafe</span><span class="op" id="1515797">.</span><span class="ident" id="1515798">Pointer</span><span class="op" id="1515805">(</span><span class="ident" id="1515806">v</span><span class="op" id="1515807">)</span><span class="op" id="1515808">,</span>&nbsp;<span class="ident" id="1515810">size</span><span class="op" id="1515814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1515820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1515825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1515829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515833">c</span><span class="op" id="1515834">.</span><span class="ident" id="1515835">local_cachealloc</span>&nbsp;<span class="op" id="1515852">+=</span>&nbsp;<span class="ident" id="1515855">intptr</span><span class="op" id="1515861">(</span><span class="ident" id="1515862">size</span><span class="op" id="1515866">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1515869">}</span>&nbsp;<span class="keyword" id="1515871">else</span>&nbsp;<span class="op" id="1515876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515880">mp</span>&nbsp;<span class="op" id="1515883">:=</span>&nbsp;<span class="ident" id="1515886">acquirem</span><span class="op" id="1515894">(</span><span class="op" id="1515895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515899">mp</span><span class="op" id="1515901">.</span><span class="ident" id="1515902">scalararg</span><span class="op" id="1515911">[</span><span class="num" id="1515912">0</span><span class="op" id="1515913">]</span>&nbsp;<span class="op" id="1515915">=</span>&nbsp;<span class="builtintype" id="1515917">uintptr</span><span class="op" id="1515924">(</span><span class="ident" id="1515925">size</span><span class="op" id="1515929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515933">mp</span><span class="op" id="1515935">.</span><span class="ident" id="1515936">scalararg</span><span class="op" id="1515945">[</span><span class="num" id="1515946">1</span><span class="op" id="1515947">]</span>&nbsp;<span class="op" id="1515949">=</span>&nbsp;<span class="builtintype" id="1515951">uintptr</span><span class="op" id="1515958">(</span><span class="ident" id="1515959">flags</span><span class="op" id="1515964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515968">onM</span><span class="op" id="1515971">(</span><span class="ident" id="1515972">largeAlloc_m</span><span class="op" id="1515984">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515988">s</span>&nbsp;<span class="op" id="1515990">=</span>&nbsp;<span class="op" id="1515992">(</span><span class="op" id="1515993">*</span><span class="ident" id="1515994">mspan</span><span class="op" id="1515999">)</span><span class="op" id="1516000">(</span><span class="ident" id="1516001">mp</span><span class="op" id="1516003">.</span><span class="ident" id="1516004">ptrarg</span><span class="op" id="1516010">[</span><span class="num" id="1516011">0</span><span class="op" id="1516012">]</span><span class="op" id="1516013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516017">mp</span><span class="op" id="1516019">.</span><span class="ident" id="1516020">ptrarg</span><span class="op" id="1516026">[</span><span class="num" id="1516027">0</span><span class="op" id="1516028">]</span>&nbsp;<span class="op" id="1516030">=</span>&nbsp;<span class="ident" id="1516032">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516038">releasem</span><span class="op" id="1516046">(</span><span class="ident" id="1516047">mp</span><span class="op" id="1516049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516053">x</span>&nbsp;<span class="op" id="1516055">=</span>&nbsp;<span class="ident" id="1516057">unsafe</span><span class="op" id="1516063">.</span><span class="ident" id="1516064">Pointer</span><span class="op" id="1516071">(</span><span class="builtintype" id="1516072">uintptr</span><span class="op" id="1516079">(</span><span class="ident" id="1516080">s</span><span class="op" id="1516081">.</span><span class="ident" id="1516082">start</span>&nbsp;<span class="op" id="1516088">&lt;&lt;</span>&nbsp;<span class="ident" id="1516091">pageShift</span><span class="op" id="1516100">)</span><span class="op" id="1516101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516105">size</span>&nbsp;<span class="op" id="1516110">=</span>&nbsp;<span class="builtintype" id="1516112">uintptr</span><span class="op" id="1516119">(</span><span class="ident" id="1516120">s</span><span class="op" id="1516121">.</span><span class="ident" id="1516122">elemsize</span><span class="op" id="1516130">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1516133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1516137">if</span>&nbsp;<span class="ident" id="1516140">flags</span><span class="op" id="1516145">&amp;</span><span class="ident" id="1516146">flagNoScan</span>&nbsp;<span class="op" id="1516157">!=</span>&nbsp;<span class="num" id="1516160">0</span>&nbsp;<span class="op" id="1516162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1516166">//&nbsp;All&nbsp;objects&nbsp;are&nbsp;pre-marked&nbsp;as&nbsp;noscan.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1516209">goto</span>&nbsp;<span class="ident" id="1516214">marked</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1516222">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1516226">//&nbsp;If&nbsp;allocating&nbsp;a&nbsp;defer+arg&nbsp;block,&nbsp;now&nbsp;that&nbsp;we&#39;ve&nbsp;picked&nbsp;a&nbsp;malloc&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1516299">//&nbsp;large&nbsp;enough&nbsp;to&nbsp;hold&nbsp;everything,&nbsp;cut&nbsp;the&nbsp;&#34;asked&nbsp;for&#34;&nbsp;size&nbsp;down&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1516369">//&nbsp;just&nbsp;the&nbsp;defer&nbsp;header,&nbsp;so&nbsp;that&nbsp;the&nbsp;GC&nbsp;bitmap&nbsp;will&nbsp;record&nbsp;the&nbsp;arg&nbsp;block</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1516444">//&nbsp;as&nbsp;containing&nbsp;nothing&nbsp;at&nbsp;all&nbsp;(as&nbsp;if&nbsp;it&nbsp;were&nbsp;unused&nbsp;space&nbsp;at&nbsp;the&nbsp;end&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1516519">//&nbsp;a&nbsp;malloc&nbsp;block&nbsp;caused&nbsp;by&nbsp;size&nbsp;rounding).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1516564">//&nbsp;The&nbsp;defer&nbsp;arg&nbsp;areas&nbsp;are&nbsp;scanned&nbsp;as&nbsp;part&nbsp;of&nbsp;scanstack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1516622">if</span>&nbsp;<span class="ident" id="1516625">typ</span>&nbsp;<span class="op" id="1516629">==</span>&nbsp;<span class="ident" id="1516632">deferType</span>&nbsp;<span class="op" id="1516642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516646">size0</span>&nbsp;<span class="op" id="1516652">=</span>&nbsp;<span class="ident" id="1516654">unsafe</span><span class="op" id="1516660">.</span><span class="ident" id="1516661">Sizeof</span><span class="op" id="1516667">(</span><span class="ident" id="1516668">_defer</span><span class="op" id="1516674">{</span><span class="op" id="1516675">}</span><span class="op" id="1516676">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1516679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1516683">//&nbsp;From&nbsp;here&nbsp;till&nbsp;marked&nbsp;label&nbsp;marking&nbsp;the&nbsp;object&nbsp;as&nbsp;allocated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1516747">//&nbsp;and&nbsp;storing&nbsp;type&nbsp;info&nbsp;in&nbsp;the&nbsp;GC&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1516791">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516795">arena_start</span>&nbsp;<span class="op" id="1516807">:=</span>&nbsp;<span class="builtintype" id="1516810">uintptr</span><span class="op" id="1516817">(</span><span class="ident" id="1516818">unsafe</span><span class="op" id="1516824">.</span><span class="ident" id="1516825">Pointer</span><span class="op" id="1516832">(</span><span class="ident" id="1516833">mheap_</span><span class="op" id="1516839">.</span><span class="ident" id="1516840">arena_start</span><span class="op" id="1516851">)</span><span class="op" id="1516852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516856">off</span>&nbsp;<span class="op" id="1516860">:=</span>&nbsp;<span class="op" id="1516863">(</span><span class="builtintype" id="1516864">uintptr</span><span class="op" id="1516871">(</span><span class="ident" id="1516872">x</span><span class="op" id="1516873">)</span>&nbsp;<span class="op" id="1516875">-</span>&nbsp;<span class="ident" id="1516877">arena_start</span><span class="op" id="1516888">)</span>&nbsp;<span class="op" id="1516890">/</span>&nbsp;<span class="ident" id="1516892">ptrSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516902">xbits</span>&nbsp;<span class="op" id="1516908">:=</span>&nbsp;<span class="op" id="1516911">(</span><span class="op" id="1516912">*</span><span class="builtintype" id="1516913">uint8</span><span class="op" id="1516918">)</span><span class="op" id="1516919">(</span><span class="ident" id="1516920">unsafe</span><span class="op" id="1516926">.</span><span class="ident" id="1516927">Pointer</span><span class="op" id="1516934">(</span><span class="ident" id="1516935">arena_start</span>&nbsp;<span class="op" id="1516947">-</span>&nbsp;<span class="ident" id="1516949">off</span><span class="op" id="1516952">/</span><span class="ident" id="1516953">wordsPerBitmapByte</span>&nbsp;<span class="op" id="1516972">-</span>&nbsp;<span class="num" id="1516974">1</span><span class="op" id="1516975">)</span><span class="op" id="1516976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516980">shift</span>&nbsp;<span class="op" id="1516986">:=</span>&nbsp;<span class="op" id="1516989">(</span><span class="ident" id="1516990">off</span>&nbsp;<span class="op" id="1516994">%</span>&nbsp;<span class="ident" id="1516996">wordsPerBitmapByte</span><span class="op" id="1517014">)</span>&nbsp;<span class="op" id="1517016">*</span>&nbsp;<span class="ident" id="1517018">gcBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1517027">if</span>&nbsp;<span class="ident" id="1517030">debugMalloc</span>&nbsp;<span class="op" id="1517042">&amp;&amp;</span>&nbsp;<span class="op" id="1517045">(</span><span class="op" id="1517046">(</span><span class="op" id="1517047">*</span><span class="ident" id="1517048">xbits</span><span class="op" id="1517053">&gt;&gt;</span><span class="ident" id="1517055">shift</span><span class="op" id="1517060">)</span><span class="op" id="1517061">&amp;</span><span class="op" id="1517062">(</span><span class="ident" id="1517063">bitMask</span><span class="op" id="1517070">|</span><span class="ident" id="1517071">bitPtrMask</span><span class="op" id="1517081">)</span><span class="op" id="1517082">)</span>&nbsp;<span class="op" id="1517084">!=</span>&nbsp;<span class="ident" id="1517087">bitBoundary</span>&nbsp;<span class="op" id="1517099">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1517104">println</span><span class="op" id="1517111">(</span><span class="string" id="1517112">&#34;runtime:&nbsp;bits&nbsp;=&#34;</span><span class="op" id="1517129">,</span>&nbsp;<span class="op" id="1517131">(</span><span class="op" id="1517132">*</span><span class="ident" id="1517133">xbits</span><span class="op" id="1517138">&gt;&gt;</span><span class="ident" id="1517140">shift</span><span class="op" id="1517145">)</span><span class="op" id="1517146">&amp;</span><span class="op" id="1517147">(</span><span class="ident" id="1517148">bitMask</span><span class="op" id="1517155">|</span><span class="ident" id="1517156">bitPtrMask</span><span class="op" id="1517166">)</span><span class="op" id="1517167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1517172">gothrow</span><span class="op" id="1517179">(</span><span class="string" id="1517180">&#34;bad&nbsp;bits&nbsp;in&nbsp;markallocated&#34;</span><span class="op" id="1517207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1517211">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1517216">var</span>&nbsp;<span class="ident" id="1517220">ti</span><span class="op" id="1517222">,</span>&nbsp;<span class="ident" id="1517224">te</span>&nbsp;<span class="builtintype" id="1517227">uintptr</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1517237">var</span>&nbsp;<span class="ident" id="1517241">ptrmask</span>&nbsp;<span class="op" id="1517249">*</span><span class="builtintype" id="1517250">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1517258">if</span>&nbsp;<span class="ident" id="1517261">size</span>&nbsp;<span class="op" id="1517266">==</span>&nbsp;<span class="ident" id="1517269">ptrSize</span>&nbsp;<span class="op" id="1517277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1517282">//&nbsp;It&#39;s&nbsp;one&nbsp;word&nbsp;and&nbsp;it&nbsp;has&nbsp;pointers,&nbsp;it&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1517345">*</span><span class="ident" id="1517346">xbits</span>&nbsp;<span class="op" id="1517352">|=</span>&nbsp;<span class="op" id="1517355">(</span><span class="ident" id="1517356">bitsPointer</span>&nbsp;<span class="op" id="1517368">&lt;&lt;</span>&nbsp;<span class="num" id="1517371">2</span><span class="op" id="1517372">)</span>&nbsp;<span class="op" id="1517374">&lt;&lt;</span>&nbsp;<span class="ident" id="1517377">shift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1517386">goto</span>&nbsp;<span class="ident" id="1517391">marked</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1517400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1517404">if</span>&nbsp;<span class="ident" id="1517407">typ</span><span class="op" id="1517410">.</span><span class="ident" id="1517411">kind</span><span class="op" id="1517415">&amp;</span><span class="ident" id="1517416">kindGCProg</span>&nbsp;<span class="op" id="1517427">!=</span>&nbsp;<span class="num" id="1517430">0</span>&nbsp;<span class="op" id="1517432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1517437">nptr</span>&nbsp;<span class="op" id="1517442">:=</span>&nbsp;<span class="op" id="1517445">(</span><span class="builtintype" id="1517446">uintptr</span><span class="op" id="1517453">(</span><span class="ident" id="1517454">typ</span><span class="op" id="1517457">.</span><span class="ident" id="1517458">size</span><span class="op" id="1517462">)</span>&nbsp;<span class="op" id="1517464">+</span>&nbsp;<span class="ident" id="1517466">ptrSize</span>&nbsp;<span class="op" id="1517474">-</span>&nbsp;<span class="num" id="1517476">1</span><span class="op" id="1517477">)</span>&nbsp;<span class="op" id="1517479">/</span>&nbsp;<span class="ident" id="1517481">ptrSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1517492">masksize</span>&nbsp;<span class="op" id="1517501">:=</span>&nbsp;<span class="ident" id="1517504">nptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1517512">if</span>&nbsp;<span class="ident" id="1517515">masksize</span><span class="op" id="1517523">%</span><span class="num" id="1517524">2</span>&nbsp;<span class="op" id="1517526">!=</span>&nbsp;<span class="num" id="1517529">0</span>&nbsp;<span class="op" id="1517531">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1517537">masksize</span>&nbsp;<span class="op" id="1517546">*=</span>&nbsp;<span class="num" id="1517549">2</span>&nbsp;<span class="comment" id="1517551">//&nbsp;repeated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1517566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1517571">masksize</span>&nbsp;<span class="op" id="1517580">=</span>&nbsp;<span class="ident" id="1517582">masksize</span>&nbsp;<span class="op" id="1517591">*</span>&nbsp;<span class="ident" id="1517593">pointersPerByte</span>&nbsp;<span class="op" id="1517609">/</span>&nbsp;<span class="num" id="1517611">8</span>&nbsp;<span class="comment" id="1517613">//&nbsp;4&nbsp;bits&nbsp;per&nbsp;word</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1517635">masksize</span><span class="op" id="1517643">++</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1517677">//&nbsp;unroll&nbsp;flag&nbsp;in&nbsp;the&nbsp;beginning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1517712">if</span>&nbsp;<span class="ident" id="1517715">masksize</span>&nbsp;<span class="op" id="1517724">&gt;</span>&nbsp;<span class="ident" id="1517726">maxGCMask</span>&nbsp;<span class="op" id="1517736">&amp;&amp;</span>&nbsp;<span class="ident" id="1517739">typ</span><span class="op" id="1517742">.</span><span class="ident" id="1517743">gc</span><span class="op" id="1517745">[</span><span class="num" id="1517746">1</span><span class="op" id="1517747">]</span>&nbsp;<span class="op" id="1517749">!=</span>&nbsp;<span class="num" id="1517752">0</span>&nbsp;<span class="op" id="1517754">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1517760">//&nbsp;If&nbsp;the&nbsp;mask&nbsp;is&nbsp;too&nbsp;large,&nbsp;unroll&nbsp;the&nbsp;program&nbsp;directly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1517821">//&nbsp;into&nbsp;the&nbsp;GC&nbsp;bitmap.&nbsp;It&#39;s&nbsp;7&nbsp;times&nbsp;slower&nbsp;than&nbsp;copying</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1517881">//&nbsp;from&nbsp;the&nbsp;pre-unrolled&nbsp;mask,&nbsp;but&nbsp;saves&nbsp;1/16&nbsp;of&nbsp;type&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1517944">//&nbsp;memory&nbsp;for&nbsp;the&nbsp;mask.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1517972">mp</span>&nbsp;<span class="op" id="1517975">:=</span>&nbsp;<span class="ident" id="1517978">acquirem</span><span class="op" id="1517986">(</span><span class="op" id="1517987">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1517993">mp</span><span class="op" id="1517995">.</span><span class="ident" id="1517996">ptrarg</span><span class="op" id="1518002">[</span><span class="num" id="1518003">0</span><span class="op" id="1518004">]</span>&nbsp;<span class="op" id="1518006">=</span>&nbsp;<span class="ident" id="1518008">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518014">mp</span><span class="op" id="1518016">.</span><span class="ident" id="1518017">ptrarg</span><span class="op" id="1518023">[</span><span class="num" id="1518024">1</span><span class="op" id="1518025">]</span>&nbsp;<span class="op" id="1518027">=</span>&nbsp;<span class="ident" id="1518029">unsafe</span><span class="op" id="1518035">.</span><span class="ident" id="1518036">Pointer</span><span class="op" id="1518043">(</span><span class="ident" id="1518044">typ</span><span class="op" id="1518047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518053">mp</span><span class="op" id="1518055">.</span><span class="ident" id="1518056">scalararg</span><span class="op" id="1518065">[</span><span class="num" id="1518066">0</span><span class="op" id="1518067">]</span>&nbsp;<span class="op" id="1518069">=</span>&nbsp;<span class="builtintype" id="1518071">uintptr</span><span class="op" id="1518078">(</span><span class="ident" id="1518079">size</span><span class="op" id="1518083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518089">mp</span><span class="op" id="1518091">.</span><span class="ident" id="1518092">scalararg</span><span class="op" id="1518101">[</span><span class="num" id="1518102">1</span><span class="op" id="1518103">]</span>&nbsp;<span class="op" id="1518105">=</span>&nbsp;<span class="builtintype" id="1518107">uintptr</span><span class="op" id="1518114">(</span><span class="ident" id="1518115">size0</span><span class="op" id="1518120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518126">onM</span><span class="op" id="1518129">(</span><span class="ident" id="1518130">unrollgcproginplace_m</span><span class="op" id="1518151">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518157">releasem</span><span class="op" id="1518165">(</span><span class="ident" id="1518166">mp</span><span class="op" id="1518168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1518174">goto</span>&nbsp;<span class="ident" id="1518179">marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1518189">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518194">ptrmask</span>&nbsp;<span class="op" id="1518202">=</span>&nbsp;<span class="op" id="1518204">(</span><span class="op" id="1518205">*</span><span class="builtintype" id="1518206">uint8</span><span class="op" id="1518211">)</span><span class="op" id="1518212">(</span><span class="ident" id="1518213">unsafe</span><span class="op" id="1518219">.</span><span class="ident" id="1518220">Pointer</span><span class="op" id="1518227">(</span><span class="builtintype" id="1518228">uintptr</span><span class="op" id="1518235">(</span><span class="ident" id="1518236">typ</span><span class="op" id="1518239">.</span><span class="ident" id="1518240">gc</span><span class="op" id="1518242">[</span><span class="num" id="1518243">0</span><span class="op" id="1518244">]</span><span class="op" id="1518245">)</span><span class="op" id="1518246">)</span><span class="op" id="1518247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1518252">//&nbsp;Check&nbsp;whether&nbsp;the&nbsp;program&nbsp;is&nbsp;already&nbsp;unrolled.</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1518305">if</span>&nbsp;<span class="builtintype" id="1518308">uintptr</span><span class="op" id="1518315">(</span><span class="ident" id="1518316">atomicloadp</span><span class="op" id="1518327">(</span><span class="ident" id="1518328">unsafe</span><span class="op" id="1518334">.</span><span class="ident" id="1518335">Pointer</span><span class="op" id="1518342">(</span><span class="ident" id="1518343">ptrmask</span><span class="op" id="1518350">)</span><span class="op" id="1518351">)</span><span class="op" id="1518352">)</span><span class="op" id="1518353">&amp;</span><span class="num" id="1518354">0xff</span>&nbsp;<span class="op" id="1518359">==</span>&nbsp;<span class="num" id="1518362">0</span>&nbsp;<span class="op" id="1518364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518370">mp</span>&nbsp;<span class="op" id="1518373">:=</span>&nbsp;<span class="ident" id="1518376">acquirem</span><span class="op" id="1518384">(</span><span class="op" id="1518385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518391">mp</span><span class="op" id="1518393">.</span><span class="ident" id="1518394">ptrarg</span><span class="op" id="1518400">[</span><span class="num" id="1518401">0</span><span class="op" id="1518402">]</span>&nbsp;<span class="op" id="1518404">=</span>&nbsp;<span class="ident" id="1518406">unsafe</span><span class="op" id="1518412">.</span><span class="ident" id="1518413">Pointer</span><span class="op" id="1518420">(</span><span class="ident" id="1518421">typ</span><span class="op" id="1518424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518430">onM</span><span class="op" id="1518433">(</span><span class="ident" id="1518434">unrollgcprog_m</span><span class="op" id="1518448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518454">releasem</span><span class="op" id="1518462">(</span><span class="ident" id="1518463">mp</span><span class="op" id="1518465">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1518470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518475">ptrmask</span>&nbsp;<span class="op" id="1518483">=</span>&nbsp;<span class="op" id="1518485">(</span><span class="op" id="1518486">*</span><span class="builtintype" id="1518487">uint8</span><span class="op" id="1518492">)</span><span class="op" id="1518493">(</span><span class="ident" id="1518494">add</span><span class="op" id="1518497">(</span><span class="ident" id="1518498">unsafe</span><span class="op" id="1518504">.</span><span class="ident" id="1518505">Pointer</span><span class="op" id="1518512">(</span><span class="ident" id="1518513">ptrmask</span><span class="op" id="1518520">)</span><span class="op" id="1518521">,</span>&nbsp;<span class="num" id="1518523">1</span><span class="op" id="1518524">)</span><span class="op" id="1518525">)</span>&nbsp;<span class="comment" id="1518527">//&nbsp;skip&nbsp;the&nbsp;unroll&nbsp;flag&nbsp;byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1518558">}</span>&nbsp;<span class="keyword" id="1518560">else</span>&nbsp;<span class="op" id="1518565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518570">ptrmask</span>&nbsp;<span class="op" id="1518578">=</span>&nbsp;<span class="op" id="1518580">(</span><span class="op" id="1518581">*</span><span class="builtintype" id="1518582">uint8</span><span class="op" id="1518587">)</span><span class="op" id="1518588">(</span><span class="ident" id="1518589">unsafe</span><span class="op" id="1518595">.</span><span class="ident" id="1518596">Pointer</span><span class="op" id="1518603">(</span><span class="ident" id="1518604">typ</span><span class="op" id="1518607">.</span><span class="ident" id="1518608">gc</span><span class="op" id="1518610">[</span><span class="num" id="1518611">0</span><span class="op" id="1518612">]</span><span class="op" id="1518613">)</span><span class="op" id="1518614">)</span>&nbsp;<span class="comment" id="1518616">//&nbsp;pointer&nbsp;to&nbsp;unrolled&nbsp;mask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1518646">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1518650">if</span>&nbsp;<span class="ident" id="1518653">size</span>&nbsp;<span class="op" id="1518658">==</span>&nbsp;<span class="num" id="1518661">2</span><span class="op" id="1518662">*</span><span class="ident" id="1518663">ptrSize</span>&nbsp;<span class="op" id="1518671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1518676">*</span><span class="ident" id="1518677">xbits</span>&nbsp;<span class="op" id="1518683">=</span>&nbsp;<span class="op" id="1518685">*</span><span class="ident" id="1518686">ptrmask</span>&nbsp;<span class="op" id="1518694">|</span>&nbsp;<span class="ident" id="1518696">bitBoundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1518711">goto</span>&nbsp;<span class="ident" id="1518716">marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1518725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518729">te</span>&nbsp;<span class="op" id="1518732">=</span>&nbsp;<span class="builtintype" id="1518734">uintptr</span><span class="op" id="1518741">(</span><span class="ident" id="1518742">typ</span><span class="op" id="1518745">.</span><span class="ident" id="1518746">size</span><span class="op" id="1518750">)</span>&nbsp;<span class="op" id="1518752">/</span>&nbsp;<span class="ident" id="1518754">ptrSize</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1518764">//&nbsp;If&nbsp;the&nbsp;type&nbsp;occupies&nbsp;odd&nbsp;number&nbsp;of&nbsp;words,&nbsp;its&nbsp;mask&nbsp;is&nbsp;repeated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1518833">if</span>&nbsp;<span class="ident" id="1518836">te</span><span class="op" id="1518838">%</span><span class="num" id="1518839">2</span>&nbsp;<span class="op" id="1518841">==</span>&nbsp;<span class="num" id="1518844">0</span>&nbsp;<span class="op" id="1518846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518851">te</span>&nbsp;<span class="op" id="1518854">/=</span>&nbsp;<span class="num" id="1518857">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1518861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1518865">//&nbsp;Copy&nbsp;pointer&nbsp;bitmask&nbsp;into&nbsp;the&nbsp;bitmap.</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1518908">for</span>&nbsp;<span class="ident" id="1518912">i</span>&nbsp;<span class="op" id="1518914">:=</span>&nbsp;<span class="builtintype" id="1518917">uintptr</span><span class="op" id="1518924">(</span><span class="num" id="1518925">0</span><span class="op" id="1518926">)</span><span class="op" id="1518927">;</span>&nbsp;<span class="ident" id="1518929">i</span>&nbsp;<span class="op" id="1518931">&lt;</span>&nbsp;<span class="ident" id="1518933">size0</span><span class="op" id="1518938">;</span>&nbsp;<span class="ident" id="1518940">i</span>&nbsp;<span class="op" id="1518942">+=</span>&nbsp;<span class="num" id="1518945">2</span>&nbsp;<span class="op" id="1518947">*</span>&nbsp;<span class="ident" id="1518949">ptrSize</span>&nbsp;<span class="op" id="1518957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518962">v</span>&nbsp;<span class="op" id="1518964">:=</span>&nbsp;<span class="op" id="1518967">*</span><span class="op" id="1518968">(</span><span class="op" id="1518969">*</span><span class="builtintype" id="1518970">uint8</span><span class="op" id="1518975">)</span><span class="op" id="1518976">(</span><span class="ident" id="1518977">add</span><span class="op" id="1518980">(</span><span class="ident" id="1518981">unsafe</span><span class="op" id="1518987">.</span><span class="ident" id="1518988">Pointer</span><span class="op" id="1518995">(</span><span class="ident" id="1518996">ptrmask</span><span class="op" id="1519003">)</span><span class="op" id="1519004">,</span>&nbsp;<span class="ident" id="1519006">ti</span><span class="op" id="1519008">)</span><span class="op" id="1519009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1519014">ti</span><span class="op" id="1519016">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1519022">if</span>&nbsp;<span class="ident" id="1519025">ti</span>&nbsp;<span class="op" id="1519028">==</span>&nbsp;<span class="ident" id="1519031">te</span>&nbsp;<span class="op" id="1519034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1519040">ti</span>&nbsp;<span class="op" id="1519043">=</span>&nbsp;<span class="num" id="1519045">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1519050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1519055">if</span>&nbsp;<span class="ident" id="1519058">i</span>&nbsp;<span class="op" id="1519060">==</span>&nbsp;<span class="num" id="1519063">0</span>&nbsp;<span class="op" id="1519065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1519071">v</span>&nbsp;<span class="op" id="1519073">|=</span>&nbsp;<span class="ident" id="1519076">bitBoundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1519091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1519096">if</span>&nbsp;<span class="ident" id="1519099">i</span><span class="op" id="1519100">+</span><span class="ident" id="1519101">ptrSize</span>&nbsp;<span class="op" id="1519109">==</span>&nbsp;<span class="ident" id="1519112">size0</span>&nbsp;<span class="op" id="1519118">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1519124">v</span>&nbsp;<span class="op" id="1519126">&amp;^=</span>&nbsp;<span class="builtintype" id="1519130">uint8</span><span class="op" id="1519135">(</span><span class="ident" id="1519136">bitPtrMask</span>&nbsp;<span class="op" id="1519147">&lt;&lt;</span>&nbsp;<span class="num" id="1519150">4</span><span class="op" id="1519151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1519156">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1519162">*</span><span class="ident" id="1519163">xbits</span>&nbsp;<span class="op" id="1519169">=</span>&nbsp;<span class="ident" id="1519171">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1519176">xbits</span>&nbsp;<span class="op" id="1519182">=</span>&nbsp;<span class="op" id="1519184">(</span><span class="op" id="1519185">*</span><span class="builtintype" id="1519186">byte</span><span class="op" id="1519190">)</span><span class="op" id="1519191">(</span><span class="ident" id="1519192">add</span><span class="op" id="1519195">(</span><span class="ident" id="1519196">unsafe</span><span class="op" id="1519202">.</span><span class="ident" id="1519203">Pointer</span><span class="op" id="1519210">(</span><span class="ident" id="1519211">xbits</span><span class="op" id="1519216">)</span><span class="op" id="1519217">,</span>&nbsp;<span class="op" id="1519219">^</span><span class="builtintype" id="1519220">uintptr</span><span class="op" id="1519227">(</span><span class="num" id="1519228">0</span><span class="op" id="1519229">)</span><span class="op" id="1519230">)</span><span class="op" id="1519231">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1519235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1519239">if</span>&nbsp;<span class="ident" id="1519242">size0</span><span class="op" id="1519247">%</span><span class="op" id="1519248">(</span><span class="num" id="1519249">2</span><span class="op" id="1519250">*</span><span class="ident" id="1519251">ptrSize</span><span class="op" id="1519258">)</span>&nbsp;<span class="op" id="1519260">==</span>&nbsp;<span class="num" id="1519263">0</span>&nbsp;<span class="op" id="1519265">&amp;&amp;</span>&nbsp;<span class="ident" id="1519268">size0</span>&nbsp;<span class="op" id="1519274">&lt;</span>&nbsp;<span class="ident" id="1519276">size</span>&nbsp;<span class="op" id="1519281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1519286">//&nbsp;Mark&nbsp;the&nbsp;word&nbsp;after&nbsp;last&nbsp;object&#39;s&nbsp;word&nbsp;as&nbsp;bitsDead.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1519344">*</span><span class="ident" id="1519345">xbits</span>&nbsp;<span class="op" id="1519351">=</span>&nbsp;<span class="ident" id="1519353">bitsDead</span>&nbsp;<span class="op" id="1519362">&lt;&lt;</span>&nbsp;<span class="num" id="1519365">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1519369">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1519372">}</span><br>
<span class="lineno"></span><span class="ident" id="1519374">marked</span><span class="op" id="1519380">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1519383">if</span>&nbsp;<span class="ident" id="1519386">raceenabled</span>&nbsp;<span class="op" id="1519398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1519402">racemalloc</span><span class="op" id="1519412">(</span><span class="ident" id="1519413">x</span><span class="op" id="1519414">,</span>&nbsp;<span class="ident" id="1519416">size</span><span class="op" id="1519420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1519423">}</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1519427">if</span>&nbsp;<span class="ident" id="1519430">debugMalloc</span>&nbsp;<span class="op" id="1519442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1519446">mp</span>&nbsp;<span class="op" id="1519449">:=</span>&nbsp;<span class="ident" id="1519452">acquirem</span><span class="op" id="1519460">(</span><span class="op" id="1519461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1519465">if</span>&nbsp;<span class="ident" id="1519468">mp</span><span class="op" id="1519470">.</span><span class="ident" id="1519471">mallocing</span>&nbsp;<span class="op" id="1519481">==</span>&nbsp;<span class="num" id="1519484">0</span>&nbsp;<span class="op" id="1519486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1519491">gothrow</span><span class="op" id="1519498">(</span><span class="string" id="1519499">&#34;bad&nbsp;malloc&#34;</span><span class="op" id="1519511">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1519515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1519519">mp</span><span class="op" id="1519521">.</span><span class="ident" id="1519522">mallocing</span>&nbsp;<span class="op" id="1519532">=</span>&nbsp;<span class="num" id="1519534">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1519538">if</span>&nbsp;<span class="ident" id="1519541">mp</span><span class="op" id="1519543">.</span><span class="ident" id="1519544">curg</span>&nbsp;<span class="op" id="1519549">!=</span>&nbsp;<span class="ident" id="1519552">nil</span>&nbsp;<span class="op" id="1519556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1519561">mp</span><span class="op" id="1519563">.</span><span class="ident" id="1519564">curg</span><span class="op" id="1519568">.</span><span class="ident" id="1519569">stackguard0</span>&nbsp;<span class="op" id="1519581">=</span>&nbsp;<span class="ident" id="1519583">mp</span><span class="op" id="1519585">.</span><span class="ident" id="1519586">curg</span><span class="op" id="1519590">.</span><span class="ident" id="1519591">stack</span><span class="op" id="1519596">.</span><span class="ident" id="1519597">lo</span>&nbsp;<span class="op" id="1519600">+</span>&nbsp;<span class="ident" id="1519602">_StackGuard</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1519616">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1519620">//&nbsp;Note:&nbsp;one&nbsp;releasem&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;just&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1519673">//&nbsp;The&nbsp;other&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;at&nbsp;start&nbsp;of&nbsp;malloc.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1519725">releasem</span><span class="op" id="1519733">(</span><span class="ident" id="1519734">mp</span><span class="op" id="1519736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1519740">releasem</span><span class="op" id="1519748">(</span><span class="ident" id="1519749">mp</span><span class="op" id="1519751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1519754">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1519758">if</span>&nbsp;<span class="ident" id="1519761">debug</span><span class="op" id="1519766">.</span><span class="ident" id="1519767">allocfreetrace</span>&nbsp;<span class="op" id="1519782">!=</span>&nbsp;<span class="num" id="1519785">0</span>&nbsp;<span class="op" id="1519787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1519791">tracealloc</span><span class="op" id="1519801">(</span><span class="ident" id="1519802">x</span><span class="op" id="1519803">,</span>&nbsp;<span class="ident" id="1519805">size</span><span class="op" id="1519809">,</span>&nbsp;<span class="ident" id="1519811">typ</span><span class="op" id="1519814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1519817">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1519821">if</span>&nbsp;<span class="ident" id="1519824">rate</span>&nbsp;<span class="op" id="1519829">:=</span>&nbsp;<span class="ident" id="1519832">MemProfileRate</span><span class="op" id="1519846">;</span>&nbsp;<span class="ident" id="1519848">rate</span>&nbsp;<span class="op" id="1519853">&gt;</span>&nbsp;<span class="num" id="1519855">0</span>&nbsp;<span class="op" id="1519857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1519861">if</span>&nbsp;<span class="ident" id="1519864">size</span>&nbsp;<span class="op" id="1519869">&lt;</span>&nbsp;<span class="builtintype" id="1519871">uintptr</span><span class="op" id="1519878">(</span><span class="ident" id="1519879">rate</span><span class="op" id="1519883">)</span>&nbsp;<span class="op" id="1519885">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1519888">int32</span><span class="op" id="1519893">(</span><span class="ident" id="1519894">size</span><span class="op" id="1519898">)</span>&nbsp;<span class="op" id="1519900">&lt;</span>&nbsp;<span class="ident" id="1519902">c</span><span class="op" id="1519903">.</span><span class="ident" id="1519904">next_sample</span>&nbsp;<span class="op" id="1519916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1519921">c</span><span class="op" id="1519922">.</span><span class="ident" id="1519923">next_sample</span>&nbsp;<span class="op" id="1519935">-=</span>&nbsp;<span class="builtintype" id="1519938">int32</span><span class="op" id="1519943">(</span><span class="ident" id="1519944">size</span><span class="op" id="1519948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1519952">}</span>&nbsp;<span class="keyword" id="1519954">else</span>&nbsp;<span class="op" id="1519959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1519964">mp</span>&nbsp;<span class="op" id="1519967">:=</span>&nbsp;<span class="ident" id="1519970">acquirem</span><span class="op" id="1519978">(</span><span class="op" id="1519979">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1519984">profilealloc</span><span class="op" id="1519996">(</span><span class="ident" id="1519997">mp</span><span class="op" id="1519999">,</span>&nbsp;<span class="ident" id="1520001">x</span><span class="op" id="1520002">,</span>&nbsp;<span class="ident" id="1520004">size</span><span class="op" id="1520008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1520013">releasem</span><span class="op" id="1520021">(</span><span class="ident" id="1520022">mp</span><span class="op" id="1520024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1520028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1520031">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1520035">if</span>&nbsp;<span class="ident" id="1520038">memstats</span><span class="op" id="1520046">.</span><span class="ident" id="1520047">heap_alloc</span>&nbsp;<span class="op" id="1520058">&gt;=</span>&nbsp;<span class="ident" id="1520061">memstats</span><span class="op" id="1520069">.</span><span class="ident" id="1520070">next_gc</span>&nbsp;<span class="op" id="1520078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1520082">gogc</span><span class="op" id="1520086">(</span><span class="num" id="1520087">0</span><span class="op" id="1520088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1520091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1520095">return</span>&nbsp;<span class="ident" id="1520102">x</span><br>
<span class="lineno">345</span><span class="op" id="1520104">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1520107">//&nbsp;implementation&nbsp;of&nbsp;new&nbsp;builtin</span><br>
<span class="lineno"></span><span class="keyword" id="1520140">func</span>&nbsp;<span class="ident" id="1520145">newobject</span><span class="op" id="1520154">(</span><span class="ident" id="1520155">typ</span>&nbsp;<span class="op" id="1520159">*</span><span class="ident" id="1520160">_type</span><span class="op" id="1520165">)</span>&nbsp;<span class="ident" id="1520167">unsafe</span><span class="op" id="1520173">.</span><span class="ident" id="1520174">Pointer</span>&nbsp;<span class="op" id="1520182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1520185">flags</span>&nbsp;<span class="op" id="1520191">:=</span>&nbsp;<span class="builtintype" id="1520194">uint32</span><span class="op" id="1520200">(</span><span class="num" id="1520201">0</span><span class="op" id="1520202">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1520205">if</span>&nbsp;<span class="ident" id="1520208">typ</span><span class="op" id="1520211">.</span><span class="ident" id="1520212">kind</span><span class="op" id="1520216">&amp;</span><span class="ident" id="1520217">kindNoPointers</span>&nbsp;<span class="op" id="1520232">!=</span>&nbsp;<span class="num" id="1520235">0</span>&nbsp;<span class="op" id="1520237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1520241">flags</span>&nbsp;<span class="op" id="1520247">|=</span>&nbsp;<span class="ident" id="1520250">flagNoScan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1520262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1520265">return</span>&nbsp;<span class="ident" id="1520272">mallocgc</span><span class="op" id="1520280">(</span><span class="builtintype" id="1520281">uintptr</span><span class="op" id="1520288">(</span><span class="ident" id="1520289">typ</span><span class="op" id="1520292">.</span><span class="ident" id="1520293">size</span><span class="op" id="1520297">)</span><span class="op" id="1520298">,</span>&nbsp;<span class="ident" id="1520300">typ</span><span class="op" id="1520303">,</span>&nbsp;<span class="ident" id="1520305">flags</span><span class="op" id="1520310">)</span><br>
<span class="lineno"></span><span class="op" id="1520312">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span><span class="comment" id="1520315">//&nbsp;implementation&nbsp;of&nbsp;make&nbsp;builtin&nbsp;for&nbsp;slices</span><br>
<span class="lineno"></span><span class="keyword" id="1520360">func</span>&nbsp;<span class="ident" id="1520365">newarray</span><span class="op" id="1520373">(</span><span class="ident" id="1520374">typ</span>&nbsp;<span class="op" id="1520378">*</span><span class="ident" id="1520379">_type</span><span class="op" id="1520384">,</span>&nbsp;<span class="ident" id="1520386">n</span>&nbsp;<span class="builtintype" id="1520388">uintptr</span><span class="op" id="1520395">)</span>&nbsp;<span class="ident" id="1520397">unsafe</span><span class="op" id="1520403">.</span><span class="ident" id="1520404">Pointer</span>&nbsp;<span class="op" id="1520412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1520415">flags</span>&nbsp;<span class="op" id="1520421">:=</span>&nbsp;<span class="builtintype" id="1520424">uint32</span><span class="op" id="1520430">(</span><span class="num" id="1520431">0</span><span class="op" id="1520432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1520435">if</span>&nbsp;<span class="ident" id="1520438">typ</span><span class="op" id="1520441">.</span><span class="ident" id="1520442">kind</span><span class="op" id="1520446">&amp;</span><span class="ident" id="1520447">kindNoPointers</span>&nbsp;<span class="op" id="1520462">!=</span>&nbsp;<span class="num" id="1520465">0</span>&nbsp;<span class="op" id="1520467">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1520471">flags</span>&nbsp;<span class="op" id="1520477">|=</span>&nbsp;<span class="ident" id="1520480">flagNoScan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1520492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1520495">if</span>&nbsp;<span class="builtintype" id="1520498">int</span><span class="op" id="1520501">(</span><span class="ident" id="1520502">n</span><span class="op" id="1520503">)</span>&nbsp;<span class="op" id="1520505">&lt;</span>&nbsp;<span class="num" id="1520507">0</span>&nbsp;<span class="op" id="1520509">||</span>&nbsp;<span class="op" id="1520512">(</span><span class="ident" id="1520513">typ</span><span class="op" id="1520516">.</span><span class="ident" id="1520517">size</span>&nbsp;<span class="op" id="1520522">&gt;</span>&nbsp;<span class="num" id="1520524">0</span>&nbsp;<span class="op" id="1520526">&amp;&amp;</span>&nbsp;<span class="ident" id="1520529">n</span>&nbsp;<span class="op" id="1520531">&gt;</span>&nbsp;<span class="ident" id="1520533">maxmem</span><span class="op" id="1520539">/</span><span class="builtintype" id="1520540">uintptr</span><span class="op" id="1520547">(</span><span class="ident" id="1520548">typ</span><span class="op" id="1520551">.</span><span class="ident" id="1520552">size</span><span class="op" id="1520556">)</span><span class="op" id="1520557">)</span>&nbsp;<span class="op" id="1520559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1520563">panic</span><span class="op" id="1520568">(</span><span class="string" id="1520569">&#34;runtime:&nbsp;allocation&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1520608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1520611">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1520614">return</span>&nbsp;<span class="ident" id="1520621">mallocgc</span><span class="op" id="1520629">(</span><span class="builtintype" id="1520630">uintptr</span><span class="op" id="1520637">(</span><span class="ident" id="1520638">typ</span><span class="op" id="1520641">.</span><span class="ident" id="1520642">size</span><span class="op" id="1520646">)</span><span class="op" id="1520647">*</span><span class="ident" id="1520648">n</span><span class="op" id="1520649">,</span>&nbsp;<span class="ident" id="1520651">typ</span><span class="op" id="1520654">,</span>&nbsp;<span class="ident" id="1520656">flags</span><span class="op" id="1520661">)</span><br>
<span class="lineno"></span><span class="op" id="1520663">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1520666">//&nbsp;rawmem&nbsp;returns&nbsp;a&nbsp;chunk&nbsp;of&nbsp;pointerless&nbsp;memory.&nbsp;&nbsp;It&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1520722">//&nbsp;not&nbsp;zeroed.</span><br>
<span class="lineno">370</span><span class="keyword" id="1520737">func</span>&nbsp;<span class="ident" id="1520742">rawmem</span><span class="op" id="1520748">(</span><span class="ident" id="1520749">size</span>&nbsp;<span class="builtintype" id="1520754">uintptr</span><span class="op" id="1520761">)</span>&nbsp;<span class="ident" id="1520763">unsafe</span><span class="op" id="1520769">.</span><span class="ident" id="1520770">Pointer</span>&nbsp;<span class="op" id="1520778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1520781">return</span>&nbsp;<span class="ident" id="1520788">mallocgc</span><span class="op" id="1520796">(</span><span class="ident" id="1520797">size</span><span class="op" id="1520801">,</span>&nbsp;<span class="ident" id="1520803">nil</span><span class="op" id="1520806">,</span>&nbsp;<span class="ident" id="1520808">flagNoScan</span><span class="op" id="1520818">|</span><span class="ident" id="1520819">flagNoZero</span><span class="op" id="1520829">)</span><br>
<span class="lineno"></span><span class="op" id="1520831">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1520834">//&nbsp;round&nbsp;size&nbsp;up&nbsp;to&nbsp;next&nbsp;size&nbsp;class</span><br>
<span class="lineno">375</span><span class="keyword" id="1520870">func</span>&nbsp;<span class="ident" id="1520875">goroundupsize</span><span class="op" id="1520888">(</span><span class="ident" id="1520889">size</span>&nbsp;<span class="builtintype" id="1520894">uintptr</span><span class="op" id="1520901">)</span>&nbsp;<span class="builtintype" id="1520903">uintptr</span>&nbsp;<span class="op" id="1520911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1520914">if</span>&nbsp;<span class="ident" id="1520917">size</span>&nbsp;<span class="op" id="1520922">&lt;</span>&nbsp;<span class="ident" id="1520924">maxSmallSize</span>&nbsp;<span class="op" id="1520937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1520941">if</span>&nbsp;<span class="ident" id="1520944">size</span>&nbsp;<span class="op" id="1520949">&lt;=</span>&nbsp;<span class="num" id="1520952">1024</span><span class="op" id="1520956">-</span><span class="num" id="1520957">8</span>&nbsp;<span class="op" id="1520959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1520964">return</span>&nbsp;<span class="builtintype" id="1520971">uintptr</span><span class="op" id="1520978">(</span><span class="ident" id="1520979">class_to_size</span><span class="op" id="1520992">[</span><span class="ident" id="1520993">size_to_class8</span><span class="op" id="1521007">[</span><span class="op" id="1521008">(</span><span class="ident" id="1521009">size</span><span class="op" id="1521013">+</span><span class="num" id="1521014">7</span><span class="op" id="1521015">)</span><span class="op" id="1521016">&gt;&gt;</span><span class="num" id="1521018">3</span><span class="op" id="1521019">]</span><span class="op" id="1521020">]</span><span class="op" id="1521021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1521025">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1521029">return</span>&nbsp;<span class="builtintype" id="1521036">uintptr</span><span class="op" id="1521043">(</span><span class="ident" id="1521044">class_to_size</span><span class="op" id="1521057">[</span><span class="ident" id="1521058">size_to_class128</span><span class="op" id="1521074">[</span><span class="op" id="1521075">(</span><span class="ident" id="1521076">size</span><span class="op" id="1521080">-</span><span class="num" id="1521081">1024</span><span class="op" id="1521085">+</span><span class="num" id="1521086">127</span><span class="op" id="1521089">)</span><span class="op" id="1521090">&gt;&gt;</span><span class="num" id="1521092">7</span><span class="op" id="1521093">]</span><span class="op" id="1521094">]</span><span class="op" id="1521095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1521098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1521101">if</span>&nbsp;<span class="ident" id="1521104">size</span><span class="op" id="1521108">+</span><span class="ident" id="1521109">pageSize</span>&nbsp;<span class="op" id="1521118">&lt;</span>&nbsp;<span class="ident" id="1521120">size</span>&nbsp;<span class="op" id="1521125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1521129">return</span>&nbsp;<span class="ident" id="1521136">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1521142">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1521145">return</span>&nbsp;<span class="op" id="1521152">(</span><span class="ident" id="1521153">size</span>&nbsp;<span class="op" id="1521158">+</span>&nbsp;<span class="ident" id="1521160">pageSize</span>&nbsp;<span class="op" id="1521169">-</span>&nbsp;<span class="num" id="1521171">1</span><span class="op" id="1521172">)</span>&nbsp;<span class="op" id="1521174">&amp;^</span>&nbsp;<span class="ident" id="1521177">pageMask</span><br>
<span class="lineno"></span><span class="op" id="1521186">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1521189">func</span>&nbsp;<span class="ident" id="1521194">profilealloc</span><span class="op" id="1521206">(</span><span class="ident" id="1521207">mp</span>&nbsp;<span class="op" id="1521210">*</span><span class="ident" id="1521211">m</span><span class="op" id="1521212">,</span>&nbsp;<span class="ident" id="1521214">x</span>&nbsp;<span class="ident" id="1521216">unsafe</span><span class="op" id="1521222">.</span><span class="ident" id="1521223">Pointer</span><span class="op" id="1521230">,</span>&nbsp;<span class="ident" id="1521232">size</span>&nbsp;<span class="builtintype" id="1521237">uintptr</span><span class="op" id="1521244">)</span>&nbsp;<span class="op" id="1521246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1521249">c</span>&nbsp;<span class="op" id="1521251">:=</span>&nbsp;<span class="ident" id="1521254">mp</span><span class="op" id="1521256">.</span><span class="ident" id="1521257">mcache</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1521265">rate</span>&nbsp;<span class="op" id="1521270">:=</span>&nbsp;<span class="ident" id="1521273">MemProfileRate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1521289">if</span>&nbsp;<span class="ident" id="1521292">size</span>&nbsp;<span class="op" id="1521297">&lt;</span>&nbsp;<span class="builtintype" id="1521299">uintptr</span><span class="op" id="1521306">(</span><span class="ident" id="1521307">rate</span><span class="op" id="1521311">)</span>&nbsp;<span class="op" id="1521313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1521317">//&nbsp;pick&nbsp;next&nbsp;profile&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1521345">//&nbsp;If&nbsp;you&nbsp;change&nbsp;this,&nbsp;also&nbsp;change&nbsp;allocmcache.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1521395">if</span>&nbsp;<span class="ident" id="1521398">rate</span>&nbsp;<span class="op" id="1521403">&gt;</span>&nbsp;<span class="num" id="1521405">0x3fffffff</span>&nbsp;<span class="op" id="1521416">{</span>&nbsp;<span class="comment" id="1521418">//&nbsp;make&nbsp;2*rate&nbsp;not&nbsp;overflow</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1521449">rate</span>&nbsp;<span class="op" id="1521454">=</span>&nbsp;<span class="num" id="1521456">0x3fffffff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1521469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1521473">next</span>&nbsp;<span class="op" id="1521478">:=</span>&nbsp;<span class="builtintype" id="1521481">int32</span><span class="op" id="1521486">(</span><span class="ident" id="1521487">fastrand1</span><span class="op" id="1521496">(</span><span class="op" id="1521497">)</span><span class="op" id="1521498">)</span>&nbsp;<span class="op" id="1521500">%</span>&nbsp;<span class="op" id="1521502">(</span><span class="num" id="1521503">2</span>&nbsp;<span class="op" id="1521505">*</span>&nbsp;<span class="builtintype" id="1521507">int32</span><span class="op" id="1521512">(</span><span class="ident" id="1521513">rate</span><span class="op" id="1521517">)</span><span class="op" id="1521518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1521522">//&nbsp;Subtract&nbsp;the&nbsp;&#34;remainder&#34;&nbsp;of&nbsp;the&nbsp;current&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1521579">//&nbsp;Otherwise&nbsp;objects&nbsp;that&nbsp;are&nbsp;close&nbsp;in&nbsp;size&nbsp;to&nbsp;sampling&nbsp;rate</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1521642">//&nbsp;will&nbsp;be&nbsp;under-sampled,&nbsp;because&nbsp;we&nbsp;consistently&nbsp;discard&nbsp;this&nbsp;remainder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1521718">next</span>&nbsp;<span class="op" id="1521723">-=</span>&nbsp;<span class="op" id="1521726">(</span><span class="builtintype" id="1521727">int32</span><span class="op" id="1521732">(</span><span class="ident" id="1521733">size</span><span class="op" id="1521737">)</span>&nbsp;<span class="op" id="1521739">-</span>&nbsp;<span class="ident" id="1521741">c</span><span class="op" id="1521742">.</span><span class="ident" id="1521743">next_sample</span><span class="op" id="1521754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1521758">if</span>&nbsp;<span class="ident" id="1521761">next</span>&nbsp;<span class="op" id="1521766">&lt;</span>&nbsp;<span class="num" id="1521768">0</span>&nbsp;<span class="op" id="1521770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1521775">next</span>&nbsp;<span class="op" id="1521780">=</span>&nbsp;<span class="num" id="1521782">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1521786">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1521790">c</span><span class="op" id="1521791">.</span><span class="ident" id="1521792">next_sample</span>&nbsp;<span class="op" id="1521804">=</span>&nbsp;<span class="ident" id="1521806">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1521812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1521816">mProf_Malloc</span><span class="op" id="1521828">(</span><span class="ident" id="1521829">x</span><span class="op" id="1521830">,</span>&nbsp;<span class="ident" id="1521832">size</span><span class="op" id="1521836">)</span><br>
<span class="lineno"></span><span class="op" id="1521838">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span><span class="comment" id="1521841">//&nbsp;force&nbsp;=&nbsp;1&nbsp;-&nbsp;do&nbsp;GC&nbsp;regardless&nbsp;of&nbsp;current&nbsp;heap&nbsp;usage</span><br>
<span class="lineno"></span><span class="comment" id="1521895">//&nbsp;force&nbsp;=&nbsp;2&nbsp;-&nbsp;go&nbsp;GC&nbsp;and&nbsp;eager&nbsp;sweep</span><br>
<span class="lineno"></span><span class="keyword" id="1521932">func</span>&nbsp;<span class="ident" id="1521937">gogc</span><span class="op" id="1521941">(</span><span class="ident" id="1521942">force</span>&nbsp;<span class="builtintype" id="1521948">int32</span><span class="op" id="1521953">)</span>&nbsp;<span class="op" id="1521955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1521958">//&nbsp;The&nbsp;gc&nbsp;is&nbsp;turned&nbsp;off&nbsp;(via&nbsp;enablegc)&nbsp;until&nbsp;the&nbsp;bootstrap&nbsp;has&nbsp;completed.</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1522033">//&nbsp;Also,&nbsp;malloc&nbsp;gets&nbsp;called&nbsp;in&nbsp;the&nbsp;guts&nbsp;of&nbsp;a&nbsp;number&nbsp;of&nbsp;libraries&nbsp;that&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1522113">//&nbsp;holding&nbsp;locks.&nbsp;To&nbsp;avoid&nbsp;deadlocks&nbsp;during&nbsp;stoptheworld,&nbsp;don&#39;t&nbsp;bother</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1522185">//&nbsp;trying&nbsp;to&nbsp;run&nbsp;gc&nbsp;while&nbsp;holding&nbsp;a&nbsp;lock.&nbsp;The&nbsp;next&nbsp;mallocgc&nbsp;without&nbsp;a&nbsp;lock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1522261">//&nbsp;will&nbsp;do&nbsp;the&nbsp;gc&nbsp;instead.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1522289">mp</span>&nbsp;<span class="op" id="1522292">:=</span>&nbsp;<span class="ident" id="1522295">acquirem</span><span class="op" id="1522303">(</span><span class="op" id="1522304">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1522307">if</span>&nbsp;<span class="ident" id="1522310">gp</span>&nbsp;<span class="op" id="1522313">:=</span>&nbsp;<span class="ident" id="1522316">getg</span><span class="op" id="1522320">(</span><span class="op" id="1522321">)</span><span class="op" id="1522322">;</span>&nbsp;<span class="ident" id="1522324">gp</span>&nbsp;<span class="op" id="1522327">==</span>&nbsp;<span class="ident" id="1522330">mp</span><span class="op" id="1522332">.</span><span class="ident" id="1522333">g0</span>&nbsp;<span class="op" id="1522336">||</span>&nbsp;<span class="ident" id="1522339">mp</span><span class="op" id="1522341">.</span><span class="ident" id="1522342">locks</span>&nbsp;<span class="op" id="1522348">&gt;</span>&nbsp;<span class="num" id="1522350">1</span>&nbsp;<span class="op" id="1522352">||</span>&nbsp;<span class="op" id="1522355">!</span><span class="ident" id="1522356">memstats</span><span class="op" id="1522364">.</span><span class="ident" id="1522365">enablegc</span>&nbsp;<span class="op" id="1522374">||</span>&nbsp;<span class="ident" id="1522377">panicking</span>&nbsp;<span class="op" id="1522387">!=</span>&nbsp;<span class="num" id="1522390">0</span>&nbsp;<span class="op" id="1522392">||</span>&nbsp;<span class="ident" id="1522395">gcpercent</span>&nbsp;<span class="op" id="1522405">&lt;</span>&nbsp;<span class="num" id="1522407">0</span>&nbsp;<span class="op" id="1522409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1522413">releasem</span><span class="op" id="1522421">(</span><span class="ident" id="1522422">mp</span><span class="op" id="1522424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1522428">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1522436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1522439">releasem</span><span class="op" id="1522447">(</span><span class="ident" id="1522448">mp</span><span class="op" id="1522450">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1522453">mp</span>&nbsp;<span class="op" id="1522456">=</span>&nbsp;<span class="ident" id="1522458">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1522464">semacquire</span><span class="op" id="1522474">(</span><span class="op" id="1522475">&amp;</span><span class="ident" id="1522476">worldsema</span><span class="op" id="1522485">,</span>&nbsp;<span class="builtintype" id="1522487">false</span><span class="op" id="1522492">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1522496">if</span>&nbsp;<span class="ident" id="1522499">force</span>&nbsp;<span class="op" id="1522505">==</span>&nbsp;<span class="num" id="1522508">0</span>&nbsp;<span class="op" id="1522510">&amp;&amp;</span>&nbsp;<span class="ident" id="1522513">memstats</span><span class="op" id="1522521">.</span><span class="ident" id="1522522">heap_alloc</span>&nbsp;<span class="op" id="1522533">&lt;</span>&nbsp;<span class="ident" id="1522535">memstats</span><span class="op" id="1522543">.</span><span class="ident" id="1522544">next_gc</span>&nbsp;<span class="op" id="1522552">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1522556">//&nbsp;typically&nbsp;threads&nbsp;which&nbsp;lost&nbsp;the&nbsp;race&nbsp;to&nbsp;grab</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1522607">//&nbsp;worldsema&nbsp;exit&nbsp;here&nbsp;when&nbsp;gc&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1522649">semrelease</span><span class="op" id="1522659">(</span><span class="op" id="1522660">&amp;</span><span class="ident" id="1522661">worldsema</span><span class="op" id="1522670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1522674">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1522682">}</span><br>
<span class="lineno">435</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1522686">//&nbsp;Ok,&nbsp;we&#39;re&nbsp;doing&nbsp;it!&nbsp;&nbsp;Stop&nbsp;everybody&nbsp;else</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1522731">startTime</span>&nbsp;<span class="op" id="1522741">:=</span>&nbsp;<span class="ident" id="1522744">nanotime</span><span class="op" id="1522752">(</span><span class="op" id="1522753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1522756">mp</span>&nbsp;<span class="op" id="1522759">=</span>&nbsp;<span class="ident" id="1522761">acquirem</span><span class="op" id="1522769">(</span><span class="op" id="1522770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1522773">mp</span><span class="op" id="1522775">.</span><span class="ident" id="1522776">gcing</span>&nbsp;<span class="op" id="1522782">=</span>&nbsp;<span class="num" id="1522784">1</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1522787">releasem</span><span class="op" id="1522795">(</span><span class="ident" id="1522796">mp</span><span class="op" id="1522798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1522801">onM</span><span class="op" id="1522804">(</span><span class="ident" id="1522805">stoptheworld</span><span class="op" id="1522817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1522820">if</span>&nbsp;<span class="ident" id="1522823">mp</span>&nbsp;<span class="op" id="1522826">!=</span>&nbsp;<span class="ident" id="1522829">acquirem</span><span class="op" id="1522837">(</span><span class="op" id="1522838">)</span>&nbsp;<span class="op" id="1522840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1522844">gothrow</span><span class="op" id="1522851">(</span><span class="string" id="1522852">&#34;gogc:&nbsp;rescheduled&#34;</span><span class="op" id="1522871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1522874">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1522878">clearpools</span><span class="op" id="1522888">(</span><span class="op" id="1522889">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1522893">//&nbsp;Run&nbsp;gc&nbsp;on&nbsp;the&nbsp;g0&nbsp;stack.&nbsp;&nbsp;We&nbsp;do&nbsp;this&nbsp;so&nbsp;that&nbsp;the&nbsp;g&nbsp;stack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1522953">//&nbsp;we&#39;re&nbsp;currently&nbsp;running&nbsp;on&nbsp;will&nbsp;no&nbsp;longer&nbsp;change.&nbsp;&nbsp;Cuts</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1523013">//&nbsp;the&nbsp;root&nbsp;set&nbsp;down&nbsp;a&nbsp;bit&nbsp;(g0&nbsp;stacks&nbsp;are&nbsp;not&nbsp;scanned,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1523073">//&nbsp;we&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;scan&nbsp;gc&#39;s&nbsp;internal&nbsp;state).&nbsp;&nbsp;We&nbsp;also</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1523130">//&nbsp;need&nbsp;to&nbsp;switch&nbsp;to&nbsp;g0&nbsp;so&nbsp;we&nbsp;can&nbsp;shrink&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1523183">n</span>&nbsp;<span class="op" id="1523185">:=</span>&nbsp;<span class="num" id="1523188">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1523191">if</span>&nbsp;<span class="ident" id="1523194">debug</span><span class="op" id="1523199">.</span><span class="ident" id="1523200">gctrace</span>&nbsp;<span class="op" id="1523208">&gt;</span>&nbsp;<span class="num" id="1523210">1</span>&nbsp;<span class="op" id="1523212">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1523216">n</span>&nbsp;<span class="op" id="1523218">=</span>&nbsp;<span class="num" id="1523220">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1523223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1523226">for</span>&nbsp;<span class="ident" id="1523230">i</span>&nbsp;<span class="op" id="1523232">:=</span>&nbsp;<span class="num" id="1523235">0</span><span class="op" id="1523236">;</span>&nbsp;<span class="ident" id="1523238">i</span>&nbsp;<span class="op" id="1523240">&lt;</span>&nbsp;<span class="ident" id="1523242">n</span><span class="op" id="1523243">;</span>&nbsp;<span class="ident" id="1523245">i</span><span class="op" id="1523246">++</span>&nbsp;<span class="op" id="1523249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1523253">if</span>&nbsp;<span class="ident" id="1523256">i</span>&nbsp;<span class="op" id="1523258">&gt;</span>&nbsp;<span class="num" id="1523260">0</span>&nbsp;<span class="op" id="1523262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1523267">startTime</span>&nbsp;<span class="op" id="1523277">=</span>&nbsp;<span class="ident" id="1523279">nanotime</span><span class="op" id="1523287">(</span><span class="op" id="1523288">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1523292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1523296">//&nbsp;switch&nbsp;to&nbsp;g0,&nbsp;call&nbsp;gc,&nbsp;then&nbsp;switch&nbsp;back</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1523341">mp</span><span class="op" id="1523343">.</span><span class="ident" id="1523344">scalararg</span><span class="op" id="1523353">[</span><span class="num" id="1523354">0</span><span class="op" id="1523355">]</span>&nbsp;<span class="op" id="1523357">=</span>&nbsp;<span class="builtintype" id="1523359">uintptr</span><span class="op" id="1523366">(</span><span class="builtintype" id="1523367">uint32</span><span class="op" id="1523373">(</span><span class="ident" id="1523374">startTime</span><span class="op" id="1523383">)</span><span class="op" id="1523384">)</span>&nbsp;<span class="comment" id="1523386">//&nbsp;low&nbsp;32&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1523403">mp</span><span class="op" id="1523405">.</span><span class="ident" id="1523406">scalararg</span><span class="op" id="1523415">[</span><span class="num" id="1523416">1</span><span class="op" id="1523417">]</span>&nbsp;<span class="op" id="1523419">=</span>&nbsp;<span class="builtintype" id="1523421">uintptr</span><span class="op" id="1523428">(</span><span class="ident" id="1523429">startTime</span>&nbsp;<span class="op" id="1523439">&gt;&gt;</span>&nbsp;<span class="num" id="1523442">32</span><span class="op" id="1523444">)</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="1523448">//&nbsp;high&nbsp;32&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1523466">if</span>&nbsp;<span class="ident" id="1523469">force</span>&nbsp;<span class="op" id="1523475">&gt;=</span>&nbsp;<span class="num" id="1523478">2</span>&nbsp;<span class="op" id="1523480">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1523485">mp</span><span class="op" id="1523487">.</span><span class="ident" id="1523488">scalararg</span><span class="op" id="1523497">[</span><span class="num" id="1523498">2</span><span class="op" id="1523499">]</span>&nbsp;<span class="op" id="1523501">=</span>&nbsp;<span class="num" id="1523503">1</span>&nbsp;<span class="comment" id="1523505">//&nbsp;eagersweep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1523521">}</span>&nbsp;<span class="keyword" id="1523523">else</span>&nbsp;<span class="op" id="1523528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1523533">mp</span><span class="op" id="1523535">.</span><span class="ident" id="1523536">scalararg</span><span class="op" id="1523545">[</span><span class="num" id="1523546">2</span><span class="op" id="1523547">]</span>&nbsp;<span class="op" id="1523549">=</span>&nbsp;<span class="num" id="1523551">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1523555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1523559">onM</span><span class="op" id="1523562">(</span><span class="ident" id="1523563">gc_m</span><span class="op" id="1523567">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1523570">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1523574">//&nbsp;all&nbsp;done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1523587">mp</span><span class="op" id="1523589">.</span><span class="ident" id="1523590">gcing</span>&nbsp;<span class="op" id="1523596">=</span>&nbsp;<span class="num" id="1523598">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1523601">semrelease</span><span class="op" id="1523611">(</span><span class="op" id="1523612">&amp;</span><span class="ident" id="1523613">worldsema</span><span class="op" id="1523622">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1523625">onM</span><span class="op" id="1523628">(</span><span class="ident" id="1523629">starttheworld</span><span class="op" id="1523642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1523645">releasem</span><span class="op" id="1523653">(</span><span class="ident" id="1523654">mp</span><span class="op" id="1523656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1523659">mp</span>&nbsp;<span class="op" id="1523662">=</span>&nbsp;<span class="ident" id="1523664">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1523670">//&nbsp;now&nbsp;that&nbsp;gc&nbsp;is&nbsp;done,&nbsp;kick&nbsp;off&nbsp;finalizer&nbsp;thread&nbsp;if&nbsp;needed</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1523731">if</span>&nbsp;<span class="op" id="1523734">!</span><span class="ident" id="1523735">concurrentSweep</span>&nbsp;<span class="op" id="1523751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1523755">//&nbsp;give&nbsp;the&nbsp;queued&nbsp;finalizers,&nbsp;if&nbsp;any,&nbsp;a&nbsp;chance&nbsp;to&nbsp;run</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1523812">Gosched</span><span class="op" id="1523819">(</span><span class="op" id="1523820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1523823">}</span><br>
<span class="lineno"></span><span class="op" id="1523825">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="comment" id="1523828">//&nbsp;GC&nbsp;runs&nbsp;a&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span><span class="keyword" id="1523861">func</span>&nbsp;<span class="ident" id="1523866">GC</span><span class="op" id="1523868">(</span><span class="op" id="1523869">)</span>&nbsp;<span class="op" id="1523871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1523874">gogc</span><span class="op" id="1523878">(</span><span class="num" id="1523879">2</span><span class="op" id="1523880">)</span><br>
<span class="lineno"></span><span class="op" id="1523882">}</span><br>
<span class="lineno">490</span><br>
<span class="lineno"></span><span class="comment" id="1523885">//&nbsp;linker-provided</span><br>
<span class="lineno"></span><span class="keyword" id="1523904">var</span>&nbsp;<span class="ident" id="1523908">noptrdata</span>&nbsp;<span class="keyword" id="1523918">struct</span><span class="op" id="1523924">{</span><span class="op" id="1523925">}</span><br>
<span class="lineno"></span><span class="keyword" id="1523927">var</span>&nbsp;<span class="ident" id="1523931">enoptrdata</span>&nbsp;<span class="keyword" id="1523942">struct</span><span class="op" id="1523948">{</span><span class="op" id="1523949">}</span><br>
<span class="lineno"></span><span class="keyword" id="1523951">var</span>&nbsp;<span class="ident" id="1523955">noptrbss</span>&nbsp;<span class="keyword" id="1523964">struct</span><span class="op" id="1523970">{</span><span class="op" id="1523971">}</span><br>
<span class="lineno">495</span><span class="keyword" id="1523973">var</span>&nbsp;<span class="ident" id="1523977">enoptrbss</span>&nbsp;<span class="keyword" id="1523987">struct</span><span class="op" id="1523993">{</span><span class="op" id="1523994">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1523997">//&nbsp;SetFinalizer&nbsp;sets&nbsp;the&nbsp;finalizer&nbsp;associated&nbsp;with&nbsp;x&nbsp;to&nbsp;f.</span><br>
<span class="lineno"></span><span class="comment" id="1524056">//&nbsp;When&nbsp;the&nbsp;garbage&nbsp;collector&nbsp;finds&nbsp;an&nbsp;unreachable&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="1524113">//&nbsp;with&nbsp;an&nbsp;associated&nbsp;finalizer,&nbsp;it&nbsp;clears&nbsp;the&nbsp;association&nbsp;and&nbsp;runs</span><br>
<span class="lineno">500</span><span class="comment" id="1524181">//&nbsp;f(x)&nbsp;in&nbsp;a&nbsp;separate&nbsp;goroutine.&nbsp;&nbsp;This&nbsp;makes&nbsp;x&nbsp;reachable&nbsp;again,&nbsp;but</span><br>
<span class="lineno"></span><span class="comment" id="1524249">//&nbsp;now&nbsp;without&nbsp;an&nbsp;associated&nbsp;finalizer.&nbsp;&nbsp;Assuming&nbsp;that&nbsp;SetFinalizer</span><br>
<span class="lineno"></span><span class="comment" id="1524317">//&nbsp;is&nbsp;not&nbsp;called&nbsp;again,&nbsp;the&nbsp;next&nbsp;time&nbsp;the&nbsp;garbage&nbsp;collector&nbsp;sees</span><br>
<span class="lineno"></span><span class="comment" id="1524382">//&nbsp;that&nbsp;x&nbsp;is&nbsp;unreachable,&nbsp;it&nbsp;will&nbsp;free&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment" id="1524424">//</span><br>
<span class="lineno">505</span><span class="comment" id="1524427">//&nbsp;SetFinalizer(x,&nbsp;nil)&nbsp;clears&nbsp;any&nbsp;finalizer&nbsp;associated&nbsp;with&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment" id="1524491">//</span><br>
<span class="lineno"></span><span class="comment" id="1524494">//&nbsp;The&nbsp;argument&nbsp;x&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer&nbsp;to&nbsp;an&nbsp;object&nbsp;allocated&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="1524556">//&nbsp;calling&nbsp;new&nbsp;or&nbsp;by&nbsp;taking&nbsp;the&nbsp;address&nbsp;of&nbsp;a&nbsp;composite&nbsp;literal.</span><br>
<span class="lineno"></span><span class="comment" id="1524620">//&nbsp;The&nbsp;argument&nbsp;f&nbsp;must&nbsp;be&nbsp;a&nbsp;function&nbsp;that&nbsp;takes&nbsp;a&nbsp;single&nbsp;argument</span><br>
<span class="lineno">510</span><span class="comment" id="1524686">//&nbsp;to&nbsp;which&nbsp;x&#39;s&nbsp;type&nbsp;can&nbsp;be&nbsp;assigned,&nbsp;and&nbsp;can&nbsp;have&nbsp;arbitrary&nbsp;ignored&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="1524762">//&nbsp;values.&nbsp;If&nbsp;either&nbsp;of&nbsp;these&nbsp;is&nbsp;not&nbsp;true,&nbsp;SetFinalizer&nbsp;aborts&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1524829">//&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="1524841">//</span><br>
<span class="lineno"></span><span class="comment" id="1524844">//&nbsp;Finalizers&nbsp;are&nbsp;run&nbsp;in&nbsp;dependency&nbsp;order:&nbsp;if&nbsp;A&nbsp;points&nbsp;at&nbsp;B,&nbsp;both&nbsp;have</span><br>
<span class="lineno">515</span><span class="comment" id="1524915">//&nbsp;finalizers,&nbsp;and&nbsp;they&nbsp;are&nbsp;otherwise&nbsp;unreachable,&nbsp;only&nbsp;the&nbsp;finalizer</span><br>
<span class="lineno"></span><span class="comment" id="1524985">//&nbsp;for&nbsp;A&nbsp;runs;&nbsp;once&nbsp;A&nbsp;is&nbsp;freed,&nbsp;the&nbsp;finalizer&nbsp;for&nbsp;B&nbsp;can&nbsp;run.</span><br>
<span class="lineno"></span><span class="comment" id="1525046">//&nbsp;If&nbsp;a&nbsp;cyclic&nbsp;structure&nbsp;includes&nbsp;a&nbsp;block&nbsp;with&nbsp;a&nbsp;finalizer,&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="1525111">//&nbsp;cycle&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;to&nbsp;be&nbsp;garbage&nbsp;collected&nbsp;and&nbsp;the&nbsp;finalizer</span><br>
<span class="lineno"></span><span class="comment" id="1525180">//&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;to&nbsp;run,&nbsp;because&nbsp;there&nbsp;is&nbsp;no&nbsp;ordering&nbsp;that</span><br>
<span class="lineno">520</span><span class="comment" id="1525243">//&nbsp;respects&nbsp;the&nbsp;dependencies.</span><br>
<span class="lineno"></span><span class="comment" id="1525273">//</span><br>
<span class="lineno"></span><span class="comment" id="1525276">//&nbsp;The&nbsp;finalizer&nbsp;for&nbsp;x&nbsp;is&nbsp;scheduled&nbsp;to&nbsp;run&nbsp;at&nbsp;some&nbsp;arbitrary&nbsp;time&nbsp;after</span><br>
<span class="lineno"></span><span class="comment" id="1525348">//&nbsp;x&nbsp;becomes&nbsp;unreachable.</span><br>
<span class="lineno"></span><span class="comment" id="1525374">//&nbsp;There&nbsp;is&nbsp;no&nbsp;guarantee&nbsp;that&nbsp;finalizers&nbsp;will&nbsp;run&nbsp;before&nbsp;a&nbsp;program&nbsp;exits,</span><br>
<span class="lineno">525</span><span class="comment" id="1525448">//&nbsp;so&nbsp;typically&nbsp;they&nbsp;are&nbsp;useful&nbsp;only&nbsp;for&nbsp;releasing&nbsp;non-memory&nbsp;resources</span><br>
<span class="lineno"></span><span class="comment" id="1525520">//&nbsp;associated&nbsp;with&nbsp;an&nbsp;object&nbsp;during&nbsp;a&nbsp;long-running&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="1525580">//&nbsp;For&nbsp;example,&nbsp;an&nbsp;os.File&nbsp;object&nbsp;could&nbsp;use&nbsp;a&nbsp;finalizer&nbsp;to&nbsp;close&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1525649">//&nbsp;associated&nbsp;operating&nbsp;system&nbsp;file&nbsp;descriptor&nbsp;when&nbsp;a&nbsp;program&nbsp;discards</span><br>
<span class="lineno"></span><span class="comment" id="1525720">//&nbsp;an&nbsp;os.File&nbsp;without&nbsp;calling&nbsp;Close,&nbsp;but&nbsp;it&nbsp;would&nbsp;be&nbsp;a&nbsp;mistake</span><br>
<span class="lineno">530</span><span class="comment" id="1525783">//&nbsp;to&nbsp;depend&nbsp;on&nbsp;a&nbsp;finalizer&nbsp;to&nbsp;flush&nbsp;an&nbsp;in-memory&nbsp;I/O&nbsp;buffer&nbsp;such&nbsp;as&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1525854">//&nbsp;bufio.Writer,&nbsp;because&nbsp;the&nbsp;buffer&nbsp;would&nbsp;not&nbsp;be&nbsp;flushed&nbsp;at&nbsp;program&nbsp;exit.</span><br>
<span class="lineno"></span><span class="comment" id="1525928">//</span><br>
<span class="lineno"></span><span class="comment" id="1525931">//&nbsp;It&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;that&nbsp;a&nbsp;finalizer&nbsp;will&nbsp;run&nbsp;if&nbsp;the&nbsp;size&nbsp;of&nbsp;*x&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1526002">//&nbsp;zero&nbsp;bytes.</span><br>
<span class="lineno">535</span><span class="comment" id="1526017">//</span><br>
<span class="lineno"></span><span class="comment" id="1526020">//&nbsp;It&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;that&nbsp;a&nbsp;finalizer&nbsp;will&nbsp;run&nbsp;for&nbsp;objects&nbsp;allocated</span><br>
<span class="lineno"></span><span class="comment" id="1526092">//&nbsp;in&nbsp;initializers&nbsp;for&nbsp;package-level&nbsp;variables.&nbsp;Such&nbsp;objects&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1526160">//&nbsp;linker-allocated,&nbsp;not&nbsp;heap-allocated.</span><br>
<span class="lineno"></span><span class="comment" id="1526201">//</span><br>
<span class="lineno">540</span><span class="comment" id="1526204">//&nbsp;A&nbsp;single&nbsp;goroutine&nbsp;runs&nbsp;all&nbsp;finalizers&nbsp;for&nbsp;a&nbsp;program,&nbsp;sequentially.</span><br>
<span class="lineno"></span><span class="comment" id="1526275">//&nbsp;If&nbsp;a&nbsp;finalizer&nbsp;must&nbsp;run&nbsp;for&nbsp;a&nbsp;long&nbsp;time,&nbsp;it&nbsp;should&nbsp;do&nbsp;so&nbsp;by&nbsp;starting</span><br>
<span class="lineno"></span><span class="comment" id="1526347">//&nbsp;a&nbsp;new&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1526367">func</span>&nbsp;<span class="ident" id="1526372">SetFinalizer</span><span class="op" id="1526384">(</span><span class="ident" id="1526385">obj</span>&nbsp;<span class="keyword" id="1526389">interface</span><span class="op" id="1526398">{</span><span class="op" id="1526399">}</span><span class="op" id="1526400">,</span>&nbsp;<span class="ident" id="1526402">finalizer</span>&nbsp;<span class="keyword" id="1526412">interface</span><span class="op" id="1526421">{</span><span class="op" id="1526422">}</span><span class="op" id="1526423">)</span>&nbsp;<span class="op" id="1526425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526428">e</span>&nbsp;<span class="op" id="1526430">:=</span>&nbsp;<span class="op" id="1526433">(</span><span class="op" id="1526434">*</span><span class="ident" id="1526435">eface</span><span class="op" id="1526440">)</span><span class="op" id="1526441">(</span><span class="ident" id="1526442">unsafe</span><span class="op" id="1526448">.</span><span class="ident" id="1526449">Pointer</span><span class="op" id="1526456">(</span><span class="op" id="1526457">&amp;</span><span class="ident" id="1526458">obj</span><span class="op" id="1526461">)</span><span class="op" id="1526462">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526465">etyp</span>&nbsp;<span class="op" id="1526470">:=</span>&nbsp;<span class="ident" id="1526473">e</span><span class="op" id="1526474">.</span><span class="ident" id="1526475">_type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1526482">if</span>&nbsp;<span class="ident" id="1526485">etyp</span>&nbsp;<span class="op" id="1526490">==</span>&nbsp;<span class="ident" id="1526493">nil</span>&nbsp;<span class="op" id="1526497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526501">gothrow</span><span class="op" id="1526508">(</span><span class="string" id="1526509">&#34;runtime.SetFinalizer:&nbsp;first&nbsp;argument&nbsp;is&nbsp;nil&#34;</span><span class="op" id="1526554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1526557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1526560">if</span>&nbsp;<span class="ident" id="1526563">etyp</span><span class="op" id="1526567">.</span><span class="ident" id="1526568">kind</span><span class="op" id="1526572">&amp;</span><span class="ident" id="1526573">kindMask</span>&nbsp;<span class="op" id="1526582">!=</span>&nbsp;<span class="ident" id="1526585">kindPtr</span>&nbsp;<span class="op" id="1526593">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526597">gothrow</span><span class="op" id="1526604">(</span><span class="string" id="1526605">&#34;runtime.SetFinalizer:&nbsp;first&nbsp;argument&nbsp;is&nbsp;&#34;</span>&nbsp;<span class="op" id="1526648">+</span>&nbsp;<span class="op" id="1526650">*</span><span class="ident" id="1526651">etyp</span><span class="op" id="1526655">.</span><span class="ident" id="1526656">_string</span>&nbsp;<span class="op" id="1526664">+</span>&nbsp;<span class="string" id="1526666">&#34;,&nbsp;not&nbsp;pointer&#34;</span><span class="op" id="1526681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1526684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526687">ot</span>&nbsp;<span class="op" id="1526690">:=</span>&nbsp;<span class="op" id="1526693">(</span><span class="op" id="1526694">*</span><span class="ident" id="1526695">ptrtype</span><span class="op" id="1526702">)</span><span class="op" id="1526703">(</span><span class="ident" id="1526704">unsafe</span><span class="op" id="1526710">.</span><span class="ident" id="1526711">Pointer</span><span class="op" id="1526718">(</span><span class="ident" id="1526719">etyp</span><span class="op" id="1526723">)</span><span class="op" id="1526724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1526727">if</span>&nbsp;<span class="ident" id="1526730">ot</span><span class="op" id="1526732">.</span><span class="ident" id="1526733">elem</span>&nbsp;<span class="op" id="1526738">==</span>&nbsp;<span class="ident" id="1526741">nil</span>&nbsp;<span class="op" id="1526745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526749">gothrow</span><span class="op" id="1526756">(</span><span class="string" id="1526757">&#34;nil&nbsp;elem&nbsp;type!&#34;</span><span class="op" id="1526773">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1526776">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1526780">//&nbsp;find&nbsp;the&nbsp;containing&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526811">_</span><span class="op" id="1526812">,</span>&nbsp;<span class="ident" id="1526814">base</span><span class="op" id="1526818">,</span>&nbsp;<span class="ident" id="1526820">_</span>&nbsp;<span class="op" id="1526822">:=</span>&nbsp;<span class="ident" id="1526825">findObject</span><span class="op" id="1526835">(</span><span class="ident" id="1526836">e</span><span class="op" id="1526837">.</span><span class="ident" id="1526838">data</span><span class="op" id="1526842">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1526846">if</span>&nbsp;<span class="ident" id="1526849">base</span>&nbsp;<span class="op" id="1526854">==</span>&nbsp;<span class="ident" id="1526857">nil</span>&nbsp;<span class="op" id="1526861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1526865">//&nbsp;0-length&nbsp;objects&nbsp;are&nbsp;okay.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1526897">if</span>&nbsp;<span class="ident" id="1526900">e</span><span class="op" id="1526901">.</span><span class="ident" id="1526902">data</span>&nbsp;<span class="op" id="1526907">==</span>&nbsp;<span class="ident" id="1526910">unsafe</span><span class="op" id="1526916">.</span><span class="ident" id="1526917">Pointer</span><span class="op" id="1526924">(</span><span class="op" id="1526925">&amp;</span><span class="ident" id="1526926">zerobase</span><span class="op" id="1526934">)</span>&nbsp;<span class="op" id="1526936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1526941">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1526950">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1526955">//&nbsp;Global&nbsp;initializers&nbsp;might&nbsp;be&nbsp;linker-allocated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1527007">//&nbsp;&nbsp;&nbsp;&nbspvar&nbsp;Foo&nbsp;=&nbsp;&amp;Object{}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1527032">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;main()&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1527051">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspruntime.SetFinalizer(Foo,&nbsp;nil)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1527088">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1527095">//&nbsp;The&nbsp;relevant&nbsp;segments&nbsp;are:&nbsp;noptrdata,&nbsp;data,&nbsp;bss,&nbsp;noptrbss.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1527159">//&nbsp;We&nbsp;cannot&nbsp;assume&nbsp;they&nbsp;are&nbsp;in&nbsp;any&nbsp;order&nbsp;or&nbsp;even&nbsp;contiguous,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1527223">//&nbsp;due&nbsp;to&nbsp;external&nbsp;linking.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1527253">if</span>&nbsp;<span class="builtintype" id="1527256">uintptr</span><span class="op" id="1527263">(</span><span class="ident" id="1527264">unsafe</span><span class="op" id="1527270">.</span><span class="ident" id="1527271">Pointer</span><span class="op" id="1527278">(</span><span class="op" id="1527279">&amp;</span><span class="ident" id="1527280">noptrdata</span><span class="op" id="1527289">)</span><span class="op" id="1527290">)</span>&nbsp;<span class="op" id="1527292">&lt;=</span>&nbsp;<span class="builtintype" id="1527295">uintptr</span><span class="op" id="1527302">(</span><span class="ident" id="1527303">e</span><span class="op" id="1527304">.</span><span class="ident" id="1527305">data</span><span class="op" id="1527309">)</span>&nbsp;<span class="op" id="1527311">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1527314">uintptr</span><span class="op" id="1527321">(</span><span class="ident" id="1527322">e</span><span class="op" id="1527323">.</span><span class="ident" id="1527324">data</span><span class="op" id="1527328">)</span>&nbsp;<span class="op" id="1527330">&lt;</span>&nbsp;<span class="builtintype" id="1527332">uintptr</span><span class="op" id="1527339">(</span><span class="ident" id="1527340">unsafe</span><span class="op" id="1527346">.</span><span class="ident" id="1527347">Pointer</span><span class="op" id="1527354">(</span><span class="op" id="1527355">&amp;</span><span class="ident" id="1527356">enoptrdata</span><span class="op" id="1527366">)</span><span class="op" id="1527367">)</span>&nbsp;<span class="op" id="1527369">||</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="1527375">uintptr</span><span class="op" id="1527382">(</span><span class="ident" id="1527383">unsafe</span><span class="op" id="1527389">.</span><span class="ident" id="1527390">Pointer</span><span class="op" id="1527397">(</span><span class="op" id="1527398">&amp;</span><span class="ident" id="1527399">data</span><span class="op" id="1527403">)</span><span class="op" id="1527404">)</span>&nbsp;<span class="op" id="1527406">&lt;=</span>&nbsp;<span class="builtintype" id="1527409">uintptr</span><span class="op" id="1527416">(</span><span class="ident" id="1527417">e</span><span class="op" id="1527418">.</span><span class="ident" id="1527419">data</span><span class="op" id="1527423">)</span>&nbsp;<span class="op" id="1527425">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1527428">uintptr</span><span class="op" id="1527435">(</span><span class="ident" id="1527436">e</span><span class="op" id="1527437">.</span><span class="ident" id="1527438">data</span><span class="op" id="1527442">)</span>&nbsp;<span class="op" id="1527444">&lt;</span>&nbsp;<span class="builtintype" id="1527446">uintptr</span><span class="op" id="1527453">(</span><span class="ident" id="1527454">unsafe</span><span class="op" id="1527460">.</span><span class="ident" id="1527461">Pointer</span><span class="op" id="1527468">(</span><span class="op" id="1527469">&amp;</span><span class="ident" id="1527470">edata</span><span class="op" id="1527475">)</span><span class="op" id="1527476">)</span>&nbsp;<span class="op" id="1527478">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="1527484">uintptr</span><span class="op" id="1527491">(</span><span class="ident" id="1527492">unsafe</span><span class="op" id="1527498">.</span><span class="ident" id="1527499">Pointer</span><span class="op" id="1527506">(</span><span class="op" id="1527507">&amp;</span><span class="ident" id="1527508">bss</span><span class="op" id="1527511">)</span><span class="op" id="1527512">)</span>&nbsp;<span class="op" id="1527514">&lt;=</span>&nbsp;<span class="builtintype" id="1527517">uintptr</span><span class="op" id="1527524">(</span><span class="ident" id="1527525">e</span><span class="op" id="1527526">.</span><span class="ident" id="1527527">data</span><span class="op" id="1527531">)</span>&nbsp;<span class="op" id="1527533">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1527536">uintptr</span><span class="op" id="1527543">(</span><span class="ident" id="1527544">e</span><span class="op" id="1527545">.</span><span class="ident" id="1527546">data</span><span class="op" id="1527550">)</span>&nbsp;<span class="op" id="1527552">&lt;</span>&nbsp;<span class="builtintype" id="1527554">uintptr</span><span class="op" id="1527561">(</span><span class="ident" id="1527562">unsafe</span><span class="op" id="1527568">.</span><span class="ident" id="1527569">Pointer</span><span class="op" id="1527576">(</span><span class="op" id="1527577">&amp;</span><span class="ident" id="1527578">ebss</span><span class="op" id="1527582">)</span><span class="op" id="1527583">)</span>&nbsp;<span class="op" id="1527585">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="1527591">uintptr</span><span class="op" id="1527598">(</span><span class="ident" id="1527599">unsafe</span><span class="op" id="1527605">.</span><span class="ident" id="1527606">Pointer</span><span class="op" id="1527613">(</span><span class="op" id="1527614">&amp;</span><span class="ident" id="1527615">noptrbss</span><span class="op" id="1527623">)</span><span class="op" id="1527624">)</span>&nbsp;<span class="op" id="1527626">&lt;=</span>&nbsp;<span class="builtintype" id="1527629">uintptr</span><span class="op" id="1527636">(</span><span class="ident" id="1527637">e</span><span class="op" id="1527638">.</span><span class="ident" id="1527639">data</span><span class="op" id="1527643">)</span>&nbsp;<span class="op" id="1527645">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1527648">uintptr</span><span class="op" id="1527655">(</span><span class="ident" id="1527656">e</span><span class="op" id="1527657">.</span><span class="ident" id="1527658">data</span><span class="op" id="1527662">)</span>&nbsp;<span class="op" id="1527664">&lt;</span>&nbsp;<span class="builtintype" id="1527666">uintptr</span><span class="op" id="1527673">(</span><span class="ident" id="1527674">unsafe</span><span class="op" id="1527680">.</span><span class="ident" id="1527681">Pointer</span><span class="op" id="1527688">(</span><span class="op" id="1527689">&amp;</span><span class="ident" id="1527690">enoptrbss</span><span class="op" id="1527699">)</span><span class="op" id="1527700">)</span>&nbsp;<span class="op" id="1527702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1527707">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1527716">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1527720">gothrow</span><span class="op" id="1527727">(</span><span class="string" id="1527728">&#34;runtime.SetFinalizer:&nbsp;pointer&nbsp;not&nbsp;in&nbsp;allocated&nbsp;block&#34;</span><span class="op" id="1527782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1527785">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1527789">if</span>&nbsp;<span class="ident" id="1527792">e</span><span class="op" id="1527793">.</span><span class="ident" id="1527794">data</span>&nbsp;<span class="op" id="1527799">!=</span>&nbsp;<span class="ident" id="1527802">base</span>&nbsp;<span class="op" id="1527807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1527811">//&nbsp;As&nbsp;an&nbsp;implementation&nbsp;detail&nbsp;we&nbsp;allow&nbsp;to&nbsp;set&nbsp;finalizers&nbsp;for&nbsp;an&nbsp;inner&nbsp;byte</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1527889">//&nbsp;of&nbsp;an&nbsp;object&nbsp;if&nbsp;it&nbsp;could&nbsp;come&nbsp;from&nbsp;tiny&nbsp;alloc&nbsp;(see&nbsp;mallocgc&nbsp;for&nbsp;details).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1527968">if</span>&nbsp;<span class="ident" id="1527971">ot</span><span class="op" id="1527973">.</span><span class="ident" id="1527974">elem</span>&nbsp;<span class="op" id="1527979">==</span>&nbsp;<span class="ident" id="1527982">nil</span>&nbsp;<span class="op" id="1527986">||</span>&nbsp;<span class="ident" id="1527989">ot</span><span class="op" id="1527991">.</span><span class="ident" id="1527992">elem</span><span class="op" id="1527996">.</span><span class="ident" id="1527997">kind</span><span class="op" id="1528001">&amp;</span><span class="ident" id="1528002">kindNoPointers</span>&nbsp;<span class="op" id="1528017">==</span>&nbsp;<span class="num" id="1528020">0</span>&nbsp;<span class="op" id="1528022">||</span>&nbsp;<span class="ident" id="1528025">ot</span><span class="op" id="1528027">.</span><span class="ident" id="1528028">elem</span><span class="op" id="1528032">.</span><span class="ident" id="1528033">size</span>&nbsp;<span class="op" id="1528038">&gt;=</span>&nbsp;<span class="ident" id="1528041">maxTinySize</span>&nbsp;<span class="op" id="1528053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528058">gothrow</span><span class="op" id="1528065">(</span><span class="string" id="1528066">&#34;runtime.SetFinalizer:&nbsp;pointer&nbsp;not&nbsp;at&nbsp;beginning&nbsp;of&nbsp;allocated&nbsp;block&#34;</span><span class="op" id="1528133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1528137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1528140">}</span><br>
<span class="lineno">590</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528144">f</span>&nbsp;<span class="op" id="1528146">:=</span>&nbsp;<span class="op" id="1528149">(</span><span class="op" id="1528150">*</span><span class="ident" id="1528151">eface</span><span class="op" id="1528156">)</span><span class="op" id="1528157">(</span><span class="ident" id="1528158">unsafe</span><span class="op" id="1528164">.</span><span class="ident" id="1528165">Pointer</span><span class="op" id="1528172">(</span><span class="op" id="1528173">&amp;</span><span class="ident" id="1528174">finalizer</span><span class="op" id="1528183">)</span><span class="op" id="1528184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528187">ftyp</span>&nbsp;<span class="op" id="1528192">:=</span>&nbsp;<span class="ident" id="1528195">f</span><span class="op" id="1528196">.</span><span class="ident" id="1528197">_type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1528204">if</span>&nbsp;<span class="ident" id="1528207">ftyp</span>&nbsp;<span class="op" id="1528212">==</span>&nbsp;<span class="ident" id="1528215">nil</span>&nbsp;<span class="op" id="1528219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1528223">//&nbsp;switch&nbsp;to&nbsp;M&nbsp;stack&nbsp;and&nbsp;remove&nbsp;finalizer</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528267">mp</span>&nbsp;<span class="op" id="1528270">:=</span>&nbsp;<span class="ident" id="1528273">acquirem</span><span class="op" id="1528281">(</span><span class="op" id="1528282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528286">mp</span><span class="op" id="1528288">.</span><span class="ident" id="1528289">ptrarg</span><span class="op" id="1528295">[</span><span class="num" id="1528296">0</span><span class="op" id="1528297">]</span>&nbsp;<span class="op" id="1528299">=</span>&nbsp;<span class="ident" id="1528301">e</span><span class="op" id="1528302">.</span><span class="ident" id="1528303">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528310">onM</span><span class="op" id="1528313">(</span><span class="ident" id="1528314">removeFinalizer_m</span><span class="op" id="1528331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528335">releasem</span><span class="op" id="1528343">(</span><span class="ident" id="1528344">mp</span><span class="op" id="1528346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1528350">return</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1528358">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1528362">if</span>&nbsp;<span class="ident" id="1528365">ftyp</span><span class="op" id="1528369">.</span><span class="ident" id="1528370">kind</span><span class="op" id="1528374">&amp;</span><span class="ident" id="1528375">kindMask</span>&nbsp;<span class="op" id="1528384">!=</span>&nbsp;<span class="ident" id="1528387">kindFunc</span>&nbsp;<span class="op" id="1528396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528400">gothrow</span><span class="op" id="1528407">(</span><span class="string" id="1528408">&#34;runtime.SetFinalizer:&nbsp;second&nbsp;argument&nbsp;is&nbsp;&#34;</span>&nbsp;<span class="op" id="1528452">+</span>&nbsp;<span class="op" id="1528454">*</span><span class="ident" id="1528455">ftyp</span><span class="op" id="1528459">.</span><span class="ident" id="1528460">_string</span>&nbsp;<span class="op" id="1528468">+</span>&nbsp;<span class="string" id="1528470">&#34;,&nbsp;not&nbsp;a&nbsp;function&#34;</span><span class="op" id="1528488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1528491">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528494">ft</span>&nbsp;<span class="op" id="1528497">:=</span>&nbsp;<span class="op" id="1528500">(</span><span class="op" id="1528501">*</span><span class="ident" id="1528502">functype</span><span class="op" id="1528510">)</span><span class="op" id="1528511">(</span><span class="ident" id="1528512">unsafe</span><span class="op" id="1528518">.</span><span class="ident" id="1528519">Pointer</span><span class="op" id="1528526">(</span><span class="ident" id="1528527">ftyp</span><span class="op" id="1528531">)</span><span class="op" id="1528532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528535">ins</span>&nbsp;<span class="op" id="1528539">:=</span>&nbsp;<span class="op" id="1528542">*</span><span class="op" id="1528543">(</span><span class="op" id="1528544">*</span><span class="op" id="1528545">[</span><span class="op" id="1528546">]</span><span class="op" id="1528547">*</span><span class="ident" id="1528548">_type</span><span class="op" id="1528553">)</span><span class="op" id="1528554">(</span><span class="ident" id="1528555">unsafe</span><span class="op" id="1528561">.</span><span class="ident" id="1528562">Pointer</span><span class="op" id="1528569">(</span><span class="op" id="1528570">&amp;</span><span class="ident" id="1528571">ft</span><span class="op" id="1528573">.</span><span class="ident" id="1528574">in</span><span class="op" id="1528576">)</span><span class="op" id="1528577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1528580">if</span>&nbsp;<span class="ident" id="1528583">ft</span><span class="op" id="1528585">.</span><span class="ident" id="1528586">dotdotdot</span>&nbsp;<span class="op" id="1528596">||</span>&nbsp;<span class="builtinfunc" id="1528599">len</span><span class="op" id="1528602">(</span><span class="ident" id="1528603">ins</span><span class="op" id="1528606">)</span>&nbsp;<span class="op" id="1528608">!=</span>&nbsp;<span class="num" id="1528611">1</span>&nbsp;<span class="op" id="1528613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528617">gothrow</span><span class="op" id="1528624">(</span><span class="string" id="1528625">&#34;runtime.SetFinalizer:&nbsp;cannot&nbsp;pass&nbsp;&#34;</span>&nbsp;<span class="op" id="1528662">+</span>&nbsp;<span class="op" id="1528664">*</span><span class="ident" id="1528665">etyp</span><span class="op" id="1528669">.</span><span class="ident" id="1528670">_string</span>&nbsp;<span class="op" id="1528678">+</span>&nbsp;<span class="string" id="1528680">&#34;&nbsp;to&nbsp;finalizer&nbsp;&#34;</span>&nbsp;<span class="op" id="1528697">+</span>&nbsp;<span class="op" id="1528699">*</span><span class="ident" id="1528700">ftyp</span><span class="op" id="1528704">.</span><span class="ident" id="1528705">_string</span><span class="op" id="1528712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1528715">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528718">fint</span>&nbsp;<span class="op" id="1528723">:=</span>&nbsp;<span class="ident" id="1528726">ins</span><span class="op" id="1528729">[</span><span class="num" id="1528730">0</span><span class="op" id="1528731">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1528734">switch</span>&nbsp;<span class="op" id="1528741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1528744">case</span>&nbsp;<span class="ident" id="1528749">fint</span>&nbsp;<span class="op" id="1528754">==</span>&nbsp;<span class="ident" id="1528757">etyp</span><span class="op" id="1528761">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1528765">//&nbsp;ok&nbsp;-&nbsp;same&nbsp;type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1528785">goto</span>&nbsp;<span class="ident" id="1528790">okarg</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1528797">case</span>&nbsp;<span class="ident" id="1528802">fint</span><span class="op" id="1528806">.</span><span class="ident" id="1528807">kind</span><span class="op" id="1528811">&amp;</span><span class="ident" id="1528812">kindMask</span>&nbsp;<span class="op" id="1528821">==</span>&nbsp;<span class="ident" id="1528824">kindPtr</span><span class="op" id="1528831">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1528835">if</span>&nbsp;<span class="op" id="1528838">(</span><span class="ident" id="1528839">fint</span><span class="op" id="1528843">.</span><span class="ident" id="1528844">x</span>&nbsp;<span class="op" id="1528846">==</span>&nbsp;<span class="ident" id="1528849">nil</span>&nbsp;<span class="op" id="1528853">||</span>&nbsp;<span class="ident" id="1528856">fint</span><span class="op" id="1528860">.</span><span class="ident" id="1528861">x</span><span class="op" id="1528862">.</span><span class="ident" id="1528863">name</span>&nbsp;<span class="op" id="1528868">==</span>&nbsp;<span class="ident" id="1528871">nil</span>&nbsp;<span class="op" id="1528875">||</span>&nbsp;<span class="ident" id="1528878">etyp</span><span class="op" id="1528882">.</span><span class="ident" id="1528883">x</span>&nbsp;<span class="op" id="1528885">==</span>&nbsp;<span class="ident" id="1528888">nil</span>&nbsp;<span class="op" id="1528892">||</span>&nbsp;<span class="ident" id="1528895">etyp</span><span class="op" id="1528899">.</span><span class="ident" id="1528900">x</span><span class="op" id="1528901">.</span><span class="ident" id="1528902">name</span>&nbsp;<span class="op" id="1528907">==</span>&nbsp;<span class="ident" id="1528910">nil</span><span class="op" id="1528913">)</span>&nbsp;<span class="op" id="1528915">&amp;&amp;</span>&nbsp;<span class="op" id="1528918">(</span><span class="op" id="1528919">*</span><span class="ident" id="1528920">ptrtype</span><span class="op" id="1528927">)</span><span class="op" id="1528928">(</span><span class="ident" id="1528929">unsafe</span><span class="op" id="1528935">.</span><span class="ident" id="1528936">Pointer</span><span class="op" id="1528943">(</span><span class="ident" id="1528944">fint</span><span class="op" id="1528948">)</span><span class="op" id="1528949">)</span><span class="op" id="1528950">.</span><span class="ident" id="1528951">elem</span>&nbsp;<span class="op" id="1528956">==</span>&nbsp;<span class="ident" id="1528959">ot</span><span class="op" id="1528961">.</span><span class="ident" id="1528962">elem</span>&nbsp;<span class="op" id="1528967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1528972">//&nbsp;ok&nbsp;-&nbsp;not&nbsp;same&nbsp;type,&nbsp;but&nbsp;both&nbsp;pointers,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1529017">//&nbsp;one&nbsp;or&nbsp;the&nbsp;other&nbsp;is&nbsp;unnamed,&nbsp;and&nbsp;same&nbsp;element&nbsp;type,&nbsp;so&nbsp;assignable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1529090">goto</span>&nbsp;<span class="ident" id="1529095">okarg</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1529103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1529106">case</span>&nbsp;<span class="ident" id="1529111">fint</span><span class="op" id="1529115">.</span><span class="ident" id="1529116">kind</span><span class="op" id="1529120">&amp;</span><span class="ident" id="1529121">kindMask</span>&nbsp;<span class="op" id="1529130">==</span>&nbsp;<span class="ident" id="1529133">kindInterface</span><span class="op" id="1529146">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529150">ityp</span>&nbsp;<span class="op" id="1529155">:=</span>&nbsp;<span class="op" id="1529158">(</span><span class="op" id="1529159">*</span><span class="ident" id="1529160">interfacetype</span><span class="op" id="1529173">)</span><span class="op" id="1529174">(</span><span class="ident" id="1529175">unsafe</span><span class="op" id="1529181">.</span><span class="ident" id="1529182">Pointer</span><span class="op" id="1529189">(</span><span class="ident" id="1529190">fint</span><span class="op" id="1529194">)</span><span class="op" id="1529195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1529199">if</span>&nbsp;<span class="builtinfunc" id="1529202">len</span><span class="op" id="1529205">(</span><span class="ident" id="1529206">ityp</span><span class="op" id="1529210">.</span><span class="ident" id="1529211">mhdr</span><span class="op" id="1529215">)</span>&nbsp;<span class="op" id="1529217">==</span>&nbsp;<span class="num" id="1529220">0</span>&nbsp;<span class="op" id="1529222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1529227">//&nbsp;ok&nbsp;-&nbsp;satisfies&nbsp;empty&nbsp;interface</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1529264">goto</span>&nbsp;<span class="ident" id="1529269">okarg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1529277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1529281">if</span>&nbsp;<span class="ident" id="1529284">_</span><span class="op" id="1529285">,</span>&nbsp;<span class="ident" id="1529287">ok</span>&nbsp;<span class="op" id="1529290">:=</span>&nbsp;<span class="ident" id="1529293">assertE2I2</span><span class="op" id="1529303">(</span><span class="ident" id="1529304">ityp</span><span class="op" id="1529308">,</span>&nbsp;<span class="ident" id="1529310">obj</span><span class="op" id="1529313">)</span><span class="op" id="1529314">;</span>&nbsp;<span class="ident" id="1529316">ok</span>&nbsp;<span class="op" id="1529319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1529324">goto</span>&nbsp;<span class="ident" id="1529329">okarg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1529337">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1529340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529343">gothrow</span><span class="op" id="1529350">(</span><span class="string" id="1529351">&#34;runtime.SetFinalizer:&nbsp;cannot&nbsp;pass&nbsp;&#34;</span>&nbsp;<span class="op" id="1529388">+</span>&nbsp;<span class="op" id="1529390">*</span><span class="ident" id="1529391">etyp</span><span class="op" id="1529395">.</span><span class="ident" id="1529396">_string</span>&nbsp;<span class="op" id="1529404">+</span>&nbsp;<span class="string" id="1529406">&#34;&nbsp;to&nbsp;finalizer&nbsp;&#34;</span>&nbsp;<span class="op" id="1529423">+</span>&nbsp;<span class="op" id="1529425">*</span><span class="ident" id="1529426">ftyp</span><span class="op" id="1529430">.</span><span class="ident" id="1529431">_string</span><span class="op" id="1529438">)</span><br>
<span class="lineno"></span><span class="ident" id="1529440">okarg</span><span class="op" id="1529445">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1529448">//&nbsp;compute&nbsp;size&nbsp;needed&nbsp;for&nbsp;return&nbsp;parameters</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529494">nret</span>&nbsp;<span class="op" id="1529499">:=</span>&nbsp;<span class="builtintype" id="1529502">uintptr</span><span class="op" id="1529509">(</span><span class="num" id="1529510">0</span><span class="op" id="1529511">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1529514">for</span>&nbsp;<span class="ident" id="1529518">_</span><span class="op" id="1529519">,</span>&nbsp;<span class="ident" id="1529521">t</span>&nbsp;<span class="op" id="1529523">:=</span>&nbsp;<span class="keyword" id="1529526">range</span>&nbsp;<span class="op" id="1529532">*</span><span class="op" id="1529533">(</span><span class="op" id="1529534">*</span><span class="op" id="1529535">[</span><span class="op" id="1529536">]</span><span class="op" id="1529537">*</span><span class="ident" id="1529538">_type</span><span class="op" id="1529543">)</span><span class="op" id="1529544">(</span><span class="ident" id="1529545">unsafe</span><span class="op" id="1529551">.</span><span class="ident" id="1529552">Pointer</span><span class="op" id="1529559">(</span><span class="op" id="1529560">&amp;</span><span class="ident" id="1529561">ft</span><span class="op" id="1529563">.</span><span class="ident" id="1529564">out</span><span class="op" id="1529567">)</span><span class="op" id="1529568">)</span>&nbsp;<span class="op" id="1529570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529574">nret</span>&nbsp;<span class="op" id="1529579">=</span>&nbsp;<span class="ident" id="1529581">round</span><span class="op" id="1529586">(</span><span class="ident" id="1529587">nret</span><span class="op" id="1529591">,</span>&nbsp;<span class="builtintype" id="1529593">uintptr</span><span class="op" id="1529600">(</span><span class="ident" id="1529601">t</span><span class="op" id="1529602">.</span><span class="ident" id="1529603">align</span><span class="op" id="1529608">)</span><span class="op" id="1529609">)</span>&nbsp;<span class="op" id="1529611">+</span>&nbsp;<span class="builtintype" id="1529613">uintptr</span><span class="op" id="1529620">(</span><span class="ident" id="1529621">t</span><span class="op" id="1529622">.</span><span class="ident" id="1529623">size</span><span class="op" id="1529627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1529630">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529633">nret</span>&nbsp;<span class="op" id="1529638">=</span>&nbsp;<span class="ident" id="1529640">round</span><span class="op" id="1529645">(</span><span class="ident" id="1529646">nret</span><span class="op" id="1529650">,</span>&nbsp;<span class="ident" id="1529652">ptrSize</span><span class="op" id="1529659">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1529663">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;have&nbsp;a&nbsp;finalizer&nbsp;goroutine</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529707">createfing</span><span class="op" id="1529717">(</span><span class="op" id="1529718">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1529722">//&nbsp;switch&nbsp;to&nbsp;M&nbsp;stack&nbsp;to&nbsp;add&nbsp;finalizer&nbsp;record</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529768">mp</span>&nbsp;<span class="op" id="1529771">:=</span>&nbsp;<span class="ident" id="1529774">acquirem</span><span class="op" id="1529782">(</span><span class="op" id="1529783">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529786">mp</span><span class="op" id="1529788">.</span><span class="ident" id="1529789">ptrarg</span><span class="op" id="1529795">[</span><span class="num" id="1529796">0</span><span class="op" id="1529797">]</span>&nbsp;<span class="op" id="1529799">=</span>&nbsp;<span class="ident" id="1529801">f</span><span class="op" id="1529802">.</span><span class="ident" id="1529803">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529809">mp</span><span class="op" id="1529811">.</span><span class="ident" id="1529812">ptrarg</span><span class="op" id="1529818">[</span><span class="num" id="1529819">1</span><span class="op" id="1529820">]</span>&nbsp;<span class="op" id="1529822">=</span>&nbsp;<span class="ident" id="1529824">e</span><span class="op" id="1529825">.</span><span class="ident" id="1529826">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529832">mp</span><span class="op" id="1529834">.</span><span class="ident" id="1529835">scalararg</span><span class="op" id="1529844">[</span><span class="num" id="1529845">0</span><span class="op" id="1529846">]</span>&nbsp;<span class="op" id="1529848">=</span>&nbsp;<span class="ident" id="1529850">nret</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529856">mp</span><span class="op" id="1529858">.</span><span class="ident" id="1529859">ptrarg</span><span class="op" id="1529865">[</span><span class="num" id="1529866">2</span><span class="op" id="1529867">]</span>&nbsp;<span class="op" id="1529869">=</span>&nbsp;<span class="ident" id="1529871">unsafe</span><span class="op" id="1529877">.</span><span class="ident" id="1529878">Pointer</span><span class="op" id="1529885">(</span><span class="ident" id="1529886">fint</span><span class="op" id="1529890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529893">mp</span><span class="op" id="1529895">.</span><span class="ident" id="1529896">ptrarg</span><span class="op" id="1529902">[</span><span class="num" id="1529903">3</span><span class="op" id="1529904">]</span>&nbsp;<span class="op" id="1529906">=</span>&nbsp;<span class="ident" id="1529908">unsafe</span><span class="op" id="1529914">.</span><span class="ident" id="1529915">Pointer</span><span class="op" id="1529922">(</span><span class="ident" id="1529923">ot</span><span class="op" id="1529925">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529928">onM</span><span class="op" id="1529931">(</span><span class="ident" id="1529932">setFinalizer_m</span><span class="op" id="1529946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1529949">if</span>&nbsp;<span class="ident" id="1529952">mp</span><span class="op" id="1529954">.</span><span class="ident" id="1529955">scalararg</span><span class="op" id="1529964">[</span><span class="num" id="1529965">0</span><span class="op" id="1529966">]</span>&nbsp;<span class="op" id="1529968">!=</span>&nbsp;<span class="num" id="1529971">1</span>&nbsp;<span class="op" id="1529973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529977">gothrow</span><span class="op" id="1529984">(</span><span class="string" id="1529985">&#34;runtime.SetFinalizer:&nbsp;finalizer&nbsp;already&nbsp;set&#34;</span><span class="op" id="1530030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1530033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530036">releasem</span><span class="op" id="1530044">(</span><span class="ident" id="1530045">mp</span><span class="op" id="1530047">)</span><br>
<span class="lineno">655</span><span class="op" id="1530049">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1530052">//&nbsp;round&nbsp;n&nbsp;up&nbsp;to&nbsp;a&nbsp;multiple&nbsp;of&nbsp;a.&nbsp;&nbsp;a&nbsp;must&nbsp;be&nbsp;a&nbsp;power&nbsp;of&nbsp;2.</span><br>
<span class="lineno"></span><span class="keyword" id="1530111">func</span>&nbsp;<span class="ident" id="1530116">round</span><span class="op" id="1530121">(</span><span class="ident" id="1530122">n</span><span class="op" id="1530123">,</span>&nbsp;<span class="ident" id="1530125">a</span>&nbsp;<span class="builtintype" id="1530127">uintptr</span><span class="op" id="1530134">)</span>&nbsp;<span class="builtintype" id="1530136">uintptr</span>&nbsp;<span class="op" id="1530144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1530147">return</span>&nbsp;<span class="op" id="1530154">(</span><span class="ident" id="1530155">n</span>&nbsp;<span class="op" id="1530157">+</span>&nbsp;<span class="ident" id="1530159">a</span>&nbsp;<span class="op" id="1530161">-</span>&nbsp;<span class="num" id="1530163">1</span><span class="op" id="1530164">)</span>&nbsp;<span class="op" id="1530166">&amp;^</span>&nbsp;<span class="op" id="1530169">(</span><span class="ident" id="1530170">a</span>&nbsp;<span class="op" id="1530172">-</span>&nbsp;<span class="num" id="1530174">1</span><span class="op" id="1530175">)</span><br>
<span class="lineno">660</span><span class="op" id="1530177">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1530180">//&nbsp;Look&nbsp;up&nbsp;pointer&nbsp;v&nbsp;in&nbsp;heap.&nbsp;&nbsp;Return&nbsp;the&nbsp;span&nbsp;containing&nbsp;the&nbsp;object,</span><br>
<span class="lineno"></span><span class="comment" id="1530250">//&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;object,&nbsp;and&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;object.&nbsp;&nbsp;If&nbsp;the&nbsp;object</span><br>
<span class="lineno"></span><span class="comment" id="1530321">//&nbsp;does&nbsp;not&nbsp;exist,&nbsp;return&nbsp;nil,&nbsp;nil,&nbsp;0.</span><br>
<span class="lineno">665</span><span class="keyword" id="1530360">func</span>&nbsp;<span class="ident" id="1530365">findObject</span><span class="op" id="1530375">(</span><span class="ident" id="1530376">v</span>&nbsp;<span class="ident" id="1530378">unsafe</span><span class="op" id="1530384">.</span><span class="ident" id="1530385">Pointer</span><span class="op" id="1530392">)</span>&nbsp;<span class="op" id="1530394">(</span><span class="ident" id="1530395">s</span>&nbsp;<span class="op" id="1530397">*</span><span class="ident" id="1530398">mspan</span><span class="op" id="1530403">,</span>&nbsp;<span class="ident" id="1530405">x</span>&nbsp;<span class="ident" id="1530407">unsafe</span><span class="op" id="1530413">.</span><span class="ident" id="1530414">Pointer</span><span class="op" id="1530421">,</span>&nbsp;<span class="ident" id="1530423">n</span>&nbsp;<span class="builtintype" id="1530425">uintptr</span><span class="op" id="1530432">)</span>&nbsp;<span class="op" id="1530434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530437">c</span>&nbsp;<span class="op" id="1530439">:=</span>&nbsp;<span class="ident" id="1530442">gomcache</span><span class="op" id="1530450">(</span><span class="op" id="1530451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530454">c</span><span class="op" id="1530455">.</span><span class="ident" id="1530456">local_nlookup</span><span class="op" id="1530469">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1530473">if</span>&nbsp;<span class="ident" id="1530476">ptrSize</span>&nbsp;<span class="op" id="1530484">==</span>&nbsp;<span class="num" id="1530487">4</span>&nbsp;<span class="op" id="1530489">&amp;&amp;</span>&nbsp;<span class="ident" id="1530492">c</span><span class="op" id="1530493">.</span><span class="ident" id="1530494">local_nlookup</span>&nbsp;<span class="op" id="1530508">&gt;=</span>&nbsp;<span class="num" id="1530511">1</span><span class="op" id="1530512">&lt;&lt;</span><span class="num" id="1530514">30</span>&nbsp;<span class="op" id="1530517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1530521">//&nbsp;purge&nbsp;cache&nbsp;stats&nbsp;to&nbsp;prevent&nbsp;overflow</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530564">lock</span><span class="op" id="1530568">(</span><span class="op" id="1530569">&amp;</span><span class="ident" id="1530570">mheap_</span><span class="op" id="1530576">.</span><span class="ident" id="1530577">lock</span><span class="op" id="1530581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530585">purgecachedstats</span><span class="op" id="1530601">(</span><span class="ident" id="1530602">c</span><span class="op" id="1530603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530607">unlock</span><span class="op" id="1530613">(</span><span class="op" id="1530614">&amp;</span><span class="ident" id="1530615">mheap_</span><span class="op" id="1530621">.</span><span class="ident" id="1530622">lock</span><span class="op" id="1530626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1530629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1530633">//&nbsp;find&nbsp;span</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530647">arena_start</span>&nbsp;<span class="op" id="1530659">:=</span>&nbsp;<span class="builtintype" id="1530662">uintptr</span><span class="op" id="1530669">(</span><span class="ident" id="1530670">unsafe</span><span class="op" id="1530676">.</span><span class="ident" id="1530677">Pointer</span><span class="op" id="1530684">(</span><span class="ident" id="1530685">mheap_</span><span class="op" id="1530691">.</span><span class="ident" id="1530692">arena_start</span><span class="op" id="1530703">)</span><span class="op" id="1530704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530707">arena_used</span>&nbsp;<span class="op" id="1530718">:=</span>&nbsp;<span class="builtintype" id="1530721">uintptr</span><span class="op" id="1530728">(</span><span class="ident" id="1530729">unsafe</span><span class="op" id="1530735">.</span><span class="ident" id="1530736">Pointer</span><span class="op" id="1530743">(</span><span class="ident" id="1530744">mheap_</span><span class="op" id="1530750">.</span><span class="ident" id="1530751">arena_used</span><span class="op" id="1530761">)</span><span class="op" id="1530762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1530765">if</span>&nbsp;<span class="builtintype" id="1530768">uintptr</span><span class="op" id="1530775">(</span><span class="ident" id="1530776">v</span><span class="op" id="1530777">)</span>&nbsp;<span class="op" id="1530779">&lt;</span>&nbsp;<span class="ident" id="1530781">arena_start</span>&nbsp;<span class="op" id="1530793">||</span>&nbsp;<span class="builtintype" id="1530796">uintptr</span><span class="op" id="1530803">(</span><span class="ident" id="1530804">v</span><span class="op" id="1530805">)</span>&nbsp;<span class="op" id="1530807">&gt;=</span>&nbsp;<span class="ident" id="1530810">arena_used</span>&nbsp;<span class="op" id="1530821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1530825">return</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1530833">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530836">p</span>&nbsp;<span class="op" id="1530838">:=</span>&nbsp;<span class="builtintype" id="1530841">uintptr</span><span class="op" id="1530848">(</span><span class="ident" id="1530849">v</span><span class="op" id="1530850">)</span>&nbsp;<span class="op" id="1530852">&gt;&gt;</span>&nbsp;<span class="ident" id="1530855">pageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530866">q</span>&nbsp;<span class="op" id="1530868">:=</span>&nbsp;<span class="ident" id="1530871">p</span>&nbsp;<span class="op" id="1530873">-</span>&nbsp;<span class="ident" id="1530875">arena_start</span><span class="op" id="1530886">&gt;&gt;</span><span class="ident" id="1530888">pageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530899">s</span>&nbsp;<span class="op" id="1530901">=</span>&nbsp;<span class="op" id="1530903">*</span><span class="op" id="1530904">(</span><span class="op" id="1530905">*</span><span class="op" id="1530906">*</span><span class="ident" id="1530907">mspan</span><span class="op" id="1530912">)</span><span class="op" id="1530913">(</span><span class="ident" id="1530914">add</span><span class="op" id="1530917">(</span><span class="ident" id="1530918">unsafe</span><span class="op" id="1530924">.</span><span class="ident" id="1530925">Pointer</span><span class="op" id="1530932">(</span><span class="ident" id="1530933">mheap_</span><span class="op" id="1530939">.</span><span class="ident" id="1530940">spans</span><span class="op" id="1530945">)</span><span class="op" id="1530946">,</span>&nbsp;<span class="ident" id="1530948">q</span><span class="op" id="1530949">*</span><span class="ident" id="1530950">ptrSize</span><span class="op" id="1530957">)</span><span class="op" id="1530958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1530961">if</span>&nbsp;<span class="ident" id="1530964">s</span>&nbsp;<span class="op" id="1530966">==</span>&nbsp;<span class="ident" id="1530969">nil</span>&nbsp;<span class="op" id="1530973">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1530977">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1530985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530988">x</span>&nbsp;<span class="op" id="1530990">=</span>&nbsp;<span class="ident" id="1530992">unsafe</span><span class="op" id="1530998">.</span><span class="ident" id="1530999">Pointer</span><span class="op" id="1531006">(</span><span class="builtintype" id="1531007">uintptr</span><span class="op" id="1531014">(</span><span class="ident" id="1531015">s</span><span class="op" id="1531016">.</span><span class="ident" id="1531017">start</span><span class="op" id="1531022">)</span>&nbsp;<span class="op" id="1531024">&lt;&lt;</span>&nbsp;<span class="ident" id="1531027">pageShift</span><span class="op" id="1531036">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531040">if</span>&nbsp;<span class="builtintype" id="1531043">uintptr</span><span class="op" id="1531050">(</span><span class="ident" id="1531051">v</span><span class="op" id="1531052">)</span>&nbsp;<span class="op" id="1531054">&lt;</span>&nbsp;<span class="builtintype" id="1531056">uintptr</span><span class="op" id="1531063">(</span><span class="ident" id="1531064">x</span><span class="op" id="1531065">)</span>&nbsp;<span class="op" id="1531067">||</span>&nbsp;<span class="builtintype" id="1531070">uintptr</span><span class="op" id="1531077">(</span><span class="ident" id="1531078">v</span><span class="op" id="1531079">)</span>&nbsp;<span class="op" id="1531081">&gt;=</span>&nbsp;<span class="builtintype" id="1531084">uintptr</span><span class="op" id="1531091">(</span><span class="ident" id="1531092">unsafe</span><span class="op" id="1531098">.</span><span class="ident" id="1531099">Pointer</span><span class="op" id="1531106">(</span><span class="ident" id="1531107">s</span><span class="op" id="1531108">.</span><span class="ident" id="1531109">limit</span><span class="op" id="1531114">)</span><span class="op" id="1531115">)</span>&nbsp;<span class="op" id="1531117">||</span>&nbsp;<span class="ident" id="1531120">s</span><span class="op" id="1531121">.</span><span class="ident" id="1531122">state</span>&nbsp;<span class="op" id="1531128">!=</span>&nbsp;<span class="ident" id="1531131">mSpanInUse</span>&nbsp;<span class="op" id="1531142">{</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531146">s</span>&nbsp;<span class="op" id="1531148">=</span>&nbsp;<span class="ident" id="1531150">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531156">x</span>&nbsp;<span class="op" id="1531158">=</span>&nbsp;<span class="ident" id="1531160">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531166">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1531174">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531178">n</span>&nbsp;<span class="op" id="1531180">=</span>&nbsp;<span class="builtintype" id="1531182">uintptr</span><span class="op" id="1531189">(</span><span class="ident" id="1531190">s</span><span class="op" id="1531191">.</span><span class="ident" id="1531192">elemsize</span><span class="op" id="1531200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531203">if</span>&nbsp;<span class="ident" id="1531206">s</span><span class="op" id="1531207">.</span><span class="ident" id="1531208">sizeclass</span>&nbsp;<span class="op" id="1531218">!=</span>&nbsp;<span class="num" id="1531221">0</span>&nbsp;<span class="op" id="1531223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531227">x</span>&nbsp;<span class="op" id="1531229">=</span>&nbsp;<span class="ident" id="1531231">add</span><span class="op" id="1531234">(</span><span class="ident" id="1531235">x</span><span class="op" id="1531236">,</span>&nbsp;<span class="op" id="1531238">(</span><span class="builtintype" id="1531239">uintptr</span><span class="op" id="1531246">(</span><span class="ident" id="1531247">v</span><span class="op" id="1531248">)</span><span class="op" id="1531249">-</span><span class="builtintype" id="1531250">uintptr</span><span class="op" id="1531257">(</span><span class="ident" id="1531258">x</span><span class="op" id="1531259">)</span><span class="op" id="1531260">)</span><span class="op" id="1531261">/</span><span class="ident" id="1531262">n</span><span class="op" id="1531263">*</span><span class="ident" id="1531264">n</span><span class="op" id="1531265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1531268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531271">return</span><br>
<span class="lineno">700</span><span class="op" id="1531278">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1531281">var</span>&nbsp;<span class="ident" id="1531285">fingCreate</span>&nbsp;<span class="builtintype" id="1531296">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1531304">func</span>&nbsp;<span class="ident" id="1531309">createfing</span><span class="op" id="1531319">(</span><span class="op" id="1531320">)</span>&nbsp;<span class="op" id="1531322">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1531325">//&nbsp;start&nbsp;the&nbsp;finalizer&nbsp;goroutine&nbsp;exactly&nbsp;once</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531372">if</span>&nbsp;<span class="ident" id="1531375">fingCreate</span>&nbsp;<span class="op" id="1531386">==</span>&nbsp;<span class="num" id="1531389">0</span>&nbsp;<span class="op" id="1531391">&amp;&amp;</span>&nbsp;<span class="ident" id="1531394">cas</span><span class="op" id="1531397">(</span><span class="op" id="1531398">&amp;</span><span class="ident" id="1531399">fingCreate</span><span class="op" id="1531409">,</span>&nbsp;<span class="num" id="1531411">0</span><span class="op" id="1531412">,</span>&nbsp;<span class="num" id="1531414">1</span><span class="op" id="1531415">)</span>&nbsp;<span class="op" id="1531417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531421">go</span>&nbsp;<span class="ident" id="1531424">runfinq</span><span class="op" id="1531431">(</span><span class="op" id="1531432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1531435">}</span><br>
<span class="lineno"></span><span class="op" id="1531437">}</span><br>
<span class="lineno">710</span><br>
<span class="lineno"></span><span class="comment" id="1531440">//&nbsp;This&nbsp;is&nbsp;the&nbsp;goroutine&nbsp;that&nbsp;runs&nbsp;all&nbsp;of&nbsp;the&nbsp;finalizers</span><br>
<span class="lineno"></span><span class="keyword" id="1531497">func</span>&nbsp;<span class="ident" id="1531502">runfinq</span><span class="op" id="1531509">(</span><span class="op" id="1531510">)</span>&nbsp;<span class="op" id="1531512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531515">var</span>&nbsp;<span class="op" id="1531519">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531523">frame</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1531532">unsafe</span><span class="op" id="1531538">.</span><span class="ident" id="1531539">Pointer</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531549">framecap</span>&nbsp;<span class="builtintype" id="1531558">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1531567">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531571">for</span>&nbsp;<span class="op" id="1531575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531579">lock</span><span class="op" id="1531583">(</span><span class="op" id="1531584">&amp;</span><span class="ident" id="1531585">finlock</span><span class="op" id="1531592">)</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531596">fb</span>&nbsp;<span class="op" id="1531599">:=</span>&nbsp;<span class="ident" id="1531602">finq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531609">finq</span>&nbsp;<span class="op" id="1531614">=</span>&nbsp;<span class="ident" id="1531616">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531622">if</span>&nbsp;<span class="ident" id="1531625">fb</span>&nbsp;<span class="op" id="1531628">==</span>&nbsp;<span class="ident" id="1531631">nil</span>&nbsp;<span class="op" id="1531635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531640">gp</span>&nbsp;<span class="op" id="1531643">:=</span>&nbsp;<span class="ident" id="1531646">getg</span><span class="op" id="1531650">(</span><span class="op" id="1531651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531656">fing</span>&nbsp;<span class="op" id="1531661">=</span>&nbsp;<span class="ident" id="1531663">gp</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531669">fingwait</span>&nbsp;<span class="op" id="1531678">=</span>&nbsp;<span class="builtintype" id="1531680">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531688">gp</span><span class="op" id="1531690">.</span><span class="ident" id="1531691">issystem</span>&nbsp;<span class="op" id="1531700">=</span>&nbsp;<span class="builtintype" id="1531702">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531710">goparkunlock</span><span class="op" id="1531722">(</span><span class="op" id="1531723">&amp;</span><span class="ident" id="1531724">finlock</span><span class="op" id="1531731">,</span>&nbsp;<span class="string" id="1531733">&#34;finalizer&nbsp;wait&#34;</span><span class="op" id="1531749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531754">gp</span><span class="op" id="1531756">.</span><span class="ident" id="1531757">issystem</span>&nbsp;<span class="op" id="1531766">=</span>&nbsp;<span class="builtintype" id="1531768">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531777">continue</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1531788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531792">unlock</span><span class="op" id="1531798">(</span><span class="op" id="1531799">&amp;</span><span class="ident" id="1531800">finlock</span><span class="op" id="1531807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531811">if</span>&nbsp;<span class="ident" id="1531814">raceenabled</span>&nbsp;<span class="op" id="1531826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531831">racefingo</span><span class="op" id="1531840">(</span><span class="op" id="1531841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1531845">}</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531849">for</span>&nbsp;<span class="ident" id="1531853">fb</span>&nbsp;<span class="op" id="1531856">!=</span>&nbsp;<span class="ident" id="1531859">nil</span>&nbsp;<span class="op" id="1531863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531868">for</span>&nbsp;<span class="ident" id="1531872">i</span>&nbsp;<span class="op" id="1531874">:=</span>&nbsp;<span class="builtintype" id="1531877">int32</span><span class="op" id="1531882">(</span><span class="num" id="1531883">0</span><span class="op" id="1531884">)</span><span class="op" id="1531885">;</span>&nbsp;<span class="ident" id="1531887">i</span>&nbsp;<span class="op" id="1531889">&lt;</span>&nbsp;<span class="ident" id="1531891">fb</span><span class="op" id="1531893">.</span><span class="ident" id="1531894">cnt</span><span class="op" id="1531897">;</span>&nbsp;<span class="ident" id="1531899">i</span><span class="op" id="1531900">++</span>&nbsp;<span class="op" id="1531903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531909">f</span>&nbsp;<span class="op" id="1531911">:=</span>&nbsp;<span class="op" id="1531914">(</span><span class="op" id="1531915">*</span><span class="ident" id="1531916">finalizer</span><span class="op" id="1531925">)</span><span class="op" id="1531926">(</span><span class="ident" id="1531927">add</span><span class="op" id="1531930">(</span><span class="ident" id="1531931">unsafe</span><span class="op" id="1531937">.</span><span class="ident" id="1531938">Pointer</span><span class="op" id="1531945">(</span><span class="op" id="1531946">&amp;</span><span class="ident" id="1531947">fb</span><span class="op" id="1531949">.</span><span class="ident" id="1531950">fin</span><span class="op" id="1531953">)</span><span class="op" id="1531954">,</span>&nbsp;<span class="builtintype" id="1531956">uintptr</span><span class="op" id="1531963">(</span><span class="ident" id="1531964">i</span><span class="op" id="1531965">)</span><span class="op" id="1531966">*</span><span class="ident" id="1531967">unsafe</span><span class="op" id="1531973">.</span><span class="ident" id="1531974">Sizeof</span><span class="op" id="1531980">(</span><span class="ident" id="1531981">finalizer</span><span class="op" id="1531990">{</span><span class="op" id="1531991">}</span><span class="op" id="1531992">)</span><span class="op" id="1531993">)</span><span class="op" id="1531994">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532001">framesz</span>&nbsp;<span class="op" id="1532009">:=</span>&nbsp;<span class="ident" id="1532012">unsafe</span><span class="op" id="1532018">.</span><span class="ident" id="1532019">Sizeof</span><span class="op" id="1532025">(</span><span class="op" id="1532026">(</span><span class="keyword" id="1532027">interface</span><span class="op" id="1532036">{</span><span class="op" id="1532037">}</span><span class="op" id="1532038">)</span><span class="op" id="1532039">(</span><span class="ident" id="1532040">nil</span><span class="op" id="1532043">)</span><span class="op" id="1532044">)</span>&nbsp;<span class="op" id="1532046">+</span>&nbsp;<span class="builtintype" id="1532048">uintptr</span><span class="op" id="1532055">(</span><span class="ident" id="1532056">f</span><span class="op" id="1532057">.</span><span class="ident" id="1532058">nret</span><span class="op" id="1532062">)</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532068">if</span>&nbsp;<span class="ident" id="1532071">framecap</span>&nbsp;<span class="op" id="1532080">&lt;</span>&nbsp;<span class="ident" id="1532082">framesz</span>&nbsp;<span class="op" id="1532090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1532097">//&nbsp;The&nbsp;frame&nbsp;does&nbsp;not&nbsp;contain&nbsp;pointers&nbsp;interesting&nbsp;for&nbsp;GC,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1532161">//&nbsp;all&nbsp;not&nbsp;yet&nbsp;finalized&nbsp;objects&nbsp;are&nbsp;stored&nbsp;in&nbsp;finq.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1532219">//&nbsp;If&nbsp;we&nbsp;do&nbsp;not&nbsp;mark&nbsp;it&nbsp;as&nbsp;FlagNoScan,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1532263">//&nbsp;the&nbsp;last&nbsp;finalized&nbsp;object&nbsp;is&nbsp;not&nbsp;collected.</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532315">frame</span>&nbsp;<span class="op" id="1532321">=</span>&nbsp;<span class="ident" id="1532323">mallocgc</span><span class="op" id="1532331">(</span><span class="ident" id="1532332">framesz</span><span class="op" id="1532339">,</span>&nbsp;<span class="ident" id="1532341">nil</span><span class="op" id="1532344">,</span>&nbsp;<span class="ident" id="1532346">flagNoScan</span><span class="op" id="1532356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532363">framecap</span>&nbsp;<span class="op" id="1532372">=</span>&nbsp;<span class="ident" id="1532374">framesz</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1532386">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532393">if</span>&nbsp;<span class="ident" id="1532396">f</span><span class="op" id="1532397">.</span><span class="ident" id="1532398">fint</span>&nbsp;<span class="op" id="1532403">==</span>&nbsp;<span class="ident" id="1532406">nil</span>&nbsp;<span class="op" id="1532410">{</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532417">gothrow</span><span class="op" id="1532424">(</span><span class="string" id="1532425">&#34;missing&nbsp;type&nbsp;in&nbsp;runfinq&#34;</span><span class="op" id="1532450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1532456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532462">switch</span>&nbsp;<span class="ident" id="1532469">f</span><span class="op" id="1532470">.</span><span class="ident" id="1532471">fint</span><span class="op" id="1532475">.</span><span class="ident" id="1532476">kind</span>&nbsp;<span class="op" id="1532481">&amp;</span>&nbsp;<span class="ident" id="1532483">kindMask</span>&nbsp;<span class="op" id="1532492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532498">case</span>&nbsp;<span class="ident" id="1532503">kindPtr</span><span class="op" id="1532510">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1532517">//&nbsp;direct&nbsp;use&nbsp;of&nbsp;pointer</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1532547">*</span><span class="op" id="1532548">(</span><span class="op" id="1532549">*</span><span class="ident" id="1532550">unsafe</span><span class="op" id="1532556">.</span><span class="ident" id="1532557">Pointer</span><span class="op" id="1532564">)</span><span class="op" id="1532565">(</span><span class="ident" id="1532566">frame</span><span class="op" id="1532571">)</span>&nbsp;<span class="op" id="1532573">=</span>&nbsp;<span class="ident" id="1532575">f</span><span class="op" id="1532576">.</span><span class="ident" id="1532577">arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532585">case</span>&nbsp;<span class="ident" id="1532590">kindInterface</span><span class="op" id="1532603">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532610">ityp</span>&nbsp;<span class="op" id="1532615">:=</span>&nbsp;<span class="op" id="1532618">(</span><span class="op" id="1532619">*</span><span class="ident" id="1532620">interfacetype</span><span class="op" id="1532633">)</span><span class="op" id="1532634">(</span><span class="ident" id="1532635">unsafe</span><span class="op" id="1532641">.</span><span class="ident" id="1532642">Pointer</span><span class="op" id="1532649">(</span><span class="ident" id="1532650">f</span><span class="op" id="1532651">.</span><span class="ident" id="1532652">fint</span><span class="op" id="1532656">)</span><span class="op" id="1532657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1532664">//&nbsp;set&nbsp;up&nbsp;with&nbsp;empty&nbsp;interface</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1532700">(</span><span class="op" id="1532701">*</span><span class="ident" id="1532702">eface</span><span class="op" id="1532707">)</span><span class="op" id="1532708">(</span><span class="ident" id="1532709">frame</span><span class="op" id="1532714">)</span><span class="op" id="1532715">.</span><span class="ident" id="1532716">_type</span>&nbsp;<span class="op" id="1532722">=</span>&nbsp;<span class="op" id="1532724">&amp;</span><span class="ident" id="1532725">f</span><span class="op" id="1532726">.</span><span class="ident" id="1532727">ot</span><span class="op" id="1532729">.</span><span class="ident" id="1532730">typ</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1532739">(</span><span class="op" id="1532740">*</span><span class="ident" id="1532741">eface</span><span class="op" id="1532746">)</span><span class="op" id="1532747">(</span><span class="ident" id="1532748">frame</span><span class="op" id="1532753">)</span><span class="op" id="1532754">.</span><span class="ident" id="1532755">data</span>&nbsp;<span class="op" id="1532760">=</span>&nbsp;<span class="ident" id="1532762">f</span><span class="op" id="1532763">.</span><span class="ident" id="1532764">arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532773">if</span>&nbsp;<span class="builtinfunc" id="1532776">len</span><span class="op" id="1532779">(</span><span class="ident" id="1532780">ityp</span><span class="op" id="1532784">.</span><span class="ident" id="1532785">mhdr</span><span class="op" id="1532789">)</span>&nbsp;<span class="op" id="1532791">!=</span>&nbsp;<span class="num" id="1532794">0</span>&nbsp;<span class="op" id="1532796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1532804">//&nbsp;convert&nbsp;to&nbsp;interface&nbsp;with&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1532847">//&nbsp;this&nbsp;conversion&nbsp;is&nbsp;guaranteed&nbsp;to&nbsp;succeed&nbsp;-&nbsp;we&nbsp;checked&nbsp;in&nbsp;SetFinalizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1532926">*</span><span class="op" id="1532927">(</span><span class="op" id="1532928">*</span><span class="ident" id="1532929">fInterface</span><span class="op" id="1532939">)</span><span class="op" id="1532940">(</span><span class="ident" id="1532941">frame</span><span class="op" id="1532946">)</span>&nbsp;<span class="op" id="1532948">=</span>&nbsp;<span class="ident" id="1532950">assertE2I</span><span class="op" id="1532959">(</span><span class="ident" id="1532960">ityp</span><span class="op" id="1532964">,</span>&nbsp;<span class="op" id="1532966">*</span><span class="op" id="1532967">(</span><span class="op" id="1532968">*</span><span class="keyword" id="1532969">interface</span><span class="op" id="1532978">{</span><span class="op" id="1532979">}</span><span class="op" id="1532980">)</span><span class="op" id="1532981">(</span><span class="ident" id="1532982">frame</span><span class="op" id="1532987">)</span><span class="op" id="1532988">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1532995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533001">default</span><span class="op" id="1533008">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533015">gothrow</span><span class="op" id="1533022">(</span><span class="string" id="1533023">&#34;bad&nbsp;kind&nbsp;in&nbsp;runfinq&#34;</span><span class="op" id="1533044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533056">reflectcall</span><span class="op" id="1533067">(</span><span class="ident" id="1533068">unsafe</span><span class="op" id="1533074">.</span><span class="ident" id="1533075">Pointer</span><span class="op" id="1533082">(</span><span class="ident" id="1533083">f</span><span class="op" id="1533084">.</span><span class="ident" id="1533085">fn</span><span class="op" id="1533087">)</span><span class="op" id="1533088">,</span>&nbsp;<span class="ident" id="1533090">frame</span><span class="op" id="1533095">,</span>&nbsp;<span class="builtintype" id="1533097">uint32</span><span class="op" id="1533103">(</span><span class="ident" id="1533104">framesz</span><span class="op" id="1533111">)</span><span class="op" id="1533112">,</span>&nbsp;<span class="builtintype" id="1533114">uint32</span><span class="op" id="1533120">(</span><span class="ident" id="1533121">framesz</span><span class="op" id="1533128">)</span><span class="op" id="1533129">)</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1533136">//&nbsp;drop&nbsp;finalizer&nbsp;queue&nbsp;references&nbsp;to&nbsp;finalized&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533195">f</span><span class="op" id="1533196">.</span><span class="ident" id="1533197">fn</span>&nbsp;<span class="op" id="1533200">=</span>&nbsp;<span class="ident" id="1533202">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533210">f</span><span class="op" id="1533211">.</span><span class="ident" id="1533212">arg</span>&nbsp;<span class="op" id="1533216">=</span>&nbsp;<span class="ident" id="1533218">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533226">f</span><span class="op" id="1533227">.</span><span class="ident" id="1533228">ot</span>&nbsp;<span class="op" id="1533231">=</span>&nbsp;<span class="ident" id="1533233">nil</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533245">fb</span><span class="op" id="1533247">.</span><span class="ident" id="1533248">cnt</span>&nbsp;<span class="op" id="1533252">=</span>&nbsp;<span class="num" id="1533254">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533259">next</span>&nbsp;<span class="op" id="1533264">:=</span>&nbsp;<span class="ident" id="1533267">fb</span><span class="op" id="1533269">.</span><span class="ident" id="1533270">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533278">lock</span><span class="op" id="1533282">(</span><span class="op" id="1533283">&amp;</span><span class="ident" id="1533284">finlock</span><span class="op" id="1533291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533296">fb</span><span class="op" id="1533298">.</span><span class="ident" id="1533299">next</span>&nbsp;<span class="op" id="1533304">=</span>&nbsp;<span class="ident" id="1533306">finc</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533314">finc</span>&nbsp;<span class="op" id="1533319">=</span>&nbsp;<span class="ident" id="1533321">fb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533327">unlock</span><span class="op" id="1533333">(</span><span class="op" id="1533334">&amp;</span><span class="ident" id="1533335">finlock</span><span class="op" id="1533342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533347">fb</span>&nbsp;<span class="op" id="1533350">=</span>&nbsp;<span class="ident" id="1533352">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533362">}</span><br>
<span class="lineno">785</span><span class="op" id="1533364">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1533367">var</span>&nbsp;<span class="ident" id="1533371">persistent</span>&nbsp;<span class="keyword" id="1533382">struct</span>&nbsp;<span class="op" id="1533389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533392">lock</span>&nbsp;<span class="ident" id="1533397">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533404">pos</span>&nbsp;&nbsp;<span class="ident" id="1533409">unsafe</span><span class="op" id="1533415">.</span><span class="ident" id="1533416">Pointer</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533425">end</span>&nbsp;&nbsp;<span class="ident" id="1533430">unsafe</span><span class="op" id="1533436">.</span><span class="ident" id="1533437">Pointer</span><br>
<span class="lineno"></span><span class="op" id="1533445">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1533448">//&nbsp;Wrapper&nbsp;around&nbsp;sysAlloc&nbsp;that&nbsp;can&nbsp;allocate&nbsp;small&nbsp;chunks.</span><br>
<span class="lineno"></span><span class="comment" id="1533507">//&nbsp;There&nbsp;is&nbsp;no&nbsp;associated&nbsp;free&nbsp;operation.</span><br>
<span class="lineno">795</span><span class="comment" id="1533549">//&nbsp;Intended&nbsp;for&nbsp;things&nbsp;like&nbsp;function/type/debug-related&nbsp;persistent&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="1533622">//&nbsp;If&nbsp;align&nbsp;is&nbsp;0,&nbsp;uses&nbsp;default&nbsp;align&nbsp;(currently&nbsp;8).</span><br>
<span class="lineno"></span><span class="keyword" id="1533674">func</span>&nbsp;<span class="ident" id="1533679">persistentalloc</span><span class="op" id="1533694">(</span><span class="ident" id="1533695">size</span><span class="op" id="1533699">,</span>&nbsp;<span class="ident" id="1533701">align</span>&nbsp;<span class="builtintype" id="1533707">uintptr</span><span class="op" id="1533714">,</span>&nbsp;<span class="ident" id="1533716">stat</span>&nbsp;<span class="op" id="1533721">*</span><span class="ident" id="1533722">uint64</span><span class="op" id="1533728">)</span>&nbsp;<span class="ident" id="1533730">unsafe</span><span class="op" id="1533736">.</span><span class="ident" id="1533737">Pointer</span>&nbsp;<span class="op" id="1533745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533748">const</span>&nbsp;<span class="op" id="1533754">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533758">chunk</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1533767">=</span>&nbsp;<span class="num" id="1533769">256</span>&nbsp;<span class="op" id="1533773">&lt;&lt;</span>&nbsp;<span class="num" id="1533776">10</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533781">maxBlock</span>&nbsp;<span class="op" id="1533790">=</span>&nbsp;<span class="num" id="1533792">64</span>&nbsp;<span class="op" id="1533795">&lt;&lt;</span>&nbsp;<span class="num" id="1533798">10</span>&nbsp;<span class="comment" id="1533801">//&nbsp;VM&nbsp;reservation&nbsp;granularity&nbsp;is&nbsp;64K&nbsp;on&nbsp;windows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533850">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533854">if</span>&nbsp;<span class="ident" id="1533857">align</span>&nbsp;<span class="op" id="1533863">!=</span>&nbsp;<span class="num" id="1533866">0</span>&nbsp;<span class="op" id="1533868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533872">if</span>&nbsp;<span class="ident" id="1533875">align</span><span class="op" id="1533880">&amp;</span><span class="op" id="1533881">(</span><span class="ident" id="1533882">align</span><span class="op" id="1533887">-</span><span class="num" id="1533888">1</span><span class="op" id="1533889">)</span>&nbsp;<span class="op" id="1533891">!=</span>&nbsp;<span class="num" id="1533894">0</span>&nbsp;<span class="op" id="1533896">{</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533901">gothrow</span><span class="op" id="1533908">(</span><span class="string" id="1533909">&#34;persistentalloc:&nbsp;align&nbsp;is&nbsp;not&nbsp;a&nbsp;power&nbsp;of&nbsp;2&#34;</span><span class="op" id="1533953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533961">if</span>&nbsp;<span class="ident" id="1533964">align</span>&nbsp;<span class="op" id="1533970">&gt;</span>&nbsp;<span class="ident" id="1533972">_PageSize</span>&nbsp;<span class="op" id="1533982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533987">gothrow</span><span class="op" id="1533994">(</span><span class="string" id="1533995">&#34;persistentalloc:&nbsp;align&nbsp;is&nbsp;too&nbsp;large&#34;</span><span class="op" id="1534032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1534036">}</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1534039">}</span>&nbsp;<span class="keyword" id="1534041">else</span>&nbsp;<span class="op" id="1534046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534050">align</span>&nbsp;<span class="op" id="1534056">=</span>&nbsp;<span class="num" id="1534058">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1534061">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534065">if</span>&nbsp;<span class="ident" id="1534068">size</span>&nbsp;<span class="op" id="1534073">&gt;=</span>&nbsp;<span class="ident" id="1534076">maxBlock</span>&nbsp;<span class="op" id="1534085">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534089">return</span>&nbsp;<span class="ident" id="1534096">sysAlloc</span><span class="op" id="1534104">(</span><span class="ident" id="1534105">size</span><span class="op" id="1534109">,</span>&nbsp;<span class="ident" id="1534111">stat</span><span class="op" id="1534115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1534118">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534122">lock</span><span class="op" id="1534126">(</span><span class="op" id="1534127">&amp;</span><span class="ident" id="1534128">persistent</span><span class="op" id="1534138">.</span><span class="ident" id="1534139">lock</span><span class="op" id="1534143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534146">persistent</span><span class="op" id="1534156">.</span><span class="ident" id="1534157">pos</span>&nbsp;<span class="op" id="1534161">=</span>&nbsp;<span class="ident" id="1534163">roundup</span><span class="op" id="1534170">(</span><span class="ident" id="1534171">persistent</span><span class="op" id="1534181">.</span><span class="ident" id="1534182">pos</span><span class="op" id="1534185">,</span>&nbsp;<span class="ident" id="1534187">align</span><span class="op" id="1534192">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534195">if</span>&nbsp;<span class="builtintype" id="1534198">uintptr</span><span class="op" id="1534205">(</span><span class="ident" id="1534206">persistent</span><span class="op" id="1534216">.</span><span class="ident" id="1534217">pos</span><span class="op" id="1534220">)</span><span class="op" id="1534221">+</span><span class="ident" id="1534222">size</span>&nbsp;<span class="op" id="1534227">&gt;</span>&nbsp;<span class="builtintype" id="1534229">uintptr</span><span class="op" id="1534236">(</span><span class="ident" id="1534237">persistent</span><span class="op" id="1534247">.</span><span class="ident" id="1534248">end</span><span class="op" id="1534251">)</span>&nbsp;<span class="op" id="1534253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534257">persistent</span><span class="op" id="1534267">.</span><span class="ident" id="1534268">pos</span>&nbsp;<span class="op" id="1534272">=</span>&nbsp;<span class="ident" id="1534274">sysAlloc</span><span class="op" id="1534282">(</span><span class="ident" id="1534283">chunk</span><span class="op" id="1534288">,</span>&nbsp;<span class="op" id="1534290">&amp;</span><span class="ident" id="1534291">memstats</span><span class="op" id="1534299">.</span><span class="ident" id="1534300">other_sys</span><span class="op" id="1534309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534313">if</span>&nbsp;<span class="ident" id="1534316">persistent</span><span class="op" id="1534326">.</span><span class="ident" id="1534327">pos</span>&nbsp;<span class="op" id="1534331">==</span>&nbsp;<span class="ident" id="1534334">nil</span>&nbsp;<span class="op" id="1534338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534343">unlock</span><span class="op" id="1534349">(</span><span class="op" id="1534350">&amp;</span><span class="ident" id="1534351">persistent</span><span class="op" id="1534361">.</span><span class="ident" id="1534362">lock</span><span class="op" id="1534366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534371">gothrow</span><span class="op" id="1534378">(</span><span class="string" id="1534379">&#34;runtime:&nbsp;cannot&nbsp;allocate&nbsp;memory&#34;</span><span class="op" id="1534412">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1534416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534420">persistent</span><span class="op" id="1534430">.</span><span class="ident" id="1534431">end</span>&nbsp;<span class="op" id="1534435">=</span>&nbsp;<span class="ident" id="1534437">add</span><span class="op" id="1534440">(</span><span class="ident" id="1534441">persistent</span><span class="op" id="1534451">.</span><span class="ident" id="1534452">pos</span><span class="op" id="1534455">,</span>&nbsp;<span class="ident" id="1534457">chunk</span><span class="op" id="1534462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1534465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534468">p</span>&nbsp;<span class="op" id="1534470">:=</span>&nbsp;<span class="ident" id="1534473">persistent</span><span class="op" id="1534483">.</span><span class="ident" id="1534484">pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534489">persistent</span><span class="op" id="1534499">.</span><span class="ident" id="1534500">pos</span>&nbsp;<span class="op" id="1534504">=</span>&nbsp;<span class="ident" id="1534506">add</span><span class="op" id="1534509">(</span><span class="ident" id="1534510">persistent</span><span class="op" id="1534520">.</span><span class="ident" id="1534521">pos</span><span class="op" id="1534524">,</span>&nbsp;<span class="ident" id="1534526">size</span><span class="op" id="1534530">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534533">unlock</span><span class="op" id="1534539">(</span><span class="op" id="1534540">&amp;</span><span class="ident" id="1534541">persistent</span><span class="op" id="1534551">.</span><span class="ident" id="1534552">lock</span><span class="op" id="1534556">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534560">if</span>&nbsp;<span class="ident" id="1534563">stat</span>&nbsp;<span class="op" id="1534568">!=</span>&nbsp;<span class="op" id="1534571">&amp;</span><span class="ident" id="1534572">memstats</span><span class="op" id="1534580">.</span><span class="ident" id="1534581">other_sys</span>&nbsp;<span class="op" id="1534591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534595">xadd64</span><span class="op" id="1534601">(</span><span class="ident" id="1534602">stat</span><span class="op" id="1534606">,</span>&nbsp;<span class="ident" id="1534608">int64</span><span class="op" id="1534613">(</span><span class="ident" id="1534614">size</span><span class="op" id="1534618">)</span><span class="op" id="1534619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534623">xadd64</span><span class="op" id="1534629">(</span><span class="op" id="1534630">&amp;</span><span class="ident" id="1534631">memstats</span><span class="op" id="1534639">.</span><span class="ident" id="1534640">other_sys</span><span class="op" id="1534649">,</span>&nbsp;<span class="op" id="1534651">-</span><span class="ident" id="1534652">int64</span><span class="op" id="1534657">(</span><span class="ident" id="1534658">size</span><span class="op" id="1534662">)</span><span class="op" id="1534663">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1534666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534669">return</span>&nbsp;<span class="ident" id="1534676">p</span><br>
<span class="lineno"></span><span class="op" id="1534678">}</span>
</div>
</body>
</html>
