<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/rsa</h2>
<ul>
<li><a href="/gostd/crypto/rsa/pkcs1v15.go.html">pkcs1v15.go</a></li>
<li><a href="/gostd/crypto/rsa/pkcs1v15_test.go.html">pkcs1v15_test.go</a></li>
<li><a href="/gostd/crypto/rsa/pss.go.html">pss.go</a></li>
<li><a href="/gostd/crypto/rsa/pss_test.go.html">pss_test.go</a></li>
<li><a href="/gostd/crypto/rsa/rsa.go.html">rsa.go</a></li>
<li><a href="/gostd/crypto/rsa/rsa_test.go.html">rsa_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3691566">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3691621">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3691675">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3691726">package</span>&nbsp;<span class="ident" id="3691734">rsa</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3691739">import</span>&nbsp;<span class="op" id="3691746">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3691749">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3691759">&#34;crypto/subtle&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3691776">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3691786">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3691792">&#34;math/big&#34;</span><br>
<span class="lineno"></span><span class="op" id="3691803">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="3691806">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;encryption&nbsp;and&nbsp;decryption&nbsp;using&nbsp;PKCS#1&nbsp;v1.5&nbsp;padding.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3691884">//&nbsp;EncryptPKCS1v15&nbsp;encrypts&nbsp;the&nbsp;given&nbsp;message&nbsp;with&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="3691980">//&nbsp;The&nbsp;message&nbsp;must&nbsp;be&nbsp;no&nbsp;longer&nbsp;than&nbsp;the&nbsp;length&nbsp;of&nbsp;the&nbsp;public&nbsp;modulus&nbsp;minus&nbsp;11&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="3692067">//&nbsp;WARNING:&nbsp;use&nbsp;of&nbsp;this&nbsp;function&nbsp;to&nbsp;encrypt&nbsp;plaintexts&nbsp;other&nbsp;than&nbsp;session&nbsp;keys</span><br>
<span class="lineno">20</span><span class="comment" id="3692146">//&nbsp;is&nbsp;dangerous.&nbsp;Use&nbsp;RSA&nbsp;OAEP&nbsp;in&nbsp;new&nbsp;protocols.</span><br>
<span class="lineno"></span><span class="keyword" id="3692194">func</span>&nbsp;<span class="ident" id="3692199">EncryptPKCS1v15</span><span class="op" id="3692214">(</span><span class="ident" id="3692215">rand</span>&nbsp;<span class="ident" id="3692220">io</span><span class="op" id="3692222">.</span><span class="ident" id="3692223">Reader</span><span class="op" id="3692229">,</span>&nbsp;<span class="ident" id="3692231">pub</span>&nbsp;<span class="op" id="3692235">*</span><span class="ident" id="3692236">PublicKey</span><span class="op" id="3692245">,</span>&nbsp;<span class="ident" id="3692247">msg</span>&nbsp;<span class="op" id="3692251">[</span><span class="op" id="3692252">]</span><span class="builtintype" id="3692253">byte</span><span class="op" id="3692257">)</span>&nbsp;<span class="op" id="3692259">(</span><span class="ident" id="3692260">out</span>&nbsp;<span class="op" id="3692264">[</span><span class="op" id="3692265">]</span><span class="builtintype" id="3692266">byte</span><span class="op" id="3692270">,</span>&nbsp;<span class="ident" id="3692272">err</span>&nbsp;<span class="builtintype" id="3692276">error</span><span class="op" id="3692281">)</span>&nbsp;<span class="op" id="3692283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3692286">if</span>&nbsp;<span class="ident" id="3692289">err</span>&nbsp;<span class="op" id="3692293">:=</span>&nbsp;<span class="ident" id="3692296">checkPub</span><span class="op" id="3692304">(</span><span class="ident" id="3692305">pub</span><span class="op" id="3692308">)</span><span class="op" id="3692309">;</span>&nbsp;<span class="ident" id="3692311">err</span>&nbsp;<span class="op" id="3692315">!=</span>&nbsp;<span class="ident" id="3692318">nil</span>&nbsp;<span class="op" id="3692322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3692326">return</span>&nbsp;<span class="ident" id="3692333">nil</span><span class="op" id="3692336">,</span>&nbsp;<span class="ident" id="3692338">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3692343">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3692346">k</span>&nbsp;<span class="op" id="3692348">:=</span>&nbsp;<span class="op" id="3692351">(</span><span class="ident" id="3692352">pub</span><span class="op" id="3692355">.</span><span class="ident" id="3692356">N</span><span class="op" id="3692357">.</span><span class="ident" id="3692358">BitLen</span><span class="op" id="3692364">(</span><span class="op" id="3692365">)</span>&nbsp;<span class="op" id="3692367">+</span>&nbsp;<span class="num" id="3692369">7</span><span class="op" id="3692370">)</span>&nbsp;<span class="op" id="3692372">/</span>&nbsp;<span class="num" id="3692374">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3692377">if</span>&nbsp;<span class="builtinfunc" id="3692380">len</span><span class="op" id="3692383">(</span><span class="ident" id="3692384">msg</span><span class="op" id="3692387">)</span>&nbsp;<span class="op" id="3692389">&gt;</span>&nbsp;<span class="ident" id="3692391">k</span><span class="op" id="3692392">-</span><span class="num" id="3692393">11</span>&nbsp;<span class="op" id="3692396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3692400">err</span>&nbsp;<span class="op" id="3692404">=</span>&nbsp;<span class="ident" id="3692406">ErrMessageTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3692426">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3692434">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3692438">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x02&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;M</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3692479">em</span>&nbsp;<span class="op" id="3692482">:=</span>&nbsp;<span class="builtinfunc" id="3692485">make</span><span class="op" id="3692489">(</span><span class="op" id="3692490">[</span><span class="op" id="3692491">]</span><span class="builtintype" id="3692492">byte</span><span class="op" id="3692496">,</span>&nbsp;<span class="ident" id="3692498">k</span><span class="op" id="3692499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3692502">em</span><span class="op" id="3692504">[</span><span class="num" id="3692505">1</span><span class="op" id="3692506">]</span>&nbsp;<span class="op" id="3692508">=</span>&nbsp;<span class="num" id="3692510">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3692513">ps</span><span class="op" id="3692515">,</span>&nbsp;<span class="ident" id="3692517">mm</span>&nbsp;<span class="op" id="3692520">:=</span>&nbsp;<span class="ident" id="3692523">em</span><span class="op" id="3692525">[</span><span class="num" id="3692526">2</span><span class="op" id="3692527">:</span><span class="builtinfunc" id="3692528">len</span><span class="op" id="3692531">(</span><span class="ident" id="3692532">em</span><span class="op" id="3692534">)</span><span class="op" id="3692535">-</span><span class="builtinfunc" id="3692536">len</span><span class="op" id="3692539">(</span><span class="ident" id="3692540">msg</span><span class="op" id="3692543">)</span><span class="op" id="3692544">-</span><span class="num" id="3692545">1</span><span class="op" id="3692546">]</span><span class="op" id="3692547">,</span>&nbsp;<span class="ident" id="3692549">em</span><span class="op" id="3692551">[</span><span class="builtinfunc" id="3692552">len</span><span class="op" id="3692555">(</span><span class="ident" id="3692556">em</span><span class="op" id="3692558">)</span><span class="op" id="3692559">-</span><span class="builtinfunc" id="3692560">len</span><span class="op" id="3692563">(</span><span class="ident" id="3692564">msg</span><span class="op" id="3692567">)</span><span class="op" id="3692568">:</span><span class="op" id="3692569">]</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3692572">err</span>&nbsp;<span class="op" id="3692576">=</span>&nbsp;<span class="ident" id="3692578">nonZeroRandomBytes</span><span class="op" id="3692596">(</span><span class="ident" id="3692597">ps</span><span class="op" id="3692599">,</span>&nbsp;<span class="ident" id="3692601">rand</span><span class="op" id="3692605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3692608">if</span>&nbsp;<span class="ident" id="3692611">err</span>&nbsp;<span class="op" id="3692615">!=</span>&nbsp;<span class="ident" id="3692618">nil</span>&nbsp;<span class="op" id="3692622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3692626">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3692634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3692637">em</span><span class="op" id="3692639">[</span><span class="builtinfunc" id="3692640">len</span><span class="op" id="3692643">(</span><span class="ident" id="3692644">em</span><span class="op" id="3692646">)</span><span class="op" id="3692647">-</span><span class="builtinfunc" id="3692648">len</span><span class="op" id="3692651">(</span><span class="ident" id="3692652">msg</span><span class="op" id="3692655">)</span><span class="op" id="3692656">-</span><span class="num" id="3692657">1</span><span class="op" id="3692658">]</span>&nbsp;<span class="op" id="3692660">=</span>&nbsp;<span class="num" id="3692662">0</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3692665">copy</span><span class="op" id="3692669">(</span><span class="ident" id="3692670">mm</span><span class="op" id="3692672">,</span>&nbsp;<span class="ident" id="3692674">msg</span><span class="op" id="3692677">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3692681">m</span>&nbsp;<span class="op" id="3692683">:=</span>&nbsp;<span class="builtinfunc" id="3692686">new</span><span class="op" id="3692689">(</span><span class="ident" id="3692690">big</span><span class="op" id="3692693">.</span><span class="ident" id="3692694">Int</span><span class="op" id="3692697">)</span><span class="op" id="3692698">.</span><span class="ident" id="3692699">SetBytes</span><span class="op" id="3692707">(</span><span class="ident" id="3692708">em</span><span class="op" id="3692710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3692713">c</span>&nbsp;<span class="op" id="3692715">:=</span>&nbsp;<span class="ident" id="3692718">encrypt</span><span class="op" id="3692725">(</span><span class="builtinfunc" id="3692726">new</span><span class="op" id="3692729">(</span><span class="ident" id="3692730">big</span><span class="op" id="3692733">.</span><span class="ident" id="3692734">Int</span><span class="op" id="3692737">)</span><span class="op" id="3692738">,</span>&nbsp;<span class="ident" id="3692740">pub</span><span class="op" id="3692743">,</span>&nbsp;<span class="ident" id="3692745">m</span><span class="op" id="3692746">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3692750">copyWithLeftPad</span><span class="op" id="3692765">(</span><span class="ident" id="3692766">em</span><span class="op" id="3692768">,</span>&nbsp;<span class="ident" id="3692770">c</span><span class="op" id="3692771">.</span><span class="ident" id="3692772">Bytes</span><span class="op" id="3692777">(</span><span class="op" id="3692778">)</span><span class="op" id="3692779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3692782">out</span>&nbsp;<span class="op" id="3692786">=</span>&nbsp;<span class="ident" id="3692788">em</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3692792">return</span><br>
<span class="lineno"></span><span class="op" id="3692799">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="3692802">//&nbsp;DecryptPKCS1v15&nbsp;decrypts&nbsp;a&nbsp;plaintext&nbsp;using&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="3692893">//&nbsp;If&nbsp;rand&nbsp;!=&nbsp;nil,&nbsp;it&nbsp;uses&nbsp;RSA&nbsp;blinding&nbsp;to&nbsp;avoid&nbsp;timing&nbsp;side-channel&nbsp;attacks.</span><br>
<span class="lineno"></span><span class="keyword" id="3692971">func</span>&nbsp;<span class="ident" id="3692976">DecryptPKCS1v15</span><span class="op" id="3692991">(</span><span class="ident" id="3692992">rand</span>&nbsp;<span class="ident" id="3692997">io</span><span class="op" id="3692999">.</span><span class="ident" id="3693000">Reader</span><span class="op" id="3693006">,</span>&nbsp;<span class="ident" id="3693008">priv</span>&nbsp;<span class="op" id="3693013">*</span><span class="ident" id="3693014">PrivateKey</span><span class="op" id="3693024">,</span>&nbsp;<span class="ident" id="3693026">ciphertext</span>&nbsp;<span class="op" id="3693037">[</span><span class="op" id="3693038">]</span><span class="builtintype" id="3693039">byte</span><span class="op" id="3693043">)</span>&nbsp;<span class="op" id="3693045">(</span><span class="ident" id="3693046">out</span>&nbsp;<span class="op" id="3693050">[</span><span class="op" id="3693051">]</span><span class="builtintype" id="3693052">byte</span><span class="op" id="3693056">,</span>&nbsp;<span class="ident" id="3693058">err</span>&nbsp;<span class="builtintype" id="3693062">error</span><span class="op" id="3693067">)</span>&nbsp;<span class="op" id="3693069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3693072">if</span>&nbsp;<span class="ident" id="3693075">err</span>&nbsp;<span class="op" id="3693079">:=</span>&nbsp;<span class="ident" id="3693082">checkPub</span><span class="op" id="3693090">(</span><span class="op" id="3693091">&amp;</span><span class="ident" id="3693092">priv</span><span class="op" id="3693096">.</span><span class="ident" id="3693097">PublicKey</span><span class="op" id="3693106">)</span><span class="op" id="3693107">;</span>&nbsp;<span class="ident" id="3693109">err</span>&nbsp;<span class="op" id="3693113">!=</span>&nbsp;<span class="ident" id="3693116">nil</span>&nbsp;<span class="op" id="3693120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3693124">return</span>&nbsp;<span class="ident" id="3693131">nil</span><span class="op" id="3693134">,</span>&nbsp;<span class="ident" id="3693136">err</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3693141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3693144">valid</span><span class="op" id="3693149">,</span>&nbsp;<span class="ident" id="3693151">out</span><span class="op" id="3693154">,</span>&nbsp;<span class="ident" id="3693156">index</span><span class="op" id="3693161">,</span>&nbsp;<span class="ident" id="3693163">err</span>&nbsp;<span class="op" id="3693167">:=</span>&nbsp;<span class="ident" id="3693170">decryptPKCS1v15</span><span class="op" id="3693185">(</span><span class="ident" id="3693186">rand</span><span class="op" id="3693190">,</span>&nbsp;<span class="ident" id="3693192">priv</span><span class="op" id="3693196">,</span>&nbsp;<span class="ident" id="3693198">ciphertext</span><span class="op" id="3693208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3693211">if</span>&nbsp;<span class="ident" id="3693214">err</span>&nbsp;<span class="op" id="3693218">!=</span>&nbsp;<span class="ident" id="3693221">nil</span>&nbsp;<span class="op" id="3693225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3693229">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3693237">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3693240">if</span>&nbsp;<span class="ident" id="3693243">valid</span>&nbsp;<span class="op" id="3693249">==</span>&nbsp;<span class="num" id="3693252">0</span>&nbsp;<span class="op" id="3693254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3693258">return</span>&nbsp;<span class="ident" id="3693265">nil</span><span class="op" id="3693268">,</span>&nbsp;<span class="ident" id="3693270">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3693285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3693288">out</span>&nbsp;<span class="op" id="3693292">=</span>&nbsp;<span class="ident" id="3693294">out</span><span class="op" id="3693297">[</span><span class="ident" id="3693298">index</span><span class="op" id="3693303">:</span><span class="op" id="3693304">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3693307">return</span><br>
<span class="lineno">65</span><span class="op" id="3693314">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3693317">//&nbsp;DecryptPKCS1v15SessionKey&nbsp;decrypts&nbsp;a&nbsp;session&nbsp;key&nbsp;using&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="3693420">//&nbsp;If&nbsp;rand&nbsp;!=&nbsp;nil,&nbsp;it&nbsp;uses&nbsp;RSA&nbsp;blinding&nbsp;to&nbsp;avoid&nbsp;timing&nbsp;side-channel&nbsp;attacks.</span><br>
<span class="lineno"></span><span class="comment" id="3693498">//&nbsp;It&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;ciphertext&nbsp;is&nbsp;the&nbsp;wrong&nbsp;length&nbsp;or&nbsp;if&nbsp;the</span><br>
<span class="lineno">70</span><span class="comment" id="3693569">//&nbsp;ciphertext&nbsp;is&nbsp;greater&nbsp;than&nbsp;the&nbsp;public&nbsp;modulus.&nbsp;Otherwise,&nbsp;no&nbsp;error&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3693642">//&nbsp;returned.&nbsp;If&nbsp;the&nbsp;padding&nbsp;is&nbsp;valid,&nbsp;the&nbsp;resulting&nbsp;plaintext&nbsp;message&nbsp;is&nbsp;copied</span><br>
<span class="lineno"></span><span class="comment" id="3693722">//&nbsp;into&nbsp;key.&nbsp;Otherwise,&nbsp;key&nbsp;is&nbsp;unchanged.&nbsp;These&nbsp;alternatives&nbsp;occur&nbsp;in&nbsp;constant</span><br>
<span class="lineno"></span><span class="comment" id="3693801">//&nbsp;time.&nbsp;It&nbsp;is&nbsp;intended&nbsp;that&nbsp;the&nbsp;user&nbsp;of&nbsp;this&nbsp;function&nbsp;generate&nbsp;a&nbsp;random</span><br>
<span class="lineno"></span><span class="comment" id="3693874">//&nbsp;session&nbsp;key&nbsp;beforehand&nbsp;and&nbsp;continue&nbsp;the&nbsp;protocol&nbsp;with&nbsp;the&nbsp;resulting&nbsp;value.</span><br>
<span class="lineno">75</span><span class="comment" id="3693952">//&nbsp;This&nbsp;will&nbsp;remove&nbsp;any&nbsp;possibility&nbsp;that&nbsp;an&nbsp;attacker&nbsp;can&nbsp;learn&nbsp;any&nbsp;information</span><br>
<span class="lineno"></span><span class="comment" id="3694031">//&nbsp;about&nbsp;the&nbsp;plaintext.</span><br>
<span class="lineno"></span><span class="comment" id="3694055">//&nbsp;See&nbsp;``Chosen&nbsp;Ciphertext&nbsp;Attacks&nbsp;Against&nbsp;Protocols&nbsp;Based&nbsp;on&nbsp;the&nbsp;RSA</span><br>
<span class="lineno"></span><span class="comment" id="3694125">//&nbsp;Encryption&nbsp;Standard&nbsp;PKCS&nbsp;#1&#39;&#39;,&nbsp;Daniel&nbsp;Bleichenbacher,&nbsp;Advances&nbsp;in&nbsp;Cryptology</span><br>
<span class="lineno"></span><span class="comment" id="3694205">//&nbsp;(Crypto&nbsp;&#39;98).</span><br>
<span class="lineno">80</span><span class="keyword" id="3694222">func</span>&nbsp;<span class="ident" id="3694227">DecryptPKCS1v15SessionKey</span><span class="op" id="3694252">(</span><span class="ident" id="3694253">rand</span>&nbsp;<span class="ident" id="3694258">io</span><span class="op" id="3694260">.</span><span class="ident" id="3694261">Reader</span><span class="op" id="3694267">,</span>&nbsp;<span class="ident" id="3694269">priv</span>&nbsp;<span class="op" id="3694274">*</span><span class="ident" id="3694275">PrivateKey</span><span class="op" id="3694285">,</span>&nbsp;<span class="ident" id="3694287">ciphertext</span>&nbsp;<span class="op" id="3694298">[</span><span class="op" id="3694299">]</span><span class="builtintype" id="3694300">byte</span><span class="op" id="3694304">,</span>&nbsp;<span class="ident" id="3694306">key</span>&nbsp;<span class="op" id="3694310">[</span><span class="op" id="3694311">]</span><span class="builtintype" id="3694312">byte</span><span class="op" id="3694316">)</span>&nbsp;<span class="op" id="3694318">(</span><span class="ident" id="3694319">err</span>&nbsp;<span class="builtintype" id="3694323">error</span><span class="op" id="3694328">)</span>&nbsp;<span class="op" id="3694330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3694333">if</span>&nbsp;<span class="ident" id="3694336">err</span>&nbsp;<span class="op" id="3694340">:=</span>&nbsp;<span class="ident" id="3694343">checkPub</span><span class="op" id="3694351">(</span><span class="op" id="3694352">&amp;</span><span class="ident" id="3694353">priv</span><span class="op" id="3694357">.</span><span class="ident" id="3694358">PublicKey</span><span class="op" id="3694367">)</span><span class="op" id="3694368">;</span>&nbsp;<span class="ident" id="3694370">err</span>&nbsp;<span class="op" id="3694374">!=</span>&nbsp;<span class="ident" id="3694377">nil</span>&nbsp;<span class="op" id="3694381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3694385">return</span>&nbsp;<span class="ident" id="3694392">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3694397">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3694400">k</span>&nbsp;<span class="op" id="3694402">:=</span>&nbsp;<span class="op" id="3694405">(</span><span class="ident" id="3694406">priv</span><span class="op" id="3694410">.</span><span class="ident" id="3694411">N</span><span class="op" id="3694412">.</span><span class="ident" id="3694413">BitLen</span><span class="op" id="3694419">(</span><span class="op" id="3694420">)</span>&nbsp;<span class="op" id="3694422">+</span>&nbsp;<span class="num" id="3694424">7</span><span class="op" id="3694425">)</span>&nbsp;<span class="op" id="3694427">/</span>&nbsp;<span class="num" id="3694429">8</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3694432">if</span>&nbsp;<span class="ident" id="3694435">k</span><span class="op" id="3694436">-</span><span class="op" id="3694437">(</span><span class="builtinfunc" id="3694438">len</span><span class="op" id="3694441">(</span><span class="ident" id="3694442">key</span><span class="op" id="3694445">)</span><span class="op" id="3694446">+</span><span class="num" id="3694447">3</span><span class="op" id="3694448">+</span><span class="num" id="3694449">8</span><span class="op" id="3694450">)</span>&nbsp;<span class="op" id="3694452">&lt;</span>&nbsp;<span class="num" id="3694454">0</span>&nbsp;<span class="op" id="3694456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3694460">return</span>&nbsp;<span class="ident" id="3694467">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3694482">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3694486">valid</span><span class="op" id="3694491">,</span>&nbsp;<span class="ident" id="3694493">em</span><span class="op" id="3694495">,</span>&nbsp;<span class="ident" id="3694497">index</span><span class="op" id="3694502">,</span>&nbsp;<span class="ident" id="3694504">err</span>&nbsp;<span class="op" id="3694508">:=</span>&nbsp;<span class="ident" id="3694511">decryptPKCS1v15</span><span class="op" id="3694526">(</span><span class="ident" id="3694527">rand</span><span class="op" id="3694531">,</span>&nbsp;<span class="ident" id="3694533">priv</span><span class="op" id="3694537">,</span>&nbsp;<span class="ident" id="3694539">ciphertext</span><span class="op" id="3694549">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3694552">if</span>&nbsp;<span class="ident" id="3694555">err</span>&nbsp;<span class="op" id="3694559">!=</span>&nbsp;<span class="ident" id="3694562">nil</span>&nbsp;<span class="op" id="3694566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3694570">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3694578">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3694582">if</span>&nbsp;<span class="builtinfunc" id="3694585">len</span><span class="op" id="3694588">(</span><span class="ident" id="3694589">em</span><span class="op" id="3694591">)</span>&nbsp;<span class="op" id="3694593">!=</span>&nbsp;<span class="ident" id="3694596">k</span>&nbsp;<span class="op" id="3694598">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3694602">//&nbsp;This&nbsp;should&nbsp;be&nbsp;impossible&nbsp;because&nbsp;decryptPKCS1v15&nbsp;always</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3694664">//&nbsp;returns&nbsp;the&nbsp;full&nbsp;slice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3694693">return</span>&nbsp;<span class="ident" id="3694700">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3694715">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3694719">valid</span>&nbsp;<span class="op" id="3694725">&amp;=</span>&nbsp;<span class="ident" id="3694728">subtle</span><span class="op" id="3694734">.</span><span class="ident" id="3694735">ConstantTimeEq</span><span class="op" id="3694749">(</span><span class="builtintype" id="3694750">int32</span><span class="op" id="3694755">(</span><span class="builtinfunc" id="3694756">len</span><span class="op" id="3694759">(</span><span class="ident" id="3694760">em</span><span class="op" id="3694762">)</span><span class="op" id="3694763">-</span><span class="ident" id="3694764">index</span><span class="op" id="3694769">)</span><span class="op" id="3694770">,</span>&nbsp;<span class="builtintype" id="3694772">int32</span><span class="op" id="3694777">(</span><span class="builtinfunc" id="3694778">len</span><span class="op" id="3694781">(</span><span class="ident" id="3694782">key</span><span class="op" id="3694785">)</span><span class="op" id="3694786">)</span><span class="op" id="3694787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3694790">subtle</span><span class="op" id="3694796">.</span><span class="ident" id="3694797">ConstantTimeCopy</span><span class="op" id="3694813">(</span><span class="ident" id="3694814">valid</span><span class="op" id="3694819">,</span>&nbsp;<span class="ident" id="3694821">key</span><span class="op" id="3694824">,</span>&nbsp;<span class="ident" id="3694826">em</span><span class="op" id="3694828">[</span><span class="builtinfunc" id="3694829">len</span><span class="op" id="3694832">(</span><span class="ident" id="3694833">em</span><span class="op" id="3694835">)</span><span class="op" id="3694836">-</span><span class="builtinfunc" id="3694837">len</span><span class="op" id="3694840">(</span><span class="ident" id="3694841">key</span><span class="op" id="3694844">)</span><span class="op" id="3694845">:</span><span class="op" id="3694846">]</span><span class="op" id="3694847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3694850">return</span><br>
<span class="lineno"></span><span class="op" id="3694857">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="3694860">//&nbsp;decryptPKCS1v15&nbsp;decrypts&nbsp;ciphertext&nbsp;using&nbsp;priv&nbsp;and&nbsp;blinds&nbsp;the&nbsp;operation&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="3694938">//&nbsp;rand&nbsp;is&nbsp;not&nbsp;nil.&nbsp;It&nbsp;returns&nbsp;one&nbsp;or&nbsp;zero&nbsp;in&nbsp;valid&nbsp;that&nbsp;indicates&nbsp;whether&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3695017">//&nbsp;plaintext&nbsp;was&nbsp;correctly&nbsp;structured.&nbsp;In&nbsp;either&nbsp;case,&nbsp;the&nbsp;plaintext&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3695089">//&nbsp;returned&nbsp;in&nbsp;em&nbsp;so&nbsp;that&nbsp;it&nbsp;may&nbsp;be&nbsp;read&nbsp;independently&nbsp;of&nbsp;whether&nbsp;it&nbsp;was&nbsp;valid</span><br>
<span class="lineno"></span><span class="comment" id="3695168">//&nbsp;in&nbsp;order&nbsp;to&nbsp;maintain&nbsp;constant&nbsp;memory&nbsp;access&nbsp;patterns.&nbsp;If&nbsp;the&nbsp;plaintext&nbsp;was</span><br>
<span class="lineno">110</span><span class="comment" id="3695246">//&nbsp;valid&nbsp;then&nbsp;index&nbsp;contains&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;original&nbsp;message&nbsp;in&nbsp;em.</span><br>
<span class="lineno"></span><span class="keyword" id="3695316">func</span>&nbsp;<span class="ident" id="3695321">decryptPKCS1v15</span><span class="op" id="3695336">(</span><span class="ident" id="3695337">rand</span>&nbsp;<span class="ident" id="3695342">io</span><span class="op" id="3695344">.</span><span class="ident" id="3695345">Reader</span><span class="op" id="3695351">,</span>&nbsp;<span class="ident" id="3695353">priv</span>&nbsp;<span class="op" id="3695358">*</span><span class="ident" id="3695359">PrivateKey</span><span class="op" id="3695369">,</span>&nbsp;<span class="ident" id="3695371">ciphertext</span>&nbsp;<span class="op" id="3695382">[</span><span class="op" id="3695383">]</span><span class="builtintype" id="3695384">byte</span><span class="op" id="3695388">)</span>&nbsp;<span class="op" id="3695390">(</span><span class="ident" id="3695391">valid</span>&nbsp;<span class="builtintype" id="3695397">int</span><span class="op" id="3695400">,</span>&nbsp;<span class="ident" id="3695402">em</span>&nbsp;<span class="op" id="3695405">[</span><span class="op" id="3695406">]</span><span class="builtintype" id="3695407">byte</span><span class="op" id="3695411">,</span>&nbsp;<span class="ident" id="3695413">index</span>&nbsp;<span class="builtintype" id="3695419">int</span><span class="op" id="3695422">,</span>&nbsp;<span class="ident" id="3695424">err</span>&nbsp;<span class="builtintype" id="3695428">error</span><span class="op" id="3695433">)</span>&nbsp;<span class="op" id="3695435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3695438">k</span>&nbsp;<span class="op" id="3695440">:=</span>&nbsp;<span class="op" id="3695443">(</span><span class="ident" id="3695444">priv</span><span class="op" id="3695448">.</span><span class="ident" id="3695449">N</span><span class="op" id="3695450">.</span><span class="ident" id="3695451">BitLen</span><span class="op" id="3695457">(</span><span class="op" id="3695458">)</span>&nbsp;<span class="op" id="3695460">+</span>&nbsp;<span class="num" id="3695462">7</span><span class="op" id="3695463">)</span>&nbsp;<span class="op" id="3695465">/</span>&nbsp;<span class="num" id="3695467">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3695470">if</span>&nbsp;<span class="ident" id="3695473">k</span>&nbsp;<span class="op" id="3695475">&lt;</span>&nbsp;<span class="num" id="3695477">11</span>&nbsp;<span class="op" id="3695480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3695484">err</span>&nbsp;<span class="op" id="3695488">=</span>&nbsp;<span class="ident" id="3695490">ErrDecryption</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3695506">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3695514">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3695518">c</span>&nbsp;<span class="op" id="3695520">:=</span>&nbsp;<span class="builtinfunc" id="3695523">new</span><span class="op" id="3695526">(</span><span class="ident" id="3695527">big</span><span class="op" id="3695530">.</span><span class="ident" id="3695531">Int</span><span class="op" id="3695534">)</span><span class="op" id="3695535">.</span><span class="ident" id="3695536">SetBytes</span><span class="op" id="3695544">(</span><span class="ident" id="3695545">ciphertext</span><span class="op" id="3695555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3695558">m</span><span class="op" id="3695559">,</span>&nbsp;<span class="ident" id="3695561">err</span>&nbsp;<span class="op" id="3695565">:=</span>&nbsp;<span class="ident" id="3695568">decrypt</span><span class="op" id="3695575">(</span><span class="ident" id="3695576">rand</span><span class="op" id="3695580">,</span>&nbsp;<span class="ident" id="3695582">priv</span><span class="op" id="3695586">,</span>&nbsp;<span class="ident" id="3695588">c</span><span class="op" id="3695589">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3695592">if</span>&nbsp;<span class="ident" id="3695595">err</span>&nbsp;<span class="op" id="3695599">!=</span>&nbsp;<span class="ident" id="3695602">nil</span>&nbsp;<span class="op" id="3695606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3695610">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3695618">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3695622">em</span>&nbsp;<span class="op" id="3695625">=</span>&nbsp;<span class="ident" id="3695627">leftPad</span><span class="op" id="3695634">(</span><span class="ident" id="3695635">m</span><span class="op" id="3695636">.</span><span class="ident" id="3695637">Bytes</span><span class="op" id="3695642">(</span><span class="op" id="3695643">)</span><span class="op" id="3695644">,</span>&nbsp;<span class="ident" id="3695646">k</span><span class="op" id="3695647">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3695650">firstByteIsZero</span>&nbsp;<span class="op" id="3695666">:=</span>&nbsp;<span class="ident" id="3695669">subtle</span><span class="op" id="3695675">.</span><span class="ident" id="3695676">ConstantTimeByteEq</span><span class="op" id="3695694">(</span><span class="ident" id="3695695">em</span><span class="op" id="3695697">[</span><span class="num" id="3695698">0</span><span class="op" id="3695699">]</span><span class="op" id="3695700">,</span>&nbsp;<span class="num" id="3695702">0</span><span class="op" id="3695703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3695706">secondByteIsTwo</span>&nbsp;<span class="op" id="3695722">:=</span>&nbsp;<span class="ident" id="3695725">subtle</span><span class="op" id="3695731">.</span><span class="ident" id="3695732">ConstantTimeByteEq</span><span class="op" id="3695750">(</span><span class="ident" id="3695751">em</span><span class="op" id="3695753">[</span><span class="num" id="3695754">1</span><span class="op" id="3695755">]</span><span class="op" id="3695756">,</span>&nbsp;<span class="num" id="3695758">2</span><span class="op" id="3695759">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3695763">//&nbsp;The&nbsp;remainder&nbsp;of&nbsp;the&nbsp;plaintext&nbsp;must&nbsp;be&nbsp;a&nbsp;string&nbsp;of&nbsp;non-zero&nbsp;random</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3695834">//&nbsp;octets,&nbsp;followed&nbsp;by&nbsp;a&nbsp;0,&nbsp;followed&nbsp;by&nbsp;the&nbsp;message.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3695888">//&nbsp;&nbsp;&nbsp;lookingForIndex:&nbsp;1&nbsp;iff&nbsp;we&nbsp;are&nbsp;still&nbsp;looking&nbsp;for&nbsp;the&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3695952">//&nbsp;&nbsp;&nbsp;index:&nbsp;the&nbsp;offset&nbsp;of&nbsp;the&nbsp;first&nbsp;zero&nbsp;byte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3696000">lookingForIndex</span>&nbsp;<span class="op" id="3696016">:=</span>&nbsp;<span class="num" id="3696019">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3696023">for</span>&nbsp;<span class="ident" id="3696027">i</span>&nbsp;<span class="op" id="3696029">:=</span>&nbsp;<span class="num" id="3696032">2</span><span class="op" id="3696033">;</span>&nbsp;<span class="ident" id="3696035">i</span>&nbsp;<span class="op" id="3696037">&lt;</span>&nbsp;<span class="builtinfunc" id="3696039">len</span><span class="op" id="3696042">(</span><span class="ident" id="3696043">em</span><span class="op" id="3696045">)</span><span class="op" id="3696046">;</span>&nbsp;<span class="ident" id="3696048">i</span><span class="op" id="3696049">++</span>&nbsp;<span class="op" id="3696052">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3696056">equals0</span>&nbsp;<span class="op" id="3696064">:=</span>&nbsp;<span class="ident" id="3696067">subtle</span><span class="op" id="3696073">.</span><span class="ident" id="3696074">ConstantTimeByteEq</span><span class="op" id="3696092">(</span><span class="ident" id="3696093">em</span><span class="op" id="3696095">[</span><span class="ident" id="3696096">i</span><span class="op" id="3696097">]</span><span class="op" id="3696098">,</span>&nbsp;<span class="num" id="3696100">0</span><span class="op" id="3696101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3696105">index</span>&nbsp;<span class="op" id="3696111">=</span>&nbsp;<span class="ident" id="3696113">subtle</span><span class="op" id="3696119">.</span><span class="ident" id="3696120">ConstantTimeSelect</span><span class="op" id="3696138">(</span><span class="ident" id="3696139">lookingForIndex</span><span class="op" id="3696154">&amp;</span><span class="ident" id="3696155">equals0</span><span class="op" id="3696162">,</span>&nbsp;<span class="ident" id="3696164">i</span><span class="op" id="3696165">,</span>&nbsp;<span class="ident" id="3696167">index</span><span class="op" id="3696172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3696176">lookingForIndex</span>&nbsp;<span class="op" id="3696192">=</span>&nbsp;<span class="ident" id="3696194">subtle</span><span class="op" id="3696200">.</span><span class="ident" id="3696201">ConstantTimeSelect</span><span class="op" id="3696219">(</span><span class="ident" id="3696220">equals0</span><span class="op" id="3696227">,</span>&nbsp;<span class="num" id="3696229">0</span><span class="op" id="3696230">,</span>&nbsp;<span class="ident" id="3696232">lookingForIndex</span><span class="op" id="3696247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3696250">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3696254">//&nbsp;The&nbsp;PS&nbsp;padding&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;8&nbsp;bytes&nbsp;long,&nbsp;and&nbsp;it&nbsp;starts&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3696322">//&nbsp;bytes&nbsp;into&nbsp;em.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3696341">validPS</span>&nbsp;<span class="op" id="3696349">:=</span>&nbsp;<span class="ident" id="3696352">subtle</span><span class="op" id="3696358">.</span><span class="ident" id="3696359">ConstantTimeLessOrEq</span><span class="op" id="3696379">(</span><span class="num" id="3696380">2</span><span class="op" id="3696381">+</span><span class="num" id="3696382">8</span><span class="op" id="3696383">,</span>&nbsp;<span class="ident" id="3696385">index</span><span class="op" id="3696390">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3696394">valid</span>&nbsp;<span class="op" id="3696400">=</span>&nbsp;<span class="ident" id="3696402">firstByteIsZero</span>&nbsp;<span class="op" id="3696418">&amp;</span>&nbsp;<span class="ident" id="3696420">secondByteIsTwo</span>&nbsp;<span class="op" id="3696436">&amp;</span>&nbsp;<span class="op" id="3696438">(</span><span class="op" id="3696439">^</span><span class="ident" id="3696440">lookingForIndex</span>&nbsp;<span class="op" id="3696456">&amp;</span>&nbsp;<span class="num" id="3696458">1</span><span class="op" id="3696459">)</span>&nbsp;<span class="op" id="3696461">&amp;</span>&nbsp;<span class="ident" id="3696463">validPS</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3696472">index</span>&nbsp;<span class="op" id="3696478">=</span>&nbsp;<span class="ident" id="3696480">subtle</span><span class="op" id="3696486">.</span><span class="ident" id="3696487">ConstantTimeSelect</span><span class="op" id="3696505">(</span><span class="ident" id="3696506">valid</span><span class="op" id="3696511">,</span>&nbsp;<span class="ident" id="3696513">index</span><span class="op" id="3696518">+</span><span class="num" id="3696519">1</span><span class="op" id="3696520">,</span>&nbsp;<span class="num" id="3696522">0</span><span class="op" id="3696523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3696526">return</span>&nbsp;<span class="ident" id="3696533">valid</span><span class="op" id="3696538">,</span>&nbsp;<span class="ident" id="3696540">em</span><span class="op" id="3696542">,</span>&nbsp;<span class="ident" id="3696544">index</span><span class="op" id="3696549">,</span>&nbsp;<span class="ident" id="3696551">nil</span><br>
<span class="lineno"></span><span class="op" id="3696555">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3696558">//&nbsp;nonZeroRandomBytes&nbsp;fills&nbsp;the&nbsp;given&nbsp;slice&nbsp;with&nbsp;non-zero&nbsp;random&nbsp;octets.</span><br>
<span class="lineno">150</span><span class="keyword" id="3696631">func</span>&nbsp;<span class="ident" id="3696636">nonZeroRandomBytes</span><span class="op" id="3696654">(</span><span class="ident" id="3696655">s</span>&nbsp;<span class="op" id="3696657">[</span><span class="op" id="3696658">]</span><span class="builtintype" id="3696659">byte</span><span class="op" id="3696663">,</span>&nbsp;<span class="ident" id="3696665">rand</span>&nbsp;<span class="ident" id="3696670">io</span><span class="op" id="3696672">.</span><span class="ident" id="3696673">Reader</span><span class="op" id="3696679">)</span>&nbsp;<span class="op" id="3696681">(</span><span class="ident" id="3696682">err</span>&nbsp;<span class="builtintype" id="3696686">error</span><span class="op" id="3696691">)</span>&nbsp;<span class="op" id="3696693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3696696">_</span><span class="op" id="3696697">,</span>&nbsp;<span class="ident" id="3696699">err</span>&nbsp;<span class="op" id="3696703">=</span>&nbsp;<span class="ident" id="3696705">io</span><span class="op" id="3696707">.</span><span class="ident" id="3696708">ReadFull</span><span class="op" id="3696716">(</span><span class="ident" id="3696717">rand</span><span class="op" id="3696721">,</span>&nbsp;<span class="ident" id="3696723">s</span><span class="op" id="3696724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3696727">if</span>&nbsp;<span class="ident" id="3696730">err</span>&nbsp;<span class="op" id="3696734">!=</span>&nbsp;<span class="ident" id="3696737">nil</span>&nbsp;<span class="op" id="3696741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3696745">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3696753">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3696757">for</span>&nbsp;<span class="ident" id="3696761">i</span>&nbsp;<span class="op" id="3696763">:=</span>&nbsp;<span class="num" id="3696766">0</span><span class="op" id="3696767">;</span>&nbsp;<span class="ident" id="3696769">i</span>&nbsp;<span class="op" id="3696771">&lt;</span>&nbsp;<span class="builtinfunc" id="3696773">len</span><span class="op" id="3696776">(</span><span class="ident" id="3696777">s</span><span class="op" id="3696778">)</span><span class="op" id="3696779">;</span>&nbsp;<span class="ident" id="3696781">i</span><span class="op" id="3696782">++</span>&nbsp;<span class="op" id="3696785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3696789">for</span>&nbsp;<span class="ident" id="3696793">s</span><span class="op" id="3696794">[</span><span class="ident" id="3696795">i</span><span class="op" id="3696796">]</span>&nbsp;<span class="op" id="3696798">==</span>&nbsp;<span class="num" id="3696801">0</span>&nbsp;<span class="op" id="3696803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3696808">_</span><span class="op" id="3696809">,</span>&nbsp;<span class="ident" id="3696811">err</span>&nbsp;<span class="op" id="3696815">=</span>&nbsp;<span class="ident" id="3696817">io</span><span class="op" id="3696819">.</span><span class="ident" id="3696820">ReadFull</span><span class="op" id="3696828">(</span><span class="ident" id="3696829">rand</span><span class="op" id="3696833">,</span>&nbsp;<span class="ident" id="3696835">s</span><span class="op" id="3696836">[</span><span class="ident" id="3696837">i</span><span class="op" id="3696838">:</span><span class="ident" id="3696839">i</span><span class="op" id="3696840">+</span><span class="num" id="3696841">1</span><span class="op" id="3696842">]</span><span class="op" id="3696843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3696848">if</span>&nbsp;<span class="ident" id="3696851">err</span>&nbsp;<span class="op" id="3696855">!=</span>&nbsp;<span class="ident" id="3696858">nil</span>&nbsp;<span class="op" id="3696862">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3696868">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3696878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3696883">//&nbsp;In&nbsp;tests,&nbsp;the&nbsp;PRNG&nbsp;may&nbsp;return&nbsp;all&nbsp;zeros&nbsp;so&nbsp;we&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3696938">//&nbsp;this&nbsp;to&nbsp;break&nbsp;the&nbsp;loop.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3696968">s</span><span class="op" id="3696969">[</span><span class="ident" id="3696970">i</span><span class="op" id="3696971">]</span>&nbsp;<span class="op" id="3696973">^=</span>&nbsp;<span class="num" id="3696976">0x42</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3696983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3696986">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3696990">return</span><br>
<span class="lineno"></span><span class="op" id="3696997">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="comment" id="3697000">//&nbsp;These&nbsp;are&nbsp;ASN1&nbsp;DER&nbsp;structures:</span><br>
<span class="lineno"></span><span class="comment" id="3697034">//&nbsp;&nbsp;&nbsp;DigestInfo&nbsp;::=&nbsp;SEQUENCE&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3697065">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;digestAlgorithm&nbsp;AlgorithmIdentifier,</span><br>
<span class="lineno"></span><span class="comment" id="3697109">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;digest&nbsp;OCTET&nbsp;STRING</span><br>
<span class="lineno">175</span><span class="comment" id="3697136">//&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="3697143">//&nbsp;For&nbsp;performance,&nbsp;we&nbsp;don&#39;t&nbsp;use&nbsp;the&nbsp;generic&nbsp;ASN1&nbsp;encoder.&nbsp;Rather,&nbsp;we</span><br>
<span class="lineno"></span><span class="comment" id="3697213">//&nbsp;precompute&nbsp;a&nbsp;prefix&nbsp;of&nbsp;the&nbsp;digest&nbsp;value&nbsp;that&nbsp;makes&nbsp;a&nbsp;valid&nbsp;ASN1&nbsp;DER&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="3697291">//&nbsp;with&nbsp;the&nbsp;correct&nbsp;contents.</span><br>
<span class="lineno"></span><span class="keyword" id="3697321">var</span>&nbsp;<span class="ident" id="3697325">hashPrefixes</span>&nbsp;<span class="op" id="3697338">=</span>&nbsp;<span class="keyword" id="3697340">map</span><span class="op" id="3697343">[</span><span class="ident" id="3697344">crypto</span><span class="op" id="3697350">.</span><span class="ident" id="3697351">Hash</span><span class="op" id="3697355">]</span><span class="op" id="3697356">[</span><span class="op" id="3697357">]</span><span class="builtintype" id="3697358">byte</span><span class="op" id="3697362">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3697365">crypto</span><span class="op" id="3697371">.</span><span class="ident" id="3697372">MD5</span><span class="op" id="3697375">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3697383">{</span><span class="num" id="3697384">0x30</span><span class="op" id="3697388">,</span>&nbsp;<span class="num" id="3697390">0x20</span><span class="op" id="3697394">,</span>&nbsp;<span class="num" id="3697396">0x30</span><span class="op" id="3697400">,</span>&nbsp;<span class="num" id="3697402">0x0c</span><span class="op" id="3697406">,</span>&nbsp;<span class="num" id="3697408">0x06</span><span class="op" id="3697412">,</span>&nbsp;<span class="num" id="3697414">0x08</span><span class="op" id="3697418">,</span>&nbsp;<span class="num" id="3697420">0x2a</span><span class="op" id="3697424">,</span>&nbsp;<span class="num" id="3697426">0x86</span><span class="op" id="3697430">,</span>&nbsp;<span class="num" id="3697432">0x48</span><span class="op" id="3697436">,</span>&nbsp;<span class="num" id="3697438">0x86</span><span class="op" id="3697442">,</span>&nbsp;<span class="num" id="3697444">0xf7</span><span class="op" id="3697448">,</span>&nbsp;<span class="num" id="3697450">0x0d</span><span class="op" id="3697454">,</span>&nbsp;<span class="num" id="3697456">0x02</span><span class="op" id="3697460">,</span>&nbsp;<span class="num" id="3697462">0x05</span><span class="op" id="3697466">,</span>&nbsp;<span class="num" id="3697468">0x05</span><span class="op" id="3697472">,</span>&nbsp;<span class="num" id="3697474">0x00</span><span class="op" id="3697478">,</span>&nbsp;<span class="num" id="3697480">0x04</span><span class="op" id="3697484">,</span>&nbsp;<span class="num" id="3697486">0x10</span><span class="op" id="3697490">}</span><span class="op" id="3697491">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3697494">crypto</span><span class="op" id="3697500">.</span><span class="ident" id="3697501">SHA1</span><span class="op" id="3697505">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3697512">{</span><span class="num" id="3697513">0x30</span><span class="op" id="3697517">,</span>&nbsp;<span class="num" id="3697519">0x21</span><span class="op" id="3697523">,</span>&nbsp;<span class="num" id="3697525">0x30</span><span class="op" id="3697529">,</span>&nbsp;<span class="num" id="3697531">0x09</span><span class="op" id="3697535">,</span>&nbsp;<span class="num" id="3697537">0x06</span><span class="op" id="3697541">,</span>&nbsp;<span class="num" id="3697543">0x05</span><span class="op" id="3697547">,</span>&nbsp;<span class="num" id="3697549">0x2b</span><span class="op" id="3697553">,</span>&nbsp;<span class="num" id="3697555">0x0e</span><span class="op" id="3697559">,</span>&nbsp;<span class="num" id="3697561">0x03</span><span class="op" id="3697565">,</span>&nbsp;<span class="num" id="3697567">0x02</span><span class="op" id="3697571">,</span>&nbsp;<span class="num" id="3697573">0x1a</span><span class="op" id="3697577">,</span>&nbsp;<span class="num" id="3697579">0x05</span><span class="op" id="3697583">,</span>&nbsp;<span class="num" id="3697585">0x00</span><span class="op" id="3697589">,</span>&nbsp;<span class="num" id="3697591">0x04</span><span class="op" id="3697595">,</span>&nbsp;<span class="num" id="3697597">0x14</span><span class="op" id="3697601">}</span><span class="op" id="3697602">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3697605">crypto</span><span class="op" id="3697611">.</span><span class="ident" id="3697612">SHA224</span><span class="op" id="3697618">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3697623">{</span><span class="num" id="3697624">0x30</span><span class="op" id="3697628">,</span>&nbsp;<span class="num" id="3697630">0x2d</span><span class="op" id="3697634">,</span>&nbsp;<span class="num" id="3697636">0x30</span><span class="op" id="3697640">,</span>&nbsp;<span class="num" id="3697642">0x0d</span><span class="op" id="3697646">,</span>&nbsp;<span class="num" id="3697648">0x06</span><span class="op" id="3697652">,</span>&nbsp;<span class="num" id="3697654">0x09</span><span class="op" id="3697658">,</span>&nbsp;<span class="num" id="3697660">0x60</span><span class="op" id="3697664">,</span>&nbsp;<span class="num" id="3697666">0x86</span><span class="op" id="3697670">,</span>&nbsp;<span class="num" id="3697672">0x48</span><span class="op" id="3697676">,</span>&nbsp;<span class="num" id="3697678">0x01</span><span class="op" id="3697682">,</span>&nbsp;<span class="num" id="3697684">0x65</span><span class="op" id="3697688">,</span>&nbsp;<span class="num" id="3697690">0x03</span><span class="op" id="3697694">,</span>&nbsp;<span class="num" id="3697696">0x04</span><span class="op" id="3697700">,</span>&nbsp;<span class="num" id="3697702">0x02</span><span class="op" id="3697706">,</span>&nbsp;<span class="num" id="3697708">0x04</span><span class="op" id="3697712">,</span>&nbsp;<span class="num" id="3697714">0x05</span><span class="op" id="3697718">,</span>&nbsp;<span class="num" id="3697720">0x00</span><span class="op" id="3697724">,</span>&nbsp;<span class="num" id="3697726">0x04</span><span class="op" id="3697730">,</span>&nbsp;<span class="num" id="3697732">0x1c</span><span class="op" id="3697736">}</span><span class="op" id="3697737">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3697740">crypto</span><span class="op" id="3697746">.</span><span class="ident" id="3697747">SHA256</span><span class="op" id="3697753">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3697758">{</span><span class="num" id="3697759">0x30</span><span class="op" id="3697763">,</span>&nbsp;<span class="num" id="3697765">0x31</span><span class="op" id="3697769">,</span>&nbsp;<span class="num" id="3697771">0x30</span><span class="op" id="3697775">,</span>&nbsp;<span class="num" id="3697777">0x0d</span><span class="op" id="3697781">,</span>&nbsp;<span class="num" id="3697783">0x06</span><span class="op" id="3697787">,</span>&nbsp;<span class="num" id="3697789">0x09</span><span class="op" id="3697793">,</span>&nbsp;<span class="num" id="3697795">0x60</span><span class="op" id="3697799">,</span>&nbsp;<span class="num" id="3697801">0x86</span><span class="op" id="3697805">,</span>&nbsp;<span class="num" id="3697807">0x48</span><span class="op" id="3697811">,</span>&nbsp;<span class="num" id="3697813">0x01</span><span class="op" id="3697817">,</span>&nbsp;<span class="num" id="3697819">0x65</span><span class="op" id="3697823">,</span>&nbsp;<span class="num" id="3697825">0x03</span><span class="op" id="3697829">,</span>&nbsp;<span class="num" id="3697831">0x04</span><span class="op" id="3697835">,</span>&nbsp;<span class="num" id="3697837">0x02</span><span class="op" id="3697841">,</span>&nbsp;<span class="num" id="3697843">0x01</span><span class="op" id="3697847">,</span>&nbsp;<span class="num" id="3697849">0x05</span><span class="op" id="3697853">,</span>&nbsp;<span class="num" id="3697855">0x00</span><span class="op" id="3697859">,</span>&nbsp;<span class="num" id="3697861">0x04</span><span class="op" id="3697865">,</span>&nbsp;<span class="num" id="3697867">0x20</span><span class="op" id="3697871">}</span><span class="op" id="3697872">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3697875">crypto</span><span class="op" id="3697881">.</span><span class="ident" id="3697882">SHA384</span><span class="op" id="3697888">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3697893">{</span><span class="num" id="3697894">0x30</span><span class="op" id="3697898">,</span>&nbsp;<span class="num" id="3697900">0x41</span><span class="op" id="3697904">,</span>&nbsp;<span class="num" id="3697906">0x30</span><span class="op" id="3697910">,</span>&nbsp;<span class="num" id="3697912">0x0d</span><span class="op" id="3697916">,</span>&nbsp;<span class="num" id="3697918">0x06</span><span class="op" id="3697922">,</span>&nbsp;<span class="num" id="3697924">0x09</span><span class="op" id="3697928">,</span>&nbsp;<span class="num" id="3697930">0x60</span><span class="op" id="3697934">,</span>&nbsp;<span class="num" id="3697936">0x86</span><span class="op" id="3697940">,</span>&nbsp;<span class="num" id="3697942">0x48</span><span class="op" id="3697946">,</span>&nbsp;<span class="num" id="3697948">0x01</span><span class="op" id="3697952">,</span>&nbsp;<span class="num" id="3697954">0x65</span><span class="op" id="3697958">,</span>&nbsp;<span class="num" id="3697960">0x03</span><span class="op" id="3697964">,</span>&nbsp;<span class="num" id="3697966">0x04</span><span class="op" id="3697970">,</span>&nbsp;<span class="num" id="3697972">0x02</span><span class="op" id="3697976">,</span>&nbsp;<span class="num" id="3697978">0x02</span><span class="op" id="3697982">,</span>&nbsp;<span class="num" id="3697984">0x05</span><span class="op" id="3697988">,</span>&nbsp;<span class="num" id="3697990">0x00</span><span class="op" id="3697994">,</span>&nbsp;<span class="num" id="3697996">0x04</span><span class="op" id="3698000">,</span>&nbsp;<span class="num" id="3698002">0x30</span><span class="op" id="3698006">}</span><span class="op" id="3698007">,</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3698010">crypto</span><span class="op" id="3698016">.</span><span class="ident" id="3698017">SHA512</span><span class="op" id="3698023">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3698028">{</span><span class="num" id="3698029">0x30</span><span class="op" id="3698033">,</span>&nbsp;<span class="num" id="3698035">0x51</span><span class="op" id="3698039">,</span>&nbsp;<span class="num" id="3698041">0x30</span><span class="op" id="3698045">,</span>&nbsp;<span class="num" id="3698047">0x0d</span><span class="op" id="3698051">,</span>&nbsp;<span class="num" id="3698053">0x06</span><span class="op" id="3698057">,</span>&nbsp;<span class="num" id="3698059">0x09</span><span class="op" id="3698063">,</span>&nbsp;<span class="num" id="3698065">0x60</span><span class="op" id="3698069">,</span>&nbsp;<span class="num" id="3698071">0x86</span><span class="op" id="3698075">,</span>&nbsp;<span class="num" id="3698077">0x48</span><span class="op" id="3698081">,</span>&nbsp;<span class="num" id="3698083">0x01</span><span class="op" id="3698087">,</span>&nbsp;<span class="num" id="3698089">0x65</span><span class="op" id="3698093">,</span>&nbsp;<span class="num" id="3698095">0x03</span><span class="op" id="3698099">,</span>&nbsp;<span class="num" id="3698101">0x04</span><span class="op" id="3698105">,</span>&nbsp;<span class="num" id="3698107">0x02</span><span class="op" id="3698111">,</span>&nbsp;<span class="num" id="3698113">0x03</span><span class="op" id="3698117">,</span>&nbsp;<span class="num" id="3698119">0x05</span><span class="op" id="3698123">,</span>&nbsp;<span class="num" id="3698125">0x00</span><span class="op" id="3698129">,</span>&nbsp;<span class="num" id="3698131">0x04</span><span class="op" id="3698135">,</span>&nbsp;<span class="num" id="3698137">0x40</span><span class="op" id="3698141">}</span><span class="op" id="3698142">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3698145">crypto</span><span class="op" id="3698151">.</span><span class="ident" id="3698152">MD5SHA1</span><span class="op" id="3698159">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3698163">{</span><span class="op" id="3698164">}</span><span class="op" id="3698165">,</span>&nbsp;<span class="comment" id="3698167">//&nbsp;A&nbsp;special&nbsp;TLS&nbsp;case&nbsp;which&nbsp;doesn&#39;t&nbsp;use&nbsp;an&nbsp;ASN1&nbsp;prefix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3698224">crypto</span><span class="op" id="3698230">.</span><span class="ident" id="3698231">RIPEMD160</span><span class="op" id="3698240">:</span>&nbsp;<span class="op" id="3698242">{</span><span class="num" id="3698243">0x30</span><span class="op" id="3698247">,</span>&nbsp;<span class="num" id="3698249">0x20</span><span class="op" id="3698253">,</span>&nbsp;<span class="num" id="3698255">0x30</span><span class="op" id="3698259">,</span>&nbsp;<span class="num" id="3698261">0x08</span><span class="op" id="3698265">,</span>&nbsp;<span class="num" id="3698267">0x06</span><span class="op" id="3698271">,</span>&nbsp;<span class="num" id="3698273">0x06</span><span class="op" id="3698277">,</span>&nbsp;<span class="num" id="3698279">0x28</span><span class="op" id="3698283">,</span>&nbsp;<span class="num" id="3698285">0xcf</span><span class="op" id="3698289">,</span>&nbsp;<span class="num" id="3698291">0x06</span><span class="op" id="3698295">,</span>&nbsp;<span class="num" id="3698297">0x03</span><span class="op" id="3698301">,</span>&nbsp;<span class="num" id="3698303">0x00</span><span class="op" id="3698307">,</span>&nbsp;<span class="num" id="3698309">0x31</span><span class="op" id="3698313">,</span>&nbsp;<span class="num" id="3698315">0x04</span><span class="op" id="3698319">,</span>&nbsp;<span class="num" id="3698321">0x14</span><span class="op" id="3698325">}</span><span class="op" id="3698326">,</span><br>
<span class="lineno"></span><span class="op" id="3698328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span><span class="comment" id="3698331">//&nbsp;SignPKCS1v15&nbsp;calculates&nbsp;the&nbsp;signature&nbsp;of&nbsp;hashed&nbsp;using&nbsp;RSASSA-PKCS1-V1_5-SIGN&nbsp;from&nbsp;RSA&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="3698433">//&nbsp;Note&nbsp;that&nbsp;hashed&nbsp;must&nbsp;be&nbsp;the&nbsp;result&nbsp;of&nbsp;hashing&nbsp;the&nbsp;input&nbsp;message&nbsp;using&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3698511">//&nbsp;given&nbsp;hash&nbsp;function.&nbsp;If&nbsp;hash&nbsp;is&nbsp;zero,&nbsp;hashed&nbsp;is&nbsp;signed&nbsp;directly.&nbsp;This&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="3698590">//&nbsp;advisable&nbsp;except&nbsp;for&nbsp;interoperability.</span><br>
<span class="lineno"></span><span class="keyword" id="3698632">func</span>&nbsp;<span class="ident" id="3698637">SignPKCS1v15</span><span class="op" id="3698649">(</span><span class="ident" id="3698650">rand</span>&nbsp;<span class="ident" id="3698655">io</span><span class="op" id="3698657">.</span><span class="ident" id="3698658">Reader</span><span class="op" id="3698664">,</span>&nbsp;<span class="ident" id="3698666">priv</span>&nbsp;<span class="op" id="3698671">*</span><span class="ident" id="3698672">PrivateKey</span><span class="op" id="3698682">,</span>&nbsp;<span class="ident" id="3698684">hash</span>&nbsp;<span class="ident" id="3698689">crypto</span><span class="op" id="3698695">.</span><span class="ident" id="3698696">Hash</span><span class="op" id="3698700">,</span>&nbsp;<span class="ident" id="3698702">hashed</span>&nbsp;<span class="op" id="3698709">[</span><span class="op" id="3698710">]</span><span class="builtintype" id="3698711">byte</span><span class="op" id="3698715">)</span>&nbsp;<span class="op" id="3698717">(</span><span class="ident" id="3698718">s</span>&nbsp;<span class="op" id="3698720">[</span><span class="op" id="3698721">]</span><span class="builtintype" id="3698722">byte</span><span class="op" id="3698726">,</span>&nbsp;<span class="ident" id="3698728">err</span>&nbsp;<span class="builtintype" id="3698732">error</span><span class="op" id="3698737">)</span>&nbsp;<span class="op" id="3698739">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3698742">hashLen</span><span class="op" id="3698749">,</span>&nbsp;<span class="ident" id="3698751">prefix</span><span class="op" id="3698757">,</span>&nbsp;<span class="ident" id="3698759">err</span>&nbsp;<span class="op" id="3698763">:=</span>&nbsp;<span class="ident" id="3698766">pkcs1v15HashInfo</span><span class="op" id="3698782">(</span><span class="ident" id="3698783">hash</span><span class="op" id="3698787">,</span>&nbsp;<span class="builtinfunc" id="3698789">len</span><span class="op" id="3698792">(</span><span class="ident" id="3698793">hashed</span><span class="op" id="3698799">)</span><span class="op" id="3698800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3698803">if</span>&nbsp;<span class="ident" id="3698806">err</span>&nbsp;<span class="op" id="3698810">!=</span>&nbsp;<span class="ident" id="3698813">nil</span>&nbsp;<span class="op" id="3698817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3698821">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3698829">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3698833">tLen</span>&nbsp;<span class="op" id="3698838">:=</span>&nbsp;<span class="builtinfunc" id="3698841">len</span><span class="op" id="3698844">(</span><span class="ident" id="3698845">prefix</span><span class="op" id="3698851">)</span>&nbsp;<span class="op" id="3698853">+</span>&nbsp;<span class="ident" id="3698855">hashLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3698864">k</span>&nbsp;<span class="op" id="3698866">:=</span>&nbsp;<span class="op" id="3698869">(</span><span class="ident" id="3698870">priv</span><span class="op" id="3698874">.</span><span class="ident" id="3698875">N</span><span class="op" id="3698876">.</span><span class="ident" id="3698877">BitLen</span><span class="op" id="3698883">(</span><span class="op" id="3698884">)</span>&nbsp;<span class="op" id="3698886">+</span>&nbsp;<span class="num" id="3698888">7</span><span class="op" id="3698889">)</span>&nbsp;<span class="op" id="3698891">/</span>&nbsp;<span class="num" id="3698893">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3698896">if</span>&nbsp;<span class="ident" id="3698899">k</span>&nbsp;<span class="op" id="3698901">&lt;</span>&nbsp;<span class="ident" id="3698903">tLen</span><span class="op" id="3698907">+</span><span class="num" id="3698908">11</span>&nbsp;<span class="op" id="3698911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3698915">return</span>&nbsp;<span class="ident" id="3698922">nil</span><span class="op" id="3698925">,</span>&nbsp;<span class="ident" id="3698927">ErrMessageTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3698946">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3698950">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x01&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;T</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3698991">em</span>&nbsp;<span class="op" id="3698994">:=</span>&nbsp;<span class="builtinfunc" id="3698997">make</span><span class="op" id="3699001">(</span><span class="op" id="3699002">[</span><span class="op" id="3699003">]</span><span class="builtintype" id="3699004">byte</span><span class="op" id="3699008">,</span>&nbsp;<span class="ident" id="3699010">k</span><span class="op" id="3699011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3699014">em</span><span class="op" id="3699016">[</span><span class="num" id="3699017">1</span><span class="op" id="3699018">]</span>&nbsp;<span class="op" id="3699020">=</span>&nbsp;<span class="num" id="3699022">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3699025">for</span>&nbsp;<span class="ident" id="3699029">i</span>&nbsp;<span class="op" id="3699031">:=</span>&nbsp;<span class="num" id="3699034">2</span><span class="op" id="3699035">;</span>&nbsp;<span class="ident" id="3699037">i</span>&nbsp;<span class="op" id="3699039">&lt;</span>&nbsp;<span class="ident" id="3699041">k</span><span class="op" id="3699042">-</span><span class="ident" id="3699043">tLen</span><span class="op" id="3699047">-</span><span class="num" id="3699048">1</span><span class="op" id="3699049">;</span>&nbsp;<span class="ident" id="3699051">i</span><span class="op" id="3699052">++</span>&nbsp;<span class="op" id="3699055">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3699059">em</span><span class="op" id="3699061">[</span><span class="ident" id="3699062">i</span><span class="op" id="3699063">]</span>&nbsp;<span class="op" id="3699065">=</span>&nbsp;<span class="num" id="3699067">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3699073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3699076">copy</span><span class="op" id="3699080">(</span><span class="ident" id="3699081">em</span><span class="op" id="3699083">[</span><span class="ident" id="3699084">k</span><span class="op" id="3699085">-</span><span class="ident" id="3699086">tLen</span><span class="op" id="3699090">:</span><span class="ident" id="3699091">k</span><span class="op" id="3699092">-</span><span class="ident" id="3699093">hashLen</span><span class="op" id="3699100">]</span><span class="op" id="3699101">,</span>&nbsp;<span class="ident" id="3699103">prefix</span><span class="op" id="3699109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3699112">copy</span><span class="op" id="3699116">(</span><span class="ident" id="3699117">em</span><span class="op" id="3699119">[</span><span class="ident" id="3699120">k</span><span class="op" id="3699121">-</span><span class="ident" id="3699122">hashLen</span><span class="op" id="3699129">:</span><span class="ident" id="3699130">k</span><span class="op" id="3699131">]</span><span class="op" id="3699132">,</span>&nbsp;<span class="ident" id="3699134">hashed</span><span class="op" id="3699140">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3699144">m</span>&nbsp;<span class="op" id="3699146">:=</span>&nbsp;<span class="builtinfunc" id="3699149">new</span><span class="op" id="3699152">(</span><span class="ident" id="3699153">big</span><span class="op" id="3699156">.</span><span class="ident" id="3699157">Int</span><span class="op" id="3699160">)</span><span class="op" id="3699161">.</span><span class="ident" id="3699162">SetBytes</span><span class="op" id="3699170">(</span><span class="ident" id="3699171">em</span><span class="op" id="3699173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3699176">c</span><span class="op" id="3699177">,</span>&nbsp;<span class="ident" id="3699179">err</span>&nbsp;<span class="op" id="3699183">:=</span>&nbsp;<span class="ident" id="3699186">decrypt</span><span class="op" id="3699193">(</span><span class="ident" id="3699194">rand</span><span class="op" id="3699198">,</span>&nbsp;<span class="ident" id="3699200">priv</span><span class="op" id="3699204">,</span>&nbsp;<span class="ident" id="3699206">m</span><span class="op" id="3699207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3699210">if</span>&nbsp;<span class="ident" id="3699213">err</span>&nbsp;<span class="op" id="3699217">!=</span>&nbsp;<span class="ident" id="3699220">nil</span>&nbsp;<span class="op" id="3699224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3699228">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3699236">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3699240">copyWithLeftPad</span><span class="op" id="3699255">(</span><span class="ident" id="3699256">em</span><span class="op" id="3699258">,</span>&nbsp;<span class="ident" id="3699260">c</span><span class="op" id="3699261">.</span><span class="ident" id="3699262">Bytes</span><span class="op" id="3699267">(</span><span class="op" id="3699268">)</span><span class="op" id="3699269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3699272">s</span>&nbsp;<span class="op" id="3699274">=</span>&nbsp;<span class="ident" id="3699276">em</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3699280">return</span><br>
<span class="lineno"></span><span class="op" id="3699287">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="comment" id="3699290">//&nbsp;VerifyPKCS1v15&nbsp;verifies&nbsp;an&nbsp;RSA&nbsp;PKCS#1&nbsp;v1.5&nbsp;signature.</span><br>
<span class="lineno"></span><span class="comment" id="3699347">//&nbsp;hashed&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;hashing&nbsp;the&nbsp;input&nbsp;message&nbsp;using&nbsp;the&nbsp;given&nbsp;hash</span><br>
<span class="lineno"></span><span class="comment" id="3699421">//&nbsp;function&nbsp;and&nbsp;sig&nbsp;is&nbsp;the&nbsp;signature.&nbsp;A&nbsp;valid&nbsp;signature&nbsp;is&nbsp;indicated&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="3699493">//&nbsp;returning&nbsp;a&nbsp;nil&nbsp;error.&nbsp;If&nbsp;hash&nbsp;is&nbsp;zero&nbsp;then&nbsp;hashed&nbsp;is&nbsp;used&nbsp;directly.&nbsp;This</span><br>
<span class="lineno">230</span><span class="comment" id="3699570">//&nbsp;isn&#39;t&nbsp;advisable&nbsp;except&nbsp;for&nbsp;interoperability.</span><br>
<span class="lineno"></span><span class="keyword" id="3699618">func</span>&nbsp;<span class="ident" id="3699623">VerifyPKCS1v15</span><span class="op" id="3699637">(</span><span class="ident" id="3699638">pub</span>&nbsp;<span class="op" id="3699642">*</span><span class="ident" id="3699643">PublicKey</span><span class="op" id="3699652">,</span>&nbsp;<span class="ident" id="3699654">hash</span>&nbsp;<span class="ident" id="3699659">crypto</span><span class="op" id="3699665">.</span><span class="ident" id="3699666">Hash</span><span class="op" id="3699670">,</span>&nbsp;<span class="ident" id="3699672">hashed</span>&nbsp;<span class="op" id="3699679">[</span><span class="op" id="3699680">]</span><span class="builtintype" id="3699681">byte</span><span class="op" id="3699685">,</span>&nbsp;<span class="ident" id="3699687">sig</span>&nbsp;<span class="op" id="3699691">[</span><span class="op" id="3699692">]</span><span class="builtintype" id="3699693">byte</span><span class="op" id="3699697">)</span>&nbsp;<span class="op" id="3699699">(</span><span class="ident" id="3699700">err</span>&nbsp;<span class="builtintype" id="3699704">error</span><span class="op" id="3699709">)</span>&nbsp;<span class="op" id="3699711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3699714">hashLen</span><span class="op" id="3699721">,</span>&nbsp;<span class="ident" id="3699723">prefix</span><span class="op" id="3699729">,</span>&nbsp;<span class="ident" id="3699731">err</span>&nbsp;<span class="op" id="3699735">:=</span>&nbsp;<span class="ident" id="3699738">pkcs1v15HashInfo</span><span class="op" id="3699754">(</span><span class="ident" id="3699755">hash</span><span class="op" id="3699759">,</span>&nbsp;<span class="builtinfunc" id="3699761">len</span><span class="op" id="3699764">(</span><span class="ident" id="3699765">hashed</span><span class="op" id="3699771">)</span><span class="op" id="3699772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3699775">if</span>&nbsp;<span class="ident" id="3699778">err</span>&nbsp;<span class="op" id="3699782">!=</span>&nbsp;<span class="ident" id="3699785">nil</span>&nbsp;<span class="op" id="3699789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3699793">return</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3699801">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3699805">tLen</span>&nbsp;<span class="op" id="3699810">:=</span>&nbsp;<span class="builtinfunc" id="3699813">len</span><span class="op" id="3699816">(</span><span class="ident" id="3699817">prefix</span><span class="op" id="3699823">)</span>&nbsp;<span class="op" id="3699825">+</span>&nbsp;<span class="ident" id="3699827">hashLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3699836">k</span>&nbsp;<span class="op" id="3699838">:=</span>&nbsp;<span class="op" id="3699841">(</span><span class="ident" id="3699842">pub</span><span class="op" id="3699845">.</span><span class="ident" id="3699846">N</span><span class="op" id="3699847">.</span><span class="ident" id="3699848">BitLen</span><span class="op" id="3699854">(</span><span class="op" id="3699855">)</span>&nbsp;<span class="op" id="3699857">+</span>&nbsp;<span class="num" id="3699859">7</span><span class="op" id="3699860">)</span>&nbsp;<span class="op" id="3699862">/</span>&nbsp;<span class="num" id="3699864">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3699867">if</span>&nbsp;<span class="ident" id="3699870">k</span>&nbsp;<span class="op" id="3699872">&lt;</span>&nbsp;<span class="ident" id="3699874">tLen</span><span class="op" id="3699878">+</span><span class="num" id="3699879">11</span>&nbsp;<span class="op" id="3699882">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3699886">err</span>&nbsp;<span class="op" id="3699890">=</span>&nbsp;<span class="ident" id="3699892">ErrVerification</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3699910">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3699918">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3699922">c</span>&nbsp;<span class="op" id="3699924">:=</span>&nbsp;<span class="builtinfunc" id="3699927">new</span><span class="op" id="3699930">(</span><span class="ident" id="3699931">big</span><span class="op" id="3699934">.</span><span class="ident" id="3699935">Int</span><span class="op" id="3699938">)</span><span class="op" id="3699939">.</span><span class="ident" id="3699940">SetBytes</span><span class="op" id="3699948">(</span><span class="ident" id="3699949">sig</span><span class="op" id="3699952">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3699955">m</span>&nbsp;<span class="op" id="3699957">:=</span>&nbsp;<span class="ident" id="3699960">encrypt</span><span class="op" id="3699967">(</span><span class="builtinfunc" id="3699968">new</span><span class="op" id="3699971">(</span><span class="ident" id="3699972">big</span><span class="op" id="3699975">.</span><span class="ident" id="3699976">Int</span><span class="op" id="3699979">)</span><span class="op" id="3699980">,</span>&nbsp;<span class="ident" id="3699982">pub</span><span class="op" id="3699985">,</span>&nbsp;<span class="ident" id="3699987">c</span><span class="op" id="3699988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3699991">em</span>&nbsp;<span class="op" id="3699994">:=</span>&nbsp;<span class="ident" id="3699997">leftPad</span><span class="op" id="3700004">(</span><span class="ident" id="3700005">m</span><span class="op" id="3700006">.</span><span class="ident" id="3700007">Bytes</span><span class="op" id="3700012">(</span><span class="op" id="3700013">)</span><span class="op" id="3700014">,</span>&nbsp;<span class="ident" id="3700016">k</span><span class="op" id="3700017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3700020">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x01&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;T</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3700062">ok</span>&nbsp;<span class="op" id="3700065">:=</span>&nbsp;<span class="ident" id="3700068">subtle</span><span class="op" id="3700074">.</span><span class="ident" id="3700075">ConstantTimeByteEq</span><span class="op" id="3700093">(</span><span class="ident" id="3700094">em</span><span class="op" id="3700096">[</span><span class="num" id="3700097">0</span><span class="op" id="3700098">]</span><span class="op" id="3700099">,</span>&nbsp;<span class="num" id="3700101">0</span><span class="op" id="3700102">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3700105">ok</span>&nbsp;<span class="op" id="3700108">&amp;=</span>&nbsp;<span class="ident" id="3700111">subtle</span><span class="op" id="3700117">.</span><span class="ident" id="3700118">ConstantTimeByteEq</span><span class="op" id="3700136">(</span><span class="ident" id="3700137">em</span><span class="op" id="3700139">[</span><span class="num" id="3700140">1</span><span class="op" id="3700141">]</span><span class="op" id="3700142">,</span>&nbsp;<span class="num" id="3700144">1</span><span class="op" id="3700145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3700148">ok</span>&nbsp;<span class="op" id="3700151">&amp;=</span>&nbsp;<span class="ident" id="3700154">subtle</span><span class="op" id="3700160">.</span><span class="ident" id="3700161">ConstantTimeCompare</span><span class="op" id="3700180">(</span><span class="ident" id="3700181">em</span><span class="op" id="3700183">[</span><span class="ident" id="3700184">k</span><span class="op" id="3700185">-</span><span class="ident" id="3700186">hashLen</span><span class="op" id="3700193">:</span><span class="ident" id="3700194">k</span><span class="op" id="3700195">]</span><span class="op" id="3700196">,</span>&nbsp;<span class="ident" id="3700198">hashed</span><span class="op" id="3700204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3700207">ok</span>&nbsp;<span class="op" id="3700210">&amp;=</span>&nbsp;<span class="ident" id="3700213">subtle</span><span class="op" id="3700219">.</span><span class="ident" id="3700220">ConstantTimeCompare</span><span class="op" id="3700239">(</span><span class="ident" id="3700240">em</span><span class="op" id="3700242">[</span><span class="ident" id="3700243">k</span><span class="op" id="3700244">-</span><span class="ident" id="3700245">tLen</span><span class="op" id="3700249">:</span><span class="ident" id="3700250">k</span><span class="op" id="3700251">-</span><span class="ident" id="3700252">hashLen</span><span class="op" id="3700259">]</span><span class="op" id="3700260">,</span>&nbsp;<span class="ident" id="3700262">prefix</span><span class="op" id="3700268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3700271">ok</span>&nbsp;<span class="op" id="3700274">&amp;=</span>&nbsp;<span class="ident" id="3700277">subtle</span><span class="op" id="3700283">.</span><span class="ident" id="3700284">ConstantTimeByteEq</span><span class="op" id="3700302">(</span><span class="ident" id="3700303">em</span><span class="op" id="3700305">[</span><span class="ident" id="3700306">k</span><span class="op" id="3700307">-</span><span class="ident" id="3700308">tLen</span><span class="op" id="3700312">-</span><span class="num" id="3700313">1</span><span class="op" id="3700314">]</span><span class="op" id="3700315">,</span>&nbsp;<span class="num" id="3700317">0</span><span class="op" id="3700318">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3700322">for</span>&nbsp;<span class="ident" id="3700326">i</span>&nbsp;<span class="op" id="3700328">:=</span>&nbsp;<span class="num" id="3700331">2</span><span class="op" id="3700332">;</span>&nbsp;<span class="ident" id="3700334">i</span>&nbsp;<span class="op" id="3700336">&lt;</span>&nbsp;<span class="ident" id="3700338">k</span><span class="op" id="3700339">-</span><span class="ident" id="3700340">tLen</span><span class="op" id="3700344">-</span><span class="num" id="3700345">1</span><span class="op" id="3700346">;</span>&nbsp;<span class="ident" id="3700348">i</span><span class="op" id="3700349">++</span>&nbsp;<span class="op" id="3700352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3700356">ok</span>&nbsp;<span class="op" id="3700359">&amp;=</span>&nbsp;<span class="ident" id="3700362">subtle</span><span class="op" id="3700368">.</span><span class="ident" id="3700369">ConstantTimeByteEq</span><span class="op" id="3700387">(</span><span class="ident" id="3700388">em</span><span class="op" id="3700390">[</span><span class="ident" id="3700391">i</span><span class="op" id="3700392">]</span><span class="op" id="3700393">,</span>&nbsp;<span class="num" id="3700395">0xff</span><span class="op" id="3700399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3700402">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3700406">if</span>&nbsp;<span class="ident" id="3700409">ok</span>&nbsp;<span class="op" id="3700412">!=</span>&nbsp;<span class="num" id="3700415">1</span>&nbsp;<span class="op" id="3700417">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3700421">return</span>&nbsp;<span class="ident" id="3700428">ErrVerification</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3700445">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3700449">return</span>&nbsp;<span class="ident" id="3700456">nil</span><br>
<span class="lineno"></span><span class="op" id="3700460">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="3700463">func</span>&nbsp;<span class="ident" id="3700468">pkcs1v15HashInfo</span><span class="op" id="3700484">(</span><span class="ident" id="3700485">hash</span>&nbsp;<span class="ident" id="3700490">crypto</span><span class="op" id="3700496">.</span><span class="ident" id="3700497">Hash</span><span class="op" id="3700501">,</span>&nbsp;<span class="ident" id="3700503">inLen</span>&nbsp;<span class="builtintype" id="3700509">int</span><span class="op" id="3700512">)</span>&nbsp;<span class="op" id="3700514">(</span><span class="ident" id="3700515">hashLen</span>&nbsp;<span class="builtintype" id="3700523">int</span><span class="op" id="3700526">,</span>&nbsp;<span class="ident" id="3700528">prefix</span>&nbsp;<span class="op" id="3700535">[</span><span class="op" id="3700536">]</span><span class="builtintype" id="3700537">byte</span><span class="op" id="3700541">,</span>&nbsp;<span class="ident" id="3700543">err</span>&nbsp;<span class="builtintype" id="3700547">error</span><span class="op" id="3700552">)</span>&nbsp;<span class="op" id="3700554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3700557">//&nbsp;Special&nbsp;case:&nbsp;crypto.Hash(0)&nbsp;is&nbsp;used&nbsp;to&nbsp;indicate&nbsp;that&nbsp;the&nbsp;data&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3700627">//&nbsp;signed&nbsp;directly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3700648">if</span>&nbsp;<span class="ident" id="3700651">hash</span>&nbsp;<span class="op" id="3700656">==</span>&nbsp;<span class="num" id="3700659">0</span>&nbsp;<span class="op" id="3700661">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3700665">return</span>&nbsp;<span class="ident" id="3700672">inLen</span><span class="op" id="3700677">,</span>&nbsp;<span class="ident" id="3700679">nil</span><span class="op" id="3700682">,</span>&nbsp;<span class="ident" id="3700684">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3700689">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3700693">hashLen</span>&nbsp;<span class="op" id="3700701">=</span>&nbsp;<span class="ident" id="3700703">hash</span><span class="op" id="3700707">.</span><span class="ident" id="3700708">Size</span><span class="op" id="3700712">(</span><span class="op" id="3700713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3700716">if</span>&nbsp;<span class="ident" id="3700719">inLen</span>&nbsp;<span class="op" id="3700725">!=</span>&nbsp;<span class="ident" id="3700728">hashLen</span>&nbsp;<span class="op" id="3700736">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3700740">return</span>&nbsp;<span class="num" id="3700747">0</span><span class="op" id="3700748">,</span>&nbsp;<span class="ident" id="3700750">nil</span><span class="op" id="3700753">,</span>&nbsp;<span class="ident" id="3700755">errors</span><span class="op" id="3700761">.</span><span class="ident" id="3700762">New</span><span class="op" id="3700765">(</span><span class="string" id="3700766">&#34;crypto/rsa:&nbsp;input&nbsp;must&nbsp;be&nbsp;hashed&nbsp;message&#34;</span><span class="op" id="3700808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3700811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3700814">prefix</span><span class="op" id="3700820">,</span>&nbsp;<span class="ident" id="3700822">ok</span>&nbsp;<span class="op" id="3700825">:=</span>&nbsp;<span class="ident" id="3700828">hashPrefixes</span><span class="op" id="3700840">[</span><span class="ident" id="3700841">hash</span><span class="op" id="3700845">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3700848">if</span>&nbsp;<span class="op" id="3700851">!</span><span class="ident" id="3700852">ok</span>&nbsp;<span class="op" id="3700855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3700859">return</span>&nbsp;<span class="num" id="3700866">0</span><span class="op" id="3700867">,</span>&nbsp;<span class="ident" id="3700869">nil</span><span class="op" id="3700872">,</span>&nbsp;<span class="ident" id="3700874">errors</span><span class="op" id="3700880">.</span><span class="ident" id="3700881">New</span><span class="op" id="3700884">(</span><span class="string" id="3700885">&#34;crypto/rsa:&nbsp;unsupported&nbsp;hash&nbsp;function&#34;</span><span class="op" id="3700924">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3700927">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3700930">return</span><br>
<span class="lineno"></span><span class="op" id="3700937">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3700940">//&nbsp;copyWithLeftPad&nbsp;copies&nbsp;src&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;dest,&nbsp;padding&nbsp;with&nbsp;zero&nbsp;bytes&nbsp;as</span><br>
<span class="lineno">285</span><span class="comment" id="3701017">//&nbsp;needed.</span><br>
<span class="lineno"></span><span class="keyword" id="3701028">func</span>&nbsp;<span class="ident" id="3701033">copyWithLeftPad</span><span class="op" id="3701048">(</span><span class="ident" id="3701049">dest</span><span class="op" id="3701053">,</span>&nbsp;<span class="ident" id="3701055">src</span>&nbsp;<span class="op" id="3701059">[</span><span class="op" id="3701060">]</span><span class="builtintype" id="3701061">byte</span><span class="op" id="3701065">)</span>&nbsp;<span class="op" id="3701067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3701070">numPaddingBytes</span>&nbsp;<span class="op" id="3701086">:=</span>&nbsp;<span class="builtinfunc" id="3701089">len</span><span class="op" id="3701092">(</span><span class="ident" id="3701093">dest</span><span class="op" id="3701097">)</span>&nbsp;<span class="op" id="3701099">-</span>&nbsp;<span class="builtinfunc" id="3701101">len</span><span class="op" id="3701104">(</span><span class="ident" id="3701105">src</span><span class="op" id="3701108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3701111">for</span>&nbsp;<span class="ident" id="3701115">i</span>&nbsp;<span class="op" id="3701117">:=</span>&nbsp;<span class="num" id="3701120">0</span><span class="op" id="3701121">;</span>&nbsp;<span class="ident" id="3701123">i</span>&nbsp;<span class="op" id="3701125">&lt;</span>&nbsp;<span class="ident" id="3701127">numPaddingBytes</span><span class="op" id="3701142">;</span>&nbsp;<span class="ident" id="3701144">i</span><span class="op" id="3701145">++</span>&nbsp;<span class="op" id="3701148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3701152">dest</span><span class="op" id="3701156">[</span><span class="ident" id="3701157">i</span><span class="op" id="3701158">]</span>&nbsp;<span class="op" id="3701160">=</span>&nbsp;<span class="num" id="3701162">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3701165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3701168">copy</span><span class="op" id="3701172">(</span><span class="ident" id="3701173">dest</span><span class="op" id="3701177">[</span><span class="ident" id="3701178">numPaddingBytes</span><span class="op" id="3701193">:</span><span class="op" id="3701194">]</span><span class="op" id="3701195">,</span>&nbsp;<span class="ident" id="3701197">src</span><span class="op" id="3701200">)</span><br>
<span class="lineno"></span><span class="op" id="3701202">}</span>
</div>
</body>
</html>
