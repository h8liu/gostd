<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html" class="current">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1393979">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1394034">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1394088">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1394139">package</span>&nbsp;<span class="ident" id="1394147">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1394153">import</span>&nbsp;<span class="op" id="1394160">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1394163">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1394174">&#34;sync/atomic&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1394189">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1394198">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1394201">//&nbsp;A&nbsp;Pool&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;temporary&nbsp;objects&nbsp;that&nbsp;may&nbsp;be&nbsp;individually&nbsp;saved&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1394276">//&nbsp;retrieved.</span><br>
<span class="lineno">15</span><span class="comment" id="1394290">//</span><br>
<span class="lineno"></span><span class="comment" id="1394293">//&nbsp;Any&nbsp;item&nbsp;stored&nbsp;in&nbsp;the&nbsp;Pool&nbsp;may&nbsp;be&nbsp;removed&nbsp;automatically&nbsp;at&nbsp;any&nbsp;time&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="1394373">//&nbsp;notification.&nbsp;If&nbsp;the&nbsp;Pool&nbsp;holds&nbsp;the&nbsp;only&nbsp;reference&nbsp;when&nbsp;this&nbsp;happens,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1394450">//&nbsp;item&nbsp;might&nbsp;be&nbsp;deallocated.</span><br>
<span class="lineno"></span><span class="comment" id="1394480">//</span><br>
<span class="lineno">20</span><span class="comment" id="1394483">//&nbsp;A&nbsp;Pool&nbsp;is&nbsp;safe&nbsp;for&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines&nbsp;simultaneously.</span><br>
<span class="lineno"></span><span class="comment" id="1394548">//</span><br>
<span class="lineno"></span><span class="comment" id="1394551">//&nbsp;Pool&#39;s&nbsp;purpose&nbsp;is&nbsp;to&nbsp;cache&nbsp;allocated&nbsp;but&nbsp;unused&nbsp;items&nbsp;for&nbsp;later&nbsp;reuse,</span><br>
<span class="lineno"></span><span class="comment" id="1394625">//&nbsp;relieving&nbsp;pressure&nbsp;on&nbsp;the&nbsp;garbage&nbsp;collector.&nbsp;That&nbsp;is,&nbsp;it&nbsp;makes&nbsp;it&nbsp;easy&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1394702">//&nbsp;build&nbsp;efficient,&nbsp;thread-safe&nbsp;free&nbsp;lists.&nbsp;However,&nbsp;it&nbsp;is&nbsp;not&nbsp;suitable&nbsp;for&nbsp;all</span><br>
<span class="lineno">25</span><span class="comment" id="1394782">//&nbsp;free&nbsp;lists.</span><br>
<span class="lineno"></span><span class="comment" id="1394797">//</span><br>
<span class="lineno"></span><span class="comment" id="1394800">//&nbsp;An&nbsp;appropriate&nbsp;use&nbsp;of&nbsp;a&nbsp;Pool&nbsp;is&nbsp;to&nbsp;manage&nbsp;a&nbsp;group&nbsp;of&nbsp;temporary&nbsp;items</span><br>
<span class="lineno"></span><span class="comment" id="1394872">//&nbsp;silently&nbsp;shared&nbsp;among&nbsp;and&nbsp;potentially&nbsp;reused&nbsp;by&nbsp;concurrent&nbsp;independent</span><br>
<span class="lineno"></span><span class="comment" id="1394946">//&nbsp;clients&nbsp;of&nbsp;a&nbsp;package.&nbsp;Pool&nbsp;provides&nbsp;a&nbsp;way&nbsp;to&nbsp;amortize&nbsp;allocation&nbsp;overhead</span><br>
<span class="lineno">30</span><span class="comment" id="1395023">//&nbsp;across&nbsp;many&nbsp;clients.</span><br>
<span class="lineno"></span><span class="comment" id="1395047">//</span><br>
<span class="lineno"></span><span class="comment" id="1395050">//&nbsp;An&nbsp;example&nbsp;of&nbsp;good&nbsp;use&nbsp;of&nbsp;a&nbsp;Pool&nbsp;is&nbsp;in&nbsp;the&nbsp;fmt&nbsp;package,&nbsp;which&nbsp;maintains&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1395127">//&nbsp;dynamically-sized&nbsp;store&nbsp;of&nbsp;temporary&nbsp;output&nbsp;buffers.&nbsp;The&nbsp;store&nbsp;scales&nbsp;under</span><br>
<span class="lineno"></span><span class="comment" id="1395206">//&nbsp;load&nbsp;(when&nbsp;many&nbsp;goroutines&nbsp;are&nbsp;actively&nbsp;printing)&nbsp;and&nbsp;shrinks&nbsp;when</span><br>
<span class="lineno">35</span><span class="comment" id="1395276">//&nbsp;quiescent.</span><br>
<span class="lineno"></span><span class="comment" id="1395290">//</span><br>
<span class="lineno"></span><span class="comment" id="1395293">//&nbsp;On&nbsp;the&nbsp;other&nbsp;hand,&nbsp;a&nbsp;free&nbsp;list&nbsp;maintained&nbsp;as&nbsp;part&nbsp;of&nbsp;a&nbsp;short-lived&nbsp;object&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1395373">//&nbsp;not&nbsp;a&nbsp;suitable&nbsp;use&nbsp;for&nbsp;a&nbsp;Pool,&nbsp;since&nbsp;the&nbsp;overhead&nbsp;does&nbsp;not&nbsp;amortize&nbsp;well&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1395452">//&nbsp;that&nbsp;scenario.&nbsp;It&nbsp;is&nbsp;more&nbsp;efficient&nbsp;to&nbsp;have&nbsp;such&nbsp;objects&nbsp;implement&nbsp;their&nbsp;own</span><br>
<span class="lineno">40</span><span class="comment" id="1395532">//&nbsp;free&nbsp;list.</span><br>
<span class="lineno"></span><span class="comment" id="1395546">//</span><br>
<span class="lineno"></span><span class="keyword" id="1395549">type</span>&nbsp;<span class="ident" id="1395554">Pool</span>&nbsp;<span class="keyword" id="1395559">struct</span>&nbsp;<span class="op" id="1395566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1395569">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1395579">unsafe</span><span class="op" id="1395585">.</span><span class="ident" id="1395586">Pointer</span>&nbsp;<span class="comment" id="1395594">//&nbsp;local&nbsp;fixed-size&nbsp;per-P&nbsp;pool,&nbsp;actual&nbsp;type&nbsp;is&nbsp;[P]poolLocal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1395655">localSize</span>&nbsp;<span class="builtintype" id="1395665">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1395680">//&nbsp;size&nbsp;of&nbsp;the&nbsp;local&nbsp;array</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1395709">//&nbsp;New&nbsp;optionally&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;generate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1395761">//&nbsp;a&nbsp;value&nbsp;when&nbsp;Get&nbsp;would&nbsp;otherwise&nbsp;return&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1395810">//&nbsp;It&nbsp;may&nbsp;not&nbsp;be&nbsp;changed&nbsp;concurrently&nbsp;with&nbsp;calls&nbsp;to&nbsp;Get.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1395868">New</span>&nbsp;<span class="keyword" id="1395872">func</span><span class="op" id="1395876">(</span><span class="op" id="1395877">)</span>&nbsp;<span class="keyword" id="1395879">interface</span><span class="op" id="1395888">{</span><span class="op" id="1395889">}</span><br>
<span class="lineno">50</span><span class="op" id="1395891">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1395894">//&nbsp;Local&nbsp;per-P&nbsp;Pool&nbsp;appendix.</span><br>
<span class="lineno"></span><span class="keyword" id="1395924">type</span>&nbsp;<span class="ident" id="1395929">poolLocal</span>&nbsp;<span class="keyword" id="1395939">struct</span>&nbsp;<span class="op" id="1395946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1395949">private</span>&nbsp;<span class="keyword" id="1395957">interface</span><span class="op" id="1395966">{</span><span class="op" id="1395967">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="1395971">//&nbsp;Can&nbsp;be&nbsp;used&nbsp;only&nbsp;by&nbsp;the&nbsp;respective&nbsp;P.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1396013">shared</span>&nbsp;&nbsp;<span class="op" id="1396021">[</span><span class="op" id="1396022">]</span><span class="keyword" id="1396023">interface</span><span class="op" id="1396032">{</span><span class="op" id="1396033">}</span>&nbsp;<span class="comment" id="1396035">//&nbsp;Can&nbsp;be&nbsp;used&nbsp;by&nbsp;any&nbsp;P.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1396061">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1396083">//&nbsp;Protects&nbsp;shared.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1396104">pad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1396112">[</span><span class="num" id="1396113">128</span><span class="op" id="1396116">]</span><span class="builtintype" id="1396117">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1396126">//&nbsp;Prevents&nbsp;false&nbsp;sharing.</span><br>
<span class="lineno"></span><span class="op" id="1396153">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="1396156">//&nbsp;Put&nbsp;adds&nbsp;x&nbsp;to&nbsp;the&nbsp;pool.</span><br>
<span class="lineno"></span><span class="keyword" id="1396183">func</span>&nbsp;<span class="op" id="1396188">(</span><span class="ident" id="1396189">p</span>&nbsp;<span class="op" id="1396191">*</span><span class="ident" id="1396192">Pool</span><span class="op" id="1396196">)</span>&nbsp;<span class="ident" id="1396198">Put</span><span class="op" id="1396201">(</span><span class="ident" id="1396202">x</span>&nbsp;<span class="keyword" id="1396204">interface</span><span class="op" id="1396213">{</span><span class="op" id="1396214">}</span><span class="op" id="1396215">)</span>&nbsp;<span class="op" id="1396217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1396220">if</span>&nbsp;<span class="ident" id="1396223">raceenabled</span>&nbsp;<span class="op" id="1396235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1396239">//&nbsp;Under&nbsp;race&nbsp;detector&nbsp;the&nbsp;Pool&nbsp;degenerates&nbsp;into&nbsp;no-op.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1396297">//&nbsp;It&#39;s&nbsp;conforming,&nbsp;simple&nbsp;and&nbsp;does&nbsp;not&nbsp;introduce&nbsp;excessive</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1396359">//&nbsp;happens-before&nbsp;edges&nbsp;between&nbsp;unrelated&nbsp;goroutines.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1396415">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1396423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1396426">if</span>&nbsp;<span class="ident" id="1396429">x</span>&nbsp;<span class="op" id="1396431">==</span>&nbsp;<span class="ident" id="1396434">nil</span>&nbsp;<span class="op" id="1396438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1396442">return</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1396450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1396453">l</span>&nbsp;<span class="op" id="1396455">:=</span>&nbsp;<span class="ident" id="1396458">p</span><span class="op" id="1396459">.</span><span class="ident" id="1396460">pin</span><span class="op" id="1396463">(</span><span class="op" id="1396464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1396467">if</span>&nbsp;<span class="ident" id="1396470">l</span><span class="op" id="1396471">.</span><span class="ident" id="1396472">private</span>&nbsp;<span class="op" id="1396480">==</span>&nbsp;<span class="ident" id="1396483">nil</span>&nbsp;<span class="op" id="1396487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1396491">l</span><span class="op" id="1396492">.</span><span class="ident" id="1396493">private</span>&nbsp;<span class="op" id="1396501">=</span>&nbsp;<span class="ident" id="1396503">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1396507">x</span>&nbsp;<span class="op" id="1396509">=</span>&nbsp;<span class="ident" id="1396511">nil</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1396516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1396519">runtime_procUnpin</span><span class="op" id="1396536">(</span><span class="op" id="1396537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1396540">if</span>&nbsp;<span class="ident" id="1396543">x</span>&nbsp;<span class="op" id="1396545">==</span>&nbsp;<span class="ident" id="1396548">nil</span>&nbsp;<span class="op" id="1396552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1396556">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1396564">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1396567">l</span><span class="op" id="1396568">.</span><span class="ident" id="1396569">Lock</span><span class="op" id="1396573">(</span><span class="op" id="1396574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1396577">l</span><span class="op" id="1396578">.</span><span class="ident" id="1396579">shared</span>&nbsp;<span class="op" id="1396586">=</span>&nbsp;<span class="builtinfunc" id="1396588">append</span><span class="op" id="1396594">(</span><span class="ident" id="1396595">l</span><span class="op" id="1396596">.</span><span class="ident" id="1396597">shared</span><span class="op" id="1396603">,</span>&nbsp;<span class="ident" id="1396605">x</span><span class="op" id="1396606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1396609">l</span><span class="op" id="1396610">.</span><span class="ident" id="1396611">Unlock</span><span class="op" id="1396617">(</span><span class="op" id="1396618">)</span><br>
<span class="lineno"></span><span class="op" id="1396620">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="comment" id="1396623">//&nbsp;Get&nbsp;selects&nbsp;an&nbsp;arbitrary&nbsp;item&nbsp;from&nbsp;the&nbsp;Pool,&nbsp;removes&nbsp;it&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1396691">//&nbsp;Pool,&nbsp;and&nbsp;returns&nbsp;it&nbsp;to&nbsp;the&nbsp;caller.</span><br>
<span class="lineno"></span><span class="comment" id="1396730">//&nbsp;Get&nbsp;may&nbsp;choose&nbsp;to&nbsp;ignore&nbsp;the&nbsp;pool&nbsp;and&nbsp;treat&nbsp;it&nbsp;as&nbsp;empty.</span><br>
<span class="lineno"></span><span class="comment" id="1396790">//&nbsp;Callers&nbsp;should&nbsp;not&nbsp;assume&nbsp;any&nbsp;relation&nbsp;between&nbsp;values&nbsp;passed&nbsp;to&nbsp;Put&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1396865">//&nbsp;the&nbsp;values&nbsp;returned&nbsp;by&nbsp;Get.</span><br>
<span class="lineno">90</span><span class="comment" id="1396896">//</span><br>
<span class="lineno"></span><span class="comment" id="1396899">//&nbsp;If&nbsp;Get&nbsp;would&nbsp;otherwise&nbsp;return&nbsp;nil&nbsp;and&nbsp;p.New&nbsp;is&nbsp;non-nil,&nbsp;Get&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="1396970">//&nbsp;the&nbsp;result&nbsp;of&nbsp;calling&nbsp;p.New.</span><br>
<span class="lineno"></span><span class="keyword" id="1397002">func</span>&nbsp;<span class="op" id="1397007">(</span><span class="ident" id="1397008">p</span>&nbsp;<span class="op" id="1397010">*</span><span class="ident" id="1397011">Pool</span><span class="op" id="1397015">)</span>&nbsp;<span class="ident" id="1397017">Get</span><span class="op" id="1397020">(</span><span class="op" id="1397021">)</span>&nbsp;<span class="keyword" id="1397023">interface</span><span class="op" id="1397032">{</span><span class="op" id="1397033">}</span>&nbsp;<span class="op" id="1397035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1397038">if</span>&nbsp;<span class="ident" id="1397041">raceenabled</span>&nbsp;<span class="op" id="1397053">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1397057">if</span>&nbsp;<span class="ident" id="1397060">p</span><span class="op" id="1397061">.</span><span class="ident" id="1397062">New</span>&nbsp;<span class="op" id="1397066">!=</span>&nbsp;<span class="ident" id="1397069">nil</span>&nbsp;<span class="op" id="1397073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1397078">return</span>&nbsp;<span class="ident" id="1397085">p</span><span class="op" id="1397086">.</span><span class="ident" id="1397087">New</span><span class="op" id="1397090">(</span><span class="op" id="1397091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1397095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1397099">return</span>&nbsp;<span class="ident" id="1397106">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1397111">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397114">l</span>&nbsp;<span class="op" id="1397116">:=</span>&nbsp;<span class="ident" id="1397119">p</span><span class="op" id="1397120">.</span><span class="ident" id="1397121">pin</span><span class="op" id="1397124">(</span><span class="op" id="1397125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397128">x</span>&nbsp;<span class="op" id="1397130">:=</span>&nbsp;<span class="ident" id="1397133">l</span><span class="op" id="1397134">.</span><span class="ident" id="1397135">private</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397144">l</span><span class="op" id="1397145">.</span><span class="ident" id="1397146">private</span>&nbsp;<span class="op" id="1397154">=</span>&nbsp;<span class="ident" id="1397156">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397161">runtime_procUnpin</span><span class="op" id="1397178">(</span><span class="op" id="1397179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1397182">if</span>&nbsp;<span class="ident" id="1397185">x</span>&nbsp;<span class="op" id="1397187">!=</span>&nbsp;<span class="ident" id="1397190">nil</span>&nbsp;<span class="op" id="1397194">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1397198">return</span>&nbsp;<span class="ident" id="1397205">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1397208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397211">l</span><span class="op" id="1397212">.</span><span class="ident" id="1397213">Lock</span><span class="op" id="1397217">(</span><span class="op" id="1397218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397221">last</span>&nbsp;<span class="op" id="1397226">:=</span>&nbsp;<span class="builtinfunc" id="1397229">len</span><span class="op" id="1397232">(</span><span class="ident" id="1397233">l</span><span class="op" id="1397234">.</span><span class="ident" id="1397235">shared</span><span class="op" id="1397241">)</span>&nbsp;<span class="op" id="1397243">-</span>&nbsp;<span class="num" id="1397245">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1397248">if</span>&nbsp;<span class="ident" id="1397251">last</span>&nbsp;<span class="op" id="1397256">&gt;=</span>&nbsp;<span class="num" id="1397259">0</span>&nbsp;<span class="op" id="1397261">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397265">x</span>&nbsp;<span class="op" id="1397267">=</span>&nbsp;<span class="ident" id="1397269">l</span><span class="op" id="1397270">.</span><span class="ident" id="1397271">shared</span><span class="op" id="1397277">[</span><span class="ident" id="1397278">last</span><span class="op" id="1397282">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397286">l</span><span class="op" id="1397287">.</span><span class="ident" id="1397288">shared</span>&nbsp;<span class="op" id="1397295">=</span>&nbsp;<span class="ident" id="1397297">l</span><span class="op" id="1397298">.</span><span class="ident" id="1397299">shared</span><span class="op" id="1397305">[</span><span class="op" id="1397306">:</span><span class="ident" id="1397307">last</span><span class="op" id="1397311">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1397314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397317">l</span><span class="op" id="1397318">.</span><span class="ident" id="1397319">Unlock</span><span class="op" id="1397325">(</span><span class="op" id="1397326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1397329">if</span>&nbsp;<span class="ident" id="1397332">x</span>&nbsp;<span class="op" id="1397334">!=</span>&nbsp;<span class="ident" id="1397337">nil</span>&nbsp;<span class="op" id="1397341">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1397345">return</span>&nbsp;<span class="ident" id="1397352">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1397355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1397358">return</span>&nbsp;<span class="ident" id="1397365">p</span><span class="op" id="1397366">.</span><span class="ident" id="1397367">getSlow</span><span class="op" id="1397374">(</span><span class="op" id="1397375">)</span><br>
<span class="lineno"></span><span class="op" id="1397377">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="1397380">func</span>&nbsp;<span class="op" id="1397385">(</span><span class="ident" id="1397386">p</span>&nbsp;<span class="op" id="1397388">*</span><span class="ident" id="1397389">Pool</span><span class="op" id="1397393">)</span>&nbsp;<span class="ident" id="1397395">getSlow</span><span class="op" id="1397402">(</span><span class="op" id="1397403">)</span>&nbsp;<span class="op" id="1397405">(</span><span class="ident" id="1397406">x</span>&nbsp;<span class="keyword" id="1397408">interface</span><span class="op" id="1397417">{</span><span class="op" id="1397418">}</span><span class="op" id="1397419">)</span>&nbsp;<span class="op" id="1397421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1397424">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;in&nbsp;pin&nbsp;regarding&nbsp;ordering&nbsp;of&nbsp;the&nbsp;loads.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397484">size</span>&nbsp;<span class="op" id="1397489">:=</span>&nbsp;<span class="ident" id="1397492">atomic</span><span class="op" id="1397498">.</span><span class="ident" id="1397499">LoadUintptr</span><span class="op" id="1397510">(</span><span class="op" id="1397511">&amp;</span><span class="ident" id="1397512">p</span><span class="op" id="1397513">.</span><span class="ident" id="1397514">localSize</span><span class="op" id="1397523">)</span>&nbsp;<span class="comment" id="1397525">//&nbsp;load-acquire</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397542">local</span>&nbsp;<span class="op" id="1397548">:=</span>&nbsp;<span class="ident" id="1397551">p</span><span class="op" id="1397552">.</span><span class="ident" id="1397553">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1397583">//&nbsp;load-consume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1397600">//&nbsp;Try&nbsp;to&nbsp;steal&nbsp;one&nbsp;element&nbsp;from&nbsp;other&nbsp;procs.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397647">pid</span>&nbsp;<span class="op" id="1397651">:=</span>&nbsp;<span class="ident" id="1397654">runtime_procPin</span><span class="op" id="1397669">(</span><span class="op" id="1397670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397673">runtime_procUnpin</span><span class="op" id="1397690">(</span><span class="op" id="1397691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1397694">for</span>&nbsp;<span class="ident" id="1397698">i</span>&nbsp;<span class="op" id="1397700">:=</span>&nbsp;<span class="num" id="1397703">0</span><span class="op" id="1397704">;</span>&nbsp;<span class="ident" id="1397706">i</span>&nbsp;<span class="op" id="1397708">&lt;</span>&nbsp;<span class="builtintype" id="1397710">int</span><span class="op" id="1397713">(</span><span class="ident" id="1397714">size</span><span class="op" id="1397718">)</span><span class="op" id="1397719">;</span>&nbsp;<span class="ident" id="1397721">i</span><span class="op" id="1397722">++</span>&nbsp;<span class="op" id="1397725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397729">l</span>&nbsp;<span class="op" id="1397731">:=</span>&nbsp;<span class="ident" id="1397734">indexLocal</span><span class="op" id="1397744">(</span><span class="ident" id="1397745">local</span><span class="op" id="1397750">,</span>&nbsp;<span class="op" id="1397752">(</span><span class="ident" id="1397753">pid</span><span class="op" id="1397756">+</span><span class="ident" id="1397757">i</span><span class="op" id="1397758">+</span><span class="num" id="1397759">1</span><span class="op" id="1397760">)</span><span class="op" id="1397761">%</span><span class="builtintype" id="1397762">int</span><span class="op" id="1397765">(</span><span class="ident" id="1397766">size</span><span class="op" id="1397770">)</span><span class="op" id="1397771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397775">l</span><span class="op" id="1397776">.</span><span class="ident" id="1397777">Lock</span><span class="op" id="1397781">(</span><span class="op" id="1397782">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397786">last</span>&nbsp;<span class="op" id="1397791">:=</span>&nbsp;<span class="builtinfunc" id="1397794">len</span><span class="op" id="1397797">(</span><span class="ident" id="1397798">l</span><span class="op" id="1397799">.</span><span class="ident" id="1397800">shared</span><span class="op" id="1397806">)</span>&nbsp;<span class="op" id="1397808">-</span>&nbsp;<span class="num" id="1397810">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1397814">if</span>&nbsp;<span class="ident" id="1397817">last</span>&nbsp;<span class="op" id="1397822">&gt;=</span>&nbsp;<span class="num" id="1397825">0</span>&nbsp;<span class="op" id="1397827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397832">x</span>&nbsp;<span class="op" id="1397834">=</span>&nbsp;<span class="ident" id="1397836">l</span><span class="op" id="1397837">.</span><span class="ident" id="1397838">shared</span><span class="op" id="1397844">[</span><span class="ident" id="1397845">last</span><span class="op" id="1397849">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397854">l</span><span class="op" id="1397855">.</span><span class="ident" id="1397856">shared</span>&nbsp;<span class="op" id="1397863">=</span>&nbsp;<span class="ident" id="1397865">l</span><span class="op" id="1397866">.</span><span class="ident" id="1397867">shared</span><span class="op" id="1397873">[</span><span class="op" id="1397874">:</span><span class="ident" id="1397875">last</span><span class="op" id="1397879">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397884">l</span><span class="op" id="1397885">.</span><span class="ident" id="1397886">Unlock</span><span class="op" id="1397892">(</span><span class="op" id="1397893">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1397898">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1397906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397910">l</span><span class="op" id="1397911">.</span><span class="ident" id="1397912">Unlock</span><span class="op" id="1397918">(</span><span class="op" id="1397919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1397922">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1397926">if</span>&nbsp;<span class="ident" id="1397929">x</span>&nbsp;<span class="op" id="1397931">==</span>&nbsp;<span class="ident" id="1397934">nil</span>&nbsp;<span class="op" id="1397938">&amp;&amp;</span>&nbsp;<span class="ident" id="1397941">p</span><span class="op" id="1397942">.</span><span class="ident" id="1397943">New</span>&nbsp;<span class="op" id="1397947">!=</span>&nbsp;<span class="ident" id="1397950">nil</span>&nbsp;<span class="op" id="1397954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397958">x</span>&nbsp;<span class="op" id="1397960">=</span>&nbsp;<span class="ident" id="1397962">p</span><span class="op" id="1397963">.</span><span class="ident" id="1397964">New</span><span class="op" id="1397967">(</span><span class="op" id="1397968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1397971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1397974">return</span>&nbsp;<span class="ident" id="1397981">x</span><br>
<span class="lineno"></span><span class="op" id="1397983">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span><span class="comment" id="1397986">//&nbsp;pin&nbsp;pins&nbsp;the&nbsp;current&nbsp;goroutine&nbsp;to&nbsp;P,&nbsp;disables&nbsp;preemption&nbsp;and&nbsp;returns&nbsp;poolLocal&nbsp;pool&nbsp;for&nbsp;the&nbsp;P.</span><br>
<span class="lineno"></span><span class="comment" id="1398084">//&nbsp;Caller&nbsp;must&nbsp;call&nbsp;runtime_procUnpin()&nbsp;when&nbsp;done&nbsp;with&nbsp;the&nbsp;pool.</span><br>
<span class="lineno"></span><span class="keyword" id="1398149">func</span>&nbsp;<span class="op" id="1398154">(</span><span class="ident" id="1398155">p</span>&nbsp;<span class="op" id="1398157">*</span><span class="ident" id="1398158">Pool</span><span class="op" id="1398162">)</span>&nbsp;<span class="ident" id="1398164">pin</span><span class="op" id="1398167">(</span><span class="op" id="1398168">)</span>&nbsp;<span class="op" id="1398170">*</span><span class="ident" id="1398171">poolLocal</span>&nbsp;<span class="op" id="1398181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1398184">pid</span>&nbsp;<span class="op" id="1398188">:=</span>&nbsp;<span class="ident" id="1398191">runtime_procPin</span><span class="op" id="1398206">(</span><span class="op" id="1398207">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1398210">//&nbsp;In&nbsp;pinSlow&nbsp;we&nbsp;store&nbsp;to&nbsp;localSize&nbsp;and&nbsp;then&nbsp;to&nbsp;local,&nbsp;here&nbsp;we&nbsp;load&nbsp;in&nbsp;opposite&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1398298">//&nbsp;Since&nbsp;we&#39;ve&nbsp;disabled&nbsp;preemption,&nbsp;GC&nbsp;can&nbsp;not&nbsp;happen&nbsp;in&nbsp;between.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1398365">//&nbsp;Thus&nbsp;here&nbsp;we&nbsp;must&nbsp;observe&nbsp;local&nbsp;at&nbsp;least&nbsp;as&nbsp;large&nbsp;localSize.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1398430">//&nbsp;We&nbsp;can&nbsp;observe&nbsp;a&nbsp;newer/larger&nbsp;local,&nbsp;it&nbsp;is&nbsp;fine&nbsp;(we&nbsp;must&nbsp;observe&nbsp;its&nbsp;zero-initialized-ness).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1398527">s</span>&nbsp;<span class="op" id="1398529">:=</span>&nbsp;<span class="ident" id="1398532">atomic</span><span class="op" id="1398538">.</span><span class="ident" id="1398539">LoadUintptr</span><span class="op" id="1398550">(</span><span class="op" id="1398551">&amp;</span><span class="ident" id="1398552">p</span><span class="op" id="1398553">.</span><span class="ident" id="1398554">localSize</span><span class="op" id="1398563">)</span>&nbsp;<span class="comment" id="1398565">//&nbsp;load-acquire</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1398582">l</span>&nbsp;<span class="op" id="1398584">:=</span>&nbsp;<span class="ident" id="1398587">p</span><span class="op" id="1398588">.</span><span class="ident" id="1398589">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1398620">//&nbsp;load-consume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1398637">if</span>&nbsp;<span class="builtintype" id="1398640">uintptr</span><span class="op" id="1398647">(</span><span class="ident" id="1398648">pid</span><span class="op" id="1398651">)</span>&nbsp;<span class="op" id="1398653">&lt;</span>&nbsp;<span class="ident" id="1398655">s</span>&nbsp;<span class="op" id="1398657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1398661">return</span>&nbsp;<span class="ident" id="1398668">indexLocal</span><span class="op" id="1398678">(</span><span class="ident" id="1398679">l</span><span class="op" id="1398680">,</span>&nbsp;<span class="ident" id="1398682">pid</span><span class="op" id="1398685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1398688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1398691">return</span>&nbsp;<span class="ident" id="1398698">p</span><span class="op" id="1398699">.</span><span class="ident" id="1398700">pinSlow</span><span class="op" id="1398707">(</span><span class="op" id="1398708">)</span><br>
<span class="lineno">160</span><span class="op" id="1398710">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1398713">func</span>&nbsp;<span class="op" id="1398718">(</span><span class="ident" id="1398719">p</span>&nbsp;<span class="op" id="1398721">*</span><span class="ident" id="1398722">Pool</span><span class="op" id="1398726">)</span>&nbsp;<span class="ident" id="1398728">pinSlow</span><span class="op" id="1398735">(</span><span class="op" id="1398736">)</span>&nbsp;<span class="op" id="1398738">*</span><span class="ident" id="1398739">poolLocal</span>&nbsp;<span class="op" id="1398749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1398752">//&nbsp;Retry&nbsp;under&nbsp;the&nbsp;mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1398779">//&nbsp;Can&nbsp;not&nbsp;lock&nbsp;the&nbsp;mutex&nbsp;while&nbsp;pinned.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1398820">runtime_procUnpin</span><span class="op" id="1398837">(</span><span class="op" id="1398838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1398841">allPoolsMu</span><span class="op" id="1398851">.</span><span class="ident" id="1398852">Lock</span><span class="op" id="1398856">(</span><span class="op" id="1398857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1398860">defer</span>&nbsp;<span class="ident" id="1398866">allPoolsMu</span><span class="op" id="1398876">.</span><span class="ident" id="1398877">Unlock</span><span class="op" id="1398883">(</span><span class="op" id="1398884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1398887">pid</span>&nbsp;<span class="op" id="1398891">:=</span>&nbsp;<span class="ident" id="1398894">runtime_procPin</span><span class="op" id="1398909">(</span><span class="op" id="1398910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1398913">//&nbsp;poolCleanup&nbsp;won&#39;t&nbsp;be&nbsp;called&nbsp;while&nbsp;we&nbsp;are&nbsp;pinned.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1398966">s</span>&nbsp;<span class="op" id="1398968">:=</span>&nbsp;<span class="ident" id="1398971">p</span><span class="op" id="1398972">.</span><span class="ident" id="1398973">localSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1398984">l</span>&nbsp;<span class="op" id="1398986">:=</span>&nbsp;<span class="ident" id="1398989">p</span><span class="op" id="1398990">.</span><span class="ident" id="1398991">local</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1398998">if</span>&nbsp;<span class="builtintype" id="1399001">uintptr</span><span class="op" id="1399008">(</span><span class="ident" id="1399009">pid</span><span class="op" id="1399012">)</span>&nbsp;<span class="op" id="1399014">&lt;</span>&nbsp;<span class="ident" id="1399016">s</span>&nbsp;<span class="op" id="1399018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1399022">return</span>&nbsp;<span class="ident" id="1399029">indexLocal</span><span class="op" id="1399039">(</span><span class="ident" id="1399040">l</span><span class="op" id="1399041">,</span>&nbsp;<span class="ident" id="1399043">pid</span><span class="op" id="1399046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1399049">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1399052">if</span>&nbsp;<span class="ident" id="1399055">p</span><span class="op" id="1399056">.</span><span class="ident" id="1399057">local</span>&nbsp;<span class="op" id="1399063">==</span>&nbsp;<span class="ident" id="1399066">nil</span>&nbsp;<span class="op" id="1399070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1399074">allPools</span>&nbsp;<span class="op" id="1399083">=</span>&nbsp;<span class="builtinfunc" id="1399085">append</span><span class="op" id="1399091">(</span><span class="ident" id="1399092">allPools</span><span class="op" id="1399100">,</span>&nbsp;<span class="ident" id="1399102">p</span><span class="op" id="1399103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1399106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1399109">//&nbsp;If&nbsp;GOMAXPROCS&nbsp;changes&nbsp;between&nbsp;GCs,&nbsp;we&nbsp;re-allocate&nbsp;the&nbsp;array&nbsp;and&nbsp;lose&nbsp;the&nbsp;old&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1399195">size</span>&nbsp;<span class="op" id="1399200">:=</span>&nbsp;<span class="ident" id="1399203">runtime</span><span class="op" id="1399210">.</span><span class="ident" id="1399211">GOMAXPROCS</span><span class="op" id="1399221">(</span><span class="num" id="1399222">0</span><span class="op" id="1399223">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1399226">local</span>&nbsp;<span class="op" id="1399232">:=</span>&nbsp;<span class="builtinfunc" id="1399235">make</span><span class="op" id="1399239">(</span><span class="op" id="1399240">[</span><span class="op" id="1399241">]</span><span class="ident" id="1399242">poolLocal</span><span class="op" id="1399251">,</span>&nbsp;<span class="ident" id="1399253">size</span><span class="op" id="1399257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1399260">atomic</span><span class="op" id="1399266">.</span><span class="ident" id="1399267">StorePointer</span><span class="op" id="1399279">(</span><span class="op" id="1399280">(</span><span class="op" id="1399281">*</span><span class="ident" id="1399282">unsafe</span><span class="op" id="1399288">.</span><span class="ident" id="1399289">Pointer</span><span class="op" id="1399296">)</span><span class="op" id="1399297">(</span><span class="op" id="1399298">&amp;</span><span class="ident" id="1399299">p</span><span class="op" id="1399300">.</span><span class="ident" id="1399301">local</span><span class="op" id="1399306">)</span><span class="op" id="1399307">,</span>&nbsp;<span class="ident" id="1399309">unsafe</span><span class="op" id="1399315">.</span><span class="ident" id="1399316">Pointer</span><span class="op" id="1399323">(</span><span class="op" id="1399324">&amp;</span><span class="ident" id="1399325">local</span><span class="op" id="1399330">[</span><span class="num" id="1399331">0</span><span class="op" id="1399332">]</span><span class="op" id="1399333">)</span><span class="op" id="1399334">)</span>&nbsp;<span class="comment" id="1399336">//&nbsp;store-release</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1399354">atomic</span><span class="op" id="1399360">.</span><span class="ident" id="1399361">StoreUintptr</span><span class="op" id="1399373">(</span><span class="op" id="1399374">&amp;</span><span class="ident" id="1399375">p</span><span class="op" id="1399376">.</span><span class="ident" id="1399377">localSize</span><span class="op" id="1399386">,</span>&nbsp;<span class="builtintype" id="1399388">uintptr</span><span class="op" id="1399395">(</span><span class="ident" id="1399396">size</span><span class="op" id="1399400">)</span><span class="op" id="1399401">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1399430">//&nbsp;store-release</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1399448">return</span>&nbsp;<span class="op" id="1399455">&amp;</span><span class="ident" id="1399456">local</span><span class="op" id="1399461">[</span><span class="ident" id="1399462">pid</span><span class="op" id="1399465">]</span><br>
<span class="lineno"></span><span class="op" id="1399467">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="keyword" id="1399470">func</span>&nbsp;<span class="ident" id="1399475">poolCleanup</span><span class="op" id="1399486">(</span><span class="op" id="1399487">)</span>&nbsp;<span class="op" id="1399489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1399492">//&nbsp;This&nbsp;function&nbsp;is&nbsp;called&nbsp;with&nbsp;the&nbsp;world&nbsp;stopped,&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;a&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1399586">//&nbsp;It&nbsp;must&nbsp;not&nbsp;allocate&nbsp;and&nbsp;probably&nbsp;should&nbsp;not&nbsp;call&nbsp;any&nbsp;runtime&nbsp;functions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1399663">//&nbsp;Defensively&nbsp;zero&nbsp;out&nbsp;everything,&nbsp;2&nbsp;reasons:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1399711">//&nbsp;1.&nbsp;To&nbsp;prevent&nbsp;false&nbsp;retention&nbsp;of&nbsp;whole&nbsp;Pools.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1399761">//&nbsp;2.&nbsp;If&nbsp;GC&nbsp;happens&nbsp;while&nbsp;a&nbsp;goroutine&nbsp;works&nbsp;with&nbsp;l.shared&nbsp;in&nbsp;Put/Get,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1399832">//&nbsp;&nbsp;&nbsp;&nbsp;it&nbsp;will&nbsp;retain&nbsp;whole&nbsp;Pool.&nbsp;So&nbsp;next&nbsp;cycle&nbsp;memory&nbsp;consumption&nbsp;would&nbsp;be&nbsp;doubled.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1399917">for</span>&nbsp;<span class="ident" id="1399921">i</span><span class="op" id="1399922">,</span>&nbsp;<span class="ident" id="1399924">p</span>&nbsp;<span class="op" id="1399926">:=</span>&nbsp;<span class="keyword" id="1399929">range</span>&nbsp;<span class="ident" id="1399935">allPools</span>&nbsp;<span class="op" id="1399944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1399948">allPools</span><span class="op" id="1399956">[</span><span class="ident" id="1399957">i</span><span class="op" id="1399958">]</span>&nbsp;<span class="op" id="1399960">=</span>&nbsp;<span class="ident" id="1399962">nil</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1399968">for</span>&nbsp;<span class="ident" id="1399972">i</span>&nbsp;<span class="op" id="1399974">:=</span>&nbsp;<span class="num" id="1399977">0</span><span class="op" id="1399978">;</span>&nbsp;<span class="ident" id="1399980">i</span>&nbsp;<span class="op" id="1399982">&lt;</span>&nbsp;<span class="builtintype" id="1399984">int</span><span class="op" id="1399987">(</span><span class="ident" id="1399988">p</span><span class="op" id="1399989">.</span><span class="ident" id="1399990">localSize</span><span class="op" id="1399999">)</span><span class="op" id="1400000">;</span>&nbsp;<span class="ident" id="1400002">i</span><span class="op" id="1400003">++</span>&nbsp;<span class="op" id="1400006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1400011">l</span>&nbsp;<span class="op" id="1400013">:=</span>&nbsp;<span class="ident" id="1400016">indexLocal</span><span class="op" id="1400026">(</span><span class="ident" id="1400027">p</span><span class="op" id="1400028">.</span><span class="ident" id="1400029">local</span><span class="op" id="1400034">,</span>&nbsp;<span class="ident" id="1400036">i</span><span class="op" id="1400037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1400042">l</span><span class="op" id="1400043">.</span><span class="ident" id="1400044">private</span>&nbsp;<span class="op" id="1400052">=</span>&nbsp;<span class="ident" id="1400054">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1400061">for</span>&nbsp;<span class="ident" id="1400065">j</span>&nbsp;<span class="op" id="1400067">:=</span>&nbsp;<span class="keyword" id="1400070">range</span>&nbsp;<span class="ident" id="1400076">l</span><span class="op" id="1400077">.</span><span class="ident" id="1400078">shared</span>&nbsp;<span class="op" id="1400085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1400091">l</span><span class="op" id="1400092">.</span><span class="ident" id="1400093">shared</span><span class="op" id="1400099">[</span><span class="ident" id="1400100">j</span><span class="op" id="1400101">]</span>&nbsp;<span class="op" id="1400103">=</span>&nbsp;<span class="ident" id="1400105">nil</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1400112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1400117">l</span><span class="op" id="1400118">.</span><span class="ident" id="1400119">shared</span>&nbsp;<span class="op" id="1400126">=</span>&nbsp;<span class="ident" id="1400128">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1400134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1400138">p</span><span class="op" id="1400139">.</span><span class="ident" id="1400140">local</span>&nbsp;<span class="op" id="1400146">=</span>&nbsp;<span class="ident" id="1400148">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1400154">p</span><span class="op" id="1400155">.</span><span class="ident" id="1400156">localSize</span>&nbsp;<span class="op" id="1400166">=</span>&nbsp;<span class="num" id="1400168">0</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1400171">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1400174">allPools</span>&nbsp;<span class="op" id="1400183">=</span>&nbsp;<span class="op" id="1400185">[</span><span class="op" id="1400186">]</span><span class="op" id="1400187">*</span><span class="ident" id="1400188">Pool</span><span class="op" id="1400192">{</span><span class="op" id="1400193">}</span><br>
<span class="lineno"></span><span class="op" id="1400195">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1400198">var</span>&nbsp;<span class="op" id="1400202">(</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1400205">allPoolsMu</span>&nbsp;<span class="ident" id="1400216">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1400223">allPools</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1400234">[</span><span class="op" id="1400235">]</span><span class="op" id="1400236">*</span><span class="ident" id="1400237">Pool</span><br>
<span class="lineno"></span><span class="op" id="1400242">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1400245">func</span>&nbsp;<span class="ident" id="1400250">init</span><span class="op" id="1400254">(</span><span class="op" id="1400255">)</span>&nbsp;<span class="op" id="1400257">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1400260">runtime_registerPoolCleanup</span><span class="op" id="1400287">(</span><span class="ident" id="1400288">poolCleanup</span><span class="op" id="1400299">)</span><br>
<span class="lineno"></span><span class="op" id="1400301">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1400304">func</span>&nbsp;<span class="ident" id="1400309">indexLocal</span><span class="op" id="1400319">(</span><span class="ident" id="1400320">l</span>&nbsp;<span class="ident" id="1400322">unsafe</span><span class="op" id="1400328">.</span><span class="ident" id="1400329">Pointer</span><span class="op" id="1400336">,</span>&nbsp;<span class="ident" id="1400338">i</span>&nbsp;<span class="builtintype" id="1400340">int</span><span class="op" id="1400343">)</span>&nbsp;<span class="op" id="1400345">*</span><span class="ident" id="1400346">poolLocal</span>&nbsp;<span class="op" id="1400356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1400359">return</span>&nbsp;<span class="op" id="1400366">&amp;</span><span class="op" id="1400367">(</span><span class="op" id="1400368">*</span><span class="op" id="1400369">[</span><span class="num" id="1400370">1000000</span><span class="op" id="1400377">]</span><span class="ident" id="1400378">poolLocal</span><span class="op" id="1400387">)</span><span class="op" id="1400388">(</span><span class="ident" id="1400389">l</span><span class="op" id="1400390">)</span><span class="op" id="1400391">[</span><span class="ident" id="1400392">i</span><span class="op" id="1400393">]</span><br>
<span class="lineno">220</span><span class="op" id="1400395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1400398">//&nbsp;Implemented&nbsp;in&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="keyword" id="1400425">func</span>&nbsp;<span class="ident" id="1400430">runtime_registerPoolCleanup</span><span class="op" id="1400457">(</span><span class="ident" id="1400458">cleanup</span>&nbsp;<span class="keyword" id="1400466">func</span><span class="op" id="1400470">(</span><span class="op" id="1400471">)</span><span class="op" id="1400472">)</span><br>
<span class="lineno"></span><span class="keyword" id="1400474">func</span>&nbsp;<span class="ident" id="1400479">runtime_procPin</span><span class="op" id="1400494">(</span><span class="op" id="1400495">)</span>&nbsp;<span class="builtintype" id="1400497">int</span><br>
<span class="lineno">225</span><span class="keyword" id="1400501">func</span>&nbsp;<span class="ident" id="1400506">runtime_procUnpin</span><span class="op" id="1400523">(</span><span class="op" id="1400524">)</span>
</div>
</body>
</html>
