<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html" class="current">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1698348">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1698403">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1698457">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1698508">//&nbsp;Semaphore&nbsp;implementation&nbsp;exposed&nbsp;to&nbsp;Go.</span><br>
<span class="lineno"></span><span class="comment" id="1698551">//&nbsp;Intended&nbsp;use&nbsp;is&nbsp;provide&nbsp;a&nbsp;sleep&nbsp;and&nbsp;wakeup</span><br>
<span class="lineno"></span><span class="comment" id="1698597">//&nbsp;primitive&nbsp;that&nbsp;can&nbsp;be&nbsp;used&nbsp;in&nbsp;the&nbsp;contended&nbsp;case</span><br>
<span class="lineno"></span><span class="comment" id="1698649">//&nbsp;of&nbsp;other&nbsp;synchronization&nbsp;primitives.</span><br>
<span class="lineno"></span><span class="comment" id="1698689">//&nbsp;Thus&nbsp;it&nbsp;targets&nbsp;the&nbsp;same&nbsp;goal&nbsp;as&nbsp;Linux&#39;s&nbsp;futex,</span><br>
<span class="lineno">10</span><span class="comment" id="1698740">//&nbsp;but&nbsp;it&nbsp;has&nbsp;much&nbsp;simpler&nbsp;semantics.</span><br>
<span class="lineno"></span><span class="comment" id="1698778">//</span><br>
<span class="lineno"></span><span class="comment" id="1698781">//&nbsp;That&nbsp;is,&nbsp;don&#39;t&nbsp;think&nbsp;of&nbsp;these&nbsp;as&nbsp;semaphores.</span><br>
<span class="lineno"></span><span class="comment" id="1698829">//&nbsp;Think&nbsp;of&nbsp;them&nbsp;as&nbsp;a&nbsp;way&nbsp;to&nbsp;implement&nbsp;sleep&nbsp;and&nbsp;wakeup</span><br>
<span class="lineno"></span><span class="comment" id="1698885">//&nbsp;such&nbsp;that&nbsp;every&nbsp;sleep&nbsp;is&nbsp;paired&nbsp;with&nbsp;a&nbsp;single&nbsp;wakeup,</span><br>
<span class="lineno">15</span><span class="comment" id="1698942">//&nbsp;even&nbsp;if,&nbsp;due&nbsp;to&nbsp;races,&nbsp;the&nbsp;wakeup&nbsp;happens&nbsp;before&nbsp;the&nbsp;sleep.</span><br>
<span class="lineno"></span><span class="comment" id="1699005">//</span><br>
<span class="lineno"></span><span class="comment" id="1699008">//&nbsp;See&nbsp;Mullender&nbsp;and&nbsp;Cox,&nbsp;``Semaphores&nbsp;in&nbsp;Plan&nbsp;9,&#39;&#39;</span><br>
<span class="lineno"></span><span class="comment" id="1699060">//&nbsp;http://swtch.com/semaphore.pdf</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1699095">package</span>&nbsp;<span class="ident" id="1699103">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1699112">import</span>&nbsp;<span class="string" id="1699119">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1699129">//&nbsp;Asynchronous&nbsp;semaphore&nbsp;for&nbsp;sync.Mutex.</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="1699172">type</span>&nbsp;<span class="ident" id="1699177">semaRoot</span>&nbsp;<span class="keyword" id="1699186">struct</span>&nbsp;<span class="op" id="1699193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1699196">lock</span>&nbsp;&nbsp;<span class="ident" id="1699202">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1699209">head</span>&nbsp;&nbsp;<span class="op" id="1699215">*</span><span class="ident" id="1699216">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1699223">tail</span>&nbsp;&nbsp;<span class="op" id="1699229">*</span><span class="ident" id="1699230">sudog</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1699237">nwait</span>&nbsp;<span class="builtintype" id="1699243">uint32</span>&nbsp;<span class="comment" id="1699250">//&nbsp;Number&nbsp;of&nbsp;waiters.&nbsp;Read&nbsp;w/o&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="op" id="1699291">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1699294">//&nbsp;Prime&nbsp;to&nbsp;not&nbsp;correlate&nbsp;with&nbsp;any&nbsp;user&nbsp;patterns.</span><br>
<span class="lineno"></span><span class="keyword" id="1699344">const</span>&nbsp;<span class="ident" id="1699350">semTabSize</span>&nbsp;<span class="op" id="1699361">=</span>&nbsp;<span class="num" id="1699363">251</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="1699368">var</span>&nbsp;<span class="ident" id="1699372">semtable</span>&nbsp;<span class="op" id="1699381">[</span><span class="ident" id="1699382">semTabSize</span><span class="op" id="1699392">]</span><span class="keyword" id="1699393">struct</span>&nbsp;<span class="op" id="1699400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1699403">root</span>&nbsp;<span class="ident" id="1699408">semaRoot</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1699418">pad</span>&nbsp;&nbsp;<span class="op" id="1699423">[</span><span class="ident" id="1699424">_CacheLineSize</span>&nbsp;<span class="op" id="1699439">-</span>&nbsp;<span class="ident" id="1699441">unsafe</span><span class="op" id="1699447">.</span><span class="ident" id="1699448">Sizeof</span><span class="op" id="1699454">(</span><span class="ident" id="1699455">semaRoot</span><span class="op" id="1699463">{</span><span class="op" id="1699464">}</span><span class="op" id="1699465">)</span><span class="op" id="1699466">]</span><span class="builtintype" id="1699467">byte</span><br>
<span class="lineno"></span><span class="op" id="1699472">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="1699475">//&nbsp;Called&nbsp;from&nbsp;sync/net&nbsp;packages.</span><br>
<span class="lineno"></span><span class="keyword" id="1699509">func</span>&nbsp;<span class="ident" id="1699514">asyncsemacquire</span><span class="op" id="1699529">(</span><span class="ident" id="1699530">addr</span>&nbsp;<span class="op" id="1699535">*</span><span class="builtintype" id="1699536">uint32</span><span class="op" id="1699542">)</span>&nbsp;<span class="op" id="1699544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1699547">semacquire</span><span class="op" id="1699557">(</span><span class="ident" id="1699558">addr</span><span class="op" id="1699562">,</span>&nbsp;<span class="builtintype" id="1699564">true</span><span class="op" id="1699568">)</span><br>
<span class="lineno"></span><span class="op" id="1699570">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword" id="1699573">func</span>&nbsp;<span class="ident" id="1699578">asyncsemrelease</span><span class="op" id="1699593">(</span><span class="ident" id="1699594">addr</span>&nbsp;<span class="op" id="1699599">*</span><span class="builtintype" id="1699600">uint32</span><span class="op" id="1699606">)</span>&nbsp;<span class="op" id="1699608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1699611">semrelease</span><span class="op" id="1699621">(</span><span class="ident" id="1699622">addr</span><span class="op" id="1699626">)</span><br>
<span class="lineno"></span><span class="op" id="1699628">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="1699631">//&nbsp;Called&nbsp;from&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="keyword" id="1699655">func</span>&nbsp;<span class="ident" id="1699660">semacquire</span><span class="op" id="1699670">(</span><span class="ident" id="1699671">addr</span>&nbsp;<span class="op" id="1699676">*</span><span class="builtintype" id="1699677">uint32</span><span class="op" id="1699683">,</span>&nbsp;<span class="ident" id="1699685">profile</span>&nbsp;<span class="builtintype" id="1699693">bool</span><span class="op" id="1699697">)</span>&nbsp;<span class="op" id="1699699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1699702">gp</span>&nbsp;<span class="op" id="1699705">:=</span>&nbsp;<span class="ident" id="1699708">getg</span><span class="op" id="1699712">(</span><span class="op" id="1699713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1699716">if</span>&nbsp;<span class="ident" id="1699719">gp</span>&nbsp;<span class="op" id="1699722">!=</span>&nbsp;<span class="ident" id="1699725">gp</span><span class="op" id="1699727">.</span><span class="ident" id="1699728">m</span><span class="op" id="1699729">.</span><span class="ident" id="1699730">curg</span>&nbsp;<span class="op" id="1699735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1699739">gothrow</span><span class="op" id="1699746">(</span><span class="string" id="1699747">&#34;semacquire&nbsp;not&nbsp;on&nbsp;the&nbsp;G&nbsp;stack&#34;</span><span class="op" id="1699778">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1699781">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1699785">//&nbsp;Easy&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1699800">if</span>&nbsp;<span class="ident" id="1699803">cansemacquire</span><span class="op" id="1699816">(</span><span class="ident" id="1699817">addr</span><span class="op" id="1699821">)</span>&nbsp;<span class="op" id="1699823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1699827">return</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1699835">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1699839">//&nbsp;Harder&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1699856">//&nbsp;&nbsp;&nbsp;&nbspincrement&nbsp;waiter&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1699883">//&nbsp;&nbsp;&nbsp;&nbsptry&nbsp;cansemacquire&nbsp;one&nbsp;more&nbsp;time,&nbsp;return&nbsp;if&nbsp;succeeded</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1699940">//&nbsp;&nbsp;&nbsp;&nbspenqueue&nbsp;itself&nbsp;as&nbsp;a&nbsp;waiter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1699971">//&nbsp;&nbsp;&nbsp;&nbspsleep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1699981">//&nbsp;&nbsp;&nbsp;&nbsp(waiter&nbsp;descriptor&nbsp;is&nbsp;dequeued&nbsp;by&nbsp;signaler)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1700029">s</span>&nbsp;<span class="op" id="1700031">:=</span>&nbsp;<span class="ident" id="1700034">acquireSudog</span><span class="op" id="1700046">(</span><span class="op" id="1700047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1700050">root</span>&nbsp;<span class="op" id="1700055">:=</span>&nbsp;<span class="ident" id="1700058">semroot</span><span class="op" id="1700065">(</span><span class="ident" id="1700066">addr</span><span class="op" id="1700070">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1700073">t0</span>&nbsp;<span class="op" id="1700076">:=</span>&nbsp;<span class="ident" id="1700079">int64</span><span class="op" id="1700084">(</span><span class="num" id="1700085">0</span><span class="op" id="1700086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1700089">s</span><span class="op" id="1700090">.</span><span class="ident" id="1700091">releasetime</span>&nbsp;<span class="op" id="1700103">=</span>&nbsp;<span class="num" id="1700105">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1700108">if</span>&nbsp;<span class="ident" id="1700111">profile</span>&nbsp;<span class="op" id="1700119">&amp;&amp;</span>&nbsp;<span class="ident" id="1700122">blockprofilerate</span>&nbsp;<span class="op" id="1700139">&gt;</span>&nbsp;<span class="num" id="1700141">0</span>&nbsp;<span class="op" id="1700143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1700147">t0</span>&nbsp;<span class="op" id="1700150">=</span>&nbsp;<span class="ident" id="1700152">cputicks</span><span class="op" id="1700160">(</span><span class="op" id="1700161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1700165">s</span><span class="op" id="1700166">.</span><span class="ident" id="1700167">releasetime</span>&nbsp;<span class="op" id="1700179">=</span>&nbsp;<span class="op" id="1700181">-</span><span class="num" id="1700182">1</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1700185">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1700188">for</span>&nbsp;<span class="op" id="1700192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1700196">lock</span><span class="op" id="1700200">(</span><span class="op" id="1700201">&amp;</span><span class="ident" id="1700202">root</span><span class="op" id="1700206">.</span><span class="ident" id="1700207">lock</span><span class="op" id="1700211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1700215">//&nbsp;Add&nbsp;ourselves&nbsp;to&nbsp;nwait&nbsp;to&nbsp;disable&nbsp;&#34;easy&nbsp;case&#34;&nbsp;in&nbsp;semrelease.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1700281">xadd</span><span class="op" id="1700285">(</span><span class="op" id="1700286">&amp;</span><span class="ident" id="1700287">root</span><span class="op" id="1700291">.</span><span class="ident" id="1700292">nwait</span><span class="op" id="1700297">,</span>&nbsp;<span class="num" id="1700299">1</span><span class="op" id="1700300">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1700304">//&nbsp;Check&nbsp;cansemacquire&nbsp;to&nbsp;avoid&nbsp;missed&nbsp;wakeup.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1700353">if</span>&nbsp;<span class="ident" id="1700356">cansemacquire</span><span class="op" id="1700369">(</span><span class="ident" id="1700370">addr</span><span class="op" id="1700374">)</span>&nbsp;<span class="op" id="1700376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1700381">xadd</span><span class="op" id="1700385">(</span><span class="op" id="1700386">&amp;</span><span class="ident" id="1700387">root</span><span class="op" id="1700391">.</span><span class="ident" id="1700392">nwait</span><span class="op" id="1700397">,</span>&nbsp;<span class="op" id="1700399">-</span><span class="num" id="1700400">1</span><span class="op" id="1700401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1700406">unlock</span><span class="op" id="1700412">(</span><span class="op" id="1700413">&amp;</span><span class="ident" id="1700414">root</span><span class="op" id="1700418">.</span><span class="ident" id="1700419">lock</span><span class="op" id="1700423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1700428">break</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1700436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1700440">//&nbsp;Any&nbsp;semrelease&nbsp;after&nbsp;the&nbsp;cansemacquire&nbsp;knows&nbsp;we&#39;re&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1700504">//&nbsp;(we&nbsp;set&nbsp;nwait&nbsp;above),&nbsp;so&nbsp;go&nbsp;to&nbsp;sleep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1700547">root</span><span class="op" id="1700551">.</span><span class="ident" id="1700552">queue</span><span class="op" id="1700557">(</span><span class="ident" id="1700558">addr</span><span class="op" id="1700562">,</span>&nbsp;<span class="ident" id="1700564">s</span><span class="op" id="1700565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1700569">goparkunlock</span><span class="op" id="1700581">(</span><span class="op" id="1700582">&amp;</span><span class="ident" id="1700583">root</span><span class="op" id="1700587">.</span><span class="ident" id="1700588">lock</span><span class="op" id="1700592">,</span>&nbsp;<span class="string" id="1700594">&#34;semacquire&#34;</span><span class="op" id="1700606">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1700610">if</span>&nbsp;<span class="ident" id="1700613">cansemacquire</span><span class="op" id="1700626">(</span><span class="ident" id="1700627">addr</span><span class="op" id="1700631">)</span>&nbsp;<span class="op" id="1700633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1700638">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1700646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1700649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1700652">if</span>&nbsp;<span class="ident" id="1700655">s</span><span class="op" id="1700656">.</span><span class="ident" id="1700657">releasetime</span>&nbsp;<span class="op" id="1700669">&gt;</span>&nbsp;<span class="num" id="1700671">0</span>&nbsp;<span class="op" id="1700673">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1700677">blockevent</span><span class="op" id="1700687">(</span><span class="ident" id="1700688">int64</span><span class="op" id="1700693">(</span><span class="ident" id="1700694">s</span><span class="op" id="1700695">.</span><span class="ident" id="1700696">releasetime</span><span class="op" id="1700707">)</span><span class="op" id="1700708">-</span><span class="ident" id="1700709">t0</span><span class="op" id="1700711">,</span>&nbsp;<span class="num" id="1700713">3</span><span class="op" id="1700714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1700717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1700720">releaseSudog</span><span class="op" id="1700732">(</span><span class="ident" id="1700733">s</span><span class="op" id="1700734">)</span><br>
<span class="lineno"></span><span class="op" id="1700736">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="1700739">func</span>&nbsp;<span class="ident" id="1700744">semrelease</span><span class="op" id="1700754">(</span><span class="ident" id="1700755">addr</span>&nbsp;<span class="op" id="1700760">*</span><span class="builtintype" id="1700761">uint32</span><span class="op" id="1700767">)</span>&nbsp;<span class="op" id="1700769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1700772">root</span>&nbsp;<span class="op" id="1700777">:=</span>&nbsp;<span class="ident" id="1700780">semroot</span><span class="op" id="1700787">(</span><span class="ident" id="1700788">addr</span><span class="op" id="1700792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1700795">xadd</span><span class="op" id="1700799">(</span><span class="ident" id="1700800">addr</span><span class="op" id="1700804">,</span>&nbsp;<span class="num" id="1700806">1</span><span class="op" id="1700807">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1700811">//&nbsp;Easy&nbsp;case:&nbsp;no&nbsp;waiters?</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1700838">//&nbsp;This&nbsp;check&nbsp;must&nbsp;happen&nbsp;after&nbsp;the&nbsp;xadd,&nbsp;to&nbsp;avoid&nbsp;a&nbsp;missed&nbsp;wakeup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1700906">//&nbsp;(see&nbsp;loop&nbsp;in&nbsp;semacquire).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1700936">if</span>&nbsp;<span class="ident" id="1700939">atomicload</span><span class="op" id="1700949">(</span><span class="op" id="1700950">&amp;</span><span class="ident" id="1700951">root</span><span class="op" id="1700955">.</span><span class="ident" id="1700956">nwait</span><span class="op" id="1700961">)</span>&nbsp;<span class="op" id="1700963">==</span>&nbsp;<span class="num" id="1700966">0</span>&nbsp;<span class="op" id="1700968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1700972">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1700980">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1700984">//&nbsp;Harder&nbsp;case:&nbsp;search&nbsp;for&nbsp;a&nbsp;waiter&nbsp;and&nbsp;wake&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1701034">lock</span><span class="op" id="1701038">(</span><span class="op" id="1701039">&amp;</span><span class="ident" id="1701040">root</span><span class="op" id="1701044">.</span><span class="ident" id="1701045">lock</span><span class="op" id="1701049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1701052">if</span>&nbsp;<span class="ident" id="1701055">atomicload</span><span class="op" id="1701065">(</span><span class="op" id="1701066">&amp;</span><span class="ident" id="1701067">root</span><span class="op" id="1701071">.</span><span class="ident" id="1701072">nwait</span><span class="op" id="1701077">)</span>&nbsp;<span class="op" id="1701079">==</span>&nbsp;<span class="num" id="1701082">0</span>&nbsp;<span class="op" id="1701084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1701088">//&nbsp;The&nbsp;count&nbsp;is&nbsp;already&nbsp;consumed&nbsp;by&nbsp;another&nbsp;goroutine,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1701145">//&nbsp;so&nbsp;no&nbsp;need&nbsp;to&nbsp;wake&nbsp;up&nbsp;another&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1701191">unlock</span><span class="op" id="1701197">(</span><span class="op" id="1701198">&amp;</span><span class="ident" id="1701199">root</span><span class="op" id="1701203">.</span><span class="ident" id="1701204">lock</span><span class="op" id="1701208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1701212">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1701220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1701223">s</span>&nbsp;<span class="op" id="1701225">:=</span>&nbsp;<span class="ident" id="1701228">root</span><span class="op" id="1701232">.</span><span class="ident" id="1701233">head</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1701239">for</span>&nbsp;<span class="op" id="1701243">;</span>&nbsp;<span class="ident" id="1701245">s</span>&nbsp;<span class="op" id="1701247">!=</span>&nbsp;<span class="ident" id="1701250">nil</span><span class="op" id="1701253">;</span>&nbsp;<span class="ident" id="1701255">s</span>&nbsp;<span class="op" id="1701257">=</span>&nbsp;<span class="ident" id="1701259">s</span><span class="op" id="1701260">.</span><span class="ident" id="1701261">next</span>&nbsp;<span class="op" id="1701266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1701270">if</span>&nbsp;<span class="ident" id="1701273">s</span><span class="op" id="1701274">.</span><span class="ident" id="1701275">elem</span>&nbsp;<span class="op" id="1701280">==</span>&nbsp;<span class="ident" id="1701283">unsafe</span><span class="op" id="1701289">.</span><span class="ident" id="1701290">Pointer</span><span class="op" id="1701297">(</span><span class="ident" id="1701298">addr</span><span class="op" id="1701302">)</span>&nbsp;<span class="op" id="1701304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1701309">xadd</span><span class="op" id="1701313">(</span><span class="op" id="1701314">&amp;</span><span class="ident" id="1701315">root</span><span class="op" id="1701319">.</span><span class="ident" id="1701320">nwait</span><span class="op" id="1701325">,</span>&nbsp;<span class="op" id="1701327">-</span><span class="num" id="1701328">1</span><span class="op" id="1701329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1701334">root</span><span class="op" id="1701338">.</span><span class="ident" id="1701339">dequeue</span><span class="op" id="1701346">(</span><span class="ident" id="1701347">s</span><span class="op" id="1701348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1701353">break</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1701361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1701364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1701367">unlock</span><span class="op" id="1701373">(</span><span class="op" id="1701374">&amp;</span><span class="ident" id="1701375">root</span><span class="op" id="1701379">.</span><span class="ident" id="1701380">lock</span><span class="op" id="1701384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1701387">if</span>&nbsp;<span class="ident" id="1701390">s</span>&nbsp;<span class="op" id="1701392">!=</span>&nbsp;<span class="ident" id="1701395">nil</span>&nbsp;<span class="op" id="1701399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1701403">if</span>&nbsp;<span class="ident" id="1701406">s</span><span class="op" id="1701407">.</span><span class="ident" id="1701408">releasetime</span>&nbsp;<span class="op" id="1701420">!=</span>&nbsp;<span class="num" id="1701423">0</span>&nbsp;<span class="op" id="1701425">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1701430">s</span><span class="op" id="1701431">.</span><span class="ident" id="1701432">releasetime</span>&nbsp;<span class="op" id="1701444">=</span>&nbsp;<span class="ident" id="1701446">cputicks</span><span class="op" id="1701454">(</span><span class="op" id="1701455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1701459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1701463">goready</span><span class="op" id="1701470">(</span><span class="ident" id="1701471">s</span><span class="op" id="1701472">.</span><span class="ident" id="1701473">g</span><span class="op" id="1701474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1701477">}</span><br>
<span class="lineno"></span><span class="op" id="1701479">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="1701482">func</span>&nbsp;<span class="ident" id="1701487">semroot</span><span class="op" id="1701494">(</span><span class="ident" id="1701495">addr</span>&nbsp;<span class="op" id="1701500">*</span><span class="builtintype" id="1701501">uint32</span><span class="op" id="1701507">)</span>&nbsp;<span class="op" id="1701509">*</span><span class="ident" id="1701510">semaRoot</span>&nbsp;<span class="op" id="1701519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1701522">return</span>&nbsp;<span class="op" id="1701529">&amp;</span><span class="ident" id="1701530">semtable</span><span class="op" id="1701538">[</span><span class="op" id="1701539">(</span><span class="builtintype" id="1701540">uintptr</span><span class="op" id="1701547">(</span><span class="ident" id="1701548">unsafe</span><span class="op" id="1701554">.</span><span class="ident" id="1701555">Pointer</span><span class="op" id="1701562">(</span><span class="ident" id="1701563">addr</span><span class="op" id="1701567">)</span><span class="op" id="1701568">)</span><span class="op" id="1701569">&gt;&gt;</span><span class="num" id="1701571">3</span><span class="op" id="1701572">)</span><span class="op" id="1701573">%</span><span class="ident" id="1701574">semTabSize</span><span class="op" id="1701584">]</span><span class="op" id="1701585">.</span><span class="ident" id="1701586">root</span><br>
<span class="lineno"></span><span class="op" id="1701591">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="1701594">func</span>&nbsp;<span class="ident" id="1701599">cansemacquire</span><span class="op" id="1701612">(</span><span class="ident" id="1701613">addr</span>&nbsp;<span class="op" id="1701618">*</span><span class="builtintype" id="1701619">uint32</span><span class="op" id="1701625">)</span>&nbsp;<span class="builtintype" id="1701627">bool</span>&nbsp;<span class="op" id="1701632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1701635">for</span>&nbsp;<span class="op" id="1701639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1701643">v</span>&nbsp;<span class="op" id="1701645">:=</span>&nbsp;<span class="ident" id="1701648">atomicload</span><span class="op" id="1701658">(</span><span class="ident" id="1701659">addr</span><span class="op" id="1701663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1701667">if</span>&nbsp;<span class="ident" id="1701670">v</span>&nbsp;<span class="op" id="1701672">==</span>&nbsp;<span class="num" id="1701675">0</span>&nbsp;<span class="op" id="1701677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1701682">return</span>&nbsp;<span class="builtintype" id="1701689">false</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1701697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1701701">if</span>&nbsp;<span class="ident" id="1701704">cas</span><span class="op" id="1701707">(</span><span class="ident" id="1701708">addr</span><span class="op" id="1701712">,</span>&nbsp;<span class="ident" id="1701714">v</span><span class="op" id="1701715">,</span>&nbsp;<span class="ident" id="1701717">v</span><span class="op" id="1701718">-</span><span class="num" id="1701719">1</span><span class="op" id="1701720">)</span>&nbsp;<span class="op" id="1701722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1701727">return</span>&nbsp;<span class="builtintype" id="1701734">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1701741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1701744">}</span><br>
<span class="lineno">150</span><span class="op" id="1701746">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1701749">func</span>&nbsp;<span class="op" id="1701754">(</span><span class="ident" id="1701755">root</span>&nbsp;<span class="op" id="1701760">*</span><span class="ident" id="1701761">semaRoot</span><span class="op" id="1701769">)</span>&nbsp;<span class="ident" id="1701771">queue</span><span class="op" id="1701776">(</span><span class="ident" id="1701777">addr</span>&nbsp;<span class="op" id="1701782">*</span><span class="builtintype" id="1701783">uint32</span><span class="op" id="1701789">,</span>&nbsp;<span class="ident" id="1701791">s</span>&nbsp;<span class="op" id="1701793">*</span><span class="ident" id="1701794">sudog</span><span class="op" id="1701799">)</span>&nbsp;<span class="op" id="1701801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1701804">s</span><span class="op" id="1701805">.</span><span class="ident" id="1701806">g</span>&nbsp;<span class="op" id="1701808">=</span>&nbsp;<span class="ident" id="1701810">getg</span><span class="op" id="1701814">(</span><span class="op" id="1701815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1701818">s</span><span class="op" id="1701819">.</span><span class="ident" id="1701820">elem</span>&nbsp;<span class="op" id="1701825">=</span>&nbsp;<span class="ident" id="1701827">unsafe</span><span class="op" id="1701833">.</span><span class="ident" id="1701834">Pointer</span><span class="op" id="1701841">(</span><span class="ident" id="1701842">addr</span><span class="op" id="1701846">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1701849">s</span><span class="op" id="1701850">.</span><span class="ident" id="1701851">next</span>&nbsp;<span class="op" id="1701856">=</span>&nbsp;<span class="ident" id="1701858">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1701863">s</span><span class="op" id="1701864">.</span><span class="ident" id="1701865">prev</span>&nbsp;<span class="op" id="1701870">=</span>&nbsp;<span class="ident" id="1701872">root</span><span class="op" id="1701876">.</span><span class="ident" id="1701877">tail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1701883">if</span>&nbsp;<span class="ident" id="1701886">root</span><span class="op" id="1701890">.</span><span class="ident" id="1701891">tail</span>&nbsp;<span class="op" id="1701896">!=</span>&nbsp;<span class="ident" id="1701899">nil</span>&nbsp;<span class="op" id="1701903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1701907">root</span><span class="op" id="1701911">.</span><span class="ident" id="1701912">tail</span><span class="op" id="1701916">.</span><span class="ident" id="1701917">next</span>&nbsp;<span class="op" id="1701922">=</span>&nbsp;<span class="ident" id="1701924">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1701927">}</span>&nbsp;<span class="keyword" id="1701929">else</span>&nbsp;<span class="op" id="1701934">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1701938">root</span><span class="op" id="1701942">.</span><span class="ident" id="1701943">head</span>&nbsp;<span class="op" id="1701948">=</span>&nbsp;<span class="ident" id="1701950">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1701953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1701956">root</span><span class="op" id="1701960">.</span><span class="ident" id="1701961">tail</span>&nbsp;<span class="op" id="1701966">=</span>&nbsp;<span class="ident" id="1701968">s</span><br>
<span class="lineno"></span><span class="op" id="1701970">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="1701973">func</span>&nbsp;<span class="op" id="1701978">(</span><span class="ident" id="1701979">root</span>&nbsp;<span class="op" id="1701984">*</span><span class="ident" id="1701985">semaRoot</span><span class="op" id="1701993">)</span>&nbsp;<span class="ident" id="1701995">dequeue</span><span class="op" id="1702002">(</span><span class="ident" id="1702003">s</span>&nbsp;<span class="op" id="1702005">*</span><span class="ident" id="1702006">sudog</span><span class="op" id="1702011">)</span>&nbsp;<span class="op" id="1702013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1702016">if</span>&nbsp;<span class="ident" id="1702019">s</span><span class="op" id="1702020">.</span><span class="ident" id="1702021">next</span>&nbsp;<span class="op" id="1702026">!=</span>&nbsp;<span class="ident" id="1702029">nil</span>&nbsp;<span class="op" id="1702033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702037">s</span><span class="op" id="1702038">.</span><span class="ident" id="1702039">next</span><span class="op" id="1702043">.</span><span class="ident" id="1702044">prev</span>&nbsp;<span class="op" id="1702049">=</span>&nbsp;<span class="ident" id="1702051">s</span><span class="op" id="1702052">.</span><span class="ident" id="1702053">prev</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1702059">}</span>&nbsp;<span class="keyword" id="1702061">else</span>&nbsp;<span class="op" id="1702066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702070">root</span><span class="op" id="1702074">.</span><span class="ident" id="1702075">tail</span>&nbsp;<span class="op" id="1702080">=</span>&nbsp;<span class="ident" id="1702082">s</span><span class="op" id="1702083">.</span><span class="ident" id="1702084">prev</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1702090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1702093">if</span>&nbsp;<span class="ident" id="1702096">s</span><span class="op" id="1702097">.</span><span class="ident" id="1702098">prev</span>&nbsp;<span class="op" id="1702103">!=</span>&nbsp;<span class="ident" id="1702106">nil</span>&nbsp;<span class="op" id="1702110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702114">s</span><span class="op" id="1702115">.</span><span class="ident" id="1702116">prev</span><span class="op" id="1702120">.</span><span class="ident" id="1702121">next</span>&nbsp;<span class="op" id="1702126">=</span>&nbsp;<span class="ident" id="1702128">s</span><span class="op" id="1702129">.</span><span class="ident" id="1702130">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1702136">}</span>&nbsp;<span class="keyword" id="1702138">else</span>&nbsp;<span class="op" id="1702143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702147">root</span><span class="op" id="1702151">.</span><span class="ident" id="1702152">head</span>&nbsp;<span class="op" id="1702157">=</span>&nbsp;<span class="ident" id="1702159">s</span><span class="op" id="1702160">.</span><span class="ident" id="1702161">next</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1702167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702170">s</span><span class="op" id="1702171">.</span><span class="ident" id="1702172">elem</span>&nbsp;<span class="op" id="1702177">=</span>&nbsp;<span class="ident" id="1702179">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702184">s</span><span class="op" id="1702185">.</span><span class="ident" id="1702186">next</span>&nbsp;<span class="op" id="1702191">=</span>&nbsp;<span class="ident" id="1702193">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702198">s</span><span class="op" id="1702199">.</span><span class="ident" id="1702200">prev</span>&nbsp;<span class="op" id="1702205">=</span>&nbsp;<span class="ident" id="1702207">nil</span><br>
<span class="lineno"></span><span class="op" id="1702211">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="comment" id="1702214">//&nbsp;Synchronous&nbsp;semaphore&nbsp;for&nbsp;sync.Cond.</span><br>
<span class="lineno"></span><span class="keyword" id="1702254">type</span>&nbsp;<span class="ident" id="1702259">syncSema</span>&nbsp;<span class="keyword" id="1702268">struct</span>&nbsp;<span class="op" id="1702275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702278">lock</span>&nbsp;<span class="ident" id="1702283">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702290">head</span>&nbsp;<span class="op" id="1702295">*</span><span class="ident" id="1702296">sudog</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702303">tail</span>&nbsp;<span class="op" id="1702308">*</span><span class="ident" id="1702309">sudog</span><br>
<span class="lineno"></span><span class="op" id="1702315">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1702318">//&nbsp;Syncsemacquire&nbsp;waits&nbsp;for&nbsp;a&nbsp;pairing&nbsp;syncsemrelease&nbsp;on&nbsp;the&nbsp;same&nbsp;semaphore&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="1702396">func</span>&nbsp;<span class="ident" id="1702401">syncsemacquire</span><span class="op" id="1702415">(</span><span class="ident" id="1702416">s</span>&nbsp;<span class="op" id="1702418">*</span><span class="ident" id="1702419">syncSema</span><span class="op" id="1702427">)</span>&nbsp;<span class="op" id="1702429">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702432">lock</span><span class="op" id="1702436">(</span><span class="op" id="1702437">&amp;</span><span class="ident" id="1702438">s</span><span class="op" id="1702439">.</span><span class="ident" id="1702440">lock</span><span class="op" id="1702444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1702447">if</span>&nbsp;<span class="ident" id="1702450">s</span><span class="op" id="1702451">.</span><span class="ident" id="1702452">head</span>&nbsp;<span class="op" id="1702457">!=</span>&nbsp;<span class="ident" id="1702460">nil</span>&nbsp;<span class="op" id="1702464">&amp;&amp;</span>&nbsp;<span class="ident" id="1702467">s</span><span class="op" id="1702468">.</span><span class="ident" id="1702469">head</span><span class="op" id="1702473">.</span><span class="ident" id="1702474">nrelease</span>&nbsp;<span class="op" id="1702483">&gt;</span>&nbsp;<span class="num" id="1702485">0</span>&nbsp;<span class="op" id="1702487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1702491">//&nbsp;Have&nbsp;pending&nbsp;release,&nbsp;consume&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1702530">var</span>&nbsp;<span class="ident" id="1702534">wake</span>&nbsp;<span class="op" id="1702539">*</span><span class="ident" id="1702540">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702548">s</span><span class="op" id="1702549">.</span><span class="ident" id="1702550">head</span><span class="op" id="1702554">.</span><span class="ident" id="1702555">nrelease</span><span class="op" id="1702563">--</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1702568">if</span>&nbsp;<span class="ident" id="1702571">s</span><span class="op" id="1702572">.</span><span class="ident" id="1702573">head</span><span class="op" id="1702577">.</span><span class="ident" id="1702578">nrelease</span>&nbsp;<span class="op" id="1702587">==</span>&nbsp;<span class="num" id="1702590">0</span>&nbsp;<span class="op" id="1702592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702597">wake</span>&nbsp;<span class="op" id="1702602">=</span>&nbsp;<span class="ident" id="1702604">s</span><span class="op" id="1702605">.</span><span class="ident" id="1702606">head</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702614">s</span><span class="op" id="1702615">.</span><span class="ident" id="1702616">head</span>&nbsp;<span class="op" id="1702621">=</span>&nbsp;<span class="ident" id="1702623">wake</span><span class="op" id="1702627">.</span><span class="ident" id="1702628">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1702636">if</span>&nbsp;<span class="ident" id="1702639">s</span><span class="op" id="1702640">.</span><span class="ident" id="1702641">head</span>&nbsp;<span class="op" id="1702646">==</span>&nbsp;<span class="ident" id="1702649">nil</span>&nbsp;<span class="op" id="1702653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702659">s</span><span class="op" id="1702660">.</span><span class="ident" id="1702661">tail</span>&nbsp;<span class="op" id="1702666">=</span>&nbsp;<span class="ident" id="1702668">nil</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1702675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1702679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702683">unlock</span><span class="op" id="1702689">(</span><span class="op" id="1702690">&amp;</span><span class="ident" id="1702691">s</span><span class="op" id="1702692">.</span><span class="ident" id="1702693">lock</span><span class="op" id="1702697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1702701">if</span>&nbsp;<span class="ident" id="1702704">wake</span>&nbsp;<span class="op" id="1702709">!=</span>&nbsp;<span class="ident" id="1702712">nil</span>&nbsp;<span class="op" id="1702716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702721">wake</span><span class="op" id="1702725">.</span><span class="ident" id="1702726">next</span>&nbsp;<span class="op" id="1702731">=</span>&nbsp;<span class="ident" id="1702733">nil</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702740">goready</span><span class="op" id="1702747">(</span><span class="ident" id="1702748">wake</span><span class="op" id="1702752">.</span><span class="ident" id="1702753">g</span><span class="op" id="1702754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1702758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1702761">}</span>&nbsp;<span class="keyword" id="1702763">else</span>&nbsp;<span class="op" id="1702768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1702772">//&nbsp;Enqueue&nbsp;itself.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702793">w</span>&nbsp;<span class="op" id="1702795">:=</span>&nbsp;<span class="ident" id="1702798">acquireSudog</span><span class="op" id="1702810">(</span><span class="op" id="1702811">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702815">w</span><span class="op" id="1702816">.</span><span class="ident" id="1702817">g</span>&nbsp;<span class="op" id="1702819">=</span>&nbsp;<span class="ident" id="1702821">getg</span><span class="op" id="1702825">(</span><span class="op" id="1702826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702830">w</span><span class="op" id="1702831">.</span><span class="ident" id="1702832">nrelease</span>&nbsp;<span class="op" id="1702841">=</span>&nbsp;<span class="op" id="1702843">-</span><span class="num" id="1702844">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702848">w</span><span class="op" id="1702849">.</span><span class="ident" id="1702850">next</span>&nbsp;<span class="op" id="1702855">=</span>&nbsp;<span class="ident" id="1702857">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702863">w</span><span class="op" id="1702864">.</span><span class="ident" id="1702865">releasetime</span>&nbsp;<span class="op" id="1702877">=</span>&nbsp;<span class="num" id="1702879">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702883">t0</span>&nbsp;<span class="op" id="1702886">:=</span>&nbsp;<span class="ident" id="1702889">int64</span><span class="op" id="1702894">(</span><span class="num" id="1702895">0</span><span class="op" id="1702896">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1702900">if</span>&nbsp;<span class="ident" id="1702903">blockprofilerate</span>&nbsp;<span class="op" id="1702920">&gt;</span>&nbsp;<span class="num" id="1702922">0</span>&nbsp;<span class="op" id="1702924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702929">t0</span>&nbsp;<span class="op" id="1702932">=</span>&nbsp;<span class="ident" id="1702934">cputicks</span><span class="op" id="1702942">(</span><span class="op" id="1702943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702948">w</span><span class="op" id="1702949">.</span><span class="ident" id="1702950">releasetime</span>&nbsp;<span class="op" id="1702962">=</span>&nbsp;<span class="op" id="1702964">-</span><span class="num" id="1702965">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1702969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1702973">if</span>&nbsp;<span class="ident" id="1702976">s</span><span class="op" id="1702977">.</span><span class="ident" id="1702978">tail</span>&nbsp;<span class="op" id="1702983">==</span>&nbsp;<span class="ident" id="1702986">nil</span>&nbsp;<span class="op" id="1702990">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702995">s</span><span class="op" id="1702996">.</span><span class="ident" id="1702997">head</span>&nbsp;<span class="op" id="1703002">=</span>&nbsp;<span class="ident" id="1703004">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1703008">}</span>&nbsp;<span class="keyword" id="1703010">else</span>&nbsp;<span class="op" id="1703015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1703020">s</span><span class="op" id="1703021">.</span><span class="ident" id="1703022">tail</span><span class="op" id="1703026">.</span><span class="ident" id="1703027">next</span>&nbsp;<span class="op" id="1703032">=</span>&nbsp;<span class="ident" id="1703034">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1703038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1703042">s</span><span class="op" id="1703043">.</span><span class="ident" id="1703044">tail</span>&nbsp;<span class="op" id="1703049">=</span>&nbsp;<span class="ident" id="1703051">w</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1703055">goparkunlock</span><span class="op" id="1703067">(</span><span class="op" id="1703068">&amp;</span><span class="ident" id="1703069">s</span><span class="op" id="1703070">.</span><span class="ident" id="1703071">lock</span><span class="op" id="1703075">,</span>&nbsp;<span class="string" id="1703077">&#34;semacquire&#34;</span><span class="op" id="1703089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1703093">if</span>&nbsp;<span class="ident" id="1703096">t0</span>&nbsp;<span class="op" id="1703099">!=</span>&nbsp;<span class="num" id="1703102">0</span>&nbsp;<span class="op" id="1703104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1703109">blockevent</span><span class="op" id="1703119">(</span><span class="ident" id="1703120">int64</span><span class="op" id="1703125">(</span><span class="ident" id="1703126">w</span><span class="op" id="1703127">.</span><span class="ident" id="1703128">releasetime</span><span class="op" id="1703139">)</span><span class="op" id="1703140">-</span><span class="ident" id="1703141">t0</span><span class="op" id="1703143">,</span>&nbsp;<span class="num" id="1703145">2</span><span class="op" id="1703146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1703150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1703154">releaseSudog</span><span class="op" id="1703166">(</span><span class="ident" id="1703167">w</span><span class="op" id="1703168">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1703171">}</span><br>
<span class="lineno"></span><span class="op" id="1703173">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1703176">//&nbsp;Syncsemrelease&nbsp;waits&nbsp;for&nbsp;n&nbsp;pairing&nbsp;syncsemacquire&nbsp;on&nbsp;the&nbsp;same&nbsp;semaphore&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="1703254">func</span>&nbsp;<span class="ident" id="1703259">syncsemrelease</span><span class="op" id="1703273">(</span><span class="ident" id="1703274">s</span>&nbsp;<span class="op" id="1703276">*</span><span class="ident" id="1703277">syncSema</span><span class="op" id="1703285">,</span>&nbsp;<span class="ident" id="1703287">n</span>&nbsp;<span class="builtintype" id="1703289">uint32</span><span class="op" id="1703295">)</span>&nbsp;<span class="op" id="1703297">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1703300">lock</span><span class="op" id="1703304">(</span><span class="op" id="1703305">&amp;</span><span class="ident" id="1703306">s</span><span class="op" id="1703307">.</span><span class="ident" id="1703308">lock</span><span class="op" id="1703312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1703315">for</span>&nbsp;<span class="ident" id="1703319">n</span>&nbsp;<span class="op" id="1703321">&gt;</span>&nbsp;<span class="num" id="1703323">0</span>&nbsp;<span class="op" id="1703325">&amp;&amp;</span>&nbsp;<span class="ident" id="1703328">s</span><span class="op" id="1703329">.</span><span class="ident" id="1703330">head</span>&nbsp;<span class="op" id="1703335">!=</span>&nbsp;<span class="ident" id="1703338">nil</span>&nbsp;<span class="op" id="1703342">&amp;&amp;</span>&nbsp;<span class="ident" id="1703345">s</span><span class="op" id="1703346">.</span><span class="ident" id="1703347">head</span><span class="op" id="1703351">.</span><span class="ident" id="1703352">nrelease</span>&nbsp;<span class="op" id="1703361">&lt;</span>&nbsp;<span class="num" id="1703363">0</span>&nbsp;<span class="op" id="1703365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1703369">//&nbsp;Have&nbsp;pending&nbsp;acquire,&nbsp;satisfy&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1703408">wake</span>&nbsp;<span class="op" id="1703413">:=</span>&nbsp;<span class="ident" id="1703416">s</span><span class="op" id="1703417">.</span><span class="ident" id="1703418">head</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1703425">s</span><span class="op" id="1703426">.</span><span class="ident" id="1703427">head</span>&nbsp;<span class="op" id="1703432">=</span>&nbsp;<span class="ident" id="1703434">wake</span><span class="op" id="1703438">.</span><span class="ident" id="1703439">next</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1703446">if</span>&nbsp;<span class="ident" id="1703449">s</span><span class="op" id="1703450">.</span><span class="ident" id="1703451">head</span>&nbsp;<span class="op" id="1703456">==</span>&nbsp;<span class="ident" id="1703459">nil</span>&nbsp;<span class="op" id="1703463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1703468">s</span><span class="op" id="1703469">.</span><span class="ident" id="1703470">tail</span>&nbsp;<span class="op" id="1703475">=</span>&nbsp;<span class="ident" id="1703477">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1703483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1703487">if</span>&nbsp;<span class="ident" id="1703490">wake</span><span class="op" id="1703494">.</span><span class="ident" id="1703495">releasetime</span>&nbsp;<span class="op" id="1703507">!=</span>&nbsp;<span class="num" id="1703510">0</span>&nbsp;<span class="op" id="1703512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1703517">wake</span><span class="op" id="1703521">.</span><span class="ident" id="1703522">releasetime</span>&nbsp;<span class="op" id="1703534">=</span>&nbsp;<span class="ident" id="1703536">cputicks</span><span class="op" id="1703544">(</span><span class="op" id="1703545">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1703549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1703553">wake</span><span class="op" id="1703557">.</span><span class="ident" id="1703558">next</span>&nbsp;<span class="op" id="1703563">=</span>&nbsp;<span class="ident" id="1703565">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1703571">goready</span><span class="op" id="1703578">(</span><span class="ident" id="1703579">wake</span><span class="op" id="1703583">.</span><span class="ident" id="1703584">g</span><span class="op" id="1703585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1703589">n</span><span class="op" id="1703590">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1703594">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1703597">if</span>&nbsp;<span class="ident" id="1703600">n</span>&nbsp;<span class="op" id="1703602">&gt;</span>&nbsp;<span class="num" id="1703604">0</span>&nbsp;<span class="op" id="1703606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1703610">//&nbsp;enqueue&nbsp;itself</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1703630">w</span>&nbsp;<span class="op" id="1703632">:=</span>&nbsp;<span class="ident" id="1703635">acquireSudog</span><span class="op" id="1703647">(</span><span class="op" id="1703648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1703652">w</span><span class="op" id="1703653">.</span><span class="ident" id="1703654">g</span>&nbsp;<span class="op" id="1703656">=</span>&nbsp;<span class="ident" id="1703658">getg</span><span class="op" id="1703662">(</span><span class="op" id="1703663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1703667">w</span><span class="op" id="1703668">.</span><span class="ident" id="1703669">nrelease</span>&nbsp;<span class="op" id="1703678">=</span>&nbsp;<span class="builtintype" id="1703680">int32</span><span class="op" id="1703685">(</span><span class="ident" id="1703686">n</span><span class="op" id="1703687">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1703691">w</span><span class="op" id="1703692">.</span><span class="ident" id="1703693">next</span>&nbsp;<span class="op" id="1703698">=</span>&nbsp;<span class="ident" id="1703700">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1703706">w</span><span class="op" id="1703707">.</span><span class="ident" id="1703708">releasetime</span>&nbsp;<span class="op" id="1703720">=</span>&nbsp;<span class="num" id="1703722">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1703726">if</span>&nbsp;<span class="ident" id="1703729">s</span><span class="op" id="1703730">.</span><span class="ident" id="1703731">tail</span>&nbsp;<span class="op" id="1703736">==</span>&nbsp;<span class="ident" id="1703739">nil</span>&nbsp;<span class="op" id="1703743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1703748">s</span><span class="op" id="1703749">.</span><span class="ident" id="1703750">head</span>&nbsp;<span class="op" id="1703755">=</span>&nbsp;<span class="ident" id="1703757">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1703761">}</span>&nbsp;<span class="keyword" id="1703763">else</span>&nbsp;<span class="op" id="1703768">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1703773">s</span><span class="op" id="1703774">.</span><span class="ident" id="1703775">tail</span><span class="op" id="1703779">.</span><span class="ident" id="1703780">next</span>&nbsp;<span class="op" id="1703785">=</span>&nbsp;<span class="ident" id="1703787">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1703791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1703795">s</span><span class="op" id="1703796">.</span><span class="ident" id="1703797">tail</span>&nbsp;<span class="op" id="1703802">=</span>&nbsp;<span class="ident" id="1703804">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1703808">goparkunlock</span><span class="op" id="1703820">(</span><span class="op" id="1703821">&amp;</span><span class="ident" id="1703822">s</span><span class="op" id="1703823">.</span><span class="ident" id="1703824">lock</span><span class="op" id="1703828">,</span>&nbsp;<span class="string" id="1703830">&#34;semarelease&#34;</span><span class="op" id="1703843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1703847">releaseSudog</span><span class="op" id="1703859">(</span><span class="ident" id="1703860">w</span><span class="op" id="1703861">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1703864">}</span>&nbsp;<span class="keyword" id="1703866">else</span>&nbsp;<span class="op" id="1703871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1703875">unlock</span><span class="op" id="1703881">(</span><span class="op" id="1703882">&amp;</span><span class="ident" id="1703883">s</span><span class="op" id="1703884">.</span><span class="ident" id="1703885">lock</span><span class="op" id="1703889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1703892">}</span><br>
<span class="lineno"></span><span class="op" id="1703894">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="keyword" id="1703897">func</span>&nbsp;<span class="ident" id="1703902">syncsemcheck</span><span class="op" id="1703914">(</span><span class="ident" id="1703915">sz</span>&nbsp;<span class="builtintype" id="1703918">uintptr</span><span class="op" id="1703925">)</span>&nbsp;<span class="op" id="1703927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1703930">if</span>&nbsp;<span class="ident" id="1703933">sz</span>&nbsp;<span class="op" id="1703936">!=</span>&nbsp;<span class="ident" id="1703939">unsafe</span><span class="op" id="1703945">.</span><span class="ident" id="1703946">Sizeof</span><span class="op" id="1703952">(</span><span class="ident" id="1703953">syncSema</span><span class="op" id="1703961">{</span><span class="op" id="1703962">}</span><span class="op" id="1703963">)</span>&nbsp;<span class="op" id="1703965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1703969">print</span><span class="op" id="1703974">(</span><span class="string" id="1703975">&#34;runtime:&nbsp;bad&nbsp;syncSema&nbsp;size&nbsp;-&nbsp;sync=&#34;</span><span class="op" id="1704011">,</span>&nbsp;<span class="ident" id="1704013">sz</span><span class="op" id="1704015">,</span>&nbsp;<span class="string" id="1704017">&#34;&nbsp;runtime=&#34;</span><span class="op" id="1704028">,</span>&nbsp;<span class="ident" id="1704030">unsafe</span><span class="op" id="1704036">.</span><span class="ident" id="1704037">Sizeof</span><span class="op" id="1704043">(</span><span class="ident" id="1704044">syncSema</span><span class="op" id="1704052">{</span><span class="op" id="1704053">}</span><span class="op" id="1704054">)</span><span class="op" id="1704055">,</span>&nbsp;<span class="string" id="1704057">&#34;\n&#34;</span><span class="op" id="1704061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1704065">gothrow</span><span class="op" id="1704072">(</span><span class="string" id="1704073">&#34;bad&nbsp;syncSema&nbsp;size&#34;</span><span class="op" id="1704092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1704095">}</span><br>
<span class="lineno">275</span><span class="op" id="1704097">}</span>
</div>
</body>
</html>
