<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7965819">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7965874">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7965928">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7965979">package</span>&nbsp;<span class="ident" id="7965987">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7965992">import</span>&nbsp;<span class="op" id="7965999">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7966002">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7966009">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7966015">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7966026">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7966037">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7966045">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7966056">&#34;time&#34;</span><br>
<span class="lineno">15</span><span class="op" id="7966063">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7966066">func</span>&nbsp;<span class="ident" id="7966071">BenchmarkTCP4OneShot</span><span class="op" id="7966091">(</span><span class="ident" id="7966092">b</span>&nbsp;<span class="op" id="7966094">*</span><span class="ident" id="7966095">testing</span><span class="op" id="7966102">.</span><span class="ident" id="7966103">B</span><span class="op" id="7966104">)</span>&nbsp;<span class="op" id="7966106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7966109">benchmarkTCP</span><span class="op" id="7966121">(</span><span class="ident" id="7966122">b</span><span class="op" id="7966123">,</span>&nbsp;<span class="builtintype" id="7966125">false</span><span class="op" id="7966130">,</span>&nbsp;<span class="builtintype" id="7966132">false</span><span class="op" id="7966137">,</span>&nbsp;<span class="string" id="7966139">&#34;127.0.0.1:0&#34;</span><span class="op" id="7966152">)</span><br>
<span class="lineno"></span><span class="op" id="7966154">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="7966157">func</span>&nbsp;<span class="ident" id="7966162">BenchmarkTCP4OneShotTimeout</span><span class="op" id="7966189">(</span><span class="ident" id="7966190">b</span>&nbsp;<span class="op" id="7966192">*</span><span class="ident" id="7966193">testing</span><span class="op" id="7966200">.</span><span class="ident" id="7966201">B</span><span class="op" id="7966202">)</span>&nbsp;<span class="op" id="7966204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7966207">benchmarkTCP</span><span class="op" id="7966219">(</span><span class="ident" id="7966220">b</span><span class="op" id="7966221">,</span>&nbsp;<span class="builtintype" id="7966223">false</span><span class="op" id="7966228">,</span>&nbsp;<span class="builtintype" id="7966230">true</span><span class="op" id="7966234">,</span>&nbsp;<span class="string" id="7966236">&#34;127.0.0.1:0&#34;</span><span class="op" id="7966249">)</span><br>
<span class="lineno"></span><span class="op" id="7966251">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="7966254">func</span>&nbsp;<span class="ident" id="7966259">BenchmarkTCP4Persistent</span><span class="op" id="7966282">(</span><span class="ident" id="7966283">b</span>&nbsp;<span class="op" id="7966285">*</span><span class="ident" id="7966286">testing</span><span class="op" id="7966293">.</span><span class="ident" id="7966294">B</span><span class="op" id="7966295">)</span>&nbsp;<span class="op" id="7966297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7966300">benchmarkTCP</span><span class="op" id="7966312">(</span><span class="ident" id="7966313">b</span><span class="op" id="7966314">,</span>&nbsp;<span class="builtintype" id="7966316">true</span><span class="op" id="7966320">,</span>&nbsp;<span class="builtintype" id="7966322">false</span><span class="op" id="7966327">,</span>&nbsp;<span class="string" id="7966329">&#34;127.0.0.1:0&#34;</span><span class="op" id="7966342">)</span><br>
<span class="lineno"></span><span class="op" id="7966344">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7966347">func</span>&nbsp;<span class="ident" id="7966352">BenchmarkTCP4PersistentTimeout</span><span class="op" id="7966382">(</span><span class="ident" id="7966383">b</span>&nbsp;<span class="op" id="7966385">*</span><span class="ident" id="7966386">testing</span><span class="op" id="7966393">.</span><span class="ident" id="7966394">B</span><span class="op" id="7966395">)</span>&nbsp;<span class="op" id="7966397">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7966400">benchmarkTCP</span><span class="op" id="7966412">(</span><span class="ident" id="7966413">b</span><span class="op" id="7966414">,</span>&nbsp;<span class="builtintype" id="7966416">true</span><span class="op" id="7966420">,</span>&nbsp;<span class="builtintype" id="7966422">true</span><span class="op" id="7966426">,</span>&nbsp;<span class="string" id="7966428">&#34;127.0.0.1:0&#34;</span><span class="op" id="7966441">)</span><br>
<span class="lineno"></span><span class="op" id="7966443">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7966446">func</span>&nbsp;<span class="ident" id="7966451">BenchmarkTCP6OneShot</span><span class="op" id="7966471">(</span><span class="ident" id="7966472">b</span>&nbsp;<span class="op" id="7966474">*</span><span class="ident" id="7966475">testing</span><span class="op" id="7966482">.</span><span class="ident" id="7966483">B</span><span class="op" id="7966484">)</span>&nbsp;<span class="op" id="7966486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7966489">if</span>&nbsp;<span class="op" id="7966492">!</span><span class="ident" id="7966493">supportsIPv6</span>&nbsp;<span class="op" id="7966506">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7966510">b</span><span class="op" id="7966511">.</span><span class="ident" id="7966512">Skip</span><span class="op" id="7966516">(</span><span class="string" id="7966517">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="7966540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7966543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7966546">benchmarkTCP</span><span class="op" id="7966558">(</span><span class="ident" id="7966559">b</span><span class="op" id="7966560">,</span>&nbsp;<span class="builtintype" id="7966562">false</span><span class="op" id="7966567">,</span>&nbsp;<span class="builtintype" id="7966569">false</span><span class="op" id="7966574">,</span>&nbsp;<span class="string" id="7966576">&#34;[::1]:0&#34;</span><span class="op" id="7966585">)</span><br>
<span class="lineno"></span><span class="op" id="7966587">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="7966590">func</span>&nbsp;<span class="ident" id="7966595">BenchmarkTCP6OneShotTimeout</span><span class="op" id="7966622">(</span><span class="ident" id="7966623">b</span>&nbsp;<span class="op" id="7966625">*</span><span class="ident" id="7966626">testing</span><span class="op" id="7966633">.</span><span class="ident" id="7966634">B</span><span class="op" id="7966635">)</span>&nbsp;<span class="op" id="7966637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7966640">if</span>&nbsp;<span class="op" id="7966643">!</span><span class="ident" id="7966644">supportsIPv6</span>&nbsp;<span class="op" id="7966657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7966661">b</span><span class="op" id="7966662">.</span><span class="ident" id="7966663">Skip</span><span class="op" id="7966667">(</span><span class="string" id="7966668">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="7966691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7966694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7966697">benchmarkTCP</span><span class="op" id="7966709">(</span><span class="ident" id="7966710">b</span><span class="op" id="7966711">,</span>&nbsp;<span class="builtintype" id="7966713">false</span><span class="op" id="7966718">,</span>&nbsp;<span class="builtintype" id="7966720">true</span><span class="op" id="7966724">,</span>&nbsp;<span class="string" id="7966726">&#34;[::1]:0&#34;</span><span class="op" id="7966735">)</span><br>
<span class="lineno">45</span><span class="op" id="7966737">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7966740">func</span>&nbsp;<span class="ident" id="7966745">BenchmarkTCP6Persistent</span><span class="op" id="7966768">(</span><span class="ident" id="7966769">b</span>&nbsp;<span class="op" id="7966771">*</span><span class="ident" id="7966772">testing</span><span class="op" id="7966779">.</span><span class="ident" id="7966780">B</span><span class="op" id="7966781">)</span>&nbsp;<span class="op" id="7966783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7966786">if</span>&nbsp;<span class="op" id="7966789">!</span><span class="ident" id="7966790">supportsIPv6</span>&nbsp;<span class="op" id="7966803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7966807">b</span><span class="op" id="7966808">.</span><span class="ident" id="7966809">Skip</span><span class="op" id="7966813">(</span><span class="string" id="7966814">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="7966837">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7966840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7966843">benchmarkTCP</span><span class="op" id="7966855">(</span><span class="ident" id="7966856">b</span><span class="op" id="7966857">,</span>&nbsp;<span class="builtintype" id="7966859">true</span><span class="op" id="7966863">,</span>&nbsp;<span class="builtintype" id="7966865">false</span><span class="op" id="7966870">,</span>&nbsp;<span class="string" id="7966872">&#34;[::1]:0&#34;</span><span class="op" id="7966881">)</span><br>
<span class="lineno"></span><span class="op" id="7966883">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7966886">func</span>&nbsp;<span class="ident" id="7966891">BenchmarkTCP6PersistentTimeout</span><span class="op" id="7966921">(</span><span class="ident" id="7966922">b</span>&nbsp;<span class="op" id="7966924">*</span><span class="ident" id="7966925">testing</span><span class="op" id="7966932">.</span><span class="ident" id="7966933">B</span><span class="op" id="7966934">)</span>&nbsp;<span class="op" id="7966936">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7966939">if</span>&nbsp;<span class="op" id="7966942">!</span><span class="ident" id="7966943">supportsIPv6</span>&nbsp;<span class="op" id="7966956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7966960">b</span><span class="op" id="7966961">.</span><span class="ident" id="7966962">Skip</span><span class="op" id="7966966">(</span><span class="string" id="7966967">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="7966990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7966993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7966996">benchmarkTCP</span><span class="op" id="7967008">(</span><span class="ident" id="7967009">b</span><span class="op" id="7967010">,</span>&nbsp;<span class="builtintype" id="7967012">true</span><span class="op" id="7967016">,</span>&nbsp;<span class="builtintype" id="7967018">true</span><span class="op" id="7967022">,</span>&nbsp;<span class="string" id="7967024">&#34;[::1]:0&#34;</span><span class="op" id="7967033">)</span><br>
<span class="lineno"></span><span class="op" id="7967035">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="7967038">func</span>&nbsp;<span class="ident" id="7967043">benchmarkTCP</span><span class="op" id="7967055">(</span><span class="ident" id="7967056">b</span>&nbsp;<span class="op" id="7967058">*</span><span class="ident" id="7967059">testing</span><span class="op" id="7967066">.</span><span class="ident" id="7967067">B</span><span class="op" id="7967068">,</span>&nbsp;<span class="ident" id="7967070">persistent</span><span class="op" id="7967080">,</span>&nbsp;<span class="ident" id="7967082">timeout</span>&nbsp;<span class="builtintype" id="7967090">bool</span><span class="op" id="7967094">,</span>&nbsp;<span class="ident" id="7967096">laddr</span>&nbsp;<span class="builtintype" id="7967102">string</span><span class="op" id="7967108">)</span>&nbsp;<span class="op" id="7967110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7967113">const</span>&nbsp;<span class="ident" id="7967119">msgLen</span>&nbsp;<span class="op" id="7967126">=</span>&nbsp;<span class="num" id="7967128">512</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7967133">conns</span>&nbsp;<span class="op" id="7967139">:=</span>&nbsp;<span class="ident" id="7967142">b</span><span class="op" id="7967143">.</span><span class="ident" id="7967144">N</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7967147">numConcurrent</span>&nbsp;<span class="op" id="7967161">:=</span>&nbsp;<span class="ident" id="7967164">runtime</span><span class="op" id="7967171">.</span><span class="ident" id="7967172">GOMAXPROCS</span><span class="op" id="7967182">(</span><span class="op" id="7967183">-</span><span class="num" id="7967184">1</span><span class="op" id="7967185">)</span>&nbsp;<span class="op" id="7967187">*</span>&nbsp;<span class="num" id="7967189">2</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7967192">msgs</span>&nbsp;<span class="op" id="7967197">:=</span>&nbsp;<span class="num" id="7967200">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7967203">if</span>&nbsp;<span class="ident" id="7967206">persistent</span>&nbsp;<span class="op" id="7967217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7967221">conns</span>&nbsp;<span class="op" id="7967227">=</span>&nbsp;<span class="ident" id="7967229">numConcurrent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7967245">msgs</span>&nbsp;<span class="op" id="7967250">=</span>&nbsp;<span class="ident" id="7967252">b</span><span class="op" id="7967253">.</span><span class="ident" id="7967254">N</span>&nbsp;<span class="op" id="7967256">/</span>&nbsp;<span class="ident" id="7967258">conns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7967266">if</span>&nbsp;<span class="ident" id="7967269">msgs</span>&nbsp;<span class="op" id="7967274">==</span>&nbsp;<span class="num" id="7967277">0</span>&nbsp;<span class="op" id="7967279">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7967284">msgs</span>&nbsp;<span class="op" id="7967289">=</span>&nbsp;<span class="num" id="7967291">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7967295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7967299">if</span>&nbsp;<span class="ident" id="7967302">conns</span>&nbsp;<span class="op" id="7967308">&gt;</span>&nbsp;<span class="ident" id="7967310">b</span><span class="op" id="7967311">.</span><span class="ident" id="7967312">N</span>&nbsp;<span class="op" id="7967314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7967319">conns</span>&nbsp;<span class="op" id="7967325">=</span>&nbsp;<span class="ident" id="7967327">b</span><span class="op" id="7967328">.</span><span class="ident" id="7967329">N</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7967333">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7967336">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7967339">sendMsg</span>&nbsp;<span class="op" id="7967347">:=</span>&nbsp;<span class="keyword" id="7967350">func</span><span class="op" id="7967354">(</span><span class="ident" id="7967355">c</span>&nbsp;<span class="ident" id="7967357">Conn</span><span class="op" id="7967361">,</span>&nbsp;<span class="ident" id="7967363">buf</span>&nbsp;<span class="op" id="7967367">[</span><span class="op" id="7967368">]</span><span class="builtintype" id="7967369">byte</span><span class="op" id="7967373">)</span>&nbsp;<span class="builtintype" id="7967375">bool</span>&nbsp;<span class="op" id="7967380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7967384">n</span><span class="op" id="7967385">,</span>&nbsp;<span class="ident" id="7967387">err</span>&nbsp;<span class="op" id="7967391">:=</span>&nbsp;<span class="ident" id="7967394">c</span><span class="op" id="7967395">.</span><span class="ident" id="7967396">Write</span><span class="op" id="7967401">(</span><span class="ident" id="7967402">buf</span><span class="op" id="7967405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7967409">if</span>&nbsp;<span class="ident" id="7967412">n</span>&nbsp;<span class="op" id="7967414">!=</span>&nbsp;<span class="builtinfunc" id="7967417">len</span><span class="op" id="7967420">(</span><span class="ident" id="7967421">buf</span><span class="op" id="7967424">)</span>&nbsp;<span class="op" id="7967426">||</span>&nbsp;<span class="ident" id="7967429">err</span>&nbsp;<span class="op" id="7967433">!=</span>&nbsp;<span class="ident" id="7967436">nil</span>&nbsp;<span class="op" id="7967440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7967445">b</span><span class="op" id="7967446">.</span><span class="ident" id="7967447">Logf</span><span class="op" id="7967451">(</span><span class="string" id="7967452">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7967470">,</span>&nbsp;<span class="ident" id="7967472">err</span><span class="op" id="7967475">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7967480">return</span>&nbsp;<span class="builtintype" id="7967487">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7967495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7967499">return</span>&nbsp;<span class="builtintype" id="7967506">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7967512">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7967515">recvMsg</span>&nbsp;<span class="op" id="7967523">:=</span>&nbsp;<span class="keyword" id="7967526">func</span><span class="op" id="7967530">(</span><span class="ident" id="7967531">c</span>&nbsp;<span class="ident" id="7967533">Conn</span><span class="op" id="7967537">,</span>&nbsp;<span class="ident" id="7967539">buf</span>&nbsp;<span class="op" id="7967543">[</span><span class="op" id="7967544">]</span><span class="builtintype" id="7967545">byte</span><span class="op" id="7967549">)</span>&nbsp;<span class="builtintype" id="7967551">bool</span>&nbsp;<span class="op" id="7967556">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7967560">for</span>&nbsp;<span class="ident" id="7967564">read</span>&nbsp;<span class="op" id="7967569">:=</span>&nbsp;<span class="num" id="7967572">0</span><span class="op" id="7967573">;</span>&nbsp;<span class="ident" id="7967575">read</span>&nbsp;<span class="op" id="7967580">!=</span>&nbsp;<span class="builtinfunc" id="7967583">len</span><span class="op" id="7967586">(</span><span class="ident" id="7967587">buf</span><span class="op" id="7967590">)</span><span class="op" id="7967591">;</span>&nbsp;<span class="op" id="7967593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7967598">n</span><span class="op" id="7967599">,</span>&nbsp;<span class="ident" id="7967601">err</span>&nbsp;<span class="op" id="7967605">:=</span>&nbsp;<span class="ident" id="7967608">c</span><span class="op" id="7967609">.</span><span class="ident" id="7967610">Read</span><span class="op" id="7967614">(</span><span class="ident" id="7967615">buf</span><span class="op" id="7967618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7967623">read</span>&nbsp;<span class="op" id="7967628">+=</span>&nbsp;<span class="ident" id="7967631">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7967636">if</span>&nbsp;<span class="ident" id="7967639">err</span>&nbsp;<span class="op" id="7967643">!=</span>&nbsp;<span class="ident" id="7967646">nil</span>&nbsp;<span class="op" id="7967650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7967656">b</span><span class="op" id="7967657">.</span><span class="ident" id="7967658">Logf</span><span class="op" id="7967662">(</span><span class="string" id="7967663">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7967680">,</span>&nbsp;<span class="ident" id="7967682">err</span><span class="op" id="7967685">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7967691">return</span>&nbsp;<span class="builtintype" id="7967698">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7967707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7967711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7967715">return</span>&nbsp;<span class="builtintype" id="7967722">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7967728">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7967731">ln</span><span class="op" id="7967733">,</span>&nbsp;<span class="ident" id="7967735">err</span>&nbsp;<span class="op" id="7967739">:=</span>&nbsp;<span class="ident" id="7967742">Listen</span><span class="op" id="7967748">(</span><span class="string" id="7967749">&#34;tcp&#34;</span><span class="op" id="7967754">,</span>&nbsp;<span class="ident" id="7967756">laddr</span><span class="op" id="7967761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7967764">if</span>&nbsp;<span class="ident" id="7967767">err</span>&nbsp;<span class="op" id="7967771">!=</span>&nbsp;<span class="ident" id="7967774">nil</span>&nbsp;<span class="op" id="7967778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7967782">b</span><span class="op" id="7967783">.</span><span class="ident" id="7967784">Fatalf</span><span class="op" id="7967790">(</span><span class="string" id="7967791">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7967810">,</span>&nbsp;<span class="ident" id="7967812">err</span><span class="op" id="7967815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7967818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7967821">defer</span>&nbsp;<span class="ident" id="7967827">ln</span><span class="op" id="7967829">.</span><span class="ident" id="7967830">Close</span><span class="op" id="7967835">(</span><span class="op" id="7967836">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7967839">serverSem</span>&nbsp;<span class="op" id="7967849">:=</span>&nbsp;<span class="builtinfunc" id="7967852">make</span><span class="op" id="7967856">(</span><span class="keyword" id="7967857">chan</span>&nbsp;<span class="builtintype" id="7967862">bool</span><span class="op" id="7967866">,</span>&nbsp;<span class="ident" id="7967868">numConcurrent</span><span class="op" id="7967881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7967884">//&nbsp;Acceptor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7967898">go</span>&nbsp;<span class="keyword" id="7967901">func</span><span class="op" id="7967905">(</span><span class="op" id="7967906">)</span>&nbsp;<span class="op" id="7967908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7967912">for</span>&nbsp;<span class="op" id="7967916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7967921">c</span><span class="op" id="7967922">,</span>&nbsp;<span class="ident" id="7967924">err</span>&nbsp;<span class="op" id="7967928">:=</span>&nbsp;<span class="ident" id="7967931">ln</span><span class="op" id="7967933">.</span><span class="ident" id="7967934">Accept</span><span class="op" id="7967940">(</span><span class="op" id="7967941">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7967946">if</span>&nbsp;<span class="ident" id="7967949">err</span>&nbsp;<span class="op" id="7967953">!=</span>&nbsp;<span class="ident" id="7967956">nil</span>&nbsp;<span class="op" id="7967960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7967966">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7967975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7967980">serverSem</span>&nbsp;<span class="op" id="7967990">&lt;-</span>&nbsp;<span class="builtintype" id="7967993">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7968001">//&nbsp;Server&nbsp;connection.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7968026">go</span>&nbsp;<span class="keyword" id="7968029">func</span><span class="op" id="7968033">(</span><span class="ident" id="7968034">c</span>&nbsp;<span class="ident" id="7968036">Conn</span><span class="op" id="7968040">)</span>&nbsp;<span class="op" id="7968042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7968048">defer</span>&nbsp;<span class="keyword" id="7968054">func</span><span class="op" id="7968058">(</span><span class="op" id="7968059">)</span>&nbsp;<span class="op" id="7968061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7968068">c</span><span class="op" id="7968069">.</span><span class="ident" id="7968070">Close</span><span class="op" id="7968075">(</span><span class="op" id="7968076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7968083">&lt;-</span><span class="ident" id="7968085">serverSem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7968099">}</span><span class="op" id="7968100">(</span><span class="op" id="7968101">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7968107">if</span>&nbsp;<span class="ident" id="7968110">timeout</span>&nbsp;<span class="op" id="7968118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7968125">c</span><span class="op" id="7968126">.</span><span class="ident" id="7968127">SetDeadline</span><span class="op" id="7968138">(</span><span class="ident" id="7968139">time</span><span class="op" id="7968143">.</span><span class="ident" id="7968144">Now</span><span class="op" id="7968147">(</span><span class="op" id="7968148">)</span><span class="op" id="7968149">.</span><span class="ident" id="7968150">Add</span><span class="op" id="7968153">(</span><span class="ident" id="7968154">time</span><span class="op" id="7968158">.</span><span class="ident" id="7968159">Hour</span><span class="op" id="7968163">)</span><span class="op" id="7968164">)</span>&nbsp;<span class="comment" id="7968166">//&nbsp;Not&nbsp;intended&nbsp;to&nbsp;fire.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7968195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7968201">var</span>&nbsp;<span class="ident" id="7968205">buf</span>&nbsp;<span class="op" id="7968209">[</span><span class="ident" id="7968210">msgLen</span><span class="op" id="7968216">]</span><span class="builtintype" id="7968217">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7968226">for</span>&nbsp;<span class="ident" id="7968230">m</span>&nbsp;<span class="op" id="7968232">:=</span>&nbsp;<span class="num" id="7968235">0</span><span class="op" id="7968236">;</span>&nbsp;<span class="ident" id="7968238">m</span>&nbsp;<span class="op" id="7968240">&lt;</span>&nbsp;<span class="ident" id="7968242">msgs</span><span class="op" id="7968246">;</span>&nbsp;<span class="ident" id="7968248">m</span><span class="op" id="7968249">++</span>&nbsp;<span class="op" id="7968252">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7968259">if</span>&nbsp;<span class="op" id="7968262">!</span><span class="ident" id="7968263">recvMsg</span><span class="op" id="7968270">(</span><span class="ident" id="7968271">c</span><span class="op" id="7968272">,</span>&nbsp;<span class="ident" id="7968274">buf</span><span class="op" id="7968277">[</span><span class="op" id="7968278">:</span><span class="op" id="7968279">]</span><span class="op" id="7968280">)</span>&nbsp;<span class="op" id="7968282">||</span>&nbsp;<span class="op" id="7968285">!</span><span class="ident" id="7968286">sendMsg</span><span class="op" id="7968293">(</span><span class="ident" id="7968294">c</span><span class="op" id="7968295">,</span>&nbsp;<span class="ident" id="7968297">buf</span><span class="op" id="7968300">[</span><span class="op" id="7968301">:</span><span class="op" id="7968302">]</span><span class="op" id="7968303">)</span>&nbsp;<span class="op" id="7968305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7968313">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7968324">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7968330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7968335">}</span><span class="op" id="7968336">(</span><span class="ident" id="7968337">c</span><span class="op" id="7968338">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7968342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7968345">}</span><span class="op" id="7968346">(</span><span class="op" id="7968347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7968350">clientSem</span>&nbsp;<span class="op" id="7968360">:=</span>&nbsp;<span class="builtinfunc" id="7968363">make</span><span class="op" id="7968367">(</span><span class="keyword" id="7968368">chan</span>&nbsp;<span class="builtintype" id="7968373">bool</span><span class="op" id="7968377">,</span>&nbsp;<span class="ident" id="7968379">numConcurrent</span><span class="op" id="7968392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7968395">for</span>&nbsp;<span class="ident" id="7968399">i</span>&nbsp;<span class="op" id="7968401">:=</span>&nbsp;<span class="num" id="7968404">0</span><span class="op" id="7968405">;</span>&nbsp;<span class="ident" id="7968407">i</span>&nbsp;<span class="op" id="7968409">&lt;</span>&nbsp;<span class="ident" id="7968411">conns</span><span class="op" id="7968416">;</span>&nbsp;<span class="ident" id="7968418">i</span><span class="op" id="7968419">++</span>&nbsp;<span class="op" id="7968422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7968426">clientSem</span>&nbsp;<span class="op" id="7968436">&lt;-</span>&nbsp;<span class="builtintype" id="7968439">true</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7968446">//&nbsp;Client&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7968470">go</span>&nbsp;<span class="keyword" id="7968473">func</span><span class="op" id="7968477">(</span><span class="op" id="7968478">)</span>&nbsp;<span class="op" id="7968480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7968485">defer</span>&nbsp;<span class="keyword" id="7968491">func</span><span class="op" id="7968495">(</span><span class="op" id="7968496">)</span>&nbsp;<span class="op" id="7968498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7968504">&lt;-</span><span class="ident" id="7968506">clientSem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7968519">}</span><span class="op" id="7968520">(</span><span class="op" id="7968521">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7968526">c</span><span class="op" id="7968527">,</span>&nbsp;<span class="ident" id="7968529">err</span>&nbsp;<span class="op" id="7968533">:=</span>&nbsp;<span class="ident" id="7968536">Dial</span><span class="op" id="7968540">(</span><span class="string" id="7968541">&#34;tcp&#34;</span><span class="op" id="7968546">,</span>&nbsp;<span class="ident" id="7968548">ln</span><span class="op" id="7968550">.</span><span class="ident" id="7968551">Addr</span><span class="op" id="7968555">(</span><span class="op" id="7968556">)</span><span class="op" id="7968557">.</span><span class="ident" id="7968558">String</span><span class="op" id="7968564">(</span><span class="op" id="7968565">)</span><span class="op" id="7968566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7968571">if</span>&nbsp;<span class="ident" id="7968574">err</span>&nbsp;<span class="op" id="7968578">!=</span>&nbsp;<span class="ident" id="7968581">nil</span>&nbsp;<span class="op" id="7968585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7968591">b</span><span class="op" id="7968592">.</span><span class="ident" id="7968593">Logf</span><span class="op" id="7968597">(</span><span class="string" id="7968598">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7968615">,</span>&nbsp;<span class="ident" id="7968617">err</span><span class="op" id="7968620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7968626">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7968636">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7968641">defer</span>&nbsp;<span class="ident" id="7968647">c</span><span class="op" id="7968648">.</span><span class="ident" id="7968649">Close</span><span class="op" id="7968654">(</span><span class="op" id="7968655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7968660">if</span>&nbsp;<span class="ident" id="7968663">timeout</span>&nbsp;<span class="op" id="7968671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7968677">c</span><span class="op" id="7968678">.</span><span class="ident" id="7968679">SetDeadline</span><span class="op" id="7968690">(</span><span class="ident" id="7968691">time</span><span class="op" id="7968695">.</span><span class="ident" id="7968696">Now</span><span class="op" id="7968699">(</span><span class="op" id="7968700">)</span><span class="op" id="7968701">.</span><span class="ident" id="7968702">Add</span><span class="op" id="7968705">(</span><span class="ident" id="7968706">time</span><span class="op" id="7968710">.</span><span class="ident" id="7968711">Hour</span><span class="op" id="7968715">)</span><span class="op" id="7968716">)</span>&nbsp;<span class="comment" id="7968718">//&nbsp;Not&nbsp;intended&nbsp;to&nbsp;fire.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7968746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7968751">var</span>&nbsp;<span class="ident" id="7968755">buf</span>&nbsp;<span class="op" id="7968759">[</span><span class="ident" id="7968760">msgLen</span><span class="op" id="7968766">]</span><span class="builtintype" id="7968767">byte</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7968775">for</span>&nbsp;<span class="ident" id="7968779">m</span>&nbsp;<span class="op" id="7968781">:=</span>&nbsp;<span class="num" id="7968784">0</span><span class="op" id="7968785">;</span>&nbsp;<span class="ident" id="7968787">m</span>&nbsp;<span class="op" id="7968789">&lt;</span>&nbsp;<span class="ident" id="7968791">msgs</span><span class="op" id="7968795">;</span>&nbsp;<span class="ident" id="7968797">m</span><span class="op" id="7968798">++</span>&nbsp;<span class="op" id="7968801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7968807">if</span>&nbsp;<span class="op" id="7968810">!</span><span class="ident" id="7968811">sendMsg</span><span class="op" id="7968818">(</span><span class="ident" id="7968819">c</span><span class="op" id="7968820">,</span>&nbsp;<span class="ident" id="7968822">buf</span><span class="op" id="7968825">[</span><span class="op" id="7968826">:</span><span class="op" id="7968827">]</span><span class="op" id="7968828">)</span>&nbsp;<span class="op" id="7968830">||</span>&nbsp;<span class="op" id="7968833">!</span><span class="ident" id="7968834">recvMsg</span><span class="op" id="7968841">(</span><span class="ident" id="7968842">c</span><span class="op" id="7968843">,</span>&nbsp;<span class="ident" id="7968845">buf</span><span class="op" id="7968848">[</span><span class="op" id="7968849">:</span><span class="op" id="7968850">]</span><span class="op" id="7968851">)</span>&nbsp;<span class="op" id="7968853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7968860">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7968870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7968875">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7968879">}</span><span class="op" id="7968880">(</span><span class="op" id="7968881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7968884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7968887">for</span>&nbsp;<span class="ident" id="7968891">i</span>&nbsp;<span class="op" id="7968893">:=</span>&nbsp;<span class="num" id="7968896">0</span><span class="op" id="7968897">;</span>&nbsp;<span class="ident" id="7968899">i</span>&nbsp;<span class="op" id="7968901">&lt;</span>&nbsp;<span class="ident" id="7968903">numConcurrent</span><span class="op" id="7968916">;</span>&nbsp;<span class="ident" id="7968918">i</span><span class="op" id="7968919">++</span>&nbsp;<span class="op" id="7968922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7968926">clientSem</span>&nbsp;<span class="op" id="7968936">&lt;-</span>&nbsp;<span class="builtintype" id="7968939">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7968946">serverSem</span>&nbsp;<span class="op" id="7968956">&lt;-</span>&nbsp;<span class="builtintype" id="7968959">true</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7968965">}</span><br>
<span class="lineno"></span><span class="op" id="7968967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7968970">func</span>&nbsp;<span class="ident" id="7968975">BenchmarkTCP4ConcurrentReadWrite</span><span class="op" id="7969007">(</span><span class="ident" id="7969008">b</span>&nbsp;<span class="op" id="7969010">*</span><span class="ident" id="7969011">testing</span><span class="op" id="7969018">.</span><span class="ident" id="7969019">B</span><span class="op" id="7969020">)</span>&nbsp;<span class="op" id="7969022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7969025">benchmarkTCPConcurrentReadWrite</span><span class="op" id="7969056">(</span><span class="ident" id="7969057">b</span><span class="op" id="7969058">,</span>&nbsp;<span class="string" id="7969060">&#34;127.0.0.1:0&#34;</span><span class="op" id="7969073">)</span><br>
<span class="lineno">160</span><span class="op" id="7969075">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7969078">func</span>&nbsp;<span class="ident" id="7969083">BenchmarkTCP6ConcurrentReadWrite</span><span class="op" id="7969115">(</span><span class="ident" id="7969116">b</span>&nbsp;<span class="op" id="7969118">*</span><span class="ident" id="7969119">testing</span><span class="op" id="7969126">.</span><span class="ident" id="7969127">B</span><span class="op" id="7969128">)</span>&nbsp;<span class="op" id="7969130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7969133">if</span>&nbsp;<span class="op" id="7969136">!</span><span class="ident" id="7969137">supportsIPv6</span>&nbsp;<span class="op" id="7969150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7969154">b</span><span class="op" id="7969155">.</span><span class="ident" id="7969156">Skip</span><span class="op" id="7969160">(</span><span class="string" id="7969161">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="7969184">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7969187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7969190">benchmarkTCPConcurrentReadWrite</span><span class="op" id="7969221">(</span><span class="ident" id="7969222">b</span><span class="op" id="7969223">,</span>&nbsp;<span class="string" id="7969225">&#34;[::1]:0&#34;</span><span class="op" id="7969234">)</span><br>
<span class="lineno"></span><span class="op" id="7969236">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7969239">func</span>&nbsp;<span class="ident" id="7969244">benchmarkTCPConcurrentReadWrite</span><span class="op" id="7969275">(</span><span class="ident" id="7969276">b</span>&nbsp;<span class="op" id="7969278">*</span><span class="ident" id="7969279">testing</span><span class="op" id="7969286">.</span><span class="ident" id="7969287">B</span><span class="op" id="7969288">,</span>&nbsp;<span class="ident" id="7969290">laddr</span>&nbsp;<span class="builtintype" id="7969296">string</span><span class="op" id="7969302">)</span>&nbsp;<span class="op" id="7969304">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7969307">//&nbsp;The&nbsp;benchmark&nbsp;creates&nbsp;GOMAXPROCS&nbsp;client/server&nbsp;pairs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7969365">//&nbsp;Each&nbsp;pair&nbsp;creates&nbsp;4&nbsp;goroutines:&nbsp;client&nbsp;reader/writer&nbsp;and&nbsp;server&nbsp;reader/writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7969448">//&nbsp;The&nbsp;benchmark&nbsp;stresses&nbsp;concurrent&nbsp;reading&nbsp;and&nbsp;writing&nbsp;to&nbsp;the&nbsp;same&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7969530">//&nbsp;Such&nbsp;pattern&nbsp;is&nbsp;used&nbsp;in&nbsp;net/http&nbsp;and&nbsp;net/rpc.</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7969581">b</span><span class="op" id="7969582">.</span><span class="ident" id="7969583">StopTimer</span><span class="op" id="7969592">(</span><span class="op" id="7969593">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7969597">P</span>&nbsp;<span class="op" id="7969599">:=</span>&nbsp;<span class="ident" id="7969602">runtime</span><span class="op" id="7969609">.</span><span class="ident" id="7969610">GOMAXPROCS</span><span class="op" id="7969620">(</span><span class="num" id="7969621">0</span><span class="op" id="7969622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7969625">N</span>&nbsp;<span class="op" id="7969627">:=</span>&nbsp;<span class="ident" id="7969630">b</span><span class="op" id="7969631">.</span><span class="ident" id="7969632">N</span>&nbsp;<span class="op" id="7969634">/</span>&nbsp;<span class="ident" id="7969636">P</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7969639">W</span>&nbsp;<span class="op" id="7969641">:=</span>&nbsp;<span class="num" id="7969644">1000</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7969651">//&nbsp;Setup&nbsp;P&nbsp;client/server&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7969690">clients</span>&nbsp;<span class="op" id="7969698">:=</span>&nbsp;<span class="builtinfunc" id="7969701">make</span><span class="op" id="7969705">(</span><span class="op" id="7969706">[</span><span class="op" id="7969707">]</span><span class="ident" id="7969708">Conn</span><span class="op" id="7969712">,</span>&nbsp;<span class="ident" id="7969714">P</span><span class="op" id="7969715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7969718">servers</span>&nbsp;<span class="op" id="7969726">:=</span>&nbsp;<span class="builtinfunc" id="7969729">make</span><span class="op" id="7969733">(</span><span class="op" id="7969734">[</span><span class="op" id="7969735">]</span><span class="ident" id="7969736">Conn</span><span class="op" id="7969740">,</span>&nbsp;<span class="ident" id="7969742">P</span><span class="op" id="7969743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7969746">ln</span><span class="op" id="7969748">,</span>&nbsp;<span class="ident" id="7969750">err</span>&nbsp;<span class="op" id="7969754">:=</span>&nbsp;<span class="ident" id="7969757">Listen</span><span class="op" id="7969763">(</span><span class="string" id="7969764">&#34;tcp&#34;</span><span class="op" id="7969769">,</span>&nbsp;<span class="ident" id="7969771">laddr</span><span class="op" id="7969776">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7969779">if</span>&nbsp;<span class="ident" id="7969782">err</span>&nbsp;<span class="op" id="7969786">!=</span>&nbsp;<span class="ident" id="7969789">nil</span>&nbsp;<span class="op" id="7969793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7969797">b</span><span class="op" id="7969798">.</span><span class="ident" id="7969799">Fatalf</span><span class="op" id="7969805">(</span><span class="string" id="7969806">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7969825">,</span>&nbsp;<span class="ident" id="7969827">err</span><span class="op" id="7969830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7969833">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7969836">defer</span>&nbsp;<span class="ident" id="7969842">ln</span><span class="op" id="7969844">.</span><span class="ident" id="7969845">Close</span><span class="op" id="7969850">(</span><span class="op" id="7969851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7969854">done</span>&nbsp;<span class="op" id="7969859">:=</span>&nbsp;<span class="builtinfunc" id="7969862">make</span><span class="op" id="7969866">(</span><span class="keyword" id="7969867">chan</span>&nbsp;<span class="builtintype" id="7969872">bool</span><span class="op" id="7969876">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7969879">go</span>&nbsp;<span class="keyword" id="7969882">func</span><span class="op" id="7969886">(</span><span class="op" id="7969887">)</span>&nbsp;<span class="op" id="7969889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7969893">for</span>&nbsp;<span class="ident" id="7969897">p</span>&nbsp;<span class="op" id="7969899">:=</span>&nbsp;<span class="num" id="7969902">0</span><span class="op" id="7969903">;</span>&nbsp;<span class="ident" id="7969905">p</span>&nbsp;<span class="op" id="7969907">&lt;</span>&nbsp;<span class="ident" id="7969909">P</span><span class="op" id="7969910">;</span>&nbsp;<span class="ident" id="7969912">p</span><span class="op" id="7969913">++</span>&nbsp;<span class="op" id="7969916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7969921">s</span><span class="op" id="7969922">,</span>&nbsp;<span class="ident" id="7969924">err</span>&nbsp;<span class="op" id="7969928">:=</span>&nbsp;<span class="ident" id="7969931">ln</span><span class="op" id="7969933">.</span><span class="ident" id="7969934">Accept</span><span class="op" id="7969940">(</span><span class="op" id="7969941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7969946">if</span>&nbsp;<span class="ident" id="7969949">err</span>&nbsp;<span class="op" id="7969953">!=</span>&nbsp;<span class="ident" id="7969956">nil</span>&nbsp;<span class="op" id="7969960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7969966">b</span><span class="op" id="7969967">.</span><span class="ident" id="7969968">Errorf</span><span class="op" id="7969974">(</span><span class="string" id="7969975">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7969994">,</span>&nbsp;<span class="ident" id="7969996">err</span><span class="op" id="7969999">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7970005">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7970015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7970020">servers</span><span class="op" id="7970027">[</span><span class="ident" id="7970028">p</span><span class="op" id="7970029">]</span>&nbsp;<span class="op" id="7970031">=</span>&nbsp;<span class="ident" id="7970033">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7970037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7970041">done</span>&nbsp;<span class="op" id="7970046">&lt;-</span>&nbsp;<span class="builtintype" id="7970049">true</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7970055">}</span><span class="op" id="7970056">(</span><span class="op" id="7970057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7970060">for</span>&nbsp;<span class="ident" id="7970064">p</span>&nbsp;<span class="op" id="7970066">:=</span>&nbsp;<span class="num" id="7970069">0</span><span class="op" id="7970070">;</span>&nbsp;<span class="ident" id="7970072">p</span>&nbsp;<span class="op" id="7970074">&lt;</span>&nbsp;<span class="ident" id="7970076">P</span><span class="op" id="7970077">;</span>&nbsp;<span class="ident" id="7970079">p</span><span class="op" id="7970080">++</span>&nbsp;<span class="op" id="7970083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7970087">c</span><span class="op" id="7970088">,</span>&nbsp;<span class="ident" id="7970090">err</span>&nbsp;<span class="op" id="7970094">:=</span>&nbsp;<span class="ident" id="7970097">Dial</span><span class="op" id="7970101">(</span><span class="string" id="7970102">&#34;tcp&#34;</span><span class="op" id="7970107">,</span>&nbsp;<span class="ident" id="7970109">ln</span><span class="op" id="7970111">.</span><span class="ident" id="7970112">Addr</span><span class="op" id="7970116">(</span><span class="op" id="7970117">)</span><span class="op" id="7970118">.</span><span class="ident" id="7970119">String</span><span class="op" id="7970125">(</span><span class="op" id="7970126">)</span><span class="op" id="7970127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7970131">if</span>&nbsp;<span class="ident" id="7970134">err</span>&nbsp;<span class="op" id="7970138">!=</span>&nbsp;<span class="ident" id="7970141">nil</span>&nbsp;<span class="op" id="7970145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7970150">b</span><span class="op" id="7970151">.</span><span class="ident" id="7970152">Fatalf</span><span class="op" id="7970158">(</span><span class="string" id="7970159">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7970176">,</span>&nbsp;<span class="ident" id="7970178">err</span><span class="op" id="7970181">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7970185">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7970189">clients</span><span class="op" id="7970196">[</span><span class="ident" id="7970197">p</span><span class="op" id="7970198">]</span>&nbsp;<span class="op" id="7970200">=</span>&nbsp;<span class="ident" id="7970202">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7970205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7970208">&lt;-</span><span class="ident" id="7970210">done</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7970217">b</span><span class="op" id="7970218">.</span><span class="ident" id="7970219">StartTimer</span><span class="op" id="7970229">(</span><span class="op" id="7970230">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7970234">var</span>&nbsp;<span class="ident" id="7970238">wg</span>&nbsp;<span class="ident" id="7970241">sync</span><span class="op" id="7970245">.</span><span class="ident" id="7970246">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7970257">wg</span><span class="op" id="7970259">.</span><span class="ident" id="7970260">Add</span><span class="op" id="7970263">(</span><span class="num" id="7970264">4</span>&nbsp;<span class="op" id="7970266">*</span>&nbsp;<span class="ident" id="7970268">P</span><span class="op" id="7970269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7970272">for</span>&nbsp;<span class="ident" id="7970276">p</span>&nbsp;<span class="op" id="7970278">:=</span>&nbsp;<span class="num" id="7970281">0</span><span class="op" id="7970282">;</span>&nbsp;<span class="ident" id="7970284">p</span>&nbsp;<span class="op" id="7970286">&lt;</span>&nbsp;<span class="ident" id="7970288">P</span><span class="op" id="7970289">;</span>&nbsp;<span class="ident" id="7970291">p</span><span class="op" id="7970292">++</span>&nbsp;<span class="op" id="7970295">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7970299">//&nbsp;Client&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7970319">go</span>&nbsp;<span class="keyword" id="7970322">func</span><span class="op" id="7970326">(</span><span class="ident" id="7970327">c</span>&nbsp;<span class="ident" id="7970329">Conn</span><span class="op" id="7970333">)</span>&nbsp;<span class="op" id="7970335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7970340">defer</span>&nbsp;<span class="ident" id="7970346">wg</span><span class="op" id="7970348">.</span><span class="ident" id="7970349">Done</span><span class="op" id="7970353">(</span><span class="op" id="7970354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7970359">var</span>&nbsp;<span class="ident" id="7970363">buf</span>&nbsp;<span class="op" id="7970367">[</span><span class="num" id="7970368">1</span><span class="op" id="7970369">]</span><span class="builtintype" id="7970370">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7970378">for</span>&nbsp;<span class="ident" id="7970382">i</span>&nbsp;<span class="op" id="7970384">:=</span>&nbsp;<span class="num" id="7970387">0</span><span class="op" id="7970388">;</span>&nbsp;<span class="ident" id="7970390">i</span>&nbsp;<span class="op" id="7970392">&lt;</span>&nbsp;<span class="ident" id="7970394">N</span><span class="op" id="7970395">;</span>&nbsp;<span class="ident" id="7970397">i</span><span class="op" id="7970398">++</span>&nbsp;<span class="op" id="7970401">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7970407">v</span>&nbsp;<span class="op" id="7970409">:=</span>&nbsp;<span class="builtintype" id="7970412">byte</span><span class="op" id="7970416">(</span><span class="ident" id="7970417">i</span><span class="op" id="7970418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7970424">for</span>&nbsp;<span class="ident" id="7970428">w</span>&nbsp;<span class="op" id="7970430">:=</span>&nbsp;<span class="num" id="7970433">0</span><span class="op" id="7970434">;</span>&nbsp;<span class="ident" id="7970436">w</span>&nbsp;<span class="op" id="7970438">&lt;</span>&nbsp;<span class="ident" id="7970440">W</span><span class="op" id="7970441">;</span>&nbsp;<span class="ident" id="7970443">w</span><span class="op" id="7970444">++</span>&nbsp;<span class="op" id="7970447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7970454">v</span>&nbsp;<span class="op" id="7970456">*=</span>&nbsp;<span class="ident" id="7970459">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7970465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7970471">buf</span><span class="op" id="7970474">[</span><span class="num" id="7970475">0</span><span class="op" id="7970476">]</span>&nbsp;<span class="op" id="7970478">=</span>&nbsp;<span class="ident" id="7970480">v</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7970486">_</span><span class="op" id="7970487">,</span>&nbsp;<span class="ident" id="7970489">err</span>&nbsp;<span class="op" id="7970493">:=</span>&nbsp;<span class="ident" id="7970496">c</span><span class="op" id="7970497">.</span><span class="ident" id="7970498">Write</span><span class="op" id="7970503">(</span><span class="ident" id="7970504">buf</span><span class="op" id="7970507">[</span><span class="op" id="7970508">:</span><span class="op" id="7970509">]</span><span class="op" id="7970510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7970516">if</span>&nbsp;<span class="ident" id="7970519">err</span>&nbsp;<span class="op" id="7970523">!=</span>&nbsp;<span class="ident" id="7970526">nil</span>&nbsp;<span class="op" id="7970530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7970537">b</span><span class="op" id="7970538">.</span><span class="ident" id="7970539">Errorf</span><span class="op" id="7970545">(</span><span class="string" id="7970546">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7970564">,</span>&nbsp;<span class="ident" id="7970566">err</span><span class="op" id="7970569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7970576">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7970587">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7970592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7970596">}</span><span class="op" id="7970597">(</span><span class="ident" id="7970598">clients</span><span class="op" id="7970605">[</span><span class="ident" id="7970606">p</span><span class="op" id="7970607">]</span><span class="op" id="7970608">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7970613">//&nbsp;Pipe&nbsp;between&nbsp;server&nbsp;reader&nbsp;and&nbsp;server&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7970664">pipe</span>&nbsp;<span class="op" id="7970669">:=</span>&nbsp;<span class="builtinfunc" id="7970672">make</span><span class="op" id="7970676">(</span><span class="keyword" id="7970677">chan</span>&nbsp;<span class="builtintype" id="7970682">byte</span><span class="op" id="7970686">,</span>&nbsp;<span class="num" id="7970688">128</span><span class="op" id="7970691">)</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7970696">//&nbsp;Server&nbsp;reader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7970716">go</span>&nbsp;<span class="keyword" id="7970719">func</span><span class="op" id="7970723">(</span><span class="ident" id="7970724">s</span>&nbsp;<span class="ident" id="7970726">Conn</span><span class="op" id="7970730">)</span>&nbsp;<span class="op" id="7970732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7970737">defer</span>&nbsp;<span class="ident" id="7970743">wg</span><span class="op" id="7970745">.</span><span class="ident" id="7970746">Done</span><span class="op" id="7970750">(</span><span class="op" id="7970751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7970756">var</span>&nbsp;<span class="ident" id="7970760">buf</span>&nbsp;<span class="op" id="7970764">[</span><span class="num" id="7970765">1</span><span class="op" id="7970766">]</span><span class="builtintype" id="7970767">byte</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7970775">for</span>&nbsp;<span class="ident" id="7970779">i</span>&nbsp;<span class="op" id="7970781">:=</span>&nbsp;<span class="num" id="7970784">0</span><span class="op" id="7970785">;</span>&nbsp;<span class="ident" id="7970787">i</span>&nbsp;<span class="op" id="7970789">&lt;</span>&nbsp;<span class="ident" id="7970791">N</span><span class="op" id="7970792">;</span>&nbsp;<span class="ident" id="7970794">i</span><span class="op" id="7970795">++</span>&nbsp;<span class="op" id="7970798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7970804">_</span><span class="op" id="7970805">,</span>&nbsp;<span class="ident" id="7970807">err</span>&nbsp;<span class="op" id="7970811">:=</span>&nbsp;<span class="ident" id="7970814">s</span><span class="op" id="7970815">.</span><span class="ident" id="7970816">Read</span><span class="op" id="7970820">(</span><span class="ident" id="7970821">buf</span><span class="op" id="7970824">[</span><span class="op" id="7970825">:</span><span class="op" id="7970826">]</span><span class="op" id="7970827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7970833">if</span>&nbsp;<span class="ident" id="7970836">err</span>&nbsp;<span class="op" id="7970840">!=</span>&nbsp;<span class="ident" id="7970843">nil</span>&nbsp;<span class="op" id="7970847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7970854">b</span><span class="op" id="7970855">.</span><span class="ident" id="7970856">Errorf</span><span class="op" id="7970862">(</span><span class="string" id="7970863">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7970880">,</span>&nbsp;<span class="ident" id="7970882">err</span><span class="op" id="7970885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7970892">return</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7970903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7970909">pipe</span>&nbsp;<span class="op" id="7970914">&lt;-</span>&nbsp;<span class="ident" id="7970917">buf</span><span class="op" id="7970920">[</span><span class="num" id="7970921">0</span><span class="op" id="7970922">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7970927">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7970931">}</span><span class="op" id="7970932">(</span><span class="ident" id="7970933">servers</span><span class="op" id="7970940">[</span><span class="ident" id="7970941">p</span><span class="op" id="7970942">]</span><span class="op" id="7970943">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7970948">//&nbsp;Server&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7970968">go</span>&nbsp;<span class="keyword" id="7970971">func</span><span class="op" id="7970975">(</span><span class="ident" id="7970976">s</span>&nbsp;<span class="ident" id="7970978">Conn</span><span class="op" id="7970982">)</span>&nbsp;<span class="op" id="7970984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7970989">defer</span>&nbsp;<span class="ident" id="7970995">wg</span><span class="op" id="7970997">.</span><span class="ident" id="7970998">Done</span><span class="op" id="7971002">(</span><span class="op" id="7971003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7971008">var</span>&nbsp;<span class="ident" id="7971012">buf</span>&nbsp;<span class="op" id="7971016">[</span><span class="num" id="7971017">1</span><span class="op" id="7971018">]</span><span class="builtintype" id="7971019">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7971027">for</span>&nbsp;<span class="ident" id="7971031">i</span>&nbsp;<span class="op" id="7971033">:=</span>&nbsp;<span class="num" id="7971036">0</span><span class="op" id="7971037">;</span>&nbsp;<span class="ident" id="7971039">i</span>&nbsp;<span class="op" id="7971041">&lt;</span>&nbsp;<span class="ident" id="7971043">N</span><span class="op" id="7971044">;</span>&nbsp;<span class="ident" id="7971046">i</span><span class="op" id="7971047">++</span>&nbsp;<span class="op" id="7971050">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7971056">v</span>&nbsp;<span class="op" id="7971058">:=</span>&nbsp;<span class="op" id="7971061">&lt;-</span><span class="ident" id="7971063">pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7971072">for</span>&nbsp;<span class="ident" id="7971076">w</span>&nbsp;<span class="op" id="7971078">:=</span>&nbsp;<span class="num" id="7971081">0</span><span class="op" id="7971082">;</span>&nbsp;<span class="ident" id="7971084">w</span>&nbsp;<span class="op" id="7971086">&lt;</span>&nbsp;<span class="ident" id="7971088">W</span><span class="op" id="7971089">;</span>&nbsp;<span class="ident" id="7971091">w</span><span class="op" id="7971092">++</span>&nbsp;<span class="op" id="7971095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7971102">v</span>&nbsp;<span class="op" id="7971104">*=</span>&nbsp;<span class="ident" id="7971107">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7971113">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7971119">buf</span><span class="op" id="7971122">[</span><span class="num" id="7971123">0</span><span class="op" id="7971124">]</span>&nbsp;<span class="op" id="7971126">=</span>&nbsp;<span class="ident" id="7971128">v</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7971134">_</span><span class="op" id="7971135">,</span>&nbsp;<span class="ident" id="7971137">err</span>&nbsp;<span class="op" id="7971141">:=</span>&nbsp;<span class="ident" id="7971144">s</span><span class="op" id="7971145">.</span><span class="ident" id="7971146">Write</span><span class="op" id="7971151">(</span><span class="ident" id="7971152">buf</span><span class="op" id="7971155">[</span><span class="op" id="7971156">:</span><span class="op" id="7971157">]</span><span class="op" id="7971158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7971164">if</span>&nbsp;<span class="ident" id="7971167">err</span>&nbsp;<span class="op" id="7971171">!=</span>&nbsp;<span class="ident" id="7971174">nil</span>&nbsp;<span class="op" id="7971178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7971185">b</span><span class="op" id="7971186">.</span><span class="ident" id="7971187">Errorf</span><span class="op" id="7971193">(</span><span class="string" id="7971194">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7971212">,</span>&nbsp;<span class="ident" id="7971214">err</span><span class="op" id="7971217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7971224">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7971235">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7971240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7971245">s</span><span class="op" id="7971246">.</span><span class="ident" id="7971247">Close</span><span class="op" id="7971252">(</span><span class="op" id="7971253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7971257">}</span><span class="op" id="7971258">(</span><span class="ident" id="7971259">servers</span><span class="op" id="7971266">[</span><span class="ident" id="7971267">p</span><span class="op" id="7971268">]</span><span class="op" id="7971269">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7971274">//&nbsp;Client&nbsp;reader.</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7971294">go</span>&nbsp;<span class="keyword" id="7971297">func</span><span class="op" id="7971301">(</span><span class="ident" id="7971302">c</span>&nbsp;<span class="ident" id="7971304">Conn</span><span class="op" id="7971308">)</span>&nbsp;<span class="op" id="7971310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7971315">defer</span>&nbsp;<span class="ident" id="7971321">wg</span><span class="op" id="7971323">.</span><span class="ident" id="7971324">Done</span><span class="op" id="7971328">(</span><span class="op" id="7971329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7971334">var</span>&nbsp;<span class="ident" id="7971338">buf</span>&nbsp;<span class="op" id="7971342">[</span><span class="num" id="7971343">1</span><span class="op" id="7971344">]</span><span class="builtintype" id="7971345">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7971353">for</span>&nbsp;<span class="ident" id="7971357">i</span>&nbsp;<span class="op" id="7971359">:=</span>&nbsp;<span class="num" id="7971362">0</span><span class="op" id="7971363">;</span>&nbsp;<span class="ident" id="7971365">i</span>&nbsp;<span class="op" id="7971367">&lt;</span>&nbsp;<span class="ident" id="7971369">N</span><span class="op" id="7971370">;</span>&nbsp;<span class="ident" id="7971372">i</span><span class="op" id="7971373">++</span>&nbsp;<span class="op" id="7971376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7971382">_</span><span class="op" id="7971383">,</span>&nbsp;<span class="ident" id="7971385">err</span>&nbsp;<span class="op" id="7971389">:=</span>&nbsp;<span class="ident" id="7971392">c</span><span class="op" id="7971393">.</span><span class="ident" id="7971394">Read</span><span class="op" id="7971398">(</span><span class="ident" id="7971399">buf</span><span class="op" id="7971402">[</span><span class="op" id="7971403">:</span><span class="op" id="7971404">]</span><span class="op" id="7971405">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7971411">if</span>&nbsp;<span class="ident" id="7971414">err</span>&nbsp;<span class="op" id="7971418">!=</span>&nbsp;<span class="ident" id="7971421">nil</span>&nbsp;<span class="op" id="7971425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7971432">b</span><span class="op" id="7971433">.</span><span class="ident" id="7971434">Errorf</span><span class="op" id="7971440">(</span><span class="string" id="7971441">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7971458">,</span>&nbsp;<span class="ident" id="7971460">err</span><span class="op" id="7971463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7971470">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7971481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7971486">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7971491">c</span><span class="op" id="7971492">.</span><span class="ident" id="7971493">Close</span><span class="op" id="7971498">(</span><span class="op" id="7971499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7971503">}</span><span class="op" id="7971504">(</span><span class="ident" id="7971505">clients</span><span class="op" id="7971512">[</span><span class="ident" id="7971513">p</span><span class="op" id="7971514">]</span><span class="op" id="7971515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7971518">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7971521">wg</span><span class="op" id="7971523">.</span><span class="ident" id="7971524">Wait</span><span class="op" id="7971528">(</span><span class="op" id="7971529">)</span><br>
<span class="lineno"></span><span class="op" id="7971531">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="7971534">type</span>&nbsp;<span class="ident" id="7971539">resolveTCPAddrTest</span>&nbsp;<span class="keyword" id="7971558">struct</span>&nbsp;<span class="op" id="7971565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7971568">net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7971582">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7971590">litAddrOrName</span>&nbsp;<span class="builtintype" id="7971604">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7971612">addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7971626">*</span><span class="ident" id="7971627">TCPAddr</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7971636">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7971650">error</span><br>
<span class="lineno"></span><span class="op" id="7971656">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7971659">var</span>&nbsp;<span class="ident" id="7971663">resolveTCPAddrTests</span>&nbsp;<span class="op" id="7971683">=</span>&nbsp;<span class="op" id="7971685">[</span><span class="op" id="7971686">]</span><span class="ident" id="7971687">resolveTCPAddrTest</span><span class="op" id="7971705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7971708">{</span><span class="string" id="7971709">&#34;tcp&#34;</span><span class="op" id="7971714">,</span>&nbsp;<span class="string" id="7971716">&#34;127.0.0.1:0&#34;</span><span class="op" id="7971729">,</span>&nbsp;<span class="op" id="7971731">&amp;</span><span class="ident" id="7971732">TCPAddr</span><span class="op" id="7971739">{</span><span class="ident" id="7971740">IP</span><span class="op" id="7971742">:</span>&nbsp;<span class="ident" id="7971744">IPv4</span><span class="op" id="7971748">(</span><span class="num" id="7971749">127</span><span class="op" id="7971752">,</span>&nbsp;<span class="num" id="7971754">0</span><span class="op" id="7971755">,</span>&nbsp;<span class="num" id="7971757">0</span><span class="op" id="7971758">,</span>&nbsp;<span class="num" id="7971760">1</span><span class="op" id="7971761">)</span><span class="op" id="7971762">,</span>&nbsp;<span class="ident" id="7971764">Port</span><span class="op" id="7971768">:</span>&nbsp;<span class="num" id="7971770">0</span><span class="op" id="7971771">}</span><span class="op" id="7971772">,</span>&nbsp;<span class="ident" id="7971774">nil</span><span class="op" id="7971777">}</span><span class="op" id="7971778">,</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7971781">{</span><span class="string" id="7971782">&#34;tcp4&#34;</span><span class="op" id="7971788">,</span>&nbsp;<span class="string" id="7971790">&#34;127.0.0.1:65535&#34;</span><span class="op" id="7971807">,</span>&nbsp;<span class="op" id="7971809">&amp;</span><span class="ident" id="7971810">TCPAddr</span><span class="op" id="7971817">{</span><span class="ident" id="7971818">IP</span><span class="op" id="7971820">:</span>&nbsp;<span class="ident" id="7971822">IPv4</span><span class="op" id="7971826">(</span><span class="num" id="7971827">127</span><span class="op" id="7971830">,</span>&nbsp;<span class="num" id="7971832">0</span><span class="op" id="7971833">,</span>&nbsp;<span class="num" id="7971835">0</span><span class="op" id="7971836">,</span>&nbsp;<span class="num" id="7971838">1</span><span class="op" id="7971839">)</span><span class="op" id="7971840">,</span>&nbsp;<span class="ident" id="7971842">Port</span><span class="op" id="7971846">:</span>&nbsp;<span class="num" id="7971848">65535</span><span class="op" id="7971853">}</span><span class="op" id="7971854">,</span>&nbsp;<span class="ident" id="7971856">nil</span><span class="op" id="7971859">}</span><span class="op" id="7971860">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7971864">{</span><span class="string" id="7971865">&#34;tcp&#34;</span><span class="op" id="7971870">,</span>&nbsp;<span class="string" id="7971872">&#34;[::1]:1&#34;</span><span class="op" id="7971881">,</span>&nbsp;<span class="op" id="7971883">&amp;</span><span class="ident" id="7971884">TCPAddr</span><span class="op" id="7971891">{</span><span class="ident" id="7971892">IP</span><span class="op" id="7971894">:</span>&nbsp;<span class="ident" id="7971896">ParseIP</span><span class="op" id="7971903">(</span><span class="string" id="7971904">&#34;::1&#34;</span><span class="op" id="7971909">)</span><span class="op" id="7971910">,</span>&nbsp;<span class="ident" id="7971912">Port</span><span class="op" id="7971916">:</span>&nbsp;<span class="num" id="7971918">1</span><span class="op" id="7971919">}</span><span class="op" id="7971920">,</span>&nbsp;<span class="ident" id="7971922">nil</span><span class="op" id="7971925">}</span><span class="op" id="7971926">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7971929">{</span><span class="string" id="7971930">&#34;tcp6&#34;</span><span class="op" id="7971936">,</span>&nbsp;<span class="string" id="7971938">&#34;[::1]:65534&#34;</span><span class="op" id="7971951">,</span>&nbsp;<span class="op" id="7971953">&amp;</span><span class="ident" id="7971954">TCPAddr</span><span class="op" id="7971961">{</span><span class="ident" id="7971962">IP</span><span class="op" id="7971964">:</span>&nbsp;<span class="ident" id="7971966">ParseIP</span><span class="op" id="7971973">(</span><span class="string" id="7971974">&#34;::1&#34;</span><span class="op" id="7971979">)</span><span class="op" id="7971980">,</span>&nbsp;<span class="ident" id="7971982">Port</span><span class="op" id="7971986">:</span>&nbsp;<span class="num" id="7971988">65534</span><span class="op" id="7971993">}</span><span class="op" id="7971994">,</span>&nbsp;<span class="ident" id="7971996">nil</span><span class="op" id="7971999">}</span><span class="op" id="7972000">,</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7972004">{</span><span class="string" id="7972005">&#34;tcp&#34;</span><span class="op" id="7972010">,</span>&nbsp;<span class="string" id="7972012">&#34;[::1%en0]:1&#34;</span><span class="op" id="7972025">,</span>&nbsp;<span class="op" id="7972027">&amp;</span><span class="ident" id="7972028">TCPAddr</span><span class="op" id="7972035">{</span><span class="ident" id="7972036">IP</span><span class="op" id="7972038">:</span>&nbsp;<span class="ident" id="7972040">ParseIP</span><span class="op" id="7972047">(</span><span class="string" id="7972048">&#34;::1&#34;</span><span class="op" id="7972053">)</span><span class="op" id="7972054">,</span>&nbsp;<span class="ident" id="7972056">Port</span><span class="op" id="7972060">:</span>&nbsp;<span class="num" id="7972062">1</span><span class="op" id="7972063">,</span>&nbsp;<span class="ident" id="7972065">Zone</span><span class="op" id="7972069">:</span>&nbsp;<span class="string" id="7972071">&#34;en0&#34;</span><span class="op" id="7972076">}</span><span class="op" id="7972077">,</span>&nbsp;<span class="ident" id="7972079">nil</span><span class="op" id="7972082">}</span><span class="op" id="7972083">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7972086">{</span><span class="string" id="7972087">&#34;tcp6&#34;</span><span class="op" id="7972093">,</span>&nbsp;<span class="string" id="7972095">&#34;[::1%911]:2&#34;</span><span class="op" id="7972108">,</span>&nbsp;<span class="op" id="7972110">&amp;</span><span class="ident" id="7972111">TCPAddr</span><span class="op" id="7972118">{</span><span class="ident" id="7972119">IP</span><span class="op" id="7972121">:</span>&nbsp;<span class="ident" id="7972123">ParseIP</span><span class="op" id="7972130">(</span><span class="string" id="7972131">&#34;::1&#34;</span><span class="op" id="7972136">)</span><span class="op" id="7972137">,</span>&nbsp;<span class="ident" id="7972139">Port</span><span class="op" id="7972143">:</span>&nbsp;<span class="num" id="7972145">2</span><span class="op" id="7972146">,</span>&nbsp;<span class="ident" id="7972148">Zone</span><span class="op" id="7972152">:</span>&nbsp;<span class="string" id="7972154">&#34;911&#34;</span><span class="op" id="7972159">}</span><span class="op" id="7972160">,</span>&nbsp;<span class="ident" id="7972162">nil</span><span class="op" id="7972165">}</span><span class="op" id="7972166">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7972170">{</span><span class="string" id="7972171">&#34;&#34;</span><span class="op" id="7972173">,</span>&nbsp;<span class="string" id="7972175">&#34;127.0.0.1:0&#34;</span><span class="op" id="7972188">,</span>&nbsp;<span class="op" id="7972190">&amp;</span><span class="ident" id="7972191">TCPAddr</span><span class="op" id="7972198">{</span><span class="ident" id="7972199">IP</span><span class="op" id="7972201">:</span>&nbsp;<span class="ident" id="7972203">IPv4</span><span class="op" id="7972207">(</span><span class="num" id="7972208">127</span><span class="op" id="7972211">,</span>&nbsp;<span class="num" id="7972213">0</span><span class="op" id="7972214">,</span>&nbsp;<span class="num" id="7972216">0</span><span class="op" id="7972217">,</span>&nbsp;<span class="num" id="7972219">1</span><span class="op" id="7972220">)</span><span class="op" id="7972221">,</span>&nbsp;<span class="ident" id="7972223">Port</span><span class="op" id="7972227">:</span>&nbsp;<span class="num" id="7972229">0</span><span class="op" id="7972230">}</span><span class="op" id="7972231">,</span>&nbsp;<span class="ident" id="7972233">nil</span><span class="op" id="7972236">}</span><span class="op" id="7972237">,</span>&nbsp;<span class="comment" id="7972239">//&nbsp;Go&nbsp;1.0&nbsp;behavior</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7972259">{</span><span class="string" id="7972260">&#34;&#34;</span><span class="op" id="7972262">,</span>&nbsp;<span class="string" id="7972264">&#34;[::1]:0&#34;</span><span class="op" id="7972273">,</span>&nbsp;<span class="op" id="7972275">&amp;</span><span class="ident" id="7972276">TCPAddr</span><span class="op" id="7972283">{</span><span class="ident" id="7972284">IP</span><span class="op" id="7972286">:</span>&nbsp;<span class="ident" id="7972288">ParseIP</span><span class="op" id="7972295">(</span><span class="string" id="7972296">&#34;::1&#34;</span><span class="op" id="7972301">)</span><span class="op" id="7972302">,</span>&nbsp;<span class="ident" id="7972304">Port</span><span class="op" id="7972308">:</span>&nbsp;<span class="num" id="7972310">0</span><span class="op" id="7972311">}</span><span class="op" id="7972312">,</span>&nbsp;<span class="ident" id="7972314">nil</span><span class="op" id="7972317">}</span><span class="op" id="7972318">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7972328">//&nbsp;Go&nbsp;1.0&nbsp;behavior</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7972349">{</span><span class="string" id="7972350">&#34;tcp&#34;</span><span class="op" id="7972355">,</span>&nbsp;<span class="string" id="7972357">&#34;:12345&#34;</span><span class="op" id="7972365">,</span>&nbsp;<span class="op" id="7972367">&amp;</span><span class="ident" id="7972368">TCPAddr</span><span class="op" id="7972375">{</span><span class="ident" id="7972376">Port</span><span class="op" id="7972380">:</span>&nbsp;<span class="num" id="7972382">12345</span><span class="op" id="7972387">}</span><span class="op" id="7972388">,</span>&nbsp;<span class="ident" id="7972390">nil</span><span class="op" id="7972393">}</span><span class="op" id="7972394">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7972398">{</span><span class="string" id="7972399">&#34;http&#34;</span><span class="op" id="7972405">,</span>&nbsp;<span class="string" id="7972407">&#34;127.0.0.1:0&#34;</span><span class="op" id="7972420">,</span>&nbsp;<span class="ident" id="7972422">nil</span><span class="op" id="7972425">,</span>&nbsp;<span class="ident" id="7972427">UnknownNetworkError</span><span class="op" id="7972446">(</span><span class="string" id="7972447">&#34;http&#34;</span><span class="op" id="7972453">)</span><span class="op" id="7972454">}</span><span class="op" id="7972455">,</span><br>
<span class="lineno"></span><span class="op" id="7972457">}</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span><span class="keyword" id="7972460">func</span>&nbsp;<span class="ident" id="7972465">init</span><span class="op" id="7972469">(</span><span class="op" id="7972470">)</span>&nbsp;<span class="op" id="7972472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7972475">if</span>&nbsp;<span class="ident" id="7972478">ifi</span>&nbsp;<span class="op" id="7972482">:=</span>&nbsp;<span class="ident" id="7972485">loopbackInterface</span><span class="op" id="7972502">(</span><span class="op" id="7972503">)</span><span class="op" id="7972504">;</span>&nbsp;<span class="ident" id="7972506">ifi</span>&nbsp;<span class="op" id="7972510">!=</span>&nbsp;<span class="ident" id="7972513">nil</span>&nbsp;<span class="op" id="7972517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7972521">index</span>&nbsp;<span class="op" id="7972527">:=</span>&nbsp;<span class="ident" id="7972530">fmt</span><span class="op" id="7972533">.</span><span class="ident" id="7972534">Sprintf</span><span class="op" id="7972541">(</span><span class="string" id="7972542">&#34;%v&#34;</span><span class="op" id="7972546">,</span>&nbsp;<span class="ident" id="7972548">ifi</span><span class="op" id="7972551">.</span><span class="ident" id="7972552">Index</span><span class="op" id="7972557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7972561">resolveTCPAddrTests</span>&nbsp;<span class="op" id="7972581">=</span>&nbsp;<span class="builtinfunc" id="7972583">append</span><span class="op" id="7972589">(</span><span class="ident" id="7972590">resolveTCPAddrTests</span><span class="op" id="7972609">,</span>&nbsp;<span class="op" id="7972611">[</span><span class="op" id="7972612">]</span><span class="ident" id="7972613">resolveTCPAddrTest</span><span class="op" id="7972631">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7972636">{</span><span class="string" id="7972637">&#34;tcp6&#34;</span><span class="op" id="7972643">,</span>&nbsp;<span class="string" id="7972645">&#34;[fe80::1%&#34;</span>&nbsp;<span class="op" id="7972657">+</span>&nbsp;<span class="ident" id="7972659">ifi</span><span class="op" id="7972662">.</span><span class="ident" id="7972663">Name</span>&nbsp;<span class="op" id="7972668">+</span>&nbsp;<span class="string" id="7972670">&#34;]:3&#34;</span><span class="op" id="7972675">,</span>&nbsp;<span class="op" id="7972677">&amp;</span><span class="ident" id="7972678">TCPAddr</span><span class="op" id="7972685">{</span><span class="ident" id="7972686">IP</span><span class="op" id="7972688">:</span>&nbsp;<span class="ident" id="7972690">ParseIP</span><span class="op" id="7972697">(</span><span class="string" id="7972698">&#34;fe80::1&#34;</span><span class="op" id="7972707">)</span><span class="op" id="7972708">,</span>&nbsp;<span class="ident" id="7972710">Port</span><span class="op" id="7972714">:</span>&nbsp;<span class="num" id="7972716">3</span><span class="op" id="7972717">,</span>&nbsp;<span class="ident" id="7972719">Zone</span><span class="op" id="7972723">:</span>&nbsp;<span class="ident" id="7972725">zoneToString</span><span class="op" id="7972737">(</span><span class="ident" id="7972738">ifi</span><span class="op" id="7972741">.</span><span class="ident" id="7972742">Index</span><span class="op" id="7972747">)</span><span class="op" id="7972748">}</span><span class="op" id="7972749">,</span>&nbsp;<span class="ident" id="7972751">nil</span><span class="op" id="7972754">}</span><span class="op" id="7972755">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7972760">{</span><span class="string" id="7972761">&#34;tcp6&#34;</span><span class="op" id="7972767">,</span>&nbsp;<span class="string" id="7972769">&#34;[fe80::1%&#34;</span>&nbsp;<span class="op" id="7972781">+</span>&nbsp;<span class="ident" id="7972783">index</span>&nbsp;<span class="op" id="7972789">+</span>&nbsp;<span class="string" id="7972791">&#34;]:4&#34;</span><span class="op" id="7972796">,</span>&nbsp;<span class="op" id="7972798">&amp;</span><span class="ident" id="7972799">TCPAddr</span><span class="op" id="7972806">{</span><span class="ident" id="7972807">IP</span><span class="op" id="7972809">:</span>&nbsp;<span class="ident" id="7972811">ParseIP</span><span class="op" id="7972818">(</span><span class="string" id="7972819">&#34;fe80::1&#34;</span><span class="op" id="7972828">)</span><span class="op" id="7972829">,</span>&nbsp;<span class="ident" id="7972831">Port</span><span class="op" id="7972835">:</span>&nbsp;<span class="num" id="7972837">4</span><span class="op" id="7972838">,</span>&nbsp;<span class="ident" id="7972840">Zone</span><span class="op" id="7972844">:</span>&nbsp;<span class="ident" id="7972846">index</span><span class="op" id="7972851">}</span><span class="op" id="7972852">,</span>&nbsp;<span class="ident" id="7972854">nil</span><span class="op" id="7972857">}</span><span class="op" id="7972858">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7972862">}</span><span class="op" id="7972863">...</span><span class="op" id="7972866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7972869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7972872">if</span>&nbsp;<span class="ident" id="7972875">ips</span><span class="op" id="7972878">,</span>&nbsp;<span class="ident" id="7972880">err</span>&nbsp;<span class="op" id="7972884">:=</span>&nbsp;<span class="ident" id="7972887">LookupIP</span><span class="op" id="7972895">(</span><span class="string" id="7972896">&#34;localhost&#34;</span><span class="op" id="7972907">)</span><span class="op" id="7972908">;</span>&nbsp;<span class="ident" id="7972910">err</span>&nbsp;<span class="op" id="7972914">==</span>&nbsp;<span class="ident" id="7972917">nil</span>&nbsp;<span class="op" id="7972921">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="7972924">len</span><span class="op" id="7972927">(</span><span class="ident" id="7972928">ips</span><span class="op" id="7972931">)</span>&nbsp;<span class="op" id="7972933">&gt;</span>&nbsp;<span class="num" id="7972935">1</span>&nbsp;<span class="op" id="7972937">&amp;&amp;</span>&nbsp;<span class="ident" id="7972940">supportsIPv4</span>&nbsp;<span class="op" id="7972953">&amp;&amp;</span>&nbsp;<span class="ident" id="7972956">supportsIPv6</span>&nbsp;<span class="op" id="7972969">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7972973">resolveTCPAddrTests</span>&nbsp;<span class="op" id="7972993">=</span>&nbsp;<span class="builtinfunc" id="7972995">append</span><span class="op" id="7973001">(</span><span class="ident" id="7973002">resolveTCPAddrTests</span><span class="op" id="7973021">,</span>&nbsp;<span class="op" id="7973023">[</span><span class="op" id="7973024">]</span><span class="ident" id="7973025">resolveTCPAddrTest</span><span class="op" id="7973043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7973048">{</span><span class="string" id="7973049">&#34;tcp&#34;</span><span class="op" id="7973054">,</span>&nbsp;<span class="string" id="7973056">&#34;localhost:5&#34;</span><span class="op" id="7973069">,</span>&nbsp;<span class="op" id="7973071">&amp;</span><span class="ident" id="7973072">TCPAddr</span><span class="op" id="7973079">{</span><span class="ident" id="7973080">IP</span><span class="op" id="7973082">:</span>&nbsp;<span class="ident" id="7973084">IPv4</span><span class="op" id="7973088">(</span><span class="num" id="7973089">127</span><span class="op" id="7973092">,</span>&nbsp;<span class="num" id="7973094">0</span><span class="op" id="7973095">,</span>&nbsp;<span class="num" id="7973097">0</span><span class="op" id="7973098">,</span>&nbsp;<span class="num" id="7973100">1</span><span class="op" id="7973101">)</span><span class="op" id="7973102">,</span>&nbsp;<span class="ident" id="7973104">Port</span><span class="op" id="7973108">:</span>&nbsp;<span class="num" id="7973110">5</span><span class="op" id="7973111">}</span><span class="op" id="7973112">,</span>&nbsp;<span class="ident" id="7973114">nil</span><span class="op" id="7973117">}</span><span class="op" id="7973118">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7973123">{</span><span class="string" id="7973124">&#34;tcp4&#34;</span><span class="op" id="7973130">,</span>&nbsp;<span class="string" id="7973132">&#34;localhost:6&#34;</span><span class="op" id="7973145">,</span>&nbsp;<span class="op" id="7973147">&amp;</span><span class="ident" id="7973148">TCPAddr</span><span class="op" id="7973155">{</span><span class="ident" id="7973156">IP</span><span class="op" id="7973158">:</span>&nbsp;<span class="ident" id="7973160">IPv4</span><span class="op" id="7973164">(</span><span class="num" id="7973165">127</span><span class="op" id="7973168">,</span>&nbsp;<span class="num" id="7973170">0</span><span class="op" id="7973171">,</span>&nbsp;<span class="num" id="7973173">0</span><span class="op" id="7973174">,</span>&nbsp;<span class="num" id="7973176">1</span><span class="op" id="7973177">)</span><span class="op" id="7973178">,</span>&nbsp;<span class="ident" id="7973180">Port</span><span class="op" id="7973184">:</span>&nbsp;<span class="num" id="7973186">6</span><span class="op" id="7973187">}</span><span class="op" id="7973188">,</span>&nbsp;<span class="ident" id="7973190">nil</span><span class="op" id="7973193">}</span><span class="op" id="7973194">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7973199">{</span><span class="string" id="7973200">&#34;tcp6&#34;</span><span class="op" id="7973206">,</span>&nbsp;<span class="string" id="7973208">&#34;localhost:7&#34;</span><span class="op" id="7973221">,</span>&nbsp;<span class="op" id="7973223">&amp;</span><span class="ident" id="7973224">TCPAddr</span><span class="op" id="7973231">{</span><span class="ident" id="7973232">IP</span><span class="op" id="7973234">:</span>&nbsp;<span class="ident" id="7973236">IPv6loopback</span><span class="op" id="7973248">,</span>&nbsp;<span class="ident" id="7973250">Port</span><span class="op" id="7973254">:</span>&nbsp;<span class="num" id="7973256">7</span><span class="op" id="7973257">}</span><span class="op" id="7973258">,</span>&nbsp;<span class="ident" id="7973260">nil</span><span class="op" id="7973263">}</span><span class="op" id="7973264">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7973268">}</span><span class="op" id="7973269">...</span><span class="op" id="7973272">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7973275">}</span><br>
<span class="lineno"></span><span class="op" id="7973277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7973280">func</span>&nbsp;<span class="ident" id="7973285">TestResolveTCPAddr</span><span class="op" id="7973303">(</span><span class="ident" id="7973304">t</span>&nbsp;<span class="op" id="7973306">*</span><span class="ident" id="7973307">testing</span><span class="op" id="7973314">.</span><span class="ident" id="7973315">T</span><span class="op" id="7973316">)</span>&nbsp;<span class="op" id="7973318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7973321">for</span>&nbsp;<span class="ident" id="7973325">_</span><span class="op" id="7973326">,</span>&nbsp;<span class="ident" id="7973328">tt</span>&nbsp;<span class="op" id="7973331">:=</span>&nbsp;<span class="keyword" id="7973334">range</span>&nbsp;<span class="ident" id="7973340">resolveTCPAddrTests</span>&nbsp;<span class="op" id="7973360">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7973364">addr</span><span class="op" id="7973368">,</span>&nbsp;<span class="ident" id="7973370">err</span>&nbsp;<span class="op" id="7973374">:=</span>&nbsp;<span class="ident" id="7973377">ResolveTCPAddr</span><span class="op" id="7973391">(</span><span class="ident" id="7973392">tt</span><span class="op" id="7973394">.</span><span class="ident" id="7973395">net</span><span class="op" id="7973398">,</span>&nbsp;<span class="ident" id="7973400">tt</span><span class="op" id="7973402">.</span><span class="ident" id="7973403">litAddrOrName</span><span class="op" id="7973416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7973420">if</span>&nbsp;<span class="ident" id="7973423">err</span>&nbsp;<span class="op" id="7973427">!=</span>&nbsp;<span class="ident" id="7973430">tt</span><span class="op" id="7973432">.</span><span class="ident" id="7973433">err</span>&nbsp;<span class="op" id="7973437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7973442">t</span><span class="op" id="7973443">.</span><span class="ident" id="7973444">Fatalf</span><span class="op" id="7973450">(</span><span class="string" id="7973451">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7973486">,</span>&nbsp;<span class="ident" id="7973488">tt</span><span class="op" id="7973490">.</span><span class="ident" id="7973491">net</span><span class="op" id="7973494">,</span>&nbsp;<span class="ident" id="7973496">tt</span><span class="op" id="7973498">.</span><span class="ident" id="7973499">litAddrOrName</span><span class="op" id="7973512">,</span>&nbsp;<span class="ident" id="7973514">err</span><span class="op" id="7973517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7973521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7973525">if</span>&nbsp;<span class="op" id="7973528">!</span><span class="ident" id="7973529">reflect</span><span class="op" id="7973536">.</span><span class="ident" id="7973537">DeepEqual</span><span class="op" id="7973546">(</span><span class="ident" id="7973547">addr</span><span class="op" id="7973551">,</span>&nbsp;<span class="ident" id="7973553">tt</span><span class="op" id="7973555">.</span><span class="ident" id="7973556">addr</span><span class="op" id="7973560">)</span>&nbsp;<span class="op" id="7973562">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7973567">t</span><span class="op" id="7973568">.</span><span class="ident" id="7973569">Fatalf</span><span class="op" id="7973575">(</span><span class="string" id="7973576">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;=&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="7973616">,</span>&nbsp;<span class="ident" id="7973618">tt</span><span class="op" id="7973620">.</span><span class="ident" id="7973621">net</span><span class="op" id="7973624">,</span>&nbsp;<span class="ident" id="7973626">tt</span><span class="op" id="7973628">.</span><span class="ident" id="7973629">litAddrOrName</span><span class="op" id="7973642">,</span>&nbsp;<span class="ident" id="7973644">addr</span><span class="op" id="7973648">,</span>&nbsp;<span class="ident" id="7973650">tt</span><span class="op" id="7973652">.</span><span class="ident" id="7973653">addr</span><span class="op" id="7973657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7973661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7973665">if</span>&nbsp;<span class="ident" id="7973668">err</span>&nbsp;<span class="op" id="7973672">==</span>&nbsp;<span class="ident" id="7973675">nil</span>&nbsp;<span class="op" id="7973679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7973684">str</span>&nbsp;<span class="op" id="7973688">:=</span>&nbsp;<span class="ident" id="7973691">addr</span><span class="op" id="7973695">.</span><span class="ident" id="7973696">String</span><span class="op" id="7973702">(</span><span class="op" id="7973703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7973708">addr1</span><span class="op" id="7973713">,</span>&nbsp;<span class="ident" id="7973715">err</span>&nbsp;<span class="op" id="7973719">:=</span>&nbsp;<span class="ident" id="7973722">ResolveTCPAddr</span><span class="op" id="7973736">(</span><span class="ident" id="7973737">tt</span><span class="op" id="7973739">.</span><span class="ident" id="7973740">net</span><span class="op" id="7973743">,</span>&nbsp;<span class="ident" id="7973745">str</span><span class="op" id="7973748">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7973753">if</span>&nbsp;<span class="ident" id="7973756">err</span>&nbsp;<span class="op" id="7973760">!=</span>&nbsp;<span class="ident" id="7973763">nil</span>&nbsp;<span class="op" id="7973767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7973773">t</span><span class="op" id="7973774">.</span><span class="ident" id="7973775">Fatalf</span><span class="op" id="7973781">(</span><span class="string" id="7973782">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;[from&nbsp;%q]:&nbsp;%v&#34;</span><span class="op" id="7973820">,</span>&nbsp;<span class="ident" id="7973822">tt</span><span class="op" id="7973824">.</span><span class="ident" id="7973825">net</span><span class="op" id="7973828">,</span>&nbsp;<span class="ident" id="7973830">str</span><span class="op" id="7973833">,</span>&nbsp;<span class="ident" id="7973835">tt</span><span class="op" id="7973837">.</span><span class="ident" id="7973838">litAddrOrName</span><span class="op" id="7973851">,</span>&nbsp;<span class="ident" id="7973853">err</span><span class="op" id="7973856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7973861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7973866">if</span>&nbsp;<span class="op" id="7973869">!</span><span class="ident" id="7973870">reflect</span><span class="op" id="7973877">.</span><span class="ident" id="7973878">DeepEqual</span><span class="op" id="7973887">(</span><span class="ident" id="7973888">addr1</span><span class="op" id="7973893">,</span>&nbsp;<span class="ident" id="7973895">addr</span><span class="op" id="7973899">)</span>&nbsp;<span class="op" id="7973901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7973907">t</span><span class="op" id="7973908">.</span><span class="ident" id="7973909">Fatalf</span><span class="op" id="7973915">(</span><span class="string" id="7973916">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;[from&nbsp;%q]&nbsp;=&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="7973966">,</span>&nbsp;<span class="ident" id="7973968">tt</span><span class="op" id="7973970">.</span><span class="ident" id="7973971">net</span><span class="op" id="7973974">,</span>&nbsp;<span class="ident" id="7973976">str</span><span class="op" id="7973979">,</span>&nbsp;<span class="ident" id="7973981">tt</span><span class="op" id="7973983">.</span><span class="ident" id="7973984">litAddrOrName</span><span class="op" id="7973997">,</span>&nbsp;<span class="ident" id="7973999">addr1</span><span class="op" id="7974004">,</span>&nbsp;<span class="ident" id="7974006">addr</span><span class="op" id="7974010">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7974015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7974019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7974022">}</span><br>
<span class="lineno"></span><span class="op" id="7974024">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span><span class="keyword" id="7974027">var</span>&nbsp;<span class="ident" id="7974031">tcpListenerNameTests</span>&nbsp;<span class="op" id="7974052">=</span>&nbsp;<span class="op" id="7974054">[</span><span class="op" id="7974055">]</span><span class="keyword" id="7974056">struct</span>&nbsp;<span class="op" id="7974063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7974066">net</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7974072">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7974080">laddr</span>&nbsp;<span class="op" id="7974086">*</span><span class="ident" id="7974087">TCPAddr</span><br>
<span class="lineno"></span><span class="op" id="7974095">}</span><span class="op" id="7974096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7974099">{</span><span class="string" id="7974100">&#34;tcp4&#34;</span><span class="op" id="7974106">,</span>&nbsp;<span class="op" id="7974108">&amp;</span><span class="ident" id="7974109">TCPAddr</span><span class="op" id="7974116">{</span><span class="ident" id="7974117">IP</span><span class="op" id="7974119">:</span>&nbsp;<span class="ident" id="7974121">IPv4</span><span class="op" id="7974125">(</span><span class="num" id="7974126">127</span><span class="op" id="7974129">,</span>&nbsp;<span class="num" id="7974131">0</span><span class="op" id="7974132">,</span>&nbsp;<span class="num" id="7974134">0</span><span class="op" id="7974135">,</span>&nbsp;<span class="num" id="7974137">1</span><span class="op" id="7974138">)</span><span class="op" id="7974139">}</span><span class="op" id="7974140">}</span><span class="op" id="7974141">,</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7974144">{</span><span class="string" id="7974145">&#34;tcp4&#34;</span><span class="op" id="7974151">,</span>&nbsp;<span class="op" id="7974153">&amp;</span><span class="ident" id="7974154">TCPAddr</span><span class="op" id="7974161">{</span><span class="op" id="7974162">}</span><span class="op" id="7974163">}</span><span class="op" id="7974164">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7974167">{</span><span class="string" id="7974168">&#34;tcp4&#34;</span><span class="op" id="7974174">,</span>&nbsp;<span class="ident" id="7974176">nil</span><span class="op" id="7974179">}</span><span class="op" id="7974180">,</span><br>
<span class="lineno"></span><span class="op" id="7974182">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7974185">func</span>&nbsp;<span class="ident" id="7974190">TestTCPListenerName</span><span class="op" id="7974209">(</span><span class="ident" id="7974210">t</span>&nbsp;<span class="op" id="7974212">*</span><span class="ident" id="7974213">testing</span><span class="op" id="7974220">.</span><span class="ident" id="7974221">T</span><span class="op" id="7974222">)</span>&nbsp;<span class="op" id="7974224">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7974227">if</span>&nbsp;<span class="ident" id="7974230">testing</span><span class="op" id="7974237">.</span><span class="ident" id="7974238">Short</span><span class="op" id="7974243">(</span><span class="op" id="7974244">)</span>&nbsp;<span class="op" id="7974246">||</span>&nbsp;<span class="op" id="7974249">!</span><span class="op" id="7974250">*</span><span class="ident" id="7974251">testExternal</span>&nbsp;<span class="op" id="7974264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7974268">t</span><span class="op" id="7974269">.</span><span class="ident" id="7974270">Skip</span><span class="op" id="7974274">(</span><span class="string" id="7974275">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="7974316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7974319">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7974323">for</span>&nbsp;<span class="ident" id="7974327">_</span><span class="op" id="7974328">,</span>&nbsp;<span class="ident" id="7974330">tt</span>&nbsp;<span class="op" id="7974333">:=</span>&nbsp;<span class="keyword" id="7974336">range</span>&nbsp;<span class="ident" id="7974342">tcpListenerNameTests</span>&nbsp;<span class="op" id="7974363">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7974367">ln</span><span class="op" id="7974369">,</span>&nbsp;<span class="ident" id="7974371">err</span>&nbsp;<span class="op" id="7974375">:=</span>&nbsp;<span class="ident" id="7974378">ListenTCP</span><span class="op" id="7974387">(</span><span class="ident" id="7974388">tt</span><span class="op" id="7974390">.</span><span class="ident" id="7974391">net</span><span class="op" id="7974394">,</span>&nbsp;<span class="ident" id="7974396">tt</span><span class="op" id="7974398">.</span><span class="ident" id="7974399">laddr</span><span class="op" id="7974404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7974408">if</span>&nbsp;<span class="ident" id="7974411">err</span>&nbsp;<span class="op" id="7974415">!=</span>&nbsp;<span class="ident" id="7974418">nil</span>&nbsp;<span class="op" id="7974422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7974427">t</span><span class="op" id="7974428">.</span><span class="ident" id="7974429">Fatalf</span><span class="op" id="7974435">(</span><span class="string" id="7974436">&#34;ListenTCP&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7974458">,</span>&nbsp;<span class="ident" id="7974460">err</span><span class="op" id="7974463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7974467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7974471">defer</span>&nbsp;<span class="ident" id="7974477">ln</span><span class="op" id="7974479">.</span><span class="ident" id="7974480">Close</span><span class="op" id="7974485">(</span><span class="op" id="7974486">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7974490">la</span>&nbsp;<span class="op" id="7974493">:=</span>&nbsp;<span class="ident" id="7974496">ln</span><span class="op" id="7974498">.</span><span class="ident" id="7974499">Addr</span><span class="op" id="7974503">(</span><span class="op" id="7974504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7974508">if</span>&nbsp;<span class="ident" id="7974511">a</span><span class="op" id="7974512">,</span>&nbsp;<span class="ident" id="7974514">ok</span>&nbsp;<span class="op" id="7974517">:=</span>&nbsp;<span class="ident" id="7974520">la</span><span class="op" id="7974522">.</span><span class="op" id="7974523">(</span><span class="op" id="7974524">*</span><span class="ident" id="7974525">TCPAddr</span><span class="op" id="7974532">)</span><span class="op" id="7974533">;</span>&nbsp;<span class="op" id="7974535">!</span><span class="ident" id="7974536">ok</span>&nbsp;<span class="op" id="7974539">||</span>&nbsp;<span class="ident" id="7974542">a</span><span class="op" id="7974543">.</span><span class="ident" id="7974544">Port</span>&nbsp;<span class="op" id="7974549">==</span>&nbsp;<span class="num" id="7974552">0</span>&nbsp;<span class="op" id="7974554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7974559">t</span><span class="op" id="7974560">.</span><span class="ident" id="7974561">Fatalf</span><span class="op" id="7974567">(</span><span class="string" id="7974568">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;non-zero&nbsp;port&nbsp;number&#34;</span><span class="op" id="7974629">,</span>&nbsp;<span class="ident" id="7974631">la</span><span class="op" id="7974633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7974637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7974640">}</span><br>
<span class="lineno">375</span><span class="op" id="7974642">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7974645">func</span>&nbsp;<span class="ident" id="7974650">TestIPv6LinkLocalUnicastTCP</span><span class="op" id="7974677">(</span><span class="ident" id="7974678">t</span>&nbsp;<span class="op" id="7974680">*</span><span class="ident" id="7974681">testing</span><span class="op" id="7974688">.</span><span class="ident" id="7974689">T</span><span class="op" id="7974690">)</span>&nbsp;<span class="op" id="7974692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7974695">if</span>&nbsp;<span class="ident" id="7974698">testing</span><span class="op" id="7974705">.</span><span class="ident" id="7974706">Short</span><span class="op" id="7974711">(</span><span class="op" id="7974712">)</span>&nbsp;<span class="op" id="7974714">||</span>&nbsp;<span class="op" id="7974717">!</span><span class="op" id="7974718">*</span><span class="ident" id="7974719">testExternal</span>&nbsp;<span class="op" id="7974732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7974736">t</span><span class="op" id="7974737">.</span><span class="ident" id="7974738">Skip</span><span class="op" id="7974742">(</span><span class="string" id="7974743">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="7974784">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7974787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7974790">if</span>&nbsp;<span class="op" id="7974793">!</span><span class="ident" id="7974794">supportsIPv6</span>&nbsp;<span class="op" id="7974807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7974811">t</span><span class="op" id="7974812">.</span><span class="ident" id="7974813">Skip</span><span class="op" id="7974817">(</span><span class="string" id="7974818">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="7974841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7974844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7974847">ifi</span>&nbsp;<span class="op" id="7974851">:=</span>&nbsp;<span class="ident" id="7974854">loopbackInterface</span><span class="op" id="7974871">(</span><span class="op" id="7974872">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7974875">if</span>&nbsp;<span class="ident" id="7974878">ifi</span>&nbsp;<span class="op" id="7974882">==</span>&nbsp;<span class="ident" id="7974885">nil</span>&nbsp;<span class="op" id="7974889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7974893">t</span><span class="op" id="7974894">.</span><span class="ident" id="7974895">Skip</span><span class="op" id="7974899">(</span><span class="string" id="7974900">&#34;loopback&nbsp;interface&nbsp;not&nbsp;found&#34;</span><span class="op" id="7974930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7974933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7974936">laddr</span>&nbsp;<span class="op" id="7974942">:=</span>&nbsp;<span class="ident" id="7974945">ipv6LinkLocalUnicastAddr</span><span class="op" id="7974969">(</span><span class="ident" id="7974970">ifi</span><span class="op" id="7974973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7974976">if</span>&nbsp;<span class="ident" id="7974979">laddr</span>&nbsp;<span class="op" id="7974985">==</span>&nbsp;<span class="string" id="7974988">&#34;&#34;</span>&nbsp;<span class="op" id="7974991">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7974995">t</span><span class="op" id="7974996">.</span><span class="ident" id="7974997">Skip</span><span class="op" id="7975001">(</span><span class="string" id="7975002">&#34;ipv6&nbsp;unicast&nbsp;address&nbsp;on&nbsp;loopback&nbsp;not&nbsp;found&#34;</span><span class="op" id="7975046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7975049">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7975053">type</span>&nbsp;<span class="ident" id="7975058">test</span>&nbsp;<span class="keyword" id="7975063">struct</span>&nbsp;<span class="op" id="7975070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7975074">net</span><span class="op" id="7975077">,</span>&nbsp;<span class="ident" id="7975079">addr</span>&nbsp;&nbsp;<span class="builtintype" id="7975085">string</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7975094">nameLookup</span>&nbsp;<span class="builtintype" id="7975105">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7975111">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7975114">var</span>&nbsp;<span class="ident" id="7975118">tests</span>&nbsp;<span class="op" id="7975124">=</span>&nbsp;<span class="op" id="7975126">[</span><span class="op" id="7975127">]</span><span class="ident" id="7975128">test</span><span class="op" id="7975132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7975136">{</span><span class="string" id="7975137">&#34;tcp&#34;</span><span class="op" id="7975142">,</span>&nbsp;<span class="string" id="7975144">&#34;[&#34;</span>&nbsp;<span class="op" id="7975148">+</span>&nbsp;<span class="ident" id="7975150">laddr</span>&nbsp;<span class="op" id="7975156">+</span>&nbsp;<span class="string" id="7975158">&#34;%&#34;</span>&nbsp;<span class="op" id="7975162">+</span>&nbsp;<span class="ident" id="7975164">ifi</span><span class="op" id="7975167">.</span><span class="ident" id="7975168">Name</span>&nbsp;<span class="op" id="7975173">+</span>&nbsp;<span class="string" id="7975175">&#34;]:0&#34;</span><span class="op" id="7975180">,</span>&nbsp;<span class="builtintype" id="7975182">false</span><span class="op" id="7975187">}</span><span class="op" id="7975188">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7975192">{</span><span class="string" id="7975193">&#34;tcp6&#34;</span><span class="op" id="7975199">,</span>&nbsp;<span class="string" id="7975201">&#34;[&#34;</span>&nbsp;<span class="op" id="7975205">+</span>&nbsp;<span class="ident" id="7975207">laddr</span>&nbsp;<span class="op" id="7975213">+</span>&nbsp;<span class="string" id="7975215">&#34;%&#34;</span>&nbsp;<span class="op" id="7975219">+</span>&nbsp;<span class="ident" id="7975221">ifi</span><span class="op" id="7975224">.</span><span class="ident" id="7975225">Name</span>&nbsp;<span class="op" id="7975230">+</span>&nbsp;<span class="string" id="7975232">&#34;]:0&#34;</span><span class="op" id="7975237">,</span>&nbsp;<span class="builtintype" id="7975239">false</span><span class="op" id="7975244">}</span><span class="op" id="7975245">,</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7975248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7975251">switch</span>&nbsp;<span class="ident" id="7975258">runtime</span><span class="op" id="7975265">.</span><span class="ident" id="7975266">GOOS</span>&nbsp;<span class="op" id="7975271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7975274">case</span>&nbsp;<span class="string" id="7975279">&#34;darwin&#34;</span><span class="op" id="7975287">,</span>&nbsp;<span class="string" id="7975289">&#34;freebsd&#34;</span><span class="op" id="7975298">,</span>&nbsp;<span class="string" id="7975300">&#34;openbsd&#34;</span><span class="op" id="7975309">,</span>&nbsp;<span class="string" id="7975311">&#34;netbsd&#34;</span><span class="op" id="7975319">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7975323">tests</span>&nbsp;<span class="op" id="7975329">=</span>&nbsp;<span class="builtinfunc" id="7975331">append</span><span class="op" id="7975337">(</span><span class="ident" id="7975338">tests</span><span class="op" id="7975343">,</span>&nbsp;<span class="op" id="7975345">[</span><span class="op" id="7975346">]</span><span class="ident" id="7975347">test</span><span class="op" id="7975351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7975356">{</span><span class="string" id="7975357">&#34;tcp&#34;</span><span class="op" id="7975362">,</span>&nbsp;<span class="string" id="7975364">&#34;[localhost%&#34;</span>&nbsp;<span class="op" id="7975378">+</span>&nbsp;<span class="ident" id="7975380">ifi</span><span class="op" id="7975383">.</span><span class="ident" id="7975384">Name</span>&nbsp;<span class="op" id="7975389">+</span>&nbsp;<span class="string" id="7975391">&#34;]:0&#34;</span><span class="op" id="7975396">,</span>&nbsp;<span class="builtintype" id="7975398">true</span><span class="op" id="7975402">}</span><span class="op" id="7975403">,</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7975408">{</span><span class="string" id="7975409">&#34;tcp6&#34;</span><span class="op" id="7975415">,</span>&nbsp;<span class="string" id="7975417">&#34;[localhost%&#34;</span>&nbsp;<span class="op" id="7975431">+</span>&nbsp;<span class="ident" id="7975433">ifi</span><span class="op" id="7975436">.</span><span class="ident" id="7975437">Name</span>&nbsp;<span class="op" id="7975442">+</span>&nbsp;<span class="string" id="7975444">&#34;]:0&#34;</span><span class="op" id="7975449">,</span>&nbsp;<span class="builtintype" id="7975451">true</span><span class="op" id="7975455">}</span><span class="op" id="7975456">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7975460">}</span><span class="op" id="7975461">...</span><span class="op" id="7975464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7975467">case</span>&nbsp;<span class="string" id="7975472">&#34;linux&#34;</span><span class="op" id="7975479">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7975483">tests</span>&nbsp;<span class="op" id="7975489">=</span>&nbsp;<span class="builtinfunc" id="7975491">append</span><span class="op" id="7975497">(</span><span class="ident" id="7975498">tests</span><span class="op" id="7975503">,</span>&nbsp;<span class="op" id="7975505">[</span><span class="op" id="7975506">]</span><span class="ident" id="7975507">test</span><span class="op" id="7975511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7975516">{</span><span class="string" id="7975517">&#34;tcp&#34;</span><span class="op" id="7975522">,</span>&nbsp;<span class="string" id="7975524">&#34;[ip6-localhost%&#34;</span>&nbsp;<span class="op" id="7975542">+</span>&nbsp;<span class="ident" id="7975544">ifi</span><span class="op" id="7975547">.</span><span class="ident" id="7975548">Name</span>&nbsp;<span class="op" id="7975553">+</span>&nbsp;<span class="string" id="7975555">&#34;]:0&#34;</span><span class="op" id="7975560">,</span>&nbsp;<span class="builtintype" id="7975562">true</span><span class="op" id="7975566">}</span><span class="op" id="7975567">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7975572">{</span><span class="string" id="7975573">&#34;tcp6&#34;</span><span class="op" id="7975579">,</span>&nbsp;<span class="string" id="7975581">&#34;[ip6-localhost%&#34;</span>&nbsp;<span class="op" id="7975599">+</span>&nbsp;<span class="ident" id="7975601">ifi</span><span class="op" id="7975604">.</span><span class="ident" id="7975605">Name</span>&nbsp;<span class="op" id="7975610">+</span>&nbsp;<span class="string" id="7975612">&#34;]:0&#34;</span><span class="op" id="7975617">,</span>&nbsp;<span class="builtintype" id="7975619">true</span><span class="op" id="7975623">}</span><span class="op" id="7975624">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7975628">}</span><span class="op" id="7975629">...</span><span class="op" id="7975632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7975635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7975638">for</span>&nbsp;<span class="ident" id="7975642">_</span><span class="op" id="7975643">,</span>&nbsp;<span class="ident" id="7975645">tt</span>&nbsp;<span class="op" id="7975648">:=</span>&nbsp;<span class="keyword" id="7975651">range</span>&nbsp;<span class="ident" id="7975657">tests</span>&nbsp;<span class="op" id="7975663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7975667">ln</span><span class="op" id="7975669">,</span>&nbsp;<span class="ident" id="7975671">err</span>&nbsp;<span class="op" id="7975675">:=</span>&nbsp;<span class="ident" id="7975678">Listen</span><span class="op" id="7975684">(</span><span class="ident" id="7975685">tt</span><span class="op" id="7975687">.</span><span class="ident" id="7975688">net</span><span class="op" id="7975691">,</span>&nbsp;<span class="ident" id="7975693">tt</span><span class="op" id="7975695">.</span><span class="ident" id="7975696">addr</span><span class="op" id="7975700">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7975704">if</span>&nbsp;<span class="ident" id="7975707">err</span>&nbsp;<span class="op" id="7975711">!=</span>&nbsp;<span class="ident" id="7975714">nil</span>&nbsp;<span class="op" id="7975718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7975723">//&nbsp;It&nbsp;might&nbsp;return&nbsp;&#34;LookupHost&nbsp;returned&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7975769">//&nbsp;suitable&nbsp;address&#34;&nbsp;error&nbsp;on&nbsp;some&nbsp;platforms.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7975818">t</span><span class="op" id="7975819">.</span><span class="ident" id="7975820">Logf</span><span class="op" id="7975824">(</span><span class="string" id="7975825">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7975844">,</span>&nbsp;<span class="ident" id="7975846">err</span><span class="op" id="7975849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7975854">continue</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7975865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7975869">defer</span>&nbsp;<span class="ident" id="7975875">ln</span><span class="op" id="7975877">.</span><span class="ident" id="7975878">Close</span><span class="op" id="7975883">(</span><span class="op" id="7975884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7975888">if</span>&nbsp;<span class="ident" id="7975891">la</span><span class="op" id="7975893">,</span>&nbsp;<span class="ident" id="7975895">ok</span>&nbsp;<span class="op" id="7975898">:=</span>&nbsp;<span class="ident" id="7975901">ln</span><span class="op" id="7975903">.</span><span class="ident" id="7975904">Addr</span><span class="op" id="7975908">(</span><span class="op" id="7975909">)</span><span class="op" id="7975910">.</span><span class="op" id="7975911">(</span><span class="op" id="7975912">*</span><span class="ident" id="7975913">TCPAddr</span><span class="op" id="7975920">)</span><span class="op" id="7975921">;</span>&nbsp;<span class="op" id="7975923">!</span><span class="ident" id="7975924">ok</span>&nbsp;<span class="op" id="7975927">||</span>&nbsp;<span class="op" id="7975930">!</span><span class="ident" id="7975931">tt</span><span class="op" id="7975933">.</span><span class="ident" id="7975934">nameLookup</span>&nbsp;<span class="op" id="7975945">&amp;&amp;</span>&nbsp;<span class="ident" id="7975948">la</span><span class="op" id="7975950">.</span><span class="ident" id="7975951">Zone</span>&nbsp;<span class="op" id="7975956">==</span>&nbsp;<span class="string" id="7975959">&#34;&#34;</span>&nbsp;<span class="op" id="7975962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7975967">t</span><span class="op" id="7975968">.</span><span class="ident" id="7975969">Fatalf</span><span class="op" id="7975975">(</span><span class="string" id="7975976">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="7976032">,</span>&nbsp;<span class="ident" id="7976034">la</span><span class="op" id="7976036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7976040">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7976045">done</span>&nbsp;<span class="op" id="7976050">:=</span>&nbsp;<span class="builtinfunc" id="7976053">make</span><span class="op" id="7976057">(</span><span class="keyword" id="7976058">chan</span>&nbsp;<span class="builtintype" id="7976063">int</span><span class="op" id="7976066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7976070">go</span>&nbsp;<span class="ident" id="7976073">transponder</span><span class="op" id="7976084">(</span><span class="ident" id="7976085">t</span><span class="op" id="7976086">,</span>&nbsp;<span class="ident" id="7976088">ln</span><span class="op" id="7976090">,</span>&nbsp;<span class="ident" id="7976092">done</span><span class="op" id="7976096">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7976101">c</span><span class="op" id="7976102">,</span>&nbsp;<span class="ident" id="7976104">err</span>&nbsp;<span class="op" id="7976108">:=</span>&nbsp;<span class="ident" id="7976111">Dial</span><span class="op" id="7976115">(</span><span class="ident" id="7976116">tt</span><span class="op" id="7976118">.</span><span class="ident" id="7976119">net</span><span class="op" id="7976122">,</span>&nbsp;<span class="ident" id="7976124">ln</span><span class="op" id="7976126">.</span><span class="ident" id="7976127">Addr</span><span class="op" id="7976131">(</span><span class="op" id="7976132">)</span><span class="op" id="7976133">.</span><span class="ident" id="7976134">String</span><span class="op" id="7976140">(</span><span class="op" id="7976141">)</span><span class="op" id="7976142">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7976146">if</span>&nbsp;<span class="ident" id="7976149">err</span>&nbsp;<span class="op" id="7976153">!=</span>&nbsp;<span class="ident" id="7976156">nil</span>&nbsp;<span class="op" id="7976160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7976165">t</span><span class="op" id="7976166">.</span><span class="ident" id="7976167">Fatalf</span><span class="op" id="7976173">(</span><span class="string" id="7976174">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7976191">,</span>&nbsp;<span class="ident" id="7976193">err</span><span class="op" id="7976196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7976200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7976204">defer</span>&nbsp;<span class="ident" id="7976210">c</span><span class="op" id="7976211">.</span><span class="ident" id="7976212">Close</span><span class="op" id="7976217">(</span><span class="op" id="7976218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7976222">if</span>&nbsp;<span class="ident" id="7976225">la</span><span class="op" id="7976227">,</span>&nbsp;<span class="ident" id="7976229">ok</span>&nbsp;<span class="op" id="7976232">:=</span>&nbsp;<span class="ident" id="7976235">c</span><span class="op" id="7976236">.</span><span class="ident" id="7976237">LocalAddr</span><span class="op" id="7976246">(</span><span class="op" id="7976247">)</span><span class="op" id="7976248">.</span><span class="op" id="7976249">(</span><span class="op" id="7976250">*</span><span class="ident" id="7976251">TCPAddr</span><span class="op" id="7976258">)</span><span class="op" id="7976259">;</span>&nbsp;<span class="op" id="7976261">!</span><span class="ident" id="7976262">ok</span>&nbsp;<span class="op" id="7976265">||</span>&nbsp;<span class="op" id="7976268">!</span><span class="ident" id="7976269">tt</span><span class="op" id="7976271">.</span><span class="ident" id="7976272">nameLookup</span>&nbsp;<span class="op" id="7976283">&amp;&amp;</span>&nbsp;<span class="ident" id="7976286">la</span><span class="op" id="7976288">.</span><span class="ident" id="7976289">Zone</span>&nbsp;<span class="op" id="7976294">==</span>&nbsp;<span class="string" id="7976297">&#34;&#34;</span>&nbsp;<span class="op" id="7976300">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7976305">t</span><span class="op" id="7976306">.</span><span class="ident" id="7976307">Fatalf</span><span class="op" id="7976313">(</span><span class="string" id="7976314">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="7976370">,</span>&nbsp;<span class="ident" id="7976372">la</span><span class="op" id="7976374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7976378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7976382">if</span>&nbsp;<span class="ident" id="7976385">ra</span><span class="op" id="7976387">,</span>&nbsp;<span class="ident" id="7976389">ok</span>&nbsp;<span class="op" id="7976392">:=</span>&nbsp;<span class="ident" id="7976395">c</span><span class="op" id="7976396">.</span><span class="ident" id="7976397">RemoteAddr</span><span class="op" id="7976407">(</span><span class="op" id="7976408">)</span><span class="op" id="7976409">.</span><span class="op" id="7976410">(</span><span class="op" id="7976411">*</span><span class="ident" id="7976412">TCPAddr</span><span class="op" id="7976419">)</span><span class="op" id="7976420">;</span>&nbsp;<span class="op" id="7976422">!</span><span class="ident" id="7976423">ok</span>&nbsp;<span class="op" id="7976426">||</span>&nbsp;<span class="op" id="7976429">!</span><span class="ident" id="7976430">tt</span><span class="op" id="7976432">.</span><span class="ident" id="7976433">nameLookup</span>&nbsp;<span class="op" id="7976444">&amp;&amp;</span>&nbsp;<span class="ident" id="7976447">ra</span><span class="op" id="7976449">.</span><span class="ident" id="7976450">Zone</span>&nbsp;<span class="op" id="7976455">==</span>&nbsp;<span class="string" id="7976458">&#34;&#34;</span>&nbsp;<span class="op" id="7976461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7976466">t</span><span class="op" id="7976467">.</span><span class="ident" id="7976468">Fatalf</span><span class="op" id="7976474">(</span><span class="string" id="7976475">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="7976531">,</span>&nbsp;<span class="ident" id="7976533">ra</span><span class="op" id="7976535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7976539">}</span><br>
<span class="lineno">440</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7976544">if</span>&nbsp;<span class="ident" id="7976547">_</span><span class="op" id="7976548">,</span>&nbsp;<span class="ident" id="7976550">err</span>&nbsp;<span class="op" id="7976554">:=</span>&nbsp;<span class="ident" id="7976557">c</span><span class="op" id="7976558">.</span><span class="ident" id="7976559">Write</span><span class="op" id="7976564">(</span><span class="op" id="7976565">[</span><span class="op" id="7976566">]</span><span class="builtintype" id="7976567">byte</span><span class="op" id="7976571">(</span><span class="string" id="7976572">&#34;TCP&nbsp;OVER&nbsp;IPV6&nbsp;LINKLOCAL&nbsp;TEST&#34;</span><span class="op" id="7976602">)</span><span class="op" id="7976603">)</span><span class="op" id="7976604">;</span>&nbsp;<span class="ident" id="7976606">err</span>&nbsp;<span class="op" id="7976610">!=</span>&nbsp;<span class="ident" id="7976613">nil</span>&nbsp;<span class="op" id="7976617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7976622">t</span><span class="op" id="7976623">.</span><span class="ident" id="7976624">Fatalf</span><span class="op" id="7976630">(</span><span class="string" id="7976631">&#34;Conn.Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7976654">,</span>&nbsp;<span class="ident" id="7976656">err</span><span class="op" id="7976659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7976663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7976667">b</span>&nbsp;<span class="op" id="7976669">:=</span>&nbsp;<span class="builtinfunc" id="7976672">make</span><span class="op" id="7976676">(</span><span class="op" id="7976677">[</span><span class="op" id="7976678">]</span><span class="builtintype" id="7976679">byte</span><span class="op" id="7976683">,</span>&nbsp;<span class="num" id="7976685">32</span><span class="op" id="7976687">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7976691">if</span>&nbsp;<span class="ident" id="7976694">_</span><span class="op" id="7976695">,</span>&nbsp;<span class="ident" id="7976697">err</span>&nbsp;<span class="op" id="7976701">:=</span>&nbsp;<span class="ident" id="7976704">c</span><span class="op" id="7976705">.</span><span class="ident" id="7976706">Read</span><span class="op" id="7976710">(</span><span class="ident" id="7976711">b</span><span class="op" id="7976712">)</span><span class="op" id="7976713">;</span>&nbsp;<span class="ident" id="7976715">err</span>&nbsp;<span class="op" id="7976719">!=</span>&nbsp;<span class="ident" id="7976722">nil</span>&nbsp;<span class="op" id="7976726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7976731">t</span><span class="op" id="7976732">.</span><span class="ident" id="7976733">Fatalf</span><span class="op" id="7976739">(</span><span class="string" id="7976740">&#34;Conn.Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7976762">,</span>&nbsp;<span class="ident" id="7976764">err</span><span class="op" id="7976767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7976771">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7976776">&lt;-</span><span class="ident" id="7976778">done</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7976784">}</span><br>
<span class="lineno"></span><span class="op" id="7976786">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7976789">func</span>&nbsp;<span class="ident" id="7976794">TestTCPConcurrentAccept</span><span class="op" id="7976817">(</span><span class="ident" id="7976818">t</span>&nbsp;<span class="op" id="7976820">*</span><span class="ident" id="7976821">testing</span><span class="op" id="7976828">.</span><span class="ident" id="7976829">T</span><span class="op" id="7976830">)</span>&nbsp;<span class="op" id="7976832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7976835">defer</span>&nbsp;<span class="ident" id="7976841">runtime</span><span class="op" id="7976848">.</span><span class="ident" id="7976849">GOMAXPROCS</span><span class="op" id="7976859">(</span><span class="ident" id="7976860">runtime</span><span class="op" id="7976867">.</span><span class="ident" id="7976868">GOMAXPROCS</span><span class="op" id="7976878">(</span><span class="num" id="7976879">4</span><span class="op" id="7976880">)</span><span class="op" id="7976881">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7976884">ln</span><span class="op" id="7976886">,</span>&nbsp;<span class="ident" id="7976888">err</span>&nbsp;<span class="op" id="7976892">:=</span>&nbsp;<span class="ident" id="7976895">Listen</span><span class="op" id="7976901">(</span><span class="string" id="7976902">&#34;tcp&#34;</span><span class="op" id="7976907">,</span>&nbsp;<span class="string" id="7976909">&#34;127.0.0.1:0&#34;</span><span class="op" id="7976922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7976925">if</span>&nbsp;<span class="ident" id="7976928">err</span>&nbsp;<span class="op" id="7976932">!=</span>&nbsp;<span class="ident" id="7976935">nil</span>&nbsp;<span class="op" id="7976939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7976943">t</span><span class="op" id="7976944">.</span><span class="ident" id="7976945">Fatalf</span><span class="op" id="7976951">(</span><span class="string" id="7976952">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7976971">,</span>&nbsp;<span class="ident" id="7976973">err</span><span class="op" id="7976976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7976979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7976982">const</span>&nbsp;<span class="ident" id="7976988">N</span>&nbsp;<span class="op" id="7976990">=</span>&nbsp;<span class="num" id="7976992">10</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7976996">var</span>&nbsp;<span class="ident" id="7977000">wg</span>&nbsp;<span class="ident" id="7977003">sync</span><span class="op" id="7977007">.</span><span class="ident" id="7977008">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7977019">wg</span><span class="op" id="7977021">.</span><span class="ident" id="7977022">Add</span><span class="op" id="7977025">(</span><span class="ident" id="7977026">N</span><span class="op" id="7977027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7977030">for</span>&nbsp;<span class="ident" id="7977034">i</span>&nbsp;<span class="op" id="7977036">:=</span>&nbsp;<span class="num" id="7977039">0</span><span class="op" id="7977040">;</span>&nbsp;<span class="ident" id="7977042">i</span>&nbsp;<span class="op" id="7977044">&lt;</span>&nbsp;<span class="ident" id="7977046">N</span><span class="op" id="7977047">;</span>&nbsp;<span class="ident" id="7977049">i</span><span class="op" id="7977050">++</span>&nbsp;<span class="op" id="7977053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7977057">go</span>&nbsp;<span class="keyword" id="7977060">func</span><span class="op" id="7977064">(</span><span class="op" id="7977065">)</span>&nbsp;<span class="op" id="7977067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7977072">for</span>&nbsp;<span class="op" id="7977076">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7977082">c</span><span class="op" id="7977083">,</span>&nbsp;<span class="ident" id="7977085">err</span>&nbsp;<span class="op" id="7977089">:=</span>&nbsp;<span class="ident" id="7977092">ln</span><span class="op" id="7977094">.</span><span class="ident" id="7977095">Accept</span><span class="op" id="7977101">(</span><span class="op" id="7977102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7977108">if</span>&nbsp;<span class="ident" id="7977111">err</span>&nbsp;<span class="op" id="7977115">!=</span>&nbsp;<span class="ident" id="7977118">nil</span>&nbsp;<span class="op" id="7977122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7977129">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7977139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7977145">c</span><span class="op" id="7977146">.</span><span class="ident" id="7977147">Close</span><span class="op" id="7977152">(</span><span class="op" id="7977153">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7977158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7977163">wg</span><span class="op" id="7977165">.</span><span class="ident" id="7977166">Done</span><span class="op" id="7977170">(</span><span class="op" id="7977171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7977175">}</span><span class="op" id="7977176">(</span><span class="op" id="7977177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7977180">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7977183">attempts</span>&nbsp;<span class="op" id="7977192">:=</span>&nbsp;<span class="num" id="7977195">10</span>&nbsp;<span class="op" id="7977198">*</span>&nbsp;<span class="ident" id="7977200">N</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7977203">fails</span>&nbsp;<span class="op" id="7977209">:=</span>&nbsp;<span class="num" id="7977212">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7977215">d</span>&nbsp;<span class="op" id="7977217">:=</span>&nbsp;<span class="op" id="7977220">&amp;</span><span class="ident" id="7977221">Dialer</span><span class="op" id="7977227">{</span><span class="ident" id="7977228">Timeout</span><span class="op" id="7977235">:</span>&nbsp;<span class="num" id="7977237">200</span>&nbsp;<span class="op" id="7977241">*</span>&nbsp;<span class="ident" id="7977243">time</span><span class="op" id="7977247">.</span><span class="ident" id="7977248">Millisecond</span><span class="op" id="7977259">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7977262">for</span>&nbsp;<span class="ident" id="7977266">i</span>&nbsp;<span class="op" id="7977268">:=</span>&nbsp;<span class="num" id="7977271">0</span><span class="op" id="7977272">;</span>&nbsp;<span class="ident" id="7977274">i</span>&nbsp;<span class="op" id="7977276">&lt;</span>&nbsp;<span class="ident" id="7977278">attempts</span><span class="op" id="7977286">;</span>&nbsp;<span class="ident" id="7977288">i</span><span class="op" id="7977289">++</span>&nbsp;<span class="op" id="7977292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7977296">c</span><span class="op" id="7977297">,</span>&nbsp;<span class="ident" id="7977299">err</span>&nbsp;<span class="op" id="7977303">:=</span>&nbsp;<span class="ident" id="7977306">d</span><span class="op" id="7977307">.</span><span class="ident" id="7977308">Dial</span><span class="op" id="7977312">(</span><span class="string" id="7977313">&#34;tcp&#34;</span><span class="op" id="7977318">,</span>&nbsp;<span class="ident" id="7977320">ln</span><span class="op" id="7977322">.</span><span class="ident" id="7977323">Addr</span><span class="op" id="7977327">(</span><span class="op" id="7977328">)</span><span class="op" id="7977329">.</span><span class="ident" id="7977330">String</span><span class="op" id="7977336">(</span><span class="op" id="7977337">)</span><span class="op" id="7977338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7977342">if</span>&nbsp;<span class="ident" id="7977345">err</span>&nbsp;<span class="op" id="7977349">!=</span>&nbsp;<span class="ident" id="7977352">nil</span>&nbsp;<span class="op" id="7977356">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7977361">fails</span><span class="op" id="7977366">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7977371">}</span>&nbsp;<span class="keyword" id="7977373">else</span>&nbsp;<span class="op" id="7977378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7977383">c</span><span class="op" id="7977384">.</span><span class="ident" id="7977385">Close</span><span class="op" id="7977390">(</span><span class="op" id="7977391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7977395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7977398">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7977401">ln</span><span class="op" id="7977403">.</span><span class="ident" id="7977404">Close</span><span class="op" id="7977409">(</span><span class="op" id="7977410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7977413">wg</span><span class="op" id="7977415">.</span><span class="ident" id="7977416">Wait</span><span class="op" id="7977420">(</span><span class="op" id="7977421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7977424">if</span>&nbsp;<span class="ident" id="7977427">fails</span>&nbsp;<span class="op" id="7977433">&gt;</span>&nbsp;<span class="ident" id="7977435">attempts</span><span class="op" id="7977443">/</span><span class="num" id="7977444">9</span>&nbsp;<span class="op" id="7977446">{</span>&nbsp;<span class="comment" id="7977448">//&nbsp;see&nbsp;issues&nbsp;7400&nbsp;and&nbsp;7541</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7977478">t</span><span class="op" id="7977479">.</span><span class="ident" id="7977480">Fatalf</span><span class="op" id="7977486">(</span><span class="string" id="7977487">&#34;too&nbsp;many&nbsp;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7977513">,</span>&nbsp;<span class="ident" id="7977515">fails</span><span class="op" id="7977520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7977523">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7977526">if</span>&nbsp;<span class="ident" id="7977529">fails</span>&nbsp;<span class="op" id="7977535">&gt;</span>&nbsp;<span class="num" id="7977537">0</span>&nbsp;<span class="op" id="7977539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7977543">t</span><span class="op" id="7977544">.</span><span class="ident" id="7977545">Logf</span><span class="op" id="7977549">(</span><span class="string" id="7977550">&#34;#&nbsp;of&nbsp;failed&nbsp;Dials:&nbsp;%v&#34;</span><span class="op" id="7977573">,</span>&nbsp;<span class="ident" id="7977575">fails</span><span class="op" id="7977580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7977583">}</span><br>
<span class="lineno"></span><span class="op" id="7977585">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="keyword" id="7977588">func</span>&nbsp;<span class="ident" id="7977593">TestTCPReadWriteMallocs</span><span class="op" id="7977616">(</span><span class="ident" id="7977617">t</span>&nbsp;<span class="op" id="7977619">*</span><span class="ident" id="7977620">testing</span><span class="op" id="7977627">.</span><span class="ident" id="7977628">T</span><span class="op" id="7977629">)</span>&nbsp;<span class="op" id="7977631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7977634">if</span>&nbsp;<span class="ident" id="7977637">testing</span><span class="op" id="7977644">.</span><span class="ident" id="7977645">Short</span><span class="op" id="7977650">(</span><span class="op" id="7977651">)</span>&nbsp;<span class="op" id="7977653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7977657">t</span><span class="op" id="7977658">.</span><span class="ident" id="7977659">Skip</span><span class="op" id="7977663">(</span><span class="string" id="7977664">&#34;skipping&nbsp;malloc&nbsp;count&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="7977701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7977704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7977707">ln</span><span class="op" id="7977709">,</span>&nbsp;<span class="ident" id="7977711">err</span>&nbsp;<span class="op" id="7977715">:=</span>&nbsp;<span class="ident" id="7977718">Listen</span><span class="op" id="7977724">(</span><span class="string" id="7977725">&#34;tcp&#34;</span><span class="op" id="7977730">,</span>&nbsp;<span class="string" id="7977732">&#34;127.0.0.1:0&#34;</span><span class="op" id="7977745">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7977748">if</span>&nbsp;<span class="ident" id="7977751">err</span>&nbsp;<span class="op" id="7977755">!=</span>&nbsp;<span class="ident" id="7977758">nil</span>&nbsp;<span class="op" id="7977762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7977766">t</span><span class="op" id="7977767">.</span><span class="ident" id="7977768">Fatalf</span><span class="op" id="7977774">(</span><span class="string" id="7977775">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7977794">,</span>&nbsp;<span class="ident" id="7977796">err</span><span class="op" id="7977799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7977802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7977805">defer</span>&nbsp;<span class="ident" id="7977811">ln</span><span class="op" id="7977813">.</span><span class="ident" id="7977814">Close</span><span class="op" id="7977819">(</span><span class="op" id="7977820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7977823">var</span>&nbsp;<span class="ident" id="7977827">server</span>&nbsp;<span class="ident" id="7977834">Conn</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7977840">errc</span>&nbsp;<span class="op" id="7977845">:=</span>&nbsp;<span class="builtinfunc" id="7977848">make</span><span class="op" id="7977852">(</span><span class="keyword" id="7977853">chan</span>&nbsp;<span class="builtintype" id="7977858">error</span><span class="op" id="7977863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7977866">go</span>&nbsp;<span class="keyword" id="7977869">func</span><span class="op" id="7977873">(</span><span class="op" id="7977874">)</span>&nbsp;<span class="op" id="7977876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7977880">var</span>&nbsp;<span class="ident" id="7977884">err</span>&nbsp;<span class="builtintype" id="7977888">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7977896">server</span><span class="op" id="7977902">,</span>&nbsp;<span class="ident" id="7977904">err</span>&nbsp;<span class="op" id="7977908">=</span>&nbsp;<span class="ident" id="7977910">ln</span><span class="op" id="7977912">.</span><span class="ident" id="7977913">Accept</span><span class="op" id="7977919">(</span><span class="op" id="7977920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7977924">errc</span>&nbsp;<span class="op" id="7977929">&lt;-</span>&nbsp;<span class="ident" id="7977932">err</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7977937">}</span><span class="op" id="7977938">(</span><span class="op" id="7977939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7977942">client</span><span class="op" id="7977948">,</span>&nbsp;<span class="ident" id="7977950">err</span>&nbsp;<span class="op" id="7977954">:=</span>&nbsp;<span class="ident" id="7977957">Dial</span><span class="op" id="7977961">(</span><span class="string" id="7977962">&#34;tcp&#34;</span><span class="op" id="7977967">,</span>&nbsp;<span class="ident" id="7977969">ln</span><span class="op" id="7977971">.</span><span class="ident" id="7977972">Addr</span><span class="op" id="7977976">(</span><span class="op" id="7977977">)</span><span class="op" id="7977978">.</span><span class="ident" id="7977979">String</span><span class="op" id="7977985">(</span><span class="op" id="7977986">)</span><span class="op" id="7977987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7977990">if</span>&nbsp;<span class="ident" id="7977993">err</span>&nbsp;<span class="op" id="7977997">!=</span>&nbsp;<span class="ident" id="7978000">nil</span>&nbsp;<span class="op" id="7978004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7978008">t</span><span class="op" id="7978009">.</span><span class="ident" id="7978010">Fatalf</span><span class="op" id="7978016">(</span><span class="string" id="7978017">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7978034">,</span>&nbsp;<span class="ident" id="7978036">err</span><span class="op" id="7978039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7978042">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7978045">if</span>&nbsp;<span class="ident" id="7978048">err</span>&nbsp;<span class="op" id="7978052">:=</span>&nbsp;<span class="op" id="7978055">&lt;-</span><span class="ident" id="7978057">errc</span><span class="op" id="7978061">;</span>&nbsp;<span class="ident" id="7978063">err</span>&nbsp;<span class="op" id="7978067">!=</span>&nbsp;<span class="ident" id="7978070">nil</span>&nbsp;<span class="op" id="7978074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7978078">t</span><span class="op" id="7978079">.</span><span class="ident" id="7978080">Fatalf</span><span class="op" id="7978086">(</span><span class="string" id="7978087">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7978106">,</span>&nbsp;<span class="ident" id="7978108">err</span><span class="op" id="7978111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7978114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7978117">defer</span>&nbsp;<span class="ident" id="7978123">server</span><span class="op" id="7978129">.</span><span class="ident" id="7978130">Close</span><span class="op" id="7978135">(</span><span class="op" id="7978136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7978139">var</span>&nbsp;<span class="ident" id="7978143">buf</span>&nbsp;<span class="op" id="7978147">[</span><span class="num" id="7978148">128</span><span class="op" id="7978151">]</span><span class="builtintype" id="7978152">byte</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7978158">mallocs</span>&nbsp;<span class="op" id="7978166">:=</span>&nbsp;<span class="ident" id="7978169">testing</span><span class="op" id="7978176">.</span><span class="ident" id="7978177">AllocsPerRun</span><span class="op" id="7978189">(</span><span class="num" id="7978190">1000</span><span class="op" id="7978194">,</span>&nbsp;<span class="keyword" id="7978196">func</span><span class="op" id="7978200">(</span><span class="op" id="7978201">)</span>&nbsp;<span class="op" id="7978203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7978207">_</span><span class="op" id="7978208">,</span>&nbsp;<span class="ident" id="7978210">err</span>&nbsp;<span class="op" id="7978214">:=</span>&nbsp;<span class="ident" id="7978217">server</span><span class="op" id="7978223">.</span><span class="ident" id="7978224">Write</span><span class="op" id="7978229">(</span><span class="ident" id="7978230">buf</span><span class="op" id="7978233">[</span><span class="op" id="7978234">:</span><span class="op" id="7978235">]</span><span class="op" id="7978236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7978240">if</span>&nbsp;<span class="ident" id="7978243">err</span>&nbsp;<span class="op" id="7978247">!=</span>&nbsp;<span class="ident" id="7978250">nil</span>&nbsp;<span class="op" id="7978254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7978259">t</span><span class="op" id="7978260">.</span><span class="ident" id="7978261">Fatalf</span><span class="op" id="7978267">(</span><span class="string" id="7978268">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7978286">,</span>&nbsp;<span class="ident" id="7978288">err</span><span class="op" id="7978291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7978295">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7978299">_</span><span class="op" id="7978300">,</span>&nbsp;<span class="ident" id="7978302">err</span>&nbsp;<span class="op" id="7978306">=</span>&nbsp;<span class="ident" id="7978308">io</span><span class="op" id="7978310">.</span><span class="ident" id="7978311">ReadFull</span><span class="op" id="7978319">(</span><span class="ident" id="7978320">client</span><span class="op" id="7978326">,</span>&nbsp;<span class="ident" id="7978328">buf</span><span class="op" id="7978331">[</span><span class="op" id="7978332">:</span><span class="op" id="7978333">]</span><span class="op" id="7978334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7978338">if</span>&nbsp;<span class="ident" id="7978341">err</span>&nbsp;<span class="op" id="7978345">!=</span>&nbsp;<span class="ident" id="7978348">nil</span>&nbsp;<span class="op" id="7978352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7978357">t</span><span class="op" id="7978358">.</span><span class="ident" id="7978359">Fatalf</span><span class="op" id="7978365">(</span><span class="string" id="7978366">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7978383">,</span>&nbsp;<span class="ident" id="7978385">err</span><span class="op" id="7978388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7978392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7978395">}</span><span class="op" id="7978396">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7978399">if</span>&nbsp;<span class="ident" id="7978402">mallocs</span>&nbsp;<span class="op" id="7978410">&gt;</span>&nbsp;<span class="num" id="7978412">0</span>&nbsp;<span class="op" id="7978414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7978418">t</span><span class="op" id="7978419">.</span><span class="ident" id="7978420">Fatalf</span><span class="op" id="7978426">(</span><span class="string" id="7978427">&#34;Got&nbsp;%v&nbsp;allocs,&nbsp;want&nbsp;0&#34;</span><span class="op" id="7978450">,</span>&nbsp;<span class="ident" id="7978452">mallocs</span><span class="op" id="7978459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7978462">}</span><br>
<span class="lineno"></span><span class="op" id="7978464">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="7978467">func</span>&nbsp;<span class="ident" id="7978472">TestTCPStress</span><span class="op" id="7978485">(</span><span class="ident" id="7978486">t</span>&nbsp;<span class="op" id="7978488">*</span><span class="ident" id="7978489">testing</span><span class="op" id="7978496">.</span><span class="ident" id="7978497">T</span><span class="op" id="7978498">)</span>&nbsp;<span class="op" id="7978500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7978503">const</span>&nbsp;<span class="ident" id="7978509">conns</span>&nbsp;<span class="op" id="7978515">=</span>&nbsp;<span class="num" id="7978517">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7978520">const</span>&nbsp;<span class="ident" id="7978526">msgLen</span>&nbsp;<span class="op" id="7978533">=</span>&nbsp;<span class="num" id="7978535">512</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7978540">msgs</span>&nbsp;<span class="op" id="7978545">:=</span>&nbsp;<span class="builtintype" id="7978548">int</span><span class="op" id="7978551">(</span><span class="num" id="7978552">1e4</span><span class="op" id="7978555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7978558">if</span>&nbsp;<span class="ident" id="7978561">testing</span><span class="op" id="7978568">.</span><span class="ident" id="7978569">Short</span><span class="op" id="7978574">(</span><span class="op" id="7978575">)</span>&nbsp;<span class="op" id="7978577">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7978581">msgs</span>&nbsp;<span class="op" id="7978586">=</span>&nbsp;<span class="num" id="7978588">1e2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7978593">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7978597">sendMsg</span>&nbsp;<span class="op" id="7978605">:=</span>&nbsp;<span class="keyword" id="7978608">func</span><span class="op" id="7978612">(</span><span class="ident" id="7978613">c</span>&nbsp;<span class="ident" id="7978615">Conn</span><span class="op" id="7978619">,</span>&nbsp;<span class="ident" id="7978621">buf</span>&nbsp;<span class="op" id="7978625">[</span><span class="op" id="7978626">]</span><span class="builtintype" id="7978627">byte</span><span class="op" id="7978631">)</span>&nbsp;<span class="builtintype" id="7978633">bool</span>&nbsp;<span class="op" id="7978638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7978642">n</span><span class="op" id="7978643">,</span>&nbsp;<span class="ident" id="7978645">err</span>&nbsp;<span class="op" id="7978649">:=</span>&nbsp;<span class="ident" id="7978652">c</span><span class="op" id="7978653">.</span><span class="ident" id="7978654">Write</span><span class="op" id="7978659">(</span><span class="ident" id="7978660">buf</span><span class="op" id="7978663">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7978667">if</span>&nbsp;<span class="ident" id="7978670">n</span>&nbsp;<span class="op" id="7978672">!=</span>&nbsp;<span class="builtinfunc" id="7978675">len</span><span class="op" id="7978678">(</span><span class="ident" id="7978679">buf</span><span class="op" id="7978682">)</span>&nbsp;<span class="op" id="7978684">||</span>&nbsp;<span class="ident" id="7978687">err</span>&nbsp;<span class="op" id="7978691">!=</span>&nbsp;<span class="ident" id="7978694">nil</span>&nbsp;<span class="op" id="7978698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7978703">t</span><span class="op" id="7978704">.</span><span class="ident" id="7978705">Logf</span><span class="op" id="7978709">(</span><span class="string" id="7978710">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7978728">,</span>&nbsp;<span class="ident" id="7978730">err</span><span class="op" id="7978733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7978738">return</span>&nbsp;<span class="builtintype" id="7978745">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7978753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7978757">return</span>&nbsp;<span class="builtintype" id="7978764">true</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7978770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7978773">recvMsg</span>&nbsp;<span class="op" id="7978781">:=</span>&nbsp;<span class="keyword" id="7978784">func</span><span class="op" id="7978788">(</span><span class="ident" id="7978789">c</span>&nbsp;<span class="ident" id="7978791">Conn</span><span class="op" id="7978795">,</span>&nbsp;<span class="ident" id="7978797">buf</span>&nbsp;<span class="op" id="7978801">[</span><span class="op" id="7978802">]</span><span class="builtintype" id="7978803">byte</span><span class="op" id="7978807">)</span>&nbsp;<span class="builtintype" id="7978809">bool</span>&nbsp;<span class="op" id="7978814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7978818">for</span>&nbsp;<span class="ident" id="7978822">read</span>&nbsp;<span class="op" id="7978827">:=</span>&nbsp;<span class="num" id="7978830">0</span><span class="op" id="7978831">;</span>&nbsp;<span class="ident" id="7978833">read</span>&nbsp;<span class="op" id="7978838">!=</span>&nbsp;<span class="builtinfunc" id="7978841">len</span><span class="op" id="7978844">(</span><span class="ident" id="7978845">buf</span><span class="op" id="7978848">)</span><span class="op" id="7978849">;</span>&nbsp;<span class="op" id="7978851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7978856">n</span><span class="op" id="7978857">,</span>&nbsp;<span class="ident" id="7978859">err</span>&nbsp;<span class="op" id="7978863">:=</span>&nbsp;<span class="ident" id="7978866">c</span><span class="op" id="7978867">.</span><span class="ident" id="7978868">Read</span><span class="op" id="7978872">(</span><span class="ident" id="7978873">buf</span><span class="op" id="7978876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7978881">read</span>&nbsp;<span class="op" id="7978886">+=</span>&nbsp;<span class="ident" id="7978889">n</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7978894">if</span>&nbsp;<span class="ident" id="7978897">err</span>&nbsp;<span class="op" id="7978901">!=</span>&nbsp;<span class="ident" id="7978904">nil</span>&nbsp;<span class="op" id="7978908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7978914">t</span><span class="op" id="7978915">.</span><span class="ident" id="7978916">Logf</span><span class="op" id="7978920">(</span><span class="string" id="7978921">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7978938">,</span>&nbsp;<span class="ident" id="7978940">err</span><span class="op" id="7978943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7978949">return</span>&nbsp;<span class="builtintype" id="7978956">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7978965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7978969">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7978973">return</span>&nbsp;<span class="builtintype" id="7978980">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7978986">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7978990">ln</span><span class="op" id="7978992">,</span>&nbsp;<span class="ident" id="7978994">err</span>&nbsp;<span class="op" id="7978998">:=</span>&nbsp;<span class="ident" id="7979001">Listen</span><span class="op" id="7979007">(</span><span class="string" id="7979008">&#34;tcp&#34;</span><span class="op" id="7979013">,</span>&nbsp;<span class="string" id="7979015">&#34;127.0.0.1:0&#34;</span><span class="op" id="7979028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7979031">if</span>&nbsp;<span class="ident" id="7979034">err</span>&nbsp;<span class="op" id="7979038">!=</span>&nbsp;<span class="ident" id="7979041">nil</span>&nbsp;<span class="op" id="7979045">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7979049">t</span><span class="op" id="7979050">.</span><span class="ident" id="7979051">Fatalf</span><span class="op" id="7979057">(</span><span class="string" id="7979058">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7979077">,</span>&nbsp;<span class="ident" id="7979079">err</span><span class="op" id="7979082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7979085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7979088">defer</span>&nbsp;<span class="ident" id="7979094">ln</span><span class="op" id="7979096">.</span><span class="ident" id="7979097">Close</span><span class="op" id="7979102">(</span><span class="op" id="7979103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7979106">//&nbsp;Acceptor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7979120">go</span>&nbsp;<span class="keyword" id="7979123">func</span><span class="op" id="7979127">(</span><span class="op" id="7979128">)</span>&nbsp;<span class="op" id="7979130">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7979134">for</span>&nbsp;<span class="op" id="7979138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7979143">c</span><span class="op" id="7979144">,</span>&nbsp;<span class="ident" id="7979146">err</span>&nbsp;<span class="op" id="7979150">:=</span>&nbsp;<span class="ident" id="7979153">ln</span><span class="op" id="7979155">.</span><span class="ident" id="7979156">Accept</span><span class="op" id="7979162">(</span><span class="op" id="7979163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7979168">if</span>&nbsp;<span class="ident" id="7979171">err</span>&nbsp;<span class="op" id="7979175">!=</span>&nbsp;<span class="ident" id="7979178">nil</span>&nbsp;<span class="op" id="7979182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7979188">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7979197">}</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7979202">//&nbsp;Server&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7979227">go</span>&nbsp;<span class="keyword" id="7979230">func</span><span class="op" id="7979234">(</span><span class="ident" id="7979235">c</span>&nbsp;<span class="ident" id="7979237">Conn</span><span class="op" id="7979241">)</span>&nbsp;<span class="op" id="7979243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7979249">defer</span>&nbsp;<span class="ident" id="7979255">c</span><span class="op" id="7979256">.</span><span class="ident" id="7979257">Close</span><span class="op" id="7979262">(</span><span class="op" id="7979263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7979269">var</span>&nbsp;<span class="ident" id="7979273">buf</span>&nbsp;<span class="op" id="7979277">[</span><span class="ident" id="7979278">msgLen</span><span class="op" id="7979284">]</span><span class="builtintype" id="7979285">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7979294">for</span>&nbsp;<span class="ident" id="7979298">m</span>&nbsp;<span class="op" id="7979300">:=</span>&nbsp;<span class="num" id="7979303">0</span><span class="op" id="7979304">;</span>&nbsp;<span class="ident" id="7979306">m</span>&nbsp;<span class="op" id="7979308">&lt;</span>&nbsp;<span class="ident" id="7979310">msgs</span><span class="op" id="7979314">;</span>&nbsp;<span class="ident" id="7979316">m</span><span class="op" id="7979317">++</span>&nbsp;<span class="op" id="7979320">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7979327">if</span>&nbsp;<span class="op" id="7979330">!</span><span class="ident" id="7979331">recvMsg</span><span class="op" id="7979338">(</span><span class="ident" id="7979339">c</span><span class="op" id="7979340">,</span>&nbsp;<span class="ident" id="7979342">buf</span><span class="op" id="7979345">[</span><span class="op" id="7979346">:</span><span class="op" id="7979347">]</span><span class="op" id="7979348">)</span>&nbsp;<span class="op" id="7979350">||</span>&nbsp;<span class="op" id="7979353">!</span><span class="ident" id="7979354">sendMsg</span><span class="op" id="7979361">(</span><span class="ident" id="7979362">c</span><span class="op" id="7979363">,</span>&nbsp;<span class="ident" id="7979365">buf</span><span class="op" id="7979368">[</span><span class="op" id="7979369">:</span><span class="op" id="7979370">]</span><span class="op" id="7979371">)</span>&nbsp;<span class="op" id="7979373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7979381">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7979392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7979398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7979403">}</span><span class="op" id="7979404">(</span><span class="ident" id="7979405">c</span><span class="op" id="7979406">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7979410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7979413">}</span><span class="op" id="7979414">(</span><span class="op" id="7979415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7979418">done</span>&nbsp;<span class="op" id="7979423">:=</span>&nbsp;<span class="builtinfunc" id="7979426">make</span><span class="op" id="7979430">(</span><span class="keyword" id="7979431">chan</span>&nbsp;<span class="builtintype" id="7979436">bool</span><span class="op" id="7979440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7979443">for</span>&nbsp;<span class="ident" id="7979447">i</span>&nbsp;<span class="op" id="7979449">:=</span>&nbsp;<span class="num" id="7979452">0</span><span class="op" id="7979453">;</span>&nbsp;<span class="ident" id="7979455">i</span>&nbsp;<span class="op" id="7979457">&lt;</span>&nbsp;<span class="ident" id="7979459">conns</span><span class="op" id="7979464">;</span>&nbsp;<span class="ident" id="7979466">i</span><span class="op" id="7979467">++</span>&nbsp;<span class="op" id="7979470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7979474">//&nbsp;Client&nbsp;connection.</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7979498">go</span>&nbsp;<span class="keyword" id="7979501">func</span><span class="op" id="7979505">(</span><span class="op" id="7979506">)</span>&nbsp;<span class="op" id="7979508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7979513">defer</span>&nbsp;<span class="keyword" id="7979519">func</span><span class="op" id="7979523">(</span><span class="op" id="7979524">)</span>&nbsp;<span class="op" id="7979526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7979532">done</span>&nbsp;<span class="op" id="7979537">&lt;-</span>&nbsp;<span class="builtintype" id="7979540">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7979548">}</span><span class="op" id="7979549">(</span><span class="op" id="7979550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7979555">c</span><span class="op" id="7979556">,</span>&nbsp;<span class="ident" id="7979558">err</span>&nbsp;<span class="op" id="7979562">:=</span>&nbsp;<span class="ident" id="7979565">Dial</span><span class="op" id="7979569">(</span><span class="string" id="7979570">&#34;tcp&#34;</span><span class="op" id="7979575">,</span>&nbsp;<span class="ident" id="7979577">ln</span><span class="op" id="7979579">.</span><span class="ident" id="7979580">Addr</span><span class="op" id="7979584">(</span><span class="op" id="7979585">)</span><span class="op" id="7979586">.</span><span class="ident" id="7979587">String</span><span class="op" id="7979593">(</span><span class="op" id="7979594">)</span><span class="op" id="7979595">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7979600">if</span>&nbsp;<span class="ident" id="7979603">err</span>&nbsp;<span class="op" id="7979607">!=</span>&nbsp;<span class="ident" id="7979610">nil</span>&nbsp;<span class="op" id="7979614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7979620">t</span><span class="op" id="7979621">.</span><span class="ident" id="7979622">Logf</span><span class="op" id="7979626">(</span><span class="string" id="7979627">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7979644">,</span>&nbsp;<span class="ident" id="7979646">err</span><span class="op" id="7979649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7979655">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7979665">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7979670">defer</span>&nbsp;<span class="ident" id="7979676">c</span><span class="op" id="7979677">.</span><span class="ident" id="7979678">Close</span><span class="op" id="7979683">(</span><span class="op" id="7979684">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7979689">var</span>&nbsp;<span class="ident" id="7979693">buf</span>&nbsp;<span class="op" id="7979697">[</span><span class="ident" id="7979698">msgLen</span><span class="op" id="7979704">]</span><span class="builtintype" id="7979705">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7979713">for</span>&nbsp;<span class="ident" id="7979717">m</span>&nbsp;<span class="op" id="7979719">:=</span>&nbsp;<span class="num" id="7979722">0</span><span class="op" id="7979723">;</span>&nbsp;<span class="ident" id="7979725">m</span>&nbsp;<span class="op" id="7979727">&lt;</span>&nbsp;<span class="ident" id="7979729">msgs</span><span class="op" id="7979733">;</span>&nbsp;<span class="ident" id="7979735">m</span><span class="op" id="7979736">++</span>&nbsp;<span class="op" id="7979739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7979745">if</span>&nbsp;<span class="op" id="7979748">!</span><span class="ident" id="7979749">sendMsg</span><span class="op" id="7979756">(</span><span class="ident" id="7979757">c</span><span class="op" id="7979758">,</span>&nbsp;<span class="ident" id="7979760">buf</span><span class="op" id="7979763">[</span><span class="op" id="7979764">:</span><span class="op" id="7979765">]</span><span class="op" id="7979766">)</span>&nbsp;<span class="op" id="7979768">||</span>&nbsp;<span class="op" id="7979771">!</span><span class="ident" id="7979772">recvMsg</span><span class="op" id="7979779">(</span><span class="ident" id="7979780">c</span><span class="op" id="7979781">,</span>&nbsp;<span class="ident" id="7979783">buf</span><span class="op" id="7979786">[</span><span class="op" id="7979787">:</span><span class="op" id="7979788">]</span><span class="op" id="7979789">)</span>&nbsp;<span class="op" id="7979791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7979798">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7979808">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7979813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7979817">}</span><span class="op" id="7979818">(</span><span class="op" id="7979819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7979822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7979825">for</span>&nbsp;<span class="ident" id="7979829">i</span>&nbsp;<span class="op" id="7979831">:=</span>&nbsp;<span class="num" id="7979834">0</span><span class="op" id="7979835">;</span>&nbsp;<span class="ident" id="7979837">i</span>&nbsp;<span class="op" id="7979839">&lt;</span>&nbsp;<span class="ident" id="7979841">conns</span><span class="op" id="7979846">;</span>&nbsp;<span class="ident" id="7979848">i</span><span class="op" id="7979849">++</span>&nbsp;<span class="op" id="7979852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7979856">&lt;-</span><span class="ident" id="7979858">done</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7979864">}</span><br>
<span class="lineno"></span><span class="op" id="7979866">}</span>
</div>
</body>
</html>
