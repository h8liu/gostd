<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>lonnie.io/e8vm/arch8</h2>
<ul>
<li><a href="/gostd/lonnie.io/e8vm/arch8/console.go.html">console.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/cpu.go.html">cpu.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/cpu_test.go.html">cpu_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/device.go.html">device.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/exception.go.html">exception.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_all.go.html">inst_all.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_br.go.html">inst_br.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_br_test.go.html">inst_br_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_imm.go.html">inst_imm.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_imm_test.go.html">inst_imm_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_jmp.go.html">inst_jmp.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_reg.go.html">inst_reg.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_reg_test.go.html">inst_reg_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_sys.go.html">inst_sys.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/int_bus.go.html">int_bus.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/interrupt.go.html">interrupt.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/interrupt_test.go.html">interrupt_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/machine.go.html">machine.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/multi_core.go.html">multi_core.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page.go.html">page.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page_table.go.html">page_table.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page_table_test.go.html">page_table_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page_test.go.html">page_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/phy_memory.go.html">phy_memory.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/phy_memory_test.go.html">phy_memory_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/regs.go.html">regs.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/regs_test.go.html">regs_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/run_image.go.html">run_image.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/serial.go.html">serial.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/ticker.go.html">ticker.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/virt_memory.go.html">virt_memory.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/virt_memory_test.go.html">virt_memory_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="keyword" id="4804291">package</span>&nbsp;<span class="ident" id="4804299">arch8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4804306">import</span>&nbsp;<span class="op" id="4804313">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4804316">&#34;bytes&#34;</span><br>
<span class="lineno">5</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4804325">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4804331">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4804338">&#34;os&#34;</span><br>
<span class="lineno"></span><span class="op" id="4804343">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="4804346">//&nbsp;Serial&nbsp;is&nbsp;a&nbsp;serial&nbsp;console&nbsp;device</span><br>
<span class="lineno"></span><span class="comment" id="4804383">//&nbsp;It&nbsp;is&nbsp;basically&nbsp;two&nbsp;DMA&nbsp;pipes&nbsp;of&nbsp;ring&nbsp;buffered&nbsp;bytes:</span><br>
<span class="lineno"></span><span class="comment" id="4804440">//&nbsp;one&nbsp;pipe&nbsp;for&nbsp;input,&nbsp;one&nbsp;pipe&nbsp;for&nbsp;output.</span><br>
<span class="lineno"></span><span class="keyword" id="4804484">type</span>&nbsp;<span class="ident" id="4804489">serial</span>&nbsp;<span class="keyword" id="4804496">struct</span>&nbsp;<span class="op" id="4804503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4804506">intBus</span>&nbsp;<span class="ident" id="4804513">intBus</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4804521">p</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4804528">*</span><span class="ident" id="4804529">page</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4804536">Core</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4804543">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4804549">IntIn</span>&nbsp;&nbsp;<span class="builtintype" id="4804556">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4804562">IntOut</span>&nbsp;<span class="builtintype" id="4804569">byte</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4804576">Output</span>&nbsp;<span class="ident" id="4804583">io</span><span class="op" id="4804585">.</span><span class="ident" id="4804586">Writer</span><br>
<span class="lineno"></span><span class="op" id="4804593">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4804596">var</span>&nbsp;<span class="ident" id="4804600">_</span>&nbsp;<span class="ident" id="4804602">device</span>&nbsp;<span class="op" id="4804609">=</span>&nbsp;<span class="builtinfunc" id="4804611">new</span><span class="op" id="4804614">(</span><span class="ident" id="4804615">serial</span><span class="op" id="4804621">)</span>&nbsp;<span class="comment" id="4804623">//&nbsp;Serial&nbsp;is&nbsp;a&nbsp;device</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="4804646">const</span>&nbsp;<span class="op" id="4804652">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4804655">serialBase</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4804670">=</span>&nbsp;<span class="num" id="4804672">128</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4804677">serialInHead</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4804692">=</span>&nbsp;<span class="ident" id="4804694">serialBase</span>&nbsp;<span class="op" id="4804705">+</span>&nbsp;<span class="num" id="4804707">0</span>&nbsp;&nbsp;<span class="comment" id="4804710">//&nbsp;updated&nbsp;by&nbsp;hardware</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4804734">serialInTail</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4804749">=</span>&nbsp;<span class="ident" id="4804751">serialBase</span>&nbsp;<span class="op" id="4804762">+</span>&nbsp;<span class="num" id="4804764">4</span>&nbsp;&nbsp;<span class="comment" id="4804767">//&nbsp;updated&nbsp;by&nbsp;cpu</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4804786">serialInWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4804801">=</span>&nbsp;<span class="ident" id="4804803">serialBase</span>&nbsp;<span class="op" id="4804814">+</span>&nbsp;<span class="num" id="4804816">8</span>&nbsp;&nbsp;<span class="comment" id="4804819">//&nbsp;cycles&nbsp;to&nbsp;wait&nbsp;to&nbsp;raise&nbsp;an&nbsp;interrupt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4804860">serialInThresh</span>&nbsp;<span class="op" id="4804875">=</span>&nbsp;<span class="ident" id="4804877">serialBase</span>&nbsp;<span class="op" id="4804888">+</span>&nbsp;<span class="num" id="4804890">12</span>&nbsp;<span class="comment" id="4804893">//&nbsp;threashold&nbsp;to&nbsp;raise&nbsp;an&nbsp;input&nbsp;interrupt</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4804937">serialOutHead</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4804953">=</span>&nbsp;<span class="ident" id="4804955">serialBase</span>&nbsp;<span class="op" id="4804966">+</span>&nbsp;<span class="num" id="4804968">16</span>&nbsp;<span class="comment" id="4804971">//&nbsp;updated&nbsp;by&nbsp;cpu</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4804990">serialOutTail</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4805006">=</span>&nbsp;<span class="ident" id="4805008">serialBase</span>&nbsp;<span class="op" id="4805019">+</span>&nbsp;<span class="num" id="4805021">20</span>&nbsp;<span class="comment" id="4805024">//&nbsp;updated&nbsp;by&nbsp;hardware</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4805048">serialOutWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4805064">=</span>&nbsp;<span class="ident" id="4805066">serialBase</span>&nbsp;<span class="op" id="4805077">+</span>&nbsp;<span class="num" id="4805079">24</span>&nbsp;<span class="comment" id="4805082">//&nbsp;cycles&nbsp;to&nbsp;wait&nbsp;to&nbsp;raise&nbsp;an&nbsp;interrupt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4805123">serialOutThresh</span>&nbsp;<span class="op" id="4805139">=</span>&nbsp;<span class="ident" id="4805141">serialBase</span>&nbsp;<span class="op" id="4805152">+</span>&nbsp;<span class="num" id="4805154">28</span>&nbsp;<span class="comment" id="4805157">//&nbsp;threashold&nbsp;to&nbsp;raise&nbsp;an&nbsp;output&nbsp;interrupt</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4805202">serialInBuf</span>&nbsp;&nbsp;<span class="op" id="4805215">=</span>&nbsp;<span class="ident" id="4805217">serialBase</span>&nbsp;<span class="op" id="4805228">+</span>&nbsp;<span class="num" id="4805230">64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4805234">serialOutBuf</span>&nbsp;<span class="op" id="4805247">=</span>&nbsp;<span class="ident" id="4805249">serialBase</span>&nbsp;<span class="op" id="4805260">+</span>&nbsp;<span class="num" id="4805262">96</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4805267">serialCap</span>&nbsp;<span class="op" id="4805277">=</span>&nbsp;<span class="num" id="4805279">30</span>&nbsp;<span class="comment" id="4805282">//&nbsp;30&nbsp;bytes&nbsp;maximum&nbsp;in&nbsp;each&nbsp;pipe</span><br>
<span class="lineno"></span><span class="op" id="4805315">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4805318">//&nbsp;NewSerial&nbsp;creates&nbsp;a&nbsp;new&nbsp;serial&nbsp;controller.</span><br>
<span class="lineno">45</span><span class="keyword" id="4805364">func</span>&nbsp;<span class="ident" id="4805369">newSerial</span><span class="op" id="4805378">(</span><span class="ident" id="4805379">p</span>&nbsp;<span class="op" id="4805381">*</span><span class="ident" id="4805382">page</span><span class="op" id="4805386">,</span>&nbsp;<span class="ident" id="4805388">i</span>&nbsp;<span class="ident" id="4805390">intBus</span><span class="op" id="4805396">)</span>&nbsp;<span class="op" id="4805398">*</span><span class="ident" id="4805399">serial</span>&nbsp;<span class="op" id="4805406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4805409">ret</span>&nbsp;<span class="op" id="4805413">:=</span>&nbsp;<span class="builtinfunc" id="4805416">new</span><span class="op" id="4805419">(</span><span class="ident" id="4805420">serial</span><span class="op" id="4805426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4805429">ret</span><span class="op" id="4805432">.</span><span class="ident" id="4805433">intBus</span>&nbsp;<span class="op" id="4805440">=</span>&nbsp;<span class="ident" id="4805442">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4805445">ret</span><span class="op" id="4805448">.</span><span class="ident" id="4805449">p</span>&nbsp;<span class="op" id="4805451">=</span>&nbsp;<span class="ident" id="4805453">p</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4805457">//&nbsp;default&nbsp;interrupts</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4805480">ret</span><span class="op" id="4805483">.</span><span class="ident" id="4805484">Core</span>&nbsp;<span class="op" id="4805489">=</span>&nbsp;<span class="num" id="4805491">0</span>&nbsp;<span class="comment" id="4805493">//&nbsp;to&nbsp;core&nbsp;0&nbsp;only</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4805512">ret</span><span class="op" id="4805515">.</span><span class="ident" id="4805516">IntIn</span>&nbsp;<span class="op" id="4805522">=</span>&nbsp;<span class="num" id="4805524">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4805527">ret</span><span class="op" id="4805530">.</span><span class="ident" id="4805531">IntOut</span>&nbsp;<span class="op" id="4805538">=</span>&nbsp;<span class="num" id="4805540">9</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4805544">ret</span><span class="op" id="4805547">.</span><span class="ident" id="4805548">Output</span>&nbsp;<span class="op" id="4805555">=</span>&nbsp;<span class="ident" id="4805557">os</span><span class="op" id="4805559">.</span><span class="ident" id="4805560">Stdout</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4805569">return</span>&nbsp;<span class="ident" id="4805576">ret</span><br>
<span class="lineno"></span><span class="op" id="4805580">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="4805583">func</span>&nbsp;<span class="op" id="4805588">(</span><span class="ident" id="4805589">s</span>&nbsp;<span class="op" id="4805591">*</span><span class="ident" id="4805592">serial</span><span class="op" id="4805598">)</span>&nbsp;<span class="ident" id="4805600">interrupt</span><span class="op" id="4805609">(</span><span class="ident" id="4805610">code</span>&nbsp;<span class="builtintype" id="4805615">byte</span><span class="op" id="4805619">)</span>&nbsp;<span class="op" id="4805621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4805624">s</span><span class="op" id="4805625">.</span><span class="ident" id="4805626">intBus</span><span class="op" id="4805632">.</span><span class="ident" id="4805633">Interrupt</span><span class="op" id="4805642">(</span><span class="ident" id="4805643">code</span><span class="op" id="4805647">,</span>&nbsp;<span class="ident" id="4805649">s</span><span class="op" id="4805650">.</span><span class="ident" id="4805651">Core</span><span class="op" id="4805655">)</span><br>
<span class="lineno"></span><span class="op" id="4805657">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4805660">//&nbsp;WriteByte&nbsp;appends&nbsp;a&nbsp;byte&nbsp;into&nbsp;the&nbsp;input&nbsp;ring&nbsp;buffer.</span><br>
<span class="lineno">65</span><span class="keyword" id="4805716">func</span>&nbsp;<span class="op" id="4805721">(</span><span class="ident" id="4805722">s</span>&nbsp;<span class="op" id="4805724">*</span><span class="ident" id="4805725">serial</span><span class="op" id="4805731">)</span>&nbsp;<span class="ident" id="4805733">WriteByte</span><span class="op" id="4805742">(</span><span class="ident" id="4805743">b</span>&nbsp;<span class="builtintype" id="4805745">byte</span><span class="op" id="4805749">)</span>&nbsp;<span class="builtintype" id="4805751">bool</span>&nbsp;<span class="op" id="4805756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4805759">head</span>&nbsp;<span class="op" id="4805764">:=</span>&nbsp;<span class="ident" id="4805767">s</span><span class="op" id="4805768">.</span><span class="ident" id="4805769">p</span><span class="op" id="4805770">.</span><span class="ident" id="4805771">ReadWord</span><span class="op" id="4805779">(</span><span class="ident" id="4805780">serialInHead</span><span class="op" id="4805792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4805795">tail</span>&nbsp;<span class="op" id="4805800">:=</span>&nbsp;<span class="ident" id="4805803">s</span><span class="op" id="4805804">.</span><span class="ident" id="4805805">p</span><span class="op" id="4805806">.</span><span class="ident" id="4805807">ReadWord</span><span class="op" id="4805815">(</span><span class="ident" id="4805816">serialInTail</span><span class="op" id="4805828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4805831">n</span>&nbsp;<span class="op" id="4805833">:=</span>&nbsp;<span class="ident" id="4805836">head</span>&nbsp;<span class="op" id="4805841">-</span>&nbsp;<span class="ident" id="4805843">tail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4805849">if</span>&nbsp;<span class="ident" id="4805852">n</span>&nbsp;<span class="op" id="4805854">&gt;=</span>&nbsp;<span class="ident" id="4805857">serialCap</span>&nbsp;<span class="op" id="4805867">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4805871">return</span>&nbsp;<span class="builtintype" id="4805878">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4805885">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4805889">s</span><span class="op" id="4805890">.</span><span class="ident" id="4805891">p</span><span class="op" id="4805892">.</span><span class="ident" id="4805893">WriteByte</span><span class="op" id="4805902">(</span><span class="ident" id="4805903">serialInBuf</span><span class="op" id="4805914">+</span><span class="ident" id="4805915">head</span><span class="op" id="4805919">%</span><span class="num" id="4805920">32</span><span class="op" id="4805922">,</span>&nbsp;<span class="ident" id="4805924">b</span><span class="op" id="4805925">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4805929">head</span><span class="op" id="4805933">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4805937">s</span><span class="op" id="4805938">.</span><span class="ident" id="4805939">p</span><span class="op" id="4805940">.</span><span class="ident" id="4805941">WriteWord</span><span class="op" id="4805950">(</span><span class="ident" id="4805951">serialInTail</span><span class="op" id="4805963">,</span>&nbsp;<span class="ident" id="4805965">head</span><span class="op" id="4805969">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4805973">n</span><span class="op" id="4805974">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4805978">thresh</span>&nbsp;<span class="op" id="4805985">:=</span>&nbsp;<span class="ident" id="4805988">s</span><span class="op" id="4805989">.</span><span class="ident" id="4805990">p</span><span class="op" id="4805991">.</span><span class="ident" id="4805992">ReadWord</span><span class="op" id="4806000">(</span><span class="ident" id="4806001">serialInThresh</span><span class="op" id="4806015">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4806018">if</span>&nbsp;<span class="ident" id="4806021">n</span>&nbsp;<span class="op" id="4806023">&gt;=</span>&nbsp;<span class="ident" id="4806026">thresh</span>&nbsp;<span class="op" id="4806033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4806037">s</span><span class="op" id="4806038">.</span><span class="ident" id="4806039">interrupt</span><span class="op" id="4806048">(</span><span class="ident" id="4806049">s</span><span class="op" id="4806050">.</span><span class="ident" id="4806051">IntIn</span><span class="op" id="4806056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4806059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4806063">return</span>&nbsp;<span class="builtintype" id="4806070">true</span><br>
<span class="lineno">85</span><span class="op" id="4806075">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4806078">//&nbsp;OutLen&nbsp;returns&nbsp;the&nbsp;current&nbsp;buffer&nbsp;length&nbsp;of&nbsp;the&nbsp;output&nbsp;ring&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="4806149">func</span>&nbsp;<span class="op" id="4806154">(</span><span class="ident" id="4806155">s</span>&nbsp;<span class="op" id="4806157">*</span><span class="ident" id="4806158">serial</span><span class="op" id="4806164">)</span>&nbsp;<span class="ident" id="4806166">OutLen</span><span class="op" id="4806172">(</span><span class="op" id="4806173">)</span>&nbsp;<span class="builtintype" id="4806175">uint32</span>&nbsp;<span class="op" id="4806182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4806185">head</span>&nbsp;<span class="op" id="4806190">:=</span>&nbsp;<span class="ident" id="4806193">s</span><span class="op" id="4806194">.</span><span class="ident" id="4806195">p</span><span class="op" id="4806196">.</span><span class="ident" id="4806197">ReadWord</span><span class="op" id="4806205">(</span><span class="ident" id="4806206">serialOutHead</span><span class="op" id="4806219">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4806222">tail</span>&nbsp;<span class="op" id="4806227">:=</span>&nbsp;<span class="ident" id="4806230">s</span><span class="op" id="4806231">.</span><span class="ident" id="4806232">p</span><span class="op" id="4806233">.</span><span class="ident" id="4806234">ReadWord</span><span class="op" id="4806242">(</span><span class="ident" id="4806243">serialOutTail</span><span class="op" id="4806256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4806259">ret</span>&nbsp;<span class="op" id="4806263">:=</span>&nbsp;<span class="ident" id="4806266">head</span>&nbsp;<span class="op" id="4806271">-</span>&nbsp;<span class="ident" id="4806273">tail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4806279">if</span>&nbsp;<span class="ident" id="4806282">ret</span>&nbsp;<span class="op" id="4806286">&gt;</span>&nbsp;<span class="ident" id="4806288">serialCap</span>&nbsp;<span class="op" id="4806298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4806302">log</span><span class="op" id="4806305">.</span><span class="ident" id="4806306">Printf</span><span class="op" id="4806312">(</span><span class="string" id="4806313">&#34;error&nbsp;output&nbsp;buffer&nbsp;length&#34;</span><span class="op" id="4806341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4806345">//&nbsp;on&nbsp;error&nbsp;set&nbsp;the&nbsp;length&nbsp;to&nbsp;full</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4806382">//&nbsp;to&nbsp;avoid&nbsp;trigger&nbsp;interrupt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4806414">ret</span>&nbsp;<span class="op" id="4806418">=</span>&nbsp;<span class="ident" id="4806420">serialCap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4806431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4806434">return</span>&nbsp;<span class="ident" id="4806441">ret</span><br>
<span class="lineno"></span><span class="op" id="4806445">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="4806448">//&nbsp;InLen&nbsp;returns&nbsp;the&nbsp;current&nbsp;buffer&nbsp;length&nbsp;of&nbsp;the&nbsp;input&nbsp;ring&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="4806517">func</span>&nbsp;<span class="op" id="4806522">(</span><span class="ident" id="4806523">s</span>&nbsp;<span class="op" id="4806525">*</span><span class="ident" id="4806526">serial</span><span class="op" id="4806532">)</span>&nbsp;<span class="ident" id="4806534">InLen</span><span class="op" id="4806539">(</span><span class="op" id="4806540">)</span>&nbsp;<span class="builtintype" id="4806542">uint32</span>&nbsp;<span class="op" id="4806549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4806552">head</span>&nbsp;<span class="op" id="4806557">:=</span>&nbsp;<span class="ident" id="4806560">s</span><span class="op" id="4806561">.</span><span class="ident" id="4806562">p</span><span class="op" id="4806563">.</span><span class="ident" id="4806564">ReadWord</span><span class="op" id="4806572">(</span><span class="ident" id="4806573">serialInHead</span><span class="op" id="4806585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4806588">tail</span>&nbsp;<span class="op" id="4806593">:=</span>&nbsp;<span class="ident" id="4806596">s</span><span class="op" id="4806597">.</span><span class="ident" id="4806598">p</span><span class="op" id="4806599">.</span><span class="ident" id="4806600">ReadWord</span><span class="op" id="4806608">(</span><span class="ident" id="4806609">serialInTail</span><span class="op" id="4806621">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4806624">ret</span>&nbsp;<span class="op" id="4806628">:=</span>&nbsp;<span class="ident" id="4806631">head</span>&nbsp;<span class="op" id="4806636">-</span>&nbsp;<span class="ident" id="4806638">tail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4806644">if</span>&nbsp;<span class="ident" id="4806647">ret</span>&nbsp;<span class="op" id="4806651">&gt;</span>&nbsp;<span class="ident" id="4806653">serialCap</span>&nbsp;<span class="op" id="4806663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4806667">log</span><span class="op" id="4806670">.</span><span class="ident" id="4806671">Printf</span><span class="op" id="4806677">(</span><span class="string" id="4806678">&#34;error&nbsp;input&nbsp;buffer&nbsp;length&#34;</span><span class="op" id="4806705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4806709">//&nbsp;on&nbsp;error,&nbsp;set&nbsp;the&nbsp;length&nbsp;to&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4806748">//&nbsp;to&nbsp;avoid&nbsp;trigger&nbsp;interrupt</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4806780">ret</span>&nbsp;<span class="op" id="4806784">=</span>&nbsp;<span class="num" id="4806786">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4806789">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4806792">return</span>&nbsp;<span class="ident" id="4806799">ret</span><br>
<span class="lineno"></span><span class="op" id="4806803">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="comment" id="4806806">//&nbsp;ReadByte&nbsp;reads&nbsp;a&nbsp;byte&nbsp;out&nbsp;of&nbsp;serial&nbsp;output&nbsp;ring&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="4806865">func</span>&nbsp;<span class="op" id="4806870">(</span><span class="ident" id="4806871">s</span>&nbsp;<span class="op" id="4806873">*</span><span class="ident" id="4806874">serial</span><span class="op" id="4806880">)</span>&nbsp;<span class="ident" id="4806882">ReadByte</span><span class="op" id="4806890">(</span><span class="op" id="4806891">)</span>&nbsp;<span class="op" id="4806893">(</span><span class="builtintype" id="4806894">byte</span><span class="op" id="4806898">,</span>&nbsp;<span class="builtintype" id="4806900">bool</span><span class="op" id="4806904">)</span>&nbsp;<span class="op" id="4806906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4806909">head</span>&nbsp;<span class="op" id="4806914">:=</span>&nbsp;<span class="ident" id="4806917">s</span><span class="op" id="4806918">.</span><span class="ident" id="4806919">p</span><span class="op" id="4806920">.</span><span class="ident" id="4806921">ReadWord</span><span class="op" id="4806929">(</span><span class="ident" id="4806930">serialOutHead</span><span class="op" id="4806943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4806946">tail</span>&nbsp;<span class="op" id="4806951">:=</span>&nbsp;<span class="ident" id="4806954">s</span><span class="op" id="4806955">.</span><span class="ident" id="4806956">p</span><span class="op" id="4806957">.</span><span class="ident" id="4806958">ReadWord</span><span class="op" id="4806966">(</span><span class="ident" id="4806967">serialOutTail</span><span class="op" id="4806980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4806983">n</span>&nbsp;<span class="op" id="4806985">:=</span>&nbsp;<span class="ident" id="4806988">head</span>&nbsp;<span class="op" id="4806993">-</span>&nbsp;<span class="ident" id="4806995">tail</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4807001">if</span>&nbsp;<span class="ident" id="4807004">n</span>&nbsp;<span class="op" id="4807006">==</span>&nbsp;<span class="num" id="4807009">0</span>&nbsp;<span class="op" id="4807011">||</span>&nbsp;<span class="ident" id="4807014">n</span>&nbsp;<span class="op" id="4807016">&gt;</span>&nbsp;<span class="ident" id="4807018">serialCap</span>&nbsp;<span class="op" id="4807028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4807032">return</span>&nbsp;<span class="num" id="4807039">0</span><span class="op" id="4807040">,</span>&nbsp;<span class="builtintype" id="4807042">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4807049">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4807053">b</span>&nbsp;<span class="op" id="4807055">:=</span>&nbsp;<span class="ident" id="4807058">s</span><span class="op" id="4807059">.</span><span class="ident" id="4807060">p</span><span class="op" id="4807061">.</span><span class="ident" id="4807062">ReadByte</span><span class="op" id="4807070">(</span><span class="ident" id="4807071">serialOutBuf</span>&nbsp;<span class="op" id="4807084">+</span>&nbsp;<span class="ident" id="4807086">tail</span><span class="op" id="4807090">%</span><span class="num" id="4807091">32</span><span class="op" id="4807093">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4807096">tail</span><span class="op" id="4807100">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4807104">s</span><span class="op" id="4807105">.</span><span class="ident" id="4807106">p</span><span class="op" id="4807107">.</span><span class="ident" id="4807108">WriteWord</span><span class="op" id="4807117">(</span><span class="ident" id="4807118">serialOutTail</span><span class="op" id="4807131">,</span>&nbsp;<span class="ident" id="4807133">tail</span><span class="op" id="4807137">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4807141">n</span><span class="op" id="4807142">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4807146">thresh</span>&nbsp;<span class="op" id="4807153">:=</span>&nbsp;<span class="ident" id="4807156">s</span><span class="op" id="4807157">.</span><span class="ident" id="4807158">p</span><span class="op" id="4807159">.</span><span class="ident" id="4807160">ReadWord</span><span class="op" id="4807168">(</span><span class="ident" id="4807169">serialOutThresh</span><span class="op" id="4807184">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4807187">if</span>&nbsp;<span class="ident" id="4807190">n</span>&nbsp;<span class="op" id="4807192">&lt;=</span>&nbsp;<span class="ident" id="4807195">thresh</span>&nbsp;<span class="op" id="4807202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4807206">s</span><span class="op" id="4807207">.</span><span class="ident" id="4807208">interrupt</span><span class="op" id="4807217">(</span><span class="ident" id="4807218">s</span><span class="op" id="4807219">.</span><span class="ident" id="4807220">IntOut</span><span class="op" id="4807226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4807229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4807233">return</span>&nbsp;<span class="ident" id="4807240">b</span><span class="op" id="4807241">,</span>&nbsp;<span class="builtintype" id="4807243">true</span><br>
<span class="lineno">135</span><span class="op" id="4807248">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4807251">func</span>&nbsp;<span class="op" id="4807256">(</span><span class="ident" id="4807257">s</span>&nbsp;<span class="op" id="4807259">*</span><span class="ident" id="4807260">serial</span><span class="op" id="4807266">)</span>&nbsp;<span class="ident" id="4807268">countDown</span><span class="op" id="4807277">(</span><span class="op" id="4807278">)</span>&nbsp;<span class="op" id="4807280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4807283">inWait</span>&nbsp;<span class="op" id="4807290">:=</span>&nbsp;<span class="ident" id="4807293">s</span><span class="op" id="4807294">.</span><span class="ident" id="4807295">p</span><span class="op" id="4807296">.</span><span class="ident" id="4807297">ReadWord</span><span class="op" id="4807305">(</span><span class="ident" id="4807306">serialInWait</span><span class="op" id="4807318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4807321">outWait</span>&nbsp;<span class="op" id="4807329">:=</span>&nbsp;<span class="ident" id="4807332">s</span><span class="op" id="4807333">.</span><span class="ident" id="4807334">p</span><span class="op" id="4807335">.</span><span class="ident" id="4807336">ReadWord</span><span class="op" id="4807344">(</span><span class="ident" id="4807345">serialOutWait</span><span class="op" id="4807358">)</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4807362">if</span>&nbsp;<span class="ident" id="4807365">inWait</span>&nbsp;<span class="op" id="4807372">&gt;</span>&nbsp;<span class="num" id="4807374">0</span>&nbsp;<span class="op" id="4807376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4807380">inWait</span><span class="op" id="4807386">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4807390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4807393">if</span>&nbsp;<span class="ident" id="4807396">outWait</span>&nbsp;<span class="op" id="4807404">&gt;</span>&nbsp;<span class="num" id="4807406">0</span>&nbsp;<span class="op" id="4807408">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4807412">outWait</span><span class="op" id="4807419">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4807423">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4807427">if</span>&nbsp;<span class="ident" id="4807430">inWait</span>&nbsp;<span class="op" id="4807437">==</span>&nbsp;<span class="num" id="4807440">0</span>&nbsp;<span class="op" id="4807442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4807446">if</span>&nbsp;<span class="ident" id="4807449">s</span><span class="op" id="4807450">.</span><span class="ident" id="4807451">InLen</span><span class="op" id="4807456">(</span><span class="op" id="4807457">)</span>&nbsp;<span class="op" id="4807459">&gt;</span>&nbsp;<span class="num" id="4807461">0</span>&nbsp;<span class="op" id="4807463">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4807468">s</span><span class="op" id="4807469">.</span><span class="ident" id="4807470">interrupt</span><span class="op" id="4807479">(</span><span class="ident" id="4807480">s</span><span class="op" id="4807481">.</span><span class="ident" id="4807482">IntIn</span><span class="op" id="4807487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4807491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4807494">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4807498">if</span>&nbsp;<span class="ident" id="4807501">outWait</span>&nbsp;<span class="op" id="4807509">==</span>&nbsp;<span class="num" id="4807512">0</span>&nbsp;<span class="op" id="4807514">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4807518">if</span>&nbsp;<span class="ident" id="4807521">s</span><span class="op" id="4807522">.</span><span class="ident" id="4807523">OutLen</span><span class="op" id="4807529">(</span><span class="op" id="4807530">)</span>&nbsp;<span class="op" id="4807532">&lt;</span>&nbsp;<span class="ident" id="4807534">serialCap</span>&nbsp;<span class="op" id="4807544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4807549">s</span><span class="op" id="4807550">.</span><span class="ident" id="4807551">interrupt</span><span class="op" id="4807560">(</span><span class="ident" id="4807561">s</span><span class="op" id="4807562">.</span><span class="ident" id="4807563">IntOut</span><span class="op" id="4807569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4807573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4807576">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4807580">s</span><span class="op" id="4807581">.</span><span class="ident" id="4807582">p</span><span class="op" id="4807583">.</span><span class="ident" id="4807584">WriteWord</span><span class="op" id="4807593">(</span><span class="ident" id="4807594">serialInWait</span><span class="op" id="4807606">,</span>&nbsp;<span class="ident" id="4807608">inWait</span><span class="op" id="4807614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4807617">s</span><span class="op" id="4807618">.</span><span class="ident" id="4807619">p</span><span class="op" id="4807620">.</span><span class="ident" id="4807621">WriteWord</span><span class="op" id="4807630">(</span><span class="ident" id="4807631">serialOutWait</span><span class="op" id="4807644">,</span>&nbsp;<span class="ident" id="4807646">outWait</span><span class="op" id="4807653">)</span><br>
<span class="lineno"></span><span class="op" id="4807655">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4807658">func</span>&nbsp;<span class="op" id="4807663">(</span><span class="ident" id="4807664">s</span>&nbsp;<span class="op" id="4807666">*</span><span class="ident" id="4807667">serial</span><span class="op" id="4807673">)</span>&nbsp;<span class="ident" id="4807675">flush</span><span class="op" id="4807680">(</span><span class="op" id="4807681">)</span>&nbsp;<span class="op" id="4807683">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4807686">buf</span>&nbsp;<span class="op" id="4807690">:=</span>&nbsp;<span class="builtinfunc" id="4807693">new</span><span class="op" id="4807696">(</span><span class="ident" id="4807697">bytes</span><span class="op" id="4807702">.</span><span class="ident" id="4807703">Buffer</span><span class="op" id="4807709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4807712">for</span>&nbsp;<span class="op" id="4807716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4807720">b</span><span class="op" id="4807721">,</span>&nbsp;<span class="ident" id="4807723">valid</span>&nbsp;<span class="op" id="4807729">:=</span>&nbsp;<span class="ident" id="4807732">s</span><span class="op" id="4807733">.</span><span class="ident" id="4807734">ReadByte</span><span class="op" id="4807742">(</span><span class="op" id="4807743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4807747">if</span>&nbsp;<span class="ident" id="4807750">valid</span>&nbsp;<span class="op" id="4807756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4807761">buf</span><span class="op" id="4807764">.</span><span class="ident" id="4807765">WriteByte</span><span class="op" id="4807774">(</span><span class="ident" id="4807775">b</span><span class="op" id="4807776">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4807780">}</span>&nbsp;<span class="keyword" id="4807782">else</span>&nbsp;<span class="op" id="4807787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4807792">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4807800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4807803">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4807807">if</span>&nbsp;<span class="ident" id="4807810">s</span><span class="op" id="4807811">.</span><span class="ident" id="4807812">Output</span>&nbsp;<span class="op" id="4807819">!=</span>&nbsp;<span class="ident" id="4807822">nil</span>&nbsp;<span class="op" id="4807826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4807830">_</span><span class="op" id="4807831">,</span>&nbsp;<span class="ident" id="4807833">e</span>&nbsp;<span class="op" id="4807835">:=</span>&nbsp;<span class="ident" id="4807838">s</span><span class="op" id="4807839">.</span><span class="ident" id="4807840">Output</span><span class="op" id="4807846">.</span><span class="ident" id="4807847">Write</span><span class="op" id="4807852">(</span><span class="ident" id="4807853">buf</span><span class="op" id="4807856">.</span><span class="ident" id="4807857">Bytes</span><span class="op" id="4807862">(</span><span class="op" id="4807863">)</span><span class="op" id="4807864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4807868">if</span>&nbsp;<span class="ident" id="4807871">e</span>&nbsp;<span class="op" id="4807873">!=</span>&nbsp;<span class="ident" id="4807876">nil</span>&nbsp;<span class="op" id="4807880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4807885">log</span><span class="op" id="4807888">.</span><span class="ident" id="4807889">Print</span><span class="op" id="4807894">(</span><span class="ident" id="4807895">e</span><span class="op" id="4807896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4807900">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4807903">}</span><br>
<span class="lineno"></span><span class="op" id="4807905">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4807908">//&nbsp;Tick&nbsp;counts&nbsp;down&nbsp;the&nbsp;waiting&nbsp;counters&nbsp;and&nbsp;triggers</span><br>
<span class="lineno"></span><span class="comment" id="4807962">//&nbsp;interrupt&nbsp;when&nbsp;the&nbsp;count&nbsp;down&nbsp;reaches&nbsp;zero.</span><br>
<span class="lineno">185</span><span class="keyword" id="4808009">func</span>&nbsp;<span class="op" id="4808014">(</span><span class="ident" id="4808015">s</span>&nbsp;<span class="op" id="4808017">*</span><span class="ident" id="4808018">serial</span><span class="op" id="4808024">)</span>&nbsp;<span class="ident" id="4808026">Tick</span><span class="op" id="4808030">(</span><span class="op" id="4808031">)</span>&nbsp;<span class="op" id="4808033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4808036">s</span><span class="op" id="4808037">.</span><span class="ident" id="4808038">flush</span><span class="op" id="4808043">(</span><span class="op" id="4808044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4808047">s</span><span class="op" id="4808048">.</span><span class="ident" id="4808049">countDown</span><span class="op" id="4808058">(</span><span class="op" id="4808059">)</span><br>
<span class="lineno"></span><span class="op" id="4808061">}</span>
</div>
</body>
</html>
