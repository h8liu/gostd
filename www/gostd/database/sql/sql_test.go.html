<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="7585431">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7585486">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7585540">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7585591">package</span>&nbsp;<span class="ident" id="7585599">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7585604">import</span>&nbsp;<span class="op" id="7585611">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7585614">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7585637">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7585647">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7585654">&#34;math/rand&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7585667">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7585678">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7585689">&#34;strings&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7585700">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7585708">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7585719">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7585726">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="7585729">func</span>&nbsp;<span class="ident" id="7585734">init</span><span class="op" id="7585738">(</span><span class="op" id="7585739">)</span>&nbsp;<span class="op" id="7585741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7585744">type</span>&nbsp;<span class="ident" id="7585749">dbConn</span>&nbsp;<span class="keyword" id="7585756">struct</span>&nbsp;<span class="op" id="7585763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7585767">db</span>&nbsp;<span class="op" id="7585770">*</span><span class="ident" id="7585771">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7585776">c</span>&nbsp;&nbsp;<span class="op" id="7585779">*</span><span class="ident" id="7585780">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7585792">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7585795">freedFrom</span>&nbsp;<span class="op" id="7585805">:=</span>&nbsp;<span class="builtinfunc" id="7585808">make</span><span class="op" id="7585812">(</span><span class="keyword" id="7585813">map</span><span class="op" id="7585816">[</span><span class="ident" id="7585817">dbConn</span><span class="op" id="7585823">]</span><span class="builtintype" id="7585824">string</span><span class="op" id="7585830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7585833">putConnHook</span>&nbsp;<span class="op" id="7585845">=</span>&nbsp;<span class="keyword" id="7585847">func</span><span class="op" id="7585851">(</span><span class="ident" id="7585852">db</span>&nbsp;<span class="op" id="7585855">*</span><span class="ident" id="7585856">DB</span><span class="op" id="7585858">,</span>&nbsp;<span class="ident" id="7585860">c</span>&nbsp;<span class="op" id="7585862">*</span><span class="ident" id="7585863">driverConn</span><span class="op" id="7585873">)</span>&nbsp;<span class="op" id="7585875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7585879">idx</span>&nbsp;<span class="op" id="7585883">:=</span>&nbsp;<span class="op" id="7585886">-</span><span class="num" id="7585887">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7585891">for</span>&nbsp;<span class="ident" id="7585895">i</span><span class="op" id="7585896">,</span>&nbsp;<span class="ident" id="7585898">v</span>&nbsp;<span class="op" id="7585900">:=</span>&nbsp;<span class="keyword" id="7585903">range</span>&nbsp;<span class="ident" id="7585909">db</span><span class="op" id="7585911">.</span><span class="ident" id="7585912">freeConn</span>&nbsp;<span class="op" id="7585921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7585926">if</span>&nbsp;<span class="ident" id="7585929">v</span>&nbsp;<span class="op" id="7585931">==</span>&nbsp;<span class="ident" id="7585934">c</span>&nbsp;<span class="op" id="7585936">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7585942">idx</span>&nbsp;<span class="op" id="7585946">=</span>&nbsp;<span class="ident" id="7585948">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7585954">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7585963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7585967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7585971">if</span>&nbsp;<span class="ident" id="7585974">idx</span>&nbsp;<span class="op" id="7585978">&gt;=</span>&nbsp;<span class="num" id="7585981">0</span>&nbsp;<span class="op" id="7585983">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7585988">//&nbsp;print&nbsp;before&nbsp;panic,&nbsp;as&nbsp;panic&nbsp;may&nbsp;get&nbsp;lost&nbsp;due&nbsp;to&nbsp;conflicting&nbsp;panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7586061">//&nbsp;(all&nbsp;goroutines&nbsp;asleep)&nbsp;elsewhere,&nbsp;since&nbsp;we&nbsp;might&nbsp;not&nbsp;unlock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7586128">//&nbsp;the&nbsp;mutex&nbsp;in&nbsp;freeConn&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7586162">println</span><span class="op" id="7586169">(</span><span class="string" id="7586170">&#34;double&nbsp;free&nbsp;of&nbsp;conn.&nbsp;conflicts&nbsp;are:\nA)&nbsp;&#34;</span>&nbsp;<span class="op" id="7586213">+</span>&nbsp;<span class="ident" id="7586215">freedFrom</span><span class="op" id="7586224">[</span><span class="ident" id="7586225">dbConn</span><span class="op" id="7586231">{</span><span class="ident" id="7586232">db</span><span class="op" id="7586234">,</span>&nbsp;<span class="ident" id="7586236">c</span><span class="op" id="7586237">}</span><span class="op" id="7586238">]</span>&nbsp;<span class="op" id="7586240">+</span>&nbsp;<span class="string" id="7586242">&#34;\n\nand\nB)&nbsp;&#34;</span>&nbsp;<span class="op" id="7586257">+</span>&nbsp;<span class="ident" id="7586259">stack</span><span class="op" id="7586264">(</span><span class="op" id="7586265">)</span><span class="op" id="7586266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7586271">panic</span><span class="op" id="7586276">(</span><span class="string" id="7586277">&#34;double&nbsp;free&nbsp;of&nbsp;conn.&#34;</span><span class="op" id="7586299">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7586303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7586307">freedFrom</span><span class="op" id="7586316">[</span><span class="ident" id="7586317">dbConn</span><span class="op" id="7586323">{</span><span class="ident" id="7586324">db</span><span class="op" id="7586326">,</span>&nbsp;<span class="ident" id="7586328">c</span><span class="op" id="7586329">}</span><span class="op" id="7586330">]</span>&nbsp;<span class="op" id="7586332">=</span>&nbsp;<span class="ident" id="7586334">stack</span><span class="op" id="7586339">(</span><span class="op" id="7586340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7586343">}</span><br>
<span class="lineno"></span><span class="op" id="7586345">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="7586348">const</span>&nbsp;<span class="ident" id="7586354">fakeDBName</span>&nbsp;<span class="op" id="7586365">=</span>&nbsp;<span class="string" id="7586367">&#34;foo&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7586374">var</span>&nbsp;<span class="ident" id="7586378">chrisBirthday</span>&nbsp;<span class="op" id="7586392">=</span>&nbsp;<span class="ident" id="7586394">time</span><span class="op" id="7586398">.</span><span class="ident" id="7586399">Unix</span><span class="op" id="7586403">(</span><span class="num" id="7586404">123456789</span><span class="op" id="7586413">,</span>&nbsp;<span class="num" id="7586415">0</span><span class="op" id="7586416">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7586419">func</span>&nbsp;<span class="ident" id="7586424">newTestDB</span><span class="op" id="7586433">(</span><span class="ident" id="7586434">t</span>&nbsp;<span class="ident" id="7586436">testing</span><span class="op" id="7586443">.</span><span class="ident" id="7586444">TB</span><span class="op" id="7586446">,</span>&nbsp;<span class="ident" id="7586448">name</span>&nbsp;<span class="builtintype" id="7586453">string</span><span class="op" id="7586459">)</span>&nbsp;<span class="op" id="7586461">*</span><span class="ident" id="7586462">DB</span>&nbsp;<span class="op" id="7586465">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7586468">db</span><span class="op" id="7586470">,</span>&nbsp;<span class="ident" id="7586472">err</span>&nbsp;<span class="op" id="7586476">:=</span>&nbsp;<span class="ident" id="7586479">Open</span><span class="op" id="7586483">(</span><span class="string" id="7586484">&#34;test&#34;</span><span class="op" id="7586490">,</span>&nbsp;<span class="ident" id="7586492">fakeDBName</span><span class="op" id="7586502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7586505">if</span>&nbsp;<span class="ident" id="7586508">err</span>&nbsp;<span class="op" id="7586512">!=</span>&nbsp;<span class="ident" id="7586515">nil</span>&nbsp;<span class="op" id="7586519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7586523">t</span><span class="op" id="7586524">.</span><span class="ident" id="7586525">Fatalf</span><span class="op" id="7586531">(</span><span class="string" id="7586532">&#34;Open:&nbsp;%v&#34;</span><span class="op" id="7586542">,</span>&nbsp;<span class="ident" id="7586544">err</span><span class="op" id="7586547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7586550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7586553">if</span>&nbsp;<span class="ident" id="7586556">_</span><span class="op" id="7586557">,</span>&nbsp;<span class="ident" id="7586559">err</span>&nbsp;<span class="op" id="7586563">:=</span>&nbsp;<span class="ident" id="7586566">db</span><span class="op" id="7586568">.</span><span class="ident" id="7586569">Exec</span><span class="op" id="7586573">(</span><span class="string" id="7586574">&#34;WIPE&#34;</span><span class="op" id="7586580">)</span><span class="op" id="7586581">;</span>&nbsp;<span class="ident" id="7586583">err</span>&nbsp;<span class="op" id="7586587">!=</span>&nbsp;<span class="ident" id="7586590">nil</span>&nbsp;<span class="op" id="7586594">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7586598">t</span><span class="op" id="7586599">.</span><span class="ident" id="7586600">Fatalf</span><span class="op" id="7586606">(</span><span class="string" id="7586607">&#34;exec&nbsp;wipe:&nbsp;%v&#34;</span><span class="op" id="7586622">,</span>&nbsp;<span class="ident" id="7586624">err</span><span class="op" id="7586627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7586630">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7586633">if</span>&nbsp;<span class="ident" id="7586636">name</span>&nbsp;<span class="op" id="7586641">==</span>&nbsp;<span class="string" id="7586644">&#34;people&#34;</span>&nbsp;<span class="op" id="7586653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7586657">exec</span><span class="op" id="7586661">(</span><span class="ident" id="7586662">t</span><span class="op" id="7586663">,</span>&nbsp;<span class="ident" id="7586665">db</span><span class="op" id="7586667">,</span>&nbsp;<span class="string" id="7586669">&#34;CREATE|people|name=string,age=int32,photo=blob,dead=bool,bdate=datetime&#34;</span><span class="op" id="7586742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7586746">exec</span><span class="op" id="7586750">(</span><span class="ident" id="7586751">t</span><span class="op" id="7586752">,</span>&nbsp;<span class="ident" id="7586754">db</span><span class="op" id="7586756">,</span>&nbsp;<span class="string" id="7586758">&#34;INSERT|people|name=Alice,age=?,photo=APHOTO&#34;</span><span class="op" id="7586803">,</span>&nbsp;<span class="num" id="7586805">1</span><span class="op" id="7586806">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7586810">exec</span><span class="op" id="7586814">(</span><span class="ident" id="7586815">t</span><span class="op" id="7586816">,</span>&nbsp;<span class="ident" id="7586818">db</span><span class="op" id="7586820">,</span>&nbsp;<span class="string" id="7586822">&#34;INSERT|people|name=Bob,age=?,photo=BPHOTO&#34;</span><span class="op" id="7586865">,</span>&nbsp;<span class="num" id="7586867">2</span><span class="op" id="7586868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7586872">exec</span><span class="op" id="7586876">(</span><span class="ident" id="7586877">t</span><span class="op" id="7586878">,</span>&nbsp;<span class="ident" id="7586880">db</span><span class="op" id="7586882">,</span>&nbsp;<span class="string" id="7586884">&#34;INSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="7586937">,</span>&nbsp;<span class="num" id="7586939">3</span><span class="op" id="7586940">,</span>&nbsp;<span class="ident" id="7586942">chrisBirthday</span><span class="op" id="7586955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7586958">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7586961">if</span>&nbsp;<span class="ident" id="7586964">name</span>&nbsp;<span class="op" id="7586969">==</span>&nbsp;<span class="string" id="7586972">&#34;magicquery&#34;</span>&nbsp;<span class="op" id="7586985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7586989">//&nbsp;Magic&nbsp;table&nbsp;name&nbsp;and&nbsp;column,&nbsp;known&nbsp;by&nbsp;fakedb_test.go.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7587048">exec</span><span class="op" id="7587052">(</span><span class="ident" id="7587053">t</span><span class="op" id="7587054">,</span>&nbsp;<span class="ident" id="7587056">db</span><span class="op" id="7587058">,</span>&nbsp;<span class="string" id="7587060">&#34;CREATE|magicquery|op=string,millis=int32&#34;</span><span class="op" id="7587102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7587106">exec</span><span class="op" id="7587110">(</span><span class="ident" id="7587111">t</span><span class="op" id="7587112">,</span>&nbsp;<span class="ident" id="7587114">db</span><span class="op" id="7587116">,</span>&nbsp;<span class="string" id="7587118">&#34;INSERT|magicquery|op=sleep,millis=10&#34;</span><span class="op" id="7587156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7587159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7587162">return</span>&nbsp;<span class="ident" id="7587169">db</span><br>
<span class="lineno"></span><span class="op" id="7587172">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="7587175">func</span>&nbsp;<span class="ident" id="7587180">exec</span><span class="op" id="7587184">(</span><span class="ident" id="7587185">t</span>&nbsp;<span class="ident" id="7587187">testing</span><span class="op" id="7587194">.</span><span class="ident" id="7587195">TB</span><span class="op" id="7587197">,</span>&nbsp;<span class="ident" id="7587199">db</span>&nbsp;<span class="op" id="7587202">*</span><span class="ident" id="7587203">DB</span><span class="op" id="7587205">,</span>&nbsp;<span class="ident" id="7587207">query</span>&nbsp;<span class="builtintype" id="7587213">string</span><span class="op" id="7587219">,</span>&nbsp;<span class="ident" id="7587221">args</span>&nbsp;<span class="op" id="7587226">...</span><span class="keyword" id="7587229">interface</span><span class="op" id="7587238">{</span><span class="op" id="7587239">}</span><span class="op" id="7587240">)</span>&nbsp;<span class="op" id="7587242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7587245">_</span><span class="op" id="7587246">,</span>&nbsp;<span class="ident" id="7587248">err</span>&nbsp;<span class="op" id="7587252">:=</span>&nbsp;<span class="ident" id="7587255">db</span><span class="op" id="7587257">.</span><span class="ident" id="7587258">Exec</span><span class="op" id="7587262">(</span><span class="ident" id="7587263">query</span><span class="op" id="7587268">,</span>&nbsp;<span class="ident" id="7587270">args</span><span class="op" id="7587274">...</span><span class="op" id="7587277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7587280">if</span>&nbsp;<span class="ident" id="7587283">err</span>&nbsp;<span class="op" id="7587287">!=</span>&nbsp;<span class="ident" id="7587290">nil</span>&nbsp;<span class="op" id="7587294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7587298">t</span><span class="op" id="7587299">.</span><span class="ident" id="7587300">Fatalf</span><span class="op" id="7587306">(</span><span class="string" id="7587307">&#34;Exec&nbsp;of&nbsp;%q:&nbsp;%v&#34;</span><span class="op" id="7587323">,</span>&nbsp;<span class="ident" id="7587325">query</span><span class="op" id="7587330">,</span>&nbsp;<span class="ident" id="7587332">err</span><span class="op" id="7587335">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7587338">}</span><br>
<span class="lineno"></span><span class="op" id="7587340">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7587343">func</span>&nbsp;<span class="ident" id="7587348">closeDB</span><span class="op" id="7587355">(</span><span class="ident" id="7587356">t</span>&nbsp;<span class="ident" id="7587358">testing</span><span class="op" id="7587365">.</span><span class="ident" id="7587366">TB</span><span class="op" id="7587368">,</span>&nbsp;<span class="ident" id="7587370">db</span>&nbsp;<span class="op" id="7587373">*</span><span class="ident" id="7587374">DB</span><span class="op" id="7587376">)</span>&nbsp;<span class="op" id="7587378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7587381">if</span>&nbsp;<span class="ident" id="7587384">e</span>&nbsp;<span class="op" id="7587386">:=</span>&nbsp;<span class="builtinfunc" id="7587389">recover</span><span class="op" id="7587396">(</span><span class="op" id="7587397">)</span><span class="op" id="7587398">;</span>&nbsp;<span class="ident" id="7587400">e</span>&nbsp;<span class="op" id="7587402">!=</span>&nbsp;<span class="ident" id="7587405">nil</span>&nbsp;<span class="op" id="7587409">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7587413">fmt</span><span class="op" id="7587416">.</span><span class="ident" id="7587417">Printf</span><span class="op" id="7587423">(</span><span class="string" id="7587424">&#34;Panic:&nbsp;%v\n&#34;</span><span class="op" id="7587437">,</span>&nbsp;<span class="ident" id="7587439">e</span><span class="op" id="7587440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7587444">panic</span><span class="op" id="7587449">(</span><span class="ident" id="7587450">e</span><span class="op" id="7587451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7587454">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7587457">defer</span>&nbsp;<span class="ident" id="7587463">setHookpostCloseConn</span><span class="op" id="7587483">(</span><span class="ident" id="7587484">nil</span><span class="op" id="7587487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7587490">setHookpostCloseConn</span><span class="op" id="7587510">(</span><span class="keyword" id="7587511">func</span><span class="op" id="7587515">(</span><span class="ident" id="7587516">_</span>&nbsp;<span class="op" id="7587518">*</span><span class="ident" id="7587519">fakeConn</span><span class="op" id="7587527">,</span>&nbsp;<span class="ident" id="7587529">err</span>&nbsp;<span class="builtintype" id="7587533">error</span><span class="op" id="7587538">)</span>&nbsp;<span class="op" id="7587540">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7587544">if</span>&nbsp;<span class="ident" id="7587547">err</span>&nbsp;<span class="op" id="7587551">!=</span>&nbsp;<span class="ident" id="7587554">nil</span>&nbsp;<span class="op" id="7587558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7587563">t</span><span class="op" id="7587564">.</span><span class="ident" id="7587565">Errorf</span><span class="op" id="7587571">(</span><span class="string" id="7587572">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="7587600">,</span>&nbsp;<span class="ident" id="7587602">err</span><span class="op" id="7587605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7587609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7587612">}</span><span class="op" id="7587613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7587616">for</span>&nbsp;<span class="ident" id="7587620">i</span><span class="op" id="7587621">,</span>&nbsp;<span class="ident" id="7587623">dc</span>&nbsp;<span class="op" id="7587626">:=</span>&nbsp;<span class="keyword" id="7587629">range</span>&nbsp;<span class="ident" id="7587635">db</span><span class="op" id="7587637">.</span><span class="ident" id="7587638">freeConn</span>&nbsp;<span class="op" id="7587647">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7587651">if</span>&nbsp;<span class="ident" id="7587654">n</span>&nbsp;<span class="op" id="7587656">:=</span>&nbsp;<span class="builtinfunc" id="7587659">len</span><span class="op" id="7587662">(</span><span class="ident" id="7587663">dc</span><span class="op" id="7587665">.</span><span class="ident" id="7587666">openStmt</span><span class="op" id="7587674">)</span><span class="op" id="7587675">;</span>&nbsp;<span class="ident" id="7587677">n</span>&nbsp;<span class="op" id="7587679">&gt;</span>&nbsp;<span class="num" id="7587681">0</span>&nbsp;<span class="op" id="7587683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7587688">//&nbsp;Just&nbsp;a&nbsp;sanity&nbsp;check.&nbsp;This&nbsp;is&nbsp;legal&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7587732">//&nbsp;general,&nbsp;but&nbsp;if&nbsp;we&nbsp;make&nbsp;the&nbsp;tests&nbsp;clean&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7587781">//&nbsp;their&nbsp;statements&nbsp;first,&nbsp;then&nbsp;we&nbsp;can&nbsp;safely</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7587830">//&nbsp;verify&nbsp;this&nbsp;is&nbsp;always&nbsp;zero&nbsp;here,&nbsp;and&nbsp;any</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7587877">//&nbsp;other&nbsp;value&nbsp;is&nbsp;a&nbsp;leak.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7587906">t</span><span class="op" id="7587907">.</span><span class="ident" id="7587908">Errorf</span><span class="op" id="7587914">(</span><span class="string" id="7587915">&#34;while&nbsp;closing&nbsp;db,&nbsp;freeConn&nbsp;%d/%d&nbsp;had&nbsp;%d&nbsp;open&nbsp;stmts;&nbsp;want&nbsp;0&#34;</span><span class="op" id="7587975">,</span>&nbsp;<span class="ident" id="7587977">i</span><span class="op" id="7587978">,</span>&nbsp;<span class="builtinfunc" id="7587980">len</span><span class="op" id="7587983">(</span><span class="ident" id="7587984">db</span><span class="op" id="7587986">.</span><span class="ident" id="7587987">freeConn</span><span class="op" id="7587995">)</span><span class="op" id="7587996">,</span>&nbsp;<span class="ident" id="7587998">n</span><span class="op" id="7587999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7588003">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7588006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7588009">err</span>&nbsp;<span class="op" id="7588013">:=</span>&nbsp;<span class="ident" id="7588016">db</span><span class="op" id="7588018">.</span><span class="ident" id="7588019">Close</span><span class="op" id="7588024">(</span><span class="op" id="7588025">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7588028">if</span>&nbsp;<span class="ident" id="7588031">err</span>&nbsp;<span class="op" id="7588035">!=</span>&nbsp;<span class="ident" id="7588038">nil</span>&nbsp;<span class="op" id="7588042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7588046">t</span><span class="op" id="7588047">.</span><span class="ident" id="7588048">Fatalf</span><span class="op" id="7588054">(</span><span class="string" id="7588055">&#34;error&nbsp;closing&nbsp;DB:&nbsp;%v&#34;</span><span class="op" id="7588077">,</span>&nbsp;<span class="ident" id="7588079">err</span><span class="op" id="7588082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7588085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7588088">db</span><span class="op" id="7588090">.</span><span class="ident" id="7588091">mu</span><span class="op" id="7588093">.</span><span class="ident" id="7588094">Lock</span><span class="op" id="7588098">(</span><span class="op" id="7588099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7588102">count</span>&nbsp;<span class="op" id="7588108">:=</span>&nbsp;<span class="ident" id="7588111">db</span><span class="op" id="7588113">.</span><span class="ident" id="7588114">numOpen</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7588123">db</span><span class="op" id="7588125">.</span><span class="ident" id="7588126">mu</span><span class="op" id="7588128">.</span><span class="ident" id="7588129">Unlock</span><span class="op" id="7588135">(</span><span class="op" id="7588136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7588139">if</span>&nbsp;<span class="ident" id="7588142">count</span>&nbsp;<span class="op" id="7588148">!=</span>&nbsp;<span class="num" id="7588151">0</span>&nbsp;<span class="op" id="7588153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7588157">t</span><span class="op" id="7588158">.</span><span class="ident" id="7588159">Fatalf</span><span class="op" id="7588165">(</span><span class="string" id="7588166">&#34;%d&nbsp;connections&nbsp;still&nbsp;open&nbsp;after&nbsp;closing&nbsp;DB&#34;</span><span class="op" id="7588210">,</span>&nbsp;<span class="ident" id="7588212">db</span><span class="op" id="7588214">.</span><span class="ident" id="7588215">numOpen</span><span class="op" id="7588222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7588225">}</span><br>
<span class="lineno"></span><span class="op" id="7588227">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="comment" id="7588230">//&nbsp;numPrepares&nbsp;assumes&nbsp;that&nbsp;db&nbsp;has&nbsp;exactly&nbsp;1&nbsp;idle&nbsp;conn&nbsp;and&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="7588297">//&nbsp;its&nbsp;count&nbsp;of&nbsp;calls&nbsp;to&nbsp;Prepare</span><br>
<span class="lineno"></span><span class="keyword" id="7588330">func</span>&nbsp;<span class="ident" id="7588335">numPrepares</span><span class="op" id="7588346">(</span><span class="ident" id="7588347">t</span>&nbsp;<span class="op" id="7588349">*</span><span class="ident" id="7588350">testing</span><span class="op" id="7588357">.</span><span class="ident" id="7588358">T</span><span class="op" id="7588359">,</span>&nbsp;<span class="ident" id="7588361">db</span>&nbsp;<span class="op" id="7588364">*</span><span class="ident" id="7588365">DB</span><span class="op" id="7588367">)</span>&nbsp;<span class="builtintype" id="7588369">int</span>&nbsp;<span class="op" id="7588373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7588376">if</span>&nbsp;<span class="ident" id="7588379">n</span>&nbsp;<span class="op" id="7588381">:=</span>&nbsp;<span class="builtinfunc" id="7588384">len</span><span class="op" id="7588387">(</span><span class="ident" id="7588388">db</span><span class="op" id="7588390">.</span><span class="ident" id="7588391">freeConn</span><span class="op" id="7588399">)</span><span class="op" id="7588400">;</span>&nbsp;<span class="ident" id="7588402">n</span>&nbsp;<span class="op" id="7588404">!=</span>&nbsp;<span class="num" id="7588407">1</span>&nbsp;<span class="op" id="7588409">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7588413">t</span><span class="op" id="7588414">.</span><span class="ident" id="7588415">Fatalf</span><span class="op" id="7588421">(</span><span class="string" id="7588422">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7588447">,</span>&nbsp;<span class="ident" id="7588449">n</span><span class="op" id="7588450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7588453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7588456">return</span>&nbsp;<span class="ident" id="7588463">db</span><span class="op" id="7588465">.</span><span class="ident" id="7588466">freeConn</span><span class="op" id="7588474">[</span><span class="num" id="7588475">0</span><span class="op" id="7588476">]</span><span class="op" id="7588477">.</span><span class="ident" id="7588478">ci</span><span class="op" id="7588480">.</span><span class="op" id="7588481">(</span><span class="op" id="7588482">*</span><span class="ident" id="7588483">fakeConn</span><span class="op" id="7588491">)</span><span class="op" id="7588492">.</span><span class="ident" id="7588493">numPrepare</span><br>
<span class="lineno"></span><span class="op" id="7588504">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="7588507">func</span>&nbsp;<span class="op" id="7588512">(</span><span class="ident" id="7588513">db</span>&nbsp;<span class="op" id="7588516">*</span><span class="ident" id="7588517">DB</span><span class="op" id="7588519">)</span>&nbsp;<span class="ident" id="7588521">numDeps</span><span class="op" id="7588528">(</span><span class="op" id="7588529">)</span>&nbsp;<span class="builtintype" id="7588531">int</span>&nbsp;<span class="op" id="7588535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7588538">db</span><span class="op" id="7588540">.</span><span class="ident" id="7588541">mu</span><span class="op" id="7588543">.</span><span class="ident" id="7588544">Lock</span><span class="op" id="7588548">(</span><span class="op" id="7588549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7588552">defer</span>&nbsp;<span class="ident" id="7588558">db</span><span class="op" id="7588560">.</span><span class="ident" id="7588561">mu</span><span class="op" id="7588563">.</span><span class="ident" id="7588564">Unlock</span><span class="op" id="7588570">(</span><span class="op" id="7588571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7588574">return</span>&nbsp;<span class="builtinfunc" id="7588581">len</span><span class="op" id="7588584">(</span><span class="ident" id="7588585">db</span><span class="op" id="7588587">.</span><span class="ident" id="7588588">dep</span><span class="op" id="7588591">)</span><br>
<span class="lineno"></span><span class="op" id="7588593">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="comment" id="7588596">//&nbsp;Dependencies&nbsp;are&nbsp;closed&nbsp;via&nbsp;a&nbsp;goroutine,&nbsp;so&nbsp;this&nbsp;polls&nbsp;waiting&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="7588666">//&nbsp;numDeps&nbsp;to&nbsp;fall&nbsp;to&nbsp;want,&nbsp;waiting&nbsp;up&nbsp;to&nbsp;d.</span><br>
<span class="lineno"></span><span class="keyword" id="7588711">func</span>&nbsp;<span class="op" id="7588716">(</span><span class="ident" id="7588717">db</span>&nbsp;<span class="op" id="7588720">*</span><span class="ident" id="7588721">DB</span><span class="op" id="7588723">)</span>&nbsp;<span class="ident" id="7588725">numDepsPollUntil</span><span class="op" id="7588741">(</span><span class="ident" id="7588742">want</span>&nbsp;<span class="builtintype" id="7588747">int</span><span class="op" id="7588750">,</span>&nbsp;<span class="ident" id="7588752">d</span>&nbsp;<span class="ident" id="7588754">time</span><span class="op" id="7588758">.</span><span class="ident" id="7588759">Duration</span><span class="op" id="7588767">)</span>&nbsp;<span class="builtintype" id="7588769">int</span>&nbsp;<span class="op" id="7588773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7588776">deadline</span>&nbsp;<span class="op" id="7588785">:=</span>&nbsp;<span class="ident" id="7588788">time</span><span class="op" id="7588792">.</span><span class="ident" id="7588793">Now</span><span class="op" id="7588796">(</span><span class="op" id="7588797">)</span><span class="op" id="7588798">.</span><span class="ident" id="7588799">Add</span><span class="op" id="7588802">(</span><span class="ident" id="7588803">d</span><span class="op" id="7588804">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7588807">for</span>&nbsp;<span class="op" id="7588811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7588815">n</span>&nbsp;<span class="op" id="7588817">:=</span>&nbsp;<span class="ident" id="7588820">db</span><span class="op" id="7588822">.</span><span class="ident" id="7588823">numDeps</span><span class="op" id="7588830">(</span><span class="op" id="7588831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7588835">if</span>&nbsp;<span class="ident" id="7588838">n</span>&nbsp;<span class="op" id="7588840">&lt;=</span>&nbsp;<span class="ident" id="7588843">want</span>&nbsp;<span class="op" id="7588848">||</span>&nbsp;<span class="ident" id="7588851">time</span><span class="op" id="7588855">.</span><span class="ident" id="7588856">Now</span><span class="op" id="7588859">(</span><span class="op" id="7588860">)</span><span class="op" id="7588861">.</span><span class="ident" id="7588862">After</span><span class="op" id="7588867">(</span><span class="ident" id="7588868">deadline</span><span class="op" id="7588876">)</span>&nbsp;<span class="op" id="7588878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7588883">return</span>&nbsp;<span class="ident" id="7588890">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7588894">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7588898">time</span><span class="op" id="7588902">.</span><span class="ident" id="7588903">Sleep</span><span class="op" id="7588908">(</span><span class="num" id="7588909">50</span>&nbsp;<span class="op" id="7588912">*</span>&nbsp;<span class="ident" id="7588914">time</span><span class="op" id="7588918">.</span><span class="ident" id="7588919">Millisecond</span><span class="op" id="7588930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7588933">}</span><br>
<span class="lineno"></span><span class="op" id="7588935">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7588938">func</span>&nbsp;<span class="op" id="7588943">(</span><span class="ident" id="7588944">db</span>&nbsp;<span class="op" id="7588947">*</span><span class="ident" id="7588948">DB</span><span class="op" id="7588950">)</span>&nbsp;<span class="ident" id="7588952">numFreeConns</span><span class="op" id="7588964">(</span><span class="op" id="7588965">)</span>&nbsp;<span class="builtintype" id="7588967">int</span>&nbsp;<span class="op" id="7588971">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7588974">db</span><span class="op" id="7588976">.</span><span class="ident" id="7588977">mu</span><span class="op" id="7588979">.</span><span class="ident" id="7588980">Lock</span><span class="op" id="7588984">(</span><span class="op" id="7588985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7588988">defer</span>&nbsp;<span class="ident" id="7588994">db</span><span class="op" id="7588996">.</span><span class="ident" id="7588997">mu</span><span class="op" id="7588999">.</span><span class="ident" id="7589000">Unlock</span><span class="op" id="7589006">(</span><span class="op" id="7589007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7589010">return</span>&nbsp;<span class="builtinfunc" id="7589017">len</span><span class="op" id="7589020">(</span><span class="ident" id="7589021">db</span><span class="op" id="7589023">.</span><span class="ident" id="7589024">freeConn</span><span class="op" id="7589032">)</span><br>
<span class="lineno"></span><span class="op" id="7589034">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="7589037">func</span>&nbsp;<span class="op" id="7589042">(</span><span class="ident" id="7589043">db</span>&nbsp;<span class="op" id="7589046">*</span><span class="ident" id="7589047">DB</span><span class="op" id="7589049">)</span>&nbsp;<span class="ident" id="7589051">dumpDeps</span><span class="op" id="7589059">(</span><span class="ident" id="7589060">t</span>&nbsp;<span class="op" id="7589062">*</span><span class="ident" id="7589063">testing</span><span class="op" id="7589070">.</span><span class="ident" id="7589071">T</span><span class="op" id="7589072">)</span>&nbsp;<span class="op" id="7589074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7589077">for</span>&nbsp;<span class="ident" id="7589081">fc</span>&nbsp;<span class="op" id="7589084">:=</span>&nbsp;<span class="keyword" id="7589087">range</span>&nbsp;<span class="ident" id="7589093">db</span><span class="op" id="7589095">.</span><span class="ident" id="7589096">dep</span>&nbsp;<span class="op" id="7589100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7589104">db</span><span class="op" id="7589106">.</span><span class="ident" id="7589107">dumpDep</span><span class="op" id="7589114">(</span><span class="ident" id="7589115">t</span><span class="op" id="7589116">,</span>&nbsp;<span class="num" id="7589118">0</span><span class="op" id="7589119">,</span>&nbsp;<span class="ident" id="7589121">fc</span><span class="op" id="7589123">,</span>&nbsp;<span class="keyword" id="7589125">map</span><span class="op" id="7589128">[</span><span class="ident" id="7589129">finalCloser</span><span class="op" id="7589140">]</span><span class="builtintype" id="7589141">bool</span><span class="op" id="7589145">{</span><span class="op" id="7589146">}</span><span class="op" id="7589147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7589150">}</span><br>
<span class="lineno"></span><span class="op" id="7589152">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="keyword" id="7589155">func</span>&nbsp;<span class="op" id="7589160">(</span><span class="ident" id="7589161">db</span>&nbsp;<span class="op" id="7589164">*</span><span class="ident" id="7589165">DB</span><span class="op" id="7589167">)</span>&nbsp;<span class="ident" id="7589169">dumpDep</span><span class="op" id="7589176">(</span><span class="ident" id="7589177">t</span>&nbsp;<span class="op" id="7589179">*</span><span class="ident" id="7589180">testing</span><span class="op" id="7589187">.</span><span class="ident" id="7589188">T</span><span class="op" id="7589189">,</span>&nbsp;<span class="ident" id="7589191">depth</span>&nbsp;<span class="builtintype" id="7589197">int</span><span class="op" id="7589200">,</span>&nbsp;<span class="ident" id="7589202">dep</span>&nbsp;<span class="ident" id="7589206">finalCloser</span><span class="op" id="7589217">,</span>&nbsp;<span class="ident" id="7589219">seen</span>&nbsp;<span class="keyword" id="7589224">map</span><span class="op" id="7589227">[</span><span class="ident" id="7589228">finalCloser</span><span class="op" id="7589239">]</span><span class="builtintype" id="7589240">bool</span><span class="op" id="7589244">)</span>&nbsp;<span class="op" id="7589246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7589249">seen</span><span class="op" id="7589253">[</span><span class="ident" id="7589254">dep</span><span class="op" id="7589257">]</span>&nbsp;<span class="op" id="7589259">=</span>&nbsp;<span class="builtintype" id="7589261">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7589267">indent</span>&nbsp;<span class="op" id="7589274">:=</span>&nbsp;<span class="ident" id="7589277">strings</span><span class="op" id="7589284">.</span><span class="ident" id="7589285">Repeat</span><span class="op" id="7589291">(</span><span class="string" id="7589292">&#34;&nbsp;&nbsp;&#34;</span><span class="op" id="7589296">,</span>&nbsp;<span class="ident" id="7589298">depth</span><span class="op" id="7589303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7589306">ds</span>&nbsp;<span class="op" id="7589309">:=</span>&nbsp;<span class="ident" id="7589312">db</span><span class="op" id="7589314">.</span><span class="ident" id="7589315">dep</span><span class="op" id="7589318">[</span><span class="ident" id="7589319">dep</span><span class="op" id="7589322">]</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7589325">for</span>&nbsp;<span class="ident" id="7589329">k</span>&nbsp;<span class="op" id="7589331">:=</span>&nbsp;<span class="keyword" id="7589334">range</span>&nbsp;<span class="ident" id="7589340">ds</span>&nbsp;<span class="op" id="7589343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7589347">t</span><span class="op" id="7589348">.</span><span class="ident" id="7589349">Logf</span><span class="op" id="7589353">(</span><span class="string" id="7589354">&#34;%s%T&nbsp;(%p)&nbsp;waiting&nbsp;for&nbsp;-&gt;&nbsp;%T&nbsp;(%p)&#34;</span><span class="op" id="7589388">,</span>&nbsp;<span class="ident" id="7589390">indent</span><span class="op" id="7589396">,</span>&nbsp;<span class="ident" id="7589398">dep</span><span class="op" id="7589401">,</span>&nbsp;<span class="ident" id="7589403">dep</span><span class="op" id="7589406">,</span>&nbsp;<span class="ident" id="7589408">k</span><span class="op" id="7589409">,</span>&nbsp;<span class="ident" id="7589411">k</span><span class="op" id="7589412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7589416">if</span>&nbsp;<span class="ident" id="7589419">fc</span><span class="op" id="7589421">,</span>&nbsp;<span class="ident" id="7589423">ok</span>&nbsp;<span class="op" id="7589426">:=</span>&nbsp;<span class="ident" id="7589429">k</span><span class="op" id="7589430">.</span><span class="op" id="7589431">(</span><span class="ident" id="7589432">finalCloser</span><span class="op" id="7589443">)</span><span class="op" id="7589444">;</span>&nbsp;<span class="ident" id="7589446">ok</span>&nbsp;<span class="op" id="7589449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7589454">if</span>&nbsp;<span class="op" id="7589457">!</span><span class="ident" id="7589458">seen</span><span class="op" id="7589462">[</span><span class="ident" id="7589463">fc</span><span class="op" id="7589465">]</span>&nbsp;<span class="op" id="7589467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7589473">db</span><span class="op" id="7589475">.</span><span class="ident" id="7589476">dumpDep</span><span class="op" id="7589483">(</span><span class="ident" id="7589484">t</span><span class="op" id="7589485">,</span>&nbsp;<span class="ident" id="7589487">depth</span><span class="op" id="7589492">+</span><span class="num" id="7589493">1</span><span class="op" id="7589494">,</span>&nbsp;<span class="ident" id="7589496">fc</span><span class="op" id="7589498">,</span>&nbsp;<span class="ident" id="7589500">seen</span><span class="op" id="7589504">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7589509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7589513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7589516">}</span><br>
<span class="lineno"></span><span class="op" id="7589518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="7589521">func</span>&nbsp;<span class="ident" id="7589526">TestQuery</span><span class="op" id="7589535">(</span><span class="ident" id="7589536">t</span>&nbsp;<span class="op" id="7589538">*</span><span class="ident" id="7589539">testing</span><span class="op" id="7589546">.</span><span class="ident" id="7589547">T</span><span class="op" id="7589548">)</span>&nbsp;<span class="op" id="7589550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7589553">db</span>&nbsp;<span class="op" id="7589556">:=</span>&nbsp;<span class="ident" id="7589559">newTestDB</span><span class="op" id="7589568">(</span><span class="ident" id="7589569">t</span><span class="op" id="7589570">,</span>&nbsp;<span class="string" id="7589572">&#34;people&#34;</span><span class="op" id="7589580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7589583">defer</span>&nbsp;<span class="ident" id="7589589">closeDB</span><span class="op" id="7589596">(</span><span class="ident" id="7589597">t</span><span class="op" id="7589598">,</span>&nbsp;<span class="ident" id="7589600">db</span><span class="op" id="7589602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7589605">prepares0</span>&nbsp;<span class="op" id="7589615">:=</span>&nbsp;<span class="ident" id="7589618">numPrepares</span><span class="op" id="7589629">(</span><span class="ident" id="7589630">t</span><span class="op" id="7589631">,</span>&nbsp;<span class="ident" id="7589633">db</span><span class="op" id="7589635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7589638">rows</span><span class="op" id="7589642">,</span>&nbsp;<span class="ident" id="7589644">err</span>&nbsp;<span class="op" id="7589648">:=</span>&nbsp;<span class="ident" id="7589651">db</span><span class="op" id="7589653">.</span><span class="ident" id="7589654">Query</span><span class="op" id="7589659">(</span><span class="string" id="7589660">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="7589685">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7589688">if</span>&nbsp;<span class="ident" id="7589691">err</span>&nbsp;<span class="op" id="7589695">!=</span>&nbsp;<span class="ident" id="7589698">nil</span>&nbsp;<span class="op" id="7589702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7589706">t</span><span class="op" id="7589707">.</span><span class="ident" id="7589708">Fatalf</span><span class="op" id="7589714">(</span><span class="string" id="7589715">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="7589726">,</span>&nbsp;<span class="ident" id="7589728">err</span><span class="op" id="7589731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7589734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7589737">type</span>&nbsp;<span class="ident" id="7589742">row</span>&nbsp;<span class="keyword" id="7589746">struct</span>&nbsp;<span class="op" id="7589753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7589757">age</span>&nbsp;&nbsp;<span class="builtintype" id="7589762">int</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7589768">name</span>&nbsp;<span class="builtintype" id="7589773">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7589781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7589784">got</span>&nbsp;<span class="op" id="7589788">:=</span>&nbsp;<span class="op" id="7589791">[</span><span class="op" id="7589792">]</span><span class="ident" id="7589793">row</span><span class="op" id="7589796">{</span><span class="op" id="7589797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7589800">for</span>&nbsp;<span class="ident" id="7589804">rows</span><span class="op" id="7589808">.</span><span class="ident" id="7589809">Next</span><span class="op" id="7589813">(</span><span class="op" id="7589814">)</span>&nbsp;<span class="op" id="7589816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7589820">var</span>&nbsp;<span class="ident" id="7589824">r</span>&nbsp;<span class="ident" id="7589826">row</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7589832">err</span>&nbsp;<span class="op" id="7589836">=</span>&nbsp;<span class="ident" id="7589838">rows</span><span class="op" id="7589842">.</span><span class="ident" id="7589843">Scan</span><span class="op" id="7589847">(</span><span class="op" id="7589848">&amp;</span><span class="ident" id="7589849">r</span><span class="op" id="7589850">.</span><span class="ident" id="7589851">age</span><span class="op" id="7589854">,</span>&nbsp;<span class="op" id="7589856">&amp;</span><span class="ident" id="7589857">r</span><span class="op" id="7589858">.</span><span class="ident" id="7589859">name</span><span class="op" id="7589863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7589867">if</span>&nbsp;<span class="ident" id="7589870">err</span>&nbsp;<span class="op" id="7589874">!=</span>&nbsp;<span class="ident" id="7589877">nil</span>&nbsp;<span class="op" id="7589881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7589886">t</span><span class="op" id="7589887">.</span><span class="ident" id="7589888">Fatalf</span><span class="op" id="7589894">(</span><span class="string" id="7589895">&#34;Scan:&nbsp;%v&#34;</span><span class="op" id="7589905">,</span>&nbsp;<span class="ident" id="7589907">err</span><span class="op" id="7589910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7589914">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7589918">got</span>&nbsp;<span class="op" id="7589922">=</span>&nbsp;<span class="builtinfunc" id="7589924">append</span><span class="op" id="7589930">(</span><span class="ident" id="7589931">got</span><span class="op" id="7589934">,</span>&nbsp;<span class="ident" id="7589936">r</span><span class="op" id="7589937">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7589940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7589943">err</span>&nbsp;<span class="op" id="7589947">=</span>&nbsp;<span class="ident" id="7589949">rows</span><span class="op" id="7589953">.</span><span class="ident" id="7589954">Err</span><span class="op" id="7589957">(</span><span class="op" id="7589958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7589961">if</span>&nbsp;<span class="ident" id="7589964">err</span>&nbsp;<span class="op" id="7589968">!=</span>&nbsp;<span class="ident" id="7589971">nil</span>&nbsp;<span class="op" id="7589975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7589979">t</span><span class="op" id="7589980">.</span><span class="ident" id="7589981">Fatalf</span><span class="op" id="7589987">(</span><span class="string" id="7589988">&#34;Err:&nbsp;%v&#34;</span><span class="op" id="7589997">,</span>&nbsp;<span class="ident" id="7589999">err</span><span class="op" id="7590002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7590005">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7590008">want</span>&nbsp;<span class="op" id="7590013">:=</span>&nbsp;<span class="op" id="7590016">[</span><span class="op" id="7590017">]</span><span class="ident" id="7590018">row</span><span class="op" id="7590021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7590025">{</span><span class="ident" id="7590026">age</span><span class="op" id="7590029">:</span>&nbsp;<span class="num" id="7590031">1</span><span class="op" id="7590032">,</span>&nbsp;<span class="ident" id="7590034">name</span><span class="op" id="7590038">:</span>&nbsp;<span class="string" id="7590040">&#34;Alice&#34;</span><span class="op" id="7590047">}</span><span class="op" id="7590048">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7590052">{</span><span class="ident" id="7590053">age</span><span class="op" id="7590056">:</span>&nbsp;<span class="num" id="7590058">2</span><span class="op" id="7590059">,</span>&nbsp;<span class="ident" id="7590061">name</span><span class="op" id="7590065">:</span>&nbsp;<span class="string" id="7590067">&#34;Bob&#34;</span><span class="op" id="7590072">}</span><span class="op" id="7590073">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7590077">{</span><span class="ident" id="7590078">age</span><span class="op" id="7590081">:</span>&nbsp;<span class="num" id="7590083">3</span><span class="op" id="7590084">,</span>&nbsp;<span class="ident" id="7590086">name</span><span class="op" id="7590090">:</span>&nbsp;<span class="string" id="7590092">&#34;Chris&#34;</span><span class="op" id="7590099">}</span><span class="op" id="7590100">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7590103">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7590106">if</span>&nbsp;<span class="op" id="7590109">!</span><span class="ident" id="7590110">reflect</span><span class="op" id="7590117">.</span><span class="ident" id="7590118">DeepEqual</span><span class="op" id="7590127">(</span><span class="ident" id="7590128">got</span><span class="op" id="7590131">,</span>&nbsp;<span class="ident" id="7590133">want</span><span class="op" id="7590137">)</span>&nbsp;<span class="op" id="7590139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7590143">t</span><span class="op" id="7590144">.</span><span class="ident" id="7590145">Errorf</span><span class="op" id="7590151">(</span><span class="string" id="7590152">&#34;mismatch.\n&nbsp;got:&nbsp;%#v\nwant:&nbsp;%#v&#34;</span><span class="op" id="7590185">,</span>&nbsp;<span class="ident" id="7590187">got</span><span class="op" id="7590190">,</span>&nbsp;<span class="ident" id="7590192">want</span><span class="op" id="7590196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7590199">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7590203">//&nbsp;And&nbsp;verify&nbsp;that&nbsp;the&nbsp;final&nbsp;rows.Next()&nbsp;call,&nbsp;which&nbsp;hit&nbsp;EOF,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7590266">//&nbsp;also&nbsp;closed&nbsp;the&nbsp;rows&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7590303">if</span>&nbsp;<span class="ident" id="7590306">n</span>&nbsp;<span class="op" id="7590308">:=</span>&nbsp;<span class="ident" id="7590311">db</span><span class="op" id="7590313">.</span><span class="ident" id="7590314">numFreeConns</span><span class="op" id="7590326">(</span><span class="op" id="7590327">)</span><span class="op" id="7590328">;</span>&nbsp;<span class="ident" id="7590330">n</span>&nbsp;<span class="op" id="7590332">!=</span>&nbsp;<span class="num" id="7590335">1</span>&nbsp;<span class="op" id="7590337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7590341">t</span><span class="op" id="7590342">.</span><span class="ident" id="7590343">Fatalf</span><span class="op" id="7590349">(</span><span class="string" id="7590350">&#34;free&nbsp;conns&nbsp;after&nbsp;query&nbsp;hitting&nbsp;EOF&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7590399">,</span>&nbsp;<span class="ident" id="7590401">n</span><span class="op" id="7590402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7590405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7590408">if</span>&nbsp;<span class="ident" id="7590411">prepares</span>&nbsp;<span class="op" id="7590420">:=</span>&nbsp;<span class="ident" id="7590423">numPrepares</span><span class="op" id="7590434">(</span><span class="ident" id="7590435">t</span><span class="op" id="7590436">,</span>&nbsp;<span class="ident" id="7590438">db</span><span class="op" id="7590440">)</span>&nbsp;<span class="op" id="7590442">-</span>&nbsp;<span class="ident" id="7590444">prepares0</span><span class="op" id="7590453">;</span>&nbsp;<span class="ident" id="7590455">prepares</span>&nbsp;<span class="op" id="7590464">!=</span>&nbsp;<span class="num" id="7590467">1</span>&nbsp;<span class="op" id="7590469">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7590473">t</span><span class="op" id="7590474">.</span><span class="ident" id="7590475">Errorf</span><span class="op" id="7590481">(</span><span class="string" id="7590482">&#34;executed&nbsp;%d&nbsp;Prepare&nbsp;statements;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7590522">,</span>&nbsp;<span class="ident" id="7590524">prepares</span><span class="op" id="7590532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7590535">}</span><br>
<span class="lineno"></span><span class="op" id="7590537">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7590540">func</span>&nbsp;<span class="ident" id="7590545">TestByteOwnership</span><span class="op" id="7590562">(</span><span class="ident" id="7590563">t</span>&nbsp;<span class="op" id="7590565">*</span><span class="ident" id="7590566">testing</span><span class="op" id="7590573">.</span><span class="ident" id="7590574">T</span><span class="op" id="7590575">)</span>&nbsp;<span class="op" id="7590577">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7590580">db</span>&nbsp;<span class="op" id="7590583">:=</span>&nbsp;<span class="ident" id="7590586">newTestDB</span><span class="op" id="7590595">(</span><span class="ident" id="7590596">t</span><span class="op" id="7590597">,</span>&nbsp;<span class="string" id="7590599">&#34;people&#34;</span><span class="op" id="7590607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7590610">defer</span>&nbsp;<span class="ident" id="7590616">closeDB</span><span class="op" id="7590623">(</span><span class="ident" id="7590624">t</span><span class="op" id="7590625">,</span>&nbsp;<span class="ident" id="7590627">db</span><span class="op" id="7590629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7590632">rows</span><span class="op" id="7590636">,</span>&nbsp;<span class="ident" id="7590638">err</span>&nbsp;<span class="op" id="7590642">:=</span>&nbsp;<span class="ident" id="7590645">db</span><span class="op" id="7590647">.</span><span class="ident" id="7590648">Query</span><span class="op" id="7590653">(</span><span class="string" id="7590654">&#34;SELECT|people|name,photo|&#34;</span><span class="op" id="7590681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7590684">if</span>&nbsp;<span class="ident" id="7590687">err</span>&nbsp;<span class="op" id="7590691">!=</span>&nbsp;<span class="ident" id="7590694">nil</span>&nbsp;<span class="op" id="7590698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7590702">t</span><span class="op" id="7590703">.</span><span class="ident" id="7590704">Fatalf</span><span class="op" id="7590710">(</span><span class="string" id="7590711">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="7590722">,</span>&nbsp;<span class="ident" id="7590724">err</span><span class="op" id="7590727">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7590730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7590733">type</span>&nbsp;<span class="ident" id="7590738">row</span>&nbsp;<span class="keyword" id="7590742">struct</span>&nbsp;<span class="op" id="7590749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7590753">name</span>&nbsp;&nbsp;<span class="op" id="7590759">[</span><span class="op" id="7590760">]</span><span class="builtintype" id="7590761">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7590768">photo</span>&nbsp;<span class="ident" id="7590774">RawBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7590784">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7590787">got</span>&nbsp;<span class="op" id="7590791">:=</span>&nbsp;<span class="op" id="7590794">[</span><span class="op" id="7590795">]</span><span class="ident" id="7590796">row</span><span class="op" id="7590799">{</span><span class="op" id="7590800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7590803">for</span>&nbsp;<span class="ident" id="7590807">rows</span><span class="op" id="7590811">.</span><span class="ident" id="7590812">Next</span><span class="op" id="7590816">(</span><span class="op" id="7590817">)</span>&nbsp;<span class="op" id="7590819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7590823">var</span>&nbsp;<span class="ident" id="7590827">r</span>&nbsp;<span class="ident" id="7590829">row</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7590835">err</span>&nbsp;<span class="op" id="7590839">=</span>&nbsp;<span class="ident" id="7590841">rows</span><span class="op" id="7590845">.</span><span class="ident" id="7590846">Scan</span><span class="op" id="7590850">(</span><span class="op" id="7590851">&amp;</span><span class="ident" id="7590852">r</span><span class="op" id="7590853">.</span><span class="ident" id="7590854">name</span><span class="op" id="7590858">,</span>&nbsp;<span class="op" id="7590860">&amp;</span><span class="ident" id="7590861">r</span><span class="op" id="7590862">.</span><span class="ident" id="7590863">photo</span><span class="op" id="7590868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7590872">if</span>&nbsp;<span class="ident" id="7590875">err</span>&nbsp;<span class="op" id="7590879">!=</span>&nbsp;<span class="ident" id="7590882">nil</span>&nbsp;<span class="op" id="7590886">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7590891">t</span><span class="op" id="7590892">.</span><span class="ident" id="7590893">Fatalf</span><span class="op" id="7590899">(</span><span class="string" id="7590900">&#34;Scan:&nbsp;%v&#34;</span><span class="op" id="7590910">,</span>&nbsp;<span class="ident" id="7590912">err</span><span class="op" id="7590915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7590919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7590923">got</span>&nbsp;<span class="op" id="7590927">=</span>&nbsp;<span class="builtinfunc" id="7590929">append</span><span class="op" id="7590935">(</span><span class="ident" id="7590936">got</span><span class="op" id="7590939">,</span>&nbsp;<span class="ident" id="7590941">r</span><span class="op" id="7590942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7590945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7590948">corruptMemory</span>&nbsp;<span class="op" id="7590962">:=</span>&nbsp;<span class="op" id="7590965">[</span><span class="op" id="7590966">]</span><span class="builtintype" id="7590967">byte</span><span class="op" id="7590971">(</span><span class="string" id="7590972">&#34;\xffPHOTO&#34;</span><span class="op" id="7590983">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7590986">want</span>&nbsp;<span class="op" id="7590991">:=</span>&nbsp;<span class="op" id="7590994">[</span><span class="op" id="7590995">]</span><span class="ident" id="7590996">row</span><span class="op" id="7590999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7591003">{</span><span class="ident" id="7591004">name</span><span class="op" id="7591008">:</span>&nbsp;<span class="op" id="7591010">[</span><span class="op" id="7591011">]</span><span class="builtintype" id="7591012">byte</span><span class="op" id="7591016">(</span><span class="string" id="7591017">&#34;Alice&#34;</span><span class="op" id="7591024">)</span><span class="op" id="7591025">,</span>&nbsp;<span class="ident" id="7591027">photo</span><span class="op" id="7591032">:</span>&nbsp;<span class="ident" id="7591034">corruptMemory</span><span class="op" id="7591047">}</span><span class="op" id="7591048">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7591052">{</span><span class="ident" id="7591053">name</span><span class="op" id="7591057">:</span>&nbsp;<span class="op" id="7591059">[</span><span class="op" id="7591060">]</span><span class="builtintype" id="7591061">byte</span><span class="op" id="7591065">(</span><span class="string" id="7591066">&#34;Bob&#34;</span><span class="op" id="7591071">)</span><span class="op" id="7591072">,</span>&nbsp;<span class="ident" id="7591074">photo</span><span class="op" id="7591079">:</span>&nbsp;<span class="ident" id="7591081">corruptMemory</span><span class="op" id="7591094">}</span><span class="op" id="7591095">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7591099">{</span><span class="ident" id="7591100">name</span><span class="op" id="7591104">:</span>&nbsp;<span class="op" id="7591106">[</span><span class="op" id="7591107">]</span><span class="builtintype" id="7591108">byte</span><span class="op" id="7591112">(</span><span class="string" id="7591113">&#34;Chris&#34;</span><span class="op" id="7591120">)</span><span class="op" id="7591121">,</span>&nbsp;<span class="ident" id="7591123">photo</span><span class="op" id="7591128">:</span>&nbsp;<span class="ident" id="7591130">corruptMemory</span><span class="op" id="7591143">}</span><span class="op" id="7591144">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7591147">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7591150">if</span>&nbsp;<span class="op" id="7591153">!</span><span class="ident" id="7591154">reflect</span><span class="op" id="7591161">.</span><span class="ident" id="7591162">DeepEqual</span><span class="op" id="7591171">(</span><span class="ident" id="7591172">got</span><span class="op" id="7591175">,</span>&nbsp;<span class="ident" id="7591177">want</span><span class="op" id="7591181">)</span>&nbsp;<span class="op" id="7591183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7591187">t</span><span class="op" id="7591188">.</span><span class="ident" id="7591189">Errorf</span><span class="op" id="7591195">(</span><span class="string" id="7591196">&#34;mismatch.\n&nbsp;got:&nbsp;%#v\nwant:&nbsp;%#v&#34;</span><span class="op" id="7591229">,</span>&nbsp;<span class="ident" id="7591231">got</span><span class="op" id="7591234">,</span>&nbsp;<span class="ident" id="7591236">want</span><span class="op" id="7591240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7591243">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7591247">var</span>&nbsp;<span class="ident" id="7591251">photo</span>&nbsp;<span class="ident" id="7591257">RawBytes</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7591267">err</span>&nbsp;<span class="op" id="7591271">=</span>&nbsp;<span class="ident" id="7591273">db</span><span class="op" id="7591275">.</span><span class="ident" id="7591276">QueryRow</span><span class="op" id="7591284">(</span><span class="string" id="7591285">&#34;SELECT|people|photo|name=?&#34;</span><span class="op" id="7591313">,</span>&nbsp;<span class="string" id="7591315">&#34;Alice&#34;</span><span class="op" id="7591322">)</span><span class="op" id="7591323">.</span><span class="ident" id="7591324">Scan</span><span class="op" id="7591328">(</span><span class="op" id="7591329">&amp;</span><span class="ident" id="7591330">photo</span><span class="op" id="7591335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7591338">if</span>&nbsp;<span class="ident" id="7591341">err</span>&nbsp;<span class="op" id="7591345">==</span>&nbsp;<span class="ident" id="7591348">nil</span>&nbsp;<span class="op" id="7591352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7591356">t</span><span class="op" id="7591357">.</span><span class="ident" id="7591358">Error</span><span class="op" id="7591363">(</span><span class="string" id="7591364">&#34;want&nbsp;error&nbsp;scanning&nbsp;into&nbsp;RawBytes&nbsp;from&nbsp;QueryRow&#34;</span><span class="op" id="7591413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7591416">}</span><br>
<span class="lineno"></span><span class="op" id="7591418">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span><span class="keyword" id="7591421">func</span>&nbsp;<span class="ident" id="7591426">TestRowsColumns</span><span class="op" id="7591441">(</span><span class="ident" id="7591442">t</span>&nbsp;<span class="op" id="7591444">*</span><span class="ident" id="7591445">testing</span><span class="op" id="7591452">.</span><span class="ident" id="7591453">T</span><span class="op" id="7591454">)</span>&nbsp;<span class="op" id="7591456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7591459">db</span>&nbsp;<span class="op" id="7591462">:=</span>&nbsp;<span class="ident" id="7591465">newTestDB</span><span class="op" id="7591474">(</span><span class="ident" id="7591475">t</span><span class="op" id="7591476">,</span>&nbsp;<span class="string" id="7591478">&#34;people&#34;</span><span class="op" id="7591486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7591489">defer</span>&nbsp;<span class="ident" id="7591495">closeDB</span><span class="op" id="7591502">(</span><span class="ident" id="7591503">t</span><span class="op" id="7591504">,</span>&nbsp;<span class="ident" id="7591506">db</span><span class="op" id="7591508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7591511">rows</span><span class="op" id="7591515">,</span>&nbsp;<span class="ident" id="7591517">err</span>&nbsp;<span class="op" id="7591521">:=</span>&nbsp;<span class="ident" id="7591524">db</span><span class="op" id="7591526">.</span><span class="ident" id="7591527">Query</span><span class="op" id="7591532">(</span><span class="string" id="7591533">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="7591558">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7591561">if</span>&nbsp;<span class="ident" id="7591564">err</span>&nbsp;<span class="op" id="7591568">!=</span>&nbsp;<span class="ident" id="7591571">nil</span>&nbsp;<span class="op" id="7591575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7591579">t</span><span class="op" id="7591580">.</span><span class="ident" id="7591581">Fatalf</span><span class="op" id="7591587">(</span><span class="string" id="7591588">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="7591599">,</span>&nbsp;<span class="ident" id="7591601">err</span><span class="op" id="7591604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7591607">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7591610">cols</span><span class="op" id="7591614">,</span>&nbsp;<span class="ident" id="7591616">err</span>&nbsp;<span class="op" id="7591620">:=</span>&nbsp;<span class="ident" id="7591623">rows</span><span class="op" id="7591627">.</span><span class="ident" id="7591628">Columns</span><span class="op" id="7591635">(</span><span class="op" id="7591636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7591639">if</span>&nbsp;<span class="ident" id="7591642">err</span>&nbsp;<span class="op" id="7591646">!=</span>&nbsp;<span class="ident" id="7591649">nil</span>&nbsp;<span class="op" id="7591653">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7591657">t</span><span class="op" id="7591658">.</span><span class="ident" id="7591659">Fatalf</span><span class="op" id="7591665">(</span><span class="string" id="7591666">&#34;Columns:&nbsp;%v&#34;</span><span class="op" id="7591679">,</span>&nbsp;<span class="ident" id="7591681">err</span><span class="op" id="7591684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7591687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7591690">want</span>&nbsp;<span class="op" id="7591695">:=</span>&nbsp;<span class="op" id="7591698">[</span><span class="op" id="7591699">]</span><span class="builtintype" id="7591700">string</span><span class="op" id="7591706">{</span><span class="string" id="7591707">&#34;age&#34;</span><span class="op" id="7591712">,</span>&nbsp;<span class="string" id="7591714">&#34;name&#34;</span><span class="op" id="7591720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7591723">if</span>&nbsp;<span class="op" id="7591726">!</span><span class="ident" id="7591727">reflect</span><span class="op" id="7591734">.</span><span class="ident" id="7591735">DeepEqual</span><span class="op" id="7591744">(</span><span class="ident" id="7591745">cols</span><span class="op" id="7591749">,</span>&nbsp;<span class="ident" id="7591751">want</span><span class="op" id="7591755">)</span>&nbsp;<span class="op" id="7591757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7591761">t</span><span class="op" id="7591762">.</span><span class="ident" id="7591763">Errorf</span><span class="op" id="7591769">(</span><span class="string" id="7591770">&#34;got&nbsp;%#v;&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="7591789">,</span>&nbsp;<span class="ident" id="7591791">cols</span><span class="op" id="7591795">,</span>&nbsp;<span class="ident" id="7591797">want</span><span class="op" id="7591801">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7591804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7591807">if</span>&nbsp;<span class="ident" id="7591810">err</span>&nbsp;<span class="op" id="7591814">:=</span>&nbsp;<span class="ident" id="7591817">rows</span><span class="op" id="7591821">.</span><span class="ident" id="7591822">Close</span><span class="op" id="7591827">(</span><span class="op" id="7591828">)</span><span class="op" id="7591829">;</span>&nbsp;<span class="ident" id="7591831">err</span>&nbsp;<span class="op" id="7591835">!=</span>&nbsp;<span class="ident" id="7591838">nil</span>&nbsp;<span class="op" id="7591842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7591846">t</span><span class="op" id="7591847">.</span><span class="ident" id="7591848">Errorf</span><span class="op" id="7591854">(</span><span class="string" id="7591855">&#34;error&nbsp;closing&nbsp;rows:&nbsp;%s&#34;</span><span class="op" id="7591879">,</span>&nbsp;<span class="ident" id="7591881">err</span><span class="op" id="7591884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7591887">}</span><br>
<span class="lineno"></span><span class="op" id="7591889">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="7591892">func</span>&nbsp;<span class="ident" id="7591897">TestQueryRow</span><span class="op" id="7591909">(</span><span class="ident" id="7591910">t</span>&nbsp;<span class="op" id="7591912">*</span><span class="ident" id="7591913">testing</span><span class="op" id="7591920">.</span><span class="ident" id="7591921">T</span><span class="op" id="7591922">)</span>&nbsp;<span class="op" id="7591924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7591927">db</span>&nbsp;<span class="op" id="7591930">:=</span>&nbsp;<span class="ident" id="7591933">newTestDB</span><span class="op" id="7591942">(</span><span class="ident" id="7591943">t</span><span class="op" id="7591944">,</span>&nbsp;<span class="string" id="7591946">&#34;people&#34;</span><span class="op" id="7591954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7591957">defer</span>&nbsp;<span class="ident" id="7591963">closeDB</span><span class="op" id="7591970">(</span><span class="ident" id="7591971">t</span><span class="op" id="7591972">,</span>&nbsp;<span class="ident" id="7591974">db</span><span class="op" id="7591976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7591979">var</span>&nbsp;<span class="ident" id="7591983">name</span>&nbsp;<span class="builtintype" id="7591988">string</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7591996">var</span>&nbsp;<span class="ident" id="7592000">age</span>&nbsp;<span class="builtintype" id="7592004">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7592009">var</span>&nbsp;<span class="ident" id="7592013">birthday</span>&nbsp;<span class="ident" id="7592022">time</span><span class="op" id="7592026">.</span><span class="ident" id="7592027">Time</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7592034">err</span>&nbsp;<span class="op" id="7592038">:=</span>&nbsp;<span class="ident" id="7592041">db</span><span class="op" id="7592043">.</span><span class="ident" id="7592044">QueryRow</span><span class="op" id="7592052">(</span><span class="string" id="7592053">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="7592083">,</span>&nbsp;<span class="num" id="7592085">3</span><span class="op" id="7592086">)</span><span class="op" id="7592087">.</span><span class="ident" id="7592088">Scan</span><span class="op" id="7592092">(</span><span class="op" id="7592093">&amp;</span><span class="ident" id="7592094">age</span><span class="op" id="7592097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7592100">if</span>&nbsp;<span class="ident" id="7592103">err</span>&nbsp;<span class="op" id="7592107">==</span>&nbsp;<span class="ident" id="7592110">nil</span>&nbsp;<span class="op" id="7592114">||</span>&nbsp;<span class="op" id="7592117">!</span><span class="ident" id="7592118">strings</span><span class="op" id="7592125">.</span><span class="ident" id="7592126">Contains</span><span class="op" id="7592134">(</span><span class="ident" id="7592135">err</span><span class="op" id="7592138">.</span><span class="ident" id="7592139">Error</span><span class="op" id="7592144">(</span><span class="op" id="7592145">)</span><span class="op" id="7592146">,</span>&nbsp;<span class="string" id="7592148">&#34;expected&nbsp;2&nbsp;destination&nbsp;arguments&#34;</span><span class="op" id="7592182">)</span>&nbsp;<span class="op" id="7592184">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7592188">t</span><span class="op" id="7592189">.</span><span class="ident" id="7592190">Errorf</span><span class="op" id="7592196">(</span><span class="string" id="7592197">&#34;expected&nbsp;error&nbsp;from&nbsp;wrong&nbsp;number&nbsp;of&nbsp;arguments;&nbsp;actually&nbsp;got:&nbsp;%v&#34;</span><span class="op" id="7592262">,</span>&nbsp;<span class="ident" id="7592264">err</span><span class="op" id="7592267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7592270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7592274">err</span>&nbsp;<span class="op" id="7592278">=</span>&nbsp;<span class="ident" id="7592280">db</span><span class="op" id="7592282">.</span><span class="ident" id="7592283">QueryRow</span><span class="op" id="7592291">(</span><span class="string" id="7592292">&#34;SELECT|people|bdate|age=?&#34;</span><span class="op" id="7592319">,</span>&nbsp;<span class="num" id="7592321">3</span><span class="op" id="7592322">)</span><span class="op" id="7592323">.</span><span class="ident" id="7592324">Scan</span><span class="op" id="7592328">(</span><span class="op" id="7592329">&amp;</span><span class="ident" id="7592330">birthday</span><span class="op" id="7592338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7592341">if</span>&nbsp;<span class="ident" id="7592344">err</span>&nbsp;<span class="op" id="7592348">!=</span>&nbsp;<span class="ident" id="7592351">nil</span>&nbsp;<span class="op" id="7592355">||</span>&nbsp;<span class="op" id="7592358">!</span><span class="ident" id="7592359">birthday</span><span class="op" id="7592367">.</span><span class="ident" id="7592368">Equal</span><span class="op" id="7592373">(</span><span class="ident" id="7592374">chrisBirthday</span><span class="op" id="7592387">)</span>&nbsp;<span class="op" id="7592389">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7592393">t</span><span class="op" id="7592394">.</span><span class="ident" id="7592395">Errorf</span><span class="op" id="7592401">(</span><span class="string" id="7592402">&#34;chris&nbsp;birthday&nbsp;=&nbsp;%v,&nbsp;err&nbsp;=&nbsp;%v;&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7592442">,</span>&nbsp;<span class="ident" id="7592444">birthday</span><span class="op" id="7592452">,</span>&nbsp;<span class="ident" id="7592454">err</span><span class="op" id="7592457">,</span>&nbsp;<span class="ident" id="7592459">chrisBirthday</span><span class="op" id="7592472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7592475">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7592479">err</span>&nbsp;<span class="op" id="7592483">=</span>&nbsp;<span class="ident" id="7592485">db</span><span class="op" id="7592487">.</span><span class="ident" id="7592488">QueryRow</span><span class="op" id="7592496">(</span><span class="string" id="7592497">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="7592527">,</span>&nbsp;<span class="num" id="7592529">2</span><span class="op" id="7592530">)</span><span class="op" id="7592531">.</span><span class="ident" id="7592532">Scan</span><span class="op" id="7592536">(</span><span class="op" id="7592537">&amp;</span><span class="ident" id="7592538">age</span><span class="op" id="7592541">,</span>&nbsp;<span class="op" id="7592543">&amp;</span><span class="ident" id="7592544">name</span><span class="op" id="7592548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7592551">if</span>&nbsp;<span class="ident" id="7592554">err</span>&nbsp;<span class="op" id="7592558">!=</span>&nbsp;<span class="ident" id="7592561">nil</span>&nbsp;<span class="op" id="7592565">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7592569">t</span><span class="op" id="7592570">.</span><span class="ident" id="7592571">Fatalf</span><span class="op" id="7592577">(</span><span class="string" id="7592578">&#34;age&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="7592601">,</span>&nbsp;<span class="ident" id="7592603">err</span><span class="op" id="7592606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7592609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7592612">if</span>&nbsp;<span class="ident" id="7592615">name</span>&nbsp;<span class="op" id="7592620">!=</span>&nbsp;<span class="string" id="7592623">&#34;Bob&#34;</span>&nbsp;<span class="op" id="7592629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7592633">t</span><span class="op" id="7592634">.</span><span class="ident" id="7592635">Errorf</span><span class="op" id="7592641">(</span><span class="string" id="7592642">&#34;expected&nbsp;name&nbsp;Bob,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7592669">,</span>&nbsp;<span class="ident" id="7592671">name</span><span class="op" id="7592675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7592678">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7592681">if</span>&nbsp;<span class="ident" id="7592684">age</span>&nbsp;<span class="op" id="7592688">!=</span>&nbsp;<span class="num" id="7592691">2</span>&nbsp;<span class="op" id="7592693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7592697">t</span><span class="op" id="7592698">.</span><span class="ident" id="7592699">Errorf</span><span class="op" id="7592705">(</span><span class="string" id="7592706">&#34;expected&nbsp;age&nbsp;2,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="7592730">,</span>&nbsp;<span class="ident" id="7592732">age</span><span class="op" id="7592735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7592738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7592742">err</span>&nbsp;<span class="op" id="7592746">=</span>&nbsp;<span class="ident" id="7592748">db</span><span class="op" id="7592750">.</span><span class="ident" id="7592751">QueryRow</span><span class="op" id="7592759">(</span><span class="string" id="7592760">&#34;SELECT|people|age,name|name=?&#34;</span><span class="op" id="7592791">,</span>&nbsp;<span class="string" id="7592793">&#34;Alice&#34;</span><span class="op" id="7592800">)</span><span class="op" id="7592801">.</span><span class="ident" id="7592802">Scan</span><span class="op" id="7592806">(</span><span class="op" id="7592807">&amp;</span><span class="ident" id="7592808">age</span><span class="op" id="7592811">,</span>&nbsp;<span class="op" id="7592813">&amp;</span><span class="ident" id="7592814">name</span><span class="op" id="7592818">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7592821">if</span>&nbsp;<span class="ident" id="7592824">err</span>&nbsp;<span class="op" id="7592828">!=</span>&nbsp;<span class="ident" id="7592831">nil</span>&nbsp;<span class="op" id="7592835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7592839">t</span><span class="op" id="7592840">.</span><span class="ident" id="7592841">Fatalf</span><span class="op" id="7592847">(</span><span class="string" id="7592848">&#34;name&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="7592872">,</span>&nbsp;<span class="ident" id="7592874">err</span><span class="op" id="7592877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7592880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7592883">if</span>&nbsp;<span class="ident" id="7592886">name</span>&nbsp;<span class="op" id="7592891">!=</span>&nbsp;<span class="string" id="7592894">&#34;Alice&#34;</span>&nbsp;<span class="op" id="7592902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7592906">t</span><span class="op" id="7592907">.</span><span class="ident" id="7592908">Errorf</span><span class="op" id="7592914">(</span><span class="string" id="7592915">&#34;expected&nbsp;name&nbsp;Alice,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7592944">,</span>&nbsp;<span class="ident" id="7592946">name</span><span class="op" id="7592950">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7592953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7592956">if</span>&nbsp;<span class="ident" id="7592959">age</span>&nbsp;<span class="op" id="7592963">!=</span>&nbsp;<span class="num" id="7592966">1</span>&nbsp;<span class="op" id="7592968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7592972">t</span><span class="op" id="7592973">.</span><span class="ident" id="7592974">Errorf</span><span class="op" id="7592980">(</span><span class="string" id="7592981">&#34;expected&nbsp;age&nbsp;1,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="7593005">,</span>&nbsp;<span class="ident" id="7593007">age</span><span class="op" id="7593010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7593013">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7593017">var</span>&nbsp;<span class="ident" id="7593021">photo</span>&nbsp;<span class="op" id="7593027">[</span><span class="op" id="7593028">]</span><span class="builtintype" id="7593029">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7593035">err</span>&nbsp;<span class="op" id="7593039">=</span>&nbsp;<span class="ident" id="7593041">db</span><span class="op" id="7593043">.</span><span class="ident" id="7593044">QueryRow</span><span class="op" id="7593052">(</span><span class="string" id="7593053">&#34;SELECT|people|photo|name=?&#34;</span><span class="op" id="7593081">,</span>&nbsp;<span class="string" id="7593083">&#34;Alice&#34;</span><span class="op" id="7593090">)</span><span class="op" id="7593091">.</span><span class="ident" id="7593092">Scan</span><span class="op" id="7593096">(</span><span class="op" id="7593097">&amp;</span><span class="ident" id="7593098">photo</span><span class="op" id="7593103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7593106">if</span>&nbsp;<span class="ident" id="7593109">err</span>&nbsp;<span class="op" id="7593113">!=</span>&nbsp;<span class="ident" id="7593116">nil</span>&nbsp;<span class="op" id="7593120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7593124">t</span><span class="op" id="7593125">.</span><span class="ident" id="7593126">Fatalf</span><span class="op" id="7593132">(</span><span class="string" id="7593133">&#34;photo&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="7593158">,</span>&nbsp;<span class="ident" id="7593160">err</span><span class="op" id="7593163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7593166">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7593169">want</span>&nbsp;<span class="op" id="7593174">:=</span>&nbsp;<span class="op" id="7593177">[</span><span class="op" id="7593178">]</span><span class="builtintype" id="7593179">byte</span><span class="op" id="7593183">(</span><span class="string" id="7593184">&#34;APHOTO&#34;</span><span class="op" id="7593192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7593195">if</span>&nbsp;<span class="op" id="7593198">!</span><span class="ident" id="7593199">reflect</span><span class="op" id="7593206">.</span><span class="ident" id="7593207">DeepEqual</span><span class="op" id="7593216">(</span><span class="ident" id="7593217">photo</span><span class="op" id="7593222">,</span>&nbsp;<span class="ident" id="7593224">want</span><span class="op" id="7593228">)</span>&nbsp;<span class="op" id="7593230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7593234">t</span><span class="op" id="7593235">.</span><span class="ident" id="7593236">Errorf</span><span class="op" id="7593242">(</span><span class="string" id="7593243">&#34;photo&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7593264">,</span>&nbsp;<span class="ident" id="7593266">photo</span><span class="op" id="7593271">,</span>&nbsp;<span class="ident" id="7593273">want</span><span class="op" id="7593277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7593280">}</span><br>
<span class="lineno"></span><span class="op" id="7593282">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="7593285">func</span>&nbsp;<span class="ident" id="7593290">TestStatementErrorAfterClose</span><span class="op" id="7593318">(</span><span class="ident" id="7593319">t</span>&nbsp;<span class="op" id="7593321">*</span><span class="ident" id="7593322">testing</span><span class="op" id="7593329">.</span><span class="ident" id="7593330">T</span><span class="op" id="7593331">)</span>&nbsp;<span class="op" id="7593333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7593336">db</span>&nbsp;<span class="op" id="7593339">:=</span>&nbsp;<span class="ident" id="7593342">newTestDB</span><span class="op" id="7593351">(</span><span class="ident" id="7593352">t</span><span class="op" id="7593353">,</span>&nbsp;<span class="string" id="7593355">&#34;people&#34;</span><span class="op" id="7593363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7593366">defer</span>&nbsp;<span class="ident" id="7593372">closeDB</span><span class="op" id="7593379">(</span><span class="ident" id="7593380">t</span><span class="op" id="7593381">,</span>&nbsp;<span class="ident" id="7593383">db</span><span class="op" id="7593385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7593388">stmt</span><span class="op" id="7593392">,</span>&nbsp;<span class="ident" id="7593394">err</span>&nbsp;<span class="op" id="7593398">:=</span>&nbsp;<span class="ident" id="7593401">db</span><span class="op" id="7593403">.</span><span class="ident" id="7593404">Prepare</span><span class="op" id="7593411">(</span><span class="string" id="7593412">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="7593438">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7593441">if</span>&nbsp;<span class="ident" id="7593444">err</span>&nbsp;<span class="op" id="7593448">!=</span>&nbsp;<span class="ident" id="7593451">nil</span>&nbsp;<span class="op" id="7593455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7593459">t</span><span class="op" id="7593460">.</span><span class="ident" id="7593461">Fatalf</span><span class="op" id="7593467">(</span><span class="string" id="7593468">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="7593481">,</span>&nbsp;<span class="ident" id="7593483">err</span><span class="op" id="7593486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7593489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7593492">err</span>&nbsp;<span class="op" id="7593496">=</span>&nbsp;<span class="ident" id="7593498">stmt</span><span class="op" id="7593502">.</span><span class="ident" id="7593503">Close</span><span class="op" id="7593508">(</span><span class="op" id="7593509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7593512">if</span>&nbsp;<span class="ident" id="7593515">err</span>&nbsp;<span class="op" id="7593519">!=</span>&nbsp;<span class="ident" id="7593522">nil</span>&nbsp;<span class="op" id="7593526">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7593530">t</span><span class="op" id="7593531">.</span><span class="ident" id="7593532">Fatalf</span><span class="op" id="7593538">(</span><span class="string" id="7593539">&#34;Close:&nbsp;%v&#34;</span><span class="op" id="7593550">,</span>&nbsp;<span class="ident" id="7593552">err</span><span class="op" id="7593555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7593558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7593561">var</span>&nbsp;<span class="ident" id="7593565">name</span>&nbsp;<span class="builtintype" id="7593570">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7593578">err</span>&nbsp;<span class="op" id="7593582">=</span>&nbsp;<span class="ident" id="7593584">stmt</span><span class="op" id="7593588">.</span><span class="ident" id="7593589">QueryRow</span><span class="op" id="7593597">(</span><span class="string" id="7593598">&#34;foo&#34;</span><span class="op" id="7593603">)</span><span class="op" id="7593604">.</span><span class="ident" id="7593605">Scan</span><span class="op" id="7593609">(</span><span class="op" id="7593610">&amp;</span><span class="ident" id="7593611">name</span><span class="op" id="7593615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7593618">if</span>&nbsp;<span class="ident" id="7593621">err</span>&nbsp;<span class="op" id="7593625">==</span>&nbsp;<span class="ident" id="7593628">nil</span>&nbsp;<span class="op" id="7593632">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7593636">t</span><span class="op" id="7593637">.</span><span class="ident" id="7593638">Errorf</span><span class="op" id="7593644">(</span><span class="string" id="7593645">&#34;expected&nbsp;error&nbsp;from&nbsp;QueryRow.Scan&nbsp;after&nbsp;Stmt.Close&#34;</span><span class="op" id="7593697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7593700">}</span><br>
<span class="lineno"></span><span class="op" id="7593702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7593705">func</span>&nbsp;<span class="ident" id="7593710">TestStatementQueryRow</span><span class="op" id="7593731">(</span><span class="ident" id="7593732">t</span>&nbsp;<span class="op" id="7593734">*</span><span class="ident" id="7593735">testing</span><span class="op" id="7593742">.</span><span class="ident" id="7593743">T</span><span class="op" id="7593744">)</span>&nbsp;<span class="op" id="7593746">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7593749">db</span>&nbsp;<span class="op" id="7593752">:=</span>&nbsp;<span class="ident" id="7593755">newTestDB</span><span class="op" id="7593764">(</span><span class="ident" id="7593765">t</span><span class="op" id="7593766">,</span>&nbsp;<span class="string" id="7593768">&#34;people&#34;</span><span class="op" id="7593776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7593779">defer</span>&nbsp;<span class="ident" id="7593785">closeDB</span><span class="op" id="7593792">(</span><span class="ident" id="7593793">t</span><span class="op" id="7593794">,</span>&nbsp;<span class="ident" id="7593796">db</span><span class="op" id="7593798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7593801">stmt</span><span class="op" id="7593805">,</span>&nbsp;<span class="ident" id="7593807">err</span>&nbsp;<span class="op" id="7593811">:=</span>&nbsp;<span class="ident" id="7593814">db</span><span class="op" id="7593816">.</span><span class="ident" id="7593817">Prepare</span><span class="op" id="7593824">(</span><span class="string" id="7593825">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="7593851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7593854">if</span>&nbsp;<span class="ident" id="7593857">err</span>&nbsp;<span class="op" id="7593861">!=</span>&nbsp;<span class="ident" id="7593864">nil</span>&nbsp;<span class="op" id="7593868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7593872">t</span><span class="op" id="7593873">.</span><span class="ident" id="7593874">Fatalf</span><span class="op" id="7593880">(</span><span class="string" id="7593881">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="7593894">,</span>&nbsp;<span class="ident" id="7593896">err</span><span class="op" id="7593899">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7593902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7593905">defer</span>&nbsp;<span class="ident" id="7593911">stmt</span><span class="op" id="7593915">.</span><span class="ident" id="7593916">Close</span><span class="op" id="7593921">(</span><span class="op" id="7593922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7593925">var</span>&nbsp;<span class="ident" id="7593929">age</span>&nbsp;<span class="builtintype" id="7593933">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7593938">for</span>&nbsp;<span class="ident" id="7593942">n</span><span class="op" id="7593943">,</span>&nbsp;<span class="ident" id="7593945">tt</span>&nbsp;<span class="op" id="7593948">:=</span>&nbsp;<span class="keyword" id="7593951">range</span>&nbsp;<span class="op" id="7593957">[</span><span class="op" id="7593958">]</span><span class="keyword" id="7593959">struct</span>&nbsp;<span class="op" id="7593966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7593970">name</span>&nbsp;<span class="builtintype" id="7593975">string</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7593984">want</span>&nbsp;<span class="builtintype" id="7593989">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7593994">}</span><span class="op" id="7593995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7593999">{</span><span class="string" id="7594000">&#34;Alice&#34;</span><span class="op" id="7594007">,</span>&nbsp;<span class="num" id="7594009">1</span><span class="op" id="7594010">}</span><span class="op" id="7594011">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7594015">{</span><span class="string" id="7594016">&#34;Bob&#34;</span><span class="op" id="7594021">,</span>&nbsp;<span class="num" id="7594023">2</span><span class="op" id="7594024">}</span><span class="op" id="7594025">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7594029">{</span><span class="string" id="7594030">&#34;Chris&#34;</span><span class="op" id="7594037">,</span>&nbsp;<span class="num" id="7594039">3</span><span class="op" id="7594040">}</span><span class="op" id="7594041">,</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7594044">}</span>&nbsp;<span class="op" id="7594046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7594050">if</span>&nbsp;<span class="ident" id="7594053">err</span>&nbsp;<span class="op" id="7594057">:=</span>&nbsp;<span class="ident" id="7594060">stmt</span><span class="op" id="7594064">.</span><span class="ident" id="7594065">QueryRow</span><span class="op" id="7594073">(</span><span class="ident" id="7594074">tt</span><span class="op" id="7594076">.</span><span class="ident" id="7594077">name</span><span class="op" id="7594081">)</span><span class="op" id="7594082">.</span><span class="ident" id="7594083">Scan</span><span class="op" id="7594087">(</span><span class="op" id="7594088">&amp;</span><span class="ident" id="7594089">age</span><span class="op" id="7594092">)</span><span class="op" id="7594093">;</span>&nbsp;<span class="ident" id="7594095">err</span>&nbsp;<span class="op" id="7594099">!=</span>&nbsp;<span class="ident" id="7594102">nil</span>&nbsp;<span class="op" id="7594106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7594111">t</span><span class="op" id="7594112">.</span><span class="ident" id="7594113">Errorf</span><span class="op" id="7594119">(</span><span class="string" id="7594120">&#34;%d:&nbsp;on&nbsp;%q,&nbsp;QueryRow/Scan:&nbsp;%v&#34;</span><span class="op" id="7594150">,</span>&nbsp;<span class="ident" id="7594152">n</span><span class="op" id="7594153">,</span>&nbsp;<span class="ident" id="7594155">tt</span><span class="op" id="7594157">.</span><span class="ident" id="7594158">name</span><span class="op" id="7594162">,</span>&nbsp;<span class="ident" id="7594164">err</span><span class="op" id="7594167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7594171">}</span>&nbsp;<span class="keyword" id="7594173">else</span>&nbsp;<span class="keyword" id="7594178">if</span>&nbsp;<span class="ident" id="7594181">age</span>&nbsp;<span class="op" id="7594185">!=</span>&nbsp;<span class="ident" id="7594188">tt</span><span class="op" id="7594190">.</span><span class="ident" id="7594191">want</span>&nbsp;<span class="op" id="7594196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7594201">t</span><span class="op" id="7594202">.</span><span class="ident" id="7594203">Errorf</span><span class="op" id="7594209">(</span><span class="string" id="7594210">&#34;%d:&nbsp;age=%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7594231">,</span>&nbsp;<span class="ident" id="7594233">n</span><span class="op" id="7594234">,</span>&nbsp;<span class="ident" id="7594236">age</span><span class="op" id="7594239">,</span>&nbsp;<span class="ident" id="7594241">tt</span><span class="op" id="7594243">.</span><span class="ident" id="7594244">want</span><span class="op" id="7594248">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7594252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7594255">}</span><br>
<span class="lineno"></span><span class="op" id="7594257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7594260">//&nbsp;golang.org/issue/3734</span><br>
<span class="lineno">360</span><span class="keyword" id="7594285">func</span>&nbsp;<span class="ident" id="7594290">TestStatementQueryRowConcurrent</span><span class="op" id="7594321">(</span><span class="ident" id="7594322">t</span>&nbsp;<span class="op" id="7594324">*</span><span class="ident" id="7594325">testing</span><span class="op" id="7594332">.</span><span class="ident" id="7594333">T</span><span class="op" id="7594334">)</span>&nbsp;<span class="op" id="7594336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7594339">db</span>&nbsp;<span class="op" id="7594342">:=</span>&nbsp;<span class="ident" id="7594345">newTestDB</span><span class="op" id="7594354">(</span><span class="ident" id="7594355">t</span><span class="op" id="7594356">,</span>&nbsp;<span class="string" id="7594358">&#34;people&#34;</span><span class="op" id="7594366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7594369">defer</span>&nbsp;<span class="ident" id="7594375">closeDB</span><span class="op" id="7594382">(</span><span class="ident" id="7594383">t</span><span class="op" id="7594384">,</span>&nbsp;<span class="ident" id="7594386">db</span><span class="op" id="7594388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7594391">stmt</span><span class="op" id="7594395">,</span>&nbsp;<span class="ident" id="7594397">err</span>&nbsp;<span class="op" id="7594401">:=</span>&nbsp;<span class="ident" id="7594404">db</span><span class="op" id="7594406">.</span><span class="ident" id="7594407">Prepare</span><span class="op" id="7594414">(</span><span class="string" id="7594415">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="7594441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7594444">if</span>&nbsp;<span class="ident" id="7594447">err</span>&nbsp;<span class="op" id="7594451">!=</span>&nbsp;<span class="ident" id="7594454">nil</span>&nbsp;<span class="op" id="7594458">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7594462">t</span><span class="op" id="7594463">.</span><span class="ident" id="7594464">Fatalf</span><span class="op" id="7594470">(</span><span class="string" id="7594471">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="7594484">,</span>&nbsp;<span class="ident" id="7594486">err</span><span class="op" id="7594489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7594492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7594495">defer</span>&nbsp;<span class="ident" id="7594501">stmt</span><span class="op" id="7594505">.</span><span class="ident" id="7594506">Close</span><span class="op" id="7594511">(</span><span class="op" id="7594512">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7594516">const</span>&nbsp;<span class="ident" id="7594522">n</span>&nbsp;<span class="op" id="7594524">=</span>&nbsp;<span class="num" id="7594526">10</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7594530">ch</span>&nbsp;<span class="op" id="7594533">:=</span>&nbsp;<span class="builtinfunc" id="7594536">make</span><span class="op" id="7594540">(</span><span class="keyword" id="7594541">chan</span>&nbsp;<span class="builtintype" id="7594546">error</span><span class="op" id="7594551">,</span>&nbsp;<span class="ident" id="7594553">n</span><span class="op" id="7594554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7594557">for</span>&nbsp;<span class="ident" id="7594561">i</span>&nbsp;<span class="op" id="7594563">:=</span>&nbsp;<span class="num" id="7594566">0</span><span class="op" id="7594567">;</span>&nbsp;<span class="ident" id="7594569">i</span>&nbsp;<span class="op" id="7594571">&lt;</span>&nbsp;<span class="ident" id="7594573">n</span><span class="op" id="7594574">;</span>&nbsp;<span class="ident" id="7594576">i</span><span class="op" id="7594577">++</span>&nbsp;<span class="op" id="7594580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7594584">go</span>&nbsp;<span class="keyword" id="7594587">func</span><span class="op" id="7594591">(</span><span class="op" id="7594592">)</span>&nbsp;<span class="op" id="7594594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7594599">var</span>&nbsp;<span class="ident" id="7594603">age</span>&nbsp;<span class="builtintype" id="7594607">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7594614">err</span>&nbsp;<span class="op" id="7594618">:=</span>&nbsp;<span class="ident" id="7594621">stmt</span><span class="op" id="7594625">.</span><span class="ident" id="7594626">QueryRow</span><span class="op" id="7594634">(</span><span class="string" id="7594635">&#34;Alice&#34;</span><span class="op" id="7594642">)</span><span class="op" id="7594643">.</span><span class="ident" id="7594644">Scan</span><span class="op" id="7594648">(</span><span class="op" id="7594649">&amp;</span><span class="ident" id="7594650">age</span><span class="op" id="7594653">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7594658">if</span>&nbsp;<span class="ident" id="7594661">err</span>&nbsp;<span class="op" id="7594665">==</span>&nbsp;<span class="ident" id="7594668">nil</span>&nbsp;<span class="op" id="7594672">&amp;&amp;</span>&nbsp;<span class="ident" id="7594675">age</span>&nbsp;<span class="op" id="7594679">!=</span>&nbsp;<span class="num" id="7594682">1</span>&nbsp;<span class="op" id="7594684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7594690">err</span>&nbsp;<span class="op" id="7594694">=</span>&nbsp;<span class="ident" id="7594696">fmt</span><span class="op" id="7594699">.</span><span class="ident" id="7594700">Errorf</span><span class="op" id="7594706">(</span><span class="string" id="7594707">&#34;unexpected&nbsp;age&nbsp;%d&#34;</span><span class="op" id="7594726">,</span>&nbsp;<span class="ident" id="7594728">age</span><span class="op" id="7594731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7594736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7594741">ch</span>&nbsp;<span class="op" id="7594744">&lt;-</span>&nbsp;<span class="ident" id="7594747">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7594753">}</span><span class="op" id="7594754">(</span><span class="op" id="7594755">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7594758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7594761">for</span>&nbsp;<span class="ident" id="7594765">i</span>&nbsp;<span class="op" id="7594767">:=</span>&nbsp;<span class="num" id="7594770">0</span><span class="op" id="7594771">;</span>&nbsp;<span class="ident" id="7594773">i</span>&nbsp;<span class="op" id="7594775">&lt;</span>&nbsp;<span class="ident" id="7594777">n</span><span class="op" id="7594778">;</span>&nbsp;<span class="ident" id="7594780">i</span><span class="op" id="7594781">++</span>&nbsp;<span class="op" id="7594784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7594788">if</span>&nbsp;<span class="ident" id="7594791">err</span>&nbsp;<span class="op" id="7594795">:=</span>&nbsp;<span class="op" id="7594798">&lt;-</span><span class="ident" id="7594800">ch</span><span class="op" id="7594802">;</span>&nbsp;<span class="ident" id="7594804">err</span>&nbsp;<span class="op" id="7594808">!=</span>&nbsp;<span class="ident" id="7594811">nil</span>&nbsp;<span class="op" id="7594815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7594820">t</span><span class="op" id="7594821">.</span><span class="ident" id="7594822">Error</span><span class="op" id="7594827">(</span><span class="ident" id="7594828">err</span><span class="op" id="7594831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7594835">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7594838">}</span><br>
<span class="lineno"></span><span class="op" id="7594840">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7594843">//&nbsp;just&nbsp;a&nbsp;test&nbsp;of&nbsp;fakedb&nbsp;itself</span><br>
<span class="lineno"></span><span class="keyword" id="7594875">func</span>&nbsp;<span class="ident" id="7594880">TestBogusPreboundParameters</span><span class="op" id="7594907">(</span><span class="ident" id="7594908">t</span>&nbsp;<span class="op" id="7594910">*</span><span class="ident" id="7594911">testing</span><span class="op" id="7594918">.</span><span class="ident" id="7594919">T</span><span class="op" id="7594920">)</span>&nbsp;<span class="op" id="7594922">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7594925">db</span>&nbsp;<span class="op" id="7594928">:=</span>&nbsp;<span class="ident" id="7594931">newTestDB</span><span class="op" id="7594940">(</span><span class="ident" id="7594941">t</span><span class="op" id="7594942">,</span>&nbsp;<span class="string" id="7594944">&#34;foo&#34;</span><span class="op" id="7594949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7594952">defer</span>&nbsp;<span class="ident" id="7594958">closeDB</span><span class="op" id="7594965">(</span><span class="ident" id="7594966">t</span><span class="op" id="7594967">,</span>&nbsp;<span class="ident" id="7594969">db</span><span class="op" id="7594971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7594974">exec</span><span class="op" id="7594978">(</span><span class="ident" id="7594979">t</span><span class="op" id="7594980">,</span>&nbsp;<span class="ident" id="7594982">db</span><span class="op" id="7594984">,</span>&nbsp;<span class="string" id="7594986">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7595029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7595032">_</span><span class="op" id="7595033">,</span>&nbsp;<span class="ident" id="7595035">err</span>&nbsp;<span class="op" id="7595039">:=</span>&nbsp;<span class="ident" id="7595042">db</span><span class="op" id="7595044">.</span><span class="ident" id="7595045">Prepare</span><span class="op" id="7595052">(</span><span class="string" id="7595053">&#34;INSERT|t1|name=?,age=bogusconversion&#34;</span><span class="op" id="7595091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7595094">if</span>&nbsp;<span class="ident" id="7595097">err</span>&nbsp;<span class="op" id="7595101">==</span>&nbsp;<span class="ident" id="7595104">nil</span>&nbsp;<span class="op" id="7595108">{</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7595112">t</span><span class="op" id="7595113">.</span><span class="ident" id="7595114">Fatalf</span><span class="op" id="7595120">(</span><span class="string" id="7595121">&#34;expected&nbsp;error&#34;</span><span class="op" id="7595137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7595140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7595143">if</span>&nbsp;<span class="ident" id="7595146">err</span><span class="op" id="7595149">.</span><span class="ident" id="7595150">Error</span><span class="op" id="7595155">(</span><span class="op" id="7595156">)</span>&nbsp;<span class="op" id="7595158">!=</span>&nbsp;<span class="string" id="7595161">`fakedb:&nbsp;invalid&nbsp;conversion&nbsp;to&nbsp;int32&nbsp;from&nbsp;&#34;bogusconversion&#34;`</span>&nbsp;<span class="op" id="7595222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7595226">t</span><span class="op" id="7595227">.</span><span class="ident" id="7595228">Errorf</span><span class="op" id="7595234">(</span><span class="string" id="7595235">&#34;unexpected&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="7595257">,</span>&nbsp;<span class="ident" id="7595259">err</span><span class="op" id="7595262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7595265">}</span><br>
<span class="lineno">400</span><span class="op" id="7595267">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7595270">func</span>&nbsp;<span class="ident" id="7595275">TestExec</span><span class="op" id="7595283">(</span><span class="ident" id="7595284">t</span>&nbsp;<span class="op" id="7595286">*</span><span class="ident" id="7595287">testing</span><span class="op" id="7595294">.</span><span class="ident" id="7595295">T</span><span class="op" id="7595296">)</span>&nbsp;<span class="op" id="7595298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7595301">db</span>&nbsp;<span class="op" id="7595304">:=</span>&nbsp;<span class="ident" id="7595307">newTestDB</span><span class="op" id="7595316">(</span><span class="ident" id="7595317">t</span><span class="op" id="7595318">,</span>&nbsp;<span class="string" id="7595320">&#34;foo&#34;</span><span class="op" id="7595325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7595328">defer</span>&nbsp;<span class="ident" id="7595334">closeDB</span><span class="op" id="7595341">(</span><span class="ident" id="7595342">t</span><span class="op" id="7595343">,</span>&nbsp;<span class="ident" id="7595345">db</span><span class="op" id="7595347">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7595350">exec</span><span class="op" id="7595354">(</span><span class="ident" id="7595355">t</span><span class="op" id="7595356">,</span>&nbsp;<span class="ident" id="7595358">db</span><span class="op" id="7595360">,</span>&nbsp;<span class="string" id="7595362">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7595405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7595408">stmt</span><span class="op" id="7595412">,</span>&nbsp;<span class="ident" id="7595414">err</span>&nbsp;<span class="op" id="7595418">:=</span>&nbsp;<span class="ident" id="7595421">db</span><span class="op" id="7595423">.</span><span class="ident" id="7595424">Prepare</span><span class="op" id="7595431">(</span><span class="string" id="7595432">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="7595456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7595459">if</span>&nbsp;<span class="ident" id="7595462">err</span>&nbsp;<span class="op" id="7595466">!=</span>&nbsp;<span class="ident" id="7595469">nil</span>&nbsp;<span class="op" id="7595473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7595477">t</span><span class="op" id="7595478">.</span><span class="ident" id="7595479">Errorf</span><span class="op" id="7595485">(</span><span class="string" id="7595486">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="7595506">,</span>&nbsp;<span class="ident" id="7595508">stmt</span><span class="op" id="7595512">,</span>&nbsp;<span class="ident" id="7595514">err</span><span class="op" id="7595517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7595520">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7595523">defer</span>&nbsp;<span class="ident" id="7595529">stmt</span><span class="op" id="7595533">.</span><span class="ident" id="7595534">Close</span><span class="op" id="7595539">(</span><span class="op" id="7595540">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7595544">type</span>&nbsp;<span class="ident" id="7595549">execTest</span>&nbsp;<span class="keyword" id="7595558">struct</span>&nbsp;<span class="op" id="7595565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7595569">args</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7595577">[</span><span class="op" id="7595578">]</span><span class="keyword" id="7595579">interface</span><span class="op" id="7595588">{</span><span class="op" id="7595589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7595593">wantErr</span>&nbsp;<span class="builtintype" id="7595601">string</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7595609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7595612">execTests</span>&nbsp;<span class="op" id="7595622">:=</span>&nbsp;<span class="op" id="7595625">[</span><span class="op" id="7595626">]</span><span class="ident" id="7595627">execTest</span><span class="op" id="7595635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7595639">//&nbsp;Okay:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7595650">{</span><span class="op" id="7595651">[</span><span class="op" id="7595652">]</span><span class="keyword" id="7595653">interface</span><span class="op" id="7595662">{</span><span class="op" id="7595663">}</span><span class="op" id="7595664">{</span><span class="string" id="7595665">&#34;Brad&#34;</span><span class="op" id="7595671">,</span>&nbsp;<span class="num" id="7595673">31</span><span class="op" id="7595675">}</span><span class="op" id="7595676">,</span>&nbsp;<span class="string" id="7595678">&#34;&#34;</span><span class="op" id="7595680">}</span><span class="op" id="7595681">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7595685">{</span><span class="op" id="7595686">[</span><span class="op" id="7595687">]</span><span class="keyword" id="7595688">interface</span><span class="op" id="7595697">{</span><span class="op" id="7595698">}</span><span class="op" id="7595699">{</span><span class="string" id="7595700">&#34;Brad&#34;</span><span class="op" id="7595706">,</span>&nbsp;<span class="ident" id="7595708">int64</span><span class="op" id="7595713">(</span><span class="num" id="7595714">31</span><span class="op" id="7595716">)</span><span class="op" id="7595717">}</span><span class="op" id="7595718">,</span>&nbsp;<span class="string" id="7595720">&#34;&#34;</span><span class="op" id="7595722">}</span><span class="op" id="7595723">,</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7595727">{</span><span class="op" id="7595728">[</span><span class="op" id="7595729">]</span><span class="keyword" id="7595730">interface</span><span class="op" id="7595739">{</span><span class="op" id="7595740">}</span><span class="op" id="7595741">{</span><span class="string" id="7595742">&#34;Bob&#34;</span><span class="op" id="7595747">,</span>&nbsp;<span class="string" id="7595749">&#34;32&#34;</span><span class="op" id="7595753">}</span><span class="op" id="7595754">,</span>&nbsp;<span class="string" id="7595756">&#34;&#34;</span><span class="op" id="7595758">}</span><span class="op" id="7595759">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7595763">{</span><span class="op" id="7595764">[</span><span class="op" id="7595765">]</span><span class="keyword" id="7595766">interface</span><span class="op" id="7595775">{</span><span class="op" id="7595776">}</span><span class="op" id="7595777">{</span><span class="num" id="7595778">7</span><span class="op" id="7595779">,</span>&nbsp;<span class="num" id="7595781">9</span><span class="op" id="7595782">}</span><span class="op" id="7595783">,</span>&nbsp;<span class="string" id="7595785">&#34;&#34;</span><span class="op" id="7595787">}</span><span class="op" id="7595788">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7595793">//&nbsp;Invalid&nbsp;conversions:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7595819">{</span><span class="op" id="7595820">[</span><span class="op" id="7595821">]</span><span class="keyword" id="7595822">interface</span><span class="op" id="7595831">{</span><span class="op" id="7595832">}</span><span class="op" id="7595833">{</span><span class="string" id="7595834">&#34;Brad&#34;</span><span class="op" id="7595840">,</span>&nbsp;<span class="ident" id="7595842">int64</span><span class="op" id="7595847">(</span><span class="num" id="7595848">0xFFFFFFFF</span><span class="op" id="7595858">)</span><span class="op" id="7595859">}</span><span class="op" id="7595860">,</span>&nbsp;<span class="string" id="7595862">&#34;sql:&nbsp;converting&nbsp;argument&nbsp;#1&#39;s&nbsp;type:&nbsp;sql/driver:&nbsp;value&nbsp;4294967295&nbsp;overflows&nbsp;int32&#34;</span><span class="op" id="7595944">}</span><span class="op" id="7595945">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7595949">{</span><span class="op" id="7595950">[</span><span class="op" id="7595951">]</span><span class="keyword" id="7595952">interface</span><span class="op" id="7595961">{</span><span class="op" id="7595962">}</span><span class="op" id="7595963">{</span><span class="string" id="7595964">&#34;Brad&#34;</span><span class="op" id="7595970">,</span>&nbsp;<span class="string" id="7595972">&#34;strconv&nbsp;fail&#34;</span><span class="op" id="7595986">}</span><span class="op" id="7595987">,</span>&nbsp;<span class="string" id="7595989">&#34;sql:&nbsp;converting&nbsp;argument&nbsp;#1&#39;s&nbsp;type:&nbsp;sql/driver:&nbsp;value&nbsp;\&#34;strconv&nbsp;fail\&#34;&nbsp;can&#39;t&nbsp;be&nbsp;converted&nbsp;to&nbsp;int32&#34;</span><span class="op" id="7596089">}</span><span class="op" id="7596090">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7596095">//&nbsp;Wrong&nbsp;number&nbsp;of&nbsp;args:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7596122">{</span><span class="op" id="7596123">[</span><span class="op" id="7596124">]</span><span class="keyword" id="7596125">interface</span><span class="op" id="7596134">{</span><span class="op" id="7596135">}</span><span class="op" id="7596136">{</span><span class="op" id="7596137">}</span><span class="op" id="7596138">,</span>&nbsp;<span class="string" id="7596140">&#34;sql:&nbsp;expected&nbsp;2&nbsp;arguments,&nbsp;got&nbsp;0&#34;</span><span class="op" id="7596174">}</span><span class="op" id="7596175">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7596179">{</span><span class="op" id="7596180">[</span><span class="op" id="7596181">]</span><span class="keyword" id="7596182">interface</span><span class="op" id="7596191">{</span><span class="op" id="7596192">}</span><span class="op" id="7596193">{</span><span class="num" id="7596194">1</span><span class="op" id="7596195">,</span>&nbsp;<span class="num" id="7596197">2</span><span class="op" id="7596198">,</span>&nbsp;<span class="num" id="7596200">3</span><span class="op" id="7596201">}</span><span class="op" id="7596202">,</span>&nbsp;<span class="string" id="7596204">&#34;sql:&nbsp;expected&nbsp;2&nbsp;arguments,&nbsp;got&nbsp;3&#34;</span><span class="op" id="7596238">}</span><span class="op" id="7596239">,</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7596242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7596245">for</span>&nbsp;<span class="ident" id="7596249">n</span><span class="op" id="7596250">,</span>&nbsp;<span class="ident" id="7596252">et</span>&nbsp;<span class="op" id="7596255">:=</span>&nbsp;<span class="keyword" id="7596258">range</span>&nbsp;<span class="ident" id="7596264">execTests</span>&nbsp;<span class="op" id="7596274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7596278">_</span><span class="op" id="7596279">,</span>&nbsp;<span class="ident" id="7596281">err</span>&nbsp;<span class="op" id="7596285">:=</span>&nbsp;<span class="ident" id="7596288">stmt</span><span class="op" id="7596292">.</span><span class="ident" id="7596293">Exec</span><span class="op" id="7596297">(</span><span class="ident" id="7596298">et</span><span class="op" id="7596300">.</span><span class="ident" id="7596301">args</span><span class="op" id="7596305">...</span><span class="op" id="7596308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7596312">errStr</span>&nbsp;<span class="op" id="7596319">:=</span>&nbsp;<span class="string" id="7596322">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7596327">if</span>&nbsp;<span class="ident" id="7596330">err</span>&nbsp;<span class="op" id="7596334">!=</span>&nbsp;<span class="ident" id="7596337">nil</span>&nbsp;<span class="op" id="7596341">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7596346">errStr</span>&nbsp;<span class="op" id="7596353">=</span>&nbsp;<span class="ident" id="7596355">err</span><span class="op" id="7596358">.</span><span class="ident" id="7596359">Error</span><span class="op" id="7596364">(</span><span class="op" id="7596365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7596369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7596373">if</span>&nbsp;<span class="ident" id="7596376">errStr</span>&nbsp;<span class="op" id="7596383">!=</span>&nbsp;<span class="ident" id="7596386">et</span><span class="op" id="7596388">.</span><span class="ident" id="7596389">wantErr</span>&nbsp;<span class="op" id="7596397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7596402">t</span><span class="op" id="7596403">.</span><span class="ident" id="7596404">Errorf</span><span class="op" id="7596410">(</span><span class="string" id="7596411">&#34;stmt.Execute&nbsp;#%d:&nbsp;for&nbsp;%v,&nbsp;got&nbsp;error&nbsp;%q,&nbsp;want&nbsp;error&nbsp;%q&#34;</span><span class="op" id="7596466">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7596472">n</span><span class="op" id="7596473">,</span>&nbsp;<span class="ident" id="7596475">et</span><span class="op" id="7596477">.</span><span class="ident" id="7596478">args</span><span class="op" id="7596482">,</span>&nbsp;<span class="ident" id="7596484">errStr</span><span class="op" id="7596490">,</span>&nbsp;<span class="ident" id="7596492">et</span><span class="op" id="7596494">.</span><span class="ident" id="7596495">wantErr</span><span class="op" id="7596502">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7596506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7596509">}</span><br>
<span class="lineno"></span><span class="op" id="7596511">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7596514">func</span>&nbsp;<span class="ident" id="7596519">TestTxPrepare</span><span class="op" id="7596532">(</span><span class="ident" id="7596533">t</span>&nbsp;<span class="op" id="7596535">*</span><span class="ident" id="7596536">testing</span><span class="op" id="7596543">.</span><span class="ident" id="7596544">T</span><span class="op" id="7596545">)</span>&nbsp;<span class="op" id="7596547">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7596550">db</span>&nbsp;<span class="op" id="7596553">:=</span>&nbsp;<span class="ident" id="7596556">newTestDB</span><span class="op" id="7596565">(</span><span class="ident" id="7596566">t</span><span class="op" id="7596567">,</span>&nbsp;<span class="string" id="7596569">&#34;&#34;</span><span class="op" id="7596571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7596574">defer</span>&nbsp;<span class="ident" id="7596580">closeDB</span><span class="op" id="7596587">(</span><span class="ident" id="7596588">t</span><span class="op" id="7596589">,</span>&nbsp;<span class="ident" id="7596591">db</span><span class="op" id="7596593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7596596">exec</span><span class="op" id="7596600">(</span><span class="ident" id="7596601">t</span><span class="op" id="7596602">,</span>&nbsp;<span class="ident" id="7596604">db</span><span class="op" id="7596606">,</span>&nbsp;<span class="string" id="7596608">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7596651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7596654">tx</span><span class="op" id="7596656">,</span>&nbsp;<span class="ident" id="7596658">err</span>&nbsp;<span class="op" id="7596662">:=</span>&nbsp;<span class="ident" id="7596665">db</span><span class="op" id="7596667">.</span><span class="ident" id="7596668">Begin</span><span class="op" id="7596673">(</span><span class="op" id="7596674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7596677">if</span>&nbsp;<span class="ident" id="7596680">err</span>&nbsp;<span class="op" id="7596684">!=</span>&nbsp;<span class="ident" id="7596687">nil</span>&nbsp;<span class="op" id="7596691">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7596695">t</span><span class="op" id="7596696">.</span><span class="ident" id="7596697">Fatalf</span><span class="op" id="7596703">(</span><span class="string" id="7596704">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7596716">,</span>&nbsp;<span class="ident" id="7596718">err</span><span class="op" id="7596721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7596724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7596727">stmt</span><span class="op" id="7596731">,</span>&nbsp;<span class="ident" id="7596733">err</span>&nbsp;<span class="op" id="7596737">:=</span>&nbsp;<span class="ident" id="7596740">tx</span><span class="op" id="7596742">.</span><span class="ident" id="7596743">Prepare</span><span class="op" id="7596750">(</span><span class="string" id="7596751">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="7596775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7596778">if</span>&nbsp;<span class="ident" id="7596781">err</span>&nbsp;<span class="op" id="7596785">!=</span>&nbsp;<span class="ident" id="7596788">nil</span>&nbsp;<span class="op" id="7596792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7596796">t</span><span class="op" id="7596797">.</span><span class="ident" id="7596798">Fatalf</span><span class="op" id="7596804">(</span><span class="string" id="7596805">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="7596825">,</span>&nbsp;<span class="ident" id="7596827">stmt</span><span class="op" id="7596831">,</span>&nbsp;<span class="ident" id="7596833">err</span><span class="op" id="7596836">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7596839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7596842">defer</span>&nbsp;<span class="ident" id="7596848">stmt</span><span class="op" id="7596852">.</span><span class="ident" id="7596853">Close</span><span class="op" id="7596858">(</span><span class="op" id="7596859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7596862">_</span><span class="op" id="7596863">,</span>&nbsp;<span class="ident" id="7596865">err</span>&nbsp;<span class="op" id="7596869">=</span>&nbsp;<span class="ident" id="7596871">stmt</span><span class="op" id="7596875">.</span><span class="ident" id="7596876">Exec</span><span class="op" id="7596880">(</span><span class="string" id="7596881">&#34;Bobby&#34;</span><span class="op" id="7596888">,</span>&nbsp;<span class="num" id="7596890">7</span><span class="op" id="7596891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7596894">if</span>&nbsp;<span class="ident" id="7596897">err</span>&nbsp;<span class="op" id="7596901">!=</span>&nbsp;<span class="ident" id="7596904">nil</span>&nbsp;<span class="op" id="7596908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7596912">t</span><span class="op" id="7596913">.</span><span class="ident" id="7596914">Fatalf</span><span class="op" id="7596920">(</span><span class="string" id="7596921">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7596932">,</span>&nbsp;<span class="ident" id="7596934">err</span><span class="op" id="7596937">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7596940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7596943">err</span>&nbsp;<span class="op" id="7596947">=</span>&nbsp;<span class="ident" id="7596949">tx</span><span class="op" id="7596951">.</span><span class="ident" id="7596952">Commit</span><span class="op" id="7596958">(</span><span class="op" id="7596959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7596962">if</span>&nbsp;<span class="ident" id="7596965">err</span>&nbsp;<span class="op" id="7596969">!=</span>&nbsp;<span class="ident" id="7596972">nil</span>&nbsp;<span class="op" id="7596976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7596980">t</span><span class="op" id="7596981">.</span><span class="ident" id="7596982">Fatalf</span><span class="op" id="7596988">(</span><span class="string" id="7596989">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7597002">,</span>&nbsp;<span class="ident" id="7597004">err</span><span class="op" id="7597007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7597010">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7597013">//&nbsp;Commit()&nbsp;should&nbsp;have&nbsp;closed&nbsp;the&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7597059">if</span>&nbsp;<span class="op" id="7597062">!</span><span class="ident" id="7597063">stmt</span><span class="op" id="7597067">.</span><span class="ident" id="7597068">closed</span>&nbsp;<span class="op" id="7597075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7597079">t</span><span class="op" id="7597080">.</span><span class="ident" id="7597081">Fatal</span><span class="op" id="7597086">(</span><span class="string" id="7597087">&#34;Stmt&nbsp;not&nbsp;closed&nbsp;after&nbsp;Commit&#34;</span><span class="op" id="7597117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7597120">}</span><br>
<span class="lineno"></span><span class="op" id="7597122">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span><span class="keyword" id="7597125">func</span>&nbsp;<span class="ident" id="7597130">TestTxStmt</span><span class="op" id="7597140">(</span><span class="ident" id="7597141">t</span>&nbsp;<span class="op" id="7597143">*</span><span class="ident" id="7597144">testing</span><span class="op" id="7597151">.</span><span class="ident" id="7597152">T</span><span class="op" id="7597153">)</span>&nbsp;<span class="op" id="7597155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7597158">db</span>&nbsp;<span class="op" id="7597161">:=</span>&nbsp;<span class="ident" id="7597164">newTestDB</span><span class="op" id="7597173">(</span><span class="ident" id="7597174">t</span><span class="op" id="7597175">,</span>&nbsp;<span class="string" id="7597177">&#34;&#34;</span><span class="op" id="7597179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7597182">defer</span>&nbsp;<span class="ident" id="7597188">closeDB</span><span class="op" id="7597195">(</span><span class="ident" id="7597196">t</span><span class="op" id="7597197">,</span>&nbsp;<span class="ident" id="7597199">db</span><span class="op" id="7597201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7597204">exec</span><span class="op" id="7597208">(</span><span class="ident" id="7597209">t</span><span class="op" id="7597210">,</span>&nbsp;<span class="ident" id="7597212">db</span><span class="op" id="7597214">,</span>&nbsp;<span class="string" id="7597216">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7597259">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7597262">stmt</span><span class="op" id="7597266">,</span>&nbsp;<span class="ident" id="7597268">err</span>&nbsp;<span class="op" id="7597272">:=</span>&nbsp;<span class="ident" id="7597275">db</span><span class="op" id="7597277">.</span><span class="ident" id="7597278">Prepare</span><span class="op" id="7597285">(</span><span class="string" id="7597286">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="7597310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7597313">if</span>&nbsp;<span class="ident" id="7597316">err</span>&nbsp;<span class="op" id="7597320">!=</span>&nbsp;<span class="ident" id="7597323">nil</span>&nbsp;<span class="op" id="7597327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7597331">t</span><span class="op" id="7597332">.</span><span class="ident" id="7597333">Fatalf</span><span class="op" id="7597339">(</span><span class="string" id="7597340">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="7597360">,</span>&nbsp;<span class="ident" id="7597362">stmt</span><span class="op" id="7597366">,</span>&nbsp;<span class="ident" id="7597368">err</span><span class="op" id="7597371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7597374">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7597377">defer</span>&nbsp;<span class="ident" id="7597383">stmt</span><span class="op" id="7597387">.</span><span class="ident" id="7597388">Close</span><span class="op" id="7597393">(</span><span class="op" id="7597394">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7597397">tx</span><span class="op" id="7597399">,</span>&nbsp;<span class="ident" id="7597401">err</span>&nbsp;<span class="op" id="7597405">:=</span>&nbsp;<span class="ident" id="7597408">db</span><span class="op" id="7597410">.</span><span class="ident" id="7597411">Begin</span><span class="op" id="7597416">(</span><span class="op" id="7597417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7597420">if</span>&nbsp;<span class="ident" id="7597423">err</span>&nbsp;<span class="op" id="7597427">!=</span>&nbsp;<span class="ident" id="7597430">nil</span>&nbsp;<span class="op" id="7597434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7597438">t</span><span class="op" id="7597439">.</span><span class="ident" id="7597440">Fatalf</span><span class="op" id="7597446">(</span><span class="string" id="7597447">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7597459">,</span>&nbsp;<span class="ident" id="7597461">err</span><span class="op" id="7597464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7597467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7597470">txs</span>&nbsp;<span class="op" id="7597474">:=</span>&nbsp;<span class="ident" id="7597477">tx</span><span class="op" id="7597479">.</span><span class="ident" id="7597480">Stmt</span><span class="op" id="7597484">(</span><span class="ident" id="7597485">stmt</span><span class="op" id="7597489">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7597492">defer</span>&nbsp;<span class="ident" id="7597498">txs</span><span class="op" id="7597501">.</span><span class="ident" id="7597502">Close</span><span class="op" id="7597507">(</span><span class="op" id="7597508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7597511">_</span><span class="op" id="7597512">,</span>&nbsp;<span class="ident" id="7597514">err</span>&nbsp;<span class="op" id="7597518">=</span>&nbsp;<span class="ident" id="7597520">txs</span><span class="op" id="7597523">.</span><span class="ident" id="7597524">Exec</span><span class="op" id="7597528">(</span><span class="string" id="7597529">&#34;Bobby&#34;</span><span class="op" id="7597536">,</span>&nbsp;<span class="num" id="7597538">7</span><span class="op" id="7597539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7597542">if</span>&nbsp;<span class="ident" id="7597545">err</span>&nbsp;<span class="op" id="7597549">!=</span>&nbsp;<span class="ident" id="7597552">nil</span>&nbsp;<span class="op" id="7597556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7597560">t</span><span class="op" id="7597561">.</span><span class="ident" id="7597562">Fatalf</span><span class="op" id="7597568">(</span><span class="string" id="7597569">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7597580">,</span>&nbsp;<span class="ident" id="7597582">err</span><span class="op" id="7597585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7597588">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7597591">err</span>&nbsp;<span class="op" id="7597595">=</span>&nbsp;<span class="ident" id="7597597">tx</span><span class="op" id="7597599">.</span><span class="ident" id="7597600">Commit</span><span class="op" id="7597606">(</span><span class="op" id="7597607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7597610">if</span>&nbsp;<span class="ident" id="7597613">err</span>&nbsp;<span class="op" id="7597617">!=</span>&nbsp;<span class="ident" id="7597620">nil</span>&nbsp;<span class="op" id="7597624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7597628">t</span><span class="op" id="7597629">.</span><span class="ident" id="7597630">Fatalf</span><span class="op" id="7597636">(</span><span class="string" id="7597637">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7597650">,</span>&nbsp;<span class="ident" id="7597652">err</span><span class="op" id="7597655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7597658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7597661">//&nbsp;Commit()&nbsp;should&nbsp;have&nbsp;closed&nbsp;the&nbsp;statement</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7597707">if</span>&nbsp;<span class="op" id="7597710">!</span><span class="ident" id="7597711">txs</span><span class="op" id="7597714">.</span><span class="ident" id="7597715">closed</span>&nbsp;<span class="op" id="7597722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7597726">t</span><span class="op" id="7597727">.</span><span class="ident" id="7597728">Fatal</span><span class="op" id="7597733">(</span><span class="string" id="7597734">&#34;Stmt&nbsp;not&nbsp;closed&nbsp;after&nbsp;Commit&#34;</span><span class="op" id="7597764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7597767">}</span><br>
<span class="lineno"></span><span class="op" id="7597769">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">500</span><span class="comment" id="7597772">//&nbsp;Issue:&nbsp;http://golang.org/issue/2784</span><br>
<span class="lineno"></span><span class="comment" id="7597811">//&nbsp;This&nbsp;test&nbsp;didn&#39;t&nbsp;fail&nbsp;before&nbsp;because&nbsp;we&nbsp;got&nbsp;lucky&nbsp;with&nbsp;the&nbsp;fakedb&nbsp;driver.</span><br>
<span class="lineno"></span><span class="comment" id="7597888">//&nbsp;It&nbsp;was&nbsp;failing,&nbsp;and&nbsp;now&nbsp;not,&nbsp;in&nbsp;github.com/bradfitz/go-sql-test</span><br>
<span class="lineno"></span><span class="keyword" id="7597955">func</span>&nbsp;<span class="ident" id="7597960">TestTxQuery</span><span class="op" id="7597971">(</span><span class="ident" id="7597972">t</span>&nbsp;<span class="op" id="7597974">*</span><span class="ident" id="7597975">testing</span><span class="op" id="7597982">.</span><span class="ident" id="7597983">T</span><span class="op" id="7597984">)</span>&nbsp;<span class="op" id="7597986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7597989">db</span>&nbsp;<span class="op" id="7597992">:=</span>&nbsp;<span class="ident" id="7597995">newTestDB</span><span class="op" id="7598004">(</span><span class="ident" id="7598005">t</span><span class="op" id="7598006">,</span>&nbsp;<span class="string" id="7598008">&#34;&#34;</span><span class="op" id="7598010">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598013">defer</span>&nbsp;<span class="ident" id="7598019">closeDB</span><span class="op" id="7598026">(</span><span class="ident" id="7598027">t</span><span class="op" id="7598028">,</span>&nbsp;<span class="ident" id="7598030">db</span><span class="op" id="7598032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7598035">exec</span><span class="op" id="7598039">(</span><span class="ident" id="7598040">t</span><span class="op" id="7598041">,</span>&nbsp;<span class="ident" id="7598043">db</span><span class="op" id="7598045">,</span>&nbsp;<span class="string" id="7598047">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7598090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7598093">exec</span><span class="op" id="7598097">(</span><span class="ident" id="7598098">t</span><span class="op" id="7598099">,</span>&nbsp;<span class="ident" id="7598101">db</span><span class="op" id="7598103">,</span>&nbsp;<span class="string" id="7598105">&#34;INSERT|t1|name=Alice&#34;</span><span class="op" id="7598127">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7598131">tx</span><span class="op" id="7598133">,</span>&nbsp;<span class="ident" id="7598135">err</span>&nbsp;<span class="op" id="7598139">:=</span>&nbsp;<span class="ident" id="7598142">db</span><span class="op" id="7598144">.</span><span class="ident" id="7598145">Begin</span><span class="op" id="7598150">(</span><span class="op" id="7598151">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598154">if</span>&nbsp;<span class="ident" id="7598157">err</span>&nbsp;<span class="op" id="7598161">!=</span>&nbsp;<span class="ident" id="7598164">nil</span>&nbsp;<span class="op" id="7598168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7598172">t</span><span class="op" id="7598173">.</span><span class="ident" id="7598174">Fatal</span><span class="op" id="7598179">(</span><span class="ident" id="7598180">err</span><span class="op" id="7598183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7598186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598189">defer</span>&nbsp;<span class="ident" id="7598195">tx</span><span class="op" id="7598197">.</span><span class="ident" id="7598198">Rollback</span><span class="op" id="7598206">(</span><span class="op" id="7598207">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7598211">r</span><span class="op" id="7598212">,</span>&nbsp;<span class="ident" id="7598214">err</span>&nbsp;<span class="op" id="7598218">:=</span>&nbsp;<span class="ident" id="7598221">tx</span><span class="op" id="7598223">.</span><span class="ident" id="7598224">Query</span><span class="op" id="7598229">(</span><span class="string" id="7598230">&#34;SELECT|t1|name|&#34;</span><span class="op" id="7598247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598250">if</span>&nbsp;<span class="ident" id="7598253">err</span>&nbsp;<span class="op" id="7598257">!=</span>&nbsp;<span class="ident" id="7598260">nil</span>&nbsp;<span class="op" id="7598264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7598268">t</span><span class="op" id="7598269">.</span><span class="ident" id="7598270">Fatal</span><span class="op" id="7598275">(</span><span class="ident" id="7598276">err</span><span class="op" id="7598279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7598282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598285">defer</span>&nbsp;<span class="ident" id="7598291">r</span><span class="op" id="7598292">.</span><span class="ident" id="7598293">Close</span><span class="op" id="7598298">(</span><span class="op" id="7598299">)</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598303">if</span>&nbsp;<span class="op" id="7598306">!</span><span class="ident" id="7598307">r</span><span class="op" id="7598308">.</span><span class="ident" id="7598309">Next</span><span class="op" id="7598313">(</span><span class="op" id="7598314">)</span>&nbsp;<span class="op" id="7598316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598320">if</span>&nbsp;<span class="ident" id="7598323">r</span><span class="op" id="7598324">.</span><span class="ident" id="7598325">Err</span><span class="op" id="7598328">(</span><span class="op" id="7598329">)</span>&nbsp;<span class="op" id="7598331">!=</span>&nbsp;<span class="ident" id="7598334">nil</span>&nbsp;<span class="op" id="7598338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7598343">t</span><span class="op" id="7598344">.</span><span class="ident" id="7598345">Fatal</span><span class="op" id="7598350">(</span><span class="ident" id="7598351">r</span><span class="op" id="7598352">.</span><span class="ident" id="7598353">Err</span><span class="op" id="7598356">(</span><span class="op" id="7598357">)</span><span class="op" id="7598358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7598362">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7598366">t</span><span class="op" id="7598367">.</span><span class="ident" id="7598368">Fatal</span><span class="op" id="7598373">(</span><span class="string" id="7598374">&#34;expected&nbsp;one&nbsp;row&#34;</span><span class="op" id="7598392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7598395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598399">var</span>&nbsp;<span class="ident" id="7598403">x</span>&nbsp;<span class="builtintype" id="7598405">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7598413">err</span>&nbsp;<span class="op" id="7598417">=</span>&nbsp;<span class="ident" id="7598419">r</span><span class="op" id="7598420">.</span><span class="ident" id="7598421">Scan</span><span class="op" id="7598425">(</span><span class="op" id="7598426">&amp;</span><span class="ident" id="7598427">x</span><span class="op" id="7598428">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598431">if</span>&nbsp;<span class="ident" id="7598434">err</span>&nbsp;<span class="op" id="7598438">!=</span>&nbsp;<span class="ident" id="7598441">nil</span>&nbsp;<span class="op" id="7598445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7598449">t</span><span class="op" id="7598450">.</span><span class="ident" id="7598451">Fatal</span><span class="op" id="7598456">(</span><span class="ident" id="7598457">err</span><span class="op" id="7598460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7598463">}</span><br>
<span class="lineno"></span><span class="op" id="7598465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="7598468">func</span>&nbsp;<span class="ident" id="7598473">TestTxQueryInvalid</span><span class="op" id="7598491">(</span><span class="ident" id="7598492">t</span>&nbsp;<span class="op" id="7598494">*</span><span class="ident" id="7598495">testing</span><span class="op" id="7598502">.</span><span class="ident" id="7598503">T</span><span class="op" id="7598504">)</span>&nbsp;<span class="op" id="7598506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7598509">db</span>&nbsp;<span class="op" id="7598512">:=</span>&nbsp;<span class="ident" id="7598515">newTestDB</span><span class="op" id="7598524">(</span><span class="ident" id="7598525">t</span><span class="op" id="7598526">,</span>&nbsp;<span class="string" id="7598528">&#34;&#34;</span><span class="op" id="7598530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598533">defer</span>&nbsp;<span class="ident" id="7598539">closeDB</span><span class="op" id="7598546">(</span><span class="ident" id="7598547">t</span><span class="op" id="7598548">,</span>&nbsp;<span class="ident" id="7598550">db</span><span class="op" id="7598552">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7598556">tx</span><span class="op" id="7598558">,</span>&nbsp;<span class="ident" id="7598560">err</span>&nbsp;<span class="op" id="7598564">:=</span>&nbsp;<span class="ident" id="7598567">db</span><span class="op" id="7598569">.</span><span class="ident" id="7598570">Begin</span><span class="op" id="7598575">(</span><span class="op" id="7598576">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598579">if</span>&nbsp;<span class="ident" id="7598582">err</span>&nbsp;<span class="op" id="7598586">!=</span>&nbsp;<span class="ident" id="7598589">nil</span>&nbsp;<span class="op" id="7598593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7598597">t</span><span class="op" id="7598598">.</span><span class="ident" id="7598599">Fatal</span><span class="op" id="7598604">(</span><span class="ident" id="7598605">err</span><span class="op" id="7598608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7598611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598614">defer</span>&nbsp;<span class="ident" id="7598620">tx</span><span class="op" id="7598622">.</span><span class="ident" id="7598623">Rollback</span><span class="op" id="7598631">(</span><span class="op" id="7598632">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7598636">_</span><span class="op" id="7598637">,</span>&nbsp;<span class="ident" id="7598639">err</span>&nbsp;<span class="op" id="7598643">=</span>&nbsp;<span class="ident" id="7598645">tx</span><span class="op" id="7598647">.</span><span class="ident" id="7598648">Query</span><span class="op" id="7598653">(</span><span class="string" id="7598654">&#34;SELECT|t1|name|&#34;</span><span class="op" id="7598671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598674">if</span>&nbsp;<span class="ident" id="7598677">err</span>&nbsp;<span class="op" id="7598681">==</span>&nbsp;<span class="ident" id="7598684">nil</span>&nbsp;<span class="op" id="7598688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7598692">t</span><span class="op" id="7598693">.</span><span class="ident" id="7598694">Fatal</span><span class="op" id="7598699">(</span><span class="string" id="7598700">&#34;Error&nbsp;expected&#34;</span><span class="op" id="7598716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7598719">}</span><br>
<span class="lineno"></span><span class="op" id="7598721">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="comment" id="7598724">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;4433,&nbsp;that&nbsp;retries&nbsp;in&nbsp;Begin&nbsp;happen&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="7598787">//&nbsp;conn.Begin()&nbsp;returns&nbsp;ErrBadConn</span><br>
<span class="lineno"></span><span class="keyword" id="7598822">func</span>&nbsp;<span class="ident" id="7598827">TestTxErrBadConn</span><span class="op" id="7598843">(</span><span class="ident" id="7598844">t</span>&nbsp;<span class="op" id="7598846">*</span><span class="ident" id="7598847">testing</span><span class="op" id="7598854">.</span><span class="ident" id="7598855">T</span><span class="op" id="7598856">)</span>&nbsp;<span class="op" id="7598858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7598861">db</span><span class="op" id="7598863">,</span>&nbsp;<span class="ident" id="7598865">err</span>&nbsp;<span class="op" id="7598869">:=</span>&nbsp;<span class="ident" id="7598872">Open</span><span class="op" id="7598876">(</span><span class="string" id="7598877">&#34;test&#34;</span><span class="op" id="7598883">,</span>&nbsp;<span class="ident" id="7598885">fakeDBName</span><span class="op" id="7598895">+</span><span class="string" id="7598896">&#34;;badConn&#34;</span><span class="op" id="7598906">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598909">if</span>&nbsp;<span class="ident" id="7598912">err</span>&nbsp;<span class="op" id="7598916">!=</span>&nbsp;<span class="ident" id="7598919">nil</span>&nbsp;<span class="op" id="7598923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7598927">t</span><span class="op" id="7598928">.</span><span class="ident" id="7598929">Fatalf</span><span class="op" id="7598935">(</span><span class="string" id="7598936">&#34;Open:&nbsp;%v&#34;</span><span class="op" id="7598946">,</span>&nbsp;<span class="ident" id="7598948">err</span><span class="op" id="7598951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7598954">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598957">if</span>&nbsp;<span class="ident" id="7598960">_</span><span class="op" id="7598961">,</span>&nbsp;<span class="ident" id="7598963">err</span>&nbsp;<span class="op" id="7598967">:=</span>&nbsp;<span class="ident" id="7598970">db</span><span class="op" id="7598972">.</span><span class="ident" id="7598973">Exec</span><span class="op" id="7598977">(</span><span class="string" id="7598978">&#34;WIPE&#34;</span><span class="op" id="7598984">)</span><span class="op" id="7598985">;</span>&nbsp;<span class="ident" id="7598987">err</span>&nbsp;<span class="op" id="7598991">!=</span>&nbsp;<span class="ident" id="7598994">nil</span>&nbsp;<span class="op" id="7598998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7599002">t</span><span class="op" id="7599003">.</span><span class="ident" id="7599004">Fatalf</span><span class="op" id="7599010">(</span><span class="string" id="7599011">&#34;exec&nbsp;wipe:&nbsp;%v&#34;</span><span class="op" id="7599026">,</span>&nbsp;<span class="ident" id="7599028">err</span><span class="op" id="7599031">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7599034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7599037">defer</span>&nbsp;<span class="ident" id="7599043">closeDB</span><span class="op" id="7599050">(</span><span class="ident" id="7599051">t</span><span class="op" id="7599052">,</span>&nbsp;<span class="ident" id="7599054">db</span><span class="op" id="7599056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7599059">exec</span><span class="op" id="7599063">(</span><span class="ident" id="7599064">t</span><span class="op" id="7599065">,</span>&nbsp;<span class="ident" id="7599067">db</span><span class="op" id="7599069">,</span>&nbsp;<span class="string" id="7599071">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7599114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7599117">stmt</span><span class="op" id="7599121">,</span>&nbsp;<span class="ident" id="7599123">err</span>&nbsp;<span class="op" id="7599127">:=</span>&nbsp;<span class="ident" id="7599130">db</span><span class="op" id="7599132">.</span><span class="ident" id="7599133">Prepare</span><span class="op" id="7599140">(</span><span class="string" id="7599141">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="7599165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7599168">if</span>&nbsp;<span class="ident" id="7599171">err</span>&nbsp;<span class="op" id="7599175">!=</span>&nbsp;<span class="ident" id="7599178">nil</span>&nbsp;<span class="op" id="7599182">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7599186">t</span><span class="op" id="7599187">.</span><span class="ident" id="7599188">Fatalf</span><span class="op" id="7599194">(</span><span class="string" id="7599195">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="7599215">,</span>&nbsp;<span class="ident" id="7599217">stmt</span><span class="op" id="7599221">,</span>&nbsp;<span class="ident" id="7599223">err</span><span class="op" id="7599226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7599229">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7599232">defer</span>&nbsp;<span class="ident" id="7599238">stmt</span><span class="op" id="7599242">.</span><span class="ident" id="7599243">Close</span><span class="op" id="7599248">(</span><span class="op" id="7599249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7599252">tx</span><span class="op" id="7599254">,</span>&nbsp;<span class="ident" id="7599256">err</span>&nbsp;<span class="op" id="7599260">:=</span>&nbsp;<span class="ident" id="7599263">db</span><span class="op" id="7599265">.</span><span class="ident" id="7599266">Begin</span><span class="op" id="7599271">(</span><span class="op" id="7599272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7599275">if</span>&nbsp;<span class="ident" id="7599278">err</span>&nbsp;<span class="op" id="7599282">!=</span>&nbsp;<span class="ident" id="7599285">nil</span>&nbsp;<span class="op" id="7599289">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7599293">t</span><span class="op" id="7599294">.</span><span class="ident" id="7599295">Fatalf</span><span class="op" id="7599301">(</span><span class="string" id="7599302">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7599314">,</span>&nbsp;<span class="ident" id="7599316">err</span><span class="op" id="7599319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7599322">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7599325">txs</span>&nbsp;<span class="op" id="7599329">:=</span>&nbsp;<span class="ident" id="7599332">tx</span><span class="op" id="7599334">.</span><span class="ident" id="7599335">Stmt</span><span class="op" id="7599339">(</span><span class="ident" id="7599340">stmt</span><span class="op" id="7599344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7599347">defer</span>&nbsp;<span class="ident" id="7599353">txs</span><span class="op" id="7599356">.</span><span class="ident" id="7599357">Close</span><span class="op" id="7599362">(</span><span class="op" id="7599363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7599366">_</span><span class="op" id="7599367">,</span>&nbsp;<span class="ident" id="7599369">err</span>&nbsp;<span class="op" id="7599373">=</span>&nbsp;<span class="ident" id="7599375">txs</span><span class="op" id="7599378">.</span><span class="ident" id="7599379">Exec</span><span class="op" id="7599383">(</span><span class="string" id="7599384">&#34;Bobby&#34;</span><span class="op" id="7599391">,</span>&nbsp;<span class="num" id="7599393">7</span><span class="op" id="7599394">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7599397">if</span>&nbsp;<span class="ident" id="7599400">err</span>&nbsp;<span class="op" id="7599404">!=</span>&nbsp;<span class="ident" id="7599407">nil</span>&nbsp;<span class="op" id="7599411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7599415">t</span><span class="op" id="7599416">.</span><span class="ident" id="7599417">Fatalf</span><span class="op" id="7599423">(</span><span class="string" id="7599424">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7599435">,</span>&nbsp;<span class="ident" id="7599437">err</span><span class="op" id="7599440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7599443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7599446">err</span>&nbsp;<span class="op" id="7599450">=</span>&nbsp;<span class="ident" id="7599452">tx</span><span class="op" id="7599454">.</span><span class="ident" id="7599455">Commit</span><span class="op" id="7599461">(</span><span class="op" id="7599462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7599465">if</span>&nbsp;<span class="ident" id="7599468">err</span>&nbsp;<span class="op" id="7599472">!=</span>&nbsp;<span class="ident" id="7599475">nil</span>&nbsp;<span class="op" id="7599479">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7599483">t</span><span class="op" id="7599484">.</span><span class="ident" id="7599485">Fatalf</span><span class="op" id="7599491">(</span><span class="string" id="7599492">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7599505">,</span>&nbsp;<span class="ident" id="7599507">err</span><span class="op" id="7599510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7599513">}</span><br>
<span class="lineno"></span><span class="op" id="7599515">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7599518">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;2542,&nbsp;that&nbsp;we&nbsp;release&nbsp;a&nbsp;lock&nbsp;when&nbsp;querying&nbsp;on</span><br>
<span class="lineno">585</span><span class="comment" id="7599587">//&nbsp;a&nbsp;closed&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="7599611">func</span>&nbsp;<span class="ident" id="7599616">TestIssue2542Deadlock</span><span class="op" id="7599637">(</span><span class="ident" id="7599638">t</span>&nbsp;<span class="op" id="7599640">*</span><span class="ident" id="7599641">testing</span><span class="op" id="7599648">.</span><span class="ident" id="7599649">T</span><span class="op" id="7599650">)</span>&nbsp;<span class="op" id="7599652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7599655">db</span>&nbsp;<span class="op" id="7599658">:=</span>&nbsp;<span class="ident" id="7599661">newTestDB</span><span class="op" id="7599670">(</span><span class="ident" id="7599671">t</span><span class="op" id="7599672">,</span>&nbsp;<span class="string" id="7599674">&#34;people&#34;</span><span class="op" id="7599682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7599685">closeDB</span><span class="op" id="7599692">(</span><span class="ident" id="7599693">t</span><span class="op" id="7599694">,</span>&nbsp;<span class="ident" id="7599696">db</span><span class="op" id="7599698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7599701">for</span>&nbsp;<span class="ident" id="7599705">i</span>&nbsp;<span class="op" id="7599707">:=</span>&nbsp;<span class="num" id="7599710">0</span><span class="op" id="7599711">;</span>&nbsp;<span class="ident" id="7599713">i</span>&nbsp;<span class="op" id="7599715">&lt;</span>&nbsp;<span class="num" id="7599717">2</span><span class="op" id="7599718">;</span>&nbsp;<span class="ident" id="7599720">i</span><span class="op" id="7599721">++</span>&nbsp;<span class="op" id="7599724">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7599728">_</span><span class="op" id="7599729">,</span>&nbsp;<span class="ident" id="7599731">err</span>&nbsp;<span class="op" id="7599735">:=</span>&nbsp;<span class="ident" id="7599738">db</span><span class="op" id="7599740">.</span><span class="ident" id="7599741">Query</span><span class="op" id="7599746">(</span><span class="string" id="7599747">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="7599772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7599776">if</span>&nbsp;<span class="ident" id="7599779">err</span>&nbsp;<span class="op" id="7599783">==</span>&nbsp;<span class="ident" id="7599786">nil</span>&nbsp;<span class="op" id="7599790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7599795">t</span><span class="op" id="7599796">.</span><span class="ident" id="7599797">Fatalf</span><span class="op" id="7599803">(</span><span class="string" id="7599804">&#34;expected&nbsp;error&#34;</span><span class="op" id="7599820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7599824">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7599827">}</span><br>
<span class="lineno">595</span><span class="op" id="7599829">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7599832">//&nbsp;From&nbsp;golang.org/issue/3865</span><br>
<span class="lineno"></span><span class="keyword" id="7599862">func</span>&nbsp;<span class="ident" id="7599867">TestCloseStmtBeforeRows</span><span class="op" id="7599890">(</span><span class="ident" id="7599891">t</span>&nbsp;<span class="op" id="7599893">*</span><span class="ident" id="7599894">testing</span><span class="op" id="7599901">.</span><span class="ident" id="7599902">T</span><span class="op" id="7599903">)</span>&nbsp;<span class="op" id="7599905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7599908">db</span>&nbsp;<span class="op" id="7599911">:=</span>&nbsp;<span class="ident" id="7599914">newTestDB</span><span class="op" id="7599923">(</span><span class="ident" id="7599924">t</span><span class="op" id="7599925">,</span>&nbsp;<span class="string" id="7599927">&#34;people&#34;</span><span class="op" id="7599935">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7599938">defer</span>&nbsp;<span class="ident" id="7599944">closeDB</span><span class="op" id="7599951">(</span><span class="ident" id="7599952">t</span><span class="op" id="7599953">,</span>&nbsp;<span class="ident" id="7599955">db</span><span class="op" id="7599957">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7599961">s</span><span class="op" id="7599962">,</span>&nbsp;<span class="ident" id="7599964">err</span>&nbsp;<span class="op" id="7599968">:=</span>&nbsp;<span class="ident" id="7599971">db</span><span class="op" id="7599973">.</span><span class="ident" id="7599974">Prepare</span><span class="op" id="7599981">(</span><span class="string" id="7599982">&#34;SELECT|people|name|&#34;</span><span class="op" id="7600003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7600006">if</span>&nbsp;<span class="ident" id="7600009">err</span>&nbsp;<span class="op" id="7600013">!=</span>&nbsp;<span class="ident" id="7600016">nil</span>&nbsp;<span class="op" id="7600020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7600024">t</span><span class="op" id="7600025">.</span><span class="ident" id="7600026">Fatal</span><span class="op" id="7600031">(</span><span class="ident" id="7600032">err</span><span class="op" id="7600035">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7600038">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7600042">r</span><span class="op" id="7600043">,</span>&nbsp;<span class="ident" id="7600045">err</span>&nbsp;<span class="op" id="7600049">:=</span>&nbsp;<span class="ident" id="7600052">s</span><span class="op" id="7600053">.</span><span class="ident" id="7600054">Query</span><span class="op" id="7600059">(</span><span class="op" id="7600060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7600063">if</span>&nbsp;<span class="ident" id="7600066">err</span>&nbsp;<span class="op" id="7600070">!=</span>&nbsp;<span class="ident" id="7600073">nil</span>&nbsp;<span class="op" id="7600077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7600081">s</span><span class="op" id="7600082">.</span><span class="ident" id="7600083">Close</span><span class="op" id="7600088">(</span><span class="op" id="7600089">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7600093">t</span><span class="op" id="7600094">.</span><span class="ident" id="7600095">Fatal</span><span class="op" id="7600100">(</span><span class="ident" id="7600101">err</span><span class="op" id="7600104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7600107">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7600111">err</span>&nbsp;<span class="op" id="7600115">=</span>&nbsp;<span class="ident" id="7600117">s</span><span class="op" id="7600118">.</span><span class="ident" id="7600119">Close</span><span class="op" id="7600124">(</span><span class="op" id="7600125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7600128">if</span>&nbsp;<span class="ident" id="7600131">err</span>&nbsp;<span class="op" id="7600135">!=</span>&nbsp;<span class="ident" id="7600138">nil</span>&nbsp;<span class="op" id="7600142">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7600146">t</span><span class="op" id="7600147">.</span><span class="ident" id="7600148">Fatal</span><span class="op" id="7600153">(</span><span class="ident" id="7600154">err</span><span class="op" id="7600157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7600160">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7600164">r</span><span class="op" id="7600165">.</span><span class="ident" id="7600166">Close</span><span class="op" id="7600171">(</span><span class="op" id="7600172">)</span><br>
<span class="lineno"></span><span class="op" id="7600174">}</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="comment" id="7600177">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;2788,&nbsp;that&nbsp;we&nbsp;bind&nbsp;nil&nbsp;to&nbsp;a&nbsp;[]byte&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="7600242">//&nbsp;value&nbsp;in&nbsp;the&nbsp;column&nbsp;is&nbsp;sql&nbsp;null</span><br>
<span class="lineno"></span><span class="keyword" id="7600277">func</span>&nbsp;<span class="ident" id="7600282">TestNullByteSlice</span><span class="op" id="7600299">(</span><span class="ident" id="7600300">t</span>&nbsp;<span class="op" id="7600302">*</span><span class="ident" id="7600303">testing</span><span class="op" id="7600310">.</span><span class="ident" id="7600311">T</span><span class="op" id="7600312">)</span>&nbsp;<span class="op" id="7600314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7600317">db</span>&nbsp;<span class="op" id="7600320">:=</span>&nbsp;<span class="ident" id="7600323">newTestDB</span><span class="op" id="7600332">(</span><span class="ident" id="7600333">t</span><span class="op" id="7600334">,</span>&nbsp;<span class="string" id="7600336">&#34;&#34;</span><span class="op" id="7600338">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7600341">defer</span>&nbsp;<span class="ident" id="7600347">closeDB</span><span class="op" id="7600354">(</span><span class="ident" id="7600355">t</span><span class="op" id="7600356">,</span>&nbsp;<span class="ident" id="7600358">db</span><span class="op" id="7600360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7600363">exec</span><span class="op" id="7600367">(</span><span class="ident" id="7600368">t</span><span class="op" id="7600369">,</span>&nbsp;<span class="ident" id="7600371">db</span><span class="op" id="7600373">,</span>&nbsp;<span class="string" id="7600375">&#34;CREATE|t|id=int32,name=nullstring&#34;</span><span class="op" id="7600410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7600413">exec</span><span class="op" id="7600417">(</span><span class="ident" id="7600418">t</span><span class="op" id="7600419">,</span>&nbsp;<span class="ident" id="7600421">db</span><span class="op" id="7600423">,</span>&nbsp;<span class="string" id="7600425">&#34;INSERT|t|id=10,name=?&#34;</span><span class="op" id="7600448">,</span>&nbsp;<span class="ident" id="7600450">nil</span><span class="op" id="7600453">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7600457">var</span>&nbsp;<span class="ident" id="7600461">name</span>&nbsp;<span class="op" id="7600466">[</span><span class="op" id="7600467">]</span><span class="builtintype" id="7600468">byte</span><br>
<span class="lineno">630</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7600475">err</span>&nbsp;<span class="op" id="7600479">:=</span>&nbsp;<span class="ident" id="7600482">db</span><span class="op" id="7600484">.</span><span class="ident" id="7600485">QueryRow</span><span class="op" id="7600493">(</span><span class="string" id="7600494">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="7600514">,</span>&nbsp;<span class="num" id="7600516">10</span><span class="op" id="7600518">)</span><span class="op" id="7600519">.</span><span class="ident" id="7600520">Scan</span><span class="op" id="7600524">(</span><span class="op" id="7600525">&amp;</span><span class="ident" id="7600526">name</span><span class="op" id="7600530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7600533">if</span>&nbsp;<span class="ident" id="7600536">err</span>&nbsp;<span class="op" id="7600540">!=</span>&nbsp;<span class="ident" id="7600543">nil</span>&nbsp;<span class="op" id="7600547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7600551">t</span><span class="op" id="7600552">.</span><span class="ident" id="7600553">Fatal</span><span class="op" id="7600558">(</span><span class="ident" id="7600559">err</span><span class="op" id="7600562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7600565">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7600568">if</span>&nbsp;<span class="ident" id="7600571">name</span>&nbsp;<span class="op" id="7600576">!=</span>&nbsp;<span class="ident" id="7600579">nil</span>&nbsp;<span class="op" id="7600583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7600587">t</span><span class="op" id="7600588">.</span><span class="ident" id="7600589">Fatalf</span><span class="op" id="7600595">(</span><span class="string" id="7600596">&#34;name&nbsp;[]byte&nbsp;should&nbsp;be&nbsp;nil&nbsp;for&nbsp;null&nbsp;column&nbsp;value,&nbsp;got:&nbsp;%#v&#34;</span><span class="op" id="7600655">,</span>&nbsp;<span class="ident" id="7600657">name</span><span class="op" id="7600661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7600664">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7600668">exec</span><span class="op" id="7600672">(</span><span class="ident" id="7600673">t</span><span class="op" id="7600674">,</span>&nbsp;<span class="ident" id="7600676">db</span><span class="op" id="7600678">,</span>&nbsp;<span class="string" id="7600680">&#34;INSERT|t|id=11,name=?&#34;</span><span class="op" id="7600703">,</span>&nbsp;<span class="string" id="7600705">&#34;bob&#34;</span><span class="op" id="7600710">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7600713">err</span>&nbsp;<span class="op" id="7600717">=</span>&nbsp;<span class="ident" id="7600719">db</span><span class="op" id="7600721">.</span><span class="ident" id="7600722">QueryRow</span><span class="op" id="7600730">(</span><span class="string" id="7600731">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="7600751">,</span>&nbsp;<span class="num" id="7600753">11</span><span class="op" id="7600755">)</span><span class="op" id="7600756">.</span><span class="ident" id="7600757">Scan</span><span class="op" id="7600761">(</span><span class="op" id="7600762">&amp;</span><span class="ident" id="7600763">name</span><span class="op" id="7600767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7600770">if</span>&nbsp;<span class="ident" id="7600773">err</span>&nbsp;<span class="op" id="7600777">!=</span>&nbsp;<span class="ident" id="7600780">nil</span>&nbsp;<span class="op" id="7600784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7600788">t</span><span class="op" id="7600789">.</span><span class="ident" id="7600790">Fatal</span><span class="op" id="7600795">(</span><span class="ident" id="7600796">err</span><span class="op" id="7600799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7600802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7600805">if</span>&nbsp;<span class="builtintype" id="7600808">string</span><span class="op" id="7600814">(</span><span class="ident" id="7600815">name</span><span class="op" id="7600819">)</span>&nbsp;<span class="op" id="7600821">!=</span>&nbsp;<span class="string" id="7600824">&#34;bob&#34;</span>&nbsp;<span class="op" id="7600830">{</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7600834">t</span><span class="op" id="7600835">.</span><span class="ident" id="7600836">Fatalf</span><span class="op" id="7600842">(</span><span class="string" id="7600843">&#34;name&nbsp;[]byte&nbsp;should&nbsp;be&nbsp;bob,&nbsp;got:&nbsp;%q&#34;</span><span class="op" id="7600879">,</span>&nbsp;<span class="builtintype" id="7600881">string</span><span class="op" id="7600887">(</span><span class="ident" id="7600888">name</span><span class="op" id="7600892">)</span><span class="op" id="7600893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7600896">}</span><br>
<span class="lineno"></span><span class="op" id="7600898">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7600901">func</span>&nbsp;<span class="ident" id="7600906">TestPointerParamsAndScans</span><span class="op" id="7600931">(</span><span class="ident" id="7600932">t</span>&nbsp;<span class="op" id="7600934">*</span><span class="ident" id="7600935">testing</span><span class="op" id="7600942">.</span><span class="ident" id="7600943">T</span><span class="op" id="7600944">)</span>&nbsp;<span class="op" id="7600946">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7600949">db</span>&nbsp;<span class="op" id="7600952">:=</span>&nbsp;<span class="ident" id="7600955">newTestDB</span><span class="op" id="7600964">(</span><span class="ident" id="7600965">t</span><span class="op" id="7600966">,</span>&nbsp;<span class="string" id="7600968">&#34;&#34;</span><span class="op" id="7600970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7600973">defer</span>&nbsp;<span class="ident" id="7600979">closeDB</span><span class="op" id="7600986">(</span><span class="ident" id="7600987">t</span><span class="op" id="7600988">,</span>&nbsp;<span class="ident" id="7600990">db</span><span class="op" id="7600992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7600995">exec</span><span class="op" id="7600999">(</span><span class="ident" id="7601000">t</span><span class="op" id="7601001">,</span>&nbsp;<span class="ident" id="7601003">db</span><span class="op" id="7601005">,</span>&nbsp;<span class="string" id="7601007">&#34;CREATE|t|id=int32,name=nullstring&#34;</span><span class="op" id="7601042">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7601046">bob</span>&nbsp;<span class="op" id="7601050">:=</span>&nbsp;<span class="string" id="7601053">&#34;bob&#34;</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7601060">var</span>&nbsp;<span class="ident" id="7601064">name</span>&nbsp;<span class="op" id="7601069">*</span><span class="builtintype" id="7601070">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7601079">name</span>&nbsp;<span class="op" id="7601084">=</span>&nbsp;<span class="op" id="7601086">&amp;</span><span class="ident" id="7601087">bob</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7601092">exec</span><span class="op" id="7601096">(</span><span class="ident" id="7601097">t</span><span class="op" id="7601098">,</span>&nbsp;<span class="ident" id="7601100">db</span><span class="op" id="7601102">,</span>&nbsp;<span class="string" id="7601104">&#34;INSERT|t|id=10,name=?&#34;</span><span class="op" id="7601127">,</span>&nbsp;<span class="ident" id="7601129">name</span><span class="op" id="7601133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7601136">name</span>&nbsp;<span class="op" id="7601141">=</span>&nbsp;<span class="ident" id="7601143">nil</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7601148">exec</span><span class="op" id="7601152">(</span><span class="ident" id="7601153">t</span><span class="op" id="7601154">,</span>&nbsp;<span class="ident" id="7601156">db</span><span class="op" id="7601158">,</span>&nbsp;<span class="string" id="7601160">&#34;INSERT|t|id=20,name=?&#34;</span><span class="op" id="7601183">,</span>&nbsp;<span class="ident" id="7601185">name</span><span class="op" id="7601189">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7601193">err</span>&nbsp;<span class="op" id="7601197">:=</span>&nbsp;<span class="ident" id="7601200">db</span><span class="op" id="7601202">.</span><span class="ident" id="7601203">QueryRow</span><span class="op" id="7601211">(</span><span class="string" id="7601212">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="7601232">,</span>&nbsp;<span class="num" id="7601234">10</span><span class="op" id="7601236">)</span><span class="op" id="7601237">.</span><span class="ident" id="7601238">Scan</span><span class="op" id="7601242">(</span><span class="op" id="7601243">&amp;</span><span class="ident" id="7601244">name</span><span class="op" id="7601248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7601251">if</span>&nbsp;<span class="ident" id="7601254">err</span>&nbsp;<span class="op" id="7601258">!=</span>&nbsp;<span class="ident" id="7601261">nil</span>&nbsp;<span class="op" id="7601265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7601269">t</span><span class="op" id="7601270">.</span><span class="ident" id="7601271">Fatalf</span><span class="op" id="7601277">(</span><span class="string" id="7601278">&#34;querying&nbsp;id&nbsp;10:&nbsp;%v&#34;</span><span class="op" id="7601298">,</span>&nbsp;<span class="ident" id="7601300">err</span><span class="op" id="7601303">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7601306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7601309">if</span>&nbsp;<span class="ident" id="7601312">name</span>&nbsp;<span class="op" id="7601317">==</span>&nbsp;<span class="ident" id="7601320">nil</span>&nbsp;<span class="op" id="7601324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7601328">t</span><span class="op" id="7601329">.</span><span class="ident" id="7601330">Errorf</span><span class="op" id="7601336">(</span><span class="string" id="7601337">&#34;id&nbsp;10&#39;s&nbsp;name&nbsp;=&nbsp;nil;&nbsp;want&nbsp;bob&#34;</span><span class="op" id="7601367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7601370">}</span>&nbsp;<span class="keyword" id="7601372">else</span>&nbsp;<span class="keyword" id="7601377">if</span>&nbsp;<span class="op" id="7601380">*</span><span class="ident" id="7601381">name</span>&nbsp;<span class="op" id="7601386">!=</span>&nbsp;<span class="string" id="7601389">&#34;bob&#34;</span>&nbsp;<span class="op" id="7601395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7601399">t</span><span class="op" id="7601400">.</span><span class="ident" id="7601401">Errorf</span><span class="op" id="7601407">(</span><span class="string" id="7601408">&#34;id&nbsp;10&#39;s&nbsp;name&nbsp;=&nbsp;%q;&nbsp;want&nbsp;bob&#34;</span><span class="op" id="7601437">,</span>&nbsp;<span class="op" id="7601439">*</span><span class="ident" id="7601440">name</span><span class="op" id="7601444">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7601447">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7601451">err</span>&nbsp;<span class="op" id="7601455">=</span>&nbsp;<span class="ident" id="7601457">db</span><span class="op" id="7601459">.</span><span class="ident" id="7601460">QueryRow</span><span class="op" id="7601468">(</span><span class="string" id="7601469">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="7601489">,</span>&nbsp;<span class="num" id="7601491">20</span><span class="op" id="7601493">)</span><span class="op" id="7601494">.</span><span class="ident" id="7601495">Scan</span><span class="op" id="7601499">(</span><span class="op" id="7601500">&amp;</span><span class="ident" id="7601501">name</span><span class="op" id="7601505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7601508">if</span>&nbsp;<span class="ident" id="7601511">err</span>&nbsp;<span class="op" id="7601515">!=</span>&nbsp;<span class="ident" id="7601518">nil</span>&nbsp;<span class="op" id="7601522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7601526">t</span><span class="op" id="7601527">.</span><span class="ident" id="7601528">Fatalf</span><span class="op" id="7601534">(</span><span class="string" id="7601535">&#34;querying&nbsp;id&nbsp;20:&nbsp;%v&#34;</span><span class="op" id="7601555">,</span>&nbsp;<span class="ident" id="7601557">err</span><span class="op" id="7601560">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7601563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7601566">if</span>&nbsp;<span class="ident" id="7601569">name</span>&nbsp;<span class="op" id="7601574">!=</span>&nbsp;<span class="ident" id="7601577">nil</span>&nbsp;<span class="op" id="7601581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7601585">t</span><span class="op" id="7601586">.</span><span class="ident" id="7601587">Errorf</span><span class="op" id="7601593">(</span><span class="string" id="7601594">&#34;id&nbsp;20&nbsp;=&nbsp;%q;&nbsp;want&nbsp;nil&#34;</span><span class="op" id="7601616">,</span>&nbsp;<span class="op" id="7601618">*</span><span class="ident" id="7601619">name</span><span class="op" id="7601623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7601626">}</span><br>
<span class="lineno"></span><span class="op" id="7601628">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="7601631">func</span>&nbsp;<span class="ident" id="7601636">TestQueryRowClosingStmt</span><span class="op" id="7601659">(</span><span class="ident" id="7601660">t</span>&nbsp;<span class="op" id="7601662">*</span><span class="ident" id="7601663">testing</span><span class="op" id="7601670">.</span><span class="ident" id="7601671">T</span><span class="op" id="7601672">)</span>&nbsp;<span class="op" id="7601674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7601677">db</span>&nbsp;<span class="op" id="7601680">:=</span>&nbsp;<span class="ident" id="7601683">newTestDB</span><span class="op" id="7601692">(</span><span class="ident" id="7601693">t</span><span class="op" id="7601694">,</span>&nbsp;<span class="string" id="7601696">&#34;people&#34;</span><span class="op" id="7601704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7601707">defer</span>&nbsp;<span class="ident" id="7601713">closeDB</span><span class="op" id="7601720">(</span><span class="ident" id="7601721">t</span><span class="op" id="7601722">,</span>&nbsp;<span class="ident" id="7601724">db</span><span class="op" id="7601726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7601729">var</span>&nbsp;<span class="ident" id="7601733">name</span>&nbsp;<span class="builtintype" id="7601738">string</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7601746">var</span>&nbsp;<span class="ident" id="7601750">age</span>&nbsp;<span class="builtintype" id="7601754">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7601759">err</span>&nbsp;<span class="op" id="7601763">:=</span>&nbsp;<span class="ident" id="7601766">db</span><span class="op" id="7601768">.</span><span class="ident" id="7601769">QueryRow</span><span class="op" id="7601777">(</span><span class="string" id="7601778">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="7601808">,</span>&nbsp;<span class="num" id="7601810">3</span><span class="op" id="7601811">)</span><span class="op" id="7601812">.</span><span class="ident" id="7601813">Scan</span><span class="op" id="7601817">(</span><span class="op" id="7601818">&amp;</span><span class="ident" id="7601819">age</span><span class="op" id="7601822">,</span>&nbsp;<span class="op" id="7601824">&amp;</span><span class="ident" id="7601825">name</span><span class="op" id="7601829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7601832">if</span>&nbsp;<span class="ident" id="7601835">err</span>&nbsp;<span class="op" id="7601839">!=</span>&nbsp;<span class="ident" id="7601842">nil</span>&nbsp;<span class="op" id="7601846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7601850">t</span><span class="op" id="7601851">.</span><span class="ident" id="7601852">Fatal</span><span class="op" id="7601857">(</span><span class="ident" id="7601858">err</span><span class="op" id="7601861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7601864">}</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7601867">if</span>&nbsp;<span class="builtinfunc" id="7601870">len</span><span class="op" id="7601873">(</span><span class="ident" id="7601874">db</span><span class="op" id="7601876">.</span><span class="ident" id="7601877">freeConn</span><span class="op" id="7601885">)</span>&nbsp;<span class="op" id="7601887">!=</span>&nbsp;<span class="num" id="7601890">1</span>&nbsp;<span class="op" id="7601892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7601896">t</span><span class="op" id="7601897">.</span><span class="ident" id="7601898">Fatalf</span><span class="op" id="7601904">(</span><span class="string" id="7601905">&#34;expected&nbsp;1&nbsp;free&nbsp;conn&#34;</span><span class="op" id="7601927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7601930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7601933">fakeConn</span>&nbsp;<span class="op" id="7601942">:=</span>&nbsp;<span class="ident" id="7601945">db</span><span class="op" id="7601947">.</span><span class="ident" id="7601948">freeConn</span><span class="op" id="7601956">[</span><span class="num" id="7601957">0</span><span class="op" id="7601958">]</span><span class="op" id="7601959">.</span><span class="ident" id="7601960">ci</span><span class="op" id="7601962">.</span><span class="op" id="7601963">(</span><span class="op" id="7601964">*</span><span class="ident" id="7601965">fakeConn</span><span class="op" id="7601973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7601976">if</span>&nbsp;<span class="ident" id="7601979">made</span><span class="op" id="7601983">,</span>&nbsp;<span class="ident" id="7601985">closed</span>&nbsp;<span class="op" id="7601992">:=</span>&nbsp;<span class="ident" id="7601995">fakeConn</span><span class="op" id="7602003">.</span><span class="ident" id="7602004">stmtsMade</span><span class="op" id="7602013">,</span>&nbsp;<span class="ident" id="7602015">fakeConn</span><span class="op" id="7602023">.</span><span class="ident" id="7602024">stmtsClosed</span><span class="op" id="7602035">;</span>&nbsp;<span class="ident" id="7602037">made</span>&nbsp;<span class="op" id="7602042">!=</span>&nbsp;<span class="ident" id="7602045">closed</span>&nbsp;<span class="op" id="7602052">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7602056">t</span><span class="op" id="7602057">.</span><span class="ident" id="7602058">Errorf</span><span class="op" id="7602064">(</span><span class="string" id="7602065">&#34;statement&nbsp;close&nbsp;mismatch:&nbsp;made&nbsp;%d,&nbsp;closed&nbsp;%d&#34;</span><span class="op" id="7602111">,</span>&nbsp;<span class="ident" id="7602113">made</span><span class="op" id="7602117">,</span>&nbsp;<span class="ident" id="7602119">closed</span><span class="op" id="7602125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7602128">}</span><br>
<span class="lineno"></span><span class="op" id="7602130">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7602133">//&nbsp;Test&nbsp;issue&nbsp;6651</span><br>
<span class="lineno">700</span><span class="keyword" id="7602152">func</span>&nbsp;<span class="ident" id="7602157">TestIssue6651</span><span class="op" id="7602170">(</span><span class="ident" id="7602171">t</span>&nbsp;<span class="op" id="7602173">*</span><span class="ident" id="7602174">testing</span><span class="op" id="7602181">.</span><span class="ident" id="7602182">T</span><span class="op" id="7602183">)</span>&nbsp;<span class="op" id="7602185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7602188">db</span>&nbsp;<span class="op" id="7602191">:=</span>&nbsp;<span class="ident" id="7602194">newTestDB</span><span class="op" id="7602203">(</span><span class="ident" id="7602204">t</span><span class="op" id="7602205">,</span>&nbsp;<span class="string" id="7602207">&#34;people&#34;</span><span class="op" id="7602215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7602218">defer</span>&nbsp;<span class="ident" id="7602224">closeDB</span><span class="op" id="7602231">(</span><span class="ident" id="7602232">t</span><span class="op" id="7602233">,</span>&nbsp;<span class="ident" id="7602235">db</span><span class="op" id="7602237">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7602241">var</span>&nbsp;<span class="ident" id="7602245">v</span>&nbsp;<span class="builtintype" id="7602247">string</span><br>
<span class="lineno">705</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7602256">want</span>&nbsp;<span class="op" id="7602261">:=</span>&nbsp;<span class="string" id="7602264">&#34;error&nbsp;in&nbsp;rows.Next&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7602286">rowsCursorNextHook</span>&nbsp;<span class="op" id="7602305">=</span>&nbsp;<span class="keyword" id="7602307">func</span><span class="op" id="7602311">(</span><span class="ident" id="7602312">dest</span>&nbsp;<span class="op" id="7602317">[</span><span class="op" id="7602318">]</span><span class="ident" id="7602319">driver</span><span class="op" id="7602325">.</span><span class="ident" id="7602326">Value</span><span class="op" id="7602331">)</span>&nbsp;<span class="builtintype" id="7602333">error</span>&nbsp;<span class="op" id="7602339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7602343">return</span>&nbsp;<span class="ident" id="7602350">fmt</span><span class="op" id="7602353">.</span><span class="ident" id="7602354">Errorf</span><span class="op" id="7602360">(</span><span class="ident" id="7602361">want</span><span class="op" id="7602365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7602368">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7602371">defer</span>&nbsp;<span class="keyword" id="7602377">func</span><span class="op" id="7602381">(</span><span class="op" id="7602382">)</span>&nbsp;<span class="op" id="7602384">{</span>&nbsp;<span class="ident" id="7602386">rowsCursorNextHook</span>&nbsp;<span class="op" id="7602405">=</span>&nbsp;<span class="ident" id="7602407">nil</span>&nbsp;<span class="op" id="7602411">}</span><span class="op" id="7602412">(</span><span class="op" id="7602413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7602416">err</span>&nbsp;<span class="op" id="7602420">:=</span>&nbsp;<span class="ident" id="7602423">db</span><span class="op" id="7602425">.</span><span class="ident" id="7602426">QueryRow</span><span class="op" id="7602434">(</span><span class="string" id="7602435">&#34;SELECT|people|name|&#34;</span><span class="op" id="7602456">)</span><span class="op" id="7602457">.</span><span class="ident" id="7602458">Scan</span><span class="op" id="7602462">(</span><span class="op" id="7602463">&amp;</span><span class="ident" id="7602464">v</span><span class="op" id="7602465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7602468">if</span>&nbsp;<span class="ident" id="7602471">err</span>&nbsp;<span class="op" id="7602475">==</span>&nbsp;<span class="ident" id="7602478">nil</span>&nbsp;<span class="op" id="7602482">||</span>&nbsp;<span class="ident" id="7602485">err</span><span class="op" id="7602488">.</span><span class="ident" id="7602489">Error</span><span class="op" id="7602494">(</span><span class="op" id="7602495">)</span>&nbsp;<span class="op" id="7602497">!=</span>&nbsp;<span class="ident" id="7602500">want</span>&nbsp;<span class="op" id="7602505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7602509">t</span><span class="op" id="7602510">.</span><span class="ident" id="7602511">Errorf</span><span class="op" id="7602517">(</span><span class="string" id="7602518">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7602539">,</span>&nbsp;<span class="ident" id="7602541">err</span><span class="op" id="7602544">,</span>&nbsp;<span class="ident" id="7602546">want</span><span class="op" id="7602550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7602553">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7602556">rowsCursorNextHook</span>&nbsp;<span class="op" id="7602575">=</span>&nbsp;<span class="ident" id="7602577">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7602583">want</span>&nbsp;<span class="op" id="7602588">=</span>&nbsp;<span class="string" id="7602590">&#34;error&nbsp;in&nbsp;rows.Close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7602613">rowsCloseHook</span>&nbsp;<span class="op" id="7602627">=</span>&nbsp;<span class="keyword" id="7602629">func</span><span class="op" id="7602633">(</span><span class="ident" id="7602634">rows</span>&nbsp;<span class="op" id="7602639">*</span><span class="ident" id="7602640">Rows</span><span class="op" id="7602644">,</span>&nbsp;<span class="ident" id="7602646">err</span>&nbsp;<span class="op" id="7602650">*</span><span class="builtintype" id="7602651">error</span><span class="op" id="7602656">)</span>&nbsp;<span class="op" id="7602658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7602662">*</span><span class="ident" id="7602663">err</span>&nbsp;<span class="op" id="7602667">=</span>&nbsp;<span class="ident" id="7602669">fmt</span><span class="op" id="7602672">.</span><span class="ident" id="7602673">Errorf</span><span class="op" id="7602679">(</span><span class="ident" id="7602680">want</span><span class="op" id="7602684">)</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7602687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7602690">defer</span>&nbsp;<span class="keyword" id="7602696">func</span><span class="op" id="7602700">(</span><span class="op" id="7602701">)</span>&nbsp;<span class="op" id="7602703">{</span>&nbsp;<span class="ident" id="7602705">rowsCloseHook</span>&nbsp;<span class="op" id="7602719">=</span>&nbsp;<span class="ident" id="7602721">nil</span>&nbsp;<span class="op" id="7602725">}</span><span class="op" id="7602726">(</span><span class="op" id="7602727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7602730">err</span>&nbsp;<span class="op" id="7602734">=</span>&nbsp;<span class="ident" id="7602736">db</span><span class="op" id="7602738">.</span><span class="ident" id="7602739">QueryRow</span><span class="op" id="7602747">(</span><span class="string" id="7602748">&#34;SELECT|people|name|&#34;</span><span class="op" id="7602769">)</span><span class="op" id="7602770">.</span><span class="ident" id="7602771">Scan</span><span class="op" id="7602775">(</span><span class="op" id="7602776">&amp;</span><span class="ident" id="7602777">v</span><span class="op" id="7602778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7602781">if</span>&nbsp;<span class="ident" id="7602784">err</span>&nbsp;<span class="op" id="7602788">==</span>&nbsp;<span class="ident" id="7602791">nil</span>&nbsp;<span class="op" id="7602795">||</span>&nbsp;<span class="ident" id="7602798">err</span><span class="op" id="7602801">.</span><span class="ident" id="7602802">Error</span><span class="op" id="7602807">(</span><span class="op" id="7602808">)</span>&nbsp;<span class="op" id="7602810">!=</span>&nbsp;<span class="ident" id="7602813">want</span>&nbsp;<span class="op" id="7602818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7602822">t</span><span class="op" id="7602823">.</span><span class="ident" id="7602824">Errorf</span><span class="op" id="7602830">(</span><span class="string" id="7602831">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7602852">,</span>&nbsp;<span class="ident" id="7602854">err</span><span class="op" id="7602857">,</span>&nbsp;<span class="ident" id="7602859">want</span><span class="op" id="7602863">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7602866">}</span><br>
<span class="lineno"></span><span class="op" id="7602868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7602871">type</span>&nbsp;<span class="ident" id="7602876">nullTestRow</span>&nbsp;<span class="keyword" id="7602888">struct</span>&nbsp;<span class="op" id="7602895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7602898">nullParam</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7602911">interface</span><span class="op" id="7602920">{</span><span class="op" id="7602921">}</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7602924">notNullParam</span>&nbsp;<span class="keyword" id="7602937">interface</span><span class="op" id="7602946">{</span><span class="op" id="7602947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7602950">scanNullVal</span>&nbsp;&nbsp;<span class="keyword" id="7602963">interface</span><span class="op" id="7602972">{</span><span class="op" id="7602973">}</span><br>
<span class="lineno"></span><span class="op" id="7602975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7602978">type</span>&nbsp;<span class="ident" id="7602983">nullTestSpec</span>&nbsp;<span class="keyword" id="7602996">struct</span>&nbsp;<span class="op" id="7603003">{</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7603006">nullType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7603018">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7603026">notNullType</span>&nbsp;<span class="builtintype" id="7603038">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7603046">rows</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7603058">[</span><span class="num" id="7603059">6</span><span class="op" id="7603060">]</span><span class="ident" id="7603061">nullTestRow</span><br>
<span class="lineno"></span><span class="op" id="7603073">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">740</span><span class="keyword" id="7603076">func</span>&nbsp;<span class="ident" id="7603081">TestNullStringParam</span><span class="op" id="7603100">(</span><span class="ident" id="7603101">t</span>&nbsp;<span class="op" id="7603103">*</span><span class="ident" id="7603104">testing</span><span class="op" id="7603111">.</span><span class="ident" id="7603112">T</span><span class="op" id="7603113">)</span>&nbsp;<span class="op" id="7603115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7603118">spec</span>&nbsp;<span class="op" id="7603123">:=</span>&nbsp;<span class="ident" id="7603126">nullTestSpec</span><span class="op" id="7603138">{</span><span class="string" id="7603139">&#34;nullstring&#34;</span><span class="op" id="7603151">,</span>&nbsp;<span class="string" id="7603153">&#34;string&#34;</span><span class="op" id="7603161">,</span>&nbsp;<span class="op" id="7603163">[</span><span class="num" id="7603164">6</span><span class="op" id="7603165">]</span><span class="ident" id="7603166">nullTestRow</span><span class="op" id="7603177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7603181">{</span><span class="ident" id="7603182">NullString</span><span class="op" id="7603192">{</span><span class="string" id="7603193">&#34;aqua&#34;</span><span class="op" id="7603199">,</span>&nbsp;<span class="builtintype" id="7603201">true</span><span class="op" id="7603205">}</span><span class="op" id="7603206">,</span>&nbsp;<span class="string" id="7603208">&#34;&#34;</span><span class="op" id="7603210">,</span>&nbsp;<span class="ident" id="7603212">NullString</span><span class="op" id="7603222">{</span><span class="string" id="7603223">&#34;aqua&#34;</span><span class="op" id="7603229">,</span>&nbsp;<span class="builtintype" id="7603231">true</span><span class="op" id="7603235">}</span><span class="op" id="7603236">}</span><span class="op" id="7603237">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7603241">{</span><span class="ident" id="7603242">NullString</span><span class="op" id="7603252">{</span><span class="string" id="7603253">&#34;brown&#34;</span><span class="op" id="7603260">,</span>&nbsp;<span class="builtintype" id="7603262">false</span><span class="op" id="7603267">}</span><span class="op" id="7603268">,</span>&nbsp;<span class="string" id="7603270">&#34;&#34;</span><span class="op" id="7603272">,</span>&nbsp;<span class="ident" id="7603274">NullString</span><span class="op" id="7603284">{</span><span class="string" id="7603285">&#34;&#34;</span><span class="op" id="7603287">,</span>&nbsp;<span class="builtintype" id="7603289">false</span><span class="op" id="7603294">}</span><span class="op" id="7603295">}</span><span class="op" id="7603296">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7603300">{</span><span class="string" id="7603301">&#34;chartreuse&#34;</span><span class="op" id="7603313">,</span>&nbsp;<span class="string" id="7603315">&#34;&#34;</span><span class="op" id="7603317">,</span>&nbsp;<span class="ident" id="7603319">NullString</span><span class="op" id="7603329">{</span><span class="string" id="7603330">&#34;chartreuse&#34;</span><span class="op" id="7603342">,</span>&nbsp;<span class="builtintype" id="7603344">true</span><span class="op" id="7603348">}</span><span class="op" id="7603349">}</span><span class="op" id="7603350">,</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7603354">{</span><span class="ident" id="7603355">NullString</span><span class="op" id="7603365">{</span><span class="string" id="7603366">&#34;darkred&#34;</span><span class="op" id="7603375">,</span>&nbsp;<span class="builtintype" id="7603377">true</span><span class="op" id="7603381">}</span><span class="op" id="7603382">,</span>&nbsp;<span class="string" id="7603384">&#34;&#34;</span><span class="op" id="7603386">,</span>&nbsp;<span class="ident" id="7603388">NullString</span><span class="op" id="7603398">{</span><span class="string" id="7603399">&#34;darkred&#34;</span><span class="op" id="7603408">,</span>&nbsp;<span class="builtintype" id="7603410">true</span><span class="op" id="7603414">}</span><span class="op" id="7603415">}</span><span class="op" id="7603416">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7603420">{</span><span class="ident" id="7603421">NullString</span><span class="op" id="7603431">{</span><span class="string" id="7603432">&#34;eel&#34;</span><span class="op" id="7603437">,</span>&nbsp;<span class="builtintype" id="7603439">false</span><span class="op" id="7603444">}</span><span class="op" id="7603445">,</span>&nbsp;<span class="string" id="7603447">&#34;&#34;</span><span class="op" id="7603449">,</span>&nbsp;<span class="ident" id="7603451">NullString</span><span class="op" id="7603461">{</span><span class="string" id="7603462">&#34;&#34;</span><span class="op" id="7603464">,</span>&nbsp;<span class="builtintype" id="7603466">false</span><span class="op" id="7603471">}</span><span class="op" id="7603472">}</span><span class="op" id="7603473">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7603477">{</span><span class="string" id="7603478">&#34;foo&#34;</span><span class="op" id="7603483">,</span>&nbsp;<span class="ident" id="7603485">NullString</span><span class="op" id="7603495">{</span><span class="string" id="7603496">&#34;black&#34;</span><span class="op" id="7603503">,</span>&nbsp;<span class="builtintype" id="7603505">false</span><span class="op" id="7603510">}</span><span class="op" id="7603511">,</span>&nbsp;<span class="ident" id="7603513">nil</span><span class="op" id="7603516">}</span><span class="op" id="7603517">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7603520">}</span><span class="op" id="7603521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7603524">nullTestRun</span><span class="op" id="7603535">(</span><span class="ident" id="7603536">t</span><span class="op" id="7603537">,</span>&nbsp;<span class="ident" id="7603539">spec</span><span class="op" id="7603543">)</span><br>
<span class="lineno">750</span><span class="op" id="7603545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7603548">func</span>&nbsp;<span class="ident" id="7603553">TestNullInt64Param</span><span class="op" id="7603571">(</span><span class="ident" id="7603572">t</span>&nbsp;<span class="op" id="7603574">*</span><span class="ident" id="7603575">testing</span><span class="op" id="7603582">.</span><span class="ident" id="7603583">T</span><span class="op" id="7603584">)</span>&nbsp;<span class="op" id="7603586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7603589">spec</span>&nbsp;<span class="op" id="7603594">:=</span>&nbsp;<span class="ident" id="7603597">nullTestSpec</span><span class="op" id="7603609">{</span><span class="string" id="7603610">&#34;nullint64&#34;</span><span class="op" id="7603621">,</span>&nbsp;<span class="string" id="7603623">&#34;int64&#34;</span><span class="op" id="7603630">,</span>&nbsp;<span class="op" id="7603632">[</span><span class="num" id="7603633">6</span><span class="op" id="7603634">]</span><span class="ident" id="7603635">nullTestRow</span><span class="op" id="7603646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7603650">{</span><span class="ident" id="7603651">NullInt64</span><span class="op" id="7603660">{</span><span class="num" id="7603661">31</span><span class="op" id="7603663">,</span>&nbsp;<span class="builtintype" id="7603665">true</span><span class="op" id="7603669">}</span><span class="op" id="7603670">,</span>&nbsp;<span class="num" id="7603672">1</span><span class="op" id="7603673">,</span>&nbsp;<span class="ident" id="7603675">NullInt64</span><span class="op" id="7603684">{</span><span class="num" id="7603685">31</span><span class="op" id="7603687">,</span>&nbsp;<span class="builtintype" id="7603689">true</span><span class="op" id="7603693">}</span><span class="op" id="7603694">}</span><span class="op" id="7603695">,</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7603699">{</span><span class="ident" id="7603700">NullInt64</span><span class="op" id="7603709">{</span><span class="op" id="7603710">-</span><span class="num" id="7603711">22</span><span class="op" id="7603713">,</span>&nbsp;<span class="builtintype" id="7603715">false</span><span class="op" id="7603720">}</span><span class="op" id="7603721">,</span>&nbsp;<span class="num" id="7603723">1</span><span class="op" id="7603724">,</span>&nbsp;<span class="ident" id="7603726">NullInt64</span><span class="op" id="7603735">{</span><span class="num" id="7603736">0</span><span class="op" id="7603737">,</span>&nbsp;<span class="builtintype" id="7603739">false</span><span class="op" id="7603744">}</span><span class="op" id="7603745">}</span><span class="op" id="7603746">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7603750">{</span><span class="num" id="7603751">22</span><span class="op" id="7603753">,</span>&nbsp;<span class="num" id="7603755">1</span><span class="op" id="7603756">,</span>&nbsp;<span class="ident" id="7603758">NullInt64</span><span class="op" id="7603767">{</span><span class="num" id="7603768">22</span><span class="op" id="7603770">,</span>&nbsp;<span class="builtintype" id="7603772">true</span><span class="op" id="7603776">}</span><span class="op" id="7603777">}</span><span class="op" id="7603778">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7603782">{</span><span class="ident" id="7603783">NullInt64</span><span class="op" id="7603792">{</span><span class="num" id="7603793">33</span><span class="op" id="7603795">,</span>&nbsp;<span class="builtintype" id="7603797">true</span><span class="op" id="7603801">}</span><span class="op" id="7603802">,</span>&nbsp;<span class="num" id="7603804">1</span><span class="op" id="7603805">,</span>&nbsp;<span class="ident" id="7603807">NullInt64</span><span class="op" id="7603816">{</span><span class="num" id="7603817">33</span><span class="op" id="7603819">,</span>&nbsp;<span class="builtintype" id="7603821">true</span><span class="op" id="7603825">}</span><span class="op" id="7603826">}</span><span class="op" id="7603827">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7603831">{</span><span class="ident" id="7603832">NullInt64</span><span class="op" id="7603841">{</span><span class="num" id="7603842">222</span><span class="op" id="7603845">,</span>&nbsp;<span class="builtintype" id="7603847">false</span><span class="op" id="7603852">}</span><span class="op" id="7603853">,</span>&nbsp;<span class="num" id="7603855">1</span><span class="op" id="7603856">,</span>&nbsp;<span class="ident" id="7603858">NullInt64</span><span class="op" id="7603867">{</span><span class="num" id="7603868">0</span><span class="op" id="7603869">,</span>&nbsp;<span class="builtintype" id="7603871">false</span><span class="op" id="7603876">}</span><span class="op" id="7603877">}</span><span class="op" id="7603878">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7603882">{</span><span class="num" id="7603883">0</span><span class="op" id="7603884">,</span>&nbsp;<span class="ident" id="7603886">NullInt64</span><span class="op" id="7603895">{</span><span class="num" id="7603896">31</span><span class="op" id="7603898">,</span>&nbsp;<span class="builtintype" id="7603900">false</span><span class="op" id="7603905">}</span><span class="op" id="7603906">,</span>&nbsp;<span class="ident" id="7603908">nil</span><span class="op" id="7603911">}</span><span class="op" id="7603912">,</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7603915">}</span><span class="op" id="7603916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7603919">nullTestRun</span><span class="op" id="7603930">(</span><span class="ident" id="7603931">t</span><span class="op" id="7603932">,</span>&nbsp;<span class="ident" id="7603934">spec</span><span class="op" id="7603938">)</span><br>
<span class="lineno"></span><span class="op" id="7603940">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7603943">func</span>&nbsp;<span class="ident" id="7603948">TestNullFloat64Param</span><span class="op" id="7603968">(</span><span class="ident" id="7603969">t</span>&nbsp;<span class="op" id="7603971">*</span><span class="ident" id="7603972">testing</span><span class="op" id="7603979">.</span><span class="ident" id="7603980">T</span><span class="op" id="7603981">)</span>&nbsp;<span class="op" id="7603983">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7603986">spec</span>&nbsp;<span class="op" id="7603991">:=</span>&nbsp;<span class="ident" id="7603994">nullTestSpec</span><span class="op" id="7604006">{</span><span class="string" id="7604007">&#34;nullfloat64&#34;</span><span class="op" id="7604020">,</span>&nbsp;<span class="string" id="7604022">&#34;float64&#34;</span><span class="op" id="7604031">,</span>&nbsp;<span class="op" id="7604033">[</span><span class="num" id="7604034">6</span><span class="op" id="7604035">]</span><span class="ident" id="7604036">nullTestRow</span><span class="op" id="7604047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7604051">{</span><span class="ident" id="7604052">NullFloat64</span><span class="op" id="7604063">{</span><span class="num" id="7604064">31.2</span><span class="op" id="7604068">,</span>&nbsp;<span class="builtintype" id="7604070">true</span><span class="op" id="7604074">}</span><span class="op" id="7604075">,</span>&nbsp;<span class="num" id="7604077">1</span><span class="op" id="7604078">,</span>&nbsp;<span class="ident" id="7604080">NullFloat64</span><span class="op" id="7604091">{</span><span class="num" id="7604092">31.2</span><span class="op" id="7604096">,</span>&nbsp;<span class="builtintype" id="7604098">true</span><span class="op" id="7604102">}</span><span class="op" id="7604103">}</span><span class="op" id="7604104">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7604108">{</span><span class="ident" id="7604109">NullFloat64</span><span class="op" id="7604120">{</span><span class="num" id="7604121">13.1</span><span class="op" id="7604125">,</span>&nbsp;<span class="builtintype" id="7604127">false</span><span class="op" id="7604132">}</span><span class="op" id="7604133">,</span>&nbsp;<span class="num" id="7604135">1</span><span class="op" id="7604136">,</span>&nbsp;<span class="ident" id="7604138">NullFloat64</span><span class="op" id="7604149">{</span><span class="num" id="7604150">0</span><span class="op" id="7604151">,</span>&nbsp;<span class="builtintype" id="7604153">false</span><span class="op" id="7604158">}</span><span class="op" id="7604159">}</span><span class="op" id="7604160">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7604164">{</span><span class="op" id="7604165">-</span><span class="num" id="7604166">22.9</span><span class="op" id="7604170">,</span>&nbsp;<span class="num" id="7604172">1</span><span class="op" id="7604173">,</span>&nbsp;<span class="ident" id="7604175">NullFloat64</span><span class="op" id="7604186">{</span><span class="op" id="7604187">-</span><span class="num" id="7604188">22.9</span><span class="op" id="7604192">,</span>&nbsp;<span class="builtintype" id="7604194">true</span><span class="op" id="7604198">}</span><span class="op" id="7604199">}</span><span class="op" id="7604200">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7604204">{</span><span class="ident" id="7604205">NullFloat64</span><span class="op" id="7604216">{</span><span class="num" id="7604217">33.81</span><span class="op" id="7604222">,</span>&nbsp;<span class="builtintype" id="7604224">true</span><span class="op" id="7604228">}</span><span class="op" id="7604229">,</span>&nbsp;<span class="num" id="7604231">1</span><span class="op" id="7604232">,</span>&nbsp;<span class="ident" id="7604234">NullFloat64</span><span class="op" id="7604245">{</span><span class="num" id="7604246">33.81</span><span class="op" id="7604251">,</span>&nbsp;<span class="builtintype" id="7604253">true</span><span class="op" id="7604257">}</span><span class="op" id="7604258">}</span><span class="op" id="7604259">,</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7604263">{</span><span class="ident" id="7604264">NullFloat64</span><span class="op" id="7604275">{</span><span class="num" id="7604276">222</span><span class="op" id="7604279">,</span>&nbsp;<span class="builtintype" id="7604281">false</span><span class="op" id="7604286">}</span><span class="op" id="7604287">,</span>&nbsp;<span class="num" id="7604289">1</span><span class="op" id="7604290">,</span>&nbsp;<span class="ident" id="7604292">NullFloat64</span><span class="op" id="7604303">{</span><span class="num" id="7604304">0</span><span class="op" id="7604305">,</span>&nbsp;<span class="builtintype" id="7604307">false</span><span class="op" id="7604312">}</span><span class="op" id="7604313">}</span><span class="op" id="7604314">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7604318">{</span><span class="num" id="7604319">10</span><span class="op" id="7604321">,</span>&nbsp;<span class="ident" id="7604323">NullFloat64</span><span class="op" id="7604334">{</span><span class="num" id="7604335">31.2</span><span class="op" id="7604339">,</span>&nbsp;<span class="builtintype" id="7604341">false</span><span class="op" id="7604346">}</span><span class="op" id="7604347">,</span>&nbsp;<span class="ident" id="7604349">nil</span><span class="op" id="7604352">}</span><span class="op" id="7604353">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7604356">}</span><span class="op" id="7604357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7604360">nullTestRun</span><span class="op" id="7604371">(</span><span class="ident" id="7604372">t</span><span class="op" id="7604373">,</span>&nbsp;<span class="ident" id="7604375">spec</span><span class="op" id="7604379">)</span><br>
<span class="lineno"></span><span class="op" id="7604381">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span><span class="keyword" id="7604384">func</span>&nbsp;<span class="ident" id="7604389">TestNullBoolParam</span><span class="op" id="7604406">(</span><span class="ident" id="7604407">t</span>&nbsp;<span class="op" id="7604409">*</span><span class="ident" id="7604410">testing</span><span class="op" id="7604417">.</span><span class="ident" id="7604418">T</span><span class="op" id="7604419">)</span>&nbsp;<span class="op" id="7604421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7604424">spec</span>&nbsp;<span class="op" id="7604429">:=</span>&nbsp;<span class="ident" id="7604432">nullTestSpec</span><span class="op" id="7604444">{</span><span class="string" id="7604445">&#34;nullbool&#34;</span><span class="op" id="7604455">,</span>&nbsp;<span class="string" id="7604457">&#34;bool&#34;</span><span class="op" id="7604463">,</span>&nbsp;<span class="op" id="7604465">[</span><span class="num" id="7604466">6</span><span class="op" id="7604467">]</span><span class="ident" id="7604468">nullTestRow</span><span class="op" id="7604479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7604483">{</span><span class="ident" id="7604484">NullBool</span><span class="op" id="7604492">{</span><span class="builtintype" id="7604493">false</span><span class="op" id="7604498">,</span>&nbsp;<span class="builtintype" id="7604500">true</span><span class="op" id="7604504">}</span><span class="op" id="7604505">,</span>&nbsp;<span class="builtintype" id="7604507">true</span><span class="op" id="7604511">,</span>&nbsp;<span class="ident" id="7604513">NullBool</span><span class="op" id="7604521">{</span><span class="builtintype" id="7604522">false</span><span class="op" id="7604527">,</span>&nbsp;<span class="builtintype" id="7604529">true</span><span class="op" id="7604533">}</span><span class="op" id="7604534">}</span><span class="op" id="7604535">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7604539">{</span><span class="ident" id="7604540">NullBool</span><span class="op" id="7604548">{</span><span class="builtintype" id="7604549">true</span><span class="op" id="7604553">,</span>&nbsp;<span class="builtintype" id="7604555">false</span><span class="op" id="7604560">}</span><span class="op" id="7604561">,</span>&nbsp;<span class="builtintype" id="7604563">false</span><span class="op" id="7604568">,</span>&nbsp;<span class="ident" id="7604570">NullBool</span><span class="op" id="7604578">{</span><span class="builtintype" id="7604579">false</span><span class="op" id="7604584">,</span>&nbsp;<span class="builtintype" id="7604586">false</span><span class="op" id="7604591">}</span><span class="op" id="7604592">}</span><span class="op" id="7604593">,</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7604597">{</span><span class="builtintype" id="7604598">true</span><span class="op" id="7604602">,</span>&nbsp;<span class="builtintype" id="7604604">true</span><span class="op" id="7604608">,</span>&nbsp;<span class="ident" id="7604610">NullBool</span><span class="op" id="7604618">{</span><span class="builtintype" id="7604619">true</span><span class="op" id="7604623">,</span>&nbsp;<span class="builtintype" id="7604625">true</span><span class="op" id="7604629">}</span><span class="op" id="7604630">}</span><span class="op" id="7604631">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7604635">{</span><span class="ident" id="7604636">NullBool</span><span class="op" id="7604644">{</span><span class="builtintype" id="7604645">true</span><span class="op" id="7604649">,</span>&nbsp;<span class="builtintype" id="7604651">true</span><span class="op" id="7604655">}</span><span class="op" id="7604656">,</span>&nbsp;<span class="builtintype" id="7604658">false</span><span class="op" id="7604663">,</span>&nbsp;<span class="ident" id="7604665">NullBool</span><span class="op" id="7604673">{</span><span class="builtintype" id="7604674">true</span><span class="op" id="7604678">,</span>&nbsp;<span class="builtintype" id="7604680">true</span><span class="op" id="7604684">}</span><span class="op" id="7604685">}</span><span class="op" id="7604686">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7604690">{</span><span class="ident" id="7604691">NullBool</span><span class="op" id="7604699">{</span><span class="builtintype" id="7604700">true</span><span class="op" id="7604704">,</span>&nbsp;<span class="builtintype" id="7604706">false</span><span class="op" id="7604711">}</span><span class="op" id="7604712">,</span>&nbsp;<span class="builtintype" id="7604714">true</span><span class="op" id="7604718">,</span>&nbsp;<span class="ident" id="7604720">NullBool</span><span class="op" id="7604728">{</span><span class="builtintype" id="7604729">false</span><span class="op" id="7604734">,</span>&nbsp;<span class="builtintype" id="7604736">false</span><span class="op" id="7604741">}</span><span class="op" id="7604742">}</span><span class="op" id="7604743">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7604747">{</span><span class="builtintype" id="7604748">true</span><span class="op" id="7604752">,</span>&nbsp;<span class="ident" id="7604754">NullBool</span><span class="op" id="7604762">{</span><span class="builtintype" id="7604763">true</span><span class="op" id="7604767">,</span>&nbsp;<span class="builtintype" id="7604769">false</span><span class="op" id="7604774">}</span><span class="op" id="7604775">,</span>&nbsp;<span class="ident" id="7604777">nil</span><span class="op" id="7604780">}</span><span class="op" id="7604781">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7604784">}</span><span class="op" id="7604785">}</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7604788">nullTestRun</span><span class="op" id="7604799">(</span><span class="ident" id="7604800">t</span><span class="op" id="7604801">,</span>&nbsp;<span class="ident" id="7604803">spec</span><span class="op" id="7604807">)</span><br>
<span class="lineno"></span><span class="op" id="7604809">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7604812">func</span>&nbsp;<span class="ident" id="7604817">nullTestRun</span><span class="op" id="7604828">(</span><span class="ident" id="7604829">t</span>&nbsp;<span class="op" id="7604831">*</span><span class="ident" id="7604832">testing</span><span class="op" id="7604839">.</span><span class="ident" id="7604840">T</span><span class="op" id="7604841">,</span>&nbsp;<span class="ident" id="7604843">spec</span>&nbsp;<span class="ident" id="7604848">nullTestSpec</span><span class="op" id="7604860">)</span>&nbsp;<span class="op" id="7604862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7604865">db</span>&nbsp;<span class="op" id="7604868">:=</span>&nbsp;<span class="ident" id="7604871">newTestDB</span><span class="op" id="7604880">(</span><span class="ident" id="7604881">t</span><span class="op" id="7604882">,</span>&nbsp;<span class="string" id="7604884">&#34;&#34;</span><span class="op" id="7604886">)</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7604889">defer</span>&nbsp;<span class="ident" id="7604895">closeDB</span><span class="op" id="7604902">(</span><span class="ident" id="7604903">t</span><span class="op" id="7604904">,</span>&nbsp;<span class="ident" id="7604906">db</span><span class="op" id="7604908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7604911">exec</span><span class="op" id="7604915">(</span><span class="ident" id="7604916">t</span><span class="op" id="7604917">,</span>&nbsp;<span class="ident" id="7604919">db</span><span class="op" id="7604921">,</span>&nbsp;<span class="ident" id="7604923">fmt</span><span class="op" id="7604926">.</span><span class="ident" id="7604927">Sprintf</span><span class="op" id="7604934">(</span><span class="string" id="7604935">&#34;CREATE|t|id=int32,name=string,nullf=%s,notnullf=%s&#34;</span><span class="op" id="7604987">,</span>&nbsp;<span class="ident" id="7604989">spec</span><span class="op" id="7604993">.</span><span class="ident" id="7604994">nullType</span><span class="op" id="7605002">,</span>&nbsp;<span class="ident" id="7605004">spec</span><span class="op" id="7605008">.</span><span class="ident" id="7605009">notNullType</span><span class="op" id="7605020">)</span><span class="op" id="7605021">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7605025">//&nbsp;Inserts&nbsp;with&nbsp;db.Exec:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7605051">exec</span><span class="op" id="7605055">(</span><span class="ident" id="7605056">t</span><span class="op" id="7605057">,</span>&nbsp;<span class="ident" id="7605059">db</span><span class="op" id="7605061">,</span>&nbsp;<span class="string" id="7605063">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="7605104">,</span>&nbsp;<span class="num" id="7605106">1</span><span class="op" id="7605107">,</span>&nbsp;<span class="string" id="7605109">&#34;alice&#34;</span><span class="op" id="7605116">,</span>&nbsp;<span class="ident" id="7605118">spec</span><span class="op" id="7605122">.</span><span class="ident" id="7605123">rows</span><span class="op" id="7605127">[</span><span class="num" id="7605128">0</span><span class="op" id="7605129">]</span><span class="op" id="7605130">.</span><span class="ident" id="7605131">nullParam</span><span class="op" id="7605140">,</span>&nbsp;<span class="ident" id="7605142">spec</span><span class="op" id="7605146">.</span><span class="ident" id="7605147">rows</span><span class="op" id="7605151">[</span><span class="num" id="7605152">0</span><span class="op" id="7605153">]</span><span class="op" id="7605154">.</span><span class="ident" id="7605155">notNullParam</span><span class="op" id="7605167">)</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7605170">exec</span><span class="op" id="7605174">(</span><span class="ident" id="7605175">t</span><span class="op" id="7605176">,</span>&nbsp;<span class="ident" id="7605178">db</span><span class="op" id="7605180">,</span>&nbsp;<span class="string" id="7605182">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="7605223">,</span>&nbsp;<span class="num" id="7605225">2</span><span class="op" id="7605226">,</span>&nbsp;<span class="string" id="7605228">&#34;bob&#34;</span><span class="op" id="7605233">,</span>&nbsp;<span class="ident" id="7605235">spec</span><span class="op" id="7605239">.</span><span class="ident" id="7605240">rows</span><span class="op" id="7605244">[</span><span class="num" id="7605245">1</span><span class="op" id="7605246">]</span><span class="op" id="7605247">.</span><span class="ident" id="7605248">nullParam</span><span class="op" id="7605257">,</span>&nbsp;<span class="ident" id="7605259">spec</span><span class="op" id="7605263">.</span><span class="ident" id="7605264">rows</span><span class="op" id="7605268">[</span><span class="num" id="7605269">1</span><span class="op" id="7605270">]</span><span class="op" id="7605271">.</span><span class="ident" id="7605272">notNullParam</span><span class="op" id="7605284">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7605288">//&nbsp;Inserts&nbsp;with&nbsp;a&nbsp;prepared&nbsp;statement:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7605327">stmt</span><span class="op" id="7605331">,</span>&nbsp;<span class="ident" id="7605333">err</span>&nbsp;<span class="op" id="7605337">:=</span>&nbsp;<span class="ident" id="7605340">db</span><span class="op" id="7605342">.</span><span class="ident" id="7605343">Prepare</span><span class="op" id="7605350">(</span><span class="string" id="7605351">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="7605392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7605395">if</span>&nbsp;<span class="ident" id="7605398">err</span>&nbsp;<span class="op" id="7605402">!=</span>&nbsp;<span class="ident" id="7605405">nil</span>&nbsp;<span class="op" id="7605409">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7605413">t</span><span class="op" id="7605414">.</span><span class="ident" id="7605415">Fatalf</span><span class="op" id="7605421">(</span><span class="string" id="7605422">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="7605435">,</span>&nbsp;<span class="ident" id="7605437">err</span><span class="op" id="7605440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7605443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7605446">defer</span>&nbsp;<span class="ident" id="7605452">stmt</span><span class="op" id="7605456">.</span><span class="ident" id="7605457">Close</span><span class="op" id="7605462">(</span><span class="op" id="7605463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7605466">if</span>&nbsp;<span class="ident" id="7605469">_</span><span class="op" id="7605470">,</span>&nbsp;<span class="ident" id="7605472">err</span>&nbsp;<span class="op" id="7605476">:=</span>&nbsp;<span class="ident" id="7605479">stmt</span><span class="op" id="7605483">.</span><span class="ident" id="7605484">Exec</span><span class="op" id="7605488">(</span><span class="num" id="7605489">3</span><span class="op" id="7605490">,</span>&nbsp;<span class="string" id="7605492">&#34;chris&#34;</span><span class="op" id="7605499">,</span>&nbsp;<span class="ident" id="7605501">spec</span><span class="op" id="7605505">.</span><span class="ident" id="7605506">rows</span><span class="op" id="7605510">[</span><span class="num" id="7605511">2</span><span class="op" id="7605512">]</span><span class="op" id="7605513">.</span><span class="ident" id="7605514">nullParam</span><span class="op" id="7605523">,</span>&nbsp;<span class="ident" id="7605525">spec</span><span class="op" id="7605529">.</span><span class="ident" id="7605530">rows</span><span class="op" id="7605534">[</span><span class="num" id="7605535">2</span><span class="op" id="7605536">]</span><span class="op" id="7605537">.</span><span class="ident" id="7605538">notNullParam</span><span class="op" id="7605550">)</span><span class="op" id="7605551">;</span>&nbsp;<span class="ident" id="7605553">err</span>&nbsp;<span class="op" id="7605557">!=</span>&nbsp;<span class="ident" id="7605560">nil</span>&nbsp;<span class="op" id="7605564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7605568">t</span><span class="op" id="7605569">.</span><span class="ident" id="7605570">Errorf</span><span class="op" id="7605576">(</span><span class="string" id="7605577">&#34;exec&nbsp;insert&nbsp;chris:&nbsp;%v&#34;</span><span class="op" id="7605600">,</span>&nbsp;<span class="ident" id="7605602">err</span><span class="op" id="7605605">)</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7605608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7605611">if</span>&nbsp;<span class="ident" id="7605614">_</span><span class="op" id="7605615">,</span>&nbsp;<span class="ident" id="7605617">err</span>&nbsp;<span class="op" id="7605621">:=</span>&nbsp;<span class="ident" id="7605624">stmt</span><span class="op" id="7605628">.</span><span class="ident" id="7605629">Exec</span><span class="op" id="7605633">(</span><span class="num" id="7605634">4</span><span class="op" id="7605635">,</span>&nbsp;<span class="string" id="7605637">&#34;dave&#34;</span><span class="op" id="7605643">,</span>&nbsp;<span class="ident" id="7605645">spec</span><span class="op" id="7605649">.</span><span class="ident" id="7605650">rows</span><span class="op" id="7605654">[</span><span class="num" id="7605655">3</span><span class="op" id="7605656">]</span><span class="op" id="7605657">.</span><span class="ident" id="7605658">nullParam</span><span class="op" id="7605667">,</span>&nbsp;<span class="ident" id="7605669">spec</span><span class="op" id="7605673">.</span><span class="ident" id="7605674">rows</span><span class="op" id="7605678">[</span><span class="num" id="7605679">3</span><span class="op" id="7605680">]</span><span class="op" id="7605681">.</span><span class="ident" id="7605682">notNullParam</span><span class="op" id="7605694">)</span><span class="op" id="7605695">;</span>&nbsp;<span class="ident" id="7605697">err</span>&nbsp;<span class="op" id="7605701">!=</span>&nbsp;<span class="ident" id="7605704">nil</span>&nbsp;<span class="op" id="7605708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7605712">t</span><span class="op" id="7605713">.</span><span class="ident" id="7605714">Errorf</span><span class="op" id="7605720">(</span><span class="string" id="7605721">&#34;exec&nbsp;insert&nbsp;dave:&nbsp;%v&#34;</span><span class="op" id="7605743">,</span>&nbsp;<span class="ident" id="7605745">err</span><span class="op" id="7605748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7605751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7605754">if</span>&nbsp;<span class="ident" id="7605757">_</span><span class="op" id="7605758">,</span>&nbsp;<span class="ident" id="7605760">err</span>&nbsp;<span class="op" id="7605764">:=</span>&nbsp;<span class="ident" id="7605767">stmt</span><span class="op" id="7605771">.</span><span class="ident" id="7605772">Exec</span><span class="op" id="7605776">(</span><span class="num" id="7605777">5</span><span class="op" id="7605778">,</span>&nbsp;<span class="string" id="7605780">&#34;eleanor&#34;</span><span class="op" id="7605789">,</span>&nbsp;<span class="ident" id="7605791">spec</span><span class="op" id="7605795">.</span><span class="ident" id="7605796">rows</span><span class="op" id="7605800">[</span><span class="num" id="7605801">4</span><span class="op" id="7605802">]</span><span class="op" id="7605803">.</span><span class="ident" id="7605804">nullParam</span><span class="op" id="7605813">,</span>&nbsp;<span class="ident" id="7605815">spec</span><span class="op" id="7605819">.</span><span class="ident" id="7605820">rows</span><span class="op" id="7605824">[</span><span class="num" id="7605825">4</span><span class="op" id="7605826">]</span><span class="op" id="7605827">.</span><span class="ident" id="7605828">notNullParam</span><span class="op" id="7605840">)</span><span class="op" id="7605841">;</span>&nbsp;<span class="ident" id="7605843">err</span>&nbsp;<span class="op" id="7605847">!=</span>&nbsp;<span class="ident" id="7605850">nil</span>&nbsp;<span class="op" id="7605854">{</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7605858">t</span><span class="op" id="7605859">.</span><span class="ident" id="7605860">Errorf</span><span class="op" id="7605866">(</span><span class="string" id="7605867">&#34;exec&nbsp;insert&nbsp;eleanor:&nbsp;%v&#34;</span><span class="op" id="7605892">,</span>&nbsp;<span class="ident" id="7605894">err</span><span class="op" id="7605897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7605900">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7605904">//&nbsp;Can&#39;t&nbsp;put&nbsp;null&nbsp;val&nbsp;into&nbsp;non-null&nbsp;col</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7605945">if</span>&nbsp;<span class="ident" id="7605948">_</span><span class="op" id="7605949">,</span>&nbsp;<span class="ident" id="7605951">err</span>&nbsp;<span class="op" id="7605955">:=</span>&nbsp;<span class="ident" id="7605958">stmt</span><span class="op" id="7605962">.</span><span class="ident" id="7605963">Exec</span><span class="op" id="7605967">(</span><span class="num" id="7605968">6</span><span class="op" id="7605969">,</span>&nbsp;<span class="string" id="7605971">&#34;bob&#34;</span><span class="op" id="7605976">,</span>&nbsp;<span class="ident" id="7605978">spec</span><span class="op" id="7605982">.</span><span class="ident" id="7605983">rows</span><span class="op" id="7605987">[</span><span class="num" id="7605988">5</span><span class="op" id="7605989">]</span><span class="op" id="7605990">.</span><span class="ident" id="7605991">nullParam</span><span class="op" id="7606000">,</span>&nbsp;<span class="ident" id="7606002">spec</span><span class="op" id="7606006">.</span><span class="ident" id="7606007">rows</span><span class="op" id="7606011">[</span><span class="num" id="7606012">5</span><span class="op" id="7606013">]</span><span class="op" id="7606014">.</span><span class="ident" id="7606015">notNullParam</span><span class="op" id="7606027">)</span><span class="op" id="7606028">;</span>&nbsp;<span class="ident" id="7606030">err</span>&nbsp;<span class="op" id="7606034">==</span>&nbsp;<span class="ident" id="7606037">nil</span>&nbsp;<span class="op" id="7606041">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7606045">t</span><span class="op" id="7606046">.</span><span class="ident" id="7606047">Errorf</span><span class="op" id="7606053">(</span><span class="string" id="7606054">&#34;expected&nbsp;error&nbsp;inserting&nbsp;nil&nbsp;val&nbsp;with&nbsp;prepared&nbsp;statement&nbsp;Exec&#34;</span><span class="op" id="7606117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7606120">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7606124">_</span><span class="op" id="7606125">,</span>&nbsp;<span class="ident" id="7606127">err</span>&nbsp;<span class="op" id="7606131">=</span>&nbsp;<span class="ident" id="7606133">db</span><span class="op" id="7606135">.</span><span class="ident" id="7606136">Exec</span><span class="op" id="7606140">(</span><span class="string" id="7606141">&#34;INSERT|t|id=?,name=?,nullf=?&#34;</span><span class="op" id="7606171">,</span>&nbsp;<span class="num" id="7606173">999</span><span class="op" id="7606176">,</span>&nbsp;<span class="ident" id="7606178">nil</span><span class="op" id="7606181">,</span>&nbsp;<span class="ident" id="7606183">nil</span><span class="op" id="7606186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7606189">if</span>&nbsp;<span class="ident" id="7606192">err</span>&nbsp;<span class="op" id="7606196">==</span>&nbsp;<span class="ident" id="7606199">nil</span>&nbsp;<span class="op" id="7606203">{</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7606207">//&nbsp;TODO:&nbsp;this&nbsp;test&nbsp;fails,&nbsp;but&nbsp;it&#39;s&nbsp;just&nbsp;because</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7606257">//&nbsp;fakeConn&nbsp;implements&nbsp;the&nbsp;optional&nbsp;Execer&nbsp;interface,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7606313">//&nbsp;so&nbsp;arguably&nbsp;this&nbsp;is&nbsp;the&nbsp;correct&nbsp;behavior.&nbsp;&nbsp;But</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7606365">//&nbsp;maybe&nbsp;I&nbsp;should&nbsp;flesh&nbsp;out&nbsp;the&nbsp;fakeConn.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7606413">//&nbsp;implementation&nbsp;so&nbsp;this&nbsp;properly&nbsp;fails.</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7606457">//&nbsp;t.Errorf(&#34;expected&nbsp;error&nbsp;inserting&nbsp;nil&nbsp;name&nbsp;with&nbsp;Exec&#34;)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7606517">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7606521">paramtype</span>&nbsp;<span class="op" id="7606531">:=</span>&nbsp;<span class="ident" id="7606534">reflect</span><span class="op" id="7606541">.</span><span class="ident" id="7606542">TypeOf</span><span class="op" id="7606548">(</span><span class="ident" id="7606549">spec</span><span class="op" id="7606553">.</span><span class="ident" id="7606554">rows</span><span class="op" id="7606558">[</span><span class="num" id="7606559">0</span><span class="op" id="7606560">]</span><span class="op" id="7606561">.</span><span class="ident" id="7606562">nullParam</span><span class="op" id="7606571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7606574">bindVal</span>&nbsp;<span class="op" id="7606582">:=</span>&nbsp;<span class="ident" id="7606585">reflect</span><span class="op" id="7606592">.</span><span class="ident" id="7606593">New</span><span class="op" id="7606596">(</span><span class="ident" id="7606597">paramtype</span><span class="op" id="7606606">)</span><span class="op" id="7606607">.</span><span class="ident" id="7606608">Interface</span><span class="op" id="7606617">(</span><span class="op" id="7606618">)</span><br>
<span class="lineno">830</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7606622">for</span>&nbsp;<span class="ident" id="7606626">i</span>&nbsp;<span class="op" id="7606628">:=</span>&nbsp;<span class="num" id="7606631">0</span><span class="op" id="7606632">;</span>&nbsp;<span class="ident" id="7606634">i</span>&nbsp;<span class="op" id="7606636">&lt;</span>&nbsp;<span class="num" id="7606638">5</span><span class="op" id="7606639">;</span>&nbsp;<span class="ident" id="7606641">i</span><span class="op" id="7606642">++</span>&nbsp;<span class="op" id="7606645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7606649">id</span>&nbsp;<span class="op" id="7606652">:=</span>&nbsp;<span class="ident" id="7606655">i</span>&nbsp;<span class="op" id="7606657">+</span>&nbsp;<span class="num" id="7606659">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7606663">if</span>&nbsp;<span class="ident" id="7606666">err</span>&nbsp;<span class="op" id="7606670">:=</span>&nbsp;<span class="ident" id="7606673">db</span><span class="op" id="7606675">.</span><span class="ident" id="7606676">QueryRow</span><span class="op" id="7606684">(</span><span class="string" id="7606685">&#34;SELECT|t|nullf|id=?&#34;</span><span class="op" id="7606706">,</span>&nbsp;<span class="ident" id="7606708">id</span><span class="op" id="7606710">)</span><span class="op" id="7606711">.</span><span class="ident" id="7606712">Scan</span><span class="op" id="7606716">(</span><span class="ident" id="7606717">bindVal</span><span class="op" id="7606724">)</span><span class="op" id="7606725">;</span>&nbsp;<span class="ident" id="7606727">err</span>&nbsp;<span class="op" id="7606731">!=</span>&nbsp;<span class="ident" id="7606734">nil</span>&nbsp;<span class="op" id="7606738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7606743">t</span><span class="op" id="7606744">.</span><span class="ident" id="7606745">Errorf</span><span class="op" id="7606751">(</span><span class="string" id="7606752">&#34;id=%d&nbsp;Scan:&nbsp;%v&#34;</span><span class="op" id="7606768">,</span>&nbsp;<span class="ident" id="7606770">id</span><span class="op" id="7606772">,</span>&nbsp;<span class="ident" id="7606774">err</span><span class="op" id="7606777">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7606781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7606785">bindValDeref</span>&nbsp;<span class="op" id="7606798">:=</span>&nbsp;<span class="ident" id="7606801">reflect</span><span class="op" id="7606808">.</span><span class="ident" id="7606809">ValueOf</span><span class="op" id="7606816">(</span><span class="ident" id="7606817">bindVal</span><span class="op" id="7606824">)</span><span class="op" id="7606825">.</span><span class="ident" id="7606826">Elem</span><span class="op" id="7606830">(</span><span class="op" id="7606831">)</span><span class="op" id="7606832">.</span><span class="ident" id="7606833">Interface</span><span class="op" id="7606842">(</span><span class="op" id="7606843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7606847">if</span>&nbsp;<span class="op" id="7606850">!</span><span class="ident" id="7606851">reflect</span><span class="op" id="7606858">.</span><span class="ident" id="7606859">DeepEqual</span><span class="op" id="7606868">(</span><span class="ident" id="7606869">bindValDeref</span><span class="op" id="7606881">,</span>&nbsp;<span class="ident" id="7606883">spec</span><span class="op" id="7606887">.</span><span class="ident" id="7606888">rows</span><span class="op" id="7606892">[</span><span class="ident" id="7606893">i</span><span class="op" id="7606894">]</span><span class="op" id="7606895">.</span><span class="ident" id="7606896">scanNullVal</span><span class="op" id="7606907">)</span>&nbsp;<span class="op" id="7606909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7606914">t</span><span class="op" id="7606915">.</span><span class="ident" id="7606916">Errorf</span><span class="op" id="7606922">(</span><span class="string" id="7606923">&#34;id=%d&nbsp;got&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="7606948">,</span>&nbsp;<span class="ident" id="7606950">id</span><span class="op" id="7606952">,</span>&nbsp;<span class="ident" id="7606954">bindValDeref</span><span class="op" id="7606966">,</span>&nbsp;<span class="ident" id="7606968">spec</span><span class="op" id="7606972">.</span><span class="ident" id="7606973">rows</span><span class="op" id="7606977">[</span><span class="ident" id="7606978">i</span><span class="op" id="7606979">]</span><span class="op" id="7606980">.</span><span class="ident" id="7606981">scanNullVal</span><span class="op" id="7606992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7606996">}</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7606999">}</span><br>
<span class="lineno"></span><span class="op" id="7607001">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7607004">//&nbsp;golang.org/issue/4859</span><br>
<span class="lineno"></span><span class="keyword" id="7607029">func</span>&nbsp;<span class="ident" id="7607034">TestQueryRowNilScanDest</span><span class="op" id="7607057">(</span><span class="ident" id="7607058">t</span>&nbsp;<span class="op" id="7607060">*</span><span class="ident" id="7607061">testing</span><span class="op" id="7607068">.</span><span class="ident" id="7607069">T</span><span class="op" id="7607070">)</span>&nbsp;<span class="op" id="7607072">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7607075">db</span>&nbsp;<span class="op" id="7607078">:=</span>&nbsp;<span class="ident" id="7607081">newTestDB</span><span class="op" id="7607090">(</span><span class="ident" id="7607091">t</span><span class="op" id="7607092">,</span>&nbsp;<span class="string" id="7607094">&#34;people&#34;</span><span class="op" id="7607102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7607105">defer</span>&nbsp;<span class="ident" id="7607111">closeDB</span><span class="op" id="7607118">(</span><span class="ident" id="7607119">t</span><span class="op" id="7607120">,</span>&nbsp;<span class="ident" id="7607122">db</span><span class="op" id="7607124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7607127">var</span>&nbsp;<span class="ident" id="7607131">name</span>&nbsp;<span class="op" id="7607136">*</span><span class="builtintype" id="7607137">string</span>&nbsp;<span class="comment" id="7607144">//&nbsp;nil&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7607160">err</span>&nbsp;<span class="op" id="7607164">:=</span>&nbsp;<span class="ident" id="7607167">db</span><span class="op" id="7607169">.</span><span class="ident" id="7607170">QueryRow</span><span class="op" id="7607178">(</span><span class="string" id="7607179">&#34;SELECT|people|name|&#34;</span><span class="op" id="7607200">)</span><span class="op" id="7607201">.</span><span class="ident" id="7607202">Scan</span><span class="op" id="7607206">(</span><span class="ident" id="7607207">name</span><span class="op" id="7607211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7607214">want</span>&nbsp;<span class="op" id="7607219">:=</span>&nbsp;<span class="string" id="7607222">&#34;sql:&nbsp;Scan&nbsp;error&nbsp;on&nbsp;column&nbsp;index&nbsp;0:&nbsp;destination&nbsp;pointer&nbsp;is&nbsp;nil&#34;</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7607287">if</span>&nbsp;<span class="ident" id="7607290">err</span>&nbsp;<span class="op" id="7607294">==</span>&nbsp;<span class="ident" id="7607297">nil</span>&nbsp;<span class="op" id="7607301">||</span>&nbsp;<span class="ident" id="7607304">err</span><span class="op" id="7607307">.</span><span class="ident" id="7607308">Error</span><span class="op" id="7607313">(</span><span class="op" id="7607314">)</span>&nbsp;<span class="op" id="7607316">!=</span>&nbsp;<span class="ident" id="7607319">want</span>&nbsp;<span class="op" id="7607324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7607328">t</span><span class="op" id="7607329">.</span><span class="ident" id="7607330">Errorf</span><span class="op" id="7607336">(</span><span class="string" id="7607337">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7607358">,</span>&nbsp;<span class="ident" id="7607360">err</span><span class="op" id="7607363">.</span><span class="ident" id="7607364">Error</span><span class="op" id="7607369">(</span><span class="op" id="7607370">)</span><span class="op" id="7607371">,</span>&nbsp;<span class="ident" id="7607373">want</span><span class="op" id="7607377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7607380">}</span><br>
<span class="lineno"></span><span class="op" id="7607382">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">855</span><span class="keyword" id="7607385">func</span>&nbsp;<span class="ident" id="7607390">TestIssue4902</span><span class="op" id="7607403">(</span><span class="ident" id="7607404">t</span>&nbsp;<span class="op" id="7607406">*</span><span class="ident" id="7607407">testing</span><span class="op" id="7607414">.</span><span class="ident" id="7607415">T</span><span class="op" id="7607416">)</span>&nbsp;<span class="op" id="7607418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7607421">db</span>&nbsp;<span class="op" id="7607424">:=</span>&nbsp;<span class="ident" id="7607427">newTestDB</span><span class="op" id="7607436">(</span><span class="ident" id="7607437">t</span><span class="op" id="7607438">,</span>&nbsp;<span class="string" id="7607440">&#34;people&#34;</span><span class="op" id="7607448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7607451">defer</span>&nbsp;<span class="ident" id="7607457">closeDB</span><span class="op" id="7607464">(</span><span class="ident" id="7607465">t</span><span class="op" id="7607466">,</span>&nbsp;<span class="ident" id="7607468">db</span><span class="op" id="7607470">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7607474">driver</span>&nbsp;<span class="op" id="7607481">:=</span>&nbsp;<span class="ident" id="7607484">db</span><span class="op" id="7607486">.</span><span class="ident" id="7607487">driver</span><span class="op" id="7607493">.</span><span class="op" id="7607494">(</span><span class="op" id="7607495">*</span><span class="ident" id="7607496">fakeDriver</span><span class="op" id="7607506">)</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7607509">opens0</span>&nbsp;<span class="op" id="7607516">:=</span>&nbsp;<span class="ident" id="7607519">driver</span><span class="op" id="7607525">.</span><span class="ident" id="7607526">openCount</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7607538">var</span>&nbsp;<span class="ident" id="7607542">stmt</span>&nbsp;<span class="op" id="7607547">*</span><span class="ident" id="7607548">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7607554">var</span>&nbsp;<span class="ident" id="7607558">err</span>&nbsp;<span class="builtintype" id="7607562">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7607569">for</span>&nbsp;<span class="ident" id="7607573">i</span>&nbsp;<span class="op" id="7607575">:=</span>&nbsp;<span class="num" id="7607578">0</span><span class="op" id="7607579">;</span>&nbsp;<span class="ident" id="7607581">i</span>&nbsp;<span class="op" id="7607583">&lt;</span>&nbsp;<span class="num" id="7607585">10</span><span class="op" id="7607587">;</span>&nbsp;<span class="ident" id="7607589">i</span><span class="op" id="7607590">++</span>&nbsp;<span class="op" id="7607593">{</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7607597">stmt</span><span class="op" id="7607601">,</span>&nbsp;<span class="ident" id="7607603">err</span>&nbsp;<span class="op" id="7607607">=</span>&nbsp;<span class="ident" id="7607609">db</span><span class="op" id="7607611">.</span><span class="ident" id="7607612">Prepare</span><span class="op" id="7607619">(</span><span class="string" id="7607620">&#34;SELECT|people|name|&#34;</span><span class="op" id="7607641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7607645">if</span>&nbsp;<span class="ident" id="7607648">err</span>&nbsp;<span class="op" id="7607652">!=</span>&nbsp;<span class="ident" id="7607655">nil</span>&nbsp;<span class="op" id="7607659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7607664">t</span><span class="op" id="7607665">.</span><span class="ident" id="7607666">Fatal</span><span class="op" id="7607671">(</span><span class="ident" id="7607672">err</span><span class="op" id="7607675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7607679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7607683">err</span>&nbsp;<span class="op" id="7607687">=</span>&nbsp;<span class="ident" id="7607689">stmt</span><span class="op" id="7607693">.</span><span class="ident" id="7607694">Close</span><span class="op" id="7607699">(</span><span class="op" id="7607700">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7607704">if</span>&nbsp;<span class="ident" id="7607707">err</span>&nbsp;<span class="op" id="7607711">!=</span>&nbsp;<span class="ident" id="7607714">nil</span>&nbsp;<span class="op" id="7607718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7607723">t</span><span class="op" id="7607724">.</span><span class="ident" id="7607725">Fatal</span><span class="op" id="7607730">(</span><span class="ident" id="7607731">err</span><span class="op" id="7607734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7607738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7607741">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7607745">opens</span>&nbsp;<span class="op" id="7607751">:=</span>&nbsp;<span class="ident" id="7607754">driver</span><span class="op" id="7607760">.</span><span class="ident" id="7607761">openCount</span>&nbsp;<span class="op" id="7607771">-</span>&nbsp;<span class="ident" id="7607773">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7607781">if</span>&nbsp;<span class="ident" id="7607784">opens</span>&nbsp;<span class="op" id="7607790">&gt;</span>&nbsp;<span class="num" id="7607792">1</span>&nbsp;<span class="op" id="7607794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7607798">t</span><span class="op" id="7607799">.</span><span class="ident" id="7607800">Errorf</span><span class="op" id="7607806">(</span><span class="string" id="7607807">&#34;opens&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;1&#34;</span><span class="op" id="7607830">,</span>&nbsp;<span class="ident" id="7607832">opens</span><span class="op" id="7607837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7607841">t</span><span class="op" id="7607842">.</span><span class="ident" id="7607843">Logf</span><span class="op" id="7607847">(</span><span class="string" id="7607848">&#34;db&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="7607858">,</span>&nbsp;<span class="ident" id="7607860">db</span><span class="op" id="7607862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7607866">t</span><span class="op" id="7607867">.</span><span class="ident" id="7607868">Logf</span><span class="op" id="7607872">(</span><span class="string" id="7607873">&#34;driver&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="7607887">,</span>&nbsp;<span class="ident" id="7607889">driver</span><span class="op" id="7607895">)</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7607899">t</span><span class="op" id="7607900">.</span><span class="ident" id="7607901">Logf</span><span class="op" id="7607905">(</span><span class="string" id="7607906">&#34;stmt&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="7607918">,</span>&nbsp;<span class="ident" id="7607920">stmt</span><span class="op" id="7607924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7607927">}</span><br>
<span class="lineno"></span><span class="op" id="7607929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7607932">//&nbsp;Issue&nbsp;3857</span><br>
<span class="lineno">885</span><span class="comment" id="7607946">//&nbsp;This&nbsp;used&nbsp;to&nbsp;deadlock.</span><br>
<span class="lineno"></span><span class="keyword" id="7607972">func</span>&nbsp;<span class="ident" id="7607977">TestSimultaneousQueries</span><span class="op" id="7608000">(</span><span class="ident" id="7608001">t</span>&nbsp;<span class="op" id="7608003">*</span><span class="ident" id="7608004">testing</span><span class="op" id="7608011">.</span><span class="ident" id="7608012">T</span><span class="op" id="7608013">)</span>&nbsp;<span class="op" id="7608015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7608018">db</span>&nbsp;<span class="op" id="7608021">:=</span>&nbsp;<span class="ident" id="7608024">newTestDB</span><span class="op" id="7608033">(</span><span class="ident" id="7608034">t</span><span class="op" id="7608035">,</span>&nbsp;<span class="string" id="7608037">&#34;people&#34;</span><span class="op" id="7608045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7608048">defer</span>&nbsp;<span class="ident" id="7608054">closeDB</span><span class="op" id="7608061">(</span><span class="ident" id="7608062">t</span><span class="op" id="7608063">,</span>&nbsp;<span class="ident" id="7608065">db</span><span class="op" id="7608067">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7608071">tx</span><span class="op" id="7608073">,</span>&nbsp;<span class="ident" id="7608075">err</span>&nbsp;<span class="op" id="7608079">:=</span>&nbsp;<span class="ident" id="7608082">db</span><span class="op" id="7608084">.</span><span class="ident" id="7608085">Begin</span><span class="op" id="7608090">(</span><span class="op" id="7608091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7608094">if</span>&nbsp;<span class="ident" id="7608097">err</span>&nbsp;<span class="op" id="7608101">!=</span>&nbsp;<span class="ident" id="7608104">nil</span>&nbsp;<span class="op" id="7608108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7608112">t</span><span class="op" id="7608113">.</span><span class="ident" id="7608114">Fatal</span><span class="op" id="7608119">(</span><span class="ident" id="7608120">err</span><span class="op" id="7608123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7608126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7608129">defer</span>&nbsp;<span class="ident" id="7608135">tx</span><span class="op" id="7608137">.</span><span class="ident" id="7608138">Rollback</span><span class="op" id="7608146">(</span><span class="op" id="7608147">)</span><br>
<span class="lineno">895</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7608151">r1</span><span class="op" id="7608153">,</span>&nbsp;<span class="ident" id="7608155">err</span>&nbsp;<span class="op" id="7608159">:=</span>&nbsp;<span class="ident" id="7608162">tx</span><span class="op" id="7608164">.</span><span class="ident" id="7608165">Query</span><span class="op" id="7608170">(</span><span class="string" id="7608171">&#34;SELECT|people|name|&#34;</span><span class="op" id="7608192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7608195">if</span>&nbsp;<span class="ident" id="7608198">err</span>&nbsp;<span class="op" id="7608202">!=</span>&nbsp;<span class="ident" id="7608205">nil</span>&nbsp;<span class="op" id="7608209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7608213">t</span><span class="op" id="7608214">.</span><span class="ident" id="7608215">Fatal</span><span class="op" id="7608220">(</span><span class="ident" id="7608221">err</span><span class="op" id="7608224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7608227">}</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7608230">defer</span>&nbsp;<span class="ident" id="7608236">r1</span><span class="op" id="7608238">.</span><span class="ident" id="7608239">Close</span><span class="op" id="7608244">(</span><span class="op" id="7608245">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7608249">r2</span><span class="op" id="7608251">,</span>&nbsp;<span class="ident" id="7608253">err</span>&nbsp;<span class="op" id="7608257">:=</span>&nbsp;<span class="ident" id="7608260">tx</span><span class="op" id="7608262">.</span><span class="ident" id="7608263">Query</span><span class="op" id="7608268">(</span><span class="string" id="7608269">&#34;SELECT|people|name|&#34;</span><span class="op" id="7608290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7608293">if</span>&nbsp;<span class="ident" id="7608296">err</span>&nbsp;<span class="op" id="7608300">!=</span>&nbsp;<span class="ident" id="7608303">nil</span>&nbsp;<span class="op" id="7608307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7608311">t</span><span class="op" id="7608312">.</span><span class="ident" id="7608313">Fatal</span><span class="op" id="7608318">(</span><span class="ident" id="7608319">err</span><span class="op" id="7608322">)</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7608325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7608328">defer</span>&nbsp;<span class="ident" id="7608334">r2</span><span class="op" id="7608336">.</span><span class="ident" id="7608337">Close</span><span class="op" id="7608342">(</span><span class="op" id="7608343">)</span><br>
<span class="lineno"></span><span class="op" id="7608345">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7608348">func</span>&nbsp;<span class="ident" id="7608353">TestMaxIdleConns</span><span class="op" id="7608369">(</span><span class="ident" id="7608370">t</span>&nbsp;<span class="op" id="7608372">*</span><span class="ident" id="7608373">testing</span><span class="op" id="7608380">.</span><span class="ident" id="7608381">T</span><span class="op" id="7608382">)</span>&nbsp;<span class="op" id="7608384">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7608387">db</span>&nbsp;<span class="op" id="7608390">:=</span>&nbsp;<span class="ident" id="7608393">newTestDB</span><span class="op" id="7608402">(</span><span class="ident" id="7608403">t</span><span class="op" id="7608404">,</span>&nbsp;<span class="string" id="7608406">&#34;people&#34;</span><span class="op" id="7608414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7608417">defer</span>&nbsp;<span class="ident" id="7608423">closeDB</span><span class="op" id="7608430">(</span><span class="ident" id="7608431">t</span><span class="op" id="7608432">,</span>&nbsp;<span class="ident" id="7608434">db</span><span class="op" id="7608436">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7608440">tx</span><span class="op" id="7608442">,</span>&nbsp;<span class="ident" id="7608444">err</span>&nbsp;<span class="op" id="7608448">:=</span>&nbsp;<span class="ident" id="7608451">db</span><span class="op" id="7608453">.</span><span class="ident" id="7608454">Begin</span><span class="op" id="7608459">(</span><span class="op" id="7608460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7608463">if</span>&nbsp;<span class="ident" id="7608466">err</span>&nbsp;<span class="op" id="7608470">!=</span>&nbsp;<span class="ident" id="7608473">nil</span>&nbsp;<span class="op" id="7608477">{</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7608481">t</span><span class="op" id="7608482">.</span><span class="ident" id="7608483">Fatal</span><span class="op" id="7608488">(</span><span class="ident" id="7608489">err</span><span class="op" id="7608492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7608495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7608498">tx</span><span class="op" id="7608500">.</span><span class="ident" id="7608501">Commit</span><span class="op" id="7608507">(</span><span class="op" id="7608508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7608511">if</span>&nbsp;<span class="ident" id="7608514">got</span>&nbsp;<span class="op" id="7608518">:=</span>&nbsp;<span class="builtinfunc" id="7608521">len</span><span class="op" id="7608524">(</span><span class="ident" id="7608525">db</span><span class="op" id="7608527">.</span><span class="ident" id="7608528">freeConn</span><span class="op" id="7608536">)</span><span class="op" id="7608537">;</span>&nbsp;<span class="ident" id="7608539">got</span>&nbsp;<span class="op" id="7608543">!=</span>&nbsp;<span class="num" id="7608546">1</span>&nbsp;<span class="op" id="7608548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7608552">t</span><span class="op" id="7608553">.</span><span class="ident" id="7608554">Errorf</span><span class="op" id="7608560">(</span><span class="string" id="7608561">&#34;freeConns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7608585">,</span>&nbsp;<span class="ident" id="7608587">got</span><span class="op" id="7608590">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7608593">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7608597">db</span><span class="op" id="7608599">.</span><span class="ident" id="7608600">SetMaxIdleConns</span><span class="op" id="7608615">(</span><span class="num" id="7608616">0</span><span class="op" id="7608617">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7608621">if</span>&nbsp;<span class="ident" id="7608624">got</span>&nbsp;<span class="op" id="7608628">:=</span>&nbsp;<span class="builtinfunc" id="7608631">len</span><span class="op" id="7608634">(</span><span class="ident" id="7608635">db</span><span class="op" id="7608637">.</span><span class="ident" id="7608638">freeConn</span><span class="op" id="7608646">)</span><span class="op" id="7608647">;</span>&nbsp;<span class="ident" id="7608649">got</span>&nbsp;<span class="op" id="7608653">!=</span>&nbsp;<span class="num" id="7608656">0</span>&nbsp;<span class="op" id="7608658">{</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7608662">t</span><span class="op" id="7608663">.</span><span class="ident" id="7608664">Errorf</span><span class="op" id="7608670">(</span><span class="string" id="7608671">&#34;freeConns&nbsp;after&nbsp;set&nbsp;to&nbsp;zero&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="7608713">,</span>&nbsp;<span class="ident" id="7608715">got</span><span class="op" id="7608718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7608721">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7608725">tx</span><span class="op" id="7608727">,</span>&nbsp;<span class="ident" id="7608729">err</span>&nbsp;<span class="op" id="7608733">=</span>&nbsp;<span class="ident" id="7608735">db</span><span class="op" id="7608737">.</span><span class="ident" id="7608738">Begin</span><span class="op" id="7608743">(</span><span class="op" id="7608744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7608747">if</span>&nbsp;<span class="ident" id="7608750">err</span>&nbsp;<span class="op" id="7608754">!=</span>&nbsp;<span class="ident" id="7608757">nil</span>&nbsp;<span class="op" id="7608761">{</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7608765">t</span><span class="op" id="7608766">.</span><span class="ident" id="7608767">Fatal</span><span class="op" id="7608772">(</span><span class="ident" id="7608773">err</span><span class="op" id="7608776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7608779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7608782">tx</span><span class="op" id="7608784">.</span><span class="ident" id="7608785">Commit</span><span class="op" id="7608791">(</span><span class="op" id="7608792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7608795">if</span>&nbsp;<span class="ident" id="7608798">got</span>&nbsp;<span class="op" id="7608802">:=</span>&nbsp;<span class="builtinfunc" id="7608805">len</span><span class="op" id="7608808">(</span><span class="ident" id="7608809">db</span><span class="op" id="7608811">.</span><span class="ident" id="7608812">freeConn</span><span class="op" id="7608820">)</span><span class="op" id="7608821">;</span>&nbsp;<span class="ident" id="7608823">got</span>&nbsp;<span class="op" id="7608827">!=</span>&nbsp;<span class="num" id="7608830">0</span>&nbsp;<span class="op" id="7608832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7608836">t</span><span class="op" id="7608837">.</span><span class="ident" id="7608838">Errorf</span><span class="op" id="7608844">(</span><span class="string" id="7608845">&#34;freeConns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="7608869">,</span>&nbsp;<span class="ident" id="7608871">got</span><span class="op" id="7608874">)</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7608877">}</span><br>
<span class="lineno"></span><span class="op" id="7608879">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7608882">func</span>&nbsp;<span class="ident" id="7608887">TestMaxOpenConns</span><span class="op" id="7608903">(</span><span class="ident" id="7608904">t</span>&nbsp;<span class="op" id="7608906">*</span><span class="ident" id="7608907">testing</span><span class="op" id="7608914">.</span><span class="ident" id="7608915">T</span><span class="op" id="7608916">)</span>&nbsp;<span class="op" id="7608918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7608921">if</span>&nbsp;<span class="ident" id="7608924">testing</span><span class="op" id="7608931">.</span><span class="ident" id="7608932">Short</span><span class="op" id="7608937">(</span><span class="op" id="7608938">)</span>&nbsp;<span class="op" id="7608940">{</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7608944">t</span><span class="op" id="7608945">.</span><span class="ident" id="7608946">Skip</span><span class="op" id="7608950">(</span><span class="string" id="7608951">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="7608975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7608978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7608981">defer</span>&nbsp;<span class="ident" id="7608987">setHookpostCloseConn</span><span class="op" id="7609007">(</span><span class="ident" id="7609008">nil</span><span class="op" id="7609011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609014">setHookpostCloseConn</span><span class="op" id="7609034">(</span><span class="keyword" id="7609035">func</span><span class="op" id="7609039">(</span><span class="ident" id="7609040">_</span>&nbsp;<span class="op" id="7609042">*</span><span class="ident" id="7609043">fakeConn</span><span class="op" id="7609051">,</span>&nbsp;<span class="ident" id="7609053">err</span>&nbsp;<span class="builtintype" id="7609057">error</span><span class="op" id="7609062">)</span>&nbsp;<span class="op" id="7609064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7609068">if</span>&nbsp;<span class="ident" id="7609071">err</span>&nbsp;<span class="op" id="7609075">!=</span>&nbsp;<span class="ident" id="7609078">nil</span>&nbsp;<span class="op" id="7609082">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609087">t</span><span class="op" id="7609088">.</span><span class="ident" id="7609089">Errorf</span><span class="op" id="7609095">(</span><span class="string" id="7609096">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="7609124">,</span>&nbsp;<span class="ident" id="7609126">err</span><span class="op" id="7609129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7609133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7609136">}</span><span class="op" id="7609137">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609141">db</span>&nbsp;<span class="op" id="7609144">:=</span>&nbsp;<span class="ident" id="7609147">newTestDB</span><span class="op" id="7609156">(</span><span class="ident" id="7609157">t</span><span class="op" id="7609158">,</span>&nbsp;<span class="string" id="7609160">&#34;magicquery&#34;</span><span class="op" id="7609172">)</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7609175">defer</span>&nbsp;<span class="ident" id="7609181">closeDB</span><span class="op" id="7609188">(</span><span class="ident" id="7609189">t</span><span class="op" id="7609190">,</span>&nbsp;<span class="ident" id="7609192">db</span><span class="op" id="7609194">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609198">driver</span>&nbsp;<span class="op" id="7609205">:=</span>&nbsp;<span class="ident" id="7609208">db</span><span class="op" id="7609210">.</span><span class="ident" id="7609211">driver</span><span class="op" id="7609217">.</span><span class="op" id="7609218">(</span><span class="op" id="7609219">*</span><span class="ident" id="7609220">fakeDriver</span><span class="op" id="7609230">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7609234">//&nbsp;Force&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;to&nbsp;0&nbsp;so&nbsp;we&nbsp;can&nbsp;get&nbsp;an&nbsp;accurate</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7609306">//&nbsp;count&nbsp;for&nbsp;the&nbsp;test</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609329">db</span><span class="op" id="7609331">.</span><span class="ident" id="7609332">SetMaxIdleConns</span><span class="op" id="7609347">(</span><span class="num" id="7609348">0</span><span class="op" id="7609349">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7609353">if</span>&nbsp;<span class="ident" id="7609356">g</span><span class="op" id="7609357">,</span>&nbsp;<span class="ident" id="7609359">w</span>&nbsp;<span class="op" id="7609361">:=</span>&nbsp;<span class="ident" id="7609364">db</span><span class="op" id="7609366">.</span><span class="ident" id="7609367">numFreeConns</span><span class="op" id="7609379">(</span><span class="op" id="7609380">)</span><span class="op" id="7609381">,</span>&nbsp;<span class="num" id="7609383">0</span><span class="op" id="7609384">;</span>&nbsp;<span class="ident" id="7609386">g</span>&nbsp;<span class="op" id="7609388">!=</span>&nbsp;<span class="ident" id="7609391">w</span>&nbsp;<span class="op" id="7609393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609397">t</span><span class="op" id="7609398">.</span><span class="ident" id="7609399">Errorf</span><span class="op" id="7609405">(</span><span class="string" id="7609406">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7609432">,</span>&nbsp;<span class="ident" id="7609434">g</span><span class="op" id="7609435">,</span>&nbsp;<span class="ident" id="7609437">w</span><span class="op" id="7609438">)</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7609441">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7609445">if</span>&nbsp;<span class="ident" id="7609448">n</span>&nbsp;<span class="op" id="7609450">:=</span>&nbsp;<span class="ident" id="7609453">db</span><span class="op" id="7609455">.</span><span class="ident" id="7609456">numDepsPollUntil</span><span class="op" id="7609472">(</span><span class="num" id="7609473">0</span><span class="op" id="7609474">,</span>&nbsp;<span class="ident" id="7609476">time</span><span class="op" id="7609480">.</span><span class="ident" id="7609481">Second</span><span class="op" id="7609487">)</span><span class="op" id="7609488">;</span>&nbsp;<span class="ident" id="7609490">n</span>&nbsp;<span class="op" id="7609492">&gt;</span>&nbsp;<span class="num" id="7609494">0</span>&nbsp;<span class="op" id="7609496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609500">t</span><span class="op" id="7609501">.</span><span class="ident" id="7609502">Errorf</span><span class="op" id="7609508">(</span><span class="string" id="7609509">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="7609550">,</span>&nbsp;<span class="ident" id="7609552">n</span><span class="op" id="7609553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609557">db</span><span class="op" id="7609559">.</span><span class="ident" id="7609560">dumpDeps</span><span class="op" id="7609568">(</span><span class="ident" id="7609569">t</span><span class="op" id="7609570">)</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7609573">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609577">driver</span><span class="op" id="7609583">.</span><span class="ident" id="7609584">mu</span><span class="op" id="7609586">.</span><span class="ident" id="7609587">Lock</span><span class="op" id="7609591">(</span><span class="op" id="7609592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609595">opens0</span>&nbsp;<span class="op" id="7609602">:=</span>&nbsp;<span class="ident" id="7609605">driver</span><span class="op" id="7609611">.</span><span class="ident" id="7609612">openCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609623">closes0</span>&nbsp;<span class="op" id="7609631">:=</span>&nbsp;<span class="ident" id="7609634">driver</span><span class="op" id="7609640">.</span><span class="ident" id="7609641">closeCount</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609653">driver</span><span class="op" id="7609659">.</span><span class="ident" id="7609660">mu</span><span class="op" id="7609662">.</span><span class="ident" id="7609663">Unlock</span><span class="op" id="7609669">(</span><span class="op" id="7609670">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609674">db</span><span class="op" id="7609676">.</span><span class="ident" id="7609677">SetMaxIdleConns</span><span class="op" id="7609692">(</span><span class="num" id="7609693">10</span><span class="op" id="7609695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609698">db</span><span class="op" id="7609700">.</span><span class="ident" id="7609701">SetMaxOpenConns</span><span class="op" id="7609716">(</span><span class="num" id="7609717">10</span><span class="op" id="7609719">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609723">stmt</span><span class="op" id="7609727">,</span>&nbsp;<span class="ident" id="7609729">err</span>&nbsp;<span class="op" id="7609733">:=</span>&nbsp;<span class="ident" id="7609736">db</span><span class="op" id="7609738">.</span><span class="ident" id="7609739">Prepare</span><span class="op" id="7609746">(</span><span class="string" id="7609747">&#34;SELECT|magicquery|op|op=?,millis=?&#34;</span><span class="op" id="7609783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7609786">if</span>&nbsp;<span class="ident" id="7609789">err</span>&nbsp;<span class="op" id="7609793">!=</span>&nbsp;<span class="ident" id="7609796">nil</span>&nbsp;<span class="op" id="7609800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609804">t</span><span class="op" id="7609805">.</span><span class="ident" id="7609806">Fatal</span><span class="op" id="7609811">(</span><span class="ident" id="7609812">err</span><span class="op" id="7609815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7609818">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7609822">//&nbsp;Start&nbsp;50&nbsp;parallel&nbsp;slow&nbsp;queries.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7609858">const</span>&nbsp;<span class="op" id="7609864">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609868">nquery</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7609880">=</span>&nbsp;<span class="num" id="7609882">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609887">sleepMillis</span>&nbsp;<span class="op" id="7609899">=</span>&nbsp;<span class="num" id="7609901">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609906">nbatch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7609918">=</span>&nbsp;<span class="num" id="7609920">2</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7609923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7609926">var</span>&nbsp;<span class="ident" id="7609930">wg</span>&nbsp;<span class="ident" id="7609933">sync</span><span class="op" id="7609937">.</span><span class="ident" id="7609938">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7609949">for</span>&nbsp;<span class="ident" id="7609953">batch</span>&nbsp;<span class="op" id="7609959">:=</span>&nbsp;<span class="num" id="7609962">0</span><span class="op" id="7609963">;</span>&nbsp;<span class="ident" id="7609965">batch</span>&nbsp;<span class="op" id="7609971">&lt;</span>&nbsp;<span class="ident" id="7609973">nbatch</span><span class="op" id="7609979">;</span>&nbsp;<span class="ident" id="7609981">batch</span><span class="op" id="7609986">++</span>&nbsp;<span class="op" id="7609989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7609993">for</span>&nbsp;<span class="ident" id="7609997">i</span>&nbsp;<span class="op" id="7609999">:=</span>&nbsp;<span class="num" id="7610002">0</span><span class="op" id="7610003">;</span>&nbsp;<span class="ident" id="7610005">i</span>&nbsp;<span class="op" id="7610007">&lt;</span>&nbsp;<span class="ident" id="7610009">nquery</span><span class="op" id="7610015">;</span>&nbsp;<span class="ident" id="7610017">i</span><span class="op" id="7610018">++</span>&nbsp;<span class="op" id="7610021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7610026">wg</span><span class="op" id="7610028">.</span><span class="ident" id="7610029">Add</span><span class="op" id="7610032">(</span><span class="num" id="7610033">1</span><span class="op" id="7610034">)</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7610039">go</span>&nbsp;<span class="keyword" id="7610042">func</span><span class="op" id="7610046">(</span><span class="op" id="7610047">)</span>&nbsp;<span class="op" id="7610049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7610055">defer</span>&nbsp;<span class="ident" id="7610061">wg</span><span class="op" id="7610063">.</span><span class="ident" id="7610064">Done</span><span class="op" id="7610068">(</span><span class="op" id="7610069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7610075">var</span>&nbsp;<span class="ident" id="7610079">op</span>&nbsp;<span class="builtintype" id="7610082">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7610093">if</span>&nbsp;<span class="ident" id="7610096">err</span>&nbsp;<span class="op" id="7610100">:=</span>&nbsp;<span class="ident" id="7610103">stmt</span><span class="op" id="7610107">.</span><span class="ident" id="7610108">QueryRow</span><span class="op" id="7610116">(</span><span class="string" id="7610117">&#34;sleep&#34;</span><span class="op" id="7610124">,</span>&nbsp;<span class="ident" id="7610126">sleepMillis</span><span class="op" id="7610137">)</span><span class="op" id="7610138">.</span><span class="ident" id="7610139">Scan</span><span class="op" id="7610143">(</span><span class="op" id="7610144">&amp;</span><span class="ident" id="7610145">op</span><span class="op" id="7610147">)</span><span class="op" id="7610148">;</span>&nbsp;<span class="ident" id="7610150">err</span>&nbsp;<span class="op" id="7610154">!=</span>&nbsp;<span class="ident" id="7610157">nil</span>&nbsp;<span class="op" id="7610161">&amp;&amp;</span>&nbsp;<span class="ident" id="7610164">err</span>&nbsp;<span class="op" id="7610168">!=</span>&nbsp;<span class="ident" id="7610171">ErrNoRows</span>&nbsp;<span class="op" id="7610181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7610188">t</span><span class="op" id="7610189">.</span><span class="ident" id="7610190">Error</span><span class="op" id="7610195">(</span><span class="ident" id="7610196">err</span><span class="op" id="7610199">)</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7610205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7610210">}</span><span class="op" id="7610211">(</span><span class="op" id="7610212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7610216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7610220">//&nbsp;Sleep&nbsp;for&nbsp;twice&nbsp;the&nbsp;expected&nbsp;length&nbsp;of&nbsp;time&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7610277">//&nbsp;batch&nbsp;of&nbsp;50&nbsp;queries&nbsp;above&nbsp;to&nbsp;finish&nbsp;before&nbsp;starting</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7610334">//&nbsp;the&nbsp;next&nbsp;round.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7610355">time</span><span class="op" id="7610359">.</span><span class="ident" id="7610360">Sleep</span><span class="op" id="7610365">(</span><span class="num" id="7610366">2</span>&nbsp;<span class="op" id="7610368">*</span>&nbsp;<span class="ident" id="7610370">sleepMillis</span>&nbsp;<span class="op" id="7610382">*</span>&nbsp;<span class="ident" id="7610384">time</span><span class="op" id="7610388">.</span><span class="ident" id="7610389">Millisecond</span><span class="op" id="7610400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7610403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7610406">wg</span><span class="op" id="7610408">.</span><span class="ident" id="7610409">Wait</span><span class="op" id="7610413">(</span><span class="op" id="7610414">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7610418">if</span>&nbsp;<span class="ident" id="7610421">g</span><span class="op" id="7610422">,</span>&nbsp;<span class="ident" id="7610424">w</span>&nbsp;<span class="op" id="7610426">:=</span>&nbsp;<span class="ident" id="7610429">db</span><span class="op" id="7610431">.</span><span class="ident" id="7610432">numFreeConns</span><span class="op" id="7610444">(</span><span class="op" id="7610445">)</span><span class="op" id="7610446">,</span>&nbsp;<span class="num" id="7610448">10</span><span class="op" id="7610450">;</span>&nbsp;<span class="ident" id="7610452">g</span>&nbsp;<span class="op" id="7610454">!=</span>&nbsp;<span class="ident" id="7610457">w</span>&nbsp;<span class="op" id="7610459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7610463">t</span><span class="op" id="7610464">.</span><span class="ident" id="7610465">Errorf</span><span class="op" id="7610471">(</span><span class="string" id="7610472">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7610498">,</span>&nbsp;<span class="ident" id="7610500">g</span><span class="op" id="7610501">,</span>&nbsp;<span class="ident" id="7610503">w</span><span class="op" id="7610504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7610507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7610511">if</span>&nbsp;<span class="ident" id="7610514">n</span>&nbsp;<span class="op" id="7610516">:=</span>&nbsp;<span class="ident" id="7610519">db</span><span class="op" id="7610521">.</span><span class="ident" id="7610522">numDepsPollUntil</span><span class="op" id="7610538">(</span><span class="num" id="7610539">20</span><span class="op" id="7610541">,</span>&nbsp;<span class="ident" id="7610543">time</span><span class="op" id="7610547">.</span><span class="ident" id="7610548">Second</span><span class="op" id="7610554">)</span><span class="op" id="7610555">;</span>&nbsp;<span class="ident" id="7610557">n</span>&nbsp;<span class="op" id="7610559">&gt;</span>&nbsp;<span class="num" id="7610561">20</span>&nbsp;<span class="op" id="7610564">{</span><br>
<span class="lineno">1010</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7610568">t</span><span class="op" id="7610569">.</span><span class="ident" id="7610570">Errorf</span><span class="op" id="7610576">(</span><span class="string" id="7610577">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;20&#34;</span><span class="op" id="7610622">,</span>&nbsp;<span class="ident" id="7610624">n</span><span class="op" id="7610625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7610629">db</span><span class="op" id="7610631">.</span><span class="ident" id="7610632">dumpDeps</span><span class="op" id="7610640">(</span><span class="ident" id="7610641">t</span><span class="op" id="7610642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7610645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7610649">driver</span><span class="op" id="7610655">.</span><span class="ident" id="7610656">mu</span><span class="op" id="7610658">.</span><span class="ident" id="7610659">Lock</span><span class="op" id="7610663">(</span><span class="op" id="7610664">)</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7610667">opens</span>&nbsp;<span class="op" id="7610673">:=</span>&nbsp;<span class="ident" id="7610676">driver</span><span class="op" id="7610682">.</span><span class="ident" id="7610683">openCount</span>&nbsp;<span class="op" id="7610693">-</span>&nbsp;<span class="ident" id="7610695">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7610703">closes</span>&nbsp;<span class="op" id="7610710">:=</span>&nbsp;<span class="ident" id="7610713">driver</span><span class="op" id="7610719">.</span><span class="ident" id="7610720">closeCount</span>&nbsp;<span class="op" id="7610731">-</span>&nbsp;<span class="ident" id="7610733">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7610742">driver</span><span class="op" id="7610748">.</span><span class="ident" id="7610749">mu</span><span class="op" id="7610751">.</span><span class="ident" id="7610752">Unlock</span><span class="op" id="7610758">(</span><span class="op" id="7610759">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7610763">if</span>&nbsp;<span class="ident" id="7610766">opens</span>&nbsp;<span class="op" id="7610772">&gt;</span>&nbsp;<span class="num" id="7610774">10</span>&nbsp;<span class="op" id="7610777">{</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7610781">t</span><span class="op" id="7610782">.</span><span class="ident" id="7610783">Logf</span><span class="op" id="7610787">(</span><span class="string" id="7610788">&#34;open&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7610805">,</span>&nbsp;<span class="ident" id="7610807">opens</span><span class="op" id="7610812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7610816">t</span><span class="op" id="7610817">.</span><span class="ident" id="7610818">Logf</span><span class="op" id="7610822">(</span><span class="string" id="7610823">&#34;close&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7610841">,</span>&nbsp;<span class="ident" id="7610843">closes</span><span class="op" id="7610849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7610853">t</span><span class="op" id="7610854">.</span><span class="ident" id="7610855">Errorf</span><span class="op" id="7610861">(</span><span class="string" id="7610862">&#34;db&nbsp;connections&nbsp;opened&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;10&#34;</span><span class="op" id="7610902">,</span>&nbsp;<span class="ident" id="7610904">opens</span><span class="op" id="7610909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7610913">db</span><span class="op" id="7610915">.</span><span class="ident" id="7610916">dumpDeps</span><span class="op" id="7610924">(</span><span class="ident" id="7610925">t</span><span class="op" id="7610926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7610929">}</span><br>
<span class="lineno">1025</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7610933">if</span>&nbsp;<span class="ident" id="7610936">err</span>&nbsp;<span class="op" id="7610940">:=</span>&nbsp;<span class="ident" id="7610943">stmt</span><span class="op" id="7610947">.</span><span class="ident" id="7610948">Close</span><span class="op" id="7610953">(</span><span class="op" id="7610954">)</span><span class="op" id="7610955">;</span>&nbsp;<span class="ident" id="7610957">err</span>&nbsp;<span class="op" id="7610961">!=</span>&nbsp;<span class="ident" id="7610964">nil</span>&nbsp;<span class="op" id="7610968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7610972">t</span><span class="op" id="7610973">.</span><span class="ident" id="7610974">Fatal</span><span class="op" id="7610979">(</span><span class="ident" id="7610980">err</span><span class="op" id="7610983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7610986">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7610990">if</span>&nbsp;<span class="ident" id="7610993">g</span><span class="op" id="7610994">,</span>&nbsp;<span class="ident" id="7610996">w</span>&nbsp;<span class="op" id="7610998">:=</span>&nbsp;<span class="ident" id="7611001">db</span><span class="op" id="7611003">.</span><span class="ident" id="7611004">numFreeConns</span><span class="op" id="7611016">(</span><span class="op" id="7611017">)</span><span class="op" id="7611018">,</span>&nbsp;<span class="num" id="7611020">10</span><span class="op" id="7611022">;</span>&nbsp;<span class="ident" id="7611024">g</span>&nbsp;<span class="op" id="7611026">!=</span>&nbsp;<span class="ident" id="7611029">w</span>&nbsp;<span class="op" id="7611031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7611035">t</span><span class="op" id="7611036">.</span><span class="ident" id="7611037">Errorf</span><span class="op" id="7611043">(</span><span class="string" id="7611044">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7611070">,</span>&nbsp;<span class="ident" id="7611072">g</span><span class="op" id="7611073">,</span>&nbsp;<span class="ident" id="7611075">w</span><span class="op" id="7611076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7611079">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7611083">if</span>&nbsp;<span class="ident" id="7611086">n</span>&nbsp;<span class="op" id="7611088">:=</span>&nbsp;<span class="ident" id="7611091">db</span><span class="op" id="7611093">.</span><span class="ident" id="7611094">numDepsPollUntil</span><span class="op" id="7611110">(</span><span class="num" id="7611111">10</span><span class="op" id="7611113">,</span>&nbsp;<span class="ident" id="7611115">time</span><span class="op" id="7611119">.</span><span class="ident" id="7611120">Second</span><span class="op" id="7611126">)</span><span class="op" id="7611127">;</span>&nbsp;<span class="ident" id="7611129">n</span>&nbsp;<span class="op" id="7611131">&gt;</span>&nbsp;<span class="num" id="7611133">10</span>&nbsp;<span class="op" id="7611136">{</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7611140">t</span><span class="op" id="7611141">.</span><span class="ident" id="7611142">Errorf</span><span class="op" id="7611148">(</span><span class="string" id="7611149">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;10&#34;</span><span class="op" id="7611194">,</span>&nbsp;<span class="ident" id="7611196">n</span><span class="op" id="7611197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7611201">db</span><span class="op" id="7611203">.</span><span class="ident" id="7611204">dumpDeps</span><span class="op" id="7611212">(</span><span class="ident" id="7611213">t</span><span class="op" id="7611214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7611217">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7611221">db</span><span class="op" id="7611223">.</span><span class="ident" id="7611224">SetMaxOpenConns</span><span class="op" id="7611239">(</span><span class="num" id="7611240">5</span><span class="op" id="7611241">)</span><br>
<span class="lineno">1040</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7611245">if</span>&nbsp;<span class="ident" id="7611248">g</span><span class="op" id="7611249">,</span>&nbsp;<span class="ident" id="7611251">w</span>&nbsp;<span class="op" id="7611253">:=</span>&nbsp;<span class="ident" id="7611256">db</span><span class="op" id="7611258">.</span><span class="ident" id="7611259">numFreeConns</span><span class="op" id="7611271">(</span><span class="op" id="7611272">)</span><span class="op" id="7611273">,</span>&nbsp;<span class="num" id="7611275">5</span><span class="op" id="7611276">;</span>&nbsp;<span class="ident" id="7611278">g</span>&nbsp;<span class="op" id="7611280">!=</span>&nbsp;<span class="ident" id="7611283">w</span>&nbsp;<span class="op" id="7611285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7611289">t</span><span class="op" id="7611290">.</span><span class="ident" id="7611291">Errorf</span><span class="op" id="7611297">(</span><span class="string" id="7611298">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7611324">,</span>&nbsp;<span class="ident" id="7611326">g</span><span class="op" id="7611327">,</span>&nbsp;<span class="ident" id="7611329">w</span><span class="op" id="7611330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7611333">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7611337">if</span>&nbsp;<span class="ident" id="7611340">n</span>&nbsp;<span class="op" id="7611342">:=</span>&nbsp;<span class="ident" id="7611345">db</span><span class="op" id="7611347">.</span><span class="ident" id="7611348">numDepsPollUntil</span><span class="op" id="7611364">(</span><span class="num" id="7611365">5</span><span class="op" id="7611366">,</span>&nbsp;<span class="ident" id="7611368">time</span><span class="op" id="7611372">.</span><span class="ident" id="7611373">Second</span><span class="op" id="7611379">)</span><span class="op" id="7611380">;</span>&nbsp;<span class="ident" id="7611382">n</span>&nbsp;<span class="op" id="7611384">&gt;</span>&nbsp;<span class="num" id="7611386">5</span>&nbsp;<span class="op" id="7611388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7611392">t</span><span class="op" id="7611393">.</span><span class="ident" id="7611394">Errorf</span><span class="op" id="7611400">(</span><span class="string" id="7611401">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="7611442">,</span>&nbsp;<span class="ident" id="7611444">n</span><span class="op" id="7611445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7611449">db</span><span class="op" id="7611451">.</span><span class="ident" id="7611452">dumpDeps</span><span class="op" id="7611460">(</span><span class="ident" id="7611461">t</span><span class="op" id="7611462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7611465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7611469">db</span><span class="op" id="7611471">.</span><span class="ident" id="7611472">SetMaxOpenConns</span><span class="op" id="7611487">(</span><span class="num" id="7611488">0</span><span class="op" id="7611489">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7611493">if</span>&nbsp;<span class="ident" id="7611496">g</span><span class="op" id="7611497">,</span>&nbsp;<span class="ident" id="7611499">w</span>&nbsp;<span class="op" id="7611501">:=</span>&nbsp;<span class="ident" id="7611504">db</span><span class="op" id="7611506">.</span><span class="ident" id="7611507">numFreeConns</span><span class="op" id="7611519">(</span><span class="op" id="7611520">)</span><span class="op" id="7611521">,</span>&nbsp;<span class="num" id="7611523">5</span><span class="op" id="7611524">;</span>&nbsp;<span class="ident" id="7611526">g</span>&nbsp;<span class="op" id="7611528">!=</span>&nbsp;<span class="ident" id="7611531">w</span>&nbsp;<span class="op" id="7611533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7611537">t</span><span class="op" id="7611538">.</span><span class="ident" id="7611539">Errorf</span><span class="op" id="7611545">(</span><span class="string" id="7611546">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7611572">,</span>&nbsp;<span class="ident" id="7611574">g</span><span class="op" id="7611575">,</span>&nbsp;<span class="ident" id="7611577">w</span><span class="op" id="7611578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7611581">}</span><br>
<span class="lineno">1055</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7611585">if</span>&nbsp;<span class="ident" id="7611588">n</span>&nbsp;<span class="op" id="7611590">:=</span>&nbsp;<span class="ident" id="7611593">db</span><span class="op" id="7611595">.</span><span class="ident" id="7611596">numDepsPollUntil</span><span class="op" id="7611612">(</span><span class="num" id="7611613">5</span><span class="op" id="7611614">,</span>&nbsp;<span class="ident" id="7611616">time</span><span class="op" id="7611620">.</span><span class="ident" id="7611621">Second</span><span class="op" id="7611627">)</span><span class="op" id="7611628">;</span>&nbsp;<span class="ident" id="7611630">n</span>&nbsp;<span class="op" id="7611632">&gt;</span>&nbsp;<span class="num" id="7611634">5</span>&nbsp;<span class="op" id="7611636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7611640">t</span><span class="op" id="7611641">.</span><span class="ident" id="7611642">Errorf</span><span class="op" id="7611648">(</span><span class="string" id="7611649">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="7611690">,</span>&nbsp;<span class="ident" id="7611692">n</span><span class="op" id="7611693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7611697">db</span><span class="op" id="7611699">.</span><span class="ident" id="7611700">dumpDeps</span><span class="op" id="7611708">(</span><span class="ident" id="7611709">t</span><span class="op" id="7611710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7611713">}</span><br>
<span class="lineno">1060</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7611717">db</span><span class="op" id="7611719">.</span><span class="ident" id="7611720">SetMaxIdleConns</span><span class="op" id="7611735">(</span><span class="num" id="7611736">0</span><span class="op" id="7611737">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7611741">if</span>&nbsp;<span class="ident" id="7611744">g</span><span class="op" id="7611745">,</span>&nbsp;<span class="ident" id="7611747">w</span>&nbsp;<span class="op" id="7611749">:=</span>&nbsp;<span class="ident" id="7611752">db</span><span class="op" id="7611754">.</span><span class="ident" id="7611755">numFreeConns</span><span class="op" id="7611767">(</span><span class="op" id="7611768">)</span><span class="op" id="7611769">,</span>&nbsp;<span class="num" id="7611771">0</span><span class="op" id="7611772">;</span>&nbsp;<span class="ident" id="7611774">g</span>&nbsp;<span class="op" id="7611776">!=</span>&nbsp;<span class="ident" id="7611779">w</span>&nbsp;<span class="op" id="7611781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7611785">t</span><span class="op" id="7611786">.</span><span class="ident" id="7611787">Errorf</span><span class="op" id="7611793">(</span><span class="string" id="7611794">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7611820">,</span>&nbsp;<span class="ident" id="7611822">g</span><span class="op" id="7611823">,</span>&nbsp;<span class="ident" id="7611825">w</span><span class="op" id="7611826">)</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7611829">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7611833">if</span>&nbsp;<span class="ident" id="7611836">n</span>&nbsp;<span class="op" id="7611838">:=</span>&nbsp;<span class="ident" id="7611841">db</span><span class="op" id="7611843">.</span><span class="ident" id="7611844">numDepsPollUntil</span><span class="op" id="7611860">(</span><span class="num" id="7611861">0</span><span class="op" id="7611862">,</span>&nbsp;<span class="ident" id="7611864">time</span><span class="op" id="7611868">.</span><span class="ident" id="7611869">Second</span><span class="op" id="7611875">)</span><span class="op" id="7611876">;</span>&nbsp;<span class="ident" id="7611878">n</span>&nbsp;<span class="op" id="7611880">&gt;</span>&nbsp;<span class="num" id="7611882">0</span>&nbsp;<span class="op" id="7611884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7611888">t</span><span class="op" id="7611889">.</span><span class="ident" id="7611890">Errorf</span><span class="op" id="7611896">(</span><span class="string" id="7611897">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="7611938">,</span>&nbsp;<span class="ident" id="7611940">n</span><span class="op" id="7611941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7611945">db</span><span class="op" id="7611947">.</span><span class="ident" id="7611948">dumpDeps</span><span class="op" id="7611956">(</span><span class="ident" id="7611957">t</span><span class="op" id="7611958">)</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7611961">}</span><br>
<span class="lineno"></span><span class="op" id="7611963">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7611966">func</span>&nbsp;<span class="ident" id="7611971">TestSingleOpenConn</span><span class="op" id="7611989">(</span><span class="ident" id="7611990">t</span>&nbsp;<span class="op" id="7611992">*</span><span class="ident" id="7611993">testing</span><span class="op" id="7612000">.</span><span class="ident" id="7612001">T</span><span class="op" id="7612002">)</span>&nbsp;<span class="op" id="7612004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7612007">db</span>&nbsp;<span class="op" id="7612010">:=</span>&nbsp;<span class="ident" id="7612013">newTestDB</span><span class="op" id="7612022">(</span><span class="ident" id="7612023">t</span><span class="op" id="7612024">,</span>&nbsp;<span class="string" id="7612026">&#34;people&#34;</span><span class="op" id="7612034">)</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7612037">defer</span>&nbsp;<span class="ident" id="7612043">closeDB</span><span class="op" id="7612050">(</span><span class="ident" id="7612051">t</span><span class="op" id="7612052">,</span>&nbsp;<span class="ident" id="7612054">db</span><span class="op" id="7612056">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7612060">db</span><span class="op" id="7612062">.</span><span class="ident" id="7612063">SetMaxOpenConns</span><span class="op" id="7612078">(</span><span class="num" id="7612079">1</span><span class="op" id="7612080">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7612084">rows</span><span class="op" id="7612088">,</span>&nbsp;<span class="ident" id="7612090">err</span>&nbsp;<span class="op" id="7612094">:=</span>&nbsp;<span class="ident" id="7612097">db</span><span class="op" id="7612099">.</span><span class="ident" id="7612100">Query</span><span class="op" id="7612105">(</span><span class="string" id="7612106">&#34;SELECT|people|name|&#34;</span><span class="op" id="7612127">)</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7612130">if</span>&nbsp;<span class="ident" id="7612133">err</span>&nbsp;<span class="op" id="7612137">!=</span>&nbsp;<span class="ident" id="7612140">nil</span>&nbsp;<span class="op" id="7612144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7612148">t</span><span class="op" id="7612149">.</span><span class="ident" id="7612150">Fatal</span><span class="op" id="7612155">(</span><span class="ident" id="7612156">err</span><span class="op" id="7612159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7612162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7612165">if</span>&nbsp;<span class="ident" id="7612168">err</span>&nbsp;<span class="op" id="7612172">=</span>&nbsp;<span class="ident" id="7612174">rows</span><span class="op" id="7612178">.</span><span class="ident" id="7612179">Close</span><span class="op" id="7612184">(</span><span class="op" id="7612185">)</span><span class="op" id="7612186">;</span>&nbsp;<span class="ident" id="7612188">err</span>&nbsp;<span class="op" id="7612192">!=</span>&nbsp;<span class="ident" id="7612195">nil</span>&nbsp;<span class="op" id="7612199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7612203">t</span><span class="op" id="7612204">.</span><span class="ident" id="7612205">Fatal</span><span class="op" id="7612210">(</span><span class="ident" id="7612211">err</span><span class="op" id="7612214">)</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7612217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7612220">//&nbsp;shouldn&#39;t&nbsp;deadlock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7612243">rows</span><span class="op" id="7612247">,</span>&nbsp;<span class="ident" id="7612249">err</span>&nbsp;<span class="op" id="7612253">=</span>&nbsp;<span class="ident" id="7612255">db</span><span class="op" id="7612257">.</span><span class="ident" id="7612258">Query</span><span class="op" id="7612263">(</span><span class="string" id="7612264">&#34;SELECT|people|name|&#34;</span><span class="op" id="7612285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7612288">if</span>&nbsp;<span class="ident" id="7612291">err</span>&nbsp;<span class="op" id="7612295">!=</span>&nbsp;<span class="ident" id="7612298">nil</span>&nbsp;<span class="op" id="7612302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7612306">t</span><span class="op" id="7612307">.</span><span class="ident" id="7612308">Fatal</span><span class="op" id="7612313">(</span><span class="ident" id="7612314">err</span><span class="op" id="7612317">)</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7612320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7612323">if</span>&nbsp;<span class="ident" id="7612326">err</span>&nbsp;<span class="op" id="7612330">=</span>&nbsp;<span class="ident" id="7612332">rows</span><span class="op" id="7612336">.</span><span class="ident" id="7612337">Close</span><span class="op" id="7612342">(</span><span class="op" id="7612343">)</span><span class="op" id="7612344">;</span>&nbsp;<span class="ident" id="7612346">err</span>&nbsp;<span class="op" id="7612350">!=</span>&nbsp;<span class="ident" id="7612353">nil</span>&nbsp;<span class="op" id="7612357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7612361">t</span><span class="op" id="7612362">.</span><span class="ident" id="7612363">Fatal</span><span class="op" id="7612368">(</span><span class="ident" id="7612369">err</span><span class="op" id="7612372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7612375">}</span><br>
<span class="lineno"></span><span class="op" id="7612377">}</span><br>
<span class="lineno">1095</span><br>
<span class="lineno"></span><span class="comment" id="7612380">//&nbsp;golang.org/issue/5323</span><br>
<span class="lineno"></span><span class="keyword" id="7612405">func</span>&nbsp;<span class="ident" id="7612410">TestStmtCloseDeps</span><span class="op" id="7612427">(</span><span class="ident" id="7612428">t</span>&nbsp;<span class="op" id="7612430">*</span><span class="ident" id="7612431">testing</span><span class="op" id="7612438">.</span><span class="ident" id="7612439">T</span><span class="op" id="7612440">)</span>&nbsp;<span class="op" id="7612442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7612445">if</span>&nbsp;<span class="ident" id="7612448">testing</span><span class="op" id="7612455">.</span><span class="ident" id="7612456">Short</span><span class="op" id="7612461">(</span><span class="op" id="7612462">)</span>&nbsp;<span class="op" id="7612464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7612468">t</span><span class="op" id="7612469">.</span><span class="ident" id="7612470">Skip</span><span class="op" id="7612474">(</span><span class="string" id="7612475">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="7612499">)</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7612502">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7612505">defer</span>&nbsp;<span class="ident" id="7612511">setHookpostCloseConn</span><span class="op" id="7612531">(</span><span class="ident" id="7612532">nil</span><span class="op" id="7612535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7612538">setHookpostCloseConn</span><span class="op" id="7612558">(</span><span class="keyword" id="7612559">func</span><span class="op" id="7612563">(</span><span class="ident" id="7612564">_</span>&nbsp;<span class="op" id="7612566">*</span><span class="ident" id="7612567">fakeConn</span><span class="op" id="7612575">,</span>&nbsp;<span class="ident" id="7612577">err</span>&nbsp;<span class="builtintype" id="7612581">error</span><span class="op" id="7612586">)</span>&nbsp;<span class="op" id="7612588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7612592">if</span>&nbsp;<span class="ident" id="7612595">err</span>&nbsp;<span class="op" id="7612599">!=</span>&nbsp;<span class="ident" id="7612602">nil</span>&nbsp;<span class="op" id="7612606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7612611">t</span><span class="op" id="7612612">.</span><span class="ident" id="7612613">Errorf</span><span class="op" id="7612619">(</span><span class="string" id="7612620">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="7612648">,</span>&nbsp;<span class="ident" id="7612650">err</span><span class="op" id="7612653">)</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7612657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7612660">}</span><span class="op" id="7612661">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7612665">db</span>&nbsp;<span class="op" id="7612668">:=</span>&nbsp;<span class="ident" id="7612671">newTestDB</span><span class="op" id="7612680">(</span><span class="ident" id="7612681">t</span><span class="op" id="7612682">,</span>&nbsp;<span class="string" id="7612684">&#34;magicquery&#34;</span><span class="op" id="7612696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7612699">defer</span>&nbsp;<span class="ident" id="7612705">closeDB</span><span class="op" id="7612712">(</span><span class="ident" id="7612713">t</span><span class="op" id="7612714">,</span>&nbsp;<span class="ident" id="7612716">db</span><span class="op" id="7612718">)</span><br>
<span class="lineno">1110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7612722">driver</span>&nbsp;<span class="op" id="7612729">:=</span>&nbsp;<span class="ident" id="7612732">db</span><span class="op" id="7612734">.</span><span class="ident" id="7612735">driver</span><span class="op" id="7612741">.</span><span class="op" id="7612742">(</span><span class="op" id="7612743">*</span><span class="ident" id="7612744">fakeDriver</span><span class="op" id="7612754">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7612758">driver</span><span class="op" id="7612764">.</span><span class="ident" id="7612765">mu</span><span class="op" id="7612767">.</span><span class="ident" id="7612768">Lock</span><span class="op" id="7612772">(</span><span class="op" id="7612773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7612776">opens0</span>&nbsp;<span class="op" id="7612783">:=</span>&nbsp;<span class="ident" id="7612786">driver</span><span class="op" id="7612792">.</span><span class="ident" id="7612793">openCount</span><br>
<span class="lineno">1115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7612804">closes0</span>&nbsp;<span class="op" id="7612812">:=</span>&nbsp;<span class="ident" id="7612815">driver</span><span class="op" id="7612821">.</span><span class="ident" id="7612822">closeCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7612834">driver</span><span class="op" id="7612840">.</span><span class="ident" id="7612841">mu</span><span class="op" id="7612843">.</span><span class="ident" id="7612844">Unlock</span><span class="op" id="7612850">(</span><span class="op" id="7612851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7612854">openDelta0</span>&nbsp;<span class="op" id="7612865">:=</span>&nbsp;<span class="ident" id="7612868">opens0</span>&nbsp;<span class="op" id="7612875">-</span>&nbsp;<span class="ident" id="7612877">closes0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7612887">stmt</span><span class="op" id="7612891">,</span>&nbsp;<span class="ident" id="7612893">err</span>&nbsp;<span class="op" id="7612897">:=</span>&nbsp;<span class="ident" id="7612900">db</span><span class="op" id="7612902">.</span><span class="ident" id="7612903">Prepare</span><span class="op" id="7612910">(</span><span class="string" id="7612911">&#34;SELECT|magicquery|op|op=?,millis=?&#34;</span><span class="op" id="7612947">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7612950">if</span>&nbsp;<span class="ident" id="7612953">err</span>&nbsp;<span class="op" id="7612957">!=</span>&nbsp;<span class="ident" id="7612960">nil</span>&nbsp;<span class="op" id="7612964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7612968">t</span><span class="op" id="7612969">.</span><span class="ident" id="7612970">Fatal</span><span class="op" id="7612975">(</span><span class="ident" id="7612976">err</span><span class="op" id="7612979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7612982">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7612986">//&nbsp;Start&nbsp;50&nbsp;parallel&nbsp;slow&nbsp;queries.</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7613022">const</span>&nbsp;<span class="op" id="7613028">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7613032">nquery</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7613044">=</span>&nbsp;<span class="num" id="7613046">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7613051">sleepMillis</span>&nbsp;<span class="op" id="7613063">=</span>&nbsp;<span class="num" id="7613065">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7613070">nbatch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7613082">=</span>&nbsp;<span class="num" id="7613084">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7613087">)</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7613090">var</span>&nbsp;<span class="ident" id="7613094">wg</span>&nbsp;<span class="ident" id="7613097">sync</span><span class="op" id="7613101">.</span><span class="ident" id="7613102">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7613113">for</span>&nbsp;<span class="ident" id="7613117">batch</span>&nbsp;<span class="op" id="7613123">:=</span>&nbsp;<span class="num" id="7613126">0</span><span class="op" id="7613127">;</span>&nbsp;<span class="ident" id="7613129">batch</span>&nbsp;<span class="op" id="7613135">&lt;</span>&nbsp;<span class="ident" id="7613137">nbatch</span><span class="op" id="7613143">;</span>&nbsp;<span class="ident" id="7613145">batch</span><span class="op" id="7613150">++</span>&nbsp;<span class="op" id="7613153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7613157">for</span>&nbsp;<span class="ident" id="7613161">i</span>&nbsp;<span class="op" id="7613163">:=</span>&nbsp;<span class="num" id="7613166">0</span><span class="op" id="7613167">;</span>&nbsp;<span class="ident" id="7613169">i</span>&nbsp;<span class="op" id="7613171">&lt;</span>&nbsp;<span class="ident" id="7613173">nquery</span><span class="op" id="7613179">;</span>&nbsp;<span class="ident" id="7613181">i</span><span class="op" id="7613182">++</span>&nbsp;<span class="op" id="7613185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7613190">wg</span><span class="op" id="7613192">.</span><span class="ident" id="7613193">Add</span><span class="op" id="7613196">(</span><span class="num" id="7613197">1</span><span class="op" id="7613198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7613203">go</span>&nbsp;<span class="keyword" id="7613206">func</span><span class="op" id="7613210">(</span><span class="op" id="7613211">)</span>&nbsp;<span class="op" id="7613213">{</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7613219">defer</span>&nbsp;<span class="ident" id="7613225">wg</span><span class="op" id="7613227">.</span><span class="ident" id="7613228">Done</span><span class="op" id="7613232">(</span><span class="op" id="7613233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7613239">var</span>&nbsp;<span class="ident" id="7613243">op</span>&nbsp;<span class="builtintype" id="7613246">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7613257">if</span>&nbsp;<span class="ident" id="7613260">err</span>&nbsp;<span class="op" id="7613264">:=</span>&nbsp;<span class="ident" id="7613267">stmt</span><span class="op" id="7613271">.</span><span class="ident" id="7613272">QueryRow</span><span class="op" id="7613280">(</span><span class="string" id="7613281">&#34;sleep&#34;</span><span class="op" id="7613288">,</span>&nbsp;<span class="ident" id="7613290">sleepMillis</span><span class="op" id="7613301">)</span><span class="op" id="7613302">.</span><span class="ident" id="7613303">Scan</span><span class="op" id="7613307">(</span><span class="op" id="7613308">&amp;</span><span class="ident" id="7613309">op</span><span class="op" id="7613311">)</span><span class="op" id="7613312">;</span>&nbsp;<span class="ident" id="7613314">err</span>&nbsp;<span class="op" id="7613318">!=</span>&nbsp;<span class="ident" id="7613321">nil</span>&nbsp;<span class="op" id="7613325">&amp;&amp;</span>&nbsp;<span class="ident" id="7613328">err</span>&nbsp;<span class="op" id="7613332">!=</span>&nbsp;<span class="ident" id="7613335">ErrNoRows</span>&nbsp;<span class="op" id="7613345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7613352">t</span><span class="op" id="7613353">.</span><span class="ident" id="7613354">Error</span><span class="op" id="7613359">(</span><span class="ident" id="7613360">err</span><span class="op" id="7613363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7613369">}</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7613374">}</span><span class="op" id="7613375">(</span><span class="op" id="7613376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7613380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7613384">//&nbsp;Sleep&nbsp;for&nbsp;twice&nbsp;the&nbsp;expected&nbsp;length&nbsp;of&nbsp;time&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7613441">//&nbsp;batch&nbsp;of&nbsp;50&nbsp;queries&nbsp;above&nbsp;to&nbsp;finish&nbsp;before&nbsp;starting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7613498">//&nbsp;the&nbsp;next&nbsp;round.</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7613519">time</span><span class="op" id="7613523">.</span><span class="ident" id="7613524">Sleep</span><span class="op" id="7613529">(</span><span class="num" id="7613530">2</span>&nbsp;<span class="op" id="7613532">*</span>&nbsp;<span class="ident" id="7613534">sleepMillis</span>&nbsp;<span class="op" id="7613546">*</span>&nbsp;<span class="ident" id="7613548">time</span><span class="op" id="7613552">.</span><span class="ident" id="7613553">Millisecond</span><span class="op" id="7613564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7613567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7613570">wg</span><span class="op" id="7613572">.</span><span class="ident" id="7613573">Wait</span><span class="op" id="7613577">(</span><span class="op" id="7613578">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7613582">if</span>&nbsp;<span class="ident" id="7613585">g</span><span class="op" id="7613586">,</span>&nbsp;<span class="ident" id="7613588">w</span>&nbsp;<span class="op" id="7613590">:=</span>&nbsp;<span class="ident" id="7613593">db</span><span class="op" id="7613595">.</span><span class="ident" id="7613596">numFreeConns</span><span class="op" id="7613608">(</span><span class="op" id="7613609">)</span><span class="op" id="7613610">,</span>&nbsp;<span class="num" id="7613612">2</span><span class="op" id="7613613">;</span>&nbsp;<span class="ident" id="7613615">g</span>&nbsp;<span class="op" id="7613617">!=</span>&nbsp;<span class="ident" id="7613620">w</span>&nbsp;<span class="op" id="7613622">{</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7613626">t</span><span class="op" id="7613627">.</span><span class="ident" id="7613628">Errorf</span><span class="op" id="7613634">(</span><span class="string" id="7613635">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7613661">,</span>&nbsp;<span class="ident" id="7613663">g</span><span class="op" id="7613664">,</span>&nbsp;<span class="ident" id="7613666">w</span><span class="op" id="7613667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7613670">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7613674">if</span>&nbsp;<span class="ident" id="7613677">n</span>&nbsp;<span class="op" id="7613679">:=</span>&nbsp;<span class="ident" id="7613682">db</span><span class="op" id="7613684">.</span><span class="ident" id="7613685">numDepsPollUntil</span><span class="op" id="7613701">(</span><span class="num" id="7613702">4</span><span class="op" id="7613703">,</span>&nbsp;<span class="ident" id="7613705">time</span><span class="op" id="7613709">.</span><span class="ident" id="7613710">Second</span><span class="op" id="7613716">)</span><span class="op" id="7613717">;</span>&nbsp;<span class="ident" id="7613719">n</span>&nbsp;<span class="op" id="7613721">&gt;</span>&nbsp;<span class="num" id="7613723">4</span>&nbsp;<span class="op" id="7613725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7613729">t</span><span class="op" id="7613730">.</span><span class="ident" id="7613731">Errorf</span><span class="op" id="7613737">(</span><span class="string" id="7613738">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;4&#34;</span><span class="op" id="7613782">,</span>&nbsp;<span class="ident" id="7613784">n</span><span class="op" id="7613785">)</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7613789">db</span><span class="op" id="7613791">.</span><span class="ident" id="7613792">dumpDeps</span><span class="op" id="7613800">(</span><span class="ident" id="7613801">t</span><span class="op" id="7613802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7613805">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7613809">driver</span><span class="op" id="7613815">.</span><span class="ident" id="7613816">mu</span><span class="op" id="7613818">.</span><span class="ident" id="7613819">Lock</span><span class="op" id="7613823">(</span><span class="op" id="7613824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7613827">opens</span>&nbsp;<span class="op" id="7613833">:=</span>&nbsp;<span class="ident" id="7613836">driver</span><span class="op" id="7613842">.</span><span class="ident" id="7613843">openCount</span>&nbsp;<span class="op" id="7613853">-</span>&nbsp;<span class="ident" id="7613855">opens0</span><br>
<span class="lineno">1160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7613863">closes</span>&nbsp;<span class="op" id="7613870">:=</span>&nbsp;<span class="ident" id="7613873">driver</span><span class="op" id="7613879">.</span><span class="ident" id="7613880">closeCount</span>&nbsp;<span class="op" id="7613891">-</span>&nbsp;<span class="ident" id="7613893">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7613902">openDelta</span>&nbsp;<span class="op" id="7613912">:=</span>&nbsp;<span class="op" id="7613915">(</span><span class="ident" id="7613916">driver</span><span class="op" id="7613922">.</span><span class="ident" id="7613923">openCount</span>&nbsp;<span class="op" id="7613933">-</span>&nbsp;<span class="ident" id="7613935">driver</span><span class="op" id="7613941">.</span><span class="ident" id="7613942">closeCount</span><span class="op" id="7613952">)</span>&nbsp;<span class="op" id="7613954">-</span>&nbsp;<span class="ident" id="7613956">openDelta0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7613968">driver</span><span class="op" id="7613974">.</span><span class="ident" id="7613975">mu</span><span class="op" id="7613977">.</span><span class="ident" id="7613978">Unlock</span><span class="op" id="7613984">(</span><span class="op" id="7613985">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7613989">if</span>&nbsp;<span class="ident" id="7613992">openDelta</span>&nbsp;<span class="op" id="7614002">&gt;</span>&nbsp;<span class="num" id="7614004">2</span>&nbsp;<span class="op" id="7614006">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7614010">t</span><span class="op" id="7614011">.</span><span class="ident" id="7614012">Logf</span><span class="op" id="7614016">(</span><span class="string" id="7614017">&#34;open&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7614034">,</span>&nbsp;<span class="ident" id="7614036">opens</span><span class="op" id="7614041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7614045">t</span><span class="op" id="7614046">.</span><span class="ident" id="7614047">Logf</span><span class="op" id="7614051">(</span><span class="string" id="7614052">&#34;close&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7614070">,</span>&nbsp;<span class="ident" id="7614072">closes</span><span class="op" id="7614078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7614082">t</span><span class="op" id="7614083">.</span><span class="ident" id="7614084">Logf</span><span class="op" id="7614088">(</span><span class="string" id="7614089">&#34;open&nbsp;delta&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7614106">,</span>&nbsp;<span class="ident" id="7614108">openDelta</span><span class="op" id="7614117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7614121">t</span><span class="op" id="7614122">.</span><span class="ident" id="7614123">Errorf</span><span class="op" id="7614129">(</span><span class="string" id="7614130">&#34;db&nbsp;connections&nbsp;opened&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;2&#34;</span><span class="op" id="7614169">,</span>&nbsp;<span class="ident" id="7614171">openDelta</span><span class="op" id="7614180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7614184">db</span><span class="op" id="7614186">.</span><span class="ident" id="7614187">dumpDeps</span><span class="op" id="7614195">(</span><span class="ident" id="7614196">t</span><span class="op" id="7614197">)</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7614200">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7614204">if</span>&nbsp;<span class="builtinfunc" id="7614207">len</span><span class="op" id="7614210">(</span><span class="ident" id="7614211">stmt</span><span class="op" id="7614215">.</span><span class="ident" id="7614216">css</span><span class="op" id="7614219">)</span>&nbsp;<span class="op" id="7614221">&gt;</span>&nbsp;<span class="ident" id="7614223">nquery</span>&nbsp;<span class="op" id="7614230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7614234">t</span><span class="op" id="7614235">.</span><span class="ident" id="7614236">Errorf</span><span class="op" id="7614242">(</span><span class="string" id="7614243">&#34;len(stmt.css)&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;%d&#34;</span><span class="op" id="7614275">,</span>&nbsp;<span class="builtinfunc" id="7614277">len</span><span class="op" id="7614280">(</span><span class="ident" id="7614281">stmt</span><span class="op" id="7614285">.</span><span class="ident" id="7614286">css</span><span class="op" id="7614289">)</span><span class="op" id="7614290">,</span>&nbsp;<span class="ident" id="7614292">nquery</span><span class="op" id="7614298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7614301">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7614305">if</span>&nbsp;<span class="ident" id="7614308">err</span>&nbsp;<span class="op" id="7614312">:=</span>&nbsp;<span class="ident" id="7614315">stmt</span><span class="op" id="7614319">.</span><span class="ident" id="7614320">Close</span><span class="op" id="7614325">(</span><span class="op" id="7614326">)</span><span class="op" id="7614327">;</span>&nbsp;<span class="ident" id="7614329">err</span>&nbsp;<span class="op" id="7614333">!=</span>&nbsp;<span class="ident" id="7614336">nil</span>&nbsp;<span class="op" id="7614340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7614344">t</span><span class="op" id="7614345">.</span><span class="ident" id="7614346">Fatal</span><span class="op" id="7614351">(</span><span class="ident" id="7614352">err</span><span class="op" id="7614355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7614358">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7614362">if</span>&nbsp;<span class="ident" id="7614365">g</span><span class="op" id="7614366">,</span>&nbsp;<span class="ident" id="7614368">w</span>&nbsp;<span class="op" id="7614370">:=</span>&nbsp;<span class="ident" id="7614373">db</span><span class="op" id="7614375">.</span><span class="ident" id="7614376">numFreeConns</span><span class="op" id="7614388">(</span><span class="op" id="7614389">)</span><span class="op" id="7614390">,</span>&nbsp;<span class="num" id="7614392">2</span><span class="op" id="7614393">;</span>&nbsp;<span class="ident" id="7614395">g</span>&nbsp;<span class="op" id="7614397">!=</span>&nbsp;<span class="ident" id="7614400">w</span>&nbsp;<span class="op" id="7614402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7614406">t</span><span class="op" id="7614407">.</span><span class="ident" id="7614408">Errorf</span><span class="op" id="7614414">(</span><span class="string" id="7614415">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7614441">,</span>&nbsp;<span class="ident" id="7614443">g</span><span class="op" id="7614444">,</span>&nbsp;<span class="ident" id="7614446">w</span><span class="op" id="7614447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7614450">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7614454">if</span>&nbsp;<span class="ident" id="7614457">n</span>&nbsp;<span class="op" id="7614459">:=</span>&nbsp;<span class="ident" id="7614462">db</span><span class="op" id="7614464">.</span><span class="ident" id="7614465">numDepsPollUntil</span><span class="op" id="7614481">(</span><span class="num" id="7614482">2</span><span class="op" id="7614483">,</span>&nbsp;<span class="ident" id="7614485">time</span><span class="op" id="7614489">.</span><span class="ident" id="7614490">Second</span><span class="op" id="7614496">)</span><span class="op" id="7614497">;</span>&nbsp;<span class="ident" id="7614499">n</span>&nbsp;<span class="op" id="7614501">&gt;</span>&nbsp;<span class="num" id="7614503">2</span>&nbsp;<span class="op" id="7614505">{</span><br>
<span class="lineno">1185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7614509">t</span><span class="op" id="7614510">.</span><span class="ident" id="7614511">Errorf</span><span class="op" id="7614517">(</span><span class="string" id="7614518">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;2&#34;</span><span class="op" id="7614562">,</span>&nbsp;<span class="ident" id="7614564">n</span><span class="op" id="7614565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7614569">db</span><span class="op" id="7614571">.</span><span class="ident" id="7614572">dumpDeps</span><span class="op" id="7614580">(</span><span class="ident" id="7614581">t</span><span class="op" id="7614582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7614585">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7614589">db</span><span class="op" id="7614591">.</span><span class="ident" id="7614592">SetMaxIdleConns</span><span class="op" id="7614607">(</span><span class="num" id="7614608">0</span><span class="op" id="7614609">)</span><br>
<span class="lineno">1190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7614613">if</span>&nbsp;<span class="ident" id="7614616">g</span><span class="op" id="7614617">,</span>&nbsp;<span class="ident" id="7614619">w</span>&nbsp;<span class="op" id="7614621">:=</span>&nbsp;<span class="ident" id="7614624">db</span><span class="op" id="7614626">.</span><span class="ident" id="7614627">numFreeConns</span><span class="op" id="7614639">(</span><span class="op" id="7614640">)</span><span class="op" id="7614641">,</span>&nbsp;<span class="num" id="7614643">0</span><span class="op" id="7614644">;</span>&nbsp;<span class="ident" id="7614646">g</span>&nbsp;<span class="op" id="7614648">!=</span>&nbsp;<span class="ident" id="7614651">w</span>&nbsp;<span class="op" id="7614653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7614657">t</span><span class="op" id="7614658">.</span><span class="ident" id="7614659">Errorf</span><span class="op" id="7614665">(</span><span class="string" id="7614666">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7614692">,</span>&nbsp;<span class="ident" id="7614694">g</span><span class="op" id="7614695">,</span>&nbsp;<span class="ident" id="7614697">w</span><span class="op" id="7614698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7614701">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7614705">if</span>&nbsp;<span class="ident" id="7614708">n</span>&nbsp;<span class="op" id="7614710">:=</span>&nbsp;<span class="ident" id="7614713">db</span><span class="op" id="7614715">.</span><span class="ident" id="7614716">numDepsPollUntil</span><span class="op" id="7614732">(</span><span class="num" id="7614733">0</span><span class="op" id="7614734">,</span>&nbsp;<span class="ident" id="7614736">time</span><span class="op" id="7614740">.</span><span class="ident" id="7614741">Second</span><span class="op" id="7614747">)</span><span class="op" id="7614748">;</span>&nbsp;<span class="ident" id="7614750">n</span>&nbsp;<span class="op" id="7614752">&gt;</span>&nbsp;<span class="num" id="7614754">0</span>&nbsp;<span class="op" id="7614756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7614760">t</span><span class="op" id="7614761">.</span><span class="ident" id="7614762">Errorf</span><span class="op" id="7614768">(</span><span class="string" id="7614769">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="7614810">,</span>&nbsp;<span class="ident" id="7614812">n</span><span class="op" id="7614813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7614817">db</span><span class="op" id="7614819">.</span><span class="ident" id="7614820">dumpDeps</span><span class="op" id="7614828">(</span><span class="ident" id="7614829">t</span><span class="op" id="7614830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7614833">}</span><br>
<span class="lineno"></span><span class="op" id="7614835">}</span><br>
<span class="lineno">1200</span><br>
<span class="lineno"></span><span class="comment" id="7614838">//&nbsp;golang.org/issue/5046</span><br>
<span class="lineno"></span><span class="keyword" id="7614863">func</span>&nbsp;<span class="ident" id="7614868">TestCloseConnBeforeStmts</span><span class="op" id="7614892">(</span><span class="ident" id="7614893">t</span>&nbsp;<span class="op" id="7614895">*</span><span class="ident" id="7614896">testing</span><span class="op" id="7614903">.</span><span class="ident" id="7614904">T</span><span class="op" id="7614905">)</span>&nbsp;<span class="op" id="7614907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7614910">db</span>&nbsp;<span class="op" id="7614913">:=</span>&nbsp;<span class="ident" id="7614916">newTestDB</span><span class="op" id="7614925">(</span><span class="ident" id="7614926">t</span><span class="op" id="7614927">,</span>&nbsp;<span class="string" id="7614929">&#34;people&#34;</span><span class="op" id="7614937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7614940">defer</span>&nbsp;<span class="ident" id="7614946">closeDB</span><span class="op" id="7614953">(</span><span class="ident" id="7614954">t</span><span class="op" id="7614955">,</span>&nbsp;<span class="ident" id="7614957">db</span><span class="op" id="7614959">)</span><br>
<span class="lineno">1205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7614963">defer</span>&nbsp;<span class="ident" id="7614969">setHookpostCloseConn</span><span class="op" id="7614989">(</span><span class="ident" id="7614990">nil</span><span class="op" id="7614993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7614996">setHookpostCloseConn</span><span class="op" id="7615016">(</span><span class="keyword" id="7615017">func</span><span class="op" id="7615021">(</span><span class="ident" id="7615022">_</span>&nbsp;<span class="op" id="7615024">*</span><span class="ident" id="7615025">fakeConn</span><span class="op" id="7615033">,</span>&nbsp;<span class="ident" id="7615035">err</span>&nbsp;<span class="builtintype" id="7615039">error</span><span class="op" id="7615044">)</span>&nbsp;<span class="op" id="7615046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7615050">if</span>&nbsp;<span class="ident" id="7615053">err</span>&nbsp;<span class="op" id="7615057">!=</span>&nbsp;<span class="ident" id="7615060">nil</span>&nbsp;<span class="op" id="7615064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7615069">t</span><span class="op" id="7615070">.</span><span class="ident" id="7615071">Errorf</span><span class="op" id="7615077">(</span><span class="string" id="7615078">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v;&nbsp;from&nbsp;%s&#34;</span><span class="op" id="7615115">,</span>&nbsp;<span class="ident" id="7615117">err</span><span class="op" id="7615120">,</span>&nbsp;<span class="ident" id="7615122">stack</span><span class="op" id="7615127">(</span><span class="op" id="7615128">)</span><span class="op" id="7615129">)</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7615134">db</span><span class="op" id="7615136">.</span><span class="ident" id="7615137">dumpDeps</span><span class="op" id="7615145">(</span><span class="ident" id="7615146">t</span><span class="op" id="7615147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7615152">t</span><span class="op" id="7615153">.</span><span class="ident" id="7615154">Errorf</span><span class="op" id="7615160">(</span><span class="string" id="7615161">&#34;DB&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="7615171">,</span>&nbsp;<span class="ident" id="7615173">db</span><span class="op" id="7615175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7615179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7615182">}</span><span class="op" id="7615183">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7615187">stmt</span><span class="op" id="7615191">,</span>&nbsp;<span class="ident" id="7615193">err</span>&nbsp;<span class="op" id="7615197">:=</span>&nbsp;<span class="ident" id="7615200">db</span><span class="op" id="7615202">.</span><span class="ident" id="7615203">Prepare</span><span class="op" id="7615210">(</span><span class="string" id="7615211">&#34;SELECT|people|name|&#34;</span><span class="op" id="7615232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7615235">if</span>&nbsp;<span class="ident" id="7615238">err</span>&nbsp;<span class="op" id="7615242">!=</span>&nbsp;<span class="ident" id="7615245">nil</span>&nbsp;<span class="op" id="7615249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7615253">t</span><span class="op" id="7615254">.</span><span class="ident" id="7615255">Fatal</span><span class="op" id="7615260">(</span><span class="ident" id="7615261">err</span><span class="op" id="7615264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7615267">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7615271">if</span>&nbsp;<span class="builtinfunc" id="7615274">len</span><span class="op" id="7615277">(</span><span class="ident" id="7615278">db</span><span class="op" id="7615280">.</span><span class="ident" id="7615281">freeConn</span><span class="op" id="7615289">)</span>&nbsp;<span class="op" id="7615291">!=</span>&nbsp;<span class="num" id="7615294">1</span>&nbsp;<span class="op" id="7615296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7615300">t</span><span class="op" id="7615301">.</span><span class="ident" id="7615302">Fatalf</span><span class="op" id="7615308">(</span><span class="string" id="7615309">&#34;expected&nbsp;1&nbsp;freeConn;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="7615338">,</span>&nbsp;<span class="builtinfunc" id="7615340">len</span><span class="op" id="7615343">(</span><span class="ident" id="7615344">db</span><span class="op" id="7615346">.</span><span class="ident" id="7615347">freeConn</span><span class="op" id="7615355">)</span><span class="op" id="7615356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7615359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7615362">dc</span>&nbsp;<span class="op" id="7615365">:=</span>&nbsp;<span class="ident" id="7615368">db</span><span class="op" id="7615370">.</span><span class="ident" id="7615371">freeConn</span><span class="op" id="7615379">[</span><span class="num" id="7615380">0</span><span class="op" id="7615381">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7615384">if</span>&nbsp;<span class="ident" id="7615387">dc</span><span class="op" id="7615389">.</span><span class="ident" id="7615390">closed</span>&nbsp;<span class="op" id="7615397">{</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7615401">t</span><span class="op" id="7615402">.</span><span class="ident" id="7615403">Errorf</span><span class="op" id="7615409">(</span><span class="string" id="7615410">&#34;conn&nbsp;shouldn&#39;t&nbsp;be&nbsp;closed&#34;</span><span class="op" id="7615436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7615439">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7615443">if</span>&nbsp;<span class="ident" id="7615446">n</span>&nbsp;<span class="op" id="7615448">:=</span>&nbsp;<span class="builtinfunc" id="7615451">len</span><span class="op" id="7615454">(</span><span class="ident" id="7615455">dc</span><span class="op" id="7615457">.</span><span class="ident" id="7615458">openStmt</span><span class="op" id="7615466">)</span><span class="op" id="7615467">;</span>&nbsp;<span class="ident" id="7615469">n</span>&nbsp;<span class="op" id="7615471">!=</span>&nbsp;<span class="num" id="7615474">1</span>&nbsp;<span class="op" id="7615476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7615480">t</span><span class="op" id="7615481">.</span><span class="ident" id="7615482">Errorf</span><span class="op" id="7615488">(</span><span class="string" id="7615489">&#34;driverConn&nbsp;num&nbsp;openStmt&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7615527">,</span>&nbsp;<span class="ident" id="7615529">n</span><span class="op" id="7615530">)</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7615533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7615536">err</span>&nbsp;<span class="op" id="7615540">=</span>&nbsp;<span class="ident" id="7615542">db</span><span class="op" id="7615544">.</span><span class="ident" id="7615545">Close</span><span class="op" id="7615550">(</span><span class="op" id="7615551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7615554">if</span>&nbsp;<span class="ident" id="7615557">err</span>&nbsp;<span class="op" id="7615561">!=</span>&nbsp;<span class="ident" id="7615564">nil</span>&nbsp;<span class="op" id="7615568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7615572">t</span><span class="op" id="7615573">.</span><span class="ident" id="7615574">Errorf</span><span class="op" id="7615580">(</span><span class="string" id="7615581">&#34;db&nbsp;Close&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7615596">,</span>&nbsp;<span class="ident" id="7615598">err</span><span class="op" id="7615601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7615604">}</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7615607">if</span>&nbsp;<span class="op" id="7615610">!</span><span class="ident" id="7615611">dc</span><span class="op" id="7615613">.</span><span class="ident" id="7615614">closed</span>&nbsp;<span class="op" id="7615621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7615625">t</span><span class="op" id="7615626">.</span><span class="ident" id="7615627">Errorf</span><span class="op" id="7615633">(</span><span class="string" id="7615634">&#34;after&nbsp;db.Close,&nbsp;driverConn&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="7615679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7615682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7615685">if</span>&nbsp;<span class="ident" id="7615688">n</span>&nbsp;<span class="op" id="7615690">:=</span>&nbsp;<span class="builtinfunc" id="7615693">len</span><span class="op" id="7615696">(</span><span class="ident" id="7615697">dc</span><span class="op" id="7615699">.</span><span class="ident" id="7615700">openStmt</span><span class="op" id="7615708">)</span><span class="op" id="7615709">;</span>&nbsp;<span class="ident" id="7615711">n</span>&nbsp;<span class="op" id="7615713">!=</span>&nbsp;<span class="num" id="7615716">0</span>&nbsp;<span class="op" id="7615718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7615722">t</span><span class="op" id="7615723">.</span><span class="ident" id="7615724">Errorf</span><span class="op" id="7615730">(</span><span class="string" id="7615731">&#34;driverConn&nbsp;num&nbsp;openStmt&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="7615769">,</span>&nbsp;<span class="ident" id="7615771">n</span><span class="op" id="7615772">)</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7615775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7615779">err</span>&nbsp;<span class="op" id="7615783">=</span>&nbsp;<span class="ident" id="7615785">stmt</span><span class="op" id="7615789">.</span><span class="ident" id="7615790">Close</span><span class="op" id="7615795">(</span><span class="op" id="7615796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7615799">if</span>&nbsp;<span class="ident" id="7615802">err</span>&nbsp;<span class="op" id="7615806">!=</span>&nbsp;<span class="ident" id="7615809">nil</span>&nbsp;<span class="op" id="7615813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7615817">t</span><span class="op" id="7615818">.</span><span class="ident" id="7615819">Errorf</span><span class="op" id="7615825">(</span><span class="string" id="7615826">&#34;Stmt&nbsp;close&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7615843">,</span>&nbsp;<span class="ident" id="7615845">err</span><span class="op" id="7615848">)</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7615851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7615855">if</span>&nbsp;<span class="op" id="7615858">!</span><span class="ident" id="7615859">dc</span><span class="op" id="7615861">.</span><span class="ident" id="7615862">closed</span>&nbsp;<span class="op" id="7615869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7615873">t</span><span class="op" id="7615874">.</span><span class="ident" id="7615875">Errorf</span><span class="op" id="7615881">(</span><span class="string" id="7615882">&#34;conn&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="7615905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7615908">}</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7615911">if</span>&nbsp;<span class="ident" id="7615914">dc</span><span class="op" id="7615916">.</span><span class="ident" id="7615917">ci</span>&nbsp;<span class="op" id="7615920">!=</span>&nbsp;<span class="ident" id="7615923">nil</span>&nbsp;<span class="op" id="7615927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7615931">t</span><span class="op" id="7615932">.</span><span class="ident" id="7615933">Errorf</span><span class="op" id="7615939">(</span><span class="string" id="7615940">&#34;after&nbsp;Stmt&nbsp;Close,&nbsp;driverConn&#39;s&nbsp;Conn&nbsp;interface&nbsp;should&nbsp;be&nbsp;nil&#34;</span><span class="op" id="7616001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7616004">}</span><br>
<span class="lineno"></span><span class="op" id="7616006">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1255</span><span class="comment" id="7616009">//&nbsp;golang.org/issue/5283:&nbsp;don&#39;t&nbsp;release&nbsp;the&nbsp;Rows&#39;&nbsp;connection&nbsp;in&nbsp;Close</span><br>
<span class="lineno"></span><span class="comment" id="7616079">//&nbsp;before&nbsp;calling&nbsp;Stmt.Close.</span><br>
<span class="lineno"></span><span class="keyword" id="7616109">func</span>&nbsp;<span class="ident" id="7616114">TestRowsCloseOrder</span><span class="op" id="7616132">(</span><span class="ident" id="7616133">t</span>&nbsp;<span class="op" id="7616135">*</span><span class="ident" id="7616136">testing</span><span class="op" id="7616143">.</span><span class="ident" id="7616144">T</span><span class="op" id="7616145">)</span>&nbsp;<span class="op" id="7616147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7616150">db</span>&nbsp;<span class="op" id="7616153">:=</span>&nbsp;<span class="ident" id="7616156">newTestDB</span><span class="op" id="7616165">(</span><span class="ident" id="7616166">t</span><span class="op" id="7616167">,</span>&nbsp;<span class="string" id="7616169">&#34;people&#34;</span><span class="op" id="7616177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7616180">defer</span>&nbsp;<span class="ident" id="7616186">closeDB</span><span class="op" id="7616193">(</span><span class="ident" id="7616194">t</span><span class="op" id="7616195">,</span>&nbsp;<span class="ident" id="7616197">db</span><span class="op" id="7616199">)</span><br>
<span class="lineno">1260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7616203">db</span><span class="op" id="7616205">.</span><span class="ident" id="7616206">SetMaxIdleConns</span><span class="op" id="7616221">(</span><span class="num" id="7616222">0</span><span class="op" id="7616223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7616226">setStrictFakeConnClose</span><span class="op" id="7616248">(</span><span class="ident" id="7616249">t</span><span class="op" id="7616250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7616253">defer</span>&nbsp;<span class="ident" id="7616259">setStrictFakeConnClose</span><span class="op" id="7616281">(</span><span class="ident" id="7616282">nil</span><span class="op" id="7616285">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7616289">rows</span><span class="op" id="7616293">,</span>&nbsp;<span class="ident" id="7616295">err</span>&nbsp;<span class="op" id="7616299">:=</span>&nbsp;<span class="ident" id="7616302">db</span><span class="op" id="7616304">.</span><span class="ident" id="7616305">Query</span><span class="op" id="7616310">(</span><span class="string" id="7616311">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="7616336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7616339">if</span>&nbsp;<span class="ident" id="7616342">err</span>&nbsp;<span class="op" id="7616346">!=</span>&nbsp;<span class="ident" id="7616349">nil</span>&nbsp;<span class="op" id="7616353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7616357">t</span><span class="op" id="7616358">.</span><span class="ident" id="7616359">Fatal</span><span class="op" id="7616364">(</span><span class="ident" id="7616365">err</span><span class="op" id="7616368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7616371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7616374">err</span>&nbsp;<span class="op" id="7616378">=</span>&nbsp;<span class="ident" id="7616380">rows</span><span class="op" id="7616384">.</span><span class="ident" id="7616385">Close</span><span class="op" id="7616390">(</span><span class="op" id="7616391">)</span><br>
<span class="lineno">1270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7616394">if</span>&nbsp;<span class="ident" id="7616397">err</span>&nbsp;<span class="op" id="7616401">!=</span>&nbsp;<span class="ident" id="7616404">nil</span>&nbsp;<span class="op" id="7616408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7616412">t</span><span class="op" id="7616413">.</span><span class="ident" id="7616414">Fatal</span><span class="op" id="7616419">(</span><span class="ident" id="7616420">err</span><span class="op" id="7616423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7616426">}</span><br>
<span class="lineno"></span><span class="op" id="7616428">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1275</span><span class="keyword" id="7616431">func</span>&nbsp;<span class="ident" id="7616436">TestRowsImplicitClose</span><span class="op" id="7616457">(</span><span class="ident" id="7616458">t</span>&nbsp;<span class="op" id="7616460">*</span><span class="ident" id="7616461">testing</span><span class="op" id="7616468">.</span><span class="ident" id="7616469">T</span><span class="op" id="7616470">)</span>&nbsp;<span class="op" id="7616472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7616475">db</span>&nbsp;<span class="op" id="7616478">:=</span>&nbsp;<span class="ident" id="7616481">newTestDB</span><span class="op" id="7616490">(</span><span class="ident" id="7616491">t</span><span class="op" id="7616492">,</span>&nbsp;<span class="string" id="7616494">&#34;people&#34;</span><span class="op" id="7616502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7616505">defer</span>&nbsp;<span class="ident" id="7616511">closeDB</span><span class="op" id="7616518">(</span><span class="ident" id="7616519">t</span><span class="op" id="7616520">,</span>&nbsp;<span class="ident" id="7616522">db</span><span class="op" id="7616524">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7616528">rows</span><span class="op" id="7616532">,</span>&nbsp;<span class="ident" id="7616534">err</span>&nbsp;<span class="op" id="7616538">:=</span>&nbsp;<span class="ident" id="7616541">db</span><span class="op" id="7616543">.</span><span class="ident" id="7616544">Query</span><span class="op" id="7616549">(</span><span class="string" id="7616550">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="7616575">)</span><br>
<span class="lineno">1280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7616578">if</span>&nbsp;<span class="ident" id="7616581">err</span>&nbsp;<span class="op" id="7616585">!=</span>&nbsp;<span class="ident" id="7616588">nil</span>&nbsp;<span class="op" id="7616592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7616596">t</span><span class="op" id="7616597">.</span><span class="ident" id="7616598">Fatal</span><span class="op" id="7616603">(</span><span class="ident" id="7616604">err</span><span class="op" id="7616607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7616610">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7616614">want</span><span class="op" id="7616618">,</span>&nbsp;<span class="ident" id="7616620">fail</span>&nbsp;<span class="op" id="7616625">:=</span>&nbsp;<span class="num" id="7616628">2</span><span class="op" id="7616629">,</span>&nbsp;<span class="ident" id="7616631">errors</span><span class="op" id="7616637">.</span><span class="ident" id="7616638">New</span><span class="op" id="7616641">(</span><span class="string" id="7616642">&#34;fail&#34;</span><span class="op" id="7616648">)</span><br>
<span class="lineno">1285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7616651">r</span>&nbsp;<span class="op" id="7616653">:=</span>&nbsp;<span class="ident" id="7616656">rows</span><span class="op" id="7616660">.</span><span class="ident" id="7616661">rowsi</span><span class="op" id="7616666">.</span><span class="op" id="7616667">(</span><span class="op" id="7616668">*</span><span class="ident" id="7616669">rowsCursor</span><span class="op" id="7616679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7616682">r</span><span class="op" id="7616683">.</span><span class="ident" id="7616684">errPos</span><span class="op" id="7616690">,</span>&nbsp;<span class="ident" id="7616692">r</span><span class="op" id="7616693">.</span><span class="ident" id="7616694">err</span>&nbsp;<span class="op" id="7616698">=</span>&nbsp;<span class="ident" id="7616700">want</span><span class="op" id="7616704">,</span>&nbsp;<span class="ident" id="7616706">fail</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7616713">got</span>&nbsp;<span class="op" id="7616717">:=</span>&nbsp;<span class="num" id="7616720">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7616723">for</span>&nbsp;<span class="ident" id="7616727">rows</span><span class="op" id="7616731">.</span><span class="ident" id="7616732">Next</span><span class="op" id="7616736">(</span><span class="op" id="7616737">)</span>&nbsp;<span class="op" id="7616739">{</span><br>
<span class="lineno">1290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7616743">got</span><span class="op" id="7616746">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7616750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7616753">if</span>&nbsp;<span class="ident" id="7616756">got</span>&nbsp;<span class="op" id="7616760">!=</span>&nbsp;<span class="ident" id="7616763">want</span>&nbsp;<span class="op" id="7616768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7616772">t</span><span class="op" id="7616773">.</span><span class="ident" id="7616774">Errorf</span><span class="op" id="7616780">(</span><span class="string" id="7616781">&#34;got&nbsp;%d&nbsp;rows,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7616803">,</span>&nbsp;<span class="ident" id="7616805">got</span><span class="op" id="7616808">,</span>&nbsp;<span class="ident" id="7616810">want</span><span class="op" id="7616814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7616817">}</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7616820">if</span>&nbsp;<span class="ident" id="7616823">err</span>&nbsp;<span class="op" id="7616827">:=</span>&nbsp;<span class="ident" id="7616830">rows</span><span class="op" id="7616834">.</span><span class="ident" id="7616835">Err</span><span class="op" id="7616838">(</span><span class="op" id="7616839">)</span><span class="op" id="7616840">;</span>&nbsp;<span class="ident" id="7616842">err</span>&nbsp;<span class="op" id="7616846">!=</span>&nbsp;<span class="ident" id="7616849">fail</span>&nbsp;<span class="op" id="7616854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7616858">t</span><span class="op" id="7616859">.</span><span class="ident" id="7616860">Errorf</span><span class="op" id="7616866">(</span><span class="string" id="7616867">&#34;got&nbsp;error&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7616890">,</span>&nbsp;<span class="ident" id="7616892">err</span><span class="op" id="7616895">,</span>&nbsp;<span class="ident" id="7616897">fail</span><span class="op" id="7616901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7616904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7616907">if</span>&nbsp;<span class="op" id="7616910">!</span><span class="ident" id="7616911">r</span><span class="op" id="7616912">.</span><span class="ident" id="7616913">closed</span>&nbsp;<span class="op" id="7616920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7616924">t</span><span class="op" id="7616925">.</span><span class="ident" id="7616926">Errorf</span><span class="op" id="7616932">(</span><span class="string" id="7616933">&#34;r.closed&nbsp;is&nbsp;false,&nbsp;want&nbsp;true&#34;</span><span class="op" id="7616963">)</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7616966">}</span><br>
<span class="lineno"></span><span class="op" id="7616968">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7616971">func</span>&nbsp;<span class="ident" id="7616976">TestStmtCloseOrder</span><span class="op" id="7616994">(</span><span class="ident" id="7616995">t</span>&nbsp;<span class="op" id="7616997">*</span><span class="ident" id="7616998">testing</span><span class="op" id="7617005">.</span><span class="ident" id="7617006">T</span><span class="op" id="7617007">)</span>&nbsp;<span class="op" id="7617009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7617012">db</span>&nbsp;<span class="op" id="7617015">:=</span>&nbsp;<span class="ident" id="7617018">newTestDB</span><span class="op" id="7617027">(</span><span class="ident" id="7617028">t</span><span class="op" id="7617029">,</span>&nbsp;<span class="string" id="7617031">&#34;people&#34;</span><span class="op" id="7617039">)</span><br>
<span class="lineno">1305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7617042">defer</span>&nbsp;<span class="ident" id="7617048">closeDB</span><span class="op" id="7617055">(</span><span class="ident" id="7617056">t</span><span class="op" id="7617057">,</span>&nbsp;<span class="ident" id="7617059">db</span><span class="op" id="7617061">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7617065">db</span><span class="op" id="7617067">.</span><span class="ident" id="7617068">SetMaxIdleConns</span><span class="op" id="7617083">(</span><span class="num" id="7617084">0</span><span class="op" id="7617085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7617088">setStrictFakeConnClose</span><span class="op" id="7617110">(</span><span class="ident" id="7617111">t</span><span class="op" id="7617112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7617115">defer</span>&nbsp;<span class="ident" id="7617121">setStrictFakeConnClose</span><span class="op" id="7617143">(</span><span class="ident" id="7617144">nil</span><span class="op" id="7617147">)</span><br>
<span class="lineno">1310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7617151">_</span><span class="op" id="7617152">,</span>&nbsp;<span class="ident" id="7617154">err</span>&nbsp;<span class="op" id="7617158">:=</span>&nbsp;<span class="ident" id="7617161">db</span><span class="op" id="7617163">.</span><span class="ident" id="7617164">Query</span><span class="op" id="7617169">(</span><span class="string" id="7617170">&#34;SELECT|non_existent|name|&#34;</span><span class="op" id="7617197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7617200">if</span>&nbsp;<span class="ident" id="7617203">err</span>&nbsp;<span class="op" id="7617207">==</span>&nbsp;<span class="ident" id="7617210">nil</span>&nbsp;<span class="op" id="7617214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7617218">t</span><span class="op" id="7617219">.</span><span class="ident" id="7617220">Fatal</span><span class="op" id="7617225">(</span><span class="string" id="7617226">&#34;Quering&nbsp;non-existent&nbsp;table&nbsp;should&nbsp;fail&#34;</span><span class="op" id="7617266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7617269">}</span><br>
<span class="lineno">1315</span><span class="op" id="7617271">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7617274">//&nbsp;golang.org/issue/5781</span><br>
<span class="lineno"></span><span class="keyword" id="7617299">func</span>&nbsp;<span class="ident" id="7617304">TestErrBadConnReconnect</span><span class="op" id="7617327">(</span><span class="ident" id="7617328">t</span>&nbsp;<span class="op" id="7617330">*</span><span class="ident" id="7617331">testing</span><span class="op" id="7617338">.</span><span class="ident" id="7617339">T</span><span class="op" id="7617340">)</span>&nbsp;<span class="op" id="7617342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7617345">db</span>&nbsp;<span class="op" id="7617348">:=</span>&nbsp;<span class="ident" id="7617351">newTestDB</span><span class="op" id="7617360">(</span><span class="ident" id="7617361">t</span><span class="op" id="7617362">,</span>&nbsp;<span class="string" id="7617364">&#34;foo&#34;</span><span class="op" id="7617369">)</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7617372">defer</span>&nbsp;<span class="ident" id="7617378">closeDB</span><span class="op" id="7617385">(</span><span class="ident" id="7617386">t</span><span class="op" id="7617387">,</span>&nbsp;<span class="ident" id="7617389">db</span><span class="op" id="7617391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7617394">exec</span><span class="op" id="7617398">(</span><span class="ident" id="7617399">t</span><span class="op" id="7617400">,</span>&nbsp;<span class="ident" id="7617402">db</span><span class="op" id="7617404">,</span>&nbsp;<span class="string" id="7617406">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7617449">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7617453">simulateBadConn</span>&nbsp;<span class="op" id="7617469">:=</span>&nbsp;<span class="keyword" id="7617472">func</span><span class="op" id="7617476">(</span><span class="ident" id="7617477">name</span>&nbsp;<span class="builtintype" id="7617482">string</span><span class="op" id="7617488">,</span>&nbsp;<span class="ident" id="7617490">hook</span>&nbsp;<span class="op" id="7617495">*</span><span class="keyword" id="7617496">func</span><span class="op" id="7617500">(</span><span class="op" id="7617501">)</span>&nbsp;<span class="builtintype" id="7617503">bool</span><span class="op" id="7617507">,</span>&nbsp;<span class="ident" id="7617509">op</span>&nbsp;<span class="keyword" id="7617512">func</span><span class="op" id="7617516">(</span><span class="op" id="7617517">)</span>&nbsp;<span class="builtintype" id="7617519">error</span><span class="op" id="7617524">)</span>&nbsp;<span class="op" id="7617526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7617530">broken</span><span class="op" id="7617536">,</span>&nbsp;<span class="ident" id="7617538">retried</span>&nbsp;<span class="op" id="7617546">:=</span>&nbsp;<span class="builtintype" id="7617549">false</span><span class="op" id="7617554">,</span>&nbsp;<span class="builtintype" id="7617556">false</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7617564">numOpen</span>&nbsp;<span class="op" id="7617572">:=</span>&nbsp;<span class="ident" id="7617575">db</span><span class="op" id="7617577">.</span><span class="ident" id="7617578">numOpen</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7617589">//&nbsp;simulate&nbsp;a&nbsp;broken&nbsp;connection&nbsp;on&nbsp;the&nbsp;first&nbsp;try</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7617640">*</span><span class="ident" id="7617641">hook</span>&nbsp;<span class="op" id="7617646">=</span>&nbsp;<span class="keyword" id="7617648">func</span><span class="op" id="7617652">(</span><span class="op" id="7617653">)</span>&nbsp;<span class="builtintype" id="7617655">bool</span>&nbsp;<span class="op" id="7617660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7617665">if</span>&nbsp;<span class="op" id="7617668">!</span><span class="ident" id="7617669">broken</span>&nbsp;<span class="op" id="7617676">{</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7617682">broken</span>&nbsp;<span class="op" id="7617689">=</span>&nbsp;<span class="builtintype" id="7617691">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7617700">return</span>&nbsp;<span class="builtintype" id="7617707">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7617715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7617720">retried</span>&nbsp;<span class="op" id="7617728">=</span>&nbsp;<span class="builtintype" id="7617730">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7617738">return</span>&nbsp;<span class="builtintype" id="7617745">false</span><br>
<span class="lineno">1335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7617753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7617758">if</span>&nbsp;<span class="ident" id="7617761">err</span>&nbsp;<span class="op" id="7617765">:=</span>&nbsp;<span class="ident" id="7617768">op</span><span class="op" id="7617770">(</span><span class="op" id="7617771">)</span><span class="op" id="7617772">;</span>&nbsp;<span class="ident" id="7617774">err</span>&nbsp;<span class="op" id="7617778">!=</span>&nbsp;<span class="ident" id="7617781">nil</span>&nbsp;<span class="op" id="7617785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7617790">t</span><span class="op" id="7617791">.</span><span class="ident" id="7617792">Errorf</span><span class="op" id="7617798">(</span><span class="ident" id="7617799">name</span><span class="op" id="7617803">+</span><span class="string" id="7617804">&#34;:&nbsp;%v&#34;</span><span class="op" id="7617810">,</span>&nbsp;<span class="ident" id="7617812">err</span><span class="op" id="7617815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7617820">return</span><br>
<span class="lineno">1340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7617829">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7617834">if</span>&nbsp;<span class="op" id="7617837">!</span><span class="ident" id="7617838">broken</span>&nbsp;<span class="op" id="7617845">||</span>&nbsp;<span class="op" id="7617848">!</span><span class="ident" id="7617849">retried</span>&nbsp;<span class="op" id="7617857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7617862">t</span><span class="op" id="7617863">.</span><span class="ident" id="7617864">Error</span><span class="op" id="7617869">(</span><span class="ident" id="7617870">name</span>&nbsp;<span class="op" id="7617875">+</span>&nbsp;<span class="string" id="7617877">&#34;:&nbsp;Failed&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connection&#34;</span><span class="op" id="7617917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7617921">}</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7617925">*</span><span class="ident" id="7617926">hook</span>&nbsp;<span class="op" id="7617931">=</span>&nbsp;<span class="ident" id="7617933">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7617940">if</span>&nbsp;<span class="ident" id="7617943">numOpen</span>&nbsp;<span class="op" id="7617951">!=</span>&nbsp;<span class="ident" id="7617954">db</span><span class="op" id="7617956">.</span><span class="ident" id="7617957">numOpen</span>&nbsp;<span class="op" id="7617965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7617970">t</span><span class="op" id="7617971">.</span><span class="ident" id="7617972">Errorf</span><span class="op" id="7617978">(</span><span class="ident" id="7617979">name</span><span class="op" id="7617983">+</span><span class="string" id="7617984">&#34;:&nbsp;leaked&nbsp;%d&nbsp;connection(s)!&#34;</span><span class="op" id="7618012">,</span>&nbsp;<span class="ident" id="7618014">db</span><span class="op" id="7618016">.</span><span class="ident" id="7618017">numOpen</span><span class="op" id="7618024">-</span><span class="ident" id="7618025">numOpen</span><span class="op" id="7618032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7618037">numOpen</span>&nbsp;<span class="op" id="7618045">=</span>&nbsp;<span class="ident" id="7618047">db</span><span class="op" id="7618049">.</span><span class="ident" id="7618050">numOpen</span><br>
<span class="lineno">1350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7618060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7618063">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7618067">//&nbsp;db.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7618079">dbExec</span>&nbsp;<span class="op" id="7618086">:=</span>&nbsp;<span class="keyword" id="7618089">func</span><span class="op" id="7618093">(</span><span class="op" id="7618094">)</span>&nbsp;<span class="builtintype" id="7618096">error</span>&nbsp;<span class="op" id="7618102">{</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7618106">_</span><span class="op" id="7618107">,</span>&nbsp;<span class="ident" id="7618109">err</span>&nbsp;<span class="op" id="7618113">:=</span>&nbsp;<span class="ident" id="7618116">db</span><span class="op" id="7618118">.</span><span class="ident" id="7618119">Exec</span><span class="op" id="7618123">(</span><span class="string" id="7618124">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="7618155">,</span>&nbsp;<span class="string" id="7618157">&#34;Gordon&#34;</span><span class="op" id="7618165">,</span>&nbsp;<span class="num" id="7618167">3</span><span class="op" id="7618168">,</span>&nbsp;<span class="builtintype" id="7618170">true</span><span class="op" id="7618174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7618178">return</span>&nbsp;<span class="ident" id="7618185">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7618190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7618193">simulateBadConn</span><span class="op" id="7618208">(</span><span class="string" id="7618209">&#34;db.Exec&nbsp;prepare&#34;</span><span class="op" id="7618226">,</span>&nbsp;<span class="op" id="7618228">&amp;</span><span class="ident" id="7618229">hookPrepareBadConn</span><span class="op" id="7618247">,</span>&nbsp;<span class="ident" id="7618249">dbExec</span><span class="op" id="7618255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7618258">simulateBadConn</span><span class="op" id="7618273">(</span><span class="string" id="7618274">&#34;db.Exec&nbsp;exec&#34;</span><span class="op" id="7618288">,</span>&nbsp;<span class="op" id="7618290">&amp;</span><span class="ident" id="7618291">hookExecBadConn</span><span class="op" id="7618306">,</span>&nbsp;<span class="ident" id="7618308">dbExec</span><span class="op" id="7618314">)</span><br>
<span class="lineno">1360</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7618318">//&nbsp;db.Query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7618331">dbQuery</span>&nbsp;<span class="op" id="7618339">:=</span>&nbsp;<span class="keyword" id="7618342">func</span><span class="op" id="7618346">(</span><span class="op" id="7618347">)</span>&nbsp;<span class="builtintype" id="7618349">error</span>&nbsp;<span class="op" id="7618355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7618359">rows</span><span class="op" id="7618363">,</span>&nbsp;<span class="ident" id="7618365">err</span>&nbsp;<span class="op" id="7618369">:=</span>&nbsp;<span class="ident" id="7618372">db</span><span class="op" id="7618374">.</span><span class="ident" id="7618375">Query</span><span class="op" id="7618380">(</span><span class="string" id="7618381">&#34;SELECT|t1|age,name|&#34;</span><span class="op" id="7618402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7618406">if</span>&nbsp;<span class="ident" id="7618409">err</span>&nbsp;<span class="op" id="7618413">==</span>&nbsp;<span class="ident" id="7618416">nil</span>&nbsp;<span class="op" id="7618420">{</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7618425">err</span>&nbsp;<span class="op" id="7618429">=</span>&nbsp;<span class="ident" id="7618431">rows</span><span class="op" id="7618435">.</span><span class="ident" id="7618436">Close</span><span class="op" id="7618441">(</span><span class="op" id="7618442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7618446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7618450">return</span>&nbsp;<span class="ident" id="7618457">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7618462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7618465">simulateBadConn</span><span class="op" id="7618480">(</span><span class="string" id="7618481">&#34;db.Query&nbsp;prepare&#34;</span><span class="op" id="7618499">,</span>&nbsp;<span class="op" id="7618501">&amp;</span><span class="ident" id="7618502">hookPrepareBadConn</span><span class="op" id="7618520">,</span>&nbsp;<span class="ident" id="7618522">dbQuery</span><span class="op" id="7618529">)</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7618532">simulateBadConn</span><span class="op" id="7618547">(</span><span class="string" id="7618548">&#34;db.Query&nbsp;query&#34;</span><span class="op" id="7618564">,</span>&nbsp;<span class="op" id="7618566">&amp;</span><span class="ident" id="7618567">hookQueryBadConn</span><span class="op" id="7618583">,</span>&nbsp;<span class="ident" id="7618585">dbQuery</span><span class="op" id="7618592">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7618596">//&nbsp;db.Prepare</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7618611">simulateBadConn</span><span class="op" id="7618626">(</span><span class="string" id="7618627">&#34;db.Prepare&#34;</span><span class="op" id="7618639">,</span>&nbsp;<span class="op" id="7618641">&amp;</span><span class="ident" id="7618642">hookPrepareBadConn</span><span class="op" id="7618660">,</span>&nbsp;<span class="keyword" id="7618662">func</span><span class="op" id="7618666">(</span><span class="op" id="7618667">)</span>&nbsp;<span class="builtintype" id="7618669">error</span>&nbsp;<span class="op" id="7618675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7618679">stmt</span><span class="op" id="7618683">,</span>&nbsp;<span class="ident" id="7618685">err</span>&nbsp;<span class="op" id="7618689">:=</span>&nbsp;<span class="ident" id="7618692">db</span><span class="op" id="7618694">.</span><span class="ident" id="7618695">Prepare</span><span class="op" id="7618702">(</span><span class="string" id="7618703">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="7618734">)</span><br>
<span class="lineno">1375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7618738">if</span>&nbsp;<span class="ident" id="7618741">err</span>&nbsp;<span class="op" id="7618745">!=</span>&nbsp;<span class="ident" id="7618748">nil</span>&nbsp;<span class="op" id="7618752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7618757">return</span>&nbsp;<span class="ident" id="7618764">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7618770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7618774">stmt</span><span class="op" id="7618778">.</span><span class="ident" id="7618779">Close</span><span class="op" id="7618784">(</span><span class="op" id="7618785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7618789">return</span>&nbsp;<span class="ident" id="7618796">nil</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7618801">}</span><span class="op" id="7618802">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7618806">//&nbsp;Provide&nbsp;a&nbsp;way&nbsp;to&nbsp;force&nbsp;a&nbsp;re-prepare&nbsp;of&nbsp;a&nbsp;statement&nbsp;on&nbsp;next&nbsp;execution</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7618879">forcePrepare</span>&nbsp;<span class="op" id="7618892">:=</span>&nbsp;<span class="keyword" id="7618895">func</span><span class="op" id="7618899">(</span><span class="ident" id="7618900">stmt</span>&nbsp;<span class="op" id="7618905">*</span><span class="ident" id="7618906">Stmt</span><span class="op" id="7618910">)</span>&nbsp;<span class="op" id="7618912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7618916">stmt</span><span class="op" id="7618920">.</span><span class="ident" id="7618921">css</span>&nbsp;<span class="op" id="7618925">=</span>&nbsp;<span class="ident" id="7618927">nil</span><br>
<span class="lineno">1385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7618932">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7618936">//&nbsp;stmt.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7618950">stmt1</span><span class="op" id="7618955">,</span>&nbsp;<span class="ident" id="7618957">err</span>&nbsp;<span class="op" id="7618961">:=</span>&nbsp;<span class="ident" id="7618964">db</span><span class="op" id="7618966">.</span><span class="ident" id="7618967">Prepare</span><span class="op" id="7618974">(</span><span class="string" id="7618975">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="7619006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7619009">if</span>&nbsp;<span class="ident" id="7619012">err</span>&nbsp;<span class="op" id="7619016">!=</span>&nbsp;<span class="ident" id="7619019">nil</span>&nbsp;<span class="op" id="7619023">{</span><br>
<span class="lineno">1390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619027">t</span><span class="op" id="7619028">.</span><span class="ident" id="7619029">Fatalf</span><span class="op" id="7619035">(</span><span class="string" id="7619036">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="7619049">,</span>&nbsp;<span class="ident" id="7619051">err</span><span class="op" id="7619054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7619057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7619060">defer</span>&nbsp;<span class="ident" id="7619066">stmt1</span><span class="op" id="7619071">.</span><span class="ident" id="7619072">Close</span><span class="op" id="7619077">(</span><span class="op" id="7619078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7619081">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;must&nbsp;prepare&nbsp;the&nbsp;stmt&nbsp;first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619126">forcePrepare</span><span class="op" id="7619138">(</span><span class="ident" id="7619139">stmt1</span><span class="op" id="7619144">)</span><br>
<span class="lineno">1395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619148">stmtExec</span>&nbsp;<span class="op" id="7619157">:=</span>&nbsp;<span class="keyword" id="7619160">func</span><span class="op" id="7619164">(</span><span class="op" id="7619165">)</span>&nbsp;<span class="builtintype" id="7619167">error</span>&nbsp;<span class="op" id="7619173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619177">_</span><span class="op" id="7619178">,</span>&nbsp;<span class="ident" id="7619180">err</span>&nbsp;<span class="op" id="7619184">:=</span>&nbsp;<span class="ident" id="7619187">stmt1</span><span class="op" id="7619192">.</span><span class="ident" id="7619193">Exec</span><span class="op" id="7619197">(</span><span class="string" id="7619198">&#34;Gopher&#34;</span><span class="op" id="7619206">,</span>&nbsp;<span class="num" id="7619208">3</span><span class="op" id="7619209">,</span>&nbsp;<span class="builtintype" id="7619211">false</span><span class="op" id="7619216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7619220">return</span>&nbsp;<span class="ident" id="7619227">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7619232">}</span><br>
<span class="lineno">1400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619235">simulateBadConn</span><span class="op" id="7619250">(</span><span class="string" id="7619251">&#34;stmt.Exec&nbsp;prepare&#34;</span><span class="op" id="7619270">,</span>&nbsp;<span class="op" id="7619272">&amp;</span><span class="ident" id="7619273">hookPrepareBadConn</span><span class="op" id="7619291">,</span>&nbsp;<span class="ident" id="7619293">stmtExec</span><span class="op" id="7619301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619304">simulateBadConn</span><span class="op" id="7619319">(</span><span class="string" id="7619320">&#34;stmt.Exec&nbsp;exec&#34;</span><span class="op" id="7619336">,</span>&nbsp;<span class="op" id="7619338">&amp;</span><span class="ident" id="7619339">hookExecBadConn</span><span class="op" id="7619354">,</span>&nbsp;<span class="ident" id="7619356">stmtExec</span><span class="op" id="7619364">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7619368">//&nbsp;stmt.Query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619383">stmt2</span><span class="op" id="7619388">,</span>&nbsp;<span class="ident" id="7619390">err</span>&nbsp;<span class="op" id="7619394">:=</span>&nbsp;<span class="ident" id="7619397">db</span><span class="op" id="7619399">.</span><span class="ident" id="7619400">Prepare</span><span class="op" id="7619407">(</span><span class="string" id="7619408">&#34;SELECT|t1|age,name|&#34;</span><span class="op" id="7619429">)</span><br>
<span class="lineno">1405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7619432">if</span>&nbsp;<span class="ident" id="7619435">err</span>&nbsp;<span class="op" id="7619439">!=</span>&nbsp;<span class="ident" id="7619442">nil</span>&nbsp;<span class="op" id="7619446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619450">t</span><span class="op" id="7619451">.</span><span class="ident" id="7619452">Fatalf</span><span class="op" id="7619458">(</span><span class="string" id="7619459">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="7619472">,</span>&nbsp;<span class="ident" id="7619474">err</span><span class="op" id="7619477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7619480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7619483">defer</span>&nbsp;<span class="ident" id="7619489">stmt2</span><span class="op" id="7619494">.</span><span class="ident" id="7619495">Close</span><span class="op" id="7619500">(</span><span class="op" id="7619501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7619504">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;must&nbsp;prepare&nbsp;the&nbsp;stmt&nbsp;first</span><br>
<span class="lineno">1410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619549">forcePrepare</span><span class="op" id="7619561">(</span><span class="ident" id="7619562">stmt2</span><span class="op" id="7619567">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619571">stmtQuery</span>&nbsp;<span class="op" id="7619581">:=</span>&nbsp;<span class="keyword" id="7619584">func</span><span class="op" id="7619588">(</span><span class="op" id="7619589">)</span>&nbsp;<span class="builtintype" id="7619591">error</span>&nbsp;<span class="op" id="7619597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619601">rows</span><span class="op" id="7619605">,</span>&nbsp;<span class="ident" id="7619607">err</span>&nbsp;<span class="op" id="7619611">:=</span>&nbsp;<span class="ident" id="7619614">stmt2</span><span class="op" id="7619619">.</span><span class="ident" id="7619620">Query</span><span class="op" id="7619625">(</span><span class="op" id="7619626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7619630">if</span>&nbsp;<span class="ident" id="7619633">err</span>&nbsp;<span class="op" id="7619637">==</span>&nbsp;<span class="ident" id="7619640">nil</span>&nbsp;<span class="op" id="7619644">{</span><br>
<span class="lineno">1415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619649">err</span>&nbsp;<span class="op" id="7619653">=</span>&nbsp;<span class="ident" id="7619655">rows</span><span class="op" id="7619659">.</span><span class="ident" id="7619660">Close</span><span class="op" id="7619665">(</span><span class="op" id="7619666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7619670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7619674">return</span>&nbsp;<span class="ident" id="7619681">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7619686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619689">simulateBadConn</span><span class="op" id="7619704">(</span><span class="string" id="7619705">&#34;stmt.Query&nbsp;prepare&#34;</span><span class="op" id="7619725">,</span>&nbsp;<span class="op" id="7619727">&amp;</span><span class="ident" id="7619728">hookPrepareBadConn</span><span class="op" id="7619746">,</span>&nbsp;<span class="ident" id="7619748">stmtQuery</span><span class="op" id="7619757">)</span><br>
<span class="lineno">1420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619760">simulateBadConn</span><span class="op" id="7619775">(</span><span class="string" id="7619776">&#34;stmt.Query&nbsp;exec&#34;</span><span class="op" id="7619793">,</span>&nbsp;<span class="op" id="7619795">&amp;</span><span class="ident" id="7619796">hookQueryBadConn</span><span class="op" id="7619812">,</span>&nbsp;<span class="ident" id="7619814">stmtQuery</span><span class="op" id="7619823">)</span><br>
<span class="lineno"></span><span class="op" id="7619825">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7619828">type</span>&nbsp;<span class="ident" id="7619833">concurrentTest</span>&nbsp;<span class="keyword" id="7619848">interface</span>&nbsp;<span class="op" id="7619858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619861">init</span><span class="op" id="7619865">(</span><span class="ident" id="7619866">t</span>&nbsp;<span class="ident" id="7619868">testing</span><span class="op" id="7619875">.</span><span class="ident" id="7619876">TB</span><span class="op" id="7619878">,</span>&nbsp;<span class="ident" id="7619880">db</span>&nbsp;<span class="op" id="7619883">*</span><span class="ident" id="7619884">DB</span><span class="op" id="7619886">)</span><br>
<span class="lineno">1425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619889">finish</span><span class="op" id="7619895">(</span><span class="ident" id="7619896">t</span>&nbsp;<span class="ident" id="7619898">testing</span><span class="op" id="7619905">.</span><span class="ident" id="7619906">TB</span><span class="op" id="7619908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619911">test</span><span class="op" id="7619915">(</span><span class="ident" id="7619916">t</span>&nbsp;<span class="ident" id="7619918">testing</span><span class="op" id="7619925">.</span><span class="ident" id="7619926">TB</span><span class="op" id="7619928">)</span>&nbsp;<span class="builtintype" id="7619930">error</span><br>
<span class="lineno"></span><span class="op" id="7619936">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7619939">type</span>&nbsp;<span class="ident" id="7619944">concurrentDBQueryTest</span>&nbsp;<span class="keyword" id="7619966">struct</span>&nbsp;<span class="op" id="7619973">{</span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619976">db</span>&nbsp;<span class="op" id="7619979">*</span><span class="ident" id="7619980">DB</span><br>
<span class="lineno"></span><span class="op" id="7619983">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7619986">func</span>&nbsp;<span class="op" id="7619991">(</span><span class="ident" id="7619992">c</span>&nbsp;<span class="op" id="7619994">*</span><span class="ident" id="7619995">concurrentDBQueryTest</span><span class="op" id="7620016">)</span>&nbsp;<span class="ident" id="7620018">init</span><span class="op" id="7620022">(</span><span class="ident" id="7620023">t</span>&nbsp;<span class="ident" id="7620025">testing</span><span class="op" id="7620032">.</span><span class="ident" id="7620033">TB</span><span class="op" id="7620035">,</span>&nbsp;<span class="ident" id="7620037">db</span>&nbsp;<span class="op" id="7620040">*</span><span class="ident" id="7620041">DB</span><span class="op" id="7620043">)</span>&nbsp;<span class="op" id="7620045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620048">c</span><span class="op" id="7620049">.</span><span class="ident" id="7620050">db</span>&nbsp;<span class="op" id="7620053">=</span>&nbsp;<span class="ident" id="7620055">db</span><br>
<span class="lineno">1435</span><span class="op" id="7620058">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7620061">func</span>&nbsp;<span class="op" id="7620066">(</span><span class="ident" id="7620067">c</span>&nbsp;<span class="op" id="7620069">*</span><span class="ident" id="7620070">concurrentDBQueryTest</span><span class="op" id="7620091">)</span>&nbsp;<span class="ident" id="7620093">finish</span><span class="op" id="7620099">(</span><span class="ident" id="7620100">t</span>&nbsp;<span class="ident" id="7620102">testing</span><span class="op" id="7620109">.</span><span class="ident" id="7620110">TB</span><span class="op" id="7620112">)</span>&nbsp;<span class="op" id="7620114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620117">c</span><span class="op" id="7620118">.</span><span class="ident" id="7620119">db</span>&nbsp;<span class="op" id="7620122">=</span>&nbsp;<span class="ident" id="7620124">nil</span><br>
<span class="lineno"></span><span class="op" id="7620128">}</span><br>
<span class="lineno">1440</span><br>
<span class="lineno"></span><span class="keyword" id="7620131">func</span>&nbsp;<span class="op" id="7620136">(</span><span class="ident" id="7620137">c</span>&nbsp;<span class="op" id="7620139">*</span><span class="ident" id="7620140">concurrentDBQueryTest</span><span class="op" id="7620161">)</span>&nbsp;<span class="ident" id="7620163">test</span><span class="op" id="7620167">(</span><span class="ident" id="7620168">t</span>&nbsp;<span class="ident" id="7620170">testing</span><span class="op" id="7620177">.</span><span class="ident" id="7620178">TB</span><span class="op" id="7620180">)</span>&nbsp;<span class="builtintype" id="7620182">error</span>&nbsp;<span class="op" id="7620188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620191">rows</span><span class="op" id="7620195">,</span>&nbsp;<span class="ident" id="7620197">err</span>&nbsp;<span class="op" id="7620201">:=</span>&nbsp;<span class="ident" id="7620204">c</span><span class="op" id="7620205">.</span><span class="ident" id="7620206">db</span><span class="op" id="7620208">.</span><span class="ident" id="7620209">Query</span><span class="op" id="7620214">(</span><span class="string" id="7620215">&#34;SELECT|people|name|&#34;</span><span class="op" id="7620236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7620239">if</span>&nbsp;<span class="ident" id="7620242">err</span>&nbsp;<span class="op" id="7620246">!=</span>&nbsp;<span class="ident" id="7620249">nil</span>&nbsp;<span class="op" id="7620253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620257">t</span><span class="op" id="7620258">.</span><span class="ident" id="7620259">Error</span><span class="op" id="7620264">(</span><span class="ident" id="7620265">err</span><span class="op" id="7620268">)</span><br>
<span class="lineno">1445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7620272">return</span>&nbsp;<span class="ident" id="7620279">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7620284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7620287">var</span>&nbsp;<span class="ident" id="7620291">name</span>&nbsp;<span class="builtintype" id="7620296">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7620304">for</span>&nbsp;<span class="ident" id="7620308">rows</span><span class="op" id="7620312">.</span><span class="ident" id="7620313">Next</span><span class="op" id="7620317">(</span><span class="op" id="7620318">)</span>&nbsp;<span class="op" id="7620320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620324">rows</span><span class="op" id="7620328">.</span><span class="ident" id="7620329">Scan</span><span class="op" id="7620333">(</span><span class="op" id="7620334">&amp;</span><span class="ident" id="7620335">name</span><span class="op" id="7620339">)</span><br>
<span class="lineno">1450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7620342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620345">rows</span><span class="op" id="7620349">.</span><span class="ident" id="7620350">Close</span><span class="op" id="7620355">(</span><span class="op" id="7620356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7620359">return</span>&nbsp;<span class="ident" id="7620366">nil</span><br>
<span class="lineno"></span><span class="op" id="7620370">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1455</span><span class="keyword" id="7620373">type</span>&nbsp;<span class="ident" id="7620378">concurrentDBExecTest</span>&nbsp;<span class="keyword" id="7620399">struct</span>&nbsp;<span class="op" id="7620406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620409">db</span>&nbsp;<span class="op" id="7620412">*</span><span class="ident" id="7620413">DB</span><br>
<span class="lineno"></span><span class="op" id="7620416">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7620419">func</span>&nbsp;<span class="op" id="7620424">(</span><span class="ident" id="7620425">c</span>&nbsp;<span class="op" id="7620427">*</span><span class="ident" id="7620428">concurrentDBExecTest</span><span class="op" id="7620448">)</span>&nbsp;<span class="ident" id="7620450">init</span><span class="op" id="7620454">(</span><span class="ident" id="7620455">t</span>&nbsp;<span class="ident" id="7620457">testing</span><span class="op" id="7620464">.</span><span class="ident" id="7620465">TB</span><span class="op" id="7620467">,</span>&nbsp;<span class="ident" id="7620469">db</span>&nbsp;<span class="op" id="7620472">*</span><span class="ident" id="7620473">DB</span><span class="op" id="7620475">)</span>&nbsp;<span class="op" id="7620477">{</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620480">c</span><span class="op" id="7620481">.</span><span class="ident" id="7620482">db</span>&nbsp;<span class="op" id="7620485">=</span>&nbsp;<span class="ident" id="7620487">db</span><br>
<span class="lineno"></span><span class="op" id="7620490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7620493">func</span>&nbsp;<span class="op" id="7620498">(</span><span class="ident" id="7620499">c</span>&nbsp;<span class="op" id="7620501">*</span><span class="ident" id="7620502">concurrentDBExecTest</span><span class="op" id="7620522">)</span>&nbsp;<span class="ident" id="7620524">finish</span><span class="op" id="7620530">(</span><span class="ident" id="7620531">t</span>&nbsp;<span class="ident" id="7620533">testing</span><span class="op" id="7620540">.</span><span class="ident" id="7620541">TB</span><span class="op" id="7620543">)</span>&nbsp;<span class="op" id="7620545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620548">c</span><span class="op" id="7620549">.</span><span class="ident" id="7620550">db</span>&nbsp;<span class="op" id="7620553">=</span>&nbsp;<span class="ident" id="7620555">nil</span><br>
<span class="lineno">1465</span><span class="op" id="7620559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7620562">func</span>&nbsp;<span class="op" id="7620567">(</span><span class="ident" id="7620568">c</span>&nbsp;<span class="op" id="7620570">*</span><span class="ident" id="7620571">concurrentDBExecTest</span><span class="op" id="7620591">)</span>&nbsp;<span class="ident" id="7620593">test</span><span class="op" id="7620597">(</span><span class="ident" id="7620598">t</span>&nbsp;<span class="ident" id="7620600">testing</span><span class="op" id="7620607">.</span><span class="ident" id="7620608">TB</span><span class="op" id="7620610">)</span>&nbsp;<span class="builtintype" id="7620612">error</span>&nbsp;<span class="op" id="7620618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620621">_</span><span class="op" id="7620622">,</span>&nbsp;<span class="ident" id="7620624">err</span>&nbsp;<span class="op" id="7620628">:=</span>&nbsp;<span class="ident" id="7620631">c</span><span class="op" id="7620632">.</span><span class="ident" id="7620633">db</span><span class="op" id="7620635">.</span><span class="ident" id="7620636">Exec</span><span class="op" id="7620640">(</span><span class="string" id="7620641">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="7620694">,</span>&nbsp;<span class="num" id="7620696">3</span><span class="op" id="7620697">,</span>&nbsp;<span class="ident" id="7620699">chrisBirthday</span><span class="op" id="7620712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7620715">if</span>&nbsp;<span class="ident" id="7620718">err</span>&nbsp;<span class="op" id="7620722">!=</span>&nbsp;<span class="ident" id="7620725">nil</span>&nbsp;<span class="op" id="7620729">{</span><br>
<span class="lineno">1470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620733">t</span><span class="op" id="7620734">.</span><span class="ident" id="7620735">Error</span><span class="op" id="7620740">(</span><span class="ident" id="7620741">err</span><span class="op" id="7620744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7620748">return</span>&nbsp;<span class="ident" id="7620755">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7620760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7620763">return</span>&nbsp;<span class="ident" id="7620770">nil</span><br>
<span class="lineno"></span><span class="op" id="7620774">}</span><br>
<span class="lineno">1475</span><br>
<span class="lineno"></span><span class="keyword" id="7620777">type</span>&nbsp;<span class="ident" id="7620782">concurrentStmtQueryTest</span>&nbsp;<span class="keyword" id="7620806">struct</span>&nbsp;<span class="op" id="7620813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620816">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7620821">*</span><span class="ident" id="7620822">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620826">stmt</span>&nbsp;<span class="op" id="7620831">*</span><span class="ident" id="7620832">Stmt</span><br>
<span class="lineno"></span><span class="op" id="7620837">}</span><br>
<span class="lineno">1480</span><br>
<span class="lineno"></span><span class="keyword" id="7620840">func</span>&nbsp;<span class="op" id="7620845">(</span><span class="ident" id="7620846">c</span>&nbsp;<span class="op" id="7620848">*</span><span class="ident" id="7620849">concurrentStmtQueryTest</span><span class="op" id="7620872">)</span>&nbsp;<span class="ident" id="7620874">init</span><span class="op" id="7620878">(</span><span class="ident" id="7620879">t</span>&nbsp;<span class="ident" id="7620881">testing</span><span class="op" id="7620888">.</span><span class="ident" id="7620889">TB</span><span class="op" id="7620891">,</span>&nbsp;<span class="ident" id="7620893">db</span>&nbsp;<span class="op" id="7620896">*</span><span class="ident" id="7620897">DB</span><span class="op" id="7620899">)</span>&nbsp;<span class="op" id="7620901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620904">c</span><span class="op" id="7620905">.</span><span class="ident" id="7620906">db</span>&nbsp;<span class="op" id="7620909">=</span>&nbsp;<span class="ident" id="7620911">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7620915">var</span>&nbsp;<span class="ident" id="7620919">err</span>&nbsp;<span class="builtintype" id="7620923">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620930">c</span><span class="op" id="7620931">.</span><span class="ident" id="7620932">stmt</span><span class="op" id="7620936">,</span>&nbsp;<span class="ident" id="7620938">err</span>&nbsp;<span class="op" id="7620942">=</span>&nbsp;<span class="ident" id="7620944">db</span><span class="op" id="7620946">.</span><span class="ident" id="7620947">Prepare</span><span class="op" id="7620954">(</span><span class="string" id="7620955">&#34;SELECT|people|name|&#34;</span><span class="op" id="7620976">)</span><br>
<span class="lineno">1485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7620979">if</span>&nbsp;<span class="ident" id="7620982">err</span>&nbsp;<span class="op" id="7620986">!=</span>&nbsp;<span class="ident" id="7620989">nil</span>&nbsp;<span class="op" id="7620993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620997">t</span><span class="op" id="7620998">.</span><span class="ident" id="7620999">Fatal</span><span class="op" id="7621004">(</span><span class="ident" id="7621005">err</span><span class="op" id="7621008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7621011">}</span><br>
<span class="lineno"></span><span class="op" id="7621013">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1490</span><span class="keyword" id="7621016">func</span>&nbsp;<span class="op" id="7621021">(</span><span class="ident" id="7621022">c</span>&nbsp;<span class="op" id="7621024">*</span><span class="ident" id="7621025">concurrentStmtQueryTest</span><span class="op" id="7621048">)</span>&nbsp;<span class="ident" id="7621050">finish</span><span class="op" id="7621056">(</span><span class="ident" id="7621057">t</span>&nbsp;<span class="ident" id="7621059">testing</span><span class="op" id="7621066">.</span><span class="ident" id="7621067">TB</span><span class="op" id="7621069">)</span>&nbsp;<span class="op" id="7621071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7621074">if</span>&nbsp;<span class="ident" id="7621077">c</span><span class="op" id="7621078">.</span><span class="ident" id="7621079">stmt</span>&nbsp;<span class="op" id="7621084">!=</span>&nbsp;<span class="ident" id="7621087">nil</span>&nbsp;<span class="op" id="7621091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621095">c</span><span class="op" id="7621096">.</span><span class="ident" id="7621097">stmt</span><span class="op" id="7621101">.</span><span class="ident" id="7621102">Close</span><span class="op" id="7621107">(</span><span class="op" id="7621108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621112">c</span><span class="op" id="7621113">.</span><span class="ident" id="7621114">stmt</span>&nbsp;<span class="op" id="7621119">=</span>&nbsp;<span class="ident" id="7621121">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7621126">}</span><br>
<span class="lineno">1495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621129">c</span><span class="op" id="7621130">.</span><span class="ident" id="7621131">db</span>&nbsp;<span class="op" id="7621134">=</span>&nbsp;<span class="ident" id="7621136">nil</span><br>
<span class="lineno"></span><span class="op" id="7621140">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7621143">func</span>&nbsp;<span class="op" id="7621148">(</span><span class="ident" id="7621149">c</span>&nbsp;<span class="op" id="7621151">*</span><span class="ident" id="7621152">concurrentStmtQueryTest</span><span class="op" id="7621175">)</span>&nbsp;<span class="ident" id="7621177">test</span><span class="op" id="7621181">(</span><span class="ident" id="7621182">t</span>&nbsp;<span class="ident" id="7621184">testing</span><span class="op" id="7621191">.</span><span class="ident" id="7621192">TB</span><span class="op" id="7621194">)</span>&nbsp;<span class="builtintype" id="7621196">error</span>&nbsp;<span class="op" id="7621202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621205">rows</span><span class="op" id="7621209">,</span>&nbsp;<span class="ident" id="7621211">err</span>&nbsp;<span class="op" id="7621215">:=</span>&nbsp;<span class="ident" id="7621218">c</span><span class="op" id="7621219">.</span><span class="ident" id="7621220">stmt</span><span class="op" id="7621224">.</span><span class="ident" id="7621225">Query</span><span class="op" id="7621230">(</span><span class="op" id="7621231">)</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7621234">if</span>&nbsp;<span class="ident" id="7621237">err</span>&nbsp;<span class="op" id="7621241">!=</span>&nbsp;<span class="ident" id="7621244">nil</span>&nbsp;<span class="op" id="7621248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621252">t</span><span class="op" id="7621253">.</span><span class="ident" id="7621254">Errorf</span><span class="op" id="7621260">(</span><span class="string" id="7621261">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="7621282">,</span>&nbsp;<span class="ident" id="7621284">err</span><span class="op" id="7621287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7621291">return</span>&nbsp;<span class="ident" id="7621298">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7621303">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7621307">var</span>&nbsp;<span class="ident" id="7621311">name</span>&nbsp;<span class="builtintype" id="7621316">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7621324">for</span>&nbsp;<span class="ident" id="7621328">rows</span><span class="op" id="7621332">.</span><span class="ident" id="7621333">Next</span><span class="op" id="7621337">(</span><span class="op" id="7621338">)</span>&nbsp;<span class="op" id="7621340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621344">rows</span><span class="op" id="7621348">.</span><span class="ident" id="7621349">Scan</span><span class="op" id="7621353">(</span><span class="op" id="7621354">&amp;</span><span class="ident" id="7621355">name</span><span class="op" id="7621359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7621362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621365">rows</span><span class="op" id="7621369">.</span><span class="ident" id="7621370">Close</span><span class="op" id="7621375">(</span><span class="op" id="7621376">)</span><br>
<span class="lineno">1510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7621379">return</span>&nbsp;<span class="ident" id="7621386">nil</span><br>
<span class="lineno"></span><span class="op" id="7621390">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7621393">type</span>&nbsp;<span class="ident" id="7621398">concurrentStmtExecTest</span>&nbsp;<span class="keyword" id="7621421">struct</span>&nbsp;<span class="op" id="7621428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621431">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7621436">*</span><span class="ident" id="7621437">DB</span><br>
<span class="lineno">1515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621441">stmt</span>&nbsp;<span class="op" id="7621446">*</span><span class="ident" id="7621447">Stmt</span><br>
<span class="lineno"></span><span class="op" id="7621452">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7621455">func</span>&nbsp;<span class="op" id="7621460">(</span><span class="ident" id="7621461">c</span>&nbsp;<span class="op" id="7621463">*</span><span class="ident" id="7621464">concurrentStmtExecTest</span><span class="op" id="7621486">)</span>&nbsp;<span class="ident" id="7621488">init</span><span class="op" id="7621492">(</span><span class="ident" id="7621493">t</span>&nbsp;<span class="ident" id="7621495">testing</span><span class="op" id="7621502">.</span><span class="ident" id="7621503">TB</span><span class="op" id="7621505">,</span>&nbsp;<span class="ident" id="7621507">db</span>&nbsp;<span class="op" id="7621510">*</span><span class="ident" id="7621511">DB</span><span class="op" id="7621513">)</span>&nbsp;<span class="op" id="7621515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621518">c</span><span class="op" id="7621519">.</span><span class="ident" id="7621520">db</span>&nbsp;<span class="op" id="7621523">=</span>&nbsp;<span class="ident" id="7621525">db</span><br>
<span class="lineno">1520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7621529">var</span>&nbsp;<span class="ident" id="7621533">err</span>&nbsp;<span class="builtintype" id="7621537">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621544">c</span><span class="op" id="7621545">.</span><span class="ident" id="7621546">stmt</span><span class="op" id="7621550">,</span>&nbsp;<span class="ident" id="7621552">err</span>&nbsp;<span class="op" id="7621556">=</span>&nbsp;<span class="ident" id="7621558">db</span><span class="op" id="7621560">.</span><span class="ident" id="7621561">Prepare</span><span class="op" id="7621568">(</span><span class="string" id="7621569">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="7621622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7621625">if</span>&nbsp;<span class="ident" id="7621628">err</span>&nbsp;<span class="op" id="7621632">!=</span>&nbsp;<span class="ident" id="7621635">nil</span>&nbsp;<span class="op" id="7621639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621643">t</span><span class="op" id="7621644">.</span><span class="ident" id="7621645">Fatal</span><span class="op" id="7621650">(</span><span class="ident" id="7621651">err</span><span class="op" id="7621654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7621657">}</span><br>
<span class="lineno">1525</span><span class="op" id="7621659">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7621662">func</span>&nbsp;<span class="op" id="7621667">(</span><span class="ident" id="7621668">c</span>&nbsp;<span class="op" id="7621670">*</span><span class="ident" id="7621671">concurrentStmtExecTest</span><span class="op" id="7621693">)</span>&nbsp;<span class="ident" id="7621695">finish</span><span class="op" id="7621701">(</span><span class="ident" id="7621702">t</span>&nbsp;<span class="ident" id="7621704">testing</span><span class="op" id="7621711">.</span><span class="ident" id="7621712">TB</span><span class="op" id="7621714">)</span>&nbsp;<span class="op" id="7621716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7621719">if</span>&nbsp;<span class="ident" id="7621722">c</span><span class="op" id="7621723">.</span><span class="ident" id="7621724">stmt</span>&nbsp;<span class="op" id="7621729">!=</span>&nbsp;<span class="ident" id="7621732">nil</span>&nbsp;<span class="op" id="7621736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621740">c</span><span class="op" id="7621741">.</span><span class="ident" id="7621742">stmt</span><span class="op" id="7621746">.</span><span class="ident" id="7621747">Close</span><span class="op" id="7621752">(</span><span class="op" id="7621753">)</span><br>
<span class="lineno">1530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621757">c</span><span class="op" id="7621758">.</span><span class="ident" id="7621759">stmt</span>&nbsp;<span class="op" id="7621764">=</span>&nbsp;<span class="ident" id="7621766">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7621771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621774">c</span><span class="op" id="7621775">.</span><span class="ident" id="7621776">db</span>&nbsp;<span class="op" id="7621779">=</span>&nbsp;<span class="ident" id="7621781">nil</span><br>
<span class="lineno"></span><span class="op" id="7621785">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1535</span><span class="keyword" id="7621788">func</span>&nbsp;<span class="op" id="7621793">(</span><span class="ident" id="7621794">c</span>&nbsp;<span class="op" id="7621796">*</span><span class="ident" id="7621797">concurrentStmtExecTest</span><span class="op" id="7621819">)</span>&nbsp;<span class="ident" id="7621821">test</span><span class="op" id="7621825">(</span><span class="ident" id="7621826">t</span>&nbsp;<span class="ident" id="7621828">testing</span><span class="op" id="7621835">.</span><span class="ident" id="7621836">TB</span><span class="op" id="7621838">)</span>&nbsp;<span class="builtintype" id="7621840">error</span>&nbsp;<span class="op" id="7621846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621849">_</span><span class="op" id="7621850">,</span>&nbsp;<span class="ident" id="7621852">err</span>&nbsp;<span class="op" id="7621856">:=</span>&nbsp;<span class="ident" id="7621859">c</span><span class="op" id="7621860">.</span><span class="ident" id="7621861">stmt</span><span class="op" id="7621865">.</span><span class="ident" id="7621866">Exec</span><span class="op" id="7621870">(</span><span class="num" id="7621871">3</span><span class="op" id="7621872">,</span>&nbsp;<span class="ident" id="7621874">chrisBirthday</span><span class="op" id="7621887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7621890">if</span>&nbsp;<span class="ident" id="7621893">err</span>&nbsp;<span class="op" id="7621897">!=</span>&nbsp;<span class="ident" id="7621900">nil</span>&nbsp;<span class="op" id="7621904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621908">t</span><span class="op" id="7621909">.</span><span class="ident" id="7621910">Errorf</span><span class="op" id="7621916">(</span><span class="string" id="7621917">&#34;error&nbsp;on&nbsp;exec:&nbsp;&nbsp;%v&#34;</span><span class="op" id="7621937">,</span>&nbsp;<span class="ident" id="7621939">err</span><span class="op" id="7621942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7621946">return</span>&nbsp;<span class="ident" id="7621953">err</span><br>
<span class="lineno">1540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7621958">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7621961">return</span>&nbsp;<span class="ident" id="7621968">nil</span><br>
<span class="lineno"></span><span class="op" id="7621972">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7621975">type</span>&nbsp;<span class="ident" id="7621980">concurrentTxQueryTest</span>&nbsp;<span class="keyword" id="7622002">struct</span>&nbsp;<span class="op" id="7622009">{</span><br>
<span class="lineno">1545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622012">db</span>&nbsp;<span class="op" id="7622015">*</span><span class="ident" id="7622016">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622020">tx</span>&nbsp;<span class="op" id="7622023">*</span><span class="ident" id="7622024">Tx</span><br>
<span class="lineno"></span><span class="op" id="7622027">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7622030">func</span>&nbsp;<span class="op" id="7622035">(</span><span class="ident" id="7622036">c</span>&nbsp;<span class="op" id="7622038">*</span><span class="ident" id="7622039">concurrentTxQueryTest</span><span class="op" id="7622060">)</span>&nbsp;<span class="ident" id="7622062">init</span><span class="op" id="7622066">(</span><span class="ident" id="7622067">t</span>&nbsp;<span class="ident" id="7622069">testing</span><span class="op" id="7622076">.</span><span class="ident" id="7622077">TB</span><span class="op" id="7622079">,</span>&nbsp;<span class="ident" id="7622081">db</span>&nbsp;<span class="op" id="7622084">*</span><span class="ident" id="7622085">DB</span><span class="op" id="7622087">)</span>&nbsp;<span class="op" id="7622089">{</span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622092">c</span><span class="op" id="7622093">.</span><span class="ident" id="7622094">db</span>&nbsp;<span class="op" id="7622097">=</span>&nbsp;<span class="ident" id="7622099">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7622103">var</span>&nbsp;<span class="ident" id="7622107">err</span>&nbsp;<span class="builtintype" id="7622111">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622118">c</span><span class="op" id="7622119">.</span><span class="ident" id="7622120">tx</span><span class="op" id="7622122">,</span>&nbsp;<span class="ident" id="7622124">err</span>&nbsp;<span class="op" id="7622128">=</span>&nbsp;<span class="ident" id="7622130">c</span><span class="op" id="7622131">.</span><span class="ident" id="7622132">db</span><span class="op" id="7622134">.</span><span class="ident" id="7622135">Begin</span><span class="op" id="7622140">(</span><span class="op" id="7622141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7622144">if</span>&nbsp;<span class="ident" id="7622147">err</span>&nbsp;<span class="op" id="7622151">!=</span>&nbsp;<span class="ident" id="7622154">nil</span>&nbsp;<span class="op" id="7622158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622162">t</span><span class="op" id="7622163">.</span><span class="ident" id="7622164">Fatal</span><span class="op" id="7622169">(</span><span class="ident" id="7622170">err</span><span class="op" id="7622173">)</span><br>
<span class="lineno">1555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7622176">}</span><br>
<span class="lineno"></span><span class="op" id="7622178">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7622181">func</span>&nbsp;<span class="op" id="7622186">(</span><span class="ident" id="7622187">c</span>&nbsp;<span class="op" id="7622189">*</span><span class="ident" id="7622190">concurrentTxQueryTest</span><span class="op" id="7622211">)</span>&nbsp;<span class="ident" id="7622213">finish</span><span class="op" id="7622219">(</span><span class="ident" id="7622220">t</span>&nbsp;<span class="ident" id="7622222">testing</span><span class="op" id="7622229">.</span><span class="ident" id="7622230">TB</span><span class="op" id="7622232">)</span>&nbsp;<span class="op" id="7622234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7622237">if</span>&nbsp;<span class="ident" id="7622240">c</span><span class="op" id="7622241">.</span><span class="ident" id="7622242">tx</span>&nbsp;<span class="op" id="7622245">!=</span>&nbsp;<span class="ident" id="7622248">nil</span>&nbsp;<span class="op" id="7622252">{</span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622256">c</span><span class="op" id="7622257">.</span><span class="ident" id="7622258">tx</span><span class="op" id="7622260">.</span><span class="ident" id="7622261">Rollback</span><span class="op" id="7622269">(</span><span class="op" id="7622270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622274">c</span><span class="op" id="7622275">.</span><span class="ident" id="7622276">tx</span>&nbsp;<span class="op" id="7622279">=</span>&nbsp;<span class="ident" id="7622281">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7622286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622289">c</span><span class="op" id="7622290">.</span><span class="ident" id="7622291">db</span>&nbsp;<span class="op" id="7622294">=</span>&nbsp;<span class="ident" id="7622296">nil</span><br>
<span class="lineno"></span><span class="op" id="7622300">}</span><br>
<span class="lineno">1565</span><br>
<span class="lineno"></span><span class="keyword" id="7622303">func</span>&nbsp;<span class="op" id="7622308">(</span><span class="ident" id="7622309">c</span>&nbsp;<span class="op" id="7622311">*</span><span class="ident" id="7622312">concurrentTxQueryTest</span><span class="op" id="7622333">)</span>&nbsp;<span class="ident" id="7622335">test</span><span class="op" id="7622339">(</span><span class="ident" id="7622340">t</span>&nbsp;<span class="ident" id="7622342">testing</span><span class="op" id="7622349">.</span><span class="ident" id="7622350">TB</span><span class="op" id="7622352">)</span>&nbsp;<span class="builtintype" id="7622354">error</span>&nbsp;<span class="op" id="7622360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622363">rows</span><span class="op" id="7622367">,</span>&nbsp;<span class="ident" id="7622369">err</span>&nbsp;<span class="op" id="7622373">:=</span>&nbsp;<span class="ident" id="7622376">c</span><span class="op" id="7622377">.</span><span class="ident" id="7622378">db</span><span class="op" id="7622380">.</span><span class="ident" id="7622381">Query</span><span class="op" id="7622386">(</span><span class="string" id="7622387">&#34;SELECT|people|name|&#34;</span><span class="op" id="7622408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7622411">if</span>&nbsp;<span class="ident" id="7622414">err</span>&nbsp;<span class="op" id="7622418">!=</span>&nbsp;<span class="ident" id="7622421">nil</span>&nbsp;<span class="op" id="7622425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622429">t</span><span class="op" id="7622430">.</span><span class="ident" id="7622431">Error</span><span class="op" id="7622436">(</span><span class="ident" id="7622437">err</span><span class="op" id="7622440">)</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7622444">return</span>&nbsp;<span class="ident" id="7622451">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7622456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7622459">var</span>&nbsp;<span class="ident" id="7622463">name</span>&nbsp;<span class="builtintype" id="7622468">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7622476">for</span>&nbsp;<span class="ident" id="7622480">rows</span><span class="op" id="7622484">.</span><span class="ident" id="7622485">Next</span><span class="op" id="7622489">(</span><span class="op" id="7622490">)</span>&nbsp;<span class="op" id="7622492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622496">rows</span><span class="op" id="7622500">.</span><span class="ident" id="7622501">Scan</span><span class="op" id="7622505">(</span><span class="op" id="7622506">&amp;</span><span class="ident" id="7622507">name</span><span class="op" id="7622511">)</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7622514">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622517">rows</span><span class="op" id="7622521">.</span><span class="ident" id="7622522">Close</span><span class="op" id="7622527">(</span><span class="op" id="7622528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7622531">return</span>&nbsp;<span class="ident" id="7622538">nil</span><br>
<span class="lineno"></span><span class="op" id="7622542">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1580</span><span class="keyword" id="7622545">type</span>&nbsp;<span class="ident" id="7622550">concurrentTxExecTest</span>&nbsp;<span class="keyword" id="7622571">struct</span>&nbsp;<span class="op" id="7622578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622581">db</span>&nbsp;<span class="op" id="7622584">*</span><span class="ident" id="7622585">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622589">tx</span>&nbsp;<span class="op" id="7622592">*</span><span class="ident" id="7622593">Tx</span><br>
<span class="lineno"></span><span class="op" id="7622596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1585</span><span class="keyword" id="7622599">func</span>&nbsp;<span class="op" id="7622604">(</span><span class="ident" id="7622605">c</span>&nbsp;<span class="op" id="7622607">*</span><span class="ident" id="7622608">concurrentTxExecTest</span><span class="op" id="7622628">)</span>&nbsp;<span class="ident" id="7622630">init</span><span class="op" id="7622634">(</span><span class="ident" id="7622635">t</span>&nbsp;<span class="ident" id="7622637">testing</span><span class="op" id="7622644">.</span><span class="ident" id="7622645">TB</span><span class="op" id="7622647">,</span>&nbsp;<span class="ident" id="7622649">db</span>&nbsp;<span class="op" id="7622652">*</span><span class="ident" id="7622653">DB</span><span class="op" id="7622655">)</span>&nbsp;<span class="op" id="7622657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622660">c</span><span class="op" id="7622661">.</span><span class="ident" id="7622662">db</span>&nbsp;<span class="op" id="7622665">=</span>&nbsp;<span class="ident" id="7622667">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7622671">var</span>&nbsp;<span class="ident" id="7622675">err</span>&nbsp;<span class="builtintype" id="7622679">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622686">c</span><span class="op" id="7622687">.</span><span class="ident" id="7622688">tx</span><span class="op" id="7622690">,</span>&nbsp;<span class="ident" id="7622692">err</span>&nbsp;<span class="op" id="7622696">=</span>&nbsp;<span class="ident" id="7622698">c</span><span class="op" id="7622699">.</span><span class="ident" id="7622700">db</span><span class="op" id="7622702">.</span><span class="ident" id="7622703">Begin</span><span class="op" id="7622708">(</span><span class="op" id="7622709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7622712">if</span>&nbsp;<span class="ident" id="7622715">err</span>&nbsp;<span class="op" id="7622719">!=</span>&nbsp;<span class="ident" id="7622722">nil</span>&nbsp;<span class="op" id="7622726">{</span><br>
<span class="lineno">1590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622730">t</span><span class="op" id="7622731">.</span><span class="ident" id="7622732">Fatal</span><span class="op" id="7622737">(</span><span class="ident" id="7622738">err</span><span class="op" id="7622741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7622744">}</span><br>
<span class="lineno"></span><span class="op" id="7622746">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7622749">func</span>&nbsp;<span class="op" id="7622754">(</span><span class="ident" id="7622755">c</span>&nbsp;<span class="op" id="7622757">*</span><span class="ident" id="7622758">concurrentTxExecTest</span><span class="op" id="7622778">)</span>&nbsp;<span class="ident" id="7622780">finish</span><span class="op" id="7622786">(</span><span class="ident" id="7622787">t</span>&nbsp;<span class="ident" id="7622789">testing</span><span class="op" id="7622796">.</span><span class="ident" id="7622797">TB</span><span class="op" id="7622799">)</span>&nbsp;<span class="op" id="7622801">{</span><br>
<span class="lineno">1595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7622804">if</span>&nbsp;<span class="ident" id="7622807">c</span><span class="op" id="7622808">.</span><span class="ident" id="7622809">tx</span>&nbsp;<span class="op" id="7622812">!=</span>&nbsp;<span class="ident" id="7622815">nil</span>&nbsp;<span class="op" id="7622819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622823">c</span><span class="op" id="7622824">.</span><span class="ident" id="7622825">tx</span><span class="op" id="7622827">.</span><span class="ident" id="7622828">Rollback</span><span class="op" id="7622836">(</span><span class="op" id="7622837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622841">c</span><span class="op" id="7622842">.</span><span class="ident" id="7622843">tx</span>&nbsp;<span class="op" id="7622846">=</span>&nbsp;<span class="ident" id="7622848">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7622853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622856">c</span><span class="op" id="7622857">.</span><span class="ident" id="7622858">db</span>&nbsp;<span class="op" id="7622861">=</span>&nbsp;<span class="ident" id="7622863">nil</span><br>
<span class="lineno">1600</span><span class="op" id="7622867">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7622870">func</span>&nbsp;<span class="op" id="7622875">(</span><span class="ident" id="7622876">c</span>&nbsp;<span class="op" id="7622878">*</span><span class="ident" id="7622879">concurrentTxExecTest</span><span class="op" id="7622899">)</span>&nbsp;<span class="ident" id="7622901">test</span><span class="op" id="7622905">(</span><span class="ident" id="7622906">t</span>&nbsp;<span class="ident" id="7622908">testing</span><span class="op" id="7622915">.</span><span class="ident" id="7622916">TB</span><span class="op" id="7622918">)</span>&nbsp;<span class="builtintype" id="7622920">error</span>&nbsp;<span class="op" id="7622926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622929">_</span><span class="op" id="7622930">,</span>&nbsp;<span class="ident" id="7622932">err</span>&nbsp;<span class="op" id="7622936">:=</span>&nbsp;<span class="ident" id="7622939">c</span><span class="op" id="7622940">.</span><span class="ident" id="7622941">tx</span><span class="op" id="7622943">.</span><span class="ident" id="7622944">Exec</span><span class="op" id="7622948">(</span><span class="string" id="7622949">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="7623002">,</span>&nbsp;<span class="num" id="7623004">3</span><span class="op" id="7623005">,</span>&nbsp;<span class="ident" id="7623007">chrisBirthday</span><span class="op" id="7623020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7623023">if</span>&nbsp;<span class="ident" id="7623026">err</span>&nbsp;<span class="op" id="7623030">!=</span>&nbsp;<span class="ident" id="7623033">nil</span>&nbsp;<span class="op" id="7623037">{</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623041">t</span><span class="op" id="7623042">.</span><span class="ident" id="7623043">Error</span><span class="op" id="7623048">(</span><span class="ident" id="7623049">err</span><span class="op" id="7623052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7623056">return</span>&nbsp;<span class="ident" id="7623063">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7623068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7623071">return</span>&nbsp;<span class="ident" id="7623078">nil</span><br>
<span class="lineno"></span><span class="op" id="7623082">}</span><br>
<span class="lineno">1610</span><br>
<span class="lineno"></span><span class="keyword" id="7623085">type</span>&nbsp;<span class="ident" id="7623090">concurrentTxStmtQueryTest</span>&nbsp;<span class="keyword" id="7623116">struct</span>&nbsp;<span class="op" id="7623123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623126">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7623131">*</span><span class="ident" id="7623132">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623136">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7623141">*</span><span class="ident" id="7623142">Tx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623146">stmt</span>&nbsp;<span class="op" id="7623151">*</span><span class="ident" id="7623152">Stmt</span><br>
<span class="lineno">1615</span><span class="op" id="7623157">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7623160">func</span>&nbsp;<span class="op" id="7623165">(</span><span class="ident" id="7623166">c</span>&nbsp;<span class="op" id="7623168">*</span><span class="ident" id="7623169">concurrentTxStmtQueryTest</span><span class="op" id="7623194">)</span>&nbsp;<span class="ident" id="7623196">init</span><span class="op" id="7623200">(</span><span class="ident" id="7623201">t</span>&nbsp;<span class="ident" id="7623203">testing</span><span class="op" id="7623210">.</span><span class="ident" id="7623211">TB</span><span class="op" id="7623213">,</span>&nbsp;<span class="ident" id="7623215">db</span>&nbsp;<span class="op" id="7623218">*</span><span class="ident" id="7623219">DB</span><span class="op" id="7623221">)</span>&nbsp;<span class="op" id="7623223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623226">c</span><span class="op" id="7623227">.</span><span class="ident" id="7623228">db</span>&nbsp;<span class="op" id="7623231">=</span>&nbsp;<span class="ident" id="7623233">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7623237">var</span>&nbsp;<span class="ident" id="7623241">err</span>&nbsp;<span class="builtintype" id="7623245">error</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623252">c</span><span class="op" id="7623253">.</span><span class="ident" id="7623254">tx</span><span class="op" id="7623256">,</span>&nbsp;<span class="ident" id="7623258">err</span>&nbsp;<span class="op" id="7623262">=</span>&nbsp;<span class="ident" id="7623264">c</span><span class="op" id="7623265">.</span><span class="ident" id="7623266">db</span><span class="op" id="7623268">.</span><span class="ident" id="7623269">Begin</span><span class="op" id="7623274">(</span><span class="op" id="7623275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7623278">if</span>&nbsp;<span class="ident" id="7623281">err</span>&nbsp;<span class="op" id="7623285">!=</span>&nbsp;<span class="ident" id="7623288">nil</span>&nbsp;<span class="op" id="7623292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623296">t</span><span class="op" id="7623297">.</span><span class="ident" id="7623298">Fatal</span><span class="op" id="7623303">(</span><span class="ident" id="7623304">err</span><span class="op" id="7623307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7623310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623313">c</span><span class="op" id="7623314">.</span><span class="ident" id="7623315">stmt</span><span class="op" id="7623319">,</span>&nbsp;<span class="ident" id="7623321">err</span>&nbsp;<span class="op" id="7623325">=</span>&nbsp;<span class="ident" id="7623327">c</span><span class="op" id="7623328">.</span><span class="ident" id="7623329">tx</span><span class="op" id="7623331">.</span><span class="ident" id="7623332">Prepare</span><span class="op" id="7623339">(</span><span class="string" id="7623340">&#34;SELECT|people|name|&#34;</span><span class="op" id="7623361">)</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7623364">if</span>&nbsp;<span class="ident" id="7623367">err</span>&nbsp;<span class="op" id="7623371">!=</span>&nbsp;<span class="ident" id="7623374">nil</span>&nbsp;<span class="op" id="7623378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623382">t</span><span class="op" id="7623383">.</span><span class="ident" id="7623384">Fatal</span><span class="op" id="7623389">(</span><span class="ident" id="7623390">err</span><span class="op" id="7623393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7623396">}</span><br>
<span class="lineno"></span><span class="op" id="7623398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1630</span><span class="keyword" id="7623401">func</span>&nbsp;<span class="op" id="7623406">(</span><span class="ident" id="7623407">c</span>&nbsp;<span class="op" id="7623409">*</span><span class="ident" id="7623410">concurrentTxStmtQueryTest</span><span class="op" id="7623435">)</span>&nbsp;<span class="ident" id="7623437">finish</span><span class="op" id="7623443">(</span><span class="ident" id="7623444">t</span>&nbsp;<span class="ident" id="7623446">testing</span><span class="op" id="7623453">.</span><span class="ident" id="7623454">TB</span><span class="op" id="7623456">)</span>&nbsp;<span class="op" id="7623458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7623461">if</span>&nbsp;<span class="ident" id="7623464">c</span><span class="op" id="7623465">.</span><span class="ident" id="7623466">stmt</span>&nbsp;<span class="op" id="7623471">!=</span>&nbsp;<span class="ident" id="7623474">nil</span>&nbsp;<span class="op" id="7623478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623482">c</span><span class="op" id="7623483">.</span><span class="ident" id="7623484">stmt</span><span class="op" id="7623488">.</span><span class="ident" id="7623489">Close</span><span class="op" id="7623494">(</span><span class="op" id="7623495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623499">c</span><span class="op" id="7623500">.</span><span class="ident" id="7623501">stmt</span>&nbsp;<span class="op" id="7623506">=</span>&nbsp;<span class="ident" id="7623508">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7623513">}</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7623516">if</span>&nbsp;<span class="ident" id="7623519">c</span><span class="op" id="7623520">.</span><span class="ident" id="7623521">tx</span>&nbsp;<span class="op" id="7623524">!=</span>&nbsp;<span class="ident" id="7623527">nil</span>&nbsp;<span class="op" id="7623531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623535">c</span><span class="op" id="7623536">.</span><span class="ident" id="7623537">tx</span><span class="op" id="7623539">.</span><span class="ident" id="7623540">Rollback</span><span class="op" id="7623548">(</span><span class="op" id="7623549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623553">c</span><span class="op" id="7623554">.</span><span class="ident" id="7623555">tx</span>&nbsp;<span class="op" id="7623558">=</span>&nbsp;<span class="ident" id="7623560">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7623565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623568">c</span><span class="op" id="7623569">.</span><span class="ident" id="7623570">db</span>&nbsp;<span class="op" id="7623573">=</span>&nbsp;<span class="ident" id="7623575">nil</span><br>
<span class="lineno">1640</span><span class="op" id="7623579">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7623582">func</span>&nbsp;<span class="op" id="7623587">(</span><span class="ident" id="7623588">c</span>&nbsp;<span class="op" id="7623590">*</span><span class="ident" id="7623591">concurrentTxStmtQueryTest</span><span class="op" id="7623616">)</span>&nbsp;<span class="ident" id="7623618">test</span><span class="op" id="7623622">(</span><span class="ident" id="7623623">t</span>&nbsp;<span class="ident" id="7623625">testing</span><span class="op" id="7623632">.</span><span class="ident" id="7623633">TB</span><span class="op" id="7623635">)</span>&nbsp;<span class="builtintype" id="7623637">error</span>&nbsp;<span class="op" id="7623643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623646">rows</span><span class="op" id="7623650">,</span>&nbsp;<span class="ident" id="7623652">err</span>&nbsp;<span class="op" id="7623656">:=</span>&nbsp;<span class="ident" id="7623659">c</span><span class="op" id="7623660">.</span><span class="ident" id="7623661">stmt</span><span class="op" id="7623665">.</span><span class="ident" id="7623666">Query</span><span class="op" id="7623671">(</span><span class="op" id="7623672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7623675">if</span>&nbsp;<span class="ident" id="7623678">err</span>&nbsp;<span class="op" id="7623682">!=</span>&nbsp;<span class="ident" id="7623685">nil</span>&nbsp;<span class="op" id="7623689">{</span><br>
<span class="lineno">1645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623693">t</span><span class="op" id="7623694">.</span><span class="ident" id="7623695">Errorf</span><span class="op" id="7623701">(</span><span class="string" id="7623702">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="7623723">,</span>&nbsp;<span class="ident" id="7623725">err</span><span class="op" id="7623728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7623732">return</span>&nbsp;<span class="ident" id="7623739">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7623744">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7623748">var</span>&nbsp;<span class="ident" id="7623752">name</span>&nbsp;<span class="builtintype" id="7623757">string</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7623765">for</span>&nbsp;<span class="ident" id="7623769">rows</span><span class="op" id="7623773">.</span><span class="ident" id="7623774">Next</span><span class="op" id="7623778">(</span><span class="op" id="7623779">)</span>&nbsp;<span class="op" id="7623781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623785">rows</span><span class="op" id="7623789">.</span><span class="ident" id="7623790">Scan</span><span class="op" id="7623794">(</span><span class="op" id="7623795">&amp;</span><span class="ident" id="7623796">name</span><span class="op" id="7623800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7623803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623806">rows</span><span class="op" id="7623810">.</span><span class="ident" id="7623811">Close</span><span class="op" id="7623816">(</span><span class="op" id="7623817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7623820">return</span>&nbsp;<span class="ident" id="7623827">nil</span><br>
<span class="lineno">1655</span><span class="op" id="7623831">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7623834">type</span>&nbsp;<span class="ident" id="7623839">concurrentTxStmtExecTest</span>&nbsp;<span class="keyword" id="7623864">struct</span>&nbsp;<span class="op" id="7623871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623874">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7623879">*</span><span class="ident" id="7623880">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623884">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7623889">*</span><span class="ident" id="7623890">Tx</span><br>
<span class="lineno">1660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623894">stmt</span>&nbsp;<span class="op" id="7623899">*</span><span class="ident" id="7623900">Stmt</span><br>
<span class="lineno"></span><span class="op" id="7623905">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7623908">func</span>&nbsp;<span class="op" id="7623913">(</span><span class="ident" id="7623914">c</span>&nbsp;<span class="op" id="7623916">*</span><span class="ident" id="7623917">concurrentTxStmtExecTest</span><span class="op" id="7623941">)</span>&nbsp;<span class="ident" id="7623943">init</span><span class="op" id="7623947">(</span><span class="ident" id="7623948">t</span>&nbsp;<span class="ident" id="7623950">testing</span><span class="op" id="7623957">.</span><span class="ident" id="7623958">TB</span><span class="op" id="7623960">,</span>&nbsp;<span class="ident" id="7623962">db</span>&nbsp;<span class="op" id="7623965">*</span><span class="ident" id="7623966">DB</span><span class="op" id="7623968">)</span>&nbsp;<span class="op" id="7623970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623973">c</span><span class="op" id="7623974">.</span><span class="ident" id="7623975">db</span>&nbsp;<span class="op" id="7623978">=</span>&nbsp;<span class="ident" id="7623980">db</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7623984">var</span>&nbsp;<span class="ident" id="7623988">err</span>&nbsp;<span class="builtintype" id="7623992">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623999">c</span><span class="op" id="7624000">.</span><span class="ident" id="7624001">tx</span><span class="op" id="7624003">,</span>&nbsp;<span class="ident" id="7624005">err</span>&nbsp;<span class="op" id="7624009">=</span>&nbsp;<span class="ident" id="7624011">c</span><span class="op" id="7624012">.</span><span class="ident" id="7624013">db</span><span class="op" id="7624015">.</span><span class="ident" id="7624016">Begin</span><span class="op" id="7624021">(</span><span class="op" id="7624022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7624025">if</span>&nbsp;<span class="ident" id="7624028">err</span>&nbsp;<span class="op" id="7624032">!=</span>&nbsp;<span class="ident" id="7624035">nil</span>&nbsp;<span class="op" id="7624039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7624043">t</span><span class="op" id="7624044">.</span><span class="ident" id="7624045">Fatal</span><span class="op" id="7624050">(</span><span class="ident" id="7624051">err</span><span class="op" id="7624054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7624057">}</span><br>
<span class="lineno">1670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7624060">c</span><span class="op" id="7624061">.</span><span class="ident" id="7624062">stmt</span><span class="op" id="7624066">,</span>&nbsp;<span class="ident" id="7624068">err</span>&nbsp;<span class="op" id="7624072">=</span>&nbsp;<span class="ident" id="7624074">c</span><span class="op" id="7624075">.</span><span class="ident" id="7624076">tx</span><span class="op" id="7624078">.</span><span class="ident" id="7624079">Prepare</span><span class="op" id="7624086">(</span><span class="string" id="7624087">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="7624140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7624143">if</span>&nbsp;<span class="ident" id="7624146">err</span>&nbsp;<span class="op" id="7624150">!=</span>&nbsp;<span class="ident" id="7624153">nil</span>&nbsp;<span class="op" id="7624157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7624161">t</span><span class="op" id="7624162">.</span><span class="ident" id="7624163">Fatal</span><span class="op" id="7624168">(</span><span class="ident" id="7624169">err</span><span class="op" id="7624172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7624175">}</span><br>
<span class="lineno"></span><span class="op" id="7624177">}</span><br>
<span class="lineno">1675</span><br>
<span class="lineno"></span><span class="keyword" id="7624180">func</span>&nbsp;<span class="op" id="7624185">(</span><span class="ident" id="7624186">c</span>&nbsp;<span class="op" id="7624188">*</span><span class="ident" id="7624189">concurrentTxStmtExecTest</span><span class="op" id="7624213">)</span>&nbsp;<span class="ident" id="7624215">finish</span><span class="op" id="7624221">(</span><span class="ident" id="7624222">t</span>&nbsp;<span class="ident" id="7624224">testing</span><span class="op" id="7624231">.</span><span class="ident" id="7624232">TB</span><span class="op" id="7624234">)</span>&nbsp;<span class="op" id="7624236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7624239">if</span>&nbsp;<span class="ident" id="7624242">c</span><span class="op" id="7624243">.</span><span class="ident" id="7624244">stmt</span>&nbsp;<span class="op" id="7624249">!=</span>&nbsp;<span class="ident" id="7624252">nil</span>&nbsp;<span class="op" id="7624256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7624260">c</span><span class="op" id="7624261">.</span><span class="ident" id="7624262">stmt</span><span class="op" id="7624266">.</span><span class="ident" id="7624267">Close</span><span class="op" id="7624272">(</span><span class="op" id="7624273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7624277">c</span><span class="op" id="7624278">.</span><span class="ident" id="7624279">stmt</span>&nbsp;<span class="op" id="7624284">=</span>&nbsp;<span class="ident" id="7624286">nil</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7624291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7624294">if</span>&nbsp;<span class="ident" id="7624297">c</span><span class="op" id="7624298">.</span><span class="ident" id="7624299">tx</span>&nbsp;<span class="op" id="7624302">!=</span>&nbsp;<span class="ident" id="7624305">nil</span>&nbsp;<span class="op" id="7624309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7624313">c</span><span class="op" id="7624314">.</span><span class="ident" id="7624315">tx</span><span class="op" id="7624317">.</span><span class="ident" id="7624318">Rollback</span><span class="op" id="7624326">(</span><span class="op" id="7624327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7624331">c</span><span class="op" id="7624332">.</span><span class="ident" id="7624333">tx</span>&nbsp;<span class="op" id="7624336">=</span>&nbsp;<span class="ident" id="7624338">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7624343">}</span><br>
<span class="lineno">1685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7624346">c</span><span class="op" id="7624347">.</span><span class="ident" id="7624348">db</span>&nbsp;<span class="op" id="7624351">=</span>&nbsp;<span class="ident" id="7624353">nil</span><br>
<span class="lineno"></span><span class="op" id="7624357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7624360">func</span>&nbsp;<span class="op" id="7624365">(</span><span class="ident" id="7624366">c</span>&nbsp;<span class="op" id="7624368">*</span><span class="ident" id="7624369">concurrentTxStmtExecTest</span><span class="op" id="7624393">)</span>&nbsp;<span class="ident" id="7624395">test</span><span class="op" id="7624399">(</span><span class="ident" id="7624400">t</span>&nbsp;<span class="ident" id="7624402">testing</span><span class="op" id="7624409">.</span><span class="ident" id="7624410">TB</span><span class="op" id="7624412">)</span>&nbsp;<span class="builtintype" id="7624414">error</span>&nbsp;<span class="op" id="7624420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7624423">_</span><span class="op" id="7624424">,</span>&nbsp;<span class="ident" id="7624426">err</span>&nbsp;<span class="op" id="7624430">:=</span>&nbsp;<span class="ident" id="7624433">c</span><span class="op" id="7624434">.</span><span class="ident" id="7624435">stmt</span><span class="op" id="7624439">.</span><span class="ident" id="7624440">Exec</span><span class="op" id="7624444">(</span><span class="num" id="7624445">3</span><span class="op" id="7624446">,</span>&nbsp;<span class="ident" id="7624448">chrisBirthday</span><span class="op" id="7624461">)</span><br>
<span class="lineno">1690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7624464">if</span>&nbsp;<span class="ident" id="7624467">err</span>&nbsp;<span class="op" id="7624471">!=</span>&nbsp;<span class="ident" id="7624474">nil</span>&nbsp;<span class="op" id="7624478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7624482">t</span><span class="op" id="7624483">.</span><span class="ident" id="7624484">Errorf</span><span class="op" id="7624490">(</span><span class="string" id="7624491">&#34;error&nbsp;on&nbsp;exec:&nbsp;&nbsp;%v&#34;</span><span class="op" id="7624511">,</span>&nbsp;<span class="ident" id="7624513">err</span><span class="op" id="7624516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7624520">return</span>&nbsp;<span class="ident" id="7624527">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7624532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7624535">return</span>&nbsp;<span class="ident" id="7624542">nil</span><br>
<span class="lineno">1695</span><span class="op" id="7624546">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7624549">type</span>&nbsp;<span class="ident" id="7624554">concurrentRandomTest</span>&nbsp;<span class="keyword" id="7624575">struct</span>&nbsp;<span class="op" id="7624582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7624585">tests</span>&nbsp;<span class="op" id="7624591">[</span><span class="op" id="7624592">]</span><span class="ident" id="7624593">concurrentTest</span><br>
<span class="lineno"></span><span class="op" id="7624608">}</span><br>
<span class="lineno">1700</span><br>
<span class="lineno"></span><span class="keyword" id="7624611">func</span>&nbsp;<span class="op" id="7624616">(</span><span class="ident" id="7624617">c</span>&nbsp;<span class="op" id="7624619">*</span><span class="ident" id="7624620">concurrentRandomTest</span><span class="op" id="7624640">)</span>&nbsp;<span class="ident" id="7624642">init</span><span class="op" id="7624646">(</span><span class="ident" id="7624647">t</span>&nbsp;<span class="ident" id="7624649">testing</span><span class="op" id="7624656">.</span><span class="ident" id="7624657">TB</span><span class="op" id="7624659">,</span>&nbsp;<span class="ident" id="7624661">db</span>&nbsp;<span class="op" id="7624664">*</span><span class="ident" id="7624665">DB</span><span class="op" id="7624667">)</span>&nbsp;<span class="op" id="7624669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7624672">c</span><span class="op" id="7624673">.</span><span class="ident" id="7624674">tests</span>&nbsp;<span class="op" id="7624680">=</span>&nbsp;<span class="op" id="7624682">[</span><span class="op" id="7624683">]</span><span class="ident" id="7624684">concurrentTest</span><span class="op" id="7624698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7624702">new</span><span class="op" id="7624705">(</span><span class="ident" id="7624706">concurrentDBQueryTest</span><span class="op" id="7624727">)</span><span class="op" id="7624728">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7624732">new</span><span class="op" id="7624735">(</span><span class="ident" id="7624736">concurrentDBExecTest</span><span class="op" id="7624756">)</span><span class="op" id="7624757">,</span><br>
<span class="lineno">1705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7624761">new</span><span class="op" id="7624764">(</span><span class="ident" id="7624765">concurrentStmtQueryTest</span><span class="op" id="7624788">)</span><span class="op" id="7624789">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7624793">new</span><span class="op" id="7624796">(</span><span class="ident" id="7624797">concurrentStmtExecTest</span><span class="op" id="7624819">)</span><span class="op" id="7624820">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7624824">new</span><span class="op" id="7624827">(</span><span class="ident" id="7624828">concurrentTxQueryTest</span><span class="op" id="7624849">)</span><span class="op" id="7624850">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7624854">new</span><span class="op" id="7624857">(</span><span class="ident" id="7624858">concurrentTxExecTest</span><span class="op" id="7624878">)</span><span class="op" id="7624879">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7624883">new</span><span class="op" id="7624886">(</span><span class="ident" id="7624887">concurrentTxStmtQueryTest</span><span class="op" id="7624912">)</span><span class="op" id="7624913">,</span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7624917">new</span><span class="op" id="7624920">(</span><span class="ident" id="7624921">concurrentTxStmtExecTest</span><span class="op" id="7624945">)</span><span class="op" id="7624946">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7624949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7624952">for</span>&nbsp;<span class="ident" id="7624956">_</span><span class="op" id="7624957">,</span>&nbsp;<span class="ident" id="7624959">ct</span>&nbsp;<span class="op" id="7624962">:=</span>&nbsp;<span class="keyword" id="7624965">range</span>&nbsp;<span class="ident" id="7624971">c</span><span class="op" id="7624972">.</span><span class="ident" id="7624973">tests</span>&nbsp;<span class="op" id="7624979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7624983">ct</span><span class="op" id="7624985">.</span><span class="ident" id="7624986">init</span><span class="op" id="7624990">(</span><span class="ident" id="7624991">t</span><span class="op" id="7624992">,</span>&nbsp;<span class="ident" id="7624994">db</span><span class="op" id="7624996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7624999">}</span><br>
<span class="lineno">1715</span><span class="op" id="7625001">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7625004">func</span>&nbsp;<span class="op" id="7625009">(</span><span class="ident" id="7625010">c</span>&nbsp;<span class="op" id="7625012">*</span><span class="ident" id="7625013">concurrentRandomTest</span><span class="op" id="7625033">)</span>&nbsp;<span class="ident" id="7625035">finish</span><span class="op" id="7625041">(</span><span class="ident" id="7625042">t</span>&nbsp;<span class="ident" id="7625044">testing</span><span class="op" id="7625051">.</span><span class="ident" id="7625052">TB</span><span class="op" id="7625054">)</span>&nbsp;<span class="op" id="7625056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625059">for</span>&nbsp;<span class="ident" id="7625063">_</span><span class="op" id="7625064">,</span>&nbsp;<span class="ident" id="7625066">ct</span>&nbsp;<span class="op" id="7625069">:=</span>&nbsp;<span class="keyword" id="7625072">range</span>&nbsp;<span class="ident" id="7625078">c</span><span class="op" id="7625079">.</span><span class="ident" id="7625080">tests</span>&nbsp;<span class="op" id="7625086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625090">ct</span><span class="op" id="7625092">.</span><span class="ident" id="7625093">finish</span><span class="op" id="7625099">(</span><span class="ident" id="7625100">t</span><span class="op" id="7625101">)</span><br>
<span class="lineno">1720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7625104">}</span><br>
<span class="lineno"></span><span class="op" id="7625106">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7625109">func</span>&nbsp;<span class="op" id="7625114">(</span><span class="ident" id="7625115">c</span>&nbsp;<span class="op" id="7625117">*</span><span class="ident" id="7625118">concurrentRandomTest</span><span class="op" id="7625138">)</span>&nbsp;<span class="ident" id="7625140">test</span><span class="op" id="7625144">(</span><span class="ident" id="7625145">t</span>&nbsp;<span class="ident" id="7625147">testing</span><span class="op" id="7625154">.</span><span class="ident" id="7625155">TB</span><span class="op" id="7625157">)</span>&nbsp;<span class="builtintype" id="7625159">error</span>&nbsp;<span class="op" id="7625165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625168">ct</span>&nbsp;<span class="op" id="7625171">:=</span>&nbsp;<span class="ident" id="7625174">c</span><span class="op" id="7625175">.</span><span class="ident" id="7625176">tests</span><span class="op" id="7625181">[</span><span class="ident" id="7625182">rand</span><span class="op" id="7625186">.</span><span class="ident" id="7625187">Intn</span><span class="op" id="7625191">(</span><span class="builtinfunc" id="7625192">len</span><span class="op" id="7625195">(</span><span class="ident" id="7625196">c</span><span class="op" id="7625197">.</span><span class="ident" id="7625198">tests</span><span class="op" id="7625203">)</span><span class="op" id="7625204">)</span><span class="op" id="7625205">]</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625208">return</span>&nbsp;<span class="ident" id="7625215">ct</span><span class="op" id="7625217">.</span><span class="ident" id="7625218">test</span><span class="op" id="7625222">(</span><span class="ident" id="7625223">t</span><span class="op" id="7625224">)</span><br>
<span class="lineno"></span><span class="op" id="7625226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7625229">func</span>&nbsp;<span class="ident" id="7625234">doConcurrentTest</span><span class="op" id="7625250">(</span><span class="ident" id="7625251">t</span>&nbsp;<span class="ident" id="7625253">testing</span><span class="op" id="7625260">.</span><span class="ident" id="7625261">TB</span><span class="op" id="7625263">,</span>&nbsp;<span class="ident" id="7625265">ct</span>&nbsp;<span class="ident" id="7625268">concurrentTest</span><span class="op" id="7625282">)</span>&nbsp;<span class="op" id="7625284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625287">maxProcs</span><span class="op" id="7625295">,</span>&nbsp;<span class="ident" id="7625297">numReqs</span>&nbsp;<span class="op" id="7625305">:=</span>&nbsp;<span class="num" id="7625308">1</span><span class="op" id="7625309">,</span>&nbsp;<span class="num" id="7625311">500</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625316">if</span>&nbsp;<span class="ident" id="7625319">testing</span><span class="op" id="7625326">.</span><span class="ident" id="7625327">Short</span><span class="op" id="7625332">(</span><span class="op" id="7625333">)</span>&nbsp;<span class="op" id="7625335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625339">maxProcs</span><span class="op" id="7625347">,</span>&nbsp;<span class="ident" id="7625349">numReqs</span>&nbsp;<span class="op" id="7625357">=</span>&nbsp;<span class="num" id="7625359">4</span><span class="op" id="7625360">,</span>&nbsp;<span class="num" id="7625362">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7625366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625369">defer</span>&nbsp;<span class="ident" id="7625375">runtime</span><span class="op" id="7625382">.</span><span class="ident" id="7625383">GOMAXPROCS</span><span class="op" id="7625393">(</span><span class="ident" id="7625394">runtime</span><span class="op" id="7625401">.</span><span class="ident" id="7625402">GOMAXPROCS</span><span class="op" id="7625412">(</span><span class="ident" id="7625413">maxProcs</span><span class="op" id="7625421">)</span><span class="op" id="7625422">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625426">db</span>&nbsp;<span class="op" id="7625429">:=</span>&nbsp;<span class="ident" id="7625432">newTestDB</span><span class="op" id="7625441">(</span><span class="ident" id="7625442">t</span><span class="op" id="7625443">,</span>&nbsp;<span class="string" id="7625445">&#34;people&#34;</span><span class="op" id="7625453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625456">defer</span>&nbsp;<span class="ident" id="7625462">closeDB</span><span class="op" id="7625469">(</span><span class="ident" id="7625470">t</span><span class="op" id="7625471">,</span>&nbsp;<span class="ident" id="7625473">db</span><span class="op" id="7625475">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625479">ct</span><span class="op" id="7625481">.</span><span class="ident" id="7625482">init</span><span class="op" id="7625486">(</span><span class="ident" id="7625487">t</span><span class="op" id="7625488">,</span>&nbsp;<span class="ident" id="7625490">db</span><span class="op" id="7625492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625495">defer</span>&nbsp;<span class="ident" id="7625501">ct</span><span class="op" id="7625503">.</span><span class="ident" id="7625504">finish</span><span class="op" id="7625510">(</span><span class="ident" id="7625511">t</span><span class="op" id="7625512">)</span><br>
<span class="lineno">1740</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625516">var</span>&nbsp;<span class="ident" id="7625520">wg</span>&nbsp;<span class="ident" id="7625523">sync</span><span class="op" id="7625527">.</span><span class="ident" id="7625528">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625539">wg</span><span class="op" id="7625541">.</span><span class="ident" id="7625542">Add</span><span class="op" id="7625545">(</span><span class="ident" id="7625546">numReqs</span><span class="op" id="7625553">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625557">reqs</span>&nbsp;<span class="op" id="7625562">:=</span>&nbsp;<span class="builtinfunc" id="7625565">make</span><span class="op" id="7625569">(</span><span class="keyword" id="7625570">chan</span>&nbsp;<span class="builtintype" id="7625575">bool</span><span class="op" id="7625579">)</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625582">defer</span>&nbsp;<span class="builtinfunc" id="7625588">close</span><span class="op" id="7625593">(</span><span class="ident" id="7625594">reqs</span><span class="op" id="7625598">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625602">for</span>&nbsp;<span class="ident" id="7625606">i</span>&nbsp;<span class="op" id="7625608">:=</span>&nbsp;<span class="num" id="7625611">0</span><span class="op" id="7625612">;</span>&nbsp;<span class="ident" id="7625614">i</span>&nbsp;<span class="op" id="7625616">&lt;</span>&nbsp;<span class="ident" id="7625618">maxProcs</span><span class="op" id="7625626">*</span><span class="num" id="7625627">2</span><span class="op" id="7625628">;</span>&nbsp;<span class="ident" id="7625630">i</span><span class="op" id="7625631">++</span>&nbsp;<span class="op" id="7625634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625638">go</span>&nbsp;<span class="keyword" id="7625641">func</span><span class="op" id="7625645">(</span><span class="op" id="7625646">)</span>&nbsp;<span class="op" id="7625648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625653">for</span>&nbsp;<span class="keyword" id="7625657">range</span>&nbsp;<span class="ident" id="7625663">reqs</span>&nbsp;<span class="op" id="7625668">{</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625674">err</span>&nbsp;<span class="op" id="7625678">:=</span>&nbsp;<span class="ident" id="7625681">ct</span><span class="op" id="7625683">.</span><span class="ident" id="7625684">test</span><span class="op" id="7625688">(</span><span class="ident" id="7625689">t</span><span class="op" id="7625690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625696">if</span>&nbsp;<span class="ident" id="7625699">err</span>&nbsp;<span class="op" id="7625703">!=</span>&nbsp;<span class="ident" id="7625706">nil</span>&nbsp;<span class="op" id="7625710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625717">wg</span><span class="op" id="7625719">.</span><span class="ident" id="7625720">Done</span><span class="op" id="7625724">(</span><span class="op" id="7625725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625732">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7625745">}</span><br>
<span class="lineno">1755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625751">wg</span><span class="op" id="7625753">.</span><span class="ident" id="7625754">Done</span><span class="op" id="7625758">(</span><span class="op" id="7625759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7625764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7625768">}</span><span class="op" id="7625769">(</span><span class="op" id="7625770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7625773">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625777">for</span>&nbsp;<span class="ident" id="7625781">i</span>&nbsp;<span class="op" id="7625783">:=</span>&nbsp;<span class="num" id="7625786">0</span><span class="op" id="7625787">;</span>&nbsp;<span class="ident" id="7625789">i</span>&nbsp;<span class="op" id="7625791">&lt;</span>&nbsp;<span class="ident" id="7625793">numReqs</span><span class="op" id="7625800">;</span>&nbsp;<span class="ident" id="7625802">i</span><span class="op" id="7625803">++</span>&nbsp;<span class="op" id="7625806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625810">reqs</span>&nbsp;<span class="op" id="7625815">&lt;-</span>&nbsp;<span class="builtintype" id="7625818">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7625824">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625828">wg</span><span class="op" id="7625830">.</span><span class="ident" id="7625831">Wait</span><span class="op" id="7625835">(</span><span class="op" id="7625836">)</span><br>
<span class="lineno">1765</span><span class="op" id="7625838">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7625841">func</span>&nbsp;<span class="ident" id="7625846">manyConcurrentQueries</span><span class="op" id="7625867">(</span><span class="ident" id="7625868">t</span>&nbsp;<span class="ident" id="7625870">testing</span><span class="op" id="7625877">.</span><span class="ident" id="7625878">TB</span><span class="op" id="7625880">)</span>&nbsp;<span class="op" id="7625882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625885">maxProcs</span><span class="op" id="7625893">,</span>&nbsp;<span class="ident" id="7625895">numReqs</span>&nbsp;<span class="op" id="7625903">:=</span>&nbsp;<span class="num" id="7625906">16</span><span class="op" id="7625908">,</span>&nbsp;<span class="num" id="7625910">500</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625915">if</span>&nbsp;<span class="ident" id="7625918">testing</span><span class="op" id="7625925">.</span><span class="ident" id="7625926">Short</span><span class="op" id="7625931">(</span><span class="op" id="7625932">)</span>&nbsp;<span class="op" id="7625934">{</span><br>
<span class="lineno">1770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625938">maxProcs</span><span class="op" id="7625946">,</span>&nbsp;<span class="ident" id="7625948">numReqs</span>&nbsp;<span class="op" id="7625956">=</span>&nbsp;<span class="num" id="7625958">4</span><span class="op" id="7625959">,</span>&nbsp;<span class="num" id="7625961">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7625965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625968">defer</span>&nbsp;<span class="ident" id="7625974">runtime</span><span class="op" id="7625981">.</span><span class="ident" id="7625982">GOMAXPROCS</span><span class="op" id="7625992">(</span><span class="ident" id="7625993">runtime</span><span class="op" id="7626000">.</span><span class="ident" id="7626001">GOMAXPROCS</span><span class="op" id="7626011">(</span><span class="ident" id="7626012">maxProcs</span><span class="op" id="7626020">)</span><span class="op" id="7626021">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626025">db</span>&nbsp;<span class="op" id="7626028">:=</span>&nbsp;<span class="ident" id="7626031">newTestDB</span><span class="op" id="7626040">(</span><span class="ident" id="7626041">t</span><span class="op" id="7626042">,</span>&nbsp;<span class="string" id="7626044">&#34;people&#34;</span><span class="op" id="7626052">)</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626055">defer</span>&nbsp;<span class="ident" id="7626061">closeDB</span><span class="op" id="7626068">(</span><span class="ident" id="7626069">t</span><span class="op" id="7626070">,</span>&nbsp;<span class="ident" id="7626072">db</span><span class="op" id="7626074">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626078">stmt</span><span class="op" id="7626082">,</span>&nbsp;<span class="ident" id="7626084">err</span>&nbsp;<span class="op" id="7626088">:=</span>&nbsp;<span class="ident" id="7626091">db</span><span class="op" id="7626093">.</span><span class="ident" id="7626094">Prepare</span><span class="op" id="7626101">(</span><span class="string" id="7626102">&#34;SELECT|people|name|&#34;</span><span class="op" id="7626123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626126">if</span>&nbsp;<span class="ident" id="7626129">err</span>&nbsp;<span class="op" id="7626133">!=</span>&nbsp;<span class="ident" id="7626136">nil</span>&nbsp;<span class="op" id="7626140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626144">t</span><span class="op" id="7626145">.</span><span class="ident" id="7626146">Fatal</span><span class="op" id="7626151">(</span><span class="ident" id="7626152">err</span><span class="op" id="7626155">)</span><br>
<span class="lineno">1780</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7626158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626161">defer</span>&nbsp;<span class="ident" id="7626167">stmt</span><span class="op" id="7626171">.</span><span class="ident" id="7626172">Close</span><span class="op" id="7626177">(</span><span class="op" id="7626178">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626182">var</span>&nbsp;<span class="ident" id="7626186">wg</span>&nbsp;<span class="ident" id="7626189">sync</span><span class="op" id="7626193">.</span><span class="ident" id="7626194">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626205">wg</span><span class="op" id="7626207">.</span><span class="ident" id="7626208">Add</span><span class="op" id="7626211">(</span><span class="ident" id="7626212">numReqs</span><span class="op" id="7626219">)</span><br>
<span class="lineno">1785</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626223">reqs</span>&nbsp;<span class="op" id="7626228">:=</span>&nbsp;<span class="builtinfunc" id="7626231">make</span><span class="op" id="7626235">(</span><span class="keyword" id="7626236">chan</span>&nbsp;<span class="builtintype" id="7626241">bool</span><span class="op" id="7626245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626248">defer</span>&nbsp;<span class="builtinfunc" id="7626254">close</span><span class="op" id="7626259">(</span><span class="ident" id="7626260">reqs</span><span class="op" id="7626264">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626268">for</span>&nbsp;<span class="ident" id="7626272">i</span>&nbsp;<span class="op" id="7626274">:=</span>&nbsp;<span class="num" id="7626277">0</span><span class="op" id="7626278">;</span>&nbsp;<span class="ident" id="7626280">i</span>&nbsp;<span class="op" id="7626282">&lt;</span>&nbsp;<span class="ident" id="7626284">maxProcs</span><span class="op" id="7626292">*</span><span class="num" id="7626293">2</span><span class="op" id="7626294">;</span>&nbsp;<span class="ident" id="7626296">i</span><span class="op" id="7626297">++</span>&nbsp;<span class="op" id="7626300">{</span><br>
<span class="lineno">1790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626304">go</span>&nbsp;<span class="keyword" id="7626307">func</span><span class="op" id="7626311">(</span><span class="op" id="7626312">)</span>&nbsp;<span class="op" id="7626314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626319">for</span>&nbsp;<span class="keyword" id="7626323">range</span>&nbsp;<span class="ident" id="7626329">reqs</span>&nbsp;<span class="op" id="7626334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626340">rows</span><span class="op" id="7626344">,</span>&nbsp;<span class="ident" id="7626346">err</span>&nbsp;<span class="op" id="7626350">:=</span>&nbsp;<span class="ident" id="7626353">stmt</span><span class="op" id="7626357">.</span><span class="ident" id="7626358">Query</span><span class="op" id="7626363">(</span><span class="op" id="7626364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626370">if</span>&nbsp;<span class="ident" id="7626373">err</span>&nbsp;<span class="op" id="7626377">!=</span>&nbsp;<span class="ident" id="7626380">nil</span>&nbsp;<span class="op" id="7626384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626391">t</span><span class="op" id="7626392">.</span><span class="ident" id="7626393">Errorf</span><span class="op" id="7626399">(</span><span class="string" id="7626400">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="7626421">,</span>&nbsp;<span class="ident" id="7626423">err</span><span class="op" id="7626426">)</span><br>
<span class="lineno">1795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626433">wg</span><span class="op" id="7626435">.</span><span class="ident" id="7626436">Done</span><span class="op" id="7626440">(</span><span class="op" id="7626441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626448">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7626461">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626468">var</span>&nbsp;<span class="ident" id="7626472">name</span>&nbsp;<span class="builtintype" id="7626477">string</span><br>
<span class="lineno">1800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626488">for</span>&nbsp;<span class="ident" id="7626492">rows</span><span class="op" id="7626496">.</span><span class="ident" id="7626497">Next</span><span class="op" id="7626501">(</span><span class="op" id="7626502">)</span>&nbsp;<span class="op" id="7626504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626511">rows</span><span class="op" id="7626515">.</span><span class="ident" id="7626516">Scan</span><span class="op" id="7626520">(</span><span class="op" id="7626521">&amp;</span><span class="ident" id="7626522">name</span><span class="op" id="7626526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7626532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626538">rows</span><span class="op" id="7626542">.</span><span class="ident" id="7626543">Close</span><span class="op" id="7626548">(</span><span class="op" id="7626549">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626556">wg</span><span class="op" id="7626558">.</span><span class="ident" id="7626559">Done</span><span class="op" id="7626563">(</span><span class="op" id="7626564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7626569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7626573">}</span><span class="op" id="7626574">(</span><span class="op" id="7626575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7626578">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626582">for</span>&nbsp;<span class="ident" id="7626586">i</span>&nbsp;<span class="op" id="7626588">:=</span>&nbsp;<span class="num" id="7626591">0</span><span class="op" id="7626592">;</span>&nbsp;<span class="ident" id="7626594">i</span>&nbsp;<span class="op" id="7626596">&lt;</span>&nbsp;<span class="ident" id="7626598">numReqs</span><span class="op" id="7626605">;</span>&nbsp;<span class="ident" id="7626607">i</span><span class="op" id="7626608">++</span>&nbsp;<span class="op" id="7626611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626615">reqs</span>&nbsp;<span class="op" id="7626620">&lt;-</span>&nbsp;<span class="builtintype" id="7626623">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7626629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626633">wg</span><span class="op" id="7626635">.</span><span class="ident" id="7626636">Wait</span><span class="op" id="7626640">(</span><span class="op" id="7626641">)</span><br>
<span class="lineno">1815</span><span class="op" id="7626643">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7626646">func</span>&nbsp;<span class="ident" id="7626651">TestIssue6081</span><span class="op" id="7626664">(</span><span class="ident" id="7626665">t</span>&nbsp;<span class="op" id="7626667">*</span><span class="ident" id="7626668">testing</span><span class="op" id="7626675">.</span><span class="ident" id="7626676">T</span><span class="op" id="7626677">)</span>&nbsp;<span class="op" id="7626679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626682">db</span>&nbsp;<span class="op" id="7626685">:=</span>&nbsp;<span class="ident" id="7626688">newTestDB</span><span class="op" id="7626697">(</span><span class="ident" id="7626698">t</span><span class="op" id="7626699">,</span>&nbsp;<span class="string" id="7626701">&#34;people&#34;</span><span class="op" id="7626709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626712">defer</span>&nbsp;<span class="ident" id="7626718">closeDB</span><span class="op" id="7626725">(</span><span class="ident" id="7626726">t</span><span class="op" id="7626727">,</span>&nbsp;<span class="ident" id="7626729">db</span><span class="op" id="7626731">)</span><br>
<span class="lineno">1820</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626735">drv</span>&nbsp;<span class="op" id="7626739">:=</span>&nbsp;<span class="ident" id="7626742">db</span><span class="op" id="7626744">.</span><span class="ident" id="7626745">driver</span><span class="op" id="7626751">.</span><span class="op" id="7626752">(</span><span class="op" id="7626753">*</span><span class="ident" id="7626754">fakeDriver</span><span class="op" id="7626764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626767">drv</span><span class="op" id="7626770">.</span><span class="ident" id="7626771">mu</span><span class="op" id="7626773">.</span><span class="ident" id="7626774">Lock</span><span class="op" id="7626778">(</span><span class="op" id="7626779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626782">opens0</span>&nbsp;<span class="op" id="7626789">:=</span>&nbsp;<span class="ident" id="7626792">drv</span><span class="op" id="7626795">.</span><span class="ident" id="7626796">openCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626807">closes0</span>&nbsp;<span class="op" id="7626815">:=</span>&nbsp;<span class="ident" id="7626818">drv</span><span class="op" id="7626821">.</span><span class="ident" id="7626822">closeCount</span><br>
<span class="lineno">1825</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626834">drv</span><span class="op" id="7626837">.</span><span class="ident" id="7626838">mu</span><span class="op" id="7626840">.</span><span class="ident" id="7626841">Unlock</span><span class="op" id="7626847">(</span><span class="op" id="7626848">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626852">stmt</span><span class="op" id="7626856">,</span>&nbsp;<span class="ident" id="7626858">err</span>&nbsp;<span class="op" id="7626862">:=</span>&nbsp;<span class="ident" id="7626865">db</span><span class="op" id="7626867">.</span><span class="ident" id="7626868">Prepare</span><span class="op" id="7626875">(</span><span class="string" id="7626876">&#34;SELECT|people|name|&#34;</span><span class="op" id="7626897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626900">if</span>&nbsp;<span class="ident" id="7626903">err</span>&nbsp;<span class="op" id="7626907">!=</span>&nbsp;<span class="ident" id="7626910">nil</span>&nbsp;<span class="op" id="7626914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626918">t</span><span class="op" id="7626919">.</span><span class="ident" id="7626920">Fatal</span><span class="op" id="7626925">(</span><span class="ident" id="7626926">err</span><span class="op" id="7626929">)</span><br>
<span class="lineno">1830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7626932">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626935">rowsCloseHook</span>&nbsp;<span class="op" id="7626949">=</span>&nbsp;<span class="keyword" id="7626951">func</span><span class="op" id="7626955">(</span><span class="ident" id="7626956">rows</span>&nbsp;<span class="op" id="7626961">*</span><span class="ident" id="7626962">Rows</span><span class="op" id="7626966">,</span>&nbsp;<span class="ident" id="7626968">err</span>&nbsp;<span class="op" id="7626972">*</span><span class="builtintype" id="7626973">error</span><span class="op" id="7626978">)</span>&nbsp;<span class="op" id="7626980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7626984">*</span><span class="ident" id="7626985">err</span>&nbsp;<span class="op" id="7626989">=</span>&nbsp;<span class="ident" id="7626991">driver</span><span class="op" id="7626997">.</span><span class="ident" id="7626998">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7627010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7627013">defer</span>&nbsp;<span class="keyword" id="7627019">func</span><span class="op" id="7627023">(</span><span class="op" id="7627024">)</span>&nbsp;<span class="op" id="7627026">{</span>&nbsp;<span class="ident" id="7627028">rowsCloseHook</span>&nbsp;<span class="op" id="7627042">=</span>&nbsp;<span class="ident" id="7627044">nil</span>&nbsp;<span class="op" id="7627048">}</span><span class="op" id="7627049">(</span><span class="op" id="7627050">)</span><br>
<span class="lineno">1835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7627053">for</span>&nbsp;<span class="ident" id="7627057">i</span>&nbsp;<span class="op" id="7627059">:=</span>&nbsp;<span class="num" id="7627062">0</span><span class="op" id="7627063">;</span>&nbsp;<span class="ident" id="7627065">i</span>&nbsp;<span class="op" id="7627067">&lt;</span>&nbsp;<span class="num" id="7627069">10</span><span class="op" id="7627071">;</span>&nbsp;<span class="ident" id="7627073">i</span><span class="op" id="7627074">++</span>&nbsp;<span class="op" id="7627077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627081">rows</span><span class="op" id="7627085">,</span>&nbsp;<span class="ident" id="7627087">err</span>&nbsp;<span class="op" id="7627091">:=</span>&nbsp;<span class="ident" id="7627094">stmt</span><span class="op" id="7627098">.</span><span class="ident" id="7627099">Query</span><span class="op" id="7627104">(</span><span class="op" id="7627105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7627109">if</span>&nbsp;<span class="ident" id="7627112">err</span>&nbsp;<span class="op" id="7627116">!=</span>&nbsp;<span class="ident" id="7627119">nil</span>&nbsp;<span class="op" id="7627123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627128">t</span><span class="op" id="7627129">.</span><span class="ident" id="7627130">Fatal</span><span class="op" id="7627135">(</span><span class="ident" id="7627136">err</span><span class="op" id="7627139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7627143">}</span><br>
<span class="lineno">1840</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627147">rows</span><span class="op" id="7627151">.</span><span class="ident" id="7627152">Close</span><span class="op" id="7627157">(</span><span class="op" id="7627158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7627161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7627164">if</span>&nbsp;<span class="ident" id="7627167">n</span>&nbsp;<span class="op" id="7627169">:=</span>&nbsp;<span class="builtinfunc" id="7627172">len</span><span class="op" id="7627175">(</span><span class="ident" id="7627176">stmt</span><span class="op" id="7627180">.</span><span class="ident" id="7627181">css</span><span class="op" id="7627184">)</span><span class="op" id="7627185">;</span>&nbsp;<span class="ident" id="7627187">n</span>&nbsp;<span class="op" id="7627189">&gt;</span>&nbsp;<span class="num" id="7627191">1</span>&nbsp;<span class="op" id="7627193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627197">t</span><span class="op" id="7627198">.</span><span class="ident" id="7627199">Errorf</span><span class="op" id="7627205">(</span><span class="string" id="7627206">&#34;len(css&nbsp;slice)&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;1&#34;</span><span class="op" id="7627238">,</span>&nbsp;<span class="ident" id="7627240">n</span><span class="op" id="7627241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7627244">}</span><br>
<span class="lineno">1845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627247">stmt</span><span class="op" id="7627251">.</span><span class="ident" id="7627252">Close</span><span class="op" id="7627257">(</span><span class="op" id="7627258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7627261">if</span>&nbsp;<span class="ident" id="7627264">n</span>&nbsp;<span class="op" id="7627266">:=</span>&nbsp;<span class="builtinfunc" id="7627269">len</span><span class="op" id="7627272">(</span><span class="ident" id="7627273">stmt</span><span class="op" id="7627277">.</span><span class="ident" id="7627278">css</span><span class="op" id="7627281">)</span><span class="op" id="7627282">;</span>&nbsp;<span class="ident" id="7627284">n</span>&nbsp;<span class="op" id="7627286">!=</span>&nbsp;<span class="num" id="7627289">0</span>&nbsp;<span class="op" id="7627291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627295">t</span><span class="op" id="7627296">.</span><span class="ident" id="7627297">Errorf</span><span class="op" id="7627303">(</span><span class="string" id="7627304">&#34;len(css&nbsp;slice)&nbsp;after&nbsp;Close&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="7627345">,</span>&nbsp;<span class="ident" id="7627347">n</span><span class="op" id="7627348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7627351">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1850</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627355">drv</span><span class="op" id="7627358">.</span><span class="ident" id="7627359">mu</span><span class="op" id="7627361">.</span><span class="ident" id="7627362">Lock</span><span class="op" id="7627366">(</span><span class="op" id="7627367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627370">opens</span>&nbsp;<span class="op" id="7627376">:=</span>&nbsp;<span class="ident" id="7627379">drv</span><span class="op" id="7627382">.</span><span class="ident" id="7627383">openCount</span>&nbsp;<span class="op" id="7627393">-</span>&nbsp;<span class="ident" id="7627395">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627403">closes</span>&nbsp;<span class="op" id="7627410">:=</span>&nbsp;<span class="ident" id="7627413">drv</span><span class="op" id="7627416">.</span><span class="ident" id="7627417">closeCount</span>&nbsp;<span class="op" id="7627428">-</span>&nbsp;<span class="ident" id="7627430">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627439">drv</span><span class="op" id="7627442">.</span><span class="ident" id="7627443">mu</span><span class="op" id="7627445">.</span><span class="ident" id="7627446">Unlock</span><span class="op" id="7627452">(</span><span class="op" id="7627453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7627456">if</span>&nbsp;<span class="ident" id="7627459">opens</span>&nbsp;<span class="op" id="7627465">&lt;</span>&nbsp;<span class="num" id="7627467">9</span>&nbsp;<span class="op" id="7627469">{</span><br>
<span class="lineno">1855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627473">t</span><span class="op" id="7627474">.</span><span class="ident" id="7627475">Errorf</span><span class="op" id="7627481">(</span><span class="string" id="7627482">&#34;opens&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&gt;=&nbsp;9&#34;</span><span class="op" id="7627505">,</span>&nbsp;<span class="ident" id="7627507">opens</span><span class="op" id="7627512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7627515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7627518">if</span>&nbsp;<span class="ident" id="7627521">closes</span>&nbsp;<span class="op" id="7627528">&lt;</span>&nbsp;<span class="num" id="7627530">9</span>&nbsp;<span class="op" id="7627532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627536">t</span><span class="op" id="7627537">.</span><span class="ident" id="7627538">Errorf</span><span class="op" id="7627544">(</span><span class="string" id="7627545">&#34;closes&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&gt;=&nbsp;9&#34;</span><span class="op" id="7627569">,</span>&nbsp;<span class="ident" id="7627571">closes</span><span class="op" id="7627577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7627580">}</span><br>
<span class="lineno">1860</span><span class="op" id="7627582">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7627585">func</span>&nbsp;<span class="ident" id="7627590">TestConcurrency</span><span class="op" id="7627605">(</span><span class="ident" id="7627606">t</span>&nbsp;<span class="op" id="7627608">*</span><span class="ident" id="7627609">testing</span><span class="op" id="7627616">.</span><span class="ident" id="7627617">T</span><span class="op" id="7627618">)</span>&nbsp;<span class="op" id="7627620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627623">doConcurrentTest</span><span class="op" id="7627639">(</span><span class="ident" id="7627640">t</span><span class="op" id="7627641">,</span>&nbsp;<span class="builtinfunc" id="7627643">new</span><span class="op" id="7627646">(</span><span class="ident" id="7627647">concurrentDBQueryTest</span><span class="op" id="7627668">)</span><span class="op" id="7627669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627672">doConcurrentTest</span><span class="op" id="7627688">(</span><span class="ident" id="7627689">t</span><span class="op" id="7627690">,</span>&nbsp;<span class="builtinfunc" id="7627692">new</span><span class="op" id="7627695">(</span><span class="ident" id="7627696">concurrentDBExecTest</span><span class="op" id="7627716">)</span><span class="op" id="7627717">)</span><br>
<span class="lineno">1865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627720">doConcurrentTest</span><span class="op" id="7627736">(</span><span class="ident" id="7627737">t</span><span class="op" id="7627738">,</span>&nbsp;<span class="builtinfunc" id="7627740">new</span><span class="op" id="7627743">(</span><span class="ident" id="7627744">concurrentStmtQueryTest</span><span class="op" id="7627767">)</span><span class="op" id="7627768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627771">doConcurrentTest</span><span class="op" id="7627787">(</span><span class="ident" id="7627788">t</span><span class="op" id="7627789">,</span>&nbsp;<span class="builtinfunc" id="7627791">new</span><span class="op" id="7627794">(</span><span class="ident" id="7627795">concurrentStmtExecTest</span><span class="op" id="7627817">)</span><span class="op" id="7627818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627821">doConcurrentTest</span><span class="op" id="7627837">(</span><span class="ident" id="7627838">t</span><span class="op" id="7627839">,</span>&nbsp;<span class="builtinfunc" id="7627841">new</span><span class="op" id="7627844">(</span><span class="ident" id="7627845">concurrentTxQueryTest</span><span class="op" id="7627866">)</span><span class="op" id="7627867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627870">doConcurrentTest</span><span class="op" id="7627886">(</span><span class="ident" id="7627887">t</span><span class="op" id="7627888">,</span>&nbsp;<span class="builtinfunc" id="7627890">new</span><span class="op" id="7627893">(</span><span class="ident" id="7627894">concurrentTxExecTest</span><span class="op" id="7627914">)</span><span class="op" id="7627915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627918">doConcurrentTest</span><span class="op" id="7627934">(</span><span class="ident" id="7627935">t</span><span class="op" id="7627936">,</span>&nbsp;<span class="builtinfunc" id="7627938">new</span><span class="op" id="7627941">(</span><span class="ident" id="7627942">concurrentTxStmtQueryTest</span><span class="op" id="7627967">)</span><span class="op" id="7627968">)</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627971">doConcurrentTest</span><span class="op" id="7627987">(</span><span class="ident" id="7627988">t</span><span class="op" id="7627989">,</span>&nbsp;<span class="builtinfunc" id="7627991">new</span><span class="op" id="7627994">(</span><span class="ident" id="7627995">concurrentTxStmtExecTest</span><span class="op" id="7628019">)</span><span class="op" id="7628020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628023">doConcurrentTest</span><span class="op" id="7628039">(</span><span class="ident" id="7628040">t</span><span class="op" id="7628041">,</span>&nbsp;<span class="builtinfunc" id="7628043">new</span><span class="op" id="7628046">(</span><span class="ident" id="7628047">concurrentRandomTest</span><span class="op" id="7628067">)</span><span class="op" id="7628068">)</span><br>
<span class="lineno"></span><span class="op" id="7628070">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7628073">func</span>&nbsp;<span class="ident" id="7628078">TestConnectionLeak</span><span class="op" id="7628096">(</span><span class="ident" id="7628097">t</span>&nbsp;<span class="op" id="7628099">*</span><span class="ident" id="7628100">testing</span><span class="op" id="7628107">.</span><span class="ident" id="7628108">T</span><span class="op" id="7628109">)</span>&nbsp;<span class="op" id="7628111">{</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628114">db</span>&nbsp;<span class="op" id="7628117">:=</span>&nbsp;<span class="ident" id="7628120">newTestDB</span><span class="op" id="7628129">(</span><span class="ident" id="7628130">t</span><span class="op" id="7628131">,</span>&nbsp;<span class="string" id="7628133">&#34;people&#34;</span><span class="op" id="7628141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628144">defer</span>&nbsp;<span class="ident" id="7628150">closeDB</span><span class="op" id="7628157">(</span><span class="ident" id="7628158">t</span><span class="op" id="7628159">,</span>&nbsp;<span class="ident" id="7628161">db</span><span class="op" id="7628163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7628166">//&nbsp;Start&nbsp;by&nbsp;opening&nbsp;defaultMaxIdleConns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628207">rows</span>&nbsp;<span class="op" id="7628212">:=</span>&nbsp;<span class="builtinfunc" id="7628215">make</span><span class="op" id="7628219">(</span><span class="op" id="7628220">[</span><span class="op" id="7628221">]</span><span class="op" id="7628222">*</span><span class="ident" id="7628223">Rows</span><span class="op" id="7628227">,</span>&nbsp;<span class="ident" id="7628229">defaultMaxIdleConns</span><span class="op" id="7628248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7628251">//&nbsp;We&nbsp;need&nbsp;to&nbsp;SetMaxOpenConns&nbsp;&gt;&nbsp;MaxIdleConns,&nbsp;so&nbsp;the&nbsp;DB&nbsp;can&nbsp;open</span><br>
<span class="lineno">1880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7628317">//&nbsp;a&nbsp;new&nbsp;connection&nbsp;and&nbsp;we&nbsp;can&nbsp;fill&nbsp;the&nbsp;idle&nbsp;queue&nbsp;with&nbsp;the&nbsp;released</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7628387">//&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628404">db</span><span class="op" id="7628406">.</span><span class="ident" id="7628407">SetMaxOpenConns</span><span class="op" id="7628422">(</span><span class="builtinfunc" id="7628423">len</span><span class="op" id="7628426">(</span><span class="ident" id="7628427">rows</span><span class="op" id="7628431">)</span>&nbsp;<span class="op" id="7628433">+</span>&nbsp;<span class="num" id="7628435">1</span><span class="op" id="7628436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628439">for</span>&nbsp;<span class="ident" id="7628443">ii</span>&nbsp;<span class="op" id="7628446">:=</span>&nbsp;<span class="keyword" id="7628449">range</span>&nbsp;<span class="ident" id="7628455">rows</span>&nbsp;<span class="op" id="7628460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628464">r</span><span class="op" id="7628465">,</span>&nbsp;<span class="ident" id="7628467">err</span>&nbsp;<span class="op" id="7628471">:=</span>&nbsp;<span class="ident" id="7628474">db</span><span class="op" id="7628476">.</span><span class="ident" id="7628477">Query</span><span class="op" id="7628482">(</span><span class="string" id="7628483">&#34;SELECT|people|name|&#34;</span><span class="op" id="7628504">)</span><br>
<span class="lineno">1885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628508">if</span>&nbsp;<span class="ident" id="7628511">err</span>&nbsp;<span class="op" id="7628515">!=</span>&nbsp;<span class="ident" id="7628518">nil</span>&nbsp;<span class="op" id="7628522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628527">t</span><span class="op" id="7628528">.</span><span class="ident" id="7628529">Fatal</span><span class="op" id="7628534">(</span><span class="ident" id="7628535">err</span><span class="op" id="7628538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7628542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628546">r</span><span class="op" id="7628547">.</span><span class="ident" id="7628548">Next</span><span class="op" id="7628552">(</span><span class="op" id="7628553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628557">if</span>&nbsp;<span class="ident" id="7628560">err</span>&nbsp;<span class="op" id="7628564">:=</span>&nbsp;<span class="ident" id="7628567">r</span><span class="op" id="7628568">.</span><span class="ident" id="7628569">Err</span><span class="op" id="7628572">(</span><span class="op" id="7628573">)</span><span class="op" id="7628574">;</span>&nbsp;<span class="ident" id="7628576">err</span>&nbsp;<span class="op" id="7628580">!=</span>&nbsp;<span class="ident" id="7628583">nil</span>&nbsp;<span class="op" id="7628587">{</span><br>
<span class="lineno">1890</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628592">t</span><span class="op" id="7628593">.</span><span class="ident" id="7628594">Fatal</span><span class="op" id="7628599">(</span><span class="ident" id="7628600">err</span><span class="op" id="7628603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7628607">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628611">rows</span><span class="op" id="7628615">[</span><span class="ident" id="7628616">ii</span><span class="op" id="7628618">]</span>&nbsp;<span class="op" id="7628620">=</span>&nbsp;<span class="ident" id="7628622">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7628625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7628628">//&nbsp;Now&nbsp;we&nbsp;have&nbsp;defaultMaxIdleConns&nbsp;busy&nbsp;connections.&nbsp;Open</span><br>
<span class="lineno">1895</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7628687">//&nbsp;a&nbsp;new&nbsp;one,&nbsp;but&nbsp;wait&nbsp;until&nbsp;the&nbsp;busy&nbsp;connections&nbsp;are&nbsp;released</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7628751">//&nbsp;before&nbsp;returning&nbsp;control&nbsp;to&nbsp;DB.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628787">drv</span>&nbsp;<span class="op" id="7628791">:=</span>&nbsp;<span class="ident" id="7628794">db</span><span class="op" id="7628796">.</span><span class="ident" id="7628797">driver</span><span class="op" id="7628803">.</span><span class="op" id="7628804">(</span><span class="op" id="7628805">*</span><span class="ident" id="7628806">fakeDriver</span><span class="op" id="7628816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628819">drv</span><span class="op" id="7628822">.</span><span class="ident" id="7628823">waitCh</span>&nbsp;<span class="op" id="7628830">=</span>&nbsp;<span class="builtinfunc" id="7628832">make</span><span class="op" id="7628836">(</span><span class="keyword" id="7628837">chan</span>&nbsp;<span class="keyword" id="7628842">struct</span><span class="op" id="7628848">{</span><span class="op" id="7628849">}</span><span class="op" id="7628850">,</span>&nbsp;<span class="num" id="7628852">1</span><span class="op" id="7628853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628856">drv</span><span class="op" id="7628859">.</span><span class="ident" id="7628860">waitingCh</span>&nbsp;<span class="op" id="7628870">=</span>&nbsp;<span class="builtinfunc" id="7628872">make</span><span class="op" id="7628876">(</span><span class="keyword" id="7628877">chan</span>&nbsp;<span class="keyword" id="7628882">struct</span><span class="op" id="7628888">{</span><span class="op" id="7628889">}</span><span class="op" id="7628890">,</span>&nbsp;<span class="num" id="7628892">1</span><span class="op" id="7628893">)</span><br>
<span class="lineno">1900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628896">var</span>&nbsp;<span class="ident" id="7628900">wg</span>&nbsp;<span class="ident" id="7628903">sync</span><span class="op" id="7628907">.</span><span class="ident" id="7628908">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628919">wg</span><span class="op" id="7628921">.</span><span class="ident" id="7628922">Add</span><span class="op" id="7628925">(</span><span class="num" id="7628926">1</span><span class="op" id="7628927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628930">go</span>&nbsp;<span class="keyword" id="7628933">func</span><span class="op" id="7628937">(</span><span class="op" id="7628938">)</span>&nbsp;<span class="op" id="7628940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628944">r</span><span class="op" id="7628945">,</span>&nbsp;<span class="ident" id="7628947">err</span>&nbsp;<span class="op" id="7628951">:=</span>&nbsp;<span class="ident" id="7628954">db</span><span class="op" id="7628956">.</span><span class="ident" id="7628957">Query</span><span class="op" id="7628962">(</span><span class="string" id="7628963">&#34;SELECT|people|name|&#34;</span><span class="op" id="7628984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628988">if</span>&nbsp;<span class="ident" id="7628991">err</span>&nbsp;<span class="op" id="7628995">!=</span>&nbsp;<span class="ident" id="7628998">nil</span>&nbsp;<span class="op" id="7629002">{</span><br>
<span class="lineno">1905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629007">t</span><span class="op" id="7629008">.</span><span class="ident" id="7629009">Fatal</span><span class="op" id="7629014">(</span><span class="ident" id="7629015">err</span><span class="op" id="7629018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7629022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629026">r</span><span class="op" id="7629027">.</span><span class="ident" id="7629028">Close</span><span class="op" id="7629033">(</span><span class="op" id="7629034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629038">wg</span><span class="op" id="7629040">.</span><span class="ident" id="7629041">Done</span><span class="op" id="7629045">(</span><span class="op" id="7629046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7629049">}</span><span class="op" id="7629050">(</span><span class="op" id="7629051">)</span><br>
<span class="lineno">1910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7629054">//&nbsp;Wait&nbsp;until&nbsp;the&nbsp;goroutine&nbsp;we&#39;ve&nbsp;just&nbsp;created&nbsp;has&nbsp;started&nbsp;waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7629123">&lt;-</span><span class="ident" id="7629125">drv</span><span class="op" id="7629128">.</span><span class="ident" id="7629129">waitingCh</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7629140">//&nbsp;Now&nbsp;close&nbsp;the&nbsp;busy&nbsp;connections.&nbsp;This&nbsp;provides&nbsp;a&nbsp;connection&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7629207">//&nbsp;the&nbsp;blocked&nbsp;goroutine&nbsp;and&nbsp;then&nbsp;fills&nbsp;up&nbsp;the&nbsp;idle&nbsp;queue.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7629267">for</span>&nbsp;<span class="ident" id="7629271">_</span><span class="op" id="7629272">,</span>&nbsp;<span class="ident" id="7629274">v</span>&nbsp;<span class="op" id="7629276">:=</span>&nbsp;<span class="keyword" id="7629279">range</span>&nbsp;<span class="ident" id="7629285">rows</span>&nbsp;<span class="op" id="7629290">{</span><br>
<span class="lineno">1915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629294">v</span><span class="op" id="7629295">.</span><span class="ident" id="7629296">Close</span><span class="op" id="7629301">(</span><span class="op" id="7629302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7629305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7629308">//&nbsp;At&nbsp;this&nbsp;point&nbsp;we&nbsp;give&nbsp;the&nbsp;new&nbsp;connection&nbsp;to&nbsp;DB.&nbsp;This&nbsp;connection&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7629379">//&nbsp;now&nbsp;useless,&nbsp;since&nbsp;the&nbsp;idle&nbsp;queue&nbsp;is&nbsp;full&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7629450">//&nbsp;requests.&nbsp;DB&nbsp;should&nbsp;deal&nbsp;with&nbsp;this&nbsp;situation&nbsp;without&nbsp;leaking&nbsp;the</span><br>
<span class="lineno">1920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7629519">//&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629535">drv</span><span class="op" id="7629538">.</span><span class="ident" id="7629539">waitCh</span>&nbsp;<span class="op" id="7629546">&lt;-</span>&nbsp;<span class="keyword" id="7629549">struct</span><span class="op" id="7629555">{</span><span class="op" id="7629556">}</span><span class="op" id="7629557">{</span><span class="op" id="7629558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629561">wg</span><span class="op" id="7629563">.</span><span class="ident" id="7629564">Wait</span><span class="op" id="7629568">(</span><span class="op" id="7629569">)</span><br>
<span class="lineno"></span><span class="op" id="7629571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1925</span><span class="keyword" id="7629574">func</span>&nbsp;<span class="ident" id="7629579">BenchmarkConcurrentDBExec</span><span class="op" id="7629604">(</span><span class="ident" id="7629605">b</span>&nbsp;<span class="op" id="7629607">*</span><span class="ident" id="7629608">testing</span><span class="op" id="7629615">.</span><span class="ident" id="7629616">B</span><span class="op" id="7629617">)</span>&nbsp;<span class="op" id="7629619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629622">b</span><span class="op" id="7629623">.</span><span class="ident" id="7629624">ReportAllocs</span><span class="op" id="7629636">(</span><span class="op" id="7629637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629640">ct</span>&nbsp;<span class="op" id="7629643">:=</span>&nbsp;<span class="builtinfunc" id="7629646">new</span><span class="op" id="7629649">(</span><span class="ident" id="7629650">concurrentDBExecTest</span><span class="op" id="7629670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7629673">for</span>&nbsp;<span class="ident" id="7629677">i</span>&nbsp;<span class="op" id="7629679">:=</span>&nbsp;<span class="num" id="7629682">0</span><span class="op" id="7629683">;</span>&nbsp;<span class="ident" id="7629685">i</span>&nbsp;<span class="op" id="7629687">&lt;</span>&nbsp;<span class="ident" id="7629689">b</span><span class="op" id="7629690">.</span><span class="ident" id="7629691">N</span><span class="op" id="7629692">;</span>&nbsp;<span class="ident" id="7629694">i</span><span class="op" id="7629695">++</span>&nbsp;<span class="op" id="7629698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629702">doConcurrentTest</span><span class="op" id="7629718">(</span><span class="ident" id="7629719">b</span><span class="op" id="7629720">,</span>&nbsp;<span class="ident" id="7629722">ct</span><span class="op" id="7629724">)</span><br>
<span class="lineno">1930</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7629727">}</span><br>
<span class="lineno"></span><span class="op" id="7629729">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7629732">func</span>&nbsp;<span class="ident" id="7629737">BenchmarkConcurrentStmtQuery</span><span class="op" id="7629765">(</span><span class="ident" id="7629766">b</span>&nbsp;<span class="op" id="7629768">*</span><span class="ident" id="7629769">testing</span><span class="op" id="7629776">.</span><span class="ident" id="7629777">B</span><span class="op" id="7629778">)</span>&nbsp;<span class="op" id="7629780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629783">b</span><span class="op" id="7629784">.</span><span class="ident" id="7629785">ReportAllocs</span><span class="op" id="7629797">(</span><span class="op" id="7629798">)</span><br>
<span class="lineno">1935</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629801">ct</span>&nbsp;<span class="op" id="7629804">:=</span>&nbsp;<span class="builtinfunc" id="7629807">new</span><span class="op" id="7629810">(</span><span class="ident" id="7629811">concurrentStmtQueryTest</span><span class="op" id="7629834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7629837">for</span>&nbsp;<span class="ident" id="7629841">i</span>&nbsp;<span class="op" id="7629843">:=</span>&nbsp;<span class="num" id="7629846">0</span><span class="op" id="7629847">;</span>&nbsp;<span class="ident" id="7629849">i</span>&nbsp;<span class="op" id="7629851">&lt;</span>&nbsp;<span class="ident" id="7629853">b</span><span class="op" id="7629854">.</span><span class="ident" id="7629855">N</span><span class="op" id="7629856">;</span>&nbsp;<span class="ident" id="7629858">i</span><span class="op" id="7629859">++</span>&nbsp;<span class="op" id="7629862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629866">doConcurrentTest</span><span class="op" id="7629882">(</span><span class="ident" id="7629883">b</span><span class="op" id="7629884">,</span>&nbsp;<span class="ident" id="7629886">ct</span><span class="op" id="7629888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7629891">}</span><br>
<span class="lineno"></span><span class="op" id="7629893">}</span><br>
<span class="lineno">1940</span><br>
<span class="lineno"></span><span class="keyword" id="7629896">func</span>&nbsp;<span class="ident" id="7629901">BenchmarkConcurrentStmtExec</span><span class="op" id="7629928">(</span><span class="ident" id="7629929">b</span>&nbsp;<span class="op" id="7629931">*</span><span class="ident" id="7629932">testing</span><span class="op" id="7629939">.</span><span class="ident" id="7629940">B</span><span class="op" id="7629941">)</span>&nbsp;<span class="op" id="7629943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629946">b</span><span class="op" id="7629947">.</span><span class="ident" id="7629948">ReportAllocs</span><span class="op" id="7629960">(</span><span class="op" id="7629961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629964">ct</span>&nbsp;<span class="op" id="7629967">:=</span>&nbsp;<span class="builtinfunc" id="7629970">new</span><span class="op" id="7629973">(</span><span class="ident" id="7629974">concurrentStmtExecTest</span><span class="op" id="7629996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7629999">for</span>&nbsp;<span class="ident" id="7630003">i</span>&nbsp;<span class="op" id="7630005">:=</span>&nbsp;<span class="num" id="7630008">0</span><span class="op" id="7630009">;</span>&nbsp;<span class="ident" id="7630011">i</span>&nbsp;<span class="op" id="7630013">&lt;</span>&nbsp;<span class="ident" id="7630015">b</span><span class="op" id="7630016">.</span><span class="ident" id="7630017">N</span><span class="op" id="7630018">;</span>&nbsp;<span class="ident" id="7630020">i</span><span class="op" id="7630021">++</span>&nbsp;<span class="op" id="7630024">{</span><br>
<span class="lineno">1945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630028">doConcurrentTest</span><span class="op" id="7630044">(</span><span class="ident" id="7630045">b</span><span class="op" id="7630046">,</span>&nbsp;<span class="ident" id="7630048">ct</span><span class="op" id="7630050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7630053">}</span><br>
<span class="lineno"></span><span class="op" id="7630055">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7630058">func</span>&nbsp;<span class="ident" id="7630063">BenchmarkConcurrentTxQuery</span><span class="op" id="7630089">(</span><span class="ident" id="7630090">b</span>&nbsp;<span class="op" id="7630092">*</span><span class="ident" id="7630093">testing</span><span class="op" id="7630100">.</span><span class="ident" id="7630101">B</span><span class="op" id="7630102">)</span>&nbsp;<span class="op" id="7630104">{</span><br>
<span class="lineno">1950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630107">b</span><span class="op" id="7630108">.</span><span class="ident" id="7630109">ReportAllocs</span><span class="op" id="7630121">(</span><span class="op" id="7630122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630125">ct</span>&nbsp;<span class="op" id="7630128">:=</span>&nbsp;<span class="builtinfunc" id="7630131">new</span><span class="op" id="7630134">(</span><span class="ident" id="7630135">concurrentTxQueryTest</span><span class="op" id="7630156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7630159">for</span>&nbsp;<span class="ident" id="7630163">i</span>&nbsp;<span class="op" id="7630165">:=</span>&nbsp;<span class="num" id="7630168">0</span><span class="op" id="7630169">;</span>&nbsp;<span class="ident" id="7630171">i</span>&nbsp;<span class="op" id="7630173">&lt;</span>&nbsp;<span class="ident" id="7630175">b</span><span class="op" id="7630176">.</span><span class="ident" id="7630177">N</span><span class="op" id="7630178">;</span>&nbsp;<span class="ident" id="7630180">i</span><span class="op" id="7630181">++</span>&nbsp;<span class="op" id="7630184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630188">doConcurrentTest</span><span class="op" id="7630204">(</span><span class="ident" id="7630205">b</span><span class="op" id="7630206">,</span>&nbsp;<span class="ident" id="7630208">ct</span><span class="op" id="7630210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7630213">}</span><br>
<span class="lineno">1955</span><span class="op" id="7630215">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7630218">func</span>&nbsp;<span class="ident" id="7630223">BenchmarkConcurrentTxExec</span><span class="op" id="7630248">(</span><span class="ident" id="7630249">b</span>&nbsp;<span class="op" id="7630251">*</span><span class="ident" id="7630252">testing</span><span class="op" id="7630259">.</span><span class="ident" id="7630260">B</span><span class="op" id="7630261">)</span>&nbsp;<span class="op" id="7630263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630266">b</span><span class="op" id="7630267">.</span><span class="ident" id="7630268">ReportAllocs</span><span class="op" id="7630280">(</span><span class="op" id="7630281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630284">ct</span>&nbsp;<span class="op" id="7630287">:=</span>&nbsp;<span class="builtinfunc" id="7630290">new</span><span class="op" id="7630293">(</span><span class="ident" id="7630294">concurrentTxExecTest</span><span class="op" id="7630314">)</span><br>
<span class="lineno">1960</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7630317">for</span>&nbsp;<span class="ident" id="7630321">i</span>&nbsp;<span class="op" id="7630323">:=</span>&nbsp;<span class="num" id="7630326">0</span><span class="op" id="7630327">;</span>&nbsp;<span class="ident" id="7630329">i</span>&nbsp;<span class="op" id="7630331">&lt;</span>&nbsp;<span class="ident" id="7630333">b</span><span class="op" id="7630334">.</span><span class="ident" id="7630335">N</span><span class="op" id="7630336">;</span>&nbsp;<span class="ident" id="7630338">i</span><span class="op" id="7630339">++</span>&nbsp;<span class="op" id="7630342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630346">doConcurrentTest</span><span class="op" id="7630362">(</span><span class="ident" id="7630363">b</span><span class="op" id="7630364">,</span>&nbsp;<span class="ident" id="7630366">ct</span><span class="op" id="7630368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7630371">}</span><br>
<span class="lineno"></span><span class="op" id="7630373">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1965</span><span class="keyword" id="7630376">func</span>&nbsp;<span class="ident" id="7630381">BenchmarkConcurrentTxStmtQuery</span><span class="op" id="7630411">(</span><span class="ident" id="7630412">b</span>&nbsp;<span class="op" id="7630414">*</span><span class="ident" id="7630415">testing</span><span class="op" id="7630422">.</span><span class="ident" id="7630423">B</span><span class="op" id="7630424">)</span>&nbsp;<span class="op" id="7630426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630429">b</span><span class="op" id="7630430">.</span><span class="ident" id="7630431">ReportAllocs</span><span class="op" id="7630443">(</span><span class="op" id="7630444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630447">ct</span>&nbsp;<span class="op" id="7630450">:=</span>&nbsp;<span class="builtinfunc" id="7630453">new</span><span class="op" id="7630456">(</span><span class="ident" id="7630457">concurrentTxStmtQueryTest</span><span class="op" id="7630482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7630485">for</span>&nbsp;<span class="ident" id="7630489">i</span>&nbsp;<span class="op" id="7630491">:=</span>&nbsp;<span class="num" id="7630494">0</span><span class="op" id="7630495">;</span>&nbsp;<span class="ident" id="7630497">i</span>&nbsp;<span class="op" id="7630499">&lt;</span>&nbsp;<span class="ident" id="7630501">b</span><span class="op" id="7630502">.</span><span class="ident" id="7630503">N</span><span class="op" id="7630504">;</span>&nbsp;<span class="ident" id="7630506">i</span><span class="op" id="7630507">++</span>&nbsp;<span class="op" id="7630510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630514">doConcurrentTest</span><span class="op" id="7630530">(</span><span class="ident" id="7630531">b</span><span class="op" id="7630532">,</span>&nbsp;<span class="ident" id="7630534">ct</span><span class="op" id="7630536">)</span><br>
<span class="lineno">1970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7630539">}</span><br>
<span class="lineno"></span><span class="op" id="7630541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7630544">func</span>&nbsp;<span class="ident" id="7630549">BenchmarkConcurrentTxStmtExec</span><span class="op" id="7630578">(</span><span class="ident" id="7630579">b</span>&nbsp;<span class="op" id="7630581">*</span><span class="ident" id="7630582">testing</span><span class="op" id="7630589">.</span><span class="ident" id="7630590">B</span><span class="op" id="7630591">)</span>&nbsp;<span class="op" id="7630593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630596">b</span><span class="op" id="7630597">.</span><span class="ident" id="7630598">ReportAllocs</span><span class="op" id="7630610">(</span><span class="op" id="7630611">)</span><br>
<span class="lineno">1975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630614">ct</span>&nbsp;<span class="op" id="7630617">:=</span>&nbsp;<span class="builtinfunc" id="7630620">new</span><span class="op" id="7630623">(</span><span class="ident" id="7630624">concurrentTxStmtExecTest</span><span class="op" id="7630648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7630651">for</span>&nbsp;<span class="ident" id="7630655">i</span>&nbsp;<span class="op" id="7630657">:=</span>&nbsp;<span class="num" id="7630660">0</span><span class="op" id="7630661">;</span>&nbsp;<span class="ident" id="7630663">i</span>&nbsp;<span class="op" id="7630665">&lt;</span>&nbsp;<span class="ident" id="7630667">b</span><span class="op" id="7630668">.</span><span class="ident" id="7630669">N</span><span class="op" id="7630670">;</span>&nbsp;<span class="ident" id="7630672">i</span><span class="op" id="7630673">++</span>&nbsp;<span class="op" id="7630676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630680">doConcurrentTest</span><span class="op" id="7630696">(</span><span class="ident" id="7630697">b</span><span class="op" id="7630698">,</span>&nbsp;<span class="ident" id="7630700">ct</span><span class="op" id="7630702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7630705">}</span><br>
<span class="lineno"></span><span class="op" id="7630707">}</span><br>
<span class="lineno">1980</span><br>
<span class="lineno"></span><span class="keyword" id="7630710">func</span>&nbsp;<span class="ident" id="7630715">BenchmarkConcurrentRandom</span><span class="op" id="7630740">(</span><span class="ident" id="7630741">b</span>&nbsp;<span class="op" id="7630743">*</span><span class="ident" id="7630744">testing</span><span class="op" id="7630751">.</span><span class="ident" id="7630752">B</span><span class="op" id="7630753">)</span>&nbsp;<span class="op" id="7630755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630758">b</span><span class="op" id="7630759">.</span><span class="ident" id="7630760">ReportAllocs</span><span class="op" id="7630772">(</span><span class="op" id="7630773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630776">ct</span>&nbsp;<span class="op" id="7630779">:=</span>&nbsp;<span class="builtinfunc" id="7630782">new</span><span class="op" id="7630785">(</span><span class="ident" id="7630786">concurrentRandomTest</span><span class="op" id="7630806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7630809">for</span>&nbsp;<span class="ident" id="7630813">i</span>&nbsp;<span class="op" id="7630815">:=</span>&nbsp;<span class="num" id="7630818">0</span><span class="op" id="7630819">;</span>&nbsp;<span class="ident" id="7630821">i</span>&nbsp;<span class="op" id="7630823">&lt;</span>&nbsp;<span class="ident" id="7630825">b</span><span class="op" id="7630826">.</span><span class="ident" id="7630827">N</span><span class="op" id="7630828">;</span>&nbsp;<span class="ident" id="7630830">i</span><span class="op" id="7630831">++</span>&nbsp;<span class="op" id="7630834">{</span><br>
<span class="lineno">1985</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630838">doConcurrentTest</span><span class="op" id="7630854">(</span><span class="ident" id="7630855">b</span><span class="op" id="7630856">,</span>&nbsp;<span class="ident" id="7630858">ct</span><span class="op" id="7630860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7630863">}</span><br>
<span class="lineno"></span><span class="op" id="7630865">}</span>
</div>
</body>
</html>
