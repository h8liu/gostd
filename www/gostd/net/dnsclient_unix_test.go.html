<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8361973">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8362028">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8362082">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="8362133">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8362198">package</span>&nbsp;<span class="ident" id="8362206">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8362211">import</span>&nbsp;<span class="op" id="8362218">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8362221">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8362227">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8362240">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8362246">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8362254">&#34;reflect&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8362265">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8362276">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8362283">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8362286">var</span>&nbsp;<span class="ident" id="8362290">dnsTransportFallbackTests</span>&nbsp;<span class="op" id="8362316">=</span>&nbsp;<span class="op" id="8362318">[</span><span class="op" id="8362319">]</span><span class="keyword" id="8362320">struct</span>&nbsp;<span class="op" id="8362327">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8362330">server</span>&nbsp;&nbsp;<span class="builtintype" id="8362338">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8362346">name</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8362354">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8362362">qtype</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8362370">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8362378">timeout</span>&nbsp;<span class="builtintype" id="8362386">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8362391">rcode</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8362399">int</span><br>
<span class="lineno">25</span><span class="op" id="8362403">}</span><span class="op" id="8362404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8362407">//&nbsp;Querying&nbsp;&#34;com.&#34;&nbsp;with&nbsp;qtype=255&nbsp;usually&nbsp;makes&nbsp;an&nbsp;answer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8362466">//&nbsp;which&nbsp;requires&nbsp;more&nbsp;than&nbsp;512&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8362506">{</span><span class="string" id="8362507">&#34;8.8.8.8:53&#34;</span><span class="op" id="8362519">,</span>&nbsp;<span class="string" id="8362521">&#34;com.&#34;</span><span class="op" id="8362527">,</span>&nbsp;<span class="ident" id="8362529">dnsTypeALL</span><span class="op" id="8362539">,</span>&nbsp;<span class="num" id="8362541">2</span><span class="op" id="8362542">,</span>&nbsp;<span class="ident" id="8362544">dnsRcodeSuccess</span><span class="op" id="8362559">}</span><span class="op" id="8362560">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8362563">{</span><span class="string" id="8362564">&#34;8.8.4.4:53&#34;</span><span class="op" id="8362576">,</span>&nbsp;<span class="string" id="8362578">&#34;com.&#34;</span><span class="op" id="8362584">,</span>&nbsp;<span class="ident" id="8362586">dnsTypeALL</span><span class="op" id="8362596">,</span>&nbsp;<span class="num" id="8362598">4</span><span class="op" id="8362599">,</span>&nbsp;<span class="ident" id="8362601">dnsRcodeSuccess</span><span class="op" id="8362616">}</span><span class="op" id="8362617">,</span><br>
<span class="lineno">30</span><span class="op" id="8362619">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8362622">func</span>&nbsp;<span class="ident" id="8362627">TestDNSTransportFallback</span><span class="op" id="8362651">(</span><span class="ident" id="8362652">t</span>&nbsp;<span class="op" id="8362654">*</span><span class="ident" id="8362655">testing</span><span class="op" id="8362662">.</span><span class="ident" id="8362663">T</span><span class="op" id="8362664">)</span>&nbsp;<span class="op" id="8362666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8362669">if</span>&nbsp;<span class="ident" id="8362672">testing</span><span class="op" id="8362679">.</span><span class="ident" id="8362680">Short</span><span class="op" id="8362685">(</span><span class="op" id="8362686">)</span>&nbsp;<span class="op" id="8362688">||</span>&nbsp;<span class="op" id="8362691">!</span><span class="op" id="8362692">*</span><span class="ident" id="8362693">testExternal</span>&nbsp;<span class="op" id="8362706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8362710">t</span><span class="op" id="8362711">.</span><span class="ident" id="8362712">Skip</span><span class="op" id="8362716">(</span><span class="string" id="8362717">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="8362758">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8362761">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8362765">for</span>&nbsp;<span class="ident" id="8362769">_</span><span class="op" id="8362770">,</span>&nbsp;<span class="ident" id="8362772">tt</span>&nbsp;<span class="op" id="8362775">:=</span>&nbsp;<span class="keyword" id="8362778">range</span>&nbsp;<span class="ident" id="8362784">dnsTransportFallbackTests</span>&nbsp;<span class="op" id="8362810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8362814">timeout</span>&nbsp;<span class="op" id="8362822">:=</span>&nbsp;<span class="ident" id="8362825">time</span><span class="op" id="8362829">.</span><span class="ident" id="8362830">Duration</span><span class="op" id="8362838">(</span><span class="ident" id="8362839">tt</span><span class="op" id="8362841">.</span><span class="ident" id="8362842">timeout</span><span class="op" id="8362849">)</span>&nbsp;<span class="op" id="8362851">*</span>&nbsp;<span class="ident" id="8362853">time</span><span class="op" id="8362857">.</span><span class="ident" id="8362858">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8362867">msg</span><span class="op" id="8362870">,</span>&nbsp;<span class="ident" id="8362872">err</span>&nbsp;<span class="op" id="8362876">:=</span>&nbsp;<span class="ident" id="8362879">exchange</span><span class="op" id="8362887">(</span><span class="ident" id="8362888">tt</span><span class="op" id="8362890">.</span><span class="ident" id="8362891">server</span><span class="op" id="8362897">,</span>&nbsp;<span class="ident" id="8362899">tt</span><span class="op" id="8362901">.</span><span class="ident" id="8362902">name</span><span class="op" id="8362906">,</span>&nbsp;<span class="ident" id="8362908">tt</span><span class="op" id="8362910">.</span><span class="ident" id="8362911">qtype</span><span class="op" id="8362916">,</span>&nbsp;<span class="ident" id="8362918">timeout</span><span class="op" id="8362925">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8362929">if</span>&nbsp;<span class="ident" id="8362932">err</span>&nbsp;<span class="op" id="8362936">!=</span>&nbsp;<span class="ident" id="8362939">nil</span>&nbsp;<span class="op" id="8362943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8362948">t</span><span class="op" id="8362949">.</span><span class="ident" id="8362950">Error</span><span class="op" id="8362955">(</span><span class="ident" id="8362956">err</span><span class="op" id="8362959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8362964">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8362975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8362979">switch</span>&nbsp;<span class="ident" id="8362986">msg</span><span class="op" id="8362989">.</span><span class="ident" id="8362990">rcode</span>&nbsp;<span class="op" id="8362996">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8363000">case</span>&nbsp;<span class="ident" id="8363005">tt</span><span class="op" id="8363007">.</span><span class="ident" id="8363008">rcode</span><span class="op" id="8363013">,</span>&nbsp;<span class="ident" id="8363015">dnsRcodeServerFailure</span><span class="op" id="8363036">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8363040">default</span><span class="op" id="8363047">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8363052">t</span><span class="op" id="8363053">.</span><span class="ident" id="8363054">Errorf</span><span class="op" id="8363060">(</span><span class="string" id="8363061">&#34;got&nbsp;%v&nbsp;from&nbsp;%v;&nbsp;want&nbsp;%v&#34;</span><span class="op" id="8363086">,</span>&nbsp;<span class="ident" id="8363088">msg</span><span class="op" id="8363091">.</span><span class="ident" id="8363092">rcode</span><span class="op" id="8363097">,</span>&nbsp;<span class="ident" id="8363099">tt</span><span class="op" id="8363101">.</span><span class="ident" id="8363102">server</span><span class="op" id="8363108">,</span>&nbsp;<span class="ident" id="8363110">tt</span><span class="op" id="8363112">.</span><span class="ident" id="8363113">rcode</span><span class="op" id="8363118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8363123">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8363134">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8363137">}</span><br>
<span class="lineno"></span><span class="op" id="8363139">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8363142">//&nbsp;See&nbsp;RFC&nbsp;6761&nbsp;for&nbsp;further&nbsp;information&nbsp;about&nbsp;the&nbsp;reserved,&nbsp;pseudo</span><br>
<span class="lineno"></span><span class="comment" id="8363209">//&nbsp;domain&nbsp;names.</span><br>
<span class="lineno">55</span><span class="keyword" id="8363226">var</span>&nbsp;<span class="ident" id="8363230">specialDomainNameTests</span>&nbsp;<span class="op" id="8363253">=</span>&nbsp;<span class="op" id="8363255">[</span><span class="op" id="8363256">]</span><span class="keyword" id="8363257">struct</span>&nbsp;<span class="op" id="8363264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8363267">name</span>&nbsp;&nbsp;<span class="builtintype" id="8363273">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8363281">qtype</span>&nbsp;<span class="builtintype" id="8363287">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8363295">rcode</span>&nbsp;<span class="builtintype" id="8363301">int</span><br>
<span class="lineno"></span><span class="op" id="8363305">}</span><span class="op" id="8363306">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8363309">//&nbsp;Name&nbsp;resoltion&nbsp;APIs&nbsp;and&nbsp;libraries&nbsp;should&nbsp;not&nbsp;recongnize&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8363373">//&nbsp;followings&nbsp;as&nbsp;special.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8363400">{</span><span class="string" id="8363401">&#34;1.0.168.192.in-addr.arpa.&#34;</span><span class="op" id="8363428">,</span>&nbsp;<span class="ident" id="8363430">dnsTypePTR</span><span class="op" id="8363440">,</span>&nbsp;<span class="ident" id="8363442">dnsRcodeNameError</span><span class="op" id="8363459">}</span><span class="op" id="8363460">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8363463">{</span><span class="string" id="8363464">&#34;test.&#34;</span><span class="op" id="8363471">,</span>&nbsp;<span class="ident" id="8363473">dnsTypeALL</span><span class="op" id="8363483">,</span>&nbsp;<span class="ident" id="8363485">dnsRcodeNameError</span><span class="op" id="8363502">}</span><span class="op" id="8363503">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8363506">{</span><span class="string" id="8363507">&#34;example.com.&#34;</span><span class="op" id="8363521">,</span>&nbsp;<span class="ident" id="8363523">dnsTypeALL</span><span class="op" id="8363533">,</span>&nbsp;<span class="ident" id="8363535">dnsRcodeSuccess</span><span class="op" id="8363550">}</span><span class="op" id="8363551">,</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8363555">//&nbsp;Name&nbsp;resoltion&nbsp;APIs&nbsp;and&nbsp;libraries&nbsp;should&nbsp;recongnize&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8363615">//&nbsp;followings&nbsp;as&nbsp;special&nbsp;and&nbsp;should&nbsp;not&nbsp;send&nbsp;any&nbsp;queries.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8363674">//&nbsp;Though,&nbsp;we&nbsp;test&nbsp;those&nbsp;names&nbsp;here&nbsp;for&nbsp;verifying&nbsp;nagative</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8363734">//&nbsp;answers&nbsp;at&nbsp;DNS&nbsp;query-response&nbsp;interaction&nbsp;level.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8363787">{</span><span class="string" id="8363788">&#34;localhost.&#34;</span><span class="op" id="8363800">,</span>&nbsp;<span class="ident" id="8363802">dnsTypeALL</span><span class="op" id="8363812">,</span>&nbsp;<span class="ident" id="8363814">dnsRcodeNameError</span><span class="op" id="8363831">}</span><span class="op" id="8363832">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8363835">{</span><span class="string" id="8363836">&#34;invalid.&#34;</span><span class="op" id="8363846">,</span>&nbsp;<span class="ident" id="8363848">dnsTypeALL</span><span class="op" id="8363858">,</span>&nbsp;<span class="ident" id="8363860">dnsRcodeNameError</span><span class="op" id="8363877">}</span><span class="op" id="8363878">,</span><br>
<span class="lineno"></span><span class="op" id="8363880">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8363883">func</span>&nbsp;<span class="ident" id="8363888">TestSpecialDomainName</span><span class="op" id="8363909">(</span><span class="ident" id="8363910">t</span>&nbsp;<span class="op" id="8363912">*</span><span class="ident" id="8363913">testing</span><span class="op" id="8363920">.</span><span class="ident" id="8363921">T</span><span class="op" id="8363922">)</span>&nbsp;<span class="op" id="8363924">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8363927">if</span>&nbsp;<span class="ident" id="8363930">testing</span><span class="op" id="8363937">.</span><span class="ident" id="8363938">Short</span><span class="op" id="8363943">(</span><span class="op" id="8363944">)</span>&nbsp;<span class="op" id="8363946">||</span>&nbsp;<span class="op" id="8363949">!</span><span class="op" id="8363950">*</span><span class="ident" id="8363951">testExternal</span>&nbsp;<span class="op" id="8363964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8363968">t</span><span class="op" id="8363969">.</span><span class="ident" id="8363970">Skip</span><span class="op" id="8363974">(</span><span class="string" id="8363975">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="8364016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8364019">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8364023">server</span>&nbsp;<span class="op" id="8364030">:=</span>&nbsp;<span class="string" id="8364033">&#34;8.8.8.8:53&#34;</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8364047">for</span>&nbsp;<span class="ident" id="8364051">_</span><span class="op" id="8364052">,</span>&nbsp;<span class="ident" id="8364054">tt</span>&nbsp;<span class="op" id="8364057">:=</span>&nbsp;<span class="keyword" id="8364060">range</span>&nbsp;<span class="ident" id="8364066">specialDomainNameTests</span>&nbsp;<span class="op" id="8364089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8364093">msg</span><span class="op" id="8364096">,</span>&nbsp;<span class="ident" id="8364098">err</span>&nbsp;<span class="op" id="8364102">:=</span>&nbsp;<span class="ident" id="8364105">exchange</span><span class="op" id="8364113">(</span><span class="ident" id="8364114">server</span><span class="op" id="8364120">,</span>&nbsp;<span class="ident" id="8364122">tt</span><span class="op" id="8364124">.</span><span class="ident" id="8364125">name</span><span class="op" id="8364129">,</span>&nbsp;<span class="ident" id="8364131">tt</span><span class="op" id="8364133">.</span><span class="ident" id="8364134">qtype</span><span class="op" id="8364139">,</span>&nbsp;<span class="num" id="8364141">0</span><span class="op" id="8364142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8364146">if</span>&nbsp;<span class="ident" id="8364149">err</span>&nbsp;<span class="op" id="8364153">!=</span>&nbsp;<span class="ident" id="8364156">nil</span>&nbsp;<span class="op" id="8364160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8364165">t</span><span class="op" id="8364166">.</span><span class="ident" id="8364167">Error</span><span class="op" id="8364172">(</span><span class="ident" id="8364173">err</span><span class="op" id="8364176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8364181">continue</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8364192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8364196">switch</span>&nbsp;<span class="ident" id="8364203">msg</span><span class="op" id="8364206">.</span><span class="ident" id="8364207">rcode</span>&nbsp;<span class="op" id="8364213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8364217">case</span>&nbsp;<span class="ident" id="8364222">tt</span><span class="op" id="8364224">.</span><span class="ident" id="8364225">rcode</span><span class="op" id="8364230">,</span>&nbsp;<span class="ident" id="8364232">dnsRcodeServerFailure</span><span class="op" id="8364253">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8364257">default</span><span class="op" id="8364264">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8364269">t</span><span class="op" id="8364270">.</span><span class="ident" id="8364271">Errorf</span><span class="op" id="8364277">(</span><span class="string" id="8364278">&#34;got&nbsp;%v&nbsp;from&nbsp;%v;&nbsp;want&nbsp;%v&#34;</span><span class="op" id="8364303">,</span>&nbsp;<span class="ident" id="8364305">msg</span><span class="op" id="8364308">.</span><span class="ident" id="8364309">rcode</span><span class="op" id="8364314">,</span>&nbsp;<span class="ident" id="8364316">server</span><span class="op" id="8364322">,</span>&nbsp;<span class="ident" id="8364324">tt</span><span class="op" id="8364326">.</span><span class="ident" id="8364327">rcode</span><span class="op" id="8364332">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8364337">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8364348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8364351">}</span><br>
<span class="lineno"></span><span class="op" id="8364353">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="8364356">type</span>&nbsp;<span class="ident" id="8364361">resolvConfTest</span>&nbsp;<span class="keyword" id="8364376">struct</span>&nbsp;<span class="op" id="8364383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8364386">*</span><span class="ident" id="8364387">testing</span><span class="op" id="8364394">.</span><span class="ident" id="8364395">T</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8364398">dir</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8364406">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8364414">path</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8364422">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8364430">started</span>&nbsp;<span class="builtintype" id="8364438">bool</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8364444">quitc</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="8364452">chan</span>&nbsp;<span class="keyword" id="8364457">chan</span>&nbsp;<span class="keyword" id="8364462">struct</span><span class="op" id="8364468">{</span><span class="op" id="8364469">}</span><br>
<span class="lineno"></span><span class="op" id="8364471">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8364474">func</span>&nbsp;<span class="ident" id="8364479">newResolvConfTest</span><span class="op" id="8364496">(</span><span class="ident" id="8364497">t</span>&nbsp;<span class="op" id="8364499">*</span><span class="ident" id="8364500">testing</span><span class="op" id="8364507">.</span><span class="ident" id="8364508">T</span><span class="op" id="8364509">)</span>&nbsp;<span class="op" id="8364511">*</span><span class="ident" id="8364512">resolvConfTest</span>&nbsp;<span class="op" id="8364527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8364530">dir</span><span class="op" id="8364533">,</span>&nbsp;<span class="ident" id="8364535">err</span>&nbsp;<span class="op" id="8364539">:=</span>&nbsp;<span class="ident" id="8364542">ioutil</span><span class="op" id="8364548">.</span><span class="ident" id="8364549">TempDir</span><span class="op" id="8364556">(</span><span class="string" id="8364557">&#34;&#34;</span><span class="op" id="8364559">,</span>&nbsp;<span class="string" id="8364561">&#34;resolvConfTest&#34;</span><span class="op" id="8364577">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8364580">if</span>&nbsp;<span class="ident" id="8364583">err</span>&nbsp;<span class="op" id="8364587">!=</span>&nbsp;<span class="ident" id="8364590">nil</span>&nbsp;<span class="op" id="8364594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8364598">t</span><span class="op" id="8364599">.</span><span class="ident" id="8364600">Fatalf</span><span class="op" id="8364606">(</span><span class="string" id="8364607">&#34;could&nbsp;not&nbsp;create&nbsp;temp&nbsp;dir:&nbsp;%v&#34;</span><span class="op" id="8364638">,</span>&nbsp;<span class="ident" id="8364640">err</span><span class="op" id="8364643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8364646">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8364650">//&nbsp;Disable&nbsp;the&nbsp;default&nbsp;loadConfig</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8364685">onceLoadConfig</span><span class="op" id="8364699">.</span><span class="ident" id="8364700">Do</span><span class="op" id="8364702">(</span><span class="keyword" id="8364703">func</span><span class="op" id="8364707">(</span><span class="op" id="8364708">)</span>&nbsp;<span class="op" id="8364710">{</span><span class="op" id="8364711">}</span><span class="op" id="8364712">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8364716">r</span>&nbsp;<span class="op" id="8364718">:=</span>&nbsp;<span class="op" id="8364721">&amp;</span><span class="ident" id="8364722">resolvConfTest</span><span class="op" id="8364736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8364740">T</span><span class="op" id="8364741">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8364747">t</span><span class="op" id="8364748">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8364752">dir</span><span class="op" id="8364755">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="8364759">dir</span><span class="op" id="8364762">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8364766">path</span><span class="op" id="8364770">:</span>&nbsp;&nbsp;<span class="ident" id="8364773">path</span><span class="op" id="8364777">.</span><span class="ident" id="8364778">Join</span><span class="op" id="8364782">(</span><span class="ident" id="8364783">dir</span><span class="op" id="8364786">,</span>&nbsp;<span class="string" id="8364788">&#34;resolv.conf&#34;</span><span class="op" id="8364801">)</span><span class="op" id="8364802">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8364806">quitc</span><span class="op" id="8364811">:</span>&nbsp;<span class="builtinfunc" id="8364813">make</span><span class="op" id="8364817">(</span><span class="keyword" id="8364818">chan</span>&nbsp;<span class="keyword" id="8364823">chan</span>&nbsp;<span class="keyword" id="8364828">struct</span><span class="op" id="8364834">{</span><span class="op" id="8364835">}</span><span class="op" id="8364836">)</span><span class="op" id="8364837">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8364840">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8364844">return</span>&nbsp;<span class="ident" id="8364851">r</span><br>
<span class="lineno">120</span><span class="op" id="8364853">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8364856">func</span>&nbsp;<span class="op" id="8364861">(</span><span class="ident" id="8364862">r</span>&nbsp;<span class="op" id="8364864">*</span><span class="ident" id="8364865">resolvConfTest</span><span class="op" id="8364879">)</span>&nbsp;<span class="ident" id="8364881">Start</span><span class="op" id="8364886">(</span><span class="op" id="8364887">)</span>&nbsp;<span class="op" id="8364889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8364892">loadConfig</span><span class="op" id="8364902">(</span><span class="ident" id="8364903">r</span><span class="op" id="8364904">.</span><span class="ident" id="8364905">path</span><span class="op" id="8364909">,</span>&nbsp;<span class="num" id="8364911">100</span><span class="op" id="8364914">*</span><span class="ident" id="8364915">time</span><span class="op" id="8364919">.</span><span class="ident" id="8364920">Millisecond</span><span class="op" id="8364931">,</span>&nbsp;<span class="ident" id="8364933">r</span><span class="op" id="8364934">.</span><span class="ident" id="8364935">quitc</span><span class="op" id="8364940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8364943">r</span><span class="op" id="8364944">.</span><span class="ident" id="8364945">started</span>&nbsp;<span class="op" id="8364953">=</span>&nbsp;<span class="builtintype" id="8364955">true</span><br>
<span class="lineno">125</span><span class="op" id="8364960">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8364963">func</span>&nbsp;<span class="op" id="8364968">(</span><span class="ident" id="8364969">r</span>&nbsp;<span class="op" id="8364971">*</span><span class="ident" id="8364972">resolvConfTest</span><span class="op" id="8364986">)</span>&nbsp;<span class="ident" id="8364988">SetConf</span><span class="op" id="8364995">(</span><span class="ident" id="8364996">s</span>&nbsp;<span class="builtintype" id="8364998">string</span><span class="op" id="8365004">)</span>&nbsp;<span class="op" id="8365006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8365009">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;file&nbsp;mtime&nbsp;will&nbsp;be&nbsp;different&nbsp;once&nbsp;we&#39;re&nbsp;done&nbsp;here,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8365078">//&nbsp;even&nbsp;on&nbsp;systems&nbsp;with&nbsp;coarse&nbsp;(1s)&nbsp;mtime&nbsp;resolution.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8365133">time</span><span class="op" id="8365137">.</span><span class="ident" id="8365138">Sleep</span><span class="op" id="8365143">(</span><span class="ident" id="8365144">time</span><span class="op" id="8365148">.</span><span class="ident" id="8365149">Second</span><span class="op" id="8365155">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8365159">f</span><span class="op" id="8365160">,</span>&nbsp;<span class="ident" id="8365162">err</span>&nbsp;<span class="op" id="8365166">:=</span>&nbsp;<span class="ident" id="8365169">os</span><span class="op" id="8365171">.</span><span class="ident" id="8365172">OpenFile</span><span class="op" id="8365180">(</span><span class="ident" id="8365181">r</span><span class="op" id="8365182">.</span><span class="ident" id="8365183">path</span><span class="op" id="8365187">,</span>&nbsp;<span class="ident" id="8365189">os</span><span class="op" id="8365191">.</span><span class="ident" id="8365192">O_CREATE</span><span class="op" id="8365200">|</span><span class="ident" id="8365201">os</span><span class="op" id="8365203">.</span><span class="ident" id="8365204">O_TRUNC</span><span class="op" id="8365211">|</span><span class="ident" id="8365212">os</span><span class="op" id="8365214">.</span><span class="ident" id="8365215">O_WRONLY</span><span class="op" id="8365223">,</span>&nbsp;<span class="num" id="8365225">0600</span><span class="op" id="8365229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8365232">if</span>&nbsp;<span class="ident" id="8365235">err</span>&nbsp;<span class="op" id="8365239">!=</span>&nbsp;<span class="ident" id="8365242">nil</span>&nbsp;<span class="op" id="8365246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8365250">r</span><span class="op" id="8365251">.</span><span class="ident" id="8365252">Fatalf</span><span class="op" id="8365258">(</span><span class="string" id="8365259">&#34;failed&nbsp;to&nbsp;create&nbsp;temp&nbsp;file&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="8365294">,</span>&nbsp;<span class="ident" id="8365296">r</span><span class="op" id="8365297">.</span><span class="ident" id="8365298">path</span><span class="op" id="8365302">,</span>&nbsp;<span class="ident" id="8365304">err</span><span class="op" id="8365307">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8365310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8365313">if</span>&nbsp;<span class="ident" id="8365316">_</span><span class="op" id="8365317">,</span>&nbsp;<span class="ident" id="8365319">err</span>&nbsp;<span class="op" id="8365323">:=</span>&nbsp;<span class="ident" id="8365326">io</span><span class="op" id="8365328">.</span><span class="ident" id="8365329">WriteString</span><span class="op" id="8365340">(</span><span class="ident" id="8365341">f</span><span class="op" id="8365342">,</span>&nbsp;<span class="ident" id="8365344">s</span><span class="op" id="8365345">)</span><span class="op" id="8365346">;</span>&nbsp;<span class="ident" id="8365348">err</span>&nbsp;<span class="op" id="8365352">!=</span>&nbsp;<span class="ident" id="8365355">nil</span>&nbsp;<span class="op" id="8365359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8365363">f</span><span class="op" id="8365364">.</span><span class="ident" id="8365365">Close</span><span class="op" id="8365370">(</span><span class="op" id="8365371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8365375">r</span><span class="op" id="8365376">.</span><span class="ident" id="8365377">Fatalf</span><span class="op" id="8365383">(</span><span class="string" id="8365384">&#34;failed&nbsp;to&nbsp;write&nbsp;temp&nbsp;file:&nbsp;%v&#34;</span><span class="op" id="8365415">,</span>&nbsp;<span class="ident" id="8365417">err</span><span class="op" id="8365420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8365423">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8365426">f</span><span class="op" id="8365427">.</span><span class="ident" id="8365428">Close</span><span class="op" id="8365433">(</span><span class="op" id="8365434">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8365438">if</span>&nbsp;<span class="ident" id="8365441">r</span><span class="op" id="8365442">.</span><span class="ident" id="8365443">started</span>&nbsp;<span class="op" id="8365451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8365455">cfg</span><span class="op" id="8365458">.</span><span class="ident" id="8365459">ch</span>&nbsp;<span class="op" id="8365462">&lt;-</span>&nbsp;<span class="keyword" id="8365465">struct</span><span class="op" id="8365471">{</span><span class="op" id="8365472">}</span><span class="op" id="8365473">{</span><span class="op" id="8365474">}</span>&nbsp;<span class="comment" id="8365476">//&nbsp;fill&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8365493">cfg</span><span class="op" id="8365496">.</span><span class="ident" id="8365497">ch</span>&nbsp;<span class="op" id="8365500">&lt;-</span>&nbsp;<span class="keyword" id="8365503">struct</span><span class="op" id="8365509">{</span><span class="op" id="8365510">}</span><span class="op" id="8365511">{</span><span class="op" id="8365512">}</span>&nbsp;<span class="comment" id="8365514">//&nbsp;wait&nbsp;for&nbsp;reload&nbsp;to&nbsp;begin</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8365544">cfg</span><span class="op" id="8365547">.</span><span class="ident" id="8365548">ch</span>&nbsp;<span class="op" id="8365551">&lt;-</span>&nbsp;<span class="keyword" id="8365554">struct</span><span class="op" id="8365560">{</span><span class="op" id="8365561">}</span><span class="op" id="8365562">{</span><span class="op" id="8365563">}</span>&nbsp;<span class="comment" id="8365565">//&nbsp;wait&nbsp;for&nbsp;reload&nbsp;to&nbsp;complete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8365597">}</span><br>
<span class="lineno"></span><span class="op" id="8365599">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8365602">func</span>&nbsp;<span class="op" id="8365607">(</span><span class="ident" id="8365608">r</span>&nbsp;<span class="op" id="8365610">*</span><span class="ident" id="8365611">resolvConfTest</span><span class="op" id="8365625">)</span>&nbsp;<span class="ident" id="8365627">WantServers</span><span class="op" id="8365638">(</span><span class="ident" id="8365639">want</span>&nbsp;<span class="op" id="8365644">[</span><span class="op" id="8365645">]</span><span class="builtintype" id="8365646">string</span><span class="op" id="8365652">)</span>&nbsp;<span class="op" id="8365654">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8365657">cfg</span><span class="op" id="8365660">.</span><span class="ident" id="8365661">mu</span><span class="op" id="8365663">.</span><span class="ident" id="8365664">RLock</span><span class="op" id="8365669">(</span><span class="op" id="8365670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8365673">defer</span>&nbsp;<span class="ident" id="8365679">cfg</span><span class="op" id="8365682">.</span><span class="ident" id="8365683">mu</span><span class="op" id="8365685">.</span><span class="ident" id="8365686">RUnlock</span><span class="op" id="8365693">(</span><span class="op" id="8365694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8365697">if</span>&nbsp;<span class="ident" id="8365700">got</span>&nbsp;<span class="op" id="8365704">:=</span>&nbsp;<span class="ident" id="8365707">cfg</span><span class="op" id="8365710">.</span><span class="ident" id="8365711">dnsConfig</span><span class="op" id="8365720">.</span><span class="ident" id="8365721">servers</span><span class="op" id="8365728">;</span>&nbsp;<span class="op" id="8365730">!</span><span class="ident" id="8365731">reflect</span><span class="op" id="8365738">.</span><span class="ident" id="8365739">DeepEqual</span><span class="op" id="8365748">(</span><span class="ident" id="8365749">got</span><span class="op" id="8365752">,</span>&nbsp;<span class="ident" id="8365754">want</span><span class="op" id="8365758">)</span>&nbsp;<span class="op" id="8365760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8365764">r</span><span class="op" id="8365765">.</span><span class="ident" id="8365766">Fatalf</span><span class="op" id="8365772">(</span><span class="string" id="8365773">&#34;Unexpected&nbsp;dns&nbsp;server&nbsp;loaded,&nbsp;got&nbsp;%v&nbsp;want&nbsp;%v&#34;</span><span class="op" id="8365819">,</span>&nbsp;<span class="ident" id="8365821">got</span><span class="op" id="8365824">,</span>&nbsp;<span class="ident" id="8365826">want</span><span class="op" id="8365830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8365833">}</span><br>
<span class="lineno">155</span><span class="op" id="8365835">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8365838">func</span>&nbsp;<span class="op" id="8365843">(</span><span class="ident" id="8365844">r</span>&nbsp;<span class="op" id="8365846">*</span><span class="ident" id="8365847">resolvConfTest</span><span class="op" id="8365861">)</span>&nbsp;<span class="ident" id="8365863">Close</span><span class="op" id="8365868">(</span><span class="op" id="8365869">)</span>&nbsp;<span class="op" id="8365871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8365874">resp</span>&nbsp;<span class="op" id="8365879">:=</span>&nbsp;<span class="builtinfunc" id="8365882">make</span><span class="op" id="8365886">(</span><span class="keyword" id="8365887">chan</span>&nbsp;<span class="keyword" id="8365892">struct</span><span class="op" id="8365898">{</span><span class="op" id="8365899">}</span><span class="op" id="8365900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8365903">r</span><span class="op" id="8365904">.</span><span class="ident" id="8365905">quitc</span>&nbsp;<span class="op" id="8365911">&lt;-</span>&nbsp;<span class="ident" id="8365914">resp</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8365920">&lt;-</span><span class="ident" id="8365922">resp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8365928">if</span>&nbsp;<span class="ident" id="8365931">err</span>&nbsp;<span class="op" id="8365935">:=</span>&nbsp;<span class="ident" id="8365938">os</span><span class="op" id="8365940">.</span><span class="ident" id="8365941">RemoveAll</span><span class="op" id="8365950">(</span><span class="ident" id="8365951">r</span><span class="op" id="8365952">.</span><span class="ident" id="8365953">dir</span><span class="op" id="8365956">)</span><span class="op" id="8365957">;</span>&nbsp;<span class="ident" id="8365959">err</span>&nbsp;<span class="op" id="8365963">!=</span>&nbsp;<span class="ident" id="8365966">nil</span>&nbsp;<span class="op" id="8365970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8365974">r</span><span class="op" id="8365975">.</span><span class="ident" id="8365976">Logf</span><span class="op" id="8365980">(</span><span class="string" id="8365981">&#34;failed&nbsp;to&nbsp;remove&nbsp;temp&nbsp;dir&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="8366015">,</span>&nbsp;<span class="ident" id="8366017">r</span><span class="op" id="8366018">.</span><span class="ident" id="8366019">dir</span><span class="op" id="8366022">,</span>&nbsp;<span class="ident" id="8366024">err</span><span class="op" id="8366027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8366030">}</span><br>
<span class="lineno"></span><span class="op" id="8366032">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="8366035">func</span>&nbsp;<span class="ident" id="8366040">TestReloadResolvConfFail</span><span class="op" id="8366064">(</span><span class="ident" id="8366065">t</span>&nbsp;<span class="op" id="8366067">*</span><span class="ident" id="8366068">testing</span><span class="op" id="8366075">.</span><span class="ident" id="8366076">T</span><span class="op" id="8366077">)</span>&nbsp;<span class="op" id="8366079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8366082">if</span>&nbsp;<span class="ident" id="8366085">testing</span><span class="op" id="8366092">.</span><span class="ident" id="8366093">Short</span><span class="op" id="8366098">(</span><span class="op" id="8366099">)</span>&nbsp;<span class="op" id="8366101">||</span>&nbsp;<span class="op" id="8366104">!</span><span class="op" id="8366105">*</span><span class="ident" id="8366106">testExternal</span>&nbsp;<span class="op" id="8366119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8366123">t</span><span class="op" id="8366124">.</span><span class="ident" id="8366125">Skip</span><span class="op" id="8366129">(</span><span class="string" id="8366130">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="8366171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8366174">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8366178">r</span>&nbsp;<span class="op" id="8366180">:=</span>&nbsp;<span class="ident" id="8366183">newResolvConfTest</span><span class="op" id="8366200">(</span><span class="ident" id="8366201">t</span><span class="op" id="8366202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8366205">defer</span>&nbsp;<span class="ident" id="8366211">r</span><span class="op" id="8366212">.</span><span class="ident" id="8366213">Close</span><span class="op" id="8366218">(</span><span class="op" id="8366219">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8366223">//&nbsp;resolv.conf.tmp&nbsp;does&nbsp;not&nbsp;exist&nbsp;yet</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8366262">r</span><span class="op" id="8366263">.</span><span class="ident" id="8366264">Start</span><span class="op" id="8366269">(</span><span class="op" id="8366270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8366273">if</span>&nbsp;<span class="ident" id="8366276">_</span><span class="op" id="8366277">,</span>&nbsp;<span class="ident" id="8366279">err</span>&nbsp;<span class="op" id="8366283">:=</span>&nbsp;<span class="ident" id="8366286">goLookupIP</span><span class="op" id="8366296">(</span><span class="string" id="8366297">&#34;golang.org&#34;</span><span class="op" id="8366309">)</span><span class="op" id="8366310">;</span>&nbsp;<span class="ident" id="8366312">err</span>&nbsp;<span class="op" id="8366316">==</span>&nbsp;<span class="ident" id="8366319">nil</span>&nbsp;<span class="op" id="8366323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8366327">t</span><span class="op" id="8366328">.</span><span class="ident" id="8366329">Fatal</span><span class="op" id="8366334">(</span><span class="string" id="8366335">&#34;goLookupIP(missing)&nbsp;succeeded&#34;</span><span class="op" id="8366366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8366369">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8366373">r</span><span class="op" id="8366374">.</span><span class="ident" id="8366375">SetConf</span><span class="op" id="8366382">(</span><span class="string" id="8366383">&#34;nameserver&nbsp;8.8.8.8&#34;</span><span class="op" id="8366403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8366406">if</span>&nbsp;<span class="ident" id="8366409">_</span><span class="op" id="8366410">,</span>&nbsp;<span class="ident" id="8366412">err</span>&nbsp;<span class="op" id="8366416">:=</span>&nbsp;<span class="ident" id="8366419">goLookupIP</span><span class="op" id="8366429">(</span><span class="string" id="8366430">&#34;golang.org&#34;</span><span class="op" id="8366442">)</span><span class="op" id="8366443">;</span>&nbsp;<span class="ident" id="8366445">err</span>&nbsp;<span class="op" id="8366449">!=</span>&nbsp;<span class="ident" id="8366452">nil</span>&nbsp;<span class="op" id="8366456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8366460">t</span><span class="op" id="8366461">.</span><span class="ident" id="8366462">Fatalf</span><span class="op" id="8366468">(</span><span class="string" id="8366469">&#34;goLookupIP(missing;&nbsp;good)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8366507">,</span>&nbsp;<span class="ident" id="8366509">err</span><span class="op" id="8366512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8366515">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8366519">//&nbsp;Using&nbsp;a&nbsp;bad&nbsp;resolv.conf&nbsp;while&nbsp;we&nbsp;had&nbsp;a&nbsp;good</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8366567">//&nbsp;one&nbsp;before&nbsp;should&nbsp;not&nbsp;update&nbsp;the&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8366611">r</span><span class="op" id="8366612">.</span><span class="ident" id="8366613">SetConf</span><span class="op" id="8366620">(</span><span class="string" id="8366621">&#34;&#34;</span><span class="op" id="8366623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8366626">if</span>&nbsp;<span class="ident" id="8366629">_</span><span class="op" id="8366630">,</span>&nbsp;<span class="ident" id="8366632">err</span>&nbsp;<span class="op" id="8366636">:=</span>&nbsp;<span class="ident" id="8366639">goLookupIP</span><span class="op" id="8366649">(</span><span class="string" id="8366650">&#34;golang.org&#34;</span><span class="op" id="8366662">)</span><span class="op" id="8366663">;</span>&nbsp;<span class="ident" id="8366665">err</span>&nbsp;<span class="op" id="8366669">!=</span>&nbsp;<span class="ident" id="8366672">nil</span>&nbsp;<span class="op" id="8366676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8366680">t</span><span class="op" id="8366681">.</span><span class="ident" id="8366682">Fatalf</span><span class="op" id="8366688">(</span><span class="string" id="8366689">&#34;goLookupIP(missing;&nbsp;good;&nbsp;bad)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8366732">,</span>&nbsp;<span class="ident" id="8366734">err</span><span class="op" id="8366737">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8366740">}</span><br>
<span class="lineno"></span><span class="op" id="8366742">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8366745">func</span>&nbsp;<span class="ident" id="8366750">TestReloadResolvConfChange</span><span class="op" id="8366776">(</span><span class="ident" id="8366777">t</span>&nbsp;<span class="op" id="8366779">*</span><span class="ident" id="8366780">testing</span><span class="op" id="8366787">.</span><span class="ident" id="8366788">T</span><span class="op" id="8366789">)</span>&nbsp;<span class="op" id="8366791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8366794">if</span>&nbsp;<span class="ident" id="8366797">testing</span><span class="op" id="8366804">.</span><span class="ident" id="8366805">Short</span><span class="op" id="8366810">(</span><span class="op" id="8366811">)</span>&nbsp;<span class="op" id="8366813">||</span>&nbsp;<span class="op" id="8366816">!</span><span class="op" id="8366817">*</span><span class="ident" id="8366818">testExternal</span>&nbsp;<span class="op" id="8366831">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8366835">t</span><span class="op" id="8366836">.</span><span class="ident" id="8366837">Skip</span><span class="op" id="8366841">(</span><span class="string" id="8366842">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="8366883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8366886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8366890">r</span>&nbsp;<span class="op" id="8366892">:=</span>&nbsp;<span class="ident" id="8366895">newResolvConfTest</span><span class="op" id="8366912">(</span><span class="ident" id="8366913">t</span><span class="op" id="8366914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8366917">defer</span>&nbsp;<span class="ident" id="8366923">r</span><span class="op" id="8366924">.</span><span class="ident" id="8366925">Close</span><span class="op" id="8366930">(</span><span class="op" id="8366931">)</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8366935">r</span><span class="op" id="8366936">.</span><span class="ident" id="8366937">SetConf</span><span class="op" id="8366944">(</span><span class="string" id="8366945">&#34;nameserver&nbsp;8.8.8.8&#34;</span><span class="op" id="8366965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8366968">r</span><span class="op" id="8366969">.</span><span class="ident" id="8366970">Start</span><span class="op" id="8366975">(</span><span class="op" id="8366976">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8366980">if</span>&nbsp;<span class="ident" id="8366983">_</span><span class="op" id="8366984">,</span>&nbsp;<span class="ident" id="8366986">err</span>&nbsp;<span class="op" id="8366990">:=</span>&nbsp;<span class="ident" id="8366993">goLookupIP</span><span class="op" id="8367003">(</span><span class="string" id="8367004">&#34;golang.org&#34;</span><span class="op" id="8367016">)</span><span class="op" id="8367017">;</span>&nbsp;<span class="ident" id="8367019">err</span>&nbsp;<span class="op" id="8367023">!=</span>&nbsp;<span class="ident" id="8367026">nil</span>&nbsp;<span class="op" id="8367030">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8367034">t</span><span class="op" id="8367035">.</span><span class="ident" id="8367036">Fatalf</span><span class="op" id="8367042">(</span><span class="string" id="8367043">&#34;goLookupIP(good)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8367072">,</span>&nbsp;<span class="ident" id="8367074">err</span><span class="op" id="8367077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8367080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8367083">r</span><span class="op" id="8367084">.</span><span class="ident" id="8367085">WantServers</span><span class="op" id="8367096">(</span><span class="op" id="8367097">[</span><span class="op" id="8367098">]</span><span class="builtintype" id="8367099">string</span><span class="op" id="8367105">{</span><span class="string" id="8367106">&#34;8.8.8.8&#34;</span><span class="op" id="8367115">}</span><span class="op" id="8367116">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8367120">//&nbsp;Using&nbsp;a&nbsp;bad&nbsp;resolv.conf&nbsp;when&nbsp;we&nbsp;had&nbsp;a&nbsp;good&nbsp;one</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8367171">//&nbsp;before&nbsp;should&nbsp;not&nbsp;update&nbsp;the&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8367211">r</span><span class="op" id="8367212">.</span><span class="ident" id="8367213">SetConf</span><span class="op" id="8367220">(</span><span class="string" id="8367221">&#34;&#34;</span><span class="op" id="8367223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8367226">if</span>&nbsp;<span class="ident" id="8367229">_</span><span class="op" id="8367230">,</span>&nbsp;<span class="ident" id="8367232">err</span>&nbsp;<span class="op" id="8367236">:=</span>&nbsp;<span class="ident" id="8367239">goLookupIP</span><span class="op" id="8367249">(</span><span class="string" id="8367250">&#34;golang.org&#34;</span><span class="op" id="8367262">)</span><span class="op" id="8367263">;</span>&nbsp;<span class="ident" id="8367265">err</span>&nbsp;<span class="op" id="8367269">!=</span>&nbsp;<span class="ident" id="8367272">nil</span>&nbsp;<span class="op" id="8367276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8367280">t</span><span class="op" id="8367281">.</span><span class="ident" id="8367282">Fatalf</span><span class="op" id="8367288">(</span><span class="string" id="8367289">&#34;goLookupIP(good;&nbsp;bad)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8367323">,</span>&nbsp;<span class="ident" id="8367325">err</span><span class="op" id="8367328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8367331">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8367335">//&nbsp;A&nbsp;new&nbsp;good&nbsp;config&nbsp;should&nbsp;get&nbsp;picked&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8367378">r</span><span class="op" id="8367379">.</span><span class="ident" id="8367380">SetConf</span><span class="op" id="8367387">(</span><span class="string" id="8367388">&#34;nameserver&nbsp;8.8.4.4&#34;</span><span class="op" id="8367408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8367411">r</span><span class="op" id="8367412">.</span><span class="ident" id="8367413">WantServers</span><span class="op" id="8367424">(</span><span class="op" id="8367425">[</span><span class="op" id="8367426">]</span><span class="builtintype" id="8367427">string</span><span class="op" id="8367433">{</span><span class="string" id="8367434">&#34;8.8.4.4&#34;</span><span class="op" id="8367443">}</span><span class="op" id="8367444">)</span><br>
<span class="lineno"></span><span class="op" id="8367446">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="keyword" id="8367449">func</span>&nbsp;<span class="ident" id="8367454">BenchmarkGoLookupIP</span><span class="op" id="8367473">(</span><span class="ident" id="8367474">b</span>&nbsp;<span class="op" id="8367476">*</span><span class="ident" id="8367477">testing</span><span class="op" id="8367484">.</span><span class="ident" id="8367485">B</span><span class="op" id="8367486">)</span>&nbsp;<span class="op" id="8367488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8367491">for</span>&nbsp;<span class="ident" id="8367495">i</span>&nbsp;<span class="op" id="8367497">:=</span>&nbsp;<span class="num" id="8367500">0</span><span class="op" id="8367501">;</span>&nbsp;<span class="ident" id="8367503">i</span>&nbsp;<span class="op" id="8367505">&lt;</span>&nbsp;<span class="ident" id="8367507">b</span><span class="op" id="8367508">.</span><span class="ident" id="8367509">N</span><span class="op" id="8367510">;</span>&nbsp;<span class="ident" id="8367512">i</span><span class="op" id="8367513">++</span>&nbsp;<span class="op" id="8367516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8367520">goLookupIP</span><span class="op" id="8367530">(</span><span class="string" id="8367531">&#34;www.example.com&#34;</span><span class="op" id="8367548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8367551">}</span><br>
<span class="lineno">225</span><span class="op" id="8367553">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8367556">func</span>&nbsp;<span class="ident" id="8367561">BenchmarkGoLookupIPNoSuchHost</span><span class="op" id="8367590">(</span><span class="ident" id="8367591">b</span>&nbsp;<span class="op" id="8367593">*</span><span class="ident" id="8367594">testing</span><span class="op" id="8367601">.</span><span class="ident" id="8367602">B</span><span class="op" id="8367603">)</span>&nbsp;<span class="op" id="8367605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8367608">for</span>&nbsp;<span class="ident" id="8367612">i</span>&nbsp;<span class="op" id="8367614">:=</span>&nbsp;<span class="num" id="8367617">0</span><span class="op" id="8367618">;</span>&nbsp;<span class="ident" id="8367620">i</span>&nbsp;<span class="op" id="8367622">&lt;</span>&nbsp;<span class="ident" id="8367624">b</span><span class="op" id="8367625">.</span><span class="ident" id="8367626">N</span><span class="op" id="8367627">;</span>&nbsp;<span class="ident" id="8367629">i</span><span class="op" id="8367630">++</span>&nbsp;<span class="op" id="8367633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8367637">goLookupIP</span><span class="op" id="8367647">(</span><span class="string" id="8367648">&#34;some.nonexistent&#34;</span><span class="op" id="8367666">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8367669">}</span><br>
<span class="lineno"></span><span class="op" id="8367671">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8367674">func</span>&nbsp;<span class="ident" id="8367679">BenchmarkGoLookupIPWithBrokenNameServer</span><span class="op" id="8367718">(</span><span class="ident" id="8367719">b</span>&nbsp;<span class="op" id="8367721">*</span><span class="ident" id="8367722">testing</span><span class="op" id="8367729">.</span><span class="ident" id="8367730">B</span><span class="op" id="8367731">)</span>&nbsp;<span class="op" id="8367733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8367736">onceLoadConfig</span><span class="op" id="8367750">.</span><span class="ident" id="8367751">Do</span><span class="op" id="8367753">(</span><span class="ident" id="8367754">loadDefaultConfig</span><span class="op" id="8367771">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8367774">if</span>&nbsp;<span class="ident" id="8367777">cfg</span><span class="op" id="8367780">.</span><span class="ident" id="8367781">dnserr</span>&nbsp;<span class="op" id="8367788">!=</span>&nbsp;<span class="ident" id="8367791">nil</span>&nbsp;<span class="op" id="8367795">||</span>&nbsp;<span class="ident" id="8367798">cfg</span><span class="op" id="8367801">.</span><span class="ident" id="8367802">dnsConfig</span>&nbsp;<span class="op" id="8367812">==</span>&nbsp;<span class="ident" id="8367815">nil</span>&nbsp;<span class="op" id="8367819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8367823">b</span><span class="op" id="8367824">.</span><span class="ident" id="8367825">Fatalf</span><span class="op" id="8367831">(</span><span class="string" id="8367832">&#34;loadConfig&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8367855">,</span>&nbsp;<span class="ident" id="8367857">cfg</span><span class="op" id="8367860">.</span><span class="ident" id="8367861">dnserr</span><span class="op" id="8367867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8367870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8367873">//&nbsp;This&nbsp;looks&nbsp;ugly&nbsp;but&nbsp;it&#39;s&nbsp;safe&nbsp;as&nbsp;long&nbsp;as&nbsp;benchmarks&nbsp;are&nbsp;run</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8367937">//&nbsp;sequentially&nbsp;in&nbsp;package&nbsp;testing.</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8367974">orig</span>&nbsp;<span class="op" id="8367979">:=</span>&nbsp;<span class="ident" id="8367982">cfg</span><span class="op" id="8367985">.</span><span class="ident" id="8367986">dnsConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8367997">cfg</span><span class="op" id="8368000">.</span><span class="ident" id="8368001">dnsConfig</span><span class="op" id="8368010">.</span><span class="ident" id="8368011">servers</span>&nbsp;<span class="op" id="8368019">=</span>&nbsp;<span class="builtinfunc" id="8368021">append</span><span class="op" id="8368027">(</span><span class="op" id="8368028">[</span><span class="op" id="8368029">]</span><span class="builtintype" id="8368030">string</span><span class="op" id="8368036">{</span><span class="string" id="8368037">&#34;203.0.113.254&#34;</span><span class="op" id="8368052">}</span><span class="op" id="8368053">,</span>&nbsp;<span class="ident" id="8368055">cfg</span><span class="op" id="8368058">.</span><span class="ident" id="8368059">dnsConfig</span><span class="op" id="8368068">.</span><span class="ident" id="8368069">servers</span><span class="op" id="8368076">...</span><span class="op" id="8368079">)</span>&nbsp;<span class="comment" id="8368081">//&nbsp;use&nbsp;TEST-NET-3&nbsp;block,&nbsp;see&nbsp;RFC&nbsp;5737</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8368120">for</span>&nbsp;<span class="ident" id="8368124">i</span>&nbsp;<span class="op" id="8368126">:=</span>&nbsp;<span class="num" id="8368129">0</span><span class="op" id="8368130">;</span>&nbsp;<span class="ident" id="8368132">i</span>&nbsp;<span class="op" id="8368134">&lt;</span>&nbsp;<span class="ident" id="8368136">b</span><span class="op" id="8368137">.</span><span class="ident" id="8368138">N</span><span class="op" id="8368139">;</span>&nbsp;<span class="ident" id="8368141">i</span><span class="op" id="8368142">++</span>&nbsp;<span class="op" id="8368145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8368149">goLookupIP</span><span class="op" id="8368159">(</span><span class="string" id="8368160">&#34;www.example.com&#34;</span><span class="op" id="8368177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8368180">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8368183">cfg</span><span class="op" id="8368186">.</span><span class="ident" id="8368187">dnsConfig</span>&nbsp;<span class="op" id="8368197">=</span>&nbsp;<span class="ident" id="8368199">orig</span><br>
<span class="lineno"></span><span class="op" id="8368204">}</span>
</div>
</body>
</html>
