<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/lzw</h2>
<ul>
<li><a href="/gostd/compress/lzw/reader.go.html">reader.go</a></li>
<li><a href="/gostd/compress/lzw/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/compress/lzw/writer.go.html">writer.go</a></li>
<li><a href="/gostd/compress/lzw/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6012273">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6012328">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6012382">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6012433">//&nbsp;Package&nbsp;lzw&nbsp;implements&nbsp;the&nbsp;Lempel-Ziv-Welch&nbsp;compressed&nbsp;data&nbsp;format,</span><br>
<span class="lineno"></span><span class="comment" id="6012504">//&nbsp;described&nbsp;in&nbsp;T.&nbsp;A.&nbsp;Welch,&nbsp;``A&nbsp;Technique&nbsp;for&nbsp;High-Performance&nbsp;Data</span><br>
<span class="lineno"></span><span class="comment" id="6012573">//&nbsp;Compression&#39;&#39;,&nbsp;Computer,&nbsp;17(6)&nbsp;(June&nbsp;1984),&nbsp;pp&nbsp;8-19.</span><br>
<span class="lineno"></span><span class="comment" id="6012629">//</span><br>
<span class="lineno"></span><span class="comment" id="6012632">//&nbsp;In&nbsp;particular,&nbsp;it&nbsp;implements&nbsp;LZW&nbsp;as&nbsp;used&nbsp;by&nbsp;the&nbsp;GIF&nbsp;and&nbsp;PDF&nbsp;file</span><br>
<span class="lineno">10</span><span class="comment" id="6012700">//&nbsp;formats,&nbsp;which&nbsp;means&nbsp;variable-width&nbsp;codes&nbsp;up&nbsp;to&nbsp;12&nbsp;bits&nbsp;and&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="6012773">//&nbsp;two&nbsp;non-literal&nbsp;codes&nbsp;are&nbsp;a&nbsp;clear&nbsp;code&nbsp;and&nbsp;an&nbsp;EOF&nbsp;code.</span><br>
<span class="lineno"></span><span class="comment" id="6012832">//</span><br>
<span class="lineno"></span><span class="comment" id="6012835">//&nbsp;The&nbsp;TIFF&nbsp;file&nbsp;format&nbsp;uses&nbsp;a&nbsp;similar&nbsp;but&nbsp;incompatible&nbsp;version&nbsp;of&nbsp;the&nbsp;LZW</span><br>
<span class="lineno"></span><span class="comment" id="6012910">//&nbsp;algorithm.&nbsp;See&nbsp;the&nbsp;golang.org/x/image/tiff/lzw&nbsp;package&nbsp;for&nbsp;an</span><br>
<span class="lineno">15</span><span class="comment" id="6012975">//&nbsp;implementation.</span><br>
<span class="lineno"></span><span class="keyword" id="6012994">package</span>&nbsp;<span class="ident" id="6013002">lzw</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6013007">//&nbsp;TODO(nigeltao):&nbsp;check&nbsp;that&nbsp;PDF&nbsp;uses&nbsp;LZW&nbsp;in&nbsp;the&nbsp;same&nbsp;way&nbsp;as&nbsp;GIF,</span><br>
<span class="lineno"></span><span class="comment" id="6013074">//&nbsp;modulo&nbsp;LSB/MSB&nbsp;packing&nbsp;order.</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="6013108">import</span>&nbsp;<span class="op" id="6013115">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6013118">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6013127">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6013137">&#34;fmt&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6013144">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="6013149">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6013152">//&nbsp;Order&nbsp;specifies&nbsp;the&nbsp;bit&nbsp;ordering&nbsp;in&nbsp;an&nbsp;LZW&nbsp;data&nbsp;stream.</span><br>
<span class="lineno"></span><span class="keyword" id="6013211">type</span>&nbsp;<span class="ident" id="6013216">Order</span>&nbsp;<span class="builtintype" id="6013222">int</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="6013227">const</span>&nbsp;<span class="op" id="6013233">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6013236">//&nbsp;LSB&nbsp;means&nbsp;Least&nbsp;Significant&nbsp;Bits&nbsp;first,&nbsp;as&nbsp;used&nbsp;in&nbsp;the&nbsp;GIF&nbsp;file&nbsp;format.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6013312">LSB</span>&nbsp;<span class="ident" id="6013316">Order</span>&nbsp;<span class="op" id="6013322">=</span>&nbsp;<span class="ident" id="6013324">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6013330">//&nbsp;MSB&nbsp;means&nbsp;Most&nbsp;Significant&nbsp;Bits&nbsp;first,&nbsp;as&nbsp;used&nbsp;in&nbsp;the&nbsp;TIFF&nbsp;and&nbsp;PDF</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6013401">//&nbsp;file&nbsp;formats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6013419">MSB</span><br>
<span class="lineno"></span><span class="op" id="6013423">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6013426">const</span>&nbsp;<span class="op" id="6013432">(</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6013435">maxWidth</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6013454">=</span>&nbsp;<span class="num" id="6013456">12</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6013460">decoderInvalidCode</span>&nbsp;<span class="op" id="6013479">=</span>&nbsp;<span class="num" id="6013481">0xffff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6013489">flushBuffer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6013508">=</span>&nbsp;<span class="num" id="6013510">1</span>&nbsp;<span class="op" id="6013512">&lt;&lt;</span>&nbsp;<span class="ident" id="6013515">maxWidth</span><br>
<span class="lineno"></span><span class="op" id="6013524">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="6013527">//&nbsp;decoder&nbsp;is&nbsp;the&nbsp;state&nbsp;from&nbsp;which&nbsp;the&nbsp;readXxx&nbsp;method&nbsp;converts&nbsp;a&nbsp;byte</span><br>
<span class="lineno"></span><span class="comment" id="6013597">//&nbsp;stream&nbsp;into&nbsp;a&nbsp;code&nbsp;stream.</span><br>
<span class="lineno"></span><span class="keyword" id="6013627">type</span>&nbsp;<span class="ident" id="6013632">decoder</span>&nbsp;<span class="keyword" id="6013640">struct</span>&nbsp;<span class="op" id="6013647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6013650">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6013659">io</span><span class="op" id="6013661">.</span><span class="ident" id="6013662">ByteReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6013674">bits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6013683">uint32</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6013691">nBits</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6013700">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6013706">width</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6013715">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6013721">read</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6013730">func</span><span class="op" id="6013734">(</span><span class="op" id="6013735">*</span><span class="ident" id="6013736">decoder</span><span class="op" id="6013743">)</span>&nbsp;<span class="op" id="6013745">(</span><span class="builtintype" id="6013746">uint16</span><span class="op" id="6013752">,</span>&nbsp;<span class="builtintype" id="6013754">error</span><span class="op" id="6013759">)</span>&nbsp;<span class="comment" id="6013761">//&nbsp;readLSB&nbsp;or&nbsp;readMSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6013784">litWidth</span>&nbsp;<span class="builtintype" id="6013793">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6013824">//&nbsp;width&nbsp;in&nbsp;bits&nbsp;of&nbsp;literal&nbsp;codes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6013859">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6013868">error</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6013876">//&nbsp;The&nbsp;first&nbsp;1&lt;&lt;litWidth&nbsp;codes&nbsp;are&nbsp;literal&nbsp;codes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6013927">//&nbsp;The&nbsp;next&nbsp;two&nbsp;codes&nbsp;mean&nbsp;clear&nbsp;and&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6013970">//&nbsp;Other&nbsp;valid&nbsp;codes&nbsp;are&nbsp;in&nbsp;the&nbsp;range&nbsp;[lo,&nbsp;hi]&nbsp;where&nbsp;lo&nbsp;:=&nbsp;clear&nbsp;+&nbsp;2,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6014041">//&nbsp;with&nbsp;the&nbsp;upper&nbsp;bound&nbsp;incrementing&nbsp;on&nbsp;each&nbsp;code&nbsp;seen.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6014098">//&nbsp;overflow&nbsp;is&nbsp;the&nbsp;code&nbsp;at&nbsp;which&nbsp;hi&nbsp;overflows&nbsp;the&nbsp;code&nbsp;width.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6014161">//&nbsp;last&nbsp;is&nbsp;the&nbsp;most&nbsp;recently&nbsp;seen&nbsp;code,&nbsp;or&nbsp;decoderInvalidCode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6014225">clear</span><span class="op" id="6014230">,</span>&nbsp;<span class="ident" id="6014232">eof</span><span class="op" id="6014235">,</span>&nbsp;<span class="ident" id="6014237">hi</span><span class="op" id="6014239">,</span>&nbsp;<span class="ident" id="6014241">overflow</span><span class="op" id="6014249">,</span>&nbsp;<span class="ident" id="6014251">last</span>&nbsp;<span class="builtintype" id="6014256">uint16</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6014265">//&nbsp;Each&nbsp;code&nbsp;c&nbsp;in&nbsp;[lo,&nbsp;hi]&nbsp;expands&nbsp;to&nbsp;two&nbsp;or&nbsp;more&nbsp;bytes.&nbsp;For&nbsp;c&nbsp;!=&nbsp;hi:</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6014336">//&nbsp;&nbsp;&nbsp;suffix[c]&nbsp;is&nbsp;the&nbsp;last&nbsp;of&nbsp;these&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6014380">//&nbsp;&nbsp;&nbsp;prefix[c]&nbsp;is&nbsp;the&nbsp;code&nbsp;for&nbsp;all&nbsp;but&nbsp;the&nbsp;last&nbsp;byte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6014435">//&nbsp;&nbsp;&nbsp;This&nbsp;code&nbsp;can&nbsp;either&nbsp;be&nbsp;a&nbsp;literal&nbsp;code&nbsp;or&nbsp;another&nbsp;code&nbsp;in&nbsp;[lo,&nbsp;c).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6014508">//&nbsp;The&nbsp;c&nbsp;==&nbsp;hi&nbsp;case&nbsp;is&nbsp;a&nbsp;special&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6014548">suffix</span>&nbsp;<span class="op" id="6014555">[</span><span class="num" id="6014556">1</span>&nbsp;<span class="op" id="6014558">&lt;&lt;</span>&nbsp;<span class="ident" id="6014561">maxWidth</span><span class="op" id="6014569">]</span><span class="builtintype" id="6014570">uint8</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6014577">prefix</span>&nbsp;<span class="op" id="6014584">[</span><span class="num" id="6014585">1</span>&nbsp;<span class="op" id="6014587">&lt;&lt;</span>&nbsp;<span class="ident" id="6014590">maxWidth</span><span class="op" id="6014598">]</span><span class="builtintype" id="6014599">uint16</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6014608">//&nbsp;output&nbsp;is&nbsp;the&nbsp;temporary&nbsp;output&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6014651">//&nbsp;Literal&nbsp;codes&nbsp;are&nbsp;accumulated&nbsp;from&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6014715">//&nbsp;Non-literal&nbsp;codes&nbsp;decode&nbsp;to&nbsp;a&nbsp;sequence&nbsp;of&nbsp;suffixes&nbsp;that&nbsp;are&nbsp;first</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6014785">//&nbsp;written&nbsp;right-to-left&nbsp;from&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;buffer&nbsp;before&nbsp;being&nbsp;copied</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6014858">//&nbsp;to&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6014890">//&nbsp;It&nbsp;is&nbsp;flushed&nbsp;when&nbsp;it&nbsp;contains&nbsp;&gt;=&nbsp;1&lt;&lt;maxWidth&nbsp;bytes,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6014947">//&nbsp;so&nbsp;that&nbsp;there&nbsp;is&nbsp;always&nbsp;room&nbsp;to&nbsp;decode&nbsp;an&nbsp;entire&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6015006">output</span>&nbsp;<span class="op" id="6015013">[</span><span class="num" id="6015014">2</span>&nbsp;<span class="op" id="6015016">*</span>&nbsp;<span class="num" id="6015018">1</span>&nbsp;<span class="op" id="6015020">&lt;&lt;</span>&nbsp;<span class="ident" id="6015023">maxWidth</span><span class="op" id="6015031">]</span><span class="builtintype" id="6015032">byte</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6015038">o</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6015045">int</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6015052">//&nbsp;write&nbsp;index&nbsp;into&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6015080">toRead</span>&nbsp;<span class="op" id="6015087">[</span><span class="op" id="6015088">]</span><span class="builtintype" id="6015089">byte</span>&nbsp;<span class="comment" id="6015094">//&nbsp;bytes&nbsp;to&nbsp;return&nbsp;from&nbsp;Read</span><br>
<span class="lineno"></span><span class="op" id="6015123">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6015126">//&nbsp;readLSB&nbsp;returns&nbsp;the&nbsp;next&nbsp;code&nbsp;for&nbsp;&#34;Least&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno">85</span><span class="keyword" id="6015200">func</span>&nbsp;<span class="op" id="6015205">(</span><span class="ident" id="6015206">d</span>&nbsp;<span class="op" id="6015208">*</span><span class="ident" id="6015209">decoder</span><span class="op" id="6015216">)</span>&nbsp;<span class="ident" id="6015218">readLSB</span><span class="op" id="6015225">(</span><span class="op" id="6015226">)</span>&nbsp;<span class="op" id="6015228">(</span><span class="builtintype" id="6015229">uint16</span><span class="op" id="6015235">,</span>&nbsp;<span class="builtintype" id="6015237">error</span><span class="op" id="6015242">)</span>&nbsp;<span class="op" id="6015244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6015247">for</span>&nbsp;<span class="ident" id="6015251">d</span><span class="op" id="6015252">.</span><span class="ident" id="6015253">nBits</span>&nbsp;<span class="op" id="6015259">&lt;</span>&nbsp;<span class="ident" id="6015261">d</span><span class="op" id="6015262">.</span><span class="ident" id="6015263">width</span>&nbsp;<span class="op" id="6015269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6015273">x</span><span class="op" id="6015274">,</span>&nbsp;<span class="ident" id="6015276">err</span>&nbsp;<span class="op" id="6015280">:=</span>&nbsp;<span class="ident" id="6015283">d</span><span class="op" id="6015284">.</span><span class="ident" id="6015285">r</span><span class="op" id="6015286">.</span><span class="ident" id="6015287">ReadByte</span><span class="op" id="6015295">(</span><span class="op" id="6015296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6015300">if</span>&nbsp;<span class="ident" id="6015303">err</span>&nbsp;<span class="op" id="6015307">!=</span>&nbsp;<span class="ident" id="6015310">nil</span>&nbsp;<span class="op" id="6015314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6015319">return</span>&nbsp;<span class="num" id="6015326">0</span><span class="op" id="6015327">,</span>&nbsp;<span class="ident" id="6015329">err</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6015335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6015339">d</span><span class="op" id="6015340">.</span><span class="ident" id="6015341">bits</span>&nbsp;<span class="op" id="6015346">|=</span>&nbsp;<span class="builtintype" id="6015349">uint32</span><span class="op" id="6015355">(</span><span class="ident" id="6015356">x</span><span class="op" id="6015357">)</span>&nbsp;<span class="op" id="6015359">&lt;&lt;</span>&nbsp;<span class="ident" id="6015362">d</span><span class="op" id="6015363">.</span><span class="ident" id="6015364">nBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6015372">d</span><span class="op" id="6015373">.</span><span class="ident" id="6015374">nBits</span>&nbsp;<span class="op" id="6015380">+=</span>&nbsp;<span class="num" id="6015383">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6015386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6015389">code</span>&nbsp;<span class="op" id="6015394">:=</span>&nbsp;<span class="builtintype" id="6015397">uint16</span><span class="op" id="6015403">(</span><span class="ident" id="6015404">d</span><span class="op" id="6015405">.</span><span class="ident" id="6015406">bits</span>&nbsp;<span class="op" id="6015411">&amp;</span>&nbsp;<span class="op" id="6015413">(</span><span class="num" id="6015414">1</span><span class="op" id="6015415">&lt;&lt;</span><span class="ident" id="6015417">d</span><span class="op" id="6015418">.</span><span class="ident" id="6015419">width</span>&nbsp;<span class="op" id="6015425">-</span>&nbsp;<span class="num" id="6015427">1</span><span class="op" id="6015428">)</span><span class="op" id="6015429">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6015432">d</span><span class="op" id="6015433">.</span><span class="ident" id="6015434">bits</span>&nbsp;<span class="op" id="6015439">&gt;&gt;=</span>&nbsp;<span class="ident" id="6015443">d</span><span class="op" id="6015444">.</span><span class="ident" id="6015445">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6015452">d</span><span class="op" id="6015453">.</span><span class="ident" id="6015454">nBits</span>&nbsp;<span class="op" id="6015460">-=</span>&nbsp;<span class="ident" id="6015463">d</span><span class="op" id="6015464">.</span><span class="ident" id="6015465">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6015472">return</span>&nbsp;<span class="ident" id="6015479">code</span><span class="op" id="6015483">,</span>&nbsp;<span class="ident" id="6015485">nil</span><br>
<span class="lineno"></span><span class="op" id="6015489">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="comment" id="6015492">//&nbsp;readMSB&nbsp;returns&nbsp;the&nbsp;next&nbsp;code&nbsp;for&nbsp;&#34;Most&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="6015565">func</span>&nbsp;<span class="op" id="6015570">(</span><span class="ident" id="6015571">d</span>&nbsp;<span class="op" id="6015573">*</span><span class="ident" id="6015574">decoder</span><span class="op" id="6015581">)</span>&nbsp;<span class="ident" id="6015583">readMSB</span><span class="op" id="6015590">(</span><span class="op" id="6015591">)</span>&nbsp;<span class="op" id="6015593">(</span><span class="builtintype" id="6015594">uint16</span><span class="op" id="6015600">,</span>&nbsp;<span class="builtintype" id="6015602">error</span><span class="op" id="6015607">)</span>&nbsp;<span class="op" id="6015609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6015612">for</span>&nbsp;<span class="ident" id="6015616">d</span><span class="op" id="6015617">.</span><span class="ident" id="6015618">nBits</span>&nbsp;<span class="op" id="6015624">&lt;</span>&nbsp;<span class="ident" id="6015626">d</span><span class="op" id="6015627">.</span><span class="ident" id="6015628">width</span>&nbsp;<span class="op" id="6015634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6015638">x</span><span class="op" id="6015639">,</span>&nbsp;<span class="ident" id="6015641">err</span>&nbsp;<span class="op" id="6015645">:=</span>&nbsp;<span class="ident" id="6015648">d</span><span class="op" id="6015649">.</span><span class="ident" id="6015650">r</span><span class="op" id="6015651">.</span><span class="ident" id="6015652">ReadByte</span><span class="op" id="6015660">(</span><span class="op" id="6015661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6015665">if</span>&nbsp;<span class="ident" id="6015668">err</span>&nbsp;<span class="op" id="6015672">!=</span>&nbsp;<span class="ident" id="6015675">nil</span>&nbsp;<span class="op" id="6015679">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6015684">return</span>&nbsp;<span class="num" id="6015691">0</span><span class="op" id="6015692">,</span>&nbsp;<span class="ident" id="6015694">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6015700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6015704">d</span><span class="op" id="6015705">.</span><span class="ident" id="6015706">bits</span>&nbsp;<span class="op" id="6015711">|=</span>&nbsp;<span class="builtintype" id="6015714">uint32</span><span class="op" id="6015720">(</span><span class="ident" id="6015721">x</span><span class="op" id="6015722">)</span>&nbsp;<span class="op" id="6015724">&lt;&lt;</span>&nbsp;<span class="op" id="6015727">(</span><span class="num" id="6015728">24</span>&nbsp;<span class="op" id="6015731">-</span>&nbsp;<span class="ident" id="6015733">d</span><span class="op" id="6015734">.</span><span class="ident" id="6015735">nBits</span><span class="op" id="6015740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6015744">d</span><span class="op" id="6015745">.</span><span class="ident" id="6015746">nBits</span>&nbsp;<span class="op" id="6015752">+=</span>&nbsp;<span class="num" id="6015755">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6015758">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6015761">code</span>&nbsp;<span class="op" id="6015766">:=</span>&nbsp;<span class="builtintype" id="6015769">uint16</span><span class="op" id="6015775">(</span><span class="ident" id="6015776">d</span><span class="op" id="6015777">.</span><span class="ident" id="6015778">bits</span>&nbsp;<span class="op" id="6015783">&gt;&gt;</span>&nbsp;<span class="op" id="6015786">(</span><span class="num" id="6015787">32</span>&nbsp;<span class="op" id="6015790">-</span>&nbsp;<span class="ident" id="6015792">d</span><span class="op" id="6015793">.</span><span class="ident" id="6015794">width</span><span class="op" id="6015799">)</span><span class="op" id="6015800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6015803">d</span><span class="op" id="6015804">.</span><span class="ident" id="6015805">bits</span>&nbsp;<span class="op" id="6015810">&lt;&lt;=</span>&nbsp;<span class="ident" id="6015814">d</span><span class="op" id="6015815">.</span><span class="ident" id="6015816">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6015823">d</span><span class="op" id="6015824">.</span><span class="ident" id="6015825">nBits</span>&nbsp;<span class="op" id="6015831">-=</span>&nbsp;<span class="ident" id="6015834">d</span><span class="op" id="6015835">.</span><span class="ident" id="6015836">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6015843">return</span>&nbsp;<span class="ident" id="6015850">code</span><span class="op" id="6015854">,</span>&nbsp;<span class="ident" id="6015856">nil</span><br>
<span class="lineno"></span><span class="op" id="6015860">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="keyword" id="6015863">func</span>&nbsp;<span class="op" id="6015868">(</span><span class="ident" id="6015869">d</span>&nbsp;<span class="op" id="6015871">*</span><span class="ident" id="6015872">decoder</span><span class="op" id="6015879">)</span>&nbsp;<span class="ident" id="6015881">Read</span><span class="op" id="6015885">(</span><span class="ident" id="6015886">b</span>&nbsp;<span class="op" id="6015888">[</span><span class="op" id="6015889">]</span><span class="builtintype" id="6015890">byte</span><span class="op" id="6015894">)</span>&nbsp;<span class="op" id="6015896">(</span><span class="builtintype" id="6015897">int</span><span class="op" id="6015900">,</span>&nbsp;<span class="builtintype" id="6015902">error</span><span class="op" id="6015907">)</span>&nbsp;<span class="op" id="6015909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6015912">for</span>&nbsp;<span class="op" id="6015916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6015920">if</span>&nbsp;<span class="builtinfunc" id="6015923">len</span><span class="op" id="6015926">(</span><span class="ident" id="6015927">d</span><span class="op" id="6015928">.</span><span class="ident" id="6015929">toRead</span><span class="op" id="6015935">)</span>&nbsp;<span class="op" id="6015937">&gt;</span>&nbsp;<span class="num" id="6015939">0</span>&nbsp;<span class="op" id="6015941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6015946">n</span>&nbsp;<span class="op" id="6015948">:=</span>&nbsp;<span class="builtinfunc" id="6015951">copy</span><span class="op" id="6015955">(</span><span class="ident" id="6015956">b</span><span class="op" id="6015957">,</span>&nbsp;<span class="ident" id="6015959">d</span><span class="op" id="6015960">.</span><span class="ident" id="6015961">toRead</span><span class="op" id="6015967">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6015972">d</span><span class="op" id="6015973">.</span><span class="ident" id="6015974">toRead</span>&nbsp;<span class="op" id="6015981">=</span>&nbsp;<span class="ident" id="6015983">d</span><span class="op" id="6015984">.</span><span class="ident" id="6015985">toRead</span><span class="op" id="6015991">[</span><span class="ident" id="6015992">n</span><span class="op" id="6015993">:</span><span class="op" id="6015994">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6015999">return</span>&nbsp;<span class="ident" id="6016006">n</span><span class="op" id="6016007">,</span>&nbsp;<span class="ident" id="6016009">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6016015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6016019">if</span>&nbsp;<span class="ident" id="6016022">d</span><span class="op" id="6016023">.</span><span class="ident" id="6016024">err</span>&nbsp;<span class="op" id="6016028">!=</span>&nbsp;<span class="ident" id="6016031">nil</span>&nbsp;<span class="op" id="6016035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6016040">return</span>&nbsp;<span class="num" id="6016047">0</span><span class="op" id="6016048">,</span>&nbsp;<span class="ident" id="6016050">d</span><span class="op" id="6016051">.</span><span class="ident" id="6016052">err</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6016058">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6016062">d</span><span class="op" id="6016063">.</span><span class="ident" id="6016064">decode</span><span class="op" id="6016070">(</span><span class="op" id="6016071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6016074">}</span><br>
<span class="lineno"></span><span class="op" id="6016076">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="comment" id="6016079">//&nbsp;decode&nbsp;decompresses&nbsp;bytes&nbsp;from&nbsp;r&nbsp;and&nbsp;leaves&nbsp;them&nbsp;in&nbsp;d.toRead.</span><br>
<span class="lineno"></span><span class="comment" id="6016144">//&nbsp;read&nbsp;specifies&nbsp;how&nbsp;to&nbsp;decode&nbsp;bytes&nbsp;into&nbsp;codes.</span><br>
<span class="lineno"></span><span class="comment" id="6016194">//&nbsp;litWidth&nbsp;is&nbsp;the&nbsp;width&nbsp;in&nbsp;bits&nbsp;of&nbsp;literal&nbsp;codes.</span><br>
<span class="lineno"></span><span class="keyword" id="6016245">func</span>&nbsp;<span class="op" id="6016250">(</span><span class="ident" id="6016251">d</span>&nbsp;<span class="op" id="6016253">*</span><span class="ident" id="6016254">decoder</span><span class="op" id="6016261">)</span>&nbsp;<span class="ident" id="6016263">decode</span><span class="op" id="6016269">(</span><span class="op" id="6016270">)</span>&nbsp;<span class="op" id="6016272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6016275">//&nbsp;Loop&nbsp;over&nbsp;the&nbsp;code&nbsp;stream,&nbsp;converting&nbsp;codes&nbsp;into&nbsp;decompressed&nbsp;bytes.</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6016348">for</span>&nbsp;<span class="op" id="6016352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6016356">code</span><span class="op" id="6016360">,</span>&nbsp;<span class="ident" id="6016362">err</span>&nbsp;<span class="op" id="6016366">:=</span>&nbsp;<span class="ident" id="6016369">d</span><span class="op" id="6016370">.</span><span class="ident" id="6016371">read</span><span class="op" id="6016375">(</span><span class="ident" id="6016376">d</span><span class="op" id="6016377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6016381">if</span>&nbsp;<span class="ident" id="6016384">err</span>&nbsp;<span class="op" id="6016388">!=</span>&nbsp;<span class="ident" id="6016391">nil</span>&nbsp;<span class="op" id="6016395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6016400">if</span>&nbsp;<span class="ident" id="6016403">err</span>&nbsp;<span class="op" id="6016407">==</span>&nbsp;<span class="ident" id="6016410">io</span><span class="op" id="6016412">.</span><span class="ident" id="6016413">EOF</span>&nbsp;<span class="op" id="6016417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6016423">err</span>&nbsp;<span class="op" id="6016427">=</span>&nbsp;<span class="ident" id="6016429">io</span><span class="op" id="6016431">.</span><span class="ident" id="6016432">ErrUnexpectedEOF</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6016452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6016457">d</span><span class="op" id="6016458">.</span><span class="ident" id="6016459">err</span>&nbsp;<span class="op" id="6016463">=</span>&nbsp;<span class="ident" id="6016465">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6016472">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6016481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6016485">switch</span>&nbsp;<span class="op" id="6016492">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6016496">case</span>&nbsp;<span class="ident" id="6016501">code</span>&nbsp;<span class="op" id="6016506">&lt;</span>&nbsp;<span class="ident" id="6016508">d</span><span class="op" id="6016509">.</span><span class="ident" id="6016510">clear</span><span class="op" id="6016515">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6016520">//&nbsp;We&nbsp;have&nbsp;a&nbsp;literal&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6016550">d</span><span class="op" id="6016551">.</span><span class="ident" id="6016552">output</span><span class="op" id="6016558">[</span><span class="ident" id="6016559">d</span><span class="op" id="6016560">.</span><span class="ident" id="6016561">o</span><span class="op" id="6016562">]</span>&nbsp;<span class="op" id="6016564">=</span>&nbsp;<span class="builtintype" id="6016566">uint8</span><span class="op" id="6016571">(</span><span class="ident" id="6016572">code</span><span class="op" id="6016576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6016581">d</span><span class="op" id="6016582">.</span><span class="ident" id="6016583">o</span><span class="op" id="6016584">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6016590">if</span>&nbsp;<span class="ident" id="6016593">d</span><span class="op" id="6016594">.</span><span class="ident" id="6016595">last</span>&nbsp;<span class="op" id="6016600">!=</span>&nbsp;<span class="ident" id="6016603">decoderInvalidCode</span>&nbsp;<span class="op" id="6016622">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6016628">//&nbsp;Save&nbsp;what&nbsp;the&nbsp;hi&nbsp;code&nbsp;expands&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6016669">d</span><span class="op" id="6016670">.</span><span class="ident" id="6016671">suffix</span><span class="op" id="6016677">[</span><span class="ident" id="6016678">d</span><span class="op" id="6016679">.</span><span class="ident" id="6016680">hi</span><span class="op" id="6016682">]</span>&nbsp;<span class="op" id="6016684">=</span>&nbsp;<span class="builtintype" id="6016686">uint8</span><span class="op" id="6016691">(</span><span class="ident" id="6016692">code</span><span class="op" id="6016696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6016702">d</span><span class="op" id="6016703">.</span><span class="ident" id="6016704">prefix</span><span class="op" id="6016710">[</span><span class="ident" id="6016711">d</span><span class="op" id="6016712">.</span><span class="ident" id="6016713">hi</span><span class="op" id="6016715">]</span>&nbsp;<span class="op" id="6016717">=</span>&nbsp;<span class="ident" id="6016719">d</span><span class="op" id="6016720">.</span><span class="ident" id="6016721">last</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6016729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6016733">case</span>&nbsp;<span class="ident" id="6016738">code</span>&nbsp;<span class="op" id="6016743">==</span>&nbsp;<span class="ident" id="6016746">d</span><span class="op" id="6016747">.</span><span class="ident" id="6016748">clear</span><span class="op" id="6016753">:</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6016758">d</span><span class="op" id="6016759">.</span><span class="ident" id="6016760">width</span>&nbsp;<span class="op" id="6016766">=</span>&nbsp;<span class="num" id="6016768">1</span>&nbsp;<span class="op" id="6016770">+</span>&nbsp;<span class="builtintype" id="6016772">uint</span><span class="op" id="6016776">(</span><span class="ident" id="6016777">d</span><span class="op" id="6016778">.</span><span class="ident" id="6016779">litWidth</span><span class="op" id="6016787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6016792">d</span><span class="op" id="6016793">.</span><span class="ident" id="6016794">hi</span>&nbsp;<span class="op" id="6016797">=</span>&nbsp;<span class="ident" id="6016799">d</span><span class="op" id="6016800">.</span><span class="ident" id="6016801">eof</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6016808">d</span><span class="op" id="6016809">.</span><span class="ident" id="6016810">overflow</span>&nbsp;<span class="op" id="6016819">=</span>&nbsp;<span class="num" id="6016821">1</span>&nbsp;<span class="op" id="6016823">&lt;&lt;</span>&nbsp;<span class="ident" id="6016826">d</span><span class="op" id="6016827">.</span><span class="ident" id="6016828">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6016837">d</span><span class="op" id="6016838">.</span><span class="ident" id="6016839">last</span>&nbsp;<span class="op" id="6016844">=</span>&nbsp;<span class="ident" id="6016846">decoderInvalidCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6016868">continue</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6016879">case</span>&nbsp;<span class="ident" id="6016884">code</span>&nbsp;<span class="op" id="6016889">==</span>&nbsp;<span class="ident" id="6016892">d</span><span class="op" id="6016893">.</span><span class="ident" id="6016894">eof</span><span class="op" id="6016897">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6016902">d</span><span class="op" id="6016903">.</span><span class="ident" id="6016904">flush</span><span class="op" id="6016909">(</span><span class="op" id="6016910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6016915">d</span><span class="op" id="6016916">.</span><span class="ident" id="6016917">err</span>&nbsp;<span class="op" id="6016921">=</span>&nbsp;<span class="ident" id="6016923">io</span><span class="op" id="6016925">.</span><span class="ident" id="6016926">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6016933">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6016942">case</span>&nbsp;<span class="ident" id="6016947">code</span>&nbsp;<span class="op" id="6016952">&lt;=</span>&nbsp;<span class="ident" id="6016955">d</span><span class="op" id="6016956">.</span><span class="ident" id="6016957">hi</span><span class="op" id="6016959">:</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6016964">c</span><span class="op" id="6016965">,</span>&nbsp;<span class="ident" id="6016967">i</span>&nbsp;<span class="op" id="6016969">:=</span>&nbsp;<span class="ident" id="6016972">code</span><span class="op" id="6016976">,</span>&nbsp;<span class="builtinfunc" id="6016978">len</span><span class="op" id="6016981">(</span><span class="ident" id="6016982">d</span><span class="op" id="6016983">.</span><span class="ident" id="6016984">output</span><span class="op" id="6016990">)</span><span class="op" id="6016991">-</span><span class="num" id="6016992">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6016997">if</span>&nbsp;<span class="ident" id="6017000">code</span>&nbsp;<span class="op" id="6017005">==</span>&nbsp;<span class="ident" id="6017008">d</span><span class="op" id="6017009">.</span><span class="ident" id="6017010">hi</span>&nbsp;<span class="op" id="6017013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6017019">//&nbsp;code&nbsp;==&nbsp;hi&nbsp;is&nbsp;a&nbsp;special&nbsp;case&nbsp;which&nbsp;expands&nbsp;to&nbsp;the&nbsp;last&nbsp;expansion</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6017091">//&nbsp;followed&nbsp;by&nbsp;the&nbsp;head&nbsp;of&nbsp;the&nbsp;last&nbsp;expansion.&nbsp;To&nbsp;find&nbsp;the&nbsp;head,&nbsp;we&nbsp;walk</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6017168">//&nbsp;the&nbsp;prefix&nbsp;chain&nbsp;until&nbsp;we&nbsp;find&nbsp;a&nbsp;literal&nbsp;code.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017222">c</span>&nbsp;<span class="op" id="6017224">=</span>&nbsp;<span class="ident" id="6017226">d</span><span class="op" id="6017227">.</span><span class="ident" id="6017228">last</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6017237">for</span>&nbsp;<span class="ident" id="6017241">c</span>&nbsp;<span class="op" id="6017243">&gt;=</span>&nbsp;<span class="ident" id="6017246">d</span><span class="op" id="6017247">.</span><span class="ident" id="6017248">clear</span>&nbsp;<span class="op" id="6017254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017261">c</span>&nbsp;<span class="op" id="6017263">=</span>&nbsp;<span class="ident" id="6017265">d</span><span class="op" id="6017266">.</span><span class="ident" id="6017267">prefix</span><span class="op" id="6017273">[</span><span class="ident" id="6017274">c</span><span class="op" id="6017275">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6017281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017287">d</span><span class="op" id="6017288">.</span><span class="ident" id="6017289">output</span><span class="op" id="6017295">[</span><span class="ident" id="6017296">i</span><span class="op" id="6017297">]</span>&nbsp;<span class="op" id="6017299">=</span>&nbsp;<span class="builtintype" id="6017301">uint8</span><span class="op" id="6017306">(</span><span class="ident" id="6017307">c</span><span class="op" id="6017308">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017314">i</span><span class="op" id="6017315">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017322">c</span>&nbsp;<span class="op" id="6017324">=</span>&nbsp;<span class="ident" id="6017326">d</span><span class="op" id="6017327">.</span><span class="ident" id="6017328">last</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6017336">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6017341">//&nbsp;Copy&nbsp;the&nbsp;suffix&nbsp;chain&nbsp;into&nbsp;output&nbsp;and&nbsp;then&nbsp;write&nbsp;that&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6017407">for</span>&nbsp;<span class="ident" id="6017411">c</span>&nbsp;<span class="op" id="6017413">&gt;=</span>&nbsp;<span class="ident" id="6017416">d</span><span class="op" id="6017417">.</span><span class="ident" id="6017418">clear</span>&nbsp;<span class="op" id="6017424">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017430">d</span><span class="op" id="6017431">.</span><span class="ident" id="6017432">output</span><span class="op" id="6017438">[</span><span class="ident" id="6017439">i</span><span class="op" id="6017440">]</span>&nbsp;<span class="op" id="6017442">=</span>&nbsp;<span class="ident" id="6017444">d</span><span class="op" id="6017445">.</span><span class="ident" id="6017446">suffix</span><span class="op" id="6017452">[</span><span class="ident" id="6017453">c</span><span class="op" id="6017454">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017460">i</span><span class="op" id="6017461">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017468">c</span>&nbsp;<span class="op" id="6017470">=</span>&nbsp;<span class="ident" id="6017472">d</span><span class="op" id="6017473">.</span><span class="ident" id="6017474">prefix</span><span class="op" id="6017480">[</span><span class="ident" id="6017481">c</span><span class="op" id="6017482">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6017487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017492">d</span><span class="op" id="6017493">.</span><span class="ident" id="6017494">output</span><span class="op" id="6017500">[</span><span class="ident" id="6017501">i</span><span class="op" id="6017502">]</span>&nbsp;<span class="op" id="6017504">=</span>&nbsp;<span class="builtintype" id="6017506">uint8</span><span class="op" id="6017511">(</span><span class="ident" id="6017512">c</span><span class="op" id="6017513">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017518">d</span><span class="op" id="6017519">.</span><span class="ident" id="6017520">o</span>&nbsp;<span class="op" id="6017522">+=</span>&nbsp;<span class="builtinfunc" id="6017525">copy</span><span class="op" id="6017529">(</span><span class="ident" id="6017530">d</span><span class="op" id="6017531">.</span><span class="ident" id="6017532">output</span><span class="op" id="6017538">[</span><span class="ident" id="6017539">d</span><span class="op" id="6017540">.</span><span class="ident" id="6017541">o</span><span class="op" id="6017542">:</span><span class="op" id="6017543">]</span><span class="op" id="6017544">,</span>&nbsp;<span class="ident" id="6017546">d</span><span class="op" id="6017547">.</span><span class="ident" id="6017548">output</span><span class="op" id="6017554">[</span><span class="ident" id="6017555">i</span><span class="op" id="6017556">:</span><span class="op" id="6017557">]</span><span class="op" id="6017558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6017563">if</span>&nbsp;<span class="ident" id="6017566">d</span><span class="op" id="6017567">.</span><span class="ident" id="6017568">last</span>&nbsp;<span class="op" id="6017573">!=</span>&nbsp;<span class="ident" id="6017576">decoderInvalidCode</span>&nbsp;<span class="op" id="6017595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6017601">//&nbsp;Save&nbsp;what&nbsp;the&nbsp;hi&nbsp;code&nbsp;expands&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017642">d</span><span class="op" id="6017643">.</span><span class="ident" id="6017644">suffix</span><span class="op" id="6017650">[</span><span class="ident" id="6017651">d</span><span class="op" id="6017652">.</span><span class="ident" id="6017653">hi</span><span class="op" id="6017655">]</span>&nbsp;<span class="op" id="6017657">=</span>&nbsp;<span class="builtintype" id="6017659">uint8</span><span class="op" id="6017664">(</span><span class="ident" id="6017665">c</span><span class="op" id="6017666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017672">d</span><span class="op" id="6017673">.</span><span class="ident" id="6017674">prefix</span><span class="op" id="6017680">[</span><span class="ident" id="6017681">d</span><span class="op" id="6017682">.</span><span class="ident" id="6017683">hi</span><span class="op" id="6017685">]</span>&nbsp;<span class="op" id="6017687">=</span>&nbsp;<span class="ident" id="6017689">d</span><span class="op" id="6017690">.</span><span class="ident" id="6017691">last</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6017699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6017703">default</span><span class="op" id="6017710">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017715">d</span><span class="op" id="6017716">.</span><span class="ident" id="6017717">err</span>&nbsp;<span class="op" id="6017721">=</span>&nbsp;<span class="ident" id="6017723">errors</span><span class="op" id="6017729">.</span><span class="ident" id="6017730">New</span><span class="op" id="6017733">(</span><span class="string" id="6017734">&#34;lzw:&nbsp;invalid&nbsp;code&#34;</span><span class="op" id="6017753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6017758">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6017767">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017771">d</span><span class="op" id="6017772">.</span><span class="ident" id="6017773">last</span><span class="op" id="6017777">,</span>&nbsp;<span class="ident" id="6017779">d</span><span class="op" id="6017780">.</span><span class="ident" id="6017781">hi</span>&nbsp;<span class="op" id="6017784">=</span>&nbsp;<span class="ident" id="6017786">code</span><span class="op" id="6017790">,</span>&nbsp;<span class="ident" id="6017792">d</span><span class="op" id="6017793">.</span><span class="ident" id="6017794">hi</span><span class="op" id="6017796">+</span><span class="num" id="6017797">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6017801">if</span>&nbsp;<span class="ident" id="6017804">d</span><span class="op" id="6017805">.</span><span class="ident" id="6017806">hi</span>&nbsp;<span class="op" id="6017809">&gt;=</span>&nbsp;<span class="ident" id="6017812">d</span><span class="op" id="6017813">.</span><span class="ident" id="6017814">overflow</span>&nbsp;<span class="op" id="6017823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6017828">if</span>&nbsp;<span class="ident" id="6017831">d</span><span class="op" id="6017832">.</span><span class="ident" id="6017833">width</span>&nbsp;<span class="op" id="6017839">==</span>&nbsp;<span class="ident" id="6017842">maxWidth</span>&nbsp;<span class="op" id="6017851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017857">d</span><span class="op" id="6017858">.</span><span class="ident" id="6017859">last</span>&nbsp;<span class="op" id="6017864">=</span>&nbsp;<span class="ident" id="6017866">decoderInvalidCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6017888">}</span>&nbsp;<span class="keyword" id="6017890">else</span>&nbsp;<span class="op" id="6017895">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017901">d</span><span class="op" id="6017902">.</span><span class="ident" id="6017903">width</span><span class="op" id="6017908">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017915">d</span><span class="op" id="6017916">.</span><span class="ident" id="6017917">overflow</span>&nbsp;<span class="op" id="6017926">&lt;&lt;=</span>&nbsp;<span class="num" id="6017930">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6017935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6017939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6017943">if</span>&nbsp;<span class="ident" id="6017946">d</span><span class="op" id="6017947">.</span><span class="ident" id="6017948">o</span>&nbsp;<span class="op" id="6017950">&gt;=</span>&nbsp;<span class="ident" id="6017953">flushBuffer</span>&nbsp;<span class="op" id="6017965">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017970">d</span><span class="op" id="6017971">.</span><span class="ident" id="6017972">flush</span><span class="op" id="6017977">(</span><span class="op" id="6017978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6017983">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6017992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6017995">}</span><br>
<span class="lineno"></span><span class="op" id="6017997">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span><span class="keyword" id="6018000">func</span>&nbsp;<span class="op" id="6018005">(</span><span class="ident" id="6018006">d</span>&nbsp;<span class="op" id="6018008">*</span><span class="ident" id="6018009">decoder</span><span class="op" id="6018016">)</span>&nbsp;<span class="ident" id="6018018">flush</span><span class="op" id="6018023">(</span><span class="op" id="6018024">)</span>&nbsp;<span class="op" id="6018026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6018029">d</span><span class="op" id="6018030">.</span><span class="ident" id="6018031">toRead</span>&nbsp;<span class="op" id="6018038">=</span>&nbsp;<span class="ident" id="6018040">d</span><span class="op" id="6018041">.</span><span class="ident" id="6018042">output</span><span class="op" id="6018048">[</span><span class="op" id="6018049">:</span><span class="ident" id="6018050">d</span><span class="op" id="6018051">.</span><span class="ident" id="6018052">o</span><span class="op" id="6018053">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6018056">d</span><span class="op" id="6018057">.</span><span class="ident" id="6018058">o</span>&nbsp;<span class="op" id="6018060">=</span>&nbsp;<span class="num" id="6018062">0</span><br>
<span class="lineno"></span><span class="op" id="6018064">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="6018067">var</span>&nbsp;<span class="ident" id="6018071">errClosed</span>&nbsp;<span class="op" id="6018081">=</span>&nbsp;<span class="ident" id="6018083">errors</span><span class="op" id="6018089">.</span><span class="ident" id="6018090">New</span><span class="op" id="6018093">(</span><span class="string" id="6018094">&#34;compress/lzw:&nbsp;reader/writer&nbsp;is&nbsp;closed&#34;</span><span class="op" id="6018133">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6018136">func</span>&nbsp;<span class="op" id="6018141">(</span><span class="ident" id="6018142">d</span>&nbsp;<span class="op" id="6018144">*</span><span class="ident" id="6018145">decoder</span><span class="op" id="6018152">)</span>&nbsp;<span class="ident" id="6018154">Close</span><span class="op" id="6018159">(</span><span class="op" id="6018160">)</span>&nbsp;<span class="builtintype" id="6018162">error</span>&nbsp;<span class="op" id="6018168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6018171">d</span><span class="op" id="6018172">.</span><span class="ident" id="6018173">err</span>&nbsp;<span class="op" id="6018177">=</span>&nbsp;<span class="ident" id="6018179">errClosed</span>&nbsp;<span class="comment" id="6018189">//&nbsp;in&nbsp;case&nbsp;any&nbsp;Reads&nbsp;come&nbsp;along</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6018222">return</span>&nbsp;<span class="ident" id="6018229">nil</span><br>
<span class="lineno"></span><span class="op" id="6018233">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6018236">//&nbsp;NewReader&nbsp;creates&nbsp;a&nbsp;new&nbsp;io.ReadCloser.</span><br>
<span class="lineno"></span><span class="comment" id="6018278">//&nbsp;Reads&nbsp;from&nbsp;the&nbsp;returned&nbsp;io.ReadCloser&nbsp;read&nbsp;and&nbsp;decompress&nbsp;data&nbsp;from&nbsp;r.</span><br>
<span class="lineno">225</span><span class="comment" id="6018352">//&nbsp;If&nbsp;r&nbsp;does&nbsp;not&nbsp;also&nbsp;implement&nbsp;io.ByteReader,</span><br>
<span class="lineno"></span><span class="comment" id="6018399">//&nbsp;the&nbsp;decompressor&nbsp;may&nbsp;read&nbsp;more&nbsp;data&nbsp;than&nbsp;necessary&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="comment" id="6018461">//&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;call&nbsp;Close&nbsp;on&nbsp;the&nbsp;ReadCloser&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="6018535">//&nbsp;finished&nbsp;reading.</span><br>
<span class="lineno"></span><span class="comment" id="6018556">//&nbsp;The&nbsp;number&nbsp;of&nbsp;bits&nbsp;to&nbsp;use&nbsp;for&nbsp;literal&nbsp;codes,&nbsp;litWidth,&nbsp;must&nbsp;be&nbsp;in&nbsp;the</span><br>
<span class="lineno">230</span><span class="comment" id="6018629">//&nbsp;range&nbsp;[2,8]&nbsp;and&nbsp;is&nbsp;typically&nbsp;8.</span><br>
<span class="lineno"></span><span class="keyword" id="6018664">func</span>&nbsp;<span class="ident" id="6018669">NewReader</span><span class="op" id="6018678">(</span><span class="ident" id="6018679">r</span>&nbsp;<span class="ident" id="6018681">io</span><span class="op" id="6018683">.</span><span class="ident" id="6018684">Reader</span><span class="op" id="6018690">,</span>&nbsp;<span class="ident" id="6018692">order</span>&nbsp;<span class="ident" id="6018698">Order</span><span class="op" id="6018703">,</span>&nbsp;<span class="ident" id="6018705">litWidth</span>&nbsp;<span class="builtintype" id="6018714">int</span><span class="op" id="6018717">)</span>&nbsp;<span class="ident" id="6018719">io</span><span class="op" id="6018721">.</span><span class="ident" id="6018722">ReadCloser</span>&nbsp;<span class="op" id="6018733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6018736">d</span>&nbsp;<span class="op" id="6018738">:=</span>&nbsp;<span class="builtinfunc" id="6018741">new</span><span class="op" id="6018744">(</span><span class="ident" id="6018745">decoder</span><span class="op" id="6018752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6018755">switch</span>&nbsp;<span class="ident" id="6018762">order</span>&nbsp;<span class="op" id="6018768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6018771">case</span>&nbsp;<span class="ident" id="6018776">LSB</span><span class="op" id="6018779">:</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6018783">d</span><span class="op" id="6018784">.</span><span class="ident" id="6018785">read</span>&nbsp;<span class="op" id="6018790">=</span>&nbsp;<span class="op" id="6018792">(</span><span class="op" id="6018793">*</span><span class="ident" id="6018794">decoder</span><span class="op" id="6018801">)</span><span class="op" id="6018802">.</span><span class="ident" id="6018803">readLSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6018812">case</span>&nbsp;<span class="ident" id="6018817">MSB</span><span class="op" id="6018820">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6018824">d</span><span class="op" id="6018825">.</span><span class="ident" id="6018826">read</span>&nbsp;<span class="op" id="6018831">=</span>&nbsp;<span class="op" id="6018833">(</span><span class="op" id="6018834">*</span><span class="ident" id="6018835">decoder</span><span class="op" id="6018842">)</span><span class="op" id="6018843">.</span><span class="ident" id="6018844">readMSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6018853">default</span><span class="op" id="6018860">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6018864">d</span><span class="op" id="6018865">.</span><span class="ident" id="6018866">err</span>&nbsp;<span class="op" id="6018870">=</span>&nbsp;<span class="ident" id="6018872">errors</span><span class="op" id="6018878">.</span><span class="ident" id="6018879">New</span><span class="op" id="6018882">(</span><span class="string" id="6018883">&#34;lzw:&nbsp;unknown&nbsp;order&#34;</span><span class="op" id="6018903">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6018907">return</span>&nbsp;<span class="ident" id="6018914">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6018917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6018920">if</span>&nbsp;<span class="ident" id="6018923">litWidth</span>&nbsp;<span class="op" id="6018932">&lt;</span>&nbsp;<span class="num" id="6018934">2</span>&nbsp;<span class="op" id="6018936">||</span>&nbsp;<span class="num" id="6018939">8</span>&nbsp;<span class="op" id="6018941">&lt;</span>&nbsp;<span class="ident" id="6018943">litWidth</span>&nbsp;<span class="op" id="6018952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6018956">d</span><span class="op" id="6018957">.</span><span class="ident" id="6018958">err</span>&nbsp;<span class="op" id="6018962">=</span>&nbsp;<span class="ident" id="6018964">fmt</span><span class="op" id="6018967">.</span><span class="ident" id="6018968">Errorf</span><span class="op" id="6018974">(</span><span class="string" id="6018975">&#34;lzw:&nbsp;litWidth&nbsp;%d&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="6019006">,</span>&nbsp;<span class="ident" id="6019008">litWidth</span><span class="op" id="6019016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6019020">return</span>&nbsp;<span class="ident" id="6019027">d</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6019030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6019033">if</span>&nbsp;<span class="ident" id="6019036">br</span><span class="op" id="6019038">,</span>&nbsp;<span class="ident" id="6019040">ok</span>&nbsp;<span class="op" id="6019043">:=</span>&nbsp;<span class="ident" id="6019046">r</span><span class="op" id="6019047">.</span><span class="op" id="6019048">(</span><span class="ident" id="6019049">io</span><span class="op" id="6019051">.</span><span class="ident" id="6019052">ByteReader</span><span class="op" id="6019062">)</span><span class="op" id="6019063">;</span>&nbsp;<span class="ident" id="6019065">ok</span>&nbsp;<span class="op" id="6019068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6019072">d</span><span class="op" id="6019073">.</span><span class="ident" id="6019074">r</span>&nbsp;<span class="op" id="6019076">=</span>&nbsp;<span class="ident" id="6019078">br</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6019082">}</span>&nbsp;<span class="keyword" id="6019084">else</span>&nbsp;<span class="op" id="6019089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6019093">d</span><span class="op" id="6019094">.</span><span class="ident" id="6019095">r</span>&nbsp;<span class="op" id="6019097">=</span>&nbsp;<span class="ident" id="6019099">bufio</span><span class="op" id="6019104">.</span><span class="ident" id="6019105">NewReader</span><span class="op" id="6019114">(</span><span class="ident" id="6019115">r</span><span class="op" id="6019116">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6019119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6019122">d</span><span class="op" id="6019123">.</span><span class="ident" id="6019124">litWidth</span>&nbsp;<span class="op" id="6019133">=</span>&nbsp;<span class="ident" id="6019135">litWidth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6019145">d</span><span class="op" id="6019146">.</span><span class="ident" id="6019147">width</span>&nbsp;<span class="op" id="6019153">=</span>&nbsp;<span class="num" id="6019155">1</span>&nbsp;<span class="op" id="6019157">+</span>&nbsp;<span class="builtintype" id="6019159">uint</span><span class="op" id="6019163">(</span><span class="ident" id="6019164">litWidth</span><span class="op" id="6019172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6019175">d</span><span class="op" id="6019176">.</span><span class="ident" id="6019177">clear</span>&nbsp;<span class="op" id="6019183">=</span>&nbsp;<span class="builtintype" id="6019185">uint16</span><span class="op" id="6019191">(</span><span class="num" id="6019192">1</span><span class="op" id="6019193">)</span>&nbsp;<span class="op" id="6019195">&lt;&lt;</span>&nbsp;<span class="builtintype" id="6019198">uint</span><span class="op" id="6019202">(</span><span class="ident" id="6019203">litWidth</span><span class="op" id="6019211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6019214">d</span><span class="op" id="6019215">.</span><span class="ident" id="6019216">eof</span><span class="op" id="6019219">,</span>&nbsp;<span class="ident" id="6019221">d</span><span class="op" id="6019222">.</span><span class="ident" id="6019223">hi</span>&nbsp;<span class="op" id="6019226">=</span>&nbsp;<span class="ident" id="6019228">d</span><span class="op" id="6019229">.</span><span class="ident" id="6019230">clear</span><span class="op" id="6019235">+</span><span class="num" id="6019236">1</span><span class="op" id="6019237">,</span>&nbsp;<span class="ident" id="6019239">d</span><span class="op" id="6019240">.</span><span class="ident" id="6019241">clear</span><span class="op" id="6019246">+</span><span class="num" id="6019247">1</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6019250">d</span><span class="op" id="6019251">.</span><span class="ident" id="6019252">overflow</span>&nbsp;<span class="op" id="6019261">=</span>&nbsp;<span class="builtintype" id="6019263">uint16</span><span class="op" id="6019269">(</span><span class="num" id="6019270">1</span><span class="op" id="6019271">)</span>&nbsp;<span class="op" id="6019273">&lt;&lt;</span>&nbsp;<span class="ident" id="6019276">d</span><span class="op" id="6019277">.</span><span class="ident" id="6019278">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6019285">d</span><span class="op" id="6019286">.</span><span class="ident" id="6019287">last</span>&nbsp;<span class="op" id="6019292">=</span>&nbsp;<span class="ident" id="6019294">decoderInvalidCode</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6019315">return</span>&nbsp;<span class="ident" id="6019322">d</span><br>
<span class="lineno"></span><span class="op" id="6019324">}</span>
</div>
</body>
</html>
