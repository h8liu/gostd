<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1433082">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1433137">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1433191">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1433242">//&nbsp;Package&nbsp;sync&nbsp;provides&nbsp;basic&nbsp;synchronization&nbsp;primitives&nbsp;such&nbsp;as&nbsp;mutual</span><br>
<span class="lineno"></span><span class="comment" id="1433315">//&nbsp;exclusion&nbsp;locks.&nbsp;&nbsp;Other&nbsp;than&nbsp;the&nbsp;Once&nbsp;and&nbsp;WaitGroup&nbsp;types,&nbsp;most&nbsp;are&nbsp;intended</span><br>
<span class="lineno"></span><span class="comment" id="1433395">//&nbsp;for&nbsp;use&nbsp;by&nbsp;low-level&nbsp;library&nbsp;routines.&nbsp;&nbsp;Higher-level&nbsp;synchronization&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1433470">//&nbsp;better&nbsp;done&nbsp;via&nbsp;channels&nbsp;and&nbsp;communication.</span><br>
<span class="lineno"></span><span class="comment" id="1433517">//</span><br>
<span class="lineno">10</span><span class="comment" id="1433520">//&nbsp;Values&nbsp;containing&nbsp;the&nbsp;types&nbsp;defined&nbsp;in&nbsp;this&nbsp;package&nbsp;should&nbsp;not&nbsp;be&nbsp;copied.</span><br>
<span class="lineno"></span><span class="keyword" id="1433597">package</span>&nbsp;<span class="ident" id="1433605">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1433611">import</span>&nbsp;<span class="op" id="1433618">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1433621">&#34;sync/atomic&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1433636">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1433645">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1433648">//&nbsp;A&nbsp;Mutex&nbsp;is&nbsp;a&nbsp;mutual&nbsp;exclusion&nbsp;lock.</span><br>
<span class="lineno"></span><span class="comment" id="1433687">//&nbsp;Mutexes&nbsp;can&nbsp;be&nbsp;created&nbsp;as&nbsp;part&nbsp;of&nbsp;other&nbsp;structures;</span><br>
<span class="lineno">20</span><span class="comment" id="1433742">//&nbsp;the&nbsp;zero&nbsp;value&nbsp;for&nbsp;a&nbsp;Mutex&nbsp;is&nbsp;an&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="1433794">type</span>&nbsp;<span class="ident" id="1433799">Mutex</span>&nbsp;<span class="keyword" id="1433805">struct</span>&nbsp;<span class="op" id="1433812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433815">state</span>&nbsp;<span class="builtintype" id="1433821">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433828">sema</span>&nbsp;&nbsp;<span class="builtintype" id="1433834">uint32</span><br>
<span class="lineno"></span><span class="op" id="1433841">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="comment" id="1433844">//&nbsp;A&nbsp;Locker&nbsp;represents&nbsp;an&nbsp;object&nbsp;that&nbsp;can&nbsp;be&nbsp;locked&nbsp;and&nbsp;unlocked.</span><br>
<span class="lineno"></span><span class="keyword" id="1433910">type</span>&nbsp;<span class="ident" id="1433915">Locker</span>&nbsp;<span class="keyword" id="1433922">interface</span>&nbsp;<span class="op" id="1433932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433935">Lock</span><span class="op" id="1433939">(</span><span class="op" id="1433940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433943">Unlock</span><span class="op" id="1433949">(</span><span class="op" id="1433950">)</span><br>
<span class="lineno">30</span><span class="op" id="1433952">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1433955">const</span>&nbsp;<span class="op" id="1433961">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433964">mutexLocked</span>&nbsp;<span class="op" id="1433976">=</span>&nbsp;<span class="num" id="1433978">1</span>&nbsp;<span class="op" id="1433980">&lt;&lt;</span>&nbsp;<span class="ident" id="1433983">iota</span>&nbsp;<span class="comment" id="1433988">//&nbsp;mutex&nbsp;is&nbsp;locked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434008">mutexWoken</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434020">mutexWaiterShift</span>&nbsp;<span class="op" id="1434037">=</span>&nbsp;<span class="ident" id="1434039">iota</span><br>
<span class="lineno"></span><span class="op" id="1434044">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1434047">//&nbsp;Lock&nbsp;locks&nbsp;m.</span><br>
<span class="lineno"></span><span class="comment" id="1434064">//&nbsp;If&nbsp;the&nbsp;lock&nbsp;is&nbsp;already&nbsp;in&nbsp;use,&nbsp;the&nbsp;calling&nbsp;goroutine</span><br>
<span class="lineno">40</span><span class="comment" id="1434120">//&nbsp;blocks&nbsp;until&nbsp;the&nbsp;mutex&nbsp;is&nbsp;available.</span><br>
<span class="lineno"></span><span class="keyword" id="1434160">func</span>&nbsp;<span class="op" id="1434165">(</span><span class="ident" id="1434166">m</span>&nbsp;<span class="op" id="1434168">*</span><span class="ident" id="1434169">Mutex</span><span class="op" id="1434174">)</span>&nbsp;<span class="ident" id="1434176">Lock</span><span class="op" id="1434180">(</span><span class="op" id="1434181">)</span>&nbsp;<span class="op" id="1434183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1434186">//&nbsp;Fast&nbsp;path:&nbsp;grab&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434222">if</span>&nbsp;<span class="ident" id="1434225">atomic</span><span class="op" id="1434231">.</span><span class="ident" id="1434232">CompareAndSwapInt32</span><span class="op" id="1434251">(</span><span class="op" id="1434252">&amp;</span><span class="ident" id="1434253">m</span><span class="op" id="1434254">.</span><span class="ident" id="1434255">state</span><span class="op" id="1434260">,</span>&nbsp;<span class="num" id="1434262">0</span><span class="op" id="1434263">,</span>&nbsp;<span class="ident" id="1434265">mutexLocked</span><span class="op" id="1434276">)</span>&nbsp;<span class="op" id="1434278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434282">if</span>&nbsp;<span class="ident" id="1434285">raceenabled</span>&nbsp;<span class="op" id="1434297">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434302">raceAcquire</span><span class="op" id="1434313">(</span><span class="ident" id="1434314">unsafe</span><span class="op" id="1434320">.</span><span class="ident" id="1434321">Pointer</span><span class="op" id="1434328">(</span><span class="ident" id="1434329">m</span><span class="op" id="1434330">)</span><span class="op" id="1434331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1434335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434339">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1434347">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434351">awoke</span>&nbsp;<span class="op" id="1434357">:=</span>&nbsp;<span class="builtintype" id="1434360">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434367">for</span>&nbsp;<span class="op" id="1434371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434375">old</span>&nbsp;<span class="op" id="1434379">:=</span>&nbsp;<span class="ident" id="1434382">m</span><span class="op" id="1434383">.</span><span class="ident" id="1434384">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1434392">new</span>&nbsp;<span class="op" id="1434396">:=</span>&nbsp;<span class="ident" id="1434399">old</span>&nbsp;<span class="op" id="1434403">|</span>&nbsp;<span class="ident" id="1434405">mutexLocked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434419">if</span>&nbsp;<span class="ident" id="1434422">old</span><span class="op" id="1434425">&amp;</span><span class="ident" id="1434426">mutexLocked</span>&nbsp;<span class="op" id="1434438">!=</span>&nbsp;<span class="num" id="1434441">0</span>&nbsp;<span class="op" id="1434443">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1434448">new</span>&nbsp;<span class="op" id="1434452">=</span>&nbsp;<span class="ident" id="1434454">old</span>&nbsp;<span class="op" id="1434458">+</span>&nbsp;<span class="num" id="1434460">1</span><span class="op" id="1434461">&lt;&lt;</span><span class="ident" id="1434463">mutexWaiterShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1434482">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434486">if</span>&nbsp;<span class="ident" id="1434489">awoke</span>&nbsp;<span class="op" id="1434495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1434500">//&nbsp;The&nbsp;goroutine&nbsp;has&nbsp;been&nbsp;woken&nbsp;from&nbsp;sleep,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1434547">//&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;reset&nbsp;the&nbsp;flag&nbsp;in&nbsp;either&nbsp;case.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1434598">new</span>&nbsp;<span class="op" id="1434602">&amp;^=</span>&nbsp;<span class="ident" id="1434606">mutexWoken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1434619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434623">if</span>&nbsp;<span class="ident" id="1434626">atomic</span><span class="op" id="1434632">.</span><span class="ident" id="1434633">CompareAndSwapInt32</span><span class="op" id="1434652">(</span><span class="op" id="1434653">&amp;</span><span class="ident" id="1434654">m</span><span class="op" id="1434655">.</span><span class="ident" id="1434656">state</span><span class="op" id="1434661">,</span>&nbsp;<span class="ident" id="1434663">old</span><span class="op" id="1434666">,</span>&nbsp;<span class="builtinfunc" id="1434668">new</span><span class="op" id="1434671">)</span>&nbsp;<span class="op" id="1434673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434678">if</span>&nbsp;<span class="ident" id="1434681">old</span><span class="op" id="1434684">&amp;</span><span class="ident" id="1434685">mutexLocked</span>&nbsp;<span class="op" id="1434697">==</span>&nbsp;<span class="num" id="1434700">0</span>&nbsp;<span class="op" id="1434702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434708">break</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1434717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434722">runtime_Semacquire</span><span class="op" id="1434740">(</span><span class="op" id="1434741">&amp;</span><span class="ident" id="1434742">m</span><span class="op" id="1434743">.</span><span class="ident" id="1434744">sema</span><span class="op" id="1434748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434753">awoke</span>&nbsp;<span class="op" id="1434759">=</span>&nbsp;<span class="builtintype" id="1434761">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1434768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1434771">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434775">if</span>&nbsp;<span class="ident" id="1434778">raceenabled</span>&nbsp;<span class="op" id="1434790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434794">raceAcquire</span><span class="op" id="1434805">(</span><span class="ident" id="1434806">unsafe</span><span class="op" id="1434812">.</span><span class="ident" id="1434813">Pointer</span><span class="op" id="1434820">(</span><span class="ident" id="1434821">m</span><span class="op" id="1434822">)</span><span class="op" id="1434823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1434826">}</span><br>
<span class="lineno"></span><span class="op" id="1434828">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="1434831">//&nbsp;Unlock&nbsp;unlocks&nbsp;m.</span><br>
<span class="lineno"></span><span class="comment" id="1434852">//&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;m&nbsp;is&nbsp;not&nbsp;locked&nbsp;on&nbsp;entry&nbsp;to&nbsp;Unlock.</span><br>
<span class="lineno"></span><span class="comment" id="1434917">//</span><br>
<span class="lineno"></span><span class="comment" id="1434920">//&nbsp;A&nbsp;locked&nbsp;Mutex&nbsp;is&nbsp;not&nbsp;associated&nbsp;with&nbsp;a&nbsp;particular&nbsp;goroutine.</span><br>
<span class="lineno">80</span><span class="comment" id="1434985">//&nbsp;It&nbsp;is&nbsp;allowed&nbsp;for&nbsp;one&nbsp;goroutine&nbsp;to&nbsp;lock&nbsp;a&nbsp;Mutex&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="1435045">//&nbsp;arrange&nbsp;for&nbsp;another&nbsp;goroutine&nbsp;to&nbsp;unlock&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="1435092">func</span>&nbsp;<span class="op" id="1435097">(</span><span class="ident" id="1435098">m</span>&nbsp;<span class="op" id="1435100">*</span><span class="ident" id="1435101">Mutex</span><span class="op" id="1435106">)</span>&nbsp;<span class="ident" id="1435108">Unlock</span><span class="op" id="1435114">(</span><span class="op" id="1435115">)</span>&nbsp;<span class="op" id="1435117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1435120">if</span>&nbsp;<span class="ident" id="1435123">raceenabled</span>&nbsp;<span class="op" id="1435135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435139">_</span>&nbsp;<span class="op" id="1435141">=</span>&nbsp;<span class="ident" id="1435143">m</span><span class="op" id="1435144">.</span><span class="ident" id="1435145">state</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435153">raceRelease</span><span class="op" id="1435164">(</span><span class="ident" id="1435165">unsafe</span><span class="op" id="1435171">.</span><span class="ident" id="1435172">Pointer</span><span class="op" id="1435179">(</span><span class="ident" id="1435180">m</span><span class="op" id="1435181">)</span><span class="op" id="1435182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1435185">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1435189">//&nbsp;Fast&nbsp;path:&nbsp;drop&nbsp;lock&nbsp;bit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1435219">new</span>&nbsp;<span class="op" id="1435223">:=</span>&nbsp;<span class="ident" id="1435226">atomic</span><span class="op" id="1435232">.</span><span class="ident" id="1435233">AddInt32</span><span class="op" id="1435241">(</span><span class="op" id="1435242">&amp;</span><span class="ident" id="1435243">m</span><span class="op" id="1435244">.</span><span class="ident" id="1435245">state</span><span class="op" id="1435250">,</span>&nbsp;<span class="op" id="1435252">-</span><span class="ident" id="1435253">mutexLocked</span><span class="op" id="1435264">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1435267">if</span>&nbsp;<span class="op" id="1435270">(</span><span class="builtinfunc" id="1435271">new</span><span class="op" id="1435274">+</span><span class="ident" id="1435275">mutexLocked</span><span class="op" id="1435286">)</span><span class="op" id="1435287">&amp;</span><span class="ident" id="1435288">mutexLocked</span>&nbsp;<span class="op" id="1435300">==</span>&nbsp;<span class="num" id="1435303">0</span>&nbsp;<span class="op" id="1435305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1435309">panic</span><span class="op" id="1435314">(</span><span class="string" id="1435315">&#34;sync:&nbsp;unlock&nbsp;of&nbsp;unlocked&nbsp;mutex&#34;</span><span class="op" id="1435347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1435350">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435354">old</span>&nbsp;<span class="op" id="1435358">:=</span>&nbsp;<span class="builtinfunc" id="1435361">new</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1435366">for</span>&nbsp;<span class="op" id="1435370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1435374">//&nbsp;If&nbsp;there&nbsp;are&nbsp;no&nbsp;waiters&nbsp;or&nbsp;a&nbsp;goroutine&nbsp;has&nbsp;already</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1435430">//&nbsp;been&nbsp;woken&nbsp;or&nbsp;grabbed&nbsp;the&nbsp;lock,&nbsp;no&nbsp;need&nbsp;to&nbsp;wake&nbsp;anyone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1435491">if</span>&nbsp;<span class="ident" id="1435494">old</span><span class="op" id="1435497">&gt;&gt;</span><span class="ident" id="1435499">mutexWaiterShift</span>&nbsp;<span class="op" id="1435516">==</span>&nbsp;<span class="num" id="1435519">0</span>&nbsp;<span class="op" id="1435521">||</span>&nbsp;<span class="ident" id="1435524">old</span><span class="op" id="1435527">&amp;</span><span class="op" id="1435528">(</span><span class="ident" id="1435529">mutexLocked</span><span class="op" id="1435540">|</span><span class="ident" id="1435541">mutexWoken</span><span class="op" id="1435551">)</span>&nbsp;<span class="op" id="1435553">!=</span>&nbsp;<span class="num" id="1435556">0</span>&nbsp;<span class="op" id="1435558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1435563">return</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1435572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1435576">//&nbsp;Grab&nbsp;the&nbsp;right&nbsp;to&nbsp;wake&nbsp;someone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1435613">new</span>&nbsp;<span class="op" id="1435617">=</span>&nbsp;<span class="op" id="1435619">(</span><span class="ident" id="1435620">old</span>&nbsp;<span class="op" id="1435624">-</span>&nbsp;<span class="num" id="1435626">1</span><span class="op" id="1435627">&lt;&lt;</span><span class="ident" id="1435629">mutexWaiterShift</span><span class="op" id="1435645">)</span>&nbsp;<span class="op" id="1435647">|</span>&nbsp;<span class="ident" id="1435649">mutexWoken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1435662">if</span>&nbsp;<span class="ident" id="1435665">atomic</span><span class="op" id="1435671">.</span><span class="ident" id="1435672">CompareAndSwapInt32</span><span class="op" id="1435691">(</span><span class="op" id="1435692">&amp;</span><span class="ident" id="1435693">m</span><span class="op" id="1435694">.</span><span class="ident" id="1435695">state</span><span class="op" id="1435700">,</span>&nbsp;<span class="ident" id="1435702">old</span><span class="op" id="1435705">,</span>&nbsp;<span class="builtinfunc" id="1435707">new</span><span class="op" id="1435710">)</span>&nbsp;<span class="op" id="1435712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435717">runtime_Semrelease</span><span class="op" id="1435735">(</span><span class="op" id="1435736">&amp;</span><span class="ident" id="1435737">m</span><span class="op" id="1435738">.</span><span class="ident" id="1435739">sema</span><span class="op" id="1435743">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1435748">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1435757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435761">old</span>&nbsp;<span class="op" id="1435765">=</span>&nbsp;<span class="ident" id="1435767">m</span><span class="op" id="1435768">.</span><span class="ident" id="1435769">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1435776">}</span><br>
<span class="lineno"></span><span class="op" id="1435778">}</span>
</div>
</body>
</html>
