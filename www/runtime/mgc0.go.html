<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1603477">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1603532">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1603586">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1603637">package</span>&nbsp;<span class="ident" id="1603645">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1603654">import</span>&nbsp;<span class="string" id="1603661">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1603671">//&nbsp;Called&nbsp;from&nbsp;C.&nbsp;Returns&nbsp;the&nbsp;Go&nbsp;type&nbsp;*m.</span><br>
<span class="lineno">10</span><span class="keyword" id="1603713">func</span>&nbsp;<span class="ident" id="1603718">gc_m_ptr</span><span class="op" id="1603726">(</span><span class="ident" id="1603727">ret</span>&nbsp;<span class="op" id="1603731">*</span><span class="keyword" id="1603732">interface</span><span class="op" id="1603741">{</span><span class="op" id="1603742">}</span><span class="op" id="1603743">)</span>&nbsp;<span class="op" id="1603745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1603748">*</span><span class="ident" id="1603749">ret</span>&nbsp;<span class="op" id="1603753">=</span>&nbsp;<span class="op" id="1603755">(</span><span class="op" id="1603756">*</span><span class="ident" id="1603757">m</span><span class="op" id="1603758">)</span><span class="op" id="1603759">(</span><span class="ident" id="1603760">nil</span><span class="op" id="1603763">)</span><br>
<span class="lineno"></span><span class="op" id="1603765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1603768">//&nbsp;Called&nbsp;from&nbsp;C.&nbsp;Returns&nbsp;the&nbsp;Go&nbsp;type&nbsp;*g.</span><br>
<span class="lineno">15</span><span class="keyword" id="1603810">func</span>&nbsp;<span class="ident" id="1603815">gc_g_ptr</span><span class="op" id="1603823">(</span><span class="ident" id="1603824">ret</span>&nbsp;<span class="op" id="1603828">*</span><span class="keyword" id="1603829">interface</span><span class="op" id="1603838">{</span><span class="op" id="1603839">}</span><span class="op" id="1603840">)</span>&nbsp;<span class="op" id="1603842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1603845">*</span><span class="ident" id="1603846">ret</span>&nbsp;<span class="op" id="1603850">=</span>&nbsp;<span class="op" id="1603852">(</span><span class="op" id="1603853">*</span><span class="ident" id="1603854">g</span><span class="op" id="1603855">)</span><span class="op" id="1603856">(</span><span class="ident" id="1603857">nil</span><span class="op" id="1603860">)</span><br>
<span class="lineno"></span><span class="op" id="1603862">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1603865">//&nbsp;Called&nbsp;from&nbsp;C.&nbsp;Returns&nbsp;the&nbsp;Go&nbsp;type&nbsp;*itab.</span><br>
<span class="lineno">20</span><span class="keyword" id="1603910">func</span>&nbsp;<span class="ident" id="1603915">gc_itab_ptr</span><span class="op" id="1603926">(</span><span class="ident" id="1603927">ret</span>&nbsp;<span class="op" id="1603931">*</span><span class="keyword" id="1603932">interface</span><span class="op" id="1603941">{</span><span class="op" id="1603942">}</span><span class="op" id="1603943">)</span>&nbsp;<span class="op" id="1603945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1603948">*</span><span class="ident" id="1603949">ret</span>&nbsp;<span class="op" id="1603953">=</span>&nbsp;<span class="op" id="1603955">(</span><span class="op" id="1603956">*</span><span class="ident" id="1603957">itab</span><span class="op" id="1603961">)</span><span class="op" id="1603962">(</span><span class="ident" id="1603963">nil</span><span class="op" id="1603966">)</span><br>
<span class="lineno"></span><span class="op" id="1603968">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1603971">func</span>&nbsp;<span class="ident" id="1603976">gc_unixnanotime</span><span class="op" id="1603991">(</span><span class="ident" id="1603992">now</span>&nbsp;<span class="op" id="1603996">*</span><span class="ident" id="1603997">int64</span><span class="op" id="1604002">)</span>&nbsp;<span class="op" id="1604004">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1604007">sec</span><span class="op" id="1604010">,</span>&nbsp;<span class="ident" id="1604012">nsec</span>&nbsp;<span class="op" id="1604017">:=</span>&nbsp;<span class="ident" id="1604020">timenow</span><span class="op" id="1604027">(</span><span class="op" id="1604028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1604031">*</span><span class="ident" id="1604032">now</span>&nbsp;<span class="op" id="1604036">=</span>&nbsp;<span class="ident" id="1604038">sec</span><span class="op" id="1604041">*</span><span class="num" id="1604042">1e9</span>&nbsp;<span class="op" id="1604046">+</span>&nbsp;<span class="ident" id="1604048">int64</span><span class="op" id="1604053">(</span><span class="ident" id="1604054">nsec</span><span class="op" id="1604058">)</span><br>
<span class="lineno"></span><span class="op" id="1604060">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1604063">func</span>&nbsp;<span class="ident" id="1604068">freeOSMemory</span><span class="op" id="1604080">(</span><span class="op" id="1604081">)</span>&nbsp;<span class="op" id="1604083">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1604086">gogc</span><span class="op" id="1604090">(</span><span class="num" id="1604091">2</span><span class="op" id="1604092">)</span>&nbsp;<span class="comment" id="1604094">//&nbsp;force&nbsp;GC&nbsp;and&nbsp;do&nbsp;eager&nbsp;sweep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1604126">onM</span><span class="op" id="1604129">(</span><span class="ident" id="1604130">scavenge_m</span><span class="op" id="1604140">)</span><br>
<span class="lineno"></span><span class="op" id="1604142">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1604145">var</span>&nbsp;<span class="ident" id="1604149">poolcleanup</span>&nbsp;<span class="keyword" id="1604161">func</span><span class="op" id="1604165">(</span><span class="op" id="1604166">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="1604169">func</span>&nbsp;<span class="ident" id="1604174">registerPoolCleanup</span><span class="op" id="1604193">(</span><span class="ident" id="1604194">f</span>&nbsp;<span class="keyword" id="1604196">func</span><span class="op" id="1604200">(</span><span class="op" id="1604201">)</span><span class="op" id="1604202">)</span>&nbsp;<span class="op" id="1604204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1604207">poolcleanup</span>&nbsp;<span class="op" id="1604219">=</span>&nbsp;<span class="ident" id="1604221">f</span><br>
<span class="lineno"></span><span class="op" id="1604223">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="1604226">func</span>&nbsp;<span class="ident" id="1604231">clearpools</span><span class="op" id="1604241">(</span><span class="op" id="1604242">)</span>&nbsp;<span class="op" id="1604244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1604247">//&nbsp;clear&nbsp;sync.Pools</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1604268">if</span>&nbsp;<span class="ident" id="1604271">poolcleanup</span>&nbsp;<span class="op" id="1604283">!=</span>&nbsp;<span class="ident" id="1604286">nil</span>&nbsp;<span class="op" id="1604290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1604294">poolcleanup</span><span class="op" id="1604305">(</span><span class="op" id="1604306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1604309">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1604313">for</span>&nbsp;<span class="ident" id="1604317">_</span><span class="op" id="1604318">,</span>&nbsp;<span class="ident" id="1604320">p</span>&nbsp;<span class="op" id="1604322">:=</span>&nbsp;<span class="keyword" id="1604325">range</span>&nbsp;<span class="op" id="1604331">&amp;</span><span class="ident" id="1604332">allp</span>&nbsp;<span class="op" id="1604337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1604341">if</span>&nbsp;<span class="ident" id="1604344">p</span>&nbsp;<span class="op" id="1604346">==</span>&nbsp;<span class="ident" id="1604349">nil</span>&nbsp;<span class="op" id="1604353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1604358">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1604366">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1604370">//&nbsp;clear&nbsp;tinyalloc&nbsp;pool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1604396">if</span>&nbsp;<span class="ident" id="1604399">c</span>&nbsp;<span class="op" id="1604401">:=</span>&nbsp;<span class="ident" id="1604404">p</span><span class="op" id="1604405">.</span><span class="ident" id="1604406">mcache</span><span class="op" id="1604412">;</span>&nbsp;<span class="ident" id="1604414">c</span>&nbsp;<span class="op" id="1604416">!=</span>&nbsp;<span class="ident" id="1604419">nil</span>&nbsp;<span class="op" id="1604423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1604428">c</span><span class="op" id="1604429">.</span><span class="ident" id="1604430">tiny</span>&nbsp;<span class="op" id="1604435">=</span>&nbsp;<span class="ident" id="1604437">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1604444">c</span><span class="op" id="1604445">.</span><span class="ident" id="1604446">tinysize</span>&nbsp;<span class="op" id="1604455">=</span>&nbsp;<span class="num" id="1604457">0</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1604463">//&nbsp;disconnect&nbsp;cached&nbsp;list&nbsp;before&nbsp;dropping&nbsp;it&nbsp;on&nbsp;the&nbsp;floor,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1604525">//&nbsp;so&nbsp;that&nbsp;a&nbsp;dangling&nbsp;ref&nbsp;to&nbsp;one&nbsp;entry&nbsp;does&nbsp;not&nbsp;pin&nbsp;all&nbsp;of&nbsp;them.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1604593">var</span>&nbsp;<span class="ident" id="1604597">sg</span><span class="op" id="1604599">,</span>&nbsp;<span class="ident" id="1604601">sgnext</span>&nbsp;<span class="op" id="1604608">*</span><span class="ident" id="1604609">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1604618">for</span>&nbsp;<span class="ident" id="1604622">sg</span>&nbsp;<span class="op" id="1604625">=</span>&nbsp;<span class="ident" id="1604627">c</span><span class="op" id="1604628">.</span><span class="ident" id="1604629">sudogcache</span><span class="op" id="1604639">;</span>&nbsp;<span class="ident" id="1604641">sg</span>&nbsp;<span class="op" id="1604644">!=</span>&nbsp;<span class="ident" id="1604647">nil</span><span class="op" id="1604650">;</span>&nbsp;<span class="ident" id="1604652">sg</span>&nbsp;<span class="op" id="1604655">=</span>&nbsp;<span class="ident" id="1604657">sgnext</span>&nbsp;<span class="op" id="1604664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1604670">sgnext</span>&nbsp;<span class="op" id="1604677">=</span>&nbsp;<span class="ident" id="1604679">sg</span><span class="op" id="1604681">.</span><span class="ident" id="1604682">next</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1604691">sg</span><span class="op" id="1604693">.</span><span class="ident" id="1604694">next</span>&nbsp;<span class="op" id="1604699">=</span>&nbsp;<span class="ident" id="1604701">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1604708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1604713">c</span><span class="op" id="1604714">.</span><span class="ident" id="1604715">sudogcache</span>&nbsp;<span class="op" id="1604726">=</span>&nbsp;<span class="ident" id="1604728">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1604734">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1604739">//&nbsp;clear&nbsp;defer&nbsp;pools</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1604762">for</span>&nbsp;<span class="ident" id="1604766">i</span>&nbsp;<span class="op" id="1604768">:=</span>&nbsp;<span class="keyword" id="1604771">range</span>&nbsp;<span class="ident" id="1604777">p</span><span class="op" id="1604778">.</span><span class="ident" id="1604779">deferpool</span>&nbsp;<span class="op" id="1604789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1604794">//&nbsp;disconnect&nbsp;cached&nbsp;list&nbsp;before&nbsp;dropping&nbsp;it&nbsp;on&nbsp;the&nbsp;floor,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1604856">//&nbsp;so&nbsp;that&nbsp;a&nbsp;dangling&nbsp;ref&nbsp;to&nbsp;one&nbsp;entry&nbsp;does&nbsp;not&nbsp;pin&nbsp;all&nbsp;of&nbsp;them.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1604924">var</span>&nbsp;<span class="ident" id="1604928">d</span><span class="op" id="1604929">,</span>&nbsp;<span class="ident" id="1604931">dlink</span>&nbsp;<span class="op" id="1604937">*</span><span class="ident" id="1604938">_defer</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1604948">for</span>&nbsp;<span class="ident" id="1604952">d</span>&nbsp;<span class="op" id="1604954">=</span>&nbsp;<span class="ident" id="1604956">p</span><span class="op" id="1604957">.</span><span class="ident" id="1604958">deferpool</span><span class="op" id="1604967">[</span><span class="ident" id="1604968">i</span><span class="op" id="1604969">]</span><span class="op" id="1604970">;</span>&nbsp;<span class="ident" id="1604972">d</span>&nbsp;<span class="op" id="1604974">!=</span>&nbsp;<span class="ident" id="1604977">nil</span><span class="op" id="1604980">;</span>&nbsp;<span class="ident" id="1604982">d</span>&nbsp;<span class="op" id="1604984">=</span>&nbsp;<span class="ident" id="1604986">dlink</span>&nbsp;<span class="op" id="1604992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1604998">dlink</span>&nbsp;<span class="op" id="1605004">=</span>&nbsp;<span class="ident" id="1605006">d</span><span class="op" id="1605007">.</span><span class="ident" id="1605008">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1605017">d</span><span class="op" id="1605018">.</span><span class="ident" id="1605019">link</span>&nbsp;<span class="op" id="1605024">=</span>&nbsp;<span class="ident" id="1605026">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1605033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1605038">p</span><span class="op" id="1605039">.</span><span class="ident" id="1605040">deferpool</span><span class="op" id="1605049">[</span><span class="ident" id="1605050">i</span><span class="op" id="1605051">]</span>&nbsp;<span class="op" id="1605053">=</span>&nbsp;<span class="ident" id="1605055">nil</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1605061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1605064">}</span><br>
<span class="lineno"></span><span class="op" id="1605066">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1605069">func</span>&nbsp;<span class="ident" id="1605074">gosweepone</span><span class="op" id="1605084">(</span><span class="op" id="1605085">)</span>&nbsp;<span class="builtintype" id="1605087">uintptr</span><br>
<span class="lineno">80</span><span class="keyword" id="1605095">func</span>&nbsp;<span class="ident" id="1605100">gosweepdone</span><span class="op" id="1605111">(</span><span class="op" id="1605112">)</span>&nbsp;<span class="builtintype" id="1605114">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1605120">func</span>&nbsp;<span class="ident" id="1605125">bgsweep</span><span class="op" id="1605132">(</span><span class="op" id="1605133">)</span>&nbsp;<span class="op" id="1605135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1605138">getg</span><span class="op" id="1605142">(</span><span class="op" id="1605143">)</span><span class="op" id="1605144">.</span><span class="ident" id="1605145">issystem</span>&nbsp;<span class="op" id="1605154">=</span>&nbsp;<span class="ident" id="1605156">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1605162">for</span>&nbsp;<span class="op" id="1605166">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1605170">for</span>&nbsp;<span class="ident" id="1605174">gosweepone</span><span class="op" id="1605184">(</span><span class="op" id="1605185">)</span>&nbsp;<span class="op" id="1605187">!=</span>&nbsp;<span class="op" id="1605190">^</span><span class="builtintype" id="1605191">uintptr</span><span class="op" id="1605198">(</span><span class="num" id="1605199">0</span><span class="op" id="1605200">)</span>&nbsp;<span class="op" id="1605202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1605207">sweep</span><span class="op" id="1605212">.</span><span class="ident" id="1605213">nbgsweep</span><span class="op" id="1605221">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1605227">Gosched</span><span class="op" id="1605234">(</span><span class="op" id="1605235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1605239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1605243">lock</span><span class="op" id="1605247">(</span><span class="op" id="1605248">&amp;</span><span class="ident" id="1605249">gclock</span><span class="op" id="1605255">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1605259">if</span>&nbsp;<span class="op" id="1605262">!</span><span class="ident" id="1605263">gosweepdone</span><span class="op" id="1605274">(</span><span class="op" id="1605275">)</span>&nbsp;<span class="op" id="1605277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1605282">//&nbsp;This&nbsp;can&nbsp;happen&nbsp;if&nbsp;a&nbsp;GC&nbsp;runs&nbsp;between</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1605325">//&nbsp;gosweepone&nbsp;returning&nbsp;^0&nbsp;above</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1605361">//&nbsp;and&nbsp;the&nbsp;lock&nbsp;being&nbsp;acquired.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1605396">unlock</span><span class="op" id="1605402">(</span><span class="op" id="1605403">&amp;</span><span class="ident" id="1605404">gclock</span><span class="op" id="1605410">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1605415">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1605426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1605430">sweep</span><span class="op" id="1605435">.</span><span class="ident" id="1605436">parked</span>&nbsp;<span class="op" id="1605443">=</span>&nbsp;<span class="ident" id="1605445">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1605452">goparkunlock</span><span class="op" id="1605464">(</span><span class="op" id="1605465">&amp;</span><span class="ident" id="1605466">gclock</span><span class="op" id="1605472">,</span>&nbsp;<span class="string" id="1605474">&#34;GC&nbsp;sweep&nbsp;wait&#34;</span><span class="op" id="1605489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1605492">}</span><br>
<span class="lineno">100</span><span class="op" id="1605494">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1605497">//&nbsp;NOTE:&nbsp;Really&nbsp;dst&nbsp;*unsafe.Pointer,&nbsp;src&nbsp;unsafe.Pointer,</span><br>
<span class="lineno"></span><span class="comment" id="1605554">//&nbsp;but&nbsp;if&nbsp;we&nbsp;do&nbsp;that,&nbsp;Go&nbsp;inserts&nbsp;a&nbsp;write&nbsp;barrier&nbsp;on&nbsp;*dst&nbsp;=&nbsp;src.</span><br>
<span class="lineno"></span><span class="comment" id="1605618">//go:nosplit</span><br>
<span class="lineno">105</span><span class="keyword" id="1605631">func</span>&nbsp;<span class="ident" id="1605636">writebarrierptr</span><span class="op" id="1605651">(</span><span class="ident" id="1605652">dst</span>&nbsp;<span class="op" id="1605656">*</span><span class="builtintype" id="1605657">uintptr</span><span class="op" id="1605664">,</span>&nbsp;<span class="ident" id="1605666">src</span>&nbsp;<span class="builtintype" id="1605670">uintptr</span><span class="op" id="1605677">)</span>&nbsp;<span class="op" id="1605679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1605682">*</span><span class="ident" id="1605683">dst</span>&nbsp;<span class="op" id="1605687">=</span>&nbsp;<span class="ident" id="1605689">src</span><br>
<span class="lineno"></span><span class="op" id="1605693">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1605696">//go:nosplit</span><br>
<span class="lineno">110</span><span class="keyword" id="1605709">func</span>&nbsp;<span class="ident" id="1605714">writebarrierstring</span><span class="op" id="1605732">(</span><span class="ident" id="1605733">dst</span>&nbsp;<span class="op" id="1605737">*</span><span class="op" id="1605738">[</span><span class="num" id="1605739">2</span><span class="op" id="1605740">]</span><span class="builtintype" id="1605741">uintptr</span><span class="op" id="1605748">,</span>&nbsp;<span class="ident" id="1605750">src</span>&nbsp;<span class="op" id="1605754">[</span><span class="num" id="1605755">2</span><span class="op" id="1605756">]</span><span class="builtintype" id="1605757">uintptr</span><span class="op" id="1605764">)</span>&nbsp;<span class="op" id="1605766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1605769">dst</span><span class="op" id="1605772">[</span><span class="num" id="1605773">0</span><span class="op" id="1605774">]</span>&nbsp;<span class="op" id="1605776">=</span>&nbsp;<span class="ident" id="1605778">src</span><span class="op" id="1605781">[</span><span class="num" id="1605782">0</span><span class="op" id="1605783">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1605786">dst</span><span class="op" id="1605789">[</span><span class="num" id="1605790">1</span><span class="op" id="1605791">]</span>&nbsp;<span class="op" id="1605793">=</span>&nbsp;<span class="ident" id="1605795">src</span><span class="op" id="1605798">[</span><span class="num" id="1605799">1</span><span class="op" id="1605800">]</span><br>
<span class="lineno"></span><span class="op" id="1605802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="comment" id="1605805">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1605818">func</span>&nbsp;<span class="ident" id="1605823">writebarrierslice</span><span class="op" id="1605840">(</span><span class="ident" id="1605841">dst</span>&nbsp;<span class="op" id="1605845">*</span><span class="op" id="1605846">[</span><span class="num" id="1605847">3</span><span class="op" id="1605848">]</span><span class="builtintype" id="1605849">uintptr</span><span class="op" id="1605856">,</span>&nbsp;<span class="ident" id="1605858">src</span>&nbsp;<span class="op" id="1605862">[</span><span class="num" id="1605863">3</span><span class="op" id="1605864">]</span><span class="builtintype" id="1605865">uintptr</span><span class="op" id="1605872">)</span>&nbsp;<span class="op" id="1605874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1605877">dst</span><span class="op" id="1605880">[</span><span class="num" id="1605881">0</span><span class="op" id="1605882">]</span>&nbsp;<span class="op" id="1605884">=</span>&nbsp;<span class="ident" id="1605886">src</span><span class="op" id="1605889">[</span><span class="num" id="1605890">0</span><span class="op" id="1605891">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1605894">dst</span><span class="op" id="1605897">[</span><span class="num" id="1605898">1</span><span class="op" id="1605899">]</span>&nbsp;<span class="op" id="1605901">=</span>&nbsp;<span class="ident" id="1605903">src</span><span class="op" id="1605906">[</span><span class="num" id="1605907">1</span><span class="op" id="1605908">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1605911">dst</span><span class="op" id="1605914">[</span><span class="num" id="1605915">2</span><span class="op" id="1605916">]</span>&nbsp;<span class="op" id="1605918">=</span>&nbsp;<span class="ident" id="1605920">src</span><span class="op" id="1605923">[</span><span class="num" id="1605924">2</span><span class="op" id="1605925">]</span><br>
<span class="lineno">120</span><span class="op" id="1605927">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1605930">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1605943">func</span>&nbsp;<span class="ident" id="1605948">writebarrieriface</span><span class="op" id="1605965">(</span><span class="ident" id="1605966">dst</span>&nbsp;<span class="op" id="1605970">*</span><span class="op" id="1605971">[</span><span class="num" id="1605972">2</span><span class="op" id="1605973">]</span><span class="builtintype" id="1605974">uintptr</span><span class="op" id="1605981">,</span>&nbsp;<span class="ident" id="1605983">src</span>&nbsp;<span class="op" id="1605987">[</span><span class="num" id="1605988">2</span><span class="op" id="1605989">]</span><span class="builtintype" id="1605990">uintptr</span><span class="op" id="1605997">)</span>&nbsp;<span class="op" id="1605999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606002">dst</span><span class="op" id="1606005">[</span><span class="num" id="1606006">0</span><span class="op" id="1606007">]</span>&nbsp;<span class="op" id="1606009">=</span>&nbsp;<span class="ident" id="1606011">src</span><span class="op" id="1606014">[</span><span class="num" id="1606015">0</span><span class="op" id="1606016">]</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606019">dst</span><span class="op" id="1606022">[</span><span class="num" id="1606023">1</span><span class="op" id="1606024">]</span>&nbsp;<span class="op" id="1606026">=</span>&nbsp;<span class="ident" id="1606028">src</span><span class="op" id="1606031">[</span><span class="num" id="1606032">1</span><span class="op" id="1606033">]</span><br>
<span class="lineno"></span><span class="op" id="1606035">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1606038">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1606051">func</span>&nbsp;<span class="ident" id="1606056">writebarrierfat2</span><span class="op" id="1606072">(</span><span class="ident" id="1606073">dst</span>&nbsp;<span class="op" id="1606077">*</span><span class="op" id="1606078">[</span><span class="num" id="1606079">2</span><span class="op" id="1606080">]</span><span class="builtintype" id="1606081">uintptr</span><span class="op" id="1606088">,</span>&nbsp;<span class="ident" id="1606090">_</span>&nbsp;<span class="op" id="1606092">*</span><span class="builtintype" id="1606093">byte</span><span class="op" id="1606097">,</span>&nbsp;<span class="ident" id="1606099">src</span>&nbsp;<span class="op" id="1606103">[</span><span class="num" id="1606104">2</span><span class="op" id="1606105">]</span><span class="builtintype" id="1606106">uintptr</span><span class="op" id="1606113">)</span>&nbsp;<span class="op" id="1606115">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606118">dst</span><span class="op" id="1606121">[</span><span class="num" id="1606122">0</span><span class="op" id="1606123">]</span>&nbsp;<span class="op" id="1606125">=</span>&nbsp;<span class="ident" id="1606127">src</span><span class="op" id="1606130">[</span><span class="num" id="1606131">0</span><span class="op" id="1606132">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606135">dst</span><span class="op" id="1606138">[</span><span class="num" id="1606139">1</span><span class="op" id="1606140">]</span>&nbsp;<span class="op" id="1606142">=</span>&nbsp;<span class="ident" id="1606144">src</span><span class="op" id="1606147">[</span><span class="num" id="1606148">1</span><span class="op" id="1606149">]</span><br>
<span class="lineno"></span><span class="op" id="1606151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1606154">//go:nosplit</span><br>
<span class="lineno">135</span><span class="keyword" id="1606167">func</span>&nbsp;<span class="ident" id="1606172">writebarrierfat3</span><span class="op" id="1606188">(</span><span class="ident" id="1606189">dst</span>&nbsp;<span class="op" id="1606193">*</span><span class="op" id="1606194">[</span><span class="num" id="1606195">3</span><span class="op" id="1606196">]</span><span class="builtintype" id="1606197">uintptr</span><span class="op" id="1606204">,</span>&nbsp;<span class="ident" id="1606206">_</span>&nbsp;<span class="op" id="1606208">*</span><span class="builtintype" id="1606209">byte</span><span class="op" id="1606213">,</span>&nbsp;<span class="ident" id="1606215">src</span>&nbsp;<span class="op" id="1606219">[</span><span class="num" id="1606220">3</span><span class="op" id="1606221">]</span><span class="builtintype" id="1606222">uintptr</span><span class="op" id="1606229">)</span>&nbsp;<span class="op" id="1606231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606234">dst</span><span class="op" id="1606237">[</span><span class="num" id="1606238">0</span><span class="op" id="1606239">]</span>&nbsp;<span class="op" id="1606241">=</span>&nbsp;<span class="ident" id="1606243">src</span><span class="op" id="1606246">[</span><span class="num" id="1606247">0</span><span class="op" id="1606248">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606251">dst</span><span class="op" id="1606254">[</span><span class="num" id="1606255">1</span><span class="op" id="1606256">]</span>&nbsp;<span class="op" id="1606258">=</span>&nbsp;<span class="ident" id="1606260">src</span><span class="op" id="1606263">[</span><span class="num" id="1606264">1</span><span class="op" id="1606265">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606268">dst</span><span class="op" id="1606271">[</span><span class="num" id="1606272">2</span><span class="op" id="1606273">]</span>&nbsp;<span class="op" id="1606275">=</span>&nbsp;<span class="ident" id="1606277">src</span><span class="op" id="1606280">[</span><span class="num" id="1606281">2</span><span class="op" id="1606282">]</span><br>
<span class="lineno"></span><span class="op" id="1606284">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="comment" id="1606287">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1606300">func</span>&nbsp;<span class="ident" id="1606305">writebarrierfat4</span><span class="op" id="1606321">(</span><span class="ident" id="1606322">dst</span>&nbsp;<span class="op" id="1606326">*</span><span class="op" id="1606327">[</span><span class="num" id="1606328">4</span><span class="op" id="1606329">]</span><span class="builtintype" id="1606330">uintptr</span><span class="op" id="1606337">,</span>&nbsp;<span class="ident" id="1606339">_</span>&nbsp;<span class="op" id="1606341">*</span><span class="builtintype" id="1606342">byte</span><span class="op" id="1606346">,</span>&nbsp;<span class="ident" id="1606348">src</span>&nbsp;<span class="op" id="1606352">[</span><span class="num" id="1606353">4</span><span class="op" id="1606354">]</span><span class="builtintype" id="1606355">uintptr</span><span class="op" id="1606362">)</span>&nbsp;<span class="op" id="1606364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606367">dst</span><span class="op" id="1606370">[</span><span class="num" id="1606371">0</span><span class="op" id="1606372">]</span>&nbsp;<span class="op" id="1606374">=</span>&nbsp;<span class="ident" id="1606376">src</span><span class="op" id="1606379">[</span><span class="num" id="1606380">0</span><span class="op" id="1606381">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606384">dst</span><span class="op" id="1606387">[</span><span class="num" id="1606388">1</span><span class="op" id="1606389">]</span>&nbsp;<span class="op" id="1606391">=</span>&nbsp;<span class="ident" id="1606393">src</span><span class="op" id="1606396">[</span><span class="num" id="1606397">1</span><span class="op" id="1606398">]</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606401">dst</span><span class="op" id="1606404">[</span><span class="num" id="1606405">2</span><span class="op" id="1606406">]</span>&nbsp;<span class="op" id="1606408">=</span>&nbsp;<span class="ident" id="1606410">src</span><span class="op" id="1606413">[</span><span class="num" id="1606414">2</span><span class="op" id="1606415">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606418">dst</span><span class="op" id="1606421">[</span><span class="num" id="1606422">3</span><span class="op" id="1606423">]</span>&nbsp;<span class="op" id="1606425">=</span>&nbsp;<span class="ident" id="1606427">src</span><span class="op" id="1606430">[</span><span class="num" id="1606431">3</span><span class="op" id="1606432">]</span><br>
<span class="lineno"></span><span class="op" id="1606434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1606437">//go:nosplit</span><br>
<span class="lineno">150</span><span class="keyword" id="1606450">func</span>&nbsp;<span class="ident" id="1606455">writebarrierfat</span><span class="op" id="1606470">(</span><span class="ident" id="1606471">typ</span>&nbsp;<span class="op" id="1606475">*</span><span class="ident" id="1606476">_type</span><span class="op" id="1606481">,</span>&nbsp;<span class="ident" id="1606483">dst</span><span class="op" id="1606486">,</span>&nbsp;<span class="ident" id="1606488">src</span>&nbsp;<span class="ident" id="1606492">unsafe</span><span class="op" id="1606498">.</span><span class="ident" id="1606499">Pointer</span><span class="op" id="1606506">)</span>&nbsp;<span class="op" id="1606508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606511">memmove</span><span class="op" id="1606518">(</span><span class="ident" id="1606519">dst</span><span class="op" id="1606522">,</span>&nbsp;<span class="ident" id="1606524">src</span><span class="op" id="1606527">,</span>&nbsp;<span class="ident" id="1606529">typ</span><span class="op" id="1606532">.</span><span class="ident" id="1606533">size</span><span class="op" id="1606537">)</span><br>
<span class="lineno"></span><span class="op" id="1606539">}</span>
</div>
</body>
</html>
