<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html" class="current">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7963871">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7963926">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7963980">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7964031">package</span>&nbsp;<span class="ident" id="7964039">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7964044">import</span>&nbsp;<span class="op" id="7964051">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7964054">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7964063">&#34;flag&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7964071">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7964078">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7964084">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7964090">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7964101">&#34;reflect&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7964112">&#34;regexp&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7964122">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7964133">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7964144">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7964152">&#34;testing&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7964163">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7964170">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7964173">func</span>&nbsp;<span class="ident" id="7964178">newLocalListener</span><span class="op" id="7964194">(</span><span class="ident" id="7964195">t</span>&nbsp;<span class="op" id="7964197">*</span><span class="ident" id="7964198">testing</span><span class="op" id="7964205">.</span><span class="ident" id="7964206">T</span><span class="op" id="7964207">)</span>&nbsp;<span class="ident" id="7964209">Listener</span>&nbsp;<span class="op" id="7964218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7964221">ln</span><span class="op" id="7964223">,</span>&nbsp;<span class="ident" id="7964225">err</span>&nbsp;<span class="op" id="7964229">:=</span>&nbsp;<span class="ident" id="7964232">Listen</span><span class="op" id="7964238">(</span><span class="string" id="7964239">&#34;tcp&#34;</span><span class="op" id="7964244">,</span>&nbsp;<span class="string" id="7964246">&#34;127.0.0.1:0&#34;</span><span class="op" id="7964259">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7964262">if</span>&nbsp;<span class="ident" id="7964265">err</span>&nbsp;<span class="op" id="7964269">!=</span>&nbsp;<span class="ident" id="7964272">nil</span>&nbsp;<span class="op" id="7964276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7964280">ln</span><span class="op" id="7964282">,</span>&nbsp;<span class="ident" id="7964284">err</span>&nbsp;<span class="op" id="7964288">=</span>&nbsp;<span class="ident" id="7964290">Listen</span><span class="op" id="7964296">(</span><span class="string" id="7964297">&#34;tcp6&#34;</span><span class="op" id="7964303">,</span>&nbsp;<span class="string" id="7964305">&#34;[::1]:0&#34;</span><span class="op" id="7964314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7964317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7964320">if</span>&nbsp;<span class="ident" id="7964323">err</span>&nbsp;<span class="op" id="7964327">!=</span>&nbsp;<span class="ident" id="7964330">nil</span>&nbsp;<span class="op" id="7964334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7964338">t</span><span class="op" id="7964339">.</span><span class="ident" id="7964340">Fatal</span><span class="op" id="7964345">(</span><span class="ident" id="7964346">err</span><span class="op" id="7964349">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7964352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7964355">return</span>&nbsp;<span class="ident" id="7964362">ln</span><br>
<span class="lineno"></span><span class="op" id="7964365">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7964368">func</span>&nbsp;<span class="ident" id="7964373">TestDialTimeout</span><span class="op" id="7964388">(</span><span class="ident" id="7964389">t</span>&nbsp;<span class="op" id="7964391">*</span><span class="ident" id="7964392">testing</span><span class="op" id="7964399">.</span><span class="ident" id="7964400">T</span><span class="op" id="7964401">)</span>&nbsp;<span class="op" id="7964403">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7964406">origBacklog</span>&nbsp;<span class="op" id="7964418">:=</span>&nbsp;<span class="ident" id="7964421">listenerBacklog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7964438">defer</span>&nbsp;<span class="keyword" id="7964444">func</span><span class="op" id="7964448">(</span><span class="op" id="7964449">)</span>&nbsp;<span class="op" id="7964451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7964455">listenerBacklog</span>&nbsp;<span class="op" id="7964471">=</span>&nbsp;<span class="ident" id="7964473">origBacklog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7964486">}</span><span class="op" id="7964487">(</span><span class="op" id="7964488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7964491">listenerBacklog</span>&nbsp;<span class="op" id="7964507">=</span>&nbsp;<span class="num" id="7964509">1</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7964513">ln</span>&nbsp;<span class="op" id="7964516">:=</span>&nbsp;<span class="ident" id="7964519">newLocalListener</span><span class="op" id="7964535">(</span><span class="ident" id="7964536">t</span><span class="op" id="7964537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7964540">defer</span>&nbsp;<span class="ident" id="7964546">ln</span><span class="op" id="7964548">.</span><span class="ident" id="7964549">Close</span><span class="op" id="7964554">(</span><span class="op" id="7964555">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7964559">errc</span>&nbsp;<span class="op" id="7964564">:=</span>&nbsp;<span class="builtinfunc" id="7964567">make</span><span class="op" id="7964571">(</span><span class="keyword" id="7964572">chan</span>&nbsp;<span class="builtintype" id="7964577">error</span><span class="op" id="7964582">)</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7964586">numConns</span>&nbsp;<span class="op" id="7964595">:=</span>&nbsp;<span class="ident" id="7964598">listenerBacklog</span>&nbsp;<span class="op" id="7964614">+</span>&nbsp;<span class="num" id="7964616">100</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7964622">//&nbsp;TODO(bradfitz):&nbsp;It&#39;s&nbsp;hard&nbsp;to&nbsp;test&nbsp;this&nbsp;in&nbsp;a&nbsp;portable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7964679">//&nbsp;way.&nbsp;This&nbsp;is&nbsp;unfortunate,&nbsp;but&nbsp;works&nbsp;for&nbsp;now.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7964728">switch</span>&nbsp;<span class="ident" id="7964735">runtime</span><span class="op" id="7964742">.</span><span class="ident" id="7964743">GOOS</span>&nbsp;<span class="op" id="7964748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7964751">case</span>&nbsp;<span class="string" id="7964756">&#34;linux&#34;</span><span class="op" id="7964763">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7964767">//&nbsp;The&nbsp;kernel&nbsp;will&nbsp;start&nbsp;accepting&nbsp;TCP&nbsp;connections&nbsp;before&nbsp;userspace</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7964837">//&nbsp;gets&nbsp;a&nbsp;chance&nbsp;to&nbsp;not&nbsp;accept&nbsp;them,&nbsp;so&nbsp;fire&nbsp;off&nbsp;a&nbsp;bunch&nbsp;to&nbsp;fill&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7964907">//&nbsp;the&nbsp;kernel&#39;s&nbsp;backlog.&nbsp;&nbsp;Then&nbsp;we&nbsp;test&nbsp;we&nbsp;get&nbsp;a&nbsp;failure&nbsp;after&nbsp;that.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7964977">for</span>&nbsp;<span class="ident" id="7964981">i</span>&nbsp;<span class="op" id="7964983">:=</span>&nbsp;<span class="num" id="7964986">0</span><span class="op" id="7964987">;</span>&nbsp;<span class="ident" id="7964989">i</span>&nbsp;<span class="op" id="7964991">&lt;</span>&nbsp;<span class="ident" id="7964993">numConns</span><span class="op" id="7965001">;</span>&nbsp;<span class="ident" id="7965003">i</span><span class="op" id="7965004">++</span>&nbsp;<span class="op" id="7965007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7965012">go</span>&nbsp;<span class="keyword" id="7965015">func</span><span class="op" id="7965019">(</span><span class="op" id="7965020">)</span>&nbsp;<span class="op" id="7965022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7965028">_</span><span class="op" id="7965029">,</span>&nbsp;<span class="ident" id="7965031">err</span>&nbsp;<span class="op" id="7965035">:=</span>&nbsp;<span class="ident" id="7965038">DialTimeout</span><span class="op" id="7965049">(</span><span class="string" id="7965050">&#34;tcp&#34;</span><span class="op" id="7965055">,</span>&nbsp;<span class="ident" id="7965057">ln</span><span class="op" id="7965059">.</span><span class="ident" id="7965060">Addr</span><span class="op" id="7965064">(</span><span class="op" id="7965065">)</span><span class="op" id="7965066">.</span><span class="ident" id="7965067">String</span><span class="op" id="7965073">(</span><span class="op" id="7965074">)</span><span class="op" id="7965075">,</span>&nbsp;<span class="num" id="7965077">200</span><span class="op" id="7965080">*</span><span class="ident" id="7965081">time</span><span class="op" id="7965085">.</span><span class="ident" id="7965086">Millisecond</span><span class="op" id="7965097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7965103">errc</span>&nbsp;<span class="op" id="7965108">&lt;-</span>&nbsp;<span class="ident" id="7965111">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7965118">}</span><span class="op" id="7965119">(</span><span class="op" id="7965120">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7965124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7965127">case</span>&nbsp;<span class="string" id="7965132">&#34;darwin&#34;</span><span class="op" id="7965140">,</span>&nbsp;<span class="string" id="7965142">&#34;plan9&#34;</span><span class="op" id="7965149">,</span>&nbsp;<span class="string" id="7965151">&#34;windows&#34;</span><span class="op" id="7965160">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7965164">//&nbsp;At&nbsp;least&nbsp;OS&nbsp;X&nbsp;10.7&nbsp;seems&nbsp;to&nbsp;accept&nbsp;any&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7965218">//&nbsp;connections,&nbsp;ignoring&nbsp;listen&#39;s&nbsp;backlog,&nbsp;so&nbsp;resort</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7965273">//&nbsp;to&nbsp;connecting&nbsp;to&nbsp;a&nbsp;hopefully-dead&nbsp;127/8&nbsp;address.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7965327">//&nbsp;Same&nbsp;for&nbsp;windows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7965350">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7965355">//&nbsp;Use&nbsp;an&nbsp;IANA&nbsp;reserved&nbsp;port&nbsp;(49151)&nbsp;instead&nbsp;of&nbsp;80,&nbsp;because</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7965417">//&nbsp;on&nbsp;our&nbsp;386&nbsp;builder,&nbsp;this&nbsp;Dial&nbsp;succeeds,&nbsp;connecting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7965473">//&nbsp;to&nbsp;an&nbsp;IIS&nbsp;web&nbsp;server&nbsp;somewhere.&nbsp;&nbsp;The&nbsp;data&nbsp;center</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7965527">//&nbsp;or&nbsp;VM&nbsp;or&nbsp;firewall&nbsp;must&nbsp;be&nbsp;stealing&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7965587">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7965592">//&nbsp;IANA&nbsp;Service&nbsp;Name&nbsp;and&nbsp;Transport&nbsp;Protocol&nbsp;Port&nbsp;Number&nbsp;Registry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7965659">//&nbsp;&lt;http://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xml&gt;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7965756">go</span>&nbsp;<span class="keyword" id="7965759">func</span><span class="op" id="7965763">(</span><span class="op" id="7965764">)</span>&nbsp;<span class="op" id="7965766">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7965771">c</span><span class="op" id="7965772">,</span>&nbsp;<span class="ident" id="7965774">err</span>&nbsp;<span class="op" id="7965778">:=</span>&nbsp;<span class="ident" id="7965781">DialTimeout</span><span class="op" id="7965792">(</span><span class="string" id="7965793">&#34;tcp&#34;</span><span class="op" id="7965798">,</span>&nbsp;<span class="string" id="7965800">&#34;127.0.71.111:49151&#34;</span><span class="op" id="7965820">,</span>&nbsp;<span class="num" id="7965822">200</span><span class="op" id="7965825">*</span><span class="ident" id="7965826">time</span><span class="op" id="7965830">.</span><span class="ident" id="7965831">Millisecond</span><span class="op" id="7965842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7965847">if</span>&nbsp;<span class="ident" id="7965850">err</span>&nbsp;<span class="op" id="7965854">==</span>&nbsp;<span class="ident" id="7965857">nil</span>&nbsp;<span class="op" id="7965861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7965867">err</span>&nbsp;<span class="op" id="7965871">=</span>&nbsp;<span class="ident" id="7965873">fmt</span><span class="op" id="7965876">.</span><span class="ident" id="7965877">Errorf</span><span class="op" id="7965883">(</span><span class="string" id="7965884">&#34;unexpected:&nbsp;connected&nbsp;to&nbsp;%s!&#34;</span><span class="op" id="7965914">,</span>&nbsp;<span class="ident" id="7965916">c</span><span class="op" id="7965917">.</span><span class="ident" id="7965918">RemoteAddr</span><span class="op" id="7965928">(</span><span class="op" id="7965929">)</span><span class="op" id="7965930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7965936">c</span><span class="op" id="7965937">.</span><span class="ident" id="7965938">Close</span><span class="op" id="7965943">(</span><span class="op" id="7965944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7965949">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7965954">errc</span>&nbsp;<span class="op" id="7965959">&lt;-</span>&nbsp;<span class="ident" id="7965962">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7965968">}</span><span class="op" id="7965969">(</span><span class="op" id="7965970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7965973">default</span><span class="op" id="7965980">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7965984">//&nbsp;TODO(bradfitz):</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7966005">//&nbsp;OpenBSD&nbsp;may&nbsp;have&nbsp;a&nbsp;reject&nbsp;route&nbsp;to&nbsp;127/8&nbsp;except&nbsp;127.0.0.1/32</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7966071">//&nbsp;by&nbsp;default.&nbsp;FreeBSD&nbsp;likely&nbsp;works,&nbsp;but&nbsp;is&nbsp;untested.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7966127">//&nbsp;TODO(rsc):</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7966143">//&nbsp;The&nbsp;timeout&nbsp;never&nbsp;happens&nbsp;on&nbsp;Windows.&nbsp;&nbsp;Why?&nbsp;&nbsp;Issue&nbsp;3016.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7966205">t</span><span class="op" id="7966206">.</span><span class="ident" id="7966207">Skipf</span><span class="op" id="7966212">(</span><span class="string" id="7966213">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q;&nbsp;untested.&#34;</span><span class="op" id="7966245">,</span>&nbsp;<span class="ident" id="7966247">runtime</span><span class="op" id="7966254">.</span><span class="ident" id="7966255">GOOS</span><span class="op" id="7966259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7966262">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7966266">connected</span>&nbsp;<span class="op" id="7966276">:=</span>&nbsp;<span class="num" id="7966279">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7966282">for</span>&nbsp;<span class="op" id="7966286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7966290">select</span>&nbsp;<span class="op" id="7966297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7966301">case</span>&nbsp;<span class="op" id="7966306">&lt;-</span><span class="ident" id="7966308">time</span><span class="op" id="7966312">.</span><span class="ident" id="7966313">After</span><span class="op" id="7966318">(</span><span class="num" id="7966319">15</span>&nbsp;<span class="op" id="7966322">*</span>&nbsp;<span class="ident" id="7966324">time</span><span class="op" id="7966328">.</span><span class="ident" id="7966329">Second</span><span class="op" id="7966335">)</span><span class="op" id="7966336">:</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7966341">t</span><span class="op" id="7966342">.</span><span class="ident" id="7966343">Fatal</span><span class="op" id="7966348">(</span><span class="string" id="7966349">&#34;too&nbsp;slow&#34;</span><span class="op" id="7966359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7966363">case</span>&nbsp;<span class="ident" id="7966368">err</span>&nbsp;<span class="op" id="7966372">:=</span>&nbsp;<span class="op" id="7966375">&lt;-</span><span class="ident" id="7966377">errc</span><span class="op" id="7966381">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7966386">if</span>&nbsp;<span class="ident" id="7966389">err</span>&nbsp;<span class="op" id="7966393">==</span>&nbsp;<span class="ident" id="7966396">nil</span>&nbsp;<span class="op" id="7966400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7966406">connected</span><span class="op" id="7966415">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7966422">if</span>&nbsp;<span class="ident" id="7966425">connected</span>&nbsp;<span class="op" id="7966435">==</span>&nbsp;<span class="ident" id="7966438">numConns</span>&nbsp;<span class="op" id="7966447">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7966454">t</span><span class="op" id="7966455">.</span><span class="ident" id="7966456">Fatal</span><span class="op" id="7966461">(</span><span class="string" id="7966462">&#34;all&nbsp;connections&nbsp;connected;&nbsp;expected&nbsp;some&nbsp;to&nbsp;time&nbsp;out&#34;</span><span class="op" id="7966516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7966522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7966527">}</span>&nbsp;<span class="keyword" id="7966529">else</span>&nbsp;<span class="op" id="7966534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7966540">terr</span><span class="op" id="7966544">,</span>&nbsp;<span class="ident" id="7966546">ok</span>&nbsp;<span class="op" id="7966549">:=</span>&nbsp;<span class="ident" id="7966552">err</span><span class="op" id="7966555">.</span><span class="op" id="7966556">(</span><span class="ident" id="7966557">timeout</span><span class="op" id="7966564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7966570">if</span>&nbsp;<span class="op" id="7966573">!</span><span class="ident" id="7966574">ok</span>&nbsp;<span class="op" id="7966577">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7966584">t</span><span class="op" id="7966585">.</span><span class="ident" id="7966586">Fatalf</span><span class="op" id="7966592">(</span><span class="string" id="7966593">&#34;got&nbsp;error&nbsp;%q;&nbsp;want&nbsp;error&nbsp;with&nbsp;timeout&nbsp;interface&#34;</span><span class="op" id="7966642">,</span>&nbsp;<span class="ident" id="7966644">err</span><span class="op" id="7966647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7966653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7966659">if</span>&nbsp;<span class="op" id="7966662">!</span><span class="ident" id="7966663">terr</span><span class="op" id="7966667">.</span><span class="ident" id="7966668">Timeout</span><span class="op" id="7966675">(</span><span class="op" id="7966676">)</span>&nbsp;<span class="op" id="7966678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7966685">t</span><span class="op" id="7966686">.</span><span class="ident" id="7966687">Fatalf</span><span class="op" id="7966693">(</span><span class="string" id="7966694">&#34;got&nbsp;error&nbsp;%q;&nbsp;not&nbsp;a&nbsp;timeout&#34;</span><span class="op" id="7966723">,</span>&nbsp;<span class="ident" id="7966725">err</span><span class="op" id="7966728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7966734">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7966740">//&nbsp;Pass.&nbsp;We&nbsp;saw&nbsp;a&nbsp;timeout&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7966777">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7966787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7966791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7966794">}</span><br>
<span class="lineno">115</span><span class="op" id="7966796">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7966799">func</span>&nbsp;<span class="ident" id="7966804">TestSelfConnect</span><span class="op" id="7966819">(</span><span class="ident" id="7966820">t</span>&nbsp;<span class="op" id="7966822">*</span><span class="ident" id="7966823">testing</span><span class="op" id="7966830">.</span><span class="ident" id="7966831">T</span><span class="op" id="7966832">)</span>&nbsp;<span class="op" id="7966834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7966837">if</span>&nbsp;<span class="ident" id="7966840">runtime</span><span class="op" id="7966847">.</span><span class="ident" id="7966848">GOOS</span>&nbsp;<span class="op" id="7966853">==</span>&nbsp;<span class="string" id="7966856">&#34;windows&#34;</span>&nbsp;<span class="op" id="7966866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7966870">//&nbsp;TODO(brainman):&nbsp;do&nbsp;not&nbsp;know&nbsp;why&nbsp;it&nbsp;hangs.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7966917">t</span><span class="op" id="7966918">.</span><span class="ident" id="7966919">Skip</span><span class="op" id="7966923">(</span><span class="string" id="7966924">&#34;skipping&nbsp;known-broken&nbsp;test&nbsp;on&nbsp;windows&#34;</span><span class="op" id="7966963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7966966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7966970">//&nbsp;Test&nbsp;that&nbsp;Dial&nbsp;does&nbsp;not&nbsp;honor&nbsp;self-connects.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7967019">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;in&nbsp;DialTCP.</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7967052">//&nbsp;Find&nbsp;a&nbsp;port&nbsp;that&nbsp;would&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;local&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967107">l</span><span class="op" id="7967108">,</span>&nbsp;<span class="ident" id="7967110">err</span>&nbsp;<span class="op" id="7967114">:=</span>&nbsp;<span class="ident" id="7967117">Listen</span><span class="op" id="7967123">(</span><span class="string" id="7967124">&#34;tcp&#34;</span><span class="op" id="7967129">,</span>&nbsp;<span class="string" id="7967131">&#34;127.0.0.1:0&#34;</span><span class="op" id="7967144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7967147">if</span>&nbsp;<span class="ident" id="7967150">err</span>&nbsp;<span class="op" id="7967154">!=</span>&nbsp;<span class="ident" id="7967157">nil</span>&nbsp;<span class="op" id="7967161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967165">t</span><span class="op" id="7967166">.</span><span class="ident" id="7967167">Fatal</span><span class="op" id="7967172">(</span><span class="ident" id="7967173">err</span><span class="op" id="7967176">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7967179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967182">c</span><span class="op" id="7967183">,</span>&nbsp;<span class="ident" id="7967185">err</span>&nbsp;<span class="op" id="7967189">:=</span>&nbsp;<span class="ident" id="7967192">Dial</span><span class="op" id="7967196">(</span><span class="string" id="7967197">&#34;tcp&#34;</span><span class="op" id="7967202">,</span>&nbsp;<span class="ident" id="7967204">l</span><span class="op" id="7967205">.</span><span class="ident" id="7967206">Addr</span><span class="op" id="7967210">(</span><span class="op" id="7967211">)</span><span class="op" id="7967212">.</span><span class="ident" id="7967213">String</span><span class="op" id="7967219">(</span><span class="op" id="7967220">)</span><span class="op" id="7967221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7967224">if</span>&nbsp;<span class="ident" id="7967227">err</span>&nbsp;<span class="op" id="7967231">!=</span>&nbsp;<span class="ident" id="7967234">nil</span>&nbsp;<span class="op" id="7967238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967242">t</span><span class="op" id="7967243">.</span><span class="ident" id="7967244">Fatal</span><span class="op" id="7967249">(</span><span class="ident" id="7967250">err</span><span class="op" id="7967253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7967256">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967259">addr</span>&nbsp;<span class="op" id="7967264">:=</span>&nbsp;<span class="ident" id="7967267">c</span><span class="op" id="7967268">.</span><span class="ident" id="7967269">LocalAddr</span><span class="op" id="7967278">(</span><span class="op" id="7967279">)</span><span class="op" id="7967280">.</span><span class="ident" id="7967281">String</span><span class="op" id="7967287">(</span><span class="op" id="7967288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967291">c</span><span class="op" id="7967292">.</span><span class="ident" id="7967293">Close</span><span class="op" id="7967298">(</span><span class="op" id="7967299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967302">l</span><span class="op" id="7967303">.</span><span class="ident" id="7967304">Close</span><span class="op" id="7967309">(</span><span class="op" id="7967310">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7967314">//&nbsp;Try&nbsp;to&nbsp;connect&nbsp;to&nbsp;that&nbsp;address&nbsp;repeatedly.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967361">n</span>&nbsp;<span class="op" id="7967363">:=</span>&nbsp;<span class="num" id="7967366">100000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7967374">if</span>&nbsp;<span class="ident" id="7967377">testing</span><span class="op" id="7967384">.</span><span class="ident" id="7967385">Short</span><span class="op" id="7967390">(</span><span class="op" id="7967391">)</span>&nbsp;<span class="op" id="7967393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967397">n</span>&nbsp;<span class="op" id="7967399">=</span>&nbsp;<span class="num" id="7967401">1000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7967407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7967410">switch</span>&nbsp;<span class="ident" id="7967417">runtime</span><span class="op" id="7967424">.</span><span class="ident" id="7967425">GOOS</span>&nbsp;<span class="op" id="7967430">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7967433">case</span>&nbsp;<span class="string" id="7967438">&#34;darwin&#34;</span><span class="op" id="7967446">,</span>&nbsp;<span class="string" id="7967448">&#34;dragonfly&#34;</span><span class="op" id="7967459">,</span>&nbsp;<span class="string" id="7967461">&#34;freebsd&#34;</span><span class="op" id="7967470">,</span>&nbsp;<span class="string" id="7967472">&#34;netbsd&#34;</span><span class="op" id="7967480">,</span>&nbsp;<span class="string" id="7967482">&#34;openbsd&#34;</span><span class="op" id="7967491">,</span>&nbsp;<span class="string" id="7967493">&#34;plan9&#34;</span><span class="op" id="7967500">,</span>&nbsp;<span class="string" id="7967502">&#34;solaris&#34;</span><span class="op" id="7967511">,</span>&nbsp;<span class="string" id="7967513">&#34;windows&#34;</span><span class="op" id="7967522">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7967526">//&nbsp;Non-Linux&nbsp;systems&nbsp;take&nbsp;a&nbsp;long&nbsp;time&nbsp;to&nbsp;figure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7967576">//&nbsp;out&nbsp;that&nbsp;there&nbsp;is&nbsp;nothing&nbsp;listening&nbsp;on&nbsp;localhost.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967631">n</span>&nbsp;<span class="op" id="7967633">=</span>&nbsp;<span class="num" id="7967635">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7967640">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7967643">for</span>&nbsp;<span class="ident" id="7967647">i</span>&nbsp;<span class="op" id="7967649">:=</span>&nbsp;<span class="num" id="7967652">0</span><span class="op" id="7967653">;</span>&nbsp;<span class="ident" id="7967655">i</span>&nbsp;<span class="op" id="7967657">&lt;</span>&nbsp;<span class="ident" id="7967659">n</span><span class="op" id="7967660">;</span>&nbsp;<span class="ident" id="7967662">i</span><span class="op" id="7967663">++</span>&nbsp;<span class="op" id="7967666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967670">c</span><span class="op" id="7967671">,</span>&nbsp;<span class="ident" id="7967673">err</span>&nbsp;<span class="op" id="7967677">:=</span>&nbsp;<span class="ident" id="7967680">DialTimeout</span><span class="op" id="7967691">(</span><span class="string" id="7967692">&#34;tcp&#34;</span><span class="op" id="7967697">,</span>&nbsp;<span class="ident" id="7967699">addr</span><span class="op" id="7967703">,</span>&nbsp;<span class="ident" id="7967705">time</span><span class="op" id="7967709">.</span><span class="ident" id="7967710">Millisecond</span><span class="op" id="7967721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7967725">if</span>&nbsp;<span class="ident" id="7967728">err</span>&nbsp;<span class="op" id="7967732">==</span>&nbsp;<span class="ident" id="7967735">nil</span>&nbsp;<span class="op" id="7967739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7967744">if</span>&nbsp;<span class="ident" id="7967747">c</span><span class="op" id="7967748">.</span><span class="ident" id="7967749">LocalAddr</span><span class="op" id="7967758">(</span><span class="op" id="7967759">)</span><span class="op" id="7967760">.</span><span class="ident" id="7967761">String</span><span class="op" id="7967767">(</span><span class="op" id="7967768">)</span>&nbsp;<span class="op" id="7967770">==</span>&nbsp;<span class="ident" id="7967773">addr</span>&nbsp;<span class="op" id="7967778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967784">t</span><span class="op" id="7967785">.</span><span class="ident" id="7967786">Errorf</span><span class="op" id="7967792">(</span><span class="string" id="7967793">&#34;#%d:&nbsp;Dial&nbsp;%q&nbsp;self-connect&#34;</span><span class="op" id="7967820">,</span>&nbsp;<span class="ident" id="7967822">i</span><span class="op" id="7967823">,</span>&nbsp;<span class="ident" id="7967825">addr</span><span class="op" id="7967829">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7967834">}</span>&nbsp;<span class="keyword" id="7967836">else</span>&nbsp;<span class="op" id="7967841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967847">t</span><span class="op" id="7967848">.</span><span class="ident" id="7967849">Logf</span><span class="op" id="7967853">(</span><span class="string" id="7967854">&#34;#%d:&nbsp;Dial&nbsp;%q&nbsp;succeeded&nbsp;-&nbsp;possibly&nbsp;racing&nbsp;with&nbsp;other&nbsp;listener&#34;</span><span class="op" id="7967916">,</span>&nbsp;<span class="ident" id="7967918">i</span><span class="op" id="7967919">,</span>&nbsp;<span class="ident" id="7967921">addr</span><span class="op" id="7967925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7967930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967935">c</span><span class="op" id="7967936">.</span><span class="ident" id="7967937">Close</span><span class="op" id="7967942">(</span><span class="op" id="7967943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7967947">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7967950">}</span><br>
<span class="lineno"></span><span class="op" id="7967952">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7967955">var</span>&nbsp;<span class="ident" id="7967959">runErrorTest</span>&nbsp;<span class="op" id="7967972">=</span>&nbsp;<span class="ident" id="7967974">flag</span><span class="op" id="7967978">.</span><span class="ident" id="7967979">Bool</span><span class="op" id="7967983">(</span><span class="string" id="7967984">&#34;run_error_test&#34;</span><span class="op" id="7968000">,</span>&nbsp;<span class="builtintype" id="7968002">false</span><span class="op" id="7968007">,</span>&nbsp;<span class="string" id="7968009">&#34;let&nbsp;TestDialError&nbsp;check&nbsp;for&nbsp;dns&nbsp;errors&#34;</span><span class="op" id="7968049">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="7968052">type</span>&nbsp;<span class="ident" id="7968057">DialErrorTest</span>&nbsp;<span class="keyword" id="7968071">struct</span>&nbsp;<span class="op" id="7968078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7968081">Net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7968089">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7968097">Raddr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7968105">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7968113">Pattern</span>&nbsp;<span class="builtintype" id="7968121">string</span><br>
<span class="lineno"></span><span class="op" id="7968128">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="keyword" id="7968131">var</span>&nbsp;<span class="ident" id="7968135">dialErrorTests</span>&nbsp;<span class="op" id="7968150">=</span>&nbsp;<span class="op" id="7968152">[</span><span class="op" id="7968153">]</span><span class="ident" id="7968154">DialErrorTest</span><span class="op" id="7968167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7968170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7968174">&#34;datakit&#34;</span><span class="op" id="7968183">,</span>&nbsp;<span class="string" id="7968185">&#34;mh/astro/r70&#34;</span><span class="op" id="7968199">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7968203">&#34;dial&nbsp;datakit&nbsp;mh/astro/r70:&nbsp;unknown&nbsp;network&nbsp;datakit&#34;</span><span class="op" id="7968255">,</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7968258">}</span><span class="op" id="7968259">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7968262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7968266">&#34;tcp&#34;</span><span class="op" id="7968271">,</span>&nbsp;<span class="string" id="7968273">&#34;127.0.0.1:☺&#34;</span><span class="op" id="7968288">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7968292">&#34;dial&nbsp;tcp&nbsp;127.0.0.1:☺:&nbsp;unknown&nbsp;port&nbsp;tcp/☺&#34;</span><span class="op" id="7968338">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7968341">}</span><span class="op" id="7968342">,</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7968345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7968349">&#34;tcp&#34;</span><span class="op" id="7968354">,</span>&nbsp;<span class="string" id="7968356">&#34;no-such-name.google.com.:80&#34;</span><span class="op" id="7968385">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7968389">&#34;dial&nbsp;tcp&nbsp;no-such-name.google.com.:80:&nbsp;lookup&nbsp;no-such-name.google.com.(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)&#34;</span><span class="op" id="7968478">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7968481">}</span><span class="op" id="7968482">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7968485">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7968489">&#34;tcp&#34;</span><span class="op" id="7968494">,</span>&nbsp;<span class="string" id="7968496">&#34;no-such-name.no-such-top-level-domain.:80&#34;</span><span class="op" id="7968539">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7968543">&#34;dial&nbsp;tcp&nbsp;no-such-name.no-such-top-level-domain.:80:&nbsp;lookup&nbsp;no-such-name.no-such-top-level-domain.(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)&#34;</span><span class="op" id="7968660">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7968663">}</span><span class="op" id="7968664">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7968667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7968671">&#34;tcp&#34;</span><span class="op" id="7968676">,</span>&nbsp;<span class="string" id="7968678">&#34;no-such-name:80&#34;</span><span class="op" id="7968695">,</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7968699">`dial&nbsp;tcp&nbsp;no-such-name:80:&nbsp;lookup&nbsp;no-such-name\.(.*\.)?(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)`</span><span class="op" id="7968773">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7968776">}</span><span class="op" id="7968777">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7968780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7968784">&#34;tcp&#34;</span><span class="op" id="7968789">,</span>&nbsp;<span class="string" id="7968791">&#34;mh/astro/r70:http&#34;</span><span class="op" id="7968810">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7968814">&#34;dial&nbsp;tcp&nbsp;mh/astro/r70:http:&nbsp;lookup&nbsp;mh/astro/r70:&nbsp;invalid&nbsp;domain&nbsp;name&#34;</span><span class="op" id="7968884">,</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7968887">}</span><span class="op" id="7968888">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7968891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7968895">&#34;unix&#34;</span><span class="op" id="7968901">,</span>&nbsp;<span class="string" id="7968903">&#34;/etc/file-not-found&#34;</span><span class="op" id="7968924">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7968928">&#34;dial&nbsp;unix&nbsp;/etc/file-not-found:&nbsp;no&nbsp;such&nbsp;file&nbsp;or&nbsp;directory&#34;</span><span class="op" id="7968986">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7968989">}</span><span class="op" id="7968990">,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7968993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7968997">&#34;unix&#34;</span><span class="op" id="7969003">,</span>&nbsp;<span class="string" id="7969005">&#34;/etc/&#34;</span><span class="op" id="7969012">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969016">&#34;dial&nbsp;unix&nbsp;/etc/:&nbsp;(permission&nbsp;denied|socket&nbsp;operation&nbsp;on&nbsp;non-socket|connection&nbsp;refused)&#34;</span><span class="op" id="7969104">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7969107">}</span><span class="op" id="7969108">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7969111">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969115">&#34;unixpacket&#34;</span><span class="op" id="7969127">,</span>&nbsp;<span class="string" id="7969129">&#34;/etc/file-not-found&#34;</span><span class="op" id="7969150">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969154">&#34;dial&nbsp;unixpacket&nbsp;/etc/file-not-found:&nbsp;no&nbsp;such&nbsp;file&nbsp;or&nbsp;directory&#34;</span><span class="op" id="7969218">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7969221">}</span><span class="op" id="7969222">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7969225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969229">&#34;unixpacket&#34;</span><span class="op" id="7969241">,</span>&nbsp;<span class="string" id="7969243">&#34;/etc/&#34;</span><span class="op" id="7969250">,</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969254">&#34;dial&nbsp;unixpacket&nbsp;/etc/:&nbsp;(permission&nbsp;denied|socket&nbsp;operation&nbsp;on&nbsp;non-socket|connection&nbsp;refused)&#34;</span><span class="op" id="7969348">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7969351">}</span><span class="op" id="7969352">,</span><br>
<span class="lineno"></span><span class="op" id="7969354">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7969357">var</span>&nbsp;<span class="ident" id="7969361">duplicateErrorPattern</span>&nbsp;<span class="op" id="7969383">=</span>&nbsp;<span class="string" id="7969385">`dial&nbsp;(.*)&nbsp;dial&nbsp;(.*)`</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="7969408">func</span>&nbsp;<span class="ident" id="7969413">TestDialError</span><span class="op" id="7969426">(</span><span class="ident" id="7969427">t</span>&nbsp;<span class="op" id="7969429">*</span><span class="ident" id="7969430">testing</span><span class="op" id="7969437">.</span><span class="ident" id="7969438">T</span><span class="op" id="7969439">)</span>&nbsp;<span class="op" id="7969441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7969444">if</span>&nbsp;<span class="op" id="7969447">!</span><span class="op" id="7969448">*</span><span class="ident" id="7969449">runErrorTest</span>&nbsp;<span class="op" id="7969462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7969466">t</span><span class="op" id="7969467">.</span><span class="ident" id="7969468">Logf</span><span class="op" id="7969472">(</span><span class="string" id="7969473">&#34;test&nbsp;disabled;&nbsp;use&nbsp;-run_error_test&nbsp;to&nbsp;enable&#34;</span><span class="op" id="7969519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7969523">return</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7969531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7969534">for</span>&nbsp;<span class="ident" id="7969538">i</span><span class="op" id="7969539">,</span>&nbsp;<span class="ident" id="7969541">tt</span>&nbsp;<span class="op" id="7969544">:=</span>&nbsp;<span class="keyword" id="7969547">range</span>&nbsp;<span class="ident" id="7969553">dialErrorTests</span>&nbsp;<span class="op" id="7969568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7969572">c</span><span class="op" id="7969573">,</span>&nbsp;<span class="ident" id="7969575">err</span>&nbsp;<span class="op" id="7969579">:=</span>&nbsp;<span class="ident" id="7969582">Dial</span><span class="op" id="7969586">(</span><span class="ident" id="7969587">tt</span><span class="op" id="7969589">.</span><span class="ident" id="7969590">Net</span><span class="op" id="7969593">,</span>&nbsp;<span class="ident" id="7969595">tt</span><span class="op" id="7969597">.</span><span class="ident" id="7969598">Raddr</span><span class="op" id="7969603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7969607">if</span>&nbsp;<span class="ident" id="7969610">c</span>&nbsp;<span class="op" id="7969612">!=</span>&nbsp;<span class="ident" id="7969615">nil</span>&nbsp;<span class="op" id="7969619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7969624">c</span><span class="op" id="7969625">.</span><span class="ident" id="7969626">Close</span><span class="op" id="7969631">(</span><span class="op" id="7969632">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7969636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7969640">if</span>&nbsp;<span class="ident" id="7969643">err</span>&nbsp;<span class="op" id="7969647">==</span>&nbsp;<span class="ident" id="7969650">nil</span>&nbsp;<span class="op" id="7969654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7969659">t</span><span class="op" id="7969660">.</span><span class="ident" id="7969661">Errorf</span><span class="op" id="7969667">(</span><span class="string" id="7969668">&#34;#%d:&nbsp;nil&nbsp;error,&nbsp;want&nbsp;match&nbsp;for&nbsp;%#q&#34;</span><span class="op" id="7969704">,</span>&nbsp;<span class="ident" id="7969706">i</span><span class="op" id="7969707">,</span>&nbsp;<span class="ident" id="7969709">tt</span><span class="op" id="7969711">.</span><span class="ident" id="7969712">Pattern</span><span class="op" id="7969719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7969724">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7969735">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7969739">s</span>&nbsp;<span class="op" id="7969741">:=</span>&nbsp;<span class="ident" id="7969744">err</span><span class="op" id="7969747">.</span><span class="ident" id="7969748">Error</span><span class="op" id="7969753">(</span><span class="op" id="7969754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7969758">match</span><span class="op" id="7969763">,</span>&nbsp;<span class="ident" id="7969765">_</span>&nbsp;<span class="op" id="7969767">:=</span>&nbsp;<span class="ident" id="7969770">regexp</span><span class="op" id="7969776">.</span><span class="ident" id="7969777">MatchString</span><span class="op" id="7969788">(</span><span class="ident" id="7969789">tt</span><span class="op" id="7969791">.</span><span class="ident" id="7969792">Pattern</span><span class="op" id="7969799">,</span>&nbsp;<span class="ident" id="7969801">s</span><span class="op" id="7969802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7969806">if</span>&nbsp;<span class="op" id="7969809">!</span><span class="ident" id="7969810">match</span>&nbsp;<span class="op" id="7969816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7969821">t</span><span class="op" id="7969822">.</span><span class="ident" id="7969823">Errorf</span><span class="op" id="7969829">(</span><span class="string" id="7969830">&#34;#%d:&nbsp;%q,&nbsp;want&nbsp;match&nbsp;for&nbsp;%#q&#34;</span><span class="op" id="7969859">,</span>&nbsp;<span class="ident" id="7969861">i</span><span class="op" id="7969862">,</span>&nbsp;<span class="ident" id="7969864">s</span><span class="op" id="7969865">,</span>&nbsp;<span class="ident" id="7969867">tt</span><span class="op" id="7969869">.</span><span class="ident" id="7969870">Pattern</span><span class="op" id="7969877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7969881">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7969885">match</span><span class="op" id="7969890">,</span>&nbsp;<span class="ident" id="7969892">_</span>&nbsp;<span class="op" id="7969894">=</span>&nbsp;<span class="ident" id="7969896">regexp</span><span class="op" id="7969902">.</span><span class="ident" id="7969903">MatchString</span><span class="op" id="7969914">(</span><span class="ident" id="7969915">duplicateErrorPattern</span><span class="op" id="7969936">,</span>&nbsp;<span class="ident" id="7969938">s</span><span class="op" id="7969939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7969943">if</span>&nbsp;<span class="ident" id="7969946">match</span>&nbsp;<span class="op" id="7969952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7969957">t</span><span class="op" id="7969958">.</span><span class="ident" id="7969959">Errorf</span><span class="op" id="7969965">(</span><span class="string" id="7969966">&#34;#%d:&nbsp;%q,&nbsp;duplicate&nbsp;error&nbsp;return&nbsp;from&nbsp;Dial&#34;</span><span class="op" id="7970009">,</span>&nbsp;<span class="ident" id="7970011">i</span><span class="op" id="7970012">,</span>&nbsp;<span class="ident" id="7970014">s</span><span class="op" id="7970015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7970019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7970022">}</span><br>
<span class="lineno">240</span><span class="op" id="7970024">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7970027">var</span>&nbsp;<span class="ident" id="7970031">invalidDialAndListenArgTests</span>&nbsp;<span class="op" id="7970060">=</span>&nbsp;<span class="op" id="7970062">[</span><span class="op" id="7970063">]</span><span class="keyword" id="7970064">struct</span>&nbsp;<span class="op" id="7970071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7970074">net</span>&nbsp;&nbsp;<span class="builtintype" id="7970079">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7970087">addr</span>&nbsp;<span class="builtintype" id="7970092">string</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7970100">err</span>&nbsp;&nbsp;<span class="builtintype" id="7970105">error</span><br>
<span class="lineno"></span><span class="op" id="7970111">}</span><span class="op" id="7970112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7970115">{</span><span class="string" id="7970116">&#34;foo&#34;</span><span class="op" id="7970121">,</span>&nbsp;<span class="string" id="7970123">&#34;bar&#34;</span><span class="op" id="7970128">,</span>&nbsp;<span class="op" id="7970130">&amp;</span><span class="ident" id="7970131">OpError</span><span class="op" id="7970138">{</span><span class="ident" id="7970139">Op</span><span class="op" id="7970141">:</span>&nbsp;<span class="string" id="7970143">&#34;dial&#34;</span><span class="op" id="7970149">,</span>&nbsp;<span class="ident" id="7970151">Net</span><span class="op" id="7970154">:</span>&nbsp;<span class="string" id="7970156">&#34;foo&#34;</span><span class="op" id="7970161">,</span>&nbsp;<span class="ident" id="7970163">Addr</span><span class="op" id="7970167">:</span>&nbsp;<span class="ident" id="7970169">nil</span><span class="op" id="7970172">,</span>&nbsp;<span class="ident" id="7970174">Err</span><span class="op" id="7970177">:</span>&nbsp;<span class="ident" id="7970179">UnknownNetworkError</span><span class="op" id="7970198">(</span><span class="string" id="7970199">&#34;foo&#34;</span><span class="op" id="7970204">)</span><span class="op" id="7970205">}</span><span class="op" id="7970206">}</span><span class="op" id="7970207">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7970210">{</span><span class="string" id="7970211">&#34;baz&#34;</span><span class="op" id="7970216">,</span>&nbsp;<span class="string" id="7970218">&#34;&#34;</span><span class="op" id="7970220">,</span>&nbsp;<span class="op" id="7970222">&amp;</span><span class="ident" id="7970223">OpError</span><span class="op" id="7970230">{</span><span class="ident" id="7970231">Op</span><span class="op" id="7970233">:</span>&nbsp;<span class="string" id="7970235">&#34;listen&#34;</span><span class="op" id="7970243">,</span>&nbsp;<span class="ident" id="7970245">Net</span><span class="op" id="7970248">:</span>&nbsp;<span class="string" id="7970250">&#34;baz&#34;</span><span class="op" id="7970255">,</span>&nbsp;<span class="ident" id="7970257">Addr</span><span class="op" id="7970261">:</span>&nbsp;<span class="ident" id="7970263">nil</span><span class="op" id="7970266">,</span>&nbsp;<span class="ident" id="7970268">Err</span><span class="op" id="7970271">:</span>&nbsp;<span class="ident" id="7970273">UnknownNetworkError</span><span class="op" id="7970292">(</span><span class="string" id="7970293">&#34;baz&#34;</span><span class="op" id="7970298">)</span><span class="op" id="7970299">}</span><span class="op" id="7970300">}</span><span class="op" id="7970301">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7970304">{</span><span class="string" id="7970305">&#34;tcp&#34;</span><span class="op" id="7970310">,</span>&nbsp;<span class="string" id="7970312">&#34;&#34;</span><span class="op" id="7970314">,</span>&nbsp;<span class="op" id="7970316">&amp;</span><span class="ident" id="7970317">OpError</span><span class="op" id="7970324">{</span><span class="ident" id="7970325">Op</span><span class="op" id="7970327">:</span>&nbsp;<span class="string" id="7970329">&#34;dial&#34;</span><span class="op" id="7970335">,</span>&nbsp;<span class="ident" id="7970337">Net</span><span class="op" id="7970340">:</span>&nbsp;<span class="string" id="7970342">&#34;tcp&#34;</span><span class="op" id="7970347">,</span>&nbsp;<span class="ident" id="7970349">Addr</span><span class="op" id="7970353">:</span>&nbsp;<span class="ident" id="7970355">nil</span><span class="op" id="7970358">,</span>&nbsp;<span class="ident" id="7970360">Err</span><span class="op" id="7970363">:</span>&nbsp;<span class="ident" id="7970365">errMissingAddress</span><span class="op" id="7970382">}</span><span class="op" id="7970383">}</span><span class="op" id="7970384">,</span><br>
<span class="lineno">250</span><span class="op" id="7970386">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7970389">func</span>&nbsp;<span class="ident" id="7970394">TestInvalidDialAndListenArgs</span><span class="op" id="7970422">(</span><span class="ident" id="7970423">t</span>&nbsp;<span class="op" id="7970425">*</span><span class="ident" id="7970426">testing</span><span class="op" id="7970433">.</span><span class="ident" id="7970434">T</span><span class="op" id="7970435">)</span>&nbsp;<span class="op" id="7970437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7970440">for</span>&nbsp;<span class="ident" id="7970444">_</span><span class="op" id="7970445">,</span>&nbsp;<span class="ident" id="7970447">tt</span>&nbsp;<span class="op" id="7970450">:=</span>&nbsp;<span class="keyword" id="7970453">range</span>&nbsp;<span class="ident" id="7970459">invalidDialAndListenArgTests</span>&nbsp;<span class="op" id="7970488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7970492">var</span>&nbsp;<span class="ident" id="7970496">err</span>&nbsp;<span class="builtintype" id="7970500">error</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7970508">switch</span>&nbsp;<span class="ident" id="7970515">tt</span><span class="op" id="7970517">.</span><span class="ident" id="7970518">err</span><span class="op" id="7970521">.</span><span class="op" id="7970522">(</span><span class="op" id="7970523">*</span><span class="ident" id="7970524">OpError</span><span class="op" id="7970531">)</span><span class="op" id="7970532">.</span><span class="ident" id="7970533">Op</span>&nbsp;<span class="op" id="7970536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7970540">case</span>&nbsp;<span class="string" id="7970545">&#34;dial&#34;</span><span class="op" id="7970551">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7970556">_</span><span class="op" id="7970557">,</span>&nbsp;<span class="ident" id="7970559">err</span>&nbsp;<span class="op" id="7970563">=</span>&nbsp;<span class="ident" id="7970565">Dial</span><span class="op" id="7970569">(</span><span class="ident" id="7970570">tt</span><span class="op" id="7970572">.</span><span class="ident" id="7970573">net</span><span class="op" id="7970576">,</span>&nbsp;<span class="ident" id="7970578">tt</span><span class="op" id="7970580">.</span><span class="ident" id="7970581">addr</span><span class="op" id="7970585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7970589">case</span>&nbsp;<span class="string" id="7970594">&#34;listen&#34;</span><span class="op" id="7970602">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7970607">_</span><span class="op" id="7970608">,</span>&nbsp;<span class="ident" id="7970610">err</span>&nbsp;<span class="op" id="7970614">=</span>&nbsp;<span class="ident" id="7970616">Listen</span><span class="op" id="7970622">(</span><span class="ident" id="7970623">tt</span><span class="op" id="7970625">.</span><span class="ident" id="7970626">net</span><span class="op" id="7970629">,</span>&nbsp;<span class="ident" id="7970631">tt</span><span class="op" id="7970633">.</span><span class="ident" id="7970634">addr</span><span class="op" id="7970638">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7970642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7970646">if</span>&nbsp;<span class="op" id="7970649">!</span><span class="ident" id="7970650">reflect</span><span class="op" id="7970657">.</span><span class="ident" id="7970658">DeepEqual</span><span class="op" id="7970667">(</span><span class="ident" id="7970668">tt</span><span class="op" id="7970670">.</span><span class="ident" id="7970671">err</span><span class="op" id="7970674">,</span>&nbsp;<span class="ident" id="7970676">err</span><span class="op" id="7970679">)</span>&nbsp;<span class="op" id="7970681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7970686">t</span><span class="op" id="7970687">.</span><span class="ident" id="7970688">Fatalf</span><span class="op" id="7970694">(</span><span class="string" id="7970695">&#34;got&nbsp;%#v;&nbsp;expected&nbsp;%#v&#34;</span><span class="op" id="7970718">,</span>&nbsp;<span class="ident" id="7970720">err</span><span class="op" id="7970723">,</span>&nbsp;<span class="ident" id="7970725">tt</span><span class="op" id="7970727">.</span><span class="ident" id="7970728">err</span><span class="op" id="7970731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7970735">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7970738">}</span><br>
<span class="lineno">265</span><span class="op" id="7970740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7970743">func</span>&nbsp;<span class="ident" id="7970748">TestDialTimeoutFDLeak</span><span class="op" id="7970769">(</span><span class="ident" id="7970770">t</span>&nbsp;<span class="op" id="7970772">*</span><span class="ident" id="7970773">testing</span><span class="op" id="7970780">.</span><span class="ident" id="7970781">T</span><span class="op" id="7970782">)</span>&nbsp;<span class="op" id="7970784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7970787">if</span>&nbsp;<span class="ident" id="7970790">runtime</span><span class="op" id="7970797">.</span><span class="ident" id="7970798">GOOS</span>&nbsp;<span class="op" id="7970803">!=</span>&nbsp;<span class="string" id="7970806">&#34;linux&#34;</span>&nbsp;<span class="op" id="7970814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7970818">//&nbsp;TODO(bradfitz):&nbsp;test&nbsp;on&nbsp;other&nbsp;platforms</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7970863">t</span><span class="op" id="7970864">.</span><span class="ident" id="7970865">Skipf</span><span class="op" id="7970870">(</span><span class="string" id="7970871">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7970892">,</span>&nbsp;<span class="ident" id="7970894">runtime</span><span class="op" id="7970901">.</span><span class="ident" id="7970902">GOOS</span><span class="op" id="7970906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7970909">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7970913">ln</span>&nbsp;<span class="op" id="7970916">:=</span>&nbsp;<span class="ident" id="7970919">newLocalListener</span><span class="op" id="7970935">(</span><span class="ident" id="7970936">t</span><span class="op" id="7970937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7970940">defer</span>&nbsp;<span class="ident" id="7970946">ln</span><span class="op" id="7970948">.</span><span class="ident" id="7970949">Close</span><span class="op" id="7970954">(</span><span class="op" id="7970955">)</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7970959">type</span>&nbsp;<span class="ident" id="7970964">connErr</span>&nbsp;<span class="keyword" id="7970972">struct</span>&nbsp;<span class="op" id="7970979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7970983">conn</span>&nbsp;<span class="ident" id="7970988">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7970995">err</span>&nbsp;&nbsp;<span class="builtintype" id="7971000">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7971007">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7971010">dials</span>&nbsp;<span class="op" id="7971016">:=</span>&nbsp;<span class="ident" id="7971019">listenerBacklog</span>&nbsp;<span class="op" id="7971035">+</span>&nbsp;<span class="num" id="7971037">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7971042">//&nbsp;used&nbsp;to&nbsp;be&nbsp;listenerBacklog&nbsp;+&nbsp;5,&nbsp;but&nbsp;was&nbsp;found&nbsp;to&nbsp;be&nbsp;unreliable,&nbsp;issue&nbsp;4384.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7971122">maxGoodConnect</span>&nbsp;<span class="op" id="7971137">:=</span>&nbsp;<span class="ident" id="7971140">listenerBacklog</span>&nbsp;<span class="op" id="7971156">+</span>&nbsp;<span class="ident" id="7971158">runtime</span><span class="op" id="7971165">.</span><span class="ident" id="7971166">NumCPU</span><span class="op" id="7971172">(</span><span class="op" id="7971173">)</span><span class="op" id="7971174">*</span><span class="num" id="7971175">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7971179">resc</span>&nbsp;<span class="op" id="7971184">:=</span>&nbsp;<span class="builtinfunc" id="7971187">make</span><span class="op" id="7971191">(</span><span class="keyword" id="7971192">chan</span>&nbsp;<span class="ident" id="7971197">connErr</span><span class="op" id="7971204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7971207">for</span>&nbsp;<span class="ident" id="7971211">i</span>&nbsp;<span class="op" id="7971213">:=</span>&nbsp;<span class="num" id="7971216">0</span><span class="op" id="7971217">;</span>&nbsp;<span class="ident" id="7971219">i</span>&nbsp;<span class="op" id="7971221">&lt;</span>&nbsp;<span class="ident" id="7971223">dials</span><span class="op" id="7971228">;</span>&nbsp;<span class="ident" id="7971230">i</span><span class="op" id="7971231">++</span>&nbsp;<span class="op" id="7971234">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7971238">go</span>&nbsp;<span class="keyword" id="7971241">func</span><span class="op" id="7971245">(</span><span class="op" id="7971246">)</span>&nbsp;<span class="op" id="7971248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7971253">conn</span><span class="op" id="7971257">,</span>&nbsp;<span class="ident" id="7971259">err</span>&nbsp;<span class="op" id="7971263">:=</span>&nbsp;<span class="ident" id="7971266">DialTimeout</span><span class="op" id="7971277">(</span><span class="string" id="7971278">&#34;tcp&#34;</span><span class="op" id="7971283">,</span>&nbsp;<span class="ident" id="7971285">ln</span><span class="op" id="7971287">.</span><span class="ident" id="7971288">Addr</span><span class="op" id="7971292">(</span><span class="op" id="7971293">)</span><span class="op" id="7971294">.</span><span class="ident" id="7971295">String</span><span class="op" id="7971301">(</span><span class="op" id="7971302">)</span><span class="op" id="7971303">,</span>&nbsp;<span class="num" id="7971305">500</span><span class="op" id="7971308">*</span><span class="ident" id="7971309">time</span><span class="op" id="7971313">.</span><span class="ident" id="7971314">Millisecond</span><span class="op" id="7971325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7971330">resc</span>&nbsp;<span class="op" id="7971335">&lt;-</span>&nbsp;<span class="ident" id="7971338">connErr</span><span class="op" id="7971345">{</span><span class="ident" id="7971346">conn</span><span class="op" id="7971350">,</span>&nbsp;<span class="ident" id="7971352">err</span><span class="op" id="7971355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7971359">}</span><span class="op" id="7971360">(</span><span class="op" id="7971361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7971364">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7971368">var</span>&nbsp;<span class="ident" id="7971372">firstErr</span>&nbsp;<span class="builtintype" id="7971381">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7971389">var</span>&nbsp;<span class="ident" id="7971393">ngood</span>&nbsp;<span class="builtintype" id="7971399">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7971404">var</span>&nbsp;<span class="ident" id="7971408">toClose</span>&nbsp;<span class="op" id="7971416">[</span><span class="op" id="7971417">]</span><span class="ident" id="7971418">io</span><span class="op" id="7971420">.</span><span class="ident" id="7971421">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7971429">for</span>&nbsp;<span class="ident" id="7971433">i</span>&nbsp;<span class="op" id="7971435">:=</span>&nbsp;<span class="num" id="7971438">0</span><span class="op" id="7971439">;</span>&nbsp;<span class="ident" id="7971441">i</span>&nbsp;<span class="op" id="7971443">&lt;</span>&nbsp;<span class="ident" id="7971445">dials</span><span class="op" id="7971450">;</span>&nbsp;<span class="ident" id="7971452">i</span><span class="op" id="7971453">++</span>&nbsp;<span class="op" id="7971456">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7971460">ce</span>&nbsp;<span class="op" id="7971463">:=</span>&nbsp;<span class="op" id="7971466">&lt;-</span><span class="ident" id="7971468">resc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7971475">if</span>&nbsp;<span class="ident" id="7971478">ce</span><span class="op" id="7971480">.</span><span class="ident" id="7971481">err</span>&nbsp;<span class="op" id="7971485">==</span>&nbsp;<span class="ident" id="7971488">nil</span>&nbsp;<span class="op" id="7971492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7971497">ngood</span><span class="op" id="7971502">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7971508">if</span>&nbsp;<span class="ident" id="7971511">ngood</span>&nbsp;<span class="op" id="7971517">&gt;</span>&nbsp;<span class="ident" id="7971519">maxGoodConnect</span>&nbsp;<span class="op" id="7971534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7971540">t</span><span class="op" id="7971541">.</span><span class="ident" id="7971542">Errorf</span><span class="op" id="7971548">(</span><span class="string" id="7971549">&#34;%d&nbsp;good&nbsp;connects;&nbsp;expected&nbsp;at&nbsp;most&nbsp;%d&#34;</span><span class="op" id="7971588">,</span>&nbsp;<span class="ident" id="7971590">ngood</span><span class="op" id="7971595">,</span>&nbsp;<span class="ident" id="7971597">maxGoodConnect</span><span class="op" id="7971611">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7971616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7971621">toClose</span>&nbsp;<span class="op" id="7971629">=</span>&nbsp;<span class="builtinfunc" id="7971631">append</span><span class="op" id="7971637">(</span><span class="ident" id="7971638">toClose</span><span class="op" id="7971645">,</span>&nbsp;<span class="ident" id="7971647">ce</span><span class="op" id="7971649">.</span><span class="ident" id="7971650">conn</span><span class="op" id="7971654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7971659">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7971670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7971674">err</span>&nbsp;<span class="op" id="7971678">:=</span>&nbsp;<span class="ident" id="7971681">ce</span><span class="op" id="7971683">.</span><span class="ident" id="7971684">err</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7971690">if</span>&nbsp;<span class="ident" id="7971693">firstErr</span>&nbsp;<span class="op" id="7971702">==</span>&nbsp;<span class="string" id="7971705">&#34;&#34;</span>&nbsp;<span class="op" id="7971708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7971713">firstErr</span>&nbsp;<span class="op" id="7971722">=</span>&nbsp;<span class="ident" id="7971724">err</span><span class="op" id="7971727">.</span><span class="ident" id="7971728">Error</span><span class="op" id="7971733">(</span><span class="op" id="7971734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7971738">}</span>&nbsp;<span class="keyword" id="7971740">else</span>&nbsp;<span class="keyword" id="7971745">if</span>&nbsp;<span class="ident" id="7971748">err</span><span class="op" id="7971751">.</span><span class="ident" id="7971752">Error</span><span class="op" id="7971757">(</span><span class="op" id="7971758">)</span>&nbsp;<span class="op" id="7971760">!=</span>&nbsp;<span class="ident" id="7971763">firstErr</span>&nbsp;<span class="op" id="7971772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7971777">t</span><span class="op" id="7971778">.</span><span class="ident" id="7971779">Fatalf</span><span class="op" id="7971785">(</span><span class="string" id="7971786">&#34;inconsistent&nbsp;error&nbsp;messages:&nbsp;first&nbsp;was&nbsp;%q,&nbsp;then&nbsp;later&nbsp;%q&#34;</span><span class="op" id="7971844">,</span>&nbsp;<span class="ident" id="7971846">firstErr</span><span class="op" id="7971854">,</span>&nbsp;<span class="ident" id="7971856">err</span><span class="op" id="7971859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7971863">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7971866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7971869">for</span>&nbsp;<span class="ident" id="7971873">_</span><span class="op" id="7971874">,</span>&nbsp;<span class="ident" id="7971876">c</span>&nbsp;<span class="op" id="7971878">:=</span>&nbsp;<span class="keyword" id="7971881">range</span>&nbsp;<span class="ident" id="7971887">toClose</span>&nbsp;<span class="op" id="7971895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7971899">c</span><span class="op" id="7971900">.</span><span class="ident" id="7971901">Close</span><span class="op" id="7971906">(</span><span class="op" id="7971907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7971910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7971913">for</span>&nbsp;<span class="ident" id="7971917">i</span>&nbsp;<span class="op" id="7971919">:=</span>&nbsp;<span class="num" id="7971922">0</span><span class="op" id="7971923">;</span>&nbsp;<span class="ident" id="7971925">i</span>&nbsp;<span class="op" id="7971927">&lt;</span>&nbsp;<span class="num" id="7971929">100</span><span class="op" id="7971932">;</span>&nbsp;<span class="ident" id="7971934">i</span><span class="op" id="7971935">++</span>&nbsp;<span class="op" id="7971938">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7971942">if</span>&nbsp;<span class="ident" id="7971945">got</span>&nbsp;<span class="op" id="7971949">:=</span>&nbsp;<span class="ident" id="7971952">numFD</span><span class="op" id="7971957">(</span><span class="op" id="7971958">)</span><span class="op" id="7971959">;</span>&nbsp;<span class="ident" id="7971961">got</span>&nbsp;<span class="op" id="7971965">&lt;</span>&nbsp;<span class="ident" id="7971967">dials</span>&nbsp;<span class="op" id="7971973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7971978">//&nbsp;Test&nbsp;passes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7971997">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7972006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7972010">time</span><span class="op" id="7972014">.</span><span class="ident" id="7972015">Sleep</span><span class="op" id="7972020">(</span><span class="num" id="7972021">10</span>&nbsp;<span class="op" id="7972024">*</span>&nbsp;<span class="ident" id="7972026">time</span><span class="op" id="7972030">.</span><span class="ident" id="7972031">Millisecond</span><span class="op" id="7972042">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7972045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7972048">if</span>&nbsp;<span class="ident" id="7972051">got</span>&nbsp;<span class="op" id="7972055">:=</span>&nbsp;<span class="ident" id="7972058">numFD</span><span class="op" id="7972063">(</span><span class="op" id="7972064">)</span><span class="op" id="7972065">;</span>&nbsp;<span class="ident" id="7972067">got</span>&nbsp;<span class="op" id="7972071">&gt;=</span>&nbsp;<span class="ident" id="7972074">dials</span>&nbsp;<span class="op" id="7972080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7972084">t</span><span class="op" id="7972085">.</span><span class="ident" id="7972086">Errorf</span><span class="op" id="7972092">(</span><span class="string" id="7972093">&#34;num&nbsp;fds&nbsp;after&nbsp;%d&nbsp;timeouts&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;%d&#34;</span><span class="op" id="7972135">,</span>&nbsp;<span class="ident" id="7972137">dials</span><span class="op" id="7972142">,</span>&nbsp;<span class="ident" id="7972144">got</span><span class="op" id="7972147">,</span>&nbsp;<span class="ident" id="7972149">dials</span><span class="op" id="7972154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7972157">}</span><br>
<span class="lineno"></span><span class="op" id="7972159">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span><span class="keyword" id="7972162">func</span>&nbsp;<span class="ident" id="7972167">numTCP</span><span class="op" id="7972173">(</span><span class="op" id="7972174">)</span>&nbsp;<span class="op" id="7972176">(</span><span class="ident" id="7972177">ntcp</span><span class="op" id="7972181">,</span>&nbsp;<span class="ident" id="7972183">nopen</span><span class="op" id="7972188">,</span>&nbsp;<span class="ident" id="7972190">nclose</span>&nbsp;<span class="builtintype" id="7972197">int</span><span class="op" id="7972200">,</span>&nbsp;<span class="ident" id="7972202">err</span>&nbsp;<span class="builtintype" id="7972206">error</span><span class="op" id="7972211">)</span>&nbsp;<span class="op" id="7972213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7972216">lsof</span><span class="op" id="7972220">,</span>&nbsp;<span class="ident" id="7972222">err</span>&nbsp;<span class="op" id="7972226">:=</span>&nbsp;<span class="ident" id="7972229">exec</span><span class="op" id="7972233">.</span><span class="ident" id="7972234">Command</span><span class="op" id="7972241">(</span><span class="string" id="7972242">&#34;lsof&#34;</span><span class="op" id="7972248">,</span>&nbsp;<span class="string" id="7972250">&#34;-n&#34;</span><span class="op" id="7972254">,</span>&nbsp;<span class="string" id="7972256">&#34;-p&#34;</span><span class="op" id="7972260">,</span>&nbsp;<span class="ident" id="7972262">strconv</span><span class="op" id="7972269">.</span><span class="ident" id="7972270">Itoa</span><span class="op" id="7972274">(</span><span class="ident" id="7972275">os</span><span class="op" id="7972277">.</span><span class="ident" id="7972278">Getpid</span><span class="op" id="7972284">(</span><span class="op" id="7972285">)</span><span class="op" id="7972286">)</span><span class="op" id="7972287">)</span><span class="op" id="7972288">.</span><span class="ident" id="7972289">Output</span><span class="op" id="7972295">(</span><span class="op" id="7972296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7972299">if</span>&nbsp;<span class="ident" id="7972302">err</span>&nbsp;<span class="op" id="7972306">!=</span>&nbsp;<span class="ident" id="7972309">nil</span>&nbsp;<span class="op" id="7972313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7972317">return</span>&nbsp;<span class="num" id="7972324">0</span><span class="op" id="7972325">,</span>&nbsp;<span class="num" id="7972327">0</span><span class="op" id="7972328">,</span>&nbsp;<span class="num" id="7972330">0</span><span class="op" id="7972331">,</span>&nbsp;<span class="ident" id="7972333">err</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7972338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7972341">ntcp</span>&nbsp;<span class="op" id="7972346">+=</span>&nbsp;<span class="ident" id="7972349">bytes</span><span class="op" id="7972354">.</span><span class="ident" id="7972355">Count</span><span class="op" id="7972360">(</span><span class="ident" id="7972361">lsof</span><span class="op" id="7972365">,</span>&nbsp;<span class="op" id="7972367">[</span><span class="op" id="7972368">]</span><span class="builtintype" id="7972369">byte</span><span class="op" id="7972373">(</span><span class="string" id="7972374">&#34;TCP&#34;</span><span class="op" id="7972379">)</span><span class="op" id="7972380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7972383">for</span>&nbsp;<span class="ident" id="7972387">_</span><span class="op" id="7972388">,</span>&nbsp;<span class="ident" id="7972390">state</span>&nbsp;<span class="op" id="7972396">:=</span>&nbsp;<span class="keyword" id="7972399">range</span>&nbsp;<span class="op" id="7972405">[</span><span class="op" id="7972406">]</span><span class="builtintype" id="7972407">string</span><span class="op" id="7972413">{</span><span class="string" id="7972414">&#34;LISTEN&#34;</span><span class="op" id="7972422">,</span>&nbsp;<span class="string" id="7972424">&#34;SYN_SENT&#34;</span><span class="op" id="7972434">,</span>&nbsp;<span class="string" id="7972436">&#34;SYN_RECEIVED&#34;</span><span class="op" id="7972450">,</span>&nbsp;<span class="string" id="7972452">&#34;ESTABLISHED&#34;</span><span class="op" id="7972465">}</span>&nbsp;<span class="op" id="7972467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7972471">nopen</span>&nbsp;<span class="op" id="7972477">+=</span>&nbsp;<span class="ident" id="7972480">bytes</span><span class="op" id="7972485">.</span><span class="ident" id="7972486">Count</span><span class="op" id="7972491">(</span><span class="ident" id="7972492">lsof</span><span class="op" id="7972496">,</span>&nbsp;<span class="op" id="7972498">[</span><span class="op" id="7972499">]</span><span class="builtintype" id="7972500">byte</span><span class="op" id="7972504">(</span><span class="ident" id="7972505">state</span><span class="op" id="7972510">)</span><span class="op" id="7972511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7972514">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7972517">for</span>&nbsp;<span class="ident" id="7972521">_</span><span class="op" id="7972522">,</span>&nbsp;<span class="ident" id="7972524">state</span>&nbsp;<span class="op" id="7972530">:=</span>&nbsp;<span class="keyword" id="7972533">range</span>&nbsp;<span class="op" id="7972539">[</span><span class="op" id="7972540">]</span><span class="builtintype" id="7972541">string</span><span class="op" id="7972547">{</span><span class="string" id="7972548">&#34;CLOSED&#34;</span><span class="op" id="7972556">,</span>&nbsp;<span class="string" id="7972558">&#34;CLOSE_WAIT&#34;</span><span class="op" id="7972570">,</span>&nbsp;<span class="string" id="7972572">&#34;LAST_ACK&#34;</span><span class="op" id="7972582">,</span>&nbsp;<span class="string" id="7972584">&#34;FIN_WAIT_1&#34;</span><span class="op" id="7972596">,</span>&nbsp;<span class="string" id="7972598">&#34;FIN_WAIT_2&#34;</span><span class="op" id="7972610">,</span>&nbsp;<span class="string" id="7972612">&#34;CLOSING&#34;</span><span class="op" id="7972621">,</span>&nbsp;<span class="string" id="7972623">&#34;TIME_WAIT&#34;</span><span class="op" id="7972634">}</span>&nbsp;<span class="op" id="7972636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7972640">nclose</span>&nbsp;<span class="op" id="7972647">+=</span>&nbsp;<span class="ident" id="7972650">bytes</span><span class="op" id="7972655">.</span><span class="ident" id="7972656">Count</span><span class="op" id="7972661">(</span><span class="ident" id="7972662">lsof</span><span class="op" id="7972666">,</span>&nbsp;<span class="op" id="7972668">[</span><span class="op" id="7972669">]</span><span class="builtintype" id="7972670">byte</span><span class="op" id="7972674">(</span><span class="ident" id="7972675">state</span><span class="op" id="7972680">)</span><span class="op" id="7972681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7972684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7972687">return</span>&nbsp;<span class="ident" id="7972694">ntcp</span><span class="op" id="7972698">,</span>&nbsp;<span class="ident" id="7972700">nopen</span><span class="op" id="7972705">,</span>&nbsp;<span class="ident" id="7972707">nclose</span><span class="op" id="7972713">,</span>&nbsp;<span class="ident" id="7972715">nil</span><br>
<span class="lineno"></span><span class="op" id="7972719">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span><span class="keyword" id="7972722">func</span>&nbsp;<span class="ident" id="7972727">TestDialMultiFDLeak</span><span class="op" id="7972746">(</span><span class="ident" id="7972747">t</span>&nbsp;<span class="op" id="7972749">*</span><span class="ident" id="7972750">testing</span><span class="op" id="7972757">.</span><span class="ident" id="7972758">T</span><span class="op" id="7972759">)</span>&nbsp;<span class="op" id="7972761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7972764">t</span><span class="op" id="7972765">.</span><span class="ident" id="7972766">Skip</span><span class="op" id="7972770">(</span><span class="string" id="7972771">&#34;flaky&nbsp;test&nbsp;-&nbsp;golang.org/issue/8764&#34;</span><span class="op" id="7972807">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7972811">if</span>&nbsp;<span class="op" id="7972814">!</span><span class="ident" id="7972815">supportsIPv4</span>&nbsp;<span class="op" id="7972828">||</span>&nbsp;<span class="op" id="7972831">!</span><span class="ident" id="7972832">supportsIPv6</span>&nbsp;<span class="op" id="7972845">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7972849">t</span><span class="op" id="7972850">.</span><span class="ident" id="7972851">Skip</span><span class="op" id="7972855">(</span><span class="string" id="7972856">&#34;neither&nbsp;ipv4&nbsp;nor&nbsp;ipv6&nbsp;is&nbsp;supported&#34;</span><span class="op" id="7972892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7972895">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7972899">halfDeadServer</span>&nbsp;<span class="op" id="7972914">:=</span>&nbsp;<span class="keyword" id="7972917">func</span><span class="op" id="7972921">(</span><span class="ident" id="7972922">dss</span>&nbsp;<span class="op" id="7972926">*</span><span class="ident" id="7972927">dualStackServer</span><span class="op" id="7972942">,</span>&nbsp;<span class="ident" id="7972944">ln</span>&nbsp;<span class="ident" id="7972947">Listener</span><span class="op" id="7972955">)</span>&nbsp;<span class="op" id="7972957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7972961">for</span>&nbsp;<span class="op" id="7972965">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7972970">if</span>&nbsp;<span class="ident" id="7972973">c</span><span class="op" id="7972974">,</span>&nbsp;<span class="ident" id="7972976">err</span>&nbsp;<span class="op" id="7972980">:=</span>&nbsp;<span class="ident" id="7972983">ln</span><span class="op" id="7972985">.</span><span class="ident" id="7972986">Accept</span><span class="op" id="7972992">(</span><span class="op" id="7972993">)</span><span class="op" id="7972994">;</span>&nbsp;<span class="ident" id="7972996">err</span>&nbsp;<span class="op" id="7973000">!=</span>&nbsp;<span class="ident" id="7973003">nil</span>&nbsp;<span class="op" id="7973007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7973013">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7973023">}</span>&nbsp;<span class="keyword" id="7973025">else</span>&nbsp;<span class="op" id="7973030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7973036">//&nbsp;It&nbsp;just&nbsp;keeps&nbsp;established</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7973069">//&nbsp;connections&nbsp;like&nbsp;a&nbsp;half-dead&nbsp;server</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7973112">//&nbsp;does.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7973125">dss</span><span class="op" id="7973128">.</span><span class="ident" id="7973129">putConn</span><span class="op" id="7973136">(</span><span class="ident" id="7973137">c</span><span class="op" id="7973138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7973143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7973147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7973150">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7973153">dss</span><span class="op" id="7973156">,</span>&nbsp;<span class="ident" id="7973158">err</span>&nbsp;<span class="op" id="7973162">:=</span>&nbsp;<span class="ident" id="7973165">newDualStackServer</span><span class="op" id="7973183">(</span><span class="op" id="7973184">[</span><span class="op" id="7973185">]</span><span class="ident" id="7973186">streamListener</span><span class="op" id="7973200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7973204">{</span><span class="ident" id="7973205">net</span><span class="op" id="7973208">:</span>&nbsp;<span class="string" id="7973210">&#34;tcp4&#34;</span><span class="op" id="7973216">,</span>&nbsp;<span class="ident" id="7973218">addr</span><span class="op" id="7973222">:</span>&nbsp;<span class="string" id="7973224">&#34;127.0.0.1&#34;</span><span class="op" id="7973235">}</span><span class="op" id="7973236">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7973240">{</span><span class="ident" id="7973241">net</span><span class="op" id="7973244">:</span>&nbsp;<span class="string" id="7973246">&#34;tcp6&#34;</span><span class="op" id="7973252">,</span>&nbsp;<span class="ident" id="7973254">addr</span><span class="op" id="7973258">:</span>&nbsp;<span class="string" id="7973260">&#34;[::1]&#34;</span><span class="op" id="7973267">}</span><span class="op" id="7973268">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7973271">}</span><span class="op" id="7973272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7973275">if</span>&nbsp;<span class="ident" id="7973278">err</span>&nbsp;<span class="op" id="7973282">!=</span>&nbsp;<span class="ident" id="7973285">nil</span>&nbsp;<span class="op" id="7973289">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7973293">t</span><span class="op" id="7973294">.</span><span class="ident" id="7973295">Fatalf</span><span class="op" id="7973301">(</span><span class="string" id="7973302">&#34;newDualStackServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7973333">,</span>&nbsp;<span class="ident" id="7973335">err</span><span class="op" id="7973338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7973341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7973344">defer</span>&nbsp;<span class="ident" id="7973350">dss</span><span class="op" id="7973353">.</span><span class="ident" id="7973354">teardown</span><span class="op" id="7973362">(</span><span class="op" id="7973363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7973366">if</span>&nbsp;<span class="ident" id="7973369">err</span>&nbsp;<span class="op" id="7973373">:=</span>&nbsp;<span class="ident" id="7973376">dss</span><span class="op" id="7973379">.</span><span class="ident" id="7973380">buildup</span><span class="op" id="7973387">(</span><span class="ident" id="7973388">halfDeadServer</span><span class="op" id="7973402">)</span><span class="op" id="7973403">;</span>&nbsp;<span class="ident" id="7973405">err</span>&nbsp;<span class="op" id="7973409">!=</span>&nbsp;<span class="ident" id="7973412">nil</span>&nbsp;<span class="op" id="7973416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7973420">t</span><span class="op" id="7973421">.</span><span class="ident" id="7973422">Fatalf</span><span class="op" id="7973428">(</span><span class="string" id="7973429">&#34;dualStackServer.buildup&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7973465">,</span>&nbsp;<span class="ident" id="7973467">err</span><span class="op" id="7973470">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7973473">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7973477">_</span><span class="op" id="7973478">,</span>&nbsp;<span class="ident" id="7973480">before</span><span class="op" id="7973486">,</span>&nbsp;<span class="ident" id="7973488">_</span><span class="op" id="7973489">,</span>&nbsp;<span class="ident" id="7973491">err</span>&nbsp;<span class="op" id="7973495">:=</span>&nbsp;<span class="ident" id="7973498">numTCP</span><span class="op" id="7973504">(</span><span class="op" id="7973505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7973508">if</span>&nbsp;<span class="ident" id="7973511">err</span>&nbsp;<span class="op" id="7973515">!=</span>&nbsp;<span class="ident" id="7973518">nil</span>&nbsp;<span class="op" id="7973522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7973526">t</span><span class="op" id="7973527">.</span><span class="ident" id="7973528">Skipf</span><span class="op" id="7973533">(</span><span class="string" id="7973534">&#34;skipping&nbsp;test;&nbsp;error&nbsp;finding&nbsp;or&nbsp;running&nbsp;lsof:&nbsp;%v&#34;</span><span class="op" id="7973584">,</span>&nbsp;<span class="ident" id="7973586">err</span><span class="op" id="7973589">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7973592">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7973596">var</span>&nbsp;<span class="ident" id="7973600">wg</span>&nbsp;<span class="ident" id="7973603">sync</span><span class="op" id="7973607">.</span><span class="ident" id="7973608">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7973619">portnum</span><span class="op" id="7973626">,</span>&nbsp;<span class="ident" id="7973628">_</span><span class="op" id="7973629">,</span>&nbsp;<span class="ident" id="7973631">_</span>&nbsp;<span class="op" id="7973633">:=</span>&nbsp;<span class="ident" id="7973636">dtoi</span><span class="op" id="7973640">(</span><span class="ident" id="7973641">dss</span><span class="op" id="7973644">.</span><span class="ident" id="7973645">port</span><span class="op" id="7973649">,</span>&nbsp;<span class="num" id="7973651">0</span><span class="op" id="7973652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7973655">ras</span>&nbsp;<span class="op" id="7973659">:=</span>&nbsp;<span class="ident" id="7973662">addrList</span><span class="op" id="7973670">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7973674">//&nbsp;Losers&nbsp;that&nbsp;will&nbsp;fail&nbsp;to&nbsp;connect,&nbsp;see&nbsp;RFC&nbsp;6890.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7973727">&amp;</span><span class="ident" id="7973728">TCPAddr</span><span class="op" id="7973735">{</span><span class="ident" id="7973736">IP</span><span class="op" id="7973738">:</span>&nbsp;<span class="ident" id="7973740">IPv4</span><span class="op" id="7973744">(</span><span class="num" id="7973745">198</span><span class="op" id="7973748">,</span>&nbsp;<span class="num" id="7973750">18</span><span class="op" id="7973752">,</span>&nbsp;<span class="num" id="7973754">0</span><span class="op" id="7973755">,</span>&nbsp;<span class="num" id="7973757">254</span><span class="op" id="7973760">)</span><span class="op" id="7973761">,</span>&nbsp;<span class="ident" id="7973763">Port</span><span class="op" id="7973767">:</span>&nbsp;<span class="ident" id="7973769">portnum</span><span class="op" id="7973776">}</span><span class="op" id="7973777">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7973781">&amp;</span><span class="ident" id="7973782">TCPAddr</span><span class="op" id="7973789">{</span><span class="ident" id="7973790">IP</span><span class="op" id="7973792">:</span>&nbsp;<span class="ident" id="7973794">ParseIP</span><span class="op" id="7973801">(</span><span class="string" id="7973802">&#34;2001:2::254&#34;</span><span class="op" id="7973815">)</span><span class="op" id="7973816">,</span>&nbsp;<span class="ident" id="7973818">Port</span><span class="op" id="7973822">:</span>&nbsp;<span class="ident" id="7973824">portnum</span><span class="op" id="7973831">}</span><span class="op" id="7973832">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7973837">//&nbsp;Winner&nbsp;candidates&nbsp;of&nbsp;this&nbsp;race.</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7973874">&amp;</span><span class="ident" id="7973875">TCPAddr</span><span class="op" id="7973882">{</span><span class="ident" id="7973883">IP</span><span class="op" id="7973885">:</span>&nbsp;<span class="ident" id="7973887">IPv4</span><span class="op" id="7973891">(</span><span class="num" id="7973892">127</span><span class="op" id="7973895">,</span>&nbsp;<span class="num" id="7973897">0</span><span class="op" id="7973898">,</span>&nbsp;<span class="num" id="7973900">0</span><span class="op" id="7973901">,</span>&nbsp;<span class="num" id="7973903">1</span><span class="op" id="7973904">)</span><span class="op" id="7973905">,</span>&nbsp;<span class="ident" id="7973907">Port</span><span class="op" id="7973911">:</span>&nbsp;<span class="ident" id="7973913">portnum</span><span class="op" id="7973920">}</span><span class="op" id="7973921">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7973925">&amp;</span><span class="ident" id="7973926">TCPAddr</span><span class="op" id="7973933">{</span><span class="ident" id="7973934">IP</span><span class="op" id="7973936">:</span>&nbsp;<span class="ident" id="7973938">IPv6loopback</span><span class="op" id="7973950">,</span>&nbsp;<span class="ident" id="7973952">Port</span><span class="op" id="7973956">:</span>&nbsp;<span class="ident" id="7973958">portnum</span><span class="op" id="7973965">}</span><span class="op" id="7973966">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7973971">//&nbsp;Losers&nbsp;that&nbsp;will&nbsp;have&nbsp;established&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7974023">&amp;</span><span class="ident" id="7974024">TCPAddr</span><span class="op" id="7974031">{</span><span class="ident" id="7974032">IP</span><span class="op" id="7974034">:</span>&nbsp;<span class="ident" id="7974036">IPv4</span><span class="op" id="7974040">(</span><span class="num" id="7974041">127</span><span class="op" id="7974044">,</span>&nbsp;<span class="num" id="7974046">0</span><span class="op" id="7974047">,</span>&nbsp;<span class="num" id="7974049">0</span><span class="op" id="7974050">,</span>&nbsp;<span class="num" id="7974052">1</span><span class="op" id="7974053">)</span><span class="op" id="7974054">,</span>&nbsp;<span class="ident" id="7974056">Port</span><span class="op" id="7974060">:</span>&nbsp;<span class="ident" id="7974062">portnum</span><span class="op" id="7974069">}</span><span class="op" id="7974070">,</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7974074">&amp;</span><span class="ident" id="7974075">TCPAddr</span><span class="op" id="7974082">{</span><span class="ident" id="7974083">IP</span><span class="op" id="7974085">:</span>&nbsp;<span class="ident" id="7974087">IPv6loopback</span><span class="op" id="7974099">,</span>&nbsp;<span class="ident" id="7974101">Port</span><span class="op" id="7974105">:</span>&nbsp;<span class="ident" id="7974107">portnum</span><span class="op" id="7974114">}</span><span class="op" id="7974115">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7974118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7974121">const</span>&nbsp;<span class="ident" id="7974127">T1</span>&nbsp;<span class="op" id="7974130">=</span>&nbsp;<span class="num" id="7974132">10</span>&nbsp;<span class="op" id="7974135">*</span>&nbsp;<span class="ident" id="7974137">time</span><span class="op" id="7974141">.</span><span class="ident" id="7974142">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7974155">const</span>&nbsp;<span class="ident" id="7974161">T2</span>&nbsp;<span class="op" id="7974164">=</span>&nbsp;<span class="num" id="7974166">2</span>&nbsp;<span class="op" id="7974168">*</span>&nbsp;<span class="ident" id="7974170">T1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7974174">const</span>&nbsp;<span class="ident" id="7974180">N</span>&nbsp;<span class="op" id="7974182">=</span>&nbsp;<span class="num" id="7974184">10</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7974188">for</span>&nbsp;<span class="ident" id="7974192">i</span>&nbsp;<span class="op" id="7974194">:=</span>&nbsp;<span class="num" id="7974197">0</span><span class="op" id="7974198">;</span>&nbsp;<span class="ident" id="7974200">i</span>&nbsp;<span class="op" id="7974202">&lt;</span>&nbsp;<span class="ident" id="7974204">N</span><span class="op" id="7974205">;</span>&nbsp;<span class="ident" id="7974207">i</span><span class="op" id="7974208">++</span>&nbsp;<span class="op" id="7974211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7974215">wg</span><span class="op" id="7974217">.</span><span class="ident" id="7974218">Add</span><span class="op" id="7974221">(</span><span class="num" id="7974222">1</span><span class="op" id="7974223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7974227">go</span>&nbsp;<span class="keyword" id="7974230">func</span><span class="op" id="7974234">(</span><span class="op" id="7974235">)</span>&nbsp;<span class="op" id="7974237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7974242">defer</span>&nbsp;<span class="ident" id="7974248">wg</span><span class="op" id="7974250">.</span><span class="ident" id="7974251">Done</span><span class="op" id="7974255">(</span><span class="op" id="7974256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7974261">if</span>&nbsp;<span class="ident" id="7974264">c</span><span class="op" id="7974265">,</span>&nbsp;<span class="ident" id="7974267">err</span>&nbsp;<span class="op" id="7974271">:=</span>&nbsp;<span class="ident" id="7974274">dialMulti</span><span class="op" id="7974283">(</span><span class="string" id="7974284">&#34;tcp&#34;</span><span class="op" id="7974289">,</span>&nbsp;<span class="string" id="7974291">&#34;fast&nbsp;failover&nbsp;test&#34;</span><span class="op" id="7974311">,</span>&nbsp;<span class="ident" id="7974313">nil</span><span class="op" id="7974316">,</span>&nbsp;<span class="ident" id="7974318">ras</span><span class="op" id="7974321">,</span>&nbsp;<span class="ident" id="7974323">time</span><span class="op" id="7974327">.</span><span class="ident" id="7974328">Now</span><span class="op" id="7974331">(</span><span class="op" id="7974332">)</span><span class="op" id="7974333">.</span><span class="ident" id="7974334">Add</span><span class="op" id="7974337">(</span><span class="ident" id="7974338">T1</span><span class="op" id="7974340">)</span><span class="op" id="7974341">)</span><span class="op" id="7974342">;</span>&nbsp;<span class="ident" id="7974344">err</span>&nbsp;<span class="op" id="7974348">==</span>&nbsp;<span class="ident" id="7974351">nil</span>&nbsp;<span class="op" id="7974355">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7974361">c</span><span class="op" id="7974362">.</span><span class="ident" id="7974363">Close</span><span class="op" id="7974368">(</span><span class="op" id="7974369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7974374">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7974378">}</span><span class="op" id="7974379">(</span><span class="op" id="7974380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7974383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7974386">wg</span><span class="op" id="7974388">.</span><span class="ident" id="7974389">Wait</span><span class="op" id="7974393">(</span><span class="op" id="7974394">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7974397">time</span><span class="op" id="7974401">.</span><span class="ident" id="7974402">Sleep</span><span class="op" id="7974407">(</span><span class="ident" id="7974408">T2</span><span class="op" id="7974410">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7974414">ntcp</span><span class="op" id="7974418">,</span>&nbsp;<span class="ident" id="7974420">after</span><span class="op" id="7974425">,</span>&nbsp;<span class="ident" id="7974427">nclose</span><span class="op" id="7974433">,</span>&nbsp;<span class="ident" id="7974435">err</span>&nbsp;<span class="op" id="7974439">:=</span>&nbsp;<span class="ident" id="7974442">numTCP</span><span class="op" id="7974448">(</span><span class="op" id="7974449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7974452">if</span>&nbsp;<span class="ident" id="7974455">err</span>&nbsp;<span class="op" id="7974459">!=</span>&nbsp;<span class="ident" id="7974462">nil</span>&nbsp;<span class="op" id="7974466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7974470">t</span><span class="op" id="7974471">.</span><span class="ident" id="7974472">Skipf</span><span class="op" id="7974477">(</span><span class="string" id="7974478">&#34;skipping&nbsp;test;&nbsp;error&nbsp;finding&nbsp;or&nbsp;running&nbsp;lsof:&nbsp;%v&#34;</span><span class="op" id="7974528">,</span>&nbsp;<span class="ident" id="7974530">err</span><span class="op" id="7974533">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7974536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7974539">t</span><span class="op" id="7974540">.</span><span class="ident" id="7974541">Logf</span><span class="op" id="7974545">(</span><span class="string" id="7974546">&#34;tcp&nbsp;sessions:&nbsp;%v,&nbsp;open&nbsp;sessions:&nbsp;%v,&nbsp;closing&nbsp;sessions:&nbsp;%v&#34;</span><span class="op" id="7974605">,</span>&nbsp;<span class="ident" id="7974607">ntcp</span><span class="op" id="7974611">,</span>&nbsp;<span class="ident" id="7974613">after</span><span class="op" id="7974618">,</span>&nbsp;<span class="ident" id="7974620">nclose</span><span class="op" id="7974626">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7974630">if</span>&nbsp;<span class="ident" id="7974633">after</span>&nbsp;<span class="op" id="7974639">!=</span>&nbsp;<span class="ident" id="7974642">before</span>&nbsp;<span class="op" id="7974649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7974653">t</span><span class="op" id="7974654">.</span><span class="ident" id="7974655">Fatalf</span><span class="op" id="7974661">(</span><span class="string" id="7974662">&#34;got&nbsp;%v&nbsp;open&nbsp;sessions;&nbsp;expected&nbsp;%v&#34;</span><span class="op" id="7974697">,</span>&nbsp;<span class="ident" id="7974699">after</span><span class="op" id="7974704">,</span>&nbsp;<span class="ident" id="7974706">before</span><span class="op" id="7974712">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7974715">}</span><br>
<span class="lineno"></span><span class="op" id="7974717">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7974720">func</span>&nbsp;<span class="ident" id="7974725">numFD</span><span class="op" id="7974730">(</span><span class="op" id="7974731">)</span>&nbsp;<span class="builtintype" id="7974733">int</span>&nbsp;<span class="op" id="7974737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7974740">if</span>&nbsp;<span class="ident" id="7974743">runtime</span><span class="op" id="7974750">.</span><span class="ident" id="7974751">GOOS</span>&nbsp;<span class="op" id="7974756">==</span>&nbsp;<span class="string" id="7974759">&#34;linux&#34;</span>&nbsp;<span class="op" id="7974767">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7974771">f</span><span class="op" id="7974772">,</span>&nbsp;<span class="ident" id="7974774">err</span>&nbsp;<span class="op" id="7974778">:=</span>&nbsp;<span class="ident" id="7974781">os</span><span class="op" id="7974783">.</span><span class="ident" id="7974784">Open</span><span class="op" id="7974788">(</span><span class="string" id="7974789">&#34;/proc/self/fd&#34;</span><span class="op" id="7974804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7974808">if</span>&nbsp;<span class="ident" id="7974811">err</span>&nbsp;<span class="op" id="7974815">!=</span>&nbsp;<span class="ident" id="7974818">nil</span>&nbsp;<span class="op" id="7974822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7974827">panic</span><span class="op" id="7974832">(</span><span class="ident" id="7974833">err</span><span class="op" id="7974836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7974840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7974844">defer</span>&nbsp;<span class="ident" id="7974850">f</span><span class="op" id="7974851">.</span><span class="ident" id="7974852">Close</span><span class="op" id="7974857">(</span><span class="op" id="7974858">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7974862">names</span><span class="op" id="7974867">,</span>&nbsp;<span class="ident" id="7974869">err</span>&nbsp;<span class="op" id="7974873">:=</span>&nbsp;<span class="ident" id="7974876">f</span><span class="op" id="7974877">.</span><span class="ident" id="7974878">Readdirnames</span><span class="op" id="7974890">(</span><span class="num" id="7974891">0</span><span class="op" id="7974892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7974896">if</span>&nbsp;<span class="ident" id="7974899">err</span>&nbsp;<span class="op" id="7974903">!=</span>&nbsp;<span class="ident" id="7974906">nil</span>&nbsp;<span class="op" id="7974910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7974915">panic</span><span class="op" id="7974920">(</span><span class="ident" id="7974921">err</span><span class="op" id="7974924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7974928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7974932">return</span>&nbsp;<span class="builtinfunc" id="7974939">len</span><span class="op" id="7974942">(</span><span class="ident" id="7974943">names</span><span class="op" id="7974948">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7974951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7974954">//&nbsp;All&nbsp;tests&nbsp;using&nbsp;this&nbsp;should&nbsp;be&nbsp;skipped&nbsp;anyway,&nbsp;but:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7975010">panic</span><span class="op" id="7975015">(</span><span class="string" id="7975016">&#34;numFDs&nbsp;not&nbsp;implemented&nbsp;on&nbsp;&#34;</span>&nbsp;<span class="op" id="7975045">+</span>&nbsp;<span class="ident" id="7975047">runtime</span><span class="op" id="7975054">.</span><span class="ident" id="7975055">GOOS</span><span class="op" id="7975059">)</span><br>
<span class="lineno"></span><span class="op" id="7975061">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="keyword" id="7975064">func</span>&nbsp;<span class="ident" id="7975069">TestDialer</span><span class="op" id="7975079">(</span><span class="ident" id="7975080">t</span>&nbsp;<span class="op" id="7975082">*</span><span class="ident" id="7975083">testing</span><span class="op" id="7975090">.</span><span class="ident" id="7975091">T</span><span class="op" id="7975092">)</span>&nbsp;<span class="op" id="7975094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7975097">ln</span><span class="op" id="7975099">,</span>&nbsp;<span class="ident" id="7975101">err</span>&nbsp;<span class="op" id="7975105">:=</span>&nbsp;<span class="ident" id="7975108">Listen</span><span class="op" id="7975114">(</span><span class="string" id="7975115">&#34;tcp4&#34;</span><span class="op" id="7975121">,</span>&nbsp;<span class="string" id="7975123">&#34;127.0.0.1:0&#34;</span><span class="op" id="7975136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7975139">if</span>&nbsp;<span class="ident" id="7975142">err</span>&nbsp;<span class="op" id="7975146">!=</span>&nbsp;<span class="ident" id="7975149">nil</span>&nbsp;<span class="op" id="7975153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7975157">t</span><span class="op" id="7975158">.</span><span class="ident" id="7975159">Fatalf</span><span class="op" id="7975165">(</span><span class="string" id="7975166">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7975185">,</span>&nbsp;<span class="ident" id="7975187">err</span><span class="op" id="7975190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7975193">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7975196">defer</span>&nbsp;<span class="ident" id="7975202">ln</span><span class="op" id="7975204">.</span><span class="ident" id="7975205">Close</span><span class="op" id="7975210">(</span><span class="op" id="7975211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7975214">ch</span>&nbsp;<span class="op" id="7975217">:=</span>&nbsp;<span class="builtinfunc" id="7975220">make</span><span class="op" id="7975224">(</span><span class="keyword" id="7975225">chan</span>&nbsp;<span class="builtintype" id="7975230">error</span><span class="op" id="7975235">,</span>&nbsp;<span class="num" id="7975237">1</span><span class="op" id="7975238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7975241">go</span>&nbsp;<span class="keyword" id="7975244">func</span><span class="op" id="7975248">(</span><span class="op" id="7975249">)</span>&nbsp;<span class="op" id="7975251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7975255">c</span><span class="op" id="7975256">,</span>&nbsp;<span class="ident" id="7975258">err</span>&nbsp;<span class="op" id="7975262">:=</span>&nbsp;<span class="ident" id="7975265">ln</span><span class="op" id="7975267">.</span><span class="ident" id="7975268">Accept</span><span class="op" id="7975274">(</span><span class="op" id="7975275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7975279">if</span>&nbsp;<span class="ident" id="7975282">err</span>&nbsp;<span class="op" id="7975286">!=</span>&nbsp;<span class="ident" id="7975289">nil</span>&nbsp;<span class="op" id="7975293">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7975298">ch</span>&nbsp;<span class="op" id="7975301">&lt;-</span>&nbsp;<span class="ident" id="7975304">fmt</span><span class="op" id="7975307">.</span><span class="ident" id="7975308">Errorf</span><span class="op" id="7975314">(</span><span class="string" id="7975315">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7975334">,</span>&nbsp;<span class="ident" id="7975336">err</span><span class="op" id="7975339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7975344">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7975353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7975357">defer</span>&nbsp;<span class="ident" id="7975363">c</span><span class="op" id="7975364">.</span><span class="ident" id="7975365">Close</span><span class="op" id="7975370">(</span><span class="op" id="7975371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7975375">ch</span>&nbsp;<span class="op" id="7975378">&lt;-</span>&nbsp;<span class="ident" id="7975381">nil</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7975386">}</span><span class="op" id="7975387">(</span><span class="op" id="7975388">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7975392">laddr</span><span class="op" id="7975397">,</span>&nbsp;<span class="ident" id="7975399">err</span>&nbsp;<span class="op" id="7975403">:=</span>&nbsp;<span class="ident" id="7975406">ResolveTCPAddr</span><span class="op" id="7975420">(</span><span class="string" id="7975421">&#34;tcp4&#34;</span><span class="op" id="7975427">,</span>&nbsp;<span class="string" id="7975429">&#34;127.0.0.1:0&#34;</span><span class="op" id="7975442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7975445">if</span>&nbsp;<span class="ident" id="7975448">err</span>&nbsp;<span class="op" id="7975452">!=</span>&nbsp;<span class="ident" id="7975455">nil</span>&nbsp;<span class="op" id="7975459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7975463">t</span><span class="op" id="7975464">.</span><span class="ident" id="7975465">Fatalf</span><span class="op" id="7975471">(</span><span class="string" id="7975472">&#34;ResolveTCPAddr&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7975499">,</span>&nbsp;<span class="ident" id="7975501">err</span><span class="op" id="7975504">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7975507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7975510">d</span>&nbsp;<span class="op" id="7975512">:=</span>&nbsp;<span class="op" id="7975515">&amp;</span><span class="ident" id="7975516">Dialer</span><span class="op" id="7975522">{</span><span class="ident" id="7975523">LocalAddr</span><span class="op" id="7975532">:</span>&nbsp;<span class="ident" id="7975534">laddr</span><span class="op" id="7975539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7975542">c</span><span class="op" id="7975543">,</span>&nbsp;<span class="ident" id="7975545">err</span>&nbsp;<span class="op" id="7975549">:=</span>&nbsp;<span class="ident" id="7975552">d</span><span class="op" id="7975553">.</span><span class="ident" id="7975554">Dial</span><span class="op" id="7975558">(</span><span class="string" id="7975559">&#34;tcp4&#34;</span><span class="op" id="7975565">,</span>&nbsp;<span class="ident" id="7975567">ln</span><span class="op" id="7975569">.</span><span class="ident" id="7975570">Addr</span><span class="op" id="7975574">(</span><span class="op" id="7975575">)</span><span class="op" id="7975576">.</span><span class="ident" id="7975577">String</span><span class="op" id="7975583">(</span><span class="op" id="7975584">)</span><span class="op" id="7975585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7975588">if</span>&nbsp;<span class="ident" id="7975591">err</span>&nbsp;<span class="op" id="7975595">!=</span>&nbsp;<span class="ident" id="7975598">nil</span>&nbsp;<span class="op" id="7975602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7975606">t</span><span class="op" id="7975607">.</span><span class="ident" id="7975608">Fatalf</span><span class="op" id="7975614">(</span><span class="string" id="7975615">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7975632">,</span>&nbsp;<span class="ident" id="7975634">err</span><span class="op" id="7975637">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7975640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7975643">defer</span>&nbsp;<span class="ident" id="7975649">c</span><span class="op" id="7975650">.</span><span class="ident" id="7975651">Close</span><span class="op" id="7975656">(</span><span class="op" id="7975657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7975660">c</span><span class="op" id="7975661">.</span><span class="ident" id="7975662">Read</span><span class="op" id="7975666">(</span><span class="builtinfunc" id="7975667">make</span><span class="op" id="7975671">(</span><span class="op" id="7975672">[</span><span class="op" id="7975673">]</span><span class="builtintype" id="7975674">byte</span><span class="op" id="7975678">,</span>&nbsp;<span class="num" id="7975680">1</span><span class="op" id="7975681">)</span><span class="op" id="7975682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7975685">err</span>&nbsp;<span class="op" id="7975689">=</span>&nbsp;<span class="op" id="7975691">&lt;-</span><span class="ident" id="7975693">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7975697">if</span>&nbsp;<span class="ident" id="7975700">err</span>&nbsp;<span class="op" id="7975704">!=</span>&nbsp;<span class="ident" id="7975707">nil</span>&nbsp;<span class="op" id="7975711">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7975715">t</span><span class="op" id="7975716">.</span><span class="ident" id="7975717">Error</span><span class="op" id="7975722">(</span><span class="ident" id="7975723">err</span><span class="op" id="7975726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7975729">}</span><br>
<span class="lineno"></span><span class="op" id="7975731">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7975734">func</span>&nbsp;<span class="ident" id="7975739">TestDialDualStackLocalhost</span><span class="op" id="7975765">(</span><span class="ident" id="7975766">t</span>&nbsp;<span class="op" id="7975768">*</span><span class="ident" id="7975769">testing</span><span class="op" id="7975776">.</span><span class="ident" id="7975777">T</span><span class="op" id="7975778">)</span>&nbsp;<span class="op" id="7975780">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7975783">switch</span>&nbsp;<span class="ident" id="7975790">runtime</span><span class="op" id="7975797">.</span><span class="ident" id="7975798">GOOS</span>&nbsp;<span class="op" id="7975803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7975806">case</span>&nbsp;<span class="string" id="7975811">&#34;nacl&#34;</span><span class="op" id="7975817">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7975821">t</span><span class="op" id="7975822">.</span><span class="ident" id="7975823">Skipf</span><span class="op" id="7975828">(</span><span class="string" id="7975829">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7975850">,</span>&nbsp;<span class="ident" id="7975852">runtime</span><span class="op" id="7975859">.</span><span class="ident" id="7975860">GOOS</span><span class="op" id="7975864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7975867">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7975871">if</span>&nbsp;<span class="ident" id="7975874">ips</span><span class="op" id="7975877">,</span>&nbsp;<span class="ident" id="7975879">err</span>&nbsp;<span class="op" id="7975883">:=</span>&nbsp;<span class="ident" id="7975886">LookupIP</span><span class="op" id="7975894">(</span><span class="string" id="7975895">&#34;localhost&#34;</span><span class="op" id="7975906">)</span><span class="op" id="7975907">;</span>&nbsp;<span class="ident" id="7975909">err</span>&nbsp;<span class="op" id="7975913">!=</span>&nbsp;<span class="ident" id="7975916">nil</span>&nbsp;<span class="op" id="7975920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7975924">t</span><span class="op" id="7975925">.</span><span class="ident" id="7975926">Fatalf</span><span class="op" id="7975932">(</span><span class="string" id="7975933">&#34;LookupIP&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7975954">,</span>&nbsp;<span class="ident" id="7975956">err</span><span class="op" id="7975959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7975962">}</span>&nbsp;<span class="keyword" id="7975964">else</span>&nbsp;<span class="keyword" id="7975969">if</span>&nbsp;<span class="builtinfunc" id="7975972">len</span><span class="op" id="7975975">(</span><span class="ident" id="7975976">ips</span><span class="op" id="7975979">)</span>&nbsp;<span class="op" id="7975981">&lt;</span>&nbsp;<span class="num" id="7975983">2</span>&nbsp;<span class="op" id="7975985">||</span>&nbsp;<span class="op" id="7975988">!</span><span class="ident" id="7975989">supportsIPv4</span>&nbsp;<span class="op" id="7976002">||</span>&nbsp;<span class="op" id="7976005">!</span><span class="ident" id="7976006">supportsIPv6</span>&nbsp;<span class="op" id="7976019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7976023">t</span><span class="op" id="7976024">.</span><span class="ident" id="7976025">Skip</span><span class="op" id="7976029">(</span><span class="string" id="7976030">&#34;localhost&nbsp;doesn&#39;t&nbsp;have&nbsp;a&nbsp;pair&nbsp;of&nbsp;different&nbsp;address&nbsp;family&nbsp;IP&nbsp;addresses&#34;</span><span class="op" id="7976102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7976105">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7976109">touchAndByeServer</span>&nbsp;<span class="op" id="7976127">:=</span>&nbsp;<span class="keyword" id="7976130">func</span><span class="op" id="7976134">(</span><span class="ident" id="7976135">dss</span>&nbsp;<span class="op" id="7976139">*</span><span class="ident" id="7976140">dualStackServer</span><span class="op" id="7976155">,</span>&nbsp;<span class="ident" id="7976157">ln</span>&nbsp;<span class="ident" id="7976160">Listener</span><span class="op" id="7976168">)</span>&nbsp;<span class="op" id="7976170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7976174">for</span>&nbsp;<span class="op" id="7976178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7976183">if</span>&nbsp;<span class="ident" id="7976186">c</span><span class="op" id="7976187">,</span>&nbsp;<span class="ident" id="7976189">err</span>&nbsp;<span class="op" id="7976193">:=</span>&nbsp;<span class="ident" id="7976196">ln</span><span class="op" id="7976198">.</span><span class="ident" id="7976199">Accept</span><span class="op" id="7976205">(</span><span class="op" id="7976206">)</span><span class="op" id="7976207">;</span>&nbsp;<span class="ident" id="7976209">err</span>&nbsp;<span class="op" id="7976213">!=</span>&nbsp;<span class="ident" id="7976216">nil</span>&nbsp;<span class="op" id="7976220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7976226">return</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7976236">}</span>&nbsp;<span class="keyword" id="7976238">else</span>&nbsp;<span class="op" id="7976243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7976249">c</span><span class="op" id="7976250">.</span><span class="ident" id="7976251">Close</span><span class="op" id="7976256">(</span><span class="op" id="7976257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7976262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7976266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7976269">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7976272">dss</span><span class="op" id="7976275">,</span>&nbsp;<span class="ident" id="7976277">err</span>&nbsp;<span class="op" id="7976281">:=</span>&nbsp;<span class="ident" id="7976284">newDualStackServer</span><span class="op" id="7976302">(</span><span class="op" id="7976303">[</span><span class="op" id="7976304">]</span><span class="ident" id="7976305">streamListener</span><span class="op" id="7976319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7976323">{</span><span class="ident" id="7976324">net</span><span class="op" id="7976327">:</span>&nbsp;<span class="string" id="7976329">&#34;tcp4&#34;</span><span class="op" id="7976335">,</span>&nbsp;<span class="ident" id="7976337">addr</span><span class="op" id="7976341">:</span>&nbsp;<span class="string" id="7976343">&#34;127.0.0.1&#34;</span><span class="op" id="7976354">}</span><span class="op" id="7976355">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7976359">{</span><span class="ident" id="7976360">net</span><span class="op" id="7976363">:</span>&nbsp;<span class="string" id="7976365">&#34;tcp6&#34;</span><span class="op" id="7976371">,</span>&nbsp;<span class="ident" id="7976373">addr</span><span class="op" id="7976377">:</span>&nbsp;<span class="string" id="7976379">&#34;[::1]&#34;</span><span class="op" id="7976386">}</span><span class="op" id="7976387">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7976390">}</span><span class="op" id="7976391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7976394">if</span>&nbsp;<span class="ident" id="7976397">err</span>&nbsp;<span class="op" id="7976401">!=</span>&nbsp;<span class="ident" id="7976404">nil</span>&nbsp;<span class="op" id="7976408">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7976412">t</span><span class="op" id="7976413">.</span><span class="ident" id="7976414">Fatalf</span><span class="op" id="7976420">(</span><span class="string" id="7976421">&#34;newDualStackServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7976452">,</span>&nbsp;<span class="ident" id="7976454">err</span><span class="op" id="7976457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7976460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7976463">defer</span>&nbsp;<span class="ident" id="7976469">dss</span><span class="op" id="7976472">.</span><span class="ident" id="7976473">teardown</span><span class="op" id="7976481">(</span><span class="op" id="7976482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7976485">if</span>&nbsp;<span class="ident" id="7976488">err</span>&nbsp;<span class="op" id="7976492">:=</span>&nbsp;<span class="ident" id="7976495">dss</span><span class="op" id="7976498">.</span><span class="ident" id="7976499">buildup</span><span class="op" id="7976506">(</span><span class="ident" id="7976507">touchAndByeServer</span><span class="op" id="7976524">)</span><span class="op" id="7976525">;</span>&nbsp;<span class="ident" id="7976527">err</span>&nbsp;<span class="op" id="7976531">!=</span>&nbsp;<span class="ident" id="7976534">nil</span>&nbsp;<span class="op" id="7976538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7976542">t</span><span class="op" id="7976543">.</span><span class="ident" id="7976544">Fatalf</span><span class="op" id="7976550">(</span><span class="string" id="7976551">&#34;dualStackServer.buildup&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7976587">,</span>&nbsp;<span class="ident" id="7976589">err</span><span class="op" id="7976592">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7976595">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7976599">d</span>&nbsp;<span class="op" id="7976601">:=</span>&nbsp;<span class="op" id="7976604">&amp;</span><span class="ident" id="7976605">Dialer</span><span class="op" id="7976611">{</span><span class="ident" id="7976612">DualStack</span><span class="op" id="7976621">:</span>&nbsp;<span class="builtintype" id="7976623">true</span><span class="op" id="7976627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7976630">for</span>&nbsp;<span class="keyword" id="7976634">range</span>&nbsp;<span class="ident" id="7976640">dss</span><span class="op" id="7976643">.</span><span class="ident" id="7976644">lns</span>&nbsp;<span class="op" id="7976648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7976652">if</span>&nbsp;<span class="ident" id="7976655">c</span><span class="op" id="7976656">,</span>&nbsp;<span class="ident" id="7976658">err</span>&nbsp;<span class="op" id="7976662">:=</span>&nbsp;<span class="ident" id="7976665">d</span><span class="op" id="7976666">.</span><span class="ident" id="7976667">Dial</span><span class="op" id="7976671">(</span><span class="string" id="7976672">&#34;tcp&#34;</span><span class="op" id="7976677">,</span>&nbsp;<span class="string" id="7976679">&#34;localhost:&#34;</span><span class="op" id="7976691">+</span><span class="ident" id="7976692">dss</span><span class="op" id="7976695">.</span><span class="ident" id="7976696">port</span><span class="op" id="7976700">)</span><span class="op" id="7976701">;</span>&nbsp;<span class="ident" id="7976703">err</span>&nbsp;<span class="op" id="7976707">!=</span>&nbsp;<span class="ident" id="7976710">nil</span>&nbsp;<span class="op" id="7976714">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7976719">t</span><span class="op" id="7976720">.</span><span class="ident" id="7976721">Errorf</span><span class="op" id="7976727">(</span><span class="string" id="7976728">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7976745">,</span>&nbsp;<span class="ident" id="7976747">err</span><span class="op" id="7976750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7976754">}</span>&nbsp;<span class="keyword" id="7976756">else</span>&nbsp;<span class="op" id="7976761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7976766">if</span>&nbsp;<span class="ident" id="7976769">addr</span>&nbsp;<span class="op" id="7976774">:=</span>&nbsp;<span class="ident" id="7976777">c</span><span class="op" id="7976778">.</span><span class="ident" id="7976779">LocalAddr</span><span class="op" id="7976788">(</span><span class="op" id="7976789">)</span><span class="op" id="7976790">.</span><span class="op" id="7976791">(</span><span class="op" id="7976792">*</span><span class="ident" id="7976793">TCPAddr</span><span class="op" id="7976800">)</span><span class="op" id="7976801">;</span>&nbsp;<span class="ident" id="7976803">addr</span><span class="op" id="7976807">.</span><span class="ident" id="7976808">IP</span><span class="op" id="7976810">.</span><span class="ident" id="7976811">To4</span><span class="op" id="7976814">(</span><span class="op" id="7976815">)</span>&nbsp;<span class="op" id="7976817">!=</span>&nbsp;<span class="ident" id="7976820">nil</span>&nbsp;<span class="op" id="7976824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7976830">dss</span><span class="op" id="7976833">.</span><span class="ident" id="7976834">teardownNetwork</span><span class="op" id="7976849">(</span><span class="string" id="7976850">&#34;tcp4&#34;</span><span class="op" id="7976856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7976861">}</span>&nbsp;<span class="keyword" id="7976863">else</span>&nbsp;<span class="keyword" id="7976868">if</span>&nbsp;<span class="ident" id="7976871">addr</span><span class="op" id="7976875">.</span><span class="ident" id="7976876">IP</span><span class="op" id="7976878">.</span><span class="ident" id="7976879">To16</span><span class="op" id="7976883">(</span><span class="op" id="7976884">)</span>&nbsp;<span class="op" id="7976886">!=</span>&nbsp;<span class="ident" id="7976889">nil</span>&nbsp;<span class="op" id="7976893">&amp;&amp;</span>&nbsp;<span class="ident" id="7976896">addr</span><span class="op" id="7976900">.</span><span class="ident" id="7976901">IP</span><span class="op" id="7976903">.</span><span class="ident" id="7976904">To4</span><span class="op" id="7976907">(</span><span class="op" id="7976908">)</span>&nbsp;<span class="op" id="7976910">==</span>&nbsp;<span class="ident" id="7976913">nil</span>&nbsp;<span class="op" id="7976917">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7976923">dss</span><span class="op" id="7976926">.</span><span class="ident" id="7976927">teardownNetwork</span><span class="op" id="7976942">(</span><span class="string" id="7976943">&#34;tcp6&#34;</span><span class="op" id="7976949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7976954">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7976959">c</span><span class="op" id="7976960">.</span><span class="ident" id="7976961">Close</span><span class="op" id="7976966">(</span><span class="op" id="7976967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7976971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7976974">}</span><br>
<span class="lineno">515</span><span class="op" id="7976976">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7976979">func</span>&nbsp;<span class="ident" id="7976984">TestDialerKeepAlive</span><span class="op" id="7977003">(</span><span class="ident" id="7977004">t</span>&nbsp;<span class="op" id="7977006">*</span><span class="ident" id="7977007">testing</span><span class="op" id="7977014">.</span><span class="ident" id="7977015">T</span><span class="op" id="7977016">)</span>&nbsp;<span class="op" id="7977018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7977021">ln</span>&nbsp;<span class="op" id="7977024">:=</span>&nbsp;<span class="ident" id="7977027">newLocalListener</span><span class="op" id="7977043">(</span><span class="ident" id="7977044">t</span><span class="op" id="7977045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7977048">defer</span>&nbsp;<span class="ident" id="7977054">ln</span><span class="op" id="7977056">.</span><span class="ident" id="7977057">Close</span><span class="op" id="7977062">(</span><span class="op" id="7977063">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7977066">defer</span>&nbsp;<span class="keyword" id="7977072">func</span><span class="op" id="7977076">(</span><span class="op" id="7977077">)</span>&nbsp;<span class="op" id="7977079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7977083">testHookSetKeepAlive</span>&nbsp;<span class="op" id="7977104">=</span>&nbsp;<span class="keyword" id="7977106">func</span><span class="op" id="7977110">(</span><span class="op" id="7977111">)</span>&nbsp;<span class="op" id="7977113">{</span><span class="op" id="7977114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7977117">}</span><span class="op" id="7977118">(</span><span class="op" id="7977119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7977122">go</span>&nbsp;<span class="keyword" id="7977125">func</span><span class="op" id="7977129">(</span><span class="op" id="7977130">)</span>&nbsp;<span class="op" id="7977132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7977136">for</span>&nbsp;<span class="op" id="7977140">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7977145">c</span><span class="op" id="7977146">,</span>&nbsp;<span class="ident" id="7977148">err</span>&nbsp;<span class="op" id="7977152">:=</span>&nbsp;<span class="ident" id="7977155">ln</span><span class="op" id="7977157">.</span><span class="ident" id="7977158">Accept</span><span class="op" id="7977164">(</span><span class="op" id="7977165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7977170">if</span>&nbsp;<span class="ident" id="7977173">err</span>&nbsp;<span class="op" id="7977177">!=</span>&nbsp;<span class="ident" id="7977180">nil</span>&nbsp;<span class="op" id="7977184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7977190">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7977200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7977205">c</span><span class="op" id="7977206">.</span><span class="ident" id="7977207">Close</span><span class="op" id="7977212">(</span><span class="op" id="7977213">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7977217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7977220">}</span><span class="op" id="7977221">(</span><span class="op" id="7977222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7977225">for</span>&nbsp;<span class="ident" id="7977229">_</span><span class="op" id="7977230">,</span>&nbsp;<span class="ident" id="7977232">keepAlive</span>&nbsp;<span class="op" id="7977242">:=</span>&nbsp;<span class="keyword" id="7977245">range</span>&nbsp;<span class="op" id="7977251">[</span><span class="op" id="7977252">]</span><span class="builtintype" id="7977253">bool</span><span class="op" id="7977257">{</span><span class="builtintype" id="7977258">false</span><span class="op" id="7977263">,</span>&nbsp;<span class="builtintype" id="7977265">true</span><span class="op" id="7977269">}</span>&nbsp;<span class="op" id="7977271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7977275">got</span>&nbsp;<span class="op" id="7977279">:=</span>&nbsp;<span class="builtintype" id="7977282">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7977290">testHookSetKeepAlive</span>&nbsp;<span class="op" id="7977311">=</span>&nbsp;<span class="keyword" id="7977313">func</span><span class="op" id="7977317">(</span><span class="op" id="7977318">)</span>&nbsp;<span class="op" id="7977320">{</span>&nbsp;<span class="ident" id="7977322">got</span>&nbsp;<span class="op" id="7977326">=</span>&nbsp;<span class="builtintype" id="7977328">true</span>&nbsp;<span class="op" id="7977333">}</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7977337">var</span>&nbsp;<span class="ident" id="7977341">d</span>&nbsp;<span class="ident" id="7977343">Dialer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7977352">if</span>&nbsp;<span class="ident" id="7977355">keepAlive</span>&nbsp;<span class="op" id="7977365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7977370">d</span><span class="op" id="7977371">.</span><span class="ident" id="7977372">KeepAlive</span>&nbsp;<span class="op" id="7977382">=</span>&nbsp;<span class="num" id="7977384">30</span>&nbsp;<span class="op" id="7977387">*</span>&nbsp;<span class="ident" id="7977389">time</span><span class="op" id="7977393">.</span><span class="ident" id="7977394">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7977403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7977407">c</span><span class="op" id="7977408">,</span>&nbsp;<span class="ident" id="7977410">err</span>&nbsp;<span class="op" id="7977414">:=</span>&nbsp;<span class="ident" id="7977417">d</span><span class="op" id="7977418">.</span><span class="ident" id="7977419">Dial</span><span class="op" id="7977423">(</span><span class="string" id="7977424">&#34;tcp&#34;</span><span class="op" id="7977429">,</span>&nbsp;<span class="ident" id="7977431">ln</span><span class="op" id="7977433">.</span><span class="ident" id="7977434">Addr</span><span class="op" id="7977438">(</span><span class="op" id="7977439">)</span><span class="op" id="7977440">.</span><span class="ident" id="7977441">String</span><span class="op" id="7977447">(</span><span class="op" id="7977448">)</span><span class="op" id="7977449">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7977453">if</span>&nbsp;<span class="ident" id="7977456">err</span>&nbsp;<span class="op" id="7977460">!=</span>&nbsp;<span class="ident" id="7977463">nil</span>&nbsp;<span class="op" id="7977467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7977472">t</span><span class="op" id="7977473">.</span><span class="ident" id="7977474">Fatal</span><span class="op" id="7977479">(</span><span class="ident" id="7977480">err</span><span class="op" id="7977483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7977487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7977491">c</span><span class="op" id="7977492">.</span><span class="ident" id="7977493">Close</span><span class="op" id="7977498">(</span><span class="op" id="7977499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7977503">if</span>&nbsp;<span class="ident" id="7977506">got</span>&nbsp;<span class="op" id="7977510">!=</span>&nbsp;<span class="ident" id="7977513">keepAlive</span>&nbsp;<span class="op" id="7977523">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7977528">t</span><span class="op" id="7977529">.</span><span class="ident" id="7977530">Errorf</span><span class="op" id="7977536">(</span><span class="string" id="7977537">&#34;Dialer.KeepAlive&nbsp;=&nbsp;%v:&nbsp;SetKeepAlive&nbsp;called&nbsp;=&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7977595">,</span>&nbsp;<span class="ident" id="7977597">d</span><span class="op" id="7977598">.</span><span class="ident" id="7977599">KeepAlive</span><span class="op" id="7977608">,</span>&nbsp;<span class="ident" id="7977610">got</span><span class="op" id="7977613">,</span>&nbsp;<span class="op" id="7977615">!</span><span class="ident" id="7977616">got</span><span class="op" id="7977619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7977623">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7977626">}</span><br>
<span class="lineno"></span><span class="op" id="7977628">}</span>
</div>
</body>
</html>
