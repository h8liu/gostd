<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>mime/multipart</h2>
<ul>
<li><a href="/gostd/mime/multipart/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/mime/multipart/formdata.go.html">formdata.go</a></li>
<li><a href="/gostd/mime/multipart/formdata_test.go.html">formdata_test.go</a></li>
<li><a href="/gostd/mime/multipart/multipart.go.html" class="current">multipart.go</a></li>
<li><a href="/gostd/mime/multipart/multipart_test.go.html">multipart_test.go</a></li>
<li><a href="/gostd/mime/multipart/quotedprintable.go.html">quotedprintable.go</a></li>
<li><a href="/gostd/mime/multipart/quotedprintable_test.go.html">quotedprintable_test.go</a></li>
<li><a href="/gostd/mime/multipart/writer.go.html">writer.go</a></li>
<li><a href="/gostd/mime/multipart/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3481891">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3481946">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3482000">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="3482050">//</span><br>
<span class="lineno">5</span><br>
<span class="lineno"></span><span class="comment" id="3482054">/*<br>
<span class="lineno"></span>Package&nbsp;multipart&nbsp;implements&nbsp;MIME&nbsp;multipart&nbsp;parsing,&nbsp;as&nbsp;defined&nbsp;in&nbsp;RFC<br>
<span class="lineno"></span>2046.<br>
<span class="lineno"></span><br>
<span class="lineno">10</span>The&nbsp;implementation&nbsp;is&nbsp;sufficient&nbsp;for&nbsp;HTTP&nbsp;(RFC&nbsp;2388)&nbsp;and&nbsp;the&nbsp;multipart<br>
<span class="lineno"></span>bodies&nbsp;generated&nbsp;by&nbsp;popular&nbsp;browsers.<br>
<span class="lineno"></span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="3482247">package</span>&nbsp;<span class="ident" id="3482255">multipart</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="3482266">import</span>&nbsp;<span class="op" id="3482273">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3482276">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3482285">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3482294">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3482301">&#34;io&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3482307">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3482320">&#34;mime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3482328">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span><span class="op" id="3482344">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="3482347">var</span>&nbsp;<span class="ident" id="3482351">emptyParams</span>&nbsp;<span class="op" id="3482363">=</span>&nbsp;<span class="builtinfunc" id="3482365">make</span><span class="op" id="3482369">(</span><span class="keyword" id="3482370">map</span><span class="op" id="3482373">[</span><span class="builtintype" id="3482374">string</span><span class="op" id="3482380">]</span><span class="builtintype" id="3482381">string</span><span class="op" id="3482387">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3482390">//&nbsp;A&nbsp;Part&nbsp;represents&nbsp;a&nbsp;single&nbsp;part&nbsp;in&nbsp;a&nbsp;multipart&nbsp;body.</span><br>
<span class="lineno"></span><span class="keyword" id="3482446">type</span>&nbsp;<span class="ident" id="3482451">Part</span>&nbsp;<span class="keyword" id="3482456">struct</span>&nbsp;<span class="op" id="3482463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3482466">//&nbsp;The&nbsp;headers&nbsp;of&nbsp;the&nbsp;body,&nbsp;if&nbsp;any,&nbsp;with&nbsp;the&nbsp;keys&nbsp;canonicalized</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3482531">//&nbsp;in&nbsp;the&nbsp;same&nbsp;fashion&nbsp;that&nbsp;the&nbsp;Go&nbsp;http.Request&nbsp;headers&nbsp;are.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3482593">//&nbsp;For&nbsp;example,&nbsp;&#34;foo-bar&#34;&nbsp;changes&nbsp;case&nbsp;to&nbsp;&#34;Foo-Bar&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3482646">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3482650">//&nbsp;As&nbsp;a&nbsp;special&nbsp;case,&nbsp;if&nbsp;the&nbsp;&#34;Content-Transfer-Encoding&#34;&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3482715">//&nbsp;has&nbsp;a&nbsp;value&nbsp;of&nbsp;&#34;quoted-printable&#34;,&nbsp;that&nbsp;header&nbsp;is&nbsp;instead</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3482777">//&nbsp;hidden&nbsp;from&nbsp;this&nbsp;map&nbsp;and&nbsp;the&nbsp;body&nbsp;is&nbsp;transparently&nbsp;decoded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3482840">//&nbsp;during&nbsp;Read&nbsp;calls.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3482863">Header</span>&nbsp;<span class="ident" id="3482870">textproto</span><span class="op" id="3482879">.</span><span class="ident" id="3482880">MIMEHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3482893">buffer</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3482903">*</span><span class="ident" id="3482904">bytes</span><span class="op" id="3482909">.</span><span class="ident" id="3482910">Buffer</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3482918">mr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3482928">*</span><span class="ident" id="3482929">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3482937">bytesRead</span>&nbsp;<span class="builtintype" id="3482947">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3482953">disposition</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3482971">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3482979">dispositionParams</span>&nbsp;<span class="keyword" id="3482997">map</span><span class="op" id="3483000">[</span><span class="builtintype" id="3483001">string</span><span class="op" id="3483007">]</span><span class="builtintype" id="3483008">string</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3483017">//&nbsp;r&nbsp;is&nbsp;either&nbsp;a&nbsp;reader&nbsp;directly&nbsp;reading&nbsp;from&nbsp;mr,&nbsp;or&nbsp;it&#39;s&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3483078">//&nbsp;wrapper&nbsp;around&nbsp;such&nbsp;a&nbsp;reader,&nbsp;decoding&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3483125">//&nbsp;Content-Transfer-Encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3483155">r</span>&nbsp;<span class="ident" id="3483157">io</span><span class="op" id="3483159">.</span><span class="ident" id="3483160">Reader</span><br>
<span class="lineno">50</span><span class="op" id="3483167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3483170">//&nbsp;FormName&nbsp;returns&nbsp;the&nbsp;name&nbsp;parameter&nbsp;if&nbsp;p&nbsp;has&nbsp;a&nbsp;Content-Disposition</span><br>
<span class="lineno"></span><span class="comment" id="3483240">//&nbsp;of&nbsp;type&nbsp;&#34;form-data&#34;.&nbsp;&nbsp;Otherwise&nbsp;it&nbsp;returns&nbsp;the&nbsp;empty&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="3483304">func</span>&nbsp;<span class="op" id="3483309">(</span><span class="ident" id="3483310">p</span>&nbsp;<span class="op" id="3483312">*</span><span class="ident" id="3483313">Part</span><span class="op" id="3483317">)</span>&nbsp;<span class="ident" id="3483319">FormName</span><span class="op" id="3483327">(</span><span class="op" id="3483328">)</span>&nbsp;<span class="builtintype" id="3483330">string</span>&nbsp;<span class="op" id="3483337">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3483340">//&nbsp;See&nbsp;http://tools.ietf.org/html/rfc2183&nbsp;section&nbsp;2&nbsp;for&nbsp;EBNF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3483402">//&nbsp;of&nbsp;Content-Disposition&nbsp;value&nbsp;format.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3483443">if</span>&nbsp;<span class="ident" id="3483446">p</span><span class="op" id="3483447">.</span><span class="ident" id="3483448">dispositionParams</span>&nbsp;<span class="op" id="3483466">==</span>&nbsp;<span class="builtintype" id="3483469">nil</span>&nbsp;<span class="op" id="3483473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3483477">p</span><span class="op" id="3483478">.</span><span class="ident" id="3483479">parseContentDisposition</span><span class="op" id="3483502">(</span><span class="op" id="3483503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3483506">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3483509">if</span>&nbsp;<span class="ident" id="3483512">p</span><span class="op" id="3483513">.</span><span class="ident" id="3483514">disposition</span>&nbsp;<span class="op" id="3483526">!=</span>&nbsp;<span class="string" id="3483529">&#34;form-data&#34;</span>&nbsp;<span class="op" id="3483541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3483545">return</span>&nbsp;<span class="string" id="3483552">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3483556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3483559">return</span>&nbsp;<span class="ident" id="3483566">p</span><span class="op" id="3483567">.</span><span class="ident" id="3483568">dispositionParams</span><span class="op" id="3483585">[</span><span class="string" id="3483586">&#34;name&#34;</span><span class="op" id="3483592">]</span><br>
<span class="lineno"></span><span class="op" id="3483594">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="3483597">//&nbsp;FileName&nbsp;returns&nbsp;the&nbsp;filename&nbsp;parameter&nbsp;of&nbsp;the&nbsp;Part&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3483654">//&nbsp;Content-Disposition&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="3483685">func</span>&nbsp;<span class="op" id="3483690">(</span><span class="ident" id="3483691">p</span>&nbsp;<span class="op" id="3483693">*</span><span class="ident" id="3483694">Part</span><span class="op" id="3483698">)</span>&nbsp;<span class="ident" id="3483700">FileName</span><span class="op" id="3483708">(</span><span class="op" id="3483709">)</span>&nbsp;<span class="builtintype" id="3483711">string</span>&nbsp;<span class="op" id="3483718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3483721">if</span>&nbsp;<span class="ident" id="3483724">p</span><span class="op" id="3483725">.</span><span class="ident" id="3483726">dispositionParams</span>&nbsp;<span class="op" id="3483744">==</span>&nbsp;<span class="builtintype" id="3483747">nil</span>&nbsp;<span class="op" id="3483751">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3483755">p</span><span class="op" id="3483756">.</span><span class="ident" id="3483757">parseContentDisposition</span><span class="op" id="3483780">(</span><span class="op" id="3483781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3483784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3483787">return</span>&nbsp;<span class="ident" id="3483794">p</span><span class="op" id="3483795">.</span><span class="ident" id="3483796">dispositionParams</span><span class="op" id="3483813">[</span><span class="string" id="3483814">&#34;filename&#34;</span><span class="op" id="3483824">]</span><br>
<span class="lineno"></span><span class="op" id="3483826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="keyword" id="3483829">func</span>&nbsp;<span class="op" id="3483834">(</span><span class="ident" id="3483835">p</span>&nbsp;<span class="op" id="3483837">*</span><span class="ident" id="3483838">Part</span><span class="op" id="3483842">)</span>&nbsp;<span class="ident" id="3483844">parseContentDisposition</span><span class="op" id="3483867">(</span><span class="op" id="3483868">)</span>&nbsp;<span class="op" id="3483870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3483873">v</span>&nbsp;<span class="op" id="3483875">:=</span>&nbsp;<span class="ident" id="3483878">p</span><span class="op" id="3483879">.</span><span class="ident" id="3483880">Header</span><span class="op" id="3483886">.</span><span class="ident" id="3483887">Get</span><span class="op" id="3483890">(</span><span class="string" id="3483891">&#34;Content-Disposition&#34;</span><span class="op" id="3483912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3483915">var</span>&nbsp;<span class="ident" id="3483919">err</span>&nbsp;<span class="builtintype" id="3483923">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3483930">p</span><span class="op" id="3483931">.</span><span class="ident" id="3483932">disposition</span><span class="op" id="3483943">,</span>&nbsp;<span class="ident" id="3483945">p</span><span class="op" id="3483946">.</span><span class="ident" id="3483947">dispositionParams</span><span class="op" id="3483964">,</span>&nbsp;<span class="ident" id="3483966">err</span>&nbsp;<span class="op" id="3483970">=</span>&nbsp;<span class="ident" id="3483972">mime</span><span class="op" id="3483976">.</span><span class="ident" id="3483977">ParseMediaType</span><span class="op" id="3483991">(</span><span class="ident" id="3483992">v</span><span class="op" id="3483993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3483996">if</span>&nbsp;<span class="ident" id="3483999">err</span>&nbsp;<span class="op" id="3484003">!=</span>&nbsp;<span class="builtintype" id="3484006">nil</span>&nbsp;<span class="op" id="3484010">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3484014">p</span><span class="op" id="3484015">.</span><span class="ident" id="3484016">dispositionParams</span>&nbsp;<span class="op" id="3484034">=</span>&nbsp;<span class="ident" id="3484036">emptyParams</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3484049">}</span><br>
<span class="lineno"></span><span class="op" id="3484051">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3484054">//&nbsp;NewReader&nbsp;creates&nbsp;a&nbsp;new&nbsp;multipart&nbsp;Reader&nbsp;reading&nbsp;from&nbsp;r&nbsp;using&nbsp;the</span><br>
<span class="lineno">85</span><span class="comment" id="3484123">//&nbsp;given&nbsp;MIME&nbsp;boundary.</span><br>
<span class="lineno"></span><span class="comment" id="3484147">//</span><br>
<span class="lineno"></span><span class="comment" id="3484150">//&nbsp;The&nbsp;boundary&nbsp;is&nbsp;usually&nbsp;obtained&nbsp;from&nbsp;the&nbsp;&#34;boundary&#34;&nbsp;parameter&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3484219">//&nbsp;the&nbsp;message&#39;s&nbsp;&#34;Content-Type&#34;&nbsp;header.&nbsp;Use&nbsp;mime.ParseMediaType&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3484286">//&nbsp;parse&nbsp;such&nbsp;headers.</span><br>
<span class="lineno">90</span><span class="keyword" id="3484309">func</span>&nbsp;<span class="ident" id="3484314">NewReader</span><span class="op" id="3484323">(</span><span class="ident" id="3484324">r</span>&nbsp;<span class="ident" id="3484326">io</span><span class="op" id="3484328">.</span><span class="ident" id="3484329">Reader</span><span class="op" id="3484335">,</span>&nbsp;<span class="ident" id="3484337">boundary</span>&nbsp;<span class="builtintype" id="3484346">string</span><span class="op" id="3484352">)</span>&nbsp;<span class="op" id="3484354">*</span><span class="ident" id="3484355">Reader</span>&nbsp;<span class="op" id="3484362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3484365">b</span>&nbsp;<span class="op" id="3484367">:=</span>&nbsp;<span class="op" id="3484370">[</span><span class="op" id="3484371">]</span><span class="builtintype" id="3484372">byte</span><span class="op" id="3484376">(</span><span class="string" id="3484377">&#34;\r\n--&#34;</span>&nbsp;<span class="op" id="3484386">+</span>&nbsp;<span class="ident" id="3484388">boundary</span>&nbsp;<span class="op" id="3484397">+</span>&nbsp;<span class="string" id="3484399">&#34;--&#34;</span><span class="op" id="3484403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3484406">return</span>&nbsp;<span class="op" id="3484413">&amp;</span><span class="ident" id="3484414">Reader</span><span class="op" id="3484420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3484424">bufReader</span><span class="op" id="3484433">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3484442">bufio</span><span class="op" id="3484447">.</span><span class="ident" id="3484448">NewReader</span><span class="op" id="3484457">(</span><span class="ident" id="3484458">r</span><span class="op" id="3484459">)</span><span class="op" id="3484460">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3484464">nl</span><span class="op" id="3484466">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3484482">b</span><span class="op" id="3484483">[</span><span class="op" id="3484484">:</span><span class="num" id="3484485">2</span><span class="op" id="3484486">]</span><span class="op" id="3484487">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3484491">nlDashBoundary</span><span class="op" id="3484505">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3484509">b</span><span class="op" id="3484510">[</span><span class="op" id="3484511">:</span><span class="builtinfunc" id="3484512">len</span><span class="op" id="3484515">(</span><span class="ident" id="3484516">b</span><span class="op" id="3484517">)</span><span class="op" id="3484518">-</span><span class="num" id="3484519">2</span><span class="op" id="3484520">]</span><span class="op" id="3484521">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3484525">dashBoundaryDash</span><span class="op" id="3484541">:</span>&nbsp;<span class="ident" id="3484543">b</span><span class="op" id="3484544">[</span><span class="num" id="3484545">2</span><span class="op" id="3484546">:</span><span class="op" id="3484547">]</span><span class="op" id="3484548">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3484552">dashBoundary</span><span class="op" id="3484564">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3484570">b</span><span class="op" id="3484571">[</span><span class="num" id="3484572">2</span>&nbsp;<span class="op" id="3484574">:</span>&nbsp;<span class="builtinfunc" id="3484576">len</span><span class="op" id="3484579">(</span><span class="ident" id="3484580">b</span><span class="op" id="3484581">)</span><span class="op" id="3484582">-</span><span class="num" id="3484583">2</span><span class="op" id="3484584">]</span><span class="op" id="3484585">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3484588">}</span><br>
<span class="lineno"></span><span class="op" id="3484590">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="3484593">func</span>&nbsp;<span class="ident" id="3484598">newPart</span><span class="op" id="3484605">(</span><span class="ident" id="3484606">mr</span>&nbsp;<span class="op" id="3484609">*</span><span class="ident" id="3484610">Reader</span><span class="op" id="3484616">)</span>&nbsp;<span class="op" id="3484618">(</span><span class="op" id="3484619">*</span><span class="ident" id="3484620">Part</span><span class="op" id="3484624">,</span>&nbsp;<span class="builtintype" id="3484626">error</span><span class="op" id="3484631">)</span>&nbsp;<span class="op" id="3484633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3484636">bp</span>&nbsp;<span class="op" id="3484639">:=</span>&nbsp;<span class="op" id="3484642">&amp;</span><span class="ident" id="3484643">Part</span><span class="op" id="3484647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3484651">Header</span><span class="op" id="3484657">:</span>&nbsp;<span class="builtinfunc" id="3484659">make</span><span class="op" id="3484663">(</span><span class="keyword" id="3484664">map</span><span class="op" id="3484667">[</span><span class="builtintype" id="3484668">string</span><span class="op" id="3484674">]</span><span class="op" id="3484675">[</span><span class="op" id="3484676">]</span><span class="builtintype" id="3484677">string</span><span class="op" id="3484683">)</span><span class="op" id="3484684">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3484688">mr</span><span class="op" id="3484690">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3484696">mr</span><span class="op" id="3484698">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3484702">buffer</span><span class="op" id="3484708">:</span>&nbsp;<span class="builtinfunc" id="3484710">new</span><span class="op" id="3484713">(</span><span class="ident" id="3484714">bytes</span><span class="op" id="3484719">.</span><span class="ident" id="3484720">Buffer</span><span class="op" id="3484726">)</span><span class="op" id="3484727">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3484730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3484733">if</span>&nbsp;<span class="ident" id="3484736">err</span>&nbsp;<span class="op" id="3484740">:=</span>&nbsp;<span class="ident" id="3484743">bp</span><span class="op" id="3484745">.</span><span class="ident" id="3484746">populateHeaders</span><span class="op" id="3484761">(</span><span class="op" id="3484762">)</span><span class="op" id="3484763">;</span>&nbsp;<span class="ident" id="3484765">err</span>&nbsp;<span class="op" id="3484769">!=</span>&nbsp;<span class="builtintype" id="3484772">nil</span>&nbsp;<span class="op" id="3484776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3484780">return</span>&nbsp;<span class="builtintype" id="3484787">nil</span><span class="op" id="3484790">,</span>&nbsp;<span class="ident" id="3484792">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3484797">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3484800">bp</span><span class="op" id="3484802">.</span><span class="ident" id="3484803">r</span>&nbsp;<span class="op" id="3484805">=</span>&nbsp;<span class="ident" id="3484807">partReader</span><span class="op" id="3484817">{</span><span class="ident" id="3484818">bp</span><span class="op" id="3484820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3484823">const</span>&nbsp;<span class="ident" id="3484829">cte</span>&nbsp;<span class="op" id="3484833">=</span>&nbsp;<span class="string" id="3484835">&#34;Content-Transfer-Encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3484864">if</span>&nbsp;<span class="ident" id="3484867">bp</span><span class="op" id="3484869">.</span><span class="ident" id="3484870">Header</span><span class="op" id="3484876">.</span><span class="ident" id="3484877">Get</span><span class="op" id="3484880">(</span><span class="ident" id="3484881">cte</span><span class="op" id="3484884">)</span>&nbsp;<span class="op" id="3484886">==</span>&nbsp;<span class="string" id="3484889">&#34;quoted-printable&#34;</span>&nbsp;<span class="op" id="3484908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3484912">bp</span><span class="op" id="3484914">.</span><span class="ident" id="3484915">Header</span><span class="op" id="3484921">.</span><span class="ident" id="3484922">Del</span><span class="op" id="3484925">(</span><span class="ident" id="3484926">cte</span><span class="op" id="3484929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3484933">bp</span><span class="op" id="3484935">.</span><span class="ident" id="3484936">r</span>&nbsp;<span class="op" id="3484938">=</span>&nbsp;<span class="ident" id="3484940">newQuotedPrintableReader</span><span class="op" id="3484964">(</span><span class="ident" id="3484965">bp</span><span class="op" id="3484967">.</span><span class="ident" id="3484968">r</span><span class="op" id="3484969">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3484972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3484975">return</span>&nbsp;<span class="ident" id="3484982">bp</span><span class="op" id="3484984">,</span>&nbsp;<span class="builtintype" id="3484986">nil</span><br>
<span class="lineno"></span><span class="op" id="3484990">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3484993">func</span>&nbsp;<span class="op" id="3484998">(</span><span class="ident" id="3484999">bp</span>&nbsp;<span class="op" id="3485002">*</span><span class="ident" id="3485003">Part</span><span class="op" id="3485007">)</span>&nbsp;<span class="ident" id="3485009">populateHeaders</span><span class="op" id="3485024">(</span><span class="op" id="3485025">)</span>&nbsp;<span class="builtintype" id="3485027">error</span>&nbsp;<span class="op" id="3485033">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3485036">r</span>&nbsp;<span class="op" id="3485038">:=</span>&nbsp;<span class="ident" id="3485041">textproto</span><span class="op" id="3485050">.</span><span class="ident" id="3485051">NewReader</span><span class="op" id="3485060">(</span><span class="ident" id="3485061">bp</span><span class="op" id="3485063">.</span><span class="ident" id="3485064">mr</span><span class="op" id="3485066">.</span><span class="ident" id="3485067">bufReader</span><span class="op" id="3485076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3485079">header</span><span class="op" id="3485085">,</span>&nbsp;<span class="ident" id="3485087">err</span>&nbsp;<span class="op" id="3485091">:=</span>&nbsp;<span class="ident" id="3485094">r</span><span class="op" id="3485095">.</span><span class="ident" id="3485096">ReadMIMEHeader</span><span class="op" id="3485110">(</span><span class="op" id="3485111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3485114">if</span>&nbsp;<span class="ident" id="3485117">err</span>&nbsp;<span class="op" id="3485121">==</span>&nbsp;<span class="builtintype" id="3485124">nil</span>&nbsp;<span class="op" id="3485128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3485132">bp</span><span class="op" id="3485134">.</span><span class="ident" id="3485135">Header</span>&nbsp;<span class="op" id="3485142">=</span>&nbsp;<span class="ident" id="3485144">header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3485152">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3485155">return</span>&nbsp;<span class="ident" id="3485162">err</span><br>
<span class="lineno"></span><span class="op" id="3485166">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3485169">//&nbsp;Read&nbsp;reads&nbsp;the&nbsp;body&nbsp;of&nbsp;a&nbsp;part,&nbsp;after&nbsp;its&nbsp;headers&nbsp;and&nbsp;before&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3485236">//&nbsp;next&nbsp;part&nbsp;(if&nbsp;any)&nbsp;begins.</span><br>
<span class="lineno">130</span><span class="keyword" id="3485266">func</span>&nbsp;<span class="op" id="3485271">(</span><span class="ident" id="3485272">p</span>&nbsp;<span class="op" id="3485274">*</span><span class="ident" id="3485275">Part</span><span class="op" id="3485279">)</span>&nbsp;<span class="ident" id="3485281">Read</span><span class="op" id="3485285">(</span><span class="ident" id="3485286">d</span>&nbsp;<span class="op" id="3485288">[</span><span class="op" id="3485289">]</span><span class="builtintype" id="3485290">byte</span><span class="op" id="3485294">)</span>&nbsp;<span class="op" id="3485296">(</span><span class="ident" id="3485297">n</span>&nbsp;<span class="builtintype" id="3485299">int</span><span class="op" id="3485302">,</span>&nbsp;<span class="ident" id="3485304">err</span>&nbsp;<span class="builtintype" id="3485308">error</span><span class="op" id="3485313">)</span>&nbsp;<span class="op" id="3485315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3485318">return</span>&nbsp;<span class="ident" id="3485325">p</span><span class="op" id="3485326">.</span><span class="ident" id="3485327">r</span><span class="op" id="3485328">.</span><span class="ident" id="3485329">Read</span><span class="op" id="3485333">(</span><span class="ident" id="3485334">d</span><span class="op" id="3485335">)</span><br>
<span class="lineno"></span><span class="op" id="3485337">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3485340">//&nbsp;partReader&nbsp;implements&nbsp;io.Reader&nbsp;by&nbsp;reading&nbsp;raw&nbsp;bytes&nbsp;directly&nbsp;from&nbsp;the</span><br>
<span class="lineno">135</span><span class="comment" id="3485414">//&nbsp;wrapped&nbsp;*Part,&nbsp;without&nbsp;doing&nbsp;any&nbsp;Transfer-Encoding&nbsp;decoding.</span><br>
<span class="lineno"></span><span class="keyword" id="3485478">type</span>&nbsp;<span class="ident" id="3485483">partReader</span>&nbsp;<span class="keyword" id="3485494">struct</span>&nbsp;<span class="op" id="3485501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3485504">p</span>&nbsp;<span class="op" id="3485506">*</span><span class="ident" id="3485507">Part</span><br>
<span class="lineno"></span><span class="op" id="3485512">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="3485515">func</span>&nbsp;<span class="op" id="3485520">(</span><span class="ident" id="3485521">pr</span>&nbsp;<span class="ident" id="3485524">partReader</span><span class="op" id="3485534">)</span>&nbsp;<span class="ident" id="3485536">Read</span><span class="op" id="3485540">(</span><span class="ident" id="3485541">d</span>&nbsp;<span class="op" id="3485543">[</span><span class="op" id="3485544">]</span><span class="builtintype" id="3485545">byte</span><span class="op" id="3485549">)</span>&nbsp;<span class="op" id="3485551">(</span><span class="ident" id="3485552">n</span>&nbsp;<span class="builtintype" id="3485554">int</span><span class="op" id="3485557">,</span>&nbsp;<span class="ident" id="3485559">err</span>&nbsp;<span class="builtintype" id="3485563">error</span><span class="op" id="3485568">)</span>&nbsp;<span class="op" id="3485570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3485573">p</span>&nbsp;<span class="op" id="3485575">:=</span>&nbsp;<span class="ident" id="3485578">pr</span><span class="op" id="3485580">.</span><span class="ident" id="3485581">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3485584">defer</span>&nbsp;<span class="keyword" id="3485590">func</span><span class="op" id="3485594">(</span><span class="op" id="3485595">)</span>&nbsp;<span class="op" id="3485597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3485601">p</span><span class="op" id="3485602">.</span><span class="ident" id="3485603">bytesRead</span>&nbsp;<span class="op" id="3485613">+=</span>&nbsp;<span class="ident" id="3485616">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3485619">}</span><span class="op" id="3485620">(</span><span class="op" id="3485621">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3485624">if</span>&nbsp;<span class="ident" id="3485627">p</span><span class="op" id="3485628">.</span><span class="ident" id="3485629">buffer</span><span class="op" id="3485635">.</span><span class="ident" id="3485636">Len</span><span class="op" id="3485639">(</span><span class="op" id="3485640">)</span>&nbsp;<span class="op" id="3485642">&gt;=</span>&nbsp;<span class="builtinfunc" id="3485645">len</span><span class="op" id="3485648">(</span><span class="ident" id="3485649">d</span><span class="op" id="3485650">)</span>&nbsp;<span class="op" id="3485652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3485656">//&nbsp;Internal&nbsp;buffer&nbsp;of&nbsp;unconsumed&nbsp;data&nbsp;is&nbsp;large&nbsp;enough&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3485716">//&nbsp;the&nbsp;read&nbsp;request.&nbsp;&nbsp;No&nbsp;need&nbsp;to&nbsp;parse&nbsp;more&nbsp;at&nbsp;the&nbsp;moment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3485777">return</span>&nbsp;<span class="ident" id="3485784">p</span><span class="op" id="3485785">.</span><span class="ident" id="3485786">buffer</span><span class="op" id="3485792">.</span><span class="ident" id="3485793">Read</span><span class="op" id="3485797">(</span><span class="ident" id="3485798">d</span><span class="op" id="3485799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3485802">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3485805">peek</span><span class="op" id="3485809">,</span>&nbsp;<span class="ident" id="3485811">err</span>&nbsp;<span class="op" id="3485815">:=</span>&nbsp;<span class="ident" id="3485818">p</span><span class="op" id="3485819">.</span><span class="ident" id="3485820">mr</span><span class="op" id="3485822">.</span><span class="ident" id="3485823">bufReader</span><span class="op" id="3485832">.</span><span class="ident" id="3485833">Peek</span><span class="op" id="3485837">(</span><span class="num" id="3485838">4096</span><span class="op" id="3485842">)</span>&nbsp;<span class="comment" id="3485844">//&nbsp;TODO(bradfitz):&nbsp;add&nbsp;buffer&nbsp;size&nbsp;accessor</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3485890">//&nbsp;Look&nbsp;for&nbsp;an&nbsp;immediate&nbsp;empty&nbsp;part&nbsp;without&nbsp;a&nbsp;leading&nbsp;\r\n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3485950">//&nbsp;before&nbsp;the&nbsp;boundary&nbsp;separator.&nbsp;&nbsp;Some&nbsp;MIME&nbsp;code&nbsp;makes&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3486013">//&nbsp;parts&nbsp;like&nbsp;this.&nbsp;Most&nbsp;browsers,&nbsp;however,&nbsp;write&nbsp;the&nbsp;\r\n</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3486073">//&nbsp;before&nbsp;the&nbsp;subsequent&nbsp;boundary&nbsp;even&nbsp;for&nbsp;empty&nbsp;parts&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3486133">//&nbsp;won&#39;t&nbsp;hit&nbsp;this&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3486158">if</span>&nbsp;<span class="ident" id="3486161">p</span><span class="op" id="3486162">.</span><span class="ident" id="3486163">bytesRead</span>&nbsp;<span class="op" id="3486173">==</span>&nbsp;<span class="num" id="3486176">0</span>&nbsp;<span class="op" id="3486178">&amp;&amp;</span>&nbsp;<span class="ident" id="3486181">p</span><span class="op" id="3486182">.</span><span class="ident" id="3486183">mr</span><span class="op" id="3486185">.</span><span class="ident" id="3486186">peekBufferIsEmptyPart</span><span class="op" id="3486207">(</span><span class="ident" id="3486208">peek</span><span class="op" id="3486212">)</span>&nbsp;<span class="op" id="3486214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3486218">return</span>&nbsp;<span class="num" id="3486225">0</span><span class="op" id="3486226">,</span>&nbsp;<span class="ident" id="3486228">io</span><span class="op" id="3486230">.</span><span class="ident" id="3486231">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3486236">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3486239">unexpectedEOF</span>&nbsp;<span class="op" id="3486253">:=</span>&nbsp;<span class="ident" id="3486256">err</span>&nbsp;<span class="op" id="3486260">==</span>&nbsp;<span class="ident" id="3486263">io</span><span class="op" id="3486265">.</span><span class="ident" id="3486266">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3486271">if</span>&nbsp;<span class="ident" id="3486274">err</span>&nbsp;<span class="op" id="3486278">!=</span>&nbsp;<span class="builtintype" id="3486281">nil</span>&nbsp;<span class="op" id="3486285">&amp;&amp;</span>&nbsp;<span class="op" id="3486288">!</span><span class="ident" id="3486289">unexpectedEOF</span>&nbsp;<span class="op" id="3486303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3486307">return</span>&nbsp;<span class="num" id="3486314">0</span><span class="op" id="3486315">,</span>&nbsp;<span class="ident" id="3486317">fmt</span><span class="op" id="3486320">.</span><span class="ident" id="3486321">Errorf</span><span class="op" id="3486327">(</span><span class="string" id="3486328">&#34;multipart:&nbsp;Part&nbsp;Read:&nbsp;%v&#34;</span><span class="op" id="3486354">,</span>&nbsp;<span class="ident" id="3486356">err</span><span class="op" id="3486359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3486362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3486365">if</span>&nbsp;<span class="ident" id="3486368">peek</span>&nbsp;<span class="op" id="3486373">==</span>&nbsp;<span class="builtintype" id="3486376">nil</span>&nbsp;<span class="op" id="3486380">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3486384">panic</span><span class="op" id="3486389">(</span><span class="string" id="3486390">&#34;nil&nbsp;peek&nbsp;buf&#34;</span><span class="op" id="3486404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3486407">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3486411">//&nbsp;Search&nbsp;the&nbsp;peek&nbsp;buffer&nbsp;for&nbsp;&#34;\r\n--boundary&#34;.&nbsp;If&nbsp;found,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3486470">//&nbsp;consume&nbsp;everything&nbsp;up&nbsp;to&nbsp;the&nbsp;boundary.&nbsp;If&nbsp;not,&nbsp;consume&nbsp;only</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3486534">//&nbsp;as&nbsp;much&nbsp;of&nbsp;the&nbsp;peek&nbsp;buffer&nbsp;as&nbsp;cannot&nbsp;hold&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3486593">//&nbsp;string.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3486605">nCopy</span>&nbsp;<span class="op" id="3486611">:=</span>&nbsp;<span class="num" id="3486614">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3486617">foundBoundary</span>&nbsp;<span class="op" id="3486631">:=</span>&nbsp;<span class="builtintype" id="3486634">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3486641">if</span>&nbsp;<span class="ident" id="3486644">idx</span>&nbsp;<span class="op" id="3486648">:=</span>&nbsp;<span class="ident" id="3486651">bytes</span><span class="op" id="3486656">.</span><span class="ident" id="3486657">Index</span><span class="op" id="3486662">(</span><span class="ident" id="3486663">peek</span><span class="op" id="3486667">,</span>&nbsp;<span class="ident" id="3486669">p</span><span class="op" id="3486670">.</span><span class="ident" id="3486671">mr</span><span class="op" id="3486673">.</span><span class="ident" id="3486674">nlDashBoundary</span><span class="op" id="3486688">)</span><span class="op" id="3486689">;</span>&nbsp;<span class="ident" id="3486691">idx</span>&nbsp;<span class="op" id="3486695">!=</span>&nbsp;<span class="op" id="3486698">-</span><span class="num" id="3486699">1</span>&nbsp;<span class="op" id="3486701">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3486705">nCopy</span>&nbsp;<span class="op" id="3486711">=</span>&nbsp;<span class="ident" id="3486713">idx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3486719">foundBoundary</span>&nbsp;<span class="op" id="3486733">=</span>&nbsp;<span class="builtintype" id="3486735">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3486741">}</span>&nbsp;<span class="keyword" id="3486743">else</span>&nbsp;<span class="keyword" id="3486748">if</span>&nbsp;<span class="ident" id="3486751">safeCount</span>&nbsp;<span class="op" id="3486761">:=</span>&nbsp;<span class="builtinfunc" id="3486764">len</span><span class="op" id="3486767">(</span><span class="ident" id="3486768">peek</span><span class="op" id="3486772">)</span>&nbsp;<span class="op" id="3486774">-</span>&nbsp;<span class="builtinfunc" id="3486776">len</span><span class="op" id="3486779">(</span><span class="ident" id="3486780">p</span><span class="op" id="3486781">.</span><span class="ident" id="3486782">mr</span><span class="op" id="3486784">.</span><span class="ident" id="3486785">nlDashBoundary</span><span class="op" id="3486799">)</span><span class="op" id="3486800">;</span>&nbsp;<span class="ident" id="3486802">safeCount</span>&nbsp;<span class="op" id="3486812">&gt;</span>&nbsp;<span class="num" id="3486814">0</span>&nbsp;<span class="op" id="3486816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3486820">nCopy</span>&nbsp;<span class="op" id="3486826">=</span>&nbsp;<span class="ident" id="3486828">safeCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3486839">}</span>&nbsp;<span class="keyword" id="3486841">else</span>&nbsp;<span class="keyword" id="3486846">if</span>&nbsp;<span class="ident" id="3486849">unexpectedEOF</span>&nbsp;<span class="op" id="3486863">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3486867">//&nbsp;If&nbsp;we&#39;ve&nbsp;run&nbsp;out&nbsp;of&nbsp;peek&nbsp;buffer&nbsp;and&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3486921">//&nbsp;wasn&#39;t&nbsp;found&nbsp;(and&nbsp;can&#39;t&nbsp;possibly&nbsp;fit),&nbsp;we&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3486978">//&nbsp;hit&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;file&nbsp;unexpectedly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3487021">return</span>&nbsp;<span class="num" id="3487028">0</span><span class="op" id="3487029">,</span>&nbsp;<span class="ident" id="3487031">io</span><span class="op" id="3487033">.</span><span class="ident" id="3487034">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3487052">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3487055">if</span>&nbsp;<span class="ident" id="3487058">nCopy</span>&nbsp;<span class="op" id="3487064">&gt;</span>&nbsp;<span class="num" id="3487066">0</span>&nbsp;<span class="op" id="3487068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3487072">if</span>&nbsp;<span class="ident" id="3487075">_</span><span class="op" id="3487076">,</span>&nbsp;<span class="ident" id="3487078">err</span>&nbsp;<span class="op" id="3487082">:=</span>&nbsp;<span class="ident" id="3487085">io</span><span class="op" id="3487087">.</span><span class="ident" id="3487088">CopyN</span><span class="op" id="3487093">(</span><span class="ident" id="3487094">p</span><span class="op" id="3487095">.</span><span class="ident" id="3487096">buffer</span><span class="op" id="3487102">,</span>&nbsp;<span class="ident" id="3487104">p</span><span class="op" id="3487105">.</span><span class="ident" id="3487106">mr</span><span class="op" id="3487108">.</span><span class="ident" id="3487109">bufReader</span><span class="op" id="3487118">,</span>&nbsp;<span class="ident" id="3487120">int64</span><span class="op" id="3487125">(</span><span class="ident" id="3487126">nCopy</span><span class="op" id="3487131">)</span><span class="op" id="3487132">)</span><span class="op" id="3487133">;</span>&nbsp;<span class="ident" id="3487135">err</span>&nbsp;<span class="op" id="3487139">!=</span>&nbsp;<span class="builtintype" id="3487142">nil</span>&nbsp;<span class="op" id="3487146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3487151">return</span>&nbsp;<span class="num" id="3487158">0</span><span class="op" id="3487159">,</span>&nbsp;<span class="ident" id="3487161">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3487167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3487170">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3487173">n</span><span class="op" id="3487174">,</span>&nbsp;<span class="ident" id="3487176">err</span>&nbsp;<span class="op" id="3487180">=</span>&nbsp;<span class="ident" id="3487182">p</span><span class="op" id="3487183">.</span><span class="ident" id="3487184">buffer</span><span class="op" id="3487190">.</span><span class="ident" id="3487191">Read</span><span class="op" id="3487195">(</span><span class="ident" id="3487196">d</span><span class="op" id="3487197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3487200">if</span>&nbsp;<span class="ident" id="3487203">err</span>&nbsp;<span class="op" id="3487207">==</span>&nbsp;<span class="ident" id="3487210">io</span><span class="op" id="3487212">.</span><span class="ident" id="3487213">EOF</span>&nbsp;<span class="op" id="3487217">&amp;&amp;</span>&nbsp;<span class="op" id="3487220">!</span><span class="ident" id="3487221">foundBoundary</span>&nbsp;<span class="op" id="3487235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3487239">//&nbsp;If&nbsp;the&nbsp;boundary&nbsp;hasn&#39;t&nbsp;been&nbsp;reached&nbsp;there&#39;s&nbsp;more&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3487296">//&nbsp;read,&nbsp;so&nbsp;don&#39;t&nbsp;pass&nbsp;through&nbsp;an&nbsp;EOF&nbsp;from&nbsp;the&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3487352">err</span>&nbsp;<span class="op" id="3487356">=</span>&nbsp;<span class="builtintype" id="3487358">nil</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3487363">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3487366">return</span><br>
<span class="lineno"></span><span class="op" id="3487373">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3487376">func</span>&nbsp;<span class="op" id="3487381">(</span><span class="ident" id="3487382">p</span>&nbsp;<span class="op" id="3487384">*</span><span class="ident" id="3487385">Part</span><span class="op" id="3487389">)</span>&nbsp;<span class="ident" id="3487391">Close</span><span class="op" id="3487396">(</span><span class="op" id="3487397">)</span>&nbsp;<span class="builtintype" id="3487399">error</span>&nbsp;<span class="op" id="3487405">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3487408">io</span><span class="op" id="3487410">.</span><span class="ident" id="3487411">Copy</span><span class="op" id="3487415">(</span><span class="ident" id="3487416">ioutil</span><span class="op" id="3487422">.</span><span class="ident" id="3487423">Discard</span><span class="op" id="3487430">,</span>&nbsp;<span class="ident" id="3487432">p</span><span class="op" id="3487433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3487436">return</span>&nbsp;<span class="builtintype" id="3487443">nil</span><br>
<span class="lineno"></span><span class="op" id="3487447">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3487450">//&nbsp;Reader&nbsp;is&nbsp;an&nbsp;iterator&nbsp;over&nbsp;parts&nbsp;in&nbsp;a&nbsp;MIME&nbsp;multipart&nbsp;body.</span><br>
<span class="lineno">205</span><span class="comment" id="3487512">//&nbsp;Reader&#39;s&nbsp;underlying&nbsp;parser&nbsp;consumes&nbsp;its&nbsp;input&nbsp;as&nbsp;needed.&nbsp;&nbsp;Seeking</span><br>
<span class="lineno"></span><span class="comment" id="3487581">//&nbsp;isn&#39;t&nbsp;supported.</span><br>
<span class="lineno"></span><span class="keyword" id="3487601">type</span>&nbsp;<span class="ident" id="3487606">Reader</span>&nbsp;<span class="keyword" id="3487613">struct</span>&nbsp;<span class="op" id="3487620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3487623">bufReader</span>&nbsp;<span class="op" id="3487633">*</span><span class="ident" id="3487634">bufio</span><span class="op" id="3487639">.</span><span class="ident" id="3487640">Reader</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3487649">currentPart</span>&nbsp;<span class="op" id="3487661">*</span><span class="ident" id="3487662">Part</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3487668">partsRead</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3487680">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3487686">nl</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3487703">[</span><span class="op" id="3487704">]</span><span class="builtintype" id="3487705">byte</span>&nbsp;<span class="comment" id="3487710">//&nbsp;&#34;\r\n&#34;&nbsp;or&nbsp;&#34;\n&#34;&nbsp;(set&nbsp;after&nbsp;seeing&nbsp;first&nbsp;boundary&nbsp;line)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3487768">nlDashBoundary</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3487785">[</span><span class="op" id="3487786">]</span><span class="builtintype" id="3487787">byte</span>&nbsp;<span class="comment" id="3487792">//&nbsp;nl&nbsp;+&nbsp;&#34;--boundary&#34;</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3487814">dashBoundaryDash</span>&nbsp;<span class="op" id="3487831">[</span><span class="op" id="3487832">]</span><span class="builtintype" id="3487833">byte</span>&nbsp;<span class="comment" id="3487838">//&nbsp;&#34;--boundary--&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3487857">dashBoundary</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3487874">[</span><span class="op" id="3487875">]</span><span class="builtintype" id="3487876">byte</span>&nbsp;<span class="comment" id="3487881">//&nbsp;&#34;--boundary&#34;</span><br>
<span class="lineno"></span><span class="op" id="3487897">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3487900">//&nbsp;NextPart&nbsp;returns&nbsp;the&nbsp;next&nbsp;part&nbsp;in&nbsp;the&nbsp;multipart&nbsp;or&nbsp;an&nbsp;error.</span><br>
<span class="lineno">220</span><span class="comment" id="3487964">//&nbsp;When&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;parts,&nbsp;the&nbsp;error&nbsp;io.EOF&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="3488027">func</span>&nbsp;<span class="op" id="3488032">(</span><span class="ident" id="3488033">r</span>&nbsp;<span class="op" id="3488035">*</span><span class="ident" id="3488036">Reader</span><span class="op" id="3488042">)</span>&nbsp;<span class="ident" id="3488044">NextPart</span><span class="op" id="3488052">(</span><span class="op" id="3488053">)</span>&nbsp;<span class="op" id="3488055">(</span><span class="op" id="3488056">*</span><span class="ident" id="3488057">Part</span><span class="op" id="3488061">,</span>&nbsp;<span class="builtintype" id="3488063">error</span><span class="op" id="3488068">)</span>&nbsp;<span class="op" id="3488070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3488073">if</span>&nbsp;<span class="ident" id="3488076">r</span><span class="op" id="3488077">.</span><span class="ident" id="3488078">currentPart</span>&nbsp;<span class="op" id="3488090">!=</span>&nbsp;<span class="builtintype" id="3488093">nil</span>&nbsp;<span class="op" id="3488097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3488101">r</span><span class="op" id="3488102">.</span><span class="ident" id="3488103">currentPart</span><span class="op" id="3488114">.</span><span class="ident" id="3488115">Close</span><span class="op" id="3488120">(</span><span class="op" id="3488121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3488124">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3488128">expectNewPart</span>&nbsp;<span class="op" id="3488142">:=</span>&nbsp;<span class="builtintype" id="3488145">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3488152">for</span>&nbsp;<span class="op" id="3488156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3488160">line</span><span class="op" id="3488164">,</span>&nbsp;<span class="ident" id="3488166">err</span>&nbsp;<span class="op" id="3488170">:=</span>&nbsp;<span class="ident" id="3488173">r</span><span class="op" id="3488174">.</span><span class="ident" id="3488175">bufReader</span><span class="op" id="3488184">.</span><span class="ident" id="3488185">ReadSlice</span><span class="op" id="3488194">(</span><span class="string" id="3488195">&#39;\n&#39;</span><span class="op" id="3488199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3488203">if</span>&nbsp;<span class="ident" id="3488206">err</span>&nbsp;<span class="op" id="3488210">==</span>&nbsp;<span class="ident" id="3488213">io</span><span class="op" id="3488215">.</span><span class="ident" id="3488216">EOF</span>&nbsp;<span class="op" id="3488220">&amp;&amp;</span>&nbsp;<span class="ident" id="3488223">r</span><span class="op" id="3488224">.</span><span class="ident" id="3488225">isFinalBoundary</span><span class="op" id="3488240">(</span><span class="ident" id="3488241">line</span><span class="op" id="3488245">)</span>&nbsp;<span class="op" id="3488247">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3488252">//&nbsp;If&nbsp;the&nbsp;buffer&nbsp;ends&nbsp;in&nbsp;&#34;--boundary--&#34;&nbsp;without&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3488307">//&nbsp;trailing&nbsp;&#34;\r\n&#34;,&nbsp;ReadSlice&nbsp;will&nbsp;return&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3488361">//&nbsp;(since&nbsp;it&#39;s&nbsp;missing&nbsp;the&nbsp;&#39;\n&#39;),&nbsp;but&nbsp;this&nbsp;is&nbsp;a&nbsp;valid</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3488418">//&nbsp;multipart&nbsp;EOF&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;return&nbsp;io.EOF&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3488477">//&nbsp;a&nbsp;fmt-wrapped&nbsp;one.</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3488502">return</span>&nbsp;<span class="builtintype" id="3488509">nil</span><span class="op" id="3488512">,</span>&nbsp;<span class="ident" id="3488514">io</span><span class="op" id="3488516">.</span><span class="ident" id="3488517">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3488523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3488527">if</span>&nbsp;<span class="ident" id="3488530">err</span>&nbsp;<span class="op" id="3488534">!=</span>&nbsp;<span class="builtintype" id="3488537">nil</span>&nbsp;<span class="op" id="3488541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3488546">return</span>&nbsp;<span class="builtintype" id="3488553">nil</span><span class="op" id="3488556">,</span>&nbsp;<span class="ident" id="3488558">fmt</span><span class="op" id="3488561">.</span><span class="ident" id="3488562">Errorf</span><span class="op" id="3488568">(</span><span class="string" id="3488569">&#34;multipart:&nbsp;NextPart:&nbsp;%v&#34;</span><span class="op" id="3488594">,</span>&nbsp;<span class="ident" id="3488596">err</span><span class="op" id="3488599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3488603">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3488608">if</span>&nbsp;<span class="ident" id="3488611">r</span><span class="op" id="3488612">.</span><span class="ident" id="3488613">isBoundaryDelimiterLine</span><span class="op" id="3488636">(</span><span class="ident" id="3488637">line</span><span class="op" id="3488641">)</span>&nbsp;<span class="op" id="3488643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3488648">r</span><span class="op" id="3488649">.</span><span class="ident" id="3488650">partsRead</span><span class="op" id="3488659">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3488665">bp</span><span class="op" id="3488667">,</span>&nbsp;<span class="ident" id="3488669">err</span>&nbsp;<span class="op" id="3488673">:=</span>&nbsp;<span class="ident" id="3488676">newPart</span><span class="op" id="3488683">(</span><span class="ident" id="3488684">r</span><span class="op" id="3488685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3488690">if</span>&nbsp;<span class="ident" id="3488693">err</span>&nbsp;<span class="op" id="3488697">!=</span>&nbsp;<span class="builtintype" id="3488700">nil</span>&nbsp;<span class="op" id="3488704">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3488710">return</span>&nbsp;<span class="builtintype" id="3488717">nil</span><span class="op" id="3488720">,</span>&nbsp;<span class="ident" id="3488722">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3488729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3488734">r</span><span class="op" id="3488735">.</span><span class="ident" id="3488736">currentPart</span>&nbsp;<span class="op" id="3488748">=</span>&nbsp;<span class="ident" id="3488750">bp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3488756">return</span>&nbsp;<span class="ident" id="3488763">bp</span><span class="op" id="3488765">,</span>&nbsp;<span class="builtintype" id="3488767">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3488773">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3488778">if</span>&nbsp;<span class="ident" id="3488781">r</span><span class="op" id="3488782">.</span><span class="ident" id="3488783">isFinalBoundary</span><span class="op" id="3488798">(</span><span class="ident" id="3488799">line</span><span class="op" id="3488803">)</span>&nbsp;<span class="op" id="3488805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3488810">//&nbsp;Expected&nbsp;EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3488829">return</span>&nbsp;<span class="builtintype" id="3488836">nil</span><span class="op" id="3488839">,</span>&nbsp;<span class="ident" id="3488841">io</span><span class="op" id="3488843">.</span><span class="ident" id="3488844">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3488850">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3488855">if</span>&nbsp;<span class="ident" id="3488858">expectNewPart</span>&nbsp;<span class="op" id="3488872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3488877">return</span>&nbsp;<span class="builtintype" id="3488884">nil</span><span class="op" id="3488887">,</span>&nbsp;<span class="ident" id="3488889">fmt</span><span class="op" id="3488892">.</span><span class="ident" id="3488893">Errorf</span><span class="op" id="3488899">(</span><span class="string" id="3488900">&#34;multipart:&nbsp;expecting&nbsp;a&nbsp;new&nbsp;Part;&nbsp;got&nbsp;line&nbsp;%q&#34;</span><span class="op" id="3488946">,</span>&nbsp;<span class="builtintype" id="3488948">string</span><span class="op" id="3488954">(</span><span class="ident" id="3488955">line</span><span class="op" id="3488959">)</span><span class="op" id="3488960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3488964">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3488969">if</span>&nbsp;<span class="ident" id="3488972">r</span><span class="op" id="3488973">.</span><span class="ident" id="3488974">partsRead</span>&nbsp;<span class="op" id="3488984">==</span>&nbsp;<span class="num" id="3488987">0</span>&nbsp;<span class="op" id="3488989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3488994">//&nbsp;skip&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3489010">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3489021">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3489026">//&nbsp;Consume&nbsp;the&nbsp;&#34;\n&#34;&nbsp;or&nbsp;&#34;\r\n&#34;&nbsp;separator&nbsp;between&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3489080">//&nbsp;body&nbsp;of&nbsp;the&nbsp;previous&nbsp;part&nbsp;and&nbsp;the&nbsp;boundary&nbsp;line&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3489136">//&nbsp;now&nbsp;expect&nbsp;will&nbsp;follow.&nbsp;(either&nbsp;a&nbsp;new&nbsp;part&nbsp;or&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3489191">//&nbsp;end&nbsp;boundary)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3489210">if</span>&nbsp;<span class="ident" id="3489213">bytes</span><span class="op" id="3489218">.</span><span class="ident" id="3489219">Equal</span><span class="op" id="3489224">(</span><span class="ident" id="3489225">line</span><span class="op" id="3489229">,</span>&nbsp;<span class="ident" id="3489231">r</span><span class="op" id="3489232">.</span><span class="ident" id="3489233">nl</span><span class="op" id="3489235">)</span>&nbsp;<span class="op" id="3489237">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3489242">expectNewPart</span>&nbsp;<span class="op" id="3489256">=</span>&nbsp;<span class="builtintype" id="3489258">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3489266">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3489277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3489282">return</span>&nbsp;<span class="builtintype" id="3489289">nil</span><span class="op" id="3489292">,</span>&nbsp;<span class="ident" id="3489294">fmt</span><span class="op" id="3489297">.</span><span class="ident" id="3489298">Errorf</span><span class="op" id="3489304">(</span><span class="string" id="3489305">&#34;multipart:&nbsp;unexpected&nbsp;line&nbsp;in&nbsp;Next():&nbsp;%q&#34;</span><span class="op" id="3489347">,</span>&nbsp;<span class="ident" id="3489349">line</span><span class="op" id="3489353">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3489356">}</span><br>
<span class="lineno"></span><span class="op" id="3489358">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3489361">//&nbsp;isFinalBoundary&nbsp;reports&nbsp;whether&nbsp;line&nbsp;is&nbsp;the&nbsp;final&nbsp;boundary&nbsp;line</span><br>
<span class="lineno"></span><span class="comment" id="3489428">//&nbsp;indicating&nbsp;that&nbsp;all&nbsp;parts&nbsp;are&nbsp;over.</span><br>
<span class="lineno">280</span><span class="comment" id="3489467">//&nbsp;It&nbsp;matches&nbsp;`^--boundary--[&nbsp;\t]*(\r\n)?$`</span><br>
<span class="lineno"></span><span class="keyword" id="3489511">func</span>&nbsp;<span class="op" id="3489516">(</span><span class="ident" id="3489517">mr</span>&nbsp;<span class="op" id="3489520">*</span><span class="ident" id="3489521">Reader</span><span class="op" id="3489527">)</span>&nbsp;<span class="ident" id="3489529">isFinalBoundary</span><span class="op" id="3489544">(</span><span class="ident" id="3489545">line</span>&nbsp;<span class="op" id="3489550">[</span><span class="op" id="3489551">]</span><span class="builtintype" id="3489552">byte</span><span class="op" id="3489556">)</span>&nbsp;<span class="builtintype" id="3489558">bool</span>&nbsp;<span class="op" id="3489563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3489566">if</span>&nbsp;<span class="op" id="3489569">!</span><span class="ident" id="3489570">bytes</span><span class="op" id="3489575">.</span><span class="ident" id="3489576">HasPrefix</span><span class="op" id="3489585">(</span><span class="ident" id="3489586">line</span><span class="op" id="3489590">,</span>&nbsp;<span class="ident" id="3489592">mr</span><span class="op" id="3489594">.</span><span class="ident" id="3489595">dashBoundaryDash</span><span class="op" id="3489611">)</span>&nbsp;<span class="op" id="3489613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3489617">return</span>&nbsp;<span class="builtintype" id="3489624">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3489631">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3489634">rest</span>&nbsp;<span class="op" id="3489639">:=</span>&nbsp;<span class="ident" id="3489642">line</span><span class="op" id="3489646">[</span><span class="builtinfunc" id="3489647">len</span><span class="op" id="3489650">(</span><span class="ident" id="3489651">mr</span><span class="op" id="3489653">.</span><span class="ident" id="3489654">dashBoundaryDash</span><span class="op" id="3489670">)</span><span class="op" id="3489671">:</span><span class="op" id="3489672">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3489675">rest</span>&nbsp;<span class="op" id="3489680">=</span>&nbsp;<span class="ident" id="3489682">skipLWSPChar</span><span class="op" id="3489694">(</span><span class="ident" id="3489695">rest</span><span class="op" id="3489699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3489702">return</span>&nbsp;<span class="builtinfunc" id="3489709">len</span><span class="op" id="3489712">(</span><span class="ident" id="3489713">rest</span><span class="op" id="3489717">)</span>&nbsp;<span class="op" id="3489719">==</span>&nbsp;<span class="num" id="3489722">0</span>&nbsp;<span class="op" id="3489724">||</span>&nbsp;<span class="ident" id="3489727">bytes</span><span class="op" id="3489732">.</span><span class="ident" id="3489733">Equal</span><span class="op" id="3489738">(</span><span class="ident" id="3489739">rest</span><span class="op" id="3489743">,</span>&nbsp;<span class="ident" id="3489745">mr</span><span class="op" id="3489747">.</span><span class="ident" id="3489748">nl</span><span class="op" id="3489750">)</span><br>
<span class="lineno"></span><span class="op" id="3489752">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="keyword" id="3489755">func</span>&nbsp;<span class="op" id="3489760">(</span><span class="ident" id="3489761">mr</span>&nbsp;<span class="op" id="3489764">*</span><span class="ident" id="3489765">Reader</span><span class="op" id="3489771">)</span>&nbsp;<span class="ident" id="3489773">isBoundaryDelimiterLine</span><span class="op" id="3489796">(</span><span class="ident" id="3489797">line</span>&nbsp;<span class="op" id="3489802">[</span><span class="op" id="3489803">]</span><span class="builtintype" id="3489804">byte</span><span class="op" id="3489808">)</span>&nbsp;<span class="op" id="3489810">(</span><span class="ident" id="3489811">ret</span>&nbsp;<span class="builtintype" id="3489815">bool</span><span class="op" id="3489819">)</span>&nbsp;<span class="op" id="3489821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3489824">//&nbsp;http://tools.ietf.org/html/rfc2046#section-5.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3489875">//&nbsp;&nbsp;&nbsp;The&nbsp;boundary&nbsp;delimiter&nbsp;line&nbsp;is&nbsp;then&nbsp;defined&nbsp;as&nbsp;a&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3489935">//&nbsp;&nbsp;&nbsp;consisting&nbsp;entirely&nbsp;of&nbsp;two&nbsp;hyphen&nbsp;characters&nbsp;(&#34;-&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3489992">//&nbsp;&nbsp;&nbsp;decimal&nbsp;value&nbsp;45)&nbsp;followed&nbsp;by&nbsp;the&nbsp;boundary&nbsp;parameter</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3490051">//&nbsp;&nbsp;&nbsp;value&nbsp;from&nbsp;the&nbsp;Content-Type&nbsp;header&nbsp;field,&nbsp;optional&nbsp;linear</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3490115">//&nbsp;&nbsp;&nbsp;whitespace,&nbsp;and&nbsp;a&nbsp;terminating&nbsp;CRLF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3490157">if</span>&nbsp;<span class="op" id="3490160">!</span><span class="ident" id="3490161">bytes</span><span class="op" id="3490166">.</span><span class="ident" id="3490167">HasPrefix</span><span class="op" id="3490176">(</span><span class="ident" id="3490177">line</span><span class="op" id="3490181">,</span>&nbsp;<span class="ident" id="3490183">mr</span><span class="op" id="3490185">.</span><span class="ident" id="3490186">dashBoundary</span><span class="op" id="3490198">)</span>&nbsp;<span class="op" id="3490200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3490204">return</span>&nbsp;<span class="builtintype" id="3490211">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3490218">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3490221">rest</span>&nbsp;<span class="op" id="3490226">:=</span>&nbsp;<span class="ident" id="3490229">line</span><span class="op" id="3490233">[</span><span class="builtinfunc" id="3490234">len</span><span class="op" id="3490237">(</span><span class="ident" id="3490238">mr</span><span class="op" id="3490240">.</span><span class="ident" id="3490241">dashBoundary</span><span class="op" id="3490253">)</span><span class="op" id="3490254">:</span><span class="op" id="3490255">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3490258">rest</span>&nbsp;<span class="op" id="3490263">=</span>&nbsp;<span class="ident" id="3490265">skipLWSPChar</span><span class="op" id="3490277">(</span><span class="ident" id="3490278">rest</span><span class="op" id="3490282">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3490286">//&nbsp;On&nbsp;the&nbsp;first&nbsp;part,&nbsp;see&nbsp;our&nbsp;lines&nbsp;are&nbsp;ending&nbsp;in&nbsp;\n&nbsp;instead&nbsp;of&nbsp;\r\n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3490356">//&nbsp;and&nbsp;switch&nbsp;into&nbsp;that&nbsp;mode&nbsp;if&nbsp;so.&nbsp;&nbsp;This&nbsp;is&nbsp;a&nbsp;violation&nbsp;of&nbsp;the&nbsp;spec,</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3490427">//&nbsp;but&nbsp;occurs&nbsp;in&nbsp;practice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3490455">if</span>&nbsp;<span class="ident" id="3490458">mr</span><span class="op" id="3490460">.</span><span class="ident" id="3490461">partsRead</span>&nbsp;<span class="op" id="3490471">==</span>&nbsp;<span class="num" id="3490474">0</span>&nbsp;<span class="op" id="3490476">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3490479">len</span><span class="op" id="3490482">(</span><span class="ident" id="3490483">rest</span><span class="op" id="3490487">)</span>&nbsp;<span class="op" id="3490489">==</span>&nbsp;<span class="num" id="3490492">1</span>&nbsp;<span class="op" id="3490494">&amp;&amp;</span>&nbsp;<span class="ident" id="3490497">rest</span><span class="op" id="3490501">[</span><span class="num" id="3490502">0</span><span class="op" id="3490503">]</span>&nbsp;<span class="op" id="3490505">==</span>&nbsp;<span class="string" id="3490508">&#39;\n&#39;</span>&nbsp;<span class="op" id="3490513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3490517">mr</span><span class="op" id="3490519">.</span><span class="ident" id="3490520">nl</span>&nbsp;<span class="op" id="3490523">=</span>&nbsp;<span class="ident" id="3490525">mr</span><span class="op" id="3490527">.</span><span class="ident" id="3490528">nl</span><span class="op" id="3490530">[</span><span class="num" id="3490531">1</span><span class="op" id="3490532">:</span><span class="op" id="3490533">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3490537">mr</span><span class="op" id="3490539">.</span><span class="ident" id="3490540">nlDashBoundary</span>&nbsp;<span class="op" id="3490555">=</span>&nbsp;<span class="ident" id="3490557">mr</span><span class="op" id="3490559">.</span><span class="ident" id="3490560">nlDashBoundary</span><span class="op" id="3490574">[</span><span class="num" id="3490575">1</span><span class="op" id="3490576">:</span><span class="op" id="3490577">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3490580">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3490583">return</span>&nbsp;<span class="ident" id="3490590">bytes</span><span class="op" id="3490595">.</span><span class="ident" id="3490596">Equal</span><span class="op" id="3490601">(</span><span class="ident" id="3490602">rest</span><span class="op" id="3490606">,</span>&nbsp;<span class="ident" id="3490608">mr</span><span class="op" id="3490610">.</span><span class="ident" id="3490611">nl</span><span class="op" id="3490613">)</span><br>
<span class="lineno"></span><span class="op" id="3490615">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3490618">//&nbsp;peekBufferIsEmptyPart&nbsp;reports&nbsp;whether&nbsp;the&nbsp;provided&nbsp;peek-ahead</span><br>
<span class="lineno"></span><span class="comment" id="3490683">//&nbsp;buffer&nbsp;represents&nbsp;an&nbsp;empty&nbsp;part.&nbsp;It&nbsp;is&nbsp;called&nbsp;only&nbsp;if&nbsp;we&#39;ve&nbsp;not</span><br>
<span class="lineno">315</span><span class="comment" id="3490750">//&nbsp;already&nbsp;read&nbsp;any&nbsp;bytes&nbsp;in&nbsp;this&nbsp;part&nbsp;and&nbsp;checks&nbsp;for&nbsp;the&nbsp;case&nbsp;of&nbsp;MIME</span><br>
<span class="lineno"></span><span class="comment" id="3490821">//&nbsp;software&nbsp;not&nbsp;writing&nbsp;the&nbsp;\r\n&nbsp;on&nbsp;empty&nbsp;parts.&nbsp;Some&nbsp;does,&nbsp;some</span><br>
<span class="lineno"></span><span class="comment" id="3490886">//&nbsp;doesn&#39;t.</span><br>
<span class="lineno"></span><span class="comment" id="3490898">//</span><br>
<span class="lineno"></span><span class="comment" id="3490901">//&nbsp;This&nbsp;checks&nbsp;that&nbsp;what&nbsp;follows&nbsp;the&nbsp;&#34;--boundary&#34;&nbsp;is&nbsp;actually&nbsp;the&nbsp;end</span><br>
<span class="lineno">320</span><span class="comment" id="3490971">//&nbsp;(&#34;--boundary--&#34;&nbsp;with&nbsp;optional&nbsp;whitespace)&nbsp;or&nbsp;optional&nbsp;whitespace</span><br>
<span class="lineno"></span><span class="comment" id="3491039">//&nbsp;and&nbsp;then&nbsp;a&nbsp;newline,&nbsp;so&nbsp;we&nbsp;don&#39;t&nbsp;catch&nbsp;&#34;--boundaryFAKE&#34;,&nbsp;in&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="3491107">//&nbsp;case&nbsp;the&nbsp;whole&nbsp;line&nbsp;is&nbsp;part&nbsp;of&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="3491151">func</span>&nbsp;<span class="op" id="3491156">(</span><span class="ident" id="3491157">mr</span>&nbsp;<span class="op" id="3491160">*</span><span class="ident" id="3491161">Reader</span><span class="op" id="3491167">)</span>&nbsp;<span class="ident" id="3491169">peekBufferIsEmptyPart</span><span class="op" id="3491190">(</span><span class="ident" id="3491191">peek</span>&nbsp;<span class="op" id="3491196">[</span><span class="op" id="3491197">]</span><span class="builtintype" id="3491198">byte</span><span class="op" id="3491202">)</span>&nbsp;<span class="builtintype" id="3491204">bool</span>&nbsp;<span class="op" id="3491209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3491212">//&nbsp;End&nbsp;of&nbsp;parts&nbsp;case.</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3491235">//&nbsp;Test&nbsp;whether&nbsp;peek&nbsp;matches&nbsp;`^--boundary--[&nbsp;\t]*(?:\r\n|$)`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3491297">if</span>&nbsp;<span class="ident" id="3491300">bytes</span><span class="op" id="3491305">.</span><span class="ident" id="3491306">HasPrefix</span><span class="op" id="3491315">(</span><span class="ident" id="3491316">peek</span><span class="op" id="3491320">,</span>&nbsp;<span class="ident" id="3491322">mr</span><span class="op" id="3491324">.</span><span class="ident" id="3491325">dashBoundaryDash</span><span class="op" id="3491341">)</span>&nbsp;<span class="op" id="3491343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3491347">rest</span>&nbsp;<span class="op" id="3491352">:=</span>&nbsp;<span class="ident" id="3491355">peek</span><span class="op" id="3491359">[</span><span class="builtinfunc" id="3491360">len</span><span class="op" id="3491363">(</span><span class="ident" id="3491364">mr</span><span class="op" id="3491366">.</span><span class="ident" id="3491367">dashBoundaryDash</span><span class="op" id="3491383">)</span><span class="op" id="3491384">:</span><span class="op" id="3491385">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3491389">rest</span>&nbsp;<span class="op" id="3491394">=</span>&nbsp;<span class="ident" id="3491396">skipLWSPChar</span><span class="op" id="3491408">(</span><span class="ident" id="3491409">rest</span><span class="op" id="3491413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3491417">return</span>&nbsp;<span class="ident" id="3491424">bytes</span><span class="op" id="3491429">.</span><span class="ident" id="3491430">HasPrefix</span><span class="op" id="3491439">(</span><span class="ident" id="3491440">rest</span><span class="op" id="3491444">,</span>&nbsp;<span class="ident" id="3491446">mr</span><span class="op" id="3491448">.</span><span class="ident" id="3491449">nl</span><span class="op" id="3491451">)</span>&nbsp;<span class="op" id="3491453">||</span>&nbsp;<span class="builtinfunc" id="3491456">len</span><span class="op" id="3491459">(</span><span class="ident" id="3491460">rest</span><span class="op" id="3491464">)</span>&nbsp;<span class="op" id="3491466">==</span>&nbsp;<span class="num" id="3491469">0</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3491472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3491475">if</span>&nbsp;<span class="op" id="3491478">!</span><span class="ident" id="3491479">bytes</span><span class="op" id="3491484">.</span><span class="ident" id="3491485">HasPrefix</span><span class="op" id="3491494">(</span><span class="ident" id="3491495">peek</span><span class="op" id="3491499">,</span>&nbsp;<span class="ident" id="3491501">mr</span><span class="op" id="3491503">.</span><span class="ident" id="3491504">dashBoundary</span><span class="op" id="3491516">)</span>&nbsp;<span class="op" id="3491518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3491522">return</span>&nbsp;<span class="builtintype" id="3491529">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3491536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3491539">//&nbsp;Test&nbsp;whether&nbsp;rest&nbsp;matches&nbsp;`^[&nbsp;\t]*\r\n`)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3491584">rest</span>&nbsp;<span class="op" id="3491589">:=</span>&nbsp;<span class="ident" id="3491592">peek</span><span class="op" id="3491596">[</span><span class="builtinfunc" id="3491597">len</span><span class="op" id="3491600">(</span><span class="ident" id="3491601">mr</span><span class="op" id="3491603">.</span><span class="ident" id="3491604">dashBoundary</span><span class="op" id="3491616">)</span><span class="op" id="3491617">:</span><span class="op" id="3491618">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3491621">rest</span>&nbsp;<span class="op" id="3491626">=</span>&nbsp;<span class="ident" id="3491628">skipLWSPChar</span><span class="op" id="3491640">(</span><span class="ident" id="3491641">rest</span><span class="op" id="3491645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3491648">return</span>&nbsp;<span class="ident" id="3491655">bytes</span><span class="op" id="3491660">.</span><span class="ident" id="3491661">HasPrefix</span><span class="op" id="3491670">(</span><span class="ident" id="3491671">rest</span><span class="op" id="3491675">,</span>&nbsp;<span class="ident" id="3491677">mr</span><span class="op" id="3491679">.</span><span class="ident" id="3491680">nl</span><span class="op" id="3491682">)</span><br>
<span class="lineno"></span><span class="op" id="3491684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span><span class="comment" id="3491687">//&nbsp;skipLWSPChar&nbsp;returns&nbsp;b&nbsp;with&nbsp;leading&nbsp;spaces&nbsp;and&nbsp;tabs&nbsp;removed.</span><br>
<span class="lineno"></span><span class="comment" id="3491751">//&nbsp;RFC&nbsp;822&nbsp;defines:</span><br>
<span class="lineno"></span><span class="comment" id="3491771">//&nbsp;&nbsp;&nbsp;&nbsp;LWSP-char&nbsp;=&nbsp;SPACE&nbsp;/&nbsp;HTAB</span><br>
<span class="lineno"></span><span class="keyword" id="3491802">func</span>&nbsp;<span class="ident" id="3491807">skipLWSPChar</span><span class="op" id="3491819">(</span><span class="ident" id="3491820">b</span>&nbsp;<span class="op" id="3491822">[</span><span class="op" id="3491823">]</span><span class="builtintype" id="3491824">byte</span><span class="op" id="3491828">)</span>&nbsp;<span class="op" id="3491830">[</span><span class="op" id="3491831">]</span><span class="builtintype" id="3491832">byte</span>&nbsp;<span class="op" id="3491837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3491840">for</span>&nbsp;<span class="builtinfunc" id="3491844">len</span><span class="op" id="3491847">(</span><span class="ident" id="3491848">b</span><span class="op" id="3491849">)</span>&nbsp;<span class="op" id="3491851">&gt;</span>&nbsp;<span class="num" id="3491853">0</span>&nbsp;<span class="op" id="3491855">&amp;&amp;</span>&nbsp;<span class="op" id="3491858">(</span><span class="ident" id="3491859">b</span><span class="op" id="3491860">[</span><span class="num" id="3491861">0</span><span class="op" id="3491862">]</span>&nbsp;<span class="op" id="3491864">==</span>&nbsp;<span class="string" id="3491867">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="3491871">||</span>&nbsp;<span class="ident" id="3491874">b</span><span class="op" id="3491875">[</span><span class="num" id="3491876">0</span><span class="op" id="3491877">]</span>&nbsp;<span class="op" id="3491879">==</span>&nbsp;<span class="string" id="3491882">&#39;\t&#39;</span><span class="op" id="3491886">)</span>&nbsp;<span class="op" id="3491888">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3491892">b</span>&nbsp;<span class="op" id="3491894">=</span>&nbsp;<span class="ident" id="3491896">b</span><span class="op" id="3491897">[</span><span class="num" id="3491898">1</span><span class="op" id="3491899">:</span><span class="op" id="3491900">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3491903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3491906">return</span>&nbsp;<span class="ident" id="3491913">b</span><br>
<span class="lineno"></span><span class="op" id="3491915">}</span>
</div>
</body>
</html>
