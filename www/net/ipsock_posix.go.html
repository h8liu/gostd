<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1448410">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1448466">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1448520">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1448571">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1448649">//&nbsp;Internet&nbsp;protocol&nbsp;family&nbsp;sockets&nbsp;for&nbsp;POSIX</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1448696">package</span>&nbsp;<span class="ident" id="1448704">net</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1448709">import</span>&nbsp;<span class="op" id="1448716">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1448719">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1448730">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="1448737">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="1448740">func</span>&nbsp;<span class="ident" id="1448745">probeIPv4Stack</span><span class="op" id="1448759">(</span><span class="op" id="1448760">)</span>&nbsp;<span class="builtintype" id="1448762">bool</span>&nbsp;<span class="op" id="1448767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448770">s</span><span class="op" id="1448771">,</span>&nbsp;<span class="ident" id="1448773">err</span>&nbsp;<span class="op" id="1448777">:=</span>&nbsp;<span class="ident" id="1448780"><a href="/net/ipsock_posix.go.html#1448719">syscall</a></span><span class="op" id="1448787">.</span><span class="ident" id="1448788">Socket</span><span class="op" id="1448794">(</span><span class="ident" id="1448795"><a href="/net/ipsock_posix.go.html#1448719">syscall</a></span><span class="op" id="1448802">.</span><span class="ident" id="1448803">AF_INET</span><span class="op" id="1448810">,</span>&nbsp;<span class="ident" id="1448812"><a href="/net/ipsock_posix.go.html#1448719">syscall</a></span><span class="op" id="1448819">.</span><span class="ident" id="1448820">SOCK_STREAM</span><span class="op" id="1448831">,</span>&nbsp;<span class="ident" id="1448833"><a href="/net/ipsock_posix.go.html#1448719">syscall</a></span><span class="op" id="1448840">.</span><span class="ident" id="1448841">IPPROTO_TCP</span><span class="op" id="1448852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1448855">switch</span>&nbsp;<span class="ident" id="1448862"><a href="/net/ipsock_posix.go.html#1448773">err</a></span>&nbsp;<span class="op" id="1448866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1448869">case</span>&nbsp;<span class="ident" id="1448874"><a href="/net/ipsock_posix.go.html#1448719">syscall</a></span><span class="op" id="1448881">.</span><span class="ident" id="1448882">EAFNOSUPPORT</span><span class="op" id="1448894">,</span>&nbsp;<span class="ident" id="1448896"><a href="/net/ipsock_posix.go.html#1448719">syscall</a></span><span class="op" id="1448903">.</span><span class="ident" id="1448904">EPROTONOSUPPORT</span><span class="op" id="1448919">:</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1448923">return</span>&nbsp;<span class="builtintype" id="1448930">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1448937">case</span>&nbsp;<span class="ident" id="1448942">nil</span><span class="op" id="1448945">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448949"><a href="/net/fd_unix.go.html#1400109">closesocket</a></span><span class="op" id="1448960">(</span><span class="ident" id="1448961"><a href="/net/ipsock_posix.go.html#1448770">s</a></span><span class="op" id="1448962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1448965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1448968">return</span>&nbsp;<span class="builtintype" id="1448975">true</span><br>
<span class="lineno">25</span><span class="op" id="1448980">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1448983">//&nbsp;Should&nbsp;we&nbsp;try&nbsp;to&nbsp;use&nbsp;the&nbsp;IPv4&nbsp;socket&nbsp;interface&nbsp;if&nbsp;we&#39;re</span><br>
<span class="lineno"></span><span class="comment" id="1449042">//&nbsp;only&nbsp;dealing&nbsp;with&nbsp;IPv4&nbsp;sockets?&nbsp;&nbsp;As&nbsp;long&nbsp;as&nbsp;the&nbsp;host&nbsp;system</span><br>
<span class="lineno"></span><span class="comment" id="1449105">//&nbsp;understands&nbsp;IPv6,&nbsp;it&#39;s&nbsp;okay&nbsp;to&nbsp;pass&nbsp;IPv4&nbsp;addresses&nbsp;to&nbsp;the&nbsp;IPv6</span><br>
<span class="lineno">30</span><span class="comment" id="1449171">//&nbsp;interface.&nbsp;&nbsp;That&nbsp;simplifies&nbsp;our&nbsp;code&nbsp;and&nbsp;is&nbsp;most&nbsp;general.</span><br>
<span class="lineno"></span><span class="comment" id="1449232">//&nbsp;Unfortunately,&nbsp;we&nbsp;need&nbsp;to&nbsp;run&nbsp;on&nbsp;kernels&nbsp;built&nbsp;without&nbsp;IPv6</span><br>
<span class="lineno"></span><span class="comment" id="1449295">//&nbsp;support&nbsp;too.&nbsp;&nbsp;So&nbsp;probe&nbsp;the&nbsp;kernel&nbsp;to&nbsp;figure&nbsp;it&nbsp;out.</span><br>
<span class="lineno"></span><span class="comment" id="1449350">//</span><br>
<span class="lineno"></span><span class="comment" id="1449353">//&nbsp;probeIPv6Stack&nbsp;probes&nbsp;both&nbsp;basic&nbsp;IPv6&nbsp;capability&nbsp;and&nbsp;IPv6&nbsp;IPv4-</span><br>
<span class="lineno">35</span><span class="comment" id="1449420">//&nbsp;mapping&nbsp;capability&nbsp;which&nbsp;is&nbsp;controlled&nbsp;by&nbsp;IPV6_V6ONLY&nbsp;socket</span><br>
<span class="lineno"></span><span class="comment" id="1449484">//&nbsp;option&nbsp;and/or&nbsp;kernel&nbsp;state&nbsp;&#34;net.inet6.ip6.v6only&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="1449538">//&nbsp;It&nbsp;returns&nbsp;two&nbsp;boolean&nbsp;values.&nbsp;&nbsp;If&nbsp;the&nbsp;first&nbsp;boolean&nbsp;value&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1449603">//&nbsp;true,&nbsp;kernel&nbsp;supports&nbsp;basic&nbsp;IPv6&nbsp;functionality.&nbsp;&nbsp;If&nbsp;the&nbsp;second</span><br>
<span class="lineno"></span><span class="comment" id="1449669">//&nbsp;boolean&nbsp;value&nbsp;is&nbsp;true,&nbsp;kernel&nbsp;supports&nbsp;IPv6&nbsp;IPv4-mapping.</span><br>
<span class="lineno">40</span><span class="keyword" id="1449730">func</span>&nbsp;<span class="ident" id="1449735">probeIPv6Stack</span><span class="op" id="1449749">(</span><span class="op" id="1449750">)</span>&nbsp;<span class="op" id="1449752">(</span><span class="ident" id="1449753">supportsIPv6</span><span class="op" id="1449765">,</span>&nbsp;<span class="ident" id="1449767">supportsIPv4map</span>&nbsp;<span class="builtintype" id="1449783">bool</span><span class="op" id="1449787">)</span>&nbsp;<span class="op" id="1449789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1449792">var</span>&nbsp;<span class="ident" id="1449796">probes</span>&nbsp;<span class="op" id="1449803">=</span>&nbsp;<span class="op" id="1449805">[</span><span class="op" id="1449806">]</span><span class="keyword" id="1449807">struct</span>&nbsp;<span class="op" id="1449814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1449818">laddr</span>&nbsp;<span class="ident" id="1449824"><a href="/net/tcpsock.go.html#1504387">TCPAddr</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1449834">value</span>&nbsp;<span class="builtintype" id="1449840">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1449846">ok</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1449852">bool</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1449858">}</span><span class="op" id="1449859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1449863">//&nbsp;IPv6&nbsp;communication&nbsp;capability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1449898">{</span><span class="ident" id="1449899">laddr</span><span class="op" id="1449904">:</span>&nbsp;<span class="ident" id="1449906"><a href="/net/tcpsock.go.html#1504387">TCPAddr</a></span><span class="op" id="1449913">{</span><span class="ident" id="1449914">IP</span><span class="op" id="1449916">:</span>&nbsp;<span class="ident" id="1449918"><a href="/net/ip.go.html#1430775">ParseIP</a></span><span class="op" id="1449925">(</span><span class="string" id="1449926">&#34;::1&#34;</span><span class="op" id="1449931">)</span><span class="op" id="1449932">}</span><span class="op" id="1449933">,</span>&nbsp;<span class="ident" id="1449935">value</span><span class="op" id="1449940">:</span>&nbsp;<span class="num" id="1449942">1</span><span class="op" id="1449943">}</span><span class="op" id="1449944">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1449948">//&nbsp;IPv6&nbsp;IPv4-mapped&nbsp;address&nbsp;communication&nbsp;capability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1450003">{</span><span class="ident" id="1450004">laddr</span><span class="op" id="1450009">:</span>&nbsp;<span class="ident" id="1450011"><a href="/net/tcpsock.go.html#1504387">TCPAddr</a></span><span class="op" id="1450018">{</span><span class="ident" id="1450019">IP</span><span class="op" id="1450021">:</span>&nbsp;<span class="ident" id="1450023"><a href="/net/ip.go.html#1417459">IPv4</a></span><span class="op" id="1450027">(</span><span class="num" id="1450028">127</span><span class="op" id="1450031">,</span>&nbsp;<span class="num" id="1450033">0</span><span class="op" id="1450034">,</span>&nbsp;<span class="num" id="1450036">0</span><span class="op" id="1450037">,</span>&nbsp;<span class="num" id="1450039">1</span><span class="op" id="1450040">)</span><span class="op" id="1450041">}</span><span class="op" id="1450042">,</span>&nbsp;<span class="ident" id="1450044">value</span><span class="op" id="1450049">:</span>&nbsp;<span class="num" id="1450051">0</span><span class="op" id="1450052">}</span><span class="op" id="1450053">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1450056">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1450060">for</span>&nbsp;<span class="ident" id="1450064">i</span>&nbsp;<span class="op" id="1450066">:=</span>&nbsp;<span class="keyword" id="1450069">range</span>&nbsp;<span class="ident" id="1450075"><a href="/net/ipsock_posix.go.html#1449796">probes</a></span>&nbsp;<span class="op" id="1450082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1450086">s</span><span class="op" id="1450087">,</span>&nbsp;<span class="ident" id="1450089">err</span>&nbsp;<span class="op" id="1450093">:=</span>&nbsp;<span class="ident" id="1450096"><a href="/net/ipsock_posix.go.html#1448719">syscall</a></span><span class="op" id="1450103">.</span><span class="ident" id="1450104">Socket</span><span class="op" id="1450110">(</span><span class="ident" id="1450111"><a href="/net/ipsock_posix.go.html#1448719">syscall</a></span><span class="op" id="1450118">.</span><span class="ident" id="1450119">AF_INET6</span><span class="op" id="1450127">,</span>&nbsp;<span class="ident" id="1450129"><a href="/net/ipsock_posix.go.html#1448719">syscall</a></span><span class="op" id="1450136">.</span><span class="ident" id="1450137">SOCK_STREAM</span><span class="op" id="1450148">,</span>&nbsp;<span class="ident" id="1450150"><a href="/net/ipsock_posix.go.html#1448719">syscall</a></span><span class="op" id="1450157">.</span><span class="ident" id="1450158">IPPROTO_TCP</span><span class="op" id="1450169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1450173">if</span>&nbsp;<span class="ident" id="1450176"><a href="/net/ipsock_posix.go.html#1450089">err</a></span>&nbsp;<span class="op" id="1450180">!=</span>&nbsp;<span class="ident" id="1450183">nil</span>&nbsp;<span class="op" id="1450187">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1450192">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1450203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1450207">defer</span>&nbsp;<span class="ident" id="1450213"><a href="/net/fd_unix.go.html#1400109">closesocket</a></span><span class="op" id="1450224">(</span><span class="ident" id="1450225"><a href="/net/ipsock_posix.go.html#1450086">s</a></span><span class="op" id="1450226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1450230"><a href="/net/ipsock_posix.go.html#1448719">syscall</a></span><span class="op" id="1450237">.</span><span class="ident" id="1450238">SetsockoptInt</span><span class="op" id="1450251">(</span><span class="ident" id="1450252"><a href="/net/ipsock_posix.go.html#1450086">s</a></span><span class="op" id="1450253">,</span>&nbsp;<span class="ident" id="1450255"><a href="/net/ipsock_posix.go.html#1448719">syscall</a></span><span class="op" id="1450262">.</span><span class="ident" id="1450263">IPPROTO_IPV6</span><span class="op" id="1450275">,</span>&nbsp;<span class="ident" id="1450277"><a href="/net/ipsock_posix.go.html#1448719">syscall</a></span><span class="op" id="1450284">.</span><span class="ident" id="1450285">IPV6_V6ONLY</span><span class="op" id="1450296">,</span>&nbsp;<span class="ident" id="1450298"><a href="/net/ipsock_posix.go.html#1449796">probes</a></span><span class="op" id="1450304">[</span><span class="ident" id="1450305"><a href="/net/ipsock_posix.go.html#1450064">i</a></span><span class="op" id="1450306">]</span><span class="op" id="1450307">.</span><span class="ident" id="1450308">value</span><span class="op" id="1450313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1450317">sa</span><span class="op" id="1450319">,</span>&nbsp;<span class="ident" id="1450321"><a href="/net/ipsock_posix.go.html#1450089">err</a></span>&nbsp;<span class="op" id="1450325">:=</span>&nbsp;<span class="ident" id="1450328"><a href="/net/ipsock_posix.go.html#1449796">probes</a></span><span class="op" id="1450334">[</span><span class="ident" id="1450335"><a href="/net/ipsock_posix.go.html#1450064">i</a></span><span class="op" id="1450336">]</span><span class="op" id="1450337">.</span><span class="ident" id="1450338">laddr</span><span class="op" id="1450343">.</span><span class="ident" id="1450344">sockaddr</span><span class="op" id="1450352">(</span><span class="ident" id="1450353"><a href="/net/ipsock_posix.go.html#1448719">syscall</a></span><span class="op" id="1450360">.</span><span class="ident" id="1450361">AF_INET6</span><span class="op" id="1450369">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1450373">if</span>&nbsp;<span class="ident" id="1450376"><a href="/net/ipsock_posix.go.html#1450089">err</a></span>&nbsp;<span class="op" id="1450380">!=</span>&nbsp;<span class="ident" id="1450383">nil</span>&nbsp;<span class="op" id="1450387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1450392">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1450403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1450407">if</span>&nbsp;<span class="ident" id="1450410">err</span>&nbsp;<span class="op" id="1450414">:=</span>&nbsp;<span class="ident" id="1450417"><a href="/net/ipsock_posix.go.html#1448719">syscall</a></span><span class="op" id="1450424">.</span><span class="ident" id="1450425">Bind</span><span class="op" id="1450429">(</span><span class="ident" id="1450430"><a href="/net/ipsock_posix.go.html#1450086">s</a></span><span class="op" id="1450431">,</span>&nbsp;<span class="ident" id="1450433"><a href="/net/ipsock_posix.go.html#1450317">sa</a></span><span class="op" id="1450435">)</span><span class="op" id="1450436">;</span>&nbsp;<span class="ident" id="1450438"><a href="/net/ipsock_posix.go.html#1450410">err</a></span>&nbsp;<span class="op" id="1450442">!=</span>&nbsp;<span class="ident" id="1450445">nil</span>&nbsp;<span class="op" id="1450449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1450454">continue</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1450465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1450469"><a href="/net/ipsock_posix.go.html#1449796">probes</a></span><span class="op" id="1450475">[</span><span class="ident" id="1450476"><a href="/net/ipsock_posix.go.html#1450064">i</a></span><span class="op" id="1450477">]</span><span class="op" id="1450478">.</span><span class="ident" id="1450479">ok</span>&nbsp;<span class="op" id="1450482">=</span>&nbsp;<span class="builtintype" id="1450484">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1450490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1450494">return</span>&nbsp;<span class="ident" id="1450501"><a href="/net/ipsock_posix.go.html#1449796">probes</a></span><span class="op" id="1450507">[</span><span class="num" id="1450508">0</span><span class="op" id="1450509">]</span><span class="op" id="1450510">.</span><span class="ident" id="1450511">ok</span><span class="op" id="1450513">,</span>&nbsp;<span class="ident" id="1450515"><a href="/net/ipsock_posix.go.html#1449796">probes</a></span><span class="op" id="1450521">[</span><span class="num" id="1450522">1</span><span class="op" id="1450523">]</span><span class="op" id="1450524">.</span><span class="ident" id="1450525">ok</span><br>
<span class="lineno">70</span><span class="op" id="1450528">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1450531">//&nbsp;favoriteAddrFamily&nbsp;returns&nbsp;the&nbsp;appropriate&nbsp;address&nbsp;family&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1450595">//&nbsp;the&nbsp;given&nbsp;net,&nbsp;laddr,&nbsp;raddr&nbsp;and&nbsp;mode.&nbsp;&nbsp;At&nbsp;first&nbsp;it&nbsp;figures</span><br>
<span class="lineno"></span><span class="comment" id="1450657">//&nbsp;address&nbsp;family&nbsp;out&nbsp;from&nbsp;the&nbsp;net.&nbsp;&nbsp;If&nbsp;mode&nbsp;indicates&nbsp;&#34;listen&#34;</span><br>
<span class="lineno">75</span><span class="comment" id="1450721">//&nbsp;and&nbsp;laddr&nbsp;is&nbsp;a&nbsp;wildcard,&nbsp;it&nbsp;assumes&nbsp;that&nbsp;the&nbsp;user&nbsp;wants&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1450783">//&nbsp;make&nbsp;a&nbsp;passive&nbsp;connection&nbsp;with&nbsp;a&nbsp;wildcard&nbsp;address&nbsp;family,&nbsp;both</span><br>
<span class="lineno"></span><span class="comment" id="1450849">//&nbsp;AF_INET&nbsp;and&nbsp;AF_INET6,&nbsp;and&nbsp;a&nbsp;wildcard&nbsp;address&nbsp;like&nbsp;following:</span><br>
<span class="lineno"></span><span class="comment" id="1450913">//</span><br>
<span class="lineno"></span><span class="comment" id="1450916">//&nbsp;&nbsp;&nbsp;&nbsp1.&nbsp;A&nbsp;wild-wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;&#34;</span><br>
<span class="lineno">80</span><span class="comment" id="1450953">//&nbsp;&nbsp;&nbsp;&nbspIf&nbsp;the&nbsp;platform&nbsp;supports&nbsp;both&nbsp;IPv6&nbsp;and&nbsp;IPv6&nbsp;IPv4-mapping</span><br>
<span class="lineno"></span><span class="comment" id="1451013">//&nbsp;&nbsp;&nbsp;&nbspcapabilities,&nbsp;we&nbsp;assume&nbsp;that&nbsp;the&nbsp;user&nbsp;want&nbsp;to&nbsp;listen&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="1451072">//&nbsp;&nbsp;&nbsp;&nbspboth&nbsp;IPv4&nbsp;and&nbsp;IPv6&nbsp;wildcard&nbsp;address&nbsp;over&nbsp;an&nbsp;AF_INET6</span><br>
<span class="lineno"></span><span class="comment" id="1451128">//&nbsp;&nbsp;&nbsp;&nbspsocket&nbsp;with&nbsp;IPV6_V6ONLY=0.&nbsp;&nbsp;Otherwise&nbsp;we&nbsp;prefer&nbsp;an&nbsp;IPv4</span><br>
<span class="lineno"></span><span class="comment" id="1451187">//&nbsp;&nbsp;&nbsp;&nbspwildcard&nbsp;address&nbsp;listen&nbsp;over&nbsp;an&nbsp;AF_INET&nbsp;socket.</span><br>
<span class="lineno">85</span><span class="comment" id="1451238">//</span><br>
<span class="lineno"></span><span class="comment" id="1451241">//&nbsp;&nbsp;&nbsp;&nbsp2.&nbsp;A&nbsp;wild-ipv4wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;0.0.0.0&#34;</span><br>
<span class="lineno"></span><span class="comment" id="1451289">//&nbsp;&nbsp;&nbsp;&nbspSame&nbsp;as&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="1451303">//</span><br>
<span class="lineno"></span><span class="comment" id="1451306">//&nbsp;&nbsp;&nbsp;&nbsp3.&nbsp;A&nbsp;wild-ipv6wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;[::]&#34;</span><br>
<span class="lineno">90</span><span class="comment" id="1451351">//&nbsp;&nbsp;&nbsp;&nbspAlmost&nbsp;same&nbsp;as&nbsp;1&nbsp;but&nbsp;we&nbsp;prefer&nbsp;an&nbsp;IPv6&nbsp;wildcard&nbsp;address</span><br>
<span class="lineno"></span><span class="comment" id="1451410">//&nbsp;&nbsp;&nbsp;&nbsplisten&nbsp;over&nbsp;an&nbsp;AF_INET6&nbsp;socket&nbsp;with&nbsp;IPV6_V6ONLY=0&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="1451468">//&nbsp;&nbsp;&nbsp;&nbspthe&nbsp;platform&nbsp;supports&nbsp;IPv6&nbsp;capability&nbsp;but&nbsp;not&nbsp;IPv6&nbsp;IPv4-</span><br>
<span class="lineno"></span><span class="comment" id="1451528">//&nbsp;&nbsp;&nbsp;&nbspmapping&nbsp;capability.</span><br>
<span class="lineno"></span><span class="comment" id="1451551">//</span><br>
<span class="lineno">95</span><span class="comment" id="1451554">//&nbsp;&nbsp;&nbsp;&nbsp4.&nbsp;A&nbsp;ipv4-ipv4wild&nbsp;listen,&nbsp;&#34;tcp4&#34;&nbsp;+&nbsp;&#34;&#34;&nbsp;or&nbsp;&#34;0.0.0.0&#34;</span><br>
<span class="lineno"></span><span class="comment" id="1451609">//&nbsp;&nbsp;&nbsp;&nbspWe&nbsp;use&nbsp;an&nbsp;IPv4&nbsp;(AF_INET)&nbsp;wildcard&nbsp;address&nbsp;listen.</span><br>
<span class="lineno"></span><span class="comment" id="1451662">//</span><br>
<span class="lineno"></span><span class="comment" id="1451665">//&nbsp;&nbsp;&nbsp;&nbsp5.&nbsp;A&nbsp;ipv6-ipv6wild&nbsp;listen,&nbsp;&#34;tcp6&#34;&nbsp;+&nbsp;&#34;&#34;&nbsp;or&nbsp;&#34;[::]&#34;</span><br>
<span class="lineno"></span><span class="comment" id="1451717">//&nbsp;&nbsp;&nbsp;&nbspWe&nbsp;use&nbsp;an&nbsp;IPv6&nbsp;(AF_INET6,&nbsp;IPV6_V6ONLY=1)&nbsp;wildcard&nbsp;address</span><br>
<span class="lineno">100</span><span class="comment" id="1451778">//&nbsp;&nbsp;&nbsp;&nbsplisten.</span><br>
<span class="lineno"></span><span class="comment" id="1451789">//</span><br>
<span class="lineno"></span><span class="comment" id="1451792">//&nbsp;Otherwise&nbsp;guess:&nbsp;if&nbsp;the&nbsp;addresses&nbsp;are&nbsp;IPv4&nbsp;then&nbsp;returns&nbsp;AF_INET,</span><br>
<span class="lineno"></span><span class="comment" id="1451860">//&nbsp;or&nbsp;else&nbsp;returns&nbsp;AF_INET6.&nbsp;&nbsp;It&nbsp;also&nbsp;returns&nbsp;a&nbsp;boolean&nbsp;value&nbsp;what</span><br>
<span class="lineno"></span><span class="comment" id="1451927">//&nbsp;designates&nbsp;IPV6_V6ONLY&nbsp;option.</span><br>
<span class="lineno">105</span><span class="comment" id="1451961">//</span><br>
<span class="lineno"></span><span class="comment" id="1451964">//&nbsp;Note&nbsp;that&nbsp;OpenBSD&nbsp;allows&nbsp;neither&nbsp;&#34;net.inet6.ip6.v6only=1&#34;&nbsp;change</span><br>
<span class="lineno"></span><span class="comment" id="1452032">//&nbsp;nor&nbsp;IPPROTO_IPV6&nbsp;level&nbsp;IPV6_V6ONLY&nbsp;socket&nbsp;option&nbsp;setting.</span><br>
<span class="lineno"></span><span class="keyword" id="1452093">func</span>&nbsp;<span class="ident" id="1452098">favoriteAddrFamily</span><span class="op" id="1452116">(</span><span class="ident" id="1452117">net</span>&nbsp;<span class="builtintype" id="1452121">string</span><span class="op" id="1452127">,</span>&nbsp;<span class="ident" id="1452129">laddr</span><span class="op" id="1452134">,</span>&nbsp;<span class="ident" id="1452136">raddr</span>&nbsp;<span class="ident" id="1452142"><a href="/net/sock_posix.go.html#1492167">sockaddr</a></span><span class="op" id="1452150">,</span>&nbsp;<span class="ident" id="1452152">mode</span>&nbsp;<span class="builtintype" id="1452157">string</span><span class="op" id="1452163">)</span>&nbsp;<span class="op" id="1452165">(</span><span class="ident" id="1452166">family</span>&nbsp;<span class="builtintype" id="1452173">int</span><span class="op" id="1452176">,</span>&nbsp;<span class="ident" id="1452178">ipv6only</span>&nbsp;<span class="builtintype" id="1452187">bool</span><span class="op" id="1452191">)</span>&nbsp;<span class="op" id="1452193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452196">switch</span>&nbsp;<span class="ident" id="1452203"><a href="/net/ipsock_posix.go.html#1452117">net</a></span><span class="op" id="1452206">[</span><span class="builtinfunc" id="1452207">len</span><span class="op" id="1452210">(</span><span class="ident" id="1452211"><a href="/net/ipsock_posix.go.html#1452117">net</a></span><span class="op" id="1452214">)</span><span class="op" id="1452215">-</span><span class="num" id="1452216">1</span><span class="op" id="1452217">]</span>&nbsp;<span class="op" id="1452219">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452222">case</span>&nbsp;<span class="string" id="1452227">&#39;4&#39;</span><span class="op" id="1452230">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452234">return</span>&nbsp;<span class="ident" id="1452241"><a href="/net/ipsock_posix.go.html#1448719">syscall</a></span><span class="op" id="1452248">.</span><span class="ident" id="1452249">AF_INET</span><span class="op" id="1452256">,</span>&nbsp;<span class="builtintype" id="1452258">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452265">case</span>&nbsp;<span class="string" id="1452270">&#39;6&#39;</span><span class="op" id="1452273">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452277">return</span>&nbsp;<span class="ident" id="1452284"><a href="/net/ipsock_posix.go.html#1448719">syscall</a></span><span class="op" id="1452291">.</span><span class="ident" id="1452292">AF_INET6</span><span class="op" id="1452300">,</span>&nbsp;<span class="builtintype" id="1452302">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1452308">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452312">if</span>&nbsp;<span class="ident" id="1452315"><a href="/net/ipsock_posix.go.html#1452152">mode</a></span>&nbsp;<span class="op" id="1452320">==</span>&nbsp;<span class="string" id="1452323">&#34;listen&#34;</span>&nbsp;<span class="op" id="1452332">&amp;&amp;</span>&nbsp;<span class="op" id="1452335">(</span><span class="ident" id="1452336"><a href="/net/ipsock_posix.go.html#1452129">laddr</a></span>&nbsp;<span class="op" id="1452342">==</span>&nbsp;<span class="ident" id="1452345">nil</span>&nbsp;<span class="op" id="1452349">||</span>&nbsp;<span class="ident" id="1452352"><a href="/net/ipsock_posix.go.html#1452129">laddr</a></span><span class="op" id="1452357">.</span><span class="ident" id="1452358">isWildcard</span><span class="op" id="1452368">(</span><span class="op" id="1452369">)</span><span class="op" id="1452370">)</span>&nbsp;<span class="op" id="1452372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452376">if</span>&nbsp;<span class="ident" id="1452379"><a href="/net/ipsock.go.html#1440829">supportsIPv4map</a></span>&nbsp;<span class="op" id="1452395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452400">return</span>&nbsp;<span class="ident" id="1452407"><a href="/net/ipsock_posix.go.html#1448719">syscall</a></span><span class="op" id="1452414">.</span><span class="ident" id="1452415">AF_INET6</span><span class="op" id="1452423">,</span>&nbsp;<span class="builtintype" id="1452425">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1452433">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452437">if</span>&nbsp;<span class="ident" id="1452440"><a href="/net/ipsock_posix.go.html#1452129">laddr</a></span>&nbsp;<span class="op" id="1452446">==</span>&nbsp;<span class="ident" id="1452449">nil</span>&nbsp;<span class="op" id="1452453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452458">return</span>&nbsp;<span class="ident" id="1452465"><a href="/net/ipsock_posix.go.html#1448719">syscall</a></span><span class="op" id="1452472">.</span><span class="ident" id="1452473">AF_INET</span><span class="op" id="1452480">,</span>&nbsp;<span class="builtintype" id="1452482">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1452490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452494">return</span>&nbsp;<span class="ident" id="1452501"><a href="/net/ipsock_posix.go.html#1452129">laddr</a></span><span class="op" id="1452506">.</span><span class="ident" id="1452507">family</span><span class="op" id="1452513">(</span><span class="op" id="1452514">)</span><span class="op" id="1452515">,</span>&nbsp;<span class="builtintype" id="1452517">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1452524">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452528">if</span>&nbsp;<span class="op" id="1452531">(</span><span class="ident" id="1452532"><a href="/net/ipsock_posix.go.html#1452129">laddr</a></span>&nbsp;<span class="op" id="1452538">==</span>&nbsp;<span class="ident" id="1452541">nil</span>&nbsp;<span class="op" id="1452545">||</span>&nbsp;<span class="ident" id="1452548"><a href="/net/ipsock_posix.go.html#1452129">laddr</a></span><span class="op" id="1452553">.</span><span class="ident" id="1452554">family</span><span class="op" id="1452560">(</span><span class="op" id="1452561">)</span>&nbsp;<span class="op" id="1452563">==</span>&nbsp;<span class="ident" id="1452566"><a href="/net/ipsock_posix.go.html#1448719">syscall</a></span><span class="op" id="1452573">.</span><span class="ident" id="1452574">AF_INET</span><span class="op" id="1452581">)</span>&nbsp;<span class="op" id="1452583">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1452588">(</span><span class="ident" id="1452589"><a href="/net/ipsock_posix.go.html#1452136">raddr</a></span>&nbsp;<span class="op" id="1452595">==</span>&nbsp;<span class="ident" id="1452598">nil</span>&nbsp;<span class="op" id="1452602">||</span>&nbsp;<span class="ident" id="1452605"><a href="/net/ipsock_posix.go.html#1452136">raddr</a></span><span class="op" id="1452610">.</span><span class="ident" id="1452611">family</span><span class="op" id="1452617">(</span><span class="op" id="1452618">)</span>&nbsp;<span class="op" id="1452620">==</span>&nbsp;<span class="ident" id="1452623"><a href="/net/ipsock_posix.go.html#1448719">syscall</a></span><span class="op" id="1452630">.</span><span class="ident" id="1452631">AF_INET</span><span class="op" id="1452638">)</span>&nbsp;<span class="op" id="1452640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452644">return</span>&nbsp;<span class="ident" id="1452651"><a href="/net/ipsock_posix.go.html#1448719">syscall</a></span><span class="op" id="1452658">.</span><span class="ident" id="1452659">AF_INET</span><span class="op" id="1452666">,</span>&nbsp;<span class="builtintype" id="1452668">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1452675">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452678">return</span>&nbsp;<span class="ident" id="1452685"><a href="/net/ipsock_posix.go.html#1448719">syscall</a></span><span class="op" id="1452692">.</span><span class="ident" id="1452693">AF_INET6</span><span class="op" id="1452701">,</span>&nbsp;<span class="builtintype" id="1452703">false</span><br>
<span class="lineno"></span><span class="op" id="1452709">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1452712">//&nbsp;Internet&nbsp;sockets&nbsp;(TCP,&nbsp;UDP,&nbsp;IP)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="1452748">func</span>&nbsp;<span class="ident" id="1452753">internetSocket</span><span class="op" id="1452767">(</span><span class="ident" id="1452768">net</span>&nbsp;<span class="builtintype" id="1452772">string</span><span class="op" id="1452778">,</span>&nbsp;<span class="ident" id="1452780">laddr</span><span class="op" id="1452785">,</span>&nbsp;<span class="ident" id="1452787">raddr</span>&nbsp;<span class="ident" id="1452793"><a href="/net/sock_posix.go.html#1492167">sockaddr</a></span><span class="op" id="1452801">,</span>&nbsp;<span class="ident" id="1452803">deadline</span>&nbsp;<span class="ident" id="1452812"><a href="/net/ipsock_posix.go.html#1448730">time</a></span><span class="op" id="1452816">.</span><span class="ident" id="1452817">Time</span><span class="op" id="1452821">,</span>&nbsp;<span class="ident" id="1452823">sotype</span><span class="op" id="1452829">,</span>&nbsp;<span class="ident" id="1452831">proto</span>&nbsp;<span class="builtintype" id="1452837">int</span><span class="op" id="1452840">,</span>&nbsp;<span class="ident" id="1452842">mode</span>&nbsp;<span class="builtintype" id="1452847">string</span><span class="op" id="1452853">)</span>&nbsp;<span class="op" id="1452855">(</span><span class="ident" id="1452856">fd</span>&nbsp;<span class="op" id="1452859">*</span><span class="ident" id="1452860"><a href="/net/fd_unix.go.html#1388279">netFD</a></span><span class="op" id="1452865">,</span>&nbsp;<span class="ident" id="1452867">err</span>&nbsp;<span class="builtintype" id="1452871">error</span><span class="op" id="1452876">)</span>&nbsp;<span class="op" id="1452878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452881">family</span><span class="op" id="1452887">,</span>&nbsp;<span class="ident" id="1452889">ipv6only</span>&nbsp;<span class="op" id="1452898">:=</span>&nbsp;<span class="ident" id="1452901"><a href="/net/ipsock_posix.go.html#1452098">favoriteAddrFamily</a></span><span class="op" id="1452919">(</span><span class="ident" id="1452920"><a href="/net/ipsock_posix.go.html#1452768">net</a></span><span class="op" id="1452923">,</span>&nbsp;<span class="ident" id="1452925"><a href="/net/ipsock_posix.go.html#1452780">laddr</a></span><span class="op" id="1452930">,</span>&nbsp;<span class="ident" id="1452932"><a href="/net/ipsock_posix.go.html#1452787">raddr</a></span><span class="op" id="1452937">,</span>&nbsp;<span class="ident" id="1452939"><a href="/net/ipsock_posix.go.html#1452842">mode</a></span><span class="op" id="1452943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452946">return</span>&nbsp;<span class="ident" id="1452953"><a href="/net/sock_posix.go.html#1492727">socket</a></span><span class="op" id="1452959">(</span><span class="ident" id="1452960"><a href="/net/ipsock_posix.go.html#1452768">net</a></span><span class="op" id="1452963">,</span>&nbsp;<span class="ident" id="1452965"><a href="/net/ipsock_posix.go.html#1452881">family</a></span><span class="op" id="1452971">,</span>&nbsp;<span class="ident" id="1452973"><a href="/net/ipsock_posix.go.html#1452823">sotype</a></span><span class="op" id="1452979">,</span>&nbsp;<span class="ident" id="1452981"><a href="/net/ipsock_posix.go.html#1452831">proto</a></span><span class="op" id="1452986">,</span>&nbsp;<span class="ident" id="1452988"><a href="/net/ipsock_posix.go.html#1452889">ipv6only</a></span><span class="op" id="1452996">,</span>&nbsp;<span class="ident" id="1452998"><a href="/net/ipsock_posix.go.html#1452780">laddr</a></span><span class="op" id="1453003">,</span>&nbsp;<span class="ident" id="1453005"><a href="/net/ipsock_posix.go.html#1452787">raddr</a></span><span class="op" id="1453010">,</span>&nbsp;<span class="ident" id="1453012"><a href="/net/ipsock_posix.go.html#1452803">deadline</a></span><span class="op" id="1453020">)</span><br>
<span class="lineno"></span><span class="op" id="1453022">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="1453025">func</span>&nbsp;<span class="ident" id="1453030">ipToSockaddr</span><span class="op" id="1453042">(</span><span class="ident" id="1453043">family</span>&nbsp;<span class="builtintype" id="1453050">int</span><span class="op" id="1453053">,</span>&nbsp;<span class="ident" id="1453055">ip</span>&nbsp;<span class="ident" id="1453058"><a href="/net/ip.go.html#1417189">IP</a></span><span class="op" id="1453060">,</span>&nbsp;<span class="ident" id="1453062">port</span>&nbsp;<span class="builtintype" id="1453067">int</span><span class="op" id="1453070">,</span>&nbsp;<span class="ident" id="1453072">zone</span>&nbsp;<span class="builtintype" id="1453077">string</span><span class="op" id="1453083">)</span>&nbsp;<span class="op" id="1453085">(</span><span class="ident" id="1453086"><a href="/net/ipsock_posix.go.html#1448719">syscall</a></span><span class="op" id="1453093">.</span><span class="ident" id="1453094">Sockaddr</span><span class="op" id="1453102">,</span>&nbsp;<span class="builtintype" id="1453104">error</span><span class="op" id="1453109">)</span>&nbsp;<span class="op" id="1453111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453114">switch</span>&nbsp;<span class="ident" id="1453121"><a href="/net/ipsock_posix.go.html#1453043">family</a></span>&nbsp;<span class="op" id="1453128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453131">case</span>&nbsp;<span class="ident" id="1453136"><a href="/net/ipsock_posix.go.html#1448719">syscall</a></span><span class="op" id="1453143">.</span><span class="ident" id="1453144">AF_INET</span><span class="op" id="1453151">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453155">if</span>&nbsp;<span class="builtinfunc" id="1453158">len</span><span class="op" id="1453161">(</span><span class="ident" id="1453162"><a href="/net/ipsock_posix.go.html#1453055">ip</a></span><span class="op" id="1453164">)</span>&nbsp;<span class="op" id="1453166">==</span>&nbsp;<span class="num" id="1453169">0</span>&nbsp;<span class="op" id="1453171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453176"><a href="/net/ipsock_posix.go.html#1453055">ip</a></span>&nbsp;<span class="op" id="1453179">=</span>&nbsp;<span class="ident" id="1453181"><a href="/net/ip.go.html#1418575">IPv4zero</a></span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453196">if</span>&nbsp;<span class="ident" id="1453199"><a href="/net/ipsock_posix.go.html#1453055">ip</a></span>&nbsp;<span class="op" id="1453202">=</span>&nbsp;<span class="ident" id="1453204"><a href="/net/ipsock_posix.go.html#1453055">ip</a></span><span class="op" id="1453206">.</span><span class="ident" id="1453207">To4</span><span class="op" id="1453210">(</span><span class="op" id="1453211">)</span><span class="op" id="1453212">;</span>&nbsp;<span class="ident" id="1453214"><a href="/net/ipsock_posix.go.html#1453055">ip</a></span>&nbsp;<span class="op" id="1453217">==</span>&nbsp;<span class="ident" id="1453220">nil</span>&nbsp;<span class="op" id="1453224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453229">return</span>&nbsp;<span class="ident" id="1453236">nil</span><span class="op" id="1453239">,</span>&nbsp;<span class="ident" id="1453241"><a href="/net/net.go.html#1474115">InvalidAddrError</a></span><span class="op" id="1453257">(</span><span class="string" id="1453258">&#34;non-IPv4&nbsp;address&#34;</span><span class="op" id="1453276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453284">sa</span>&nbsp;<span class="op" id="1453287">:=</span>&nbsp;<span class="builtinfunc" id="1453290">new</span><span class="op" id="1453293">(</span><span class="ident" id="1453294"><a href="/net/ipsock_posix.go.html#1448719">syscall</a></span><span class="op" id="1453301">.</span><span class="ident" id="1453302">SockaddrInet4</span><span class="op" id="1453315">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453319">for</span>&nbsp;<span class="ident" id="1453323">i</span>&nbsp;<span class="op" id="1453325">:=</span>&nbsp;<span class="num" id="1453328">0</span><span class="op" id="1453329">;</span>&nbsp;<span class="ident" id="1453331"><a href="/net/ipsock_posix.go.html#1453323">i</a></span>&nbsp;<span class="op" id="1453333">&lt;</span>&nbsp;<span class="ident" id="1453335"><a href="/net/ip.go.html#1416769">IPv4len</a></span><span class="op" id="1453342">;</span>&nbsp;<span class="ident" id="1453344"><a href="/net/ipsock_posix.go.html#1453323">i</a></span><span class="op" id="1453345">++</span>&nbsp;<span class="op" id="1453348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453353"><a href="/net/ipsock_posix.go.html#1453284">sa</a></span><span class="op" id="1453355">.</span><span class="ident" id="1453356">Addr</span><span class="op" id="1453360">[</span><span class="ident" id="1453361"><a href="/net/ipsock_posix.go.html#1453323">i</a></span><span class="op" id="1453362">]</span>&nbsp;<span class="op" id="1453364">=</span>&nbsp;<span class="ident" id="1453366"><a href="/net/ipsock_posix.go.html#1453055">ip</a></span><span class="op" id="1453368">[</span><span class="ident" id="1453369"><a href="/net/ipsock_posix.go.html#1453323">i</a></span><span class="op" id="1453370">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453374">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453378"><a href="/net/ipsock_posix.go.html#1453284">sa</a></span><span class="op" id="1453380">.</span><span class="ident" id="1453381">Port</span>&nbsp;<span class="op" id="1453386">=</span>&nbsp;<span class="ident" id="1453388"><a href="/net/ipsock_posix.go.html#1453062">port</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453395">return</span>&nbsp;<span class="ident" id="1453402"><a href="/net/ipsock_posix.go.html#1453284">sa</a></span><span class="op" id="1453404">,</span>&nbsp;<span class="ident" id="1453406">nil</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453411">case</span>&nbsp;<span class="ident" id="1453416"><a href="/net/ipsock_posix.go.html#1448719">syscall</a></span><span class="op" id="1453423">.</span><span class="ident" id="1453424">AF_INET6</span><span class="op" id="1453432">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453436">if</span>&nbsp;<span class="builtinfunc" id="1453439">len</span><span class="op" id="1453442">(</span><span class="ident" id="1453443"><a href="/net/ipsock_posix.go.html#1453055">ip</a></span><span class="op" id="1453445">)</span>&nbsp;<span class="op" id="1453447">==</span>&nbsp;<span class="num" id="1453450">0</span>&nbsp;<span class="op" id="1453452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453457"><a href="/net/ipsock_posix.go.html#1453055">ip</a></span>&nbsp;<span class="op" id="1453460">=</span>&nbsp;<span class="ident" id="1453462"><a href="/net/ip.go.html#1418668">IPv6zero</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1453477">//&nbsp;IPv4&nbsp;callers&nbsp;use&nbsp;0.0.0.0&nbsp;to&nbsp;mean&nbsp;&#34;announce&nbsp;on&nbsp;any&nbsp;available&nbsp;address&#34;.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1453552">//&nbsp;In&nbsp;IPv6&nbsp;mode,&nbsp;Linux&nbsp;treats&nbsp;that&nbsp;as&nbsp;meaning&nbsp;&#34;announce&nbsp;on&nbsp;0.0.0.0&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1453623">//&nbsp;which&nbsp;it&nbsp;refuses&nbsp;to&nbsp;do.&nbsp;&nbsp;Rewrite&nbsp;to&nbsp;the&nbsp;IPv6&nbsp;unspecified&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453694">if</span>&nbsp;<span class="ident" id="1453697"><a href="/net/ipsock_posix.go.html#1453055">ip</a></span><span class="op" id="1453699">.</span><span class="ident" id="1453700">Equal</span><span class="op" id="1453705">(</span><span class="ident" id="1453706"><a href="/net/ip.go.html#1418575">IPv4zero</a></span><span class="op" id="1453714">)</span>&nbsp;<span class="op" id="1453716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453721"><a href="/net/ipsock_posix.go.html#1453055">ip</a></span>&nbsp;<span class="op" id="1453724">=</span>&nbsp;<span class="ident" id="1453726"><a href="/net/ip.go.html#1418668">IPv6zero</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453737">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453741">if</span>&nbsp;<span class="ident" id="1453744"><a href="/net/ipsock_posix.go.html#1453055">ip</a></span>&nbsp;<span class="op" id="1453747">=</span>&nbsp;<span class="ident" id="1453749"><a href="/net/ipsock_posix.go.html#1453055">ip</a></span><span class="op" id="1453751">.</span><span class="ident" id="1453752">To16</span><span class="op" id="1453756">(</span><span class="op" id="1453757">)</span><span class="op" id="1453758">;</span>&nbsp;<span class="ident" id="1453760"><a href="/net/ipsock_posix.go.html#1453055">ip</a></span>&nbsp;<span class="op" id="1453763">==</span>&nbsp;<span class="ident" id="1453766">nil</span>&nbsp;<span class="op" id="1453770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453775">return</span>&nbsp;<span class="ident" id="1453782">nil</span><span class="op" id="1453785">,</span>&nbsp;<span class="ident" id="1453787"><a href="/net/net.go.html#1474115">InvalidAddrError</a></span><span class="op" id="1453803">(</span><span class="string" id="1453804">&#34;non-IPv6&nbsp;address&#34;</span><span class="op" id="1453822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453830">sa</span>&nbsp;<span class="op" id="1453833">:=</span>&nbsp;<span class="builtinfunc" id="1453836">new</span><span class="op" id="1453839">(</span><span class="ident" id="1453840"><a href="/net/ipsock_posix.go.html#1448719">syscall</a></span><span class="op" id="1453847">.</span><span class="ident" id="1453848">SockaddrInet6</span><span class="op" id="1453861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453865">for</span>&nbsp;<span class="ident" id="1453869">i</span>&nbsp;<span class="op" id="1453871">:=</span>&nbsp;<span class="num" id="1453874">0</span><span class="op" id="1453875">;</span>&nbsp;<span class="ident" id="1453877"><a href="/net/ipsock_posix.go.html#1453869">i</a></span>&nbsp;<span class="op" id="1453879">&lt;</span>&nbsp;<span class="ident" id="1453881"><a href="/net/ip.go.html#1416782">IPv6len</a></span><span class="op" id="1453888">;</span>&nbsp;<span class="ident" id="1453890"><a href="/net/ipsock_posix.go.html#1453869">i</a></span><span class="op" id="1453891">++</span>&nbsp;<span class="op" id="1453894">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453899"><a href="/net/ipsock_posix.go.html#1453830">sa</a></span><span class="op" id="1453901">.</span><span class="ident" id="1453902">Addr</span><span class="op" id="1453906">[</span><span class="ident" id="1453907"><a href="/net/ipsock_posix.go.html#1453869">i</a></span><span class="op" id="1453908">]</span>&nbsp;<span class="op" id="1453910">=</span>&nbsp;<span class="ident" id="1453912"><a href="/net/ipsock_posix.go.html#1453055">ip</a></span><span class="op" id="1453914">[</span><span class="ident" id="1453915"><a href="/net/ipsock_posix.go.html#1453869">i</a></span><span class="op" id="1453916">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453924"><a href="/net/ipsock_posix.go.html#1453830">sa</a></span><span class="op" id="1453926">.</span><span class="ident" id="1453927">Port</span>&nbsp;<span class="op" id="1453932">=</span>&nbsp;<span class="ident" id="1453934"><a href="/net/ipsock_posix.go.html#1453062">port</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453941"><a href="/net/ipsock_posix.go.html#1453830">sa</a></span><span class="op" id="1453943">.</span><span class="ident" id="1453944">ZoneId</span>&nbsp;<span class="op" id="1453951">=</span>&nbsp;<span class="builtintype" id="1453953">uint32</span><span class="op" id="1453959">(</span><span class="ident" id="1453960"><a href="/net/ipsock.go.html#1448237">zoneToInt</a></span><span class="op" id="1453969">(</span><span class="ident" id="1453970"><a href="/net/ipsock_posix.go.html#1453072">zone</a></span><span class="op" id="1453974">)</span><span class="op" id="1453975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453979">return</span>&nbsp;<span class="ident" id="1453986"><a href="/net/ipsock_posix.go.html#1453830">sa</a></span><span class="op" id="1453988">,</span>&nbsp;<span class="ident" id="1453990">nil</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453998">return</span>&nbsp;<span class="ident" id="1454005">nil</span><span class="op" id="1454008">,</span>&nbsp;<span class="ident" id="1454010"><a href="/net/net.go.html#1474115">InvalidAddrError</a></span><span class="op" id="1454026">(</span><span class="string" id="1454027">&#34;unexpected&nbsp;socket&nbsp;family&#34;</span><span class="op" id="1454053">)</span><br>
<span class="lineno"></span><span class="op" id="1454055">}</span>
</div>
</body>
</html>
