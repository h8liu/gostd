<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/gob</h2>
<ul>
<li><a href="/gostd/encoding/gob/codec_test.go.html">codec_test.go</a></li>
<li><a href="/gostd/encoding/gob/dec_helpers.go.html">dec_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/gob/decoder.go.html">decoder.go</a></li>
<li><a href="/gostd/encoding/gob/doc.go.html">doc.go</a></li>
<li><a href="/gostd/encoding/gob/enc_helpers.go.html">enc_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/encode.go.html">encode.go</a></li>
<li><a href="/gostd/encoding/gob/encoder.go.html">encoder.go</a></li>
<li><a href="/gostd/encoding/gob/encoder_test.go.html">encoder_test.go</a></li>
<li><a href="/gostd/encoding/gob/error.go.html">error.go</a></li>
<li><a href="/gostd/encoding/gob/example_encdec_test.go.html">example_encdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_interface_test.go.html">example_interface_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/gob/gobencdec_test.go.html">gobencdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/timing_test.go.html">timing_test.go</a></li>
<li><a href="/gostd/encoding/gob/type.go.html">type.go</a></li>
<li><a href="/gostd/encoding/gob/type_test.go.html">type_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3986041">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3986096">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3986150">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3986201">//go:generate&nbsp;go&nbsp;run&nbsp;encgen.go&nbsp;-output&nbsp;enc_helpers.go</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3986256">package</span>&nbsp;<span class="ident" id="3986264">gob</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3986269">import</span>&nbsp;<span class="op" id="3986276">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3986279">&#34;encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3986291">&#34;math&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3986299">&#34;reflect&#34;</span><br>
<span class="lineno"></span><span class="op" id="3986309">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="3986312">const</span>&nbsp;<span class="ident" id="3986318">uint64Size</span>&nbsp;<span class="op" id="3986329">=</span>&nbsp;<span class="num" id="3986331">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3986334">type</span>&nbsp;<span class="ident" id="3986339">encHelper</span>&nbsp;<span class="keyword" id="3986349">func</span><span class="op" id="3986353">(</span><span class="ident" id="3986354">state</span>&nbsp;<span class="op" id="3986360">*</span><span class="ident" id="3986361">encoderState</span><span class="op" id="3986373">,</span>&nbsp;<span class="ident" id="3986375">v</span>&nbsp;<span class="ident" id="3986377">reflect</span><span class="op" id="3986384">.</span><span class="ident" id="3986385">Value</span><span class="op" id="3986390">)</span>&nbsp;<span class="builtintype" id="3986392">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3986398">//&nbsp;encoderState&nbsp;is&nbsp;the&nbsp;global&nbsp;execution&nbsp;state&nbsp;of&nbsp;an&nbsp;instance&nbsp;of&nbsp;the&nbsp;encoder.</span><br>
<span class="lineno">20</span><span class="comment" id="3986475">//&nbsp;Field&nbsp;numbers&nbsp;are&nbsp;delta&nbsp;encoded&nbsp;and&nbsp;always&nbsp;increase.&nbsp;The&nbsp;field</span><br>
<span class="lineno"></span><span class="comment" id="3986541">//&nbsp;number&nbsp;is&nbsp;initialized&nbsp;to&nbsp;-1&nbsp;so&nbsp;0&nbsp;comes&nbsp;out&nbsp;as&nbsp;delta(1).&nbsp;A&nbsp;delta&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3986611">//&nbsp;0&nbsp;terminates&nbsp;the&nbsp;structure.</span><br>
<span class="lineno"></span><span class="keyword" id="3986642">type</span>&nbsp;<span class="ident" id="3986647">encoderState</span>&nbsp;<span class="keyword" id="3986660">struct</span>&nbsp;<span class="op" id="3986667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3986670">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3986679">*</span><span class="ident" id="3986680">Encoder</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3986689">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3986698">*</span><span class="ident" id="3986699">encBuffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3986710">sendZero</span>&nbsp;<span class="builtintype" id="3986719">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3986740">//&nbsp;encoding&nbsp;an&nbsp;array&nbsp;element&nbsp;or&nbsp;map&nbsp;key/value&nbsp;pair;&nbsp;send&nbsp;zero&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3986810">fieldnum</span>&nbsp;<span class="builtintype" id="3986819">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3986840">//&nbsp;the&nbsp;last&nbsp;field&nbsp;number&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3986875">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3986884">[</span><span class="num" id="3986885">1</span>&nbsp;<span class="op" id="3986887">+</span>&nbsp;<span class="ident" id="3986889">uint64Size</span><span class="op" id="3986899">]</span><span class="builtintype" id="3986900">byte</span>&nbsp;<span class="comment" id="3986905">//&nbsp;buffer&nbsp;used&nbsp;by&nbsp;the&nbsp;encoder;&nbsp;here&nbsp;to&nbsp;avoid&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3986963">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3986972">*</span><span class="ident" id="3986973">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3986993">//&nbsp;for&nbsp;free&nbsp;list</span><br>
<span class="lineno">30</span><span class="op" id="3987010">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3987013">//&nbsp;encBuffer&nbsp;is&nbsp;an&nbsp;extremely&nbsp;simple,&nbsp;fast&nbsp;implementation&nbsp;of&nbsp;a&nbsp;write-only&nbsp;byte&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="comment" id="3987099">//&nbsp;It&nbsp;never&nbsp;returns&nbsp;a&nbsp;non-nil&nbsp;error,&nbsp;but&nbsp;Write&nbsp;returns&nbsp;an&nbsp;error&nbsp;value&nbsp;so&nbsp;it&nbsp;matches&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="3987194">type</span>&nbsp;<span class="ident" id="3987199">encBuffer</span>&nbsp;<span class="keyword" id="3987209">struct</span>&nbsp;<span class="op" id="3987216">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987219">data</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3987227">[</span><span class="op" id="3987228">]</span><span class="builtintype" id="3987229">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987235">scratch</span>&nbsp;<span class="op" id="3987243">[</span><span class="num" id="3987244">64</span><span class="op" id="3987246">]</span><span class="builtintype" id="3987247">byte</span><br>
<span class="lineno"></span><span class="op" id="3987252">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3987255">func</span>&nbsp;<span class="op" id="3987260">(</span><span class="ident" id="3987261">e</span>&nbsp;<span class="op" id="3987263">*</span><span class="ident" id="3987264">encBuffer</span><span class="op" id="3987273">)</span>&nbsp;<span class="ident" id="3987275">WriteByte</span><span class="op" id="3987284">(</span><span class="ident" id="3987285">c</span>&nbsp;<span class="builtintype" id="3987287">byte</span><span class="op" id="3987291">)</span>&nbsp;<span class="op" id="3987293">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987296">e</span><span class="op" id="3987297">.</span><span class="ident" id="3987298">data</span>&nbsp;<span class="op" id="3987303">=</span>&nbsp;<span class="builtinfunc" id="3987305">append</span><span class="op" id="3987311">(</span><span class="ident" id="3987312">e</span><span class="op" id="3987313">.</span><span class="ident" id="3987314">data</span><span class="op" id="3987318">,</span>&nbsp;<span class="ident" id="3987320">c</span><span class="op" id="3987321">)</span><br>
<span class="lineno"></span><span class="op" id="3987323">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3987326">func</span>&nbsp;<span class="op" id="3987331">(</span><span class="ident" id="3987332">e</span>&nbsp;<span class="op" id="3987334">*</span><span class="ident" id="3987335">encBuffer</span><span class="op" id="3987344">)</span>&nbsp;<span class="ident" id="3987346">Write</span><span class="op" id="3987351">(</span><span class="ident" id="3987352">p</span>&nbsp;<span class="op" id="3987354">[</span><span class="op" id="3987355">]</span><span class="builtintype" id="3987356">byte</span><span class="op" id="3987360">)</span>&nbsp;<span class="op" id="3987362">(</span><span class="builtintype" id="3987363">int</span><span class="op" id="3987366">,</span>&nbsp;<span class="builtintype" id="3987368">error</span><span class="op" id="3987373">)</span>&nbsp;<span class="op" id="3987375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987378">e</span><span class="op" id="3987379">.</span><span class="ident" id="3987380">data</span>&nbsp;<span class="op" id="3987385">=</span>&nbsp;<span class="builtinfunc" id="3987387">append</span><span class="op" id="3987393">(</span><span class="ident" id="3987394">e</span><span class="op" id="3987395">.</span><span class="ident" id="3987396">data</span><span class="op" id="3987400">,</span>&nbsp;<span class="ident" id="3987402">p</span><span class="op" id="3987403">...</span><span class="op" id="3987406">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3987409">return</span>&nbsp;<span class="builtinfunc" id="3987416">len</span><span class="op" id="3987419">(</span><span class="ident" id="3987420">p</span><span class="op" id="3987421">)</span><span class="op" id="3987422">,</span>&nbsp;<span class="ident" id="3987424">nil</span><br>
<span class="lineno"></span><span class="op" id="3987428">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3987431">func</span>&nbsp;<span class="op" id="3987436">(</span><span class="ident" id="3987437">e</span>&nbsp;<span class="op" id="3987439">*</span><span class="ident" id="3987440">encBuffer</span><span class="op" id="3987449">)</span>&nbsp;<span class="ident" id="3987451">WriteString</span><span class="op" id="3987462">(</span><span class="ident" id="3987463">s</span>&nbsp;<span class="builtintype" id="3987465">string</span><span class="op" id="3987471">)</span>&nbsp;<span class="op" id="3987473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987476">e</span><span class="op" id="3987477">.</span><span class="ident" id="3987478">data</span>&nbsp;<span class="op" id="3987483">=</span>&nbsp;<span class="builtinfunc" id="3987485">append</span><span class="op" id="3987491">(</span><span class="ident" id="3987492">e</span><span class="op" id="3987493">.</span><span class="ident" id="3987494">data</span><span class="op" id="3987498">,</span>&nbsp;<span class="ident" id="3987500">s</span><span class="op" id="3987501">...</span><span class="op" id="3987504">)</span><br>
<span class="lineno">50</span><span class="op" id="3987506">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3987509">func</span>&nbsp;<span class="op" id="3987514">(</span><span class="ident" id="3987515">e</span>&nbsp;<span class="op" id="3987517">*</span><span class="ident" id="3987518">encBuffer</span><span class="op" id="3987527">)</span>&nbsp;<span class="ident" id="3987529">Len</span><span class="op" id="3987532">(</span><span class="op" id="3987533">)</span>&nbsp;<span class="builtintype" id="3987535">int</span>&nbsp;<span class="op" id="3987539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3987542">return</span>&nbsp;<span class="builtinfunc" id="3987549">len</span><span class="op" id="3987552">(</span><span class="ident" id="3987553">e</span><span class="op" id="3987554">.</span><span class="ident" id="3987555">data</span><span class="op" id="3987559">)</span><br>
<span class="lineno"></span><span class="op" id="3987561">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="3987564">func</span>&nbsp;<span class="op" id="3987569">(</span><span class="ident" id="3987570">e</span>&nbsp;<span class="op" id="3987572">*</span><span class="ident" id="3987573">encBuffer</span><span class="op" id="3987582">)</span>&nbsp;<span class="ident" id="3987584">Bytes</span><span class="op" id="3987589">(</span><span class="op" id="3987590">)</span>&nbsp;<span class="op" id="3987592">[</span><span class="op" id="3987593">]</span><span class="builtintype" id="3987594">byte</span>&nbsp;<span class="op" id="3987599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3987602">return</span>&nbsp;<span class="ident" id="3987609">e</span><span class="op" id="3987610">.</span><span class="ident" id="3987611">data</span><br>
<span class="lineno"></span><span class="op" id="3987616">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="3987619">func</span>&nbsp;<span class="op" id="3987624">(</span><span class="ident" id="3987625">e</span>&nbsp;<span class="op" id="3987627">*</span><span class="ident" id="3987628">encBuffer</span><span class="op" id="3987637">)</span>&nbsp;<span class="ident" id="3987639">Reset</span><span class="op" id="3987644">(</span><span class="op" id="3987645">)</span>&nbsp;<span class="op" id="3987647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987650">e</span><span class="op" id="3987651">.</span><span class="ident" id="3987652">data</span>&nbsp;<span class="op" id="3987657">=</span>&nbsp;<span class="ident" id="3987659">e</span><span class="op" id="3987660">.</span><span class="ident" id="3987661">data</span><span class="op" id="3987665">[</span><span class="num" id="3987666">0</span><span class="op" id="3987667">:</span><span class="num" id="3987668">0</span><span class="op" id="3987669">]</span><br>
<span class="lineno"></span><span class="op" id="3987671">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3987674">func</span>&nbsp;<span class="op" id="3987679">(</span><span class="ident" id="3987680">enc</span>&nbsp;<span class="op" id="3987684">*</span><span class="ident" id="3987685">Encoder</span><span class="op" id="3987692">)</span>&nbsp;<span class="ident" id="3987694">newEncoderState</span><span class="op" id="3987709">(</span><span class="ident" id="3987710">b</span>&nbsp;<span class="op" id="3987712">*</span><span class="ident" id="3987713">encBuffer</span><span class="op" id="3987722">)</span>&nbsp;<span class="op" id="3987724">*</span><span class="ident" id="3987725">encoderState</span>&nbsp;<span class="op" id="3987738">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987741">e</span>&nbsp;<span class="op" id="3987743">:=</span>&nbsp;<span class="ident" id="3987746">enc</span><span class="op" id="3987749">.</span><span class="ident" id="3987750">freeList</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3987760">if</span>&nbsp;<span class="ident" id="3987763">e</span>&nbsp;<span class="op" id="3987765">==</span>&nbsp;<span class="ident" id="3987768">nil</span>&nbsp;<span class="op" id="3987772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987776">e</span>&nbsp;<span class="op" id="3987778">=</span>&nbsp;<span class="builtinfunc" id="3987780">new</span><span class="op" id="3987783">(</span><span class="ident" id="3987784">encoderState</span><span class="op" id="3987796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987800">e</span><span class="op" id="3987801">.</span><span class="ident" id="3987802">enc</span>&nbsp;<span class="op" id="3987806">=</span>&nbsp;<span class="ident" id="3987808">enc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3987813">}</span>&nbsp;<span class="keyword" id="3987815">else</span>&nbsp;<span class="op" id="3987820">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987824">enc</span><span class="op" id="3987827">.</span><span class="ident" id="3987828">freeList</span>&nbsp;<span class="op" id="3987837">=</span>&nbsp;<span class="ident" id="3987839">e</span><span class="op" id="3987840">.</span><span class="ident" id="3987841">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3987847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987850">e</span><span class="op" id="3987851">.</span><span class="ident" id="3987852">sendZero</span>&nbsp;<span class="op" id="3987861">=</span>&nbsp;<span class="builtintype" id="3987863">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987870">e</span><span class="op" id="3987871">.</span><span class="ident" id="3987872">fieldnum</span>&nbsp;<span class="op" id="3987881">=</span>&nbsp;<span class="num" id="3987883">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987886">e</span><span class="op" id="3987887">.</span><span class="ident" id="3987888">b</span>&nbsp;<span class="op" id="3987890">=</span>&nbsp;<span class="ident" id="3987892">b</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3987895">if</span>&nbsp;<span class="builtinfunc" id="3987898">len</span><span class="op" id="3987901">(</span><span class="ident" id="3987902">b</span><span class="op" id="3987903">.</span><span class="ident" id="3987904">data</span><span class="op" id="3987908">)</span>&nbsp;<span class="op" id="3987910">==</span>&nbsp;<span class="num" id="3987913">0</span>&nbsp;<span class="op" id="3987915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987919">b</span><span class="op" id="3987920">.</span><span class="ident" id="3987921">data</span>&nbsp;<span class="op" id="3987926">=</span>&nbsp;<span class="ident" id="3987928">b</span><span class="op" id="3987929">.</span><span class="ident" id="3987930">scratch</span><span class="op" id="3987937">[</span><span class="num" id="3987938">0</span><span class="op" id="3987939">:</span><span class="num" id="3987940">0</span><span class="op" id="3987941">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3987944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3987947">return</span>&nbsp;<span class="ident" id="3987954">e</span><br>
<span class="lineno"></span><span class="op" id="3987956">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="3987959">func</span>&nbsp;<span class="op" id="3987964">(</span><span class="ident" id="3987965">enc</span>&nbsp;<span class="op" id="3987969">*</span><span class="ident" id="3987970">Encoder</span><span class="op" id="3987977">)</span>&nbsp;<span class="ident" id="3987979">freeEncoderState</span><span class="op" id="3987995">(</span><span class="ident" id="3987996">e</span>&nbsp;<span class="op" id="3987998">*</span><span class="ident" id="3987999">encoderState</span><span class="op" id="3988011">)</span>&nbsp;<span class="op" id="3988013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988016">e</span><span class="op" id="3988017">.</span><span class="ident" id="3988018">next</span>&nbsp;<span class="op" id="3988023">=</span>&nbsp;<span class="ident" id="3988025">enc</span><span class="op" id="3988028">.</span><span class="ident" id="3988029">freeList</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988039">enc</span><span class="op" id="3988042">.</span><span class="ident" id="3988043">freeList</span>&nbsp;<span class="op" id="3988052">=</span>&nbsp;<span class="ident" id="3988054">e</span><br>
<span class="lineno"></span><span class="op" id="3988056">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment" id="3988059">//&nbsp;Unsigned&nbsp;integers&nbsp;have&nbsp;a&nbsp;two-state&nbsp;encoding.&nbsp;&nbsp;If&nbsp;the&nbsp;number&nbsp;is&nbsp;less</span><br>
<span class="lineno"></span><span class="comment" id="3988130">//&nbsp;than&nbsp;128&nbsp;(0&nbsp;through&nbsp;0x7F),&nbsp;its&nbsp;value&nbsp;is&nbsp;written&nbsp;directly.</span><br>
<span class="lineno"></span><span class="comment" id="3988191">//&nbsp;Otherwise&nbsp;the&nbsp;value&nbsp;is&nbsp;written&nbsp;in&nbsp;big-endian&nbsp;byte&nbsp;order&nbsp;preceded</span><br>
<span class="lineno"></span><span class="comment" id="3988259">//&nbsp;by&nbsp;the&nbsp;byte&nbsp;length,&nbsp;negated.</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="3988292">//&nbsp;encodeUint&nbsp;writes&nbsp;an&nbsp;encoded&nbsp;unsigned&nbsp;integer&nbsp;to&nbsp;state.b.</span><br>
<span class="lineno"></span><span class="keyword" id="3988353">func</span>&nbsp;<span class="op" id="3988358">(</span><span class="ident" id="3988359">state</span>&nbsp;<span class="op" id="3988365">*</span><span class="ident" id="3988366">encoderState</span><span class="op" id="3988378">)</span>&nbsp;<span class="ident" id="3988380">encodeUint</span><span class="op" id="3988390">(</span><span class="ident" id="3988391">x</span>&nbsp;<span class="ident" id="3988393">uint64</span><span class="op" id="3988399">)</span>&nbsp;<span class="op" id="3988401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3988404">if</span>&nbsp;<span class="ident" id="3988407">x</span>&nbsp;<span class="op" id="3988409">&lt;=</span>&nbsp;<span class="num" id="3988412">0x7F</span>&nbsp;<span class="op" id="3988417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988421">state</span><span class="op" id="3988426">.</span><span class="ident" id="3988427">b</span><span class="op" id="3988428">.</span><span class="ident" id="3988429">WriteByte</span><span class="op" id="3988438">(</span><span class="builtintype" id="3988439">uint8</span><span class="op" id="3988444">(</span><span class="ident" id="3988445">x</span><span class="op" id="3988446">)</span><span class="op" id="3988447">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3988451">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3988459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988462">i</span>&nbsp;<span class="op" id="3988464">:=</span>&nbsp;<span class="ident" id="3988467">uint64Size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3988479">for</span>&nbsp;<span class="ident" id="3988483">x</span>&nbsp;<span class="op" id="3988485">&gt;</span>&nbsp;<span class="num" id="3988487">0</span>&nbsp;<span class="op" id="3988489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988493">state</span><span class="op" id="3988498">.</span><span class="ident" id="3988499">buf</span><span class="op" id="3988502">[</span><span class="ident" id="3988503">i</span><span class="op" id="3988504">]</span>&nbsp;<span class="op" id="3988506">=</span>&nbsp;<span class="builtintype" id="3988508">uint8</span><span class="op" id="3988513">(</span><span class="ident" id="3988514">x</span><span class="op" id="3988515">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988519">x</span>&nbsp;<span class="op" id="3988521">&gt;&gt;=</span>&nbsp;<span class="num" id="3988525">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988529">i</span><span class="op" id="3988530">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3988534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988537">state</span><span class="op" id="3988542">.</span><span class="ident" id="3988543">buf</span><span class="op" id="3988546">[</span><span class="ident" id="3988547">i</span><span class="op" id="3988548">]</span>&nbsp;<span class="op" id="3988550">=</span>&nbsp;<span class="builtintype" id="3988552">uint8</span><span class="op" id="3988557">(</span><span class="ident" id="3988558">i</span>&nbsp;<span class="op" id="3988560">-</span>&nbsp;<span class="ident" id="3988562">uint64Size</span><span class="op" id="3988572">)</span>&nbsp;<span class="comment" id="3988574">//&nbsp;=&nbsp;loop&nbsp;count,&nbsp;negated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988600">state</span><span class="op" id="3988605">.</span><span class="ident" id="3988606">b</span><span class="op" id="3988607">.</span><span class="ident" id="3988608">Write</span><span class="op" id="3988613">(</span><span class="ident" id="3988614">state</span><span class="op" id="3988619">.</span><span class="ident" id="3988620">buf</span><span class="op" id="3988623">[</span><span class="ident" id="3988624">i</span>&nbsp;<span class="op" id="3988626">:</span>&nbsp;<span class="ident" id="3988628">uint64Size</span><span class="op" id="3988638">+</span><span class="num" id="3988639">1</span><span class="op" id="3988640">]</span><span class="op" id="3988641">)</span><br>
<span class="lineno">105</span><span class="op" id="3988643">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3988646">//&nbsp;encodeInt&nbsp;writes&nbsp;an&nbsp;encoded&nbsp;signed&nbsp;integer&nbsp;to&nbsp;state.w.</span><br>
<span class="lineno"></span><span class="comment" id="3988704">//&nbsp;The&nbsp;low&nbsp;bit&nbsp;of&nbsp;the&nbsp;encoding&nbsp;says&nbsp;whether&nbsp;to&nbsp;bit&nbsp;complement&nbsp;the&nbsp;(other&nbsp;bits&nbsp;of&nbsp;the)</span><br>
<span class="lineno"></span><span class="comment" id="3988790">//&nbsp;uint&nbsp;to&nbsp;recover&nbsp;the&nbsp;int.</span><br>
<span class="lineno">110</span><span class="keyword" id="3988818">func</span>&nbsp;<span class="op" id="3988823">(</span><span class="ident" id="3988824">state</span>&nbsp;<span class="op" id="3988830">*</span><span class="ident" id="3988831">encoderState</span><span class="op" id="3988843">)</span>&nbsp;<span class="ident" id="3988845">encodeInt</span><span class="op" id="3988854">(</span><span class="ident" id="3988855">i</span>&nbsp;<span class="ident" id="3988857">int64</span><span class="op" id="3988862">)</span>&nbsp;<span class="op" id="3988864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3988867">var</span>&nbsp;<span class="ident" id="3988871">x</span>&nbsp;<span class="ident" id="3988873">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3988881">if</span>&nbsp;<span class="ident" id="3988884">i</span>&nbsp;<span class="op" id="3988886">&lt;</span>&nbsp;<span class="num" id="3988888">0</span>&nbsp;<span class="op" id="3988890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988894">x</span>&nbsp;<span class="op" id="3988896">=</span>&nbsp;<span class="ident" id="3988898">uint64</span><span class="op" id="3988904">(</span><span class="op" id="3988905">^</span><span class="ident" id="3988906">i</span><span class="op" id="3988907">&lt;&lt;</span><span class="num" id="3988909">1</span><span class="op" id="3988910">)</span>&nbsp;<span class="op" id="3988912">|</span>&nbsp;<span class="num" id="3988914">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3988917">}</span>&nbsp;<span class="keyword" id="3988919">else</span>&nbsp;<span class="op" id="3988924">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988928">x</span>&nbsp;<span class="op" id="3988930">=</span>&nbsp;<span class="ident" id="3988932">uint64</span><span class="op" id="3988938">(</span><span class="ident" id="3988939">i</span>&nbsp;<span class="op" id="3988941">&lt;&lt;</span>&nbsp;<span class="num" id="3988944">1</span><span class="op" id="3988945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3988948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988951">state</span><span class="op" id="3988956">.</span><span class="ident" id="3988957">encodeUint</span><span class="op" id="3988967">(</span><span class="ident" id="3988968">uint64</span><span class="op" id="3988974">(</span><span class="ident" id="3988975">x</span><span class="op" id="3988976">)</span><span class="op" id="3988977">)</span><br>
<span class="lineno"></span><span class="op" id="3988979">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="3988982">//&nbsp;encOp&nbsp;is&nbsp;the&nbsp;signature&nbsp;of&nbsp;an&nbsp;encoding&nbsp;operator&nbsp;for&nbsp;a&nbsp;given&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="3989050">type</span>&nbsp;<span class="ident" id="3989055">encOp</span>&nbsp;<span class="keyword" id="3989061">func</span><span class="op" id="3989065">(</span><span class="ident" id="3989066">i</span>&nbsp;<span class="op" id="3989068">*</span><span class="ident" id="3989069">encInstr</span><span class="op" id="3989077">,</span>&nbsp;<span class="ident" id="3989079">state</span>&nbsp;<span class="op" id="3989085">*</span><span class="ident" id="3989086">encoderState</span><span class="op" id="3989098">,</span>&nbsp;<span class="ident" id="3989100">v</span>&nbsp;<span class="ident" id="3989102">reflect</span><span class="op" id="3989109">.</span><span class="ident" id="3989110">Value</span><span class="op" id="3989115">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3989118">//&nbsp;The&nbsp;&#39;instructions&#39;&nbsp;of&nbsp;the&nbsp;encoding&nbsp;machine</span><br>
<span class="lineno"></span><span class="keyword" id="3989164">type</span>&nbsp;<span class="ident" id="3989169">encInstr</span>&nbsp;<span class="keyword" id="3989178">struct</span>&nbsp;<span class="op" id="3989185">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3989188">op</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3989194">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3989201">field</span>&nbsp;<span class="builtintype" id="3989207">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3989213">//&nbsp;field&nbsp;number&nbsp;in&nbsp;input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3989239">index</span>&nbsp;<span class="op" id="3989245">[</span><span class="op" id="3989246">]</span><span class="builtintype" id="3989247">int</span>&nbsp;<span class="comment" id="3989251">//&nbsp;struct&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3989268">indir</span>&nbsp;<span class="builtintype" id="3989274">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3989280">//&nbsp;how&nbsp;many&nbsp;pointer&nbsp;indirections&nbsp;to&nbsp;reach&nbsp;the&nbsp;value&nbsp;in&nbsp;the&nbsp;struct</span><br>
<span class="lineno"></span><span class="op" id="3989346">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment" id="3989349">//&nbsp;update&nbsp;emits&nbsp;a&nbsp;field&nbsp;number&nbsp;and&nbsp;updates&nbsp;the&nbsp;state&nbsp;to&nbsp;record&nbsp;its&nbsp;value&nbsp;for&nbsp;delta&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="comment" id="3989442">//&nbsp;If&nbsp;the&nbsp;instruction&nbsp;pointer&nbsp;is&nbsp;nil,&nbsp;it&nbsp;does&nbsp;nothing</span><br>
<span class="lineno"></span><span class="keyword" id="3989496">func</span>&nbsp;<span class="op" id="3989501">(</span><span class="ident" id="3989502">state</span>&nbsp;<span class="op" id="3989508">*</span><span class="ident" id="3989509">encoderState</span><span class="op" id="3989521">)</span>&nbsp;<span class="ident" id="3989523">update</span><span class="op" id="3989529">(</span><span class="ident" id="3989530">instr</span>&nbsp;<span class="op" id="3989536">*</span><span class="ident" id="3989537">encInstr</span><span class="op" id="3989545">)</span>&nbsp;<span class="op" id="3989547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3989550">if</span>&nbsp;<span class="ident" id="3989553">instr</span>&nbsp;<span class="op" id="3989559">!=</span>&nbsp;<span class="ident" id="3989562">nil</span>&nbsp;<span class="op" id="3989566">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3989570">state</span><span class="op" id="3989575">.</span><span class="ident" id="3989576">encodeUint</span><span class="op" id="3989586">(</span><span class="ident" id="3989587">uint64</span><span class="op" id="3989593">(</span><span class="ident" id="3989594">instr</span><span class="op" id="3989599">.</span><span class="ident" id="3989600">field</span>&nbsp;<span class="op" id="3989606">-</span>&nbsp;<span class="ident" id="3989608">state</span><span class="op" id="3989613">.</span><span class="ident" id="3989614">fieldnum</span><span class="op" id="3989622">)</span><span class="op" id="3989623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3989627">state</span><span class="op" id="3989632">.</span><span class="ident" id="3989633">fieldnum</span>&nbsp;<span class="op" id="3989642">=</span>&nbsp;<span class="ident" id="3989644">instr</span><span class="op" id="3989649">.</span><span class="ident" id="3989650">field</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3989657">}</span><br>
<span class="lineno"></span><span class="op" id="3989659">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="3989662">//&nbsp;Each&nbsp;encoder&nbsp;for&nbsp;a&nbsp;composite&nbsp;is&nbsp;responsible&nbsp;for&nbsp;handling&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="3989726">//&nbsp;indirections&nbsp;associated&nbsp;with&nbsp;the&nbsp;elements&nbsp;of&nbsp;the&nbsp;data&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="3989794">//&nbsp;If&nbsp;any&nbsp;pointer&nbsp;so&nbsp;reached&nbsp;is&nbsp;nil,&nbsp;no&nbsp;bytes&nbsp;are&nbsp;written.&nbsp;&nbsp;If&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3989861">//&nbsp;data&nbsp;item&nbsp;is&nbsp;zero,&nbsp;no&nbsp;bytes&nbsp;are&nbsp;written.&nbsp;&nbsp;Single&nbsp;values&nbsp;-&nbsp;ints,</span><br>
<span class="lineno"></span><span class="comment" id="3989928">//&nbsp;strings&nbsp;etc.&nbsp;-&nbsp;are&nbsp;indirected&nbsp;before&nbsp;calling&nbsp;their&nbsp;encoders.</span><br>
<span class="lineno">145</span><span class="comment" id="3989992">//&nbsp;Otherwise,&nbsp;the&nbsp;output&nbsp;(for&nbsp;a&nbsp;scalar)&nbsp;is&nbsp;the&nbsp;field&nbsp;number,&nbsp;as&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="3990059">//&nbsp;encoded&nbsp;integer,&nbsp;followed&nbsp;by&nbsp;the&nbsp;field&nbsp;data&nbsp;in&nbsp;its&nbsp;appropriate</span><br>
<span class="lineno"></span><span class="comment" id="3990125">//&nbsp;format.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3990137">//&nbsp;encIndirect&nbsp;dereferences&nbsp;pv&nbsp;indir&nbsp;times&nbsp;and&nbsp;returns&nbsp;the&nbsp;result.</span><br>
<span class="lineno">150</span><span class="keyword" id="3990204">func</span>&nbsp;<span class="ident" id="3990209">encIndirect</span><span class="op" id="3990220">(</span><span class="ident" id="3990221">pv</span>&nbsp;<span class="ident" id="3990224">reflect</span><span class="op" id="3990231">.</span><span class="ident" id="3990232">Value</span><span class="op" id="3990237">,</span>&nbsp;<span class="ident" id="3990239">indir</span>&nbsp;<span class="builtintype" id="3990245">int</span><span class="op" id="3990248">)</span>&nbsp;<span class="ident" id="3990250">reflect</span><span class="op" id="3990257">.</span><span class="ident" id="3990258">Value</span>&nbsp;<span class="op" id="3990264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990267">for</span>&nbsp;<span class="op" id="3990271">;</span>&nbsp;<span class="ident" id="3990273">indir</span>&nbsp;<span class="op" id="3990279">&gt;</span>&nbsp;<span class="num" id="3990281">0</span><span class="op" id="3990282">;</span>&nbsp;<span class="ident" id="3990284">indir</span><span class="op" id="3990289">--</span>&nbsp;<span class="op" id="3990292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990296">if</span>&nbsp;<span class="ident" id="3990299">pv</span><span class="op" id="3990301">.</span><span class="ident" id="3990302">IsNil</span><span class="op" id="3990307">(</span><span class="op" id="3990308">)</span>&nbsp;<span class="op" id="3990310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990315">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3990323">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990327">pv</span>&nbsp;<span class="op" id="3990330">=</span>&nbsp;<span class="ident" id="3990332">pv</span><span class="op" id="3990334">.</span><span class="ident" id="3990335">Elem</span><span class="op" id="3990339">(</span><span class="op" id="3990340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3990343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990346">return</span>&nbsp;<span class="ident" id="3990353">pv</span><br>
<span class="lineno"></span><span class="op" id="3990356">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="3990359">//&nbsp;encBool&nbsp;encodes&nbsp;the&nbsp;bool&nbsp;referenced&nbsp;by&nbsp;v&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;0&nbsp;or&nbsp;1.</span><br>
<span class="lineno"></span><span class="keyword" id="3990426">func</span>&nbsp;<span class="ident" id="3990431">encBool</span><span class="op" id="3990438">(</span><span class="ident" id="3990439">i</span>&nbsp;<span class="op" id="3990441">*</span><span class="ident" id="3990442">encInstr</span><span class="op" id="3990450">,</span>&nbsp;<span class="ident" id="3990452">state</span>&nbsp;<span class="op" id="3990458">*</span><span class="ident" id="3990459">encoderState</span><span class="op" id="3990471">,</span>&nbsp;<span class="ident" id="3990473">v</span>&nbsp;<span class="ident" id="3990475">reflect</span><span class="op" id="3990482">.</span><span class="ident" id="3990483">Value</span><span class="op" id="3990488">)</span>&nbsp;<span class="op" id="3990490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990493">b</span>&nbsp;<span class="op" id="3990495">:=</span>&nbsp;<span class="ident" id="3990498">v</span><span class="op" id="3990499">.</span><span class="ident" id="3990500">Bool</span><span class="op" id="3990504">(</span><span class="op" id="3990505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990508">if</span>&nbsp;<span class="ident" id="3990511">b</span>&nbsp;<span class="op" id="3990513">||</span>&nbsp;<span class="ident" id="3990516">state</span><span class="op" id="3990521">.</span><span class="ident" id="3990522">sendZero</span>&nbsp;<span class="op" id="3990531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990535">state</span><span class="op" id="3990540">.</span><span class="ident" id="3990541">update</span><span class="op" id="3990547">(</span><span class="ident" id="3990548">i</span><span class="op" id="3990549">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990553">if</span>&nbsp;<span class="ident" id="3990556">b</span>&nbsp;<span class="op" id="3990558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990563">state</span><span class="op" id="3990568">.</span><span class="ident" id="3990569">encodeUint</span><span class="op" id="3990579">(</span><span class="num" id="3990580">1</span><span class="op" id="3990581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3990585">}</span>&nbsp;<span class="keyword" id="3990587">else</span>&nbsp;<span class="op" id="3990592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990597">state</span><span class="op" id="3990602">.</span><span class="ident" id="3990603">encodeUint</span><span class="op" id="3990613">(</span><span class="num" id="3990614">0</span><span class="op" id="3990615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3990619">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3990622">}</span><br>
<span class="lineno"></span><span class="op" id="3990624">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3990627">//&nbsp;encInt&nbsp;encodes&nbsp;the&nbsp;signed&nbsp;integer&nbsp;(int&nbsp;int8&nbsp;int16&nbsp;int32&nbsp;int64)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="3990710">func</span>&nbsp;<span class="ident" id="3990715">encInt</span><span class="op" id="3990721">(</span><span class="ident" id="3990722">i</span>&nbsp;<span class="op" id="3990724">*</span><span class="ident" id="3990725">encInstr</span><span class="op" id="3990733">,</span>&nbsp;<span class="ident" id="3990735">state</span>&nbsp;<span class="op" id="3990741">*</span><span class="ident" id="3990742">encoderState</span><span class="op" id="3990754">,</span>&nbsp;<span class="ident" id="3990756">v</span>&nbsp;<span class="ident" id="3990758">reflect</span><span class="op" id="3990765">.</span><span class="ident" id="3990766">Value</span><span class="op" id="3990771">)</span>&nbsp;<span class="op" id="3990773">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990776">value</span>&nbsp;<span class="op" id="3990782">:=</span>&nbsp;<span class="ident" id="3990785">v</span><span class="op" id="3990786">.</span><span class="ident" id="3990787">Int</span><span class="op" id="3990790">(</span><span class="op" id="3990791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990794">if</span>&nbsp;<span class="ident" id="3990797">value</span>&nbsp;<span class="op" id="3990803">!=</span>&nbsp;<span class="num" id="3990806">0</span>&nbsp;<span class="op" id="3990808">||</span>&nbsp;<span class="ident" id="3990811">state</span><span class="op" id="3990816">.</span><span class="ident" id="3990817">sendZero</span>&nbsp;<span class="op" id="3990826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990830">state</span><span class="op" id="3990835">.</span><span class="ident" id="3990836">update</span><span class="op" id="3990842">(</span><span class="ident" id="3990843">i</span><span class="op" id="3990844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990848">state</span><span class="op" id="3990853">.</span><span class="ident" id="3990854">encodeInt</span><span class="op" id="3990863">(</span><span class="ident" id="3990864">value</span><span class="op" id="3990869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3990872">}</span><br>
<span class="lineno">180</span><span class="op" id="3990874">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3990877">//&nbsp;encUint&nbsp;encodes&nbsp;the&nbsp;unsigned&nbsp;integer&nbsp;(uint&nbsp;uint8&nbsp;uint16&nbsp;uint32&nbsp;uint64&nbsp;uintptr)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="3990976">func</span>&nbsp;<span class="ident" id="3990981">encUint</span><span class="op" id="3990988">(</span><span class="ident" id="3990989">i</span>&nbsp;<span class="op" id="3990991">*</span><span class="ident" id="3990992">encInstr</span><span class="op" id="3991000">,</span>&nbsp;<span class="ident" id="3991002">state</span>&nbsp;<span class="op" id="3991008">*</span><span class="ident" id="3991009">encoderState</span><span class="op" id="3991021">,</span>&nbsp;<span class="ident" id="3991023">v</span>&nbsp;<span class="ident" id="3991025">reflect</span><span class="op" id="3991032">.</span><span class="ident" id="3991033">Value</span><span class="op" id="3991038">)</span>&nbsp;<span class="op" id="3991040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3991043">value</span>&nbsp;<span class="op" id="3991049">:=</span>&nbsp;<span class="ident" id="3991052">v</span><span class="op" id="3991053">.</span><span class="ident" id="3991054">Uint</span><span class="op" id="3991058">(</span><span class="op" id="3991059">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3991062">if</span>&nbsp;<span class="ident" id="3991065">value</span>&nbsp;<span class="op" id="3991071">!=</span>&nbsp;<span class="num" id="3991074">0</span>&nbsp;<span class="op" id="3991076">||</span>&nbsp;<span class="ident" id="3991079">state</span><span class="op" id="3991084">.</span><span class="ident" id="3991085">sendZero</span>&nbsp;<span class="op" id="3991094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3991098">state</span><span class="op" id="3991103">.</span><span class="ident" id="3991104">update</span><span class="op" id="3991110">(</span><span class="ident" id="3991111">i</span><span class="op" id="3991112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3991116">state</span><span class="op" id="3991121">.</span><span class="ident" id="3991122">encodeUint</span><span class="op" id="3991132">(</span><span class="ident" id="3991133">value</span><span class="op" id="3991138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3991141">}</span><br>
<span class="lineno"></span><span class="op" id="3991143">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="3991146">//&nbsp;floatBits&nbsp;returns&nbsp;a&nbsp;uint64&nbsp;holding&nbsp;the&nbsp;bits&nbsp;of&nbsp;a&nbsp;floating-point&nbsp;number.</span><br>
<span class="lineno"></span><span class="comment" id="3991221">//&nbsp;Floating-point&nbsp;numbers&nbsp;are&nbsp;transmitted&nbsp;as&nbsp;uint64s&nbsp;holding&nbsp;the&nbsp;bits</span><br>
<span class="lineno"></span><span class="comment" id="3991291">//&nbsp;of&nbsp;the&nbsp;underlying&nbsp;representation.&nbsp;&nbsp;They&nbsp;are&nbsp;sent&nbsp;byte-reversed,&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="3991363">//&nbsp;the&nbsp;exponent&nbsp;end&nbsp;coming&nbsp;out&nbsp;first,&nbsp;so&nbsp;integer&nbsp;floating&nbsp;point&nbsp;numbers</span><br>
<span class="lineno">195</span><span class="comment" id="3991435">//&nbsp;(for&nbsp;example)&nbsp;transmit&nbsp;more&nbsp;compactly.&nbsp;&nbsp;This&nbsp;routine&nbsp;does&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3991500">//&nbsp;swizzling.</span><br>
<span class="lineno"></span><span class="keyword" id="3991514">func</span>&nbsp;<span class="ident" id="3991519">floatBits</span><span class="op" id="3991528">(</span><span class="ident" id="3991529">f</span>&nbsp;<span class="builtintype" id="3991531">float64</span><span class="op" id="3991538">)</span>&nbsp;<span class="ident" id="3991540">uint64</span>&nbsp;<span class="op" id="3991547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3991550">u</span>&nbsp;<span class="op" id="3991552">:=</span>&nbsp;<span class="ident" id="3991555">math</span><span class="op" id="3991559">.</span><span class="ident" id="3991560">Float64bits</span><span class="op" id="3991571">(</span><span class="ident" id="3991572">f</span><span class="op" id="3991573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3991576">var</span>&nbsp;<span class="ident" id="3991580">v</span>&nbsp;<span class="ident" id="3991582">uint64</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3991590">for</span>&nbsp;<span class="ident" id="3991594">i</span>&nbsp;<span class="op" id="3991596">:=</span>&nbsp;<span class="num" id="3991599">0</span><span class="op" id="3991600">;</span>&nbsp;<span class="ident" id="3991602">i</span>&nbsp;<span class="op" id="3991604">&lt;</span>&nbsp;<span class="num" id="3991606">8</span><span class="op" id="3991607">;</span>&nbsp;<span class="ident" id="3991609">i</span><span class="op" id="3991610">++</span>&nbsp;<span class="op" id="3991613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3991617">v</span>&nbsp;<span class="op" id="3991619">&lt;&lt;=</span>&nbsp;<span class="num" id="3991623">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3991627">v</span>&nbsp;<span class="op" id="3991629">|=</span>&nbsp;<span class="ident" id="3991632">u</span>&nbsp;<span class="op" id="3991634">&amp;</span>&nbsp;<span class="num" id="3991636">0xFF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3991643">u</span>&nbsp;<span class="op" id="3991645">&gt;&gt;=</span>&nbsp;<span class="num" id="3991649">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3991652">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3991655">return</span>&nbsp;<span class="ident" id="3991662">v</span><br>
<span class="lineno"></span><span class="op" id="3991664">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3991667">//&nbsp;encFloat&nbsp;encodes&nbsp;the&nbsp;floating&nbsp;point&nbsp;value&nbsp;(float32&nbsp;float64)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="3991747">func</span>&nbsp;<span class="ident" id="3991752">encFloat</span><span class="op" id="3991760">(</span><span class="ident" id="3991761">i</span>&nbsp;<span class="op" id="3991763">*</span><span class="ident" id="3991764">encInstr</span><span class="op" id="3991772">,</span>&nbsp;<span class="ident" id="3991774">state</span>&nbsp;<span class="op" id="3991780">*</span><span class="ident" id="3991781">encoderState</span><span class="op" id="3991793">,</span>&nbsp;<span class="ident" id="3991795">v</span>&nbsp;<span class="ident" id="3991797">reflect</span><span class="op" id="3991804">.</span><span class="ident" id="3991805">Value</span><span class="op" id="3991810">)</span>&nbsp;<span class="op" id="3991812">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3991815">f</span>&nbsp;<span class="op" id="3991817">:=</span>&nbsp;<span class="ident" id="3991820">v</span><span class="op" id="3991821">.</span><span class="ident" id="3991822">Float</span><span class="op" id="3991827">(</span><span class="op" id="3991828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3991831">if</span>&nbsp;<span class="ident" id="3991834">f</span>&nbsp;<span class="op" id="3991836">!=</span>&nbsp;<span class="num" id="3991839">0</span>&nbsp;<span class="op" id="3991841">||</span>&nbsp;<span class="ident" id="3991844">state</span><span class="op" id="3991849">.</span><span class="ident" id="3991850">sendZero</span>&nbsp;<span class="op" id="3991859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3991863">bits</span>&nbsp;<span class="op" id="3991868">:=</span>&nbsp;<span class="ident" id="3991871">floatBits</span><span class="op" id="3991880">(</span><span class="ident" id="3991881">f</span><span class="op" id="3991882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3991886">state</span><span class="op" id="3991891">.</span><span class="ident" id="3991892">update</span><span class="op" id="3991898">(</span><span class="ident" id="3991899">i</span><span class="op" id="3991900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3991904">state</span><span class="op" id="3991909">.</span><span class="ident" id="3991910">encodeUint</span><span class="op" id="3991920">(</span><span class="ident" id="3991921">bits</span><span class="op" id="3991925">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3991928">}</span><br>
<span class="lineno"></span><span class="op" id="3991930">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3991933">//&nbsp;encComplex&nbsp;encodes&nbsp;the&nbsp;complex&nbsp;value&nbsp;(complex64&nbsp;complex128)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="3992013">//&nbsp;Complex&nbsp;numbers&nbsp;are&nbsp;just&nbsp;a&nbsp;pair&nbsp;of&nbsp;floating-point&nbsp;numbers,&nbsp;real&nbsp;part&nbsp;first.</span><br>
<span class="lineno">220</span><span class="keyword" id="3992092">func</span>&nbsp;<span class="ident" id="3992097">encComplex</span><span class="op" id="3992107">(</span><span class="ident" id="3992108">i</span>&nbsp;<span class="op" id="3992110">*</span><span class="ident" id="3992111">encInstr</span><span class="op" id="3992119">,</span>&nbsp;<span class="ident" id="3992121">state</span>&nbsp;<span class="op" id="3992127">*</span><span class="ident" id="3992128">encoderState</span><span class="op" id="3992140">,</span>&nbsp;<span class="ident" id="3992142">v</span>&nbsp;<span class="ident" id="3992144">reflect</span><span class="op" id="3992151">.</span><span class="ident" id="3992152">Value</span><span class="op" id="3992157">)</span>&nbsp;<span class="op" id="3992159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992162">c</span>&nbsp;<span class="op" id="3992164">:=</span>&nbsp;<span class="ident" id="3992167">v</span><span class="op" id="3992168">.</span><span class="ident" id="3992169">Complex</span><span class="op" id="3992176">(</span><span class="op" id="3992177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3992180">if</span>&nbsp;<span class="ident" id="3992183">c</span>&nbsp;<span class="op" id="3992185">!=</span>&nbsp;<span class="num" id="3992188">0</span><span class="op" id="3992189">+</span><span class="num" id="3992190">0i</span>&nbsp;<span class="op" id="3992193">||</span>&nbsp;<span class="ident" id="3992196">state</span><span class="op" id="3992201">.</span><span class="ident" id="3992202">sendZero</span>&nbsp;<span class="op" id="3992211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992215">rpart</span>&nbsp;<span class="op" id="3992221">:=</span>&nbsp;<span class="ident" id="3992224">floatBits</span><span class="op" id="3992233">(</span><span class="builtinfunc" id="3992234">real</span><span class="op" id="3992238">(</span><span class="ident" id="3992239">c</span><span class="op" id="3992240">)</span><span class="op" id="3992241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992245">ipart</span>&nbsp;<span class="op" id="3992251">:=</span>&nbsp;<span class="ident" id="3992254">floatBits</span><span class="op" id="3992263">(</span><span class="builtinfunc" id="3992264">imag</span><span class="op" id="3992268">(</span><span class="ident" id="3992269">c</span><span class="op" id="3992270">)</span><span class="op" id="3992271">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992275">state</span><span class="op" id="3992280">.</span><span class="ident" id="3992281">update</span><span class="op" id="3992287">(</span><span class="ident" id="3992288">i</span><span class="op" id="3992289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992293">state</span><span class="op" id="3992298">.</span><span class="ident" id="3992299">encodeUint</span><span class="op" id="3992309">(</span><span class="ident" id="3992310">rpart</span><span class="op" id="3992315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992319">state</span><span class="op" id="3992324">.</span><span class="ident" id="3992325">encodeUint</span><span class="op" id="3992335">(</span><span class="ident" id="3992336">ipart</span><span class="op" id="3992341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3992344">}</span><br>
<span class="lineno"></span><span class="op" id="3992346">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="3992349">//&nbsp;encUint8Array&nbsp;encodes&nbsp;the&nbsp;byte&nbsp;array&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="3992406">//&nbsp;Byte&nbsp;arrays&nbsp;are&nbsp;encoded&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;the&nbsp;raw&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="3992481">func</span>&nbsp;<span class="ident" id="3992486">encUint8Array</span><span class="op" id="3992499">(</span><span class="ident" id="3992500">i</span>&nbsp;<span class="op" id="3992502">*</span><span class="ident" id="3992503">encInstr</span><span class="op" id="3992511">,</span>&nbsp;<span class="ident" id="3992513">state</span>&nbsp;<span class="op" id="3992519">*</span><span class="ident" id="3992520">encoderState</span><span class="op" id="3992532">,</span>&nbsp;<span class="ident" id="3992534">v</span>&nbsp;<span class="ident" id="3992536">reflect</span><span class="op" id="3992543">.</span><span class="ident" id="3992544">Value</span><span class="op" id="3992549">)</span>&nbsp;<span class="op" id="3992551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992554">b</span>&nbsp;<span class="op" id="3992556">:=</span>&nbsp;<span class="ident" id="3992559">v</span><span class="op" id="3992560">.</span><span class="ident" id="3992561">Bytes</span><span class="op" id="3992566">(</span><span class="op" id="3992567">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3992570">if</span>&nbsp;<span class="builtinfunc" id="3992573">len</span><span class="op" id="3992576">(</span><span class="ident" id="3992577">b</span><span class="op" id="3992578">)</span>&nbsp;<span class="op" id="3992580">&gt;</span>&nbsp;<span class="num" id="3992582">0</span>&nbsp;<span class="op" id="3992584">||</span>&nbsp;<span class="ident" id="3992587">state</span><span class="op" id="3992592">.</span><span class="ident" id="3992593">sendZero</span>&nbsp;<span class="op" id="3992602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992606">state</span><span class="op" id="3992611">.</span><span class="ident" id="3992612">update</span><span class="op" id="3992618">(</span><span class="ident" id="3992619">i</span><span class="op" id="3992620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992624">state</span><span class="op" id="3992629">.</span><span class="ident" id="3992630">encodeUint</span><span class="op" id="3992640">(</span><span class="ident" id="3992641">uint64</span><span class="op" id="3992647">(</span><span class="builtinfunc" id="3992648">len</span><span class="op" id="3992651">(</span><span class="ident" id="3992652">b</span><span class="op" id="3992653">)</span><span class="op" id="3992654">)</span><span class="op" id="3992655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992659">state</span><span class="op" id="3992664">.</span><span class="ident" id="3992665">b</span><span class="op" id="3992666">.</span><span class="ident" id="3992667">Write</span><span class="op" id="3992672">(</span><span class="ident" id="3992673">b</span><span class="op" id="3992674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3992677">}</span><br>
<span class="lineno">240</span><span class="op" id="3992679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3992682">//&nbsp;encString&nbsp;encodes&nbsp;the&nbsp;string&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="3992731">//&nbsp;Strings&nbsp;are&nbsp;encoded&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;the&nbsp;raw&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="3992802">func</span>&nbsp;<span class="ident" id="3992807">encString</span><span class="op" id="3992816">(</span><span class="ident" id="3992817">i</span>&nbsp;<span class="op" id="3992819">*</span><span class="ident" id="3992820">encInstr</span><span class="op" id="3992828">,</span>&nbsp;<span class="ident" id="3992830">state</span>&nbsp;<span class="op" id="3992836">*</span><span class="ident" id="3992837">encoderState</span><span class="op" id="3992849">,</span>&nbsp;<span class="ident" id="3992851">v</span>&nbsp;<span class="ident" id="3992853">reflect</span><span class="op" id="3992860">.</span><span class="ident" id="3992861">Value</span><span class="op" id="3992866">)</span>&nbsp;<span class="op" id="3992868">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992871">s</span>&nbsp;<span class="op" id="3992873">:=</span>&nbsp;<span class="ident" id="3992876">v</span><span class="op" id="3992877">.</span><span class="ident" id="3992878">String</span><span class="op" id="3992884">(</span><span class="op" id="3992885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3992888">if</span>&nbsp;<span class="builtinfunc" id="3992891">len</span><span class="op" id="3992894">(</span><span class="ident" id="3992895">s</span><span class="op" id="3992896">)</span>&nbsp;<span class="op" id="3992898">&gt;</span>&nbsp;<span class="num" id="3992900">0</span>&nbsp;<span class="op" id="3992902">||</span>&nbsp;<span class="ident" id="3992905">state</span><span class="op" id="3992910">.</span><span class="ident" id="3992911">sendZero</span>&nbsp;<span class="op" id="3992920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992924">state</span><span class="op" id="3992929">.</span><span class="ident" id="3992930">update</span><span class="op" id="3992936">(</span><span class="ident" id="3992937">i</span><span class="op" id="3992938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992942">state</span><span class="op" id="3992947">.</span><span class="ident" id="3992948">encodeUint</span><span class="op" id="3992958">(</span><span class="ident" id="3992959">uint64</span><span class="op" id="3992965">(</span><span class="builtinfunc" id="3992966">len</span><span class="op" id="3992969">(</span><span class="ident" id="3992970">s</span><span class="op" id="3992971">)</span><span class="op" id="3992972">)</span><span class="op" id="3992973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992977">state</span><span class="op" id="3992982">.</span><span class="ident" id="3992983">b</span><span class="op" id="3992984">.</span><span class="ident" id="3992985">WriteString</span><span class="op" id="3992996">(</span><span class="ident" id="3992997">s</span><span class="op" id="3992998">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3993001">}</span><br>
<span class="lineno"></span><span class="op" id="3993003">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3993006">//&nbsp;encStructTerminator&nbsp;encodes&nbsp;the&nbsp;end&nbsp;of&nbsp;an&nbsp;encoded&nbsp;struct</span><br>
<span class="lineno"></span><span class="comment" id="3993066">//&nbsp;as&nbsp;delta&nbsp;field&nbsp;number&nbsp;of&nbsp;0.</span><br>
<span class="lineno">255</span><span class="keyword" id="3993097">func</span>&nbsp;<span class="ident" id="3993102">encStructTerminator</span><span class="op" id="3993121">(</span><span class="ident" id="3993122">i</span>&nbsp;<span class="op" id="3993124">*</span><span class="ident" id="3993125">encInstr</span><span class="op" id="3993133">,</span>&nbsp;<span class="ident" id="3993135">state</span>&nbsp;<span class="op" id="3993141">*</span><span class="ident" id="3993142">encoderState</span><span class="op" id="3993154">,</span>&nbsp;<span class="ident" id="3993156">v</span>&nbsp;<span class="ident" id="3993158">reflect</span><span class="op" id="3993165">.</span><span class="ident" id="3993166">Value</span><span class="op" id="3993171">)</span>&nbsp;<span class="op" id="3993173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3993176">state</span><span class="op" id="3993181">.</span><span class="ident" id="3993182">encodeUint</span><span class="op" id="3993192">(</span><span class="num" id="3993193">0</span><span class="op" id="3993194">)</span><br>
<span class="lineno"></span><span class="op" id="3993196">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3993199">//&nbsp;Execution&nbsp;engine</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="3993220">//&nbsp;encEngine&nbsp;an&nbsp;array&nbsp;of&nbsp;instructions&nbsp;indexed&nbsp;by&nbsp;field&nbsp;number&nbsp;of&nbsp;the&nbsp;encoding</span><br>
<span class="lineno"></span><span class="comment" id="3993298">//&nbsp;data,&nbsp;typically&nbsp;a&nbsp;struct.&nbsp;&nbsp;It&nbsp;is&nbsp;executed&nbsp;top&nbsp;to&nbsp;bottom,&nbsp;walking&nbsp;the&nbsp;struct.</span><br>
<span class="lineno"></span><span class="keyword" id="3993378">type</span>&nbsp;<span class="ident" id="3993383">encEngine</span>&nbsp;<span class="keyword" id="3993393">struct</span>&nbsp;<span class="op" id="3993400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3993403">instr</span>&nbsp;<span class="op" id="3993409">[</span><span class="op" id="3993410">]</span><span class="ident" id="3993411">encInstr</span><br>
<span class="lineno">265</span><span class="op" id="3993420">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3993423">const</span>&nbsp;<span class="ident" id="3993429">singletonField</span>&nbsp;<span class="op" id="3993444">=</span>&nbsp;<span class="num" id="3993446">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3993449">//&nbsp;valid&nbsp;reports&nbsp;whether&nbsp;the&nbsp;value&nbsp;is&nbsp;valid&nbsp;and&nbsp;a&nbsp;non-nil&nbsp;pointer.</span><br>
<span class="lineno">270</span><span class="comment" id="3993516">//&nbsp;(Slices,&nbsp;maps,&nbsp;and&nbsp;chans&nbsp;take&nbsp;care&nbsp;of&nbsp;themselves.)</span><br>
<span class="lineno"></span><span class="keyword" id="3993570">func</span>&nbsp;<span class="ident" id="3993575">valid</span><span class="op" id="3993580">(</span><span class="ident" id="3993581">v</span>&nbsp;<span class="ident" id="3993583">reflect</span><span class="op" id="3993590">.</span><span class="ident" id="3993591">Value</span><span class="op" id="3993596">)</span>&nbsp;<span class="builtintype" id="3993598">bool</span>&nbsp;<span class="op" id="3993603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3993606">switch</span>&nbsp;<span class="ident" id="3993613">v</span><span class="op" id="3993614">.</span><span class="ident" id="3993615">Kind</span><span class="op" id="3993619">(</span><span class="op" id="3993620">)</span>&nbsp;<span class="op" id="3993622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3993625">case</span>&nbsp;<span class="ident" id="3993630">reflect</span><span class="op" id="3993637">.</span><span class="ident" id="3993638">Invalid</span><span class="op" id="3993645">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3993649">return</span>&nbsp;<span class="builtintype" id="3993656">false</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3993663">case</span>&nbsp;<span class="ident" id="3993668">reflect</span><span class="op" id="3993675">.</span><span class="ident" id="3993676">Ptr</span><span class="op" id="3993679">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3993683">return</span>&nbsp;<span class="op" id="3993690">!</span><span class="ident" id="3993691">v</span><span class="op" id="3993692">.</span><span class="ident" id="3993693">IsNil</span><span class="op" id="3993698">(</span><span class="op" id="3993699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3993702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3993705">return</span>&nbsp;<span class="builtintype" id="3993712">true</span><br>
<span class="lineno"></span><span class="op" id="3993717">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="3993720">//&nbsp;encodeSingle&nbsp;encodes&nbsp;a&nbsp;single&nbsp;top-level&nbsp;non-struct&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="3993781">func</span>&nbsp;<span class="op" id="3993786">(</span><span class="ident" id="3993787">enc</span>&nbsp;<span class="op" id="3993791">*</span><span class="ident" id="3993792">Encoder</span><span class="op" id="3993799">)</span>&nbsp;<span class="ident" id="3993801">encodeSingle</span><span class="op" id="3993813">(</span><span class="ident" id="3993814">b</span>&nbsp;<span class="op" id="3993816">*</span><span class="ident" id="3993817">encBuffer</span><span class="op" id="3993826">,</span>&nbsp;<span class="ident" id="3993828">engine</span>&nbsp;<span class="op" id="3993835">*</span><span class="ident" id="3993836">encEngine</span><span class="op" id="3993845">,</span>&nbsp;<span class="ident" id="3993847">value</span>&nbsp;<span class="ident" id="3993853">reflect</span><span class="op" id="3993860">.</span><span class="ident" id="3993861">Value</span><span class="op" id="3993866">)</span>&nbsp;<span class="op" id="3993868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3993871">state</span>&nbsp;<span class="op" id="3993877">:=</span>&nbsp;<span class="ident" id="3993880">enc</span><span class="op" id="3993883">.</span><span class="ident" id="3993884">newEncoderState</span><span class="op" id="3993899">(</span><span class="ident" id="3993900">b</span><span class="op" id="3993901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3993904">defer</span>&nbsp;<span class="ident" id="3993910">enc</span><span class="op" id="3993913">.</span><span class="ident" id="3993914">freeEncoderState</span><span class="op" id="3993930">(</span><span class="ident" id="3993931">state</span><span class="op" id="3993936">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3993939">state</span><span class="op" id="3993944">.</span><span class="ident" id="3993945">fieldnum</span>&nbsp;<span class="op" id="3993954">=</span>&nbsp;<span class="ident" id="3993956">singletonField</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3993972">//&nbsp;There&nbsp;is&nbsp;no&nbsp;surrounding&nbsp;struct&nbsp;to&nbsp;frame&nbsp;the&nbsp;transmission,&nbsp;so&nbsp;we&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3994045">//&nbsp;generate&nbsp;data&nbsp;even&nbsp;if&nbsp;the&nbsp;item&nbsp;is&nbsp;zero.&nbsp;&nbsp;To&nbsp;do&nbsp;this,&nbsp;set&nbsp;sendZero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994116">state</span><span class="op" id="3994121">.</span><span class="ident" id="3994122">sendZero</span>&nbsp;<span class="op" id="3994131">=</span>&nbsp;<span class="builtintype" id="3994133">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994139">instr</span>&nbsp;<span class="op" id="3994145">:=</span>&nbsp;<span class="op" id="3994148">&amp;</span><span class="ident" id="3994149">engine</span><span class="op" id="3994155">.</span><span class="ident" id="3994156">instr</span><span class="op" id="3994161">[</span><span class="ident" id="3994162">singletonField</span><span class="op" id="3994176">]</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3994179">if</span>&nbsp;<span class="ident" id="3994182">instr</span><span class="op" id="3994187">.</span><span class="ident" id="3994188">indir</span>&nbsp;<span class="op" id="3994194">&gt;</span>&nbsp;<span class="num" id="3994196">0</span>&nbsp;<span class="op" id="3994198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994202">value</span>&nbsp;<span class="op" id="3994208">=</span>&nbsp;<span class="ident" id="3994210">encIndirect</span><span class="op" id="3994221">(</span><span class="ident" id="3994222">value</span><span class="op" id="3994227">,</span>&nbsp;<span class="ident" id="3994229">instr</span><span class="op" id="3994234">.</span><span class="ident" id="3994235">indir</span><span class="op" id="3994240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3994243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3994246">if</span>&nbsp;<span class="ident" id="3994249">valid</span><span class="op" id="3994254">(</span><span class="ident" id="3994255">value</span><span class="op" id="3994260">)</span>&nbsp;<span class="op" id="3994262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994266">instr</span><span class="op" id="3994271">.</span><span class="ident" id="3994272">op</span><span class="op" id="3994274">(</span><span class="ident" id="3994275">instr</span><span class="op" id="3994280">,</span>&nbsp;<span class="ident" id="3994282">state</span><span class="op" id="3994287">,</span>&nbsp;<span class="ident" id="3994289">value</span><span class="op" id="3994294">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3994297">}</span><br>
<span class="lineno"></span><span class="op" id="3994299">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3994302">//&nbsp;encodeStruct&nbsp;encodes&nbsp;a&nbsp;single&nbsp;struct&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="3994349">func</span>&nbsp;<span class="op" id="3994354">(</span><span class="ident" id="3994355">enc</span>&nbsp;<span class="op" id="3994359">*</span><span class="ident" id="3994360">Encoder</span><span class="op" id="3994367">)</span>&nbsp;<span class="ident" id="3994369">encodeStruct</span><span class="op" id="3994381">(</span><span class="ident" id="3994382">b</span>&nbsp;<span class="op" id="3994384">*</span><span class="ident" id="3994385">encBuffer</span><span class="op" id="3994394">,</span>&nbsp;<span class="ident" id="3994396">engine</span>&nbsp;<span class="op" id="3994403">*</span><span class="ident" id="3994404">encEngine</span><span class="op" id="3994413">,</span>&nbsp;<span class="ident" id="3994415">value</span>&nbsp;<span class="ident" id="3994421">reflect</span><span class="op" id="3994428">.</span><span class="ident" id="3994429">Value</span><span class="op" id="3994434">)</span>&nbsp;<span class="op" id="3994436">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3994439">if</span>&nbsp;<span class="op" id="3994442">!</span><span class="ident" id="3994443">valid</span><span class="op" id="3994448">(</span><span class="ident" id="3994449">value</span><span class="op" id="3994454">)</span>&nbsp;<span class="op" id="3994456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3994460">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3994468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994471">state</span>&nbsp;<span class="op" id="3994477">:=</span>&nbsp;<span class="ident" id="3994480">enc</span><span class="op" id="3994483">.</span><span class="ident" id="3994484">newEncoderState</span><span class="op" id="3994499">(</span><span class="ident" id="3994500">b</span><span class="op" id="3994501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3994504">defer</span>&nbsp;<span class="ident" id="3994510">enc</span><span class="op" id="3994513">.</span><span class="ident" id="3994514">freeEncoderState</span><span class="op" id="3994530">(</span><span class="ident" id="3994531">state</span><span class="op" id="3994536">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994539">state</span><span class="op" id="3994544">.</span><span class="ident" id="3994545">fieldnum</span>&nbsp;<span class="op" id="3994554">=</span>&nbsp;<span class="op" id="3994556">-</span><span class="num" id="3994557">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3994560">for</span>&nbsp;<span class="ident" id="3994564">i</span>&nbsp;<span class="op" id="3994566">:=</span>&nbsp;<span class="num" id="3994569">0</span><span class="op" id="3994570">;</span>&nbsp;<span class="ident" id="3994572">i</span>&nbsp;<span class="op" id="3994574">&lt;</span>&nbsp;<span class="builtinfunc" id="3994576">len</span><span class="op" id="3994579">(</span><span class="ident" id="3994580">engine</span><span class="op" id="3994586">.</span><span class="ident" id="3994587">instr</span><span class="op" id="3994592">)</span><span class="op" id="3994593">;</span>&nbsp;<span class="ident" id="3994595">i</span><span class="op" id="3994596">++</span>&nbsp;<span class="op" id="3994599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994603">instr</span>&nbsp;<span class="op" id="3994609">:=</span>&nbsp;<span class="op" id="3994612">&amp;</span><span class="ident" id="3994613">engine</span><span class="op" id="3994619">.</span><span class="ident" id="3994620">instr</span><span class="op" id="3994625">[</span><span class="ident" id="3994626">i</span><span class="op" id="3994627">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3994631">if</span>&nbsp;<span class="ident" id="3994634">i</span>&nbsp;<span class="op" id="3994636">&gt;=</span>&nbsp;<span class="ident" id="3994639">value</span><span class="op" id="3994644">.</span><span class="ident" id="3994645">NumField</span><span class="op" id="3994653">(</span><span class="op" id="3994654">)</span>&nbsp;<span class="op" id="3994656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3994661">//&nbsp;encStructTerminator</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994687">instr</span><span class="op" id="3994692">.</span><span class="ident" id="3994693">op</span><span class="op" id="3994695">(</span><span class="ident" id="3994696">instr</span><span class="op" id="3994701">,</span>&nbsp;<span class="ident" id="3994703">state</span><span class="op" id="3994708">,</span>&nbsp;<span class="ident" id="3994710">reflect</span><span class="op" id="3994717">.</span><span class="ident" id="3994718">Value</span><span class="op" id="3994723">{</span><span class="op" id="3994724">}</span><span class="op" id="3994725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3994730">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3994738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994742">field</span>&nbsp;<span class="op" id="3994748">:=</span>&nbsp;<span class="ident" id="3994751">value</span><span class="op" id="3994756">.</span><span class="ident" id="3994757">FieldByIndex</span><span class="op" id="3994769">(</span><span class="ident" id="3994770">instr</span><span class="op" id="3994775">.</span><span class="ident" id="3994776">index</span><span class="op" id="3994781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3994785">if</span>&nbsp;<span class="ident" id="3994788">instr</span><span class="op" id="3994793">.</span><span class="ident" id="3994794">indir</span>&nbsp;<span class="op" id="3994800">&gt;</span>&nbsp;<span class="num" id="3994802">0</span>&nbsp;<span class="op" id="3994804">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994809">field</span>&nbsp;<span class="op" id="3994815">=</span>&nbsp;<span class="ident" id="3994817">encIndirect</span><span class="op" id="3994828">(</span><span class="ident" id="3994829">field</span><span class="op" id="3994834">,</span>&nbsp;<span class="ident" id="3994836">instr</span><span class="op" id="3994841">.</span><span class="ident" id="3994842">indir</span><span class="op" id="3994847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3994852">//&nbsp;TODO:&nbsp;Is&nbsp;field&nbsp;guaranteed&nbsp;valid?&nbsp;If&nbsp;so&nbsp;we&nbsp;could&nbsp;avoid&nbsp;this&nbsp;check.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3994924">if</span>&nbsp;<span class="op" id="3994927">!</span><span class="ident" id="3994928">valid</span><span class="op" id="3994933">(</span><span class="ident" id="3994934">field</span><span class="op" id="3994939">)</span>&nbsp;<span class="op" id="3994941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3994947">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3994959">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3994963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994967">instr</span><span class="op" id="3994972">.</span><span class="ident" id="3994973">op</span><span class="op" id="3994975">(</span><span class="ident" id="3994976">instr</span><span class="op" id="3994981">,</span>&nbsp;<span class="ident" id="3994983">state</span><span class="op" id="3994988">,</span>&nbsp;<span class="ident" id="3994990">field</span><span class="op" id="3994995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3994998">}</span><br>
<span class="lineno"></span><span class="op" id="3995000">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="comment" id="3995003">//&nbsp;encodeArray&nbsp;encodes&nbsp;an&nbsp;array.</span><br>
<span class="lineno"></span><span class="keyword" id="3995036">func</span>&nbsp;<span class="op" id="3995041">(</span><span class="ident" id="3995042">enc</span>&nbsp;<span class="op" id="3995046">*</span><span class="ident" id="3995047">Encoder</span><span class="op" id="3995054">)</span>&nbsp;<span class="ident" id="3995056">encodeArray</span><span class="op" id="3995067">(</span><span class="ident" id="3995068">b</span>&nbsp;<span class="op" id="3995070">*</span><span class="ident" id="3995071">encBuffer</span><span class="op" id="3995080">,</span>&nbsp;<span class="ident" id="3995082">value</span>&nbsp;<span class="ident" id="3995088">reflect</span><span class="op" id="3995095">.</span><span class="ident" id="3995096">Value</span><span class="op" id="3995101">,</span>&nbsp;<span class="ident" id="3995103">op</span>&nbsp;<span class="ident" id="3995106">encOp</span><span class="op" id="3995111">,</span>&nbsp;<span class="ident" id="3995113">elemIndir</span>&nbsp;<span class="builtintype" id="3995123">int</span><span class="op" id="3995126">,</span>&nbsp;<span class="ident" id="3995128">length</span>&nbsp;<span class="builtintype" id="3995135">int</span><span class="op" id="3995138">,</span>&nbsp;<span class="ident" id="3995140">helper</span>&nbsp;<span class="ident" id="3995147">encHelper</span><span class="op" id="3995156">)</span>&nbsp;<span class="op" id="3995158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995161">state</span>&nbsp;<span class="op" id="3995167">:=</span>&nbsp;<span class="ident" id="3995170">enc</span><span class="op" id="3995173">.</span><span class="ident" id="3995174">newEncoderState</span><span class="op" id="3995189">(</span><span class="ident" id="3995190">b</span><span class="op" id="3995191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3995194">defer</span>&nbsp;<span class="ident" id="3995200">enc</span><span class="op" id="3995203">.</span><span class="ident" id="3995204">freeEncoderState</span><span class="op" id="3995220">(</span><span class="ident" id="3995221">state</span><span class="op" id="3995226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995229">state</span><span class="op" id="3995234">.</span><span class="ident" id="3995235">fieldnum</span>&nbsp;<span class="op" id="3995244">=</span>&nbsp;<span class="op" id="3995246">-</span><span class="num" id="3995247">1</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995250">state</span><span class="op" id="3995255">.</span><span class="ident" id="3995256">sendZero</span>&nbsp;<span class="op" id="3995265">=</span>&nbsp;<span class="builtintype" id="3995267">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995273">state</span><span class="op" id="3995278">.</span><span class="ident" id="3995279">encodeUint</span><span class="op" id="3995289">(</span><span class="ident" id="3995290">uint64</span><span class="op" id="3995296">(</span><span class="ident" id="3995297">length</span><span class="op" id="3995303">)</span><span class="op" id="3995304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3995307">if</span>&nbsp;<span class="ident" id="3995310">helper</span>&nbsp;<span class="op" id="3995317">!=</span>&nbsp;<span class="ident" id="3995320">nil</span>&nbsp;<span class="op" id="3995324">&amp;&amp;</span>&nbsp;<span class="ident" id="3995327">helper</span><span class="op" id="3995333">(</span><span class="ident" id="3995334">state</span><span class="op" id="3995339">,</span>&nbsp;<span class="ident" id="3995341">value</span><span class="op" id="3995346">)</span>&nbsp;<span class="op" id="3995348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3995352">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3995360">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3995363">for</span>&nbsp;<span class="ident" id="3995367">i</span>&nbsp;<span class="op" id="3995369">:=</span>&nbsp;<span class="num" id="3995372">0</span><span class="op" id="3995373">;</span>&nbsp;<span class="ident" id="3995375">i</span>&nbsp;<span class="op" id="3995377">&lt;</span>&nbsp;<span class="ident" id="3995379">length</span><span class="op" id="3995385">;</span>&nbsp;<span class="ident" id="3995387">i</span><span class="op" id="3995388">++</span>&nbsp;<span class="op" id="3995391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995395">elem</span>&nbsp;<span class="op" id="3995400">:=</span>&nbsp;<span class="ident" id="3995403">value</span><span class="op" id="3995408">.</span><span class="ident" id="3995409">Index</span><span class="op" id="3995414">(</span><span class="ident" id="3995415">i</span><span class="op" id="3995416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3995420">if</span>&nbsp;<span class="ident" id="3995423">elemIndir</span>&nbsp;<span class="op" id="3995433">&gt;</span>&nbsp;<span class="num" id="3995435">0</span>&nbsp;<span class="op" id="3995437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995442">elem</span>&nbsp;<span class="op" id="3995447">=</span>&nbsp;<span class="ident" id="3995449">encIndirect</span><span class="op" id="3995460">(</span><span class="ident" id="3995461">elem</span><span class="op" id="3995465">,</span>&nbsp;<span class="ident" id="3995467">elemIndir</span><span class="op" id="3995476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3995481">//&nbsp;TODO:&nbsp;Is&nbsp;elem&nbsp;guaranteed&nbsp;valid?&nbsp;If&nbsp;so&nbsp;we&nbsp;could&nbsp;avoid&nbsp;this&nbsp;check.</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3995552">if</span>&nbsp;<span class="op" id="3995555">!</span><span class="ident" id="3995556">valid</span><span class="op" id="3995561">(</span><span class="ident" id="3995562">elem</span><span class="op" id="3995566">)</span>&nbsp;<span class="op" id="3995568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995574">errorf</span><span class="op" id="3995580">(</span><span class="string" id="3995581">&#34;encodeArray:&nbsp;nil&nbsp;element&#34;</span><span class="op" id="3995607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3995612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3995616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995620">op</span><span class="op" id="3995622">(</span><span class="ident" id="3995623">nil</span><span class="op" id="3995626">,</span>&nbsp;<span class="ident" id="3995628">state</span><span class="op" id="3995633">,</span>&nbsp;<span class="ident" id="3995635">elem</span><span class="op" id="3995639">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3995642">}</span><br>
<span class="lineno"></span><span class="op" id="3995644">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3995647">//&nbsp;encodeReflectValue&nbsp;is&nbsp;a&nbsp;helper&nbsp;for&nbsp;maps.&nbsp;It&nbsp;encodes&nbsp;the&nbsp;value&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="3995715">func</span>&nbsp;<span class="ident" id="3995720">encodeReflectValue</span><span class="op" id="3995738">(</span><span class="ident" id="3995739">state</span>&nbsp;<span class="op" id="3995745">*</span><span class="ident" id="3995746">encoderState</span><span class="op" id="3995758">,</span>&nbsp;<span class="ident" id="3995760">v</span>&nbsp;<span class="ident" id="3995762">reflect</span><span class="op" id="3995769">.</span><span class="ident" id="3995770">Value</span><span class="op" id="3995775">,</span>&nbsp;<span class="ident" id="3995777">op</span>&nbsp;<span class="ident" id="3995780">encOp</span><span class="op" id="3995785">,</span>&nbsp;<span class="ident" id="3995787">indir</span>&nbsp;<span class="builtintype" id="3995793">int</span><span class="op" id="3995796">)</span>&nbsp;<span class="op" id="3995798">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3995801">for</span>&nbsp;<span class="ident" id="3995805">i</span>&nbsp;<span class="op" id="3995807">:=</span>&nbsp;<span class="num" id="3995810">0</span><span class="op" id="3995811">;</span>&nbsp;<span class="ident" id="3995813">i</span>&nbsp;<span class="op" id="3995815">&lt;</span>&nbsp;<span class="ident" id="3995817">indir</span>&nbsp;<span class="op" id="3995823">&amp;&amp;</span>&nbsp;<span class="ident" id="3995826">v</span><span class="op" id="3995827">.</span><span class="ident" id="3995828">IsValid</span><span class="op" id="3995835">(</span><span class="op" id="3995836">)</span><span class="op" id="3995837">;</span>&nbsp;<span class="ident" id="3995839">i</span><span class="op" id="3995840">++</span>&nbsp;<span class="op" id="3995843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995847">v</span>&nbsp;<span class="op" id="3995849">=</span>&nbsp;<span class="ident" id="3995851">reflect</span><span class="op" id="3995858">.</span><span class="ident" id="3995859">Indirect</span><span class="op" id="3995867">(</span><span class="ident" id="3995868">v</span><span class="op" id="3995869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3995872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3995875">if</span>&nbsp;<span class="op" id="3995878">!</span><span class="ident" id="3995879">v</span><span class="op" id="3995880">.</span><span class="ident" id="3995881">IsValid</span><span class="op" id="3995888">(</span><span class="op" id="3995889">)</span>&nbsp;<span class="op" id="3995891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995895">errorf</span><span class="op" id="3995901">(</span><span class="string" id="3995902">&#34;encodeReflectValue:&nbsp;nil&nbsp;element&#34;</span><span class="op" id="3995935">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3995938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995941">op</span><span class="op" id="3995943">(</span><span class="ident" id="3995944">nil</span><span class="op" id="3995947">,</span>&nbsp;<span class="ident" id="3995949">state</span><span class="op" id="3995954">,</span>&nbsp;<span class="ident" id="3995956">v</span><span class="op" id="3995957">)</span><br>
<span class="lineno"></span><span class="op" id="3995959">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3995962">//&nbsp;encodeMap&nbsp;encodes&nbsp;a&nbsp;map&nbsp;as&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;key:value&nbsp;pairs.</span><br>
<span class="lineno">360</span><span class="keyword" id="3996036">func</span>&nbsp;<span class="op" id="3996041">(</span><span class="ident" id="3996042">enc</span>&nbsp;<span class="op" id="3996046">*</span><span class="ident" id="3996047">Encoder</span><span class="op" id="3996054">)</span>&nbsp;<span class="ident" id="3996056">encodeMap</span><span class="op" id="3996065">(</span><span class="ident" id="3996066">b</span>&nbsp;<span class="op" id="3996068">*</span><span class="ident" id="3996069">encBuffer</span><span class="op" id="3996078">,</span>&nbsp;<span class="ident" id="3996080">mv</span>&nbsp;<span class="ident" id="3996083">reflect</span><span class="op" id="3996090">.</span><span class="ident" id="3996091">Value</span><span class="op" id="3996096">,</span>&nbsp;<span class="ident" id="3996098">keyOp</span><span class="op" id="3996103">,</span>&nbsp;<span class="ident" id="3996105">elemOp</span>&nbsp;<span class="ident" id="3996112">encOp</span><span class="op" id="3996117">,</span>&nbsp;<span class="ident" id="3996119">keyIndir</span><span class="op" id="3996127">,</span>&nbsp;<span class="ident" id="3996129">elemIndir</span>&nbsp;<span class="builtintype" id="3996139">int</span><span class="op" id="3996142">)</span>&nbsp;<span class="op" id="3996144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3996147">state</span>&nbsp;<span class="op" id="3996153">:=</span>&nbsp;<span class="ident" id="3996156">enc</span><span class="op" id="3996159">.</span><span class="ident" id="3996160">newEncoderState</span><span class="op" id="3996175">(</span><span class="ident" id="3996176">b</span><span class="op" id="3996177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3996180">state</span><span class="op" id="3996185">.</span><span class="ident" id="3996186">fieldnum</span>&nbsp;<span class="op" id="3996195">=</span>&nbsp;<span class="op" id="3996197">-</span><span class="num" id="3996198">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3996201">state</span><span class="op" id="3996206">.</span><span class="ident" id="3996207">sendZero</span>&nbsp;<span class="op" id="3996216">=</span>&nbsp;<span class="builtintype" id="3996218">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3996224">keys</span>&nbsp;<span class="op" id="3996229">:=</span>&nbsp;<span class="ident" id="3996232">mv</span><span class="op" id="3996234">.</span><span class="ident" id="3996235">MapKeys</span><span class="op" id="3996242">(</span><span class="op" id="3996243">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3996246">state</span><span class="op" id="3996251">.</span><span class="ident" id="3996252">encodeUint</span><span class="op" id="3996262">(</span><span class="ident" id="3996263">uint64</span><span class="op" id="3996269">(</span><span class="builtinfunc" id="3996270">len</span><span class="op" id="3996273">(</span><span class="ident" id="3996274">keys</span><span class="op" id="3996278">)</span><span class="op" id="3996279">)</span><span class="op" id="3996280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3996283">for</span>&nbsp;<span class="ident" id="3996287">_</span><span class="op" id="3996288">,</span>&nbsp;<span class="ident" id="3996290">key</span>&nbsp;<span class="op" id="3996294">:=</span>&nbsp;<span class="keyword" id="3996297">range</span>&nbsp;<span class="ident" id="3996303">keys</span>&nbsp;<span class="op" id="3996308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3996312">encodeReflectValue</span><span class="op" id="3996330">(</span><span class="ident" id="3996331">state</span><span class="op" id="3996336">,</span>&nbsp;<span class="ident" id="3996338">key</span><span class="op" id="3996341">,</span>&nbsp;<span class="ident" id="3996343">keyOp</span><span class="op" id="3996348">,</span>&nbsp;<span class="ident" id="3996350">keyIndir</span><span class="op" id="3996358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3996362">encodeReflectValue</span><span class="op" id="3996380">(</span><span class="ident" id="3996381">state</span><span class="op" id="3996386">,</span>&nbsp;<span class="ident" id="3996388">mv</span><span class="op" id="3996390">.</span><span class="ident" id="3996391">MapIndex</span><span class="op" id="3996399">(</span><span class="ident" id="3996400">key</span><span class="op" id="3996403">)</span><span class="op" id="3996404">,</span>&nbsp;<span class="ident" id="3996406">elemOp</span><span class="op" id="3996412">,</span>&nbsp;<span class="ident" id="3996414">elemIndir</span><span class="op" id="3996423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3996426">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3996429">enc</span><span class="op" id="3996432">.</span><span class="ident" id="3996433">freeEncoderState</span><span class="op" id="3996449">(</span><span class="ident" id="3996450">state</span><span class="op" id="3996455">)</span><br>
<span class="lineno"></span><span class="op" id="3996457">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3996460">//&nbsp;encodeInterface&nbsp;encodes&nbsp;the&nbsp;interface&nbsp;value&nbsp;iv.</span><br>
<span class="lineno"></span><span class="comment" id="3996511">//&nbsp;To&nbsp;send&nbsp;an&nbsp;interface,&nbsp;we&nbsp;send&nbsp;a&nbsp;string&nbsp;identifying&nbsp;the&nbsp;concrete&nbsp;type,&nbsp;followed</span><br>
<span class="lineno">375</span><span class="comment" id="3996593">//&nbsp;by&nbsp;the&nbsp;type&nbsp;identifier&nbsp;(which&nbsp;might&nbsp;require&nbsp;defining&nbsp;that&nbsp;type&nbsp;right&nbsp;now),&nbsp;followed</span><br>
<span class="lineno"></span><span class="comment" id="3996680">//&nbsp;by&nbsp;the&nbsp;concrete&nbsp;value.&nbsp;&nbsp;A&nbsp;nil&nbsp;value&nbsp;gets&nbsp;sent&nbsp;as&nbsp;the&nbsp;empty&nbsp;string&nbsp;for&nbsp;the&nbsp;name,</span><br>
<span class="lineno"></span><span class="comment" id="3996763">//&nbsp;followed&nbsp;by&nbsp;no&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="3996788">func</span>&nbsp;<span class="op" id="3996793">(</span><span class="ident" id="3996794">enc</span>&nbsp;<span class="op" id="3996798">*</span><span class="ident" id="3996799">Encoder</span><span class="op" id="3996806">)</span>&nbsp;<span class="ident" id="3996808">encodeInterface</span><span class="op" id="3996823">(</span><span class="ident" id="3996824">b</span>&nbsp;<span class="op" id="3996826">*</span><span class="ident" id="3996827">encBuffer</span><span class="op" id="3996836">,</span>&nbsp;<span class="ident" id="3996838">iv</span>&nbsp;<span class="ident" id="3996841">reflect</span><span class="op" id="3996848">.</span><span class="ident" id="3996849">Value</span><span class="op" id="3996854">)</span>&nbsp;<span class="op" id="3996856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3996859">//&nbsp;Gobs&nbsp;can&nbsp;encode&nbsp;nil&nbsp;interface&nbsp;values&nbsp;but&nbsp;not&nbsp;typed&nbsp;interface</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3996924">//&nbsp;values&nbsp;holding&nbsp;nil&nbsp;pointers,&nbsp;since&nbsp;nil&nbsp;pointers&nbsp;point&nbsp;to&nbsp;no&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3996995">elem</span>&nbsp;<span class="op" id="3997000">:=</span>&nbsp;<span class="ident" id="3997003">iv</span><span class="op" id="3997005">.</span><span class="ident" id="3997006">Elem</span><span class="op" id="3997010">(</span><span class="op" id="3997011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3997014">if</span>&nbsp;<span class="ident" id="3997017">elem</span><span class="op" id="3997021">.</span><span class="ident" id="3997022">Kind</span><span class="op" id="3997026">(</span><span class="op" id="3997027">)</span>&nbsp;<span class="op" id="3997029">==</span>&nbsp;<span class="ident" id="3997032">reflect</span><span class="op" id="3997039">.</span><span class="ident" id="3997040">Ptr</span>&nbsp;<span class="op" id="3997044">&amp;&amp;</span>&nbsp;<span class="ident" id="3997047">elem</span><span class="op" id="3997051">.</span><span class="ident" id="3997052">IsNil</span><span class="op" id="3997057">(</span><span class="op" id="3997058">)</span>&nbsp;<span class="op" id="3997060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3997064">errorf</span><span class="op" id="3997070">(</span><span class="string" id="3997071">&#34;gob:&nbsp;cannot&nbsp;encode&nbsp;nil&nbsp;pointer&nbsp;of&nbsp;type&nbsp;%s&nbsp;inside&nbsp;interface&#34;</span><span class="op" id="3997131">,</span>&nbsp;<span class="ident" id="3997133">iv</span><span class="op" id="3997135">.</span><span class="ident" id="3997136">Elem</span><span class="op" id="3997140">(</span><span class="op" id="3997141">)</span><span class="op" id="3997142">.</span><span class="ident" id="3997143">Type</span><span class="op" id="3997147">(</span><span class="op" id="3997148">)</span><span class="op" id="3997149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3997152">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3997155">state</span>&nbsp;<span class="op" id="3997161">:=</span>&nbsp;<span class="ident" id="3997164">enc</span><span class="op" id="3997167">.</span><span class="ident" id="3997168">newEncoderState</span><span class="op" id="3997183">(</span><span class="ident" id="3997184">b</span><span class="op" id="3997185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3997188">state</span><span class="op" id="3997193">.</span><span class="ident" id="3997194">fieldnum</span>&nbsp;<span class="op" id="3997203">=</span>&nbsp;<span class="op" id="3997205">-</span><span class="num" id="3997206">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3997209">state</span><span class="op" id="3997214">.</span><span class="ident" id="3997215">sendZero</span>&nbsp;<span class="op" id="3997224">=</span>&nbsp;<span class="builtintype" id="3997226">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3997232">if</span>&nbsp;<span class="ident" id="3997235">iv</span><span class="op" id="3997237">.</span><span class="ident" id="3997238">IsNil</span><span class="op" id="3997243">(</span><span class="op" id="3997244">)</span>&nbsp;<span class="op" id="3997246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3997250">state</span><span class="op" id="3997255">.</span><span class="ident" id="3997256">encodeUint</span><span class="op" id="3997266">(</span><span class="num" id="3997267">0</span><span class="op" id="3997268">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3997272">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3997280">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3997284">ut</span>&nbsp;<span class="op" id="3997287">:=</span>&nbsp;<span class="ident" id="3997290">userType</span><span class="op" id="3997298">(</span><span class="ident" id="3997299">iv</span><span class="op" id="3997301">.</span><span class="ident" id="3997302">Elem</span><span class="op" id="3997306">(</span><span class="op" id="3997307">)</span><span class="op" id="3997308">.</span><span class="ident" id="3997309">Type</span><span class="op" id="3997313">(</span><span class="op" id="3997314">)</span><span class="op" id="3997315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3997318">registerLock</span><span class="op" id="3997330">.</span><span class="ident" id="3997331">RLock</span><span class="op" id="3997336">(</span><span class="op" id="3997337">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3997340">name</span><span class="op" id="3997344">,</span>&nbsp;<span class="ident" id="3997346">ok</span>&nbsp;<span class="op" id="3997349">:=</span>&nbsp;<span class="ident" id="3997352">concreteTypeToName</span><span class="op" id="3997370">[</span><span class="ident" id="3997371">ut</span><span class="op" id="3997373">.</span><span class="ident" id="3997374">base</span><span class="op" id="3997378">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3997381">registerLock</span><span class="op" id="3997393">.</span><span class="ident" id="3997394">RUnlock</span><span class="op" id="3997401">(</span><span class="op" id="3997402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3997405">if</span>&nbsp;<span class="op" id="3997408">!</span><span class="ident" id="3997409">ok</span>&nbsp;<span class="op" id="3997412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3997416">errorf</span><span class="op" id="3997422">(</span><span class="string" id="3997423">&#34;type&nbsp;not&nbsp;registered&nbsp;for&nbsp;interface:&nbsp;%s&#34;</span><span class="op" id="3997462">,</span>&nbsp;<span class="ident" id="3997464">ut</span><span class="op" id="3997466">.</span><span class="ident" id="3997467">base</span><span class="op" id="3997471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3997474">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3997477">//&nbsp;Send&nbsp;the&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3997496">state</span><span class="op" id="3997501">.</span><span class="ident" id="3997502">encodeUint</span><span class="op" id="3997512">(</span><span class="ident" id="3997513">uint64</span><span class="op" id="3997519">(</span><span class="builtinfunc" id="3997520">len</span><span class="op" id="3997523">(</span><span class="ident" id="3997524">name</span><span class="op" id="3997528">)</span><span class="op" id="3997529">)</span><span class="op" id="3997530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3997533">state</span><span class="op" id="3997538">.</span><span class="ident" id="3997539">b</span><span class="op" id="3997540">.</span><span class="ident" id="3997541">WriteString</span><span class="op" id="3997552">(</span><span class="ident" id="3997553">name</span><span class="op" id="3997557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3997560">//&nbsp;Define&nbsp;the&nbsp;type&nbsp;id&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3997597">enc</span><span class="op" id="3997600">.</span><span class="ident" id="3997601">sendTypeDescriptor</span><span class="op" id="3997619">(</span><span class="ident" id="3997620">enc</span><span class="op" id="3997623">.</span><span class="ident" id="3997624">writer</span><span class="op" id="3997630">(</span><span class="op" id="3997631">)</span><span class="op" id="3997632">,</span>&nbsp;<span class="ident" id="3997634">state</span><span class="op" id="3997639">,</span>&nbsp;<span class="ident" id="3997641">ut</span><span class="op" id="3997643">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3997646">//&nbsp;Send&nbsp;the&nbsp;type&nbsp;id.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3997668">enc</span><span class="op" id="3997671">.</span><span class="ident" id="3997672">sendTypeId</span><span class="op" id="3997682">(</span><span class="ident" id="3997683">state</span><span class="op" id="3997688">,</span>&nbsp;<span class="ident" id="3997690">ut</span><span class="op" id="3997692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3997695">//&nbsp;Encode&nbsp;the&nbsp;value&nbsp;into&nbsp;a&nbsp;new&nbsp;buffer.&nbsp;&nbsp;Any&nbsp;nested&nbsp;type&nbsp;definitions</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3997764">//&nbsp;should&nbsp;be&nbsp;written&nbsp;to&nbsp;b,&nbsp;before&nbsp;the&nbsp;encoded&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3997818">enc</span><span class="op" id="3997821">.</span><span class="ident" id="3997822">pushWriter</span><span class="op" id="3997832">(</span><span class="ident" id="3997833">b</span><span class="op" id="3997834">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3997837">data</span>&nbsp;<span class="op" id="3997842">:=</span>&nbsp;<span class="builtinfunc" id="3997845">new</span><span class="op" id="3997848">(</span><span class="ident" id="3997849">encBuffer</span><span class="op" id="3997858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3997861">data</span><span class="op" id="3997865">.</span><span class="ident" id="3997866">Write</span><span class="op" id="3997871">(</span><span class="ident" id="3997872">spaceForLength</span><span class="op" id="3997886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3997889">enc</span><span class="op" id="3997892">.</span><span class="ident" id="3997893">encode</span><span class="op" id="3997899">(</span><span class="ident" id="3997900">data</span><span class="op" id="3997904">,</span>&nbsp;<span class="ident" id="3997906">elem</span><span class="op" id="3997910">,</span>&nbsp;<span class="ident" id="3997912">ut</span><span class="op" id="3997914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3997917">if</span>&nbsp;<span class="ident" id="3997920">enc</span><span class="op" id="3997923">.</span><span class="ident" id="3997924">err</span>&nbsp;<span class="op" id="3997928">!=</span>&nbsp;<span class="ident" id="3997931">nil</span>&nbsp;<span class="op" id="3997935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3997939">error_</span><span class="op" id="3997945">(</span><span class="ident" id="3997946">enc</span><span class="op" id="3997949">.</span><span class="ident" id="3997950">err</span><span class="op" id="3997953">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3997956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3997959">enc</span><span class="op" id="3997962">.</span><span class="ident" id="3997963">popWriter</span><span class="op" id="3997972">(</span><span class="op" id="3997973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3997976">enc</span><span class="op" id="3997979">.</span><span class="ident" id="3997980">writeMessage</span><span class="op" id="3997992">(</span><span class="ident" id="3997993">b</span><span class="op" id="3997994">,</span>&nbsp;<span class="ident" id="3997996">data</span><span class="op" id="3998000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998003">if</span>&nbsp;<span class="ident" id="3998006">enc</span><span class="op" id="3998009">.</span><span class="ident" id="3998010">err</span>&nbsp;<span class="op" id="3998014">!=</span>&nbsp;<span class="ident" id="3998017">nil</span>&nbsp;<span class="op" id="3998021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3998025">error_</span><span class="op" id="3998031">(</span><span class="ident" id="3998032">enc</span><span class="op" id="3998035">.</span><span class="ident" id="3998036">err</span><span class="op" id="3998039">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3998042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3998045">enc</span><span class="op" id="3998048">.</span><span class="ident" id="3998049">freeEncoderState</span><span class="op" id="3998065">(</span><span class="ident" id="3998066">state</span><span class="op" id="3998071">)</span><br>
<span class="lineno"></span><span class="op" id="3998073">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3998076">//&nbsp;isZero&nbsp;reports&nbsp;whether&nbsp;the&nbsp;value&nbsp;is&nbsp;the&nbsp;zero&nbsp;of&nbsp;its&nbsp;type.</span><br>
<span class="lineno">425</span><span class="keyword" id="3998137">func</span>&nbsp;<span class="ident" id="3998142">isZero</span><span class="op" id="3998148">(</span><span class="ident" id="3998149">val</span>&nbsp;<span class="ident" id="3998153">reflect</span><span class="op" id="3998160">.</span><span class="ident" id="3998161">Value</span><span class="op" id="3998166">)</span>&nbsp;<span class="builtintype" id="3998168">bool</span>&nbsp;<span class="op" id="3998173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998176">switch</span>&nbsp;<span class="ident" id="3998183">val</span><span class="op" id="3998186">.</span><span class="ident" id="3998187">Kind</span><span class="op" id="3998191">(</span><span class="op" id="3998192">)</span>&nbsp;<span class="op" id="3998194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998197">case</span>&nbsp;<span class="ident" id="3998202">reflect</span><span class="op" id="3998209">.</span><span class="ident" id="3998210">Array</span><span class="op" id="3998215">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998219">for</span>&nbsp;<span class="ident" id="3998223">i</span>&nbsp;<span class="op" id="3998225">:=</span>&nbsp;<span class="num" id="3998228">0</span><span class="op" id="3998229">;</span>&nbsp;<span class="ident" id="3998231">i</span>&nbsp;<span class="op" id="3998233">&lt;</span>&nbsp;<span class="ident" id="3998235">val</span><span class="op" id="3998238">.</span><span class="ident" id="3998239">Len</span><span class="op" id="3998242">(</span><span class="op" id="3998243">)</span><span class="op" id="3998244">;</span>&nbsp;<span class="ident" id="3998246">i</span><span class="op" id="3998247">++</span>&nbsp;<span class="op" id="3998250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998255">if</span>&nbsp;<span class="op" id="3998258">!</span><span class="ident" id="3998259">isZero</span><span class="op" id="3998265">(</span><span class="ident" id="3998266">val</span><span class="op" id="3998269">.</span><span class="ident" id="3998270">Index</span><span class="op" id="3998275">(</span><span class="ident" id="3998276">i</span><span class="op" id="3998277">)</span><span class="op" id="3998278">)</span>&nbsp;<span class="op" id="3998280">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998286">return</span>&nbsp;<span class="builtintype" id="3998293">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3998302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3998306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998310">return</span>&nbsp;<span class="builtintype" id="3998317">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998323">case</span>&nbsp;<span class="ident" id="3998328">reflect</span><span class="op" id="3998335">.</span><span class="ident" id="3998336">Map</span><span class="op" id="3998339">,</span>&nbsp;<span class="ident" id="3998341">reflect</span><span class="op" id="3998348">.</span><span class="ident" id="3998349">Slice</span><span class="op" id="3998354">,</span>&nbsp;<span class="ident" id="3998356">reflect</span><span class="op" id="3998363">.</span><span class="ident" id="3998364">String</span><span class="op" id="3998370">:</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998374">return</span>&nbsp;<span class="ident" id="3998381">val</span><span class="op" id="3998384">.</span><span class="ident" id="3998385">Len</span><span class="op" id="3998388">(</span><span class="op" id="3998389">)</span>&nbsp;<span class="op" id="3998391">==</span>&nbsp;<span class="num" id="3998394">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998397">case</span>&nbsp;<span class="ident" id="3998402">reflect</span><span class="op" id="3998409">.</span><span class="ident" id="3998410">Bool</span><span class="op" id="3998414">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998418">return</span>&nbsp;<span class="op" id="3998425">!</span><span class="ident" id="3998426">val</span><span class="op" id="3998429">.</span><span class="ident" id="3998430">Bool</span><span class="op" id="3998434">(</span><span class="op" id="3998435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998438">case</span>&nbsp;<span class="ident" id="3998443">reflect</span><span class="op" id="3998450">.</span><span class="ident" id="3998451">Complex64</span><span class="op" id="3998460">,</span>&nbsp;<span class="ident" id="3998462">reflect</span><span class="op" id="3998469">.</span><span class="ident" id="3998470">Complex128</span><span class="op" id="3998480">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998484">return</span>&nbsp;<span class="ident" id="3998491">val</span><span class="op" id="3998494">.</span><span class="ident" id="3998495">Complex</span><span class="op" id="3998502">(</span><span class="op" id="3998503">)</span>&nbsp;<span class="op" id="3998505">==</span>&nbsp;<span class="num" id="3998508">0</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998511">case</span>&nbsp;<span class="ident" id="3998516">reflect</span><span class="op" id="3998523">.</span><span class="ident" id="3998524">Chan</span><span class="op" id="3998528">,</span>&nbsp;<span class="ident" id="3998530">reflect</span><span class="op" id="3998537">.</span><span class="ident" id="3998538">Func</span><span class="op" id="3998542">,</span>&nbsp;<span class="ident" id="3998544">reflect</span><span class="op" id="3998551">.</span><span class="ident" id="3998552">Interface</span><span class="op" id="3998561">,</span>&nbsp;<span class="ident" id="3998563">reflect</span><span class="op" id="3998570">.</span><span class="ident" id="3998571">Ptr</span><span class="op" id="3998574">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998578">return</span>&nbsp;<span class="ident" id="3998585">val</span><span class="op" id="3998588">.</span><span class="ident" id="3998589">IsNil</span><span class="op" id="3998594">(</span><span class="op" id="3998595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998598">case</span>&nbsp;<span class="ident" id="3998603">reflect</span><span class="op" id="3998610">.</span><span class="ident" id="3998611">Int</span><span class="op" id="3998614">,</span>&nbsp;<span class="ident" id="3998616">reflect</span><span class="op" id="3998623">.</span><span class="ident" id="3998624">Int8</span><span class="op" id="3998628">,</span>&nbsp;<span class="ident" id="3998630">reflect</span><span class="op" id="3998637">.</span><span class="ident" id="3998638">Int16</span><span class="op" id="3998643">,</span>&nbsp;<span class="ident" id="3998645">reflect</span><span class="op" id="3998652">.</span><span class="ident" id="3998653">Int32</span><span class="op" id="3998658">,</span>&nbsp;<span class="ident" id="3998660">reflect</span><span class="op" id="3998667">.</span><span class="ident" id="3998668">Int64</span><span class="op" id="3998673">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998677">return</span>&nbsp;<span class="ident" id="3998684">val</span><span class="op" id="3998687">.</span><span class="ident" id="3998688">Int</span><span class="op" id="3998691">(</span><span class="op" id="3998692">)</span>&nbsp;<span class="op" id="3998694">==</span>&nbsp;<span class="num" id="3998697">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998700">case</span>&nbsp;<span class="ident" id="3998705">reflect</span><span class="op" id="3998712">.</span><span class="ident" id="3998713">Float32</span><span class="op" id="3998720">,</span>&nbsp;<span class="ident" id="3998722">reflect</span><span class="op" id="3998729">.</span><span class="ident" id="3998730">Float64</span><span class="op" id="3998737">:</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998741">return</span>&nbsp;<span class="ident" id="3998748">val</span><span class="op" id="3998751">.</span><span class="ident" id="3998752">Float</span><span class="op" id="3998757">(</span><span class="op" id="3998758">)</span>&nbsp;<span class="op" id="3998760">==</span>&nbsp;<span class="num" id="3998763">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998766">case</span>&nbsp;<span class="ident" id="3998771">reflect</span><span class="op" id="3998778">.</span><span class="ident" id="3998779">Uint</span><span class="op" id="3998783">,</span>&nbsp;<span class="ident" id="3998785">reflect</span><span class="op" id="3998792">.</span><span class="ident" id="3998793">Uint8</span><span class="op" id="3998798">,</span>&nbsp;<span class="ident" id="3998800">reflect</span><span class="op" id="3998807">.</span><span class="ident" id="3998808">Uint16</span><span class="op" id="3998814">,</span>&nbsp;<span class="ident" id="3998816">reflect</span><span class="op" id="3998823">.</span><span class="ident" id="3998824">Uint32</span><span class="op" id="3998830">,</span>&nbsp;<span class="ident" id="3998832">reflect</span><span class="op" id="3998839">.</span><span class="ident" id="3998840">Uint64</span><span class="op" id="3998846">,</span>&nbsp;<span class="ident" id="3998848">reflect</span><span class="op" id="3998855">.</span><span class="ident" id="3998856">Uintptr</span><span class="op" id="3998863">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998867">return</span>&nbsp;<span class="ident" id="3998874">val</span><span class="op" id="3998877">.</span><span class="ident" id="3998878">Uint</span><span class="op" id="3998882">(</span><span class="op" id="3998883">)</span>&nbsp;<span class="op" id="3998885">==</span>&nbsp;<span class="num" id="3998888">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998891">case</span>&nbsp;<span class="ident" id="3998896">reflect</span><span class="op" id="3998903">.</span><span class="ident" id="3998904">Struct</span><span class="op" id="3998910">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998914">for</span>&nbsp;<span class="ident" id="3998918">i</span>&nbsp;<span class="op" id="3998920">:=</span>&nbsp;<span class="num" id="3998923">0</span><span class="op" id="3998924">;</span>&nbsp;<span class="ident" id="3998926">i</span>&nbsp;<span class="op" id="3998928">&lt;</span>&nbsp;<span class="ident" id="3998930">val</span><span class="op" id="3998933">.</span><span class="ident" id="3998934">NumField</span><span class="op" id="3998942">(</span><span class="op" id="3998943">)</span><span class="op" id="3998944">;</span>&nbsp;<span class="ident" id="3998946">i</span><span class="op" id="3998947">++</span>&nbsp;<span class="op" id="3998950">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998955">if</span>&nbsp;<span class="op" id="3998958">!</span><span class="ident" id="3998959">isZero</span><span class="op" id="3998965">(</span><span class="ident" id="3998966">val</span><span class="op" id="3998969">.</span><span class="ident" id="3998970">Field</span><span class="op" id="3998975">(</span><span class="ident" id="3998976">i</span><span class="op" id="3998977">)</span><span class="op" id="3998978">)</span>&nbsp;<span class="op" id="3998980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998986">return</span>&nbsp;<span class="builtintype" id="3998993">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3999002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3999006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3999010">return</span>&nbsp;<span class="builtintype" id="3999017">true</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3999023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3999026">panic</span><span class="op" id="3999031">(</span><span class="string" id="3999032">&#34;unknown&nbsp;type&nbsp;in&nbsp;isZero&nbsp;&#34;</span>&nbsp;<span class="op" id="3999058">+</span>&nbsp;<span class="ident" id="3999060">val</span><span class="op" id="3999063">.</span><span class="ident" id="3999064">Type</span><span class="op" id="3999068">(</span><span class="op" id="3999069">)</span><span class="op" id="3999070">.</span><span class="ident" id="3999071">String</span><span class="op" id="3999077">(</span><span class="op" id="3999078">)</span><span class="op" id="3999079">)</span><br>
<span class="lineno"></span><span class="op" id="3999081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3999084">//&nbsp;encGobEncoder&nbsp;encodes&nbsp;a&nbsp;value&nbsp;that&nbsp;implements&nbsp;the&nbsp;GobEncoder&nbsp;interface.</span><br>
<span class="lineno">460</span><span class="comment" id="3999159">//&nbsp;The&nbsp;data&nbsp;is&nbsp;sent&nbsp;as&nbsp;a&nbsp;byte&nbsp;array.</span><br>
<span class="lineno"></span><span class="keyword" id="3999196">func</span>&nbsp;<span class="op" id="3999201">(</span><span class="ident" id="3999202">enc</span>&nbsp;<span class="op" id="3999206">*</span><span class="ident" id="3999207">Encoder</span><span class="op" id="3999214">)</span>&nbsp;<span class="ident" id="3999216">encodeGobEncoder</span><span class="op" id="3999232">(</span><span class="ident" id="3999233">b</span>&nbsp;<span class="op" id="3999235">*</span><span class="ident" id="3999236">encBuffer</span><span class="op" id="3999245">,</span>&nbsp;<span class="ident" id="3999247">ut</span>&nbsp;<span class="op" id="3999250">*</span><span class="ident" id="3999251">userTypeInfo</span><span class="op" id="3999263">,</span>&nbsp;<span class="ident" id="3999265">v</span>&nbsp;<span class="ident" id="3999267">reflect</span><span class="op" id="3999274">.</span><span class="ident" id="3999275">Value</span><span class="op" id="3999280">)</span>&nbsp;<span class="op" id="3999282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3999285">//&nbsp;TODO:&nbsp;should&nbsp;we&nbsp;catch&nbsp;panics&nbsp;from&nbsp;the&nbsp;called&nbsp;method?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3999343">var</span>&nbsp;<span class="ident" id="3999347">data</span>&nbsp;<span class="op" id="3999352">[</span><span class="op" id="3999353">]</span><span class="builtintype" id="3999354">byte</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3999360">var</span>&nbsp;<span class="ident" id="3999364">err</span>&nbsp;<span class="builtintype" id="3999368">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3999375">//&nbsp;We&nbsp;know&nbsp;it&#39;s&nbsp;one&nbsp;of&nbsp;these.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3999406">switch</span>&nbsp;<span class="ident" id="3999413">ut</span><span class="op" id="3999415">.</span><span class="ident" id="3999416">externalEnc</span>&nbsp;<span class="op" id="3999428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3999431">case</span>&nbsp;<span class="ident" id="3999436">xGob</span><span class="op" id="3999440">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3999444">data</span><span class="op" id="3999448">,</span>&nbsp;<span class="ident" id="3999450">err</span>&nbsp;<span class="op" id="3999454">=</span>&nbsp;<span class="ident" id="3999456">v</span><span class="op" id="3999457">.</span><span class="ident" id="3999458">Interface</span><span class="op" id="3999467">(</span><span class="op" id="3999468">)</span><span class="op" id="3999469">.</span><span class="op" id="3999470">(</span><span class="ident" id="3999471">GobEncoder</span><span class="op" id="3999481">)</span><span class="op" id="3999482">.</span><span class="ident" id="3999483">GobEncode</span><span class="op" id="3999492">(</span><span class="op" id="3999493">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3999496">case</span>&nbsp;<span class="ident" id="3999501">xBinary</span><span class="op" id="3999508">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3999512">data</span><span class="op" id="3999516">,</span>&nbsp;<span class="ident" id="3999518">err</span>&nbsp;<span class="op" id="3999522">=</span>&nbsp;<span class="ident" id="3999524">v</span><span class="op" id="3999525">.</span><span class="ident" id="3999526">Interface</span><span class="op" id="3999535">(</span><span class="op" id="3999536">)</span><span class="op" id="3999537">.</span><span class="op" id="3999538">(</span><span class="ident" id="3999539">encoding</span><span class="op" id="3999547">.</span><span class="ident" id="3999548">BinaryMarshaler</span><span class="op" id="3999563">)</span><span class="op" id="3999564">.</span><span class="ident" id="3999565">MarshalBinary</span><span class="op" id="3999578">(</span><span class="op" id="3999579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3999582">case</span>&nbsp;<span class="ident" id="3999587">xText</span><span class="op" id="3999592">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3999596">data</span><span class="op" id="3999600">,</span>&nbsp;<span class="ident" id="3999602">err</span>&nbsp;<span class="op" id="3999606">=</span>&nbsp;<span class="ident" id="3999608">v</span><span class="op" id="3999609">.</span><span class="ident" id="3999610">Interface</span><span class="op" id="3999619">(</span><span class="op" id="3999620">)</span><span class="op" id="3999621">.</span><span class="op" id="3999622">(</span><span class="ident" id="3999623">encoding</span><span class="op" id="3999631">.</span><span class="ident" id="3999632">TextMarshaler</span><span class="op" id="3999645">)</span><span class="op" id="3999646">.</span><span class="ident" id="3999647">MarshalText</span><span class="op" id="3999658">(</span><span class="op" id="3999659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3999662">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3999665">if</span>&nbsp;<span class="ident" id="3999668">err</span>&nbsp;<span class="op" id="3999672">!=</span>&nbsp;<span class="ident" id="3999675">nil</span>&nbsp;<span class="op" id="3999679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3999683">error_</span><span class="op" id="3999689">(</span><span class="ident" id="3999690">err</span><span class="op" id="3999693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3999696">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3999699">state</span>&nbsp;<span class="op" id="3999705">:=</span>&nbsp;<span class="ident" id="3999708">enc</span><span class="op" id="3999711">.</span><span class="ident" id="3999712">newEncoderState</span><span class="op" id="3999727">(</span><span class="ident" id="3999728">b</span><span class="op" id="3999729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3999732">state</span><span class="op" id="3999737">.</span><span class="ident" id="3999738">fieldnum</span>&nbsp;<span class="op" id="3999747">=</span>&nbsp;<span class="op" id="3999749">-</span><span class="num" id="3999750">1</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3999753">state</span><span class="op" id="3999758">.</span><span class="ident" id="3999759">encodeUint</span><span class="op" id="3999769">(</span><span class="ident" id="3999770">uint64</span><span class="op" id="3999776">(</span><span class="builtinfunc" id="3999777">len</span><span class="op" id="3999780">(</span><span class="ident" id="3999781">data</span><span class="op" id="3999785">)</span><span class="op" id="3999786">)</span><span class="op" id="3999787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3999790">state</span><span class="op" id="3999795">.</span><span class="ident" id="3999796">b</span><span class="op" id="3999797">.</span><span class="ident" id="3999798">Write</span><span class="op" id="3999803">(</span><span class="ident" id="3999804">data</span><span class="op" id="3999808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3999811">enc</span><span class="op" id="3999814">.</span><span class="ident" id="3999815">freeEncoderState</span><span class="op" id="3999831">(</span><span class="ident" id="3999832">state</span><span class="op" id="3999837">)</span><br>
<span class="lineno"></span><span class="op" id="3999839">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">485</span><span class="keyword" id="3999842">var</span>&nbsp;<span class="ident" id="3999846">encOpTable</span>&nbsp;<span class="op" id="3999857">=</span>&nbsp;<span class="op" id="3999859">[</span><span class="op" id="3999860">...</span><span class="op" id="3999863">]</span><span class="ident" id="3999864">encOp</span><span class="op" id="3999869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3999872">reflect</span><span class="op" id="3999879">.</span><span class="ident" id="3999880">Bool</span><span class="op" id="3999884">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3999892">encBool</span><span class="op" id="3999899">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3999902">reflect</span><span class="op" id="3999909">.</span><span class="ident" id="3999910">Int</span><span class="op" id="3999913">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3999922">encInt</span><span class="op" id="3999928">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3999931">reflect</span><span class="op" id="3999938">.</span><span class="ident" id="3999939">Int8</span><span class="op" id="3999943">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3999951">encInt</span><span class="op" id="3999957">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3999960">reflect</span><span class="op" id="3999967">.</span><span class="ident" id="3999968">Int16</span><span class="op" id="3999973">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3999980">encInt</span><span class="op" id="3999986">,</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3999989">reflect</span><span class="op" id="3999996">.</span><span class="ident" id="3999997">Int32</span><span class="op" id="4000002">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000009">encInt</span><span class="op" id="4000015">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4000018">reflect</span><span class="op" id="4000025">.</span><span class="ident" id="4000026">Int64</span><span class="op" id="4000031">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000038">encInt</span><span class="op" id="4000044">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4000047">reflect</span><span class="op" id="4000054">.</span><span class="ident" id="4000055">Uint</span><span class="op" id="4000059">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000067">encUint</span><span class="op" id="4000074">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4000077">reflect</span><span class="op" id="4000084">.</span><span class="ident" id="4000085">Uint8</span><span class="op" id="4000090">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000097">encUint</span><span class="op" id="4000104">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4000107">reflect</span><span class="op" id="4000114">.</span><span class="ident" id="4000115">Uint16</span><span class="op" id="4000121">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000127">encUint</span><span class="op" id="4000134">,</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4000137">reflect</span><span class="op" id="4000144">.</span><span class="ident" id="4000145">Uint32</span><span class="op" id="4000151">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000157">encUint</span><span class="op" id="4000164">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4000167">reflect</span><span class="op" id="4000174">.</span><span class="ident" id="4000175">Uint64</span><span class="op" id="4000181">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000187">encUint</span><span class="op" id="4000194">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4000197">reflect</span><span class="op" id="4000204">.</span><span class="ident" id="4000205">Uintptr</span><span class="op" id="4000212">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000217">encUint</span><span class="op" id="4000224">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4000227">reflect</span><span class="op" id="4000234">.</span><span class="ident" id="4000235">Float32</span><span class="op" id="4000242">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000247">encFloat</span><span class="op" id="4000255">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4000258">reflect</span><span class="op" id="4000265">.</span><span class="ident" id="4000266">Float64</span><span class="op" id="4000273">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000278">encFloat</span><span class="op" id="4000286">,</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4000289">reflect</span><span class="op" id="4000296">.</span><span class="ident" id="4000297">Complex64</span><span class="op" id="4000306">:</span>&nbsp;&nbsp;<span class="ident" id="4000309">encComplex</span><span class="op" id="4000319">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4000322">reflect</span><span class="op" id="4000329">.</span><span class="ident" id="4000330">Complex128</span><span class="op" id="4000340">:</span>&nbsp;<span class="ident" id="4000342">encComplex</span><span class="op" id="4000352">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4000355">reflect</span><span class="op" id="4000362">.</span><span class="ident" id="4000363">String</span><span class="op" id="4000369">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000375">encString</span><span class="op" id="4000384">,</span><br>
<span class="lineno"></span><span class="op" id="4000386">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span><span class="comment" id="4000389">//&nbsp;encOpFor&nbsp;returns&nbsp;(a&nbsp;pointer&nbsp;to)&nbsp;the&nbsp;encoding&nbsp;op&nbsp;for&nbsp;the&nbsp;base&nbsp;type&nbsp;under&nbsp;rt&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4000471">//&nbsp;the&nbsp;indirection&nbsp;count&nbsp;to&nbsp;reach&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="4000509">func</span>&nbsp;<span class="ident" id="4000514">encOpFor</span><span class="op" id="4000522">(</span><span class="ident" id="4000523">rt</span>&nbsp;<span class="ident" id="4000526">reflect</span><span class="op" id="4000533">.</span><span class="ident" id="4000534">Type</span><span class="op" id="4000538">,</span>&nbsp;<span class="ident" id="4000540">inProgress</span>&nbsp;<span class="keyword" id="4000551">map</span><span class="op" id="4000554">[</span><span class="ident" id="4000555">reflect</span><span class="op" id="4000562">.</span><span class="ident" id="4000563">Type</span><span class="op" id="4000567">]</span><span class="op" id="4000568">*</span><span class="ident" id="4000569">encOp</span><span class="op" id="4000574">,</span>&nbsp;<span class="ident" id="4000576">building</span>&nbsp;<span class="keyword" id="4000585">map</span><span class="op" id="4000588">[</span><span class="op" id="4000589">*</span><span class="ident" id="4000590">typeInfo</span><span class="op" id="4000598">]</span><span class="builtintype" id="4000599">bool</span><span class="op" id="4000603">)</span>&nbsp;<span class="op" id="4000605">(</span><span class="op" id="4000606">*</span><span class="ident" id="4000607">encOp</span><span class="op" id="4000612">,</span>&nbsp;<span class="builtintype" id="4000614">int</span><span class="op" id="4000617">)</span>&nbsp;<span class="op" id="4000619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4000622">ut</span>&nbsp;<span class="op" id="4000625">:=</span>&nbsp;<span class="ident" id="4000628">userType</span><span class="op" id="4000636">(</span><span class="ident" id="4000637">rt</span><span class="op" id="4000639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4000642">//&nbsp;If&nbsp;the&nbsp;type&nbsp;implements&nbsp;GobEncoder,&nbsp;we&nbsp;handle&nbsp;it&nbsp;without&nbsp;further&nbsp;processing.</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4000722">if</span>&nbsp;<span class="ident" id="4000725">ut</span><span class="op" id="4000727">.</span><span class="ident" id="4000728">externalEnc</span>&nbsp;<span class="op" id="4000740">!=</span>&nbsp;<span class="num" id="4000743">0</span>&nbsp;<span class="op" id="4000745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4000749">return</span>&nbsp;<span class="ident" id="4000756">gobEncodeOpFor</span><span class="op" id="4000770">(</span><span class="ident" id="4000771">ut</span><span class="op" id="4000773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4000776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4000779">//&nbsp;If&nbsp;this&nbsp;type&nbsp;is&nbsp;already&nbsp;in&nbsp;progress,&nbsp;it&#39;s&nbsp;a&nbsp;recursive&nbsp;type&nbsp;(e.g.&nbsp;map[string]*T).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4000864">//&nbsp;Return&nbsp;the&nbsp;pointer&nbsp;to&nbsp;the&nbsp;op&nbsp;we&#39;re&nbsp;already&nbsp;building.</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4000921">if</span>&nbsp;<span class="ident" id="4000924">opPtr</span>&nbsp;<span class="op" id="4000930">:=</span>&nbsp;<span class="ident" id="4000933">inProgress</span><span class="op" id="4000943">[</span><span class="ident" id="4000944">rt</span><span class="op" id="4000946">]</span><span class="op" id="4000947">;</span>&nbsp;<span class="ident" id="4000949">opPtr</span>&nbsp;<span class="op" id="4000955">!=</span>&nbsp;<span class="ident" id="4000958">nil</span>&nbsp;<span class="op" id="4000962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4000966">return</span>&nbsp;<span class="ident" id="4000973">opPtr</span><span class="op" id="4000978">,</span>&nbsp;<span class="ident" id="4000980">ut</span><span class="op" id="4000982">.</span><span class="ident" id="4000983">indir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4000990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4000993">typ</span>&nbsp;<span class="op" id="4000997">:=</span>&nbsp;<span class="ident" id="4001000">ut</span><span class="op" id="4001002">.</span><span class="ident" id="4001003">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4001009">indir</span>&nbsp;<span class="op" id="4001015">:=</span>&nbsp;<span class="ident" id="4001018">ut</span><span class="op" id="4001020">.</span><span class="ident" id="4001021">indir</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4001028">k</span>&nbsp;<span class="op" id="4001030">:=</span>&nbsp;<span class="ident" id="4001033">typ</span><span class="op" id="4001036">.</span><span class="ident" id="4001037">Kind</span><span class="op" id="4001041">(</span><span class="op" id="4001042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4001045">var</span>&nbsp;<span class="ident" id="4001049">op</span>&nbsp;<span class="ident" id="4001052">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4001059">if</span>&nbsp;<span class="builtintype" id="4001062">int</span><span class="op" id="4001065">(</span><span class="ident" id="4001066">k</span><span class="op" id="4001067">)</span>&nbsp;<span class="op" id="4001069">&lt;</span>&nbsp;<span class="builtinfunc" id="4001071">len</span><span class="op" id="4001074">(</span><span class="ident" id="4001075">encOpTable</span><span class="op" id="4001085">)</span>&nbsp;<span class="op" id="4001087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4001091">op</span>&nbsp;<span class="op" id="4001094">=</span>&nbsp;<span class="ident" id="4001096">encOpTable</span><span class="op" id="4001106">[</span><span class="ident" id="4001107">k</span><span class="op" id="4001108">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4001111">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4001114">if</span>&nbsp;<span class="ident" id="4001117">op</span>&nbsp;<span class="op" id="4001120">==</span>&nbsp;<span class="ident" id="4001123">nil</span>&nbsp;<span class="op" id="4001127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4001131">inProgress</span><span class="op" id="4001141">[</span><span class="ident" id="4001142">rt</span><span class="op" id="4001144">]</span>&nbsp;<span class="op" id="4001146">=</span>&nbsp;<span class="op" id="4001148">&amp;</span><span class="ident" id="4001149">op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4001154">//&nbsp;Special&nbsp;cases</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4001173">switch</span>&nbsp;<span class="ident" id="4001180">t</span>&nbsp;<span class="op" id="4001182">:=</span>&nbsp;<span class="ident" id="4001185">typ</span><span class="op" id="4001188">;</span>&nbsp;<span class="ident" id="4001190">t</span><span class="op" id="4001191">.</span><span class="ident" id="4001192">Kind</span><span class="op" id="4001196">(</span><span class="op" id="4001197">)</span>&nbsp;<span class="op" id="4001199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4001203">case</span>&nbsp;<span class="ident" id="4001208">reflect</span><span class="op" id="4001215">.</span><span class="ident" id="4001216">Slice</span><span class="op" id="4001221">:</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4001226">if</span>&nbsp;<span class="ident" id="4001229">t</span><span class="op" id="4001230">.</span><span class="ident" id="4001231">Elem</span><span class="op" id="4001235">(</span><span class="op" id="4001236">)</span><span class="op" id="4001237">.</span><span class="ident" id="4001238">Kind</span><span class="op" id="4001242">(</span><span class="op" id="4001243">)</span>&nbsp;<span class="op" id="4001245">==</span>&nbsp;<span class="ident" id="4001248">reflect</span><span class="op" id="4001255">.</span><span class="ident" id="4001256">Uint8</span>&nbsp;<span class="op" id="4001262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4001268">op</span>&nbsp;<span class="op" id="4001271">=</span>&nbsp;<span class="ident" id="4001273">encUint8Array</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4001291">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4001300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4001305">//&nbsp;Slices&nbsp;have&nbsp;a&nbsp;header;&nbsp;we&nbsp;decode&nbsp;it&nbsp;to&nbsp;find&nbsp;the&nbsp;underlying&nbsp;array.</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4001376">elemOp</span><span class="op" id="4001382">,</span>&nbsp;<span class="ident" id="4001384">elemIndir</span>&nbsp;<span class="op" id="4001394">:=</span>&nbsp;<span class="ident" id="4001397">encOpFor</span><span class="op" id="4001405">(</span><span class="ident" id="4001406">t</span><span class="op" id="4001407">.</span><span class="ident" id="4001408">Elem</span><span class="op" id="4001412">(</span><span class="op" id="4001413">)</span><span class="op" id="4001414">,</span>&nbsp;<span class="ident" id="4001416">inProgress</span><span class="op" id="4001426">,</span>&nbsp;<span class="ident" id="4001428">building</span><span class="op" id="4001436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4001441">helper</span>&nbsp;<span class="op" id="4001448">:=</span>&nbsp;<span class="ident" id="4001451">encSliceHelper</span><span class="op" id="4001465">[</span><span class="ident" id="4001466">t</span><span class="op" id="4001467">.</span><span class="ident" id="4001468">Elem</span><span class="op" id="4001472">(</span><span class="op" id="4001473">)</span><span class="op" id="4001474">.</span><span class="ident" id="4001475">Kind</span><span class="op" id="4001479">(</span><span class="op" id="4001480">)</span><span class="op" id="4001481">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4001486">op</span>&nbsp;<span class="op" id="4001489">=</span>&nbsp;<span class="keyword" id="4001491">func</span><span class="op" id="4001495">(</span><span class="ident" id="4001496">i</span>&nbsp;<span class="op" id="4001498">*</span><span class="ident" id="4001499">encInstr</span><span class="op" id="4001507">,</span>&nbsp;<span class="ident" id="4001509">state</span>&nbsp;<span class="op" id="4001515">*</span><span class="ident" id="4001516">encoderState</span><span class="op" id="4001528">,</span>&nbsp;<span class="ident" id="4001530">slice</span>&nbsp;<span class="ident" id="4001536">reflect</span><span class="op" id="4001543">.</span><span class="ident" id="4001544">Value</span><span class="op" id="4001549">)</span>&nbsp;<span class="op" id="4001551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4001557">if</span>&nbsp;<span class="op" id="4001560">!</span><span class="ident" id="4001561">state</span><span class="op" id="4001566">.</span><span class="ident" id="4001567">sendZero</span>&nbsp;<span class="op" id="4001576">&amp;&amp;</span>&nbsp;<span class="ident" id="4001579">slice</span><span class="op" id="4001584">.</span><span class="ident" id="4001585">Len</span><span class="op" id="4001588">(</span><span class="op" id="4001589">)</span>&nbsp;<span class="op" id="4001591">==</span>&nbsp;<span class="num" id="4001594">0</span>&nbsp;<span class="op" id="4001596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4001603">return</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4001614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4001620">state</span><span class="op" id="4001625">.</span><span class="ident" id="4001626">update</span><span class="op" id="4001632">(</span><span class="ident" id="4001633">i</span><span class="op" id="4001634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4001640">state</span><span class="op" id="4001645">.</span><span class="ident" id="4001646">enc</span><span class="op" id="4001649">.</span><span class="ident" id="4001650">encodeArray</span><span class="op" id="4001661">(</span><span class="ident" id="4001662">state</span><span class="op" id="4001667">.</span><span class="ident" id="4001668">b</span><span class="op" id="4001669">,</span>&nbsp;<span class="ident" id="4001671">slice</span><span class="op" id="4001676">,</span>&nbsp;<span class="op" id="4001678">*</span><span class="ident" id="4001679">elemOp</span><span class="op" id="4001685">,</span>&nbsp;<span class="ident" id="4001687">elemIndir</span><span class="op" id="4001696">,</span>&nbsp;<span class="ident" id="4001698">slice</span><span class="op" id="4001703">.</span><span class="ident" id="4001704">Len</span><span class="op" id="4001707">(</span><span class="op" id="4001708">)</span><span class="op" id="4001709">,</span>&nbsp;<span class="ident" id="4001711">helper</span><span class="op" id="4001717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4001722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4001726">case</span>&nbsp;<span class="ident" id="4001731">reflect</span><span class="op" id="4001738">.</span><span class="ident" id="4001739">Array</span><span class="op" id="4001744">:</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4001749">//&nbsp;True&nbsp;arrays&nbsp;have&nbsp;size&nbsp;in&nbsp;the&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4001790">elemOp</span><span class="op" id="4001796">,</span>&nbsp;<span class="ident" id="4001798">elemIndir</span>&nbsp;<span class="op" id="4001808">:=</span>&nbsp;<span class="ident" id="4001811">encOpFor</span><span class="op" id="4001819">(</span><span class="ident" id="4001820">t</span><span class="op" id="4001821">.</span><span class="ident" id="4001822">Elem</span><span class="op" id="4001826">(</span><span class="op" id="4001827">)</span><span class="op" id="4001828">,</span>&nbsp;<span class="ident" id="4001830">inProgress</span><span class="op" id="4001840">,</span>&nbsp;<span class="ident" id="4001842">building</span><span class="op" id="4001850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4001855">helper</span>&nbsp;<span class="op" id="4001862">:=</span>&nbsp;<span class="ident" id="4001865">encArrayHelper</span><span class="op" id="4001879">[</span><span class="ident" id="4001880">t</span><span class="op" id="4001881">.</span><span class="ident" id="4001882">Elem</span><span class="op" id="4001886">(</span><span class="op" id="4001887">)</span><span class="op" id="4001888">.</span><span class="ident" id="4001889">Kind</span><span class="op" id="4001893">(</span><span class="op" id="4001894">)</span><span class="op" id="4001895">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4001900">op</span>&nbsp;<span class="op" id="4001903">=</span>&nbsp;<span class="keyword" id="4001905">func</span><span class="op" id="4001909">(</span><span class="ident" id="4001910">i</span>&nbsp;<span class="op" id="4001912">*</span><span class="ident" id="4001913">encInstr</span><span class="op" id="4001921">,</span>&nbsp;<span class="ident" id="4001923">state</span>&nbsp;<span class="op" id="4001929">*</span><span class="ident" id="4001930">encoderState</span><span class="op" id="4001942">,</span>&nbsp;<span class="ident" id="4001944">array</span>&nbsp;<span class="ident" id="4001950">reflect</span><span class="op" id="4001957">.</span><span class="ident" id="4001958">Value</span><span class="op" id="4001963">)</span>&nbsp;<span class="op" id="4001965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4001971">state</span><span class="op" id="4001976">.</span><span class="ident" id="4001977">update</span><span class="op" id="4001983">(</span><span class="ident" id="4001984">i</span><span class="op" id="4001985">)</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4001991">state</span><span class="op" id="4001996">.</span><span class="ident" id="4001997">enc</span><span class="op" id="4002000">.</span><span class="ident" id="4002001">encodeArray</span><span class="op" id="4002012">(</span><span class="ident" id="4002013">state</span><span class="op" id="4002018">.</span><span class="ident" id="4002019">b</span><span class="op" id="4002020">,</span>&nbsp;<span class="ident" id="4002022">array</span><span class="op" id="4002027">,</span>&nbsp;<span class="op" id="4002029">*</span><span class="ident" id="4002030">elemOp</span><span class="op" id="4002036">,</span>&nbsp;<span class="ident" id="4002038">elemIndir</span><span class="op" id="4002047">,</span>&nbsp;<span class="ident" id="4002049">array</span><span class="op" id="4002054">.</span><span class="ident" id="4002055">Len</span><span class="op" id="4002058">(</span><span class="op" id="4002059">)</span><span class="op" id="4002060">,</span>&nbsp;<span class="ident" id="4002062">helper</span><span class="op" id="4002068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4002073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4002077">case</span>&nbsp;<span class="ident" id="4002082">reflect</span><span class="op" id="4002089">.</span><span class="ident" id="4002090">Map</span><span class="op" id="4002093">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4002098">keyOp</span><span class="op" id="4002103">,</span>&nbsp;<span class="ident" id="4002105">keyIndir</span>&nbsp;<span class="op" id="4002114">:=</span>&nbsp;<span class="ident" id="4002117">encOpFor</span><span class="op" id="4002125">(</span><span class="ident" id="4002126">t</span><span class="op" id="4002127">.</span><span class="ident" id="4002128">Key</span><span class="op" id="4002131">(</span><span class="op" id="4002132">)</span><span class="op" id="4002133">,</span>&nbsp;<span class="ident" id="4002135">inProgress</span><span class="op" id="4002145">,</span>&nbsp;<span class="ident" id="4002147">building</span><span class="op" id="4002155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4002160">elemOp</span><span class="op" id="4002166">,</span>&nbsp;<span class="ident" id="4002168">elemIndir</span>&nbsp;<span class="op" id="4002178">:=</span>&nbsp;<span class="ident" id="4002181">encOpFor</span><span class="op" id="4002189">(</span><span class="ident" id="4002190">t</span><span class="op" id="4002191">.</span><span class="ident" id="4002192">Elem</span><span class="op" id="4002196">(</span><span class="op" id="4002197">)</span><span class="op" id="4002198">,</span>&nbsp;<span class="ident" id="4002200">inProgress</span><span class="op" id="4002210">,</span>&nbsp;<span class="ident" id="4002212">building</span><span class="op" id="4002220">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4002225">op</span>&nbsp;<span class="op" id="4002228">=</span>&nbsp;<span class="keyword" id="4002230">func</span><span class="op" id="4002234">(</span><span class="ident" id="4002235">i</span>&nbsp;<span class="op" id="4002237">*</span><span class="ident" id="4002238">encInstr</span><span class="op" id="4002246">,</span>&nbsp;<span class="ident" id="4002248">state</span>&nbsp;<span class="op" id="4002254">*</span><span class="ident" id="4002255">encoderState</span><span class="op" id="4002267">,</span>&nbsp;<span class="ident" id="4002269">mv</span>&nbsp;<span class="ident" id="4002272">reflect</span><span class="op" id="4002279">.</span><span class="ident" id="4002280">Value</span><span class="op" id="4002285">)</span>&nbsp;<span class="op" id="4002287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4002293">//&nbsp;We&nbsp;send&nbsp;zero-length&nbsp;(but&nbsp;non-nil)&nbsp;maps&nbsp;because&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4002351">//&nbsp;receiver&nbsp;might&nbsp;want&nbsp;to&nbsp;use&nbsp;the&nbsp;map.&nbsp;&nbsp;(Maps&nbsp;don&#39;t&nbsp;use&nbsp;append.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4002420">if</span>&nbsp;<span class="op" id="4002423">!</span><span class="ident" id="4002424">state</span><span class="op" id="4002429">.</span><span class="ident" id="4002430">sendZero</span>&nbsp;<span class="op" id="4002439">&amp;&amp;</span>&nbsp;<span class="ident" id="4002442">mv</span><span class="op" id="4002444">.</span><span class="ident" id="4002445">IsNil</span><span class="op" id="4002450">(</span><span class="op" id="4002451">)</span>&nbsp;<span class="op" id="4002453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4002460">return</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4002471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4002477">state</span><span class="op" id="4002482">.</span><span class="ident" id="4002483">update</span><span class="op" id="4002489">(</span><span class="ident" id="4002490">i</span><span class="op" id="4002491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4002497">state</span><span class="op" id="4002502">.</span><span class="ident" id="4002503">enc</span><span class="op" id="4002506">.</span><span class="ident" id="4002507">encodeMap</span><span class="op" id="4002516">(</span><span class="ident" id="4002517">state</span><span class="op" id="4002522">.</span><span class="ident" id="4002523">b</span><span class="op" id="4002524">,</span>&nbsp;<span class="ident" id="4002526">mv</span><span class="op" id="4002528">,</span>&nbsp;<span class="op" id="4002530">*</span><span class="ident" id="4002531">keyOp</span><span class="op" id="4002536">,</span>&nbsp;<span class="op" id="4002538">*</span><span class="ident" id="4002539">elemOp</span><span class="op" id="4002545">,</span>&nbsp;<span class="ident" id="4002547">keyIndir</span><span class="op" id="4002555">,</span>&nbsp;<span class="ident" id="4002557">elemIndir</span><span class="op" id="4002566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4002571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4002575">case</span>&nbsp;<span class="ident" id="4002580">reflect</span><span class="op" id="4002587">.</span><span class="ident" id="4002588">Struct</span><span class="op" id="4002594">:</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4002599">//&nbsp;Generate&nbsp;a&nbsp;closure&nbsp;that&nbsp;calls&nbsp;out&nbsp;to&nbsp;the&nbsp;engine&nbsp;for&nbsp;the&nbsp;nested&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4002674">getEncEngine</span><span class="op" id="4002686">(</span><span class="ident" id="4002687">userType</span><span class="op" id="4002695">(</span><span class="ident" id="4002696">typ</span><span class="op" id="4002699">)</span><span class="op" id="4002700">,</span>&nbsp;<span class="ident" id="4002702">building</span><span class="op" id="4002710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4002715">info</span>&nbsp;<span class="op" id="4002720">:=</span>&nbsp;<span class="ident" id="4002723">mustGetTypeInfo</span><span class="op" id="4002738">(</span><span class="ident" id="4002739">typ</span><span class="op" id="4002742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4002747">op</span>&nbsp;<span class="op" id="4002750">=</span>&nbsp;<span class="keyword" id="4002752">func</span><span class="op" id="4002756">(</span><span class="ident" id="4002757">i</span>&nbsp;<span class="op" id="4002759">*</span><span class="ident" id="4002760">encInstr</span><span class="op" id="4002768">,</span>&nbsp;<span class="ident" id="4002770">state</span>&nbsp;<span class="op" id="4002776">*</span><span class="ident" id="4002777">encoderState</span><span class="op" id="4002789">,</span>&nbsp;<span class="ident" id="4002791">sv</span>&nbsp;<span class="ident" id="4002794">reflect</span><span class="op" id="4002801">.</span><span class="ident" id="4002802">Value</span><span class="op" id="4002807">)</span>&nbsp;<span class="op" id="4002809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4002815">state</span><span class="op" id="4002820">.</span><span class="ident" id="4002821">update</span><span class="op" id="4002827">(</span><span class="ident" id="4002828">i</span><span class="op" id="4002829">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4002835">//&nbsp;indirect&nbsp;through&nbsp;info&nbsp;to&nbsp;delay&nbsp;evaluation&nbsp;for&nbsp;recursive&nbsp;structs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4002906">enc</span>&nbsp;<span class="op" id="4002910">:=</span>&nbsp;<span class="ident" id="4002913">info</span><span class="op" id="4002917">.</span><span class="ident" id="4002918">encoder</span><span class="op" id="4002925">.</span><span class="ident" id="4002926">Load</span><span class="op" id="4002930">(</span><span class="op" id="4002931">)</span><span class="op" id="4002932">.</span><span class="op" id="4002933">(</span><span class="op" id="4002934">*</span><span class="ident" id="4002935">encEngine</span><span class="op" id="4002944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4002950">state</span><span class="op" id="4002955">.</span><span class="ident" id="4002956">enc</span><span class="op" id="4002959">.</span><span class="ident" id="4002960">encodeStruct</span><span class="op" id="4002972">(</span><span class="ident" id="4002973">state</span><span class="op" id="4002978">.</span><span class="ident" id="4002979">b</span><span class="op" id="4002980">,</span>&nbsp;<span class="ident" id="4002982">enc</span><span class="op" id="4002985">,</span>&nbsp;<span class="ident" id="4002987">sv</span><span class="op" id="4002989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4002994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4002998">case</span>&nbsp;<span class="ident" id="4003003">reflect</span><span class="op" id="4003010">.</span><span class="ident" id="4003011">Interface</span><span class="op" id="4003020">:</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4003025">op</span>&nbsp;<span class="op" id="4003028">=</span>&nbsp;<span class="keyword" id="4003030">func</span><span class="op" id="4003034">(</span><span class="ident" id="4003035">i</span>&nbsp;<span class="op" id="4003037">*</span><span class="ident" id="4003038">encInstr</span><span class="op" id="4003046">,</span>&nbsp;<span class="ident" id="4003048">state</span>&nbsp;<span class="op" id="4003054">*</span><span class="ident" id="4003055">encoderState</span><span class="op" id="4003067">,</span>&nbsp;<span class="ident" id="4003069">iv</span>&nbsp;<span class="ident" id="4003072">reflect</span><span class="op" id="4003079">.</span><span class="ident" id="4003080">Value</span><span class="op" id="4003085">)</span>&nbsp;<span class="op" id="4003087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4003093">if</span>&nbsp;<span class="op" id="4003096">!</span><span class="ident" id="4003097">state</span><span class="op" id="4003102">.</span><span class="ident" id="4003103">sendZero</span>&nbsp;<span class="op" id="4003112">&amp;&amp;</span>&nbsp;<span class="op" id="4003115">(</span><span class="op" id="4003116">!</span><span class="ident" id="4003117">iv</span><span class="op" id="4003119">.</span><span class="ident" id="4003120">IsValid</span><span class="op" id="4003127">(</span><span class="op" id="4003128">)</span>&nbsp;<span class="op" id="4003130">||</span>&nbsp;<span class="ident" id="4003133">iv</span><span class="op" id="4003135">.</span><span class="ident" id="4003136">IsNil</span><span class="op" id="4003141">(</span><span class="op" id="4003142">)</span><span class="op" id="4003143">)</span>&nbsp;<span class="op" id="4003145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4003152">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4003163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4003169">state</span><span class="op" id="4003174">.</span><span class="ident" id="4003175">update</span><span class="op" id="4003181">(</span><span class="ident" id="4003182">i</span><span class="op" id="4003183">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4003189">state</span><span class="op" id="4003194">.</span><span class="ident" id="4003195">enc</span><span class="op" id="4003198">.</span><span class="ident" id="4003199">encodeInterface</span><span class="op" id="4003214">(</span><span class="ident" id="4003215">state</span><span class="op" id="4003220">.</span><span class="ident" id="4003221">b</span><span class="op" id="4003222">,</span>&nbsp;<span class="ident" id="4003224">iv</span><span class="op" id="4003226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4003231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4003235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4003238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4003241">if</span>&nbsp;<span class="ident" id="4003244">op</span>&nbsp;<span class="op" id="4003247">==</span>&nbsp;<span class="ident" id="4003250">nil</span>&nbsp;<span class="op" id="4003254">{</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4003258">errorf</span><span class="op" id="4003264">(</span><span class="string" id="4003265">&#34;can&#39;t&nbsp;happen:&nbsp;encode&nbsp;type&nbsp;%s&#34;</span><span class="op" id="4003295">,</span>&nbsp;<span class="ident" id="4003297">rt</span><span class="op" id="4003299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4003302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4003305">return</span>&nbsp;<span class="op" id="4003312">&amp;</span><span class="ident" id="4003313">op</span><span class="op" id="4003315">,</span>&nbsp;<span class="ident" id="4003317">indir</span><br>
<span class="lineno"></span><span class="op" id="4003323">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span><span class="comment" id="4003326">//&nbsp;gobEncodeOpFor&nbsp;returns&nbsp;the&nbsp;op&nbsp;for&nbsp;a&nbsp;type&nbsp;that&nbsp;is&nbsp;known&nbsp;to&nbsp;implement&nbsp;GobEncoder.</span><br>
<span class="lineno"></span><span class="keyword" id="4003409">func</span>&nbsp;<span class="ident" id="4003414">gobEncodeOpFor</span><span class="op" id="4003428">(</span><span class="ident" id="4003429">ut</span>&nbsp;<span class="op" id="4003432">*</span><span class="ident" id="4003433">userTypeInfo</span><span class="op" id="4003445">)</span>&nbsp;<span class="op" id="4003447">(</span><span class="op" id="4003448">*</span><span class="ident" id="4003449">encOp</span><span class="op" id="4003454">,</span>&nbsp;<span class="builtintype" id="4003456">int</span><span class="op" id="4003459">)</span>&nbsp;<span class="op" id="4003461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4003464">rt</span>&nbsp;<span class="op" id="4003467">:=</span>&nbsp;<span class="ident" id="4003470">ut</span><span class="op" id="4003472">.</span><span class="ident" id="4003473">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4003479">if</span>&nbsp;<span class="ident" id="4003482">ut</span><span class="op" id="4003484">.</span><span class="ident" id="4003485">encIndir</span>&nbsp;<span class="op" id="4003494">==</span>&nbsp;<span class="op" id="4003497">-</span><span class="num" id="4003498">1</span>&nbsp;<span class="op" id="4003500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4003504">rt</span>&nbsp;<span class="op" id="4003507">=</span>&nbsp;<span class="ident" id="4003509">reflect</span><span class="op" id="4003516">.</span><span class="ident" id="4003517">PtrTo</span><span class="op" id="4003522">(</span><span class="ident" id="4003523">rt</span><span class="op" id="4003525">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4003528">}</span>&nbsp;<span class="keyword" id="4003530">else</span>&nbsp;<span class="keyword" id="4003535">if</span>&nbsp;<span class="ident" id="4003538">ut</span><span class="op" id="4003540">.</span><span class="ident" id="4003541">encIndir</span>&nbsp;<span class="op" id="4003550">&gt;</span>&nbsp;<span class="num" id="4003552">0</span>&nbsp;<span class="op" id="4003554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4003558">for</span>&nbsp;<span class="ident" id="4003562">i</span>&nbsp;<span class="op" id="4003564">:=</span>&nbsp;<span class="builtintype" id="4003567">int8</span><span class="op" id="4003571">(</span><span class="num" id="4003572">0</span><span class="op" id="4003573">)</span><span class="op" id="4003574">;</span>&nbsp;<span class="ident" id="4003576">i</span>&nbsp;<span class="op" id="4003578">&lt;</span>&nbsp;<span class="ident" id="4003580">ut</span><span class="op" id="4003582">.</span><span class="ident" id="4003583">encIndir</span><span class="op" id="4003591">;</span>&nbsp;<span class="ident" id="4003593">i</span><span class="op" id="4003594">++</span>&nbsp;<span class="op" id="4003597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4003602">rt</span>&nbsp;<span class="op" id="4003605">=</span>&nbsp;<span class="ident" id="4003607">rt</span><span class="op" id="4003609">.</span><span class="ident" id="4003610">Elem</span><span class="op" id="4003614">(</span><span class="op" id="4003615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4003619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4003622">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4003625">var</span>&nbsp;<span class="ident" id="4003629">op</span>&nbsp;<span class="ident" id="4003632">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4003639">op</span>&nbsp;<span class="op" id="4003642">=</span>&nbsp;<span class="keyword" id="4003644">func</span><span class="op" id="4003648">(</span><span class="ident" id="4003649">i</span>&nbsp;<span class="op" id="4003651">*</span><span class="ident" id="4003652">encInstr</span><span class="op" id="4003660">,</span>&nbsp;<span class="ident" id="4003662">state</span>&nbsp;<span class="op" id="4003668">*</span><span class="ident" id="4003669">encoderState</span><span class="op" id="4003681">,</span>&nbsp;<span class="ident" id="4003683">v</span>&nbsp;<span class="ident" id="4003685">reflect</span><span class="op" id="4003692">.</span><span class="ident" id="4003693">Value</span><span class="op" id="4003698">)</span>&nbsp;<span class="op" id="4003700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4003704">if</span>&nbsp;<span class="ident" id="4003707">ut</span><span class="op" id="4003709">.</span><span class="ident" id="4003710">encIndir</span>&nbsp;<span class="op" id="4003719">==</span>&nbsp;<span class="op" id="4003722">-</span><span class="num" id="4003723">1</span>&nbsp;<span class="op" id="4003725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4003730">//&nbsp;Need&nbsp;to&nbsp;climb&nbsp;up&nbsp;one&nbsp;level&nbsp;to&nbsp;turn&nbsp;value&nbsp;into&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4003791">if</span>&nbsp;<span class="op" id="4003794">!</span><span class="ident" id="4003795">v</span><span class="op" id="4003796">.</span><span class="ident" id="4003797">CanAddr</span><span class="op" id="4003804">(</span><span class="op" id="4003805">)</span>&nbsp;<span class="op" id="4003807">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4003813">errorf</span><span class="op" id="4003819">(</span><span class="string" id="4003820">&#34;unaddressable&nbsp;value&nbsp;of&nbsp;type&nbsp;%s&#34;</span><span class="op" id="4003852">,</span>&nbsp;<span class="ident" id="4003854">rt</span><span class="op" id="4003856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4003861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4003866">v</span>&nbsp;<span class="op" id="4003868">=</span>&nbsp;<span class="ident" id="4003870">v</span><span class="op" id="4003871">.</span><span class="ident" id="4003872">Addr</span><span class="op" id="4003876">(</span><span class="op" id="4003877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4003881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4003885">if</span>&nbsp;<span class="op" id="4003888">!</span><span class="ident" id="4003889">state</span><span class="op" id="4003894">.</span><span class="ident" id="4003895">sendZero</span>&nbsp;<span class="op" id="4003904">&amp;&amp;</span>&nbsp;<span class="ident" id="4003907">isZero</span><span class="op" id="4003913">(</span><span class="ident" id="4003914">v</span><span class="op" id="4003915">)</span>&nbsp;<span class="op" id="4003917">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4003922">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4003931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4003935">state</span><span class="op" id="4003940">.</span><span class="ident" id="4003941">update</span><span class="op" id="4003947">(</span><span class="ident" id="4003948">i</span><span class="op" id="4003949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4003953">state</span><span class="op" id="4003958">.</span><span class="ident" id="4003959">enc</span><span class="op" id="4003962">.</span><span class="ident" id="4003963">encodeGobEncoder</span><span class="op" id="4003979">(</span><span class="ident" id="4003980">state</span><span class="op" id="4003985">.</span><span class="ident" id="4003986">b</span><span class="op" id="4003987">,</span>&nbsp;<span class="ident" id="4003989">ut</span><span class="op" id="4003991">,</span>&nbsp;<span class="ident" id="4003993">v</span><span class="op" id="4003994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4003997">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4004000">return</span>&nbsp;<span class="op" id="4004007">&amp;</span><span class="ident" id="4004008">op</span><span class="op" id="4004010">,</span>&nbsp;<span class="builtintype" id="4004012">int</span><span class="op" id="4004015">(</span><span class="ident" id="4004016">ut</span><span class="op" id="4004018">.</span><span class="ident" id="4004019">encIndir</span><span class="op" id="4004027">)</span>&nbsp;<span class="comment" id="4004029">//&nbsp;encIndir:&nbsp;op&nbsp;will&nbsp;get&nbsp;called&nbsp;with&nbsp;p&nbsp;==&nbsp;address&nbsp;of&nbsp;receiver.</span><br>
<span class="lineno"></span><span class="op" id="4004092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4004095">//&nbsp;compileEnc&nbsp;returns&nbsp;the&nbsp;engine&nbsp;to&nbsp;compile&nbsp;the&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="4004149">func</span>&nbsp;<span class="ident" id="4004154">compileEnc</span><span class="op" id="4004164">(</span><span class="ident" id="4004165">ut</span>&nbsp;<span class="op" id="4004168">*</span><span class="ident" id="4004169">userTypeInfo</span><span class="op" id="4004181">,</span>&nbsp;<span class="ident" id="4004183">building</span>&nbsp;<span class="keyword" id="4004192">map</span><span class="op" id="4004195">[</span><span class="op" id="4004196">*</span><span class="ident" id="4004197">typeInfo</span><span class="op" id="4004205">]</span><span class="builtintype" id="4004206">bool</span><span class="op" id="4004210">)</span>&nbsp;<span class="op" id="4004212">*</span><span class="ident" id="4004213">encEngine</span>&nbsp;<span class="op" id="4004223">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4004226">srt</span>&nbsp;<span class="op" id="4004230">:=</span>&nbsp;<span class="ident" id="4004233">ut</span><span class="op" id="4004235">.</span><span class="ident" id="4004236">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4004242">engine</span>&nbsp;<span class="op" id="4004249">:=</span>&nbsp;<span class="builtinfunc" id="4004252">new</span><span class="op" id="4004255">(</span><span class="ident" id="4004256">encEngine</span><span class="op" id="4004265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4004268">seen</span>&nbsp;<span class="op" id="4004273">:=</span>&nbsp;<span class="builtinfunc" id="4004276">make</span><span class="op" id="4004280">(</span><span class="keyword" id="4004281">map</span><span class="op" id="4004284">[</span><span class="ident" id="4004285">reflect</span><span class="op" id="4004292">.</span><span class="ident" id="4004293">Type</span><span class="op" id="4004297">]</span><span class="op" id="4004298">*</span><span class="ident" id="4004299">encOp</span><span class="op" id="4004304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4004307">rt</span>&nbsp;<span class="op" id="4004310">:=</span>&nbsp;<span class="ident" id="4004313">ut</span><span class="op" id="4004315">.</span><span class="ident" id="4004316">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4004322">if</span>&nbsp;<span class="ident" id="4004325">ut</span><span class="op" id="4004327">.</span><span class="ident" id="4004328">externalEnc</span>&nbsp;<span class="op" id="4004340">!=</span>&nbsp;<span class="num" id="4004343">0</span>&nbsp;<span class="op" id="4004345">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4004349">rt</span>&nbsp;<span class="op" id="4004352">=</span>&nbsp;<span class="ident" id="4004354">ut</span><span class="op" id="4004356">.</span><span class="ident" id="4004357">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4004363">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4004366">if</span>&nbsp;<span class="ident" id="4004369">ut</span><span class="op" id="4004371">.</span><span class="ident" id="4004372">externalEnc</span>&nbsp;<span class="op" id="4004384">==</span>&nbsp;<span class="num" id="4004387">0</span>&nbsp;<span class="op" id="4004389">&amp;&amp;</span>&nbsp;<span class="ident" id="4004392">srt</span><span class="op" id="4004395">.</span><span class="ident" id="4004396">Kind</span><span class="op" id="4004400">(</span><span class="op" id="4004401">)</span>&nbsp;<span class="op" id="4004403">==</span>&nbsp;<span class="ident" id="4004406">reflect</span><span class="op" id="4004413">.</span><span class="ident" id="4004414">Struct</span>&nbsp;<span class="op" id="4004421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4004425">for</span>&nbsp;<span class="ident" id="4004429">fieldNum</span><span class="op" id="4004437">,</span>&nbsp;<span class="ident" id="4004439">wireFieldNum</span>&nbsp;<span class="op" id="4004452">:=</span>&nbsp;<span class="num" id="4004455">0</span><span class="op" id="4004456">,</span>&nbsp;<span class="num" id="4004458">0</span><span class="op" id="4004459">;</span>&nbsp;<span class="ident" id="4004461">fieldNum</span>&nbsp;<span class="op" id="4004470">&lt;</span>&nbsp;<span class="ident" id="4004472">srt</span><span class="op" id="4004475">.</span><span class="ident" id="4004476">NumField</span><span class="op" id="4004484">(</span><span class="op" id="4004485">)</span><span class="op" id="4004486">;</span>&nbsp;<span class="ident" id="4004488">fieldNum</span><span class="op" id="4004496">++</span>&nbsp;<span class="op" id="4004499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4004504">f</span>&nbsp;<span class="op" id="4004506">:=</span>&nbsp;<span class="ident" id="4004509">srt</span><span class="op" id="4004512">.</span><span class="ident" id="4004513">Field</span><span class="op" id="4004518">(</span><span class="ident" id="4004519">fieldNum</span><span class="op" id="4004527">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4004532">if</span>&nbsp;<span class="op" id="4004535">!</span><span class="ident" id="4004536">isSent</span><span class="op" id="4004542">(</span><span class="op" id="4004543">&amp;</span><span class="ident" id="4004544">f</span><span class="op" id="4004545">)</span>&nbsp;<span class="op" id="4004547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4004553">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4004565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4004570">op</span><span class="op" id="4004572">,</span>&nbsp;<span class="ident" id="4004574">indir</span>&nbsp;<span class="op" id="4004580">:=</span>&nbsp;<span class="ident" id="4004583">encOpFor</span><span class="op" id="4004591">(</span><span class="ident" id="4004592">f</span><span class="op" id="4004593">.</span><span class="ident" id="4004594">Type</span><span class="op" id="4004598">,</span>&nbsp;<span class="ident" id="4004600">seen</span><span class="op" id="4004604">,</span>&nbsp;<span class="ident" id="4004606">building</span><span class="op" id="4004614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4004619">engine</span><span class="op" id="4004625">.</span><span class="ident" id="4004626">instr</span>&nbsp;<span class="op" id="4004632">=</span>&nbsp;<span class="builtinfunc" id="4004634">append</span><span class="op" id="4004640">(</span><span class="ident" id="4004641">engine</span><span class="op" id="4004647">.</span><span class="ident" id="4004648">instr</span><span class="op" id="4004653">,</span>&nbsp;<span class="ident" id="4004655">encInstr</span><span class="op" id="4004663">{</span><span class="op" id="4004664">*</span><span class="ident" id="4004665">op</span><span class="op" id="4004667">,</span>&nbsp;<span class="ident" id="4004669">wireFieldNum</span><span class="op" id="4004681">,</span>&nbsp;<span class="ident" id="4004683">f</span><span class="op" id="4004684">.</span><span class="ident" id="4004685">Index</span><span class="op" id="4004690">,</span>&nbsp;<span class="ident" id="4004692">indir</span><span class="op" id="4004697">}</span><span class="op" id="4004698">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4004703">wireFieldNum</span><span class="op" id="4004715">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4004720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4004724">if</span>&nbsp;<span class="ident" id="4004727">srt</span><span class="op" id="4004730">.</span><span class="ident" id="4004731">NumField</span><span class="op" id="4004739">(</span><span class="op" id="4004740">)</span>&nbsp;<span class="op" id="4004742">&gt;</span>&nbsp;<span class="num" id="4004744">0</span>&nbsp;<span class="op" id="4004746">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4004749">len</span><span class="op" id="4004752">(</span><span class="ident" id="4004753">engine</span><span class="op" id="4004759">.</span><span class="ident" id="4004760">instr</span><span class="op" id="4004765">)</span>&nbsp;<span class="op" id="4004767">==</span>&nbsp;<span class="num" id="4004770">0</span>&nbsp;<span class="op" id="4004772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4004777">errorf</span><span class="op" id="4004783">(</span><span class="string" id="4004784">&#34;type&nbsp;%s&nbsp;has&nbsp;no&nbsp;exported&nbsp;fields&#34;</span><span class="op" id="4004816">,</span>&nbsp;<span class="ident" id="4004818">rt</span><span class="op" id="4004820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4004824">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4004828">engine</span><span class="op" id="4004834">.</span><span class="ident" id="4004835">instr</span>&nbsp;<span class="op" id="4004841">=</span>&nbsp;<span class="builtinfunc" id="4004843">append</span><span class="op" id="4004849">(</span><span class="ident" id="4004850">engine</span><span class="op" id="4004856">.</span><span class="ident" id="4004857">instr</span><span class="op" id="4004862">,</span>&nbsp;<span class="ident" id="4004864">encInstr</span><span class="op" id="4004872">{</span><span class="ident" id="4004873">encStructTerminator</span><span class="op" id="4004892">,</span>&nbsp;<span class="num" id="4004894">0</span><span class="op" id="4004895">,</span>&nbsp;<span class="ident" id="4004897">nil</span><span class="op" id="4004900">,</span>&nbsp;<span class="num" id="4004902">0</span><span class="op" id="4004903">}</span><span class="op" id="4004904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4004907">}</span>&nbsp;<span class="keyword" id="4004909">else</span>&nbsp;<span class="op" id="4004914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4004918">engine</span><span class="op" id="4004924">.</span><span class="ident" id="4004925">instr</span>&nbsp;<span class="op" id="4004931">=</span>&nbsp;<span class="builtinfunc" id="4004933">make</span><span class="op" id="4004937">(</span><span class="op" id="4004938">[</span><span class="op" id="4004939">]</span><span class="ident" id="4004940">encInstr</span><span class="op" id="4004948">,</span>&nbsp;<span class="num" id="4004950">1</span><span class="op" id="4004951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4004955">op</span><span class="op" id="4004957">,</span>&nbsp;<span class="ident" id="4004959">indir</span>&nbsp;<span class="op" id="4004965">:=</span>&nbsp;<span class="ident" id="4004968">encOpFor</span><span class="op" id="4004976">(</span><span class="ident" id="4004977">rt</span><span class="op" id="4004979">,</span>&nbsp;<span class="ident" id="4004981">seen</span><span class="op" id="4004985">,</span>&nbsp;<span class="ident" id="4004987">building</span><span class="op" id="4004995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4004999">engine</span><span class="op" id="4005005">.</span><span class="ident" id="4005006">instr</span><span class="op" id="4005011">[</span><span class="num" id="4005012">0</span><span class="op" id="4005013">]</span>&nbsp;<span class="op" id="4005015">=</span>&nbsp;<span class="ident" id="4005017">encInstr</span><span class="op" id="4005025">{</span><span class="op" id="4005026">*</span><span class="ident" id="4005027">op</span><span class="op" id="4005029">,</span>&nbsp;<span class="ident" id="4005031">singletonField</span><span class="op" id="4005045">,</span>&nbsp;<span class="ident" id="4005047">nil</span><span class="op" id="4005050">,</span>&nbsp;<span class="ident" id="4005052">indir</span><span class="op" id="4005057">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4005060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4005063">return</span>&nbsp;<span class="ident" id="4005070">engine</span><br>
<span class="lineno"></span><span class="op" id="4005077">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4005080">//&nbsp;getEncEngine&nbsp;returns&nbsp;the&nbsp;engine&nbsp;to&nbsp;compile&nbsp;the&nbsp;type.</span><br>
<span class="lineno">650</span><span class="keyword" id="4005136">func</span>&nbsp;<span class="ident" id="4005141">getEncEngine</span><span class="op" id="4005153">(</span><span class="ident" id="4005154">ut</span>&nbsp;<span class="op" id="4005157">*</span><span class="ident" id="4005158">userTypeInfo</span><span class="op" id="4005170">,</span>&nbsp;<span class="ident" id="4005172">building</span>&nbsp;<span class="keyword" id="4005181">map</span><span class="op" id="4005184">[</span><span class="op" id="4005185">*</span><span class="ident" id="4005186">typeInfo</span><span class="op" id="4005194">]</span><span class="builtintype" id="4005195">bool</span><span class="op" id="4005199">)</span>&nbsp;<span class="op" id="4005201">*</span><span class="ident" id="4005202">encEngine</span>&nbsp;<span class="op" id="4005212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4005215">info</span><span class="op" id="4005219">,</span>&nbsp;<span class="ident" id="4005221">err</span>&nbsp;<span class="op" id="4005225">:=</span>&nbsp;<span class="ident" id="4005228">getTypeInfo</span><span class="op" id="4005239">(</span><span class="ident" id="4005240">ut</span><span class="op" id="4005242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4005245">if</span>&nbsp;<span class="ident" id="4005248">err</span>&nbsp;<span class="op" id="4005252">!=</span>&nbsp;<span class="ident" id="4005255">nil</span>&nbsp;<span class="op" id="4005259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4005263">error_</span><span class="op" id="4005269">(</span><span class="ident" id="4005270">err</span><span class="op" id="4005273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4005276">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4005279">enc</span><span class="op" id="4005282">,</span>&nbsp;<span class="ident" id="4005284">ok</span>&nbsp;<span class="op" id="4005287">:=</span>&nbsp;<span class="ident" id="4005290">info</span><span class="op" id="4005294">.</span><span class="ident" id="4005295">encoder</span><span class="op" id="4005302">.</span><span class="ident" id="4005303">Load</span><span class="op" id="4005307">(</span><span class="op" id="4005308">)</span><span class="op" id="4005309">.</span><span class="op" id="4005310">(</span><span class="op" id="4005311">*</span><span class="ident" id="4005312">encEngine</span><span class="op" id="4005321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4005324">if</span>&nbsp;<span class="op" id="4005327">!</span><span class="ident" id="4005328">ok</span>&nbsp;<span class="op" id="4005331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4005335">enc</span>&nbsp;<span class="op" id="4005339">=</span>&nbsp;<span class="ident" id="4005341">buildEncEngine</span><span class="op" id="4005355">(</span><span class="ident" id="4005356">info</span><span class="op" id="4005360">,</span>&nbsp;<span class="ident" id="4005362">ut</span><span class="op" id="4005364">,</span>&nbsp;<span class="ident" id="4005366">building</span><span class="op" id="4005374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4005377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4005380">return</span>&nbsp;<span class="ident" id="4005387">enc</span><br>
<span class="lineno">660</span><span class="op" id="4005391">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4005394">func</span>&nbsp;<span class="ident" id="4005399">buildEncEngine</span><span class="op" id="4005413">(</span><span class="ident" id="4005414">info</span>&nbsp;<span class="op" id="4005419">*</span><span class="ident" id="4005420">typeInfo</span><span class="op" id="4005428">,</span>&nbsp;<span class="ident" id="4005430">ut</span>&nbsp;<span class="op" id="4005433">*</span><span class="ident" id="4005434">userTypeInfo</span><span class="op" id="4005446">,</span>&nbsp;<span class="ident" id="4005448">building</span>&nbsp;<span class="keyword" id="4005457">map</span><span class="op" id="4005460">[</span><span class="op" id="4005461">*</span><span class="ident" id="4005462">typeInfo</span><span class="op" id="4005470">]</span><span class="builtintype" id="4005471">bool</span><span class="op" id="4005475">)</span>&nbsp;<span class="op" id="4005477">*</span><span class="ident" id="4005478">encEngine</span>&nbsp;<span class="op" id="4005488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4005491">//&nbsp;Check&nbsp;for&nbsp;recursive&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4005522">if</span>&nbsp;<span class="ident" id="4005525">building</span>&nbsp;<span class="op" id="4005534">!=</span>&nbsp;<span class="ident" id="4005537">nil</span>&nbsp;<span class="op" id="4005541">&amp;&amp;</span>&nbsp;<span class="ident" id="4005544">building</span><span class="op" id="4005552">[</span><span class="ident" id="4005553">info</span><span class="op" id="4005557">]</span>&nbsp;<span class="op" id="4005559">{</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4005563">return</span>&nbsp;<span class="ident" id="4005570">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4005575">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4005578">info</span><span class="op" id="4005582">.</span><span class="ident" id="4005583">encInit</span><span class="op" id="4005590">.</span><span class="ident" id="4005591">Lock</span><span class="op" id="4005595">(</span><span class="op" id="4005596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4005599">defer</span>&nbsp;<span class="ident" id="4005605">info</span><span class="op" id="4005609">.</span><span class="ident" id="4005610">encInit</span><span class="op" id="4005617">.</span><span class="ident" id="4005618">Unlock</span><span class="op" id="4005624">(</span><span class="op" id="4005625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4005628">enc</span><span class="op" id="4005631">,</span>&nbsp;<span class="ident" id="4005633">ok</span>&nbsp;<span class="op" id="4005636">:=</span>&nbsp;<span class="ident" id="4005639">info</span><span class="op" id="4005643">.</span><span class="ident" id="4005644">encoder</span><span class="op" id="4005651">.</span><span class="ident" id="4005652">Load</span><span class="op" id="4005656">(</span><span class="op" id="4005657">)</span><span class="op" id="4005658">.</span><span class="op" id="4005659">(</span><span class="op" id="4005660">*</span><span class="ident" id="4005661">encEngine</span><span class="op" id="4005670">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4005673">if</span>&nbsp;<span class="op" id="4005676">!</span><span class="ident" id="4005677">ok</span>&nbsp;<span class="op" id="4005680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4005684">if</span>&nbsp;<span class="ident" id="4005687">building</span>&nbsp;<span class="op" id="4005696">==</span>&nbsp;<span class="ident" id="4005699">nil</span>&nbsp;<span class="op" id="4005703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4005708">building</span>&nbsp;<span class="op" id="4005717">=</span>&nbsp;<span class="builtinfunc" id="4005719">make</span><span class="op" id="4005723">(</span><span class="keyword" id="4005724">map</span><span class="op" id="4005727">[</span><span class="op" id="4005728">*</span><span class="ident" id="4005729">typeInfo</span><span class="op" id="4005737">]</span><span class="builtintype" id="4005738">bool</span><span class="op" id="4005742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4005746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4005750">building</span><span class="op" id="4005758">[</span><span class="ident" id="4005759">info</span><span class="op" id="4005763">]</span>&nbsp;<span class="op" id="4005765">=</span>&nbsp;<span class="builtintype" id="4005767">true</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4005774">enc</span>&nbsp;<span class="op" id="4005778">=</span>&nbsp;<span class="ident" id="4005780">compileEnc</span><span class="op" id="4005790">(</span><span class="ident" id="4005791">ut</span><span class="op" id="4005793">,</span>&nbsp;<span class="ident" id="4005795">building</span><span class="op" id="4005803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4005807">info</span><span class="op" id="4005811">.</span><span class="ident" id="4005812">encoder</span><span class="op" id="4005819">.</span><span class="ident" id="4005820">Store</span><span class="op" id="4005825">(</span><span class="ident" id="4005826">enc</span><span class="op" id="4005829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4005832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4005835">return</span>&nbsp;<span class="ident" id="4005842">enc</span><br>
<span class="lineno"></span><span class="op" id="4005846">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="4005849">func</span>&nbsp;<span class="op" id="4005854">(</span><span class="ident" id="4005855">enc</span>&nbsp;<span class="op" id="4005859">*</span><span class="ident" id="4005860">Encoder</span><span class="op" id="4005867">)</span>&nbsp;<span class="ident" id="4005869">encode</span><span class="op" id="4005875">(</span><span class="ident" id="4005876">b</span>&nbsp;<span class="op" id="4005878">*</span><span class="ident" id="4005879">encBuffer</span><span class="op" id="4005888">,</span>&nbsp;<span class="ident" id="4005890">value</span>&nbsp;<span class="ident" id="4005896">reflect</span><span class="op" id="4005903">.</span><span class="ident" id="4005904">Value</span><span class="op" id="4005909">,</span>&nbsp;<span class="ident" id="4005911">ut</span>&nbsp;<span class="op" id="4005914">*</span><span class="ident" id="4005915">userTypeInfo</span><span class="op" id="4005927">)</span>&nbsp;<span class="op" id="4005929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4005932">defer</span>&nbsp;<span class="ident" id="4005938">catchError</span><span class="op" id="4005948">(</span><span class="op" id="4005949">&amp;</span><span class="ident" id="4005950">enc</span><span class="op" id="4005953">.</span><span class="ident" id="4005954">err</span><span class="op" id="4005957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4005960">engine</span>&nbsp;<span class="op" id="4005967">:=</span>&nbsp;<span class="ident" id="4005970">getEncEngine</span><span class="op" id="4005982">(</span><span class="ident" id="4005983">ut</span><span class="op" id="4005985">,</span>&nbsp;<span class="ident" id="4005987">nil</span><span class="op" id="4005990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4005993">indir</span>&nbsp;<span class="op" id="4005999">:=</span>&nbsp;<span class="ident" id="4006002">ut</span><span class="op" id="4006004">.</span><span class="ident" id="4006005">indir</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4006012">if</span>&nbsp;<span class="ident" id="4006015">ut</span><span class="op" id="4006017">.</span><span class="ident" id="4006018">externalEnc</span>&nbsp;<span class="op" id="4006030">!=</span>&nbsp;<span class="num" id="4006033">0</span>&nbsp;<span class="op" id="4006035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4006039">indir</span>&nbsp;<span class="op" id="4006045">=</span>&nbsp;<span class="builtintype" id="4006047">int</span><span class="op" id="4006050">(</span><span class="ident" id="4006051">ut</span><span class="op" id="4006053">.</span><span class="ident" id="4006054">encIndir</span><span class="op" id="4006062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4006065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4006068">for</span>&nbsp;<span class="ident" id="4006072">i</span>&nbsp;<span class="op" id="4006074">:=</span>&nbsp;<span class="num" id="4006077">0</span><span class="op" id="4006078">;</span>&nbsp;<span class="ident" id="4006080">i</span>&nbsp;<span class="op" id="4006082">&lt;</span>&nbsp;<span class="ident" id="4006084">indir</span><span class="op" id="4006089">;</span>&nbsp;<span class="ident" id="4006091">i</span><span class="op" id="4006092">++</span>&nbsp;<span class="op" id="4006095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4006099">value</span>&nbsp;<span class="op" id="4006105">=</span>&nbsp;<span class="ident" id="4006107">reflect</span><span class="op" id="4006114">.</span><span class="ident" id="4006115">Indirect</span><span class="op" id="4006123">(</span><span class="ident" id="4006124">value</span><span class="op" id="4006129">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4006132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4006135">if</span>&nbsp;<span class="ident" id="4006138">ut</span><span class="op" id="4006140">.</span><span class="ident" id="4006141">externalEnc</span>&nbsp;<span class="op" id="4006153">==</span>&nbsp;<span class="num" id="4006156">0</span>&nbsp;<span class="op" id="4006158">&amp;&amp;</span>&nbsp;<span class="ident" id="4006161">value</span><span class="op" id="4006166">.</span><span class="ident" id="4006167">Type</span><span class="op" id="4006171">(</span><span class="op" id="4006172">)</span><span class="op" id="4006173">.</span><span class="ident" id="4006174">Kind</span><span class="op" id="4006178">(</span><span class="op" id="4006179">)</span>&nbsp;<span class="op" id="4006181">==</span>&nbsp;<span class="ident" id="4006184">reflect</span><span class="op" id="4006191">.</span><span class="ident" id="4006192">Struct</span>&nbsp;<span class="op" id="4006199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4006203">enc</span><span class="op" id="4006206">.</span><span class="ident" id="4006207">encodeStruct</span><span class="op" id="4006219">(</span><span class="ident" id="4006220">b</span><span class="op" id="4006221">,</span>&nbsp;<span class="ident" id="4006223">engine</span><span class="op" id="4006229">,</span>&nbsp;<span class="ident" id="4006231">value</span><span class="op" id="4006236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4006239">}</span>&nbsp;<span class="keyword" id="4006241">else</span>&nbsp;<span class="op" id="4006246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4006250">enc</span><span class="op" id="4006253">.</span><span class="ident" id="4006254">encodeSingle</span><span class="op" id="4006266">(</span><span class="ident" id="4006267">b</span><span class="op" id="4006268">,</span>&nbsp;<span class="ident" id="4006270">engine</span><span class="op" id="4006276">,</span>&nbsp;<span class="ident" id="4006278">value</span><span class="op" id="4006283">)</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4006286">}</span><br>
<span class="lineno"></span><span class="op" id="4006288">}</span>
</div>
</body>
</html>
