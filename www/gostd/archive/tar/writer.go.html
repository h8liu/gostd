<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>archive/tar</h2>
<ul>
<li><a href="/gostd/archive/tar/common.go.html">common.go</a></li>
<li><a href="/gostd/archive/tar/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/archive/tar/reader.go.html">reader.go</a></li>
<li><a href="/gostd/archive/tar/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/archive/tar/stat_atim.go.html">stat_atim.go</a></li>
<li><a href="/gostd/archive/tar/stat_unix.go.html">stat_unix.go</a></li>
<li><a href="/gostd/archive/tar/tar_test.go.html">tar_test.go</a></li>
<li><a href="/gostd/archive/tar/writer.go.html" class="current">writer.go</a></li>
<li><a href="/gostd/archive/tar/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6008177">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6008232">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6008286">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6008337">package</span>&nbsp;<span class="ident" id="6008345">tar</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6008350">//&nbsp;TODO(dsymonds):</span><br>
<span class="lineno"></span><span class="comment" id="6008369">//&nbsp;-&nbsp;catch&nbsp;more&nbsp;errors&nbsp;(no&nbsp;first&nbsp;header,&nbsp;etc.)</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="6008417">import</span>&nbsp;<span class="op" id="6008424">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6008427">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6008436">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6008446">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6008453">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6008459">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6008465">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6008473">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6008484">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6008495">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="6008502">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6008505">var</span>&nbsp;<span class="op" id="6008509">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6008512">ErrWriteTooLong</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6008531">=</span>&nbsp;<span class="ident" id="6008533">errors</span><span class="op" id="6008539">.</span><span class="ident" id="6008540">New</span><span class="op" id="6008543">(</span><span class="string" id="6008544">&#34;archive/tar:&nbsp;write&nbsp;too&nbsp;long&#34;</span><span class="op" id="6008573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6008576">ErrFieldTooLong</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6008595">=</span>&nbsp;<span class="ident" id="6008597">errors</span><span class="op" id="6008603">.</span><span class="ident" id="6008604">New</span><span class="op" id="6008607">(</span><span class="string" id="6008608">&#34;archive/tar:&nbsp;header&nbsp;field&nbsp;too&nbsp;long&#34;</span><span class="op" id="6008644">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6008647">ErrWriteAfterClose</span>&nbsp;<span class="op" id="6008666">=</span>&nbsp;<span class="ident" id="6008668">errors</span><span class="op" id="6008674">.</span><span class="ident" id="6008675">New</span><span class="op" id="6008678">(</span><span class="string" id="6008679">&#34;archive/tar:&nbsp;write&nbsp;after&nbsp;close&#34;</span><span class="op" id="6008711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6008714">errNameTooLong</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6008733">=</span>&nbsp;<span class="ident" id="6008735">errors</span><span class="op" id="6008741">.</span><span class="ident" id="6008742">New</span><span class="op" id="6008745">(</span><span class="string" id="6008746">&#34;archive/tar:&nbsp;name&nbsp;too&nbsp;long&#34;</span><span class="op" id="6008774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6008777">errInvalidHeader</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6008796">=</span>&nbsp;<span class="ident" id="6008798">errors</span><span class="op" id="6008804">.</span><span class="ident" id="6008805">New</span><span class="op" id="6008808">(</span><span class="string" id="6008809">&#34;archive/tar:&nbsp;header&nbsp;field&nbsp;too&nbsp;long&nbsp;or&nbsp;contains&nbsp;invalid&nbsp;values&#34;</span><span class="op" id="6008872">)</span><br>
<span class="lineno"></span><span class="op" id="6008874">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="comment" id="6008877">//&nbsp;A&nbsp;Writer&nbsp;provides&nbsp;sequential&nbsp;writing&nbsp;of&nbsp;a&nbsp;tar&nbsp;archive&nbsp;in&nbsp;POSIX.1&nbsp;format.</span><br>
<span class="lineno"></span><span class="comment" id="6008953">//&nbsp;A&nbsp;tar&nbsp;archive&nbsp;consists&nbsp;of&nbsp;a&nbsp;sequence&nbsp;of&nbsp;files.</span><br>
<span class="lineno"></span><span class="comment" id="6009003">//&nbsp;Call&nbsp;WriteHeader&nbsp;to&nbsp;begin&nbsp;a&nbsp;new&nbsp;file,&nbsp;and&nbsp;then&nbsp;call&nbsp;Write&nbsp;to&nbsp;supply&nbsp;that&nbsp;file&#39;s&nbsp;data,</span><br>
<span class="lineno"></span><span class="comment" id="6009092">//&nbsp;writing&nbsp;at&nbsp;most&nbsp;hdr.Size&nbsp;bytes&nbsp;in&nbsp;total.</span><br>
<span class="lineno"></span><span class="keyword" id="6009136">type</span>&nbsp;<span class="ident" id="6009141">Writer</span>&nbsp;<span class="keyword" id="6009148">struct</span>&nbsp;<span class="op" id="6009155">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6009158">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6009169">io</span><span class="op" id="6009171">.</span><span class="ident" id="6009172">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6009180">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6009191">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6009198">nb</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6009209">int64</span>&nbsp;<span class="comment" id="6009215">//&nbsp;number&nbsp;of&nbsp;unwritten&nbsp;bytes&nbsp;for&nbsp;current&nbsp;file&nbsp;entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6009268">pad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6009279">int64</span>&nbsp;<span class="comment" id="6009285">//&nbsp;amount&nbsp;of&nbsp;padding&nbsp;to&nbsp;write&nbsp;after&nbsp;current&nbsp;file&nbsp;entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6009341">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6009352">bool</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6009358">usedBinary</span>&nbsp;<span class="builtintype" id="6009369">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6009385">//&nbsp;whether&nbsp;the&nbsp;binary&nbsp;numeric&nbsp;field&nbsp;extension&nbsp;was&nbsp;used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6009441">preferPax</span>&nbsp;&nbsp;<span class="builtintype" id="6009452">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6009468">//&nbsp;use&nbsp;pax&nbsp;header&nbsp;instead&nbsp;of&nbsp;binary&nbsp;numeric&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6009520">hdrBuff</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6009531">[</span><span class="ident" id="6009532">blockSize</span><span class="op" id="6009541">]</span><span class="builtintype" id="6009542">byte</span>&nbsp;<span class="comment" id="6009547">//&nbsp;buffer&nbsp;to&nbsp;use&nbsp;in&nbsp;writeHeader&nbsp;when&nbsp;writing&nbsp;a&nbsp;regular&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6009610">paxHdrBuff</span>&nbsp;<span class="op" id="6009621">[</span><span class="ident" id="6009622">blockSize</span><span class="op" id="6009631">]</span><span class="builtintype" id="6009632">byte</span>&nbsp;<span class="comment" id="6009637">//&nbsp;buffer&nbsp;to&nbsp;use&nbsp;in&nbsp;writeHeader&nbsp;when&nbsp;writing&nbsp;a&nbsp;pax&nbsp;header</span><br>
<span class="lineno"></span><span class="op" id="6009695">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="6009698">//&nbsp;NewWriter&nbsp;creates&nbsp;a&nbsp;new&nbsp;Writer&nbsp;writing&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="6009746">func</span>&nbsp;<span class="ident" id="6009751">NewWriter</span><span class="op" id="6009760">(</span><span class="ident" id="6009761">w</span>&nbsp;<span class="ident" id="6009763">io</span><span class="op" id="6009765">.</span><span class="ident" id="6009766">Writer</span><span class="op" id="6009772">)</span>&nbsp;<span class="op" id="6009774">*</span><span class="ident" id="6009775">Writer</span>&nbsp;<span class="op" id="6009782">{</span>&nbsp;<span class="keyword" id="6009784">return</span>&nbsp;<span class="op" id="6009791">&amp;</span><span class="ident" id="6009792">Writer</span><span class="op" id="6009798">{</span><span class="ident" id="6009799">w</span><span class="op" id="6009800">:</span>&nbsp;<span class="ident" id="6009802">w</span><span class="op" id="6009803">}</span>&nbsp;<span class="op" id="6009805">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6009808">//&nbsp;Flush&nbsp;finishes&nbsp;writing&nbsp;the&nbsp;current&nbsp;file&nbsp;(optional).</span><br>
<span class="lineno">50</span><span class="keyword" id="6009863">func</span>&nbsp;<span class="op" id="6009868">(</span><span class="ident" id="6009869">tw</span>&nbsp;<span class="op" id="6009872">*</span><span class="ident" id="6009873">Writer</span><span class="op" id="6009879">)</span>&nbsp;<span class="ident" id="6009881">Flush</span><span class="op" id="6009886">(</span><span class="op" id="6009887">)</span>&nbsp;<span class="builtintype" id="6009889">error</span>&nbsp;<span class="op" id="6009895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6009898">if</span>&nbsp;<span class="ident" id="6009901">tw</span><span class="op" id="6009903">.</span><span class="ident" id="6009904">nb</span>&nbsp;<span class="op" id="6009907">&gt;</span>&nbsp;<span class="num" id="6009909">0</span>&nbsp;<span class="op" id="6009911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6009915">tw</span><span class="op" id="6009917">.</span><span class="ident" id="6009918">err</span>&nbsp;<span class="op" id="6009922">=</span>&nbsp;<span class="ident" id="6009924">fmt</span><span class="op" id="6009927">.</span><span class="ident" id="6009928">Errorf</span><span class="op" id="6009934">(</span><span class="string" id="6009935">&#34;archive/tar:&nbsp;missed&nbsp;writing&nbsp;%d&nbsp;bytes&#34;</span><span class="op" id="6009973">,</span>&nbsp;<span class="ident" id="6009975">tw</span><span class="op" id="6009977">.</span><span class="ident" id="6009978">nb</span><span class="op" id="6009980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6009984">return</span>&nbsp;<span class="ident" id="6009991">tw</span><span class="op" id="6009993">.</span><span class="ident" id="6009994">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6009999">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6010003">n</span>&nbsp;<span class="op" id="6010005">:=</span>&nbsp;<span class="ident" id="6010008">tw</span><span class="op" id="6010010">.</span><span class="ident" id="6010011">nb</span>&nbsp;<span class="op" id="6010014">+</span>&nbsp;<span class="ident" id="6010016">tw</span><span class="op" id="6010018">.</span><span class="ident" id="6010019">pad</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6010024">for</span>&nbsp;<span class="ident" id="6010028">n</span>&nbsp;<span class="op" id="6010030">&gt;</span>&nbsp;<span class="num" id="6010032">0</span>&nbsp;<span class="op" id="6010034">&amp;&amp;</span>&nbsp;<span class="ident" id="6010037">tw</span><span class="op" id="6010039">.</span><span class="ident" id="6010040">err</span>&nbsp;<span class="op" id="6010044">==</span>&nbsp;<span class="ident" id="6010047">nil</span>&nbsp;<span class="op" id="6010051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6010055">nr</span>&nbsp;<span class="op" id="6010058">:=</span>&nbsp;<span class="ident" id="6010061">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6010065">if</span>&nbsp;<span class="ident" id="6010068">nr</span>&nbsp;<span class="op" id="6010071">&gt;</span>&nbsp;<span class="ident" id="6010073">blockSize</span>&nbsp;<span class="op" id="6010083">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6010088">nr</span>&nbsp;<span class="op" id="6010091">=</span>&nbsp;<span class="ident" id="6010093">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6010105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6010109">var</span>&nbsp;<span class="ident" id="6010113">nw</span>&nbsp;<span class="builtintype" id="6010116">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6010122">nw</span><span class="op" id="6010124">,</span>&nbsp;<span class="ident" id="6010126">tw</span><span class="op" id="6010128">.</span><span class="ident" id="6010129">err</span>&nbsp;<span class="op" id="6010133">=</span>&nbsp;<span class="ident" id="6010135">tw</span><span class="op" id="6010137">.</span><span class="ident" id="6010138">w</span><span class="op" id="6010139">.</span><span class="ident" id="6010140">Write</span><span class="op" id="6010145">(</span><span class="ident" id="6010146">zeroBlock</span><span class="op" id="6010155">[</span><span class="num" id="6010156">0</span><span class="op" id="6010157">:</span><span class="ident" id="6010158">nr</span><span class="op" id="6010160">]</span><span class="op" id="6010161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6010165">n</span>&nbsp;<span class="op" id="6010167">-=</span>&nbsp;<span class="ident" id="6010170">int64</span><span class="op" id="6010175">(</span><span class="ident" id="6010176">nw</span><span class="op" id="6010178">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6010181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6010184">tw</span><span class="op" id="6010186">.</span><span class="ident" id="6010187">nb</span>&nbsp;<span class="op" id="6010190">=</span>&nbsp;<span class="num" id="6010192">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6010195">tw</span><span class="op" id="6010197">.</span><span class="ident" id="6010198">pad</span>&nbsp;<span class="op" id="6010202">=</span>&nbsp;<span class="num" id="6010204">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6010207">return</span>&nbsp;<span class="ident" id="6010214">tw</span><span class="op" id="6010216">.</span><span class="ident" id="6010217">err</span><br>
<span class="lineno"></span><span class="op" id="6010221">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment" id="6010224">//&nbsp;Write&nbsp;s&nbsp;into&nbsp;b,&nbsp;terminating&nbsp;it&nbsp;with&nbsp;a&nbsp;NUL&nbsp;if&nbsp;there&nbsp;is&nbsp;room.</span><br>
<span class="lineno"></span><span class="comment" id="6010287">//&nbsp;If&nbsp;the&nbsp;value&nbsp;is&nbsp;too&nbsp;long&nbsp;for&nbsp;the&nbsp;field&nbsp;and&nbsp;allowPax&nbsp;is&nbsp;true&nbsp;add&nbsp;a&nbsp;paxheader&nbsp;record&nbsp;instead</span><br>
<span class="lineno"></span><span class="keyword" id="6010381">func</span>&nbsp;<span class="op" id="6010386">(</span><span class="ident" id="6010387">tw</span>&nbsp;<span class="op" id="6010390">*</span><span class="ident" id="6010391">Writer</span><span class="op" id="6010397">)</span>&nbsp;<span class="ident" id="6010399">cString</span><span class="op" id="6010406">(</span><span class="ident" id="6010407">b</span>&nbsp;<span class="op" id="6010409">[</span><span class="op" id="6010410">]</span><span class="builtintype" id="6010411">byte</span><span class="op" id="6010415">,</span>&nbsp;<span class="ident" id="6010417">s</span>&nbsp;<span class="builtintype" id="6010419">string</span><span class="op" id="6010425">,</span>&nbsp;<span class="ident" id="6010427">allowPax</span>&nbsp;<span class="builtintype" id="6010436">bool</span><span class="op" id="6010440">,</span>&nbsp;<span class="ident" id="6010442">paxKeyword</span>&nbsp;<span class="builtintype" id="6010453">string</span><span class="op" id="6010459">,</span>&nbsp;<span class="ident" id="6010461">paxHeaders</span>&nbsp;<span class="keyword" id="6010472">map</span><span class="op" id="6010475">[</span><span class="builtintype" id="6010476">string</span><span class="op" id="6010482">]</span><span class="builtintype" id="6010483">string</span><span class="op" id="6010489">)</span>&nbsp;<span class="op" id="6010491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6010494">needsPaxHeader</span>&nbsp;<span class="op" id="6010509">:=</span>&nbsp;<span class="ident" id="6010512">allowPax</span>&nbsp;<span class="op" id="6010521">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="6010524">len</span><span class="op" id="6010527">(</span><span class="ident" id="6010528">s</span><span class="op" id="6010529">)</span>&nbsp;<span class="op" id="6010531">&gt;</span>&nbsp;<span class="builtinfunc" id="6010533">len</span><span class="op" id="6010536">(</span><span class="ident" id="6010537">b</span><span class="op" id="6010538">)</span>&nbsp;<span class="op" id="6010540">||</span>&nbsp;<span class="op" id="6010543">!</span><span class="ident" id="6010544">isASCII</span><span class="op" id="6010551">(</span><span class="ident" id="6010552">s</span><span class="op" id="6010553">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6010556">if</span>&nbsp;<span class="ident" id="6010559">needsPaxHeader</span>&nbsp;<span class="op" id="6010574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6010578">paxHeaders</span><span class="op" id="6010588">[</span><span class="ident" id="6010589">paxKeyword</span><span class="op" id="6010599">]</span>&nbsp;<span class="op" id="6010601">=</span>&nbsp;<span class="ident" id="6010603">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6010607">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6010615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6010618">if</span>&nbsp;<span class="builtinfunc" id="6010621">len</span><span class="op" id="6010624">(</span><span class="ident" id="6010625">s</span><span class="op" id="6010626">)</span>&nbsp;<span class="op" id="6010628">&gt;</span>&nbsp;<span class="builtinfunc" id="6010630">len</span><span class="op" id="6010633">(</span><span class="ident" id="6010634">b</span><span class="op" id="6010635">)</span>&nbsp;<span class="op" id="6010637">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6010641">if</span>&nbsp;<span class="ident" id="6010644">tw</span><span class="op" id="6010646">.</span><span class="ident" id="6010647">err</span>&nbsp;<span class="op" id="6010651">==</span>&nbsp;<span class="ident" id="6010654">nil</span>&nbsp;<span class="op" id="6010658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6010663">tw</span><span class="op" id="6010665">.</span><span class="ident" id="6010666">err</span>&nbsp;<span class="op" id="6010670">=</span>&nbsp;<span class="ident" id="6010672">ErrFieldTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6010690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6010694">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6010702">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6010705">ascii</span>&nbsp;<span class="op" id="6010711">:=</span>&nbsp;<span class="ident" id="6010714">toASCII</span><span class="op" id="6010721">(</span><span class="ident" id="6010722">s</span><span class="op" id="6010723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6010726">copy</span><span class="op" id="6010730">(</span><span class="ident" id="6010731">b</span><span class="op" id="6010732">,</span>&nbsp;<span class="ident" id="6010734">ascii</span><span class="op" id="6010739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6010742">if</span>&nbsp;<span class="builtinfunc" id="6010745">len</span><span class="op" id="6010748">(</span><span class="ident" id="6010749">ascii</span><span class="op" id="6010754">)</span>&nbsp;<span class="op" id="6010756">&lt;</span>&nbsp;<span class="builtinfunc" id="6010758">len</span><span class="op" id="6010761">(</span><span class="ident" id="6010762">b</span><span class="op" id="6010763">)</span>&nbsp;<span class="op" id="6010765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6010769">b</span><span class="op" id="6010770">[</span><span class="builtinfunc" id="6010771">len</span><span class="op" id="6010774">(</span><span class="ident" id="6010775">ascii</span><span class="op" id="6010780">)</span><span class="op" id="6010781">]</span>&nbsp;<span class="op" id="6010783">=</span>&nbsp;<span class="num" id="6010785">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6010788">}</span><br>
<span class="lineno">90</span><span class="op" id="6010790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6010793">//&nbsp;Encode&nbsp;x&nbsp;as&nbsp;an&nbsp;octal&nbsp;ASCII&nbsp;string&nbsp;and&nbsp;write&nbsp;it&nbsp;into&nbsp;b&nbsp;with&nbsp;leading&nbsp;zeros.</span><br>
<span class="lineno"></span><span class="keyword" id="6010870">func</span>&nbsp;<span class="op" id="6010875">(</span><span class="ident" id="6010876">tw</span>&nbsp;<span class="op" id="6010879">*</span><span class="ident" id="6010880">Writer</span><span class="op" id="6010886">)</span>&nbsp;<span class="ident" id="6010888">octal</span><span class="op" id="6010893">(</span><span class="ident" id="6010894">b</span>&nbsp;<span class="op" id="6010896">[</span><span class="op" id="6010897">]</span><span class="builtintype" id="6010898">byte</span><span class="op" id="6010902">,</span>&nbsp;<span class="ident" id="6010904">x</span>&nbsp;<span class="ident" id="6010906">int64</span><span class="op" id="6010911">)</span>&nbsp;<span class="op" id="6010913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6010916">s</span>&nbsp;<span class="op" id="6010918">:=</span>&nbsp;<span class="ident" id="6010921">strconv</span><span class="op" id="6010928">.</span><span class="ident" id="6010929">FormatInt</span><span class="op" id="6010938">(</span><span class="ident" id="6010939">x</span><span class="op" id="6010940">,</span>&nbsp;<span class="num" id="6010942">8</span><span class="op" id="6010943">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6010946">//&nbsp;leading&nbsp;zeros,&nbsp;but&nbsp;leave&nbsp;room&nbsp;for&nbsp;a&nbsp;NUL.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6010991">for</span>&nbsp;<span class="builtinfunc" id="6010995">len</span><span class="op" id="6010998">(</span><span class="ident" id="6010999">s</span><span class="op" id="6011000">)</span><span class="op" id="6011001">+</span><span class="num" id="6011002">1</span>&nbsp;<span class="op" id="6011004">&lt;</span>&nbsp;<span class="builtinfunc" id="6011006">len</span><span class="op" id="6011009">(</span><span class="ident" id="6011010">b</span><span class="op" id="6011011">)</span>&nbsp;<span class="op" id="6011013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6011017">s</span>&nbsp;<span class="op" id="6011019">=</span>&nbsp;<span class="string" id="6011021">&#34;0&#34;</span>&nbsp;<span class="op" id="6011025">+</span>&nbsp;<span class="ident" id="6011027">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6011030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6011033">tw</span><span class="op" id="6011035">.</span><span class="ident" id="6011036">cString</span><span class="op" id="6011043">(</span><span class="ident" id="6011044">b</span><span class="op" id="6011045">,</span>&nbsp;<span class="ident" id="6011047">s</span><span class="op" id="6011048">,</span>&nbsp;<span class="builtintype" id="6011050">false</span><span class="op" id="6011055">,</span>&nbsp;<span class="ident" id="6011057">paxNone</span><span class="op" id="6011064">,</span>&nbsp;<span class="ident" id="6011066">nil</span><span class="op" id="6011069">)</span><br>
<span class="lineno">100</span><span class="op" id="6011071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6011074">//&nbsp;Write&nbsp;x&nbsp;into&nbsp;b,&nbsp;either&nbsp;as&nbsp;octal&nbsp;or&nbsp;as&nbsp;binary&nbsp;(GNUtar/star&nbsp;extension).</span><br>
<span class="lineno"></span><span class="comment" id="6011147">//&nbsp;If&nbsp;the&nbsp;value&nbsp;is&nbsp;too&nbsp;long&nbsp;for&nbsp;the&nbsp;field&nbsp;and&nbsp;writingPax&nbsp;is&nbsp;enabled&nbsp;both&nbsp;for&nbsp;the&nbsp;field&nbsp;and&nbsp;the&nbsp;add&nbsp;a&nbsp;paxheader&nbsp;record&nbsp;instead</span><br>
<span class="lineno"></span><span class="keyword" id="6011273">func</span>&nbsp;<span class="op" id="6011278">(</span><span class="ident" id="6011279">tw</span>&nbsp;<span class="op" id="6011282">*</span><span class="ident" id="6011283">Writer</span><span class="op" id="6011289">)</span>&nbsp;<span class="ident" id="6011291">numeric</span><span class="op" id="6011298">(</span><span class="ident" id="6011299">b</span>&nbsp;<span class="op" id="6011301">[</span><span class="op" id="6011302">]</span><span class="builtintype" id="6011303">byte</span><span class="op" id="6011307">,</span>&nbsp;<span class="ident" id="6011309">x</span>&nbsp;<span class="ident" id="6011311">int64</span><span class="op" id="6011316">,</span>&nbsp;<span class="ident" id="6011318">allowPax</span>&nbsp;<span class="builtintype" id="6011327">bool</span><span class="op" id="6011331">,</span>&nbsp;<span class="ident" id="6011333">paxKeyword</span>&nbsp;<span class="builtintype" id="6011344">string</span><span class="op" id="6011350">,</span>&nbsp;<span class="ident" id="6011352">paxHeaders</span>&nbsp;<span class="keyword" id="6011363">map</span><span class="op" id="6011366">[</span><span class="builtintype" id="6011367">string</span><span class="op" id="6011373">]</span><span class="builtintype" id="6011374">string</span><span class="op" id="6011380">)</span>&nbsp;<span class="op" id="6011382">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6011385">//&nbsp;Try&nbsp;octal&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6011406">s</span>&nbsp;<span class="op" id="6011408">:=</span>&nbsp;<span class="ident" id="6011411">strconv</span><span class="op" id="6011418">.</span><span class="ident" id="6011419">FormatInt</span><span class="op" id="6011428">(</span><span class="ident" id="6011429">x</span><span class="op" id="6011430">,</span>&nbsp;<span class="num" id="6011432">8</span><span class="op" id="6011433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6011436">if</span>&nbsp;<span class="builtinfunc" id="6011439">len</span><span class="op" id="6011442">(</span><span class="ident" id="6011443">s</span><span class="op" id="6011444">)</span>&nbsp;<span class="op" id="6011446">&lt;</span>&nbsp;<span class="builtinfunc" id="6011448">len</span><span class="op" id="6011451">(</span><span class="ident" id="6011452">b</span><span class="op" id="6011453">)</span>&nbsp;<span class="op" id="6011455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6011459">tw</span><span class="op" id="6011461">.</span><span class="ident" id="6011462">octal</span><span class="op" id="6011467">(</span><span class="ident" id="6011468">b</span><span class="op" id="6011469">,</span>&nbsp;<span class="ident" id="6011471">x</span><span class="op" id="6011472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6011476">return</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6011484">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6011488">//&nbsp;If&nbsp;it&nbsp;is&nbsp;too&nbsp;long&nbsp;for&nbsp;octal,&nbsp;and&nbsp;pax&nbsp;is&nbsp;preferred,&nbsp;use&nbsp;a&nbsp;pax&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6011560">if</span>&nbsp;<span class="ident" id="6011563">allowPax</span>&nbsp;<span class="op" id="6011572">&amp;&amp;</span>&nbsp;<span class="ident" id="6011575">tw</span><span class="op" id="6011577">.</span><span class="ident" id="6011578">preferPax</span>&nbsp;<span class="op" id="6011588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6011592">tw</span><span class="op" id="6011594">.</span><span class="ident" id="6011595">octal</span><span class="op" id="6011600">(</span><span class="ident" id="6011601">b</span><span class="op" id="6011602">,</span>&nbsp;<span class="num" id="6011604">0</span><span class="op" id="6011605">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6011609">s</span>&nbsp;<span class="op" id="6011611">:=</span>&nbsp;<span class="ident" id="6011614">strconv</span><span class="op" id="6011621">.</span><span class="ident" id="6011622">FormatInt</span><span class="op" id="6011631">(</span><span class="ident" id="6011632">x</span><span class="op" id="6011633">,</span>&nbsp;<span class="num" id="6011635">10</span><span class="op" id="6011637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6011641">paxHeaders</span><span class="op" id="6011651">[</span><span class="ident" id="6011652">paxKeyword</span><span class="op" id="6011662">]</span>&nbsp;<span class="op" id="6011664">=</span>&nbsp;<span class="ident" id="6011666">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6011670">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6011678">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6011682">//&nbsp;Too&nbsp;big:&nbsp;use&nbsp;binary&nbsp;(big-endian).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6011720">tw</span><span class="op" id="6011722">.</span><span class="ident" id="6011723">usedBinary</span>&nbsp;<span class="op" id="6011734">=</span>&nbsp;<span class="builtintype" id="6011736">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6011742">for</span>&nbsp;<span class="ident" id="6011746">i</span>&nbsp;<span class="op" id="6011748">:=</span>&nbsp;<span class="builtinfunc" id="6011751">len</span><span class="op" id="6011754">(</span><span class="ident" id="6011755">b</span><span class="op" id="6011756">)</span>&nbsp;<span class="op" id="6011758">-</span>&nbsp;<span class="num" id="6011760">1</span><span class="op" id="6011761">;</span>&nbsp;<span class="ident" id="6011763">x</span>&nbsp;<span class="op" id="6011765">&gt;</span>&nbsp;<span class="num" id="6011767">0</span>&nbsp;<span class="op" id="6011769">&amp;&amp;</span>&nbsp;<span class="ident" id="6011772">i</span>&nbsp;<span class="op" id="6011774">&gt;=</span>&nbsp;<span class="num" id="6011777">0</span><span class="op" id="6011778">;</span>&nbsp;<span class="ident" id="6011780">i</span><span class="op" id="6011781">--</span>&nbsp;<span class="op" id="6011784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6011788">b</span><span class="op" id="6011789">[</span><span class="ident" id="6011790">i</span><span class="op" id="6011791">]</span>&nbsp;<span class="op" id="6011793">=</span>&nbsp;<span class="builtintype" id="6011795">byte</span><span class="op" id="6011799">(</span><span class="ident" id="6011800">x</span><span class="op" id="6011801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6011805">x</span>&nbsp;<span class="op" id="6011807">&gt;&gt;=</span>&nbsp;<span class="num" id="6011811">8</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6011814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6011817">b</span><span class="op" id="6011818">[</span><span class="num" id="6011819">0</span><span class="op" id="6011820">]</span>&nbsp;<span class="op" id="6011822">|=</span>&nbsp;<span class="num" id="6011825">0x80</span>&nbsp;<span class="comment" id="6011830">//&nbsp;highest&nbsp;bit&nbsp;indicates&nbsp;binary&nbsp;format</span><br>
<span class="lineno"></span><span class="op" id="6011869">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6011872">var</span>&nbsp;<span class="op" id="6011876">(</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6011879">minTime</span>&nbsp;<span class="op" id="6011887">=</span>&nbsp;<span class="ident" id="6011889">time</span><span class="op" id="6011893">.</span><span class="ident" id="6011894">Unix</span><span class="op" id="6011898">(</span><span class="num" id="6011899">0</span><span class="op" id="6011900">,</span>&nbsp;<span class="num" id="6011902">0</span><span class="op" id="6011903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6011906">//&nbsp;There&nbsp;is&nbsp;room&nbsp;for&nbsp;11&nbsp;octal&nbsp;digits&nbsp;(33&nbsp;bits)&nbsp;of&nbsp;mtime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6011964">maxTime</span>&nbsp;<span class="op" id="6011972">=</span>&nbsp;<span class="ident" id="6011974">minTime</span><span class="op" id="6011981">.</span><span class="ident" id="6011982">Add</span><span class="op" id="6011985">(</span><span class="op" id="6011986">(</span><span class="num" id="6011987">1</span><span class="op" id="6011988">&lt;&lt;</span><span class="num" id="6011990">33</span>&nbsp;<span class="op" id="6011993">-</span>&nbsp;<span class="num" id="6011995">1</span><span class="op" id="6011996">)</span>&nbsp;<span class="op" id="6011998">*</span>&nbsp;<span class="ident" id="6012000">time</span><span class="op" id="6012004">.</span><span class="ident" id="6012005">Second</span><span class="op" id="6012011">)</span><br>
<span class="lineno"></span><span class="op" id="6012013">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="comment" id="6012016">//&nbsp;WriteHeader&nbsp;writes&nbsp;hdr&nbsp;and&nbsp;prepares&nbsp;to&nbsp;accept&nbsp;the&nbsp;file&#39;s&nbsp;contents.</span><br>
<span class="lineno"></span><span class="comment" id="6012086">//&nbsp;WriteHeader&nbsp;calls&nbsp;Flush&nbsp;if&nbsp;it&nbsp;is&nbsp;not&nbsp;the&nbsp;first&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="6012144">//&nbsp;Calling&nbsp;after&nbsp;a&nbsp;Close&nbsp;will&nbsp;return&nbsp;ErrWriteAfterClose.</span><br>
<span class="lineno"></span><span class="keyword" id="6012201">func</span>&nbsp;<span class="op" id="6012206">(</span><span class="ident" id="6012207">tw</span>&nbsp;<span class="op" id="6012210">*</span><span class="ident" id="6012211">Writer</span><span class="op" id="6012217">)</span>&nbsp;<span class="ident" id="6012219">WriteHeader</span><span class="op" id="6012230">(</span><span class="ident" id="6012231">hdr</span>&nbsp;<span class="op" id="6012235">*</span><span class="ident" id="6012236">Header</span><span class="op" id="6012242">)</span>&nbsp;<span class="builtintype" id="6012244">error</span>&nbsp;<span class="op" id="6012250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6012253">return</span>&nbsp;<span class="ident" id="6012260">tw</span><span class="op" id="6012262">.</span><span class="ident" id="6012263">writeHeader</span><span class="op" id="6012274">(</span><span class="ident" id="6012275">hdr</span><span class="op" id="6012278">,</span>&nbsp;<span class="builtintype" id="6012280">true</span><span class="op" id="6012284">)</span><br>
<span class="lineno">140</span><span class="op" id="6012286">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6012289">//&nbsp;WriteHeader&nbsp;writes&nbsp;hdr&nbsp;and&nbsp;prepares&nbsp;to&nbsp;accept&nbsp;the&nbsp;file&#39;s&nbsp;contents.</span><br>
<span class="lineno"></span><span class="comment" id="6012359">//&nbsp;WriteHeader&nbsp;calls&nbsp;Flush&nbsp;if&nbsp;it&nbsp;is&nbsp;not&nbsp;the&nbsp;first&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="6012417">//&nbsp;Calling&nbsp;after&nbsp;a&nbsp;Close&nbsp;will&nbsp;return&nbsp;ErrWriteAfterClose.</span><br>
<span class="lineno">145</span><span class="comment" id="6012474">//&nbsp;As&nbsp;this&nbsp;method&nbsp;is&nbsp;called&nbsp;internally&nbsp;by&nbsp;writePax&nbsp;header&nbsp;to&nbsp;allow&nbsp;it&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="6012547">//&nbsp;suppress&nbsp;writing&nbsp;the&nbsp;pax&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="6012583">func</span>&nbsp;<span class="op" id="6012588">(</span><span class="ident" id="6012589">tw</span>&nbsp;<span class="op" id="6012592">*</span><span class="ident" id="6012593">Writer</span><span class="op" id="6012599">)</span>&nbsp;<span class="ident" id="6012601">writeHeader</span><span class="op" id="6012612">(</span><span class="ident" id="6012613">hdr</span>&nbsp;<span class="op" id="6012617">*</span><span class="ident" id="6012618">Header</span><span class="op" id="6012624">,</span>&nbsp;<span class="ident" id="6012626">allowPax</span>&nbsp;<span class="builtintype" id="6012635">bool</span><span class="op" id="6012639">)</span>&nbsp;<span class="builtintype" id="6012641">error</span>&nbsp;<span class="op" id="6012647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6012650">if</span>&nbsp;<span class="ident" id="6012653">tw</span><span class="op" id="6012655">.</span><span class="ident" id="6012656">closed</span>&nbsp;<span class="op" id="6012663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6012667">return</span>&nbsp;<span class="ident" id="6012674">ErrWriteAfterClose</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6012694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6012697">if</span>&nbsp;<span class="ident" id="6012700">tw</span><span class="op" id="6012702">.</span><span class="ident" id="6012703">err</span>&nbsp;<span class="op" id="6012707">==</span>&nbsp;<span class="ident" id="6012710">nil</span>&nbsp;<span class="op" id="6012714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6012718">tw</span><span class="op" id="6012720">.</span><span class="ident" id="6012721">Flush</span><span class="op" id="6012726">(</span><span class="op" id="6012727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6012730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6012733">if</span>&nbsp;<span class="ident" id="6012736">tw</span><span class="op" id="6012738">.</span><span class="ident" id="6012739">err</span>&nbsp;<span class="op" id="6012743">!=</span>&nbsp;<span class="ident" id="6012746">nil</span>&nbsp;<span class="op" id="6012750">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6012754">return</span>&nbsp;<span class="ident" id="6012761">tw</span><span class="op" id="6012763">.</span><span class="ident" id="6012764">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6012769">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6012773">//&nbsp;a&nbsp;map&nbsp;to&nbsp;hold&nbsp;pax&nbsp;header&nbsp;records,&nbsp;if&nbsp;any&nbsp;are&nbsp;needed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6012829">paxHeaders</span>&nbsp;<span class="op" id="6012840">:=</span>&nbsp;<span class="builtinfunc" id="6012843">make</span><span class="op" id="6012847">(</span><span class="keyword" id="6012848">map</span><span class="op" id="6012851">[</span><span class="builtintype" id="6012852">string</span><span class="op" id="6012858">]</span><span class="builtintype" id="6012859">string</span><span class="op" id="6012865">)</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6012869">//&nbsp;TODO(shanemhansen):&nbsp;we&nbsp;might&nbsp;want&nbsp;to&nbsp;use&nbsp;PAX&nbsp;headers&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6012930">//&nbsp;subsecond&nbsp;time&nbsp;resolution,&nbsp;but&nbsp;for&nbsp;now&nbsp;let&#39;s&nbsp;just&nbsp;capture</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6012992">//&nbsp;too&nbsp;long&nbsp;fields&nbsp;or&nbsp;non&nbsp;ascii&nbsp;characters</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6013037">var</span>&nbsp;<span class="ident" id="6013041">header</span>&nbsp;<span class="op" id="6013048">[</span><span class="op" id="6013049">]</span><span class="builtintype" id="6013050">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6013057">//&nbsp;We&nbsp;need&nbsp;to&nbsp;select&nbsp;which&nbsp;scratch&nbsp;buffer&nbsp;to&nbsp;use&nbsp;carefully,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6013118">//&nbsp;since&nbsp;this&nbsp;method&nbsp;is&nbsp;called&nbsp;recursively&nbsp;to&nbsp;write&nbsp;PAX&nbsp;headers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6013184">//&nbsp;If&nbsp;allowPax&nbsp;is&nbsp;true,&nbsp;this&nbsp;is&nbsp;the&nbsp;non-recursive&nbsp;call,&nbsp;and&nbsp;we&nbsp;will&nbsp;use&nbsp;hdrBuff.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6013266">//&nbsp;If&nbsp;allowPax&nbsp;is&nbsp;false,&nbsp;we&nbsp;are&nbsp;being&nbsp;called&nbsp;by&nbsp;writePAXHeader,&nbsp;and&nbsp;hdrBuff&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6013346">//&nbsp;already&nbsp;being&nbsp;used&nbsp;by&nbsp;the&nbsp;non-recursive&nbsp;call,&nbsp;so&nbsp;we&nbsp;must&nbsp;use&nbsp;paxHdrBuff.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6013423">header</span>&nbsp;<span class="op" id="6013430">=</span>&nbsp;<span class="ident" id="6013432">tw</span><span class="op" id="6013434">.</span><span class="ident" id="6013435">hdrBuff</span><span class="op" id="6013442">[</span><span class="op" id="6013443">:</span><span class="op" id="6013444">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6013447">if</span>&nbsp;<span class="op" id="6013450">!</span><span class="ident" id="6013451">allowPax</span>&nbsp;<span class="op" id="6013460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6013464">header</span>&nbsp;<span class="op" id="6013471">=</span>&nbsp;<span class="ident" id="6013473">tw</span><span class="op" id="6013475">.</span><span class="ident" id="6013476">paxHdrBuff</span><span class="op" id="6013486">[</span><span class="op" id="6013487">:</span><span class="op" id="6013488">]</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6013491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6013494">copy</span><span class="op" id="6013498">(</span><span class="ident" id="6013499">header</span><span class="op" id="6013505">,</span>&nbsp;<span class="ident" id="6013507">zeroBlock</span><span class="op" id="6013516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6013519">s</span>&nbsp;<span class="op" id="6013521">:=</span>&nbsp;<span class="ident" id="6013524">slicer</span><span class="op" id="6013530">(</span><span class="ident" id="6013531">header</span><span class="op" id="6013537">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6013541">//&nbsp;keep&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;filename&nbsp;to&nbsp;allow&nbsp;to&nbsp;overwrite&nbsp;it&nbsp;later&nbsp;if&nbsp;we&nbsp;detect&nbsp;that&nbsp;we&nbsp;can&nbsp;use&nbsp;ustar&nbsp;longnames&nbsp;instead&nbsp;of&nbsp;pax</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6013669">pathHeaderBytes</span>&nbsp;<span class="op" id="6013685">:=</span>&nbsp;<span class="ident" id="6013688">s</span><span class="op" id="6013689">.</span><span class="ident" id="6013690">next</span><span class="op" id="6013694">(</span><span class="ident" id="6013695">fileNameSize</span><span class="op" id="6013707">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6013711">tw</span><span class="op" id="6013713">.</span><span class="ident" id="6013714">cString</span><span class="op" id="6013721">(</span><span class="ident" id="6013722">pathHeaderBytes</span><span class="op" id="6013737">,</span>&nbsp;<span class="ident" id="6013739">hdr</span><span class="op" id="6013742">.</span><span class="ident" id="6013743">Name</span><span class="op" id="6013747">,</span>&nbsp;<span class="builtintype" id="6013749">true</span><span class="op" id="6013753">,</span>&nbsp;<span class="ident" id="6013755">paxPath</span><span class="op" id="6013762">,</span>&nbsp;<span class="ident" id="6013764">paxHeaders</span><span class="op" id="6013774">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6013778">//&nbsp;Handle&nbsp;out&nbsp;of&nbsp;range&nbsp;ModTime&nbsp;carefully.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6013821">var</span>&nbsp;<span class="ident" id="6013825">modTime</span>&nbsp;<span class="ident" id="6013833">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6013840">if</span>&nbsp;<span class="op" id="6013843">!</span><span class="ident" id="6013844">hdr</span><span class="op" id="6013847">.</span><span class="ident" id="6013848">ModTime</span><span class="op" id="6013855">.</span><span class="ident" id="6013856">Before</span><span class="op" id="6013862">(</span><span class="ident" id="6013863">minTime</span><span class="op" id="6013870">)</span>&nbsp;<span class="op" id="6013872">&amp;&amp;</span>&nbsp;<span class="op" id="6013875">!</span><span class="ident" id="6013876">hdr</span><span class="op" id="6013879">.</span><span class="ident" id="6013880">ModTime</span><span class="op" id="6013887">.</span><span class="ident" id="6013888">After</span><span class="op" id="6013893">(</span><span class="ident" id="6013894">maxTime</span><span class="op" id="6013901">)</span>&nbsp;<span class="op" id="6013903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6013907">modTime</span>&nbsp;<span class="op" id="6013915">=</span>&nbsp;<span class="ident" id="6013917">hdr</span><span class="op" id="6013920">.</span><span class="ident" id="6013921">ModTime</span><span class="op" id="6013928">.</span><span class="ident" id="6013929">Unix</span><span class="op" id="6013933">(</span><span class="op" id="6013934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6013937">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6013941">tw</span><span class="op" id="6013943">.</span><span class="ident" id="6013944">octal</span><span class="op" id="6013949">(</span><span class="ident" id="6013950">s</span><span class="op" id="6013951">.</span><span class="ident" id="6013952">next</span><span class="op" id="6013956">(</span><span class="num" id="6013957">8</span><span class="op" id="6013958">)</span><span class="op" id="6013959">,</span>&nbsp;<span class="ident" id="6013961">hdr</span><span class="op" id="6013964">.</span><span class="ident" id="6013965">Mode</span><span class="op" id="6013969">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6014005">//&nbsp;100:108</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6014017">tw</span><span class="op" id="6014019">.</span><span class="ident" id="6014020">numeric</span><span class="op" id="6014027">(</span><span class="ident" id="6014028">s</span><span class="op" id="6014029">.</span><span class="ident" id="6014030">next</span><span class="op" id="6014034">(</span><span class="num" id="6014035">8</span><span class="op" id="6014036">)</span><span class="op" id="6014037">,</span>&nbsp;<span class="ident" id="6014039">int64</span><span class="op" id="6014044">(</span><span class="ident" id="6014045">hdr</span><span class="op" id="6014048">.</span><span class="ident" id="6014049">Uid</span><span class="op" id="6014052">)</span><span class="op" id="6014053">,</span>&nbsp;<span class="builtintype" id="6014055">true</span><span class="op" id="6014059">,</span>&nbsp;<span class="ident" id="6014061">paxUid</span><span class="op" id="6014067">,</span>&nbsp;<span class="ident" id="6014069">paxHeaders</span><span class="op" id="6014079">)</span>&nbsp;<span class="comment" id="6014081">//&nbsp;108:116</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6014093">tw</span><span class="op" id="6014095">.</span><span class="ident" id="6014096">numeric</span><span class="op" id="6014103">(</span><span class="ident" id="6014104">s</span><span class="op" id="6014105">.</span><span class="ident" id="6014106">next</span><span class="op" id="6014110">(</span><span class="num" id="6014111">8</span><span class="op" id="6014112">)</span><span class="op" id="6014113">,</span>&nbsp;<span class="ident" id="6014115">int64</span><span class="op" id="6014120">(</span><span class="ident" id="6014121">hdr</span><span class="op" id="6014124">.</span><span class="ident" id="6014125">Gid</span><span class="op" id="6014128">)</span><span class="op" id="6014129">,</span>&nbsp;<span class="builtintype" id="6014131">true</span><span class="op" id="6014135">,</span>&nbsp;<span class="ident" id="6014137">paxGid</span><span class="op" id="6014143">,</span>&nbsp;<span class="ident" id="6014145">paxHeaders</span><span class="op" id="6014155">)</span>&nbsp;<span class="comment" id="6014157">//&nbsp;116:124</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6014169">tw</span><span class="op" id="6014171">.</span><span class="ident" id="6014172">numeric</span><span class="op" id="6014179">(</span><span class="ident" id="6014180">s</span><span class="op" id="6014181">.</span><span class="ident" id="6014182">next</span><span class="op" id="6014186">(</span><span class="num" id="6014187">12</span><span class="op" id="6014189">)</span><span class="op" id="6014190">,</span>&nbsp;<span class="ident" id="6014192">hdr</span><span class="op" id="6014195">.</span><span class="ident" id="6014196">Size</span><span class="op" id="6014200">,</span>&nbsp;<span class="builtintype" id="6014202">true</span><span class="op" id="6014206">,</span>&nbsp;<span class="ident" id="6014208">paxSize</span><span class="op" id="6014215">,</span>&nbsp;<span class="ident" id="6014217">paxHeaders</span><span class="op" id="6014227">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6014233">//&nbsp;124:136</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6014245">tw</span><span class="op" id="6014247">.</span><span class="ident" id="6014248">numeric</span><span class="op" id="6014255">(</span><span class="ident" id="6014256">s</span><span class="op" id="6014257">.</span><span class="ident" id="6014258">next</span><span class="op" id="6014262">(</span><span class="num" id="6014263">12</span><span class="op" id="6014265">)</span><span class="op" id="6014266">,</span>&nbsp;<span class="ident" id="6014268">modTime</span><span class="op" id="6014275">,</span>&nbsp;<span class="builtintype" id="6014277">false</span><span class="op" id="6014282">,</span>&nbsp;<span class="ident" id="6014284">paxNone</span><span class="op" id="6014291">,</span>&nbsp;<span class="ident" id="6014293">nil</span><span class="op" id="6014296">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6014309">//&nbsp;136:148&nbsp;---&nbsp;consider&nbsp;using&nbsp;pax&nbsp;for&nbsp;finer&nbsp;granularity</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6014366">s</span><span class="op" id="6014367">.</span><span class="ident" id="6014368">next</span><span class="op" id="6014372">(</span><span class="num" id="6014373">8</span><span class="op" id="6014374">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6014430">//&nbsp;chksum&nbsp;(148:156)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6014451">s</span><span class="op" id="6014452">.</span><span class="ident" id="6014453">next</span><span class="op" id="6014457">(</span><span class="num" id="6014458">1</span><span class="op" id="6014459">)</span><span class="op" id="6014460">[</span><span class="num" id="6014461">0</span><span class="op" id="6014462">]</span>&nbsp;<span class="op" id="6014464">=</span>&nbsp;<span class="ident" id="6014466">hdr</span><span class="op" id="6014469">.</span><span class="ident" id="6014470">Typeflag</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6014515">//&nbsp;156:157</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6014528">tw</span><span class="op" id="6014530">.</span><span class="ident" id="6014531">cString</span><span class="op" id="6014538">(</span><span class="ident" id="6014539">s</span><span class="op" id="6014540">.</span><span class="ident" id="6014541">next</span><span class="op" id="6014545">(</span><span class="num" id="6014546">100</span><span class="op" id="6014549">)</span><span class="op" id="6014550">,</span>&nbsp;<span class="ident" id="6014552">hdr</span><span class="op" id="6014555">.</span><span class="ident" id="6014556">Linkname</span><span class="op" id="6014564">,</span>&nbsp;<span class="builtintype" id="6014566">true</span><span class="op" id="6014570">,</span>&nbsp;<span class="ident" id="6014572">paxLinkpath</span><span class="op" id="6014583">,</span>&nbsp;<span class="ident" id="6014585">paxHeaders</span><span class="op" id="6014595">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6014599">copy</span><span class="op" id="6014603">(</span><span class="ident" id="6014604">s</span><span class="op" id="6014605">.</span><span class="ident" id="6014606">next</span><span class="op" id="6014610">(</span><span class="num" id="6014611">8</span><span class="op" id="6014612">)</span><span class="op" id="6014613">,</span>&nbsp;<span class="op" id="6014615">[</span><span class="op" id="6014616">]</span><span class="builtintype" id="6014617">byte</span><span class="op" id="6014621">(</span><span class="string" id="6014622">&#34;ustar\x0000&#34;</span><span class="op" id="6014635">)</span><span class="op" id="6014636">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6014661">//&nbsp;257:265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6014673">tw</span><span class="op" id="6014675">.</span><span class="ident" id="6014676">cString</span><span class="op" id="6014683">(</span><span class="ident" id="6014684">s</span><span class="op" id="6014685">.</span><span class="ident" id="6014686">next</span><span class="op" id="6014690">(</span><span class="num" id="6014691">32</span><span class="op" id="6014693">)</span><span class="op" id="6014694">,</span>&nbsp;<span class="ident" id="6014696">hdr</span><span class="op" id="6014699">.</span><span class="ident" id="6014700">Uname</span><span class="op" id="6014705">,</span>&nbsp;<span class="builtintype" id="6014707">true</span><span class="op" id="6014711">,</span>&nbsp;<span class="ident" id="6014713">paxUname</span><span class="op" id="6014721">,</span>&nbsp;<span class="ident" id="6014723">paxHeaders</span><span class="op" id="6014733">)</span>&nbsp;<span class="comment" id="6014735">//&nbsp;265:297</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6014747">tw</span><span class="op" id="6014749">.</span><span class="ident" id="6014750">cString</span><span class="op" id="6014757">(</span><span class="ident" id="6014758">s</span><span class="op" id="6014759">.</span><span class="ident" id="6014760">next</span><span class="op" id="6014764">(</span><span class="num" id="6014765">32</span><span class="op" id="6014767">)</span><span class="op" id="6014768">,</span>&nbsp;<span class="ident" id="6014770">hdr</span><span class="op" id="6014773">.</span><span class="ident" id="6014774">Gname</span><span class="op" id="6014779">,</span>&nbsp;<span class="builtintype" id="6014781">true</span><span class="op" id="6014785">,</span>&nbsp;<span class="ident" id="6014787">paxGname</span><span class="op" id="6014795">,</span>&nbsp;<span class="ident" id="6014797">paxHeaders</span><span class="op" id="6014807">)</span>&nbsp;<span class="comment" id="6014809">//&nbsp;297:329</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6014821">tw</span><span class="op" id="6014823">.</span><span class="ident" id="6014824">numeric</span><span class="op" id="6014831">(</span><span class="ident" id="6014832">s</span><span class="op" id="6014833">.</span><span class="ident" id="6014834">next</span><span class="op" id="6014838">(</span><span class="num" id="6014839">8</span><span class="op" id="6014840">)</span><span class="op" id="6014841">,</span>&nbsp;<span class="ident" id="6014843">hdr</span><span class="op" id="6014846">.</span><span class="ident" id="6014847">Devmajor</span><span class="op" id="6014855">,</span>&nbsp;<span class="builtintype" id="6014857">false</span><span class="op" id="6014862">,</span>&nbsp;<span class="ident" id="6014864">paxNone</span><span class="op" id="6014871">,</span>&nbsp;<span class="ident" id="6014873">nil</span><span class="op" id="6014876">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6014883">//&nbsp;329:337</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6014895">tw</span><span class="op" id="6014897">.</span><span class="ident" id="6014898">numeric</span><span class="op" id="6014905">(</span><span class="ident" id="6014906">s</span><span class="op" id="6014907">.</span><span class="ident" id="6014908">next</span><span class="op" id="6014912">(</span><span class="num" id="6014913">8</span><span class="op" id="6014914">)</span><span class="op" id="6014915">,</span>&nbsp;<span class="ident" id="6014917">hdr</span><span class="op" id="6014920">.</span><span class="ident" id="6014921">Devminor</span><span class="op" id="6014929">,</span>&nbsp;<span class="builtintype" id="6014931">false</span><span class="op" id="6014936">,</span>&nbsp;<span class="ident" id="6014938">paxNone</span><span class="op" id="6014945">,</span>&nbsp;<span class="ident" id="6014947">nil</span><span class="op" id="6014950">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6014957">//&nbsp;337:345</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6014970">//&nbsp;keep&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;prefix&nbsp;to&nbsp;allow&nbsp;to&nbsp;overwrite&nbsp;it&nbsp;later&nbsp;if&nbsp;we&nbsp;detect&nbsp;that&nbsp;we&nbsp;can&nbsp;use&nbsp;ustar&nbsp;longnames&nbsp;instead&nbsp;of&nbsp;pax</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6015096">prefixHeaderBytes</span>&nbsp;<span class="op" id="6015114">:=</span>&nbsp;<span class="ident" id="6015117">s</span><span class="op" id="6015118">.</span><span class="ident" id="6015119">next</span><span class="op" id="6015123">(</span><span class="num" id="6015124">155</span><span class="op" id="6015127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6015130">tw</span><span class="op" id="6015132">.</span><span class="ident" id="6015133">cString</span><span class="op" id="6015140">(</span><span class="ident" id="6015141">prefixHeaderBytes</span><span class="op" id="6015158">,</span>&nbsp;<span class="string" id="6015160">&#34;&#34;</span><span class="op" id="6015162">,</span>&nbsp;<span class="builtintype" id="6015164">false</span><span class="op" id="6015169">,</span>&nbsp;<span class="ident" id="6015171">paxNone</span><span class="op" id="6015178">,</span>&nbsp;<span class="ident" id="6015180">nil</span><span class="op" id="6015183">)</span>&nbsp;<span class="comment" id="6015185">//&nbsp;345:500&nbsp;&nbsp;prefix</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6015206">//&nbsp;Use&nbsp;the&nbsp;GNU&nbsp;magic&nbsp;instead&nbsp;of&nbsp;POSIX&nbsp;magic&nbsp;if&nbsp;we&nbsp;used&nbsp;any&nbsp;GNU&nbsp;extensions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6015282">if</span>&nbsp;<span class="ident" id="6015285">tw</span><span class="op" id="6015287">.</span><span class="ident" id="6015288">usedBinary</span>&nbsp;<span class="op" id="6015299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6015303">copy</span><span class="op" id="6015307">(</span><span class="ident" id="6015308">header</span><span class="op" id="6015314">[</span><span class="num" id="6015315">257</span><span class="op" id="6015318">:</span><span class="num" id="6015319">265</span><span class="op" id="6015322">]</span><span class="op" id="6015323">,</span>&nbsp;<span class="op" id="6015325">[</span><span class="op" id="6015326">]</span><span class="builtintype" id="6015327">byte</span><span class="op" id="6015331">(</span><span class="string" id="6015332">&#34;ustar&nbsp;&nbsp;\x00&#34;</span><span class="op" id="6015345">)</span><span class="op" id="6015346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6015349">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6015353">_</span><span class="op" id="6015354">,</span>&nbsp;<span class="ident" id="6015356">paxPathUsed</span>&nbsp;<span class="op" id="6015368">:=</span>&nbsp;<span class="ident" id="6015371">paxHeaders</span><span class="op" id="6015381">[</span><span class="ident" id="6015382">paxPath</span><span class="op" id="6015389">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6015392">//&nbsp;try&nbsp;to&nbsp;use&nbsp;a&nbsp;ustar&nbsp;header&nbsp;when&nbsp;only&nbsp;the&nbsp;name&nbsp;is&nbsp;too&nbsp;long</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6015453">if</span>&nbsp;<span class="op" id="6015456">!</span><span class="ident" id="6015457">tw</span><span class="op" id="6015459">.</span><span class="ident" id="6015460">preferPax</span>&nbsp;<span class="op" id="6015470">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="6015473">len</span><span class="op" id="6015476">(</span><span class="ident" id="6015477">paxHeaders</span><span class="op" id="6015487">)</span>&nbsp;<span class="op" id="6015489">==</span>&nbsp;<span class="num" id="6015492">1</span>&nbsp;<span class="op" id="6015494">&amp;&amp;</span>&nbsp;<span class="ident" id="6015497">paxPathUsed</span>&nbsp;<span class="op" id="6015509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6015513">suffix</span>&nbsp;<span class="op" id="6015520">:=</span>&nbsp;<span class="ident" id="6015523">hdr</span><span class="op" id="6015526">.</span><span class="ident" id="6015527">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6015534">prefix</span>&nbsp;<span class="op" id="6015541">:=</span>&nbsp;<span class="string" id="6015544">&#34;&#34;</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6015549">if</span>&nbsp;<span class="builtinfunc" id="6015552">len</span><span class="op" id="6015555">(</span><span class="ident" id="6015556">hdr</span><span class="op" id="6015559">.</span><span class="ident" id="6015560">Name</span><span class="op" id="6015564">)</span>&nbsp;<span class="op" id="6015566">&gt;</span>&nbsp;<span class="ident" id="6015568">fileNameSize</span>&nbsp;<span class="op" id="6015581">&amp;&amp;</span>&nbsp;<span class="ident" id="6015584">isASCII</span><span class="op" id="6015591">(</span><span class="ident" id="6015592">hdr</span><span class="op" id="6015595">.</span><span class="ident" id="6015596">Name</span><span class="op" id="6015600">)</span>&nbsp;<span class="op" id="6015602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6015607">var</span>&nbsp;<span class="ident" id="6015611">err</span>&nbsp;<span class="builtintype" id="6015615">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6015624">prefix</span><span class="op" id="6015630">,</span>&nbsp;<span class="ident" id="6015632">suffix</span><span class="op" id="6015638">,</span>&nbsp;<span class="ident" id="6015640">err</span>&nbsp;<span class="op" id="6015644">=</span>&nbsp;<span class="ident" id="6015646">tw</span><span class="op" id="6015648">.</span><span class="ident" id="6015649">splitUSTARLongName</span><span class="op" id="6015667">(</span><span class="ident" id="6015668">hdr</span><span class="op" id="6015671">.</span><span class="ident" id="6015672">Name</span><span class="op" id="6015676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6015681">if</span>&nbsp;<span class="ident" id="6015684">err</span>&nbsp;<span class="op" id="6015688">==</span>&nbsp;<span class="ident" id="6015691">nil</span>&nbsp;<span class="op" id="6015695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6015701">//&nbsp;ok&nbsp;we&nbsp;can&nbsp;use&nbsp;a&nbsp;ustar&nbsp;long&nbsp;name&nbsp;instead&nbsp;of&nbsp;pax,&nbsp;now&nbsp;correct&nbsp;the&nbsp;fields</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6015780">//&nbsp;remove&nbsp;the&nbsp;path&nbsp;field&nbsp;from&nbsp;the&nbsp;pax&nbsp;header.&nbsp;this&nbsp;will&nbsp;suppress&nbsp;the&nbsp;pax&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6015864">delete</span><span class="op" id="6015870">(</span><span class="ident" id="6015871">paxHeaders</span><span class="op" id="6015881">,</span>&nbsp;<span class="ident" id="6015883">paxPath</span><span class="op" id="6015890">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6015897">//&nbsp;update&nbsp;the&nbsp;path&nbsp;fields</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6015927">tw</span><span class="op" id="6015929">.</span><span class="ident" id="6015930">cString</span><span class="op" id="6015937">(</span><span class="ident" id="6015938">pathHeaderBytes</span><span class="op" id="6015953">,</span>&nbsp;<span class="ident" id="6015955">suffix</span><span class="op" id="6015961">,</span>&nbsp;<span class="builtintype" id="6015963">false</span><span class="op" id="6015968">,</span>&nbsp;<span class="ident" id="6015970">paxNone</span><span class="op" id="6015977">,</span>&nbsp;<span class="ident" id="6015979">nil</span><span class="op" id="6015982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6015988">tw</span><span class="op" id="6015990">.</span><span class="ident" id="6015991">cString</span><span class="op" id="6015998">(</span><span class="ident" id="6015999">prefixHeaderBytes</span><span class="op" id="6016016">,</span>&nbsp;<span class="ident" id="6016018">prefix</span><span class="op" id="6016024">,</span>&nbsp;<span class="builtintype" id="6016026">false</span><span class="op" id="6016031">,</span>&nbsp;<span class="ident" id="6016033">paxNone</span><span class="op" id="6016040">,</span>&nbsp;<span class="ident" id="6016042">nil</span><span class="op" id="6016045">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6016052">//&nbsp;Use&nbsp;the&nbsp;ustar&nbsp;magic&nbsp;if&nbsp;we&nbsp;used&nbsp;ustar&nbsp;long&nbsp;names.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6016108">if</span>&nbsp;<span class="builtinfunc" id="6016111">len</span><span class="op" id="6016114">(</span><span class="ident" id="6016115">prefix</span><span class="op" id="6016121">)</span>&nbsp;<span class="op" id="6016123">&gt;</span>&nbsp;<span class="num" id="6016125">0</span>&nbsp;<span class="op" id="6016127">&amp;&amp;</span>&nbsp;<span class="op" id="6016130">!</span><span class="ident" id="6016131">tw</span><span class="op" id="6016133">.</span><span class="ident" id="6016134">usedBinary</span>&nbsp;<span class="op" id="6016145">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6016152">copy</span><span class="op" id="6016156">(</span><span class="ident" id="6016157">header</span><span class="op" id="6016163">[</span><span class="num" id="6016164">257</span><span class="op" id="6016167">:</span><span class="num" id="6016168">265</span><span class="op" id="6016171">]</span><span class="op" id="6016172">,</span>&nbsp;<span class="op" id="6016174">[</span><span class="op" id="6016175">]</span><span class="builtintype" id="6016176">byte</span><span class="op" id="6016180">(</span><span class="string" id="6016181">&#34;ustar\x00&#34;</span><span class="op" id="6016192">)</span><span class="op" id="6016193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6016199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6016204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6016208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6016211">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6016215">//&nbsp;The&nbsp;chksum&nbsp;field&nbsp;is&nbsp;terminated&nbsp;by&nbsp;a&nbsp;NUL&nbsp;and&nbsp;a&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6016272">//&nbsp;This&nbsp;is&nbsp;different&nbsp;from&nbsp;the&nbsp;other&nbsp;octal&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6016323">chksum</span><span class="op" id="6016329">,</span>&nbsp;<span class="ident" id="6016331">_</span>&nbsp;<span class="op" id="6016333">:=</span>&nbsp;<span class="ident" id="6016336">checksum</span><span class="op" id="6016344">(</span><span class="ident" id="6016345">header</span><span class="op" id="6016351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6016354">tw</span><span class="op" id="6016356">.</span><span class="ident" id="6016357">octal</span><span class="op" id="6016362">(</span><span class="ident" id="6016363">header</span><span class="op" id="6016369">[</span><span class="num" id="6016370">148</span><span class="op" id="6016373">:</span><span class="num" id="6016374">155</span><span class="op" id="6016377">]</span><span class="op" id="6016378">,</span>&nbsp;<span class="ident" id="6016380">chksum</span><span class="op" id="6016386">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6016389">header</span><span class="op" id="6016395">[</span><span class="num" id="6016396">155</span><span class="op" id="6016399">]</span>&nbsp;<span class="op" id="6016401">=</span>&nbsp;<span class="string" id="6016403">&#39;&nbsp;&#39;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6016409">if</span>&nbsp;<span class="ident" id="6016412">tw</span><span class="op" id="6016414">.</span><span class="ident" id="6016415">err</span>&nbsp;<span class="op" id="6016419">!=</span>&nbsp;<span class="ident" id="6016422">nil</span>&nbsp;<span class="op" id="6016426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6016430">//&nbsp;problem&nbsp;with&nbsp;header;&nbsp;probably&nbsp;integer&nbsp;too&nbsp;big&nbsp;for&nbsp;a&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6016494">return</span>&nbsp;<span class="ident" id="6016501">tw</span><span class="op" id="6016503">.</span><span class="ident" id="6016504">err</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6016509">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6016513">if</span>&nbsp;<span class="ident" id="6016516">allowPax</span>&nbsp;<span class="op" id="6016525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6016529">for</span>&nbsp;<span class="ident" id="6016533">k</span><span class="op" id="6016534">,</span>&nbsp;<span class="ident" id="6016536">v</span>&nbsp;<span class="op" id="6016538">:=</span>&nbsp;<span class="keyword" id="6016541">range</span>&nbsp;<span class="ident" id="6016547">hdr</span><span class="op" id="6016550">.</span><span class="ident" id="6016551">Xattrs</span>&nbsp;<span class="op" id="6016558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6016563">paxHeaders</span><span class="op" id="6016573">[</span><span class="ident" id="6016574">paxXattr</span><span class="op" id="6016582">+</span><span class="ident" id="6016583">k</span><span class="op" id="6016584">]</span>&nbsp;<span class="op" id="6016586">=</span>&nbsp;<span class="ident" id="6016588">v</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6016592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6016595">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6016599">if</span>&nbsp;<span class="builtinfunc" id="6016602">len</span><span class="op" id="6016605">(</span><span class="ident" id="6016606">paxHeaders</span><span class="op" id="6016616">)</span>&nbsp;<span class="op" id="6016618">&gt;</span>&nbsp;<span class="num" id="6016620">0</span>&nbsp;<span class="op" id="6016622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6016626">if</span>&nbsp;<span class="op" id="6016629">!</span><span class="ident" id="6016630">allowPax</span>&nbsp;<span class="op" id="6016639">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6016644">return</span>&nbsp;<span class="ident" id="6016651">errInvalidHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6016670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6016674">if</span>&nbsp;<span class="ident" id="6016677">err</span>&nbsp;<span class="op" id="6016681">:=</span>&nbsp;<span class="ident" id="6016684">tw</span><span class="op" id="6016686">.</span><span class="ident" id="6016687">writePAXHeader</span><span class="op" id="6016701">(</span><span class="ident" id="6016702">hdr</span><span class="op" id="6016705">,</span>&nbsp;<span class="ident" id="6016707">paxHeaders</span><span class="op" id="6016717">)</span><span class="op" id="6016718">;</span>&nbsp;<span class="ident" id="6016720">err</span>&nbsp;<span class="op" id="6016724">!=</span>&nbsp;<span class="ident" id="6016727">nil</span>&nbsp;<span class="op" id="6016731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6016736">return</span>&nbsp;<span class="ident" id="6016743">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6016749">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6016752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6016755">tw</span><span class="op" id="6016757">.</span><span class="ident" id="6016758">nb</span>&nbsp;<span class="op" id="6016761">=</span>&nbsp;<span class="ident" id="6016763">int64</span><span class="op" id="6016768">(</span><span class="ident" id="6016769">hdr</span><span class="op" id="6016772">.</span><span class="ident" id="6016773">Size</span><span class="op" id="6016777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6016780">tw</span><span class="op" id="6016782">.</span><span class="ident" id="6016783">pad</span>&nbsp;<span class="op" id="6016787">=</span>&nbsp;<span class="op" id="6016789">(</span><span class="ident" id="6016790">blockSize</span>&nbsp;<span class="op" id="6016800">-</span>&nbsp;<span class="op" id="6016802">(</span><span class="ident" id="6016803">tw</span><span class="op" id="6016805">.</span><span class="ident" id="6016806">nb</span>&nbsp;<span class="op" id="6016809">%</span>&nbsp;<span class="ident" id="6016811">blockSize</span><span class="op" id="6016820">)</span><span class="op" id="6016821">)</span>&nbsp;<span class="op" id="6016823">%</span>&nbsp;<span class="ident" id="6016825">blockSize</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6016837">_</span><span class="op" id="6016838">,</span>&nbsp;<span class="ident" id="6016840">tw</span><span class="op" id="6016842">.</span><span class="ident" id="6016843">err</span>&nbsp;<span class="op" id="6016847">=</span>&nbsp;<span class="ident" id="6016849">tw</span><span class="op" id="6016851">.</span><span class="ident" id="6016852">w</span><span class="op" id="6016853">.</span><span class="ident" id="6016854">Write</span><span class="op" id="6016859">(</span><span class="ident" id="6016860">header</span><span class="op" id="6016866">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6016869">return</span>&nbsp;<span class="ident" id="6016876">tw</span><span class="op" id="6016878">.</span><span class="ident" id="6016879">err</span><br>
<span class="lineno"></span><span class="op" id="6016883">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6016886">//&nbsp;writeUSTARLongName&nbsp;splits&nbsp;a&nbsp;USTAR&nbsp;long&nbsp;name&nbsp;hdr.Name.</span><br>
<span class="lineno"></span><span class="comment" id="6016943">//&nbsp;name&nbsp;must&nbsp;be&nbsp;&lt;&nbsp;256&nbsp;characters.&nbsp;errNameTooLong&nbsp;is&nbsp;returned</span><br>
<span class="lineno">275</span><span class="comment" id="6017004">//&nbsp;if&nbsp;hdr.Name&nbsp;can&#39;t&nbsp;be&nbsp;split.&nbsp;The&nbsp;splitting&nbsp;heuristic</span><br>
<span class="lineno"></span><span class="comment" id="6017059">//&nbsp;is&nbsp;compatible&nbsp;with&nbsp;gnu&nbsp;tar.</span><br>
<span class="lineno"></span><span class="keyword" id="6017090">func</span>&nbsp;<span class="op" id="6017095">(</span><span class="ident" id="6017096">tw</span>&nbsp;<span class="op" id="6017099">*</span><span class="ident" id="6017100">Writer</span><span class="op" id="6017106">)</span>&nbsp;<span class="ident" id="6017108">splitUSTARLongName</span><span class="op" id="6017126">(</span><span class="ident" id="6017127">name</span>&nbsp;<span class="builtintype" id="6017132">string</span><span class="op" id="6017138">)</span>&nbsp;<span class="op" id="6017140">(</span><span class="ident" id="6017141">prefix</span><span class="op" id="6017147">,</span>&nbsp;<span class="ident" id="6017149">suffix</span>&nbsp;<span class="builtintype" id="6017156">string</span><span class="op" id="6017162">,</span>&nbsp;<span class="ident" id="6017164">err</span>&nbsp;<span class="builtintype" id="6017168">error</span><span class="op" id="6017173">)</span>&nbsp;<span class="op" id="6017175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017178">length</span>&nbsp;<span class="op" id="6017185">:=</span>&nbsp;<span class="builtinfunc" id="6017188">len</span><span class="op" id="6017191">(</span><span class="ident" id="6017192">name</span><span class="op" id="6017196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6017199">if</span>&nbsp;<span class="ident" id="6017202">length</span>&nbsp;<span class="op" id="6017209">&gt;</span>&nbsp;<span class="ident" id="6017211">fileNamePrefixSize</span><span class="op" id="6017229">+</span><span class="num" id="6017230">1</span>&nbsp;<span class="op" id="6017232">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017236">length</span>&nbsp;<span class="op" id="6017243">=</span>&nbsp;<span class="ident" id="6017245">fileNamePrefixSize</span>&nbsp;<span class="op" id="6017264">+</span>&nbsp;<span class="num" id="6017266">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6017269">}</span>&nbsp;<span class="keyword" id="6017271">else</span>&nbsp;<span class="keyword" id="6017276">if</span>&nbsp;<span class="ident" id="6017279">name</span><span class="op" id="6017283">[</span><span class="ident" id="6017284">length</span><span class="op" id="6017290">-</span><span class="num" id="6017291">1</span><span class="op" id="6017292">]</span>&nbsp;<span class="op" id="6017294">==</span>&nbsp;<span class="string" id="6017297">&#39;/&#39;</span>&nbsp;<span class="op" id="6017301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017305">length</span><span class="op" id="6017311">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6017315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017318">i</span>&nbsp;<span class="op" id="6017320">:=</span>&nbsp;<span class="ident" id="6017323">strings</span><span class="op" id="6017330">.</span><span class="ident" id="6017331">LastIndex</span><span class="op" id="6017340">(</span><span class="ident" id="6017341">name</span><span class="op" id="6017345">[</span><span class="op" id="6017346">:</span><span class="ident" id="6017347">length</span><span class="op" id="6017353">]</span><span class="op" id="6017354">,</span>&nbsp;<span class="string" id="6017356">&#34;/&#34;</span><span class="op" id="6017359">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6017362">//&nbsp;nlen&nbsp;contains&nbsp;the&nbsp;resulting&nbsp;length&nbsp;in&nbsp;the&nbsp;name&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6017420">//&nbsp;plen&nbsp;contains&nbsp;the&nbsp;resulting&nbsp;length&nbsp;in&nbsp;the&nbsp;prefix&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017480">nlen</span>&nbsp;<span class="op" id="6017485">:=</span>&nbsp;<span class="builtinfunc" id="6017488">len</span><span class="op" id="6017491">(</span><span class="ident" id="6017492">name</span><span class="op" id="6017496">)</span>&nbsp;<span class="op" id="6017498">-</span>&nbsp;<span class="ident" id="6017500">i</span>&nbsp;<span class="op" id="6017502">-</span>&nbsp;<span class="num" id="6017504">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017507">plen</span>&nbsp;<span class="op" id="6017512">:=</span>&nbsp;<span class="ident" id="6017515">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6017518">if</span>&nbsp;<span class="ident" id="6017521">i</span>&nbsp;<span class="op" id="6017523">&lt;=</span>&nbsp;<span class="num" id="6017526">0</span>&nbsp;<span class="op" id="6017528">||</span>&nbsp;<span class="ident" id="6017531">nlen</span>&nbsp;<span class="op" id="6017536">&gt;</span>&nbsp;<span class="ident" id="6017538">fileNameSize</span>&nbsp;<span class="op" id="6017551">||</span>&nbsp;<span class="ident" id="6017554">nlen</span>&nbsp;<span class="op" id="6017559">==</span>&nbsp;<span class="num" id="6017562">0</span>&nbsp;<span class="op" id="6017564">||</span>&nbsp;<span class="ident" id="6017567">plen</span>&nbsp;<span class="op" id="6017572">&gt;</span>&nbsp;<span class="ident" id="6017574">fileNamePrefixSize</span>&nbsp;<span class="op" id="6017593">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017597">err</span>&nbsp;<span class="op" id="6017601">=</span>&nbsp;<span class="ident" id="6017603">errNameTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6017620">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6017628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017631">prefix</span><span class="op" id="6017637">,</span>&nbsp;<span class="ident" id="6017639">suffix</span>&nbsp;<span class="op" id="6017646">=</span>&nbsp;<span class="ident" id="6017648">name</span><span class="op" id="6017652">[</span><span class="op" id="6017653">:</span><span class="ident" id="6017654">i</span><span class="op" id="6017655">]</span><span class="op" id="6017656">,</span>&nbsp;<span class="ident" id="6017658">name</span><span class="op" id="6017662">[</span><span class="ident" id="6017663">i</span><span class="op" id="6017664">+</span><span class="num" id="6017665">1</span><span class="op" id="6017666">:</span><span class="op" id="6017667">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6017670">return</span><br>
<span class="lineno">295</span><span class="op" id="6017677">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6017680">//&nbsp;writePaxHeader&nbsp;writes&nbsp;an&nbsp;extended&nbsp;pax&nbsp;header&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6017735">//&nbsp;archive.</span><br>
<span class="lineno"></span><span class="keyword" id="6017747">func</span>&nbsp;<span class="op" id="6017752">(</span><span class="ident" id="6017753">tw</span>&nbsp;<span class="op" id="6017756">*</span><span class="ident" id="6017757">Writer</span><span class="op" id="6017763">)</span>&nbsp;<span class="ident" id="6017765">writePAXHeader</span><span class="op" id="6017779">(</span><span class="ident" id="6017780">hdr</span>&nbsp;<span class="op" id="6017784">*</span><span class="ident" id="6017785">Header</span><span class="op" id="6017791">,</span>&nbsp;<span class="ident" id="6017793">paxHeaders</span>&nbsp;<span class="keyword" id="6017804">map</span><span class="op" id="6017807">[</span><span class="builtintype" id="6017808">string</span><span class="op" id="6017814">]</span><span class="builtintype" id="6017815">string</span><span class="op" id="6017821">)</span>&nbsp;<span class="builtintype" id="6017823">error</span>&nbsp;<span class="op" id="6017829">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6017832">//&nbsp;Prepare&nbsp;extended&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017860">ext</span>&nbsp;<span class="op" id="6017864">:=</span>&nbsp;<span class="builtinfunc" id="6017867">new</span><span class="op" id="6017870">(</span><span class="ident" id="6017871">Header</span><span class="op" id="6017877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017880">ext</span><span class="op" id="6017883">.</span><span class="ident" id="6017884">Typeflag</span>&nbsp;<span class="op" id="6017893">=</span>&nbsp;<span class="ident" id="6017895">TypeXHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6017908">//&nbsp;Setting&nbsp;ModTime&nbsp;is&nbsp;required&nbsp;for&nbsp;reader&nbsp;parsing&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6017962">//&nbsp;succeed,&nbsp;and&nbsp;seems&nbsp;harmless&nbsp;enough.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6018002">ext</span><span class="op" id="6018005">.</span><span class="ident" id="6018006">ModTime</span>&nbsp;<span class="op" id="6018014">=</span>&nbsp;<span class="ident" id="6018016">hdr</span><span class="op" id="6018019">.</span><span class="ident" id="6018020">ModTime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6018029">//&nbsp;The&nbsp;spec&nbsp;asks&nbsp;that&nbsp;we&nbsp;namespace&nbsp;our&nbsp;pseudo&nbsp;files</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6018082">//&nbsp;with&nbsp;the&nbsp;current&nbsp;pid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6018108">pid</span>&nbsp;<span class="op" id="6018112">:=</span>&nbsp;<span class="ident" id="6018115">os</span><span class="op" id="6018117">.</span><span class="ident" id="6018118">Getpid</span><span class="op" id="6018124">(</span><span class="op" id="6018125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6018128">dir</span><span class="op" id="6018131">,</span>&nbsp;<span class="ident" id="6018133">file</span>&nbsp;<span class="op" id="6018138">:=</span>&nbsp;<span class="ident" id="6018141">path</span><span class="op" id="6018145">.</span><span class="ident" id="6018146">Split</span><span class="op" id="6018151">(</span><span class="ident" id="6018152">hdr</span><span class="op" id="6018155">.</span><span class="ident" id="6018156">Name</span><span class="op" id="6018160">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6018163">fullName</span>&nbsp;<span class="op" id="6018172">:=</span>&nbsp;<span class="ident" id="6018175">path</span><span class="op" id="6018179">.</span><span class="ident" id="6018180">Join</span><span class="op" id="6018184">(</span><span class="ident" id="6018185">dir</span><span class="op" id="6018188">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6018192">fmt</span><span class="op" id="6018195">.</span><span class="ident" id="6018196">Sprintf</span><span class="op" id="6018203">(</span><span class="string" id="6018204">&#34;PaxHeaders.%d&#34;</span><span class="op" id="6018219">,</span>&nbsp;<span class="ident" id="6018221">pid</span><span class="op" id="6018224">)</span><span class="op" id="6018225">,</span>&nbsp;<span class="ident" id="6018227">file</span><span class="op" id="6018231">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6018235">ascii</span>&nbsp;<span class="op" id="6018241">:=</span>&nbsp;<span class="ident" id="6018244">toASCII</span><span class="op" id="6018251">(</span><span class="ident" id="6018252">fullName</span><span class="op" id="6018260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6018263">if</span>&nbsp;<span class="builtinfunc" id="6018266">len</span><span class="op" id="6018269">(</span><span class="ident" id="6018270">ascii</span><span class="op" id="6018275">)</span>&nbsp;<span class="op" id="6018277">&gt;</span>&nbsp;<span class="num" id="6018279">100</span>&nbsp;<span class="op" id="6018283">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6018287">ascii</span>&nbsp;<span class="op" id="6018293">=</span>&nbsp;<span class="ident" id="6018295">ascii</span><span class="op" id="6018300">[</span><span class="op" id="6018301">:</span><span class="num" id="6018302">100</span><span class="op" id="6018305">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6018308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6018311">ext</span><span class="op" id="6018314">.</span><span class="ident" id="6018315">Name</span>&nbsp;<span class="op" id="6018320">=</span>&nbsp;<span class="ident" id="6018322">ascii</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6018329">//&nbsp;Construct&nbsp;the&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6018352">var</span>&nbsp;<span class="ident" id="6018356">buf</span>&nbsp;<span class="ident" id="6018360">bytes</span><span class="op" id="6018365">.</span><span class="ident" id="6018366">Buffer</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6018375">for</span>&nbsp;<span class="ident" id="6018379">k</span><span class="op" id="6018380">,</span>&nbsp;<span class="ident" id="6018382">v</span>&nbsp;<span class="op" id="6018384">:=</span>&nbsp;<span class="keyword" id="6018387">range</span>&nbsp;<span class="ident" id="6018393">paxHeaders</span>&nbsp;<span class="op" id="6018404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6018408">fmt</span><span class="op" id="6018411">.</span><span class="ident" id="6018412">Fprint</span><span class="op" id="6018418">(</span><span class="op" id="6018419">&amp;</span><span class="ident" id="6018420">buf</span><span class="op" id="6018423">,</span>&nbsp;<span class="ident" id="6018425">paxHeader</span><span class="op" id="6018434">(</span><span class="ident" id="6018435">k</span><span class="op" id="6018436">+</span><span class="string" id="6018437">&#34;=&#34;</span><span class="op" id="6018440">+</span><span class="ident" id="6018441">v</span><span class="op" id="6018442">)</span><span class="op" id="6018443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6018446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6018450">ext</span><span class="op" id="6018453">.</span><span class="ident" id="6018454">Size</span>&nbsp;<span class="op" id="6018459">=</span>&nbsp;<span class="ident" id="6018461">int64</span><span class="op" id="6018466">(</span><span class="builtinfunc" id="6018467">len</span><span class="op" id="6018470">(</span><span class="ident" id="6018471">buf</span><span class="op" id="6018474">.</span><span class="ident" id="6018475">Bytes</span><span class="op" id="6018480">(</span><span class="op" id="6018481">)</span><span class="op" id="6018482">)</span><span class="op" id="6018483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6018486">if</span>&nbsp;<span class="ident" id="6018489">err</span>&nbsp;<span class="op" id="6018493">:=</span>&nbsp;<span class="ident" id="6018496">tw</span><span class="op" id="6018498">.</span><span class="ident" id="6018499">writeHeader</span><span class="op" id="6018510">(</span><span class="ident" id="6018511">ext</span><span class="op" id="6018514">,</span>&nbsp;<span class="builtintype" id="6018516">false</span><span class="op" id="6018521">)</span><span class="op" id="6018522">;</span>&nbsp;<span class="ident" id="6018524">err</span>&nbsp;<span class="op" id="6018528">!=</span>&nbsp;<span class="ident" id="6018531">nil</span>&nbsp;<span class="op" id="6018535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6018539">return</span>&nbsp;<span class="ident" id="6018546">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6018551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6018554">if</span>&nbsp;<span class="ident" id="6018557">_</span><span class="op" id="6018558">,</span>&nbsp;<span class="ident" id="6018560">err</span>&nbsp;<span class="op" id="6018564">:=</span>&nbsp;<span class="ident" id="6018567">tw</span><span class="op" id="6018569">.</span><span class="ident" id="6018570">Write</span><span class="op" id="6018575">(</span><span class="ident" id="6018576">buf</span><span class="op" id="6018579">.</span><span class="ident" id="6018580">Bytes</span><span class="op" id="6018585">(</span><span class="op" id="6018586">)</span><span class="op" id="6018587">)</span><span class="op" id="6018588">;</span>&nbsp;<span class="ident" id="6018590">err</span>&nbsp;<span class="op" id="6018594">!=</span>&nbsp;<span class="ident" id="6018597">nil</span>&nbsp;<span class="op" id="6018601">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6018605">return</span>&nbsp;<span class="ident" id="6018612">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6018617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6018620">if</span>&nbsp;<span class="ident" id="6018623">err</span>&nbsp;<span class="op" id="6018627">:=</span>&nbsp;<span class="ident" id="6018630">tw</span><span class="op" id="6018632">.</span><span class="ident" id="6018633">Flush</span><span class="op" id="6018638">(</span><span class="op" id="6018639">)</span><span class="op" id="6018640">;</span>&nbsp;<span class="ident" id="6018642">err</span>&nbsp;<span class="op" id="6018646">!=</span>&nbsp;<span class="ident" id="6018649">nil</span>&nbsp;<span class="op" id="6018653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6018657">return</span>&nbsp;<span class="ident" id="6018664">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6018669">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6018672">return</span>&nbsp;<span class="ident" id="6018679">nil</span><br>
<span class="lineno"></span><span class="op" id="6018683">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6018686">//&nbsp;paxHeader&nbsp;formats&nbsp;a&nbsp;single&nbsp;pax&nbsp;record,&nbsp;prefixing&nbsp;it&nbsp;with&nbsp;the&nbsp;appropriate&nbsp;length</span><br>
<span class="lineno"></span><span class="keyword" id="6018769">func</span>&nbsp;<span class="ident" id="6018774">paxHeader</span><span class="op" id="6018783">(</span><span class="ident" id="6018784">msg</span>&nbsp;<span class="builtintype" id="6018788">string</span><span class="op" id="6018794">)</span>&nbsp;<span class="builtintype" id="6018796">string</span>&nbsp;<span class="op" id="6018803">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6018806">const</span>&nbsp;<span class="ident" id="6018812">padding</span>&nbsp;<span class="op" id="6018820">=</span>&nbsp;<span class="num" id="6018822">2</span>&nbsp;<span class="comment" id="6018824">//&nbsp;Extra&nbsp;padding&nbsp;for&nbsp;space&nbsp;and&nbsp;newline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6018864">size</span>&nbsp;<span class="op" id="6018869">:=</span>&nbsp;<span class="builtinfunc" id="6018872">len</span><span class="op" id="6018875">(</span><span class="ident" id="6018876">msg</span><span class="op" id="6018879">)</span>&nbsp;<span class="op" id="6018881">+</span>&nbsp;<span class="ident" id="6018883">padding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6018892">size</span>&nbsp;<span class="op" id="6018897">+=</span>&nbsp;<span class="builtinfunc" id="6018900">len</span><span class="op" id="6018903">(</span><span class="ident" id="6018904">strconv</span><span class="op" id="6018911">.</span><span class="ident" id="6018912">Itoa</span><span class="op" id="6018916">(</span><span class="ident" id="6018917">size</span><span class="op" id="6018921">)</span><span class="op" id="6018922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6018925">record</span>&nbsp;<span class="op" id="6018932">:=</span>&nbsp;<span class="ident" id="6018935">fmt</span><span class="op" id="6018938">.</span><span class="ident" id="6018939">Sprintf</span><span class="op" id="6018946">(</span><span class="string" id="6018947">&#34;%d&nbsp;%s\n&#34;</span><span class="op" id="6018956">,</span>&nbsp;<span class="ident" id="6018958">size</span><span class="op" id="6018962">,</span>&nbsp;<span class="ident" id="6018964">msg</span><span class="op" id="6018967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6018970">if</span>&nbsp;<span class="builtinfunc" id="6018973">len</span><span class="op" id="6018976">(</span><span class="ident" id="6018977">record</span><span class="op" id="6018983">)</span>&nbsp;<span class="op" id="6018985">!=</span>&nbsp;<span class="ident" id="6018988">size</span>&nbsp;<span class="op" id="6018993">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6018997">//&nbsp;Final&nbsp;adjustment&nbsp;if&nbsp;adding&nbsp;size&nbsp;increased</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6019044">//&nbsp;the&nbsp;number&nbsp;of&nbsp;digits&nbsp;in&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6019078">size</span>&nbsp;<span class="op" id="6019083">=</span>&nbsp;<span class="builtinfunc" id="6019085">len</span><span class="op" id="6019088">(</span><span class="ident" id="6019089">record</span><span class="op" id="6019095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6019099">record</span>&nbsp;<span class="op" id="6019106">=</span>&nbsp;<span class="ident" id="6019108">fmt</span><span class="op" id="6019111">.</span><span class="ident" id="6019112">Sprintf</span><span class="op" id="6019119">(</span><span class="string" id="6019120">&#34;%d&nbsp;%s\n&#34;</span><span class="op" id="6019129">,</span>&nbsp;<span class="ident" id="6019131">size</span><span class="op" id="6019135">,</span>&nbsp;<span class="ident" id="6019137">msg</span><span class="op" id="6019140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6019143">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6019146">return</span>&nbsp;<span class="ident" id="6019153">record</span><br>
<span class="lineno"></span><span class="op" id="6019160">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6019163">//&nbsp;Write&nbsp;writes&nbsp;to&nbsp;the&nbsp;current&nbsp;entry&nbsp;in&nbsp;the&nbsp;tar&nbsp;archive.</span><br>
<span class="lineno"></span><span class="comment" id="6019220">//&nbsp;Write&nbsp;returns&nbsp;the&nbsp;error&nbsp;ErrWriteTooLong&nbsp;if&nbsp;more&nbsp;than</span><br>
<span class="lineno">355</span><span class="comment" id="6019276">//&nbsp;hdr.Size&nbsp;bytes&nbsp;are&nbsp;written&nbsp;after&nbsp;WriteHeader.</span><br>
<span class="lineno"></span><span class="keyword" id="6019325">func</span>&nbsp;<span class="op" id="6019330">(</span><span class="ident" id="6019331">tw</span>&nbsp;<span class="op" id="6019334">*</span><span class="ident" id="6019335">Writer</span><span class="op" id="6019341">)</span>&nbsp;<span class="ident" id="6019343">Write</span><span class="op" id="6019348">(</span><span class="ident" id="6019349">b</span>&nbsp;<span class="op" id="6019351">[</span><span class="op" id="6019352">]</span><span class="builtintype" id="6019353">byte</span><span class="op" id="6019357">)</span>&nbsp;<span class="op" id="6019359">(</span><span class="ident" id="6019360">n</span>&nbsp;<span class="builtintype" id="6019362">int</span><span class="op" id="6019365">,</span>&nbsp;<span class="ident" id="6019367">err</span>&nbsp;<span class="builtintype" id="6019371">error</span><span class="op" id="6019376">)</span>&nbsp;<span class="op" id="6019378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6019381">if</span>&nbsp;<span class="ident" id="6019384">tw</span><span class="op" id="6019386">.</span><span class="ident" id="6019387">closed</span>&nbsp;<span class="op" id="6019394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6019398">err</span>&nbsp;<span class="op" id="6019402">=</span>&nbsp;<span class="ident" id="6019404">ErrWriteTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6019422">return</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6019430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6019433">overwrite</span>&nbsp;<span class="op" id="6019443">:=</span>&nbsp;<span class="builtintype" id="6019446">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6019453">if</span>&nbsp;<span class="ident" id="6019456">int64</span><span class="op" id="6019461">(</span><span class="builtinfunc" id="6019462">len</span><span class="op" id="6019465">(</span><span class="ident" id="6019466">b</span><span class="op" id="6019467">)</span><span class="op" id="6019468">)</span>&nbsp;<span class="op" id="6019470">&gt;</span>&nbsp;<span class="ident" id="6019472">tw</span><span class="op" id="6019474">.</span><span class="ident" id="6019475">nb</span>&nbsp;<span class="op" id="6019478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6019482">b</span>&nbsp;<span class="op" id="6019484">=</span>&nbsp;<span class="ident" id="6019486">b</span><span class="op" id="6019487">[</span><span class="num" id="6019488">0</span><span class="op" id="6019489">:</span><span class="ident" id="6019490">tw</span><span class="op" id="6019492">.</span><span class="ident" id="6019493">nb</span><span class="op" id="6019495">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6019499">overwrite</span>&nbsp;<span class="op" id="6019509">=</span>&nbsp;<span class="builtintype" id="6019511">true</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6019517">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6019520">n</span><span class="op" id="6019521">,</span>&nbsp;<span class="ident" id="6019523">err</span>&nbsp;<span class="op" id="6019527">=</span>&nbsp;<span class="ident" id="6019529">tw</span><span class="op" id="6019531">.</span><span class="ident" id="6019532">w</span><span class="op" id="6019533">.</span><span class="ident" id="6019534">Write</span><span class="op" id="6019539">(</span><span class="ident" id="6019540">b</span><span class="op" id="6019541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6019544">tw</span><span class="op" id="6019546">.</span><span class="ident" id="6019547">nb</span>&nbsp;<span class="op" id="6019550">-=</span>&nbsp;<span class="ident" id="6019553">int64</span><span class="op" id="6019558">(</span><span class="ident" id="6019559">n</span><span class="op" id="6019560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6019563">if</span>&nbsp;<span class="ident" id="6019566">err</span>&nbsp;<span class="op" id="6019570">==</span>&nbsp;<span class="ident" id="6019573">nil</span>&nbsp;<span class="op" id="6019577">&amp;&amp;</span>&nbsp;<span class="ident" id="6019580">overwrite</span>&nbsp;<span class="op" id="6019590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6019594">err</span>&nbsp;<span class="op" id="6019598">=</span>&nbsp;<span class="ident" id="6019600">ErrWriteTooLong</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6019618">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6019626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6019629">tw</span><span class="op" id="6019631">.</span><span class="ident" id="6019632">err</span>&nbsp;<span class="op" id="6019636">=</span>&nbsp;<span class="ident" id="6019638">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6019643">return</span><br>
<span class="lineno"></span><span class="op" id="6019650">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="comment" id="6019653">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;tar&nbsp;archive,&nbsp;flushing&nbsp;any&nbsp;unwritten</span><br>
<span class="lineno"></span><span class="comment" id="6019709">//&nbsp;data&nbsp;to&nbsp;the&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="6019743">func</span>&nbsp;<span class="op" id="6019748">(</span><span class="ident" id="6019749">tw</span>&nbsp;<span class="op" id="6019752">*</span><span class="ident" id="6019753">Writer</span><span class="op" id="6019759">)</span>&nbsp;<span class="ident" id="6019761">Close</span><span class="op" id="6019766">(</span><span class="op" id="6019767">)</span>&nbsp;<span class="builtintype" id="6019769">error</span>&nbsp;<span class="op" id="6019775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6019778">if</span>&nbsp;<span class="ident" id="6019781">tw</span><span class="op" id="6019783">.</span><span class="ident" id="6019784">err</span>&nbsp;<span class="op" id="6019788">!=</span>&nbsp;<span class="ident" id="6019791">nil</span>&nbsp;<span class="op" id="6019795">||</span>&nbsp;<span class="ident" id="6019798">tw</span><span class="op" id="6019800">.</span><span class="ident" id="6019801">closed</span>&nbsp;<span class="op" id="6019808">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6019812">return</span>&nbsp;<span class="ident" id="6019819">tw</span><span class="op" id="6019821">.</span><span class="ident" id="6019822">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6019827">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6019830">tw</span><span class="op" id="6019832">.</span><span class="ident" id="6019833">Flush</span><span class="op" id="6019838">(</span><span class="op" id="6019839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6019842">tw</span><span class="op" id="6019844">.</span><span class="ident" id="6019845">closed</span>&nbsp;<span class="op" id="6019852">=</span>&nbsp;<span class="builtintype" id="6019854">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6019860">if</span>&nbsp;<span class="ident" id="6019863">tw</span><span class="op" id="6019865">.</span><span class="ident" id="6019866">err</span>&nbsp;<span class="op" id="6019870">!=</span>&nbsp;<span class="ident" id="6019873">nil</span>&nbsp;<span class="op" id="6019877">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6019881">return</span>&nbsp;<span class="ident" id="6019888">tw</span><span class="op" id="6019890">.</span><span class="ident" id="6019891">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6019896">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6019900">//&nbsp;trailer:&nbsp;two&nbsp;zero&nbsp;blocks</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6019929">for</span>&nbsp;<span class="ident" id="6019933">i</span>&nbsp;<span class="op" id="6019935">:=</span>&nbsp;<span class="num" id="6019938">0</span><span class="op" id="6019939">;</span>&nbsp;<span class="ident" id="6019941">i</span>&nbsp;<span class="op" id="6019943">&lt;</span>&nbsp;<span class="num" id="6019945">2</span><span class="op" id="6019946">;</span>&nbsp;<span class="ident" id="6019948">i</span><span class="op" id="6019949">++</span>&nbsp;<span class="op" id="6019952">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6019956">_</span><span class="op" id="6019957">,</span>&nbsp;<span class="ident" id="6019959">tw</span><span class="op" id="6019961">.</span><span class="ident" id="6019962">err</span>&nbsp;<span class="op" id="6019966">=</span>&nbsp;<span class="ident" id="6019968">tw</span><span class="op" id="6019970">.</span><span class="ident" id="6019971">w</span><span class="op" id="6019972">.</span><span class="ident" id="6019973">Write</span><span class="op" id="6019978">(</span><span class="ident" id="6019979">zeroBlock</span><span class="op" id="6019988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6019992">if</span>&nbsp;<span class="ident" id="6019995">tw</span><span class="op" id="6019997">.</span><span class="ident" id="6019998">err</span>&nbsp;<span class="op" id="6020002">!=</span>&nbsp;<span class="ident" id="6020005">nil</span>&nbsp;<span class="op" id="6020009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6020014">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6020022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6020025">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6020028">return</span>&nbsp;<span class="ident" id="6020035">tw</span><span class="op" id="6020037">.</span><span class="ident" id="6020038">err</span><br>
<span class="lineno"></span><span class="op" id="6020042">}</span>
</div>
</body>
</html>
