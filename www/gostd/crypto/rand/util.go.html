<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/rand</h2>
<ul>
<li><a href="/gostd/crypto/rand/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/rand/rand.go.html">rand.go</a></li>
<li><a href="/gostd/crypto/rand/rand_linux.go.html">rand_linux.go</a></li>
<li><a href="/gostd/crypto/rand/rand_test.go.html">rand_test.go</a></li>
<li><a href="/gostd/crypto/rand/rand_unix.go.html">rand_unix.go</a></li>
<li><a href="/gostd/crypto/rand/util.go.html">util.go</a></li>
<li><a href="/gostd/crypto/rand/util_test.go.html">util_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3832818">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3832874">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3832928">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3832979">package</span>&nbsp;<span class="ident" id="3832987">rand</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3832993">import</span>&nbsp;<span class="op" id="3833000">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3833003">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3833013">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3833019">&#34;math/big&#34;</span><br>
<span class="lineno"></span><span class="op" id="3833030">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3833033">//&nbsp;smallPrimes&nbsp;is&nbsp;a&nbsp;list&nbsp;of&nbsp;small,&nbsp;prime&nbsp;numbers&nbsp;that&nbsp;allows&nbsp;us&nbsp;to&nbsp;rapidly</span><br>
<span class="lineno"></span><span class="comment" id="3833108">//&nbsp;exclude&nbsp;some&nbsp;fraction&nbsp;of&nbsp;composite&nbsp;candidates&nbsp;when&nbsp;searching&nbsp;for&nbsp;a&nbsp;random</span><br>
<span class="lineno">15</span><span class="comment" id="3833185">//&nbsp;prime.&nbsp;This&nbsp;list&nbsp;is&nbsp;truncated&nbsp;at&nbsp;the&nbsp;point&nbsp;where&nbsp;smallPrimesProduct&nbsp;exceeds</span><br>
<span class="lineno"></span><span class="comment" id="3833264">//&nbsp;a&nbsp;uint64.&nbsp;It&nbsp;does&nbsp;not&nbsp;include&nbsp;two&nbsp;because&nbsp;we&nbsp;ensure&nbsp;that&nbsp;the&nbsp;candidates&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="3833343">//&nbsp;odd&nbsp;by&nbsp;construction.</span><br>
<span class="lineno"></span><span class="keyword" id="3833367">var</span>&nbsp;<span class="ident" id="3833371">smallPrimes</span>&nbsp;<span class="op" id="3833383">=</span>&nbsp;<span class="op" id="3833385">[</span><span class="op" id="3833386">]</span><span class="builtintype" id="3833387">uint8</span><span class="op" id="3833392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="3833395">3</span><span class="op" id="3833396">,</span>&nbsp;<span class="num" id="3833398">5</span><span class="op" id="3833399">,</span>&nbsp;<span class="num" id="3833401">7</span><span class="op" id="3833402">,</span>&nbsp;<span class="num" id="3833404">11</span><span class="op" id="3833406">,</span>&nbsp;<span class="num" id="3833408">13</span><span class="op" id="3833410">,</span>&nbsp;<span class="num" id="3833412">17</span><span class="op" id="3833414">,</span>&nbsp;<span class="num" id="3833416">19</span><span class="op" id="3833418">,</span>&nbsp;<span class="num" id="3833420">23</span><span class="op" id="3833422">,</span>&nbsp;<span class="num" id="3833424">29</span><span class="op" id="3833426">,</span>&nbsp;<span class="num" id="3833428">31</span><span class="op" id="3833430">,</span>&nbsp;<span class="num" id="3833432">37</span><span class="op" id="3833434">,</span>&nbsp;<span class="num" id="3833436">41</span><span class="op" id="3833438">,</span>&nbsp;<span class="num" id="3833440">43</span><span class="op" id="3833442">,</span>&nbsp;<span class="num" id="3833444">47</span><span class="op" id="3833446">,</span>&nbsp;<span class="num" id="3833448">53</span><span class="op" id="3833450">,</span><br>
<span class="lineno">20</span><span class="op" id="3833452">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3833455">//&nbsp;smallPrimesProduct&nbsp;is&nbsp;the&nbsp;product&nbsp;of&nbsp;the&nbsp;values&nbsp;in&nbsp;smallPrimes&nbsp;and&nbsp;allows&nbsp;us</span><br>
<span class="lineno"></span><span class="comment" id="3833535">//&nbsp;to&nbsp;reduce&nbsp;a&nbsp;candidate&nbsp;prime&nbsp;by&nbsp;this&nbsp;number&nbsp;and&nbsp;then&nbsp;determine&nbsp;whether&nbsp;it&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3833613">//&nbsp;coprime&nbsp;to&nbsp;all&nbsp;the&nbsp;elements&nbsp;of&nbsp;smallPrimes&nbsp;without&nbsp;further&nbsp;big.Int</span><br>
<span class="lineno">25</span><span class="comment" id="3833683">//&nbsp;operations.</span><br>
<span class="lineno"></span><span class="keyword" id="3833698">var</span>&nbsp;<span class="ident" id="3833702">smallPrimesProduct</span>&nbsp;<span class="op" id="3833721">=</span>&nbsp;<span class="builtinfunc" id="3833723">new</span><span class="op" id="3833726">(</span><span class="ident" id="3833727">big</span><span class="op" id="3833730">.</span><span class="ident" id="3833731">Int</span><span class="op" id="3833734">)</span><span class="op" id="3833735">.</span><span class="ident" id="3833736">SetUint64</span><span class="op" id="3833745">(</span><span class="num" id="3833746">16294579238595022365</span><span class="op" id="3833766">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3833769">//&nbsp;Prime&nbsp;returns&nbsp;a&nbsp;number,&nbsp;p,&nbsp;of&nbsp;the&nbsp;given&nbsp;size,&nbsp;such&nbsp;that&nbsp;p&nbsp;is&nbsp;prime</span><br>
<span class="lineno"></span><span class="comment" id="3833839">//&nbsp;with&nbsp;high&nbsp;probability.</span><br>
<span class="lineno">30</span><span class="comment" id="3833865">//&nbsp;Prime&nbsp;will&nbsp;return&nbsp;error&nbsp;for&nbsp;any&nbsp;error&nbsp;returned&nbsp;by&nbsp;rand.Read&nbsp;or&nbsp;if&nbsp;bits&nbsp;&lt;&nbsp;2.</span><br>
<span class="lineno"></span><span class="keyword" id="3833944">func</span>&nbsp;<span class="ident" id="3833949">Prime</span><span class="op" id="3833954">(</span><span class="ident" id="3833955">rand</span>&nbsp;<span class="ident" id="3833960">io</span><span class="op" id="3833962">.</span><span class="ident" id="3833963">Reader</span><span class="op" id="3833969">,</span>&nbsp;<span class="ident" id="3833971">bits</span>&nbsp;<span class="builtintype" id="3833976">int</span><span class="op" id="3833979">)</span>&nbsp;<span class="op" id="3833981">(</span><span class="ident" id="3833982">p</span>&nbsp;<span class="op" id="3833984">*</span><span class="ident" id="3833985">big</span><span class="op" id="3833988">.</span><span class="ident" id="3833989">Int</span><span class="op" id="3833992">,</span>&nbsp;<span class="ident" id="3833994">err</span>&nbsp;<span class="builtintype" id="3833998">error</span><span class="op" id="3834003">)</span>&nbsp;<span class="op" id="3834005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3834008">if</span>&nbsp;<span class="ident" id="3834011">bits</span>&nbsp;<span class="op" id="3834016">&lt;</span>&nbsp;<span class="num" id="3834018">2</span>&nbsp;<span class="op" id="3834020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3834024">err</span>&nbsp;<span class="op" id="3834028">=</span>&nbsp;<span class="ident" id="3834030">errors</span><span class="op" id="3834036">.</span><span class="ident" id="3834037">New</span><span class="op" id="3834040">(</span><span class="string" id="3834041">&#34;crypto/rand:&nbsp;prime&nbsp;size&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;2-bit&#34;</span><span class="op" id="3834089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3834093">return</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3834101">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3834105">b</span>&nbsp;<span class="op" id="3834107">:=</span>&nbsp;<span class="builtintype" id="3834110">uint</span><span class="op" id="3834114">(</span><span class="ident" id="3834115">bits</span>&nbsp;<span class="op" id="3834120">%</span>&nbsp;<span class="num" id="3834122">8</span><span class="op" id="3834123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3834126">if</span>&nbsp;<span class="ident" id="3834129">b</span>&nbsp;<span class="op" id="3834131">==</span>&nbsp;<span class="num" id="3834134">0</span>&nbsp;<span class="op" id="3834136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3834140">b</span>&nbsp;<span class="op" id="3834142">=</span>&nbsp;<span class="num" id="3834144">8</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3834147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3834151">bytes</span>&nbsp;<span class="op" id="3834157">:=</span>&nbsp;<span class="builtinfunc" id="3834160">make</span><span class="op" id="3834164">(</span><span class="op" id="3834165">[</span><span class="op" id="3834166">]</span><span class="builtintype" id="3834167">byte</span><span class="op" id="3834171">,</span>&nbsp;<span class="op" id="3834173">(</span><span class="ident" id="3834174">bits</span><span class="op" id="3834178">+</span><span class="num" id="3834179">7</span><span class="op" id="3834180">)</span><span class="op" id="3834181">/</span><span class="num" id="3834182">8</span><span class="op" id="3834183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3834186">p</span>&nbsp;<span class="op" id="3834188">=</span>&nbsp;<span class="builtinfunc" id="3834190">new</span><span class="op" id="3834193">(</span><span class="ident" id="3834194">big</span><span class="op" id="3834197">.</span><span class="ident" id="3834198">Int</span><span class="op" id="3834201">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3834205">bigMod</span>&nbsp;<span class="op" id="3834212">:=</span>&nbsp;<span class="builtinfunc" id="3834215">new</span><span class="op" id="3834218">(</span><span class="ident" id="3834219">big</span><span class="op" id="3834222">.</span><span class="ident" id="3834223">Int</span><span class="op" id="3834226">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3834230">for</span>&nbsp;<span class="op" id="3834234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3834238">_</span><span class="op" id="3834239">,</span>&nbsp;<span class="ident" id="3834241">err</span>&nbsp;<span class="op" id="3834245">=</span>&nbsp;<span class="ident" id="3834247">io</span><span class="op" id="3834249">.</span><span class="ident" id="3834250">ReadFull</span><span class="op" id="3834258">(</span><span class="ident" id="3834259">rand</span><span class="op" id="3834263">,</span>&nbsp;<span class="ident" id="3834265">bytes</span><span class="op" id="3834270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3834274">if</span>&nbsp;<span class="ident" id="3834277">err</span>&nbsp;<span class="op" id="3834281">!=</span>&nbsp;<span class="ident" id="3834284">nil</span>&nbsp;<span class="op" id="3834288">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3834293">return</span>&nbsp;<span class="ident" id="3834300">nil</span><span class="op" id="3834303">,</span>&nbsp;<span class="ident" id="3834305">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3834311">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3834316">//&nbsp;Clear&nbsp;bits&nbsp;in&nbsp;the&nbsp;first&nbsp;byte&nbsp;to&nbsp;make&nbsp;sure&nbsp;the&nbsp;candidate&nbsp;has&nbsp;a&nbsp;size&nbsp;&lt;=&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3834397">bytes</span><span class="op" id="3834402">[</span><span class="num" id="3834403">0</span><span class="op" id="3834404">]</span>&nbsp;<span class="op" id="3834406">&amp;=</span>&nbsp;<span class="builtintype" id="3834409">uint8</span><span class="op" id="3834414">(</span><span class="builtintype" id="3834415">int</span><span class="op" id="3834418">(</span><span class="num" id="3834419">1</span><span class="op" id="3834420">&lt;&lt;</span><span class="ident" id="3834422">b</span><span class="op" id="3834423">)</span>&nbsp;<span class="op" id="3834425">-</span>&nbsp;<span class="num" id="3834427">1</span><span class="op" id="3834428">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3834432">//&nbsp;Don&#39;t&nbsp;let&nbsp;the&nbsp;value&nbsp;be&nbsp;too&nbsp;small,&nbsp;i.e,&nbsp;set&nbsp;the&nbsp;most&nbsp;significant&nbsp;two&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3834511">//&nbsp;Setting&nbsp;the&nbsp;top&nbsp;two&nbsp;bits,&nbsp;rather&nbsp;than&nbsp;just&nbsp;the&nbsp;top&nbsp;bit,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3834572">//&nbsp;means&nbsp;that&nbsp;when&nbsp;two&nbsp;of&nbsp;these&nbsp;values&nbsp;are&nbsp;multiplied&nbsp;together,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3834638">//&nbsp;the&nbsp;result&nbsp;isn&#39;t&nbsp;ever&nbsp;one&nbsp;bit&nbsp;short.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3834680">if</span>&nbsp;<span class="ident" id="3834683">b</span>&nbsp;<span class="op" id="3834685">&gt;=</span>&nbsp;<span class="num" id="3834688">2</span>&nbsp;<span class="op" id="3834690">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3834695">bytes</span><span class="op" id="3834700">[</span><span class="num" id="3834701">0</span><span class="op" id="3834702">]</span>&nbsp;<span class="op" id="3834704">|=</span>&nbsp;<span class="num" id="3834707">3</span>&nbsp;<span class="op" id="3834709">&lt;&lt;</span>&nbsp;<span class="op" id="3834712">(</span><span class="ident" id="3834713">b</span>&nbsp;<span class="op" id="3834715">-</span>&nbsp;<span class="num" id="3834717">2</span><span class="op" id="3834718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3834722">}</span>&nbsp;<span class="keyword" id="3834724">else</span>&nbsp;<span class="op" id="3834729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3834734">//&nbsp;Here&nbsp;b==1,&nbsp;because&nbsp;b&nbsp;cannot&nbsp;be&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3834777">bytes</span><span class="op" id="3834782">[</span><span class="num" id="3834783">0</span><span class="op" id="3834784">]</span>&nbsp;<span class="op" id="3834786">|=</span>&nbsp;<span class="num" id="3834789">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3834794">if</span>&nbsp;<span class="builtinfunc" id="3834797">len</span><span class="op" id="3834800">(</span><span class="ident" id="3834801">bytes</span><span class="op" id="3834806">)</span>&nbsp;<span class="op" id="3834808">&gt;</span>&nbsp;<span class="num" id="3834810">1</span>&nbsp;<span class="op" id="3834812">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3834818">bytes</span><span class="op" id="3834823">[</span><span class="num" id="3834824">1</span><span class="op" id="3834825">]</span>&nbsp;<span class="op" id="3834827">|=</span>&nbsp;<span class="num" id="3834830">0x80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3834838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3834842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3834846">//&nbsp;Make&nbsp;the&nbsp;value&nbsp;odd&nbsp;since&nbsp;an&nbsp;even&nbsp;number&nbsp;this&nbsp;large&nbsp;certainly&nbsp;isn&#39;t&nbsp;prime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3834925">bytes</span><span class="op" id="3834930">[</span><span class="builtinfunc" id="3834931">len</span><span class="op" id="3834934">(</span><span class="ident" id="3834935">bytes</span><span class="op" id="3834940">)</span><span class="op" id="3834941">-</span><span class="num" id="3834942">1</span><span class="op" id="3834943">]</span>&nbsp;<span class="op" id="3834945">|=</span>&nbsp;<span class="num" id="3834948">1</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3834953">p</span><span class="op" id="3834954">.</span><span class="ident" id="3834955">SetBytes</span><span class="op" id="3834963">(</span><span class="ident" id="3834964">bytes</span><span class="op" id="3834969">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3834974">//&nbsp;Calculate&nbsp;the&nbsp;value&nbsp;mod&nbsp;the&nbsp;product&nbsp;of&nbsp;smallPrimes.&nbsp;&nbsp;If&nbsp;it&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3835040">//&nbsp;a&nbsp;multiple&nbsp;of&nbsp;any&nbsp;of&nbsp;these&nbsp;primes&nbsp;we&nbsp;add&nbsp;two&nbsp;until&nbsp;it&nbsp;isn&#39;t.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3835106">//&nbsp;The&nbsp;probability&nbsp;of&nbsp;overflowing&nbsp;is&nbsp;minimal&nbsp;and&nbsp;can&nbsp;be&nbsp;ignored</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3835172">//&nbsp;because&nbsp;we&nbsp;still&nbsp;perform&nbsp;Miller-Rabin&nbsp;tests&nbsp;on&nbsp;the&nbsp;result.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3835236">bigMod</span><span class="op" id="3835242">.</span><span class="ident" id="3835243">Mod</span><span class="op" id="3835246">(</span><span class="ident" id="3835247">p</span><span class="op" id="3835248">,</span>&nbsp;<span class="ident" id="3835250">smallPrimesProduct</span><span class="op" id="3835268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3835272">mod</span>&nbsp;<span class="op" id="3835276">:=</span>&nbsp;<span class="ident" id="3835279">bigMod</span><span class="op" id="3835285">.</span><span class="ident" id="3835286">Uint64</span><span class="op" id="3835292">(</span><span class="op" id="3835293">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3835297">NextDelta</span><span class="op" id="3835306">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835310">for</span>&nbsp;<span class="ident" id="3835314">delta</span>&nbsp;<span class="op" id="3835320">:=</span>&nbsp;<span class="ident" id="3835323">uint64</span><span class="op" id="3835329">(</span><span class="num" id="3835330">0</span><span class="op" id="3835331">)</span><span class="op" id="3835332">;</span>&nbsp;<span class="ident" id="3835334">delta</span>&nbsp;<span class="op" id="3835340">&lt;</span>&nbsp;<span class="num" id="3835342">1</span><span class="op" id="3835343">&lt;&lt;</span><span class="num" id="3835345">20</span><span class="op" id="3835347">;</span>&nbsp;<span class="ident" id="3835349">delta</span>&nbsp;<span class="op" id="3835355">+=</span>&nbsp;<span class="num" id="3835358">2</span>&nbsp;<span class="op" id="3835360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3835365">m</span>&nbsp;<span class="op" id="3835367">:=</span>&nbsp;<span class="ident" id="3835370">mod</span>&nbsp;<span class="op" id="3835374">+</span>&nbsp;<span class="ident" id="3835376">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835385">for</span>&nbsp;<span class="ident" id="3835389">_</span><span class="op" id="3835390">,</span>&nbsp;<span class="ident" id="3835392">prime</span>&nbsp;<span class="op" id="3835398">:=</span>&nbsp;<span class="keyword" id="3835401">range</span>&nbsp;<span class="ident" id="3835407">smallPrimes</span>&nbsp;<span class="op" id="3835419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835425">if</span>&nbsp;<span class="ident" id="3835428">m</span><span class="op" id="3835429">%</span><span class="ident" id="3835430">uint64</span><span class="op" id="3835436">(</span><span class="ident" id="3835437">prime</span><span class="op" id="3835442">)</span>&nbsp;<span class="op" id="3835444">==</span>&nbsp;<span class="num" id="3835447">0</span>&nbsp;<span class="op" id="3835449">&amp;&amp;</span>&nbsp;<span class="op" id="3835452">(</span><span class="ident" id="3835453">bits</span>&nbsp;<span class="op" id="3835458">&gt;</span>&nbsp;<span class="num" id="3835460">6</span>&nbsp;<span class="op" id="3835462">||</span>&nbsp;<span class="ident" id="3835465">m</span>&nbsp;<span class="op" id="3835467">!=</span>&nbsp;<span class="ident" id="3835470">uint64</span><span class="op" id="3835476">(</span><span class="ident" id="3835477">prime</span><span class="op" id="3835482">)</span><span class="op" id="3835483">)</span>&nbsp;<span class="op" id="3835485">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835492">continue</span>&nbsp;<span class="ident" id="3835501">NextDelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3835515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3835520">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835526">if</span>&nbsp;<span class="ident" id="3835529">delta</span>&nbsp;<span class="op" id="3835535">&gt;</span>&nbsp;<span class="num" id="3835537">0</span>&nbsp;<span class="op" id="3835539">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3835545">bigMod</span><span class="op" id="3835551">.</span><span class="ident" id="3835552">SetUint64</span><span class="op" id="3835561">(</span><span class="ident" id="3835562">delta</span><span class="op" id="3835567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3835573">p</span><span class="op" id="3835574">.</span><span class="ident" id="3835575">Add</span><span class="op" id="3835578">(</span><span class="ident" id="3835579">p</span><span class="op" id="3835580">,</span>&nbsp;<span class="ident" id="3835582">bigMod</span><span class="op" id="3835588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3835593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835598">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3835606">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3835611">//&nbsp;There&nbsp;is&nbsp;a&nbsp;tiny&nbsp;possibility&nbsp;that,&nbsp;by&nbsp;adding&nbsp;delta,&nbsp;we&nbsp;caused</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3835677">//&nbsp;the&nbsp;number&nbsp;to&nbsp;be&nbsp;one&nbsp;bit&nbsp;too&nbsp;long.&nbsp;Thus&nbsp;we&nbsp;check&nbsp;BitLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3835738">//&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835749">if</span>&nbsp;<span class="ident" id="3835752">p</span><span class="op" id="3835753">.</span><span class="ident" id="3835754">ProbablyPrime</span><span class="op" id="3835767">(</span><span class="num" id="3835768">20</span><span class="op" id="3835770">)</span>&nbsp;<span class="op" id="3835772">&amp;&amp;</span>&nbsp;<span class="ident" id="3835775">p</span><span class="op" id="3835776">.</span><span class="ident" id="3835777">BitLen</span><span class="op" id="3835783">(</span><span class="op" id="3835784">)</span>&nbsp;<span class="op" id="3835786">==</span>&nbsp;<span class="ident" id="3835789">bits</span>&nbsp;<span class="op" id="3835794">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835799">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3835808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3835811">}</span><br>
<span class="lineno"></span><span class="op" id="3835813">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="3835816">//&nbsp;Int&nbsp;returns&nbsp;a&nbsp;uniform&nbsp;random&nbsp;value&nbsp;in&nbsp;[0,&nbsp;max).&nbsp;It&nbsp;panics&nbsp;if&nbsp;max&nbsp;&lt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="3835890">func</span>&nbsp;<span class="ident" id="3835895">Int</span><span class="op" id="3835898">(</span><span class="ident" id="3835899">rand</span>&nbsp;<span class="ident" id="3835904">io</span><span class="op" id="3835906">.</span><span class="ident" id="3835907">Reader</span><span class="op" id="3835913">,</span>&nbsp;<span class="ident" id="3835915">max</span>&nbsp;<span class="op" id="3835919">*</span><span class="ident" id="3835920">big</span><span class="op" id="3835923">.</span><span class="ident" id="3835924">Int</span><span class="op" id="3835927">)</span>&nbsp;<span class="op" id="3835929">(</span><span class="ident" id="3835930">n</span>&nbsp;<span class="op" id="3835932">*</span><span class="ident" id="3835933">big</span><span class="op" id="3835936">.</span><span class="ident" id="3835937">Int</span><span class="op" id="3835940">,</span>&nbsp;<span class="ident" id="3835942">err</span>&nbsp;<span class="builtintype" id="3835946">error</span><span class="op" id="3835951">)</span>&nbsp;<span class="op" id="3835953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835956">if</span>&nbsp;<span class="ident" id="3835959">max</span><span class="op" id="3835962">.</span><span class="ident" id="3835963">Sign</span><span class="op" id="3835967">(</span><span class="op" id="3835968">)</span>&nbsp;<span class="op" id="3835970">&lt;=</span>&nbsp;<span class="num" id="3835973">0</span>&nbsp;<span class="op" id="3835975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3835979">panic</span><span class="op" id="3835984">(</span><span class="string" id="3835985">&#34;crypto/rand:&nbsp;argument&nbsp;to&nbsp;Int&nbsp;is&nbsp;&lt;=&nbsp;0&#34;</span><span class="op" id="3836023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3836026">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3836029">k</span>&nbsp;<span class="op" id="3836031">:=</span>&nbsp;<span class="op" id="3836034">(</span><span class="ident" id="3836035">max</span><span class="op" id="3836038">.</span><span class="ident" id="3836039">BitLen</span><span class="op" id="3836045">(</span><span class="op" id="3836046">)</span>&nbsp;<span class="op" id="3836048">+</span>&nbsp;<span class="num" id="3836050">7</span><span class="op" id="3836051">)</span>&nbsp;<span class="op" id="3836053">/</span>&nbsp;<span class="num" id="3836055">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3836059">//&nbsp;b&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;bits&nbsp;in&nbsp;the&nbsp;most&nbsp;significant&nbsp;byte&nbsp;of&nbsp;max.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3836124">b</span>&nbsp;<span class="op" id="3836126">:=</span>&nbsp;<span class="builtintype" id="3836129">uint</span><span class="op" id="3836133">(</span><span class="ident" id="3836134">max</span><span class="op" id="3836137">.</span><span class="ident" id="3836138">BitLen</span><span class="op" id="3836144">(</span><span class="op" id="3836145">)</span>&nbsp;<span class="op" id="3836147">%</span>&nbsp;<span class="num" id="3836149">8</span><span class="op" id="3836150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3836153">if</span>&nbsp;<span class="ident" id="3836156">b</span>&nbsp;<span class="op" id="3836158">==</span>&nbsp;<span class="num" id="3836161">0</span>&nbsp;<span class="op" id="3836163">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3836167">b</span>&nbsp;<span class="op" id="3836169">=</span>&nbsp;<span class="num" id="3836171">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3836174">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3836178">bytes</span>&nbsp;<span class="op" id="3836184">:=</span>&nbsp;<span class="builtinfunc" id="3836187">make</span><span class="op" id="3836191">(</span><span class="op" id="3836192">[</span><span class="op" id="3836193">]</span><span class="builtintype" id="3836194">byte</span><span class="op" id="3836198">,</span>&nbsp;<span class="ident" id="3836200">k</span><span class="op" id="3836201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3836204">n</span>&nbsp;<span class="op" id="3836206">=</span>&nbsp;<span class="builtinfunc" id="3836208">new</span><span class="op" id="3836211">(</span><span class="ident" id="3836212">big</span><span class="op" id="3836215">.</span><span class="ident" id="3836216">Int</span><span class="op" id="3836219">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3836223">for</span>&nbsp;<span class="op" id="3836227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3836231">_</span><span class="op" id="3836232">,</span>&nbsp;<span class="ident" id="3836234">err</span>&nbsp;<span class="op" id="3836238">=</span>&nbsp;<span class="ident" id="3836240">io</span><span class="op" id="3836242">.</span><span class="ident" id="3836243">ReadFull</span><span class="op" id="3836251">(</span><span class="ident" id="3836252">rand</span><span class="op" id="3836256">,</span>&nbsp;<span class="ident" id="3836258">bytes</span><span class="op" id="3836263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3836267">if</span>&nbsp;<span class="ident" id="3836270">err</span>&nbsp;<span class="op" id="3836274">!=</span>&nbsp;<span class="ident" id="3836277">nil</span>&nbsp;<span class="op" id="3836281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3836286">return</span>&nbsp;<span class="ident" id="3836293">nil</span><span class="op" id="3836296">,</span>&nbsp;<span class="ident" id="3836298">err</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3836304">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3836309">//&nbsp;Clear&nbsp;bits&nbsp;in&nbsp;the&nbsp;first&nbsp;byte&nbsp;to&nbsp;increase&nbsp;the&nbsp;probability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3836371">//&nbsp;that&nbsp;the&nbsp;candidate&nbsp;is&nbsp;&lt;&nbsp;max.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3836405">bytes</span><span class="op" id="3836410">[</span><span class="num" id="3836411">0</span><span class="op" id="3836412">]</span>&nbsp;<span class="op" id="3836414">&amp;=</span>&nbsp;<span class="builtintype" id="3836417">uint8</span><span class="op" id="3836422">(</span><span class="builtintype" id="3836423">int</span><span class="op" id="3836426">(</span><span class="num" id="3836427">1</span><span class="op" id="3836428">&lt;&lt;</span><span class="ident" id="3836430">b</span><span class="op" id="3836431">)</span>&nbsp;<span class="op" id="3836433">-</span>&nbsp;<span class="num" id="3836435">1</span><span class="op" id="3836436">)</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3836441">n</span><span class="op" id="3836442">.</span><span class="ident" id="3836443">SetBytes</span><span class="op" id="3836451">(</span><span class="ident" id="3836452">bytes</span><span class="op" id="3836457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3836461">if</span>&nbsp;<span class="ident" id="3836464">n</span><span class="op" id="3836465">.</span><span class="ident" id="3836466">Cmp</span><span class="op" id="3836469">(</span><span class="ident" id="3836470">max</span><span class="op" id="3836473">)</span>&nbsp;<span class="op" id="3836475">&lt;</span>&nbsp;<span class="num" id="3836477">0</span>&nbsp;<span class="op" id="3836479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3836484">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3836493">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3836496">}</span><br>
<span class="lineno"></span><span class="op" id="3836498">}</span>
</div>
</body>
</html>
