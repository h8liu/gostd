<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword">package</span>&nbsp;<span class="ident">flate</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;math&#34;</span><br>
<span class="lineno">10</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">const</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;largest&nbsp;offset&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">offsetCodeCount</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">30</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;special&nbsp;code&nbsp;used&nbsp;to&nbsp;mark&nbsp;the&nbsp;end&nbsp;of&nbsp;a&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">endBlockMarker</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">256</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;first&nbsp;length&nbsp;code.</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lengthCodesStart</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">257</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;number&nbsp;of&nbsp;codegen&nbsp;codes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">codegenCodeCount</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">19</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">badCode</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="num">255</span><br>
<span class="lineno">25</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;number&nbsp;of&nbsp;extra&nbsp;bits&nbsp;needed&nbsp;by&nbsp;length&nbsp;code&nbsp;X&nbsp;-&nbsp;LENGTH_CODES_START.</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">lengthExtraBits</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">int8</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">/*&nbsp;257&nbsp;*/</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">/*&nbsp;260&nbsp;*/</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">2</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">/*&nbsp;270&nbsp;*/</span>&nbsp;<span class="num">2</span><span class="op">,</span>&nbsp;<span class="num">2</span><span class="op">,</span>&nbsp;<span class="num">2</span><span class="op">,</span>&nbsp;<span class="num">3</span><span class="op">,</span>&nbsp;<span class="num">3</span><span class="op">,</span>&nbsp;<span class="num">3</span><span class="op">,</span>&nbsp;<span class="num">3</span><span class="op">,</span>&nbsp;<span class="num">4</span><span class="op">,</span>&nbsp;<span class="num">4</span><span class="op">,</span>&nbsp;<span class="num">4</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">/*&nbsp;280&nbsp;*/</span>&nbsp;<span class="num">4</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment">//&nbsp;The&nbsp;length&nbsp;indicated&nbsp;by&nbsp;length&nbsp;code&nbsp;X&nbsp;-&nbsp;LENGTH_CODES_START.</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">lengthBase</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uint32</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">2</span><span class="op">,</span>&nbsp;<span class="num">3</span><span class="op">,</span>&nbsp;<span class="num">4</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">10</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">12</span><span class="op">,</span>&nbsp;<span class="num">14</span><span class="op">,</span>&nbsp;<span class="num">16</span><span class="op">,</span>&nbsp;<span class="num">20</span><span class="op">,</span>&nbsp;<span class="num">24</span><span class="op">,</span>&nbsp;<span class="num">28</span><span class="op">,</span>&nbsp;<span class="num">32</span><span class="op">,</span>&nbsp;<span class="num">40</span><span class="op">,</span>&nbsp;<span class="num">48</span><span class="op">,</span>&nbsp;<span class="num">56</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">64</span><span class="op">,</span>&nbsp;<span class="num">80</span><span class="op">,</span>&nbsp;<span class="num">96</span><span class="op">,</span>&nbsp;<span class="num">112</span><span class="op">,</span>&nbsp;<span class="num">128</span><span class="op">,</span>&nbsp;<span class="num">160</span><span class="op">,</span>&nbsp;<span class="num">192</span><span class="op">,</span>&nbsp;<span class="num">224</span><span class="op">,</span>&nbsp;<span class="num">255</span><span class="op">,</span><br>
<span class="lineno">40</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;offset&nbsp;code&nbsp;word&nbsp;extra&nbsp;bits.</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">offsetExtraBits</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">int8</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">2</span><span class="op">,</span>&nbsp;<span class="num">2</span><span class="op">,</span>&nbsp;<span class="num">3</span><span class="op">,</span>&nbsp;<span class="num">3</span><span class="op">,</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">4</span><span class="op">,</span>&nbsp;<span class="num">4</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">9</span><span class="op">,</span>&nbsp;<span class="num">9</span><span class="op">,</span>&nbsp;<span class="num">10</span><span class="op">,</span>&nbsp;<span class="num">10</span><span class="op">,</span>&nbsp;<span class="num">11</span><span class="op">,</span>&nbsp;<span class="num">11</span><span class="op">,</span>&nbsp;<span class="num">12</span><span class="op">,</span>&nbsp;<span class="num">12</span><span class="op">,</span>&nbsp;<span class="num">13</span><span class="op">,</span>&nbsp;<span class="num">13</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">/*&nbsp;extended&nbsp;window&nbsp;*/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">14</span><span class="op">,</span>&nbsp;<span class="num">14</span><span class="op">,</span>&nbsp;<span class="num">15</span><span class="op">,</span>&nbsp;<span class="num">15</span><span class="op">,</span>&nbsp;<span class="num">16</span><span class="op">,</span>&nbsp;<span class="num">16</span><span class="op">,</span>&nbsp;<span class="num">17</span><span class="op">,</span>&nbsp;<span class="num">17</span><span class="op">,</span>&nbsp;<span class="num">18</span><span class="op">,</span>&nbsp;<span class="num">18</span><span class="op">,</span>&nbsp;<span class="num">19</span><span class="op">,</span>&nbsp;<span class="num">19</span><span class="op">,</span>&nbsp;<span class="num">20</span><span class="op">,</span>&nbsp;<span class="num">20</span><span class="op">,</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">offsetBase</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uint32</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">/*&nbsp;normal&nbsp;deflate&nbsp;*/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x000000</span><span class="op">,</span>&nbsp;<span class="num">0x000001</span><span class="op">,</span>&nbsp;<span class="num">0x000002</span><span class="op">,</span>&nbsp;<span class="num">0x000003</span><span class="op">,</span>&nbsp;<span class="num">0x000004</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x000006</span><span class="op">,</span>&nbsp;<span class="num">0x000008</span><span class="op">,</span>&nbsp;<span class="num">0x00000c</span><span class="op">,</span>&nbsp;<span class="num">0x000010</span><span class="op">,</span>&nbsp;<span class="num">0x000018</span><span class="op">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x000020</span><span class="op">,</span>&nbsp;<span class="num">0x000030</span><span class="op">,</span>&nbsp;<span class="num">0x000040</span><span class="op">,</span>&nbsp;<span class="num">0x000060</span><span class="op">,</span>&nbsp;<span class="num">0x000080</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x0000c0</span><span class="op">,</span>&nbsp;<span class="num">0x000100</span><span class="op">,</span>&nbsp;<span class="num">0x000180</span><span class="op">,</span>&nbsp;<span class="num">0x000200</span><span class="op">,</span>&nbsp;<span class="num">0x000300</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x000400</span><span class="op">,</span>&nbsp;<span class="num">0x000600</span><span class="op">,</span>&nbsp;<span class="num">0x000800</span><span class="op">,</span>&nbsp;<span class="num">0x000c00</span><span class="op">,</span>&nbsp;<span class="num">0x001000</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x001800</span><span class="op">,</span>&nbsp;<span class="num">0x002000</span><span class="op">,</span>&nbsp;<span class="num">0x003000</span><span class="op">,</span>&nbsp;<span class="num">0x004000</span><span class="op">,</span>&nbsp;<span class="num">0x006000</span><span class="op">,</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">/*&nbsp;extended&nbsp;window&nbsp;*/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x008000</span><span class="op">,</span>&nbsp;<span class="num">0x00c000</span><span class="op">,</span>&nbsp;<span class="num">0x010000</span><span class="op">,</span>&nbsp;<span class="num">0x018000</span><span class="op">,</span>&nbsp;<span class="num">0x020000</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x030000</span><span class="op">,</span>&nbsp;<span class="num">0x040000</span><span class="op">,</span>&nbsp;<span class="num">0x060000</span><span class="op">,</span>&nbsp;<span class="num">0x080000</span><span class="op">,</span>&nbsp;<span class="num">0x0c0000</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x100000</span><span class="op">,</span>&nbsp;<span class="num">0x180000</span><span class="op">,</span>&nbsp;<span class="num">0x200000</span><span class="op">,</span>&nbsp;<span class="num">0x300000</span><span class="op">,</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;odd&nbsp;order&nbsp;in&nbsp;which&nbsp;the&nbsp;codegen&nbsp;code&nbsp;sizes&nbsp;are&nbsp;written.</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">codegenOrder</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uint32</span><span class="op">{</span><span class="num">16</span><span class="op">,</span>&nbsp;<span class="num">17</span><span class="op">,</span>&nbsp;<span class="num">18</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">9</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">10</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">,</span>&nbsp;<span class="num">11</span><span class="op">,</span>&nbsp;<span class="num">4</span><span class="op">,</span>&nbsp;<span class="num">12</span><span class="op">,</span>&nbsp;<span class="num">3</span><span class="op">,</span>&nbsp;<span class="num">13</span><span class="op">,</span>&nbsp;<span class="num">2</span><span class="op">,</span>&nbsp;<span class="num">14</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">15</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">huffmanBitWriter</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;written&nbsp;is&nbsp;bytes[0:nbytes]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;and&nbsp;then&nbsp;the&nbsp;low&nbsp;nbits&nbsp;of&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nbits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">uint32</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bytes</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">[</span><span class="num">64</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nbytes</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">literalFreq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">offsetFreq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">codegen</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uint8</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">codegenFreq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">literalEncoding</span>&nbsp;<span class="op">*</span><span class="ident">huffmanEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">offsetEncoding</span>&nbsp;&nbsp;<span class="op">*</span><span class="ident">huffmanEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">codegenEncoding</span>&nbsp;<span class="op">*</span><span class="ident">huffmanEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">error</span><br>
<span class="lineno">85</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">newHuffmanBitWriter</span><span class="op">(</span><span class="ident">w</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">Writer</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">huffmanBitWriter</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">huffmanBitWriter</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">w</span><span class="op">,</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">literalFreq</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">int32</span><span class="op">,</span>&nbsp;<span class="ident">maxLit</span><span class="op">)</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">offsetFreq</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">int32</span><span class="op">,</span>&nbsp;<span class="ident">offsetCodeCount</span><span class="op">)</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">codegen</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">uint8</span><span class="op">,</span>&nbsp;<span class="ident">maxLit</span><span class="op">+</span><span class="ident">offsetCodeCount</span><span class="op">+</span><span class="num">1</span><span class="op">)</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">codegenFreq</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">int32</span><span class="op">,</span>&nbsp;<span class="ident">codegenCodeCount</span><span class="op">)</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">literalEncoding</span><span class="op">:</span>&nbsp;<span class="ident">newHuffmanEncoder</span><span class="op">(</span><span class="ident">maxLit</span><span class="op">)</span><span class="op">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">offsetEncoding</span><span class="op">:</span>&nbsp;&nbsp;<span class="ident">newHuffmanEncoder</span><span class="op">(</span><span class="ident">offsetCodeCount</span><span class="op">)</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">codegenEncoding</span><span class="op">:</span>&nbsp;<span class="ident">newHuffmanEncoder</span><span class="op">(</span><span class="ident">codegenCodeCount</span><span class="op">)</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">w</span>&nbsp;<span class="op">*</span><span class="ident">huffmanBitWriter</span><span class="op">)</span>&nbsp;<span class="ident">reset</span><span class="op">(</span><span class="ident">writer</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">Writer</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">w</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">bits</span><span class="op">,</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">nbits</span><span class="op">,</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">nbytes</span><span class="op">,</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">bytes</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="num">64</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">{</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">codegen</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">codegen</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="op">[</span><span class="op">...</span><span class="op">]</span><span class="op">[</span><span class="op">]</span><span class="builtintype">int32</span><span class="op">{</span><span class="ident">w</span><span class="op">.</span><span class="ident">literalFreq</span><span class="op">,</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">offsetFreq</span><span class="op">,</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">codegenFreq</span><span class="op">}</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">enc</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="op">[</span><span class="op">...</span><span class="op">]</span><span class="op">*</span><span class="ident">huffmanEncoder</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">literalEncoding</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">offsetEncoding</span><span class="op">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">codegenEncoding</span><span class="op">}</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">enc</span><span class="op">.</span><span class="ident">code</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">enc</span><span class="op">.</span><span class="ident">code</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">enc</span><span class="op">.</span><span class="ident">codeBits</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">enc</span><span class="op">.</span><span class="ident">codeBits</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">w</span>&nbsp;<span class="op">*</span><span class="ident">huffmanBitWriter</span><span class="op">)</span>&nbsp;<span class="ident">flushBits</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">nbits</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bits</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">bits</span>&nbsp;<span class="op">&gt;&gt;=</span>&nbsp;<span class="num">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">nbits</span>&nbsp;<span class="op">-=</span>&nbsp;<span class="num">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">nbytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">bytes</span><span class="op">[</span><span class="ident">n</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">byte</span><span class="op">(</span><span class="ident">bits</span><span class="op">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">bytes</span><span class="op">[</span><span class="ident">n</span><span class="op">+</span><span class="num">1</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">byte</span><span class="op">(</span><span class="ident">bits</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="num">8</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="num">2</span><span class="op">;</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">w</span><span class="op">.</span><span class="ident">bytes</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">w</span><span class="op">.</span><span class="ident">Write</span><span class="op">(</span><span class="ident">w</span><span class="op">.</span><span class="ident">bytes</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">nbytes</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">n</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">w</span>&nbsp;<span class="op">*</span><span class="ident">huffmanBitWriter</span><span class="op">)</span>&nbsp;<span class="ident">flush</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">nbits</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">nbytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">nbits</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">8</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">bytes</span><span class="op">[</span><span class="ident">n</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">byte</span><span class="op">(</span><span class="ident">w</span><span class="op">.</span><span class="ident">bits</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">bits</span>&nbsp;<span class="op">&gt;&gt;=</span>&nbsp;<span class="num">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">nbits</span>&nbsp;<span class="op">-=</span>&nbsp;<span class="num">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">nbits</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">bytes</span><span class="op">[</span><span class="ident">n</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">byte</span><span class="op">(</span><span class="ident">w</span><span class="op">.</span><span class="ident">bits</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">nbits</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">bits</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">w</span><span class="op">.</span><span class="ident">Write</span><span class="op">(</span><span class="ident">w</span><span class="op">.</span><span class="ident">bytes</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">n</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">nbytes</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">w</span>&nbsp;<span class="op">*</span><span class="ident">huffmanBitWriter</span><span class="op">)</span>&nbsp;<span class="ident">writeBits</span><span class="op">(</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">nb</span>&nbsp;<span class="builtintype">int32</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">bits</span>&nbsp;<span class="op">|=</span>&nbsp;<span class="builtintype">uint32</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">nbits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">nbits</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="builtintype">uint32</span><span class="op">(</span><span class="ident">nb</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">nbits</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">16</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">flushBits</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">170</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">w</span>&nbsp;<span class="op">*</span><span class="ident">huffmanBitWriter</span><span class="op">)</span>&nbsp;<span class="ident">writeBytes</span><span class="op">(</span><span class="ident">bytes</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">nbytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">nbits</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">8</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">bytes</span><span class="op">[</span><span class="ident">n</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">byte</span><span class="op">(</span><span class="ident">w</span><span class="op">.</span><span class="ident">bits</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">nbits</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">nbits</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">InternalError</span><span class="op">(</span><span class="string">&#34;writeBytes&nbsp;with&nbsp;unfinished&nbsp;bits&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">w</span><span class="op">.</span><span class="ident">Write</span><span class="op">(</span><span class="ident">w</span><span class="op">.</span><span class="ident">bytes</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">n</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">nbytes</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">w</span><span class="op">.</span><span class="ident">Write</span><span class="op">(</span><span class="ident">bytes</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;RFC&nbsp;1951&nbsp;3.2.7&nbsp;specifies&nbsp;a&nbsp;special&nbsp;run-length&nbsp;encoding&nbsp;for&nbsp;specifying</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;the&nbsp;literal&nbsp;and&nbsp;offset&nbsp;lengths&nbsp;arrays&nbsp;(which&nbsp;are&nbsp;concatenated&nbsp;into&nbsp;a&nbsp;single</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;array).&nbsp;&nbsp;This&nbsp;method&nbsp;generates&nbsp;that&nbsp;run-length&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno">200</span><span class="comment">//&nbsp;The&nbsp;result&nbsp;is&nbsp;written&nbsp;into&nbsp;the&nbsp;codegen&nbsp;array,&nbsp;and&nbsp;the&nbsp;frequencies</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;of&nbsp;each&nbsp;code&nbsp;is&nbsp;written&nbsp;into&nbsp;the&nbsp;codegenFreq&nbsp;array.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Codes&nbsp;0-15&nbsp;are&nbsp;single&nbsp;byte&nbsp;codes.&nbsp;Codes&nbsp;16-18&nbsp;are&nbsp;followed&nbsp;by&nbsp;additional</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;information.&nbsp;&nbsp;Code&nbsp;badCode&nbsp;is&nbsp;an&nbsp;end&nbsp;marker</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno">205</span><span class="comment">//&nbsp;&nbsp;numLiterals&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;number&nbsp;of&nbsp;literals&nbsp;in&nbsp;literalEncoding</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;numOffsets&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;number&nbsp;of&nbsp;offsets&nbsp;in&nbsp;offsetEncoding</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">w</span>&nbsp;<span class="op">*</span><span class="ident">huffmanBitWriter</span><span class="op">)</span>&nbsp;<span class="ident">generateCodegen</span><span class="op">(</span><span class="ident">numLiterals</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">numOffsets</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">codegenFreq</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">codegenFreq</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Note&nbsp;that&nbsp;we&nbsp;are&nbsp;using&nbsp;codegen&nbsp;both&nbsp;as&nbsp;a&nbsp;temporary&nbsp;variable&nbsp;for&nbsp;holding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;frequencies,&nbsp;and&nbsp;as&nbsp;the&nbsp;place&nbsp;where&nbsp;we&nbsp;put&nbsp;the&nbsp;result.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;This&nbsp;is&nbsp;fine&nbsp;because&nbsp;the&nbsp;output&nbsp;is&nbsp;always&nbsp;shorter&nbsp;than&nbsp;the&nbsp;input&nbsp;used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;so&nbsp;far.</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">codegen</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">codegen</span>&nbsp;<span class="comment">//&nbsp;cache</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Copy&nbsp;the&nbsp;concatenated&nbsp;code&nbsp;sizes&nbsp;to&nbsp;codegen.&nbsp;&nbsp;Put&nbsp;a&nbsp;marker&nbsp;at&nbsp;the&nbsp;end.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">copy</span><span class="op">(</span><span class="ident">codegen</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">numLiterals</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">literalEncoding</span><span class="op">.</span><span class="ident">codeBits</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">copy</span><span class="op">(</span><span class="ident">codegen</span><span class="op">[</span><span class="ident">numLiterals</span><span class="op">:</span><span class="ident">numLiterals</span><span class="op">+</span><span class="ident">numOffsets</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">offsetEncoding</span><span class="op">.</span><span class="ident">codeBits</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">codegen</span><span class="op">[</span><span class="ident">numLiterals</span><span class="op">+</span><span class="ident">numOffsets</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">badCode</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">size</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">codegen</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">count</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">outIndex</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">inIndex</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">1</span><span class="op">;</span>&nbsp;<span class="ident">size</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">badCode</span><span class="op">;</span>&nbsp;<span class="ident">inIndex</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;INVARIANT:&nbsp;We&nbsp;have&nbsp;seen&nbsp;&#34;count&#34;&nbsp;copies&nbsp;of&nbsp;size&nbsp;that&nbsp;have&nbsp;not&nbsp;yet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;had&nbsp;output&nbsp;generated&nbsp;for&nbsp;them.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nextSize</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">codegen</span><span class="op">[</span><span class="ident">inIndex</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">nextSize</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">size</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">count</span><span class="op">++</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&nbsp;need&nbsp;to&nbsp;generate&nbsp;codegen&nbsp;indicating&nbsp;&#34;count&#34;&nbsp;of&nbsp;size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">size</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">codegen</span><span class="op">[</span><span class="ident">outIndex</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">size</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">outIndex</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">codegenFreq</span><span class="op">[</span><span class="ident">size</span><span class="op">]</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">count</span><span class="op">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">count</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">3</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">6</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">count</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">codegen</span><span class="op">[</span><span class="ident">outIndex</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">outIndex</span><span class="op">++</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">codegen</span><span class="op">[</span><span class="ident">outIndex</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">uint8</span><span class="op">(</span><span class="ident">n</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">3</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">outIndex</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">codegenFreq</span><span class="op">[</span><span class="num">16</span><span class="op">]</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">count</span>&nbsp;<span class="op">-=</span>&nbsp;<span class="ident">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">count</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">11</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">138</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">count</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">count</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">codegen</span><span class="op">[</span><span class="ident">outIndex</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">18</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">outIndex</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">codegen</span><span class="op">[</span><span class="ident">outIndex</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">uint8</span><span class="op">(</span><span class="ident">n</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">11</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">outIndex</span><span class="op">++</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">codegenFreq</span><span class="op">[</span><span class="num">18</span><span class="op">]</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">count</span>&nbsp;<span class="op">-=</span>&nbsp;<span class="ident">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">count</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">3</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;count&nbsp;&gt;=&nbsp;3&nbsp;&amp;&amp;&nbsp;count&nbsp;&lt;=&nbsp;10</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">codegen</span><span class="op">[</span><span class="ident">outIndex</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">17</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">outIndex</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">codegen</span><span class="op">[</span><span class="ident">outIndex</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">uint8</span><span class="op">(</span><span class="ident">count</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">3</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">outIndex</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">codegenFreq</span><span class="op">[</span><span class="num">17</span><span class="op">]</span><span class="op">++</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">count</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">count</span><span class="op">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="op">;</span>&nbsp;<span class="ident">count</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">count</span><span class="op">--</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">codegen</span><span class="op">[</span><span class="ident">outIndex</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">outIndex</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">codegenFreq</span><span class="op">[</span><span class="ident">size</span><span class="op">]</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Set&nbsp;up&nbsp;invariant&nbsp;for&nbsp;next&nbsp;time&nbsp;through&nbsp;the&nbsp;loop.</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">size</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nextSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">count</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Marker&nbsp;indicating&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;codegen.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">codegen</span><span class="op">[</span><span class="ident">outIndex</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">badCode</span><br>
<span class="lineno">285</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">w</span>&nbsp;<span class="op">*</span><span class="ident">huffmanBitWriter</span><span class="op">)</span>&nbsp;<span class="ident">writeCode</span><span class="op">(</span><span class="ident">code</span>&nbsp;<span class="op">*</span><span class="ident">huffmanEncoder</span><span class="op">,</span>&nbsp;<span class="ident">literal</span>&nbsp;<span class="builtintype">uint32</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">writeBits</span><span class="op">(</span><span class="builtintype">int32</span><span class="op">(</span><span class="ident">code</span><span class="op">.</span><span class="ident">code</span><span class="op">[</span><span class="ident">literal</span><span class="op">]</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="builtintype">int32</span><span class="op">(</span><span class="ident">code</span><span class="op">.</span><span class="ident">codeBits</span><span class="op">[</span><span class="ident">literal</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Write&nbsp;the&nbsp;header&nbsp;of&nbsp;a&nbsp;dynamic&nbsp;Huffman&nbsp;block&nbsp;to&nbsp;the&nbsp;output&nbsp;stream.</span><br>
<span class="lineno">295</span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;numLiterals&nbsp;&nbsp;The&nbsp;number&nbsp;of&nbsp;literals&nbsp;specified&nbsp;in&nbsp;codegen</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;numOffsets&nbsp;&nbsp;&nbsp;The&nbsp;number&nbsp;of&nbsp;offsets&nbsp;specified&nbsp;in&nbsp;codegen</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;numCodegens&nbsp;&nbsp;The&nbsp;number&nbsp;of&nbsp;codegens&nbsp;used&nbsp;in&nbsp;codegen</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">w</span>&nbsp;<span class="op">*</span><span class="ident">huffmanBitWriter</span><span class="op">)</span>&nbsp;<span class="ident">writeDynamicHeader</span><span class="op">(</span><span class="ident">numLiterals</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">numOffsets</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">numCodegens</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">isEof</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">firstBits</span>&nbsp;<span class="builtintype">int32</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">isEof</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">firstBits</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">writeBits</span><span class="op">(</span><span class="ident">firstBits</span><span class="op">,</span>&nbsp;<span class="num">3</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">writeBits</span><span class="op">(</span><span class="builtintype">int32</span><span class="op">(</span><span class="ident">numLiterals</span><span class="op">-</span><span class="num">257</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">writeBits</span><span class="op">(</span><span class="builtintype">int32</span><span class="op">(</span><span class="ident">numOffsets</span><span class="op">-</span><span class="num">1</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">writeBits</span><span class="op">(</span><span class="builtintype">int32</span><span class="op">(</span><span class="ident">numCodegens</span><span class="op">-</span><span class="num">4</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="num">4</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">numCodegens</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">value</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">codegenEncoding</span><span class="op">.</span><span class="ident">codeBits</span><span class="op">[</span><span class="ident">codegenOrder</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">writeBits</span><span class="op">(</span><span class="builtintype">int32</span><span class="op">(</span><span class="ident">value</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="num">3</span><span class="op">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">codeWord</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">w</span><span class="op">.</span><span class="ident">codegen</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">codeWord</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">badCode</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;low&nbsp;byte&nbsp;contains&nbsp;the&nbsp;actual&nbsp;code&nbsp;to&nbsp;generate.</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">writeCode</span><span class="op">(</span><span class="ident">w</span><span class="op">.</span><span class="ident">codegenEncoding</span><span class="op">,</span>&nbsp;<span class="builtintype">uint32</span><span class="op">(</span><span class="ident">codeWord</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">codeWord</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="num">16</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">writeBits</span><span class="op">(</span><span class="builtintype">int32</span><span class="op">(</span><span class="ident">w</span><span class="op">.</span><span class="ident">codegen</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="num">2</span><span class="op">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="num">17</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">writeBits</span><span class="op">(</span><span class="builtintype">int32</span><span class="op">(</span><span class="ident">w</span><span class="op">.</span><span class="ident">codegen</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="num">3</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">++</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="num">18</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">writeBits</span><span class="op">(</span><span class="builtintype">int32</span><span class="op">(</span><span class="ident">w</span><span class="op">.</span><span class="ident">codegen</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">w</span>&nbsp;<span class="op">*</span><span class="ident">huffmanBitWriter</span><span class="op">)</span>&nbsp;<span class="ident">writeStoredHeader</span><span class="op">(</span><span class="ident">length</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">isEof</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">flag</span>&nbsp;<span class="builtintype">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">isEof</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">flag</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">writeBits</span><span class="op">(</span><span class="ident">flag</span><span class="op">,</span>&nbsp;<span class="num">3</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">flush</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">writeBits</span><span class="op">(</span><span class="builtintype">int32</span><span class="op">(</span><span class="ident">length</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="num">16</span><span class="op">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">writeBits</span><span class="op">(</span><span class="builtintype">int32</span><span class="op">(</span><span class="op">^</span><span class="builtintype">uint16</span><span class="op">(</span><span class="ident">length</span><span class="op">)</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="num">16</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">w</span>&nbsp;<span class="op">*</span><span class="ident">huffmanBitWriter</span><span class="op">)</span>&nbsp;<span class="ident">writeFixedHeader</span><span class="op">(</span><span class="ident">isEof</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Indicate&nbsp;that&nbsp;we&nbsp;are&nbsp;a&nbsp;fixed&nbsp;Huffman&nbsp;block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="builtintype">int32</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">isEof</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">value</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">writeBits</span><span class="op">(</span><span class="ident">value</span><span class="op">,</span>&nbsp;<span class="num">3</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">370</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">w</span>&nbsp;<span class="op">*</span><span class="ident">huffmanBitWriter</span><span class="op">)</span>&nbsp;<span class="ident">writeBlock</span><span class="op">(</span><span class="ident">tokens</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">token</span><span class="op">,</span>&nbsp;<span class="ident">eof</span>&nbsp;<span class="builtintype">bool</span><span class="op">,</span>&nbsp;<span class="ident">input</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">literalFreq</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">literalFreq</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">offsetFreq</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">offsetFreq</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">tokens</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tokens</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">tokens</span><span class="op">[</span><span class="num">0</span>&nbsp;<span class="op">:</span>&nbsp;<span class="ident">n</span><span class="op">+</span><span class="num">1</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tokens</span><span class="op">[</span><span class="ident">n</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">endBlockMarker</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">t</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">tokens</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">typ</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">literalType</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">literalFreq</span><span class="op">[</span><span class="ident">t</span><span class="op">.</span><span class="ident">literal</span><span class="op">(</span><span class="op">)</span><span class="op">]</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">matchType</span><span class="op">:</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">length</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">length</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">offset</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">offset</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">literalFreq</span><span class="op">[</span><span class="ident">lengthCodesStart</span><span class="op">+</span><span class="ident">lengthCode</span><span class="op">(</span><span class="ident">length</span><span class="op">)</span><span class="op">]</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">offsetFreq</span><span class="op">[</span><span class="ident">offsetCode</span><span class="op">(</span><span class="ident">offset</span><span class="op">)</span><span class="op">]</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;get&nbsp;the&nbsp;number&nbsp;of&nbsp;literals</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">numLiterals</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">w</span><span class="op">.</span><span class="ident">literalFreq</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">literalFreq</span><span class="op">[</span><span class="ident">numLiterals</span><span class="op">-</span><span class="num">1</span><span class="op">]</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">numLiterals</span><span class="op">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;get&nbsp;the&nbsp;number&nbsp;of&nbsp;offsets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">numOffsets</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">w</span><span class="op">.</span><span class="ident">offsetFreq</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">numOffsets</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">offsetFreq</span><span class="op">[</span><span class="ident">numOffsets</span><span class="op">-</span><span class="num">1</span><span class="op">]</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">numOffsets</span><span class="op">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">numOffsets</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&nbsp;haven&#39;t&nbsp;found&nbsp;a&nbsp;single&nbsp;match.&nbsp;If&nbsp;we&nbsp;want&nbsp;to&nbsp;go&nbsp;with&nbsp;the&nbsp;dynamic&nbsp;encoding,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;we&nbsp;should&nbsp;count&nbsp;at&nbsp;least&nbsp;one&nbsp;offset&nbsp;to&nbsp;be&nbsp;sure&nbsp;that&nbsp;the&nbsp;offset&nbsp;huffman&nbsp;tree&nbsp;could&nbsp;be&nbsp;encoded.</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">offsetFreq</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">numOffsets</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">literalEncoding</span><span class="op">.</span><span class="ident">generate</span><span class="op">(</span><span class="ident">w</span><span class="op">.</span><span class="ident">literalFreq</span><span class="op">,</span>&nbsp;<span class="num">15</span><span class="op">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">offsetEncoding</span><span class="op">.</span><span class="ident">generate</span><span class="op">(</span><span class="ident">w</span><span class="op">.</span><span class="ident">offsetFreq</span><span class="op">,</span>&nbsp;<span class="num">15</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">storedBytes</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">input</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">storedBytes</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">input</span><span class="op">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">extraBits</span>&nbsp;<span class="ident">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">storedSize</span>&nbsp;<span class="ident">int64</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">math</span><span class="op">.</span><span class="ident">MaxInt64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">storedBytes</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="ident">maxStoreBlockSize</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">input</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">storedSize</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="op">(</span><span class="ident">storedBytes</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">5</span><span class="op">)</span>&nbsp;<span class="op">*</span>&nbsp;<span class="num">8</span><span class="op">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&nbsp;only&nbsp;bother&nbsp;calculating&nbsp;the&nbsp;costs&nbsp;of&nbsp;the&nbsp;extra&nbsp;bits&nbsp;required&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;the&nbsp;length&nbsp;of&nbsp;offset&nbsp;fields&nbsp;(which&nbsp;will&nbsp;be&nbsp;the&nbsp;same&nbsp;for&nbsp;both&nbsp;fixed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;and&nbsp;dynamic&nbsp;encoding),&nbsp;if&nbsp;we&nbsp;need&nbsp;to&nbsp;compare&nbsp;those&nbsp;two&nbsp;encodings</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;against&nbsp;stored&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">lengthCode</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">lengthCodesStart</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">8</span><span class="op">;</span>&nbsp;<span class="ident">lengthCode</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">numLiterals</span><span class="op">;</span>&nbsp;<span class="ident">lengthCode</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;First&nbsp;eight&nbsp;length&nbsp;codes&nbsp;have&nbsp;extra&nbsp;size&nbsp;=&nbsp;0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">extraBits</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="ident">w</span><span class="op">.</span><span class="ident">literalFreq</span><span class="op">[</span><span class="ident">lengthCode</span><span class="op">]</span><span class="op">)</span>&nbsp;<span class="op">*</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="ident">lengthExtraBits</span><span class="op">[</span><span class="ident">lengthCode</span><span class="op">-</span><span class="ident">lengthCodesStart</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">offsetCode</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">4</span><span class="op">;</span>&nbsp;<span class="ident">offsetCode</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">numOffsets</span><span class="op">;</span>&nbsp;<span class="ident">offsetCode</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;First&nbsp;four&nbsp;offset&nbsp;codes&nbsp;have&nbsp;extra&nbsp;size&nbsp;=&nbsp;0.</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">extraBits</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="ident">w</span><span class="op">.</span><span class="ident">offsetFreq</span><span class="op">[</span><span class="ident">offsetCode</span><span class="op">]</span><span class="op">)</span>&nbsp;<span class="op">*</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="ident">offsetExtraBits</span><span class="op">[</span><span class="ident">offsetCode</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Figure&nbsp;out&nbsp;smallest&nbsp;code.</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Fixed&nbsp;Huffman&nbsp;baseline.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">size</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="num">3</span><span class="op">)</span>&nbsp;<span class="op">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fixedLiteralEncoding</span><span class="op">.</span><span class="ident">bitLength</span><span class="op">(</span><span class="ident">w</span><span class="op">.</span><span class="ident">literalFreq</span><span class="op">)</span>&nbsp;<span class="op">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fixedOffsetEncoding</span><span class="op">.</span><span class="ident">bitLength</span><span class="op">(</span><span class="ident">w</span><span class="op">.</span><span class="ident">offsetFreq</span><span class="op">)</span>&nbsp;<span class="op">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">extraBits</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">literalEncoding</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">fixedLiteralEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">offsetEncoding</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">fixedOffsetEncoding</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Dynamic&nbsp;Huffman?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">numCodegens</span>&nbsp;<span class="builtintype">int</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Generate&nbsp;codegen&nbsp;and&nbsp;codegenFrequencies,&nbsp;which&nbsp;indicates&nbsp;how&nbsp;to&nbsp;encode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;the&nbsp;literalEncoding&nbsp;and&nbsp;the&nbsp;offsetEncoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">generateCodegen</span><span class="op">(</span><span class="ident">numLiterals</span><span class="op">,</span>&nbsp;<span class="ident">numOffsets</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">codegenEncoding</span><span class="op">.</span><span class="ident">generate</span><span class="op">(</span><span class="ident">w</span><span class="op">.</span><span class="ident">codegenFreq</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">numCodegens</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">w</span><span class="op">.</span><span class="ident">codegenFreq</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">numCodegens</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">4</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">codegenFreq</span><span class="op">[</span><span class="ident">codegenOrder</span><span class="op">[</span><span class="ident">numCodegens</span><span class="op">-</span><span class="num">1</span><span class="op">]</span><span class="op">]</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">numCodegens</span><span class="op">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dynamicHeader</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="num">3</span><span class="op">+</span><span class="num">5</span><span class="op">+</span><span class="num">5</span><span class="op">+</span><span class="num">4</span><span class="op">+</span><span class="op">(</span><span class="num">3</span><span class="op">*</span><span class="ident">numCodegens</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">+</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">codegenEncoding</span><span class="op">.</span><span class="ident">bitLength</span><span class="op">(</span><span class="ident">w</span><span class="op">.</span><span class="ident">codegenFreq</span><span class="op">)</span>&nbsp;<span class="op">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">int64</span><span class="op">(</span><span class="ident">extraBits</span><span class="op">)</span>&nbsp;<span class="op">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">int64</span><span class="op">(</span><span class="ident">w</span><span class="op">.</span><span class="ident">codegenFreq</span><span class="op">[</span><span class="num">16</span><span class="op">]</span><span class="op">*</span><span class="num">2</span><span class="op">)</span>&nbsp;<span class="op">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">int64</span><span class="op">(</span><span class="ident">w</span><span class="op">.</span><span class="ident">codegenFreq</span><span class="op">[</span><span class="num">17</span><span class="op">]</span><span class="op">*</span><span class="num">3</span><span class="op">)</span>&nbsp;<span class="op">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">int64</span><span class="op">(</span><span class="ident">w</span><span class="op">.</span><span class="ident">codegenFreq</span><span class="op">[</span><span class="num">18</span><span class="op">]</span><span class="op">*</span><span class="num">7</span><span class="op">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dynamicSize</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dynamicHeader</span>&nbsp;<span class="op">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">literalEncoding</span><span class="op">.</span><span class="ident">bitLength</span><span class="op">(</span><span class="ident">w</span><span class="op">.</span><span class="ident">literalFreq</span><span class="op">)</span>&nbsp;<span class="op">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">offsetEncoding</span><span class="op">.</span><span class="ident">bitLength</span><span class="op">(</span><span class="ident">w</span><span class="op">.</span><span class="ident">offsetFreq</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">dynamicSize</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">size</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">size</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">dynamicSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">literalEncoding</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">literalEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">offsetEncoding</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">offsetEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Stored&nbsp;bytes?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">storedSize</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">size</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">writeStoredHeader</span><span class="op">(</span><span class="ident">storedBytes</span><span class="op">,</span>&nbsp;<span class="ident">eof</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">writeBytes</span><span class="op">(</span><span class="ident">input</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">storedBytes</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Huffman.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">literalEncoding</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">fixedLiteralEncoding</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">writeFixedHeader</span><span class="op">(</span><span class="ident">eof</span><span class="op">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">writeDynamicHeader</span><span class="op">(</span><span class="ident">numLiterals</span><span class="op">,</span>&nbsp;<span class="ident">numOffsets</span><span class="op">,</span>&nbsp;<span class="ident">numCodegens</span><span class="op">,</span>&nbsp;<span class="ident">eof</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">t</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">tokens</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">typ</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">literalType</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">writeCode</span><span class="op">(</span><span class="ident">literalEncoding</span><span class="op">,</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">literal</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">matchType</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Write&nbsp;the&nbsp;length</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">length</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">length</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lengthCode</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">lengthCode</span><span class="op">(</span><span class="ident">length</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">writeCode</span><span class="op">(</span><span class="ident">literalEncoding</span><span class="op">,</span>&nbsp;<span class="ident">lengthCode</span><span class="op">+</span><span class="ident">lengthCodesStart</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">extraLengthBits</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">int32</span><span class="op">(</span><span class="ident">lengthExtraBits</span><span class="op">[</span><span class="ident">lengthCode</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">extraLengthBits</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">extraLength</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">int32</span><span class="op">(</span><span class="ident">length</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">lengthBase</span><span class="op">[</span><span class="ident">lengthCode</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">writeBits</span><span class="op">(</span><span class="ident">extraLength</span><span class="op">,</span>&nbsp;<span class="ident">extraLengthBits</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Write&nbsp;the&nbsp;offset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">offset</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">offset</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">offsetCode</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">offsetCode</span><span class="op">(</span><span class="ident">offset</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">writeCode</span><span class="op">(</span><span class="ident">offsetEncoding</span><span class="op">,</span>&nbsp;<span class="ident">offsetCode</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">extraOffsetBits</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">int32</span><span class="op">(</span><span class="ident">offsetExtraBits</span><span class="op">[</span><span class="ident">offsetCode</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">extraOffsetBits</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">extraOffset</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">int32</span><span class="op">(</span><span class="ident">offset</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">offsetBase</span><span class="op">[</span><span class="ident">offsetCode</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">.</span><span class="ident">writeBits</span><span class="op">(</span><span class="ident">extraOffset</span><span class="op">,</span>&nbsp;<span class="ident">extraOffsetBits</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;unknown&nbsp;token&nbsp;type:&nbsp;&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="builtintype">string</span><span class="op">(</span><span class="ident">t</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span>
</div>
</body>
</html>
