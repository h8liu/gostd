<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html" class="current">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7956817">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7956872">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7956926">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7956977">//&nbsp;Tests&nbsp;for&nbsp;package&nbsp;cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7957003">package</span>&nbsp;<span class="ident" id="7957011">cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7957016">import</span>&nbsp;<span class="op" id="7957023">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7957026">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7957035">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7957042">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7957048">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7957055">&#34;net/http&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7957067">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7957088">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7957094">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7957105">&#34;path/filepath&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7957122">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7957133">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7957144">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7957155">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7957166">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7957173">)</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="7957176">func</span>&nbsp;<span class="ident" id="7957181">newRequest</span><span class="op" id="7957191">(</span><span class="ident" id="7957192">httpreq</span>&nbsp;<span class="builtintype" id="7957200">string</span><span class="op" id="7957206">)</span>&nbsp;<span class="op" id="7957208">*</span><span class="ident" id="7957209">http</span><span class="op" id="7957213">.</span><span class="ident" id="7957214">Request</span>&nbsp;<span class="op" id="7957222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7957225">buf</span>&nbsp;<span class="op" id="7957229">:=</span>&nbsp;<span class="ident" id="7957232">bufio</span><span class="op" id="7957237">.</span><span class="ident" id="7957238">NewReader</span><span class="op" id="7957247">(</span><span class="ident" id="7957248">strings</span><span class="op" id="7957255">.</span><span class="ident" id="7957256">NewReader</span><span class="op" id="7957265">(</span><span class="ident" id="7957266">httpreq</span><span class="op" id="7957273">)</span><span class="op" id="7957274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7957277">req</span><span class="op" id="7957280">,</span>&nbsp;<span class="ident" id="7957282">err</span>&nbsp;<span class="op" id="7957286">:=</span>&nbsp;<span class="ident" id="7957289">http</span><span class="op" id="7957293">.</span><span class="ident" id="7957294">ReadRequest</span><span class="op" id="7957305">(</span><span class="ident" id="7957306">buf</span><span class="op" id="7957309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7957312">if</span>&nbsp;<span class="ident" id="7957315">err</span>&nbsp;<span class="op" id="7957319">!=</span>&nbsp;<span class="builtintype" id="7957322">nil</span>&nbsp;<span class="op" id="7957326">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7957330">panic</span><span class="op" id="7957335">(</span><span class="string" id="7957336">&#34;cgi:&nbsp;bogus&nbsp;http&nbsp;request&nbsp;in&nbsp;test:&nbsp;&#34;</span>&nbsp;<span class="op" id="7957372">+</span>&nbsp;<span class="ident" id="7957374">httpreq</span><span class="op" id="7957381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7957384">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7957387">req</span><span class="op" id="7957390">.</span><span class="ident" id="7957391">RemoteAddr</span>&nbsp;<span class="op" id="7957402">=</span>&nbsp;<span class="string" id="7957404">&#34;1.2.3.4&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7957415">return</span>&nbsp;<span class="ident" id="7957422">req</span><br>
<span class="lineno"></span><span class="op" id="7957426">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="7957429">func</span>&nbsp;<span class="ident" id="7957434">runCgiTest</span><span class="op" id="7957444">(</span><span class="ident" id="7957445">t</span>&nbsp;<span class="op" id="7957447">*</span><span class="ident" id="7957448">testing</span><span class="op" id="7957455">.</span><span class="ident" id="7957456">T</span><span class="op" id="7957457">,</span>&nbsp;<span class="ident" id="7957459">h</span>&nbsp;<span class="op" id="7957461">*</span><span class="ident" id="7957462">Handler</span><span class="op" id="7957469">,</span>&nbsp;<span class="ident" id="7957471">httpreq</span>&nbsp;<span class="builtintype" id="7957479">string</span><span class="op" id="7957485">,</span>&nbsp;<span class="ident" id="7957487">expectedMap</span>&nbsp;<span class="keyword" id="7957499">map</span><span class="op" id="7957502">[</span><span class="builtintype" id="7957503">string</span><span class="op" id="7957509">]</span><span class="builtintype" id="7957510">string</span><span class="op" id="7957516">)</span>&nbsp;<span class="op" id="7957518">*</span><span class="ident" id="7957519">httptest</span><span class="op" id="7957527">.</span><span class="ident" id="7957528">ResponseRecorder</span>&nbsp;<span class="op" id="7957545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7957548">rw</span>&nbsp;<span class="op" id="7957551">:=</span>&nbsp;<span class="ident" id="7957554">httptest</span><span class="op" id="7957562">.</span><span class="ident" id="7957563">NewRecorder</span><span class="op" id="7957574">(</span><span class="op" id="7957575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7957578">req</span>&nbsp;<span class="op" id="7957582">:=</span>&nbsp;<span class="ident" id="7957585">newRequest</span><span class="op" id="7957595">(</span><span class="ident" id="7957596">httpreq</span><span class="op" id="7957603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7957606">h</span><span class="op" id="7957607">.</span><span class="ident" id="7957608">ServeHTTP</span><span class="op" id="7957617">(</span><span class="ident" id="7957618">rw</span><span class="op" id="7957620">,</span>&nbsp;<span class="ident" id="7957622">req</span><span class="op" id="7957625">)</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7957629">//&nbsp;Make&nbsp;a&nbsp;map&nbsp;to&nbsp;hold&nbsp;the&nbsp;test&nbsp;map&nbsp;that&nbsp;the&nbsp;CGI&nbsp;returns.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7957687">m</span>&nbsp;<span class="op" id="7957689">:=</span>&nbsp;<span class="builtinfunc" id="7957692">make</span><span class="op" id="7957696">(</span><span class="keyword" id="7957697">map</span><span class="op" id="7957700">[</span><span class="builtintype" id="7957701">string</span><span class="op" id="7957707">]</span><span class="builtintype" id="7957708">string</span><span class="op" id="7957714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7957717">m</span><span class="op" id="7957718">[</span><span class="string" id="7957719">&#34;_body&#34;</span><span class="op" id="7957726">]</span>&nbsp;<span class="op" id="7957728">=</span>&nbsp;<span class="ident" id="7957730">rw</span><span class="op" id="7957732">.</span><span class="ident" id="7957733">Body</span><span class="op" id="7957737">.</span><span class="ident" id="7957738">String</span><span class="op" id="7957744">(</span><span class="op" id="7957745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7957748">linesRead</span>&nbsp;<span class="op" id="7957758">:=</span>&nbsp;<span class="num" id="7957761">0</span><br>
<span class="lineno">45</span><span class="ident" id="7957763">readlines</span><span class="op" id="7957772">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7957775">for</span>&nbsp;<span class="op" id="7957779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7957783">line</span><span class="op" id="7957787">,</span>&nbsp;<span class="ident" id="7957789">err</span>&nbsp;<span class="op" id="7957793">:=</span>&nbsp;<span class="ident" id="7957796">rw</span><span class="op" id="7957798">.</span><span class="ident" id="7957799">Body</span><span class="op" id="7957803">.</span><span class="ident" id="7957804">ReadString</span><span class="op" id="7957814">(</span><span class="string" id="7957815">&#39;\n&#39;</span><span class="op" id="7957819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7957823">switch</span>&nbsp;<span class="op" id="7957830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7957834">case</span>&nbsp;<span class="ident" id="7957839">err</span>&nbsp;<span class="op" id="7957843">==</span>&nbsp;<span class="ident" id="7957846">io</span><span class="op" id="7957848">.</span><span class="ident" id="7957849">EOF</span><span class="op" id="7957852">:</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7957857">break</span>&nbsp;<span class="ident" id="7957863">readlines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7957875">case</span>&nbsp;<span class="ident" id="7957880">err</span>&nbsp;<span class="op" id="7957884">!=</span>&nbsp;<span class="builtintype" id="7957887">nil</span><span class="op" id="7957890">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7957895">t</span><span class="op" id="7957896">.</span><span class="ident" id="7957897">Fatalf</span><span class="op" id="7957903">(</span><span class="string" id="7957904">&#34;unexpected&nbsp;error&nbsp;reading&nbsp;from&nbsp;CGI:&nbsp;%v&#34;</span><span class="op" id="7957943">,</span>&nbsp;<span class="ident" id="7957945">err</span><span class="op" id="7957948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7957952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7957956">linesRead</span><span class="op" id="7957965">++</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7957970">trimmedLine</span>&nbsp;<span class="op" id="7957982">:=</span>&nbsp;<span class="ident" id="7957985">strings</span><span class="op" id="7957992">.</span><span class="ident" id="7957993">TrimRight</span><span class="op" id="7958002">(</span><span class="ident" id="7958003">line</span><span class="op" id="7958007">,</span>&nbsp;<span class="string" id="7958009">&#34;\r\n&#34;</span><span class="op" id="7958015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7958019">split</span>&nbsp;<span class="op" id="7958025">:=</span>&nbsp;<span class="ident" id="7958028">strings</span><span class="op" id="7958035">.</span><span class="ident" id="7958036">SplitN</span><span class="op" id="7958042">(</span><span class="ident" id="7958043">trimmedLine</span><span class="op" id="7958054">,</span>&nbsp;<span class="string" id="7958056">&#34;=&#34;</span><span class="op" id="7958059">,</span>&nbsp;<span class="num" id="7958061">2</span><span class="op" id="7958062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7958066">if</span>&nbsp;<span class="builtinfunc" id="7958069">len</span><span class="op" id="7958072">(</span><span class="ident" id="7958073">split</span><span class="op" id="7958078">)</span>&nbsp;<span class="op" id="7958080">!=</span>&nbsp;<span class="num" id="7958083">2</span>&nbsp;<span class="op" id="7958085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7958090">t</span><span class="op" id="7958091">.</span><span class="ident" id="7958092">Fatalf</span><span class="op" id="7958098">(</span><span class="string" id="7958099">&#34;Unexpected&nbsp;%d&nbsp;parts&nbsp;from&nbsp;invalid&nbsp;line&nbsp;number&nbsp;%v:&nbsp;%q;&nbsp;existing&nbsp;map=%v&#34;</span><span class="op" id="7958169">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7958175">len</span><span class="op" id="7958178">(</span><span class="ident" id="7958179">split</span><span class="op" id="7958184">)</span><span class="op" id="7958185">,</span>&nbsp;<span class="ident" id="7958187">linesRead</span><span class="op" id="7958196">,</span>&nbsp;<span class="ident" id="7958198">line</span><span class="op" id="7958202">,</span>&nbsp;<span class="ident" id="7958204">m</span><span class="op" id="7958205">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7958209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7958213">m</span><span class="op" id="7958214">[</span><span class="ident" id="7958215">split</span><span class="op" id="7958220">[</span><span class="num" id="7958221">0</span><span class="op" id="7958222">]</span><span class="op" id="7958223">]</span>&nbsp;<span class="op" id="7958225">=</span>&nbsp;<span class="ident" id="7958227">split</span><span class="op" id="7958232">[</span><span class="num" id="7958233">1</span><span class="op" id="7958234">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7958237">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7958241">for</span>&nbsp;<span class="ident" id="7958245">key</span><span class="op" id="7958248">,</span>&nbsp;<span class="ident" id="7958250">expected</span>&nbsp;<span class="op" id="7958259">:=</span>&nbsp;<span class="keyword" id="7958262">range</span>&nbsp;<span class="ident" id="7958268">expectedMap</span>&nbsp;<span class="op" id="7958280">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7958284">got</span>&nbsp;<span class="op" id="7958288">:=</span>&nbsp;<span class="ident" id="7958291">m</span><span class="op" id="7958292">[</span><span class="ident" id="7958293">key</span><span class="op" id="7958296">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7958300">if</span>&nbsp;<span class="ident" id="7958303">key</span>&nbsp;<span class="op" id="7958307">==</span>&nbsp;<span class="string" id="7958310">&#34;cwd&#34;</span>&nbsp;<span class="op" id="7958316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7958321">//&nbsp;For&nbsp;Windows.&nbsp;golang.org/issue/4645.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7958363">fi1</span><span class="op" id="7958366">,</span>&nbsp;<span class="ident" id="7958368">_</span>&nbsp;<span class="op" id="7958370">:=</span>&nbsp;<span class="ident" id="7958373">os</span><span class="op" id="7958375">.</span><span class="ident" id="7958376">Stat</span><span class="op" id="7958380">(</span><span class="ident" id="7958381">got</span><span class="op" id="7958384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7958389">fi2</span><span class="op" id="7958392">,</span>&nbsp;<span class="ident" id="7958394">_</span>&nbsp;<span class="op" id="7958396">:=</span>&nbsp;<span class="ident" id="7958399">os</span><span class="op" id="7958401">.</span><span class="ident" id="7958402">Stat</span><span class="op" id="7958406">(</span><span class="ident" id="7958407">expected</span><span class="op" id="7958415">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7958420">if</span>&nbsp;<span class="ident" id="7958423">os</span><span class="op" id="7958425">.</span><span class="ident" id="7958426">SameFile</span><span class="op" id="7958434">(</span><span class="ident" id="7958435">fi1</span><span class="op" id="7958438">,</span>&nbsp;<span class="ident" id="7958440">fi2</span><span class="op" id="7958443">)</span>&nbsp;<span class="op" id="7958445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7958451">got</span>&nbsp;<span class="op" id="7958455">=</span>&nbsp;<span class="ident" id="7958457">expected</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7958469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7958473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7958477">if</span>&nbsp;<span class="ident" id="7958480">got</span>&nbsp;<span class="op" id="7958484">!=</span>&nbsp;<span class="ident" id="7958487">expected</span>&nbsp;<span class="op" id="7958496">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7958501">t</span><span class="op" id="7958502">.</span><span class="ident" id="7958503">Errorf</span><span class="op" id="7958509">(</span><span class="string" id="7958510">&#34;for&nbsp;key&nbsp;%q&nbsp;got&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7958542">,</span>&nbsp;<span class="ident" id="7958544">key</span><span class="op" id="7958547">,</span>&nbsp;<span class="ident" id="7958549">got</span><span class="op" id="7958552">,</span>&nbsp;<span class="ident" id="7958554">expected</span><span class="op" id="7958562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7958566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7958569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7958572">return</span>&nbsp;<span class="ident" id="7958579">rw</span><br>
<span class="lineno"></span><span class="op" id="7958582">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="7958585">var</span>&nbsp;<span class="ident" id="7958589">cgiTested</span><span class="op" id="7958598">,</span>&nbsp;<span class="ident" id="7958600">cgiWorks</span>&nbsp;<span class="builtintype" id="7958609">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7958615">func</span>&nbsp;<span class="ident" id="7958620">check</span><span class="op" id="7958625">(</span><span class="ident" id="7958626">t</span>&nbsp;<span class="op" id="7958628">*</span><span class="ident" id="7958629">testing</span><span class="op" id="7958636">.</span><span class="ident" id="7958637">T</span><span class="op" id="7958638">)</span>&nbsp;<span class="op" id="7958640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7958643">if</span>&nbsp;<span class="op" id="7958646">!</span><span class="ident" id="7958647">cgiTested</span>&nbsp;<span class="op" id="7958657">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7958661">cgiTested</span>&nbsp;<span class="op" id="7958671">=</span>&nbsp;<span class="builtintype" id="7958673">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7958680">cgiWorks</span>&nbsp;<span class="op" id="7958689">=</span>&nbsp;<span class="ident" id="7958691">exec</span><span class="op" id="7958695">.</span><span class="ident" id="7958696">Command</span><span class="op" id="7958703">(</span><span class="string" id="7958704">&#34;./testdata/test.cgi&#34;</span><span class="op" id="7958725">)</span><span class="op" id="7958726">.</span><span class="ident" id="7958727">Run</span><span class="op" id="7958730">(</span><span class="op" id="7958731">)</span>&nbsp;<span class="op" id="7958733">==</span>&nbsp;<span class="builtintype" id="7958736">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7958741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7958744">if</span>&nbsp;<span class="op" id="7958747">!</span><span class="ident" id="7958748">cgiWorks</span>&nbsp;<span class="op" id="7958757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7958761">//&nbsp;No&nbsp;Perl&nbsp;on&nbsp;Windows,&nbsp;needed&nbsp;by&nbsp;test.cgi</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7958805">//&nbsp;TODO:&nbsp;make&nbsp;the&nbsp;child&nbsp;process&nbsp;be&nbsp;Go,&nbsp;not&nbsp;Perl.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7958856">t</span><span class="op" id="7958857">.</span><span class="ident" id="7958858">Skip</span><span class="op" id="7958862">(</span><span class="string" id="7958863">&#34;Skipping&nbsp;test:&nbsp;test.cgi&nbsp;failed.&#34;</span><span class="op" id="7958896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7958899">}</span><br>
<span class="lineno"></span><span class="op" id="7958901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="7958904">func</span>&nbsp;<span class="ident" id="7958909">TestCGIBasicGet</span><span class="op" id="7958924">(</span><span class="ident" id="7958925">t</span>&nbsp;<span class="op" id="7958927">*</span><span class="ident" id="7958928">testing</span><span class="op" id="7958935">.</span><span class="ident" id="7958936">T</span><span class="op" id="7958937">)</span>&nbsp;<span class="op" id="7958939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7958942">check</span><span class="op" id="7958947">(</span><span class="ident" id="7958948">t</span><span class="op" id="7958949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7958952">h</span>&nbsp;<span class="op" id="7958954">:=</span>&nbsp;<span class="op" id="7958957">&amp;</span><span class="ident" id="7958958">Handler</span><span class="op" id="7958965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7958969">Path</span><span class="op" id="7958973">:</span>&nbsp;<span class="string" id="7958975">&#34;testdata/test.cgi&#34;</span><span class="op" id="7958994">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7958998">Root</span><span class="op" id="7959002">:</span>&nbsp;<span class="string" id="7959004">&#34;/test.cgi&#34;</span><span class="op" id="7959015">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7959018">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7959021">expectedMap</span>&nbsp;<span class="op" id="7959033">:=</span>&nbsp;<span class="keyword" id="7959036">map</span><span class="op" id="7959039">[</span><span class="builtintype" id="7959040">string</span><span class="op" id="7959046">]</span><span class="builtintype" id="7959047">string</span><span class="op" id="7959053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7959057">&#34;test&#34;</span><span class="op" id="7959063">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7959082">&#34;Hello&nbsp;CGI&#34;</span><span class="op" id="7959093">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7959097">&#34;param-a&#34;</span><span class="op" id="7959106">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7959122">&#34;b&#34;</span><span class="op" id="7959125">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7959129">&#34;param-foo&#34;</span><span class="op" id="7959140">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7959154">&#34;bar&#34;</span><span class="op" id="7959159">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7959163">&#34;env-GATEWAY_INTERFACE&#34;</span><span class="op" id="7959186">:</span>&nbsp;<span class="string" id="7959188">&#34;CGI/1.1&#34;</span><span class="op" id="7959197">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7959201">&#34;env-HTTP_HOST&#34;</span><span class="op" id="7959216">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7959226">&#34;example.com&#34;</span><span class="op" id="7959239">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7959243">&#34;env-PATH_INFO&#34;</span><span class="op" id="7959258">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7959268">&#34;&#34;</span><span class="op" id="7959270">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7959274">&#34;env-QUERY_STRING&#34;</span><span class="op" id="7959292">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7959299">&#34;foo=bar&amp;a=b&#34;</span><span class="op" id="7959312">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7959316">&#34;env-REMOTE_ADDR&#34;</span><span class="op" id="7959333">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7959341">&#34;1.2.3.4&#34;</span><span class="op" id="7959350">,</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7959354">&#34;env-REMOTE_HOST&#34;</span><span class="op" id="7959371">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7959379">&#34;1.2.3.4&#34;</span><span class="op" id="7959388">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7959392">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="7959412">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7959417">&#34;GET&#34;</span><span class="op" id="7959422">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7959426">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7959443">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7959451">&#34;/test.cgi?foo=bar&amp;a=b&#34;</span><span class="op" id="7959474">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7959478">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7959499">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="7959503">&#34;testdata/test.cgi&#34;</span><span class="op" id="7959522">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7959526">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7959543">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7959551">&#34;/test.cgi&#34;</span><span class="op" id="7959562">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7959566">&#34;env-SERVER_NAME&#34;</span><span class="op" id="7959583">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7959591">&#34;example.com&#34;</span><span class="op" id="7959604">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7959608">&#34;env-SERVER_PORT&#34;</span><span class="op" id="7959625">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7959633">&#34;80&#34;</span><span class="op" id="7959637">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7959641">&#34;env-SERVER_SOFTWARE&#34;</span><span class="op" id="7959662">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="7959666">&#34;go&#34;</span><span class="op" id="7959670">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7959673">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7959676">replay</span>&nbsp;<span class="op" id="7959683">:=</span>&nbsp;<span class="ident" id="7959686">runCgiTest</span><span class="op" id="7959696">(</span><span class="ident" id="7959697">t</span><span class="op" id="7959698">,</span>&nbsp;<span class="ident" id="7959700">h</span><span class="op" id="7959701">,</span>&nbsp;<span class="string" id="7959703">&#34;GET&nbsp;/test.cgi?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7959762">,</span>&nbsp;<span class="ident" id="7959764">expectedMap</span><span class="op" id="7959775">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7959779">if</span>&nbsp;<span class="ident" id="7959782">expected</span><span class="op" id="7959790">,</span>&nbsp;<span class="ident" id="7959792">got</span>&nbsp;<span class="op" id="7959796">:=</span>&nbsp;<span class="string" id="7959799">&#34;text/html&#34;</span><span class="op" id="7959810">,</span>&nbsp;<span class="ident" id="7959812">replay</span><span class="op" id="7959818">.</span><span class="ident" id="7959819">Header</span><span class="op" id="7959825">(</span><span class="op" id="7959826">)</span><span class="op" id="7959827">.</span><span class="ident" id="7959828">Get</span><span class="op" id="7959831">(</span><span class="string" id="7959832">&#34;Content-Type&#34;</span><span class="op" id="7959846">)</span><span class="op" id="7959847">;</span>&nbsp;<span class="ident" id="7959849">got</span>&nbsp;<span class="op" id="7959853">!=</span>&nbsp;<span class="ident" id="7959856">expected</span>&nbsp;<span class="op" id="7959865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7959869">t</span><span class="op" id="7959870">.</span><span class="ident" id="7959871">Errorf</span><span class="op" id="7959877">(</span><span class="string" id="7959878">&#34;got&nbsp;a&nbsp;Content-Type&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7959917">,</span>&nbsp;<span class="ident" id="7959919">got</span><span class="op" id="7959922">,</span>&nbsp;<span class="ident" id="7959924">expected</span><span class="op" id="7959932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7959935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7959938">if</span>&nbsp;<span class="ident" id="7959941">expected</span><span class="op" id="7959949">,</span>&nbsp;<span class="ident" id="7959951">got</span>&nbsp;<span class="op" id="7959955">:=</span>&nbsp;<span class="string" id="7959958">&#34;X-Test-Value&#34;</span><span class="op" id="7959972">,</span>&nbsp;<span class="ident" id="7959974">replay</span><span class="op" id="7959980">.</span><span class="ident" id="7959981">Header</span><span class="op" id="7959987">(</span><span class="op" id="7959988">)</span><span class="op" id="7959989">.</span><span class="ident" id="7959990">Get</span><span class="op" id="7959993">(</span><span class="string" id="7959994">&#34;X-Test-Header&#34;</span><span class="op" id="7960009">)</span><span class="op" id="7960010">;</span>&nbsp;<span class="ident" id="7960012">got</span>&nbsp;<span class="op" id="7960016">!=</span>&nbsp;<span class="ident" id="7960019">expected</span>&nbsp;<span class="op" id="7960028">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7960032">t</span><span class="op" id="7960033">.</span><span class="ident" id="7960034">Errorf</span><span class="op" id="7960040">(</span><span class="string" id="7960041">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7960081">,</span>&nbsp;<span class="ident" id="7960083">got</span><span class="op" id="7960086">,</span>&nbsp;<span class="ident" id="7960088">expected</span><span class="op" id="7960096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7960099">}</span><br>
<span class="lineno"></span><span class="op" id="7960101">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7960104">func</span>&nbsp;<span class="ident" id="7960109">TestCGIBasicGetAbsPath</span><span class="op" id="7960131">(</span><span class="ident" id="7960132">t</span>&nbsp;<span class="op" id="7960134">*</span><span class="ident" id="7960135">testing</span><span class="op" id="7960142">.</span><span class="ident" id="7960143">T</span><span class="op" id="7960144">)</span>&nbsp;<span class="op" id="7960146">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7960149">check</span><span class="op" id="7960154">(</span><span class="ident" id="7960155">t</span><span class="op" id="7960156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7960159">pwd</span><span class="op" id="7960162">,</span>&nbsp;<span class="ident" id="7960164">err</span>&nbsp;<span class="op" id="7960168">:=</span>&nbsp;<span class="ident" id="7960171">os</span><span class="op" id="7960173">.</span><span class="ident" id="7960174">Getwd</span><span class="op" id="7960179">(</span><span class="op" id="7960180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7960183">if</span>&nbsp;<span class="ident" id="7960186">err</span>&nbsp;<span class="op" id="7960190">!=</span>&nbsp;<span class="builtintype" id="7960193">nil</span>&nbsp;<span class="op" id="7960197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7960201">t</span><span class="op" id="7960202">.</span><span class="ident" id="7960203">Fatalf</span><span class="op" id="7960209">(</span><span class="string" id="7960210">&#34;getwd&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="7960227">,</span>&nbsp;<span class="ident" id="7960229">err</span><span class="op" id="7960232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7960235">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7960238">h</span>&nbsp;<span class="op" id="7960240">:=</span>&nbsp;<span class="op" id="7960243">&amp;</span><span class="ident" id="7960244">Handler</span><span class="op" id="7960251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7960255">Path</span><span class="op" id="7960259">:</span>&nbsp;<span class="ident" id="7960261">pwd</span>&nbsp;<span class="op" id="7960265">+</span>&nbsp;<span class="string" id="7960267">&#34;/testdata/test.cgi&#34;</span><span class="op" id="7960287">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7960291">Root</span><span class="op" id="7960295">:</span>&nbsp;<span class="string" id="7960297">&#34;/test.cgi&#34;</span><span class="op" id="7960308">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7960311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7960314">expectedMap</span>&nbsp;<span class="op" id="7960326">:=</span>&nbsp;<span class="keyword" id="7960329">map</span><span class="op" id="7960332">[</span><span class="builtintype" id="7960333">string</span><span class="op" id="7960339">]</span><span class="builtintype" id="7960340">string</span><span class="op" id="7960346">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7960350">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7960367">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7960373">&#34;/test.cgi?foo=bar&amp;a=b&#34;</span><span class="op" id="7960396">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7960400">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7960421">:</span>&nbsp;<span class="ident" id="7960423">pwd</span>&nbsp;<span class="op" id="7960427">+</span>&nbsp;<span class="string" id="7960429">&#34;/testdata/test.cgi&#34;</span><span class="op" id="7960449">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7960453">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7960470">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7960476">&#34;/test.cgi&#34;</span><span class="op" id="7960487">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7960490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7960493">runCgiTest</span><span class="op" id="7960503">(</span><span class="ident" id="7960504">t</span><span class="op" id="7960505">,</span>&nbsp;<span class="ident" id="7960507">h</span><span class="op" id="7960508">,</span>&nbsp;<span class="string" id="7960510">&#34;GET&nbsp;/test.cgi?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7960569">,</span>&nbsp;<span class="ident" id="7960571">expectedMap</span><span class="op" id="7960582">)</span><br>
<span class="lineno">145</span><span class="op" id="7960584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7960587">func</span>&nbsp;<span class="ident" id="7960592">TestPathInfo</span><span class="op" id="7960604">(</span><span class="ident" id="7960605">t</span>&nbsp;<span class="op" id="7960607">*</span><span class="ident" id="7960608">testing</span><span class="op" id="7960615">.</span><span class="ident" id="7960616">T</span><span class="op" id="7960617">)</span>&nbsp;<span class="op" id="7960619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7960622">check</span><span class="op" id="7960627">(</span><span class="ident" id="7960628">t</span><span class="op" id="7960629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7960632">h</span>&nbsp;<span class="op" id="7960634">:=</span>&nbsp;<span class="op" id="7960637">&amp;</span><span class="ident" id="7960638">Handler</span><span class="op" id="7960645">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7960649">Path</span><span class="op" id="7960653">:</span>&nbsp;<span class="string" id="7960655">&#34;testdata/test.cgi&#34;</span><span class="op" id="7960674">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7960678">Root</span><span class="op" id="7960682">:</span>&nbsp;<span class="string" id="7960684">&#34;/test.cgi&#34;</span><span class="op" id="7960695">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7960698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7960701">expectedMap</span>&nbsp;<span class="op" id="7960713">:=</span>&nbsp;<span class="keyword" id="7960716">map</span><span class="op" id="7960719">[</span><span class="builtintype" id="7960720">string</span><span class="op" id="7960726">]</span><span class="builtintype" id="7960727">string</span><span class="op" id="7960733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7960737">&#34;param-a&#34;</span><span class="op" id="7960746">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7960760">&#34;b&#34;</span><span class="op" id="7960763">,</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7960767">&#34;env-PATH_INFO&#34;</span><span class="op" id="7960782">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7960790">&#34;/extrapath&#34;</span><span class="op" id="7960802">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7960806">&#34;env-QUERY_STRING&#34;</span><span class="op" id="7960824">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7960829">&#34;a=b&#34;</span><span class="op" id="7960834">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7960838">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7960855">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7960861">&#34;/test.cgi/extrapath?a=b&#34;</span><span class="op" id="7960886">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7960890">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7960911">:</span>&nbsp;<span class="string" id="7960913">&#34;testdata/test.cgi&#34;</span><span class="op" id="7960932">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7960936">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7960953">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7960959">&#34;/test.cgi&#34;</span><span class="op" id="7960970">,</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7960973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7960976">runCgiTest</span><span class="op" id="7960986">(</span><span class="ident" id="7960987">t</span><span class="op" id="7960988">,</span>&nbsp;<span class="ident" id="7960990">h</span><span class="op" id="7960991">,</span>&nbsp;<span class="string" id="7960993">&#34;GET&nbsp;/test.cgi/extrapath?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7961054">,</span>&nbsp;<span class="ident" id="7961056">expectedMap</span><span class="op" id="7961067">)</span><br>
<span class="lineno"></span><span class="op" id="7961069">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7961072">func</span>&nbsp;<span class="ident" id="7961077">TestPathInfoDirRoot</span><span class="op" id="7961096">(</span><span class="ident" id="7961097">t</span>&nbsp;<span class="op" id="7961099">*</span><span class="ident" id="7961100">testing</span><span class="op" id="7961107">.</span><span class="ident" id="7961108">T</span><span class="op" id="7961109">)</span>&nbsp;<span class="op" id="7961111">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7961114">check</span><span class="op" id="7961119">(</span><span class="ident" id="7961120">t</span><span class="op" id="7961121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7961124">h</span>&nbsp;<span class="op" id="7961126">:=</span>&nbsp;<span class="op" id="7961129">&amp;</span><span class="ident" id="7961130">Handler</span><span class="op" id="7961137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7961141">Path</span><span class="op" id="7961145">:</span>&nbsp;<span class="string" id="7961147">&#34;testdata/test.cgi&#34;</span><span class="op" id="7961166">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7961170">Root</span><span class="op" id="7961174">:</span>&nbsp;<span class="string" id="7961176">&#34;/myscript/&#34;</span><span class="op" id="7961188">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7961191">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7961194">expectedMap</span>&nbsp;<span class="op" id="7961206">:=</span>&nbsp;<span class="keyword" id="7961209">map</span><span class="op" id="7961212">[</span><span class="builtintype" id="7961213">string</span><span class="op" id="7961219">]</span><span class="builtintype" id="7961220">string</span><span class="op" id="7961226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7961230">&#34;env-PATH_INFO&#34;</span><span class="op" id="7961245">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7961253">&#34;bar&#34;</span><span class="op" id="7961258">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7961262">&#34;env-QUERY_STRING&#34;</span><span class="op" id="7961280">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7961285">&#34;a=b&#34;</span><span class="op" id="7961290">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7961294">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7961311">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7961317">&#34;/myscript/bar?a=b&#34;</span><span class="op" id="7961336">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7961340">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7961361">:</span>&nbsp;<span class="string" id="7961363">&#34;testdata/test.cgi&#34;</span><span class="op" id="7961382">,</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7961386">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7961403">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7961409">&#34;/myscript/&#34;</span><span class="op" id="7961421">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7961424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7961427">runCgiTest</span><span class="op" id="7961437">(</span><span class="ident" id="7961438">t</span><span class="op" id="7961439">,</span>&nbsp;<span class="ident" id="7961441">h</span><span class="op" id="7961442">,</span>&nbsp;<span class="string" id="7961444">&#34;GET&nbsp;/myscript/bar?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7961499">,</span>&nbsp;<span class="ident" id="7961501">expectedMap</span><span class="op" id="7961512">)</span><br>
<span class="lineno"></span><span class="op" id="7961514">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="7961517">func</span>&nbsp;<span class="ident" id="7961522">TestDupHeaders</span><span class="op" id="7961536">(</span><span class="ident" id="7961537">t</span>&nbsp;<span class="op" id="7961539">*</span><span class="ident" id="7961540">testing</span><span class="op" id="7961547">.</span><span class="ident" id="7961548">T</span><span class="op" id="7961549">)</span>&nbsp;<span class="op" id="7961551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7961554">check</span><span class="op" id="7961559">(</span><span class="ident" id="7961560">t</span><span class="op" id="7961561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7961564">h</span>&nbsp;<span class="op" id="7961566">:=</span>&nbsp;<span class="op" id="7961569">&amp;</span><span class="ident" id="7961570">Handler</span><span class="op" id="7961577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7961581">Path</span><span class="op" id="7961585">:</span>&nbsp;<span class="string" id="7961587">&#34;testdata/test.cgi&#34;</span><span class="op" id="7961606">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7961609">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7961612">expectedMap</span>&nbsp;<span class="op" id="7961624">:=</span>&nbsp;<span class="keyword" id="7961627">map</span><span class="op" id="7961630">[</span><span class="builtintype" id="7961631">string</span><span class="op" id="7961637">]</span><span class="builtintype" id="7961638">string</span><span class="op" id="7961644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7961648">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7961665">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7961671">&#34;/myscript/bar?a=b&#34;</span><span class="op" id="7961690">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7961694">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7961715">:</span>&nbsp;<span class="string" id="7961717">&#34;testdata/test.cgi&#34;</span><span class="op" id="7961736">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7961740">&#34;env-HTTP_COOKIE&#34;</span><span class="op" id="7961757">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7961763">&#34;nom=NOM;&nbsp;yum=YUM&#34;</span><span class="op" id="7961781">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7961785">&#34;env-HTTP_X_FOO&#34;</span><span class="op" id="7961801">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7961808">&#34;val1,&nbsp;val2&#34;</span><span class="op" id="7961820">,</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7961823">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7961826">runCgiTest</span><span class="op" id="7961836">(</span><span class="ident" id="7961837">t</span><span class="op" id="7961838">,</span>&nbsp;<span class="ident" id="7961840">h</span><span class="op" id="7961841">,</span>&nbsp;<span class="string" id="7961843">&#34;GET&nbsp;/myscript/bar?a=b&nbsp;HTTP/1.0\n&#34;</span><span class="op" id="7961877">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7961881">&#34;Cookie:&nbsp;nom=NOM\n&#34;</span><span class="op" id="7961900">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7961904">&#34;Cookie:&nbsp;yum=YUM\n&#34;</span><span class="op" id="7961923">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7961927">&#34;X-Foo:&nbsp;val1\n&#34;</span><span class="op" id="7961942">+</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7961946">&#34;X-Foo:&nbsp;val2\n&#34;</span><span class="op" id="7961961">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7961965">&#34;Host:&nbsp;example.com\n\n&#34;</span><span class="op" id="7961988">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7961992">expectedMap</span><span class="op" id="7962003">)</span><br>
<span class="lineno"></span><span class="op" id="7962005">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span><span class="keyword" id="7962008">func</span>&nbsp;<span class="ident" id="7962013">TestPathInfoNoRoot</span><span class="op" id="7962031">(</span><span class="ident" id="7962032">t</span>&nbsp;<span class="op" id="7962034">*</span><span class="ident" id="7962035">testing</span><span class="op" id="7962042">.</span><span class="ident" id="7962043">T</span><span class="op" id="7962044">)</span>&nbsp;<span class="op" id="7962046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7962049">check</span><span class="op" id="7962054">(</span><span class="ident" id="7962055">t</span><span class="op" id="7962056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7962059">h</span>&nbsp;<span class="op" id="7962061">:=</span>&nbsp;<span class="op" id="7962064">&amp;</span><span class="ident" id="7962065">Handler</span><span class="op" id="7962072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7962076">Path</span><span class="op" id="7962080">:</span>&nbsp;<span class="string" id="7962082">&#34;testdata/test.cgi&#34;</span><span class="op" id="7962101">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7962105">Root</span><span class="op" id="7962109">:</span>&nbsp;<span class="string" id="7962111">&#34;&#34;</span><span class="op" id="7962113">,</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7962116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7962119">expectedMap</span>&nbsp;<span class="op" id="7962131">:=</span>&nbsp;<span class="keyword" id="7962134">map</span><span class="op" id="7962137">[</span><span class="builtintype" id="7962138">string</span><span class="op" id="7962144">]</span><span class="builtintype" id="7962145">string</span><span class="op" id="7962151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7962155">&#34;env-PATH_INFO&#34;</span><span class="op" id="7962170">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7962178">&#34;/bar&#34;</span><span class="op" id="7962184">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7962188">&#34;env-QUERY_STRING&#34;</span><span class="op" id="7962206">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7962211">&#34;a=b&#34;</span><span class="op" id="7962216">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7962220">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7962237">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7962243">&#34;/bar?a=b&#34;</span><span class="op" id="7962253">,</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7962257">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7962278">:</span>&nbsp;<span class="string" id="7962280">&#34;testdata/test.cgi&#34;</span><span class="op" id="7962299">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7962303">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7962320">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7962326">&#34;/&#34;</span><span class="op" id="7962329">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7962332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7962335">runCgiTest</span><span class="op" id="7962345">(</span><span class="ident" id="7962346">t</span><span class="op" id="7962347">,</span>&nbsp;<span class="ident" id="7962349">h</span><span class="op" id="7962350">,</span>&nbsp;<span class="string" id="7962352">&#34;GET&nbsp;/bar?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7962398">,</span>&nbsp;<span class="ident" id="7962400">expectedMap</span><span class="op" id="7962411">)</span><br>
<span class="lineno"></span><span class="op" id="7962413">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="7962416">func</span>&nbsp;<span class="ident" id="7962421">TestCGIBasicPost</span><span class="op" id="7962437">(</span><span class="ident" id="7962438">t</span>&nbsp;<span class="op" id="7962440">*</span><span class="ident" id="7962441">testing</span><span class="op" id="7962448">.</span><span class="ident" id="7962449">T</span><span class="op" id="7962450">)</span>&nbsp;<span class="op" id="7962452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7962455">check</span><span class="op" id="7962460">(</span><span class="ident" id="7962461">t</span><span class="op" id="7962462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7962465">postReq</span>&nbsp;<span class="op" id="7962473">:=</span>&nbsp;<span class="string" id="7962476">`POST&nbsp;/test.cgi?a=b&nbsp;HTTP/1.0<br>
<span class="lineno"></span>Host:&nbsp;example.com<br>
<span class="lineno">220</span>Content-Type:&nbsp;application/x-www-form-urlencoded<br>
<span class="lineno"></span>Content-Length:&nbsp;15<br>
<span class="lineno"></span><br>
<span class="lineno"></span>postfoo=postbar`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7962609">h</span>&nbsp;<span class="op" id="7962611">:=</span>&nbsp;<span class="op" id="7962614">&amp;</span><span class="ident" id="7962615">Handler</span><span class="op" id="7962622">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7962626">Path</span><span class="op" id="7962630">:</span>&nbsp;<span class="string" id="7962632">&#34;testdata/test.cgi&#34;</span><span class="op" id="7962651">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7962655">Root</span><span class="op" id="7962659">:</span>&nbsp;<span class="string" id="7962661">&#34;/test.cgi&#34;</span><span class="op" id="7962672">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7962675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7962678">expectedMap</span>&nbsp;<span class="op" id="7962690">:=</span>&nbsp;<span class="keyword" id="7962693">map</span><span class="op" id="7962696">[</span><span class="builtintype" id="7962697">string</span><span class="op" id="7962703">]</span><span class="builtintype" id="7962704">string</span><span class="op" id="7962710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7962714">&#34;test&#34;</span><span class="op" id="7962720">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7962736">&#34;Hello&nbsp;CGI&#34;</span><span class="op" id="7962747">,</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7962751">&#34;param-postfoo&#34;</span><span class="op" id="7962766">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7962773">&#34;postbar&#34;</span><span class="op" id="7962782">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7962786">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="7962806">:</span>&nbsp;<span class="string" id="7962808">&#34;POST&#34;</span><span class="op" id="7962814">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7962818">&#34;env-CONTENT_LENGTH&#34;</span><span class="op" id="7962838">:</span>&nbsp;<span class="string" id="7962840">&#34;15&#34;</span><span class="op" id="7962844">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7962848">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7962865">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7962870">&#34;/test.cgi?a=b&#34;</span><span class="op" id="7962885">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7962888">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7962891">runCgiTest</span><span class="op" id="7962901">(</span><span class="ident" id="7962902">t</span><span class="op" id="7962903">,</span>&nbsp;<span class="ident" id="7962905">h</span><span class="op" id="7962906">,</span>&nbsp;<span class="ident" id="7962908">postReq</span><span class="op" id="7962915">,</span>&nbsp;<span class="ident" id="7962917">expectedMap</span><span class="op" id="7962928">)</span><br>
<span class="lineno"></span><span class="op" id="7962930">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7962933">func</span>&nbsp;<span class="ident" id="7962938">chunk</span><span class="op" id="7962943">(</span><span class="ident" id="7962944">s</span>&nbsp;<span class="builtintype" id="7962946">string</span><span class="op" id="7962952">)</span>&nbsp;<span class="builtintype" id="7962954">string</span>&nbsp;<span class="op" id="7962961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7962964">return</span>&nbsp;<span class="ident" id="7962971">fmt</span><span class="op" id="7962974">.</span><span class="ident" id="7962975">Sprintf</span><span class="op" id="7962982">(</span><span class="string" id="7962983">&#34;%x\r\n%s\r\n&#34;</span><span class="op" id="7962997">,</span>&nbsp;<span class="builtinfunc" id="7962999">len</span><span class="op" id="7963002">(</span><span class="ident" id="7963003">s</span><span class="op" id="7963004">)</span><span class="op" id="7963005">,</span>&nbsp;<span class="ident" id="7963007">s</span><span class="op" id="7963008">)</span><br>
<span class="lineno">240</span><span class="op" id="7963010">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7963013">//&nbsp;The&nbsp;CGI&nbsp;spec&nbsp;doesn&#39;t&nbsp;allow&nbsp;chunked&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="7963061">func</span>&nbsp;<span class="ident" id="7963066">TestCGIPostChunked</span><span class="op" id="7963084">(</span><span class="ident" id="7963085">t</span>&nbsp;<span class="op" id="7963087">*</span><span class="ident" id="7963088">testing</span><span class="op" id="7963095">.</span><span class="ident" id="7963096">T</span><span class="op" id="7963097">)</span>&nbsp;<span class="op" id="7963099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7963102">check</span><span class="op" id="7963107">(</span><span class="ident" id="7963108">t</span><span class="op" id="7963109">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7963112">postReq</span>&nbsp;<span class="op" id="7963120">:=</span>&nbsp;<span class="string" id="7963123">`POST&nbsp;/test.cgi?a=b&nbsp;HTTP/1.1<br>
<span class="lineno"></span>Host:&nbsp;example.com<br>
<span class="lineno"></span>Content-Type:&nbsp;application/x-www-form-urlencoded<br>
<span class="lineno"></span>Transfer-Encoding:&nbsp;chunked<br>
<span class="lineno"></span><br>
<span class="lineno">250</span>`</span>&nbsp;<span class="op" id="7963248">+</span>&nbsp;<span class="ident" id="7963250">chunk</span><span class="op" id="7963255">(</span><span class="string" id="7963256">&#34;postfoo&#34;</span><span class="op" id="7963265">)</span>&nbsp;<span class="op" id="7963267">+</span>&nbsp;<span class="ident" id="7963269">chunk</span><span class="op" id="7963274">(</span><span class="string" id="7963275">&#34;=&#34;</span><span class="op" id="7963278">)</span>&nbsp;<span class="op" id="7963280">+</span>&nbsp;<span class="ident" id="7963282">chunk</span><span class="op" id="7963287">(</span><span class="string" id="7963288">&#34;postbar&#34;</span><span class="op" id="7963297">)</span>&nbsp;<span class="op" id="7963299">+</span>&nbsp;<span class="ident" id="7963301">chunk</span><span class="op" id="7963306">(</span><span class="string" id="7963307">&#34;&#34;</span><span class="op" id="7963309">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7963313">h</span>&nbsp;<span class="op" id="7963315">:=</span>&nbsp;<span class="op" id="7963318">&amp;</span><span class="ident" id="7963319">Handler</span><span class="op" id="7963326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7963330">Path</span><span class="op" id="7963334">:</span>&nbsp;<span class="string" id="7963336">&#34;testdata/test.cgi&#34;</span><span class="op" id="7963355">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7963359">Root</span><span class="op" id="7963363">:</span>&nbsp;<span class="string" id="7963365">&#34;/test.cgi&#34;</span><span class="op" id="7963376">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7963379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7963382">expectedMap</span>&nbsp;<span class="op" id="7963394">:=</span>&nbsp;<span class="keyword" id="7963397">map</span><span class="op" id="7963400">[</span><span class="builtintype" id="7963401">string</span><span class="op" id="7963407">]</span><span class="builtintype" id="7963408">string</span><span class="op" id="7963414">{</span><span class="op" id="7963415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7963418">resp</span>&nbsp;<span class="op" id="7963423">:=</span>&nbsp;<span class="ident" id="7963426">runCgiTest</span><span class="op" id="7963436">(</span><span class="ident" id="7963437">t</span><span class="op" id="7963438">,</span>&nbsp;<span class="ident" id="7963440">h</span><span class="op" id="7963441">,</span>&nbsp;<span class="ident" id="7963443">postReq</span><span class="op" id="7963450">,</span>&nbsp;<span class="ident" id="7963452">expectedMap</span><span class="op" id="7963463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7963466">if</span>&nbsp;<span class="ident" id="7963469">got</span><span class="op" id="7963472">,</span>&nbsp;<span class="ident" id="7963474">expected</span>&nbsp;<span class="op" id="7963483">:=</span>&nbsp;<span class="ident" id="7963486">resp</span><span class="op" id="7963490">.</span><span class="ident" id="7963491">Code</span><span class="op" id="7963495">,</span>&nbsp;<span class="ident" id="7963497">http</span><span class="op" id="7963501">.</span><span class="ident" id="7963502">StatusBadRequest</span><span class="op" id="7963518">;</span>&nbsp;<span class="ident" id="7963520">got</span>&nbsp;<span class="op" id="7963524">!=</span>&nbsp;<span class="ident" id="7963527">expected</span>&nbsp;<span class="op" id="7963536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7963540">t</span><span class="op" id="7963541">.</span><span class="ident" id="7963542">Fatalf</span><span class="op" id="7963548">(</span><span class="string" id="7963549">&#34;Expected&nbsp;%v&nbsp;response&nbsp;code&nbsp;from&nbsp;chunked&nbsp;request&nbsp;body;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="7963610">,</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7963615">expected</span><span class="op" id="7963623">,</span>&nbsp;<span class="ident" id="7963625">got</span><span class="op" id="7963628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7963631">}</span><br>
<span class="lineno"></span><span class="op" id="7963633">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7963636">func</span>&nbsp;<span class="ident" id="7963641">TestRedirect</span><span class="op" id="7963653">(</span><span class="ident" id="7963654">t</span>&nbsp;<span class="op" id="7963656">*</span><span class="ident" id="7963657">testing</span><span class="op" id="7963664">.</span><span class="ident" id="7963665">T</span><span class="op" id="7963666">)</span>&nbsp;<span class="op" id="7963668">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7963671">check</span><span class="op" id="7963676">(</span><span class="ident" id="7963677">t</span><span class="op" id="7963678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7963681">h</span>&nbsp;<span class="op" id="7963683">:=</span>&nbsp;<span class="op" id="7963686">&amp;</span><span class="ident" id="7963687">Handler</span><span class="op" id="7963694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7963698">Path</span><span class="op" id="7963702">:</span>&nbsp;<span class="string" id="7963704">&#34;testdata/test.cgi&#34;</span><span class="op" id="7963723">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7963727">Root</span><span class="op" id="7963731">:</span>&nbsp;<span class="string" id="7963733">&#34;/test.cgi&#34;</span><span class="op" id="7963744">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7963747">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7963750">rec</span>&nbsp;<span class="op" id="7963754">:=</span>&nbsp;<span class="ident" id="7963757">runCgiTest</span><span class="op" id="7963767">(</span><span class="ident" id="7963768">t</span><span class="op" id="7963769">,</span>&nbsp;<span class="ident" id="7963771">h</span><span class="op" id="7963772">,</span>&nbsp;<span class="string" id="7963774">&#34;GET&nbsp;/test.cgi?loc=http://foo.com/&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7963841">,</span>&nbsp;<span class="builtintype" id="7963843">nil</span><span class="op" id="7963846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7963849">if</span>&nbsp;<span class="ident" id="7963852">e</span><span class="op" id="7963853">,</span>&nbsp;<span class="ident" id="7963855">g</span>&nbsp;<span class="op" id="7963857">:=</span>&nbsp;<span class="num" id="7963860">302</span><span class="op" id="7963863">,</span>&nbsp;<span class="ident" id="7963865">rec</span><span class="op" id="7963868">.</span><span class="ident" id="7963869">Code</span><span class="op" id="7963873">;</span>&nbsp;<span class="ident" id="7963875">e</span>&nbsp;<span class="op" id="7963877">!=</span>&nbsp;<span class="ident" id="7963880">g</span>&nbsp;<span class="op" id="7963882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7963886">t</span><span class="op" id="7963887">.</span><span class="ident" id="7963888">Errorf</span><span class="op" id="7963894">(</span><span class="string" id="7963895">&#34;expected&nbsp;status&nbsp;code&nbsp;%d;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="7963928">,</span>&nbsp;<span class="ident" id="7963930">e</span><span class="op" id="7963931">,</span>&nbsp;<span class="ident" id="7963933">g</span><span class="op" id="7963934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7963937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7963940">if</span>&nbsp;<span class="ident" id="7963943">e</span><span class="op" id="7963944">,</span>&nbsp;<span class="ident" id="7963946">g</span>&nbsp;<span class="op" id="7963948">:=</span>&nbsp;<span class="string" id="7963951">&#34;http://foo.com/&#34;</span><span class="op" id="7963968">,</span>&nbsp;<span class="ident" id="7963970">rec</span><span class="op" id="7963973">.</span><span class="ident" id="7963974">Header</span><span class="op" id="7963980">(</span><span class="op" id="7963981">)</span><span class="op" id="7963982">.</span><span class="ident" id="7963983">Get</span><span class="op" id="7963986">(</span><span class="string" id="7963987">&#34;Location&#34;</span><span class="op" id="7963997">)</span><span class="op" id="7963998">;</span>&nbsp;<span class="ident" id="7964000">e</span>&nbsp;<span class="op" id="7964002">!=</span>&nbsp;<span class="ident" id="7964005">g</span>&nbsp;<span class="op" id="7964007">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7964011">t</span><span class="op" id="7964012">.</span><span class="ident" id="7964013">Errorf</span><span class="op" id="7964019">(</span><span class="string" id="7964020">&#34;expected&nbsp;Location&nbsp;header&nbsp;of&nbsp;%q;&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7964060">,</span>&nbsp;<span class="ident" id="7964062">e</span><span class="op" id="7964063">,</span>&nbsp;<span class="ident" id="7964065">g</span><span class="op" id="7964066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7964069">}</span><br>
<span class="lineno"></span><span class="op" id="7964071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7964074">func</span>&nbsp;<span class="ident" id="7964079">TestInternalRedirect</span><span class="op" id="7964099">(</span><span class="ident" id="7964100">t</span>&nbsp;<span class="op" id="7964102">*</span><span class="ident" id="7964103">testing</span><span class="op" id="7964110">.</span><span class="ident" id="7964111">T</span><span class="op" id="7964112">)</span>&nbsp;<span class="op" id="7964114">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7964117">check</span><span class="op" id="7964122">(</span><span class="ident" id="7964123">t</span><span class="op" id="7964124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7964127">baseHandler</span>&nbsp;<span class="op" id="7964139">:=</span>&nbsp;<span class="ident" id="7964142">http</span><span class="op" id="7964146">.</span><span class="ident" id="7964147">HandlerFunc</span><span class="op" id="7964158">(</span><span class="keyword" id="7964159">func</span><span class="op" id="7964163">(</span><span class="ident" id="7964164">rw</span>&nbsp;<span class="ident" id="7964167">http</span><span class="op" id="7964171">.</span><span class="ident" id="7964172">ResponseWriter</span><span class="op" id="7964186">,</span>&nbsp;<span class="ident" id="7964188">req</span>&nbsp;<span class="op" id="7964192">*</span><span class="ident" id="7964193">http</span><span class="op" id="7964197">.</span><span class="ident" id="7964198">Request</span><span class="op" id="7964205">)</span>&nbsp;<span class="op" id="7964207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7964211">fmt</span><span class="op" id="7964214">.</span><span class="ident" id="7964215">Fprintf</span><span class="op" id="7964222">(</span><span class="ident" id="7964223">rw</span><span class="op" id="7964225">,</span>&nbsp;<span class="string" id="7964227">&#34;basepath=%s\n&#34;</span><span class="op" id="7964242">,</span>&nbsp;<span class="ident" id="7964244">req</span><span class="op" id="7964247">.</span><span class="ident" id="7964248">URL</span><span class="op" id="7964251">.</span><span class="ident" id="7964252">Path</span><span class="op" id="7964256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7964260">fmt</span><span class="op" id="7964263">.</span><span class="ident" id="7964264">Fprintf</span><span class="op" id="7964271">(</span><span class="ident" id="7964272">rw</span><span class="op" id="7964274">,</span>&nbsp;<span class="string" id="7964276">&#34;remoteaddr=%s\n&#34;</span><span class="op" id="7964293">,</span>&nbsp;<span class="ident" id="7964295">req</span><span class="op" id="7964298">.</span><span class="ident" id="7964299">RemoteAddr</span><span class="op" id="7964309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7964312">}</span><span class="op" id="7964313">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7964316">h</span>&nbsp;<span class="op" id="7964318">:=</span>&nbsp;<span class="op" id="7964321">&amp;</span><span class="ident" id="7964322">Handler</span><span class="op" id="7964329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7964333">Path</span><span class="op" id="7964337">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7964354">&#34;testdata/test.cgi&#34;</span><span class="op" id="7964373">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7964377">Root</span><span class="op" id="7964381">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7964398">&#34;/test.cgi&#34;</span><span class="op" id="7964409">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7964413">PathLocationHandler</span><span class="op" id="7964432">:</span>&nbsp;<span class="ident" id="7964434">baseHandler</span><span class="op" id="7964445">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7964448">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7964451">expectedMap</span>&nbsp;<span class="op" id="7964463">:=</span>&nbsp;<span class="keyword" id="7964466">map</span><span class="op" id="7964469">[</span><span class="builtintype" id="7964470">string</span><span class="op" id="7964476">]</span><span class="builtintype" id="7964477">string</span><span class="op" id="7964483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7964487">&#34;basepath&#34;</span><span class="op" id="7964497">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="7964501">&#34;/foo&#34;</span><span class="op" id="7964507">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7964511">&#34;remoteaddr&#34;</span><span class="op" id="7964523">:</span>&nbsp;<span class="string" id="7964525">&#34;1.2.3.4&#34;</span><span class="op" id="7964534">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7964537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7964540">runCgiTest</span><span class="op" id="7964550">(</span><span class="ident" id="7964551">t</span><span class="op" id="7964552">,</span>&nbsp;<span class="ident" id="7964554">h</span><span class="op" id="7964555">,</span>&nbsp;<span class="string" id="7964557">&#34;GET&nbsp;/test.cgi?loc=/foo&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7964613">,</span>&nbsp;<span class="ident" id="7964615">expectedMap</span><span class="op" id="7964626">)</span><br>
<span class="lineno">295</span><span class="op" id="7964628">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7964631">//&nbsp;TestCopyError&nbsp;tests&nbsp;that&nbsp;we&nbsp;kill&nbsp;the&nbsp;process&nbsp;if&nbsp;there&#39;s&nbsp;an&nbsp;error&nbsp;copying</span><br>
<span class="lineno"></span><span class="comment" id="7964707">//&nbsp;its&nbsp;output.&nbsp;(for&nbsp;example,&nbsp;from&nbsp;the&nbsp;client&nbsp;having&nbsp;gone&nbsp;away)</span><br>
<span class="lineno"></span><span class="keyword" id="7964770">func</span>&nbsp;<span class="ident" id="7964775">TestCopyError</span><span class="op" id="7964788">(</span><span class="ident" id="7964789">t</span>&nbsp;<span class="op" id="7964791">*</span><span class="ident" id="7964792">testing</span><span class="op" id="7964799">.</span><span class="ident" id="7964800">T</span><span class="op" id="7964801">)</span>&nbsp;<span class="op" id="7964803">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7964806">check</span><span class="op" id="7964811">(</span><span class="ident" id="7964812">t</span><span class="op" id="7964813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7964816">if</span>&nbsp;<span class="ident" id="7964819">runtime</span><span class="op" id="7964826">.</span><span class="ident" id="7964827">GOOS</span>&nbsp;<span class="op" id="7964832">==</span>&nbsp;<span class="string" id="7964835">&#34;windows&#34;</span>&nbsp;<span class="op" id="7964845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7964849">t</span><span class="op" id="7964850">.</span><span class="ident" id="7964851">Skipf</span><span class="op" id="7964856">(</span><span class="string" id="7964857">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7964878">,</span>&nbsp;<span class="ident" id="7964880">runtime</span><span class="op" id="7964887">.</span><span class="ident" id="7964888">GOOS</span><span class="op" id="7964892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7964895">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7964898">h</span>&nbsp;<span class="op" id="7964900">:=</span>&nbsp;<span class="op" id="7964903">&amp;</span><span class="ident" id="7964904">Handler</span><span class="op" id="7964911">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7964915">Path</span><span class="op" id="7964919">:</span>&nbsp;<span class="string" id="7964921">&#34;testdata/test.cgi&#34;</span><span class="op" id="7964940">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7964944">Root</span><span class="op" id="7964948">:</span>&nbsp;<span class="string" id="7964950">&#34;/test.cgi&#34;</span><span class="op" id="7964961">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7964964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7964967">ts</span>&nbsp;<span class="op" id="7964970">:=</span>&nbsp;<span class="ident" id="7964973">httptest</span><span class="op" id="7964981">.</span><span class="ident" id="7964982">NewServer</span><span class="op" id="7964991">(</span><span class="ident" id="7964992">h</span><span class="op" id="7964993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7964996">defer</span>&nbsp;<span class="ident" id="7965002">ts</span><span class="op" id="7965004">.</span><span class="ident" id="7965005">Close</span><span class="op" id="7965010">(</span><span class="op" id="7965011">)</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7965015">conn</span><span class="op" id="7965019">,</span>&nbsp;<span class="ident" id="7965021">err</span>&nbsp;<span class="op" id="7965025">:=</span>&nbsp;<span class="ident" id="7965028">net</span><span class="op" id="7965031">.</span><span class="ident" id="7965032">Dial</span><span class="op" id="7965036">(</span><span class="string" id="7965037">&#34;tcp&#34;</span><span class="op" id="7965042">,</span>&nbsp;<span class="ident" id="7965044">ts</span><span class="op" id="7965046">.</span><span class="ident" id="7965047">Listener</span><span class="op" id="7965055">.</span><span class="ident" id="7965056">Addr</span><span class="op" id="7965060">(</span><span class="op" id="7965061">)</span><span class="op" id="7965062">.</span><span class="ident" id="7965063">String</span><span class="op" id="7965069">(</span><span class="op" id="7965070">)</span><span class="op" id="7965071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7965074">if</span>&nbsp;<span class="ident" id="7965077">err</span>&nbsp;<span class="op" id="7965081">!=</span>&nbsp;<span class="builtintype" id="7965084">nil</span>&nbsp;<span class="op" id="7965088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7965092">t</span><span class="op" id="7965093">.</span><span class="ident" id="7965094">Fatal</span><span class="op" id="7965099">(</span><span class="ident" id="7965100">err</span><span class="op" id="7965103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7965106">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7965109">req</span><span class="op" id="7965112">,</span>&nbsp;<span class="ident" id="7965114">_</span>&nbsp;<span class="op" id="7965116">:=</span>&nbsp;<span class="ident" id="7965119">http</span><span class="op" id="7965123">.</span><span class="ident" id="7965124">NewRequest</span><span class="op" id="7965134">(</span><span class="string" id="7965135">&#34;GET&#34;</span><span class="op" id="7965140">,</span>&nbsp;<span class="string" id="7965142">&#34;http://example.com/test.cgi?bigresponse=1&#34;</span><span class="op" id="7965185">,</span>&nbsp;<span class="builtintype" id="7965187">nil</span><span class="op" id="7965190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7965193">err</span>&nbsp;<span class="op" id="7965197">=</span>&nbsp;<span class="ident" id="7965199">req</span><span class="op" id="7965202">.</span><span class="ident" id="7965203">Write</span><span class="op" id="7965208">(</span><span class="ident" id="7965209">conn</span><span class="op" id="7965213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7965216">if</span>&nbsp;<span class="ident" id="7965219">err</span>&nbsp;<span class="op" id="7965223">!=</span>&nbsp;<span class="builtintype" id="7965226">nil</span>&nbsp;<span class="op" id="7965230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7965234">t</span><span class="op" id="7965235">.</span><span class="ident" id="7965236">Fatalf</span><span class="op" id="7965242">(</span><span class="string" id="7965243">&#34;Write:&nbsp;%v&#34;</span><span class="op" id="7965254">,</span>&nbsp;<span class="ident" id="7965256">err</span><span class="op" id="7965259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7965262">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7965266">res</span><span class="op" id="7965269">,</span>&nbsp;<span class="ident" id="7965271">err</span>&nbsp;<span class="op" id="7965275">:=</span>&nbsp;<span class="ident" id="7965278">http</span><span class="op" id="7965282">.</span><span class="ident" id="7965283">ReadResponse</span><span class="op" id="7965295">(</span><span class="ident" id="7965296">bufio</span><span class="op" id="7965301">.</span><span class="ident" id="7965302">NewReader</span><span class="op" id="7965311">(</span><span class="ident" id="7965312">conn</span><span class="op" id="7965316">)</span><span class="op" id="7965317">,</span>&nbsp;<span class="ident" id="7965319">req</span><span class="op" id="7965322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7965325">if</span>&nbsp;<span class="ident" id="7965328">err</span>&nbsp;<span class="op" id="7965332">!=</span>&nbsp;<span class="builtintype" id="7965335">nil</span>&nbsp;<span class="op" id="7965339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7965343">t</span><span class="op" id="7965344">.</span><span class="ident" id="7965345">Fatalf</span><span class="op" id="7965351">(</span><span class="string" id="7965352">&#34;ReadResponse:&nbsp;%v&#34;</span><span class="op" id="7965370">,</span>&nbsp;<span class="ident" id="7965372">err</span><span class="op" id="7965375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7965378">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7965382">pidstr</span>&nbsp;<span class="op" id="7965389">:=</span>&nbsp;<span class="ident" id="7965392">res</span><span class="op" id="7965395">.</span><span class="ident" id="7965396">Header</span><span class="op" id="7965402">.</span><span class="ident" id="7965403">Get</span><span class="op" id="7965406">(</span><span class="string" id="7965407">&#34;X-CGI-Pid&#34;</span><span class="op" id="7965418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7965421">if</span>&nbsp;<span class="ident" id="7965424">pidstr</span>&nbsp;<span class="op" id="7965431">==</span>&nbsp;<span class="string" id="7965434">&#34;&#34;</span>&nbsp;<span class="op" id="7965437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7965441">t</span><span class="op" id="7965442">.</span><span class="ident" id="7965443">Fatalf</span><span class="op" id="7965449">(</span><span class="string" id="7965450">&#34;expected&nbsp;an&nbsp;X-CGI-Pid&nbsp;header&nbsp;in&nbsp;response&#34;</span><span class="op" id="7965492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7965495">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7965498">pid</span><span class="op" id="7965501">,</span>&nbsp;<span class="ident" id="7965503">err</span>&nbsp;<span class="op" id="7965507">:=</span>&nbsp;<span class="ident" id="7965510">strconv</span><span class="op" id="7965517">.</span><span class="ident" id="7965518">Atoi</span><span class="op" id="7965522">(</span><span class="ident" id="7965523">pidstr</span><span class="op" id="7965529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7965532">if</span>&nbsp;<span class="ident" id="7965535">err</span>&nbsp;<span class="op" id="7965539">!=</span>&nbsp;<span class="builtintype" id="7965542">nil</span>&nbsp;<span class="op" id="7965546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7965550">t</span><span class="op" id="7965551">.</span><span class="ident" id="7965552">Fatalf</span><span class="op" id="7965558">(</span><span class="string" id="7965559">&#34;invalid&nbsp;X-CGI-Pid&nbsp;value&#34;</span><span class="op" id="7965584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7965587">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7965591">var</span>&nbsp;<span class="ident" id="7965595">buf</span>&nbsp;<span class="op" id="7965599">[</span><span class="num" id="7965600">5000</span><span class="op" id="7965604">]</span><span class="builtintype" id="7965605">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7965611">n</span><span class="op" id="7965612">,</span>&nbsp;<span class="ident" id="7965614">err</span>&nbsp;<span class="op" id="7965618">:=</span>&nbsp;<span class="ident" id="7965621">io</span><span class="op" id="7965623">.</span><span class="ident" id="7965624">ReadFull</span><span class="op" id="7965632">(</span><span class="ident" id="7965633">res</span><span class="op" id="7965636">.</span><span class="ident" id="7965637">Body</span><span class="op" id="7965641">,</span>&nbsp;<span class="ident" id="7965643">buf</span><span class="op" id="7965646">[</span><span class="op" id="7965647">:</span><span class="op" id="7965648">]</span><span class="op" id="7965649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7965652">if</span>&nbsp;<span class="ident" id="7965655">err</span>&nbsp;<span class="op" id="7965659">!=</span>&nbsp;<span class="builtintype" id="7965662">nil</span>&nbsp;<span class="op" id="7965666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7965670">t</span><span class="op" id="7965671">.</span><span class="ident" id="7965672">Fatalf</span><span class="op" id="7965678">(</span><span class="string" id="7965679">&#34;ReadFull:&nbsp;%d&nbsp;bytes,&nbsp;%v&#34;</span><span class="op" id="7965703">,</span>&nbsp;<span class="ident" id="7965705">n</span><span class="op" id="7965706">,</span>&nbsp;<span class="ident" id="7965708">err</span><span class="op" id="7965711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7965714">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7965718">childRunning</span>&nbsp;<span class="op" id="7965731">:=</span>&nbsp;<span class="keyword" id="7965734">func</span><span class="op" id="7965738">(</span><span class="op" id="7965739">)</span>&nbsp;<span class="builtintype" id="7965741">bool</span>&nbsp;<span class="op" id="7965746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7965750">return</span>&nbsp;<span class="ident" id="7965757">isProcessRunning</span><span class="op" id="7965773">(</span><span class="ident" id="7965774">t</span><span class="op" id="7965775">,</span>&nbsp;<span class="ident" id="7965777">pid</span><span class="op" id="7965780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7965783">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7965787">if</span>&nbsp;<span class="op" id="7965790">!</span><span class="ident" id="7965791">childRunning</span><span class="op" id="7965803">(</span><span class="op" id="7965804">)</span>&nbsp;<span class="op" id="7965806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7965810">t</span><span class="op" id="7965811">.</span><span class="ident" id="7965812">Fatalf</span><span class="op" id="7965818">(</span><span class="string" id="7965819">&#34;pre-conn.Close,&nbsp;expected&nbsp;child&nbsp;to&nbsp;be&nbsp;running&#34;</span><span class="op" id="7965865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7965868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7965871">conn</span><span class="op" id="7965875">.</span><span class="ident" id="7965876">Close</span><span class="op" id="7965881">(</span><span class="op" id="7965882">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7965886">tries</span>&nbsp;<span class="op" id="7965892">:=</span>&nbsp;<span class="num" id="7965895">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7965898">for</span>&nbsp;<span class="ident" id="7965902">tries</span>&nbsp;<span class="op" id="7965908">&lt;</span>&nbsp;<span class="num" id="7965910">25</span>&nbsp;<span class="op" id="7965913">&amp;&amp;</span>&nbsp;<span class="ident" id="7965916">childRunning</span><span class="op" id="7965928">(</span><span class="op" id="7965929">)</span>&nbsp;<span class="op" id="7965931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7965935">time</span><span class="op" id="7965939">.</span><span class="ident" id="7965940">Sleep</span><span class="op" id="7965945">(</span><span class="num" id="7965946">50</span>&nbsp;<span class="op" id="7965949">*</span>&nbsp;<span class="ident" id="7965951">time</span><span class="op" id="7965955">.</span><span class="ident" id="7965956">Millisecond</span>&nbsp;<span class="op" id="7965968">*</span>&nbsp;<span class="ident" id="7965970">time</span><span class="op" id="7965974">.</span><span class="ident" id="7965975">Duration</span><span class="op" id="7965983">(</span><span class="ident" id="7965984">tries</span><span class="op" id="7965989">)</span><span class="op" id="7965990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7965994">tries</span><span class="op" id="7965999">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7966003">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7966006">if</span>&nbsp;<span class="ident" id="7966009">childRunning</span><span class="op" id="7966021">(</span><span class="op" id="7966022">)</span>&nbsp;<span class="op" id="7966024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7966028">t</span><span class="op" id="7966029">.</span><span class="ident" id="7966030">Fatalf</span><span class="op" id="7966036">(</span><span class="string" id="7966037">&#34;post-conn.Close,&nbsp;expected&nbsp;child&nbsp;to&nbsp;be&nbsp;gone&#34;</span><span class="op" id="7966081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7966084">}</span><br>
<span class="lineno"></span><span class="op" id="7966086">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span><span class="keyword" id="7966089">func</span>&nbsp;<span class="ident" id="7966094">TestDirUnix</span><span class="op" id="7966105">(</span><span class="ident" id="7966106">t</span>&nbsp;<span class="op" id="7966108">*</span><span class="ident" id="7966109">testing</span><span class="op" id="7966116">.</span><span class="ident" id="7966117">T</span><span class="op" id="7966118">)</span>&nbsp;<span class="op" id="7966120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7966123">check</span><span class="op" id="7966128">(</span><span class="ident" id="7966129">t</span><span class="op" id="7966130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7966133">if</span>&nbsp;<span class="ident" id="7966136">runtime</span><span class="op" id="7966143">.</span><span class="ident" id="7966144">GOOS</span>&nbsp;<span class="op" id="7966149">==</span>&nbsp;<span class="string" id="7966152">&#34;windows&#34;</span>&nbsp;<span class="op" id="7966162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7966166">t</span><span class="op" id="7966167">.</span><span class="ident" id="7966168">Skipf</span><span class="op" id="7966173">(</span><span class="string" id="7966174">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7966195">,</span>&nbsp;<span class="ident" id="7966197">runtime</span><span class="op" id="7966204">.</span><span class="ident" id="7966205">GOOS</span><span class="op" id="7966209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7966212">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7966215">cwd</span><span class="op" id="7966218">,</span>&nbsp;<span class="ident" id="7966220">_</span>&nbsp;<span class="op" id="7966222">:=</span>&nbsp;<span class="ident" id="7966225">os</span><span class="op" id="7966227">.</span><span class="ident" id="7966228">Getwd</span><span class="op" id="7966233">(</span><span class="op" id="7966234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7966237">h</span>&nbsp;<span class="op" id="7966239">:=</span>&nbsp;<span class="op" id="7966242">&amp;</span><span class="ident" id="7966243">Handler</span><span class="op" id="7966250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7966254">Path</span><span class="op" id="7966258">:</span>&nbsp;<span class="string" id="7966260">&#34;testdata/test.cgi&#34;</span><span class="op" id="7966279">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7966283">Root</span><span class="op" id="7966287">:</span>&nbsp;<span class="string" id="7966289">&#34;/test.cgi&#34;</span><span class="op" id="7966300">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7966304">Dir</span><span class="op" id="7966307">:</span>&nbsp;&nbsp;<span class="ident" id="7966310">cwd</span><span class="op" id="7966313">,</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7966316">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7966319">expectedMap</span>&nbsp;<span class="op" id="7966331">:=</span>&nbsp;<span class="keyword" id="7966334">map</span><span class="op" id="7966337">[</span><span class="builtintype" id="7966338">string</span><span class="op" id="7966344">]</span><span class="builtintype" id="7966345">string</span><span class="op" id="7966351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7966355">&#34;cwd&#34;</span><span class="op" id="7966360">:</span>&nbsp;<span class="ident" id="7966362">cwd</span><span class="op" id="7966365">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7966368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7966371">runCgiTest</span><span class="op" id="7966381">(</span><span class="ident" id="7966382">t</span><span class="op" id="7966383">,</span>&nbsp;<span class="ident" id="7966385">h</span><span class="op" id="7966386">,</span>&nbsp;<span class="string" id="7966388">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7966435">,</span>&nbsp;<span class="ident" id="7966437">expectedMap</span><span class="op" id="7966448">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7966452">cwd</span><span class="op" id="7966455">,</span>&nbsp;<span class="ident" id="7966457">_</span>&nbsp;<span class="op" id="7966459">=</span>&nbsp;<span class="ident" id="7966461">os</span><span class="op" id="7966463">.</span><span class="ident" id="7966464">Getwd</span><span class="op" id="7966469">(</span><span class="op" id="7966470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7966473">cwd</span>&nbsp;<span class="op" id="7966477">=</span>&nbsp;<span class="ident" id="7966479">filepath</span><span class="op" id="7966487">.</span><span class="ident" id="7966488">Join</span><span class="op" id="7966492">(</span><span class="ident" id="7966493">cwd</span><span class="op" id="7966496">,</span>&nbsp;<span class="string" id="7966498">&#34;testdata&#34;</span><span class="op" id="7966508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7966511">h</span>&nbsp;<span class="op" id="7966513">=</span>&nbsp;<span class="op" id="7966515">&amp;</span><span class="ident" id="7966516">Handler</span><span class="op" id="7966523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7966527">Path</span><span class="op" id="7966531">:</span>&nbsp;<span class="string" id="7966533">&#34;testdata/test.cgi&#34;</span><span class="op" id="7966552">,</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7966556">Root</span><span class="op" id="7966560">:</span>&nbsp;<span class="string" id="7966562">&#34;/test.cgi&#34;</span><span class="op" id="7966573">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7966576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7966579">expectedMap</span>&nbsp;<span class="op" id="7966591">=</span>&nbsp;<span class="keyword" id="7966593">map</span><span class="op" id="7966596">[</span><span class="builtintype" id="7966597">string</span><span class="op" id="7966603">]</span><span class="builtintype" id="7966604">string</span><span class="op" id="7966610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7966614">&#34;cwd&#34;</span><span class="op" id="7966619">:</span>&nbsp;<span class="ident" id="7966621">cwd</span><span class="op" id="7966624">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7966627">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7966630">runCgiTest</span><span class="op" id="7966640">(</span><span class="ident" id="7966641">t</span><span class="op" id="7966642">,</span>&nbsp;<span class="ident" id="7966644">h</span><span class="op" id="7966645">,</span>&nbsp;<span class="string" id="7966647">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7966694">,</span>&nbsp;<span class="ident" id="7966696">expectedMap</span><span class="op" id="7966707">)</span><br>
<span class="lineno"></span><span class="op" id="7966709">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7966712">func</span>&nbsp;<span class="ident" id="7966717">TestDirWindows</span><span class="op" id="7966731">(</span><span class="ident" id="7966732">t</span>&nbsp;<span class="op" id="7966734">*</span><span class="ident" id="7966735">testing</span><span class="op" id="7966742">.</span><span class="ident" id="7966743">T</span><span class="op" id="7966744">)</span>&nbsp;<span class="op" id="7966746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7966749">if</span>&nbsp;<span class="ident" id="7966752">runtime</span><span class="op" id="7966759">.</span><span class="ident" id="7966760">GOOS</span>&nbsp;<span class="op" id="7966765">!=</span>&nbsp;<span class="string" id="7966768">&#34;windows&#34;</span>&nbsp;<span class="op" id="7966778">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7966782">t</span><span class="op" id="7966783">.</span><span class="ident" id="7966784">Skip</span><span class="op" id="7966788">(</span><span class="string" id="7966789">&#34;Skipping&nbsp;windows&nbsp;specific&nbsp;test.&#34;</span><span class="op" id="7966822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7966825">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7966829">cgifile</span><span class="op" id="7966836">,</span>&nbsp;<span class="ident" id="7966838">_</span>&nbsp;<span class="op" id="7966840">:=</span>&nbsp;<span class="ident" id="7966843">filepath</span><span class="op" id="7966851">.</span><span class="ident" id="7966852">Abs</span><span class="op" id="7966855">(</span><span class="string" id="7966856">&#34;testdata/test.cgi&#34;</span><span class="op" id="7966875">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7966879">var</span>&nbsp;<span class="ident" id="7966883">perl</span>&nbsp;<span class="builtintype" id="7966888">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7966896">var</span>&nbsp;<span class="ident" id="7966900">err</span>&nbsp;<span class="builtintype" id="7966904">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7966911">perl</span><span class="op" id="7966915">,</span>&nbsp;<span class="ident" id="7966917">err</span>&nbsp;<span class="op" id="7966921">=</span>&nbsp;<span class="ident" id="7966923">exec</span><span class="op" id="7966927">.</span><span class="ident" id="7966928">LookPath</span><span class="op" id="7966936">(</span><span class="string" id="7966937">&#34;perl&#34;</span><span class="op" id="7966943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7966946">if</span>&nbsp;<span class="ident" id="7966949">err</span>&nbsp;<span class="op" id="7966953">!=</span>&nbsp;<span class="builtintype" id="7966956">nil</span>&nbsp;<span class="op" id="7966960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7966964">t</span><span class="op" id="7966965">.</span><span class="ident" id="7966966">Skip</span><span class="op" id="7966970">(</span><span class="string" id="7966971">&#34;Skipping&nbsp;test:&nbsp;perl&nbsp;not&nbsp;found.&#34;</span><span class="op" id="7967003">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7967006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967009">perl</span><span class="op" id="7967013">,</span>&nbsp;<span class="ident" id="7967015">_</span>&nbsp;<span class="op" id="7967017">=</span>&nbsp;<span class="ident" id="7967019">filepath</span><span class="op" id="7967027">.</span><span class="ident" id="7967028">Abs</span><span class="op" id="7967031">(</span><span class="ident" id="7967032">perl</span><span class="op" id="7967036">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967040">cwd</span><span class="op" id="7967043">,</span>&nbsp;<span class="ident" id="7967045">_</span>&nbsp;<span class="op" id="7967047">:=</span>&nbsp;<span class="ident" id="7967050">os</span><span class="op" id="7967052">.</span><span class="ident" id="7967053">Getwd</span><span class="op" id="7967058">(</span><span class="op" id="7967059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967062">h</span>&nbsp;<span class="op" id="7967064">:=</span>&nbsp;<span class="op" id="7967067">&amp;</span><span class="ident" id="7967068">Handler</span><span class="op" id="7967075">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967079">Path</span><span class="op" id="7967083">:</span>&nbsp;<span class="ident" id="7967085">perl</span><span class="op" id="7967089">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967093">Root</span><span class="op" id="7967097">:</span>&nbsp;<span class="string" id="7967099">&#34;/test.cgi&#34;</span><span class="op" id="7967110">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967114">Dir</span><span class="op" id="7967117">:</span>&nbsp;&nbsp;<span class="ident" id="7967120">cwd</span><span class="op" id="7967123">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967127">Args</span><span class="op" id="7967131">:</span>&nbsp;<span class="op" id="7967133">[</span><span class="op" id="7967134">]</span><span class="builtintype" id="7967135">string</span><span class="op" id="7967141">{</span><span class="ident" id="7967142">cgifile</span><span class="op" id="7967149">}</span><span class="op" id="7967150">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967154">Env</span><span class="op" id="7967157">:</span>&nbsp;&nbsp;<span class="op" id="7967160">[</span><span class="op" id="7967161">]</span><span class="builtintype" id="7967162">string</span><span class="op" id="7967168">{</span><span class="string" id="7967169">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="7967188">+</span>&nbsp;<span class="ident" id="7967190">cgifile</span><span class="op" id="7967197">}</span><span class="op" id="7967198">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7967201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967204">expectedMap</span>&nbsp;<span class="op" id="7967216">:=</span>&nbsp;<span class="keyword" id="7967219">map</span><span class="op" id="7967222">[</span><span class="builtintype" id="7967223">string</span><span class="op" id="7967229">]</span><span class="builtintype" id="7967230">string</span><span class="op" id="7967236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7967240">&#34;cwd&#34;</span><span class="op" id="7967245">:</span>&nbsp;<span class="ident" id="7967247">cwd</span><span class="op" id="7967250">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7967253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967256">runCgiTest</span><span class="op" id="7967266">(</span><span class="ident" id="7967267">t</span><span class="op" id="7967268">,</span>&nbsp;<span class="ident" id="7967270">h</span><span class="op" id="7967271">,</span>&nbsp;<span class="string" id="7967273">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7967320">,</span>&nbsp;<span class="ident" id="7967322">expectedMap</span><span class="op" id="7967333">)</span><br>
<span class="lineno">415</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7967337">//&nbsp;If&nbsp;not&nbsp;specify&nbsp;Dir&nbsp;on&nbsp;windows,&nbsp;working&nbsp;directory&nbsp;should&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7967400">//&nbsp;base&nbsp;directory&nbsp;of&nbsp;perl.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967428">cwd</span><span class="op" id="7967431">,</span>&nbsp;<span class="ident" id="7967433">_</span>&nbsp;<span class="op" id="7967435">=</span>&nbsp;<span class="ident" id="7967437">filepath</span><span class="op" id="7967445">.</span><span class="ident" id="7967446">Split</span><span class="op" id="7967451">(</span><span class="ident" id="7967452">perl</span><span class="op" id="7967456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7967459">if</span>&nbsp;<span class="ident" id="7967462">cwd</span>&nbsp;<span class="op" id="7967466">!=</span>&nbsp;<span class="string" id="7967469">&#34;&#34;</span>&nbsp;<span class="op" id="7967472">&amp;&amp;</span>&nbsp;<span class="ident" id="7967475">cwd</span><span class="op" id="7967478">[</span><span class="builtinfunc" id="7967479">len</span><span class="op" id="7967482">(</span><span class="ident" id="7967483">cwd</span><span class="op" id="7967486">)</span><span class="op" id="7967487">-</span><span class="num" id="7967488">1</span><span class="op" id="7967489">]</span>&nbsp;<span class="op" id="7967491">==</span>&nbsp;<span class="ident" id="7967494">filepath</span><span class="op" id="7967502">.</span><span class="ident" id="7967503">Separator</span>&nbsp;<span class="op" id="7967513">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967517">cwd</span>&nbsp;<span class="op" id="7967521">=</span>&nbsp;<span class="ident" id="7967523">cwd</span><span class="op" id="7967526">[</span><span class="op" id="7967527">:</span><span class="builtinfunc" id="7967528">len</span><span class="op" id="7967531">(</span><span class="ident" id="7967532">cwd</span><span class="op" id="7967535">)</span><span class="op" id="7967536">-</span><span class="num" id="7967537">1</span><span class="op" id="7967538">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7967541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967544">h</span>&nbsp;<span class="op" id="7967546">=</span>&nbsp;<span class="op" id="7967548">&amp;</span><span class="ident" id="7967549">Handler</span><span class="op" id="7967556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967560">Path</span><span class="op" id="7967564">:</span>&nbsp;<span class="ident" id="7967566">perl</span><span class="op" id="7967570">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967574">Root</span><span class="op" id="7967578">:</span>&nbsp;<span class="string" id="7967580">&#34;/test.cgi&#34;</span><span class="op" id="7967591">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967595">Args</span><span class="op" id="7967599">:</span>&nbsp;<span class="op" id="7967601">[</span><span class="op" id="7967602">]</span><span class="builtintype" id="7967603">string</span><span class="op" id="7967609">{</span><span class="ident" id="7967610">cgifile</span><span class="op" id="7967617">}</span><span class="op" id="7967618">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967622">Env</span><span class="op" id="7967625">:</span>&nbsp;&nbsp;<span class="op" id="7967628">[</span><span class="op" id="7967629">]</span><span class="builtintype" id="7967630">string</span><span class="op" id="7967636">{</span><span class="string" id="7967637">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="7967656">+</span>&nbsp;<span class="ident" id="7967658">cgifile</span><span class="op" id="7967665">}</span><span class="op" id="7967666">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7967669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967672">expectedMap</span>&nbsp;<span class="op" id="7967684">=</span>&nbsp;<span class="keyword" id="7967686">map</span><span class="op" id="7967689">[</span><span class="builtintype" id="7967690">string</span><span class="op" id="7967696">]</span><span class="builtintype" id="7967697">string</span><span class="op" id="7967703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7967707">&#34;cwd&#34;</span><span class="op" id="7967712">:</span>&nbsp;<span class="ident" id="7967714">cwd</span><span class="op" id="7967717">,</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7967720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967723">runCgiTest</span><span class="op" id="7967733">(</span><span class="ident" id="7967734">t</span><span class="op" id="7967735">,</span>&nbsp;<span class="ident" id="7967737">h</span><span class="op" id="7967738">,</span>&nbsp;<span class="string" id="7967740">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7967787">,</span>&nbsp;<span class="ident" id="7967789">expectedMap</span><span class="op" id="7967800">)</span><br>
<span class="lineno"></span><span class="op" id="7967802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7967805">func</span>&nbsp;<span class="ident" id="7967810">TestEnvOverride</span><span class="op" id="7967825">(</span><span class="ident" id="7967826">t</span>&nbsp;<span class="op" id="7967828">*</span><span class="ident" id="7967829">testing</span><span class="op" id="7967836">.</span><span class="ident" id="7967837">T</span><span class="op" id="7967838">)</span>&nbsp;<span class="op" id="7967840">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967843">cgifile</span><span class="op" id="7967850">,</span>&nbsp;<span class="ident" id="7967852">_</span>&nbsp;<span class="op" id="7967854">:=</span>&nbsp;<span class="ident" id="7967857">filepath</span><span class="op" id="7967865">.</span><span class="ident" id="7967866">Abs</span><span class="op" id="7967869">(</span><span class="string" id="7967870">&#34;testdata/test.cgi&#34;</span><span class="op" id="7967889">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7967893">var</span>&nbsp;<span class="ident" id="7967897">perl</span>&nbsp;<span class="builtintype" id="7967902">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7967910">var</span>&nbsp;<span class="ident" id="7967914">err</span>&nbsp;<span class="builtintype" id="7967918">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967925">perl</span><span class="op" id="7967929">,</span>&nbsp;<span class="ident" id="7967931">err</span>&nbsp;<span class="op" id="7967935">=</span>&nbsp;<span class="ident" id="7967937">exec</span><span class="op" id="7967941">.</span><span class="ident" id="7967942">LookPath</span><span class="op" id="7967950">(</span><span class="string" id="7967951">&#34;perl&#34;</span><span class="op" id="7967957">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7967960">if</span>&nbsp;<span class="ident" id="7967963">err</span>&nbsp;<span class="op" id="7967967">!=</span>&nbsp;<span class="builtintype" id="7967970">nil</span>&nbsp;<span class="op" id="7967974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7967978">t</span><span class="op" id="7967979">.</span><span class="ident" id="7967980">Skipf</span><span class="op" id="7967985">(</span><span class="string" id="7967986">&#34;Skipping&nbsp;test:&nbsp;perl&nbsp;not&nbsp;found.&#34;</span><span class="op" id="7968018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7968021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7968024">perl</span><span class="op" id="7968028">,</span>&nbsp;<span class="ident" id="7968030">_</span>&nbsp;<span class="op" id="7968032">=</span>&nbsp;<span class="ident" id="7968034">filepath</span><span class="op" id="7968042">.</span><span class="ident" id="7968043">Abs</span><span class="op" id="7968046">(</span><span class="ident" id="7968047">perl</span><span class="op" id="7968051">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7968055">cwd</span><span class="op" id="7968058">,</span>&nbsp;<span class="ident" id="7968060">_</span>&nbsp;<span class="op" id="7968062">:=</span>&nbsp;<span class="ident" id="7968065">os</span><span class="op" id="7968067">.</span><span class="ident" id="7968068">Getwd</span><span class="op" id="7968073">(</span><span class="op" id="7968074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7968077">h</span>&nbsp;<span class="op" id="7968079">:=</span>&nbsp;<span class="op" id="7968082">&amp;</span><span class="ident" id="7968083">Handler</span><span class="op" id="7968090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7968094">Path</span><span class="op" id="7968098">:</span>&nbsp;<span class="ident" id="7968100">perl</span><span class="op" id="7968104">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7968108">Root</span><span class="op" id="7968112">:</span>&nbsp;<span class="string" id="7968114">&#34;/test.cgi&#34;</span><span class="op" id="7968125">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7968129">Dir</span><span class="op" id="7968132">:</span>&nbsp;&nbsp;<span class="ident" id="7968135">cwd</span><span class="op" id="7968138">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7968142">Args</span><span class="op" id="7968146">:</span>&nbsp;<span class="op" id="7968148">[</span><span class="op" id="7968149">]</span><span class="builtintype" id="7968150">string</span><span class="op" id="7968156">{</span><span class="ident" id="7968157">cgifile</span><span class="op" id="7968164">}</span><span class="op" id="7968165">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7968169">Env</span><span class="op" id="7968172">:</span>&nbsp;<span class="op" id="7968174">[</span><span class="op" id="7968175">]</span><span class="builtintype" id="7968176">string</span><span class="op" id="7968182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7968187">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="7968206">+</span>&nbsp;<span class="ident" id="7968208">cgifile</span><span class="op" id="7968215">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7968220">&#34;REQUEST_URI=/foo/bar&#34;</span><span class="op" id="7968242">}</span><span class="op" id="7968243">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7968246">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7968249">expectedMap</span>&nbsp;<span class="op" id="7968261">:=</span>&nbsp;<span class="keyword" id="7968264">map</span><span class="op" id="7968267">[</span><span class="builtintype" id="7968268">string</span><span class="op" id="7968274">]</span><span class="builtintype" id="7968275">string</span><span class="op" id="7968281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7968285">&#34;cwd&#34;</span><span class="op" id="7968290">:</span>&nbsp;<span class="ident" id="7968292">cwd</span><span class="op" id="7968295">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7968299">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7968320">:</span>&nbsp;<span class="ident" id="7968322">cgifile</span><span class="op" id="7968329">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7968333">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7968350">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7968356">&#34;/foo/bar&#34;</span><span class="op" id="7968366">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7968369">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7968372">runCgiTest</span><span class="op" id="7968382">(</span><span class="ident" id="7968383">t</span><span class="op" id="7968384">,</span>&nbsp;<span class="ident" id="7968386">h</span><span class="op" id="7968387">,</span>&nbsp;<span class="string" id="7968389">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7968436">,</span>&nbsp;<span class="ident" id="7968438">expectedMap</span><span class="op" id="7968449">)</span><br>
<span class="lineno"></span><span class="op" id="7968451">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
