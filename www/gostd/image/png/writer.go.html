<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/png</h2>
<ul>
<li><a href="/gostd/image/png/paeth.go.html">paeth.go</a></li>
<li><a href="/gostd/image/png/paeth_test.go.html">paeth_test.go</a></li>
<li><a href="/gostd/image/png/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/png/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/png/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/png/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4687405">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4687460">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4687514">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4687565">package</span>&nbsp;<span class="ident" id="4687573">png</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4687578">import</span>&nbsp;<span class="op" id="4687585">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4687588">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4687597">&#34;compress/zlib&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4687614">&#34;hash/crc32&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4687628">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4687637">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4687652">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4687658">&#34;strconv&#34;</span><br>
<span class="lineno">15</span><span class="op" id="4687668">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4687671">//&nbsp;Encoder&nbsp;configures&nbsp;encoding&nbsp;PNG&nbsp;images.</span><br>
<span class="lineno"></span><span class="keyword" id="4687714">type</span>&nbsp;<span class="ident" id="4687719">Encoder</span>&nbsp;<span class="keyword" id="4687727">struct</span>&nbsp;<span class="op" id="4687734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4687737">CompressionLevel</span>&nbsp;<span class="ident" id="4687754">CompressionLevel</span><br>
<span class="lineno">20</span><span class="op" id="4687771">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4687774">type</span>&nbsp;<span class="ident" id="4687779">encoder</span>&nbsp;<span class="keyword" id="4687787">struct</span>&nbsp;<span class="op" id="4687794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4687797">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4687804">*</span><span class="ident" id="4687805">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4687814">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4687821">io</span><span class="op" id="4687823">.</span><span class="ident" id="4687824">Writer</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4687832">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4687839">image</span><span class="op" id="4687844">.</span><span class="ident" id="4687845">Image</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4687852">cb</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4687859">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4687864">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4687871">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4687878">header</span>&nbsp;<span class="op" id="4687885">[</span><span class="num" id="4687886">8</span><span class="op" id="4687887">]</span><span class="builtintype" id="4687888">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4687894">footer</span>&nbsp;<span class="op" id="4687901">[</span><span class="num" id="4687902">4</span><span class="op" id="4687903">]</span><span class="builtintype" id="4687904">byte</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4687910">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4687917">[</span><span class="num" id="4687918">4</span>&nbsp;<span class="op" id="4687920">*</span>&nbsp;<span class="num" id="4687922">256</span><span class="op" id="4687925">]</span><span class="builtintype" id="4687926">byte</span><br>
<span class="lineno"></span><span class="op" id="4687931">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4687934">type</span>&nbsp;<span class="ident" id="4687939">CompressionLevel</span>&nbsp;<span class="builtintype" id="4687956">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="4687961">const</span>&nbsp;<span class="op" id="4687967">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4687970">DefaultCompression</span>&nbsp;<span class="ident" id="4687989">CompressionLevel</span>&nbsp;<span class="op" id="4688006">=</span>&nbsp;<span class="num" id="4688008">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4688011">NoCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4688030">CompressionLevel</span>&nbsp;<span class="op" id="4688047">=</span>&nbsp;<span class="op" id="4688049">-</span><span class="num" id="4688050">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4688053">BestSpeed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4688072">CompressionLevel</span>&nbsp;<span class="op" id="4688089">=</span>&nbsp;<span class="op" id="4688091">-</span><span class="num" id="4688092">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4688095">BestCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4688114">CompressionLevel</span>&nbsp;<span class="op" id="4688131">=</span>&nbsp;<span class="op" id="4688133">-</span><span class="num" id="4688134">3</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4688138">//&nbsp;Positive&nbsp;CompressionLevel&nbsp;values&nbsp;are&nbsp;reserved&nbsp;to&nbsp;mean&nbsp;a&nbsp;numeric&nbsp;zlib</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4688211">//&nbsp;compression&nbsp;level,&nbsp;although&nbsp;that&nbsp;is&nbsp;not&nbsp;implemented&nbsp;yet.</span><br>
<span class="lineno"></span><span class="op" id="4688271">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="4688274">//&nbsp;Big-endian.</span><br>
<span class="lineno"></span><span class="keyword" id="4688289">func</span>&nbsp;<span class="ident" id="4688294">writeUint32</span><span class="op" id="4688305">(</span><span class="ident" id="4688306">b</span>&nbsp;<span class="op" id="4688308">[</span><span class="op" id="4688309">]</span><span class="builtintype" id="4688310">uint8</span><span class="op" id="4688315">,</span>&nbsp;<span class="ident" id="4688317">u</span>&nbsp;<span class="builtintype" id="4688319">uint32</span><span class="op" id="4688325">)</span>&nbsp;<span class="op" id="4688327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4688330">b</span><span class="op" id="4688331">[</span><span class="num" id="4688332">0</span><span class="op" id="4688333">]</span>&nbsp;<span class="op" id="4688335">=</span>&nbsp;<span class="builtintype" id="4688337">uint8</span><span class="op" id="4688342">(</span><span class="ident" id="4688343">u</span>&nbsp;<span class="op" id="4688345">&gt;&gt;</span>&nbsp;<span class="num" id="4688348">24</span><span class="op" id="4688350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4688353">b</span><span class="op" id="4688354">[</span><span class="num" id="4688355">1</span><span class="op" id="4688356">]</span>&nbsp;<span class="op" id="4688358">=</span>&nbsp;<span class="builtintype" id="4688360">uint8</span><span class="op" id="4688365">(</span><span class="ident" id="4688366">u</span>&nbsp;<span class="op" id="4688368">&gt;&gt;</span>&nbsp;<span class="num" id="4688371">16</span><span class="op" id="4688373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4688376">b</span><span class="op" id="4688377">[</span><span class="num" id="4688378">2</span><span class="op" id="4688379">]</span>&nbsp;<span class="op" id="4688381">=</span>&nbsp;<span class="builtintype" id="4688383">uint8</span><span class="op" id="4688388">(</span><span class="ident" id="4688389">u</span>&nbsp;<span class="op" id="4688391">&gt;&gt;</span>&nbsp;<span class="num" id="4688394">8</span><span class="op" id="4688395">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4688398">b</span><span class="op" id="4688399">[</span><span class="num" id="4688400">3</span><span class="op" id="4688401">]</span>&nbsp;<span class="op" id="4688403">=</span>&nbsp;<span class="builtintype" id="4688405">uint8</span><span class="op" id="4688410">(</span><span class="ident" id="4688411">u</span>&nbsp;<span class="op" id="4688413">&gt;&gt;</span>&nbsp;<span class="num" id="4688416">0</span><span class="op" id="4688417">)</span><br>
<span class="lineno"></span><span class="op" id="4688419">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4688422">type</span>&nbsp;<span class="ident" id="4688427">opaquer</span>&nbsp;<span class="keyword" id="4688435">interface</span>&nbsp;<span class="op" id="4688445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4688448">Opaque</span><span class="op" id="4688454">(</span><span class="op" id="4688455">)</span>&nbsp;<span class="builtintype" id="4688457">bool</span><br>
<span class="lineno">55</span><span class="op" id="4688462">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4688465">//&nbsp;Returns&nbsp;whether&nbsp;or&nbsp;not&nbsp;the&nbsp;image&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span><span class="keyword" id="4688518">func</span>&nbsp;<span class="ident" id="4688523">opaque</span><span class="op" id="4688529">(</span><span class="ident" id="4688530">m</span>&nbsp;<span class="ident" id="4688532">image</span><span class="op" id="4688537">.</span><span class="ident" id="4688538">Image</span><span class="op" id="4688543">)</span>&nbsp;<span class="builtintype" id="4688545">bool</span>&nbsp;<span class="op" id="4688550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4688553">if</span>&nbsp;<span class="ident" id="4688556">o</span><span class="op" id="4688557">,</span>&nbsp;<span class="ident" id="4688559">ok</span>&nbsp;<span class="op" id="4688562">:=</span>&nbsp;<span class="ident" id="4688565">m</span><span class="op" id="4688566">.</span><span class="op" id="4688567">(</span><span class="ident" id="4688568">opaquer</span><span class="op" id="4688575">)</span><span class="op" id="4688576">;</span>&nbsp;<span class="ident" id="4688578">ok</span>&nbsp;<span class="op" id="4688581">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4688585">return</span>&nbsp;<span class="ident" id="4688592">o</span><span class="op" id="4688593">.</span><span class="ident" id="4688594">Opaque</span><span class="op" id="4688600">(</span><span class="op" id="4688601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4688604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4688607">b</span>&nbsp;<span class="op" id="4688609">:=</span>&nbsp;<span class="ident" id="4688612">m</span><span class="op" id="4688613">.</span><span class="ident" id="4688614">Bounds</span><span class="op" id="4688620">(</span><span class="op" id="4688621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4688624">for</span>&nbsp;<span class="ident" id="4688628">y</span>&nbsp;<span class="op" id="4688630">:=</span>&nbsp;<span class="ident" id="4688633">b</span><span class="op" id="4688634">.</span><span class="ident" id="4688635">Min</span><span class="op" id="4688638">.</span><span class="ident" id="4688639">Y</span><span class="op" id="4688640">;</span>&nbsp;<span class="ident" id="4688642">y</span>&nbsp;<span class="op" id="4688644">&lt;</span>&nbsp;<span class="ident" id="4688646">b</span><span class="op" id="4688647">.</span><span class="ident" id="4688648">Max</span><span class="op" id="4688651">.</span><span class="ident" id="4688652">Y</span><span class="op" id="4688653">;</span>&nbsp;<span class="ident" id="4688655">y</span><span class="op" id="4688656">++</span>&nbsp;<span class="op" id="4688659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4688663">for</span>&nbsp;<span class="ident" id="4688667">x</span>&nbsp;<span class="op" id="4688669">:=</span>&nbsp;<span class="ident" id="4688672">b</span><span class="op" id="4688673">.</span><span class="ident" id="4688674">Min</span><span class="op" id="4688677">.</span><span class="ident" id="4688678">X</span><span class="op" id="4688679">;</span>&nbsp;<span class="ident" id="4688681">x</span>&nbsp;<span class="op" id="4688683">&lt;</span>&nbsp;<span class="ident" id="4688685">b</span><span class="op" id="4688686">.</span><span class="ident" id="4688687">Max</span><span class="op" id="4688690">.</span><span class="ident" id="4688691">X</span><span class="op" id="4688692">;</span>&nbsp;<span class="ident" id="4688694">x</span><span class="op" id="4688695">++</span>&nbsp;<span class="op" id="4688698">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4688703">_</span><span class="op" id="4688704">,</span>&nbsp;<span class="ident" id="4688706">_</span><span class="op" id="4688707">,</span>&nbsp;<span class="ident" id="4688709">_</span><span class="op" id="4688710">,</span>&nbsp;<span class="ident" id="4688712">a</span>&nbsp;<span class="op" id="4688714">:=</span>&nbsp;<span class="ident" id="4688717">m</span><span class="op" id="4688718">.</span><span class="ident" id="4688719">At</span><span class="op" id="4688721">(</span><span class="ident" id="4688722">x</span><span class="op" id="4688723">,</span>&nbsp;<span class="ident" id="4688725">y</span><span class="op" id="4688726">)</span><span class="op" id="4688727">.</span><span class="ident" id="4688728">RGBA</span><span class="op" id="4688732">(</span><span class="op" id="4688733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4688738">if</span>&nbsp;<span class="ident" id="4688741">a</span>&nbsp;<span class="op" id="4688743">!=</span>&nbsp;<span class="num" id="4688746">0xffff</span>&nbsp;<span class="op" id="4688753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4688759">return</span>&nbsp;<span class="builtintype" id="4688766">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4688775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4688779">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4688782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4688785">return</span>&nbsp;<span class="builtintype" id="4688792">true</span><br>
<span class="lineno"></span><span class="op" id="4688797">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4688800">//&nbsp;The&nbsp;absolute&nbsp;value&nbsp;of&nbsp;a&nbsp;byte&nbsp;interpreted&nbsp;as&nbsp;a&nbsp;signed&nbsp;int8.</span><br>
<span class="lineno">75</span><span class="keyword" id="4688862">func</span>&nbsp;<span class="ident" id="4688867">abs8</span><span class="op" id="4688871">(</span><span class="ident" id="4688872">d</span>&nbsp;<span class="builtintype" id="4688874">uint8</span><span class="op" id="4688879">)</span>&nbsp;<span class="builtintype" id="4688881">int</span>&nbsp;<span class="op" id="4688885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4688888">if</span>&nbsp;<span class="ident" id="4688891">d</span>&nbsp;<span class="op" id="4688893">&lt;</span>&nbsp;<span class="num" id="4688895">128</span>&nbsp;<span class="op" id="4688899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4688903">return</span>&nbsp;<span class="builtintype" id="4688910">int</span><span class="op" id="4688913">(</span><span class="ident" id="4688914">d</span><span class="op" id="4688915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4688918">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4688921">return</span>&nbsp;<span class="num" id="4688928">256</span>&nbsp;<span class="op" id="4688932">-</span>&nbsp;<span class="builtintype" id="4688934">int</span><span class="op" id="4688937">(</span><span class="ident" id="4688938">d</span><span class="op" id="4688939">)</span><br>
<span class="lineno">80</span><span class="op" id="4688941">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4688944">func</span>&nbsp;<span class="op" id="4688949">(</span><span class="ident" id="4688950">e</span>&nbsp;<span class="op" id="4688952">*</span><span class="ident" id="4688953">encoder</span><span class="op" id="4688960">)</span>&nbsp;<span class="ident" id="4688962">writeChunk</span><span class="op" id="4688972">(</span><span class="ident" id="4688973">b</span>&nbsp;<span class="op" id="4688975">[</span><span class="op" id="4688976">]</span><span class="builtintype" id="4688977">byte</span><span class="op" id="4688981">,</span>&nbsp;<span class="ident" id="4688983">name</span>&nbsp;<span class="builtintype" id="4688988">string</span><span class="op" id="4688994">)</span>&nbsp;<span class="op" id="4688996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4688999">if</span>&nbsp;<span class="ident" id="4689002">e</span><span class="op" id="4689003">.</span><span class="ident" id="4689004">err</span>&nbsp;<span class="op" id="4689008">!=</span>&nbsp;<span class="ident" id="4689011">nil</span>&nbsp;<span class="op" id="4689015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4689019">return</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4689027">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689030">n</span>&nbsp;<span class="op" id="4689032">:=</span>&nbsp;<span class="builtintype" id="4689035">uint32</span><span class="op" id="4689041">(</span><span class="builtinfunc" id="4689042">len</span><span class="op" id="4689045">(</span><span class="ident" id="4689046">b</span><span class="op" id="4689047">)</span><span class="op" id="4689048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4689051">if</span>&nbsp;<span class="builtintype" id="4689054">int</span><span class="op" id="4689057">(</span><span class="ident" id="4689058">n</span><span class="op" id="4689059">)</span>&nbsp;<span class="op" id="4689061">!=</span>&nbsp;<span class="builtinfunc" id="4689064">len</span><span class="op" id="4689067">(</span><span class="ident" id="4689068">b</span><span class="op" id="4689069">)</span>&nbsp;<span class="op" id="4689071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689075">e</span><span class="op" id="4689076">.</span><span class="ident" id="4689077">err</span>&nbsp;<span class="op" id="4689081">=</span>&nbsp;<span class="ident" id="4689083">UnsupportedError</span><span class="op" id="4689099">(</span><span class="ident" id="4689100">name</span>&nbsp;<span class="op" id="4689105">+</span>&nbsp;<span class="string" id="4689107">&#34;&nbsp;chunk&nbsp;is&nbsp;too&nbsp;large:&nbsp;&#34;</span>&nbsp;<span class="op" id="4689131">+</span>&nbsp;<span class="ident" id="4689133">strconv</span><span class="op" id="4689140">.</span><span class="ident" id="4689141">Itoa</span><span class="op" id="4689145">(</span><span class="builtinfunc" id="4689146">len</span><span class="op" id="4689149">(</span><span class="ident" id="4689150">b</span><span class="op" id="4689151">)</span><span class="op" id="4689152">)</span><span class="op" id="4689153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4689157">return</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4689165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689168">writeUint32</span><span class="op" id="4689179">(</span><span class="ident" id="4689180">e</span><span class="op" id="4689181">.</span><span class="ident" id="4689182">header</span><span class="op" id="4689188">[</span><span class="op" id="4689189">:</span><span class="num" id="4689190">4</span><span class="op" id="4689191">]</span><span class="op" id="4689192">,</span>&nbsp;<span class="ident" id="4689194">n</span><span class="op" id="4689195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689198">e</span><span class="op" id="4689199">.</span><span class="ident" id="4689200">header</span><span class="op" id="4689206">[</span><span class="num" id="4689207">4</span><span class="op" id="4689208">]</span>&nbsp;<span class="op" id="4689210">=</span>&nbsp;<span class="ident" id="4689212">name</span><span class="op" id="4689216">[</span><span class="num" id="4689217">0</span><span class="op" id="4689218">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689221">e</span><span class="op" id="4689222">.</span><span class="ident" id="4689223">header</span><span class="op" id="4689229">[</span><span class="num" id="4689230">5</span><span class="op" id="4689231">]</span>&nbsp;<span class="op" id="4689233">=</span>&nbsp;<span class="ident" id="4689235">name</span><span class="op" id="4689239">[</span><span class="num" id="4689240">1</span><span class="op" id="4689241">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689244">e</span><span class="op" id="4689245">.</span><span class="ident" id="4689246">header</span><span class="op" id="4689252">[</span><span class="num" id="4689253">6</span><span class="op" id="4689254">]</span>&nbsp;<span class="op" id="4689256">=</span>&nbsp;<span class="ident" id="4689258">name</span><span class="op" id="4689262">[</span><span class="num" id="4689263">2</span><span class="op" id="4689264">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689267">e</span><span class="op" id="4689268">.</span><span class="ident" id="4689269">header</span><span class="op" id="4689275">[</span><span class="num" id="4689276">7</span><span class="op" id="4689277">]</span>&nbsp;<span class="op" id="4689279">=</span>&nbsp;<span class="ident" id="4689281">name</span><span class="op" id="4689285">[</span><span class="num" id="4689286">3</span><span class="op" id="4689287">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689290">crc</span>&nbsp;<span class="op" id="4689294">:=</span>&nbsp;<span class="ident" id="4689297">crc32</span><span class="op" id="4689302">.</span><span class="ident" id="4689303">NewIEEE</span><span class="op" id="4689310">(</span><span class="op" id="4689311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689314">crc</span><span class="op" id="4689317">.</span><span class="ident" id="4689318">Write</span><span class="op" id="4689323">(</span><span class="ident" id="4689324">e</span><span class="op" id="4689325">.</span><span class="ident" id="4689326">header</span><span class="op" id="4689332">[</span><span class="num" id="4689333">4</span><span class="op" id="4689334">:</span><span class="num" id="4689335">8</span><span class="op" id="4689336">]</span><span class="op" id="4689337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689340">crc</span><span class="op" id="4689343">.</span><span class="ident" id="4689344">Write</span><span class="op" id="4689349">(</span><span class="ident" id="4689350">b</span><span class="op" id="4689351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689354">writeUint32</span><span class="op" id="4689365">(</span><span class="ident" id="4689366">e</span><span class="op" id="4689367">.</span><span class="ident" id="4689368">footer</span><span class="op" id="4689374">[</span><span class="op" id="4689375">:</span><span class="num" id="4689376">4</span><span class="op" id="4689377">]</span><span class="op" id="4689378">,</span>&nbsp;<span class="ident" id="4689380">crc</span><span class="op" id="4689383">.</span><span class="ident" id="4689384">Sum32</span><span class="op" id="4689389">(</span><span class="op" id="4689390">)</span><span class="op" id="4689391">)</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689395">_</span><span class="op" id="4689396">,</span>&nbsp;<span class="ident" id="4689398">e</span><span class="op" id="4689399">.</span><span class="ident" id="4689400">err</span>&nbsp;<span class="op" id="4689404">=</span>&nbsp;<span class="ident" id="4689406">e</span><span class="op" id="4689407">.</span><span class="ident" id="4689408">w</span><span class="op" id="4689409">.</span><span class="ident" id="4689410">Write</span><span class="op" id="4689415">(</span><span class="ident" id="4689416">e</span><span class="op" id="4689417">.</span><span class="ident" id="4689418">header</span><span class="op" id="4689424">[</span><span class="op" id="4689425">:</span><span class="num" id="4689426">8</span><span class="op" id="4689427">]</span><span class="op" id="4689428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4689431">if</span>&nbsp;<span class="ident" id="4689434">e</span><span class="op" id="4689435">.</span><span class="ident" id="4689436">err</span>&nbsp;<span class="op" id="4689440">!=</span>&nbsp;<span class="ident" id="4689443">nil</span>&nbsp;<span class="op" id="4689447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4689451">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4689459">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689462">_</span><span class="op" id="4689463">,</span>&nbsp;<span class="ident" id="4689465">e</span><span class="op" id="4689466">.</span><span class="ident" id="4689467">err</span>&nbsp;<span class="op" id="4689471">=</span>&nbsp;<span class="ident" id="4689473">e</span><span class="op" id="4689474">.</span><span class="ident" id="4689475">w</span><span class="op" id="4689476">.</span><span class="ident" id="4689477">Write</span><span class="op" id="4689482">(</span><span class="ident" id="4689483">b</span><span class="op" id="4689484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4689487">if</span>&nbsp;<span class="ident" id="4689490">e</span><span class="op" id="4689491">.</span><span class="ident" id="4689492">err</span>&nbsp;<span class="op" id="4689496">!=</span>&nbsp;<span class="ident" id="4689499">nil</span>&nbsp;<span class="op" id="4689503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4689507">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4689515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689518">_</span><span class="op" id="4689519">,</span>&nbsp;<span class="ident" id="4689521">e</span><span class="op" id="4689522">.</span><span class="ident" id="4689523">err</span>&nbsp;<span class="op" id="4689527">=</span>&nbsp;<span class="ident" id="4689529">e</span><span class="op" id="4689530">.</span><span class="ident" id="4689531">w</span><span class="op" id="4689532">.</span><span class="ident" id="4689533">Write</span><span class="op" id="4689538">(</span><span class="ident" id="4689539">e</span><span class="op" id="4689540">.</span><span class="ident" id="4689541">footer</span><span class="op" id="4689547">[</span><span class="op" id="4689548">:</span><span class="num" id="4689549">4</span><span class="op" id="4689550">]</span><span class="op" id="4689551">)</span><br>
<span class="lineno">110</span><span class="op" id="4689553">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4689556">func</span>&nbsp;<span class="op" id="4689561">(</span><span class="ident" id="4689562">e</span>&nbsp;<span class="op" id="4689564">*</span><span class="ident" id="4689565">encoder</span><span class="op" id="4689572">)</span>&nbsp;<span class="ident" id="4689574">writeIHDR</span><span class="op" id="4689583">(</span><span class="op" id="4689584">)</span>&nbsp;<span class="op" id="4689586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689589">b</span>&nbsp;<span class="op" id="4689591">:=</span>&nbsp;<span class="ident" id="4689594">e</span><span class="op" id="4689595">.</span><span class="ident" id="4689596">m</span><span class="op" id="4689597">.</span><span class="ident" id="4689598">Bounds</span><span class="op" id="4689604">(</span><span class="op" id="4689605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689608">writeUint32</span><span class="op" id="4689619">(</span><span class="ident" id="4689620">e</span><span class="op" id="4689621">.</span><span class="ident" id="4689622">tmp</span><span class="op" id="4689625">[</span><span class="num" id="4689626">0</span><span class="op" id="4689627">:</span><span class="num" id="4689628">4</span><span class="op" id="4689629">]</span><span class="op" id="4689630">,</span>&nbsp;<span class="builtintype" id="4689632">uint32</span><span class="op" id="4689638">(</span><span class="ident" id="4689639">b</span><span class="op" id="4689640">.</span><span class="ident" id="4689641">Dx</span><span class="op" id="4689643">(</span><span class="op" id="4689644">)</span><span class="op" id="4689645">)</span><span class="op" id="4689646">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689649">writeUint32</span><span class="op" id="4689660">(</span><span class="ident" id="4689661">e</span><span class="op" id="4689662">.</span><span class="ident" id="4689663">tmp</span><span class="op" id="4689666">[</span><span class="num" id="4689667">4</span><span class="op" id="4689668">:</span><span class="num" id="4689669">8</span><span class="op" id="4689670">]</span><span class="op" id="4689671">,</span>&nbsp;<span class="builtintype" id="4689673">uint32</span><span class="op" id="4689679">(</span><span class="ident" id="4689680">b</span><span class="op" id="4689681">.</span><span class="ident" id="4689682">Dy</span><span class="op" id="4689684">(</span><span class="op" id="4689685">)</span><span class="op" id="4689686">)</span><span class="op" id="4689687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4689690">//&nbsp;Set&nbsp;bit&nbsp;depth&nbsp;and&nbsp;color&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4689724">switch</span>&nbsp;<span class="ident" id="4689731">e</span><span class="op" id="4689732">.</span><span class="ident" id="4689733">cb</span>&nbsp;<span class="op" id="4689736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4689739">case</span>&nbsp;<span class="ident" id="4689744">cbG8</span><span class="op" id="4689748">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689752">e</span><span class="op" id="4689753">.</span><span class="ident" id="4689754">tmp</span><span class="op" id="4689757">[</span><span class="num" id="4689758">8</span><span class="op" id="4689759">]</span>&nbsp;<span class="op" id="4689761">=</span>&nbsp;<span class="num" id="4689763">8</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689767">e</span><span class="op" id="4689768">.</span><span class="ident" id="4689769">tmp</span><span class="op" id="4689772">[</span><span class="num" id="4689773">9</span><span class="op" id="4689774">]</span>&nbsp;<span class="op" id="4689776">=</span>&nbsp;<span class="ident" id="4689778">ctGrayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4689791">case</span>&nbsp;<span class="ident" id="4689796">cbTC8</span><span class="op" id="4689801">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689805">e</span><span class="op" id="4689806">.</span><span class="ident" id="4689807">tmp</span><span class="op" id="4689810">[</span><span class="num" id="4689811">8</span><span class="op" id="4689812">]</span>&nbsp;<span class="op" id="4689814">=</span>&nbsp;<span class="num" id="4689816">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689820">e</span><span class="op" id="4689821">.</span><span class="ident" id="4689822">tmp</span><span class="op" id="4689825">[</span><span class="num" id="4689826">9</span><span class="op" id="4689827">]</span>&nbsp;<span class="op" id="4689829">=</span>&nbsp;<span class="ident" id="4689831">ctTrueColor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4689844">case</span>&nbsp;<span class="ident" id="4689849">cbP8</span><span class="op" id="4689853">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689857">e</span><span class="op" id="4689858">.</span><span class="ident" id="4689859">tmp</span><span class="op" id="4689862">[</span><span class="num" id="4689863">8</span><span class="op" id="4689864">]</span>&nbsp;<span class="op" id="4689866">=</span>&nbsp;<span class="num" id="4689868">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689872">e</span><span class="op" id="4689873">.</span><span class="ident" id="4689874">tmp</span><span class="op" id="4689877">[</span><span class="num" id="4689878">9</span><span class="op" id="4689879">]</span>&nbsp;<span class="op" id="4689881">=</span>&nbsp;<span class="ident" id="4689883">ctPaletted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4689895">case</span>&nbsp;<span class="ident" id="4689900">cbTCA8</span><span class="op" id="4689906">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689910">e</span><span class="op" id="4689911">.</span><span class="ident" id="4689912">tmp</span><span class="op" id="4689915">[</span><span class="num" id="4689916">8</span><span class="op" id="4689917">]</span>&nbsp;<span class="op" id="4689919">=</span>&nbsp;<span class="num" id="4689921">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689925">e</span><span class="op" id="4689926">.</span><span class="ident" id="4689927">tmp</span><span class="op" id="4689930">[</span><span class="num" id="4689931">9</span><span class="op" id="4689932">]</span>&nbsp;<span class="op" id="4689934">=</span>&nbsp;<span class="ident" id="4689936">ctTrueColorAlpha</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4689954">case</span>&nbsp;<span class="ident" id="4689959">cbG16</span><span class="op" id="4689964">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689968">e</span><span class="op" id="4689969">.</span><span class="ident" id="4689970">tmp</span><span class="op" id="4689973">[</span><span class="num" id="4689974">8</span><span class="op" id="4689975">]</span>&nbsp;<span class="op" id="4689977">=</span>&nbsp;<span class="num" id="4689979">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689984">e</span><span class="op" id="4689985">.</span><span class="ident" id="4689986">tmp</span><span class="op" id="4689989">[</span><span class="num" id="4689990">9</span><span class="op" id="4689991">]</span>&nbsp;<span class="op" id="4689993">=</span>&nbsp;<span class="ident" id="4689995">ctGrayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4690008">case</span>&nbsp;<span class="ident" id="4690013">cbTC16</span><span class="op" id="4690019">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690023">e</span><span class="op" id="4690024">.</span><span class="ident" id="4690025">tmp</span><span class="op" id="4690028">[</span><span class="num" id="4690029">8</span><span class="op" id="4690030">]</span>&nbsp;<span class="op" id="4690032">=</span>&nbsp;<span class="num" id="4690034">16</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690039">e</span><span class="op" id="4690040">.</span><span class="ident" id="4690041">tmp</span><span class="op" id="4690044">[</span><span class="num" id="4690045">9</span><span class="op" id="4690046">]</span>&nbsp;<span class="op" id="4690048">=</span>&nbsp;<span class="ident" id="4690050">ctTrueColor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4690063">case</span>&nbsp;<span class="ident" id="4690068">cbTCA16</span><span class="op" id="4690075">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690079">e</span><span class="op" id="4690080">.</span><span class="ident" id="4690081">tmp</span><span class="op" id="4690084">[</span><span class="num" id="4690085">8</span><span class="op" id="4690086">]</span>&nbsp;<span class="op" id="4690088">=</span>&nbsp;<span class="num" id="4690090">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690095">e</span><span class="op" id="4690096">.</span><span class="ident" id="4690097">tmp</span><span class="op" id="4690100">[</span><span class="num" id="4690101">9</span><span class="op" id="4690102">]</span>&nbsp;<span class="op" id="4690104">=</span>&nbsp;<span class="ident" id="4690106">ctTrueColorAlpha</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4690124">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690127">e</span><span class="op" id="4690128">.</span><span class="ident" id="4690129">tmp</span><span class="op" id="4690132">[</span><span class="num" id="4690133">10</span><span class="op" id="4690135">]</span>&nbsp;<span class="op" id="4690137">=</span>&nbsp;<span class="num" id="4690139">0</span>&nbsp;<span class="comment" id="4690141">//&nbsp;default&nbsp;compression&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690172">e</span><span class="op" id="4690173">.</span><span class="ident" id="4690174">tmp</span><span class="op" id="4690177">[</span><span class="num" id="4690178">11</span><span class="op" id="4690180">]</span>&nbsp;<span class="op" id="4690182">=</span>&nbsp;<span class="num" id="4690184">0</span>&nbsp;<span class="comment" id="4690186">//&nbsp;default&nbsp;filter&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690212">e</span><span class="op" id="4690213">.</span><span class="ident" id="4690214">tmp</span><span class="op" id="4690217">[</span><span class="num" id="4690218">12</span><span class="op" id="4690220">]</span>&nbsp;<span class="op" id="4690222">=</span>&nbsp;<span class="num" id="4690224">0</span>&nbsp;<span class="comment" id="4690226">//&nbsp;non-interlaced</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690245">e</span><span class="op" id="4690246">.</span><span class="ident" id="4690247">writeChunk</span><span class="op" id="4690257">(</span><span class="ident" id="4690258">e</span><span class="op" id="4690259">.</span><span class="ident" id="4690260">tmp</span><span class="op" id="4690263">[</span><span class="op" id="4690264">:</span><span class="num" id="4690265">13</span><span class="op" id="4690267">]</span><span class="op" id="4690268">,</span>&nbsp;<span class="string" id="4690270">&#34;IHDR&#34;</span><span class="op" id="4690276">)</span><br>
<span class="lineno"></span><span class="op" id="4690278">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span><span class="keyword" id="4690281">func</span>&nbsp;<span class="op" id="4690286">(</span><span class="ident" id="4690287">e</span>&nbsp;<span class="op" id="4690289">*</span><span class="ident" id="4690290">encoder</span><span class="op" id="4690297">)</span>&nbsp;<span class="ident" id="4690299">writePLTEAndTRNS</span><span class="op" id="4690315">(</span><span class="ident" id="4690316">p</span>&nbsp;<span class="ident" id="4690318">color</span><span class="op" id="4690323">.</span><span class="ident" id="4690324">Palette</span><span class="op" id="4690331">)</span>&nbsp;<span class="op" id="4690333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4690336">if</span>&nbsp;<span class="builtinfunc" id="4690339">len</span><span class="op" id="4690342">(</span><span class="ident" id="4690343">p</span><span class="op" id="4690344">)</span>&nbsp;<span class="op" id="4690346">&lt;</span>&nbsp;<span class="num" id="4690348">1</span>&nbsp;<span class="op" id="4690350">||</span>&nbsp;<span class="builtinfunc" id="4690353">len</span><span class="op" id="4690356">(</span><span class="ident" id="4690357">p</span><span class="op" id="4690358">)</span>&nbsp;<span class="op" id="4690360">&gt;</span>&nbsp;<span class="num" id="4690362">256</span>&nbsp;<span class="op" id="4690366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690370">e</span><span class="op" id="4690371">.</span><span class="ident" id="4690372">err</span>&nbsp;<span class="op" id="4690376">=</span>&nbsp;<span class="ident" id="4690378">FormatError</span><span class="op" id="4690389">(</span><span class="string" id="4690390">&#34;bad&nbsp;palette&nbsp;length:&nbsp;&#34;</span>&nbsp;<span class="op" id="4690413">+</span>&nbsp;<span class="ident" id="4690415">strconv</span><span class="op" id="4690422">.</span><span class="ident" id="4690423">Itoa</span><span class="op" id="4690427">(</span><span class="builtinfunc" id="4690428">len</span><span class="op" id="4690431">(</span><span class="ident" id="4690432">p</span><span class="op" id="4690433">)</span><span class="op" id="4690434">)</span><span class="op" id="4690435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4690439">return</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4690447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690450">last</span>&nbsp;<span class="op" id="4690455">:=</span>&nbsp;<span class="op" id="4690458">-</span><span class="num" id="4690459">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4690462">for</span>&nbsp;<span class="ident" id="4690466">i</span><span class="op" id="4690467">,</span>&nbsp;<span class="ident" id="4690469">c</span>&nbsp;<span class="op" id="4690471">:=</span>&nbsp;<span class="keyword" id="4690474">range</span>&nbsp;<span class="ident" id="4690480">p</span>&nbsp;<span class="op" id="4690482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690486">c1</span>&nbsp;<span class="op" id="4690489">:=</span>&nbsp;<span class="ident" id="4690492">color</span><span class="op" id="4690497">.</span><span class="ident" id="4690498">NRGBAModel</span><span class="op" id="4690508">.</span><span class="ident" id="4690509">Convert</span><span class="op" id="4690516">(</span><span class="ident" id="4690517">c</span><span class="op" id="4690518">)</span><span class="op" id="4690519">.</span><span class="op" id="4690520">(</span><span class="ident" id="4690521">color</span><span class="op" id="4690526">.</span><span class="ident" id="4690527">NRGBA</span><span class="op" id="4690532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690536">e</span><span class="op" id="4690537">.</span><span class="ident" id="4690538">tmp</span><span class="op" id="4690541">[</span><span class="num" id="4690542">3</span><span class="op" id="4690543">*</span><span class="ident" id="4690544">i</span><span class="op" id="4690545">+</span><span class="num" id="4690546">0</span><span class="op" id="4690547">]</span>&nbsp;<span class="op" id="4690549">=</span>&nbsp;<span class="ident" id="4690551">c1</span><span class="op" id="4690553">.</span><span class="ident" id="4690554">R</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690558">e</span><span class="op" id="4690559">.</span><span class="ident" id="4690560">tmp</span><span class="op" id="4690563">[</span><span class="num" id="4690564">3</span><span class="op" id="4690565">*</span><span class="ident" id="4690566">i</span><span class="op" id="4690567">+</span><span class="num" id="4690568">1</span><span class="op" id="4690569">]</span>&nbsp;<span class="op" id="4690571">=</span>&nbsp;<span class="ident" id="4690573">c1</span><span class="op" id="4690575">.</span><span class="ident" id="4690576">G</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690580">e</span><span class="op" id="4690581">.</span><span class="ident" id="4690582">tmp</span><span class="op" id="4690585">[</span><span class="num" id="4690586">3</span><span class="op" id="4690587">*</span><span class="ident" id="4690588">i</span><span class="op" id="4690589">+</span><span class="num" id="4690590">2</span><span class="op" id="4690591">]</span>&nbsp;<span class="op" id="4690593">=</span>&nbsp;<span class="ident" id="4690595">c1</span><span class="op" id="4690597">.</span><span class="ident" id="4690598">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4690602">if</span>&nbsp;<span class="ident" id="4690605">c1</span><span class="op" id="4690607">.</span><span class="ident" id="4690608">A</span>&nbsp;<span class="op" id="4690610">!=</span>&nbsp;<span class="num" id="4690613">0xff</span>&nbsp;<span class="op" id="4690618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690623">last</span>&nbsp;<span class="op" id="4690628">=</span>&nbsp;<span class="ident" id="4690630">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4690634">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690638">e</span><span class="op" id="4690639">.</span><span class="ident" id="4690640">tmp</span><span class="op" id="4690643">[</span><span class="num" id="4690644">3</span><span class="op" id="4690645">*</span><span class="num" id="4690646">256</span><span class="op" id="4690649">+</span><span class="ident" id="4690650">i</span><span class="op" id="4690651">]</span>&nbsp;<span class="op" id="4690653">=</span>&nbsp;<span class="ident" id="4690655">c1</span><span class="op" id="4690657">.</span><span class="ident" id="4690658">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4690661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690664">e</span><span class="op" id="4690665">.</span><span class="ident" id="4690666">writeChunk</span><span class="op" id="4690676">(</span><span class="ident" id="4690677">e</span><span class="op" id="4690678">.</span><span class="ident" id="4690679">tmp</span><span class="op" id="4690682">[</span><span class="op" id="4690683">:</span><span class="num" id="4690684">3</span><span class="op" id="4690685">*</span><span class="builtinfunc" id="4690686">len</span><span class="op" id="4690689">(</span><span class="ident" id="4690690">p</span><span class="op" id="4690691">)</span><span class="op" id="4690692">]</span><span class="op" id="4690693">,</span>&nbsp;<span class="string" id="4690695">&#34;PLTE&#34;</span><span class="op" id="4690701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4690704">if</span>&nbsp;<span class="ident" id="4690707">last</span>&nbsp;<span class="op" id="4690712">!=</span>&nbsp;<span class="op" id="4690715">-</span><span class="num" id="4690716">1</span>&nbsp;<span class="op" id="4690718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690722">e</span><span class="op" id="4690723">.</span><span class="ident" id="4690724">writeChunk</span><span class="op" id="4690734">(</span><span class="ident" id="4690735">e</span><span class="op" id="4690736">.</span><span class="ident" id="4690737">tmp</span><span class="op" id="4690740">[</span><span class="num" id="4690741">3</span><span class="op" id="4690742">*</span><span class="num" id="4690743">256</span><span class="op" id="4690746">:</span><span class="num" id="4690747">3</span><span class="op" id="4690748">*</span><span class="num" id="4690749">256</span><span class="op" id="4690752">+</span><span class="num" id="4690753">1</span><span class="op" id="4690754">+</span><span class="ident" id="4690755">last</span><span class="op" id="4690759">]</span><span class="op" id="4690760">,</span>&nbsp;<span class="string" id="4690762">&#34;tRNS&#34;</span><span class="op" id="4690768">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4690771">}</span><br>
<span class="lineno"></span><span class="op" id="4690773">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4690776">//&nbsp;An&nbsp;encoder&nbsp;is&nbsp;an&nbsp;io.Writer&nbsp;that&nbsp;satisfies&nbsp;writes&nbsp;by&nbsp;writing&nbsp;PNG&nbsp;IDAT&nbsp;chunks,</span><br>
<span class="lineno"></span><span class="comment" id="4690856">//&nbsp;including&nbsp;an&nbsp;8-byte&nbsp;header&nbsp;and&nbsp;4-byte&nbsp;CRC&nbsp;checksum&nbsp;per&nbsp;Write&nbsp;call.&nbsp;Such&nbsp;calls</span><br>
<span class="lineno">170</span><span class="comment" id="4690937">//&nbsp;should&nbsp;be&nbsp;relatively&nbsp;infrequent,&nbsp;since&nbsp;writeIDATs&nbsp;uses&nbsp;a&nbsp;bufio.Writer.</span><br>
<span class="lineno"></span><span class="comment" id="4691011">//</span><br>
<span class="lineno"></span><span class="comment" id="4691014">//&nbsp;This&nbsp;method&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;writeIDATs&nbsp;(via&nbsp;writeImage).</span><br>
<span class="lineno"></span><span class="comment" id="4691085">//&nbsp;No&nbsp;other&nbsp;code&nbsp;should&nbsp;treat&nbsp;an&nbsp;encoder&nbsp;as&nbsp;an&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4691143">func</span>&nbsp;<span class="op" id="4691148">(</span><span class="ident" id="4691149">e</span>&nbsp;<span class="op" id="4691151">*</span><span class="ident" id="4691152">encoder</span><span class="op" id="4691159">)</span>&nbsp;<span class="ident" id="4691161">Write</span><span class="op" id="4691166">(</span><span class="ident" id="4691167">b</span>&nbsp;<span class="op" id="4691169">[</span><span class="op" id="4691170">]</span><span class="builtintype" id="4691171">byte</span><span class="op" id="4691175">)</span>&nbsp;<span class="op" id="4691177">(</span><span class="builtintype" id="4691178">int</span><span class="op" id="4691181">,</span>&nbsp;<span class="builtintype" id="4691183">error</span><span class="op" id="4691188">)</span>&nbsp;<span class="op" id="4691190">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4691193">e</span><span class="op" id="4691194">.</span><span class="ident" id="4691195">writeChunk</span><span class="op" id="4691205">(</span><span class="ident" id="4691206">b</span><span class="op" id="4691207">,</span>&nbsp;<span class="string" id="4691209">&#34;IDAT&#34;</span><span class="op" id="4691215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4691218">if</span>&nbsp;<span class="ident" id="4691221">e</span><span class="op" id="4691222">.</span><span class="ident" id="4691223">err</span>&nbsp;<span class="op" id="4691227">!=</span>&nbsp;<span class="ident" id="4691230">nil</span>&nbsp;<span class="op" id="4691234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4691238">return</span>&nbsp;<span class="num" id="4691245">0</span><span class="op" id="4691246">,</span>&nbsp;<span class="ident" id="4691248">e</span><span class="op" id="4691249">.</span><span class="ident" id="4691250">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4691255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4691258">return</span>&nbsp;<span class="builtinfunc" id="4691265">len</span><span class="op" id="4691268">(</span><span class="ident" id="4691269">b</span><span class="op" id="4691270">)</span><span class="op" id="4691271">,</span>&nbsp;<span class="ident" id="4691273">nil</span><br>
<span class="lineno">180</span><span class="op" id="4691277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4691280">//&nbsp;Chooses&nbsp;the&nbsp;filter&nbsp;to&nbsp;use&nbsp;for&nbsp;encoding&nbsp;the&nbsp;current&nbsp;row,&nbsp;and&nbsp;applies&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="4691355">//&nbsp;The&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;filter&nbsp;and&nbsp;also&nbsp;of&nbsp;the&nbsp;row&nbsp;in&nbsp;cr&nbsp;that&nbsp;has&nbsp;had&nbsp;it&nbsp;applied.</span><br>
<span class="lineno"></span><span class="keyword" id="4691453">func</span>&nbsp;<span class="ident" id="4691458">filter</span><span class="op" id="4691464">(</span><span class="ident" id="4691465">cr</span>&nbsp;<span class="op" id="4691468">*</span><span class="op" id="4691469">[</span><span class="ident" id="4691470">nFilter</span><span class="op" id="4691477">]</span><span class="op" id="4691478">[</span><span class="op" id="4691479">]</span><span class="builtintype" id="4691480">byte</span><span class="op" id="4691484">,</span>&nbsp;<span class="ident" id="4691486">pr</span>&nbsp;<span class="op" id="4691489">[</span><span class="op" id="4691490">]</span><span class="builtintype" id="4691491">byte</span><span class="op" id="4691495">,</span>&nbsp;<span class="ident" id="4691497">bpp</span>&nbsp;<span class="builtintype" id="4691501">int</span><span class="op" id="4691504">)</span>&nbsp;<span class="builtintype" id="4691506">int</span>&nbsp;<span class="op" id="4691510">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4691513">//&nbsp;We&nbsp;try&nbsp;all&nbsp;five&nbsp;filter&nbsp;types,&nbsp;and&nbsp;pick&nbsp;the&nbsp;one&nbsp;that&nbsp;minimizes&nbsp;the&nbsp;sum&nbsp;of&nbsp;absolute&nbsp;differences.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4691612">//&nbsp;This&nbsp;is&nbsp;the&nbsp;same&nbsp;heuristic&nbsp;that&nbsp;libpng&nbsp;uses,&nbsp;although&nbsp;the&nbsp;filters&nbsp;are&nbsp;attempted&nbsp;in&nbsp;order&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4691708">//&nbsp;estimated&nbsp;most&nbsp;likely&nbsp;to&nbsp;be&nbsp;minimal&nbsp;(ftUp,&nbsp;ftPaeth,&nbsp;ftNone,&nbsp;ftSub,&nbsp;ftAverage),&nbsp;rather&nbsp;than</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4691803">//&nbsp;in&nbsp;their&nbsp;enumeration&nbsp;order&nbsp;(ftNone,&nbsp;ftSub,&nbsp;ftUp,&nbsp;ftAverage,&nbsp;ftPaeth).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4691877">cdat0</span>&nbsp;<span class="op" id="4691883">:=</span>&nbsp;<span class="ident" id="4691886">cr</span><span class="op" id="4691888">[</span><span class="num" id="4691889">0</span><span class="op" id="4691890">]</span><span class="op" id="4691891">[</span><span class="num" id="4691892">1</span><span class="op" id="4691893">:</span><span class="op" id="4691894">]</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4691897">cdat1</span>&nbsp;<span class="op" id="4691903">:=</span>&nbsp;<span class="ident" id="4691906">cr</span><span class="op" id="4691908">[</span><span class="num" id="4691909">1</span><span class="op" id="4691910">]</span><span class="op" id="4691911">[</span><span class="num" id="4691912">1</span><span class="op" id="4691913">:</span><span class="op" id="4691914">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4691917">cdat2</span>&nbsp;<span class="op" id="4691923">:=</span>&nbsp;<span class="ident" id="4691926">cr</span><span class="op" id="4691928">[</span><span class="num" id="4691929">2</span><span class="op" id="4691930">]</span><span class="op" id="4691931">[</span><span class="num" id="4691932">1</span><span class="op" id="4691933">:</span><span class="op" id="4691934">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4691937">cdat3</span>&nbsp;<span class="op" id="4691943">:=</span>&nbsp;<span class="ident" id="4691946">cr</span><span class="op" id="4691948">[</span><span class="num" id="4691949">3</span><span class="op" id="4691950">]</span><span class="op" id="4691951">[</span><span class="num" id="4691952">1</span><span class="op" id="4691953">:</span><span class="op" id="4691954">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4691957">cdat4</span>&nbsp;<span class="op" id="4691963">:=</span>&nbsp;<span class="ident" id="4691966">cr</span><span class="op" id="4691968">[</span><span class="num" id="4691969">4</span><span class="op" id="4691970">]</span><span class="op" id="4691971">[</span><span class="num" id="4691972">1</span><span class="op" id="4691973">:</span><span class="op" id="4691974">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4691977">pdat</span>&nbsp;<span class="op" id="4691982">:=</span>&nbsp;<span class="ident" id="4691985">pr</span><span class="op" id="4691987">[</span><span class="num" id="4691988">1</span><span class="op" id="4691989">:</span><span class="op" id="4691990">]</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4691993">n</span>&nbsp;<span class="op" id="4691995">:=</span>&nbsp;<span class="builtinfunc" id="4691998">len</span><span class="op" id="4692001">(</span><span class="ident" id="4692002">cdat0</span><span class="op" id="4692007">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4692011">//&nbsp;The&nbsp;up&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692030">sum</span>&nbsp;<span class="op" id="4692034">:=</span>&nbsp;<span class="num" id="4692037">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4692040">for</span>&nbsp;<span class="ident" id="4692044">i</span>&nbsp;<span class="op" id="4692046">:=</span>&nbsp;<span class="num" id="4692049">0</span><span class="op" id="4692050">;</span>&nbsp;<span class="ident" id="4692052">i</span>&nbsp;<span class="op" id="4692054">&lt;</span>&nbsp;<span class="ident" id="4692056">n</span><span class="op" id="4692057">;</span>&nbsp;<span class="ident" id="4692059">i</span><span class="op" id="4692060">++</span>&nbsp;<span class="op" id="4692063">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692067">cdat2</span><span class="op" id="4692072">[</span><span class="ident" id="4692073">i</span><span class="op" id="4692074">]</span>&nbsp;<span class="op" id="4692076">=</span>&nbsp;<span class="ident" id="4692078">cdat0</span><span class="op" id="4692083">[</span><span class="ident" id="4692084">i</span><span class="op" id="4692085">]</span>&nbsp;<span class="op" id="4692087">-</span>&nbsp;<span class="ident" id="4692089">pdat</span><span class="op" id="4692093">[</span><span class="ident" id="4692094">i</span><span class="op" id="4692095">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692099">sum</span>&nbsp;<span class="op" id="4692103">+=</span>&nbsp;<span class="ident" id="4692106">abs8</span><span class="op" id="4692110">(</span><span class="ident" id="4692111">cdat2</span><span class="op" id="4692116">[</span><span class="ident" id="4692117">i</span><span class="op" id="4692118">]</span><span class="op" id="4692119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4692122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692125">best</span>&nbsp;<span class="op" id="4692130">:=</span>&nbsp;<span class="ident" id="4692133">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692138">filter</span>&nbsp;<span class="op" id="4692145">:=</span>&nbsp;<span class="ident" id="4692148">ftUp</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4692155">//&nbsp;The&nbsp;Paeth&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692177">sum</span>&nbsp;<span class="op" id="4692181">=</span>&nbsp;<span class="num" id="4692183">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4692186">for</span>&nbsp;<span class="ident" id="4692190">i</span>&nbsp;<span class="op" id="4692192">:=</span>&nbsp;<span class="num" id="4692195">0</span><span class="op" id="4692196">;</span>&nbsp;<span class="ident" id="4692198">i</span>&nbsp;<span class="op" id="4692200">&lt;</span>&nbsp;<span class="ident" id="4692202">bpp</span><span class="op" id="4692205">;</span>&nbsp;<span class="ident" id="4692207">i</span><span class="op" id="4692208">++</span>&nbsp;<span class="op" id="4692211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692215">cdat4</span><span class="op" id="4692220">[</span><span class="ident" id="4692221">i</span><span class="op" id="4692222">]</span>&nbsp;<span class="op" id="4692224">=</span>&nbsp;<span class="ident" id="4692226">cdat0</span><span class="op" id="4692231">[</span><span class="ident" id="4692232">i</span><span class="op" id="4692233">]</span>&nbsp;<span class="op" id="4692235">-</span>&nbsp;<span class="ident" id="4692237">pdat</span><span class="op" id="4692241">[</span><span class="ident" id="4692242">i</span><span class="op" id="4692243">]</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692247">sum</span>&nbsp;<span class="op" id="4692251">+=</span>&nbsp;<span class="ident" id="4692254">abs8</span><span class="op" id="4692258">(</span><span class="ident" id="4692259">cdat4</span><span class="op" id="4692264">[</span><span class="ident" id="4692265">i</span><span class="op" id="4692266">]</span><span class="op" id="4692267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4692270">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4692273">for</span>&nbsp;<span class="ident" id="4692277">i</span>&nbsp;<span class="op" id="4692279">:=</span>&nbsp;<span class="ident" id="4692282">bpp</span><span class="op" id="4692285">;</span>&nbsp;<span class="ident" id="4692287">i</span>&nbsp;<span class="op" id="4692289">&lt;</span>&nbsp;<span class="ident" id="4692291">n</span><span class="op" id="4692292">;</span>&nbsp;<span class="ident" id="4692294">i</span><span class="op" id="4692295">++</span>&nbsp;<span class="op" id="4692298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692302">cdat4</span><span class="op" id="4692307">[</span><span class="ident" id="4692308">i</span><span class="op" id="4692309">]</span>&nbsp;<span class="op" id="4692311">=</span>&nbsp;<span class="ident" id="4692313">cdat0</span><span class="op" id="4692318">[</span><span class="ident" id="4692319">i</span><span class="op" id="4692320">]</span>&nbsp;<span class="op" id="4692322">-</span>&nbsp;<span class="ident" id="4692324">paeth</span><span class="op" id="4692329">(</span><span class="ident" id="4692330">cdat0</span><span class="op" id="4692335">[</span><span class="ident" id="4692336">i</span><span class="op" id="4692337">-</span><span class="ident" id="4692338">bpp</span><span class="op" id="4692341">]</span><span class="op" id="4692342">,</span>&nbsp;<span class="ident" id="4692344">pdat</span><span class="op" id="4692348">[</span><span class="ident" id="4692349">i</span><span class="op" id="4692350">]</span><span class="op" id="4692351">,</span>&nbsp;<span class="ident" id="4692353">pdat</span><span class="op" id="4692357">[</span><span class="ident" id="4692358">i</span><span class="op" id="4692359">-</span><span class="ident" id="4692360">bpp</span><span class="op" id="4692363">]</span><span class="op" id="4692364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692368">sum</span>&nbsp;<span class="op" id="4692372">+=</span>&nbsp;<span class="ident" id="4692375">abs8</span><span class="op" id="4692379">(</span><span class="ident" id="4692380">cdat4</span><span class="op" id="4692385">[</span><span class="ident" id="4692386">i</span><span class="op" id="4692387">]</span><span class="op" id="4692388">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4692392">if</span>&nbsp;<span class="ident" id="4692395">sum</span>&nbsp;<span class="op" id="4692399">&gt;=</span>&nbsp;<span class="ident" id="4692402">best</span>&nbsp;<span class="op" id="4692407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4692412">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4692420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4692423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4692426">if</span>&nbsp;<span class="ident" id="4692429">sum</span>&nbsp;<span class="op" id="4692433">&lt;</span>&nbsp;<span class="ident" id="4692435">best</span>&nbsp;<span class="op" id="4692440">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692444">best</span>&nbsp;<span class="op" id="4692449">=</span>&nbsp;<span class="ident" id="4692451">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692457">filter</span>&nbsp;<span class="op" id="4692464">=</span>&nbsp;<span class="ident" id="4692466">ftPaeth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4692475">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4692479">//&nbsp;The&nbsp;none&nbsp;filter.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692500">sum</span>&nbsp;<span class="op" id="4692504">=</span>&nbsp;<span class="num" id="4692506">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4692509">for</span>&nbsp;<span class="ident" id="4692513">i</span>&nbsp;<span class="op" id="4692515">:=</span>&nbsp;<span class="num" id="4692518">0</span><span class="op" id="4692519">;</span>&nbsp;<span class="ident" id="4692521">i</span>&nbsp;<span class="op" id="4692523">&lt;</span>&nbsp;<span class="ident" id="4692525">n</span><span class="op" id="4692526">;</span>&nbsp;<span class="ident" id="4692528">i</span><span class="op" id="4692529">++</span>&nbsp;<span class="op" id="4692532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692536">sum</span>&nbsp;<span class="op" id="4692540">+=</span>&nbsp;<span class="ident" id="4692543">abs8</span><span class="op" id="4692547">(</span><span class="ident" id="4692548">cdat0</span><span class="op" id="4692553">[</span><span class="ident" id="4692554">i</span><span class="op" id="4692555">]</span><span class="op" id="4692556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4692560">if</span>&nbsp;<span class="ident" id="4692563">sum</span>&nbsp;<span class="op" id="4692567">&gt;=</span>&nbsp;<span class="ident" id="4692570">best</span>&nbsp;<span class="op" id="4692575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4692580">break</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4692588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4692591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4692594">if</span>&nbsp;<span class="ident" id="4692597">sum</span>&nbsp;<span class="op" id="4692601">&lt;</span>&nbsp;<span class="ident" id="4692603">best</span>&nbsp;<span class="op" id="4692608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692612">best</span>&nbsp;<span class="op" id="4692617">=</span>&nbsp;<span class="ident" id="4692619">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692625">filter</span>&nbsp;<span class="op" id="4692632">=</span>&nbsp;<span class="ident" id="4692634">ftNone</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4692642">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4692646">//&nbsp;The&nbsp;sub&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692666">sum</span>&nbsp;<span class="op" id="4692670">=</span>&nbsp;<span class="num" id="4692672">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4692675">for</span>&nbsp;<span class="ident" id="4692679">i</span>&nbsp;<span class="op" id="4692681">:=</span>&nbsp;<span class="num" id="4692684">0</span><span class="op" id="4692685">;</span>&nbsp;<span class="ident" id="4692687">i</span>&nbsp;<span class="op" id="4692689">&lt;</span>&nbsp;<span class="ident" id="4692691">bpp</span><span class="op" id="4692694">;</span>&nbsp;<span class="ident" id="4692696">i</span><span class="op" id="4692697">++</span>&nbsp;<span class="op" id="4692700">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692704">cdat1</span><span class="op" id="4692709">[</span><span class="ident" id="4692710">i</span><span class="op" id="4692711">]</span>&nbsp;<span class="op" id="4692713">=</span>&nbsp;<span class="ident" id="4692715">cdat0</span><span class="op" id="4692720">[</span><span class="ident" id="4692721">i</span><span class="op" id="4692722">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692726">sum</span>&nbsp;<span class="op" id="4692730">+=</span>&nbsp;<span class="ident" id="4692733">abs8</span><span class="op" id="4692737">(</span><span class="ident" id="4692738">cdat1</span><span class="op" id="4692743">[</span><span class="ident" id="4692744">i</span><span class="op" id="4692745">]</span><span class="op" id="4692746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4692749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4692752">for</span>&nbsp;<span class="ident" id="4692756">i</span>&nbsp;<span class="op" id="4692758">:=</span>&nbsp;<span class="ident" id="4692761">bpp</span><span class="op" id="4692764">;</span>&nbsp;<span class="ident" id="4692766">i</span>&nbsp;<span class="op" id="4692768">&lt;</span>&nbsp;<span class="ident" id="4692770">n</span><span class="op" id="4692771">;</span>&nbsp;<span class="ident" id="4692773">i</span><span class="op" id="4692774">++</span>&nbsp;<span class="op" id="4692777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692781">cdat1</span><span class="op" id="4692786">[</span><span class="ident" id="4692787">i</span><span class="op" id="4692788">]</span>&nbsp;<span class="op" id="4692790">=</span>&nbsp;<span class="ident" id="4692792">cdat0</span><span class="op" id="4692797">[</span><span class="ident" id="4692798">i</span><span class="op" id="4692799">]</span>&nbsp;<span class="op" id="4692801">-</span>&nbsp;<span class="ident" id="4692803">cdat0</span><span class="op" id="4692808">[</span><span class="ident" id="4692809">i</span><span class="op" id="4692810">-</span><span class="ident" id="4692811">bpp</span><span class="op" id="4692814">]</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692818">sum</span>&nbsp;<span class="op" id="4692822">+=</span>&nbsp;<span class="ident" id="4692825">abs8</span><span class="op" id="4692829">(</span><span class="ident" id="4692830">cdat1</span><span class="op" id="4692835">[</span><span class="ident" id="4692836">i</span><span class="op" id="4692837">]</span><span class="op" id="4692838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4692842">if</span>&nbsp;<span class="ident" id="4692845">sum</span>&nbsp;<span class="op" id="4692849">&gt;=</span>&nbsp;<span class="ident" id="4692852">best</span>&nbsp;<span class="op" id="4692857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4692862">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4692870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4692873">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4692876">if</span>&nbsp;<span class="ident" id="4692879">sum</span>&nbsp;<span class="op" id="4692883">&lt;</span>&nbsp;<span class="ident" id="4692885">best</span>&nbsp;<span class="op" id="4692890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692894">best</span>&nbsp;<span class="op" id="4692899">=</span>&nbsp;<span class="ident" id="4692901">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692907">filter</span>&nbsp;<span class="op" id="4692914">=</span>&nbsp;<span class="ident" id="4692916">ftSub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4692923">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4692927">//&nbsp;The&nbsp;average&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692951">sum</span>&nbsp;<span class="op" id="4692955">=</span>&nbsp;<span class="num" id="4692957">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4692960">for</span>&nbsp;<span class="ident" id="4692964">i</span>&nbsp;<span class="op" id="4692966">:=</span>&nbsp;<span class="num" id="4692969">0</span><span class="op" id="4692970">;</span>&nbsp;<span class="ident" id="4692972">i</span>&nbsp;<span class="op" id="4692974">&lt;</span>&nbsp;<span class="ident" id="4692976">bpp</span><span class="op" id="4692979">;</span>&nbsp;<span class="ident" id="4692981">i</span><span class="op" id="4692982">++</span>&nbsp;<span class="op" id="4692985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692989">cdat3</span><span class="op" id="4692994">[</span><span class="ident" id="4692995">i</span><span class="op" id="4692996">]</span>&nbsp;<span class="op" id="4692998">=</span>&nbsp;<span class="ident" id="4693000">cdat0</span><span class="op" id="4693005">[</span><span class="ident" id="4693006">i</span><span class="op" id="4693007">]</span>&nbsp;<span class="op" id="4693009">-</span>&nbsp;<span class="ident" id="4693011">pdat</span><span class="op" id="4693015">[</span><span class="ident" id="4693016">i</span><span class="op" id="4693017">]</span><span class="op" id="4693018">/</span><span class="num" id="4693019">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693023">sum</span>&nbsp;<span class="op" id="4693027">+=</span>&nbsp;<span class="ident" id="4693030">abs8</span><span class="op" id="4693034">(</span><span class="ident" id="4693035">cdat3</span><span class="op" id="4693040">[</span><span class="ident" id="4693041">i</span><span class="op" id="4693042">]</span><span class="op" id="4693043">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4693046">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4693049">for</span>&nbsp;<span class="ident" id="4693053">i</span>&nbsp;<span class="op" id="4693055">:=</span>&nbsp;<span class="ident" id="4693058">bpp</span><span class="op" id="4693061">;</span>&nbsp;<span class="ident" id="4693063">i</span>&nbsp;<span class="op" id="4693065">&lt;</span>&nbsp;<span class="ident" id="4693067">n</span><span class="op" id="4693068">;</span>&nbsp;<span class="ident" id="4693070">i</span><span class="op" id="4693071">++</span>&nbsp;<span class="op" id="4693074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693078">cdat3</span><span class="op" id="4693083">[</span><span class="ident" id="4693084">i</span><span class="op" id="4693085">]</span>&nbsp;<span class="op" id="4693087">=</span>&nbsp;<span class="ident" id="4693089">cdat0</span><span class="op" id="4693094">[</span><span class="ident" id="4693095">i</span><span class="op" id="4693096">]</span>&nbsp;<span class="op" id="4693098">-</span>&nbsp;<span class="builtintype" id="4693100">uint8</span><span class="op" id="4693105">(</span><span class="op" id="4693106">(</span><span class="builtintype" id="4693107">int</span><span class="op" id="4693110">(</span><span class="ident" id="4693111">cdat0</span><span class="op" id="4693116">[</span><span class="ident" id="4693117">i</span><span class="op" id="4693118">-</span><span class="ident" id="4693119">bpp</span><span class="op" id="4693122">]</span><span class="op" id="4693123">)</span><span class="op" id="4693124">+</span><span class="builtintype" id="4693125">int</span><span class="op" id="4693128">(</span><span class="ident" id="4693129">pdat</span><span class="op" id="4693133">[</span><span class="ident" id="4693134">i</span><span class="op" id="4693135">]</span><span class="op" id="4693136">)</span><span class="op" id="4693137">)</span><span class="op" id="4693138">/</span><span class="num" id="4693139">2</span><span class="op" id="4693140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693144">sum</span>&nbsp;<span class="op" id="4693148">+=</span>&nbsp;<span class="ident" id="4693151">abs8</span><span class="op" id="4693155">(</span><span class="ident" id="4693156">cdat3</span><span class="op" id="4693161">[</span><span class="ident" id="4693162">i</span><span class="op" id="4693163">]</span><span class="op" id="4693164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4693168">if</span>&nbsp;<span class="ident" id="4693171">sum</span>&nbsp;<span class="op" id="4693175">&gt;=</span>&nbsp;<span class="ident" id="4693178">best</span>&nbsp;<span class="op" id="4693183">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4693188">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4693196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4693199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4693202">if</span>&nbsp;<span class="ident" id="4693205">sum</span>&nbsp;<span class="op" id="4693209">&lt;</span>&nbsp;<span class="ident" id="4693211">best</span>&nbsp;<span class="op" id="4693216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693220">best</span>&nbsp;<span class="op" id="4693225">=</span>&nbsp;<span class="ident" id="4693227">sum</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693233">filter</span>&nbsp;<span class="op" id="4693240">=</span>&nbsp;<span class="ident" id="4693242">ftAverage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4693253">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4693257">return</span>&nbsp;<span class="ident" id="4693264">filter</span><br>
<span class="lineno"></span><span class="op" id="4693271">}</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span><span class="keyword" id="4693274">func</span>&nbsp;<span class="ident" id="4693279">writeImage</span><span class="op" id="4693289">(</span><span class="ident" id="4693290">w</span>&nbsp;<span class="ident" id="4693292">io</span><span class="op" id="4693294">.</span><span class="ident" id="4693295">Writer</span><span class="op" id="4693301">,</span>&nbsp;<span class="ident" id="4693303">m</span>&nbsp;<span class="ident" id="4693305">image</span><span class="op" id="4693310">.</span><span class="ident" id="4693311">Image</span><span class="op" id="4693316">,</span>&nbsp;<span class="ident" id="4693318">cb</span>&nbsp;<span class="builtintype" id="4693321">int</span><span class="op" id="4693324">,</span>&nbsp;<span class="ident" id="4693326">level</span>&nbsp;<span class="builtintype" id="4693332">int</span><span class="op" id="4693335">)</span>&nbsp;<span class="builtintype" id="4693337">error</span>&nbsp;<span class="op" id="4693343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693346">zw</span><span class="op" id="4693348">,</span>&nbsp;<span class="ident" id="4693350">err</span>&nbsp;<span class="op" id="4693354">:=</span>&nbsp;<span class="ident" id="4693357">zlib</span><span class="op" id="4693361">.</span><span class="ident" id="4693362">NewWriterLevel</span><span class="op" id="4693376">(</span><span class="ident" id="4693377">w</span><span class="op" id="4693378">,</span>&nbsp;<span class="ident" id="4693380">level</span><span class="op" id="4693385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4693388">if</span>&nbsp;<span class="ident" id="4693391">err</span>&nbsp;<span class="op" id="4693395">!=</span>&nbsp;<span class="ident" id="4693398">nil</span>&nbsp;<span class="op" id="4693402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4693406">return</span>&nbsp;<span class="ident" id="4693413">err</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4693418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4693421">defer</span>&nbsp;<span class="ident" id="4693427">zw</span><span class="op" id="4693429">.</span><span class="ident" id="4693430">Close</span><span class="op" id="4693435">(</span><span class="op" id="4693436">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693440">bpp</span>&nbsp;<span class="op" id="4693444">:=</span>&nbsp;<span class="num" id="4693447">0</span>&nbsp;<span class="comment" id="4693449">//&nbsp;Bytes&nbsp;per&nbsp;pixel.</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4693471">switch</span>&nbsp;<span class="ident" id="4693478">cb</span>&nbsp;<span class="op" id="4693481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4693484">case</span>&nbsp;<span class="ident" id="4693489">cbG8</span><span class="op" id="4693493">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693497">bpp</span>&nbsp;<span class="op" id="4693501">=</span>&nbsp;<span class="num" id="4693503">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4693506">case</span>&nbsp;<span class="ident" id="4693511">cbTC8</span><span class="op" id="4693516">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693520">bpp</span>&nbsp;<span class="op" id="4693524">=</span>&nbsp;<span class="num" id="4693526">3</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4693529">case</span>&nbsp;<span class="ident" id="4693534">cbP8</span><span class="op" id="4693538">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693542">bpp</span>&nbsp;<span class="op" id="4693546">=</span>&nbsp;<span class="num" id="4693548">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4693551">case</span>&nbsp;<span class="ident" id="4693556">cbTCA8</span><span class="op" id="4693562">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693566">bpp</span>&nbsp;<span class="op" id="4693570">=</span>&nbsp;<span class="num" id="4693572">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4693575">case</span>&nbsp;<span class="ident" id="4693580">cbTC16</span><span class="op" id="4693586">:</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693590">bpp</span>&nbsp;<span class="op" id="4693594">=</span>&nbsp;<span class="num" id="4693596">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4693599">case</span>&nbsp;<span class="ident" id="4693604">cbTCA16</span><span class="op" id="4693611">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693615">bpp</span>&nbsp;<span class="op" id="4693619">=</span>&nbsp;<span class="num" id="4693621">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4693624">case</span>&nbsp;<span class="ident" id="4693629">cbG16</span><span class="op" id="4693634">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693638">bpp</span>&nbsp;<span class="op" id="4693642">=</span>&nbsp;<span class="num" id="4693644">2</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4693647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4693650">//&nbsp;cr[*]&nbsp;and&nbsp;pr&nbsp;are&nbsp;the&nbsp;bytes&nbsp;for&nbsp;the&nbsp;current&nbsp;and&nbsp;previous&nbsp;row.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4693715">//&nbsp;cr[0]&nbsp;is&nbsp;unfiltered&nbsp;(or&nbsp;equivalently,&nbsp;filtered&nbsp;with&nbsp;the&nbsp;ftNone&nbsp;filter).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4693791">//&nbsp;cr[ft],&nbsp;for&nbsp;non-zero&nbsp;filter&nbsp;types&nbsp;ft,&nbsp;are&nbsp;buffers&nbsp;for&nbsp;transforming&nbsp;cr[0]&nbsp;under&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4693878">//&nbsp;other&nbsp;PNG&nbsp;filter&nbsp;types.&nbsp;These&nbsp;buffers&nbsp;are&nbsp;allocated&nbsp;once&nbsp;and&nbsp;re-used&nbsp;for&nbsp;each&nbsp;row.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4693965">//&nbsp;The&nbsp;+1&nbsp;is&nbsp;for&nbsp;the&nbsp;per-row&nbsp;filter&nbsp;type,&nbsp;which&nbsp;is&nbsp;at&nbsp;cr[*][0].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694030">b</span>&nbsp;<span class="op" id="4694032">:=</span>&nbsp;<span class="ident" id="4694035">m</span><span class="op" id="4694036">.</span><span class="ident" id="4694037">Bounds</span><span class="op" id="4694043">(</span><span class="op" id="4694044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694047">var</span>&nbsp;<span class="ident" id="4694051">cr</span>&nbsp;<span class="op" id="4694054">[</span><span class="ident" id="4694055">nFilter</span><span class="op" id="4694062">]</span><span class="op" id="4694063">[</span><span class="op" id="4694064">]</span><span class="builtintype" id="4694065">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694072">for</span>&nbsp;<span class="ident" id="4694076">i</span>&nbsp;<span class="op" id="4694078">:=</span>&nbsp;<span class="keyword" id="4694081">range</span>&nbsp;<span class="ident" id="4694087">cr</span>&nbsp;<span class="op" id="4694090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694094">cr</span><span class="op" id="4694096">[</span><span class="ident" id="4694097">i</span><span class="op" id="4694098">]</span>&nbsp;<span class="op" id="4694100">=</span>&nbsp;<span class="builtinfunc" id="4694102">make</span><span class="op" id="4694106">(</span><span class="op" id="4694107">[</span><span class="op" id="4694108">]</span><span class="builtintype" id="4694109">uint8</span><span class="op" id="4694114">,</span>&nbsp;<span class="num" id="4694116">1</span><span class="op" id="4694117">+</span><span class="ident" id="4694118">bpp</span><span class="op" id="4694121">*</span><span class="ident" id="4694122">b</span><span class="op" id="4694123">.</span><span class="ident" id="4694124">Dx</span><span class="op" id="4694126">(</span><span class="op" id="4694127">)</span><span class="op" id="4694128">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694132">cr</span><span class="op" id="4694134">[</span><span class="ident" id="4694135">i</span><span class="op" id="4694136">]</span><span class="op" id="4694137">[</span><span class="num" id="4694138">0</span><span class="op" id="4694139">]</span>&nbsp;<span class="op" id="4694141">=</span>&nbsp;<span class="builtintype" id="4694143">uint8</span><span class="op" id="4694148">(</span><span class="ident" id="4694149">i</span><span class="op" id="4694150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4694153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694156">pr</span>&nbsp;<span class="op" id="4694159">:=</span>&nbsp;<span class="builtinfunc" id="4694162">make</span><span class="op" id="4694166">(</span><span class="op" id="4694167">[</span><span class="op" id="4694168">]</span><span class="builtintype" id="4694169">uint8</span><span class="op" id="4694174">,</span>&nbsp;<span class="num" id="4694176">1</span><span class="op" id="4694177">+</span><span class="ident" id="4694178">bpp</span><span class="op" id="4694181">*</span><span class="ident" id="4694182">b</span><span class="op" id="4694183">.</span><span class="ident" id="4694184">Dx</span><span class="op" id="4694186">(</span><span class="op" id="4694187">)</span><span class="op" id="4694188">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694192">gray</span><span class="op" id="4694196">,</span>&nbsp;<span class="ident" id="4694198">_</span>&nbsp;<span class="op" id="4694200">:=</span>&nbsp;<span class="ident" id="4694203">m</span><span class="op" id="4694204">.</span><span class="op" id="4694205">(</span><span class="op" id="4694206">*</span><span class="ident" id="4694207">image</span><span class="op" id="4694212">.</span><span class="ident" id="4694213">Gray</span><span class="op" id="4694217">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694220">rgba</span><span class="op" id="4694224">,</span>&nbsp;<span class="ident" id="4694226">_</span>&nbsp;<span class="op" id="4694228">:=</span>&nbsp;<span class="ident" id="4694231">m</span><span class="op" id="4694232">.</span><span class="op" id="4694233">(</span><span class="op" id="4694234">*</span><span class="ident" id="4694235">image</span><span class="op" id="4694240">.</span><span class="ident" id="4694241">RGBA</span><span class="op" id="4694245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694248">paletted</span><span class="op" id="4694256">,</span>&nbsp;<span class="ident" id="4694258">_</span>&nbsp;<span class="op" id="4694260">:=</span>&nbsp;<span class="ident" id="4694263">m</span><span class="op" id="4694264">.</span><span class="op" id="4694265">(</span><span class="op" id="4694266">*</span><span class="ident" id="4694267">image</span><span class="op" id="4694272">.</span><span class="ident" id="4694273">Paletted</span><span class="op" id="4694281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694284">nrgba</span><span class="op" id="4694289">,</span>&nbsp;<span class="ident" id="4694291">_</span>&nbsp;<span class="op" id="4694293">:=</span>&nbsp;<span class="ident" id="4694296">m</span><span class="op" id="4694297">.</span><span class="op" id="4694298">(</span><span class="op" id="4694299">*</span><span class="ident" id="4694300">image</span><span class="op" id="4694305">.</span><span class="ident" id="4694306">NRGBA</span><span class="op" id="4694311">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694315">for</span>&nbsp;<span class="ident" id="4694319">y</span>&nbsp;<span class="op" id="4694321">:=</span>&nbsp;<span class="ident" id="4694324">b</span><span class="op" id="4694325">.</span><span class="ident" id="4694326">Min</span><span class="op" id="4694329">.</span><span class="ident" id="4694330">Y</span><span class="op" id="4694331">;</span>&nbsp;<span class="ident" id="4694333">y</span>&nbsp;<span class="op" id="4694335">&lt;</span>&nbsp;<span class="ident" id="4694337">b</span><span class="op" id="4694338">.</span><span class="ident" id="4694339">Max</span><span class="op" id="4694342">.</span><span class="ident" id="4694343">Y</span><span class="op" id="4694344">;</span>&nbsp;<span class="ident" id="4694346">y</span><span class="op" id="4694347">++</span>&nbsp;<span class="op" id="4694350">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4694354">//&nbsp;Convert&nbsp;from&nbsp;colors&nbsp;to&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694389">i</span>&nbsp;<span class="op" id="4694391">:=</span>&nbsp;<span class="num" id="4694394">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694398">switch</span>&nbsp;<span class="ident" id="4694405">cb</span>&nbsp;<span class="op" id="4694408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694412">case</span>&nbsp;<span class="ident" id="4694417">cbG8</span><span class="op" id="4694421">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694426">if</span>&nbsp;<span class="ident" id="4694429">gray</span>&nbsp;<span class="op" id="4694434">!=</span>&nbsp;<span class="ident" id="4694437">nil</span>&nbsp;<span class="op" id="4694441">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694447">offset</span>&nbsp;<span class="op" id="4694454">:=</span>&nbsp;<span class="op" id="4694457">(</span><span class="ident" id="4694458">y</span>&nbsp;<span class="op" id="4694460">-</span>&nbsp;<span class="ident" id="4694462">b</span><span class="op" id="4694463">.</span><span class="ident" id="4694464">Min</span><span class="op" id="4694467">.</span><span class="ident" id="4694468">Y</span><span class="op" id="4694469">)</span>&nbsp;<span class="op" id="4694471">*</span>&nbsp;<span class="ident" id="4694473">gray</span><span class="op" id="4694477">.</span><span class="ident" id="4694478">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4694489">copy</span><span class="op" id="4694493">(</span><span class="ident" id="4694494">cr</span><span class="op" id="4694496">[</span><span class="num" id="4694497">0</span><span class="op" id="4694498">]</span><span class="op" id="4694499">[</span><span class="num" id="4694500">1</span><span class="op" id="4694501">:</span><span class="op" id="4694502">]</span><span class="op" id="4694503">,</span>&nbsp;<span class="ident" id="4694505">gray</span><span class="op" id="4694509">.</span><span class="ident" id="4694510">Pix</span><span class="op" id="4694513">[</span><span class="ident" id="4694514">offset</span><span class="op" id="4694520">:</span><span class="ident" id="4694521">offset</span><span class="op" id="4694527">+</span><span class="ident" id="4694528">b</span><span class="op" id="4694529">.</span><span class="ident" id="4694530">Dx</span><span class="op" id="4694532">(</span><span class="op" id="4694533">)</span><span class="op" id="4694534">]</span><span class="op" id="4694535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4694540">}</span>&nbsp;<span class="keyword" id="4694542">else</span>&nbsp;<span class="op" id="4694547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694553">for</span>&nbsp;<span class="ident" id="4694557">x</span>&nbsp;<span class="op" id="4694559">:=</span>&nbsp;<span class="ident" id="4694562">b</span><span class="op" id="4694563">.</span><span class="ident" id="4694564">Min</span><span class="op" id="4694567">.</span><span class="ident" id="4694568">X</span><span class="op" id="4694569">;</span>&nbsp;<span class="ident" id="4694571">x</span>&nbsp;<span class="op" id="4694573">&lt;</span>&nbsp;<span class="ident" id="4694575">b</span><span class="op" id="4694576">.</span><span class="ident" id="4694577">Max</span><span class="op" id="4694580">.</span><span class="ident" id="4694581">X</span><span class="op" id="4694582">;</span>&nbsp;<span class="ident" id="4694584">x</span><span class="op" id="4694585">++</span>&nbsp;<span class="op" id="4694588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694595">c</span>&nbsp;<span class="op" id="4694597">:=</span>&nbsp;<span class="ident" id="4694600">color</span><span class="op" id="4694605">.</span><span class="ident" id="4694606">GrayModel</span><span class="op" id="4694615">.</span><span class="ident" id="4694616">Convert</span><span class="op" id="4694623">(</span><span class="ident" id="4694624">m</span><span class="op" id="4694625">.</span><span class="ident" id="4694626">At</span><span class="op" id="4694628">(</span><span class="ident" id="4694629">x</span><span class="op" id="4694630">,</span>&nbsp;<span class="ident" id="4694632">y</span><span class="op" id="4694633">)</span><span class="op" id="4694634">)</span><span class="op" id="4694635">.</span><span class="op" id="4694636">(</span><span class="ident" id="4694637">color</span><span class="op" id="4694642">.</span><span class="ident" id="4694643">Gray</span><span class="op" id="4694647">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694654">cr</span><span class="op" id="4694656">[</span><span class="num" id="4694657">0</span><span class="op" id="4694658">]</span><span class="op" id="4694659">[</span><span class="ident" id="4694660">i</span><span class="op" id="4694661">]</span>&nbsp;<span class="op" id="4694663">=</span>&nbsp;<span class="ident" id="4694665">c</span><span class="op" id="4694666">.</span><span class="ident" id="4694667">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694674">i</span><span class="op" id="4694675">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4694682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4694687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694691">case</span>&nbsp;<span class="ident" id="4694696">cbTC8</span><span class="op" id="4694701">:</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4694706">//&nbsp;We&nbsp;have&nbsp;previously&nbsp;verified&nbsp;that&nbsp;the&nbsp;alpha&nbsp;value&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694778">cr0</span>&nbsp;<span class="op" id="4694782">:=</span>&nbsp;<span class="ident" id="4694785">cr</span><span class="op" id="4694787">[</span><span class="num" id="4694788">0</span><span class="op" id="4694789">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694794">stride</span><span class="op" id="4694800">,</span>&nbsp;<span class="ident" id="4694802">pix</span>&nbsp;<span class="op" id="4694806">:=</span>&nbsp;<span class="num" id="4694809">0</span><span class="op" id="4694810">,</span>&nbsp;<span class="op" id="4694812">[</span><span class="op" id="4694813">]</span><span class="builtintype" id="4694814">byte</span><span class="op" id="4694818">(</span><span class="ident" id="4694819">nil</span><span class="op" id="4694822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694827">if</span>&nbsp;<span class="ident" id="4694830">rgba</span>&nbsp;<span class="op" id="4694835">!=</span>&nbsp;<span class="ident" id="4694838">nil</span>&nbsp;<span class="op" id="4694842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694848">stride</span><span class="op" id="4694854">,</span>&nbsp;<span class="ident" id="4694856">pix</span>&nbsp;<span class="op" id="4694860">=</span>&nbsp;<span class="ident" id="4694862">rgba</span><span class="op" id="4694866">.</span><span class="ident" id="4694867">Stride</span><span class="op" id="4694873">,</span>&nbsp;<span class="ident" id="4694875">rgba</span><span class="op" id="4694879">.</span><span class="ident" id="4694880">Pix</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4694887">}</span>&nbsp;<span class="keyword" id="4694889">else</span>&nbsp;<span class="keyword" id="4694894">if</span>&nbsp;<span class="ident" id="4694897">nrgba</span>&nbsp;<span class="op" id="4694903">!=</span>&nbsp;<span class="ident" id="4694906">nil</span>&nbsp;<span class="op" id="4694910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694916">stride</span><span class="op" id="4694922">,</span>&nbsp;<span class="ident" id="4694924">pix</span>&nbsp;<span class="op" id="4694928">=</span>&nbsp;<span class="ident" id="4694930">nrgba</span><span class="op" id="4694935">.</span><span class="ident" id="4694936">Stride</span><span class="op" id="4694942">,</span>&nbsp;<span class="ident" id="4694944">nrgba</span><span class="op" id="4694949">.</span><span class="ident" id="4694950">Pix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4694957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694962">if</span>&nbsp;<span class="ident" id="4694965">stride</span>&nbsp;<span class="op" id="4694972">!=</span>&nbsp;<span class="num" id="4694975">0</span>&nbsp;<span class="op" id="4694977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694983">j0</span>&nbsp;<span class="op" id="4694986">:=</span>&nbsp;<span class="op" id="4694989">(</span><span class="ident" id="4694990">y</span>&nbsp;<span class="op" id="4694992">-</span>&nbsp;<span class="ident" id="4694994">b</span><span class="op" id="4694995">.</span><span class="ident" id="4694996">Min</span><span class="op" id="4694999">.</span><span class="ident" id="4695000">Y</span><span class="op" id="4695001">)</span>&nbsp;<span class="op" id="4695003">*</span>&nbsp;<span class="ident" id="4695005">stride</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4695016">j1</span>&nbsp;<span class="op" id="4695019">:=</span>&nbsp;<span class="ident" id="4695022">j0</span>&nbsp;<span class="op" id="4695025">+</span>&nbsp;<span class="ident" id="4695027">b</span><span class="op" id="4695028">.</span><span class="ident" id="4695029">Dx</span><span class="op" id="4695031">(</span><span class="op" id="4695032">)</span><span class="op" id="4695033">*</span><span class="num" id="4695034">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4695040">for</span>&nbsp;<span class="ident" id="4695044">j</span>&nbsp;<span class="op" id="4695046">:=</span>&nbsp;<span class="ident" id="4695049">j0</span><span class="op" id="4695051">;</span>&nbsp;<span class="ident" id="4695053">j</span>&nbsp;<span class="op" id="4695055">&lt;</span>&nbsp;<span class="ident" id="4695057">j1</span><span class="op" id="4695059">;</span>&nbsp;<span class="ident" id="4695061">j</span>&nbsp;<span class="op" id="4695063">+=</span>&nbsp;<span class="num" id="4695066">4</span>&nbsp;<span class="op" id="4695068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4695075">cr0</span><span class="op" id="4695078">[</span><span class="ident" id="4695079">i</span><span class="op" id="4695080">+</span><span class="num" id="4695081">0</span><span class="op" id="4695082">]</span>&nbsp;<span class="op" id="4695084">=</span>&nbsp;<span class="ident" id="4695086">pix</span><span class="op" id="4695089">[</span><span class="ident" id="4695090">j</span><span class="op" id="4695091">+</span><span class="num" id="4695092">0</span><span class="op" id="4695093">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4695100">cr0</span><span class="op" id="4695103">[</span><span class="ident" id="4695104">i</span><span class="op" id="4695105">+</span><span class="num" id="4695106">1</span><span class="op" id="4695107">]</span>&nbsp;<span class="op" id="4695109">=</span>&nbsp;<span class="ident" id="4695111">pix</span><span class="op" id="4695114">[</span><span class="ident" id="4695115">j</span><span class="op" id="4695116">+</span><span class="num" id="4695117">1</span><span class="op" id="4695118">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4695125">cr0</span><span class="op" id="4695128">[</span><span class="ident" id="4695129">i</span><span class="op" id="4695130">+</span><span class="num" id="4695131">2</span><span class="op" id="4695132">]</span>&nbsp;<span class="op" id="4695134">=</span>&nbsp;<span class="ident" id="4695136">pix</span><span class="op" id="4695139">[</span><span class="ident" id="4695140">j</span><span class="op" id="4695141">+</span><span class="num" id="4695142">2</span><span class="op" id="4695143">]</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4695150">i</span>&nbsp;<span class="op" id="4695152">+=</span>&nbsp;<span class="num" id="4695155">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4695161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4695166">}</span>&nbsp;<span class="keyword" id="4695168">else</span>&nbsp;<span class="op" id="4695173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4695179">for</span>&nbsp;<span class="ident" id="4695183">x</span>&nbsp;<span class="op" id="4695185">:=</span>&nbsp;<span class="ident" id="4695188">b</span><span class="op" id="4695189">.</span><span class="ident" id="4695190">Min</span><span class="op" id="4695193">.</span><span class="ident" id="4695194">X</span><span class="op" id="4695195">;</span>&nbsp;<span class="ident" id="4695197">x</span>&nbsp;<span class="op" id="4695199">&lt;</span>&nbsp;<span class="ident" id="4695201">b</span><span class="op" id="4695202">.</span><span class="ident" id="4695203">Max</span><span class="op" id="4695206">.</span><span class="ident" id="4695207">X</span><span class="op" id="4695208">;</span>&nbsp;<span class="ident" id="4695210">x</span><span class="op" id="4695211">++</span>&nbsp;<span class="op" id="4695214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4695221">r</span><span class="op" id="4695222">,</span>&nbsp;<span class="ident" id="4695224">g</span><span class="op" id="4695225">,</span>&nbsp;<span class="ident" id="4695227">b</span><span class="op" id="4695228">,</span>&nbsp;<span class="ident" id="4695230">_</span>&nbsp;<span class="op" id="4695232">:=</span>&nbsp;<span class="ident" id="4695235">m</span><span class="op" id="4695236">.</span><span class="ident" id="4695237">At</span><span class="op" id="4695239">(</span><span class="ident" id="4695240">x</span><span class="op" id="4695241">,</span>&nbsp;<span class="ident" id="4695243">y</span><span class="op" id="4695244">)</span><span class="op" id="4695245">.</span><span class="ident" id="4695246">RGBA</span><span class="op" id="4695250">(</span><span class="op" id="4695251">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4695258">cr0</span><span class="op" id="4695261">[</span><span class="ident" id="4695262">i</span><span class="op" id="4695263">+</span><span class="num" id="4695264">0</span><span class="op" id="4695265">]</span>&nbsp;<span class="op" id="4695267">=</span>&nbsp;<span class="builtintype" id="4695269">uint8</span><span class="op" id="4695274">(</span><span class="ident" id="4695275">r</span>&nbsp;<span class="op" id="4695277">&gt;&gt;</span>&nbsp;<span class="num" id="4695280">8</span><span class="op" id="4695281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4695288">cr0</span><span class="op" id="4695291">[</span><span class="ident" id="4695292">i</span><span class="op" id="4695293">+</span><span class="num" id="4695294">1</span><span class="op" id="4695295">]</span>&nbsp;<span class="op" id="4695297">=</span>&nbsp;<span class="builtintype" id="4695299">uint8</span><span class="op" id="4695304">(</span><span class="ident" id="4695305">g</span>&nbsp;<span class="op" id="4695307">&gt;&gt;</span>&nbsp;<span class="num" id="4695310">8</span><span class="op" id="4695311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4695318">cr0</span><span class="op" id="4695321">[</span><span class="ident" id="4695322">i</span><span class="op" id="4695323">+</span><span class="num" id="4695324">2</span><span class="op" id="4695325">]</span>&nbsp;<span class="op" id="4695327">=</span>&nbsp;<span class="builtintype" id="4695329">uint8</span><span class="op" id="4695334">(</span><span class="ident" id="4695335">b</span>&nbsp;<span class="op" id="4695337">&gt;&gt;</span>&nbsp;<span class="num" id="4695340">8</span><span class="op" id="4695341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4695348">i</span>&nbsp;<span class="op" id="4695350">+=</span>&nbsp;<span class="num" id="4695353">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4695359">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4695364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4695368">case</span>&nbsp;<span class="ident" id="4695373">cbP8</span><span class="op" id="4695377">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4695382">if</span>&nbsp;<span class="ident" id="4695385">paletted</span>&nbsp;<span class="op" id="4695394">!=</span>&nbsp;<span class="ident" id="4695397">nil</span>&nbsp;<span class="op" id="4695401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4695407">offset</span>&nbsp;<span class="op" id="4695414">:=</span>&nbsp;<span class="op" id="4695417">(</span><span class="ident" id="4695418">y</span>&nbsp;<span class="op" id="4695420">-</span>&nbsp;<span class="ident" id="4695422">b</span><span class="op" id="4695423">.</span><span class="ident" id="4695424">Min</span><span class="op" id="4695427">.</span><span class="ident" id="4695428">Y</span><span class="op" id="4695429">)</span>&nbsp;<span class="op" id="4695431">*</span>&nbsp;<span class="ident" id="4695433">paletted</span><span class="op" id="4695441">.</span><span class="ident" id="4695442">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4695453">copy</span><span class="op" id="4695457">(</span><span class="ident" id="4695458">cr</span><span class="op" id="4695460">[</span><span class="num" id="4695461">0</span><span class="op" id="4695462">]</span><span class="op" id="4695463">[</span><span class="num" id="4695464">1</span><span class="op" id="4695465">:</span><span class="op" id="4695466">]</span><span class="op" id="4695467">,</span>&nbsp;<span class="ident" id="4695469">paletted</span><span class="op" id="4695477">.</span><span class="ident" id="4695478">Pix</span><span class="op" id="4695481">[</span><span class="ident" id="4695482">offset</span><span class="op" id="4695488">:</span><span class="ident" id="4695489">offset</span><span class="op" id="4695495">+</span><span class="ident" id="4695496">b</span><span class="op" id="4695497">.</span><span class="ident" id="4695498">Dx</span><span class="op" id="4695500">(</span><span class="op" id="4695501">)</span><span class="op" id="4695502">]</span><span class="op" id="4695503">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4695508">}</span>&nbsp;<span class="keyword" id="4695510">else</span>&nbsp;<span class="op" id="4695515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4695521">pi</span>&nbsp;<span class="op" id="4695524">:=</span>&nbsp;<span class="ident" id="4695527">m</span><span class="op" id="4695528">.</span><span class="op" id="4695529">(</span><span class="ident" id="4695530">image</span><span class="op" id="4695535">.</span><span class="ident" id="4695536">PalettedImage</span><span class="op" id="4695549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4695555">for</span>&nbsp;<span class="ident" id="4695559">x</span>&nbsp;<span class="op" id="4695561">:=</span>&nbsp;<span class="ident" id="4695564">b</span><span class="op" id="4695565">.</span><span class="ident" id="4695566">Min</span><span class="op" id="4695569">.</span><span class="ident" id="4695570">X</span><span class="op" id="4695571">;</span>&nbsp;<span class="ident" id="4695573">x</span>&nbsp;<span class="op" id="4695575">&lt;</span>&nbsp;<span class="ident" id="4695577">b</span><span class="op" id="4695578">.</span><span class="ident" id="4695579">Max</span><span class="op" id="4695582">.</span><span class="ident" id="4695583">X</span><span class="op" id="4695584">;</span>&nbsp;<span class="ident" id="4695586">x</span><span class="op" id="4695587">++</span>&nbsp;<span class="op" id="4695590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4695597">cr</span><span class="op" id="4695599">[</span><span class="num" id="4695600">0</span><span class="op" id="4695601">]</span><span class="op" id="4695602">[</span><span class="ident" id="4695603">i</span><span class="op" id="4695604">]</span>&nbsp;<span class="op" id="4695606">=</span>&nbsp;<span class="ident" id="4695608">pi</span><span class="op" id="4695610">.</span><span class="ident" id="4695611">ColorIndexAt</span><span class="op" id="4695623">(</span><span class="ident" id="4695624">x</span><span class="op" id="4695625">,</span>&nbsp;<span class="ident" id="4695627">y</span><span class="op" id="4695628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4695635">i</span>&nbsp;<span class="op" id="4695637">+=</span>&nbsp;<span class="num" id="4695640">1</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4695646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4695651">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4695655">case</span>&nbsp;<span class="ident" id="4695660">cbTCA8</span><span class="op" id="4695666">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4695671">if</span>&nbsp;<span class="ident" id="4695674">nrgba</span>&nbsp;<span class="op" id="4695680">!=</span>&nbsp;<span class="ident" id="4695683">nil</span>&nbsp;<span class="op" id="4695687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4695693">offset</span>&nbsp;<span class="op" id="4695700">:=</span>&nbsp;<span class="op" id="4695703">(</span><span class="ident" id="4695704">y</span>&nbsp;<span class="op" id="4695706">-</span>&nbsp;<span class="ident" id="4695708">b</span><span class="op" id="4695709">.</span><span class="ident" id="4695710">Min</span><span class="op" id="4695713">.</span><span class="ident" id="4695714">Y</span><span class="op" id="4695715">)</span>&nbsp;<span class="op" id="4695717">*</span>&nbsp;<span class="ident" id="4695719">nrgba</span><span class="op" id="4695724">.</span><span class="ident" id="4695725">Stride</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4695736">copy</span><span class="op" id="4695740">(</span><span class="ident" id="4695741">cr</span><span class="op" id="4695743">[</span><span class="num" id="4695744">0</span><span class="op" id="4695745">]</span><span class="op" id="4695746">[</span><span class="num" id="4695747">1</span><span class="op" id="4695748">:</span><span class="op" id="4695749">]</span><span class="op" id="4695750">,</span>&nbsp;<span class="ident" id="4695752">nrgba</span><span class="op" id="4695757">.</span><span class="ident" id="4695758">Pix</span><span class="op" id="4695761">[</span><span class="ident" id="4695762">offset</span><span class="op" id="4695768">:</span><span class="ident" id="4695769">offset</span><span class="op" id="4695775">+</span><span class="ident" id="4695776">b</span><span class="op" id="4695777">.</span><span class="ident" id="4695778">Dx</span><span class="op" id="4695780">(</span><span class="op" id="4695781">)</span><span class="op" id="4695782">*</span><span class="num" id="4695783">4</span><span class="op" id="4695784">]</span><span class="op" id="4695785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4695790">}</span>&nbsp;<span class="keyword" id="4695792">else</span>&nbsp;<span class="op" id="4695797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4695803">//&nbsp;Convert&nbsp;from&nbsp;image.Image&nbsp;(which&nbsp;is&nbsp;alpha-premultiplied)&nbsp;to&nbsp;PNG&#39;s&nbsp;non-alpha-premultiplied.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4695900">for</span>&nbsp;<span class="ident" id="4695904">x</span>&nbsp;<span class="op" id="4695906">:=</span>&nbsp;<span class="ident" id="4695909">b</span><span class="op" id="4695910">.</span><span class="ident" id="4695911">Min</span><span class="op" id="4695914">.</span><span class="ident" id="4695915">X</span><span class="op" id="4695916">;</span>&nbsp;<span class="ident" id="4695918">x</span>&nbsp;<span class="op" id="4695920">&lt;</span>&nbsp;<span class="ident" id="4695922">b</span><span class="op" id="4695923">.</span><span class="ident" id="4695924">Max</span><span class="op" id="4695927">.</span><span class="ident" id="4695928">X</span><span class="op" id="4695929">;</span>&nbsp;<span class="ident" id="4695931">x</span><span class="op" id="4695932">++</span>&nbsp;<span class="op" id="4695935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4695942">c</span>&nbsp;<span class="op" id="4695944">:=</span>&nbsp;<span class="ident" id="4695947">color</span><span class="op" id="4695952">.</span><span class="ident" id="4695953">NRGBAModel</span><span class="op" id="4695963">.</span><span class="ident" id="4695964">Convert</span><span class="op" id="4695971">(</span><span class="ident" id="4695972">m</span><span class="op" id="4695973">.</span><span class="ident" id="4695974">At</span><span class="op" id="4695976">(</span><span class="ident" id="4695977">x</span><span class="op" id="4695978">,</span>&nbsp;<span class="ident" id="4695980">y</span><span class="op" id="4695981">)</span><span class="op" id="4695982">)</span><span class="op" id="4695983">.</span><span class="op" id="4695984">(</span><span class="ident" id="4695985">color</span><span class="op" id="4695990">.</span><span class="ident" id="4695991">NRGBA</span><span class="op" id="4695996">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4696003">cr</span><span class="op" id="4696005">[</span><span class="num" id="4696006">0</span><span class="op" id="4696007">]</span><span class="op" id="4696008">[</span><span class="ident" id="4696009">i</span><span class="op" id="4696010">+</span><span class="num" id="4696011">0</span><span class="op" id="4696012">]</span>&nbsp;<span class="op" id="4696014">=</span>&nbsp;<span class="ident" id="4696016">c</span><span class="op" id="4696017">.</span><span class="ident" id="4696018">R</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4696025">cr</span><span class="op" id="4696027">[</span><span class="num" id="4696028">0</span><span class="op" id="4696029">]</span><span class="op" id="4696030">[</span><span class="ident" id="4696031">i</span><span class="op" id="4696032">+</span><span class="num" id="4696033">1</span><span class="op" id="4696034">]</span>&nbsp;<span class="op" id="4696036">=</span>&nbsp;<span class="ident" id="4696038">c</span><span class="op" id="4696039">.</span><span class="ident" id="4696040">G</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4696047">cr</span><span class="op" id="4696049">[</span><span class="num" id="4696050">0</span><span class="op" id="4696051">]</span><span class="op" id="4696052">[</span><span class="ident" id="4696053">i</span><span class="op" id="4696054">+</span><span class="num" id="4696055">2</span><span class="op" id="4696056">]</span>&nbsp;<span class="op" id="4696058">=</span>&nbsp;<span class="ident" id="4696060">c</span><span class="op" id="4696061">.</span><span class="ident" id="4696062">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4696069">cr</span><span class="op" id="4696071">[</span><span class="num" id="4696072">0</span><span class="op" id="4696073">]</span><span class="op" id="4696074">[</span><span class="ident" id="4696075">i</span><span class="op" id="4696076">+</span><span class="num" id="4696077">3</span><span class="op" id="4696078">]</span>&nbsp;<span class="op" id="4696080">=</span>&nbsp;<span class="ident" id="4696082">c</span><span class="op" id="4696083">.</span><span class="ident" id="4696084">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4696091">i</span>&nbsp;<span class="op" id="4696093">+=</span>&nbsp;<span class="num" id="4696096">4</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4696102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4696107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4696111">case</span>&nbsp;<span class="ident" id="4696116">cbG16</span><span class="op" id="4696121">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4696126">for</span>&nbsp;<span class="ident" id="4696130">x</span>&nbsp;<span class="op" id="4696132">:=</span>&nbsp;<span class="ident" id="4696135">b</span><span class="op" id="4696136">.</span><span class="ident" id="4696137">Min</span><span class="op" id="4696140">.</span><span class="ident" id="4696141">X</span><span class="op" id="4696142">;</span>&nbsp;<span class="ident" id="4696144">x</span>&nbsp;<span class="op" id="4696146">&lt;</span>&nbsp;<span class="ident" id="4696148">b</span><span class="op" id="4696149">.</span><span class="ident" id="4696150">Max</span><span class="op" id="4696153">.</span><span class="ident" id="4696154">X</span><span class="op" id="4696155">;</span>&nbsp;<span class="ident" id="4696157">x</span><span class="op" id="4696158">++</span>&nbsp;<span class="op" id="4696161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4696167">c</span>&nbsp;<span class="op" id="4696169">:=</span>&nbsp;<span class="ident" id="4696172">color</span><span class="op" id="4696177">.</span><span class="ident" id="4696178">Gray16Model</span><span class="op" id="4696189">.</span><span class="ident" id="4696190">Convert</span><span class="op" id="4696197">(</span><span class="ident" id="4696198">m</span><span class="op" id="4696199">.</span><span class="ident" id="4696200">At</span><span class="op" id="4696202">(</span><span class="ident" id="4696203">x</span><span class="op" id="4696204">,</span>&nbsp;<span class="ident" id="4696206">y</span><span class="op" id="4696207">)</span><span class="op" id="4696208">)</span><span class="op" id="4696209">.</span><span class="op" id="4696210">(</span><span class="ident" id="4696211">color</span><span class="op" id="4696216">.</span><span class="ident" id="4696217">Gray16</span><span class="op" id="4696223">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4696229">cr</span><span class="op" id="4696231">[</span><span class="num" id="4696232">0</span><span class="op" id="4696233">]</span><span class="op" id="4696234">[</span><span class="ident" id="4696235">i</span><span class="op" id="4696236">+</span><span class="num" id="4696237">0</span><span class="op" id="4696238">]</span>&nbsp;<span class="op" id="4696240">=</span>&nbsp;<span class="builtintype" id="4696242">uint8</span><span class="op" id="4696247">(</span><span class="ident" id="4696248">c</span><span class="op" id="4696249">.</span><span class="ident" id="4696250">Y</span>&nbsp;<span class="op" id="4696252">&gt;&gt;</span>&nbsp;<span class="num" id="4696255">8</span><span class="op" id="4696256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4696262">cr</span><span class="op" id="4696264">[</span><span class="num" id="4696265">0</span><span class="op" id="4696266">]</span><span class="op" id="4696267">[</span><span class="ident" id="4696268">i</span><span class="op" id="4696269">+</span><span class="num" id="4696270">1</span><span class="op" id="4696271">]</span>&nbsp;<span class="op" id="4696273">=</span>&nbsp;<span class="builtintype" id="4696275">uint8</span><span class="op" id="4696280">(</span><span class="ident" id="4696281">c</span><span class="op" id="4696282">.</span><span class="ident" id="4696283">Y</span><span class="op" id="4696284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4696290">i</span>&nbsp;<span class="op" id="4696292">+=</span>&nbsp;<span class="num" id="4696295">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4696300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4696304">case</span>&nbsp;<span class="ident" id="4696309">cbTC16</span><span class="op" id="4696315">:</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4696320">//&nbsp;We&nbsp;have&nbsp;previously&nbsp;verified&nbsp;that&nbsp;the&nbsp;alpha&nbsp;value&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4696392">for</span>&nbsp;<span class="ident" id="4696396">x</span>&nbsp;<span class="op" id="4696398">:=</span>&nbsp;<span class="ident" id="4696401">b</span><span class="op" id="4696402">.</span><span class="ident" id="4696403">Min</span><span class="op" id="4696406">.</span><span class="ident" id="4696407">X</span><span class="op" id="4696408">;</span>&nbsp;<span class="ident" id="4696410">x</span>&nbsp;<span class="op" id="4696412">&lt;</span>&nbsp;<span class="ident" id="4696414">b</span><span class="op" id="4696415">.</span><span class="ident" id="4696416">Max</span><span class="op" id="4696419">.</span><span class="ident" id="4696420">X</span><span class="op" id="4696421">;</span>&nbsp;<span class="ident" id="4696423">x</span><span class="op" id="4696424">++</span>&nbsp;<span class="op" id="4696427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4696433">r</span><span class="op" id="4696434">,</span>&nbsp;<span class="ident" id="4696436">g</span><span class="op" id="4696437">,</span>&nbsp;<span class="ident" id="4696439">b</span><span class="op" id="4696440">,</span>&nbsp;<span class="ident" id="4696442">_</span>&nbsp;<span class="op" id="4696444">:=</span>&nbsp;<span class="ident" id="4696447">m</span><span class="op" id="4696448">.</span><span class="ident" id="4696449">At</span><span class="op" id="4696451">(</span><span class="ident" id="4696452">x</span><span class="op" id="4696453">,</span>&nbsp;<span class="ident" id="4696455">y</span><span class="op" id="4696456">)</span><span class="op" id="4696457">.</span><span class="ident" id="4696458">RGBA</span><span class="op" id="4696462">(</span><span class="op" id="4696463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4696469">cr</span><span class="op" id="4696471">[</span><span class="num" id="4696472">0</span><span class="op" id="4696473">]</span><span class="op" id="4696474">[</span><span class="ident" id="4696475">i</span><span class="op" id="4696476">+</span><span class="num" id="4696477">0</span><span class="op" id="4696478">]</span>&nbsp;<span class="op" id="4696480">=</span>&nbsp;<span class="builtintype" id="4696482">uint8</span><span class="op" id="4696487">(</span><span class="ident" id="4696488">r</span>&nbsp;<span class="op" id="4696490">&gt;&gt;</span>&nbsp;<span class="num" id="4696493">8</span><span class="op" id="4696494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4696500">cr</span><span class="op" id="4696502">[</span><span class="num" id="4696503">0</span><span class="op" id="4696504">]</span><span class="op" id="4696505">[</span><span class="ident" id="4696506">i</span><span class="op" id="4696507">+</span><span class="num" id="4696508">1</span><span class="op" id="4696509">]</span>&nbsp;<span class="op" id="4696511">=</span>&nbsp;<span class="builtintype" id="4696513">uint8</span><span class="op" id="4696518">(</span><span class="ident" id="4696519">r</span><span class="op" id="4696520">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4696526">cr</span><span class="op" id="4696528">[</span><span class="num" id="4696529">0</span><span class="op" id="4696530">]</span><span class="op" id="4696531">[</span><span class="ident" id="4696532">i</span><span class="op" id="4696533">+</span><span class="num" id="4696534">2</span><span class="op" id="4696535">]</span>&nbsp;<span class="op" id="4696537">=</span>&nbsp;<span class="builtintype" id="4696539">uint8</span><span class="op" id="4696544">(</span><span class="ident" id="4696545">g</span>&nbsp;<span class="op" id="4696547">&gt;&gt;</span>&nbsp;<span class="num" id="4696550">8</span><span class="op" id="4696551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4696557">cr</span><span class="op" id="4696559">[</span><span class="num" id="4696560">0</span><span class="op" id="4696561">]</span><span class="op" id="4696562">[</span><span class="ident" id="4696563">i</span><span class="op" id="4696564">+</span><span class="num" id="4696565">3</span><span class="op" id="4696566">]</span>&nbsp;<span class="op" id="4696568">=</span>&nbsp;<span class="builtintype" id="4696570">uint8</span><span class="op" id="4696575">(</span><span class="ident" id="4696576">g</span><span class="op" id="4696577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4696583">cr</span><span class="op" id="4696585">[</span><span class="num" id="4696586">0</span><span class="op" id="4696587">]</span><span class="op" id="4696588">[</span><span class="ident" id="4696589">i</span><span class="op" id="4696590">+</span><span class="num" id="4696591">4</span><span class="op" id="4696592">]</span>&nbsp;<span class="op" id="4696594">=</span>&nbsp;<span class="builtintype" id="4696596">uint8</span><span class="op" id="4696601">(</span><span class="ident" id="4696602">b</span>&nbsp;<span class="op" id="4696604">&gt;&gt;</span>&nbsp;<span class="num" id="4696607">8</span><span class="op" id="4696608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4696614">cr</span><span class="op" id="4696616">[</span><span class="num" id="4696617">0</span><span class="op" id="4696618">]</span><span class="op" id="4696619">[</span><span class="ident" id="4696620">i</span><span class="op" id="4696621">+</span><span class="num" id="4696622">5</span><span class="op" id="4696623">]</span>&nbsp;<span class="op" id="4696625">=</span>&nbsp;<span class="builtintype" id="4696627">uint8</span><span class="op" id="4696632">(</span><span class="ident" id="4696633">b</span><span class="op" id="4696634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4696640">i</span>&nbsp;<span class="op" id="4696642">+=</span>&nbsp;<span class="num" id="4696645">6</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4696650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4696654">case</span>&nbsp;<span class="ident" id="4696659">cbTCA16</span><span class="op" id="4696666">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4696671">//&nbsp;Convert&nbsp;from&nbsp;image.Image&nbsp;(which&nbsp;is&nbsp;alpha-premultiplied)&nbsp;to&nbsp;PNG&#39;s&nbsp;non-alpha-premultiplied.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4696767">for</span>&nbsp;<span class="ident" id="4696771">x</span>&nbsp;<span class="op" id="4696773">:=</span>&nbsp;<span class="ident" id="4696776">b</span><span class="op" id="4696777">.</span><span class="ident" id="4696778">Min</span><span class="op" id="4696781">.</span><span class="ident" id="4696782">X</span><span class="op" id="4696783">;</span>&nbsp;<span class="ident" id="4696785">x</span>&nbsp;<span class="op" id="4696787">&lt;</span>&nbsp;<span class="ident" id="4696789">b</span><span class="op" id="4696790">.</span><span class="ident" id="4696791">Max</span><span class="op" id="4696794">.</span><span class="ident" id="4696795">X</span><span class="op" id="4696796">;</span>&nbsp;<span class="ident" id="4696798">x</span><span class="op" id="4696799">++</span>&nbsp;<span class="op" id="4696802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4696808">c</span>&nbsp;<span class="op" id="4696810">:=</span>&nbsp;<span class="ident" id="4696813">color</span><span class="op" id="4696818">.</span><span class="ident" id="4696819">NRGBA64Model</span><span class="op" id="4696831">.</span><span class="ident" id="4696832">Convert</span><span class="op" id="4696839">(</span><span class="ident" id="4696840">m</span><span class="op" id="4696841">.</span><span class="ident" id="4696842">At</span><span class="op" id="4696844">(</span><span class="ident" id="4696845">x</span><span class="op" id="4696846">,</span>&nbsp;<span class="ident" id="4696848">y</span><span class="op" id="4696849">)</span><span class="op" id="4696850">)</span><span class="op" id="4696851">.</span><span class="op" id="4696852">(</span><span class="ident" id="4696853">color</span><span class="op" id="4696858">.</span><span class="ident" id="4696859">NRGBA64</span><span class="op" id="4696866">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4696872">cr</span><span class="op" id="4696874">[</span><span class="num" id="4696875">0</span><span class="op" id="4696876">]</span><span class="op" id="4696877">[</span><span class="ident" id="4696878">i</span><span class="op" id="4696879">+</span><span class="num" id="4696880">0</span><span class="op" id="4696881">]</span>&nbsp;<span class="op" id="4696883">=</span>&nbsp;<span class="builtintype" id="4696885">uint8</span><span class="op" id="4696890">(</span><span class="ident" id="4696891">c</span><span class="op" id="4696892">.</span><span class="ident" id="4696893">R</span>&nbsp;<span class="op" id="4696895">&gt;&gt;</span>&nbsp;<span class="num" id="4696898">8</span><span class="op" id="4696899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4696905">cr</span><span class="op" id="4696907">[</span><span class="num" id="4696908">0</span><span class="op" id="4696909">]</span><span class="op" id="4696910">[</span><span class="ident" id="4696911">i</span><span class="op" id="4696912">+</span><span class="num" id="4696913">1</span><span class="op" id="4696914">]</span>&nbsp;<span class="op" id="4696916">=</span>&nbsp;<span class="builtintype" id="4696918">uint8</span><span class="op" id="4696923">(</span><span class="ident" id="4696924">c</span><span class="op" id="4696925">.</span><span class="ident" id="4696926">R</span><span class="op" id="4696927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4696933">cr</span><span class="op" id="4696935">[</span><span class="num" id="4696936">0</span><span class="op" id="4696937">]</span><span class="op" id="4696938">[</span><span class="ident" id="4696939">i</span><span class="op" id="4696940">+</span><span class="num" id="4696941">2</span><span class="op" id="4696942">]</span>&nbsp;<span class="op" id="4696944">=</span>&nbsp;<span class="builtintype" id="4696946">uint8</span><span class="op" id="4696951">(</span><span class="ident" id="4696952">c</span><span class="op" id="4696953">.</span><span class="ident" id="4696954">G</span>&nbsp;<span class="op" id="4696956">&gt;&gt;</span>&nbsp;<span class="num" id="4696959">8</span><span class="op" id="4696960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4696966">cr</span><span class="op" id="4696968">[</span><span class="num" id="4696969">0</span><span class="op" id="4696970">]</span><span class="op" id="4696971">[</span><span class="ident" id="4696972">i</span><span class="op" id="4696973">+</span><span class="num" id="4696974">3</span><span class="op" id="4696975">]</span>&nbsp;<span class="op" id="4696977">=</span>&nbsp;<span class="builtintype" id="4696979">uint8</span><span class="op" id="4696984">(</span><span class="ident" id="4696985">c</span><span class="op" id="4696986">.</span><span class="ident" id="4696987">G</span><span class="op" id="4696988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4696994">cr</span><span class="op" id="4696996">[</span><span class="num" id="4696997">0</span><span class="op" id="4696998">]</span><span class="op" id="4696999">[</span><span class="ident" id="4697000">i</span><span class="op" id="4697001">+</span><span class="num" id="4697002">4</span><span class="op" id="4697003">]</span>&nbsp;<span class="op" id="4697005">=</span>&nbsp;<span class="builtintype" id="4697007">uint8</span><span class="op" id="4697012">(</span><span class="ident" id="4697013">c</span><span class="op" id="4697014">.</span><span class="ident" id="4697015">B</span>&nbsp;<span class="op" id="4697017">&gt;&gt;</span>&nbsp;<span class="num" id="4697020">8</span><span class="op" id="4697021">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4697027">cr</span><span class="op" id="4697029">[</span><span class="num" id="4697030">0</span><span class="op" id="4697031">]</span><span class="op" id="4697032">[</span><span class="ident" id="4697033">i</span><span class="op" id="4697034">+</span><span class="num" id="4697035">5</span><span class="op" id="4697036">]</span>&nbsp;<span class="op" id="4697038">=</span>&nbsp;<span class="builtintype" id="4697040">uint8</span><span class="op" id="4697045">(</span><span class="ident" id="4697046">c</span><span class="op" id="4697047">.</span><span class="ident" id="4697048">B</span><span class="op" id="4697049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4697055">cr</span><span class="op" id="4697057">[</span><span class="num" id="4697058">0</span><span class="op" id="4697059">]</span><span class="op" id="4697060">[</span><span class="ident" id="4697061">i</span><span class="op" id="4697062">+</span><span class="num" id="4697063">6</span><span class="op" id="4697064">]</span>&nbsp;<span class="op" id="4697066">=</span>&nbsp;<span class="builtintype" id="4697068">uint8</span><span class="op" id="4697073">(</span><span class="ident" id="4697074">c</span><span class="op" id="4697075">.</span><span class="ident" id="4697076">A</span>&nbsp;<span class="op" id="4697078">&gt;&gt;</span>&nbsp;<span class="num" id="4697081">8</span><span class="op" id="4697082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4697088">cr</span><span class="op" id="4697090">[</span><span class="num" id="4697091">0</span><span class="op" id="4697092">]</span><span class="op" id="4697093">[</span><span class="ident" id="4697094">i</span><span class="op" id="4697095">+</span><span class="num" id="4697096">7</span><span class="op" id="4697097">]</span>&nbsp;<span class="op" id="4697099">=</span>&nbsp;<span class="builtintype" id="4697101">uint8</span><span class="op" id="4697106">(</span><span class="ident" id="4697107">c</span><span class="op" id="4697108">.</span><span class="ident" id="4697109">A</span><span class="op" id="4697110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4697116">i</span>&nbsp;<span class="op" id="4697118">+=</span>&nbsp;<span class="num" id="4697121">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4697126">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4697130">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4697135">//&nbsp;Apply&nbsp;the&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4697158">f</span>&nbsp;<span class="op" id="4697160">:=</span>&nbsp;<span class="ident" id="4697163">ftNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4697172">if</span>&nbsp;<span class="ident" id="4697175">level</span>&nbsp;<span class="op" id="4697181">!=</span>&nbsp;<span class="ident" id="4697184">zlib</span><span class="op" id="4697188">.</span><span class="ident" id="4697189">NoCompression</span>&nbsp;<span class="op" id="4697203">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4697208">f</span>&nbsp;<span class="op" id="4697210">=</span>&nbsp;<span class="ident" id="4697212">filter</span><span class="op" id="4697218">(</span><span class="op" id="4697219">&amp;</span><span class="ident" id="4697220">cr</span><span class="op" id="4697222">,</span>&nbsp;<span class="ident" id="4697224">pr</span><span class="op" id="4697226">,</span>&nbsp;<span class="ident" id="4697228">bpp</span><span class="op" id="4697231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4697235">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4697240">//&nbsp;Write&nbsp;the&nbsp;compressed&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4697273">if</span>&nbsp;<span class="ident" id="4697276">_</span><span class="op" id="4697277">,</span>&nbsp;<span class="ident" id="4697279">err</span>&nbsp;<span class="op" id="4697283">:=</span>&nbsp;<span class="ident" id="4697286">zw</span><span class="op" id="4697288">.</span><span class="ident" id="4697289">Write</span><span class="op" id="4697294">(</span><span class="ident" id="4697295">cr</span><span class="op" id="4697297">[</span><span class="ident" id="4697298">f</span><span class="op" id="4697299">]</span><span class="op" id="4697300">)</span><span class="op" id="4697301">;</span>&nbsp;<span class="ident" id="4697303">err</span>&nbsp;<span class="op" id="4697307">!=</span>&nbsp;<span class="ident" id="4697310">nil</span>&nbsp;<span class="op" id="4697314">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4697319">return</span>&nbsp;<span class="ident" id="4697326">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4697332">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4697337">//&nbsp;The&nbsp;current&nbsp;row&nbsp;for&nbsp;y&nbsp;is&nbsp;the&nbsp;previous&nbsp;row&nbsp;for&nbsp;y+1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4697393">pr</span><span class="op" id="4697395">,</span>&nbsp;<span class="ident" id="4697397">cr</span><span class="op" id="4697399">[</span><span class="num" id="4697400">0</span><span class="op" id="4697401">]</span>&nbsp;<span class="op" id="4697403">=</span>&nbsp;<span class="ident" id="4697405">cr</span><span class="op" id="4697407">[</span><span class="num" id="4697408">0</span><span class="op" id="4697409">]</span><span class="op" id="4697410">,</span>&nbsp;<span class="ident" id="4697412">pr</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4697416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4697419">return</span>&nbsp;<span class="ident" id="4697426">nil</span><br>
<span class="lineno"></span><span class="op" id="4697430">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4697433">//&nbsp;Write&nbsp;the&nbsp;actual&nbsp;image&nbsp;data&nbsp;to&nbsp;one&nbsp;or&nbsp;more&nbsp;IDAT&nbsp;chunks.</span><br>
<span class="lineno">440</span><span class="keyword" id="4697492">func</span>&nbsp;<span class="op" id="4697497">(</span><span class="ident" id="4697498">e</span>&nbsp;<span class="op" id="4697500">*</span><span class="ident" id="4697501">encoder</span><span class="op" id="4697508">)</span>&nbsp;<span class="ident" id="4697510">writeIDATs</span><span class="op" id="4697520">(</span><span class="op" id="4697521">)</span>&nbsp;<span class="op" id="4697523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4697526">if</span>&nbsp;<span class="ident" id="4697529">e</span><span class="op" id="4697530">.</span><span class="ident" id="4697531">err</span>&nbsp;<span class="op" id="4697535">!=</span>&nbsp;<span class="ident" id="4697538">nil</span>&nbsp;<span class="op" id="4697542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4697546">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4697554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4697557">var</span>&nbsp;<span class="ident" id="4697561">bw</span>&nbsp;<span class="op" id="4697564">*</span><span class="ident" id="4697565">bufio</span><span class="op" id="4697570">.</span><span class="ident" id="4697571">Writer</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4697579">bw</span>&nbsp;<span class="op" id="4697582">=</span>&nbsp;<span class="ident" id="4697584">bufio</span><span class="op" id="4697589">.</span><span class="ident" id="4697590">NewWriterSize</span><span class="op" id="4697603">(</span><span class="ident" id="4697604">e</span><span class="op" id="4697605">,</span>&nbsp;<span class="num" id="4697607">1</span><span class="op" id="4697608">&lt;&lt;</span><span class="num" id="4697610">15</span><span class="op" id="4697612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4697615">e</span><span class="op" id="4697616">.</span><span class="ident" id="4697617">err</span>&nbsp;<span class="op" id="4697621">=</span>&nbsp;<span class="ident" id="4697623">writeImage</span><span class="op" id="4697633">(</span><span class="ident" id="4697634">bw</span><span class="op" id="4697636">,</span>&nbsp;<span class="ident" id="4697638">e</span><span class="op" id="4697639">.</span><span class="ident" id="4697640">m</span><span class="op" id="4697641">,</span>&nbsp;<span class="ident" id="4697643">e</span><span class="op" id="4697644">.</span><span class="ident" id="4697645">cb</span><span class="op" id="4697647">,</span>&nbsp;<span class="ident" id="4697649">levelToZlib</span><span class="op" id="4697660">(</span><span class="ident" id="4697661">e</span><span class="op" id="4697662">.</span><span class="ident" id="4697663">enc</span><span class="op" id="4697666">.</span><span class="ident" id="4697667">CompressionLevel</span><span class="op" id="4697683">)</span><span class="op" id="4697684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4697687">if</span>&nbsp;<span class="ident" id="4697690">e</span><span class="op" id="4697691">.</span><span class="ident" id="4697692">err</span>&nbsp;<span class="op" id="4697696">!=</span>&nbsp;<span class="ident" id="4697699">nil</span>&nbsp;<span class="op" id="4697703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4697707">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4697715">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4697718">e</span><span class="op" id="4697719">.</span><span class="ident" id="4697720">err</span>&nbsp;<span class="op" id="4697724">=</span>&nbsp;<span class="ident" id="4697726">bw</span><span class="op" id="4697728">.</span><span class="ident" id="4697729">Flush</span><span class="op" id="4697734">(</span><span class="op" id="4697735">)</span><br>
<span class="lineno"></span><span class="op" id="4697737">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4697740">//&nbsp;This&nbsp;function&nbsp;is&nbsp;required&nbsp;because&nbsp;we&nbsp;want&nbsp;the&nbsp;zero&nbsp;value&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4697803">//&nbsp;Encoder.CompressionLevel&nbsp;to&nbsp;map&nbsp;to&nbsp;zlib.DefaultCompression.</span><br>
<span class="lineno">455</span><span class="keyword" id="4697866">func</span>&nbsp;<span class="ident" id="4697871">levelToZlib</span><span class="op" id="4697882">(</span><span class="ident" id="4697883">l</span>&nbsp;<span class="ident" id="4697885">CompressionLevel</span><span class="op" id="4697901">)</span>&nbsp;<span class="builtintype" id="4697903">int</span>&nbsp;<span class="op" id="4697907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4697910">switch</span>&nbsp;<span class="ident" id="4697917">l</span>&nbsp;<span class="op" id="4697919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4697922">case</span>&nbsp;<span class="ident" id="4697927">DefaultCompression</span><span class="op" id="4697945">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4697949">return</span>&nbsp;<span class="ident" id="4697956">zlib</span><span class="op" id="4697960">.</span><span class="ident" id="4697961">DefaultCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4697981">case</span>&nbsp;<span class="ident" id="4697986">NoCompression</span><span class="op" id="4697999">:</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4698003">return</span>&nbsp;<span class="ident" id="4698010">zlib</span><span class="op" id="4698014">.</span><span class="ident" id="4698015">NoCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4698030">case</span>&nbsp;<span class="ident" id="4698035">BestSpeed</span><span class="op" id="4698044">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4698048">return</span>&nbsp;<span class="ident" id="4698055">zlib</span><span class="op" id="4698059">.</span><span class="ident" id="4698060">BestSpeed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4698071">case</span>&nbsp;<span class="ident" id="4698076">BestCompression</span><span class="op" id="4698091">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4698095">return</span>&nbsp;<span class="ident" id="4698102">zlib</span><span class="op" id="4698106">.</span><span class="ident" id="4698107">BestCompression</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4698124">default</span><span class="op" id="4698131">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4698135">return</span>&nbsp;<span class="ident" id="4698142">zlib</span><span class="op" id="4698146">.</span><span class="ident" id="4698147">DefaultCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4698167">}</span><br>
<span class="lineno"></span><span class="op" id="4698169">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">470</span><span class="keyword" id="4698172">func</span>&nbsp;<span class="op" id="4698177">(</span><span class="ident" id="4698178">e</span>&nbsp;<span class="op" id="4698180">*</span><span class="ident" id="4698181">encoder</span><span class="op" id="4698188">)</span>&nbsp;<span class="ident" id="4698190">writeIEND</span><span class="op" id="4698199">(</span><span class="op" id="4698200">)</span>&nbsp;<span class="op" id="4698202">{</span>&nbsp;<span class="ident" id="4698204">e</span><span class="op" id="4698205">.</span><span class="ident" id="4698206">writeChunk</span><span class="op" id="4698216">(</span><span class="ident" id="4698217">nil</span><span class="op" id="4698220">,</span>&nbsp;<span class="string" id="4698222">&#34;IEND&#34;</span><span class="op" id="4698228">)</span>&nbsp;<span class="op" id="4698230">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4698233">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;PNG&nbsp;format.&nbsp;Any&nbsp;Image&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4698299">//&nbsp;encoded,&nbsp;but&nbsp;images&nbsp;that&nbsp;are&nbsp;not&nbsp;image.NRGBA&nbsp;might&nbsp;be&nbsp;encoded&nbsp;lossily.</span><br>
<span class="lineno"></span><span class="keyword" id="4698373">func</span>&nbsp;<span class="ident" id="4698378">Encode</span><span class="op" id="4698384">(</span><span class="ident" id="4698385">w</span>&nbsp;<span class="ident" id="4698387">io</span><span class="op" id="4698389">.</span><span class="ident" id="4698390">Writer</span><span class="op" id="4698396">,</span>&nbsp;<span class="ident" id="4698398">m</span>&nbsp;<span class="ident" id="4698400">image</span><span class="op" id="4698405">.</span><span class="ident" id="4698406">Image</span><span class="op" id="4698411">)</span>&nbsp;<span class="builtintype" id="4698413">error</span>&nbsp;<span class="op" id="4698419">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4698422">var</span>&nbsp;<span class="ident" id="4698426">e</span>&nbsp;<span class="ident" id="4698428">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4698437">return</span>&nbsp;<span class="ident" id="4698444">e</span><span class="op" id="4698445">.</span><span class="ident" id="4698446">Encode</span><span class="op" id="4698452">(</span><span class="ident" id="4698453">w</span><span class="op" id="4698454">,</span>&nbsp;<span class="ident" id="4698456">m</span><span class="op" id="4698457">)</span><br>
<span class="lineno"></span><span class="op" id="4698459">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4698462">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;PNG&nbsp;format.</span><br>
<span class="lineno">480</span><span class="keyword" id="4698511">func</span>&nbsp;<span class="op" id="4698516">(</span><span class="ident" id="4698517">enc</span>&nbsp;<span class="op" id="4698521">*</span><span class="ident" id="4698522">Encoder</span><span class="op" id="4698529">)</span>&nbsp;<span class="ident" id="4698531">Encode</span><span class="op" id="4698537">(</span><span class="ident" id="4698538">w</span>&nbsp;<span class="ident" id="4698540">io</span><span class="op" id="4698542">.</span><span class="ident" id="4698543">Writer</span><span class="op" id="4698549">,</span>&nbsp;<span class="ident" id="4698551">m</span>&nbsp;<span class="ident" id="4698553">image</span><span class="op" id="4698558">.</span><span class="ident" id="4698559">Image</span><span class="op" id="4698564">)</span>&nbsp;<span class="builtintype" id="4698566">error</span>&nbsp;<span class="op" id="4698572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4698575">//&nbsp;Obviously,&nbsp;negative&nbsp;widths&nbsp;and&nbsp;heights&nbsp;are&nbsp;invalid.&nbsp;Furthermore,&nbsp;the&nbsp;PNG</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4698652">//&nbsp;spec&nbsp;section&nbsp;11.2.2&nbsp;says&nbsp;that&nbsp;zero&nbsp;is&nbsp;invalid.&nbsp;Excessively&nbsp;large&nbsp;images&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4698732">//&nbsp;also&nbsp;rejected.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4698751">mw</span><span class="op" id="4698753">,</span>&nbsp;<span class="ident" id="4698755">mh</span>&nbsp;<span class="op" id="4698758">:=</span>&nbsp;<span class="ident" id="4698761">int64</span><span class="op" id="4698766">(</span><span class="ident" id="4698767">m</span><span class="op" id="4698768">.</span><span class="ident" id="4698769">Bounds</span><span class="op" id="4698775">(</span><span class="op" id="4698776">)</span><span class="op" id="4698777">.</span><span class="ident" id="4698778">Dx</span><span class="op" id="4698780">(</span><span class="op" id="4698781">)</span><span class="op" id="4698782">)</span><span class="op" id="4698783">,</span>&nbsp;<span class="ident" id="4698785">int64</span><span class="op" id="4698790">(</span><span class="ident" id="4698791">m</span><span class="op" id="4698792">.</span><span class="ident" id="4698793">Bounds</span><span class="op" id="4698799">(</span><span class="op" id="4698800">)</span><span class="op" id="4698801">.</span><span class="ident" id="4698802">Dy</span><span class="op" id="4698804">(</span><span class="op" id="4698805">)</span><span class="op" id="4698806">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4698809">if</span>&nbsp;<span class="ident" id="4698812">mw</span>&nbsp;<span class="op" id="4698815">&lt;=</span>&nbsp;<span class="num" id="4698818">0</span>&nbsp;<span class="op" id="4698820">||</span>&nbsp;<span class="ident" id="4698823">mh</span>&nbsp;<span class="op" id="4698826">&lt;=</span>&nbsp;<span class="num" id="4698829">0</span>&nbsp;<span class="op" id="4698831">||</span>&nbsp;<span class="ident" id="4698834">mw</span>&nbsp;<span class="op" id="4698837">&gt;=</span>&nbsp;<span class="num" id="4698840">1</span><span class="op" id="4698841">&lt;&lt;</span><span class="num" id="4698843">32</span>&nbsp;<span class="op" id="4698846">||</span>&nbsp;<span class="ident" id="4698849">mh</span>&nbsp;<span class="op" id="4698852">&gt;=</span>&nbsp;<span class="num" id="4698855">1</span><span class="op" id="4698856">&lt;&lt;</span><span class="num" id="4698858">32</span>&nbsp;<span class="op" id="4698861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4698865">return</span>&nbsp;<span class="ident" id="4698872">FormatError</span><span class="op" id="4698883">(</span><span class="string" id="4698884">&#34;invalid&nbsp;image&nbsp;size:&nbsp;&#34;</span>&nbsp;<span class="op" id="4698907">+</span>&nbsp;<span class="ident" id="4698909">strconv</span><span class="op" id="4698916">.</span><span class="ident" id="4698917">FormatInt</span><span class="op" id="4698926">(</span><span class="ident" id="4698927">mw</span><span class="op" id="4698929">,</span>&nbsp;<span class="num" id="4698931">10</span><span class="op" id="4698933">)</span>&nbsp;<span class="op" id="4698935">+</span>&nbsp;<span class="string" id="4698937">&#34;x&#34;</span>&nbsp;<span class="op" id="4698941">+</span>&nbsp;<span class="ident" id="4698943">strconv</span><span class="op" id="4698950">.</span><span class="ident" id="4698951">FormatInt</span><span class="op" id="4698960">(</span><span class="ident" id="4698961">mh</span><span class="op" id="4698963">,</span>&nbsp;<span class="num" id="4698965">10</span><span class="op" id="4698967">)</span><span class="op" id="4698968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4698971">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4698975">var</span>&nbsp;<span class="ident" id="4698979">e</span>&nbsp;<span class="ident" id="4698981">encoder</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4698990">e</span><span class="op" id="4698991">.</span><span class="ident" id="4698992">enc</span>&nbsp;<span class="op" id="4698996">=</span>&nbsp;<span class="ident" id="4698998">enc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4699003">e</span><span class="op" id="4699004">.</span><span class="ident" id="4699005">w</span>&nbsp;<span class="op" id="4699007">=</span>&nbsp;<span class="ident" id="4699009">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4699012">e</span><span class="op" id="4699013">.</span><span class="ident" id="4699014">m</span>&nbsp;<span class="op" id="4699016">=</span>&nbsp;<span class="ident" id="4699018">m</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4699022">var</span>&nbsp;<span class="ident" id="4699026">pal</span>&nbsp;<span class="ident" id="4699030">color</span><span class="op" id="4699035">.</span><span class="ident" id="4699036">Palette</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4699045">//&nbsp;cbP8&nbsp;encoding&nbsp;needs&nbsp;PalettedImage&#39;s&nbsp;ColorIndexAt&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4699106">if</span>&nbsp;<span class="ident" id="4699109">_</span><span class="op" id="4699110">,</span>&nbsp;<span class="ident" id="4699112">ok</span>&nbsp;<span class="op" id="4699115">:=</span>&nbsp;<span class="ident" id="4699118">m</span><span class="op" id="4699119">.</span><span class="op" id="4699120">(</span><span class="ident" id="4699121">image</span><span class="op" id="4699126">.</span><span class="ident" id="4699127">PalettedImage</span><span class="op" id="4699140">)</span><span class="op" id="4699141">;</span>&nbsp;<span class="ident" id="4699143">ok</span>&nbsp;<span class="op" id="4699146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4699150">pal</span><span class="op" id="4699153">,</span>&nbsp;<span class="ident" id="4699155">_</span>&nbsp;<span class="op" id="4699157">=</span>&nbsp;<span class="ident" id="4699159">m</span><span class="op" id="4699160">.</span><span class="ident" id="4699161">ColorModel</span><span class="op" id="4699171">(</span><span class="op" id="4699172">)</span><span class="op" id="4699173">.</span><span class="op" id="4699174">(</span><span class="ident" id="4699175">color</span><span class="op" id="4699180">.</span><span class="ident" id="4699181">Palette</span><span class="op" id="4699188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4699191">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4699194">if</span>&nbsp;<span class="ident" id="4699197">pal</span>&nbsp;<span class="op" id="4699201">!=</span>&nbsp;<span class="ident" id="4699204">nil</span>&nbsp;<span class="op" id="4699208">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4699212">e</span><span class="op" id="4699213">.</span><span class="ident" id="4699214">cb</span>&nbsp;<span class="op" id="4699217">=</span>&nbsp;<span class="ident" id="4699219">cbP8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4699225">}</span>&nbsp;<span class="keyword" id="4699227">else</span>&nbsp;<span class="op" id="4699232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4699236">switch</span>&nbsp;<span class="ident" id="4699243">m</span><span class="op" id="4699244">.</span><span class="ident" id="4699245">ColorModel</span><span class="op" id="4699255">(</span><span class="op" id="4699256">)</span>&nbsp;<span class="op" id="4699258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4699262">case</span>&nbsp;<span class="ident" id="4699267">color</span><span class="op" id="4699272">.</span><span class="ident" id="4699273">GrayModel</span><span class="op" id="4699282">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4699287">e</span><span class="op" id="4699288">.</span><span class="ident" id="4699289">cb</span>&nbsp;<span class="op" id="4699292">=</span>&nbsp;<span class="ident" id="4699294">cbG8</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4699301">case</span>&nbsp;<span class="ident" id="4699306">color</span><span class="op" id="4699311">.</span><span class="ident" id="4699312">Gray16Model</span><span class="op" id="4699323">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4699328">e</span><span class="op" id="4699329">.</span><span class="ident" id="4699330">cb</span>&nbsp;<span class="op" id="4699333">=</span>&nbsp;<span class="ident" id="4699335">cbG16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4699343">case</span>&nbsp;<span class="ident" id="4699348">color</span><span class="op" id="4699353">.</span><span class="ident" id="4699354">RGBAModel</span><span class="op" id="4699363">,</span>&nbsp;<span class="ident" id="4699365">color</span><span class="op" id="4699370">.</span><span class="ident" id="4699371">NRGBAModel</span><span class="op" id="4699381">,</span>&nbsp;<span class="ident" id="4699383">color</span><span class="op" id="4699388">.</span><span class="ident" id="4699389">AlphaModel</span><span class="op" id="4699399">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4699404">if</span>&nbsp;<span class="ident" id="4699407">opaque</span><span class="op" id="4699413">(</span><span class="ident" id="4699414">m</span><span class="op" id="4699415">)</span>&nbsp;<span class="op" id="4699417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4699423">e</span><span class="op" id="4699424">.</span><span class="ident" id="4699425">cb</span>&nbsp;<span class="op" id="4699428">=</span>&nbsp;<span class="ident" id="4699430">cbTC8</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4699439">}</span>&nbsp;<span class="keyword" id="4699441">else</span>&nbsp;<span class="op" id="4699446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4699452">e</span><span class="op" id="4699453">.</span><span class="ident" id="4699454">cb</span>&nbsp;<span class="op" id="4699457">=</span>&nbsp;<span class="ident" id="4699459">cbTCA8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4699469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4699473">default</span><span class="op" id="4699480">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4699485">if</span>&nbsp;<span class="ident" id="4699488">opaque</span><span class="op" id="4699494">(</span><span class="ident" id="4699495">m</span><span class="op" id="4699496">)</span>&nbsp;<span class="op" id="4699498">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4699504">e</span><span class="op" id="4699505">.</span><span class="ident" id="4699506">cb</span>&nbsp;<span class="op" id="4699509">=</span>&nbsp;<span class="ident" id="4699511">cbTC16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4699521">}</span>&nbsp;<span class="keyword" id="4699523">else</span>&nbsp;<span class="op" id="4699528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4699534">e</span><span class="op" id="4699535">.</span><span class="ident" id="4699536">cb</span>&nbsp;<span class="op" id="4699539">=</span>&nbsp;<span class="ident" id="4699541">cbTCA16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4699552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4699556">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4699559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4699563">_</span><span class="op" id="4699564">,</span>&nbsp;<span class="ident" id="4699566">e</span><span class="op" id="4699567">.</span><span class="ident" id="4699568">err</span>&nbsp;<span class="op" id="4699572">=</span>&nbsp;<span class="ident" id="4699574">io</span><span class="op" id="4699576">.</span><span class="ident" id="4699577">WriteString</span><span class="op" id="4699588">(</span><span class="ident" id="4699589">w</span><span class="op" id="4699590">,</span>&nbsp;<span class="ident" id="4699592">pngHeader</span><span class="op" id="4699601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4699604">e</span><span class="op" id="4699605">.</span><span class="ident" id="4699606">writeIHDR</span><span class="op" id="4699615">(</span><span class="op" id="4699616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4699619">if</span>&nbsp;<span class="ident" id="4699622">pal</span>&nbsp;<span class="op" id="4699626">!=</span>&nbsp;<span class="ident" id="4699629">nil</span>&nbsp;<span class="op" id="4699633">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4699637">e</span><span class="op" id="4699638">.</span><span class="ident" id="4699639">writePLTEAndTRNS</span><span class="op" id="4699655">(</span><span class="ident" id="4699656">pal</span><span class="op" id="4699659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4699662">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4699665">e</span><span class="op" id="4699666">.</span><span class="ident" id="4699667">writeIDATs</span><span class="op" id="4699677">(</span><span class="op" id="4699678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4699681">e</span><span class="op" id="4699682">.</span><span class="ident" id="4699683">writeIEND</span><span class="op" id="4699692">(</span><span class="op" id="4699693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4699696">return</span>&nbsp;<span class="ident" id="4699703">e</span><span class="op" id="4699704">.</span><span class="ident" id="4699705">err</span><br>
<span class="lineno">530</span><span class="op" id="4699709">}</span>
</div>
</body>
</html>
