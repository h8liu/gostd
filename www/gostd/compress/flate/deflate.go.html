<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/flate</h2>
<ul>
<li><a href="/gostd/compress/flate/copy.go.html">copy.go</a></li>
<li><a href="/gostd/compress/flate/copy_test.go.html">copy_test.go</a></li>
<li><a href="/gostd/compress/flate/deflate.go.html">deflate.go</a></li>
<li><a href="/gostd/compress/flate/deflate_test.go.html">deflate_test.go</a></li>
<li><a href="/gostd/compress/flate/fixedhuff.go.html">fixedhuff.go</a></li>
<li><a href="/gostd/compress/flate/flate_test.go.html">flate_test.go</a></li>
<li><a href="/gostd/compress/flate/huffman_bit_writer.go.html">huffman_bit_writer.go</a></li>
<li><a href="/gostd/compress/flate/huffman_code.go.html">huffman_code.go</a></li>
<li><a href="/gostd/compress/flate/inflate.go.html">inflate.go</a></li>
<li><a href="/gostd/compress/flate/inflate_test.go.html">inflate_test.go</a></li>
<li><a href="/gostd/compress/flate/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/compress/flate/reverse_bits.go.html">reverse_bits.go</a></li>
<li><a href="/gostd/compress/flate/token.go.html">token.go</a></li>
<li><a href="/gostd/compress/flate/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4245546">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4245601">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4245655">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4245706">package</span>&nbsp;<span class="ident" id="4245714">flate</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4245721">import</span>&nbsp;<span class="op" id="4245728">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4245731">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4245738">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4245744">&#34;math&#34;</span><br>
<span class="lineno"></span><span class="op" id="4245751">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4245754">const</span>&nbsp;<span class="op" id="4245760">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4245763">NoCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4245782">=</span>&nbsp;<span class="num" id="4245784">0</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4245787">BestSpeed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4245806">=</span>&nbsp;<span class="num" id="4245808">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4245811">fastCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4245830">=</span>&nbsp;<span class="num" id="4245832">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4245835">BestCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4245854">=</span>&nbsp;<span class="num" id="4245856">9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4245859">DefaultCompression</span>&nbsp;<span class="op" id="4245878">=</span>&nbsp;<span class="op" id="4245880">-</span><span class="num" id="4245881">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4245884">logWindowSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4245903">=</span>&nbsp;<span class="num" id="4245905">15</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4245909">windowSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4245928">=</span>&nbsp;<span class="num" id="4245930">1</span>&nbsp;<span class="op" id="4245932">&lt;&lt;</span>&nbsp;<span class="ident" id="4245935">logWindowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4245950">windowMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4245969">=</span>&nbsp;<span class="ident" id="4245971">windowSize</span>&nbsp;<span class="op" id="4245982">-</span>&nbsp;<span class="num" id="4245984">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4245987">logMaxOffsetSize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4246006">=</span>&nbsp;<span class="num" id="4246008">15</span>&nbsp;&nbsp;<span class="comment" id="4246012">//&nbsp;Standard&nbsp;DEFLATE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4246033">minMatchLength</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4246052">=</span>&nbsp;<span class="num" id="4246054">3</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4246058">//&nbsp;The&nbsp;smallest&nbsp;match&nbsp;that&nbsp;the&nbsp;compressor&nbsp;looks&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4246111">maxMatchLength</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4246130">=</span>&nbsp;<span class="num" id="4246132">258</span>&nbsp;<span class="comment" id="4246136">//&nbsp;The&nbsp;longest&nbsp;match&nbsp;for&nbsp;the&nbsp;compressor</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4246177">minOffsetSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4246196">=</span>&nbsp;<span class="num" id="4246198">1</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4246202">//&nbsp;The&nbsp;shortest&nbsp;offset&nbsp;that&nbsp;makes&nbsp;any&nbsp;sense</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4246248">//&nbsp;The&nbsp;maximum&nbsp;number&nbsp;of&nbsp;tokens&nbsp;we&nbsp;put&nbsp;into&nbsp;a&nbsp;single&nbsp;flat&nbsp;block,&nbsp;just&nbsp;too</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4246323">//&nbsp;stop&nbsp;things&nbsp;from&nbsp;getting&nbsp;too&nbsp;large.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4246363">maxFlateBlockTokens</span>&nbsp;<span class="op" id="4246383">=</span>&nbsp;<span class="num" id="4246385">1</span>&nbsp;<span class="op" id="4246387">&lt;&lt;</span>&nbsp;<span class="num" id="4246390">14</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4246394">maxStoreBlockSize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4246414">=</span>&nbsp;<span class="num" id="4246416">65535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4246423">hashBits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4246443">=</span>&nbsp;<span class="num" id="4246445">17</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4246449">hashSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4246469">=</span>&nbsp;<span class="num" id="4246471">1</span>&nbsp;<span class="op" id="4246473">&lt;&lt;</span>&nbsp;<span class="ident" id="4246476">hashBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4246486">hashMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4246506">=</span>&nbsp;<span class="op" id="4246508">(</span><span class="num" id="4246509">1</span>&nbsp;<span class="op" id="4246511">&lt;&lt;</span>&nbsp;<span class="ident" id="4246514">hashBits</span><span class="op" id="4246522">)</span>&nbsp;<span class="op" id="4246524">-</span>&nbsp;<span class="num" id="4246526">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4246529">hashShift</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4246549">=</span>&nbsp;<span class="op" id="4246551">(</span><span class="ident" id="4246552">hashBits</span>&nbsp;<span class="op" id="4246561">+</span>&nbsp;<span class="ident" id="4246563">minMatchLength</span>&nbsp;<span class="op" id="4246578">-</span>&nbsp;<span class="num" id="4246580">1</span><span class="op" id="4246581">)</span>&nbsp;<span class="op" id="4246583">/</span>&nbsp;<span class="ident" id="4246585">minMatchLength</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4246601">maxHashOffset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4246621">=</span>&nbsp;<span class="num" id="4246623">1</span>&nbsp;<span class="op" id="4246625">&lt;&lt;</span>&nbsp;<span class="num" id="4246628">24</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4246633">skipNever</span>&nbsp;<span class="op" id="4246643">=</span>&nbsp;<span class="ident" id="4246645">math</span><span class="op" id="4246649">.</span><span class="ident" id="4246650">MaxInt32</span><br>
<span class="lineno"></span><span class="op" id="4246659">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="4246662">type</span>&nbsp;<span class="ident" id="4246667">compressionLevel</span>&nbsp;<span class="keyword" id="4246684">struct</span>&nbsp;<span class="op" id="4246691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4246694">good</span><span class="op" id="4246698">,</span>&nbsp;<span class="ident" id="4246700">lazy</span><span class="op" id="4246704">,</span>&nbsp;<span class="ident" id="4246706">nice</span><span class="op" id="4246710">,</span>&nbsp;<span class="ident" id="4246712">chain</span><span class="op" id="4246717">,</span>&nbsp;<span class="ident" id="4246719">fastSkipHashing</span>&nbsp;<span class="builtintype" id="4246735">int</span><br>
<span class="lineno"></span><span class="op" id="4246739">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4246742">var</span>&nbsp;<span class="ident" id="4246746">levels</span>&nbsp;<span class="op" id="4246753">=</span>&nbsp;<span class="op" id="4246755">[</span><span class="op" id="4246756">]</span><span class="ident" id="4246757">compressionLevel</span><span class="op" id="4246773">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4246776">{</span><span class="op" id="4246777">}</span><span class="op" id="4246778">,</span>&nbsp;<span class="comment" id="4246780">//&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4246786">//&nbsp;For&nbsp;levels&nbsp;1-3&nbsp;we&nbsp;don&#39;t&nbsp;bother&nbsp;trying&nbsp;with&nbsp;lazy&nbsp;matches</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4246846">{</span><span class="num" id="4246847">3</span><span class="op" id="4246848">,</span>&nbsp;<span class="num" id="4246850">0</span><span class="op" id="4246851">,</span>&nbsp;<span class="num" id="4246853">8</span><span class="op" id="4246854">,</span>&nbsp;<span class="num" id="4246856">4</span><span class="op" id="4246857">,</span>&nbsp;<span class="num" id="4246859">4</span><span class="op" id="4246860">}</span><span class="op" id="4246861">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4246864">{</span><span class="num" id="4246865">3</span><span class="op" id="4246866">,</span>&nbsp;<span class="num" id="4246868">0</span><span class="op" id="4246869">,</span>&nbsp;<span class="num" id="4246871">16</span><span class="op" id="4246873">,</span>&nbsp;<span class="num" id="4246875">8</span><span class="op" id="4246876">,</span>&nbsp;<span class="num" id="4246878">5</span><span class="op" id="4246879">}</span><span class="op" id="4246880">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4246883">{</span><span class="num" id="4246884">3</span><span class="op" id="4246885">,</span>&nbsp;<span class="num" id="4246887">0</span><span class="op" id="4246888">,</span>&nbsp;<span class="num" id="4246890">32</span><span class="op" id="4246892">,</span>&nbsp;<span class="num" id="4246894">32</span><span class="op" id="4246896">,</span>&nbsp;<span class="num" id="4246898">6</span><span class="op" id="4246899">}</span><span class="op" id="4246900">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4246903">//&nbsp;Levels&nbsp;4-9&nbsp;use&nbsp;increasingly&nbsp;more&nbsp;lazy&nbsp;matching</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4246954">//&nbsp;and&nbsp;increasingly&nbsp;stringent&nbsp;conditions&nbsp;for&nbsp;&#34;good&nbsp;enough&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4247015">{</span><span class="num" id="4247016">4</span><span class="op" id="4247017">,</span>&nbsp;<span class="num" id="4247019">4</span><span class="op" id="4247020">,</span>&nbsp;<span class="num" id="4247022">16</span><span class="op" id="4247024">,</span>&nbsp;<span class="num" id="4247026">16</span><span class="op" id="4247028">,</span>&nbsp;<span class="ident" id="4247030">skipNever</span><span class="op" id="4247039">}</span><span class="op" id="4247040">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4247043">{</span><span class="num" id="4247044">8</span><span class="op" id="4247045">,</span>&nbsp;<span class="num" id="4247047">16</span><span class="op" id="4247049">,</span>&nbsp;<span class="num" id="4247051">32</span><span class="op" id="4247053">,</span>&nbsp;<span class="num" id="4247055">32</span><span class="op" id="4247057">,</span>&nbsp;<span class="ident" id="4247059">skipNever</span><span class="op" id="4247068">}</span><span class="op" id="4247069">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4247072">{</span><span class="num" id="4247073">8</span><span class="op" id="4247074">,</span>&nbsp;<span class="num" id="4247076">16</span><span class="op" id="4247078">,</span>&nbsp;<span class="num" id="4247080">128</span><span class="op" id="4247083">,</span>&nbsp;<span class="num" id="4247085">128</span><span class="op" id="4247088">,</span>&nbsp;<span class="ident" id="4247090">skipNever</span><span class="op" id="4247099">}</span><span class="op" id="4247100">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4247103">{</span><span class="num" id="4247104">8</span><span class="op" id="4247105">,</span>&nbsp;<span class="num" id="4247107">32</span><span class="op" id="4247109">,</span>&nbsp;<span class="num" id="4247111">128</span><span class="op" id="4247114">,</span>&nbsp;<span class="num" id="4247116">256</span><span class="op" id="4247119">,</span>&nbsp;<span class="ident" id="4247121">skipNever</span><span class="op" id="4247130">}</span><span class="op" id="4247131">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4247134">{</span><span class="num" id="4247135">32</span><span class="op" id="4247137">,</span>&nbsp;<span class="num" id="4247139">128</span><span class="op" id="4247142">,</span>&nbsp;<span class="num" id="4247144">258</span><span class="op" id="4247147">,</span>&nbsp;<span class="num" id="4247149">1024</span><span class="op" id="4247153">,</span>&nbsp;<span class="ident" id="4247155">skipNever</span><span class="op" id="4247164">}</span><span class="op" id="4247165">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4247168">{</span><span class="num" id="4247169">32</span><span class="op" id="4247171">,</span>&nbsp;<span class="num" id="4247173">258</span><span class="op" id="4247176">,</span>&nbsp;<span class="num" id="4247178">258</span><span class="op" id="4247181">,</span>&nbsp;<span class="num" id="4247183">4096</span><span class="op" id="4247187">,</span>&nbsp;<span class="ident" id="4247189">skipNever</span><span class="op" id="4247198">}</span><span class="op" id="4247199">,</span><br>
<span class="lineno"></span><span class="op" id="4247201">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="4247204">type</span>&nbsp;<span class="ident" id="4247209">compressor</span>&nbsp;<span class="keyword" id="4247220">struct</span>&nbsp;<span class="op" id="4247227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4247230">compressionLevel</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4247249">w</span>&nbsp;<span class="op" id="4247251">*</span><span class="ident" id="4247252">huffmanBitWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4247271">//&nbsp;compression&nbsp;algorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4247297">fill</span>&nbsp;<span class="keyword" id="4247302">func</span><span class="op" id="4247306">(</span><span class="op" id="4247307">*</span><span class="ident" id="4247308">compressor</span><span class="op" id="4247318">,</span>&nbsp;<span class="op" id="4247320">[</span><span class="op" id="4247321">]</span><span class="builtintype" id="4247322">byte</span><span class="op" id="4247326">)</span>&nbsp;<span class="builtintype" id="4247328">int</span>&nbsp;<span class="comment" id="4247332">//&nbsp;copy&nbsp;data&nbsp;to&nbsp;window</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4247356">step</span>&nbsp;<span class="keyword" id="4247361">func</span><span class="op" id="4247365">(</span><span class="op" id="4247366">*</span><span class="ident" id="4247367">compressor</span><span class="op" id="4247377">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4247391">//&nbsp;process&nbsp;window</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4247410">sync</span>&nbsp;<span class="builtintype" id="4247415">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4247445">//&nbsp;requesting&nbsp;flush</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4247467">//&nbsp;Input&nbsp;hash&nbsp;chains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4247489">//&nbsp;hashHead[hashValue]&nbsp;contains&nbsp;the&nbsp;largest&nbsp;inputIndex&nbsp;with&nbsp;the&nbsp;specified&nbsp;hash&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4247575">//&nbsp;If&nbsp;hashHead[hashValue]&nbsp;is&nbsp;within&nbsp;the&nbsp;current&nbsp;window,&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4247637">//&nbsp;hashPrev[hashHead[hashValue]&nbsp;&amp;&nbsp;windowMask]&nbsp;contains&nbsp;the&nbsp;previous&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4247712">//&nbsp;with&nbsp;the&nbsp;same&nbsp;hash&nbsp;value.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4247742">chainHead</span>&nbsp;&nbsp;<span class="builtintype" id="4247753">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4247758">hashHead</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4247769">[</span><span class="op" id="4247770">]</span><span class="builtintype" id="4247771">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4247776">hashPrev</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4247787">[</span><span class="op" id="4247788">]</span><span class="builtintype" id="4247789">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4247794">hashOffset</span>&nbsp;<span class="builtintype" id="4247805">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4247811">//&nbsp;input&nbsp;window:&nbsp;unprocessed&nbsp;data&nbsp;is&nbsp;window[index:windowEnd]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4247873">index</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4247887">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4247892">window</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4247906">[</span><span class="op" id="4247907">]</span><span class="builtintype" id="4247908">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4247914">windowEnd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4247928">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4247933">blockStart</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4247947">int</span>&nbsp;&nbsp;<span class="comment" id="4247952">//&nbsp;window&nbsp;index&nbsp;where&nbsp;current&nbsp;tokens&nbsp;start</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4247996">byteAvailable</span>&nbsp;<span class="builtintype" id="4248010">bool</span>&nbsp;<span class="comment" id="4248015">//&nbsp;if&nbsp;true,&nbsp;still&nbsp;need&nbsp;to&nbsp;process&nbsp;window[index-1].</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4248068">//&nbsp;queued&nbsp;output&nbsp;tokens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4248093">tokens</span>&nbsp;<span class="op" id="4248100">[</span><span class="op" id="4248101">]</span><span class="ident" id="4248102">token</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4248110">//&nbsp;deflate&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4248128">length</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4248143">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4248148">offset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4248163">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4248168">hash</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4248183">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4248188">maxInsertIndex</span>&nbsp;<span class="builtintype" id="4248203">int</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4248208">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4248223">error</span><br>
<span class="lineno"></span><span class="op" id="4248229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4248232">func</span>&nbsp;<span class="op" id="4248237">(</span><span class="ident" id="4248238">d</span>&nbsp;<span class="op" id="4248240">*</span><span class="ident" id="4248241">compressor</span><span class="op" id="4248251">)</span>&nbsp;<span class="ident" id="4248253">fillDeflate</span><span class="op" id="4248264">(</span><span class="ident" id="4248265">b</span>&nbsp;<span class="op" id="4248267">[</span><span class="op" id="4248268">]</span><span class="builtintype" id="4248269">byte</span><span class="op" id="4248273">)</span>&nbsp;<span class="builtintype" id="4248275">int</span>&nbsp;<span class="op" id="4248279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4248282">if</span>&nbsp;<span class="ident" id="4248285">d</span><span class="op" id="4248286">.</span><span class="ident" id="4248287">index</span>&nbsp;<span class="op" id="4248293">&gt;=</span>&nbsp;<span class="num" id="4248296">2</span><span class="op" id="4248297">*</span><span class="ident" id="4248298">windowSize</span><span class="op" id="4248308">-</span><span class="op" id="4248309">(</span><span class="ident" id="4248310">minMatchLength</span><span class="op" id="4248324">+</span><span class="ident" id="4248325">maxMatchLength</span><span class="op" id="4248339">)</span>&nbsp;<span class="op" id="4248341">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4248345">//&nbsp;shift&nbsp;the&nbsp;window&nbsp;by&nbsp;windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4248381">copy</span><span class="op" id="4248385">(</span><span class="ident" id="4248386">d</span><span class="op" id="4248387">.</span><span class="ident" id="4248388">window</span><span class="op" id="4248394">,</span>&nbsp;<span class="ident" id="4248396">d</span><span class="op" id="4248397">.</span><span class="ident" id="4248398">window</span><span class="op" id="4248404">[</span><span class="ident" id="4248405">windowSize</span><span class="op" id="4248415">:</span><span class="num" id="4248416">2</span><span class="op" id="4248417">*</span><span class="ident" id="4248418">windowSize</span><span class="op" id="4248428">]</span><span class="op" id="4248429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4248433">d</span><span class="op" id="4248434">.</span><span class="ident" id="4248435">index</span>&nbsp;<span class="op" id="4248441">-=</span>&nbsp;<span class="ident" id="4248444">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4248457">d</span><span class="op" id="4248458">.</span><span class="ident" id="4248459">windowEnd</span>&nbsp;<span class="op" id="4248469">-=</span>&nbsp;<span class="ident" id="4248472">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4248485">if</span>&nbsp;<span class="ident" id="4248488">d</span><span class="op" id="4248489">.</span><span class="ident" id="4248490">blockStart</span>&nbsp;<span class="op" id="4248501">&gt;=</span>&nbsp;<span class="ident" id="4248504">windowSize</span>&nbsp;<span class="op" id="4248515">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4248520">d</span><span class="op" id="4248521">.</span><span class="ident" id="4248522">blockStart</span>&nbsp;<span class="op" id="4248533">-=</span>&nbsp;<span class="ident" id="4248536">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4248549">}</span>&nbsp;<span class="keyword" id="4248551">else</span>&nbsp;<span class="op" id="4248556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4248561">d</span><span class="op" id="4248562">.</span><span class="ident" id="4248563">blockStart</span>&nbsp;<span class="op" id="4248574">=</span>&nbsp;<span class="ident" id="4248576">math</span><span class="op" id="4248580">.</span><span class="ident" id="4248581">MaxInt32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4248592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4248596">d</span><span class="op" id="4248597">.</span><span class="ident" id="4248598">hashOffset</span>&nbsp;<span class="op" id="4248609">+=</span>&nbsp;<span class="ident" id="4248612">windowSize</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4248625">if</span>&nbsp;<span class="ident" id="4248628">d</span><span class="op" id="4248629">.</span><span class="ident" id="4248630">hashOffset</span>&nbsp;<span class="op" id="4248641">&gt;</span>&nbsp;<span class="ident" id="4248643">maxHashOffset</span>&nbsp;<span class="op" id="4248657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4248662">delta</span>&nbsp;<span class="op" id="4248668">:=</span>&nbsp;<span class="ident" id="4248671">d</span><span class="op" id="4248672">.</span><span class="ident" id="4248673">hashOffset</span>&nbsp;<span class="op" id="4248684">-</span>&nbsp;<span class="num" id="4248686">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4248691">d</span><span class="op" id="4248692">.</span><span class="ident" id="4248693">hashOffset</span>&nbsp;<span class="op" id="4248704">-=</span>&nbsp;<span class="ident" id="4248707">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4248716">d</span><span class="op" id="4248717">.</span><span class="ident" id="4248718">chainHead</span>&nbsp;<span class="op" id="4248728">-=</span>&nbsp;<span class="ident" id="4248731">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4248740">for</span>&nbsp;<span class="ident" id="4248744">i</span><span class="op" id="4248745">,</span>&nbsp;<span class="ident" id="4248747">v</span>&nbsp;<span class="op" id="4248749">:=</span>&nbsp;<span class="keyword" id="4248752">range</span>&nbsp;<span class="ident" id="4248758">d</span><span class="op" id="4248759">.</span><span class="ident" id="4248760">hashPrev</span>&nbsp;<span class="op" id="4248769">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4248775">if</span>&nbsp;<span class="ident" id="4248778">v</span>&nbsp;<span class="op" id="4248780">&gt;</span>&nbsp;<span class="ident" id="4248782">delta</span>&nbsp;<span class="op" id="4248788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4248795">d</span><span class="op" id="4248796">.</span><span class="ident" id="4248797">hashPrev</span><span class="op" id="4248805">[</span><span class="ident" id="4248806">i</span><span class="op" id="4248807">]</span>&nbsp;<span class="op" id="4248809">-=</span>&nbsp;<span class="ident" id="4248812">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4248822">}</span>&nbsp;<span class="keyword" id="4248824">else</span>&nbsp;<span class="op" id="4248829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4248836">d</span><span class="op" id="4248837">.</span><span class="ident" id="4248838">hashPrev</span><span class="op" id="4248846">[</span><span class="ident" id="4248847">i</span><span class="op" id="4248848">]</span>&nbsp;<span class="op" id="4248850">=</span>&nbsp;<span class="num" id="4248852">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4248858">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4248863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4248868">for</span>&nbsp;<span class="ident" id="4248872">i</span><span class="op" id="4248873">,</span>&nbsp;<span class="ident" id="4248875">v</span>&nbsp;<span class="op" id="4248877">:=</span>&nbsp;<span class="keyword" id="4248880">range</span>&nbsp;<span class="ident" id="4248886">d</span><span class="op" id="4248887">.</span><span class="ident" id="4248888">hashHead</span>&nbsp;<span class="op" id="4248897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4248903">if</span>&nbsp;<span class="ident" id="4248906">v</span>&nbsp;<span class="op" id="4248908">&gt;</span>&nbsp;<span class="ident" id="4248910">delta</span>&nbsp;<span class="op" id="4248916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4248923">d</span><span class="op" id="4248924">.</span><span class="ident" id="4248925">hashHead</span><span class="op" id="4248933">[</span><span class="ident" id="4248934">i</span><span class="op" id="4248935">]</span>&nbsp;<span class="op" id="4248937">-=</span>&nbsp;<span class="ident" id="4248940">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4248950">}</span>&nbsp;<span class="keyword" id="4248952">else</span>&nbsp;<span class="op" id="4248957">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4248964">d</span><span class="op" id="4248965">.</span><span class="ident" id="4248966">hashHead</span><span class="op" id="4248974">[</span><span class="ident" id="4248975">i</span><span class="op" id="4248976">]</span>&nbsp;<span class="op" id="4248978">=</span>&nbsp;<span class="num" id="4248980">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4248986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4248991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4248995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4248998">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4249001">n</span>&nbsp;<span class="op" id="4249003">:=</span>&nbsp;<span class="builtinfunc" id="4249006">copy</span><span class="op" id="4249010">(</span><span class="ident" id="4249011">d</span><span class="op" id="4249012">.</span><span class="ident" id="4249013">window</span><span class="op" id="4249019">[</span><span class="ident" id="4249020">d</span><span class="op" id="4249021">.</span><span class="ident" id="4249022">windowEnd</span><span class="op" id="4249031">:</span><span class="op" id="4249032">]</span><span class="op" id="4249033">,</span>&nbsp;<span class="ident" id="4249035">b</span><span class="op" id="4249036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4249039">d</span><span class="op" id="4249040">.</span><span class="ident" id="4249041">windowEnd</span>&nbsp;<span class="op" id="4249051">+=</span>&nbsp;<span class="ident" id="4249054">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4249057">return</span>&nbsp;<span class="ident" id="4249064">n</span><br>
<span class="lineno"></span><span class="op" id="4249066">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="4249069">func</span>&nbsp;<span class="op" id="4249074">(</span><span class="ident" id="4249075">d</span>&nbsp;<span class="op" id="4249077">*</span><span class="ident" id="4249078">compressor</span><span class="op" id="4249088">)</span>&nbsp;<span class="ident" id="4249090">writeBlock</span><span class="op" id="4249100">(</span><span class="ident" id="4249101">tokens</span>&nbsp;<span class="op" id="4249108">[</span><span class="op" id="4249109">]</span><span class="ident" id="4249110">token</span><span class="op" id="4249115">,</span>&nbsp;<span class="ident" id="4249117">index</span>&nbsp;<span class="builtintype" id="4249123">int</span><span class="op" id="4249126">,</span>&nbsp;<span class="ident" id="4249128">eof</span>&nbsp;<span class="builtintype" id="4249132">bool</span><span class="op" id="4249136">)</span>&nbsp;<span class="builtintype" id="4249138">error</span>&nbsp;<span class="op" id="4249144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4249147">if</span>&nbsp;<span class="ident" id="4249150">index</span>&nbsp;<span class="op" id="4249156">&gt;</span>&nbsp;<span class="num" id="4249158">0</span>&nbsp;<span class="op" id="4249160">||</span>&nbsp;<span class="ident" id="4249163">eof</span>&nbsp;<span class="op" id="4249167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4249171">var</span>&nbsp;<span class="ident" id="4249175">window</span>&nbsp;<span class="op" id="4249182">[</span><span class="op" id="4249183">]</span><span class="builtintype" id="4249184">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4249191">if</span>&nbsp;<span class="ident" id="4249194">d</span><span class="op" id="4249195">.</span><span class="ident" id="4249196">blockStart</span>&nbsp;<span class="op" id="4249207">&lt;=</span>&nbsp;<span class="ident" id="4249210">index</span>&nbsp;<span class="op" id="4249216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4249221">window</span>&nbsp;<span class="op" id="4249228">=</span>&nbsp;<span class="ident" id="4249230">d</span><span class="op" id="4249231">.</span><span class="ident" id="4249232">window</span><span class="op" id="4249238">[</span><span class="ident" id="4249239">d</span><span class="op" id="4249240">.</span><span class="ident" id="4249241">blockStart</span><span class="op" id="4249251">:</span><span class="ident" id="4249252">index</span><span class="op" id="4249257">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4249261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4249265">d</span><span class="op" id="4249266">.</span><span class="ident" id="4249267">blockStart</span>&nbsp;<span class="op" id="4249278">=</span>&nbsp;<span class="ident" id="4249280">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4249288">d</span><span class="op" id="4249289">.</span><span class="ident" id="4249290">w</span><span class="op" id="4249291">.</span><span class="ident" id="4249292">writeBlock</span><span class="op" id="4249302">(</span><span class="ident" id="4249303">tokens</span><span class="op" id="4249309">,</span>&nbsp;<span class="ident" id="4249311">eof</span><span class="op" id="4249314">,</span>&nbsp;<span class="ident" id="4249316">window</span><span class="op" id="4249322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4249326">return</span>&nbsp;<span class="ident" id="4249333">d</span><span class="op" id="4249334">.</span><span class="ident" id="4249335">w</span><span class="op" id="4249336">.</span><span class="ident" id="4249337">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4249342">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4249345">return</span>&nbsp;<span class="ident" id="4249352">nil</span><br>
<span class="lineno"></span><span class="op" id="4249356">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4249359">//&nbsp;Try&nbsp;to&nbsp;find&nbsp;a&nbsp;match&nbsp;starting&nbsp;at&nbsp;index&nbsp;whose&nbsp;length&nbsp;is&nbsp;greater&nbsp;than&nbsp;prevSize.</span><br>
<span class="lineno"></span><span class="comment" id="4249439">//&nbsp;We&nbsp;only&nbsp;look&nbsp;at&nbsp;chainCount&nbsp;possibilities&nbsp;before&nbsp;giving&nbsp;up.</span><br>
<span class="lineno">150</span><span class="keyword" id="4249501">func</span>&nbsp;<span class="op" id="4249506">(</span><span class="ident" id="4249507">d</span>&nbsp;<span class="op" id="4249509">*</span><span class="ident" id="4249510">compressor</span><span class="op" id="4249520">)</span>&nbsp;<span class="ident" id="4249522">findMatch</span><span class="op" id="4249531">(</span><span class="ident" id="4249532">pos</span>&nbsp;<span class="builtintype" id="4249536">int</span><span class="op" id="4249539">,</span>&nbsp;<span class="ident" id="4249541">prevHead</span>&nbsp;<span class="builtintype" id="4249550">int</span><span class="op" id="4249553">,</span>&nbsp;<span class="ident" id="4249555">prevLength</span>&nbsp;<span class="builtintype" id="4249566">int</span><span class="op" id="4249569">,</span>&nbsp;<span class="ident" id="4249571">lookahead</span>&nbsp;<span class="builtintype" id="4249581">int</span><span class="op" id="4249584">)</span>&nbsp;<span class="op" id="4249586">(</span><span class="ident" id="4249587">length</span><span class="op" id="4249593">,</span>&nbsp;<span class="ident" id="4249595">offset</span>&nbsp;<span class="builtintype" id="4249602">int</span><span class="op" id="4249605">,</span>&nbsp;<span class="ident" id="4249607">ok</span>&nbsp;<span class="builtintype" id="4249610">bool</span><span class="op" id="4249614">)</span>&nbsp;<span class="op" id="4249616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4249619">minMatchLook</span>&nbsp;<span class="op" id="4249632">:=</span>&nbsp;<span class="ident" id="4249635">maxMatchLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4249651">if</span>&nbsp;<span class="ident" id="4249654">lookahead</span>&nbsp;<span class="op" id="4249664">&lt;</span>&nbsp;<span class="ident" id="4249666">minMatchLook</span>&nbsp;<span class="op" id="4249679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4249683">minMatchLook</span>&nbsp;<span class="op" id="4249696">=</span>&nbsp;<span class="ident" id="4249698">lookahead</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4249709">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4249713">win</span>&nbsp;<span class="op" id="4249717">:=</span>&nbsp;<span class="ident" id="4249720">d</span><span class="op" id="4249721">.</span><span class="ident" id="4249722">window</span><span class="op" id="4249728">[</span><span class="num" id="4249729">0</span>&nbsp;<span class="op" id="4249731">:</span>&nbsp;<span class="ident" id="4249733">pos</span><span class="op" id="4249736">+</span><span class="ident" id="4249737">minMatchLook</span><span class="op" id="4249749">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4249753">//&nbsp;We&nbsp;quit&nbsp;when&nbsp;we&nbsp;get&nbsp;a&nbsp;match&nbsp;that&#39;s&nbsp;at&nbsp;least&nbsp;nice&nbsp;long</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4249811">nice</span>&nbsp;<span class="op" id="4249816">:=</span>&nbsp;<span class="builtinfunc" id="4249819">len</span><span class="op" id="4249822">(</span><span class="ident" id="4249823">win</span><span class="op" id="4249826">)</span>&nbsp;<span class="op" id="4249828">-</span>&nbsp;<span class="ident" id="4249830">pos</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4249835">if</span>&nbsp;<span class="ident" id="4249838">d</span><span class="op" id="4249839">.</span><span class="ident" id="4249840">nice</span>&nbsp;<span class="op" id="4249845">&lt;</span>&nbsp;<span class="ident" id="4249847">nice</span>&nbsp;<span class="op" id="4249852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4249856">nice</span>&nbsp;<span class="op" id="4249861">=</span>&nbsp;<span class="ident" id="4249863">d</span><span class="op" id="4249864">.</span><span class="ident" id="4249865">nice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4249871">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4249875">//&nbsp;If&nbsp;we&#39;ve&nbsp;got&nbsp;a&nbsp;match&nbsp;that&#39;s&nbsp;good&nbsp;enough,&nbsp;only&nbsp;look&nbsp;in&nbsp;1/4&nbsp;the&nbsp;chain.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4249948">tries</span>&nbsp;<span class="op" id="4249954">:=</span>&nbsp;<span class="ident" id="4249957">d</span><span class="op" id="4249958">.</span><span class="ident" id="4249959">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4249966">length</span>&nbsp;<span class="op" id="4249973">=</span>&nbsp;<span class="ident" id="4249975">prevLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4249987">if</span>&nbsp;<span class="ident" id="4249990">length</span>&nbsp;<span class="op" id="4249997">&gt;=</span>&nbsp;<span class="ident" id="4250000">d</span><span class="op" id="4250001">.</span><span class="ident" id="4250002">good</span>&nbsp;<span class="op" id="4250007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4250011">tries</span>&nbsp;<span class="op" id="4250017">&gt;&gt;=</span>&nbsp;<span class="num" id="4250021">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4250024">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4250028">w0</span>&nbsp;<span class="op" id="4250031">:=</span>&nbsp;<span class="ident" id="4250034">win</span><span class="op" id="4250037">[</span><span class="ident" id="4250038">pos</span><span class="op" id="4250041">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4250044">w1</span>&nbsp;<span class="op" id="4250047">:=</span>&nbsp;<span class="ident" id="4250050">win</span><span class="op" id="4250053">[</span><span class="ident" id="4250054">pos</span><span class="op" id="4250057">+</span><span class="num" id="4250058">1</span><span class="op" id="4250059">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4250062">wEnd</span>&nbsp;<span class="op" id="4250067">:=</span>&nbsp;<span class="ident" id="4250070">win</span><span class="op" id="4250073">[</span><span class="ident" id="4250074">pos</span><span class="op" id="4250077">+</span><span class="ident" id="4250078">length</span><span class="op" id="4250084">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4250087">minIndex</span>&nbsp;<span class="op" id="4250096">:=</span>&nbsp;<span class="ident" id="4250099">pos</span>&nbsp;<span class="op" id="4250103">-</span>&nbsp;<span class="ident" id="4250105">windowSize</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4250118">for</span>&nbsp;<span class="ident" id="4250122">i</span>&nbsp;<span class="op" id="4250124">:=</span>&nbsp;<span class="ident" id="4250127">prevHead</span><span class="op" id="4250135">;</span>&nbsp;<span class="ident" id="4250137">tries</span>&nbsp;<span class="op" id="4250143">&gt;</span>&nbsp;<span class="num" id="4250145">0</span><span class="op" id="4250146">;</span>&nbsp;<span class="ident" id="4250148">tries</span><span class="op" id="4250153">--</span>&nbsp;<span class="op" id="4250156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4250160">if</span>&nbsp;<span class="ident" id="4250163">w0</span>&nbsp;<span class="op" id="4250166">==</span>&nbsp;<span class="ident" id="4250169">win</span><span class="op" id="4250172">[</span><span class="ident" id="4250173">i</span><span class="op" id="4250174">]</span>&nbsp;<span class="op" id="4250176">&amp;&amp;</span>&nbsp;<span class="ident" id="4250179">w1</span>&nbsp;<span class="op" id="4250182">==</span>&nbsp;<span class="ident" id="4250185">win</span><span class="op" id="4250188">[</span><span class="ident" id="4250189">i</span><span class="op" id="4250190">+</span><span class="num" id="4250191">1</span><span class="op" id="4250192">]</span>&nbsp;<span class="op" id="4250194">&amp;&amp;</span>&nbsp;<span class="ident" id="4250197">wEnd</span>&nbsp;<span class="op" id="4250202">==</span>&nbsp;<span class="ident" id="4250205">win</span><span class="op" id="4250208">[</span><span class="ident" id="4250209">i</span><span class="op" id="4250210">+</span><span class="ident" id="4250211">length</span><span class="op" id="4250217">]</span>&nbsp;<span class="op" id="4250219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4250224">//&nbsp;The&nbsp;hash&nbsp;function&nbsp;ensures&nbsp;that&nbsp;if&nbsp;win[i]&nbsp;and&nbsp;win[i+1]&nbsp;match,&nbsp;win[i+2]&nbsp;matches</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4250309">n</span>&nbsp;<span class="op" id="4250311">:=</span>&nbsp;<span class="num" id="4250314">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4250319">for</span>&nbsp;<span class="ident" id="4250323">pos</span><span class="op" id="4250326">+</span><span class="ident" id="4250327">n</span>&nbsp;<span class="op" id="4250329">&lt;</span>&nbsp;<span class="builtinfunc" id="4250331">len</span><span class="op" id="4250334">(</span><span class="ident" id="4250335">win</span><span class="op" id="4250338">)</span>&nbsp;<span class="op" id="4250340">&amp;&amp;</span>&nbsp;<span class="ident" id="4250343">win</span><span class="op" id="4250346">[</span><span class="ident" id="4250347">i</span><span class="op" id="4250348">+</span><span class="ident" id="4250349">n</span><span class="op" id="4250350">]</span>&nbsp;<span class="op" id="4250352">==</span>&nbsp;<span class="ident" id="4250355">win</span><span class="op" id="4250358">[</span><span class="ident" id="4250359">pos</span><span class="op" id="4250362">+</span><span class="ident" id="4250363">n</span><span class="op" id="4250364">]</span>&nbsp;<span class="op" id="4250366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4250372">n</span><span class="op" id="4250373">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4250379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4250384">if</span>&nbsp;<span class="ident" id="4250387">n</span>&nbsp;<span class="op" id="4250389">&gt;</span>&nbsp;<span class="ident" id="4250391">length</span>&nbsp;<span class="op" id="4250398">&amp;&amp;</span>&nbsp;<span class="op" id="4250401">(</span><span class="ident" id="4250402">n</span>&nbsp;<span class="op" id="4250404">&gt;</span>&nbsp;<span class="num" id="4250406">3</span>&nbsp;<span class="op" id="4250408">||</span>&nbsp;<span class="ident" id="4250411">pos</span><span class="op" id="4250414">-</span><span class="ident" id="4250415">i</span>&nbsp;<span class="op" id="4250417">&lt;=</span>&nbsp;<span class="num" id="4250420">4096</span><span class="op" id="4250424">)</span>&nbsp;<span class="op" id="4250426">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4250432">length</span>&nbsp;<span class="op" id="4250439">=</span>&nbsp;<span class="ident" id="4250441">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4250447">offset</span>&nbsp;<span class="op" id="4250454">=</span>&nbsp;<span class="ident" id="4250456">pos</span>&nbsp;<span class="op" id="4250460">-</span>&nbsp;<span class="ident" id="4250462">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4250468">ok</span>&nbsp;<span class="op" id="4250471">=</span>&nbsp;<span class="builtintype" id="4250473">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4250482">if</span>&nbsp;<span class="ident" id="4250485">n</span>&nbsp;<span class="op" id="4250487">&gt;=</span>&nbsp;<span class="ident" id="4250490">nice</span>&nbsp;<span class="op" id="4250495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4250502">//&nbsp;The&nbsp;match&nbsp;is&nbsp;good&nbsp;enough&nbsp;that&nbsp;we&nbsp;don&#39;t&nbsp;try&nbsp;to&nbsp;find&nbsp;a&nbsp;better&nbsp;one.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4250575">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4250585">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4250591">wEnd</span>&nbsp;<span class="op" id="4250596">=</span>&nbsp;<span class="ident" id="4250598">win</span><span class="op" id="4250601">[</span><span class="ident" id="4250602">pos</span><span class="op" id="4250605">+</span><span class="ident" id="4250606">n</span><span class="op" id="4250607">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4250612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4250616">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4250620">if</span>&nbsp;<span class="ident" id="4250623">i</span>&nbsp;<span class="op" id="4250625">==</span>&nbsp;<span class="ident" id="4250628">minIndex</span>&nbsp;<span class="op" id="4250637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4250642">//&nbsp;hashPrev[i&nbsp;&amp;&nbsp;windowMask]&nbsp;has&nbsp;already&nbsp;been&nbsp;overwritten,&nbsp;so&nbsp;stop&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4250716">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4250724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4250728">if</span>&nbsp;<span class="ident" id="4250731">i</span>&nbsp;<span class="op" id="4250733">=</span>&nbsp;<span class="ident" id="4250735">d</span><span class="op" id="4250736">.</span><span class="ident" id="4250737">hashPrev</span><span class="op" id="4250745">[</span><span class="ident" id="4250746">i</span><span class="op" id="4250747">&amp;</span><span class="ident" id="4250748">windowMask</span><span class="op" id="4250758">]</span>&nbsp;<span class="op" id="4250760">-</span>&nbsp;<span class="ident" id="4250762">d</span><span class="op" id="4250763">.</span><span class="ident" id="4250764">hashOffset</span><span class="op" id="4250774">;</span>&nbsp;<span class="ident" id="4250776">i</span>&nbsp;<span class="op" id="4250778">&lt;</span>&nbsp;<span class="ident" id="4250780">minIndex</span>&nbsp;<span class="op" id="4250789">||</span>&nbsp;<span class="ident" id="4250792">i</span>&nbsp;<span class="op" id="4250794">&lt;</span>&nbsp;<span class="num" id="4250796">0</span>&nbsp;<span class="op" id="4250798">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4250803">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4250811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4250814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4250817">return</span><br>
<span class="lineno"></span><span class="op" id="4250824">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="4250827">func</span>&nbsp;<span class="op" id="4250832">(</span><span class="ident" id="4250833">d</span>&nbsp;<span class="op" id="4250835">*</span><span class="ident" id="4250836">compressor</span><span class="op" id="4250846">)</span>&nbsp;<span class="ident" id="4250848">writeStoredBlock</span><span class="op" id="4250864">(</span><span class="ident" id="4250865">buf</span>&nbsp;<span class="op" id="4250869">[</span><span class="op" id="4250870">]</span><span class="builtintype" id="4250871">byte</span><span class="op" id="4250875">)</span>&nbsp;<span class="builtintype" id="4250877">error</span>&nbsp;<span class="op" id="4250883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4250886">if</span>&nbsp;<span class="ident" id="4250889">d</span><span class="op" id="4250890">.</span><span class="ident" id="4250891">w</span><span class="op" id="4250892">.</span><span class="ident" id="4250893">writeStoredHeader</span><span class="op" id="4250910">(</span><span class="builtinfunc" id="4250911">len</span><span class="op" id="4250914">(</span><span class="ident" id="4250915">buf</span><span class="op" id="4250918">)</span><span class="op" id="4250919">,</span>&nbsp;<span class="builtintype" id="4250921">false</span><span class="op" id="4250926">)</span><span class="op" id="4250927">;</span>&nbsp;<span class="ident" id="4250929">d</span><span class="op" id="4250930">.</span><span class="ident" id="4250931">w</span><span class="op" id="4250932">.</span><span class="ident" id="4250933">err</span>&nbsp;<span class="op" id="4250937">!=</span>&nbsp;<span class="ident" id="4250940">nil</span>&nbsp;<span class="op" id="4250944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4250948">return</span>&nbsp;<span class="ident" id="4250955">d</span><span class="op" id="4250956">.</span><span class="ident" id="4250957">w</span><span class="op" id="4250958">.</span><span class="ident" id="4250959">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4250964">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4250967">d</span><span class="op" id="4250968">.</span><span class="ident" id="4250969">w</span><span class="op" id="4250970">.</span><span class="ident" id="4250971">writeBytes</span><span class="op" id="4250981">(</span><span class="ident" id="4250982">buf</span><span class="op" id="4250985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4250988">return</span>&nbsp;<span class="ident" id="4250995">d</span><span class="op" id="4250996">.</span><span class="ident" id="4250997">w</span><span class="op" id="4250998">.</span><span class="ident" id="4250999">err</span><br>
<span class="lineno"></span><span class="op" id="4251003">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4251006">func</span>&nbsp;<span class="op" id="4251011">(</span><span class="ident" id="4251012">d</span>&nbsp;<span class="op" id="4251014">*</span><span class="ident" id="4251015">compressor</span><span class="op" id="4251025">)</span>&nbsp;<span class="ident" id="4251027">initDeflate</span><span class="op" id="4251038">(</span><span class="op" id="4251039">)</span>&nbsp;<span class="op" id="4251041">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251044">d</span><span class="op" id="4251045">.</span><span class="ident" id="4251046">hashHead</span>&nbsp;<span class="op" id="4251055">=</span>&nbsp;<span class="builtinfunc" id="4251057">make</span><span class="op" id="4251061">(</span><span class="op" id="4251062">[</span><span class="op" id="4251063">]</span><span class="builtintype" id="4251064">int</span><span class="op" id="4251067">,</span>&nbsp;<span class="ident" id="4251069">hashSize</span><span class="op" id="4251077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251080">d</span><span class="op" id="4251081">.</span><span class="ident" id="4251082">hashPrev</span>&nbsp;<span class="op" id="4251091">=</span>&nbsp;<span class="builtinfunc" id="4251093">make</span><span class="op" id="4251097">(</span><span class="op" id="4251098">[</span><span class="op" id="4251099">]</span><span class="builtintype" id="4251100">int</span><span class="op" id="4251103">,</span>&nbsp;<span class="ident" id="4251105">windowSize</span><span class="op" id="4251115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251118">d</span><span class="op" id="4251119">.</span><span class="ident" id="4251120">window</span>&nbsp;<span class="op" id="4251127">=</span>&nbsp;<span class="builtinfunc" id="4251129">make</span><span class="op" id="4251133">(</span><span class="op" id="4251134">[</span><span class="op" id="4251135">]</span><span class="builtintype" id="4251136">byte</span><span class="op" id="4251140">,</span>&nbsp;<span class="num" id="4251142">2</span><span class="op" id="4251143">*</span><span class="ident" id="4251144">windowSize</span><span class="op" id="4251154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251157">d</span><span class="op" id="4251158">.</span><span class="ident" id="4251159">hashOffset</span>&nbsp;<span class="op" id="4251170">=</span>&nbsp;<span class="num" id="4251172">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251175">d</span><span class="op" id="4251176">.</span><span class="ident" id="4251177">tokens</span>&nbsp;<span class="op" id="4251184">=</span>&nbsp;<span class="builtinfunc" id="4251186">make</span><span class="op" id="4251190">(</span><span class="op" id="4251191">[</span><span class="op" id="4251192">]</span><span class="ident" id="4251193">token</span><span class="op" id="4251198">,</span>&nbsp;<span class="num" id="4251200">0</span><span class="op" id="4251201">,</span>&nbsp;<span class="ident" id="4251203">maxFlateBlockTokens</span><span class="op" id="4251222">+</span><span class="num" id="4251223">1</span><span class="op" id="4251224">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251227">d</span><span class="op" id="4251228">.</span><span class="ident" id="4251229">length</span>&nbsp;<span class="op" id="4251236">=</span>&nbsp;<span class="ident" id="4251238">minMatchLength</span>&nbsp;<span class="op" id="4251253">-</span>&nbsp;<span class="num" id="4251255">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251258">d</span><span class="op" id="4251259">.</span><span class="ident" id="4251260">offset</span>&nbsp;<span class="op" id="4251267">=</span>&nbsp;<span class="num" id="4251269">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251272">d</span><span class="op" id="4251273">.</span><span class="ident" id="4251274">byteAvailable</span>&nbsp;<span class="op" id="4251288">=</span>&nbsp;<span class="builtintype" id="4251290">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251297">d</span><span class="op" id="4251298">.</span><span class="ident" id="4251299">index</span>&nbsp;<span class="op" id="4251305">=</span>&nbsp;<span class="num" id="4251307">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251310">d</span><span class="op" id="4251311">.</span><span class="ident" id="4251312">hash</span>&nbsp;<span class="op" id="4251317">=</span>&nbsp;<span class="num" id="4251319">0</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251322">d</span><span class="op" id="4251323">.</span><span class="ident" id="4251324">chainHead</span>&nbsp;<span class="op" id="4251334">=</span>&nbsp;<span class="op" id="4251336">-</span><span class="num" id="4251337">1</span><br>
<span class="lineno"></span><span class="op" id="4251339">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4251342">func</span>&nbsp;<span class="op" id="4251347">(</span><span class="ident" id="4251348">d</span>&nbsp;<span class="op" id="4251350">*</span><span class="ident" id="4251351">compressor</span><span class="op" id="4251361">)</span>&nbsp;<span class="ident" id="4251363">deflate</span><span class="op" id="4251370">(</span><span class="op" id="4251371">)</span>&nbsp;<span class="op" id="4251373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4251376">if</span>&nbsp;<span class="ident" id="4251379">d</span><span class="op" id="4251380">.</span><span class="ident" id="4251381">windowEnd</span><span class="op" id="4251390">-</span><span class="ident" id="4251391">d</span><span class="op" id="4251392">.</span><span class="ident" id="4251393">index</span>&nbsp;<span class="op" id="4251399">&lt;</span>&nbsp;<span class="ident" id="4251401">minMatchLength</span><span class="op" id="4251415">+</span><span class="ident" id="4251416">maxMatchLength</span>&nbsp;<span class="op" id="4251431">&amp;&amp;</span>&nbsp;<span class="op" id="4251434">!</span><span class="ident" id="4251435">d</span><span class="op" id="4251436">.</span><span class="ident" id="4251437">sync</span>&nbsp;<span class="op" id="4251442">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4251446">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4251454">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251458">d</span><span class="op" id="4251459">.</span><span class="ident" id="4251460">maxInsertIndex</span>&nbsp;<span class="op" id="4251475">=</span>&nbsp;<span class="ident" id="4251477">d</span><span class="op" id="4251478">.</span><span class="ident" id="4251479">windowEnd</span>&nbsp;<span class="op" id="4251489">-</span>&nbsp;<span class="op" id="4251491">(</span><span class="ident" id="4251492">minMatchLength</span>&nbsp;<span class="op" id="4251507">-</span>&nbsp;<span class="num" id="4251509">1</span><span class="op" id="4251510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4251513">if</span>&nbsp;<span class="ident" id="4251516">d</span><span class="op" id="4251517">.</span><span class="ident" id="4251518">index</span>&nbsp;<span class="op" id="4251524">&lt;</span>&nbsp;<span class="ident" id="4251526">d</span><span class="op" id="4251527">.</span><span class="ident" id="4251528">maxInsertIndex</span>&nbsp;<span class="op" id="4251543">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251547">d</span><span class="op" id="4251548">.</span><span class="ident" id="4251549">hash</span>&nbsp;<span class="op" id="4251554">=</span>&nbsp;<span class="builtintype" id="4251556">int</span><span class="op" id="4251559">(</span><span class="ident" id="4251560">d</span><span class="op" id="4251561">.</span><span class="ident" id="4251562">window</span><span class="op" id="4251568">[</span><span class="ident" id="4251569">d</span><span class="op" id="4251570">.</span><span class="ident" id="4251571">index</span><span class="op" id="4251576">]</span><span class="op" id="4251577">)</span><span class="op" id="4251578">&lt;&lt;</span><span class="ident" id="4251580">hashShift</span>&nbsp;<span class="op" id="4251590">+</span>&nbsp;<span class="builtintype" id="4251592">int</span><span class="op" id="4251595">(</span><span class="ident" id="4251596">d</span><span class="op" id="4251597">.</span><span class="ident" id="4251598">window</span><span class="op" id="4251604">[</span><span class="ident" id="4251605">d</span><span class="op" id="4251606">.</span><span class="ident" id="4251607">index</span><span class="op" id="4251612">+</span><span class="num" id="4251613">1</span><span class="op" id="4251614">]</span><span class="op" id="4251615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4251618">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="4251621">Loop</span><span class="op" id="4251625">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4251628">for</span>&nbsp;<span class="op" id="4251632">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4251636">if</span>&nbsp;<span class="ident" id="4251639">d</span><span class="op" id="4251640">.</span><span class="ident" id="4251641">index</span>&nbsp;<span class="op" id="4251647">&gt;</span>&nbsp;<span class="ident" id="4251649">d</span><span class="op" id="4251650">.</span><span class="ident" id="4251651">windowEnd</span>&nbsp;<span class="op" id="4251661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4251666">panic</span><span class="op" id="4251671">(</span><span class="string" id="4251672">&#34;index&nbsp;&gt;&nbsp;windowEnd&#34;</span><span class="op" id="4251691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4251695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251699">lookahead</span>&nbsp;<span class="op" id="4251709">:=</span>&nbsp;<span class="ident" id="4251712">d</span><span class="op" id="4251713">.</span><span class="ident" id="4251714">windowEnd</span>&nbsp;<span class="op" id="4251724">-</span>&nbsp;<span class="ident" id="4251726">d</span><span class="op" id="4251727">.</span><span class="ident" id="4251728">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4251736">if</span>&nbsp;<span class="ident" id="4251739">lookahead</span>&nbsp;<span class="op" id="4251749">&lt;</span>&nbsp;<span class="ident" id="4251751">minMatchLength</span><span class="op" id="4251765">+</span><span class="ident" id="4251766">maxMatchLength</span>&nbsp;<span class="op" id="4251781">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4251786">if</span>&nbsp;<span class="op" id="4251789">!</span><span class="ident" id="4251790">d</span><span class="op" id="4251791">.</span><span class="ident" id="4251792">sync</span>&nbsp;<span class="op" id="4251797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4251803">break</span>&nbsp;<span class="ident" id="4251809">Loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4251817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4251822">if</span>&nbsp;<span class="ident" id="4251825">d</span><span class="op" id="4251826">.</span><span class="ident" id="4251827">index</span>&nbsp;<span class="op" id="4251833">&gt;</span>&nbsp;<span class="ident" id="4251835">d</span><span class="op" id="4251836">.</span><span class="ident" id="4251837">windowEnd</span>&nbsp;<span class="op" id="4251847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4251853">panic</span><span class="op" id="4251858">(</span><span class="string" id="4251859">&#34;index&nbsp;&gt;&nbsp;windowEnd&#34;</span><span class="op" id="4251878">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4251883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4251888">if</span>&nbsp;<span class="ident" id="4251891">lookahead</span>&nbsp;<span class="op" id="4251901">==</span>&nbsp;<span class="num" id="4251904">0</span>&nbsp;<span class="op" id="4251906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4251912">//&nbsp;Flush&nbsp;current&nbsp;output&nbsp;block&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4251954">if</span>&nbsp;<span class="ident" id="4251957">d</span><span class="op" id="4251958">.</span><span class="ident" id="4251959">byteAvailable</span>&nbsp;<span class="op" id="4251973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4251980">//&nbsp;There&nbsp;is&nbsp;still&nbsp;one&nbsp;pending&nbsp;token&nbsp;that&nbsp;needs&nbsp;to&nbsp;be&nbsp;flushed</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4252046">d</span><span class="op" id="4252047">.</span><span class="ident" id="4252048">tokens</span>&nbsp;<span class="op" id="4252055">=</span>&nbsp;<span class="builtinfunc" id="4252057">append</span><span class="op" id="4252063">(</span><span class="ident" id="4252064">d</span><span class="op" id="4252065">.</span><span class="ident" id="4252066">tokens</span><span class="op" id="4252072">,</span>&nbsp;<span class="ident" id="4252074">literalToken</span><span class="op" id="4252086">(</span><span class="builtintype" id="4252087">uint32</span><span class="op" id="4252093">(</span><span class="ident" id="4252094">d</span><span class="op" id="4252095">.</span><span class="ident" id="4252096">window</span><span class="op" id="4252102">[</span><span class="ident" id="4252103">d</span><span class="op" id="4252104">.</span><span class="ident" id="4252105">index</span><span class="op" id="4252110">-</span><span class="num" id="4252111">1</span><span class="op" id="4252112">]</span><span class="op" id="4252113">)</span><span class="op" id="4252114">)</span><span class="op" id="4252115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4252122">d</span><span class="op" id="4252123">.</span><span class="ident" id="4252124">byteAvailable</span>&nbsp;<span class="op" id="4252138">=</span>&nbsp;<span class="builtintype" id="4252140">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4252150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4252156">if</span>&nbsp;<span class="builtinfunc" id="4252159">len</span><span class="op" id="4252162">(</span><span class="ident" id="4252163">d</span><span class="op" id="4252164">.</span><span class="ident" id="4252165">tokens</span><span class="op" id="4252171">)</span>&nbsp;<span class="op" id="4252173">&gt;</span>&nbsp;<span class="num" id="4252175">0</span>&nbsp;<span class="op" id="4252177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4252184">if</span>&nbsp;<span class="ident" id="4252187">d</span><span class="op" id="4252188">.</span><span class="ident" id="4252189">err</span>&nbsp;<span class="op" id="4252193">=</span>&nbsp;<span class="ident" id="4252195">d</span><span class="op" id="4252196">.</span><span class="ident" id="4252197">writeBlock</span><span class="op" id="4252207">(</span><span class="ident" id="4252208">d</span><span class="op" id="4252209">.</span><span class="ident" id="4252210">tokens</span><span class="op" id="4252216">,</span>&nbsp;<span class="ident" id="4252218">d</span><span class="op" id="4252219">.</span><span class="ident" id="4252220">index</span><span class="op" id="4252225">,</span>&nbsp;<span class="builtintype" id="4252227">false</span><span class="op" id="4252232">)</span><span class="op" id="4252233">;</span>&nbsp;<span class="ident" id="4252235">d</span><span class="op" id="4252236">.</span><span class="ident" id="4252237">err</span>&nbsp;<span class="op" id="4252241">!=</span>&nbsp;<span class="ident" id="4252244">nil</span>&nbsp;<span class="op" id="4252248">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4252256">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4252268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4252275">d</span><span class="op" id="4252276">.</span><span class="ident" id="4252277">tokens</span>&nbsp;<span class="op" id="4252284">=</span>&nbsp;<span class="ident" id="4252286">d</span><span class="op" id="4252287">.</span><span class="ident" id="4252288">tokens</span><span class="op" id="4252294">[</span><span class="op" id="4252295">:</span><span class="num" id="4252296">0</span><span class="op" id="4252297">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4252303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4252309">break</span>&nbsp;<span class="ident" id="4252315">Loop</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4252323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4252327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4252331">if</span>&nbsp;<span class="ident" id="4252334">d</span><span class="op" id="4252335">.</span><span class="ident" id="4252336">index</span>&nbsp;<span class="op" id="4252342">&lt;</span>&nbsp;<span class="ident" id="4252344">d</span><span class="op" id="4252345">.</span><span class="ident" id="4252346">maxInsertIndex</span>&nbsp;<span class="op" id="4252361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4252366">//&nbsp;Update&nbsp;the&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4252388">d</span><span class="op" id="4252389">.</span><span class="ident" id="4252390">hash</span>&nbsp;<span class="op" id="4252395">=</span>&nbsp;<span class="op" id="4252397">(</span><span class="ident" id="4252398">d</span><span class="op" id="4252399">.</span><span class="ident" id="4252400">hash</span><span class="op" id="4252404">&lt;&lt;</span><span class="ident" id="4252406">hashShift</span>&nbsp;<span class="op" id="4252416">+</span>&nbsp;<span class="builtintype" id="4252418">int</span><span class="op" id="4252421">(</span><span class="ident" id="4252422">d</span><span class="op" id="4252423">.</span><span class="ident" id="4252424">window</span><span class="op" id="4252430">[</span><span class="ident" id="4252431">d</span><span class="op" id="4252432">.</span><span class="ident" id="4252433">index</span><span class="op" id="4252438">+</span><span class="num" id="4252439">2</span><span class="op" id="4252440">]</span><span class="op" id="4252441">)</span><span class="op" id="4252442">)</span>&nbsp;<span class="op" id="4252444">&amp;</span>&nbsp;<span class="ident" id="4252446">hashMask</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4252458">d</span><span class="op" id="4252459">.</span><span class="ident" id="4252460">chainHead</span>&nbsp;<span class="op" id="4252470">=</span>&nbsp;<span class="ident" id="4252472">d</span><span class="op" id="4252473">.</span><span class="ident" id="4252474">hashHead</span><span class="op" id="4252482">[</span><span class="ident" id="4252483">d</span><span class="op" id="4252484">.</span><span class="ident" id="4252485">hash</span><span class="op" id="4252489">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4252494">d</span><span class="op" id="4252495">.</span><span class="ident" id="4252496">hashPrev</span><span class="op" id="4252504">[</span><span class="ident" id="4252505">d</span><span class="op" id="4252506">.</span><span class="ident" id="4252507">index</span><span class="op" id="4252512">&amp;</span><span class="ident" id="4252513">windowMask</span><span class="op" id="4252523">]</span>&nbsp;<span class="op" id="4252525">=</span>&nbsp;<span class="ident" id="4252527">d</span><span class="op" id="4252528">.</span><span class="ident" id="4252529">chainHead</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4252542">d</span><span class="op" id="4252543">.</span><span class="ident" id="4252544">hashHead</span><span class="op" id="4252552">[</span><span class="ident" id="4252553">d</span><span class="op" id="4252554">.</span><span class="ident" id="4252555">hash</span><span class="op" id="4252559">]</span>&nbsp;<span class="op" id="4252561">=</span>&nbsp;<span class="ident" id="4252563">d</span><span class="op" id="4252564">.</span><span class="ident" id="4252565">index</span>&nbsp;<span class="op" id="4252571">+</span>&nbsp;<span class="ident" id="4252573">d</span><span class="op" id="4252574">.</span><span class="ident" id="4252575">hashOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4252588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4252592">prevLength</span>&nbsp;<span class="op" id="4252603">:=</span>&nbsp;<span class="ident" id="4252606">d</span><span class="op" id="4252607">.</span><span class="ident" id="4252608">length</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4252617">prevOffset</span>&nbsp;<span class="op" id="4252628">:=</span>&nbsp;<span class="ident" id="4252631">d</span><span class="op" id="4252632">.</span><span class="ident" id="4252633">offset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4252642">d</span><span class="op" id="4252643">.</span><span class="ident" id="4252644">length</span>&nbsp;<span class="op" id="4252651">=</span>&nbsp;<span class="ident" id="4252653">minMatchLength</span>&nbsp;<span class="op" id="4252668">-</span>&nbsp;<span class="num" id="4252670">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4252674">d</span><span class="op" id="4252675">.</span><span class="ident" id="4252676">offset</span>&nbsp;<span class="op" id="4252683">=</span>&nbsp;<span class="num" id="4252685">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4252689">minIndex</span>&nbsp;<span class="op" id="4252698">:=</span>&nbsp;<span class="ident" id="4252701">d</span><span class="op" id="4252702">.</span><span class="ident" id="4252703">index</span>&nbsp;<span class="op" id="4252709">-</span>&nbsp;<span class="ident" id="4252711">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4252724">if</span>&nbsp;<span class="ident" id="4252727">minIndex</span>&nbsp;<span class="op" id="4252736">&lt;</span>&nbsp;<span class="num" id="4252738">0</span>&nbsp;<span class="op" id="4252740">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4252745">minIndex</span>&nbsp;<span class="op" id="4252754">=</span>&nbsp;<span class="num" id="4252756">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4252760">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4252765">if</span>&nbsp;<span class="ident" id="4252768">d</span><span class="op" id="4252769">.</span><span class="ident" id="4252770">chainHead</span><span class="op" id="4252779">-</span><span class="ident" id="4252780">d</span><span class="op" id="4252781">.</span><span class="ident" id="4252782">hashOffset</span>&nbsp;<span class="op" id="4252793">&gt;=</span>&nbsp;<span class="ident" id="4252796">minIndex</span>&nbsp;<span class="op" id="4252805">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4252811">(</span><span class="ident" id="4252812">d</span><span class="op" id="4252813">.</span><span class="ident" id="4252814">fastSkipHashing</span>&nbsp;<span class="op" id="4252830">!=</span>&nbsp;<span class="ident" id="4252833">skipNever</span>&nbsp;<span class="op" id="4252843">&amp;&amp;</span>&nbsp;<span class="ident" id="4252846">lookahead</span>&nbsp;<span class="op" id="4252856">&gt;</span>&nbsp;<span class="ident" id="4252858">minMatchLength</span><span class="op" id="4252872">-</span><span class="num" id="4252873">1</span>&nbsp;<span class="op" id="4252875">||</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4252882">d</span><span class="op" id="4252883">.</span><span class="ident" id="4252884">fastSkipHashing</span>&nbsp;<span class="op" id="4252900">==</span>&nbsp;<span class="ident" id="4252903">skipNever</span>&nbsp;<span class="op" id="4252913">&amp;&amp;</span>&nbsp;<span class="ident" id="4252916">lookahead</span>&nbsp;<span class="op" id="4252926">&gt;</span>&nbsp;<span class="ident" id="4252928">prevLength</span>&nbsp;<span class="op" id="4252939">&amp;&amp;</span>&nbsp;<span class="ident" id="4252942">prevLength</span>&nbsp;<span class="op" id="4252953">&lt;</span>&nbsp;<span class="ident" id="4252955">d</span><span class="op" id="4252956">.</span><span class="ident" id="4252957">lazy</span><span class="op" id="4252961">)</span>&nbsp;<span class="op" id="4252963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4252968">if</span>&nbsp;<span class="ident" id="4252971">newLength</span><span class="op" id="4252980">,</span>&nbsp;<span class="ident" id="4252982">newOffset</span><span class="op" id="4252991">,</span>&nbsp;<span class="ident" id="4252993">ok</span>&nbsp;<span class="op" id="4252996">:=</span>&nbsp;<span class="ident" id="4252999">d</span><span class="op" id="4253000">.</span><span class="ident" id="4253001">findMatch</span><span class="op" id="4253010">(</span><span class="ident" id="4253011">d</span><span class="op" id="4253012">.</span><span class="ident" id="4253013">index</span><span class="op" id="4253018">,</span>&nbsp;<span class="ident" id="4253020">d</span><span class="op" id="4253021">.</span><span class="ident" id="4253022">chainHead</span><span class="op" id="4253031">-</span><span class="ident" id="4253032">d</span><span class="op" id="4253033">.</span><span class="ident" id="4253034">hashOffset</span><span class="op" id="4253044">,</span>&nbsp;<span class="ident" id="4253046">minMatchLength</span><span class="op" id="4253060">-</span><span class="num" id="4253061">1</span><span class="op" id="4253062">,</span>&nbsp;<span class="ident" id="4253064">lookahead</span><span class="op" id="4253073">)</span><span class="op" id="4253074">;</span>&nbsp;<span class="ident" id="4253076">ok</span>&nbsp;<span class="op" id="4253079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4253085">d</span><span class="op" id="4253086">.</span><span class="ident" id="4253087">length</span>&nbsp;<span class="op" id="4253094">=</span>&nbsp;<span class="ident" id="4253096">newLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4253110">d</span><span class="op" id="4253111">.</span><span class="ident" id="4253112">offset</span>&nbsp;<span class="op" id="4253119">=</span>&nbsp;<span class="ident" id="4253121">newOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4253134">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4253138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4253142">if</span>&nbsp;<span class="ident" id="4253145">d</span><span class="op" id="4253146">.</span><span class="ident" id="4253147">fastSkipHashing</span>&nbsp;<span class="op" id="4253163">!=</span>&nbsp;<span class="ident" id="4253166">skipNever</span>&nbsp;<span class="op" id="4253176">&amp;&amp;</span>&nbsp;<span class="ident" id="4253179">d</span><span class="op" id="4253180">.</span><span class="ident" id="4253181">length</span>&nbsp;<span class="op" id="4253188">&gt;=</span>&nbsp;<span class="ident" id="4253191">minMatchLength</span>&nbsp;<span class="op" id="4253206">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4253212">d</span><span class="op" id="4253213">.</span><span class="ident" id="4253214">fastSkipHashing</span>&nbsp;<span class="op" id="4253230">==</span>&nbsp;<span class="ident" id="4253233">skipNever</span>&nbsp;<span class="op" id="4253243">&amp;&amp;</span>&nbsp;<span class="ident" id="4253246">prevLength</span>&nbsp;<span class="op" id="4253257">&gt;=</span>&nbsp;<span class="ident" id="4253260">minMatchLength</span>&nbsp;<span class="op" id="4253275">&amp;&amp;</span>&nbsp;<span class="ident" id="4253278">d</span><span class="op" id="4253279">.</span><span class="ident" id="4253280">length</span>&nbsp;<span class="op" id="4253287">&lt;=</span>&nbsp;<span class="ident" id="4253290">prevLength</span>&nbsp;<span class="op" id="4253301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4253306">//&nbsp;There&nbsp;was&nbsp;a&nbsp;match&nbsp;at&nbsp;the&nbsp;previous&nbsp;step,&nbsp;and&nbsp;the&nbsp;current&nbsp;match&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4253377">//&nbsp;not&nbsp;better.&nbsp;Output&nbsp;the&nbsp;previous&nbsp;match.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4253422">if</span>&nbsp;<span class="ident" id="4253425">d</span><span class="op" id="4253426">.</span><span class="ident" id="4253427">fastSkipHashing</span>&nbsp;<span class="op" id="4253443">!=</span>&nbsp;<span class="ident" id="4253446">skipNever</span>&nbsp;<span class="op" id="4253456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4253462">d</span><span class="op" id="4253463">.</span><span class="ident" id="4253464">tokens</span>&nbsp;<span class="op" id="4253471">=</span>&nbsp;<span class="builtinfunc" id="4253473">append</span><span class="op" id="4253479">(</span><span class="ident" id="4253480">d</span><span class="op" id="4253481">.</span><span class="ident" id="4253482">tokens</span><span class="op" id="4253488">,</span>&nbsp;<span class="ident" id="4253490">matchToken</span><span class="op" id="4253500">(</span><span class="builtintype" id="4253501">uint32</span><span class="op" id="4253507">(</span><span class="ident" id="4253508">d</span><span class="op" id="4253509">.</span><span class="ident" id="4253510">length</span><span class="op" id="4253516">-</span><span class="ident" id="4253517">minMatchLength</span><span class="op" id="4253531">)</span><span class="op" id="4253532">,</span>&nbsp;<span class="builtintype" id="4253534">uint32</span><span class="op" id="4253540">(</span><span class="ident" id="4253541">d</span><span class="op" id="4253542">.</span><span class="ident" id="4253543">offset</span><span class="op" id="4253549">-</span><span class="ident" id="4253550">minOffsetSize</span><span class="op" id="4253563">)</span><span class="op" id="4253564">)</span><span class="op" id="4253565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4253570">}</span>&nbsp;<span class="keyword" id="4253572">else</span>&nbsp;<span class="op" id="4253577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4253583">d</span><span class="op" id="4253584">.</span><span class="ident" id="4253585">tokens</span>&nbsp;<span class="op" id="4253592">=</span>&nbsp;<span class="builtinfunc" id="4253594">append</span><span class="op" id="4253600">(</span><span class="ident" id="4253601">d</span><span class="op" id="4253602">.</span><span class="ident" id="4253603">tokens</span><span class="op" id="4253609">,</span>&nbsp;<span class="ident" id="4253611">matchToken</span><span class="op" id="4253621">(</span><span class="builtintype" id="4253622">uint32</span><span class="op" id="4253628">(</span><span class="ident" id="4253629">prevLength</span><span class="op" id="4253639">-</span><span class="ident" id="4253640">minMatchLength</span><span class="op" id="4253654">)</span><span class="op" id="4253655">,</span>&nbsp;<span class="builtintype" id="4253657">uint32</span><span class="op" id="4253663">(</span><span class="ident" id="4253664">prevOffset</span><span class="op" id="4253674">-</span><span class="ident" id="4253675">minOffsetSize</span><span class="op" id="4253688">)</span><span class="op" id="4253689">)</span><span class="op" id="4253690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4253695">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4253700">//&nbsp;Insert&nbsp;in&nbsp;the&nbsp;hash&nbsp;table&nbsp;all&nbsp;strings&nbsp;up&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4253771">//&nbsp;index&nbsp;and&nbsp;index-1&nbsp;are&nbsp;already&nbsp;inserted.&nbsp;If&nbsp;there&nbsp;is&nbsp;not&nbsp;enough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4253840">//&nbsp;lookahead,&nbsp;the&nbsp;last&nbsp;two&nbsp;strings&nbsp;are&nbsp;not&nbsp;inserted&nbsp;into&nbsp;the&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4253909">//&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4253922">if</span>&nbsp;<span class="ident" id="4253925">d</span><span class="op" id="4253926">.</span><span class="ident" id="4253927">length</span>&nbsp;<span class="op" id="4253934">&lt;=</span>&nbsp;<span class="ident" id="4253937">d</span><span class="op" id="4253938">.</span><span class="ident" id="4253939">fastSkipHashing</span>&nbsp;<span class="op" id="4253955">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4253961">var</span>&nbsp;<span class="ident" id="4253965">newIndex</span>&nbsp;<span class="builtintype" id="4253974">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4253982">if</span>&nbsp;<span class="ident" id="4253985">d</span><span class="op" id="4253986">.</span><span class="ident" id="4253987">fastSkipHashing</span>&nbsp;<span class="op" id="4254003">!=</span>&nbsp;<span class="ident" id="4254006">skipNever</span>&nbsp;<span class="op" id="4254016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254023">newIndex</span>&nbsp;<span class="op" id="4254032">=</span>&nbsp;<span class="ident" id="4254034">d</span><span class="op" id="4254035">.</span><span class="ident" id="4254036">index</span>&nbsp;<span class="op" id="4254042">+</span>&nbsp;<span class="ident" id="4254044">d</span><span class="op" id="4254045">.</span><span class="ident" id="4254046">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4254057">}</span>&nbsp;<span class="keyword" id="4254059">else</span>&nbsp;<span class="op" id="4254064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254071">newIndex</span>&nbsp;<span class="op" id="4254080">=</span>&nbsp;<span class="ident" id="4254082">d</span><span class="op" id="4254083">.</span><span class="ident" id="4254084">index</span>&nbsp;<span class="op" id="4254090">+</span>&nbsp;<span class="ident" id="4254092">prevLength</span>&nbsp;<span class="op" id="4254103">-</span>&nbsp;<span class="num" id="4254105">1</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4254111">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4254117">for</span>&nbsp;<span class="ident" id="4254121">d</span><span class="op" id="4254122">.</span><span class="ident" id="4254123">index</span><span class="op" id="4254128">++</span><span class="op" id="4254130">;</span>&nbsp;<span class="ident" id="4254132">d</span><span class="op" id="4254133">.</span><span class="ident" id="4254134">index</span>&nbsp;<span class="op" id="4254140">&lt;</span>&nbsp;<span class="ident" id="4254142">newIndex</span><span class="op" id="4254150">;</span>&nbsp;<span class="ident" id="4254152">d</span><span class="op" id="4254153">.</span><span class="ident" id="4254154">index</span><span class="op" id="4254159">++</span>&nbsp;<span class="op" id="4254162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4254169">if</span>&nbsp;<span class="ident" id="4254172">d</span><span class="op" id="4254173">.</span><span class="ident" id="4254174">index</span>&nbsp;<span class="op" id="4254180">&lt;</span>&nbsp;<span class="ident" id="4254182">d</span><span class="op" id="4254183">.</span><span class="ident" id="4254184">maxInsertIndex</span>&nbsp;<span class="op" id="4254199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254207">d</span><span class="op" id="4254208">.</span><span class="ident" id="4254209">hash</span>&nbsp;<span class="op" id="4254214">=</span>&nbsp;<span class="op" id="4254216">(</span><span class="ident" id="4254217">d</span><span class="op" id="4254218">.</span><span class="ident" id="4254219">hash</span><span class="op" id="4254223">&lt;&lt;</span><span class="ident" id="4254225">hashShift</span>&nbsp;<span class="op" id="4254235">+</span>&nbsp;<span class="builtintype" id="4254237">int</span><span class="op" id="4254240">(</span><span class="ident" id="4254241">d</span><span class="op" id="4254242">.</span><span class="ident" id="4254243">window</span><span class="op" id="4254249">[</span><span class="ident" id="4254250">d</span><span class="op" id="4254251">.</span><span class="ident" id="4254252">index</span><span class="op" id="4254257">+</span><span class="num" id="4254258">2</span><span class="op" id="4254259">]</span><span class="op" id="4254260">)</span><span class="op" id="4254261">)</span>&nbsp;<span class="op" id="4254263">&amp;</span>&nbsp;<span class="ident" id="4254265">hashMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4254280">//&nbsp;Get&nbsp;previous&nbsp;value&nbsp;with&nbsp;the&nbsp;same&nbsp;hash.</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4254328">//&nbsp;Our&nbsp;chain&nbsp;should&nbsp;point&nbsp;to&nbsp;the&nbsp;previous&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254383">d</span><span class="op" id="4254384">.</span><span class="ident" id="4254385">hashPrev</span><span class="op" id="4254393">[</span><span class="ident" id="4254394">d</span><span class="op" id="4254395">.</span><span class="ident" id="4254396">index</span><span class="op" id="4254401">&amp;</span><span class="ident" id="4254402">windowMask</span><span class="op" id="4254412">]</span>&nbsp;<span class="op" id="4254414">=</span>&nbsp;<span class="ident" id="4254416">d</span><span class="op" id="4254417">.</span><span class="ident" id="4254418">hashHead</span><span class="op" id="4254426">[</span><span class="ident" id="4254427">d</span><span class="op" id="4254428">.</span><span class="ident" id="4254429">hash</span><span class="op" id="4254433">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4254441">//&nbsp;Set&nbsp;the&nbsp;head&nbsp;of&nbsp;the&nbsp;hash&nbsp;chain&nbsp;to&nbsp;us.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254488">d</span><span class="op" id="4254489">.</span><span class="ident" id="4254490">hashHead</span><span class="op" id="4254498">[</span><span class="ident" id="4254499">d</span><span class="op" id="4254500">.</span><span class="ident" id="4254501">hash</span><span class="op" id="4254505">]</span>&nbsp;<span class="op" id="4254507">=</span>&nbsp;<span class="ident" id="4254509">d</span><span class="op" id="4254510">.</span><span class="ident" id="4254511">index</span>&nbsp;<span class="op" id="4254517">+</span>&nbsp;<span class="ident" id="4254519">d</span><span class="op" id="4254520">.</span><span class="ident" id="4254521">hashOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4254537">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4254543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4254549">if</span>&nbsp;<span class="ident" id="4254552">d</span><span class="op" id="4254553">.</span><span class="ident" id="4254554">fastSkipHashing</span>&nbsp;<span class="op" id="4254570">==</span>&nbsp;<span class="ident" id="4254573">skipNever</span>&nbsp;<span class="op" id="4254583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254590">d</span><span class="op" id="4254591">.</span><span class="ident" id="4254592">byteAvailable</span>&nbsp;<span class="op" id="4254606">=</span>&nbsp;<span class="builtintype" id="4254608">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254619">d</span><span class="op" id="4254620">.</span><span class="ident" id="4254621">length</span>&nbsp;<span class="op" id="4254628">=</span>&nbsp;<span class="ident" id="4254630">minMatchLength</span>&nbsp;<span class="op" id="4254645">-</span>&nbsp;<span class="num" id="4254647">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4254653">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4254658">}</span>&nbsp;<span class="keyword" id="4254660">else</span>&nbsp;<span class="op" id="4254665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4254671">//&nbsp;For&nbsp;matches&nbsp;this&nbsp;long,&nbsp;we&nbsp;don&#39;t&nbsp;bother&nbsp;inserting&nbsp;each&nbsp;individual</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4254743">//&nbsp;item&nbsp;into&nbsp;the&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254771">d</span><span class="op" id="4254772">.</span><span class="ident" id="4254773">index</span>&nbsp;<span class="op" id="4254779">+=</span>&nbsp;<span class="ident" id="4254782">d</span><span class="op" id="4254783">.</span><span class="ident" id="4254784">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4254795">if</span>&nbsp;<span class="ident" id="4254798">d</span><span class="op" id="4254799">.</span><span class="ident" id="4254800">index</span>&nbsp;<span class="op" id="4254806">&lt;</span>&nbsp;<span class="ident" id="4254808">d</span><span class="op" id="4254809">.</span><span class="ident" id="4254810">maxInsertIndex</span>&nbsp;<span class="op" id="4254825">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254832">d</span><span class="op" id="4254833">.</span><span class="ident" id="4254834">hash</span>&nbsp;<span class="op" id="4254839">=</span>&nbsp;<span class="op" id="4254841">(</span><span class="builtintype" id="4254842">int</span><span class="op" id="4254845">(</span><span class="ident" id="4254846">d</span><span class="op" id="4254847">.</span><span class="ident" id="4254848">window</span><span class="op" id="4254854">[</span><span class="ident" id="4254855">d</span><span class="op" id="4254856">.</span><span class="ident" id="4254857">index</span><span class="op" id="4254862">]</span><span class="op" id="4254863">)</span><span class="op" id="4254864">&lt;&lt;</span><span class="ident" id="4254866">hashShift</span>&nbsp;<span class="op" id="4254876">+</span>&nbsp;<span class="builtintype" id="4254878">int</span><span class="op" id="4254881">(</span><span class="ident" id="4254882">d</span><span class="op" id="4254883">.</span><span class="ident" id="4254884">window</span><span class="op" id="4254890">[</span><span class="ident" id="4254891">d</span><span class="op" id="4254892">.</span><span class="ident" id="4254893">index</span><span class="op" id="4254898">+</span><span class="num" id="4254899">1</span><span class="op" id="4254900">]</span><span class="op" id="4254901">)</span><span class="op" id="4254902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4254908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4254913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4254918">if</span>&nbsp;<span class="builtinfunc" id="4254921">len</span><span class="op" id="4254924">(</span><span class="ident" id="4254925">d</span><span class="op" id="4254926">.</span><span class="ident" id="4254927">tokens</span><span class="op" id="4254933">)</span>&nbsp;<span class="op" id="4254935">==</span>&nbsp;<span class="ident" id="4254938">maxFlateBlockTokens</span>&nbsp;<span class="op" id="4254958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4254964">//&nbsp;The&nbsp;block&nbsp;includes&nbsp;the&nbsp;current&nbsp;character</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255012">if</span>&nbsp;<span class="ident" id="4255015">d</span><span class="op" id="4255016">.</span><span class="ident" id="4255017">err</span>&nbsp;<span class="op" id="4255021">=</span>&nbsp;<span class="ident" id="4255023">d</span><span class="op" id="4255024">.</span><span class="ident" id="4255025">writeBlock</span><span class="op" id="4255035">(</span><span class="ident" id="4255036">d</span><span class="op" id="4255037">.</span><span class="ident" id="4255038">tokens</span><span class="op" id="4255044">,</span>&nbsp;<span class="ident" id="4255046">d</span><span class="op" id="4255047">.</span><span class="ident" id="4255048">index</span><span class="op" id="4255053">,</span>&nbsp;<span class="builtintype" id="4255055">false</span><span class="op" id="4255060">)</span><span class="op" id="4255061">;</span>&nbsp;<span class="ident" id="4255063">d</span><span class="op" id="4255064">.</span><span class="ident" id="4255065">err</span>&nbsp;<span class="op" id="4255069">!=</span>&nbsp;<span class="ident" id="4255072">nil</span>&nbsp;<span class="op" id="4255076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255083">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4255094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255100">d</span><span class="op" id="4255101">.</span><span class="ident" id="4255102">tokens</span>&nbsp;<span class="op" id="4255109">=</span>&nbsp;<span class="ident" id="4255111">d</span><span class="op" id="4255112">.</span><span class="ident" id="4255113">tokens</span><span class="op" id="4255119">[</span><span class="op" id="4255120">:</span><span class="num" id="4255121">0</span><span class="op" id="4255122">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4255127">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4255131">}</span>&nbsp;<span class="keyword" id="4255133">else</span>&nbsp;<span class="op" id="4255138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255143">if</span>&nbsp;<span class="ident" id="4255146">d</span><span class="op" id="4255147">.</span><span class="ident" id="4255148">fastSkipHashing</span>&nbsp;<span class="op" id="4255164">!=</span>&nbsp;<span class="ident" id="4255167">skipNever</span>&nbsp;<span class="op" id="4255177">||</span>&nbsp;<span class="ident" id="4255180">d</span><span class="op" id="4255181">.</span><span class="ident" id="4255182">byteAvailable</span>&nbsp;<span class="op" id="4255196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255202">i</span>&nbsp;<span class="op" id="4255204">:=</span>&nbsp;<span class="ident" id="4255207">d</span><span class="op" id="4255208">.</span><span class="ident" id="4255209">index</span>&nbsp;<span class="op" id="4255215">-</span>&nbsp;<span class="num" id="4255217">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255223">if</span>&nbsp;<span class="ident" id="4255226">d</span><span class="op" id="4255227">.</span><span class="ident" id="4255228">fastSkipHashing</span>&nbsp;<span class="op" id="4255244">!=</span>&nbsp;<span class="ident" id="4255247">skipNever</span>&nbsp;<span class="op" id="4255257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255264">i</span>&nbsp;<span class="op" id="4255266">=</span>&nbsp;<span class="ident" id="4255268">d</span><span class="op" id="4255269">.</span><span class="ident" id="4255270">index</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4255280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255286">d</span><span class="op" id="4255287">.</span><span class="ident" id="4255288">tokens</span>&nbsp;<span class="op" id="4255295">=</span>&nbsp;<span class="builtinfunc" id="4255297">append</span><span class="op" id="4255303">(</span><span class="ident" id="4255304">d</span><span class="op" id="4255305">.</span><span class="ident" id="4255306">tokens</span><span class="op" id="4255312">,</span>&nbsp;<span class="ident" id="4255314">literalToken</span><span class="op" id="4255326">(</span><span class="builtintype" id="4255327">uint32</span><span class="op" id="4255333">(</span><span class="ident" id="4255334">d</span><span class="op" id="4255335">.</span><span class="ident" id="4255336">window</span><span class="op" id="4255342">[</span><span class="ident" id="4255343">i</span><span class="op" id="4255344">]</span><span class="op" id="4255345">)</span><span class="op" id="4255346">)</span><span class="op" id="4255347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255353">if</span>&nbsp;<span class="builtinfunc" id="4255356">len</span><span class="op" id="4255359">(</span><span class="ident" id="4255360">d</span><span class="op" id="4255361">.</span><span class="ident" id="4255362">tokens</span><span class="op" id="4255368">)</span>&nbsp;<span class="op" id="4255370">==</span>&nbsp;<span class="ident" id="4255373">maxFlateBlockTokens</span>&nbsp;<span class="op" id="4255393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255400">if</span>&nbsp;<span class="ident" id="4255403">d</span><span class="op" id="4255404">.</span><span class="ident" id="4255405">err</span>&nbsp;<span class="op" id="4255409">=</span>&nbsp;<span class="ident" id="4255411">d</span><span class="op" id="4255412">.</span><span class="ident" id="4255413">writeBlock</span><span class="op" id="4255423">(</span><span class="ident" id="4255424">d</span><span class="op" id="4255425">.</span><span class="ident" id="4255426">tokens</span><span class="op" id="4255432">,</span>&nbsp;<span class="ident" id="4255434">i</span><span class="op" id="4255435">+</span><span class="num" id="4255436">1</span><span class="op" id="4255437">,</span>&nbsp;<span class="builtintype" id="4255439">false</span><span class="op" id="4255444">)</span><span class="op" id="4255445">;</span>&nbsp;<span class="ident" id="4255447">d</span><span class="op" id="4255448">.</span><span class="ident" id="4255449">err</span>&nbsp;<span class="op" id="4255453">!=</span>&nbsp;<span class="ident" id="4255456">nil</span>&nbsp;<span class="op" id="4255460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255468">return</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4255480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255487">d</span><span class="op" id="4255488">.</span><span class="ident" id="4255489">tokens</span>&nbsp;<span class="op" id="4255496">=</span>&nbsp;<span class="ident" id="4255498">d</span><span class="op" id="4255499">.</span><span class="ident" id="4255500">tokens</span><span class="op" id="4255506">[</span><span class="op" id="4255507">:</span><span class="num" id="4255508">0</span><span class="op" id="4255509">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4255515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4255520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255525">d</span><span class="op" id="4255526">.</span><span class="ident" id="4255527">index</span><span class="op" id="4255532">++</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255538">if</span>&nbsp;<span class="ident" id="4255541">d</span><span class="op" id="4255542">.</span><span class="ident" id="4255543">fastSkipHashing</span>&nbsp;<span class="op" id="4255559">==</span>&nbsp;<span class="ident" id="4255562">skipNever</span>&nbsp;<span class="op" id="4255572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255578">d</span><span class="op" id="4255579">.</span><span class="ident" id="4255580">byteAvailable</span>&nbsp;<span class="op" id="4255594">=</span>&nbsp;<span class="builtintype" id="4255596">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4255604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4255608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4255611">}</span><br>
<span class="lineno">360</span><span class="op" id="4255613">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4255616">func</span>&nbsp;<span class="op" id="4255621">(</span><span class="ident" id="4255622">d</span>&nbsp;<span class="op" id="4255624">*</span><span class="ident" id="4255625">compressor</span><span class="op" id="4255635">)</span>&nbsp;<span class="ident" id="4255637">fillStore</span><span class="op" id="4255646">(</span><span class="ident" id="4255647">b</span>&nbsp;<span class="op" id="4255649">[</span><span class="op" id="4255650">]</span><span class="builtintype" id="4255651">byte</span><span class="op" id="4255655">)</span>&nbsp;<span class="builtintype" id="4255657">int</span>&nbsp;<span class="op" id="4255661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255664">n</span>&nbsp;<span class="op" id="4255666">:=</span>&nbsp;<span class="builtinfunc" id="4255669">copy</span><span class="op" id="4255673">(</span><span class="ident" id="4255674">d</span><span class="op" id="4255675">.</span><span class="ident" id="4255676">window</span><span class="op" id="4255682">[</span><span class="ident" id="4255683">d</span><span class="op" id="4255684">.</span><span class="ident" id="4255685">windowEnd</span><span class="op" id="4255694">:</span><span class="op" id="4255695">]</span><span class="op" id="4255696">,</span>&nbsp;<span class="ident" id="4255698">b</span><span class="op" id="4255699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255702">d</span><span class="op" id="4255703">.</span><span class="ident" id="4255704">windowEnd</span>&nbsp;<span class="op" id="4255714">+=</span>&nbsp;<span class="ident" id="4255717">n</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255720">return</span>&nbsp;<span class="ident" id="4255727">n</span><br>
<span class="lineno"></span><span class="op" id="4255729">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4255732">func</span>&nbsp;<span class="op" id="4255737">(</span><span class="ident" id="4255738">d</span>&nbsp;<span class="op" id="4255740">*</span><span class="ident" id="4255741">compressor</span><span class="op" id="4255751">)</span>&nbsp;<span class="ident" id="4255753">store</span><span class="op" id="4255758">(</span><span class="op" id="4255759">)</span>&nbsp;<span class="op" id="4255761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255764">if</span>&nbsp;<span class="ident" id="4255767">d</span><span class="op" id="4255768">.</span><span class="ident" id="4255769">windowEnd</span>&nbsp;<span class="op" id="4255779">&gt;</span>&nbsp;<span class="num" id="4255781">0</span>&nbsp;<span class="op" id="4255783">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255787">d</span><span class="op" id="4255788">.</span><span class="ident" id="4255789">err</span>&nbsp;<span class="op" id="4255793">=</span>&nbsp;<span class="ident" id="4255795">d</span><span class="op" id="4255796">.</span><span class="ident" id="4255797">writeStoredBlock</span><span class="op" id="4255813">(</span><span class="ident" id="4255814">d</span><span class="op" id="4255815">.</span><span class="ident" id="4255816">window</span><span class="op" id="4255822">[</span><span class="op" id="4255823">:</span><span class="ident" id="4255824">d</span><span class="op" id="4255825">.</span><span class="ident" id="4255826">windowEnd</span><span class="op" id="4255835">]</span><span class="op" id="4255836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4255839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255842">d</span><span class="op" id="4255843">.</span><span class="ident" id="4255844">windowEnd</span>&nbsp;<span class="op" id="4255854">=</span>&nbsp;<span class="num" id="4255856">0</span><br>
<span class="lineno"></span><span class="op" id="4255858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span><span class="keyword" id="4255861">func</span>&nbsp;<span class="op" id="4255866">(</span><span class="ident" id="4255867">d</span>&nbsp;<span class="op" id="4255869">*</span><span class="ident" id="4255870">compressor</span><span class="op" id="4255880">)</span>&nbsp;<span class="ident" id="4255882">write</span><span class="op" id="4255887">(</span><span class="ident" id="4255888">b</span>&nbsp;<span class="op" id="4255890">[</span><span class="op" id="4255891">]</span><span class="builtintype" id="4255892">byte</span><span class="op" id="4255896">)</span>&nbsp;<span class="op" id="4255898">(</span><span class="ident" id="4255899">n</span>&nbsp;<span class="builtintype" id="4255901">int</span><span class="op" id="4255904">,</span>&nbsp;<span class="ident" id="4255906">err</span>&nbsp;<span class="builtintype" id="4255910">error</span><span class="op" id="4255915">)</span>&nbsp;<span class="op" id="4255917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255920">n</span>&nbsp;<span class="op" id="4255922">=</span>&nbsp;<span class="builtinfunc" id="4255924">len</span><span class="op" id="4255927">(</span><span class="ident" id="4255928">b</span><span class="op" id="4255929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255932">b</span>&nbsp;<span class="op" id="4255934">=</span>&nbsp;<span class="ident" id="4255936">b</span><span class="op" id="4255937">[</span><span class="ident" id="4255938">d</span><span class="op" id="4255939">.</span><span class="ident" id="4255940">fill</span><span class="op" id="4255944">(</span><span class="ident" id="4255945">d</span><span class="op" id="4255946">,</span>&nbsp;<span class="ident" id="4255948">b</span><span class="op" id="4255949">)</span><span class="op" id="4255950">:</span><span class="op" id="4255951">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255954">for</span>&nbsp;<span class="builtinfunc" id="4255958">len</span><span class="op" id="4255961">(</span><span class="ident" id="4255962">b</span><span class="op" id="4255963">)</span>&nbsp;<span class="op" id="4255965">&gt;</span>&nbsp;<span class="num" id="4255967">0</span>&nbsp;<span class="op" id="4255969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255973">d</span><span class="op" id="4255974">.</span><span class="ident" id="4255975">step</span><span class="op" id="4255979">(</span><span class="ident" id="4255980">d</span><span class="op" id="4255981">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255985">b</span>&nbsp;<span class="op" id="4255987">=</span>&nbsp;<span class="ident" id="4255989">b</span><span class="op" id="4255990">[</span><span class="ident" id="4255991">d</span><span class="op" id="4255992">.</span><span class="ident" id="4255993">fill</span><span class="op" id="4255997">(</span><span class="ident" id="4255998">d</span><span class="op" id="4255999">,</span>&nbsp;<span class="ident" id="4256001">b</span><span class="op" id="4256002">)</span><span class="op" id="4256003">:</span><span class="op" id="4256004">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4256007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256010">return</span>&nbsp;<span class="ident" id="4256017">n</span><span class="op" id="4256018">,</span>&nbsp;<span class="ident" id="4256020">d</span><span class="op" id="4256021">.</span><span class="ident" id="4256022">err</span><br>
<span class="lineno"></span><span class="op" id="4256026">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span><span class="keyword" id="4256029">func</span>&nbsp;<span class="op" id="4256034">(</span><span class="ident" id="4256035">d</span>&nbsp;<span class="op" id="4256037">*</span><span class="ident" id="4256038">compressor</span><span class="op" id="4256048">)</span>&nbsp;<span class="ident" id="4256050">syncFlush</span><span class="op" id="4256059">(</span><span class="op" id="4256060">)</span>&nbsp;<span class="builtintype" id="4256062">error</span>&nbsp;<span class="op" id="4256068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256071">d</span><span class="op" id="4256072">.</span><span class="ident" id="4256073">sync</span>&nbsp;<span class="op" id="4256078">=</span>&nbsp;<span class="builtintype" id="4256080">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256086">d</span><span class="op" id="4256087">.</span><span class="ident" id="4256088">step</span><span class="op" id="4256092">(</span><span class="ident" id="4256093">d</span><span class="op" id="4256094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256097">if</span>&nbsp;<span class="ident" id="4256100">d</span><span class="op" id="4256101">.</span><span class="ident" id="4256102">err</span>&nbsp;<span class="op" id="4256106">==</span>&nbsp;<span class="ident" id="4256109">nil</span>&nbsp;<span class="op" id="4256113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256117">d</span><span class="op" id="4256118">.</span><span class="ident" id="4256119">w</span><span class="op" id="4256120">.</span><span class="ident" id="4256121">writeStoredHeader</span><span class="op" id="4256138">(</span><span class="num" id="4256139">0</span><span class="op" id="4256140">,</span>&nbsp;<span class="builtintype" id="4256142">false</span><span class="op" id="4256147">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256151">d</span><span class="op" id="4256152">.</span><span class="ident" id="4256153">w</span><span class="op" id="4256154">.</span><span class="ident" id="4256155">flush</span><span class="op" id="4256160">(</span><span class="op" id="4256161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256165">d</span><span class="op" id="4256166">.</span><span class="ident" id="4256167">err</span>&nbsp;<span class="op" id="4256171">=</span>&nbsp;<span class="ident" id="4256173">d</span><span class="op" id="4256174">.</span><span class="ident" id="4256175">w</span><span class="op" id="4256176">.</span><span class="ident" id="4256177">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4256182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256185">d</span><span class="op" id="4256186">.</span><span class="ident" id="4256187">sync</span>&nbsp;<span class="op" id="4256192">=</span>&nbsp;<span class="builtintype" id="4256194">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256201">return</span>&nbsp;<span class="ident" id="4256208">d</span><span class="op" id="4256209">.</span><span class="ident" id="4256210">err</span><br>
<span class="lineno">395</span><span class="op" id="4256214">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4256217">func</span>&nbsp;<span class="op" id="4256222">(</span><span class="ident" id="4256223">d</span>&nbsp;<span class="op" id="4256225">*</span><span class="ident" id="4256226">compressor</span><span class="op" id="4256236">)</span>&nbsp;<span class="ident" id="4256238">init</span><span class="op" id="4256242">(</span><span class="ident" id="4256243">w</span>&nbsp;<span class="ident" id="4256245">io</span><span class="op" id="4256247">.</span><span class="ident" id="4256248">Writer</span><span class="op" id="4256254">,</span>&nbsp;<span class="ident" id="4256256">level</span>&nbsp;<span class="builtintype" id="4256262">int</span><span class="op" id="4256265">)</span>&nbsp;<span class="op" id="4256267">(</span><span class="ident" id="4256268">err</span>&nbsp;<span class="builtintype" id="4256272">error</span><span class="op" id="4256277">)</span>&nbsp;<span class="op" id="4256279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256282">d</span><span class="op" id="4256283">.</span><span class="ident" id="4256284">w</span>&nbsp;<span class="op" id="4256286">=</span>&nbsp;<span class="ident" id="4256288">newHuffmanBitWriter</span><span class="op" id="4256307">(</span><span class="ident" id="4256308">w</span><span class="op" id="4256309">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256313">switch</span>&nbsp;<span class="op" id="4256320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256323">case</span>&nbsp;<span class="ident" id="4256328">level</span>&nbsp;<span class="op" id="4256334">==</span>&nbsp;<span class="ident" id="4256337">NoCompression</span><span class="op" id="4256350">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256354">d</span><span class="op" id="4256355">.</span><span class="ident" id="4256356">window</span>&nbsp;<span class="op" id="4256363">=</span>&nbsp;<span class="builtinfunc" id="4256365">make</span><span class="op" id="4256369">(</span><span class="op" id="4256370">[</span><span class="op" id="4256371">]</span><span class="builtintype" id="4256372">byte</span><span class="op" id="4256376">,</span>&nbsp;<span class="ident" id="4256378">maxStoreBlockSize</span><span class="op" id="4256395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256399">d</span><span class="op" id="4256400">.</span><span class="ident" id="4256401">fill</span>&nbsp;<span class="op" id="4256406">=</span>&nbsp;<span class="op" id="4256408">(</span><span class="op" id="4256409">*</span><span class="ident" id="4256410">compressor</span><span class="op" id="4256420">)</span><span class="op" id="4256421">.</span><span class="ident" id="4256422">fillStore</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256434">d</span><span class="op" id="4256435">.</span><span class="ident" id="4256436">step</span>&nbsp;<span class="op" id="4256441">=</span>&nbsp;<span class="op" id="4256443">(</span><span class="op" id="4256444">*</span><span class="ident" id="4256445">compressor</span><span class="op" id="4256455">)</span><span class="op" id="4256456">.</span><span class="ident" id="4256457">store</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256464">case</span>&nbsp;<span class="ident" id="4256469">level</span>&nbsp;<span class="op" id="4256475">==</span>&nbsp;<span class="ident" id="4256478">DefaultCompression</span><span class="op" id="4256496">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256500">level</span>&nbsp;<span class="op" id="4256506">=</span>&nbsp;<span class="num" id="4256508">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256512">fallthrough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256525">case</span>&nbsp;<span class="num" id="4256530">1</span>&nbsp;<span class="op" id="4256532">&lt;=</span>&nbsp;<span class="ident" id="4256535">level</span>&nbsp;<span class="op" id="4256541">&amp;&amp;</span>&nbsp;<span class="ident" id="4256544">level</span>&nbsp;<span class="op" id="4256550">&lt;=</span>&nbsp;<span class="num" id="4256553">9</span><span class="op" id="4256554">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256558">d</span><span class="op" id="4256559">.</span><span class="ident" id="4256560">compressionLevel</span>&nbsp;<span class="op" id="4256577">=</span>&nbsp;<span class="ident" id="4256579">levels</span><span class="op" id="4256585">[</span><span class="ident" id="4256586">level</span><span class="op" id="4256591">]</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256595">d</span><span class="op" id="4256596">.</span><span class="ident" id="4256597">initDeflate</span><span class="op" id="4256608">(</span><span class="op" id="4256609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256613">d</span><span class="op" id="4256614">.</span><span class="ident" id="4256615">fill</span>&nbsp;<span class="op" id="4256620">=</span>&nbsp;<span class="op" id="4256622">(</span><span class="op" id="4256623">*</span><span class="ident" id="4256624">compressor</span><span class="op" id="4256634">)</span><span class="op" id="4256635">.</span><span class="ident" id="4256636">fillDeflate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256650">d</span><span class="op" id="4256651">.</span><span class="ident" id="4256652">step</span>&nbsp;<span class="op" id="4256657">=</span>&nbsp;<span class="op" id="4256659">(</span><span class="op" id="4256660">*</span><span class="ident" id="4256661">compressor</span><span class="op" id="4256671">)</span><span class="op" id="4256672">.</span><span class="ident" id="4256673">deflate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256682">default</span><span class="op" id="4256689">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256693">return</span>&nbsp;<span class="ident" id="4256700">fmt</span><span class="op" id="4256703">.</span><span class="ident" id="4256704">Errorf</span><span class="op" id="4256710">(</span><span class="string" id="4256711">&#34;flate:&nbsp;invalid&nbsp;compression&nbsp;level&nbsp;%d:&nbsp;want&nbsp;value&nbsp;in&nbsp;range&nbsp;[-1,&nbsp;9]&#34;</span><span class="op" id="4256777">,</span>&nbsp;<span class="ident" id="4256779">level</span><span class="op" id="4256784">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4256787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256790">return</span>&nbsp;<span class="ident" id="4256797">nil</span><br>
<span class="lineno"></span><span class="op" id="4256801">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4256804">var</span>&nbsp;<span class="ident" id="4256808">zeroes</span>&nbsp;<span class="op" id="4256815">[</span><span class="num" id="4256816">32</span><span class="op" id="4256818">]</span><span class="builtintype" id="4256819">int</span><br>
<span class="lineno">420</span><span class="keyword" id="4256823">var</span>&nbsp;<span class="ident" id="4256827">bzeroes</span>&nbsp;<span class="op" id="4256835">[</span><span class="num" id="4256836">256</span><span class="op" id="4256839">]</span><span class="builtintype" id="4256840">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4256846">func</span>&nbsp;<span class="op" id="4256851">(</span><span class="ident" id="4256852">d</span>&nbsp;<span class="op" id="4256854">*</span><span class="ident" id="4256855">compressor</span><span class="op" id="4256865">)</span>&nbsp;<span class="ident" id="4256867">reset</span><span class="op" id="4256872">(</span><span class="ident" id="4256873">w</span>&nbsp;<span class="ident" id="4256875">io</span><span class="op" id="4256877">.</span><span class="ident" id="4256878">Writer</span><span class="op" id="4256884">)</span>&nbsp;<span class="op" id="4256886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256889">d</span><span class="op" id="4256890">.</span><span class="ident" id="4256891">w</span><span class="op" id="4256892">.</span><span class="ident" id="4256893">reset</span><span class="op" id="4256898">(</span><span class="ident" id="4256899">w</span><span class="op" id="4256900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256903">d</span><span class="op" id="4256904">.</span><span class="ident" id="4256905">sync</span>&nbsp;<span class="op" id="4256910">=</span>&nbsp;<span class="builtintype" id="4256912">false</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256919">d</span><span class="op" id="4256920">.</span><span class="ident" id="4256921">err</span>&nbsp;<span class="op" id="4256925">=</span>&nbsp;<span class="ident" id="4256927">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256932">switch</span>&nbsp;<span class="ident" id="4256939">d</span><span class="op" id="4256940">.</span><span class="ident" id="4256941">compressionLevel</span><span class="op" id="4256957">.</span><span class="ident" id="4256958">chain</span>&nbsp;<span class="op" id="4256964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256967">case</span>&nbsp;<span class="num" id="4256972">0</span><span class="op" id="4256973">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4256977">//&nbsp;level&nbsp;was&nbsp;NoCompression.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4257007">for</span>&nbsp;<span class="ident" id="4257011">i</span>&nbsp;<span class="op" id="4257013">:=</span>&nbsp;<span class="keyword" id="4257016">range</span>&nbsp;<span class="ident" id="4257022">d</span><span class="op" id="4257023">.</span><span class="ident" id="4257024">window</span>&nbsp;<span class="op" id="4257031">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257036">d</span><span class="op" id="4257037">.</span><span class="ident" id="4257038">window</span><span class="op" id="4257044">[</span><span class="ident" id="4257045">i</span><span class="op" id="4257046">]</span>&nbsp;<span class="op" id="4257048">=</span>&nbsp;<span class="num" id="4257050">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4257054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257058">d</span><span class="op" id="4257059">.</span><span class="ident" id="4257060">windowEnd</span>&nbsp;<span class="op" id="4257070">=</span>&nbsp;<span class="num" id="4257072">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4257075">default</span><span class="op" id="4257082">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257086">d</span><span class="op" id="4257087">.</span><span class="ident" id="4257088">chainHead</span>&nbsp;<span class="op" id="4257098">=</span>&nbsp;<span class="op" id="4257100">-</span><span class="num" id="4257101">1</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4257105">for</span>&nbsp;<span class="ident" id="4257109">s</span>&nbsp;<span class="op" id="4257111">:=</span>&nbsp;<span class="ident" id="4257114">d</span><span class="op" id="4257115">.</span><span class="ident" id="4257116">hashHead</span><span class="op" id="4257124">;</span>&nbsp;<span class="builtinfunc" id="4257126">len</span><span class="op" id="4257129">(</span><span class="ident" id="4257130">s</span><span class="op" id="4257131">)</span>&nbsp;<span class="op" id="4257133">&gt;</span>&nbsp;<span class="num" id="4257135">0</span><span class="op" id="4257136">;</span>&nbsp;<span class="op" id="4257138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257143">n</span>&nbsp;<span class="op" id="4257145">:=</span>&nbsp;<span class="builtinfunc" id="4257148">copy</span><span class="op" id="4257152">(</span><span class="ident" id="4257153">s</span><span class="op" id="4257154">,</span>&nbsp;<span class="ident" id="4257156">zeroes</span><span class="op" id="4257162">[</span><span class="op" id="4257163">:</span><span class="op" id="4257164">]</span><span class="op" id="4257165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257170">s</span>&nbsp;<span class="op" id="4257172">=</span>&nbsp;<span class="ident" id="4257174">s</span><span class="op" id="4257175">[</span><span class="ident" id="4257176">n</span><span class="op" id="4257177">:</span><span class="op" id="4257178">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4257182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4257186">for</span>&nbsp;<span class="ident" id="4257190">s</span>&nbsp;<span class="op" id="4257192">:=</span>&nbsp;<span class="ident" id="4257195">d</span><span class="op" id="4257196">.</span><span class="ident" id="4257197">hashPrev</span><span class="op" id="4257205">;</span>&nbsp;<span class="builtinfunc" id="4257207">len</span><span class="op" id="4257210">(</span><span class="ident" id="4257211">s</span><span class="op" id="4257212">)</span>&nbsp;<span class="op" id="4257214">&gt;</span>&nbsp;<span class="num" id="4257216">0</span><span class="op" id="4257217">;</span>&nbsp;<span class="ident" id="4257219">s</span>&nbsp;<span class="op" id="4257221">=</span>&nbsp;<span class="ident" id="4257223">s</span><span class="op" id="4257224">[</span><span class="builtinfunc" id="4257225">len</span><span class="op" id="4257228">(</span><span class="ident" id="4257229">zeroes</span><span class="op" id="4257235">)</span><span class="op" id="4257236">:</span><span class="op" id="4257237">]</span>&nbsp;<span class="op" id="4257239">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4257244">copy</span><span class="op" id="4257248">(</span><span class="ident" id="4257249">s</span><span class="op" id="4257250">,</span>&nbsp;<span class="ident" id="4257252">zeroes</span><span class="op" id="4257258">[</span><span class="op" id="4257259">:</span><span class="op" id="4257260">]</span><span class="op" id="4257261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4257265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257269">d</span><span class="op" id="4257270">.</span><span class="ident" id="4257271">hashOffset</span>&nbsp;<span class="op" id="4257282">=</span>&nbsp;<span class="num" id="4257284">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257289">d</span><span class="op" id="4257290">.</span><span class="ident" id="4257291">index</span><span class="op" id="4257296">,</span>&nbsp;<span class="ident" id="4257298">d</span><span class="op" id="4257299">.</span><span class="ident" id="4257300">windowEnd</span>&nbsp;<span class="op" id="4257310">=</span>&nbsp;<span class="num" id="4257312">0</span><span class="op" id="4257313">,</span>&nbsp;<span class="num" id="4257315">0</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4257319">for</span>&nbsp;<span class="ident" id="4257323">s</span>&nbsp;<span class="op" id="4257325">:=</span>&nbsp;<span class="ident" id="4257328">d</span><span class="op" id="4257329">.</span><span class="ident" id="4257330">window</span><span class="op" id="4257336">;</span>&nbsp;<span class="builtinfunc" id="4257338">len</span><span class="op" id="4257341">(</span><span class="ident" id="4257342">s</span><span class="op" id="4257343">)</span>&nbsp;<span class="op" id="4257345">&gt;</span>&nbsp;<span class="num" id="4257347">0</span><span class="op" id="4257348">;</span>&nbsp;<span class="op" id="4257350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257355">n</span>&nbsp;<span class="op" id="4257357">:=</span>&nbsp;<span class="builtinfunc" id="4257360">copy</span><span class="op" id="4257364">(</span><span class="ident" id="4257365">s</span><span class="op" id="4257366">,</span>&nbsp;<span class="ident" id="4257368">bzeroes</span><span class="op" id="4257375">[</span><span class="op" id="4257376">:</span><span class="op" id="4257377">]</span><span class="op" id="4257378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257383">s</span>&nbsp;<span class="op" id="4257385">=</span>&nbsp;<span class="ident" id="4257387">s</span><span class="op" id="4257388">[</span><span class="ident" id="4257389">n</span><span class="op" id="4257390">:</span><span class="op" id="4257391">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4257395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257399">d</span><span class="op" id="4257400">.</span><span class="ident" id="4257401">blockStart</span><span class="op" id="4257411">,</span>&nbsp;<span class="ident" id="4257413">d</span><span class="op" id="4257414">.</span><span class="ident" id="4257415">byteAvailable</span>&nbsp;<span class="op" id="4257429">=</span>&nbsp;<span class="num" id="4257431">0</span><span class="op" id="4257432">,</span>&nbsp;<span class="builtintype" id="4257434">false</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257443">d</span><span class="op" id="4257444">.</span><span class="ident" id="4257445">tokens</span>&nbsp;<span class="op" id="4257452">=</span>&nbsp;<span class="ident" id="4257454">d</span><span class="op" id="4257455">.</span><span class="ident" id="4257456">tokens</span><span class="op" id="4257462">[</span><span class="op" id="4257463">:</span><span class="ident" id="4257464">maxFlateBlockTokens</span><span class="op" id="4257483">+</span><span class="num" id="4257484">1</span><span class="op" id="4257485">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4257489">for</span>&nbsp;<span class="ident" id="4257493">i</span>&nbsp;<span class="op" id="4257495">:=</span>&nbsp;<span class="num" id="4257498">0</span><span class="op" id="4257499">;</span>&nbsp;<span class="ident" id="4257501">i</span>&nbsp;<span class="op" id="4257503">&lt;=</span>&nbsp;<span class="ident" id="4257506">maxFlateBlockTokens</span><span class="op" id="4257525">;</span>&nbsp;<span class="ident" id="4257527">i</span><span class="op" id="4257528">++</span>&nbsp;<span class="op" id="4257531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257536">d</span><span class="op" id="4257537">.</span><span class="ident" id="4257538">tokens</span><span class="op" id="4257544">[</span><span class="ident" id="4257545">i</span><span class="op" id="4257546">]</span>&nbsp;<span class="op" id="4257548">=</span>&nbsp;<span class="num" id="4257550">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4257554">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257558">d</span><span class="op" id="4257559">.</span><span class="ident" id="4257560">tokens</span>&nbsp;<span class="op" id="4257567">=</span>&nbsp;<span class="ident" id="4257569">d</span><span class="op" id="4257570">.</span><span class="ident" id="4257571">tokens</span><span class="op" id="4257577">[</span><span class="op" id="4257578">:</span><span class="num" id="4257579">0</span><span class="op" id="4257580">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257584">d</span><span class="op" id="4257585">.</span><span class="ident" id="4257586">length</span>&nbsp;<span class="op" id="4257593">=</span>&nbsp;<span class="ident" id="4257595">minMatchLength</span>&nbsp;<span class="op" id="4257610">-</span>&nbsp;<span class="num" id="4257612">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257616">d</span><span class="op" id="4257617">.</span><span class="ident" id="4257618">offset</span>&nbsp;<span class="op" id="4257625">=</span>&nbsp;<span class="num" id="4257627">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257631">d</span><span class="op" id="4257632">.</span><span class="ident" id="4257633">hash</span>&nbsp;<span class="op" id="4257638">=</span>&nbsp;<span class="num" id="4257640">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257644">d</span><span class="op" id="4257645">.</span><span class="ident" id="4257646">maxInsertIndex</span>&nbsp;<span class="op" id="4257661">=</span>&nbsp;<span class="num" id="4257663">0</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4257666">}</span><br>
<span class="lineno"></span><span class="op" id="4257668">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4257671">func</span>&nbsp;<span class="op" id="4257676">(</span><span class="ident" id="4257677">d</span>&nbsp;<span class="op" id="4257679">*</span><span class="ident" id="4257680">compressor</span><span class="op" id="4257690">)</span>&nbsp;<span class="builtinfunc" id="4257692">close</span><span class="op" id="4257697">(</span><span class="op" id="4257698">)</span>&nbsp;<span class="builtintype" id="4257700">error</span>&nbsp;<span class="op" id="4257706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257709">d</span><span class="op" id="4257710">.</span><span class="ident" id="4257711">sync</span>&nbsp;<span class="op" id="4257716">=</span>&nbsp;<span class="builtintype" id="4257718">true</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257724">d</span><span class="op" id="4257725">.</span><span class="ident" id="4257726">step</span><span class="op" id="4257730">(</span><span class="ident" id="4257731">d</span><span class="op" id="4257732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4257735">if</span>&nbsp;<span class="ident" id="4257738">d</span><span class="op" id="4257739">.</span><span class="ident" id="4257740">err</span>&nbsp;<span class="op" id="4257744">!=</span>&nbsp;<span class="ident" id="4257747">nil</span>&nbsp;<span class="op" id="4257751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4257755">return</span>&nbsp;<span class="ident" id="4257762">d</span><span class="op" id="4257763">.</span><span class="ident" id="4257764">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4257769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4257772">if</span>&nbsp;<span class="ident" id="4257775">d</span><span class="op" id="4257776">.</span><span class="ident" id="4257777">w</span><span class="op" id="4257778">.</span><span class="ident" id="4257779">writeStoredHeader</span><span class="op" id="4257796">(</span><span class="num" id="4257797">0</span><span class="op" id="4257798">,</span>&nbsp;<span class="builtintype" id="4257800">true</span><span class="op" id="4257804">)</span><span class="op" id="4257805">;</span>&nbsp;<span class="ident" id="4257807">d</span><span class="op" id="4257808">.</span><span class="ident" id="4257809">w</span><span class="op" id="4257810">.</span><span class="ident" id="4257811">err</span>&nbsp;<span class="op" id="4257815">!=</span>&nbsp;<span class="ident" id="4257818">nil</span>&nbsp;<span class="op" id="4257822">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4257826">return</span>&nbsp;<span class="ident" id="4257833">d</span><span class="op" id="4257834">.</span><span class="ident" id="4257835">w</span><span class="op" id="4257836">.</span><span class="ident" id="4257837">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4257842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257845">d</span><span class="op" id="4257846">.</span><span class="ident" id="4257847">w</span><span class="op" id="4257848">.</span><span class="ident" id="4257849">flush</span><span class="op" id="4257854">(</span><span class="op" id="4257855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4257858">return</span>&nbsp;<span class="ident" id="4257865">d</span><span class="op" id="4257866">.</span><span class="ident" id="4257867">w</span><span class="op" id="4257868">.</span><span class="ident" id="4257869">err</span><br>
<span class="lineno"></span><span class="op" id="4257873">}</span><br>
<span class="lineno">475</span><br>
<span class="lineno"></span><span class="comment" id="4257876">//&nbsp;NewWriter&nbsp;returns&nbsp;a&nbsp;new&nbsp;Writer&nbsp;compressing&nbsp;data&nbsp;at&nbsp;the&nbsp;given&nbsp;level.</span><br>
<span class="lineno"></span><span class="comment" id="4257947">//&nbsp;Following&nbsp;zlib,&nbsp;levels&nbsp;range&nbsp;from&nbsp;1&nbsp;(BestSpeed)&nbsp;to&nbsp;9&nbsp;(BestCompression);</span><br>
<span class="lineno"></span><span class="comment" id="4258022">//&nbsp;higher&nbsp;levels&nbsp;typically&nbsp;run&nbsp;slower&nbsp;but&nbsp;compress&nbsp;more.&nbsp;Level&nbsp;0</span><br>
<span class="lineno"></span><span class="comment" id="4258087">//&nbsp;(NoCompression)&nbsp;does&nbsp;not&nbsp;attempt&nbsp;any&nbsp;compression;&nbsp;it&nbsp;only&nbsp;adds&nbsp;the</span><br>
<span class="lineno">480</span><span class="comment" id="4258157">//&nbsp;necessary&nbsp;DEFLATE&nbsp;framing.&nbsp;Level&nbsp;-1&nbsp;(DefaultCompression)&nbsp;uses&nbsp;the&nbsp;default</span><br>
<span class="lineno"></span><span class="comment" id="4258234">//&nbsp;compression&nbsp;level.</span><br>
<span class="lineno"></span><span class="comment" id="4258256">//</span><br>
<span class="lineno"></span><span class="comment" id="4258259">//&nbsp;If&nbsp;level&nbsp;is&nbsp;in&nbsp;the&nbsp;range&nbsp;[-1,&nbsp;9]&nbsp;then&nbsp;the&nbsp;error&nbsp;returned&nbsp;will&nbsp;be&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="4258332">//&nbsp;Otherwise&nbsp;the&nbsp;error&nbsp;returned&nbsp;will&nbsp;be&nbsp;non-nil.</span><br>
<span class="lineno">485</span><span class="keyword" id="4258381">func</span>&nbsp;<span class="ident" id="4258386">NewWriter</span><span class="op" id="4258395">(</span><span class="ident" id="4258396">w</span>&nbsp;<span class="ident" id="4258398">io</span><span class="op" id="4258400">.</span><span class="ident" id="4258401">Writer</span><span class="op" id="4258407">,</span>&nbsp;<span class="ident" id="4258409">level</span>&nbsp;<span class="builtintype" id="4258415">int</span><span class="op" id="4258418">)</span>&nbsp;<span class="op" id="4258420">(</span><span class="op" id="4258421">*</span><span class="ident" id="4258422">Writer</span><span class="op" id="4258428">,</span>&nbsp;<span class="builtintype" id="4258430">error</span><span class="op" id="4258435">)</span>&nbsp;<span class="op" id="4258437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4258440">var</span>&nbsp;<span class="ident" id="4258444">dw</span>&nbsp;<span class="ident" id="4258447">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4258455">if</span>&nbsp;<span class="ident" id="4258458">err</span>&nbsp;<span class="op" id="4258462">:=</span>&nbsp;<span class="ident" id="4258465">dw</span><span class="op" id="4258467">.</span><span class="ident" id="4258468">d</span><span class="op" id="4258469">.</span><span class="ident" id="4258470">init</span><span class="op" id="4258474">(</span><span class="ident" id="4258475">w</span><span class="op" id="4258476">,</span>&nbsp;<span class="ident" id="4258478">level</span><span class="op" id="4258483">)</span><span class="op" id="4258484">;</span>&nbsp;<span class="ident" id="4258486">err</span>&nbsp;<span class="op" id="4258490">!=</span>&nbsp;<span class="ident" id="4258493">nil</span>&nbsp;<span class="op" id="4258497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4258501">return</span>&nbsp;<span class="ident" id="4258508">nil</span><span class="op" id="4258511">,</span>&nbsp;<span class="ident" id="4258513">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4258518">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4258521">return</span>&nbsp;<span class="op" id="4258528">&amp;</span><span class="ident" id="4258529">dw</span><span class="op" id="4258531">,</span>&nbsp;<span class="ident" id="4258533">nil</span><br>
<span class="lineno"></span><span class="op" id="4258537">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4258540">//&nbsp;NewWriterDict&nbsp;is&nbsp;like&nbsp;NewWriter&nbsp;but&nbsp;initializes&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="4258599">//&nbsp;Writer&nbsp;with&nbsp;a&nbsp;preset&nbsp;dictionary.&nbsp;&nbsp;The&nbsp;returned&nbsp;Writer&nbsp;behaves</span><br>
<span class="lineno">495</span><span class="comment" id="4258664">//&nbsp;as&nbsp;if&nbsp;the&nbsp;dictionary&nbsp;had&nbsp;been&nbsp;written&nbsp;to&nbsp;it&nbsp;without&nbsp;producing</span><br>
<span class="lineno"></span><span class="comment" id="4258729">//&nbsp;any&nbsp;compressed&nbsp;output.&nbsp;&nbsp;The&nbsp;compressed&nbsp;data&nbsp;written&nbsp;to&nbsp;w</span><br>
<span class="lineno"></span><span class="comment" id="4258789">//&nbsp;can&nbsp;only&nbsp;be&nbsp;decompressed&nbsp;by&nbsp;a&nbsp;Reader&nbsp;initialized&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4258850">//&nbsp;same&nbsp;dictionary.</span><br>
<span class="lineno"></span><span class="keyword" id="4258870">func</span>&nbsp;<span class="ident" id="4258875">NewWriterDict</span><span class="op" id="4258888">(</span><span class="ident" id="4258889">w</span>&nbsp;<span class="ident" id="4258891">io</span><span class="op" id="4258893">.</span><span class="ident" id="4258894">Writer</span><span class="op" id="4258900">,</span>&nbsp;<span class="ident" id="4258902">level</span>&nbsp;<span class="builtintype" id="4258908">int</span><span class="op" id="4258911">,</span>&nbsp;<span class="ident" id="4258913">dict</span>&nbsp;<span class="op" id="4258918">[</span><span class="op" id="4258919">]</span><span class="builtintype" id="4258920">byte</span><span class="op" id="4258924">)</span>&nbsp;<span class="op" id="4258926">(</span><span class="op" id="4258927">*</span><span class="ident" id="4258928">Writer</span><span class="op" id="4258934">,</span>&nbsp;<span class="builtintype" id="4258936">error</span><span class="op" id="4258941">)</span>&nbsp;<span class="op" id="4258943">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4258946">dw</span>&nbsp;<span class="op" id="4258949">:=</span>&nbsp;<span class="op" id="4258952">&amp;</span><span class="ident" id="4258953">dictWriter</span><span class="op" id="4258963">{</span><span class="ident" id="4258964">w</span><span class="op" id="4258965">,</span>&nbsp;<span class="builtintype" id="4258967">false</span><span class="op" id="4258972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4258975">zw</span><span class="op" id="4258977">,</span>&nbsp;<span class="ident" id="4258979">err</span>&nbsp;<span class="op" id="4258983">:=</span>&nbsp;<span class="ident" id="4258986">NewWriter</span><span class="op" id="4258995">(</span><span class="ident" id="4258996">dw</span><span class="op" id="4258998">,</span>&nbsp;<span class="ident" id="4259000">level</span><span class="op" id="4259005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4259008">if</span>&nbsp;<span class="ident" id="4259011">err</span>&nbsp;<span class="op" id="4259015">!=</span>&nbsp;<span class="ident" id="4259018">nil</span>&nbsp;<span class="op" id="4259022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4259026">return</span>&nbsp;<span class="ident" id="4259033">nil</span><span class="op" id="4259036">,</span>&nbsp;<span class="ident" id="4259038">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4259043">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4259046">zw</span><span class="op" id="4259048">.</span><span class="ident" id="4259049">Write</span><span class="op" id="4259054">(</span><span class="ident" id="4259055">dict</span><span class="op" id="4259059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4259062">zw</span><span class="op" id="4259064">.</span><span class="ident" id="4259065">Flush</span><span class="op" id="4259070">(</span><span class="op" id="4259071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4259074">dw</span><span class="op" id="4259076">.</span><span class="ident" id="4259077">enabled</span>&nbsp;<span class="op" id="4259085">=</span>&nbsp;<span class="builtintype" id="4259087">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4259093">zw</span><span class="op" id="4259095">.</span><span class="ident" id="4259096">dict</span>&nbsp;<span class="op" id="4259101">=</span>&nbsp;<span class="builtinfunc" id="4259103">append</span><span class="op" id="4259109">(</span><span class="ident" id="4259110">zw</span><span class="op" id="4259112">.</span><span class="ident" id="4259113">dict</span><span class="op" id="4259117">,</span>&nbsp;<span class="ident" id="4259119">dict</span><span class="op" id="4259123">...</span><span class="op" id="4259126">)</span>&nbsp;<span class="comment" id="4259128">//&nbsp;duplicate&nbsp;dictionary&nbsp;for&nbsp;Reset&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4259171">return</span>&nbsp;<span class="ident" id="4259178">zw</span><span class="op" id="4259180">,</span>&nbsp;<span class="ident" id="4259182">err</span><br>
<span class="lineno">510</span><span class="op" id="4259186">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4259189">type</span>&nbsp;<span class="ident" id="4259194">dictWriter</span>&nbsp;<span class="keyword" id="4259205">struct</span>&nbsp;<span class="op" id="4259212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4259215">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4259223">io</span><span class="op" id="4259225">.</span><span class="ident" id="4259226">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4259234">enabled</span>&nbsp;<span class="builtintype" id="4259242">bool</span><br>
<span class="lineno">515</span><span class="op" id="4259247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4259250">func</span>&nbsp;<span class="op" id="4259255">(</span><span class="ident" id="4259256">w</span>&nbsp;<span class="op" id="4259258">*</span><span class="ident" id="4259259">dictWriter</span><span class="op" id="4259269">)</span>&nbsp;<span class="ident" id="4259271">Write</span><span class="op" id="4259276">(</span><span class="ident" id="4259277">b</span>&nbsp;<span class="op" id="4259279">[</span><span class="op" id="4259280">]</span><span class="builtintype" id="4259281">byte</span><span class="op" id="4259285">)</span>&nbsp;<span class="op" id="4259287">(</span><span class="ident" id="4259288">n</span>&nbsp;<span class="builtintype" id="4259290">int</span><span class="op" id="4259293">,</span>&nbsp;<span class="ident" id="4259295">err</span>&nbsp;<span class="builtintype" id="4259299">error</span><span class="op" id="4259304">)</span>&nbsp;<span class="op" id="4259306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4259309">if</span>&nbsp;<span class="ident" id="4259312">w</span><span class="op" id="4259313">.</span><span class="ident" id="4259314">enabled</span>&nbsp;<span class="op" id="4259322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4259326">return</span>&nbsp;<span class="ident" id="4259333">w</span><span class="op" id="4259334">.</span><span class="ident" id="4259335">w</span><span class="op" id="4259336">.</span><span class="ident" id="4259337">Write</span><span class="op" id="4259342">(</span><span class="ident" id="4259343">b</span><span class="op" id="4259344">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4259347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4259350">return</span>&nbsp;<span class="builtinfunc" id="4259357">len</span><span class="op" id="4259360">(</span><span class="ident" id="4259361">b</span><span class="op" id="4259362">)</span><span class="op" id="4259363">,</span>&nbsp;<span class="ident" id="4259365">nil</span><br>
<span class="lineno"></span><span class="op" id="4259369">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4259372">//&nbsp;A&nbsp;Writer&nbsp;takes&nbsp;data&nbsp;written&nbsp;to&nbsp;it&nbsp;and&nbsp;writes&nbsp;the&nbsp;compressed</span><br>
<span class="lineno">525</span><span class="comment" id="4259435">//&nbsp;form&nbsp;of&nbsp;that&nbsp;data&nbsp;to&nbsp;an&nbsp;underlying&nbsp;writer&nbsp;(see&nbsp;NewWriter).</span><br>
<span class="lineno"></span><span class="keyword" id="4259497">type</span>&nbsp;<span class="ident" id="4259502">Writer</span>&nbsp;<span class="keyword" id="4259509">struct</span>&nbsp;<span class="op" id="4259516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4259519">d</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4259524">compressor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4259536">dict</span>&nbsp;<span class="op" id="4259541">[</span><span class="op" id="4259542">]</span><span class="builtintype" id="4259543">byte</span><br>
<span class="lineno"></span><span class="op" id="4259548">}</span><br>
<span class="lineno">530</span><br>
<span class="lineno"></span><span class="comment" id="4259551">//&nbsp;Write&nbsp;writes&nbsp;data&nbsp;to&nbsp;w,&nbsp;which&nbsp;will&nbsp;eventually&nbsp;write&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4259610">//&nbsp;compressed&nbsp;form&nbsp;of&nbsp;data&nbsp;to&nbsp;its&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4259663">func</span>&nbsp;<span class="op" id="4259668">(</span><span class="ident" id="4259669">w</span>&nbsp;<span class="op" id="4259671">*</span><span class="ident" id="4259672">Writer</span><span class="op" id="4259678">)</span>&nbsp;<span class="ident" id="4259680">Write</span><span class="op" id="4259685">(</span><span class="ident" id="4259686">data</span>&nbsp;<span class="op" id="4259691">[</span><span class="op" id="4259692">]</span><span class="builtintype" id="4259693">byte</span><span class="op" id="4259697">)</span>&nbsp;<span class="op" id="4259699">(</span><span class="ident" id="4259700">n</span>&nbsp;<span class="builtintype" id="4259702">int</span><span class="op" id="4259705">,</span>&nbsp;<span class="ident" id="4259707">err</span>&nbsp;<span class="builtintype" id="4259711">error</span><span class="op" id="4259716">)</span>&nbsp;<span class="op" id="4259718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4259721">return</span>&nbsp;<span class="ident" id="4259728">w</span><span class="op" id="4259729">.</span><span class="ident" id="4259730">d</span><span class="op" id="4259731">.</span><span class="ident" id="4259732">write</span><span class="op" id="4259737">(</span><span class="ident" id="4259738">data</span><span class="op" id="4259742">)</span><br>
<span class="lineno">535</span><span class="op" id="4259744">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4259747">//&nbsp;Flush&nbsp;flushes&nbsp;any&nbsp;pending&nbsp;compressed&nbsp;data&nbsp;to&nbsp;the&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="comment" id="4259818">//&nbsp;It&nbsp;is&nbsp;useful&nbsp;mainly&nbsp;in&nbsp;compressed&nbsp;network&nbsp;protocols,&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4259889">//&nbsp;a&nbsp;remote&nbsp;reader&nbsp;has&nbsp;enough&nbsp;data&nbsp;to&nbsp;reconstruct&nbsp;a&nbsp;packet.</span><br>
<span class="lineno">540</span><span class="comment" id="4259949">//&nbsp;Flush&nbsp;does&nbsp;not&nbsp;return&nbsp;until&nbsp;the&nbsp;data&nbsp;has&nbsp;been&nbsp;written.</span><br>
<span class="lineno"></span><span class="comment" id="4260007">//&nbsp;If&nbsp;the&nbsp;underlying&nbsp;writer&nbsp;returns&nbsp;an&nbsp;error,&nbsp;Flush&nbsp;returns&nbsp;that&nbsp;error.</span><br>
<span class="lineno"></span><span class="comment" id="4260079">//</span><br>
<span class="lineno"></span><span class="comment" id="4260082">//&nbsp;In&nbsp;the&nbsp;terminology&nbsp;of&nbsp;the&nbsp;zlib&nbsp;library,&nbsp;Flush&nbsp;is&nbsp;equivalent&nbsp;to&nbsp;Z_SYNC_FLUSH.</span><br>
<span class="lineno"></span><span class="keyword" id="4260162">func</span>&nbsp;<span class="op" id="4260167">(</span><span class="ident" id="4260168">w</span>&nbsp;<span class="op" id="4260170">*</span><span class="ident" id="4260171">Writer</span><span class="op" id="4260177">)</span>&nbsp;<span class="ident" id="4260179">Flush</span><span class="op" id="4260184">(</span><span class="op" id="4260185">)</span>&nbsp;<span class="builtintype" id="4260187">error</span>&nbsp;<span class="op" id="4260193">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4260196">//&nbsp;For&nbsp;more&nbsp;about&nbsp;flushing:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4260225">//&nbsp;http://www.bolet.org/~pornin/deflate-flush.html</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4260277">return</span>&nbsp;<span class="ident" id="4260284">w</span><span class="op" id="4260285">.</span><span class="ident" id="4260286">d</span><span class="op" id="4260287">.</span><span class="ident" id="4260288">syncFlush</span><span class="op" id="4260297">(</span><span class="op" id="4260298">)</span><br>
<span class="lineno"></span><span class="op" id="4260300">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">550</span><span class="comment" id="4260303">//&nbsp;Close&nbsp;flushes&nbsp;and&nbsp;closes&nbsp;the&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4260343">func</span>&nbsp;<span class="op" id="4260348">(</span><span class="ident" id="4260349">w</span>&nbsp;<span class="op" id="4260351">*</span><span class="ident" id="4260352">Writer</span><span class="op" id="4260358">)</span>&nbsp;<span class="ident" id="4260360">Close</span><span class="op" id="4260365">(</span><span class="op" id="4260366">)</span>&nbsp;<span class="builtintype" id="4260368">error</span>&nbsp;<span class="op" id="4260374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4260377">return</span>&nbsp;<span class="ident" id="4260384">w</span><span class="op" id="4260385">.</span><span class="ident" id="4260386">d</span><span class="op" id="4260387">.</span><span class="builtinfunc" id="4260388">close</span><span class="op" id="4260393">(</span><span class="op" id="4260394">)</span><br>
<span class="lineno"></span><span class="op" id="4260396">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">555</span><span class="comment" id="4260399">//&nbsp;Reset&nbsp;discards&nbsp;the&nbsp;writer&#39;s&nbsp;state&nbsp;and&nbsp;makes&nbsp;it&nbsp;equivalent&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4260463">//&nbsp;the&nbsp;result&nbsp;of&nbsp;NewWriter&nbsp;or&nbsp;NewWriterDict&nbsp;called&nbsp;with&nbsp;dst</span><br>
<span class="lineno"></span><span class="comment" id="4260523">//&nbsp;and&nbsp;w&#39;s&nbsp;level&nbsp;and&nbsp;dictionary.</span><br>
<span class="lineno"></span><span class="keyword" id="4260556">func</span>&nbsp;<span class="op" id="4260561">(</span><span class="ident" id="4260562">w</span>&nbsp;<span class="op" id="4260564">*</span><span class="ident" id="4260565">Writer</span><span class="op" id="4260571">)</span>&nbsp;<span class="ident" id="4260573">Reset</span><span class="op" id="4260578">(</span><span class="ident" id="4260579">dst</span>&nbsp;<span class="ident" id="4260583">io</span><span class="op" id="4260585">.</span><span class="ident" id="4260586">Writer</span><span class="op" id="4260592">)</span>&nbsp;<span class="op" id="4260594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4260597">if</span>&nbsp;<span class="ident" id="4260600">dw</span><span class="op" id="4260602">,</span>&nbsp;<span class="ident" id="4260604">ok</span>&nbsp;<span class="op" id="4260607">:=</span>&nbsp;<span class="ident" id="4260610">w</span><span class="op" id="4260611">.</span><span class="ident" id="4260612">d</span><span class="op" id="4260613">.</span><span class="ident" id="4260614">w</span><span class="op" id="4260615">.</span><span class="ident" id="4260616">w</span><span class="op" id="4260617">.</span><span class="op" id="4260618">(</span><span class="op" id="4260619">*</span><span class="ident" id="4260620">dictWriter</span><span class="op" id="4260630">)</span><span class="op" id="4260631">;</span>&nbsp;<span class="ident" id="4260633">ok</span>&nbsp;<span class="op" id="4260636">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4260640">//&nbsp;w&nbsp;was&nbsp;created&nbsp;with&nbsp;NewWriterDict</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4260678">dw</span><span class="op" id="4260680">.</span><span class="ident" id="4260681">w</span>&nbsp;<span class="op" id="4260683">=</span>&nbsp;<span class="ident" id="4260685">dst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4260691">w</span><span class="op" id="4260692">.</span><span class="ident" id="4260693">d</span><span class="op" id="4260694">.</span><span class="ident" id="4260695">reset</span><span class="op" id="4260700">(</span><span class="ident" id="4260701">dw</span><span class="op" id="4260703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4260707">dw</span><span class="op" id="4260709">.</span><span class="ident" id="4260710">enabled</span>&nbsp;<span class="op" id="4260718">=</span>&nbsp;<span class="builtintype" id="4260720">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4260728">w</span><span class="op" id="4260729">.</span><span class="ident" id="4260730">Write</span><span class="op" id="4260735">(</span><span class="ident" id="4260736">w</span><span class="op" id="4260737">.</span><span class="ident" id="4260738">dict</span><span class="op" id="4260742">)</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4260746">w</span><span class="op" id="4260747">.</span><span class="ident" id="4260748">Flush</span><span class="op" id="4260753">(</span><span class="op" id="4260754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4260758">dw</span><span class="op" id="4260760">.</span><span class="ident" id="4260761">enabled</span>&nbsp;<span class="op" id="4260769">=</span>&nbsp;<span class="builtintype" id="4260771">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4260777">}</span>&nbsp;<span class="keyword" id="4260779">else</span>&nbsp;<span class="op" id="4260784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4260788">//&nbsp;w&nbsp;was&nbsp;created&nbsp;with&nbsp;NewWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4260822">w</span><span class="op" id="4260823">.</span><span class="ident" id="4260824">d</span><span class="op" id="4260825">.</span><span class="ident" id="4260826">reset</span><span class="op" id="4260831">(</span><span class="ident" id="4260832">dst</span><span class="op" id="4260835">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4260838">}</span><br>
<span class="lineno"></span><span class="op" id="4260840">}</span>
</div>
</body>
</html>
